<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ArrayBlockingQueue</title>
    <url>/posts/62562/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ğŸ” åŸºäºJDK1.8çš„ArrayBlockingQueueæºç åˆ†æã€‚</p>
<h2 id="åŸºæœ¬çŸ¥è¯†"><a href="#åŸºæœ¬çŸ¥è¯†" class="headerlink" title="åŸºæœ¬çŸ¥è¯†"></a>åŸºæœ¬çŸ¥è¯†</h2><ul>
<li><p>å§‹äºï¼š<strong>JDK 1.5</strong></p>
</li>
<li><p>ä½œè€…ï¼š<strong>Doug Lea</strong></p>
</li>
<li><p>ç‰¹ç‚¹ï¼šçº¿ç¨‹å®‰å…¨ï¼Œæœ‰ç•Œå¹¶é˜»å¡</p>
</li>
<li><p>ç»“æ„ï¼šæ•°ç»„</p>
</li>
<li><p>ç±»å›¾ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62562/ArrayBlockingQueue.png" class="" title="ArrayBlockingQueue">



</li>
</ul>
<h2 id="ä¸»è¦å±æ€§"><a href="#ä¸»è¦å±æ€§" class="headerlink" title="ä¸»è¦å±æ€§"></a>ä¸»è¦å±æ€§</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** å­˜å‚¨å…ƒç´ çš„æ•°ç»„ */</span></span><br><span class="line"><span class="keyword">final</span> Object[] items;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** é˜Ÿåˆ—å¤´éƒ¨ä½ç½®ï¼Œtake, poll, peek, removeæ“ä½œçš„ä½ç½® */</span></span><br><span class="line"><span class="keyword">int</span> takeIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** é˜Ÿåˆ—å°¾éƒ¨ä½ç½®ï¼Œput, offer, addæ“ä½œçš„ä½ç½® */</span></span><br><span class="line"><span class="keyword">int</span> putIndex;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** é˜Ÿåˆ—å…ƒç´ çš„æ•°é‡ */</span></span><br><span class="line"><span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å¯é‡å…¥ç‹¬å é” */</span></span><br><span class="line"><span class="keyword">final</span> ReentrantLock lock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ‰§è¡Œå‡ºé˜Ÿæ“ä½œçš„çº¿ç¨‹ä¼šè¢«æ”¾å…¥çš„æ¡ä»¶é˜Ÿåˆ— */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å½“é˜Ÿåˆ—ä¸ºæ»¡æ—¶ï¼Œæ‰§è¡Œå…¥é˜Ÿæ“ä½œçš„çº¿ç¨‹ä¼šè¢«æ”¾å…¥çš„æ¡ä»¶é˜Ÿåˆ— */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notFull;</span><br></pre></td></tr></table></figure>



<h2 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®¹é‡æ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(capacity, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¬å¹³æ€§æ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">this</span>.items = <span class="keyword">new</span> Object[capacity];</span><br><span class="line">    lock = <span class="keyword">new</span> ReentrantLock(fair);</span><br><span class="line">    notEmpty = lock.newCondition();</span><br><span class="line">    notFull =  lock.newCondition();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é›†åˆæ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> fair,</span></span></span><br><span class="line"><span class="function"><span class="params">                          Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(capacity, fair);</span><br><span class="line">	<span class="comment">// è·å–ç‹¬å é”ï¼Œå¹¶åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (E e : c) &#123;</span><br><span class="line">                checkNotNull(e);</span><br><span class="line">                items[i++] = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        count = i;</span><br><span class="line">        putIndex = (i == capacity) ? <span class="number">0</span> : i;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤ä½¿ç”¨éå…¬å¹³é”ã€‚</p>
<h2 id="offer-E-e"><a href="#offer-E-e" class="headerlink" title="offer(E e)"></a>offer(E e)</h2><p>ç”¨é€”ï¼šå‘é˜Ÿåˆ—å°¾éƒ¨æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—æœ‰ç©ºé—²ç©ºé—´åˆ™æ’å…¥æˆåŠŸåè¿”å›trueï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡åˆ™ä¸¢å¼ƒå½“å‰å…ƒç´ ç„¶åè¿”å›falseã€‚å¦‚æœ<code>e</code>ä¸ºnullåˆ™æŠ›å‡ºNPEå¼‚å¸¸ã€‚è¯¥æ–¹æ³•æ˜¯éé˜»å¡çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (1) å‚æ•°éªŒç©º</span></span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    <span class="comment">// (2) è·å–ç‹¬å é”ï¼Œå¹¶åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// (3) å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œè¿”å›false</span></span><br><span class="line">        <span class="keyword">if</span> (count == items.length)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// (4) é˜Ÿåˆ—æœªæ»¡ï¼Œæ’å…¥å…ƒç´ ï¼Œè¿”å›true</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            enqueue(e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// (5) é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é˜Ÿåˆ—å°¾éƒ¨æ’å…¥å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(E x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (6) å°†å…ƒç´ æ”¾å…¥ç›¸åº”ä½ç½®</span></span><br><span class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</span><br><span class="line">    items[putIndex] = x;</span><br><span class="line">    <span class="comment">// (7) å¦‚æœå½“å‰é˜Ÿåˆ—å·²æ»¡ï¼Œä¸‹ä¸€æ¬¡å­˜æ”¾ä½ç½®ä¸ºèµ·å§‹ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (++putIndex == items.length)</span><br><span class="line">        putIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// (8) é˜Ÿåˆ—å…ƒç´ æ•°é‡é€’å¢</span></span><br><span class="line">    count++;</span><br><span class="line">    <span class="comment">// (9) æ·»åŠ äº†å…ƒç´ ï¼Œå”¤é†’å‡ºé˜Ÿæ¡ä»¶é˜Ÿåˆ—çš„é˜»å¡è¿›è¡Œæ¶ˆè´¹</span></span><br><span class="line">    notEmpty.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç ï¼ˆ1ï¼‰è¿›è¡Œå‚æ•°æ ¡éªŒï¼Œå¦‚æœä¸ºç©ºåˆ™æŠ›å‡º<code>NullPointerException</code>å¼‚å¸¸ã€‚</p>
<p>ä»£ç ï¼ˆ2ï¼‰è·å–ç‹¬å é”ï¼Œå½“å‰çº¿ç¨‹è·å–è¯¥é”åï¼Œå…¶ä»–å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œçš„çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡æŒ‚èµ·è€Œåè¢«æ”¾å…¥lockçš„AQSé˜»å¡é˜Ÿåˆ—ã€‚</p>
<p>ä»£ç ï¼ˆ3ï¼‰åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ï¼Œæ»¡åˆ™ç›´æ¥è¿”å›falseï¼Œå¦åˆ™è°ƒç”¨<code>enqueue</code>æ–¹æ³•åè¿”å›trueã€‚</p>
<p>åœ¨<code>enqueue</code>æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæŠŠå½“å‰å…ƒç´ æ”¾å…¥<code>items</code>æ•°ç»„ï¼Œç„¶åè®¡ç®—ä¸‹ä¸€ä¸ªå…ƒç´ åº”è¯¥å­˜æ”¾çš„ä¸‹æ ‡ä½ç½®ï¼Œå¹¶é€’å¢å…ƒç´ ä¸ªæ•°è®¡æ•°å™¨ï¼Œæ·»åŠ å…ƒç´ ä¹‹åï¼Œæ¿€æ´»å› ä¸ºè¿›è¡Œæ¶ˆè´¹æ“ä½œè€Œè¢«é˜»å¡çš„çº¿ç¨‹ã€‚è¿™é‡Œç”±äºåœ¨æ“ä½œå…±äº«å˜é‡<code>count</code>å‰åŠ äº†ç‹¬å é”ï¼Œæ‰€ä»¥ä¸å­˜åœ¨å†…å­˜ä¸å¯è§é—®é¢˜ï¼ŒåŠ è¿‡é”åè·å–çš„å…±äº«å˜é‡éƒ½æ˜¯ä»ä¸»å†…å­˜è·å–çš„ï¼Œè€Œä¸æ˜¯ä»CPUç¼“å­˜æˆ–è€…å¯„å­˜å™¨è·å–ã€‚</p>
<p>ä»£ç ï¼ˆ5ï¼‰é‡Šæ”¾é”åï¼Œä¼šæŠŠä¿®æ”¹çš„å…±äº«å˜é‡å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹é€šè¿‡åŠ é”å†æ¬¡è¯»å–è¿™äº›å…±äº«å˜é‡æ—¶ï¼Œå°±å¯ä»¥çœ‹åˆ°æœ€æ–°çš„å€¼ã€‚</p>
<h2 id="put-E-e"><a href="#put-E-e" class="headerlink" title="put(E e)"></a>put(E e)</h2><p>ç”¨é€”ï¼šå‘é˜Ÿåˆ—å°¾éƒ¨æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—æœ‰ç©ºé—²ä½ç½®åˆ™æ’å…¥åç›´æ¥è¿”å›trueï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡åˆ™é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºé—²å¹¶æ’å…¥æˆåŠŸåè¿”å›trueï¼Œå¦‚æœåœ¨é˜»å¡æ—¶è¢«å…¶ä»–çº¿ç¨‹è®¾ç½®äº†ä¸­æ–­æ ‡å¿—ï¼Œåˆ™è¢«é˜»å¡çº¿ç¨‹ä¼šæŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸è€Œè¿”å›ã€‚å¦‚æœ<code>e</code>ä¸ºnullåˆ™æŠ›å‡ºNPEå¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// (1) å‚æ•°éªŒç©º</span></span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    <span class="comment">// (2) è·å–ç‹¬å é”ï¼Œå¹¶åŠ é”ï¼ˆå¯æ‰“æ–­ï¼‰</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// (3) å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™æŠŠå½“å‰çº¿ç¨‹æ”¾å…¥notFullæ¡ä»¶é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">while</span> (count == items.length)</span><br><span class="line">            notFull.await();</span><br><span class="line">        <span class="comment">// (4) é˜Ÿåˆ—äº§ç”Ÿç©ºé—²ä½ç½®ï¼Œæ’å…¥å…ƒç´ </span></span><br><span class="line">        enqueue(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// (5) é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="poll"><a href="#poll" class="headerlink" title="poll()"></a>poll()</h2><p>ç”¨é€”ï¼šä»é˜Ÿåˆ—å¤´éƒ¨è·å–å¹¶ç§»é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å›nullï¼Œè¯¥æ–¹æ³•æ˜¯ä¸é˜»å¡çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (1) è·å–ç‹¬å é”ï¼Œå¹¶åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// (2) å½“å‰é˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å›null</span></span><br><span class="line">        <span class="comment">// éç©ºåˆ™è·å–å¹¶ç§»é™¤é˜Ÿå°¾å…ƒç´ ï¼Œå¹¶è¿”å›é˜Ÿå°¾å…ƒç´ çš„å€¼</span></span><br><span class="line">        <span class="keyword">return</span> (count == <span class="number">0</span>) ? <span class="keyword">null</span> : dequeue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// (3) é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å¹¶ç§»é™¤é˜Ÿåˆ—å°¾éƒ¨å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">dequeue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Object[] items = <span class="keyword">this</span>.items;</span><br><span class="line">    <span class="comment">// (4) è·å–å…ƒç´ å€¼</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    E x = (E) items[takeIndex];</span><br><span class="line">    <span class="comment">// (5) æ•°ç»„ä¸­çš„å€¼ä¸ºnull</span></span><br><span class="line">    items[takeIndex] = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// (6) å¦‚æœå½“å‰é˜Ÿåˆ—å·²æ»¡ï¼Œä¸‹ä¸€æ¬¡è·å–ä½ç½®ä¸ºèµ·å§‹ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (++takeIndex == items.length)</span><br><span class="line">        takeIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// (7) é˜Ÿåˆ—å…ƒç´ æ•°é‡é€’å‡</span></span><br><span class="line">    count--;</span><br><span class="line">    <span class="comment">// (8) æ›´æ–°è¿­ä»£å™¨çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (itrs != <span class="keyword">null</span>)</span><br><span class="line">        itrs.elementDequeued();</span><br><span class="line">    <span class="comment">// (9) ç§»é™¤äº†å…ƒç´ ï¼Œé˜Ÿåˆ—äº§ç”Ÿç©ºä½ï¼Œå”¤é†’å…¥é˜Ÿæ¡ä»¶é˜Ÿåˆ—çš„é˜»å¡çº¿ç¨‹è¿›è¡Œç”Ÿäº§</span></span><br><span class="line">    notFull.signal();</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="take"><a href="#take" class="headerlink" title="take()"></a>take()</h2><p>ç”¨é€”ï¼šè·å–å½“å‰é˜Ÿåˆ—å¤´éƒ¨å…ƒç´ å¹¶ä»é˜Ÿåˆ—é‡Œé¢ç§»é™¤å®ƒã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©ºç„¶åè¿”å›å…ƒç´ ï¼Œå¦‚æœåœ¨é˜»å¡æ—¶è¢«å…¶ä»–çº¿ç¨‹è®¾ç½®äº†ä¸­æ–­æ ‡å¿—ï¼Œåˆ™è¢«é˜»å¡çº¿ç¨‹ä¼šæŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// (1) è·å–ç‹¬å é”ï¼Œå¹¶åŠ é”ï¼ˆå¯æ‰“æ–­ï¼‰</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// (2) å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æŠŠå½“å‰çº¿ç¨‹æ”¾å…¥notEmptyæ¡ä»¶é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">while</span> (count == <span class="number">0</span>)</span><br><span class="line">            notEmpty.await();</span><br><span class="line">        <span class="comment">// (3) è·å–é˜Ÿå¤´å…ƒç´ </span></span><br><span class="line">        <span class="keyword">return</span> dequeue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// (4) é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="peek"><a href="#peek" class="headerlink" title="peek()"></a>peek()</h2><p>ç”¨é€”ï¼šè·å–é˜Ÿåˆ—å¤´éƒ¨å…ƒç´ ä½†æ˜¯ä¸ä»é˜Ÿåˆ—é‡Œé¢ç§»é™¤ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å›nullï¼Œè¯¥æ–¹æ³•æ˜¯ä¸é˜»å¡çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">peek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (1) è·å–ç‹¬å é”ï¼Œå¹¶åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// (2) ä»æ•°ç»„ä¸­è·å–é˜Ÿå¤´ä¸‹æ ‡</span></span><br><span class="line">        <span class="keyword">return</span> itemAt(takeIndex); </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// (3) é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> E <span class="title">itemAt</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (E) items[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="size"><a href="#size" class="headerlink" title="size()"></a>size()</h2><p>ç”¨é€”ï¼šè·å–é˜Ÿåˆ—å…ƒç´ ä¸ªæ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>size</code>æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä¸Šé”åç›´æ¥è¿”å›<code>count</code>ï¼Œå¹¶åœ¨è¿”å›å‰é‡Šæ”¾é”ã€‚</p>
<p>å› ä¸º<code>count</code>å¹¶æ²¡æœ‰è¢«å£°æ˜ä¸º<code>volatile</code>ï¼Œæ‰€ä»¥æ— æ³•ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚</p>
<h2 id="æœ€åå°ç»“"><a href="#æœ€åå°ç»“" class="headerlink" title="æœ€åå°ç»“"></a>æœ€åå°ç»“</h2><p><code>ArrayBlockingQueue</code>é€šè¿‡å…¨å±€ç‹¬å é”å®ç°äº†åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå…¥é˜Ÿæˆ–è€…å‡ºé˜Ÿæ“ä½œï¼Œè¿™ä¸ªé”çš„ç²’åº¦æ¯”è¾ƒå¤§ï¼Œæœ‰ç‚¹ç±»ä¼¼äºåœ¨æ–¹æ³•ä¸Šæ·»åŠ <code>synchronized</code>çš„æ„æ€ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62562/operate.svg" class="" title="ArrayBlockingQueue">

<p>å…¶ä¸­<code>offer</code>å’Œ<code>poll</code>æ“ä½œé€šè¿‡ç®€å•çš„åŠ é”è¿›è¡Œå…¥é˜Ÿã€å‡ºé˜Ÿæ“ä½œï¼Œè€Œ<code>put</code>ã€<code>take</code>æ“ä½œåˆ™ä½¿ç”¨æ¡ä»¶å˜é‡å®ç°ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡åˆ™ç­‰å¾…ï¼Œå¦‚æœé˜Ÿåˆ—ç©ºåˆ™ç­‰å¾…ï¼Œç„¶ååˆ†åˆ«åœ¨å‡ºé˜Ÿå’Œå…¥é˜Ÿæ“ä½œä¸­å‘é€ä¿¡å·æ¿€æ´»ç­‰å¾…çº¿ç¨‹å®ç°åŒæ­¥ã€‚å¦å¤–ï¼Œç›¸æ¯”<code>LinkedBlockingQueue</code>ï¼Œ<code>ArrayBlockingQueue</code>çš„<code>size</code>æ“ä½œçš„ç»“æœæ˜¯ç²¾ç¡®çš„ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>ArrayList &amp; LinkedList</title>
    <url>/posts/55122/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ğŸ” åŸºäºJDK1.8çš„ArrayListå’ŒLinkedListçš„æºç è§£æã€‚</p>
<p>âš¡ æ¶‰åŠçš„APIï¼š<code>Arrays#copyOf(U[] original, int newLength, Class&lt;? extends T[]&gt; newType)</code></p>
<p>ç”¨äºæ•°ç»„å…‹éš†ï¼Œå‚æ•°å¦‚ä¸‹ï¼š</p>
<ol>
<li>originalï¼šåŸæ•°ç»„</li>
<li>newLengthï¼šæ–°æ•°ç»„é•¿åº¦</li>
<li>newTypeï¼šæ–°æ•°ç»„ç±»å‹</li>
</ol>
<p>å…‹éš†æ—¶ä¼šæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>å¦‚æœæ–°æ•°ç»„çš„é•¿åº¦å¤§äºåŸæ•°ç»„ï¼Œé‚£ä¹ˆå¤šå‡ºçš„éƒ¨åˆ†ç”¨nullå¡«å……ã€‚</li>
<li>å¦‚æœæ–°æ•°ç»„çš„é•¿åº¦å°äºåŸæ•°ç»„ï¼Œé‚£ä¹ˆå¤šå‡ºçš„éƒ¨åˆ†ç›´æ¥ä¸¢å¼ƒã€‚</li>
</ol>
<h2 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h2><h3 id="åŸºæœ¬çŸ¥è¯†"><a href="#åŸºæœ¬çŸ¥è¯†" class="headerlink" title="åŸºæœ¬çŸ¥è¯†"></a>åŸºæœ¬çŸ¥è¯†</h3><ul>
<li><p>å§‹äºï¼š<strong>JDK 1.2</strong></p>
</li>
<li><p>ä½œè€…ï¼š<strong>Josh Bloch</strong>, <strong>Neal Gafter</strong></p>
</li>
<li><p>å®ç°ï¼š<strong>List<E></strong>, <strong>RandomAccess</strong>, <strong>Cloneable</strong>, <strong>Serializable</strong></p>
</li>
<li><p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å¯å­˜å‚¨ä»»ä½•ç±»å‹æ•°æ®ï¼ˆåŒ…æ‹¬nullï¼‰</li>
<li>å¯å­˜å‚¨é‡å¤æ•°æ®</li>
<li>å­˜å‚¨æ•°æ®ä¿è¯æœ‰åºæ€§</li>
<li>éçº¿ç¨‹å®‰å…¨</li>
</ul>
</li>
<li><p>ç±»å›¾ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/55122/ArrayList.png" class="" title="ArrayList">



</li>
</ul>
<h3 id="åŸºæœ¬å±æ€§"><a href="#åŸºæœ¬å±æ€§" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤å®¹é‡(10)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–å®¹é‡ä¸º0ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ— å‚æ„é€ æ–¹æ³•ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­˜æ”¾å…ƒç´ </span></span><br><span class="line"><span class="keyword">transient</span> Object[] elementData; </span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„é•¿åº¦/å…ƒç´ æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ€å¤§å®¹é‡(2147483647 - 8 = 2147483639)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ARRAY_SIZE = Integer.MAX_VALUE - <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»§æ‰¿è‡ªAbstractListï¼Œè®°å½•ç»“æ„å˜åŒ–æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">transient</span> <span class="keyword">int</span> modCount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>



<h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¸¦åˆå§‹åŒ–å®¹é‡çš„æ„é€ å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = <span class="keyword">new</span> Object[initialCapacity];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal Capacity: &quot;</span>+</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ— å‚æ„é€ å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é›†åˆæ„é€ å™¨ï¼Œå¤åˆ¶å¦ä¸€ä¸ªé›†åˆä¸­çš„å…¨éƒ¨å†…å®¹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    elementData = c.toArray();</span><br><span class="line">    <span class="keyword">if</span> ((size = elementData.length) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// c.toArray might (incorrectly) not return Object[] (see 6260652)</span></span><br><span class="line">        <span class="keyword">if</span> (elementData.getClass() != Object[].class)</span><br><span class="line">            elementData = Arrays.copyOf(elementData, size, Object[].class);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// replace with empty array.</span></span><br><span class="line">        <span class="keyword">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="addæ–¹æ³•"><a href="#addæ–¹æ³•" class="headerlink" title="addæ–¹æ³•"></a>addæ–¹æ³•</h3><p>ç”¨é€”ï¼šå‘æ•°ç»„æœ«å°¾æ·»åŠ å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// ç¡®ä¿å®¹é‡è¶³å¤Ÿ</span></span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°æ•°ç»„å°¾éƒ¨</span></span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¡®ä¿å®¹é‡è¶³å¤Ÿ</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—æ‰€éœ€å®¹é‡</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculateCapacity</span><span class="params">(Object[] elementData, <span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123; <span class="comment">// è¯´æ˜åˆšåˆšåˆ›å»º</span></span><br><span class="line">        <span class="keyword">return</span> Math.max(DEFAULT_CAPACITY, minCapacity);  <span class="comment">// åˆ™å–åˆå§‹åŒ–å®¹é‡å’Œæ‰€éœ€å®¹é‡çš„æœ€å¤§å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> minCapacity; <span class="comment">// æ»¡è¶³éœ€è¦çš„æœ€å°å®¹é‡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureExplicitCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    modCount++; <span class="comment">// ç»“æ„æ”¹å˜æ¬¡æ•°+1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// éœ€è¦çš„æœ€å°å®¹é‡å¤§äºæ•°ç»„é•¿åº¦ï¼Œåˆ™æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰©å®¹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åŸæ•°ç»„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">    <span class="comment">// æ–°æ•°ç»„é•¿åº¦ = åŸæ•°ç»„é•¿åº¦ * 1.5</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 1.5å€ä¸å¤Ÿåˆ™ç»™äºˆæ‰€éœ€å®¹é‡</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="comment">// æ–°çš„å®¹é‡è¶…è¿‡æœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    <span class="comment">// å°†åŸæ•°ç»„å†…å®¹å¤åˆ¶åˆ°æ–°æ•°ç»„</span></span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´å¤§çš„å®¹é‡</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">    <span class="comment">// å¦‚æœæ‰€éœ€æœ€å°å®¹é‡å¤§äº2147483639ï¼Œé‚£ä¹ˆåªèƒ½æ‰©å®¹åˆ°2147483647</span></span><br><span class="line">    <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ? Integer.MAX_VALUE : MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆç¡®ä¿å®¹é‡ï¼Œæ‰€éœ€å®¹é‡ = size + 1ã€‚</p>
<p>å¯¹äºåˆšåˆšåˆ›å»ºçš„ArrayListï¼šæ‰€éœ€å®¹é‡ = max(åˆå§‹åŒ–å®¹é‡10ï¼Œå½“å‰å®¹é‡)ã€‚</p>
<p>å¦‚æœæ‰€éœ€å®¹é‡å¤§äºæ•°ç»„é•¿åº¦ï¼Œåˆ™è¿›è¡Œæ‰©å®¹ï¼Œé»˜è®¤æ‰©å®¹ä¸º1.5å€ï¼Œä¸å¤Ÿåˆ™ç»™äºˆæ‰€éœ€å®¹é‡ï¼›</p>
<p>å¦‚æœæ‰€éœ€å®¹é‡å¤§äºæœ€å¤§å®¹é‡ï¼Œé‚£ä¹ˆåªèƒ½æ‰©å®¹ä¸º<code>Integer.MAX_VALUE</code>ã€‚</p>
<p>æœ€åå°†å…ƒç´ æ·»åŠ åˆ°æ•°ç»„å°¾éƒ¨ã€‚</p>
<h3 id="getæ–¹æ³•"><a href="#getæ–¹æ³•" class="headerlink" title="getæ–¹æ³•"></a>getæ–¹æ³•</h3><p>ç”¨é€”ï¼šè·å–æ‰§è¡Œä¸‹æ ‡çš„å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¶Šç•Œæ£€æŸ¥</span></span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    <span class="keyword">return</span> elementData(index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¶Šç•Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rangeCheck</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= size)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(outOfBoundsMsg(index));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›´æ¥æ ¹æ®ä¸‹æ ‡è¿”å›æ•°ç»„å…ƒç´ å¹¶è¿›è¡Œç±»å‹è½¬æ¢</span></span><br><span class="line"><span class="function">E <span class="title">elementData</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (E) elementData[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè¿›è¡Œè¶Šç•Œæ£€æŸ¥ï¼Œç„¶åç›´æ¥æ ¹æ®ä¸‹æ ‡è¿”å›æ•°ç»„å…ƒç´ ã€‚</p>
<h3 id="removeæ–¹æ³•"><a href="#removeæ–¹æ³•" class="headerlink" title="removeæ–¹æ³•"></a>removeæ–¹æ³•</h3><p>ç”¨é€”ï¼šç§»é™¤æŒ‡å®šä¸‹æ ‡çš„å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¶Šç•Œæ£€æŸ¥</span></span><br><span class="line">    rangeCheck(index);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»“æ„æ”¹å˜æ¬¡æ•°+1</span></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// éœ€è¦åˆ é™¤çš„å…ƒç´ </span></span><br><span class="line">    E oldValue = elementData(index);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éœ€è¦ç§»åŠ¨çš„å…ƒç´ æ•°é‡ï¼ŒoldValueåé¢æ‰€æœ‰çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">int</span> numMoved = size - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// å°†oldValueåé¢çš„å…ƒç´ å…¨éƒ¨å‘å‰ç§»åŠ¨ä¸€ä¸ªå•ä½</span></span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    <span class="comment">// size - 1</span></span><br><span class="line">    elementData[--size] = <span class="keyword">null</span>; <span class="comment">// clear to let GC do its work</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›åˆ é™¤çš„å€¼</span></span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè¿›è¡Œè¶Šç•Œæ£€æŸ¥ï¼Œç„¶åå°†éœ€è¦åˆ é™¤çš„å…ƒç´ ä¹‹åçš„å…ƒç´ å…¨éƒ¨å‘å‰ç§»åŠ¨ä¸€ä½ï¼Œå¹¶å°†æ•°ç»„å°¾éƒ¨å…ƒç´ ç½®ä¸ºnullã€‚</p>
<h3 id="trimToSizeæ–¹æ³•"><a href="#trimToSizeæ–¹æ³•" class="headerlink" title="trimToSizeæ–¹æ³•"></a>trimToSizeæ–¹æ³•</h3><p>ç”¨é€”ï¼šå°†æ•°ç»„å®¹é‡è°ƒæ•´ä¸ºå®é™…å…ƒç´ ä¸ªæ•°å¤§å°ï¼Œå½“ArryListå…ƒç´ ä¸ªæ•°ä¸å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå¯ä»¥è°ƒç”¨è¯¥æ–¹æ³•å‡å°‘å†…å­˜å ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">if</span> (size &lt; elementData.length) &#123;</span><br><span class="line">        <span class="comment">// æ•°ç»„é•¿åº¦ä¸º0ï¼Œåˆ™ç½®ä¸ºç©ºæ•°ç»„</span></span><br><span class="line">        <span class="comment">// å¦åˆ™å¤åˆ¶ä¸€ä»½æ–°æ•°ç»„ï¼Œé•¿åº¦ä¸ºå½“å‰å¤§å°</span></span><br><span class="line">        elementData = (size == <span class="number">0</span>) ? </span><br><span class="line">            EMPTY_ELEMENTDATA : Arrays.copyOf(elementData, size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h2><h3 id="åŸºæœ¬çŸ¥è¯†-1"><a href="#åŸºæœ¬çŸ¥è¯†-1" class="headerlink" title="åŸºæœ¬çŸ¥è¯†"></a>åŸºæœ¬çŸ¥è¯†</h3><ul>
<li><p>å§‹äºï¼š<em>JDK 1.2</em></p>
</li>
<li><p>ä½œè€…ï¼š<em>Josh Bloch</em></p>
</li>
<li><p>å®ç°ï¼š<em>List<E>, Deque<E>, Cloneable, Serializable</em></p>
</li>
<li><p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å¯å­˜å‚¨ä»»ä½•ç±»å‹æ•°æ®ï¼ˆåŒ…æ‹¬nullï¼‰</li>
<li>å¯å­˜å‚¨é‡å¤æ•°æ®</li>
<li>å­˜å‚¨æ•°æ®ä¿è¯æœ‰åºæ€§</li>
<li>éçº¿ç¨‹å®‰å…¨</li>
</ul>
</li>
<li><p>ç±»å›¾ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/55122/LinkedList.png" class="" title="LinkedList">
</li>
<li><p>ç»“æ„ï¼šåŒå‘é“¾è¡¨</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/55122/LinkedList-structure.svg" class="" title="LinkedList-structure">



</li>
</ul>
<h3 id="åŸºæœ¬å±æ€§-1"><a href="#åŸºæœ¬å±æ€§-1" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å†…éƒ¨ç±»ï¼šèŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    E item;       <span class="comment">// èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    Node&lt;E&gt; next; <span class="comment">// åç»§èŠ‚ç‚¹</span></span><br><span class="line">    Node&lt;E&gt; prev; <span class="comment">// å‰é©±èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">    Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.item = element;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">        <span class="keyword">this</span>.prev = prev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é“¾è¡¨é•¿åº¦/å…ƒç´ æ•°é‡</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; first;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; last;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»§æ‰¿è‡ªAbstractListï¼Œè®°å½•ç»“æ„å˜åŒ–æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">transient</span> <span class="keyword">int</span> modCount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>



<h3 id="æ„é€ æ–¹æ³•-1"><a href="#æ„é€ æ–¹æ³•-1" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç©ºå‚æ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é›†åˆæ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>();</span><br><span class="line">    addAll(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="addæ–¹æ³•-1"><a href="#addæ–¹æ³•-1" class="headerlink" title="addæ–¹æ³•"></a>addæ–¹æ³•</h3><p>è·å–æŒ‡å®šä¸‹æ ‡çš„å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    linkLast(e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨é“¾è¡¨å°¾éƒ¨æ’å…¥å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">linkLast</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(l, e, <span class="keyword">null</span>);</span><br><span class="line">   	<span class="comment">// æ–°èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">    last = newNode;</span><br><span class="line">    <span class="comment">// å°¾èŠ‚ç‚¹ä¸ºç©ºï¼Œå°†æ–°èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (l == <span class="keyword">null</span>)</span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="comment">// å°¾èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå°†æ–°èŠ‚ç‚¹è¿æ¥åˆ°å°¾èŠ‚ç‚¹çš„åé¢</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        l.next = newNode;</span><br><span class="line">    <span class="comment">// é“¾è¡¨é•¿åº¦+1</span></span><br><span class="line">    size++;</span><br><span class="line">    <span class="comment">// æ”¹å˜æ¬¡æ•°+1</span></span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè·å–å°¾èŠ‚ç‚¹ï¼ˆç”¨äºåˆ¤æ–­é“¾è¡¨æ˜¯å¦ä¸ºç©ºï¼‰ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹å­˜æ”¾å½“å‰å…ƒç´ ï¼Œå¹¶å°†æ–°èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹ã€‚</p>
<p>è‹¥é“¾è¡¨ä¸ºç©ºï¼Œåˆ™å°†æ–°èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„å¤´èŠ‚ç‚¹ï¼Œå¦åˆ™å°†æ–°èŠ‚ç‚¹è¿æ¥åˆ°å°¾èŠ‚ç‚¹çš„åé¢ï¼Œç„¶åå°†é“¾è¡¨é•¿åº¦å’Œæ”¹å˜æ¬¡æ•°+1ã€‚</p>
<h3 id="getæ–¹æ³•-1"><a href="#getæ–¹æ³•-1" class="headerlink" title="getæ–¹æ³•"></a>getæ–¹æ³•</h3><p>è·å–æŒ‡å®šä¸‹æ ‡çš„å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¶Šç•Œæ£€æŸ¥</span></span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="keyword">return</span> node(index).item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¶Šç•Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkElementIndex</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isElementIndex(index))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(outOfBoundsMsg(index));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥æ˜¯å¦è¶Šç•Œ</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isElementIndex</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´ </span></span><br><span class="line"><span class="function">Node&lt;E&gt; <span class="title">node</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert isElementIndex(index);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨äºŒåˆ†æ³•ï¼Œæ¯”è¾ƒindexä¸size/2</span></span><br><span class="line">    <span class="comment">// è‹¥ index &lt; size / 2ï¼Œè¯´æ˜indexé è¿‘å¤´èŠ‚ç‚¹ï¼Œä»å¤´å‘åéå†</span></span><br><span class="line">    <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        Node&lt;E&gt; x = first;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">            x = x.next;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// è‹¥ index &gt;= size / 2ï¼Œè¯´æ˜indexé è¿‘å°¾èŠ‚ç‚¹ï¼Œä»å°¾å‘å‰éå†</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;E&gt; x = last;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">            x = x.prev;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè¿›è¡Œè¶Šç•Œæ£€æŸ¥ï¼Œç„¶åæ ¹æ®ç´¢å¼•ä¸é“¾è¡¨é•¿åº¦å…³ç³»å†³å®šæ˜¯ä»å¤´å¼€å§‹éå†è¿˜æ˜¯ä»å°¾å¼€å§‹éå†ã€‚</p>
<h3 id="removeæ–¹æ³•-1"><a href="#removeæ–¹æ³•-1" class="headerlink" title="removeæ–¹æ³•"></a>removeæ–¹æ³•</h3><p>ç§»é™¤æŒ‡å®šä¸‹æ ‡çš„å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¶Šç•Œæ£€æŸ¥</span></span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="keyword">return</span> unlink(node(index));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">E <span class="title">unlink</span><span class="params">(Node&lt;E&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert x != null;</span></span><br><span class="line">    <span class="keyword">final</span> E element = x.item;</span><br><span class="line">    <span class="comment">// å¾…åˆ é™¤ç»“ç‚¹çš„åç»§ï¼Œç®€ç§°åç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; next = x.next;</span><br><span class="line">    <span class="comment">// å¾…åˆ é™¤ç»“ç‚¹çš„å‰é©±ï¼Œç®€ç§°å‰ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; prev = x.prev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‰ç‚¹ä¸ºç©ºï¼Œç›´æ¥å°†å¤´èŠ‚ç‚¹è®¾ç½®ä¸ºåç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (prev == <span class="keyword">null</span>) &#123;</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// å‰ç‚¹éç©ºï¼Œå°†å‰é©±çš„åç»§èŠ‚ç‚¹è®¾ç½®ä¸ºåç‚¹</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        prev.next = next;</span><br><span class="line">        <span class="comment">// å°†xä¸å‰ç‚¹æ–­å¼€è¿æ¥</span></span><br><span class="line">        x.prev = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// åç‚¹ä¸ºç©ºï¼Œç›´æ¥å°†å°¾èŠ‚ç‚¹è®¾ç½®ä¸ºå‰ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</span><br><span class="line">        last = prev;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// åç‚¹éç©ºï¼Œå°†åç»§çš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºå‰ç‚¹</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        next.prev = prev;</span><br><span class="line">        <span class="comment">// å°†xä¸åç‚¹æ–­å¼€è¿æ¥</span></span><br><span class="line">        x.next = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†åˆ é™¤èŠ‚ç‚¹ç½®ä¸ºnullï¼Œhelp GC</span></span><br><span class="line">    x.item = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// é“¾è¡¨é•¿åº¦-1</span></span><br><span class="line">    size--;</span><br><span class="line">    <span class="comment">// æ“ä½œæ¬¡æ•°+1</span></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// è¿”å›è¢«åˆ é™¤ç»“ç‚¹çš„å€¼</span></span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè·å–å¾…åˆ èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹å’Œåç»§èŠ‚ç‚¹ï¼Œç®€ç§°ä¸ºå‰ç‚¹å’Œåç‚¹ã€‚</p>
<p>è‹¥å‰ç‚¹ä¸ºç©ºï¼Œåˆ™ç›´æ¥å°†å¤´èŠ‚ç‚¹è®¾ç½®ä¸ºåç‚¹ï¼›å¦åˆ™å‰ç‚¹ä¸ä¸ºç©ºï¼Œå°†å‰ç‚¹çš„åç»§èŠ‚ç‚¹è®¾ç½®ä¸ºåç‚¹ï¼Œå°†å¾…åˆ èŠ‚ç‚¹ä¸å‰ç‚¹æ–­å¼€è¿æ¥ã€‚</p>
<p>è‹¥åç‚¹ä¸ºç©ºï¼Œåˆ™ç›´æ¥å°†å°¾èŠ‚ç‚¹è®¾ç½®ä¸ºå‰ç‚¹ï¼›å¦åˆ™åç‚¹ä¸ä¸ºç©ºï¼Œå°†åç‚¹çš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºå‰ç‚¹ï¼Œå°†å¾…åˆ èŠ‚ç‚¹ä¸åç‚¹æ–­å¼€è¿æ¥ã€‚</p>
<p>æœ€åå°†å¾…åˆ èŠ‚ç‚¹ç½®ä¸ºnullï¼Œé“¾è¡¨é•¿åº¦-1ï¼Œå¹¶è¿”å›åˆ é™¤èŠ‚ç‚¹çš„å€¼ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>äºŒåˆ†æŸ¥æ‰¾</title>
    <url>/posts/18721/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è™½ç„¶äºŒåˆ†å°±é‚£ä¹ˆç®€å•çš„å‡ è¡Œä»£ç ï¼Œä½†æ˜¯æˆ‘ä¹‹å‰ä¸€ç›´æä¸æ‡‚é‡Œé¢çš„ä¸€äº›åˆ¤æ–­æ˜¯ä¸æ˜¯è¦åŠ ç­‰äºå·ï¼Œæ›´æ–°è¾¹ç•Œè¦ä¸è¦åŠ 1æˆ–è€…å‡1ã€‚<br>æ¯æ¬¡å†™çš„æ—¶å€™å°±ç„å­¦å†™ï¼Œå¯èƒ½æˆåŠŸï¼Œä¹Ÿå¯èƒ½æ­»å¾ªç¯ã€‚ä½†æ˜¯ï¼Œå…¶å®åªè¦æ˜ç¡®äº†ã€Œæœç´¢åŒºé—´ã€å’Œã€Œæ”¶ç¼©é€»è¾‘ã€ï¼Œæ‰§è¡Œé€»è¾‘ä¸æ¼æ‰å…ƒç´ ï¼Œå°±å¾ˆå¥½åŠäº†ã€‚<br>åˆå­¦ç¼–å†™ä»£ç æ—¶ï¼Œæˆ‘ä»¬ä¹ æƒ¯æ¡ä»¶åˆ¤æ–­ä¸­çš„å°†æœ€åä¸€ä¸ªåˆ†æ”¯ç»å¸¸è¢«<code>else</code>ä»£æ›¿ï¼Œæˆ–è€…å¦‚æœä¸¤ä¸ªåˆ†æ”¯æ¡ä»¶çš„æ‰§è¡Œé€»è¾‘ç›¸åŒæ—¶å°†ä¸¤ä¸ªåˆ†æ”¯åˆäºŒä¸ºä¸€ï¼Œæˆ‘è§‰å¾—è¿™æ ·å¯¹æ€è€ƒäºŒåˆ†æµç¨‹æ˜¯ä¸åˆ©çš„ã€‚<br>å¦å¤–ï¼Œæ•´æ•°æº¢å‡ºçš„é—®é¢˜å·²ç»æ˜¯è€ç”Ÿå¸¸è°ˆäº†ï¼Œå°‘ç”¨<code>(l + r) / 2</code>ï¼Œæ”¹ç”¨<code>l + (r - l) &gt;&gt; 1</code>ã€‚<br>â€‹</p>
<h2 id="æŸ¥æ‰¾å…ƒç´ "><a href="#æŸ¥æ‰¾å…ƒç´ " class="headerlink" title="æŸ¥æ‰¾å…ƒç´ "></a>æŸ¥æ‰¾å…ƒç´ </h2><p>å¸¸ç”¨æ¨¡æ¿å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">search</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, r = nums.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (l &lt;= r) &#123;</span><br><span class="line">        <span class="keyword">int</span> m = l + ((r - l) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nums[m] == target)</span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[m] &lt; target)</span><br><span class="line">            l = m + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[m] &gt; target)</span><br><span class="line">            r = m - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä¹ æƒ¯ä½¿ç”¨é—­åŒºé—´è¿›è¡Œæœç´¢ï¼Œè¿™æ ·æ”¶ç¼©åŒºé—´æ—¶å€™çš„<code>+1</code>å’Œ<code>-1</code>é€»è¾‘ä¹Ÿæ˜¯å¯¹ç§°çš„ï¼Œå¾ˆå¥½è®°å¿†ã€‚</p>
<p>ï¼ˆ1ï¼‰æœç´¢åŒºé—´</p>
<p>è¿™é‡Œæœç´¢é—­åŒºé—´<code>[l, r]</code>ï¼Œç»ˆæ­¢æ¡ä»¶ä¸º<code>l = r + 1</code>ï¼Œå› ä¸ºè¿™æ—¶å€™<code>[r + 1, r]</code>ä¸ºç©ºåŒºé—´ã€‚<br>å¦‚æœå°†ç»ˆæ­¢æ¡ä»¶æ”¹ä¸º<code>l = r</code>ï¼Œé‚£ä¹ˆç»ˆæ­¢æ—¶å€™é—­åŒºé—´ä¸º<code>[r, r]</code>ï¼Œå®ƒè¿˜åŒ…å«ä¸€ä¸ªæ•°<code>nums[r]</code>ï¼Œåœ¨è¿”å›æ—¶å€™åˆ¤æ–­ä¸€ä¸‹<code>nums[r]</code>ä¸<code>target</code>çš„å¤§å°å³å¯ã€‚</p>
<p>ï¼ˆ2ï¼‰æ”¶ç¼©é€»è¾‘</p>
<ol>
<li>å¦‚æœ<code>nums[m] &lt; target</code>ï¼Œè¯´æ˜<code>[l, m]</code>æ•´ä¸ªåŒºé—´éƒ½å°äº<code>target</code>ï¼Œå› æ­¤æ¥ä¸‹æ¥å‘å³æ”¶ç¼©ï¼Œæœç´¢<code>[m + 1, r]</code>å³å¯ï¼Œäºæ˜¯æˆ‘ä»¬æŠŠ<code>l</code>æ›´æ–°ä¸º<code>m + 1</code>ã€‚</li>
<li>å¦‚æœ<code>nums[m] &gt; target</code>ï¼Œè¯´æ˜<code>[m, r]</code>æ•´ä¸ªåŒºé—´éƒ½å¤§äº<code>target</code>ï¼Œå› æ­¤æ¥ä¸‹æ¥å‘å·¦æ”¶ç¼©ï¼Œæœç´¢<code>[l, m - 1]</code>å³å¯ï¼Œäºæ˜¯æˆ‘ä»¬æŠŠ<code>r</code>æ›´æ–°ä¸º<code>m - 1</code>ã€‚</li>
</ol>
<h2 id="æŸ¥æ‰¾å·¦è¾¹ç•Œ"><a href="#æŸ¥æ‰¾å·¦è¾¹ç•Œ" class="headerlink" title="æŸ¥æ‰¾å·¦è¾¹ç•Œ"></a>æŸ¥æ‰¾å·¦è¾¹ç•Œ</h2><p>å¸¸ç”¨æ¨¡æ¿å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">searchLeft</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, r = nums.length;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">        <span class="keyword">int</span> m = l + ((r - l) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nums[m] == target)</span><br><span class="line">            r = m;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[m] &lt; target)</span><br><span class="line">            l = m + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[m] &gt; target)</span><br><span class="line">            r = m;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= nums.length || nums[l] != target)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ1ï¼‰æœç´¢åŒºé—´</p>
<p>è¿™é‡Œæœç´¢åŒºé—´<code>[l, r)</code>ï¼Œç»ˆæ­¢æ¡ä»¶ä¸º<code>l = r</code>ï¼Œå› ä¸ºè¿™æ—¶å€™åŒºé—´<code>[r, r)</code>æ˜¯ä¸€ä¸ªç©ºåŒºé—´ã€‚</p>
<p>ï¼ˆ2ï¼‰æ”¶ç¼©é€»è¾‘</p>
<ol>
<li>å¦‚æœ<code>nums[m] = target</code>ï¼Œè¿™æ—¶å€™åˆšå¥½æ‰¾åˆ°äº†<code>target</code>ï¼Œä¸è¦ç«‹å³è¿”å›ï¼Œè€Œæ˜¯ç¼©å°åŒºé—´çš„å³è¾¹ç•Œï¼Œå°†<code>r</code>æ›´æ–°ä¸º<code>m</code>ï¼Œåœ¨åŒºé—´<code>[l, m)</code>ä¸­ç»§ç»­æœç´¢ï¼Œä¸æ–­å‘å·¦æ”¶ç¼©ï¼Œè¾¾åˆ°é”å®šå·¦ä¾§è¾¹ç•Œçš„ç›®çš„ã€‚</li>
<li>å¦‚æœ<code>nums[m] &lt; target</code>ï¼Œè¯´æ˜<code>[l, m]</code>æ•´ä¸ªåŒºé—´éƒ½å°äº<code>target</code>ï¼Œå› æ­¤æ¥ä¸‹æ¥å‘å³æ”¶ç¼©ï¼Œæœç´¢<code>[m + 1, r]</code>å³å¯ï¼Œäºæ˜¯æˆ‘ä»¬æŠŠ<code>l</code>æ›´æ–°ä¸º<code>m + 1</code>ã€‚</li>
<li>å¦‚æœ<code>nums[m] &gt; target</code>ï¼Œè¯´æ˜<code>[m, r]</code>æ•´ä¸ªåŒºé—´éƒ½å¤§äº<code>target</code>ï¼Œå› æ­¤æ¥ä¸‹æ¥å‘å·¦æ”¶ç¼©ï¼Œæœç´¢<code>[l, m]</code>å³å¯ï¼Œäºæ˜¯æˆ‘ä»¬æŠŠ<code>r</code>æ›´æ–°ä¸º<code>m</code>ã€‚</li>
</ol>
<p>ï¼ˆ3ï¼‰è¶Šç•Œæƒ…å†µ</p>
<p>å¦‚æœç›®æ ‡æ•°å­—æ¯”æ•°ç»„æœ€åä¸€ä¸ªæ•°å­—è¿˜è¦å¤§ï¼Œé‚£ä¹ˆå¾ªç¯ç»“æŸå<code>l = nums.length</code>ï¼Œå› æ­¤éœ€è¦åšä¸€ä¸ªè¶Šç•Œåˆ¤æ–­ã€‚<br>æ¯”å¦‚åœ¨[2, 2]ä¸­æŸ¥æ‰¾3ï¼Œé‚£ä¹ˆæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>æ‰§è¡Œå‰(l, r)</th>
<th>m</th>
<th>æ‰§è¡Œå(l, r)</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>(0, 2)</td>
<td>1</td>
<td>(2, 2)</td>
</tr>
</tbody></table>
<p>å¾ªç¯ç»“æŸï¼Œl = r = 2ï¼Œå·²ç»è¶Šç•Œï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­ã€‚</p>
<p>ï¼ˆ4ï¼‰åŒé—­å†™æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">searchLeft</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, r = nums.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (l &lt;= r) &#123;</span><br><span class="line">        <span class="keyword">int</span> m = l + ((r - l) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nums[m] == target)</span><br><span class="line">            r = m - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[m] &lt; target)</span><br><span class="line">            l = m + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            r = m - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= nums.length || nums[l] != target)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="æŸ¥æ‰¾å³è¾¹ç•Œ"><a href="#æŸ¥æ‰¾å³è¾¹ç•Œ" class="headerlink" title="æŸ¥æ‰¾å³è¾¹ç•Œ"></a>æŸ¥æ‰¾å³è¾¹ç•Œ</h2><p>å¸¸ç”¨æ¨¡æ¿å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">searchRight</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>, r = nums.length;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">        <span class="keyword">int</span> m = l + ((r - l) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (nums[m] == target)</span><br><span class="line">            l = m + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[m] &lt; target)</span><br><span class="line">            l = m + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nums[m] &gt; target)</span><br><span class="line">            r = m;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (l - <span class="number">1</span> &lt; <span class="number">0</span> || nums[l - <span class="number">1</span>] != target) </span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span>  l - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ï¼ˆ1ï¼‰æœç´¢åŒºé—´</p>
<p>åœ¨å¾ªç¯ä¸­æœç´¢å·¦é—­å³å¼€åŒºé—´<code>[l, r)</code>ï¼Œç»ˆæ­¢æ¡ä»¶<code>l = r</code>ã€‚<br>ä½†æ˜¯ï¼Œæ³¨æ„<code>if (nums[m] == target) l = m + 1</code>è¿™ä¸ªè¯­å¥ï¼Œä¸€æ—¦<code>nums[m]</code>ä¸<code>target</code>ç›¸ç­‰ï¼Œ<code>l</code>å°±ç­‰äº<code>m+1</code>ï¼Œæ‰€ä»¥å¾ªç¯ç»“æŸä¹‹åï¼Œ<code>nums[l]</code>å¿…ç„¶ä¸ç­‰äº<code>target</code>ï¼Œæœ€ç»ˆ<code>l</code>æ¯”å³è¾¹ç•Œå¤§1ï¼Œè¿”å›çš„æ—¶å€™éœ€è¦æŠŠ<code>l-1</code>ã€‚</p>
<p>ï¼ˆ2ï¼‰æ”¶ç¼©é€»è¾‘</p>
<ol>
<li>å¦‚æœ<code>nums[m] = target</code>ï¼Œè¿™æ—¶å€™åˆšå¥½æ‰¾åˆ°äº†<code>target</code>ï¼Œä¸è¦ç«‹å³è¿”å›ï¼Œè€Œæ˜¯ç¼©å°åŒºé—´çš„å·¦è¾¹ç•Œï¼Œå°†<code>l</code>æ›´æ–°ä¸º<code>m + 1</code>ï¼Œåœ¨åŒºé—´<code>[m + 1, r)</code>ä¸­ç»§ç»­æœç´¢ï¼Œä¸æ–­å‘å³æ”¶ç¼©ï¼Œè¾¾åˆ°é”å®šå³ä¾§è¾¹ç•Œçš„ç›®çš„ã€‚</li>
<li>å¦‚æœ<code>nums[m] &lt; target</code>ï¼Œè¯´æ˜<code>[l, m]</code>æ•´ä¸ªåŒºé—´éƒ½å°äº<code>target</code>ï¼Œå› æ­¤æ¥ä¸‹æ¥å‘å³æ”¶ç¼©ï¼Œæœç´¢<code>[m + 1, r]</code>å³å¯ï¼Œäºæ˜¯æˆ‘ä»¬æŠŠ<code>l</code>æ›´æ–°ä¸º<code>m + 1</code>ã€‚</li>
<li>å¦‚æœ<code>nums[m] &gt; target</code>ï¼Œè¯´æ˜<code>[m, r]</code>æ•´ä¸ªåŒºé—´éƒ½å¤§äº<code>target</code>ï¼Œå› æ­¤æ¥ä¸‹æ¥å‘å·¦æ”¶ç¼©ï¼Œæœç´¢<code>[l, m]</code>å³å¯ï¼Œäºæ˜¯æˆ‘ä»¬æŠŠ<code>r</code>æ›´æ–°ä¸º<code>m</code>ã€‚</li>
</ol>
<p>ï¼ˆ3ï¼‰è¶Šç•Œæƒ…å†µ</p>
<p>å¦‚æœç›®æ ‡æ•°å­—æ¯”æ•°ç»„ç¬¬ä¸€ä¸ªæ•°å­—è¿˜è¦å¤§ï¼Œé‚£ä¹ˆå¾ªç¯ç»“æŸå<code>l = 0</code>ï¼Œå› æ­¤éœ€è¦åšä¸€ä¸ªè¶Šç•Œåˆ¤æ–­ã€‚<br>æ¯”å¦‚åœ¨[2, 2]ä¸­æŸ¥æ‰¾1ï¼Œé‚£ä¹ˆæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>æ‰§è¡Œå‰(l, r)</th>
<th>m</th>
<th>æ‰§è¡Œå(l, r)</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>(0, 2)</td>
<td>1</td>
<td>(0, 1)</td>
</tr>
<tr>
<td>2</td>
<td>(0, 1)</td>
<td>0</td>
<td>(0, 0)</td>
</tr>
</tbody></table>
<p>å¾ªç¯ç»“æŸï¼Œl = r = 0ï¼Œ(l - 1)å·²ç»è¶Šç•Œï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­ã€‚<br>â€‹</p>
<h2 id="åŠ›æ‰£ç»ƒä¹ "><a href="#åŠ›æ‰£ç»ƒä¹ " class="headerlink" title="åŠ›æ‰£ç»ƒä¹ "></a>åŠ›æ‰£ç»ƒä¹ </h2><p>é¢˜å‹1ï¼šäºŒåˆ†ä¸‹æ ‡ï¼ˆåœ¨æ•°ç»„ä¸­æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„å…ƒç´ çš„ä¸‹æ ‡ï¼‰<br>ä¸€èˆ¬è€Œè¨€è¿™ä¸ªæ•°ç»„æ˜¯æœ‰åºçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯åŠæœ‰åºçš„ï¼ˆæ—‹è½¬æœ‰åºæ•°ç»„æˆ–è€…å±±è„‰æ•°ç»„ï¼‰ã€‚</p>
<table>
<thead>
<tr>
<th>é¢˜ç›®</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://leetcode-cn.com/problems/binary-search/">704. äºŒåˆ†æŸ¥æ‰¾ï¼ˆç®€å•ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/find-first-and-last-position-of-element-in-sorted-array/">34. åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/search-in-rotated-sorted-array/">33. æœç´¢æ—‹è½¬æ’åºæ•°ç»„ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/search-in-rotated-sorted-array-ii/">81. æœç´¢æ—‹è½¬æ’åºæ•°ç»„ IIï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/find-minimum-in-rotated-sorted-array/">153. å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/find-minimum-in-rotated-sorted-array-ii/">154. å¯»æ‰¾æ—‹è½¬æ’åºæ•°ç»„ä¸­çš„æœ€å°å€¼ IIï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/longest-increasing-subsequence/">300. æœ€é•¿ä¸Šå‡å­åºåˆ—ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/peak-index-in-a-mountain-array/">852. å±±è„‰æ•°ç»„çš„å³°é¡¶ç´¢å¼•ï¼ˆç®€å•ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/find-in-mountain-array/">1095. å±±è„‰æ•°ç»„ä¸­æŸ¥æ‰¾ç›®æ ‡å€¼ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/median-of-two-sorted-arrays/">4. å¯»æ‰¾ä¸¤ä¸ªæœ‰åºæ•°ç»„çš„ä¸­ä½æ•°ï¼ˆå›°éš¾ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/find-k-closest-elements/">658. æ‰¾åˆ° K ä¸ªæœ€æ¥è¿‘çš„å…ƒç´ ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
</tbody></table>
<p>é¢˜å‹2ï¼šäºŒåˆ†ç­”æ¡ˆï¼ˆåœ¨ä¸€ä¸ªæœ‰èŒƒå›´çš„åŒºé—´é‡Œæœç´¢ä¸€ä¸ªæ•´æ•°ï¼‰<br>å®šä½ä¸€ä¸ªæœ‰èŒƒå›´çš„æ•´æ•°ï¼Œè¿™ä»¶äº‹æƒ…ä¹Ÿå«ã€ŒäºŒåˆ†ç­”æ¡ˆã€æˆ–è€…å«ã€ŒäºŒåˆ†ç»“æœã€ã€‚å¦‚æœé¢˜ç›®è¦æ±‚çš„æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°æœ‰æ˜ç¡®çš„èŒƒå›´ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ã€‚</p>
<table>
<thead>
<tr>
<th>é¢˜ç›®</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://leetcode-cn.com/problems/sqrtx/">69. å¹³æ–¹æ ¹ï¼ˆç®€å•ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/find-the-duplicate-number/">287. å¯»æ‰¾é‡å¤æ•°ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/guess-number-higher-or-lower/">374. çŒœæ•°å­—å¤§å°ï¼ˆç®€å•ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/sum-of-mutated-array-closest-to-target/">1300. è½¬å˜æ•°ç»„åæœ€æ¥è¿‘ç›®æ ‡å€¼çš„æ•°ç»„å’Œ</a></td>
</tr>
</tbody></table>
<p>é¢˜å‹3ï¼šäºŒåˆ†ç­”æ¡ˆçš„å‡çº§ç‰ˆï¼ˆåˆ¤åˆ«æ¡ä»¶éœ€è¦éå†æ•°ç»„ï¼‰</p>
<table>
<thead>
<tr>
<th>é¢˜ç›®</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://leetcode-cn.com/problems/split-array-largest-sum/">410. åˆ†å‰²æ•°ç»„çš„æœ€å¤§å€¼ï¼ˆå›°éš¾ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/koko-eating-bananas/">875. çˆ±åƒé¦™è•‰çš„ç‚ç‚ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/xiao-zhang-shua-ti-ji-hua/">LCP 12. å°å¼ åˆ·é¢˜è®¡åˆ’ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/minimum-number-of-days-to-make-m-bouquets/">1482. åˆ¶ä½œ m æŸèŠ±æ‰€éœ€çš„æœ€å°‘å¤©æ•°ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
<tr>
<td><a href="https://leetcode-cn.com/problems/magnetic-force-between-two-balls/">1552. ä¸¤çƒä¹‹é—´çš„ç£åŠ›ï¼ˆä¸­ç­‰ï¼‰</a></td>
</tr>
</tbody></table>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>[1] ğŸ’¤ <a href="https://leetcode-cn.com/problems/binary-search/solution/er-fen-cha-zhao-xiang-jie-by-labuladong/">labuladongåŠ›æ‰£T704é¢˜è§£</a><br>[2] ğŸ’« <a href="https://leetcode-cn.com/problems/search-insert-position/solution/te-bie-hao-yong-de-er-fen-cha-fa-fa-mo-ban-python-/">liweiweiå“¥å“¥åŠ›æ‰£T35é¢˜è§£</a><br>â€‹</p>
]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
      <tags>
        <tag>BinarySearch</tag>
      </tags>
  </entry>
  <entry>
    <title>BloomFilter</title>
    <url>/posts/13354/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰æ˜¯å¸ƒéš†åœ¨1970å¹´æå‡ºçš„ï¼Œå®ƒå®é™…ä¸Šæ˜¯ç”±ä¸€ä¸ªå¾ˆé•¿çš„bitæ•°ç»„å’Œä¸€ç³»åˆ—hashå‡½æ•°ç»„æˆï¼Œå¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥ç”¨äºæ£€ç´¢ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆä¸­ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯ç©ºé—´æ•ˆç‡å’ŒæŸ¥è¯¢æ•ˆç‡éƒ½è¿œè¿œè¶…å‡ºä¸€èˆ¬çš„ç®—æ³•ï¼Œç¼ºç‚¹æ˜¯å­˜åœ¨è¯¯å·®å’Œåˆ é™¤å›°éš¾ã€‚</p>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>æ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½åªå 1bitç©ºé—´ï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ åªèƒ½ä¸º0æˆ–1ã€‚<br>å¸ƒéš†è¿‡æ»¤å™¨è¿˜æ‹¥æœ‰Kä¸ªå“ˆå¸Œå‡½æ•°ï¼Œå½“ä¸€ä¸ªå…ƒç´ åŠ å…¥åˆ°å¸ƒéš†è¿‡æ»¤å™¨æ—¶ä¼šä½¿ç”¨kä¸ªhashå‡½æ•°å¯¹å…¶è¿›è¡Œkæ¬¡è®¡ç®—ï¼Œå¾—åˆ°kä¸ªå“ˆå¸Œå€¼ï¼Œå¹¶ä¸”æ ¹æ®å¾—åˆ°çš„å“ˆå¸Œå€¼ï¼Œåœ¨ä½æ•°ç»„ä¸­æŠŠå¯¹åº”ä¸‹æ ‡çš„å€¼ç½®ä¸º1ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13354/image1.png" class="" title="image1"><br />
<p>åˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå°±å¯¹é’™å…ƒç´ è¿›è¡Œkæ¬¡å“ˆå¸Œè®¡ç®—ï¼Œå¾—åˆ°çš„å€¼åœ¨ä½æ•°ç»„ä¸­åˆ¤æ–­æ¯ä¸ªå…ƒç´ æ˜¯å¦éƒ½ä¸º1ï¼Œå¦‚æœæ¯ä¸ªå…ƒç´ éƒ½ä¸º1ï¼Œå°±è¯´æ˜è¿™ä¸ªå€¼åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚</p>
<h2 id="è¯¯å·®"><a href="#è¯¯å·®" class="headerlink" title="è¯¯å·®"></a>è¯¯å·®</h2><p>å‡è®¾ hash å‡½æ•°ä»¥ç­‰æ¦‚ç‡æ¡ä»¶é€‰æ‹©å¹¶è®¾ç½® Bit Array ä¸­çš„æŸä¸€ä½ï¼Œm æ˜¯è¯¥ä½æ•°ç»„çš„å¤§å°ï¼Œk æ˜¯ hash å‡½æ•°çš„ä¸ªæ•°ã€‚</p>
<p>ä½æ•°ç»„ä¸­æŸä¸€ç‰¹å®šçš„ä½åœ¨è¿›è¡Œå…ƒç´ æ’å…¥æ—¶çš„hashæ“ä½œä¸­æ²¡æœ‰è¢«ç½®ä¸º1çš„æ¦‚ç‡ï¼š<br>$$<br>1 - \frac{1}{m} \<br>$$<br>é‚£ä¹ˆåœ¨æ‰€æœ‰kæ¬¡hashæ“ä½œåè¯¥ä½éƒ½æ²¡æœ‰è¢«ç½®ä¸º1çš„æ¦‚ç‡ï¼š<br>$$<br>(1 - \frac{1}{m})^k \<br>$$<br>æ’å…¥nä¸ªå…ƒç´ åï¼ŒæŸä¸€ä½ä»ç„¶ä¸º0çš„æ¦‚ç‡ï¼š<br>$$<br>(1 - \frac{1}{m})^{k \times n} \<br>$$<br>é‚£ä¹ˆï¼Œä»»æ„ä¸€ä½ä¸º1çš„æ¦‚ç‡ï¼š<br>$$<br>1 - (1 - \frac{1}{m})^{k \times n} \<br>$$<br>è¯¯å·®ç‡å³kä¸ªä½ç½®éƒ½ä¸º1çš„æ¦‚ç‡ï¼š<br>$$<br>[1 - (1 - \frac{1}{m})^{k \times n}]^k \<br>= (1 - e^{-\frac{k \times n}{m}})^k \<br>$$</p>
<p>é‚£ä¹ˆæ±‚è¯¯å·®æœ€å°æ—¶çš„kå€¼ï¼Œé—®é¢˜å°±è½¬åŒ–ä¸ºï¼š</p>
<p>$$<br>å¯¹äº f(k) = (1 - e^{-\frac{m}{n}})ï¼Œæ±‚å…¶å€¼æœ€å°æ—¶çš„kå€¼ã€‚ \<br>$$<br>è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p>$$<br>ä»¤e^{\frac{n}{m}}=bï¼Œåˆ™f(k) = (1-b^{-k})^k \<br>$$</p>
<p>$$<br>ç­‰å¼ä¸¤è¾¹å–å¯¹æ•°ï¼Œ\ln f(k) = k \times \ln (1-b^{-k}) \<br>$$</p>
<p>$$<br>ç­‰å¼ä¸¤è¾¹æ±‚å¯¼æ•°ï¼Œ\frac{1}{f(k)} \times {f^{â€˜}(k)} = \ln(1-b^{-k}) + k \times {\frac{1}{1-b^{-k}} \times (-b^{-k}) \times \ln (b) \times (-1)} \<br>$$</p>
<p>$$<br>ç®€åŒ–ï¼Œ\frac{f^{â€˜}(k)}{f(k)} = \ln(1-b^{-k}) + k \times {\frac{b^{-k} \ln b}{1-b^{-k}}} \<br>$$</p>
<p>$$<br>ä»¤f^{â€˜}(k) = 0ï¼Œåˆ™\ln(1-b^{-k}) + k \times {\frac{b^{-k} \ln b}{1-b^{-k}}} = 0 \<br>$$</p>
<p>$$<br>ä»¤1-b^{-k}=aï¼Œåˆ™b=-\frac{\ln (1-a)}{k} \<br>$$</p>
<p>$$<br>ä¸Šå¼è½¬åŒ–ä¸ºï¼Œ\ln a + {k} \times {\frac{(1-a) \times ({-\frac{1}{k}}) \times {\ln (1-a)}}{a}} = 0 \<br>$$</p>
<p>$$<br>ç®€åŒ–ï¼Œa \ln a = (1 - a) \ln (1-a) \<br>$$</p>
<p>$$<br>æ ¹æ®g(x) = xlnxçš„ç‰¹æ€§ï¼Œa = 1 - a =&gt; a = \frac{1}{2} \<br>$$</p>
<p>$$<br>ä»è€Œï¼Œ1 - b^{-k} = \frac{1}{2} =&gt; b^{-k} = \frac{1}{2} \<br>$$</p>
<p>$$<br>æ‰€ä»¥ï¼Œk = \frac{m}{n} \ln 2 \<br>$$</p>
<h2 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h2><p>ä¸åŒçš„å“ˆå¸Œå‡½æ•°å¯¹äºéšæœºå­—ç¬¦çš„æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>å“ˆå¸Œå‡½æ•°</th>
<th>æ—¶é—´(ns)</th>
<th>å†²çªä¸ªæ•°</th>
<th>æ€»ä¸ªæ•°</th>
</tr>
</thead>
<tbody><tr>
<td>SDBMHash</td>
<td>158062897</td>
<td>180</td>
<td>1000000</td>
</tr>
<tr>
<td>SimMurMurHash</td>
<td>144356292</td>
<td>108</td>
<td>1000000</td>
</tr>
<tr>
<td>JSHash</td>
<td>160829523</td>
<td>230</td>
<td>1000000</td>
</tr>
<tr>
<td>PJW</td>
<td>169142421</td>
<td>3901</td>
<td>1000000</td>
</tr>
<tr>
<td>MurMurHash2</td>
<td>144678973</td>
<td>129</td>
<td>1000000</td>
</tr>
<tr>
<td>ELFHash</td>
<td>173966075</td>
<td>3901</td>
<td>1000000</td>
</tr>
<tr>
<td>BKDRHash</td>
<td>160517055</td>
<td>258</td>
<td>1000000</td>
</tr>
<tr>
<td>CalcNrHash</td>
<td>180425843</td>
<td>124</td>
<td>1000000</td>
</tr>
<tr>
<td>APHash</td>
<td>166644369</td>
<td>245</td>
<td>1000000</td>
</tr>
<tr>
<td>BPHash</td>
<td>144647091</td>
<td>920005</td>
<td>1000000</td>
</tr>
<tr>
<td>FNVHash</td>
<td>160584860</td>
<td>109</td>
<td>1000000</td>
</tr>
<tr>
<td>RSHash</td>
<td>160316468</td>
<td>240</td>
<td>1000000</td>
</tr>
<tr>
<td>DJB</td>
<td>185411123</td>
<td>97</td>
<td>1000000</td>
</tr>
<tr>
<td>DJB2Hash</td>
<td>151799803</td>
<td>97</td>
<td>1000000</td>
</tr>
<tr>
<td>DEKHash</td>
<td>145856752</td>
<td>119</td>
<td>1000000</td>
</tr>
<tr>
<td>SipHashNoCase</td>
<td>205930199</td>
<td>126</td>
<td>1000000</td>
</tr>
<tr>
<td>SipHash</td>
<td>187972639</td>
<td>126</td>
<td>1000000</td>
</tr>
</tbody></table>
<p>ç»è¿‡å¾ˆå¤šç´ æçš„æµ‹è¯•ï¼Œæœ€ç»ˆé€‰æ‹©äº†<code>MurmurHash2</code>å‡½æ•°ã€‚<br>â€‹</p>
<blockquote>
<p>è‰ç¨¿</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13354/image2.jpg" class="" title="image2">
</blockquote>
]]></content>
      <categories>
        <category>BloomFilter</category>
      </categories>
      <tags>
        <tag>BloomFilter</tag>
      </tags>
  </entry>
  <entry>
    <title>Chartjs</title>
    <url>/posts/50163/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>å‰è¨€</p>
</blockquote>
<p>å››æœˆäº†ï¼Œæ°´ä¸€ç¯‡åšå®¢å§ï¼Œå…³äº<code>hexo-tag-chart</code>æ’ä»¶çš„ä½¿ç”¨ï¼Œæ–‡æ¡£åªæœ‰ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå®˜æ–¹æ–‡æ¡£åªç»™å‡º<code>js</code>ç”¨æ³•ï¼Œè‡³äºæ€ä¹ˆä½¿ç”¨ä»¥åŠç”¨åˆ°ä½•ç§ç¨‹åº¦ï¼Œå°±çœ‹è‡ªå·±çš„é€ åŒ–å§ã€‚</p>
<p>ç¤ºä¾‹ï¼š<a href="https://shen-yu.gitee.io/2020/chartjs">æ²ˆå®‡å¤§ä½¬åšå®¢</a></p>
<p>æ–‡æ¡£ï¼š<a href="https://chartjs.bootcss.com/">ä¸­æ–‡å®˜æ–¹æ–‡æ¡£</a></p>
<h3 id="æ¯æœˆæ˜ç»†"><a href="#æ¯æœˆæ˜ç»†" class="headerlink" title="æ¯æœˆæ˜ç»†"></a>æ¯æœˆæ˜ç»†</h3><div style="width: 80%;margin: 0 auto">
    <canvas id="chart8775" style="height: 120px"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script type="text/javascript">
    var ctx = document.getElementById('chart8775').getContext('2d');
    var options = {
    type: 'line',
    data: {
        labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
        datasets: [{
        	label: '2020',
            borderColor: 'orange',
            backgroundColor: 'yellow',
			data: [0, 0, 0, 0, 0, 1, 0, 0, 1, 6, 5, 1], 
		},{
			label: '2021',
            borderColor: 'blue',
            backgroundColor: 'lightBlue',
			data: [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
		}]
    },
    options: {
        responsive: true,
        title: {
            display: true,
            text: 'æ¯æœˆæ˜ç»†'
        }
    }
};;
    new Chart(ctx, options);
</script>



<a id="more"></a>




<h3 id="å¹´åº¦ç»Ÿè®¡"><a href="#å¹´åº¦ç»Ÿè®¡" class="headerlink" title="å¹´åº¦ç»Ÿè®¡"></a>å¹´åº¦ç»Ÿè®¡</h3><div style="width: 100%;margin: 0 auto">
    <canvas id="chart3775" style="height: 100px"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script type="text/javascript">
    var ctx = document.getElementById('chart3775').getContext('2d');
    var options = {
    type: 'polarArea',
    data: {
        labels: ['2020', '2021'],
        datasets: [{
            backgroundColor: ['orange', 'blue'],
			data: [14, 1], 
		}]
    },
    options: {
        responsive: true,
        title: {
            display: true,
            text: 'åšå®¢ç»Ÿè®¡'
        }
    }
};;
    new Chart(ctx, options);
</script>



<h3 id="èƒ½åŠ›é›·è¾¾"><a href="#èƒ½åŠ›é›·è¾¾" class="headerlink" title="èƒ½åŠ›é›·è¾¾"></a>èƒ½åŠ›é›·è¾¾</h3><div style="width: 100%;margin: 0 auto">
    <canvas id="chart189" style="height: 100px"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script type="text/javascript">
    var ctx = document.getElementById('chart189').getContext('2d');
    var options = {
    type: 'radar',
    data: {
        labels: ['Java', 'MySQL', 'Redis', 'Spring', 'SpringBoot', 'SpringCloud Alibaba', 'Vue', 'TCP/IP', 'OS'],
        datasets: [{
            label: '2020',
            fill: true,
            borderColor: 'rgb(253, 100, 131)',
			pointHoverBackgroundColor: 'red',
			data: [0.5, 0.4, 0.4, 0.1, 0.5, 0.2, 0.2, 0.5, 0.3]
		},
		{
			label: '2021',
			fill: true,
			borderColor: 'rgb(100, 147, 208)',
			pointHoverBackgroundColor: 'blue', 
			data: [0.7, 0.7, 0.5, 0.5, 0.7, 0.5, 0.1, 0.6, 0.2]
        }]
    },
    options: {
        responsive: true,
        title: {
            display: true,
            text: 'èƒ½åŠ›é›·è¾¾'
        }
    }
};;
    new Chart(ctx, options);
</script>

]]></content>
      <categories>
        <category>Frontend</category>
      </categories>
      <tags>
        <tag>Chartjs</tag>
      </tags>
  </entry>
  <entry>
    <title>CopyOnWriteArrayList</title>
    <url>/posts/48481/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ğŸ” åŸºäºJDK1.8çš„CopyOnWriteArrayListæºç è§£æã€‚</p>
<p>âš¡ æ¶‰åŠçš„APIï¼š<code>System#copyArray(Object src, int srcPos,Object dest, int destPos, int length)</code></p>
<p>ç”¨äºæ•°ç»„å…‹éš†ï¼Œå‚æ•°å¦‚ä¸‹ï¼š</p>
<ol>
<li>srcï¼šåŸæ•°ç»„</li>
<li>srcPosï¼šåŸæ•°ç»„å…‹éš†çš„èµ·å§‹ä½ç½®</li>
<li>destï¼šæ–°æ•°ç»„</li>
<li>destPosï¼šæ–°æ•°ç»„å…‹éš†çš„èµ·å§‹ä½ç½®</li>
<li>lengthï¼šå…‹éš†çš„é•¿åº¦</li>
</ol>
<h2 id="åŸºæœ¬çŸ¥è¯†"><a href="#åŸºæœ¬çŸ¥è¯†" class="headerlink" title="åŸºæœ¬çŸ¥è¯†"></a>åŸºæœ¬çŸ¥è¯†</h2><ul>
<li><p>å§‹äºï¼š<strong>JDK 1.5</strong></p>
</li>
<li><p>ä½œè€…ï¼š<strong>Doug Lea</strong></p>
</li>
<li><p>ç‰¹ç‚¹ï¼šçº¿ç¨‹å®‰å…¨ï¼Œå†™æ—¶åŠ é”ï¼Œè¯»ä¸åŠ é”ï¼Œæ”¯æŒè¯»å¤šå†™å°‘çš„åœºæ™¯</p>
</li>
<li><p>æ€æƒ³ï¼šå†™æ—¶å¤åˆ¶ï¼ˆcopy on writeï¼Œç®€ç§°COWï¼‰</p>
<p>å†™æ—¶å¤åˆ¶æ˜¯CSé¢†åŸŸçš„ä¸€ç§ä¼˜åŒ–ç­–ç•¥ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœæœ‰å¤šä¸ªè°ƒç”¨è€…åŒæ—¶è¯·æ±‚ç›¸åŒçš„èµ„æºï¼Œå®ƒä»¬ä¼šè·å–ç›¸åŒçš„æŒ‡é’ˆæŒ‡å‘çš„èµ„æºï¼›å¦‚æœæŸä¸ªè°ƒç”¨è€…è¯•å›¾ä¿®æ”¹èµ„æºçš„å†…å®¹æ—¶ï¼Œå¤åˆ¶ä¸€ä»½å‰¯æœ¬ç»™è¯¥è°ƒç”¨è€…ï¼Œè¯¥è°ƒç”¨è€…ä¿®æ”¹çš„ä¾¿æ˜¯å‰¯æœ¬ï¼Œå…¶ä»–è°ƒç”¨è€…æ‰€è§çš„ä¾ç„¶æ˜¯æœ€åˆçš„èµ„æºï¼Œå½“ä¿®æ”¹å®Œæ¯•æ—¶ï¼Œä½¿ç”¨å‰¯æœ¬æ›¿æ¢åŸå§‹èµ„æºã€‚</p>
</li>
<li><p>ç±»å›¾ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/48481/CopyOnWriteArrayList.png" class="" title="image-20210611111106058">



</li>
</ul>
<h2 id="åŸºæœ¬å±æ€§"><a href="#åŸºæœ¬å±æ€§" class="headerlink" title="åŸºæœ¬å±æ€§"></a>åŸºæœ¬å±æ€§</h2><p>ä¸¤ä¸ªå±æ€§ï¼Œç®€å•æ˜äº†ï¼›æ•°ç»„å­˜å‚¨æ•°æ®ï¼Œç‹¬å é”ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç‹¬å å¼å¯é‡å…¥é”ï¼Œç”¨äºå¯¹å†™æ“ä½œåŠ é”</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">transient</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­˜æ”¾æ•°æ®çš„æ•°ç»„ï¼Œä¿è¯çº¿ç¨‹å¯è§æ€§</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Object[] array;</span><br></pre></td></tr></table></figure>



<h2 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><p>æ— å‚æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setArray</span><span class="params">(Object[] a)</span> </span>&#123;</span><br><span class="line">    array = a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArrayList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç›´æ¥åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º0çš„Objectæ•°ç»„ï¼Œèµ‹å€¼ç»™array</span></span><br><span class="line">    setArray(<span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é›†åˆæ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArrayList</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ–°æ•°ç»„</span></span><br><span class="line">    Object[] elements;</span><br><span class="line">    <span class="comment">// å¦‚æœé›†åˆç±»å‹ç›¸åŒï¼Œç›´æ¥è·å–è¯¥é›†åˆçš„æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (c.getClass() == CopyOnWriteArrayList.class)</span><br><span class="line">        elements = ((CopyOnWriteArrayList&lt;?&gt;)c).getArray();</span><br><span class="line">    <span class="comment">// å¦‚æœé›†åˆç±»å‹ä¸åŒï¼Œåˆ™å°†è¯¥é›†åˆè½¬æ¢ä¸ºæ•°ç»„</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        elements = c.toArray();</span><br><span class="line">        <span class="comment">// cçš„ç±»å‹ä¸ä¸ºObjectï¼Œè½¬æ¢ä¸ºObject</span></span><br><span class="line">        <span class="keyword">if</span> (elements.getClass() != Object[].class)</span><br><span class="line">            elements = Arrays.copyOf(elements, elements.length, Object[].class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†æ–°æ•°ç»„çš„èµ‹å€¼ç»™array</span></span><br><span class="line">    setArray(elements);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•°ç»„æ„é€ ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CopyOnWriteArrayList</span><span class="params">(E[] toCopyIn)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹·è´ä¸€ä»½æ•°ç»„èµ‹å€¼ç»™array</span></span><br><span class="line">    setArray(Arrays.copyOf(toCopyIn, toCopyIn.length, Object[].class));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="add-E-e"><a href="#add-E-e" class="headerlink" title="add(E e)"></a>add(E e)</h2><p>ç”¨é€”ï¼šå‘æ•°ç»„æœ«å°¾æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–ç‹¬å é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–array</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="comment">// è·å–arrayé•¿åº¦</span></span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        <span class="comment">// å¤åˆ¶arrayçš„å†…å®¹åˆ°æ–°æ•°ç»„ï¼Œé•¿åº¦+1</span></span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// åœ¨æ–°æ•°ç»„æœ«å°¾æ·»åŠ å…ƒç´ </span></span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        <span class="comment">// å°†æ–°æ•°ç»„èµ‹å€¼ç»™array</span></span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµç¨‹ï¼š</p>
<ol>
<li>è·å–ç‹¬å é”</li>
<li>åŠ é”</li>
<li>å¤åˆ¶ä¸€ä»½<code>array</code>ç»™æ–°æ•°ç»„ï¼Œæ–°æ•°ç»„é•¿åº¦ä¸º<code>array</code>çš„é•¿åº¦+1</li>
<li>åœ¨æ–°æ•°ç»„çš„æœ«å°¾æ·»åŠ æ–°å…ƒç´ </li>
<li>å°†æ–°æ•°ç»„èµ‹å€¼ç»™<code>array</code></li>
<li>é‡Šæ”¾ç‹¬å é”</li>
</ol>
<h2 id="add-int-index-E-element"><a href="#add-int-index-E-element" class="headerlink" title="add (int index, E element)"></a>add (int index, E element)</h2><p>ç”¨é€”ï¼šåœ¨æ•°ç»„çš„æŒ‡å®šä¸‹æ ‡æ·»åŠ æŒ‡å®šå…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–ç‹¬å é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–array</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="comment">// è·å–array</span></span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥indexçš„åˆæ³•æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (index &gt; len || index &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">&quot;Index: &quot;</span>+index+</span><br><span class="line">                                                <span class="string">&quot;, Size: &quot;</span>+len);</span><br><span class="line">        <span class="comment">// æ–°æ•°ç»„ï¼Œé•¿åº¦ä¸ºarray.length + 1</span></span><br><span class="line">        Object[] newElements;</span><br><span class="line">        <span class="comment">// éœ€è¦ç§»åŠ¨çš„å…ƒç´ æ•°é‡ï¼Œåœ¨indexä¹‹å(åŒ…å«index)çš„å…ƒç´ å…¨éƒ¨éœ€è¦ç§»åŠ¨</span></span><br><span class="line">        <span class="keyword">int</span> numMoved = len - index;</span><br><span class="line">        <span class="comment">// æ’åœ¨æ•°ç»„æœ«å°¾ï¼Œä¸éœ€è¦ç§»åŠ¨</span></span><br><span class="line">        <span class="keyword">if</span> (numMoved == <span class="number">0</span>)</span><br><span class="line">            newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// æ’åœ¨æ•°ç»„ä¸­éƒ¨ï¼Œåé¢å…ƒç´ ç§»åŠ¨</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            newElements = <span class="keyword">new</span> Object[len + <span class="number">1</span>];</span><br><span class="line">            <span class="comment">// å°†indexä¹‹å‰çš„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­ï¼Œä½ç½®ä¸å˜</span></span><br><span class="line">            System.arraycopy(elements, <span class="number">0</span>, newElements, <span class="number">0</span>, index);</span><br><span class="line">            <span class="comment">// å°†indexåŠä¹‹åçš„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­ï¼Œä¸‹æ ‡+1</span></span><br><span class="line">            System.arraycopy(elements, index, newElements, index + <span class="number">1</span>,</span><br><span class="line">                             numMoved);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°†æ–°å…ƒç´ æ’å…¥åˆ°indexä½ç½®</span></span><br><span class="line">        newElements[index] = element;</span><br><span class="line">        <span class="comment">// å°†æ–°æ•°ç»„èµ‹å€¼ç»™array</span></span><br><span class="line">        setArray(newElements);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="set-int-index-E-element"><a href="#set-int-index-E-element" class="headerlink" title="set(int index, E element)"></a>set(int index, E element)</h2><p>ç”¨é€”ï¼šè®¾ç½®æ•°ç»„æŒ‡å®šä¸‹æ ‡çš„å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">set</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–ç‹¬å é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–array</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="comment">// è·å–arrayä¸‹æ ‡ä¸ºindexçš„å…ƒç´ </span></span><br><span class="line">        E oldValue = get(elements, index);</span><br><span class="line">        <span class="comment">// å¦‚æœæ—§å…ƒç´ ä¸æ–°å…ƒç´ ä¸ç›¸ç­‰</span></span><br><span class="line">        <span class="keyword">if</span> (oldValue != element) &#123;</span><br><span class="line">            <span class="keyword">int</span> len = elements.length;</span><br><span class="line">            <span class="comment">// å¤åˆ¶ä¸€ä»½æ–°æ•°ç»„ï¼Œé•¿åº¦å’Œarrayä¿æŒä¸€è‡´</span></span><br><span class="line">            Object[] newElements = Arrays.copyOf(elements, len);</span><br><span class="line">            <span class="comment">// ä¿®æ”¹æ–°æ•°ç»„indexä¸‹æ ‡çš„å€¼</span></span><br><span class="line">            newElements[index] = element;</span><br><span class="line">            <span class="comment">// å°†æ–°æ•°ç»„èµ‹å€¼ç»™array</span></span><br><span class="line">            setArray(newElements);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å³æ—¶æ–°å€¼å’Œæ—§å€¼ä¸€è‡´ï¼Œä¸ºäº†ç¡®ä¿volatileè¯­ä¹‰ï¼Œéœ€è¦é‡æ–°è®¾ç½®array</span></span><br><span class="line">            setArray(elements);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›æ—§å…ƒç´ </span></span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="remove-int-index"><a href="#remove-int-index" class="headerlink" title="remove(int index)"></a>remove(int index)</h2><p>ç”¨é€”ï¼šåˆ é™¤æ•°ç»„æŒ‡å®šä¸‹æ ‡çš„å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–ç‹¬å é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–array</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="comment">// è·å–arrayé•¿åº¦</span></span><br><span class="line">        <span class="keyword">int</span> len = elements.length;</span><br><span class="line">        <span class="comment">// è·å–å¾…åˆ é™¤å…ƒç´ </span></span><br><span class="line">        E oldValue = get(elements, index);</span><br><span class="line">        <span class="comment">// éœ€è¦ç§»åŠ¨çš„å…ƒç´ æ•°é‡ï¼Œåœ¨indexä¹‹å(ä¸åŒ…å«index)çš„å…ƒç´ å…¨éƒ¨éœ€è¦ç§»åŠ¨</span></span><br><span class="line">        <span class="keyword">int</span> numMoved = len - index - <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœåˆ é™¤å…ƒç´ åœ¨æœ«å°¾ï¼Œéœ€è¦ç§»åŠ¨</span></span><br><span class="line">        <span class="keyword">if</span> (numMoved == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// ç›´æ¥å¤åˆ¶ä¸€ä»½æ–°æ•°ç»„ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¸¢å¼ƒ</span></span><br><span class="line">            <span class="comment">// å¹¶å°†æ–°æ•°ç»„èµ‹å€¼ç»™array</span></span><br><span class="line">            setArray(Arrays.copyOf(elements, len - <span class="number">1</span>));</span><br><span class="line">        <span class="comment">// å¦‚æœåˆ é™¤å…ƒç´ åœ¨ä¸­éƒ¨ï¼ŒindexåŠåé¢å…ƒç´ ç§»åŠ¨</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ–°æ•°ç»„ï¼Œé•¿åº¦ä¸ºarray.length - 1</span></span><br><span class="line">            Object[] newElements = <span class="keyword">new</span> Object[len - <span class="number">1</span>];</span><br><span class="line">            <span class="comment">// å°†indexä¹‹å‰çš„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­ï¼Œä½ç½®ä¸å˜</span></span><br><span class="line">            System.arraycopy(elements, <span class="number">0</span>, newElements, <span class="number">0</span>, index);</span><br><span class="line">            <span class="comment">// å°†indexä¹‹åçš„å…ƒç´ å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­ï¼Œä¸‹æ ‡ - 1</span></span><br><span class="line">            System.arraycopy(elements, index + <span class="number">1</span>, newElements, index,</span><br><span class="line">                             numMoved);</span><br><span class="line">            <span class="comment">// å°†æ–°æ•°ç»„çš„å€¼èµ‹å€¼ç»™array</span></span><br><span class="line">            setArray(newElements);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿”å›åˆ é™¤å…ƒç´ </span></span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="get-int-index"><a href="#get-int-index" class="headerlink" title="get(int index)"></a>get(int index)</h2><p>ç”¨é€”ï¼šè·å–æ•°ç»„æŒ‡å®šä¸‹æ ‡çš„å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> get(getArray(), index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">get</span><span class="params">(Object[] a, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (E) a[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•´ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰åŠ é”ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹å¯èƒ½å‡ºç°å¦‚ä¸‹æƒ…å†µï¼š</p>
<ol>
<li>çº¿ç¨‹1è°ƒç”¨<code>get</code>æ–¹æ³•è·å–å€¼ï¼Œå†…éƒ¨é€šè¿‡<code>getArray</code>æ–¹æ³•è·å–åˆ°<code>array</code>æ•°ç»„ï¼›</li>
<li>çº¿ç¨‹2è°ƒç”¨<code>add</code>/<code>set</code>/<code>remove</code>æ–¹æ³•ï¼Œå†…éƒ¨é€šè¿‡<code>setArray</code>æ–¹æ³•ä¿®æ”¹äº†<code>array</code>æ•°ç»„ï¼›</li>
<li>çº¿ç¨‹1çœ‹çš„ä¾ç„¶æ˜¯æ›¾ç»çš„<code>array</code>ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œ<code>get</code>æ–¹æ³•æ˜¯å¼±ä¸€è‡´æ€§çš„ã€‚</p>
<h2 id="Iterator"><a href="#Iterator" class="headerlink" title="Iterator"></a>Iterator</h2><p>è¿­ä»£å™¨ï¼Œç”¨äºéå†æ•°ç»„å…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> COWIterator&lt;E&gt;(getArray(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">COWIterator</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">ListIterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// æ•°ç»„å¿«ç…§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] snapshot;</span><br><span class="line">    <span class="comment">// æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cursor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">COWIterator</span><span class="params">(Object[] elements, <span class="keyword">int</span> initialCursor)</span> </span>&#123;</span><br><span class="line">        cursor = initialCursor;</span><br><span class="line">        snapshot = elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦éå†ç»“æŸ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cursor &lt; snapshot.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å…ƒç´ </span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> E <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! hasNext())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">        <span class="keyword">return</span> (E) snapshot[cursor++];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬è°ƒç”¨<code>interator()</code>æ–¹æ³•è·å–è¿­ä»£å™¨æ—¶ï¼Œå®é™…ä¸Šè¿”å›ä¸€ä¸ª<code>COWIterator</code>å¯¹è±¡ï¼Œå…¶ä¸­å¿«ç…§<code>snapshot</code>ä¿å­˜çš„æ˜¯å½“å‰<code>array</code>çš„å†…å®¹ï¼Œä¸‹æ ‡<code>cursor</code>ä¸º0ã€‚</p>
<p>è¿­ä»£å™¨æ²¡æœ‰åœ¨é”ä¸­è¿›è¡Œï¼Œä¾ç„¶æ˜¯å¼±ä¸€è‡´æ€§çš„ã€‚</p>
<p>æ¯”å¦‚ï¼Œä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CopyOnWriteArrayList&lt;String&gt; list = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">list.add(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">    list.add(<span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">Iterator&lt;String&gt; iterator = list.iterator();</span><br><span class="line">thread.start();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    System.out.println(iterator.next());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¿è¯è¿­ä»£å™¨åœ¨å¦ä¸€ä¸ªæ·»åŠ æ•°æ®çš„çº¿ç¨‹å‰è·å–ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Hello</span><br></pre></td></tr></table></figure>



<h2 id="æœ€åå°ç»“"><a href="#æœ€åå°ç»“" class="headerlink" title="æœ€åå°ç»“"></a>æœ€åå°ç»“</h2><ol>
<li><p><code>CopyOnWriteArrayList</code>ä½“ç°äº†å†™æ—¶å¤åˆ¶çš„æ€æƒ³ï¼Œå¢åˆ æ”¹éƒ½æ˜¯åœ¨å‰¯æœ¬ä¸­è¿›è¡Œï¼›</p>
</li>
<li><p><code>CopyOnWriteArrayList</code>çš„å–å€¼æ–¹æ³•æ˜¯å¼±ä¸€è‡´æ€§çš„ï¼Œæ— æ³•ç¡®ä¿å®æ—¶è·å¾—çš„æ˜¯æœ€æ–°çš„æ•°æ®ï¼›</p>
</li>
<li><p><code>CopyOnWriteArrayList</code>çš„å¢åˆ æ”¹æ“ä½œéƒ½æ˜¯åœ¨ç‹¬å å¼å¯é‡å…¥é”ä¸­è¿›è¡Œï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ï¼›</p>
</li>
<li><p><code>CopyOnWriteArrayList</code>çš„çº¿ç¨‹å®‰å…¨æ€§ä½“ç°åœ¨å¤šçº¿ç¨‹ä¿®æ”¹ä¸ä¼šæŠ›å‡º<br> <code>java.util.ConcurrentModificationException</code>å¼‚å¸¸ï¼Œå¹¶ä¸èƒ½ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼›</p>
</li>
<li><p>åŒä¸€æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¯¹<code>CopyOnWriteArrayList</code>è¿›è¡Œå¢åˆ æ”¹æ“ä½œï¼Œè€Œè¯»æ“ä½œæ²¡æœ‰é™åˆ¶ã€‚å¢åˆ æ”¹æ“ä½œéƒ½éœ€è¦å¤åˆ¶ä¸€ä»½æ–°æ•°ç»„ï¼Œå¢åŠ äº†å†…å­˜æ¶ˆè€—ï¼Œæ‰€ä»¥æ›´é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>åšå¼ˆè®º</title>
    <url>/posts/12bcd26e/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><center>
    <font face="Kristen ITC" color="#555555" size=3>Khighnessã€å¯»æ‰¾å¿…è´¥æ€</font><br>
</center>



<h2 id="1-å·´ä»€åšå¼ˆ"><a href="#1-å·´ä»€åšå¼ˆ" class="headerlink" title="1. å·´ä»€åšå¼ˆ"></a>1. å·´ä»€åšå¼ˆ</h2><br>

<h3 id="1-1-é—®é¢˜"><a href="#1-1-é—®é¢˜" class="headerlink" title="1.1 é—®é¢˜"></a>1.1 é—®é¢˜</h3><blockquote>
<p>ä¸¤ä¸ªé¡¶å°–èªæ˜çš„äººåœ¨ç©æ¸¸æˆï¼Œæœ‰ n ä¸ªçŸ³å­ï¼Œæ¯ä¸ªäººæ¯æ¬¡æ‹¿ 1~m ä¸ªçŸ³å¤´ï¼Œæ‹¿æ‰æœ€åä¸€å—çŸ³å¤´çš„äººå°±æ˜¯è·èƒœè€…ã€‚è¯·é—®å…ˆæ‰‹ä¸åæ‰‹è°å¿…èƒœï¼Ÿ</p>
</blockquote>
<br>

<h3 id="1-2-åˆ†æ"><a href="#1-2-åˆ†æ" class="headerlink" title="1.2 åˆ†æ"></a>1.2 åˆ†æ</h3><blockquote>
<p>åˆ†ç±»è®¨è®º: </p>
<p>ï¼ˆ1ï¼‰å½“n â‰¤ mæ—¶ï¼Œè¿™æ—¶å…ˆæ‰‹çš„äººå¯ä»¥ä¸€æ¬¡å–èµ°æ‰€æœ‰çš„ï¼›</p>
<p>ï¼ˆ2ï¼‰å½“n = m+1æ—¶ï¼Œè¿™æ—¶å…ˆæ‰‹æ— è®ºå–èµ°å¤šå°‘ä¸ªï¼Œåæ‰‹çš„äººéƒ½èƒ½å–èµ°å‰©ä¸‹æ‰€æœ‰çš„ï¼›</p>
<p>ï¼ˆ3ï¼‰å½“n = k âˆ— ( m + 1)æ—¶ï¼Œå¯¹äºæ¯(m + 1)ä¸ªçŸ³å­ï¼Œå…ˆæ‰‹å–iä¸ªï¼Œåæ‰‹ä¸€å®šèƒ½å°†å‰©ä¸‹çš„(m + 1 âˆ’ i)ä¸ªéƒ½å–èµ°ï¼Œå› æ­¤åæ‰‹å¿…èƒœï¼›</p>
<p>ï¼ˆ4ï¼‰å½“n = k âˆ— ( m + 1)  + x ( 0&lt; x&lt; m + 1)æ—¶ï¼Œå…ˆæ‰‹å¯ä»¥å…ˆå– x ä¸ªï¼Œä¹‹åçš„å±€åŠ¿å°±å›åˆ°äº†ä¸Šä¸€ç§æƒ…å†µï¼Œæ— è®ºåæ‰‹å–å¤šå°‘ä¸ªï¼Œå…ˆæ‰‹éƒ½èƒ½å–èµ°m+1ä¸ªä¸­å‰©ä¸‹çš„ï¼Œå› æ­¤å…ˆæ‰‹å¿…èƒœã€‚</p>
</blockquote>
<br>

<h3 id="1-3-ç»“è®º"><a href="#1-3-ç»“è®º" class="headerlink" title="1.3 ç»“è®º"></a>1.3 ç»“è®º</h3><blockquote>
<p><strong>å½“n % m + 1) == 0æ—¶ï¼Œåæ‰‹å¿…èƒœï¼Œå¦åˆ™å…ˆæ‰‹å¿…èƒœã€‚</strong></p>
</blockquote>
<br>

<h3 id="1-4-ä»£ç "><a href="#1-4-ä»£ç " class="headerlink" title="1.4 ä»£ç "></a>1.4 ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BashGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> m)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((n % (m + <span class="number">1</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;åæ‰‹è·èƒœ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å…ˆæ‰‹è·èƒœ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h2 id="2-å°¼å§†åšå¼ˆ"><a href="#2-å°¼å§†åšå¼ˆ" class="headerlink" title="2. å°¼å§†åšå¼ˆ"></a>2. å°¼å§†åšå¼ˆ</h2><br>

<h3 id="2-1-é—®é¢˜"><a href="#2-1-é—®é¢˜" class="headerlink" title="2.1 é—®é¢˜"></a>2.1 é—®é¢˜</h3><blockquote>
<p>ä¸¤ä¸ªé¡¶å°–èªæ˜çš„äººåœ¨ç©æ¸¸æˆï¼Œæœ‰ n å †çŸ³å­ï¼Œç¬¬ i å †æœ‰ ai æ¯ä¸ªäººæ¯æ¬¡èƒ½ä»ä¸€å †çŸ³å­ä¸­å–ä»»æ„å¤šä¸ªçŸ³å­ä½†ä¸èƒ½ä¸å–ï¼Œä¸èƒ½å–çš„äººè¾“ã€‚è¯·é—®å…ˆæ‰‹ä¸åæ‰‹è°å¿…èƒœï¼Ÿ</p>
</blockquote>
<br>

<h3 id="2-2-åˆ†æ"><a href="#2-2-åˆ†æ" class="headerlink" title="2.2 åˆ†æ"></a>2.2 åˆ†æ</h3><blockquote>
<p>ï¼ˆ1ï¼‰å½“n = 1æ—¶ï¼Œæ˜¾ç„¶å…ˆæ‰‹å–èµ°è¿™ä¸€å †å°±èƒ½è·èƒœï¼›</p>
<p>ï¼ˆ2ï¼‰å½“n = 2ä¸”a1 != a2æ—¶ï¼Œæˆ‘ä»¬å‡è®¾a1 &gt; a2ï¼Œå…ˆæ‰‹å¯ä»¥å…ˆåœ¨ç¬¬ä¸€å †å–èµ°a1-a2ä¸ªï¼Œä¸‹ä¸€æ¬¡æ— è®ºåæ‰‹å–èµ°å¤šå°‘ä¸ªï¼Œå…ˆæ‰‹éƒ½å¯ä»¥åœ¨å¦ä¸€å †å–èµ°ç›¸åŒçš„ä¸ªæ•°ï¼Œå› æ­¤å…ˆæ‰‹å¿…èƒœï¼›</p>
<p>ï¼ˆ3ï¼‰å½“n = 2ä¸”a1 == a2æ—¶ï¼Œå…ˆæ‰‹æ— è®ºå–å¤šå°‘ä¸ªï¼Œåæ‰‹éƒ½å¯ä»¥åœ¨å¦ä¸€å †å–ç›¸åŒçš„ä¸ªæ•°ï¼Œå› æ­¤åæ‰‹å¿…èƒœï¼›</p>
<p>ï¼ˆ4ï¼‰å½“n &gt;= 3æ—¶ï¼Œé—®é¢˜å˜å¾—ç¹çèµ·æ¥ï¼Œå…ˆæ‰¾å‡ºè§„å¾‹æ€§çš„ç»“è®ºã€‚</p>
</blockquote>
<br>

<h3 id="2-3-ç»“è®º"><a href="#2-3-ç»“è®º" class="headerlink" title="2.3 ç»“è®º"></a>2.3 ç»“è®º</h3><blockquote>
<p><strong>å½“ a1 ^ a2 ^ Â·Â·Â· ^ an =  0 æ—¶ï¼Œåæ‰‹å¿…èƒœï¼Œå¦åˆ™å…ˆæ‰‹å¿…èƒœã€‚</strong></p>
<p><strong>è¯æ˜ï¼š</strong></p>
<p>å‡è®¾å½“å‰ï¼ša1 ^ a2 ^ Â·Â·Â· ^ an =  0ï¼Œ</p>
<p>å…ˆæ‰‹å›åˆï¼šå–èµ°è‹¥å¹²ä¸ªåï¼Œ</p>
<p>å±€åŠ¿å˜æˆï¼ša1 ^ a2 ^ Â·Â·Â· ^ an =  Kï¼Œ</p>
<p>å³ï¼ša1 ^ a2 ^ Â·Â·Â· ^ an ^ K = 0ã€‚</p>
<p>å‡è®¾ K çš„æœ€é«˜ä½1åœ¨ç¬¬ x ä½ï¼Œ</p>
<p>é‚£ä¹ˆå¿…ç„¶å­˜åœ¨ aj (1 &lt; = j &lt;= n) çš„ ç¬¬ x ä½ä¸º1ï¼Œ</p>
<p>åæ‰‹å›åˆï¼šåªè¦æŠŠ aj å˜æˆ aj ^ Kï¼Œ</p>
<p>å°±èƒ½ä½¿å¾—ï¼ša1 ^ a2 ^ Â·Â·Â· ^ an =  0ã€‚</p>
<p>ç”±äº aj ^ K ä½¿å¾—ç¬¬ x ä½ ä¸º0ï¼Œæ— è®ºä½ä½æ˜¯ä»€ä¹ˆï¼Œ</p>
<p>ç¬¬ x ä½å˜ä¸º0åï¼Œaj æ•´ä¸ªæ•°ä¸€å®šä¼šå˜å°ï¼Œå³ï¼šaj ^ K &lt; ajï¼Œ</p>
<p>æ‰€ä»¥åæ‰‹åªéœ€åœ¨ç¬¬ j å †å–èµ°(aj - aj ^ K)ä¸ªçŸ³å­å³å¯ã€‚</p>
<p>å…ˆæ‰‹æ¯æ¬¡å–å®Œï¼Œåæ‰‹æ¯æ¬¡å–(aj - aj ^ K)ï¼Œ</p>
<p>æœ€åçš„å±€åŠ¿ä¸€å®šæ˜¯ï¼ša1 = a2 = Â·Â·Â· = an = 0ï¼Œ</p>
<p>æ­¤æ—¶å…ˆæ‰‹æ— æ³•å–äº†ï¼Œåæ‰‹å¿…èƒœã€‚</p>
<p>åä¹‹ï¼Œå½“a1 ^ a2 ^ Â·Â·Â· ^ an = K æ—¶ï¼Œ</p>
<p>å±€åŠ¿åè½¬ï¼Œå…ˆæ‰‹æ¯æ¬¡å–(aj - aj ^ K)ä¸ªå³å¯ï¼Œå…ˆæ‰‹å¿…èƒœã€‚</p>
</blockquote>
<br>

<h3 id="2-4-ä»£ç "><a href="#2-4-ä»£ç " class="headerlink" title="2.4 ä»£ç "></a>2.4 ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NimGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(<span class="keyword">int</span>[] a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i : a) &#123;</span><br><span class="line">            res ^= i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (res == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;åæ‰‹è·èƒœ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å…ˆæ‰‹è·èƒœ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h2 id="3-å°¼å§†Plusåšå¼ˆ"><a href="#3-å°¼å§†Plusåšå¼ˆ" class="headerlink" title="3. å°¼å§†Plusåšå¼ˆ"></a>3. å°¼å§†Plusåšå¼ˆ</h2><br>

<h3 id="3-1-é—®é¢˜"><a href="#3-1-é—®é¢˜" class="headerlink" title="3.1 é—®é¢˜"></a>3.1 é—®é¢˜</h3><blockquote>
<p>ä¸¤ä¸ªé¡¶å°–èªæ˜çš„äººåœ¨ç©æ¸¸æˆï¼Œæœ‰ n å †çŸ³å­ï¼Œç¬¬ i å †æœ‰ ai ä¸ªçŸ³å­ï¼Œæ¯ä¸ªäººæ¯æ¬¡èƒ½ä» 1~d å †çŸ³å­ä¸­å–ä»»æ„å¤šä¸ªçŸ³å­ä½†ä¸èƒ½ä¸å–ï¼Œä¸èƒ½å–çš„äººè¾“ã€‚è¯·é—®å…ˆæ‰‹ä¸åæ‰‹è°å¿…èƒœï¼Ÿ</p>
</blockquote>
<br>

<h3 id="3-2-åˆ†æ"><a href="#3-2-åˆ†æ" class="headerlink" title="3.2 åˆ†æ"></a>3.2 åˆ†æ</h3><blockquote>
<p>ç‰¹ä¹ˆå¤ªéš¾äº†å•Šï¼Œå‘œå‘œå‘œæˆ‘å¥½èœ</p>
</blockquote>
<br>

<h3 id="3-3-ç»“è®º"><a href="#3-3-ç»“è®º" class="headerlink" title="3.3 ç»“è®º"></a>3.3 ç»“è®º</h3><blockquote>
<p><strong>å°†æ¯å †çŸ³å­æ•°é‡ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œå¯¹äºäºŒè¿›åˆ¶çš„ä»»æ„ä¸€ä½ï¼Œå¦‚æœè¿™ä¸€ä½ä¸º1çš„çŸ³å­å †æ•°é‡%(d+1)==0ï¼Œé‚£ä¹ˆåæ‰‹å¿…èƒœï¼Œå¦åˆ™å…ˆæ‰‹å¿…èƒœã€‚</strong></p>
</blockquote>
<br>

<h3 id="3-4-è¯æ˜"><a href="#3-4-è¯æ˜" class="headerlink" title="3.4 è¯æ˜"></a>3.4 è¯æ˜</h3><blockquote>
<p>åªéœ€è¦è¯æ˜ä¸‰ç‚¹ï¼š</p>
<ol>
<li><p>ç»ˆæ­¢å±€é¢ä¸ºå…ˆæ‰‹å¿…è´¥ï¼ˆæ˜¾ç„¶ï¼‰</p>
</li>
<li><p>ä»»æ„å…ˆæ‰‹å¿…èƒœçš„å±€é¢éƒ½èƒ½è½¬å˜æˆå…ˆæ‰‹å¿…è´¥çš„å±€é¢</p>
</li>
<li><p>ä»»æ„å…ˆæ‰‹å¿…è´¥çš„å±€é¢éƒ½ä¸èƒ½è½¬å˜æˆå…ˆæ‰‹å¿…èƒœçš„å±€é¢</p>
</li>
</ol>
<p><strong>è¯æ˜</strong></p>
<p>è¯æ˜2:</p>
<p>å‡è®¾æœ€é«˜ä½%(d+1) != 0æœ‰må †ï¼Œé‚£ä¹ˆå°†è¿™äº›å †çš„è¿™ä¸€ä½å˜æˆ0ï¼›</p>
<p>å‡è®¾ä¸‹ä¸€ä½%(d+1) != 0çš„ä½æœ‰nä¸ªï¼Œä¹‹å‰må †ä¸­è¿™ä¸€ä½æœ‰aä¸ª1å’Œbä¸ª0ã€‚</p>
<p>ï¼ˆ1ï¼‰å¦‚æœn &lt;= aï¼Œæ˜¾ç„¶å°†è¿™aä¸­çš„nä¸ªå˜æˆ0å³å¯ï¼›</p>
<p>ï¼ˆ2ï¼‰å¦‚æœ(d+1) - n &lt;= bï¼Œé‚£ä¹ˆåªè¦å°†bä¸ªä¸­çš„(d+1) - nä¸ªå˜æˆ1å³å¯ï¼›</p>
<p>å› ä¸ºä¹‹å‰æœ€é«˜ä½æ˜¯å°†1å˜æˆ0ï¼Œæ‰€ä»¥è¿™ä¸€ä½å³ä½¿ç”±0å˜1ï¼Œè¿™å †çŸ³å­ä¹Ÿæ˜¯å‡å°‘çš„ï¼›</p>
<p>ï¼ˆ3ï¼‰å¦‚æœä¸¤ä¸ªéƒ½ä¸æ»¡è¶³ï¼Œå³a &gt; n &amp;&amp; b &lt; (d + 1 - n)ï¼Œé‚£ä¹ˆåªè¦å°†è¿™aå †å’Œmå †ä¹‹å¤–çš„(n - a)å †çš„è¿™ä¸€ä½å˜æˆ0ï¼Œ</p>
<p>é‚£ä¹ˆæ€»æ”¹å˜å †æ•°ä¸º a + b + (n - a) = b + n &lt; (d + 1) - n + n = d + 1ï¼Œ</p>
<p>å³å°†è¿™ä¸€ä½å˜æˆ%(d+1) = 0éœ€è¦æ”¹å˜çš„æ€»å †æ•°è¦å°äº(d+1)ï¼Œ</p>
<p>å³å¯ä»¥ä¸€æ¬¡æ“ä½œå®Œæˆï¼Œç„¶åä»¥æ­¤ç±»æ¨å°±èƒ½ä½¿æ¯ä¸€ä½éƒ½å˜ä¸º%(d+1)=0ã€‚</p>
<p>è¯æ˜3:</p>
<p>å› ä¸ºä¸€æ¬¡æœ€å¤šæ“ä½œdå †çŸ³å­ï¼Œå› æ­¤ä¸èƒ½å°†(d+1)å †æŸä¸€ä½æ˜¯1çš„çŸ³å­å †çš„è¿™ä¸€ä½éƒ½å˜ä¸º0ã€‚</p>
</blockquote>
<br>

<h2 id="4-å¨ä½å¤«åšå¼ˆ"><a href="#4-å¨ä½å¤«åšå¼ˆ" class="headerlink" title="4. å¨ä½å¤«åšå¼ˆ"></a>4. å¨ä½å¤«åšå¼ˆ</h2><br>

<h3 id="4-1-é—®é¢˜"><a href="#4-1-é—®é¢˜" class="headerlink" title="4.1 é—®é¢˜"></a>4.1 é—®é¢˜</h3><blockquote>
<p>ä¸¤ä¸ªé¡¶å°–èªæ˜çš„äººåœ¨ç©æ¸¸æˆï¼Œæœ‰ 2 å †çŸ³å­ï¼Œæ¯ä¸ªäººæ¯æ¬¡å¯ä»¥ä»ä»»æ„ä¸€å †çŸ³å­ä¸­å–ä»»æ„å¤šçš„çŸ³å­æˆ–è€…ä»ä¸¤å †çŸ³å­ä¸­å–åŒæ ·å¤šçš„çŸ³å­ï¼Œä¸èƒ½å–çš„äººè¾“ã€‚è¯·é—®å…ˆæ‰‹ä¸åæ‰‹è°å¿…èƒœï¼Ÿ</p>
</blockquote>
<br>

<h3 id="4-2-åˆ†æ"><a href="#4-2-åˆ†æ" class="headerlink" title="4.2 åˆ†æ"></a>4.2 åˆ†æ</h3><blockquote>
<p>å¨ä½å¤«åšå¼ˆä¸åŒäºå·´ä»€åšå¼ˆå’Œå°¼å§†åšå¼ˆï¼Œå®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºä¸èƒ½å°†ä¸¤å †çŸ³å­åˆ†å¼€åˆ†æã€‚</p>
<p><em>ä¸‹é¢åˆ†æä¸æƒ³çœ‹çš„ç›´æ¥è·³è¿‡è®°ä½ç»“è®ºå³å¯</em></p>
<p>å®šä¹‰å…ˆæ‰‹å¿…è¾“çš„å±€åŠ¿ä¸ºå¥‡å¼‚å±€åŠ¿ï¼Œå‰å‡ ä¸ªå¥‡å¼‚å±€åŠ¿ä¸º: (0, 0), (1, 2), (3, 5), (4, 7), (6,10)â€¦â€¦</p>
<p>å‡è®¾ (x, y) ä¸ºç¬¬ k ä¸ªå¥‡å¼‚å±€åŠ¿</p>
<p>æ€§è´¨ï¼š</p>
<ul>
<li>xä¸ºå‰ 1Â·Â·Â·k ä¸ªå¥‡å¼‚å±€åŠ¿ä¸­æ²¡æœ‰å‡ºç°è¿‡çš„æœ€å°æ­£æ•´æ•°ï¼Œy = x + k (æ‰“è¡¨æ‰¾è§„å¾‹)</li>
<li>ä»»ä½•ä¸€ä¸ªè‡ªç„¶æ•°éƒ½åŒ…å«åœ¨ä¸€ä¸ªä¸”ä»…æœ‰ä¸€ä¸ªå¥‡å¼‚å±€åŠ¿ä¸­</li>
<li>ä»»ä½•æ“ä½œéƒ½ä¼šå°†å¥‡å¼‚å±€åŠ¿å˜ä¸ºéå¥‡å¼‚å±€åŠ¿</li>
<li>éå¥‡å¼‚å±€åŠ¿å¯ä»¥é€šè¿‡é€‚å½“æ“ä½œå˜ä¸ºå¥‡å¼‚å±€åŠ¿</li>
</ul>
<p>è¯æ˜è¿™ä¸ªç»“è®ºï¼Œåªéœ€è¯æ˜ï¼š</p>
<ol>
<li>ä»»æ„è‡ªç„¶æ•°éƒ½å‡ºç°è¿‡</li>
<li>ä»»æ„è‡ªç„¶æ•°ä»…å‡ºç°ä¸€æ¬¡</li>
</ol>
<p>åè¯æ³•æ˜“è¯ã€‚</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/12bcd26e/%E5%A8%81%E4%BD%90%E5%A4%AB%E5%8D%9A%E5%BC%88.jpg" class="" title="XY">

<blockquote>
<p>æˆ‘ä»¬å¯ä»¥å°†ä¸¤å †çŸ³å­çœ‹æˆæ˜¯æ£‹ç›˜ä¸Šä¸€ä¸ªç‚¹çš„çºµæ¨ªåæ ‡ï¼Œé‚£ä¹ˆæ¸¸æˆåˆ‡æ¢ï¼š</p>
<p>æ£‹ç›˜ä¸Šæœ‰ä¸€ä¸ªç‚¹ï¼Œæ¯æ¬¡æ¯ä¸ªäººåªèƒ½å°†æ£‹å­å¾€å·¦æˆ–è€…å¾€ä¸‹ç§»åŠ¨ä»»æ„ä¸ªæ ¼å­ï¼Œä¸èƒ½ç§»åŠ¨çš„äººè¾“ã€‚</p>
<p>å°†èƒ½ä¸€æ­¥åˆ°è¾¾(0, 0)çš„ç‚¹éƒ½æŸ“è‰²ï¼Œé‚£ä¹ˆè¿™äº›ç‚¹å°±æ˜¯å¿…èƒœæ€ï¼Œå†æ‰¾åˆ°æ¨ªçºµåæ ‡ä¹‹å’Œæœ€å°çš„æ²¡è¢«æŸ“è‰²çš„ç‚¹ï¼Œ</p>
<p>è¿™ä¸ªç‚¹å°±æ˜¯ä¸‹ä¸€ä¸ªå¿…è´¥æ€ï¼Œç”±æ­¤ç”»å‡ºä¸Šå›¾ã€‚</p>
</blockquote>
<br>

<h3 id="4-3-ç»“è®º"><a href="#4-3-ç»“è®º" class="headerlink" title="4.3 ç»“è®º"></a>4.3 ç»“è®º</h3><blockquote>
<p><strong>æ ¹æ®<a href="https://baike.baidu.com/item/%E8%B4%9D%E8%92%82%E5%AE%9A%E7%90%86/2677437?fr=aladdin">Bettyå®šç†</a>ï¼Œç¬¬Kä¸ªå±€åŠ¿å°±æ˜¯(âŒŠ(1+âˆš5)/2 *kâŒ‹, âŒŠ(3+âˆš5)/2 *kâŒ‹)ï¼Œå…¶ä¸­(1+âˆš5)/2=1.618æ˜¯é»„é‡‘åˆ†å‰²ç³»æ•°ã€‚</strong></p>
<p><strong>å› æ­¤ï¼Œå±€åŠ¿(x, y)æ»¡è¶³(y - x)*(1+âˆš5)/2)=xæ—¶ï¼Œå…ˆæ‰‹å¿…è´¥ï¼Œå¦åˆ™å…ˆæ‰‹å¿…èƒœã€‚</strong></p>
</blockquote>
<br>

<h3 id="4-4-ä»£ç "><a href="#4-4-ä»£ç " class="headerlink" title="4.4 ä»£ç "></a>4.4 ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WizovGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä¿è¯ a &lt;= b</span></span><br><span class="line">        <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">            <span class="keyword">int</span> temp = b;</span><br><span class="line">            b = a;</span><br><span class="line">            a = temp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ a == (b - a) * é»„é‡‘åˆ†å‰²ç³»æ•° (å‘ä¸Šå–æ•´)</span></span><br><span class="line">        <span class="keyword">if</span> ( a == (<span class="keyword">int</span>) Math.ceil( (b - a) * (<span class="number">1</span> + Math.sqrt(<span class="number">5.0</span>)) / <span class="number">2</span>) ) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;åæ‰‹è·èƒœ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å…ˆæ‰‹è·èƒœ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h2 id="5-æ–æ³¢é‚£å¥‘åšå¼ˆ"><a href="#5-æ–æ³¢é‚£å¥‘åšå¼ˆ" class="headerlink" title="5. æ–æ³¢é‚£å¥‘åšå¼ˆ"></a>5. æ–æ³¢é‚£å¥‘åšå¼ˆ</h2><br>

<h3 id="5-1-é—®é¢˜"><a href="#5-1-é—®é¢˜" class="headerlink" title="5.1 é—®é¢˜"></a>5.1 é—®é¢˜</h3><blockquote>
<p>ä¸¤ä¸ªé¡¶å°–èªæ˜çš„äººåœ¨ç©æ¸¸æˆï¼Œæœ‰ä¸€å †çŸ³å­ï¼Œæ•°é‡ä¸ºnï¼Œä¸¤ä¸ªäººè½®æµå–çŸ³å­ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆ1ï¼‰å…ˆæ‰‹ä¸èƒ½åœ¨ç¬¬ä¸€æ¬¡æŠŠæ‰€æœ‰çš„çŸ³å­å–å®Œï¼Œè‡³å°‘å–ä¸€é¢—ï¼›</p>
<p>ï¼ˆ2ï¼‰ä¹‹åæ¯æ¬¡å¯ä»¥å–çš„çŸ³å­æ•°è‡³å°‘ä¸º1ï¼Œè‡³å¤šä¸ºå¯¹æ‰‹åˆšå–çš„çŸ³å­æ•°çš„2å€ï¼›</p>
<p>ä¸èƒ½å–çš„äººè¾“ã€‚è¯·é—®å…ˆæ‰‹ä¸åæ‰‹è°å¿…èƒœï¼Ÿ</p>
</blockquote>
<br>

<h3 id="5-2-ç»“è®º"><a href="#5-2-ç»“è®º" class="headerlink" title="5.2 ç»“è®º"></a>5.2 ç»“è®º</h3><blockquote>
<p><strong>å½“nä¸ºFibonacciæ•°çš„æ—¶å€™ï¼Œåæ‰‹å¿…èƒœï¼Œå¦åˆ™å…ˆæ‰‹å¿…èƒœã€‚</strong></p>
</blockquote>
<br>

<h3 id="5-3-è¯æ˜"><a href="#5-3-è¯æ˜" class="headerlink" title="5.3 è¯æ˜"></a>5.3 è¯æ˜</h3><blockquote>
<p>æ•°å­¦å½’çº³æ³•ï¼š</p>
<p>å‡è®¾çŸ³å­æ•°é‡n = F[i]ï¼ˆæ–æ³¢é‚£å¥‘æ•°åˆ—ä¸­çš„ç¬¬ié¡¹{1, 1, 2, 3, 5Â·Â·Â·Â·Â·Â·}ï¼‰</p>
<p>ï¼ˆ1ï¼‰å½“ i = 2 æ—¶ï¼Œn = 2ï¼Œæ˜¾ç„¶å…ˆæ‰‹å–ä¸€ä¸ªï¼Œåæ‰‹å¿…èƒœ</p>
<p>ï¼ˆ2ï¼‰å½“ i &gt; 2 æ—¶ï¼Œå‡è®¾å½“ i &lt;= k æ—¶ç»“è®ºæˆç«‹ã€‚</p>
<p>å½“i = k + 1æ—¶ï¼ŒF[i] = F[k] + F[k-1]ï¼Œå°†çŸ³å­åˆ†æˆä¸¤éƒ¨åˆ†æ¥çœ‹ã€‚</p>
<p>å‡è®¾å…ˆæ‰‹ç¬¬ä¸€æ¬¡å– x ä¸ªï¼Œåæ‰‹ç¬¬ä¸€æ¬¡å– y ä¸ªã€‚</p>
<p>1ï¼‰å¦‚æœ x &lt; F[k-1] / 3ï¼Œå› ä¸º n = F[k-1] æ—¶å·²ç»è¯æ˜åæ‰‹ä¸€å®šèƒ½å–åˆ° F[k-1] ä¸ªä¸­çš„æœ€åä¸€ä¸ªï¼Œ</p>
<p>æ‰€ä»¥é—®é¢˜è½¬åŒ–æˆäº†æœ‰ F[k] ä¸ªä¸­çš„æœ€åä¸€ä¸ªï¼Œè¿™ä¸ªä¹Ÿå·²ç»è¯æ˜åæ‰‹ä¸€å®šèƒ½å–åˆ°F[k]ä¸­çš„æœ€åä¸€ä¸ªã€‚</p>
<p>æ‰€ä»¥åæ‰‹å¿…èƒœã€‚</p>
<p>2ï¼‰å¦‚æœ F[k-1] / 3 &lt;= x &lt;= F[k]æ—¶ï¼Œåˆ™F[k-1]ä¸­å‰©ä½™æ•°é‡å°äº2xï¼Œåæ‰‹å¯ä»¥ç›´æ¥å–å®Œï¼Œ</p>
<p>ï¼ˆå¦‚æœä¸é€‰æ‹©ä¸€æ¬¡æ€§å–å®Œï¼Œæ…¢æ…¢ç£¨æœ€ç»ˆä¹Ÿä¼šæ˜¯æ‰€è¯æ˜çš„F[k-1]çš„æƒ…å†µï¼Œåæ‰‹æœ€åå–å®Œï¼‰</p>
<p>å³åæ‰‹å–äº†F[k-1]-xä¸ªï¼Œå³y &lt;= 2/3 * F[k-1]ã€‚æ¯”è¾ƒ 2/3 * F[k-1] ä¸ 1/2 * F[k] çš„å¤§å°ï¼Œ</p>
<p>å³æ¯”è¾ƒ4 * [k-1] ä¸ 3 * F[k] çš„å¤§å°ï¼š</p>
<p>ç”±äº F[k] å‡½æ•°é€’å¢ ä¸” F[k] = F[k-1] + F[k-2]æ˜“çŸ¥ï¼š2 * F[k-2] &lt; F[k] &lt; 2 * F[k-1]ï¼Œ</p>
<p>å› è€Œ 3 * F[k] = 3 * F[k-1] + 3 * F[k-2] &gt; 3 * F[k-1] + 3 / 2 * F[k-1] &gt; 4 * F[k-1]ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åæ‰‹å–å®ŒF[k-1]é‚£ä¸€å †çŸ³å­ä¹‹åï¼Œå…ˆæ‰‹ä¸èƒ½ä¸€æ¬¡æ€§å–å®ŒF[k]é‚£ä¸€å †çŸ³å­ï¼Œ</p>
<p>äºæ˜¯é—®é¢˜æœ€ç»ˆæ¼”å˜æˆäº†F[k]çš„çŠ¶å†µï¼Œåæ‰‹æœ€åå–å®Œã€‚</p>
<p>3ï¼‰å¦‚æœ x &gt; F[k-1]ï¼Œå› ä¸ºF[k] &lt; 2 * F[k-1]ï¼Œåæ‰‹å¯ä»¥ä¸€æ¬¡æ€§å–å®Œã€‚</p>
<p>ç»¼ä¸Šä¸‰ç§æƒ…å†µï¼Œå½“ i &lt;= k æ—¶ç»“è®ºæˆç«‹ï¼Œé‚£ä¹ˆå½“ n = k+1 æ—¶ç»“è®ºä¹Ÿæˆç«‹ã€‚</p>
</blockquote>
<br>

<h3 id="5-4-ä»£ç "><a href="#5-4-ä»£ç " class="headerlink" title="5.4 ä»£ç "></a>5.4 ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FibonacciGame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">fibnacci</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// é€’å½’è®¡ç®—ï¼Œæ…¢</span></span><br><span class="line"><span class="comment">//        if (n == 1 || n == 2)</span></span><br><span class="line"><span class="comment">//            return 1;</span></span><br><span class="line"><span class="comment">//        else</span></span><br><span class="line"><span class="comment">//            return fibnacci(n - 1) + fibnacci(n - 2);</span></span><br><span class="line">        <span class="comment">// å…¬å¼è®¡ç®—ï¼Œå¿«</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) Math.floor( ( Math.pow((<span class="number">1</span> + Math.sqrt(<span class="number">5</span>)) / <span class="number">2</span>, n)  - Math.pow((<span class="number">1</span> - Math.sqrt(<span class="number">5</span>)) / <span class="number">2</span>, n) ) / Math.sqrt(<span class="number">5</span>) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; fibnacci(i) &lt;= n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (fibnacci(i+<span class="number">1</span>) == n) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;åæ‰‹è·èƒœ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;å…ˆæ‰‹è·èƒœ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
      <tags>
        <tag>Game</tag>
      </tags>
  </entry>
  <entry>
    <title>Golang-Module</title>
    <url>/posts/58003/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a>å®˜æ–¹æ–‡æ¡£</h2><p>modulesçš„wiki: <a href="https://github.com/golang/go/wiki/Modules">https://github.com/golang/go/wiki/Modules</a></p>
<blockquote>
<p>go 1.14</p>
</blockquote>
<p>æ¨¡å—æ”¯æŒå·²ç»å‡†å¤‡å¥½ç”¨äºç”Ÿäº§ï¼Œå¹¶ä¸”é¼“åŠ±æ‰€æœ‰ç”¨æˆ·ä»å…¶ä»–ä¾èµ–ç®¡ç†ç³»ç»Ÿè¿ç§»åˆ°æ¨¡å—ã€‚</p>
<blockquote>
<p>go 1.16</p>
</blockquote>
<p>æ¨¡å—æ¨¡å¼é»˜è®¤å¼€å¯ï¼Œå³GO111MODULE=onã€‚</p>
<h2 id="GO111MODULE"><a href="#GO111MODULE" class="headerlink" title="GO111MODULE"></a>GO111MODULE</h2><p>GO111MODULEæœ‰ä¸‰ä¸ªå€¼ï¼šoffã€onå’Œautoï¼Œä¸åŒç‰ˆæœ¬çš„é»˜è®¤å€¼ä¸å°½ç›¸åŒã€‚</p>
<ol>
<li>offï¼šgoå‘½ä»¤è¡Œå°†ä¸ä¼šæ”¯æŒmoduleåŠŸèƒ½ï¼Œå¯»æ‰¾ä¾èµ–åŒ…çš„æ–¹å¼å°†ä¼šæ²¿ç”¨æ—§ç‰ˆæœ¬é€šè¿‡vendorç›®å½•æˆ–è€…GOPATHæ¨¡å¼æŸ¥æ‰¾ã€‚</li>
<li>onï¼šgoå‘½ä»¤è¡Œä¼šä½¿ç”¨modulesï¼Œè€Œä¸”ä¸€ç‚¹ä¹Ÿä¸ä¼šå»GOPATHç›®å½•ä¸‹æŸ¥æ‰¾ã€‚</li>
<li>autoï¼šgoå‘½ä»¤è¡Œå°†ä¼šæ ¹æ®å½“å‰ç›®å½•æ¥å†³å®šæ˜¯å¦å¯ç”¨moduleåŠŸèƒ½ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å½¢ï¼š<ol>
<li>å½“å‰ç›®å½•åœ¨$GOPATH/srcä¹‹å¤–ä¸”è¯¥ç›®å½•åŒ…å«go.modæ–‡ä»¶</li>
<li>å½“å‰æ–‡ä»¶åœ¨åŒ…å«go.modæ–‡ä»¶çš„ç›®å½•ä¸‹é¢</li>
</ol>
</li>
</ol>
<p>è¯´æ˜ï¼šå½“modules åŠŸèƒ½å¯ç”¨æ—¶ï¼Œä¾èµ–åŒ…çš„å­˜æ”¾ä½ç½®å˜æ›´ä¸º$GOPATH/pkgï¼Œå…è®¸åŒä¸€ä¸ªpackageå¤šä¸ªç‰ˆæœ¬å¹¶å­˜ï¼Œä¸”å¤šä¸ªé¡¹ç›®å¯ä»¥å…±äº«ç¼“å­˜çš„ moduleã€‚</p>
<h2 id="åŸºæœ¬å‘½ä»¤"><a href="#åŸºæœ¬å‘½ä»¤" class="headerlink" title="åŸºæœ¬å‘½ä»¤"></a>åŸºæœ¬å‘½ä»¤</h2><p>golangæä¾›äº†<code>go mod</code>å‘½ä»¤æ¥ç®¡ç†åŒ…ï¼Œåç½®å‚æ•°å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>download</td>
<td>ä¸‹è½½ä¾èµ–åŒ…</td>
</tr>
<tr>
<td>edit</td>
<td>ç¼–è¾‘go.mod</td>
</tr>
<tr>
<td>graph</td>
<td>æ‰“å°æ¨¡å—ä¾èµ–å›¾</td>
</tr>
<tr>
<td>init</td>
<td>åœ¨å½“å‰ç›®å½•åˆå§‹åŒ–mod</td>
</tr>
<tr>
<td>tidy</td>
<td>æ‹‰å–ç¼ºå°‘çš„æ¨¡å—ï¼Œç§»é™¤ä¸ç”¨çš„æ¨¡å—</td>
</tr>
<tr>
<td>vendor</td>
<td>å°†ä¾èµ–å¤åˆ¶åˆ°vendorä¸‹</td>
</tr>
<tr>
<td>verify</td>
<td>éªŒè¯ä¾èµ–æ˜¯å¦æ­£ç¡®</td>
</tr>
<tr>
<td>why</td>
<td>è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ä¾èµ–</td>
</tr>
</tbody></table>
<h2 id="modæ–‡ä»¶"><a href="#modæ–‡ä»¶" class="headerlink" title="modæ–‡ä»¶"></a>modæ–‡ä»¶</h2><p>go.modæ–‡ä»¶ä¸­æä¾›äº†å››ä¸ªå‘½ä»¤ï¼š</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>module</td>
<td>æŒ‡å®šåŒ…çš„åç§°</td>
</tr>
<tr>
<td>require</td>
<td>æŒ‡å®šä¾èµ–é¡¹æ¨¡å—</td>
</tr>
<tr>
<td>replace</td>
<td>æ›¿æ¢ä¾èµ–é¡¹æ¨¡å—</td>
</tr>
<tr>
<td>exclude</td>
<td>å¿½ç•¥ä¾èµ–é¡¹æ¨¡å—</td>
</tr>
</tbody></table>
<h2 id="é¡¹ç›®æ¡ˆä¾‹"><a href="#é¡¹ç›®æ¡ˆä¾‹" class="headerlink" title="é¡¹ç›®æ¡ˆä¾‹"></a>é¡¹ç›®æ¡ˆä¾‹</h2><p>ç¯å¢ƒï¼šgo 1.16.3</p>
<blockquote>
<p>åˆ›å»ºé¡¹ç›®</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> mkdir go<span class="literal">-mod</span> &amp;&amp; <span class="built_in">cd</span> go<span class="literal">-mod</span></span><br><span class="line"><span class="variable">$</span> go mod init hello</span><br><span class="line"><span class="variable">$</span> touch server.go</span><br><span class="line"><span class="variable">$</span> mkdir api &amp;&amp; <span class="built_in">cd</span> api</span><br><span class="line"><span class="variable">$</span> touch hello.go &amp;&amp; touch print.go</span><br></pre></td></tr></table></figure>
<blockquote>
<p>é¡¹ç›®ç»“æ„</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">go<span class="literal">-mod</span></span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ server.go</span><br><span class="line">â””â”€â”€ api</span><br><span class="line">    â”œâ”€â”€ hello.mod</span><br><span class="line">    â””â”€â”€ print.go</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­serveréœ€è¦è°ƒç”¨apiä¸­çš„helloçš„<code>_HelloKHighness_</code>å’Œprintçš„<code>_ConsolePrint_</code>æ¥å£ã€‚</p>
<p>åˆå§‹åŒ–çš„go-modä¸­å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">module hello</span><br><span class="line"></span><br><span class="line">go <span class="number">1.16</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>hello.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> api</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author KHighness</span></span><br><span class="line"><span class="comment"> * @since 2021-04-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/labstack/echo&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloKHighness</span><span class="params">(c echo.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> c.JSON(http.StatusOK, <span class="string">&quot;Hello KHighness!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>print.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> api</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author KHighness</span></span><br><span class="line"><span class="comment"> * @since 2021-04-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConsolePrint</span><span class="params">()</span></span>  &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;Hello, KHighness!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>server.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author KHighness</span></span><br><span class="line"><span class="comment"> * @since 2021-04-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/labstack/echo&quot;</span></span><br><span class="line">	helloAPI <span class="string">&quot;hello/api&quot;</span> </span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	helloAPI.ConsolePrint()</span><br><span class="line">	e := echo.New()</span><br><span class="line">	e.GET(<span class="string">&quot;/&quot;</span>, helloAPI.HelloKHighness)</span><br><span class="line">	e.Logger.Fatal(e.Start(<span class="string">&quot;:3333&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å®‰è£…ä¾èµ–</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> go mod tidy</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/labstack/<span class="built_in">echo</span></span><br><span class="line">go: found github.com/labstack/<span class="built_in">echo</span> <span class="keyword">in</span> github.com/labstack/<span class="built_in">echo</span> v3.<span class="number">3.10</span>+incompatible</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/stretchr/testify/assert</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/labstack/gommon/color</span><br><span class="line">go: finding module <span class="keyword">for</span> package github.com/labstack/gommon/log</span><br><span class="line">go: finding module <span class="keyword">for</span> package golang.org/x/crypto/acme/autocert</span><br><span class="line">go: found github.com/labstack/gommon/color <span class="keyword">in</span> github.com/labstack/gommon v0.<span class="number">3.0</span></span><br><span class="line">go: found github.com/labstack/gommon/log <span class="keyword">in</span> github.com/labstack/gommon v0.<span class="number">3.0</span></span><br><span class="line">go: found golang.org/x/crypto/acme/autocert <span class="keyword">in</span> golang.org/x/crypto v0.<span class="number">0.0</span><span class="literal">-20210415154028</span><span class="literal">-4f45737414dc</span></span><br><span class="line">go: found github.com/stretchr/testify/assert <span class="keyword">in</span> github.com/stretchr/testify v1.<span class="number">7.0</span></span><br></pre></td></tr></table></figure>
<p>å®‰è£…åå¯ä»¥çœ‹åˆ°go.modæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">module hello</span><br><span class="line"></span><br><span class="line">go 1.16</span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">	github.com&#x2F;labstack&#x2F;echo v3.3.10+incompatible</span><br><span class="line">	github.com&#x2F;labstack&#x2F;gommon v0.3.0 &#x2F;&#x2F; indirect</span><br><span class="line">	github.com&#x2F;stretchr&#x2F;testify v1.7.0 &#x2F;&#x2F; indirect</span><br><span class="line">	golang.org&#x2F;x&#x2F;crypto v0.0.0-20210415154028-4f45737414dc &#x2F;&#x2F; indirect</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿è¡Œé¡¹ç›®</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> go run server.go</span><br><span class="line">Hello, KHighness!</span><br><span class="line"></span><br><span class="line">   ____    __</span><br><span class="line">  / __/___/ /  ___</span><br><span class="line"> / _// __/ _ \/ _ \</span><br><span class="line">/___/\__/_//_/\___/ v3.<span class="number">3.10</span><span class="literal">-dev</span></span><br><span class="line">High performance, minimalist Go web framework</span><br><span class="line">https://echo.labstack.com</span><br><span class="line">____________________________________O/_______</span><br><span class="line">                                    O\</span><br><span class="line">â‡¨ http server started on [::]:<span class="number">3333</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>é¡¹ç›®æµ‹è¯•</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"> <span class="variable">$</span> <span class="built_in">curl</span> <span class="literal">-X</span> GET http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3333</span></span><br><span class="line"><span class="string">&quot;Hello KHighness!&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>é¡¹ç›®æ‰“åŒ…</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> go build</span><br></pre></td></tr></table></figure>
<p>æ‰“åŒ…ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°hello.exeå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p>[1] modules wiki: <a href="https://github.com/golang/go/wiki/Modules">https://github.com/golang/go/wiki/Modules</a><br>[2] go mod ä½¿ç”¨: <a href="https://juejin.cn/post/6844903798658301960">https://juejin.cn/post/6844903798658301960</a><br>[3] å†æ¢go modules: <a href="https://www.cnblogs.com/apocelipes/p/10295096.html">https://www.cnblogs.com/apocelipes/p/10295096.html</a></p>
]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title>Golang-MySQL</title>
    <url>/posts/52018/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å®‰è£…é©±åŠ¨"><a href="#å®‰è£…é©±åŠ¨" class="headerlink" title="å®‰è£…é©±åŠ¨"></a>å®‰è£…é©±åŠ¨</h2><p>æ–¹å¼ä¸€ï¼šè®¾ç½®ä»£ç†å¹¶å®‰è£…é©±åŠ¨</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> go env <span class="literal">-w</span> GOPROXY=https://goproxy.cn</span><br><span class="line"><span class="variable">$</span> go get github.com/go<span class="literal">-sql</span><span class="literal">-driver</span>/mysql</span><br><span class="line"><span class="variable">$</span> go get github.com/jmoiron/sqlx</span><br></pre></td></tr></table></figure>
<p>æ–¹å¼äºŒï¼šä½¿ç”¨modåˆ›å»ºé¡¹ç›®</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆå§‹åŒ–</span></span><br><span class="line"><span class="variable">$</span> go mod init go<span class="literal">-mysql</span></span><br><span class="line"><span class="comment"># åœ¨go.modä¸­æ·»åŠ </span></span><br><span class="line">require github.com/go<span class="literal">-sql</span><span class="literal">-driver</span>/mysql v1.<span class="number">6.0</span></span><br><span class="line"><span class="comment"># ä¸‹è½½ä¾èµ–</span></span><br><span class="line"><span class="variable">$</span> go mod download</span><br></pre></td></tr></table></figure>

<h2 id="æ•°æ®å‡†å¤‡"><a href="#æ•°æ®å‡†å¤‡" class="headerlink" title="æ•°æ®å‡†å¤‡"></a>æ•°æ®å‡†å¤‡</h2><blockquote>
<p>å»ºè¡¨è¯­å¥</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `user` (</span><br><span class="line">  `id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(<span class="number">25</span>) CHARACTER <span class="built_in">SET</span> utf8 COLLATE utf8_general_ci NOT NULL,</span><br><span class="line">  `age` tinyint unsigned NOT NULL DEFAULT <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">16</span> DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åˆå§‹æ•°æ®</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`demo`</span>.<span class="string">`user`</span>(<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;Khighness&#x27;</span>, <span class="number">19</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`demo`</span>.<span class="string">`user`</span>(<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;RabbishK&#x27;</span>, <span class="number">18</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`demo`</span>.<span class="string">`user`</span>(<span class="string">`id`</span>, <span class="string">`name`</span>, <span class="string">`age`</span>) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;UnknownK&#x27;</span>, <span class="number">17</span>);</span><br></pre></td></tr></table></figure>

<h2 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">go-mysql</span><br><span class="line">â”œâ”€â”€ .idea</span><br><span class="line">â”œâ”€â”€ db</span><br><span class="line">â”‚   â”œâ”€â”€ delete.go</span><br><span class="line">â”‚   â”œâ”€â”€ insert.go</span><br><span class="line">â”‚   â”œâ”€â”€ mysql.go</span><br><span class="line">â”‚   â”œâ”€â”€ select.go</span><br><span class="line">â”‚   â”œâ”€â”€ transaction.go</span><br><span class="line">â”‚   â”œâ”€â”€ update.go</span><br><span class="line">â”‚   â””â”€â”€ user.go</span><br><span class="line">â”œâ”€â”€ db_test.go</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â””â”€â”€ go.sum</span><br></pre></td></tr></table></figure>

<h2 id="MySQLè¿æ¥æ± "><a href="#MySQLè¿æ¥æ± " class="headerlink" title="MySQLè¿æ¥æ± "></a>MySQLè¿æ¥æ± </h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;database/sql&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author KHighness</span></span><br><span class="line"><span class="comment"> * @since 2021-04-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> MysqlDB *sql.DB</span><br><span class="line"><span class="keyword">var</span> MysqlDBERR error</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	USERNAME = <span class="string">&quot;root&quot;</span></span><br><span class="line">	PASSWORD = <span class="string">&quot;KAG1823&quot;</span></span><br><span class="line">	HOST     = <span class="string">&quot;8.133.183.149&quot;</span></span><br><span class="line">	PORT     = <span class="string">&quot;3306&quot;</span></span><br><span class="line">	DATABASE = <span class="string">&quot;demo&quot;</span></span><br><span class="line">	CHARSET  = <span class="string">&quot;utf8&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–é“¾æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	dbDSN := fmt.Sprintf(<span class="string">&quot;%s:%s@tcp(%s:%s)/%s?charset=%s&quot;</span>, USERNAME, PASSWORD, HOST, PORT, DATABASE, CHARSET)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ‰“å¼€è¿æ¥å¤±è´¥</span></span><br><span class="line">	MysqlDB, MysqlDBERR = sql.Open(<span class="string">&quot;mysql&quot;</span>, dbDSN)</span><br><span class="line">	<span class="keyword">if</span> MysqlDBERR != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">&quot;dbDSN: &quot;</span> + dbDSN)</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;æ•°æ®æºé…ç½®é”™è¯¯: &quot;</span> + MysqlDBERR.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">	MysqlDB.SetMaxOpenConns(<span class="number">100</span>)</span><br><span class="line">	<span class="comment">// é—²ç½®è¿æ¥æ•°</span></span><br><span class="line">	MysqlDB.SetMaxIdleConns(<span class="number">20</span>)</span><br><span class="line">	<span class="comment">// æœ€å¤§è¿æ¥å‘¨æœŸ</span></span><br><span class="line">	MysqlDB.SetConnMaxLifetime(<span class="number">100</span> * time.Second)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> MysqlDBERR = MysqlDB.Ping(); <span class="literal">nil</span> != MysqlDBERR &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;æ•°æ®åº“è¿æ¥å¤±è´¥: &quot;</span> + MysqlDBERR.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç”¨æˆ·ç»“æ„ä½“"><a href="#ç”¨æˆ·ç»“æ„ä½“" class="headerlink" title="ç”¨æˆ·ç»“æ„ä½“"></a>ç”¨æˆ·ç»“æ„ä½“</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author KHighness</span></span><br><span class="line"><span class="comment"> * @since 2021-04-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æˆ·ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Id <span class="keyword">int64</span> <span class="string">`db:&quot;id&quot;`</span></span><br><span class="line">	Name <span class="keyword">string</span> <span class="string">`db:&quot;name&quot;`</span></span><br><span class="line">	Age <span class="keyword">int</span> <span class="string">`db:&quot;age&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="INSERTæ“ä½œ"><a href="#INSERTæ“ä½œ" class="headerlink" title="INSERTæ“ä½œ"></a>INSERTæ“ä½œ</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author KHighness</span></span><br><span class="line"><span class="comment"> * @since 2021-04-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿å­˜ç”¨æˆ·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SaveUser</span><span class="params">(user User)</span></span>  &#123;</span><br><span class="line">	res, _ := MysqlDB.Exec(<span class="string">&quot;INSERT INTO user(name, age) VALUES (?, ?)&quot;</span>, user.Name, user.Age)</span><br><span class="line">	lastInsertId, _ := res.LastInsertId()</span><br><span class="line">	rowsAffected, _ := res.RowsAffected()</span><br><span class="line">	log.Printf(<span class="string">&quot;æ’å…¥ID =&gt; [%d], å½±å“è¡Œæ•° =&gt; [%d]&quot;</span>, lastInsertId, rowsAffected)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SELECTæ“ä½œ"><a href="#SELECTæ“ä½œ" class="headerlink" title="SELECTæ“ä½œ"></a>SELECTæ“ä½œ</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author KHighness</span></span><br><span class="line"><span class="comment"> * @since 2021-04-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®IDæŸ¥è¯¢</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">QueryById</span><span class="params">(id <span class="keyword">int</span>)</span></span>  &#123;</span><br><span class="line">	user := <span class="built_in">new</span>(User)</span><br><span class="line">	row := MysqlDB.QueryRow(<span class="string">&quot;SELECT * FROM user WHERE id = ?&quot;</span>, id)</span><br><span class="line">	<span class="keyword">if</span> err :=row.Scan(&amp;user.Id,&amp;user.Name,&amp;user.Age); err != <span class="literal">nil</span>&#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;scan failed, err:%v&quot;</span>,err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">&quot;query result =&gt; [%s]\n&quot;</span>, user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸ¥è¯¢æ‰€æœ‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">QueryList</span><span class="params">()</span></span> &#123;</span><br><span class="line">	users := <span class="built_in">make</span>([]User, <span class="number">0</span>)</span><br><span class="line">	rows, _ := MysqlDB.Query(<span class="string">&quot;SELECT * FROM user&quot;</span>)</span><br><span class="line">	<span class="comment">// éå†</span></span><br><span class="line">	<span class="keyword">var</span> user User</span><br><span class="line">	<span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">		_ = rows.Scan(&amp;user.Id, &amp;user.Name, &amp;user.Age)</span><br><span class="line">		users = <span class="built_in">append</span>(users, user)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">&quot;query result =&gt; [%s]\n&quot;</span>, users)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UPDATEæ“ä½œ"><a href="#UPDATEæ“ä½œ" class="headerlink" title="UPDATEæ“ä½œ"></a>UPDATEæ“ä½œ</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author KHighness</span></span><br><span class="line"><span class="comment"> * @since 2021-04-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°ç”¨æˆ·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UpdateById</span><span class="params">(user User)</span></span>  &#123;</span><br><span class="line">	res, _ := MysqlDB.Exec(<span class="string">&quot;UPDATE user SET name = ?, age = ? WHERE id = ? &quot;</span>, user.Name, user.Age, user.Id)</span><br><span class="line">	lastInsertId, _ := res.LastInsertId()</span><br><span class="line">	rowsAffected, _ := res.RowsAffected()</span><br><span class="line">	log.Printf(<span class="string">&quot;æ›´æ–°ID =&gt; [%d], å½±å“è¡Œæ•° =&gt; [%d]&quot;</span>, lastInsertId, rowsAffected)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DELETEæ“ä½œ"><a href="#DELETEæ“ä½œ" class="headerlink" title="DELETEæ“ä½œ"></a>DELETEæ“ä½œ</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author KHighness</span></span><br><span class="line"><span class="comment"> * @since 2021-04-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤ç”¨æˆ·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DeleteById</span><span class="params">(id <span class="keyword">int</span>)</span></span>  &#123;</span><br><span class="line">	res, _ := MysqlDB.Exec(<span class="string">&quot;DELETE FROM user WHERE id = ?&quot;</span>, id)</span><br><span class="line">	lastInsertId, _ := res.LastInsertId()</span><br><span class="line">	rowsAffected, _ := res.RowsAffected()</span><br><span class="line">	log.Printf(<span class="string">&quot;åˆ é™¤ID =&gt; [%d], å½±å“è¡Œæ•° =&gt; [%d]&quot;</span>, lastInsertId, rowsAffected)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="äº‹åŠ¡æ“ä½œ"><a href="#äº‹åŠ¡æ“ä½œ" class="headerlink" title="äº‹åŠ¡æ“ä½œ"></a>äº‹åŠ¡æ“ä½œ</h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author KHighness</span></span><br><span class="line"><span class="comment"> * @since 2021-04-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹åŠ¡: æ‰¹é‡æ’å…¥5ä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BatchSaveUser</span><span class="params">(users [5]User)</span></span>  &#123;</span><br><span class="line">	<span class="comment">// å¼€å§‹äº‹åŠ¡</span></span><br><span class="line">	tx, _ := MysqlDB.Begin()</span><br><span class="line">	<span class="keyword">var</span> total <span class="keyword">int64</span> = <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> _, user := <span class="keyword">range</span> users &#123;</span><br><span class="line">		res, _ := MysqlDB.Exec(<span class="string">&quot;INSERT INTO user(name, age) VALUES(?, ?)&quot;</span>, user.Name, user.Age)</span><br><span class="line">		aff, _ := res.RowsAffected()</span><br><span class="line">		total += aff</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// è½¬å­—ç¬¦ä¸²æ¯”è¾ƒ</span></span><br><span class="line">	<span class="keyword">if</span>  strconv.FormatInt(total, <span class="number">10</span>) == strconv.Itoa(<span class="built_in">len</span>(users)) &#123; 	<span class="comment">// æäº¤äº‹åŠ¡</span></span><br><span class="line">		_ = tx.Commit()</span><br><span class="line">		log.Print(<span class="string">&quot;äº‹åŠ¡æäº¤&quot;</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">// å›æ»š</span></span><br><span class="line">		_ = tx.Rollback()</span><br><span class="line">		log.Print(<span class="string">&quot;äº‹åŠ¡å›æ»š&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;go-mysql/db&quot;</span></span><br><span class="line">	<span class="string">&quot;testing&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author KHighness</span><br><span class="line"> * @since <span class="number">2021</span><span class="literal">-04</span><span class="literal">-20</span></span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// æµ‹è¯•æŸ¥è¯¢</span><br><span class="line">func TestQueryById(t *testing.T) &#123;</span><br><span class="line">	db.QueryById(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æµ‹è¯•æŸ¥è¯¢æ‰€æœ‰</span><br><span class="line">func TestQueryList(t *testing.T) &#123;</span><br><span class="line">	db.QueryList()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æµ‹è¯•ä¿å­˜</span><br><span class="line">func TestSaveUser(t *testing.T) &#123;</span><br><span class="line">	user := db.User&#123;Name: <span class="string">&quot;FlowerK&quot;</span>, Age: <span class="number">16</span>&#125;</span><br><span class="line">	db.SaveUser(user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æµ‹è¯•æ›´æ–°</span><br><span class="line">func TestUpdateById(t *testing.T)  &#123;</span><br><span class="line">	user := db.User&#123;Id: <span class="number">1</span>, Name: <span class="string">&quot;K&quot;</span>, Age: <span class="number">20</span>&#125;</span><br><span class="line">	db.UpdateById(user)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æµ‹è¯•åˆ é™¤</span><br><span class="line">func TestDeleteById(t *testing.T)  &#123;</span><br><span class="line">	db.DeleteById(<span class="number">4</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æµ‹è¯•äº‹åŠ¡</span><br><span class="line">func TestBatchSaveUser(t *testing.T)  &#123;</span><br><span class="line">	var users [<span class="number">5</span>]db.User</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">		users[<span class="type">i</span>] = db.User&#123;Name: fmt.Sprintf(<span class="string">&quot;%s-%d&quot;</span>, <span class="string">&quot;K&quot;</span>, i + <span class="number">1</span>), Age: i + <span class="number">1</span>&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	db.BatchSaveUser(users)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello, World</title>
    <url>/posts/19577/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ğŸš€ ç•ªå¤–ï¼š<a href="https://pan.baidu.com/s/1wPglwA80SSlQCoGbrJdATQ">https://pan.baidu.com/s/1wPglwA80SSlQCoGbrJdATQ</a> ï¼Œæå–ç ï¼škkkk </p>
<p>âš¡ é¢„è­¦ï¼šå¤šé‡ä¸–ç•Œï¼Œå¤šé‡ç©¿è¶Šï¼Œç›´å®å’Œç‰ç’ƒåœ¨è™šå®ä¸­çš„åŒå‘æ•‘èµã€‚</p>
<p>â“ è¿·æƒ‘ï¼šå‰ä¼ â€”â€”ç”·ä¸»åœ¨åŠªåŠ›æ•‘å¥³ä¸»ï¼Œç»“å°¾â€”â€”å¥³ä¸»åœ¨æœˆçƒæ•‘ç”·ä¸»ã€‚</p>
<blockquote>
<p>â€”â€”å³æ—¶ä¸–ç•Œæ¯ç­ï¼Œæˆ‘ä¹Ÿæƒ³å†è§ä½ ä¸€é¢ã€‚</p>
<p>â€”â€”äº¤å¾€æ˜¯ä¸€ä¸ªäººåšä¸åˆ°çš„ï¼Œæˆ‘ä»¬ä¸¤ä¸ªäººä¸€èµ·è¯•è¯•ã€‚</p>
<p>â€”â€”å¦‚æ²³è¾¹çš„èŠ±æœµèˆ¬ï¼Œæ¸©æŸ”ç»½æ”¾çš„ç¬‘å®¹ã€‚æˆ‘å–œæ¬¢çš„ï¼Œå°±æ˜¯å¥¹è¿™æ ·çš„ç¬‘å®¹ã€‚</p>
</blockquote>
<h2 id="å‰§æƒ…"><a href="#å‰§æƒ…" class="headerlink" title="å‰§æƒ…"></a>å‰§æƒ…</h2><p>ç•ªå¤–ï¼šè®²è¿°ç”·ä¸»ï¼ˆåšä¹¦ç›´å®ï¼‰ä¸å¥³ä¸»ï¼ˆä¸€è¡Œç‘ ç’ƒï¼‰ç›¸è¯†ã€ç›¸çˆ±ã€ç›¸ç¦»ã€‚å¥³ä¸»è¢«é›·ç”µæ‰€ä¼¤åè„‘æ­»äº¡ï¼Œç”·ä¸»å¥‹åŠ›å­¦ä¹ æƒ³æ•‘å›å¥³ä¸»ã€‚è¿™éƒ¨åˆ†æ°”æ°›å¾ˆå‹æŠ‘ï¼Œç”·ä¸»çš„ä¸–ç•Œæç»˜ä¸ºç°è‰²ï¼Œä½†æ˜¯æœ‰å¾ˆå¼ºçš„æƒ…æ„Ÿå¼ åŠ›ï¼Œç»†èŠ‚éƒ¨åˆ†æ¯”æ­£ç‰‡è¦å¥½ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/19577/Die.jpg" class="" title="Die">

<p>èƒŒæ™¯ï¼šé«˜ç§‘æŠ€é˜¿å°”å¡”æ‹‰é€šè¿‡é‡å­ç§‘æŠ€å®ç°æ— é™å­˜å‚¨ï¼Œå®ƒä¸äº¬éƒ½å¸‚è¿›è¡Œé¡¹ç›®åˆä½œï¼Œå­˜å‚¨åŸå¸‚è®°å¿†ï¼Œè¿›è¡Œå†å²å¤ç°ã€‚</p>
<p>æ•´éƒ¨ç”µå½±ä¸»è¦åˆ’åˆ†å››ä¸ªæ—¶ç©ºï¼š2027å¹´â€”â€”ç¬¬ä¸€æ—¶ç©ºï¼ˆè™šæ‹Ÿæ•°æ®ï¼‰ã€2037å¹´â€”â€”ç¬¬äºŒæ—¶ç©ºï¼ˆè™šæ‹Ÿæ•°æ®ï¼‰ã€2047å¹´â€”â€”ç¬¬ä¸‰æ—¶ç©ºï¼ˆçœŸå®ä¸–ç•Œï¼‰ä»¥åŠä¸€ä¸ªå…¨æ–°æ—¶ç©ºï¼ˆè™šæ‹Ÿæ•°æ®ï¼‰ã€‚</p>
<p>ç¬¬äºŒæ—¶ç©ºçš„ç›´å®ï¼ˆç•ªå¤–ç”·ä¸»ï¼Œç®€ç§°è€å¸ˆï¼‰ï¼Œä¸ºäº†æ•‘ç‰ç’ƒï¼Œä½¿ç”¨é˜¿å°”å¡”æ‹‰ç³»ç»Ÿçš„äº¬éƒ½2027å¹´æ•°æ®ï¼Œåˆ›é€ å‡ºç¬¬ä¸€æ—¶ç©ºï¼Œä¼å›¾æ”¹å˜å†å²ï¼Œä¿æŠ¤ç‰ç’ƒã€‚</p>
<p>ç²¾ç¥å½¢æ€çš„ä»–æ¥åˆ°ç¬¬ä¸€æ—¶ç©ºï¼Œæ— æ³•ä½œå‡ºç‰©è´¨æ”¹å˜ã€‚ç¢°å·§çš„æ˜¯ç©¿è¶Šè¿‡æ¥ç›´æ¥ç¢°åˆ°äº†åå¹´å‰çš„ç›´å®ï¼Œæ³¢æŠ˜ä¹‹åç›´å®æ¥å—äº†ä»–æœªæ¥çš„è®¾å®šï¼Œå¹¶å†³å®šå¸®åŠ©è€å¸ˆã€‚</p>
<p>åœ¨æœªæ¥æœ€å¼ºç§˜ç±çš„æŒ‡å¼•ä¸‹ï¼Œç›´å®ä¸ç‰ç’ƒé€æ¸å‡æ¸©å¹¶è¡¨ç™½æˆåŠŸã€‚åŒæ—¶ï¼Œç›´å®é ä¹Œé¸¦èµ äºˆçš„ç¥ä¹‹æ‰‹ä¸æ–­ç»ƒä¹ è€å¸ˆæ•™çš„åˆ›é€ æœ¯ï¼Œä¸€åˆ‡æ— å…³æƒ…æ„Ÿç²¾ç¥çš„ä¸œè¥¿çš†å¯åˆ›é€ ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/19577/Know.jpg" class="" title="Know">

<p>çƒŸèŠ±å¤§ä¼šä¹‹å¤œï¼Œç‹é¢äººï¼ˆé˜¿å°”å¡”æ‹‰è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿï¼‰çªç„¶ç°èº«ï¼Œå®ƒä»¬æ„ŸçŸ¥åˆ°è®°å½•è¦è¢«ç¯¡æ”¹ï¼Œä¼å›¾å°†ä¸–ç•Œæ¢å¤åˆ°æ­£ç¡®çŠ¶æ€ã€‚ç›´å®å‡»é€€ç‹é¢äººåï¼Œä½¿ç”¨ç¥ä¹‹æ‰‹åˆ›é€ å‡ºé»‘æ´æŠµå¾¡é›·ç”µï¼ŒæˆåŠŸä¿æŠ¤ç‰ç’ƒã€‚</p>
<p>ä½†æ˜¯ï¼Œè€å¸ˆçªç„¶æ¨ªåˆ€å¤ºçˆ±ï¼Œå¸¦èµ°ç‰ç’ƒã€‚å› ä¸ºæ­¤æ—¶çš„ç‰ç’ƒï¼Œä¸åå¹´å‰è„‘æ­»äº¡çš„ç‰ç’ƒçš„ç²¾ç¥çŠ¶æ€åŸºæœ¬ä¸€è‡´ï¼Œåªè¦å°†2027å¹´çš„ç‰ç’ƒæ•°æ®å¸¦å›åˆ°2037å¹´ï¼Œå¹¶å°†æ•°æ®ä¸­çš„é‡å­ç²¾ç¥åŒæ­¥åˆ°ç¬¬äºŒæ—¶ç©ºç‰ç’ƒçš„ç‰©ç†ç²¾ç¥ï¼Œå°±èƒ½è®©å¥¹è‹é†’ã€‚ä½†æ˜¯ç‰ç’ƒè‹é†’çš„åŒæ—¶ï¼Œå¸¦ç€2027å¹´çš„æ•°æ®è®°å¿†ï¼Œè®¤å‡ºé¢å‰è¿™ä¸ªè€å¸ˆå¹¶éè‡ªå·±æ‰€çˆ±çš„ç›´å®ã€‚</p>
<p>ç¬¬ä¸€æ—¶ç©ºä¸­ï¼Œç›´å®å¤±å»æ‰€çˆ±ï¼ŒåŒæ—¶å¤±å»ç¥ä¹‹æ‰‹ã€‚ç‰ç’ƒæ•°æ®çš„ç¯¡æ”¹æ‰€å½±å“çš„èŒƒå›´è¶Šæ¥è¶Šå¤§ï¼Œé˜¿å°”å¡”æ‹‰ç ”ç©¶å®¤åœ¨ä¿®å¤æ— æœåå†³å®šé‡å¯ç¬¬ä¸€æ—¶ç©ºã€‚</p>
<p>ç—›è‹¦çš„ç›´å®æ„Ÿå—åˆ°ä¸–ç•Œå³å°†æ¯ç­ï¼Œæ¯…ç„¶è¿›å…¥è™«æ´å»æ•‘ç‰ç’ƒï¼Œå¹¶åœ¨æ—¶ç©ºéš§é“ä¸­ç›¸é‡ä¹Œé¸¦ã€‚ä¹Œé¸¦é‡æ–°èµ äºˆå…¶ç¥ä¹‹æ‰‹ï¼Œå¹¶æŒ‡å¼•ä»–å»ç¬¬äºŒæ—¶ç©ºæ•‘ç‰ç’ƒã€‚</p>
<p>ç¬¬äºŒæ—¶ç©ºä¸­ï¼Œå¼€å§‹å‡ºç°ç‹é¢äººï¼Œæ‰€ä»¥ç¬¬äºŒæ—¶ç©ºä¹Ÿæ˜¯è™šæ‹Ÿæ•°æ®ï¼Œå› ä¸ºç‰ç’ƒæ•°æ®è¢«ç¯¡æ”¹ï¼ŒåˆåŒæ—¶å‡ºç°äº†ä¸¤ä¸ªç›´å®ã€‚ç‹é¢äººå¿…é¡»æ¶ˆç­ç‰ç’ƒå’Œä¸¤ä¸ªç›´å®å…¶ä¸­çš„ä¸€ä¸ªã€‚</p>
<p>ä¸ºäº†åº”å¯¹ä¿®å¤ç³»ç»Ÿçš„ç‹é¢äººï¼Œç›´å®å¸¦ç€ç‰ç’ƒé€ƒè·‘ï¼Œè€å¸ˆä¹Ÿå¼€å§‹é†’æ‚Ÿã€‚åœ¨è€å¸ˆå’Œä¹Œé¸¦çš„å¸®åŠ©ä¸‹ï¼Œç›´å®å°†ç‰ç’ƒä¼ åˆ°å¦ä¸€å…¨æ–°æ—¶ç©ºã€‚è€å¸ˆæ·±çŸ¥ï¼Œä¸ªäººæ•°æ®è¿˜æ˜¯éš¾ä»¥æŠµæŒ¡ä¿®å¤ç³»ç»Ÿçš„åŠ›é‡ï¼Œæœ€åæ›¿ç›´å®æŠµæŒ¡ç³»ç»Ÿçš„æ”»å‡»ï¼Œç‰ºç‰²äº†è‡ªå·±ã€‚</p>
<p>ç›´å®å’Œç‰ç’ƒå»åˆ°å…¨æ–°æ—¶ç©ºï¼Œç›¸æ‹¥åœ¨ä¸€èµ·ã€‚</p>
<p>å½±ç‰‡çš„ç»“å°¾æ¥åˆ°äº†ç¬¬ä¸‰æ—¶ç©ºâ€”â€”æœˆçƒçš„ç ”ç©¶å®¤ï¼Œ2047å¹´ï¼Œç›´å®é†’æ¥ï¼Œå¹¶ä¸ç‰ç’ƒç›¸æ‹¥åœ¨ä¸€èµ·ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/19577/RealWorld.jpg" class="" title="RealWorld"> 



<h2 id="ç†è§£"><a href="#ç†è§£" class="headerlink" title="ç†è§£"></a>ç†è§£</h2><p>ä¸ºäº†ç†æ¸…é€»è¾‘ï¼Œåº”è¯¥ä»ç°å®ä¸–ç•Œåæ¨ã€‚</p>
<p>ã€ç¬¬ä¸‰æ—¶ç©ºâ€”â€”ç°å®ä¸–ç•Œã€‘</p>
<p>2027å¹´ï¼Œç›´å®ä¸ç‰ç’ƒç›¸è¯†ç›¸æ‹ã€‚</p>
<p>åœ¨çƒŸèŠ±å¤§ä¼šä¸Šï¼Œç›´å®ä¸ºäº†æ•‘ç‰ç’ƒï¼Œè¢«é›·ç”µå‡»ä¸­åè„‘æ­»äº¡ã€‚ã€æ­»äº¡æ—¶çš„ç²¾ç¥ï¼šä¸ºæ‰€çˆ±ä¹‹äººç‰ºç‰²è‡ªå·±ã€</p>
<p>ç‰ç’ƒç»è¿‡äº†10å¹´çš„å­¦ä¹ ä¸ç ”ç©¶ï¼Œå°†æ˜è¿·åå¹´çš„ç›´å®å¸¦ä¸Šäº†æœˆçƒçš„ç§‘ç ”åŸºåœ°ã€‚</p>
<p>ä¸ºäº†æ‹¯æ•‘ç›´å®ï¼Œç‰ç’ƒä½¿ç”¨é˜¿å°”å¡”æ‹‰åˆ›é€ ç¬¬äºŒæ—¶ç©ºï¼Œå¤ç°é›·å‡»åœºæ™¯ï¼Œä¼å›¾ä¿æŠ¤ç›´å®ï¼Œè·å–æ­¤æ—¶çš„é‡å­æ•°æ®ï¼Œä»¥åŒæ­¥ç°å®ä¸–ç•Œçš„ç‰©ç†ç²¾ç¥ã€‚ä½†æ˜¯è®¡åˆ’å¤±è´¥ï¼Œç‰ç’ƒè¢«é›·å‡»ä¸­åè„‘æ­»äº¡ã€‚</p>
<p>ã€ç¬¬äºŒæ—¶ç©ºâ€”â€”è™šæ‹Ÿæ•°æ®ã€‘</p>
<p>ç›´å®ç»è¿‡äº†åå¹´çš„å­¦ä¹ å’Œç ”ç©¶ï¼Œä¸ºäº†æ‹¯æ•‘ç‰ç’ƒï¼Œåœ¨è‡ªå·±èº«ä¸Šåšäº†æ— æ•°æ¬¡è¯•éªŒã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/19577/Try.jpg" class="" title="Try">

<p>æœ€ç»ˆä½¿ç”¨é˜¿å°”å¡”æ‹‰åˆ›é€ å‡ºç¬¬ä¸€æ—¶ç©ºï¼Œå¤ç°é›·å‡»åœºæ™¯ï¼ŒæˆåŠŸä¿æŠ¤ç‰ç’ƒï¼Œå¸¦èµ°äº†ç¬¬ä¸€æ—¶ç©ºçš„ç‰ç’ƒï¼Œå¯¼å…¥é‡å­ç²¾ç¥åˆ°ç¬¬äºŒæ—¶ç©ºç‰ç’ƒã€‚</p>
<p>ä½†æ˜¯ç¬¬äºŒæ—¶ç©ºçš„ç‰ç’ƒä¾ç„¶çˆ±ç€ç¬¬ä¸€æ—¶ç©ºçš„ç›´å®ï¼Œæœ€ç»ˆä¸ºäº†ç¬¬äºŒæ—¶ç©ºçš„å¥³ä¸»ï¼Œæ›¿ç¬¬ä¸€æ—¶ç©ºçš„ç”·ä¸»æŒ¡ä¸‹è‡´å‘½æ”»å‡»ç„¶åæ­»äº¡ã€‚ã€æ­»äº¡æ—¶çš„ç²¾ç¥ï¼šä¸ºæ‰€çˆ±ä¹‹äººç‰ºç‰²è‡ªå·±ã€</p>
<p>æ­¤æ—¶ä¹Œé¸¦æˆåŠŸè·å–åˆ°ç¬¬äºŒæ—¶ç©ºç›´å®çš„é‡å­ç²¾ç¥ï¼ŒåŒæ­¥åˆ°ç¬¬ä¸‰æ—¶ç©ºçš„ç›´å®ï¼Œç°å®ä¸–ç•Œçš„ç›´å®å¾—ä»¥è‹é†’ã€‚</p>
<p>ç‰ºç‰²ï¼Œé‡ç”Ÿã€‚</p>
<p>ã€å…¨æ–°æ—¶ç©ºâ€”â€”Hello Worldã€‘</p>
<p>ç¬¬äºŒæ—¶ç©ºçš„ç›´å®æ­»äº¡ä¹‹åï¼Œåƒå¤æ•™æˆå…³é—­äº†ä¿®å¤ç³»ç»Ÿã€‚</p>
<p>ç¬¬ä¸€æ—¶ç©ºçš„ç›´å®å’Œç‰ç’ƒæ¥åˆ°äº†å…¨æ–°æ—¶ç©ºï¼Œä¸å†å—åˆ°é™åˆ¶ï¼Œå³Hello Worldã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/19577/HelloWorld.jpg" class="" title="HelloWorld">

<p>ä½ å¥½ï¼Œä¸–ç•Œã€‚</p>
<h2 id="ç»†èŠ‚"><a href="#ç»†èŠ‚" class="headerlink" title="ç»†èŠ‚"></a>ç»†èŠ‚</h2><p>ç‰ç’ƒä¸ä¼šç”¨æ‰‹æœºï¼Œä½†ï¼Œåå¹´ç ”ç©¶ï¼Œåˆ›é€ å‡ºä¸¤ä¸ªè™šæ‹Ÿä¸–ç•Œã€‚</p>
<p>ç‰ç’ƒæ˜¯æœ‰æé«˜ç—‡ï¼Œä½†ï¼Œç™»ä¸Šæœˆçƒï¼Œæˆä¸ºé˜¿å°”å¡”æ‹‰ç§‘å­¦å®¶ã€‚</p>
<p>ç¬¬ä¸€æ—¶ç©ºçš„ä¹Œé¸¦ç”±ç¬¬äºŒæ—¶ç©ºçš„ç›´å®æ“çºµï¼Œç›®çš„æ˜¯å¤æ´»ç¬¬äºŒæ—¶ç©ºçš„ç‰ç’ƒã€‚</p>
<p>ç¬¬äºŒæ—¶ç©ºçš„ä¹Œé¸¦æ˜¯ç°å®ä¸–ç•Œçš„ä¸€è¡Œç‰ç’ƒï¼Œç›®çš„æ˜¯å¤æ´»ç°å®ä¸–ç•Œçš„ç›´å®ã€‚</p>
<h2 id="è¯„ä»·"><a href="#è¯„ä»·" class="headerlink" title="è¯„ä»·"></a>è¯„ä»·</h2><p>å½±ç‰‡ç»“å°¾ï¼Œçªç„¶åè½¬ï¼Œå¤šé‡æ—¶ç©ºå·²ç»æŠŠè„‘å­ç»•æ™•ï¼Œã€Šç›—æ¢¦ã€‹æœ‰å‰è½¦ä¹‹é‰´ã€‚</p>
<p>é¦–æ¬¡è§‚å½±ï¼Œè§‰å¾—æƒ…æ„Ÿçº¿æ¯”è¾ƒå•è°ƒï¼Œè—çš„å¾ˆå¤šï¼Œè¡¨ç°å¤ªå°‘ï¼Œåªèƒ½ç»†ç»†ä½“ä¼šã€‚</p>
<p>èµ°å‡ºå½±é™¢ï¼Œæ²¡æœ‰çœ‹å®Œã€Šå¤©æ°”ä¹‹å­ã€‹é‚£æ ·çš„å›è‚ è¡æ°”ï¼Œ90åˆ†é’Ÿçš„ç¡®ä¸å¤Ÿçˆ½ã€‚</p>
<p>ç¬¬ä¸€æ—¶ç©ºå¥³ä¸»çš„å†°å±±è„¸å‡ ä¹æ²¡æ€ä¹ˆå˜è¿‡ï¼Œç¬¬äºŒæ—¶ç©ºå¥³ä¸»æ¢å¼ å¿§éƒè„¸ç»§ç»­ä¿æŒï¼Œå¥½å§ï¼Œé•¿å¾—æ¼‚äº®å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºã€‚</p>
<p>ç”·ä¸»å¯¹çº¿é›·éœ†æ—¶ï¼Œå¥³ä¸»è¶´åœ¨åœ°ä¸Šèº«ä½“æ²¡åŠ¨(bug)ï¼Œç”·ä¸»æŠµå¾¡æˆåŠŸåå¥³ä¸»è„¸ä¸Šä¹Ÿæ¯«æ— æƒŠè®¶çš„è¡¨æƒ…ï¼Œå¥½åƒä¸å¤ªåˆç†ã€‚</p>
<p>å½“ç„¶ï¼Œ2Dæ¸²æŸ“3Dï¼Œç”»é£ç²¾è‡´ä¼˜ç¾ï¼Œæƒ…æ„Ÿç»†è…»çœŸå®ï¼Œçº¯çˆ±èåˆç§‘å¹»ï¼Œæƒ³è±¡ç‘°ä¸½å¥‡è°²ï¼Œè·¨è¶Šæ—¶ç©ºçš„æ•‘èµå¼•äººå…±æƒ…ã€‚</p>
<p>å¤šé‡ä¸–ç•Œï¼Œå¤šé‡è§£è¯»ï¼Œä½ å¯ä»¥é€‰æ‹©ä»»æ„åˆç†çš„è§’åº¦å»ç†è§£ã€‚</p>
<p>ä»¥ä¸Šã€‚</p>
<h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>ç”µå½±æ˜¯11å·çœ‹çš„ï¼Œå›åˆ°å®¿èˆå½±è¯„æ²¡æ¥å¾—åŠå†™å®Œã€‚</p>
<p>12å·ï¼Œå»åŒ»é™¢ä½“æ£€å›æ¥çš„è·¯ä¸Šè¢«è¯ˆéª—700ç°é‡‘ã€‚</p>
<p>å‘ç¤¾ä¼šäº¤äº†700å­¦è´¹ï¼Œæˆ–è®¸è¿™æ˜¯æˆ‘æˆé•¿çš„å¿…ç»ä¹‹äº‹ã€‚</p>
<p>è¿˜æ˜¯ä¸è‡ªæˆ‘å®‰æ…°äº†ï¼Œå°±æ˜¯è‡ªå·±ç¬¨ï¼Œç»™ä¸€ç›´ä»¥æ¥è‡ªè®¤ä¸ºç†æ€§çš„è‡ªå·±æ‰‡äº†ä¸€è€³å…‰ã€‚</p>
<p>å¤§å®¶é‡åˆ°è¿™ç§äº‹è¿˜æ˜¯è¦è­¦è§‰ï¼Œå­¦ä¼šæ‹’ç»ã€‚</p>
<p>é™Œç”Ÿäººå¯»åŠ©é€ä»–110ï¼Œæ•‘æ­»æ‰¶ä¼¤é€ä»–120ã€‚</p>
<p>å¸Œæœ›å¤©ä¸‹æ‰€æœ‰çš„å–„è‰¯éƒ½ä¸è¢«è¾œè´Ÿï¼Œæ‰€æœ‰çš„éª—å­éƒ½æ—©ç‚¹è¿›å¤§ç‰¢ï¼Œå…¨å®¶ICUé¢„è­¦ã€‚</p>
<p>13å·ï¼Œä¸¤ä¸ªå®¤å‹å“¥å“¥å¸¦æˆ‘å»è­¦å¯Ÿå±€åšç¬”å½•ï¼Œè¯¢é—®å”å”å¥½å‡¶ï¼Œç¬”å½•å°å“¥è¿˜ä¸é”™ã€‚</p>
<p>ä¸­åˆï¼Œä»–ä»¬è¯·æˆ‘åƒé¥­é¥­ï¼Œå¾½èœä¸è¡Œï¼ŒçœŸçš„ä¸è¡Œï¼ŒçœŸçš„å’¸ï¼Œå’¸çš„è¦å‘½ï¼Œä¸æ¨èã€‚</p>
<p>å¤§ä¸€åƒè¿‡ä¸€æ¬¡è‡­æ¡‚é±¼ç•™ä¸‹é˜´å½±ï¼Œä»Šå¤©çš„é±¼åˆæ˜¯åˆè…¥åˆå’¸ï¼Œç›´æ¥ç»™æˆ‘æ°¸ä¹…åŠé€€ã€‚</p>
]]></content>
      <categories>
        <category>å½±è¯„</category>
      </categories>
      <tags>
        <tag>å½±è¯„</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-5(å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜)</title>
    <url>/posts/53165/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ä¸å¯å˜ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡å­ä¸èƒ½å¤Ÿä¿®æ”¹å…¶å†…éƒ¨çŠ¶æ€ï¼ˆå±æ€§ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºä¸å­˜åœ¨å¹¶å‘ä¿®æ”¹ã€‚</p>
<h2 id="7-1-ä¸å¯å˜ç±»çš„ä½¿ç”¨"><a href="#7-1-ä¸å¯å˜ç±»çš„ä½¿ç”¨" class="headerlink" title="7.1 ä¸å¯å˜ç±»çš„ä½¿ç”¨"></a>7.1 ä¸å¯å˜ç±»çš„ä½¿ç”¨</h2><h3 id="7-1-1-é—®é¢˜æå‡º"><a href="#7-1-1-é—®é¢˜æå‡º" class="headerlink" title="7.1.1 é—®é¢˜æå‡º"></a>7.1.1 é—®é¢˜æå‡º</h3><p><code>SimpleDateFormat</code>ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸‹åˆ—ä»£ç æ‰§è¡Œæ—¶ä¼šäº§ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;SimpleDateFormat&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleDateFormatDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleDateFormat SDF = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String dateStr = <span class="string">&quot;2001-09-11 00:00:00.000&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(SDF.parse(dateStr).toString());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java.lang.NumberFormatException: multiple points</span><br><span class="line">	at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:<span class="number">1890</span>)</span><br><span class="line">	at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:<span class="number">110</span>)</span><br><span class="line">	at java.lang.Double.parseDouble(Double.java:<span class="number">538</span>)</span><br><span class="line">	at java.text.DigitList.getDouble(DigitList.java:<span class="number">169</span>)</span><br><span class="line">	at java.text.DecimalFormat.parse(DecimalFormat.java:<span class="number">2089</span>)</span><br><span class="line">	at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:<span class="number">1869</span>)</span><br><span class="line">	at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:<span class="number">1514</span>)</span><br><span class="line">	at java.text.DateFormat.parse(DateFormat.java:<span class="number">364</span>)</span><br><span class="line">	at top.parak.immutable.SimpleDateFormatDemo.lambda$main$<span class="number">0</span>(SimpleDateFormatDemo.java:<span class="number">22</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">29</span> <span class="number">11</span>:<span class="number">30</span>:<span class="number">23.116</span> [Thread-<span class="number">2</span>] DEBUG SimpleDateFormat - Sun Sep <span class="number">11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> CST <span class="number">1121</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">29</span> <span class="number">11</span>:<span class="number">30</span>:<span class="number">23.117</span> [Thread-<span class="number">9</span>] DEBUG SimpleDateFormat - Sun Sep <span class="number">11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> CST <span class="number">1121</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">29</span> <span class="number">11</span>:<span class="number">30</span>:<span class="number">23.117</span> [Thread-<span class="number">5</span>] DEBUG SimpleDateFormat - Tue Sep <span class="number">11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> CST <span class="number">2001</span></span><br></pre></td></tr></table></figure>



<h3 id="7-1-2-åŒæ­¥é”"><a href="#7-1-2-åŒæ­¥é”" class="headerlink" title="7.1.2 åŒæ­¥é”"></a>7.1.2 åŒæ­¥é”</h3><p>ä½¿ç”¨åŒæ­¥é”<code>synchronized</code>èƒ½è§£å†³å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (SDF) &#123;</span><br><span class="line">    log.debug(SDF.parse(dateStr).toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-1-3-ä¸å¯å˜"><a href="#7-1-3-ä¸å¯å˜" class="headerlink" title="7.1.3 ä¸å¯å˜"></a>7.1.3 ä¸å¯å˜</h3><p>ä½¿ç”¨JDK1.8ä¸­çš„ä¸å¯å˜æ—¥æœŸæ ¼å¼ç±»<code>DateTimeFormatter</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;DateTimeFormatter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateTimeFormatterDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateTimeFormatter DTF = DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String dateStr = <span class="string">&quot;2001-09-11 00:00:00.000&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                TemporalAccessor date = DTF.parse(dateStr);</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, date);</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-2-ä¸å¯å˜ç±»çš„è®¾è®¡"><a href="#7-2-ä¸å¯å˜ç±»çš„è®¾è®¡" class="headerlink" title="7.2 ä¸å¯å˜ç±»çš„è®¾è®¡"></a>7.2 ä¸å¯å˜ç±»çš„è®¾è®¡</h2><h3 id="7-1-1-finalçš„ä½¿ç”¨"><a href="#7-1-1-finalçš„ä½¿ç”¨" class="headerlink" title="7.1.1 finalçš„ä½¿ç”¨"></a>7.1.1 finalçš„ä½¿ç”¨</h3><p><code>Integer</code>ã€<code>Double</code>ã€<code>String</code>ã€<code>DateTimeFormatter</code>ä»¥åŠåŸºæœ¬ç±»å‹åŒ…è£…ç±»ï¼Œéƒ½æ˜¯ç”¨finalä¿®é¥°çš„ã€‚</p>
<ul>
<li>å±æ€§ç”¨finalä¿®é¥°ä¿è¯äº†è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ä¿®æ”¹</li>
<li>ç±»ç”¨finalä¿®é¥°ä¿è¯äº†è¯¥ç±»ä¸­çš„æ–¹æ³•ä¸èƒ½è¢«è¦†ç›–ï¼Œé˜²æ­¢å­ç±»æ— æ„é—´ç ´åä¸å¯å˜æ€§</li>
</ul>
<h3 id="7-2-2-ä¿æŠ¤æ€§æ‹·è´"><a href="#7-2-2-ä¿æŠ¤æ€§æ‹·è´" class="headerlink" title="7.2.2 ä¿æŠ¤æ€§æ‹·è´"></a>7.2.2 ä¿æŠ¤æ€§æ‹·è´</h3><p>ä»¥<code>String</code>çš„<code>substring</code>æ–¹æ³•ä¸ºä¾‹ï¼Œæ–¹æ³•çš„æœ€åè¿˜æ˜¯<code>new String</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">substring</span><span class="params">(<span class="keyword">int</span> beginIndex, <span class="keyword">int</span> endIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (beginIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(beginIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (endIndex &gt; value.length) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(endIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> subLen = endIndex - beginIndex;</span><br><span class="line">    <span class="keyword">if</span> (subLen &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(subLen);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ((beginIndex == <span class="number">0</span>) &amp;&amp; (endIndex == value.length)) ? <span class="keyword">this</span></span><br><span class="line">        : <span class="keyword">new</span> String(value, beginIndex, subLen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ç§åˆ›å»ºå‰¯æœ¬å¯¹è±¡æ¥é¿å…å…±äº«çš„æ‰‹æ®µç§°ä¸ºä¿æŠ¤æ€§æ‹·è´ï¼ˆdefensive copyï¼‰ã€‚</p>
<h3 id="7-2-3-æ¨¡å¼ä¹‹äº«å…ƒ"><a href="#7-2-3-æ¨¡å¼ä¹‹äº«å…ƒ" class="headerlink" title="7.2.3 æ¨¡å¼ä¹‹äº«å…ƒ"></a>7.2.3 æ¨¡å¼ä¹‹äº«å…ƒ</h3><p>å®šä¹‰ï¼šè¿ç”¨å…±äº«æŠ€æœ¯æ¥æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦å¯¹è±¡çš„å¤ç”¨ã€‚</p>
<p>ä¼˜åŠ¿ï¼šç›¸åŒå¯¹è±¡åªä¿å­˜ä¸€ä»½ï¼Œè¿™é™ä½äº†ç³»ç»Ÿä¸­å¯¹è±¡çš„æ•°é‡ï¼Œé™ä½å†…å­˜å‹åŠ›ã€‚</p>
<p>åœ¨JDKä¸­<code>Boolean</code>ã€<code>Byte</code>ã€<code>Short</code>ã€<code>Long</code>ã€<code>Character</code>ç­‰åŒ…è£…ç±»æä¾›äº†<code>valueOf</code>æ–¹æ³•ã€‚</p>
<p>ä¾‹å¦‚<code>Longh.valueOf()</code>ï¼Œåœ¨-128~127ä¹‹é—´çš„Longå¯¹è±¡ï¼Œåœ¨è¿™ä¸ªèŒƒå›´å†…ä¼šç”¨ç¼“å­˜å¯¹è±¡ï¼Œè¶…è¿‡è¿™ä¸ªèŒƒå›´ï¼Œæ‰ä¼šä¿¡ä»¶Longå¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">valueOf</span><span class="params">(<span class="keyword">long</span> l)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> offset = <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= -<span class="number">128</span> &amp;&amp; l &lt;= <span class="number">127</span>) &#123; <span class="comment">// will cache</span></span><br><span class="line">        <span class="keyword">return</span> LongCache.cache[(<span class="keyword">int</span>)l + offset];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Long(l);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼š</p>
<ul>
<li><code>Byte</code>ã€<code>Short</code>ã€<code>Long</code>ç¼“å­˜çš„èŒƒå›´ï¼š-128~127</li>
<li><code>Character</code>ç¼“å­˜çš„èŒƒå›´ï¼š0~127</li>
<li><code>Integer</code>çš„é»˜è®¤èŒƒå›´ï¼š-128~127ï¼Œæœ€å°å€¼ä¸èƒ½å˜ï¼Œæœ€å¤§å€¼é€šè¿‡è™šæ‹Ÿæœºå‚æ•°<code>-Djava.lang.Integer.IntegerCache.high</code>æ¥æ”¹å˜ã€‚</li>
<li><code>Boolean</code>ç¼“å­˜ï¼štrue / false</li>
</ul>
<h3 id="7-2-4-DIYè¿æ¥æ± "><a href="#7-2-4-DIYè¿æ¥æ± " class="headerlink" title="7.2.4 DIYè¿æ¥æ± "></a>7.2.4 DIYè¿æ¥æ± </h3><p>ä¾‹å¦‚ï¼šä¸€ä¸ªçº¿ä¸Šå•†åŸåº”ç”¨ï¼ŒQPS è¾¾åˆ°æ•°åƒï¼Œå¦‚æœæ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºå’Œå…³é—­æ•°æ®åº“è¿æ¥ï¼Œæ€§èƒ½ä¼šå—åˆ°æå¤§å½±å“ã€‚ è¿™æ—¶é¢„å…ˆåˆ›å»ºå¥½ä¸€æ‰¹è¿æ¥ï¼Œæ”¾å…¥è¿æ¥æ± ã€‚ä¸€æ¬¡è¯·æ±‚åˆ°è¾¾åï¼Œä»è¿æ¥æ± è·å–è¿æ¥ï¼Œä½¿ç”¨å®Œæ¯•åå†è¿˜å›è¿æ¥æ± ï¼Œè¿™æ ·æ—¢èŠ‚çº¦äº†è¿æ¥çš„åˆ›å»ºå’Œå…³é—­æ—¶é—´ï¼Œä¹Ÿå®ç°äº†è¿æ¥çš„é‡ç”¨ï¼Œä¸è‡³äºè®©åºå¤§çš„è¿æ¥æ•°å‹å®æ•°æ®åº“ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicIntegerArray;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-04-29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Pool pool = <span class="keyword">new</span> Pool(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">               Connection connection = pool.get();</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   TimeUnit.MILLISECONDS.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>));</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               pool.free(connection);</span><br><span class="line">            &#125;, <span class="string">&quot;T-&quot;</span> + (i + <span class="number">1</span>)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Pool&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pool</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿æ¥æ± å¤§å°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> poolSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿æ¥æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Connection[] connections;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿æ¥çŠ¶æ€æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicIntegerArray states;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–è¿æ¥æ± </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pool</span><span class="params">(<span class="keyword">int</span> pollSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.poolSize = pollSize;</span><br><span class="line">        connections = <span class="keyword">new</span> Connection[pollSize];</span><br><span class="line">        states = <span class="keyword">new</span> AtomicIntegerArray(<span class="keyword">new</span> <span class="keyword">int</span>[pollSize]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollSize; i++) &#123;</span><br><span class="line">            connections[i] = <span class="keyword">new</span> ParaKConnection(<span class="string">&quot;è¿æ¥&quot;</span> + (i + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ä¸€ä¸ªè¿æ¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// æŸ¥çœ‹æ˜¯å¦æœ‰ç©ºé—²è¿æ¥</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (states.get(i) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (states.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                        log.debug(<span class="string">&quot;get &#123;&#125;&quot;</span>, connections[i]);</span><br><span class="line">                        <span class="keyword">return</span> connections[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰ç©ºé—²è¿æ¥åˆ™ç­‰å¾…</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;wait...&quot;</span>);</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾ä¸€ä¸ªè¿æ¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">free</span><span class="params">(Connection connection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connections[i] == connection) &#123;</span><br><span class="line">                states.set(i, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;free &#123;&#125;&quot;</span>, connection);</span><br><span class="line">                    <span class="keyword">this</span>.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParaKConnection</span> <span class="keyword">implements</span> <span class="title">Connection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParaKConnection</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ParaKConnection[&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯æ”¹è¿›ç‚¹ï¼š</p>
<ul>
<li>è¿æ¥çš„åŠ¨æ€å¢é•¿ä¸æ”¶ç¼©</li>
<li>è¿æ¥ä¿æ´»ï¼ˆå¯ç”¨æ€§æ£€æµ‹ï¼‰</li>
<li>ç­‰å¾…è¶…æ—¶å¤„ç†</li>
<li>åˆ†å¸ƒå¼hash</li>
</ul>
<h2 id="7-3-finalåŸç†"><a href="#7-3-finalåŸç†" class="headerlink" title="7.3 finalåŸç†"></a>7.3 finalåŸç†</h2><h3 id="7-3-1-è®¾ç½®finalå˜é‡çš„åŸç†"><a href="#7-3-1-è®¾ç½®finalå˜é‡çš„åŸç†" class="headerlink" title="7.3.1 è®¾ç½®finalå˜é‡çš„åŸç†"></a>7.3.1 è®¾ç½®finalå˜é‡çš„åŸç†</h3><p>å¯¹äºä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FinalDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> k = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>initå­—èŠ‚ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0 aload_0</span><br><span class="line">1 invokespecial #1 &lt;java&#x2F;lang&#x2F;Object.&lt;init&gt;&gt;</span><br><span class="line">4 aload_0</span><br><span class="line">5 iconst_3</span><br><span class="line">6 putfield #2 &lt;top&#x2F;parak&#x2F;immutable&#x2F;FinalDemo.k&gt;</span><br><span class="line">&lt;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; å†™å±éšœ</span><br><span class="line">9 return</span><br></pre></td></tr></table></figure>

<p>å‘ç°finalå˜é‡çš„èµ‹å€¼ä¹Ÿä¼šé€šè¿‡putfieldæŒ‡ä»¤æ¥å®Œæˆï¼ŒåŒæ ·åœ¨è¿™æ¡æŒ‡ä»¤ä¹‹åä¹Ÿä¼šåŠ å…¥å†™å±éšœï¼Œä¿è¯åœ¨å…¶ä»–çº¿ç¨‹è¯»åˆ°å®ƒçš„å€¼æ—¶ä¸ä¼šå‡ºç°ä¸º0çš„æƒ…å†µã€‚</p>
<h3 id="7-3-2-è·å–finalå˜é‡çš„åŸç†"><a href="#7-3-2-è·å–finalå˜é‡çš„åŸç†" class="headerlink" title="7.3.2 è·å–finalå˜é‡çš„åŸç†"></a>7.3.2 è·å–finalå˜é‡çš„åŸç†</h3><p>å¯¹äºä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FinalDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> A = <span class="number">33333</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> b = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> B = <span class="number">33333</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> FinalDemo().a);</span><br><span class="line">        System.out.println(A);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> FinalDemo().b);</span><br><span class="line">        System.out.println(B);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mainå­—èŠ‚ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> # è·å–æ‰“å°æµ</span><br><span class="line"> 0 getstatic #4 &lt;java&#x2F;lang&#x2F;System.out&gt;</span><br><span class="line"> </span><br><span class="line"> # æ‰“å°a</span><br><span class="line"> 3 new #5 &lt;top&#x2F;parak&#x2F;immutable&#x2F;FinalDemo&gt;</span><br><span class="line"> 6 dup</span><br><span class="line"> 7 invokespecial #6 &lt;top&#x2F;parak&#x2F;immutable&#x2F;FinalDemo.&lt;init&gt;&gt;</span><br><span class="line">10 getfield #2 &lt;top&#x2F;parak&#x2F;immutable&#x2F;FinalDemo.a&gt;</span><br><span class="line">13 invokevirtual #7 &lt;java&#x2F;io&#x2F;PrintStream.println&gt;</span><br><span class="line"></span><br><span class="line"># æ‰“å°A</span><br><span class="line">16 getstatic #4 &lt;java&#x2F;lang&#x2F;System.out&gt;</span><br><span class="line"># ä¸åŠ finalï¼Œè·å–Aå˜é‡çš„æ—¶å€™ä½¿ç”¨getStaticï¼Œä½¿ç”¨å…±äº«å†…å­˜</span><br><span class="line">19 getstatic #8 &lt;top&#x2F;parak&#x2F;immutable&#x2F;FinalDemo.A&gt;  </span><br><span class="line">22 invokevirtual #7 &lt;java&#x2F;io&#x2F;PrintStream.println&gt;</span><br><span class="line">25 getstatic #4 &lt;java&#x2F;lang&#x2F;System.out&gt;</span><br><span class="line"></span><br><span class="line"># æ‰“å°b</span><br><span class="line">28 new #5 &lt;top&#x2F;parak&#x2F;immutable&#x2F;FinalDemo&gt;</span><br><span class="line">31 dup</span><br><span class="line">32 invokespecial #6 &lt;top&#x2F;parak&#x2F;immutable&#x2F;FinalDemo.&lt;init&gt;&gt;</span><br><span class="line">35 invokevirtual #9 &lt;java&#x2F;lang&#x2F;Object.getClass&gt;</span><br><span class="line">38 pop</span><br><span class="line">39 iconst_3</span><br><span class="line">40 invokevirtual #7 &lt;java&#x2F;io&#x2F;PrintStream.println&gt;</span><br><span class="line"></span><br><span class="line"># æ‰“å°B</span><br><span class="line">43 getstatic #4 &lt;java&#x2F;lang&#x2F;System.out&gt;</span><br><span class="line"># åŠ äº†finalï¼Œæ²¡æœ‰ç›´æ¥å»è·å–Aå˜é‡ï¼Œè€Œæ˜¯å°†Aå¤åˆ¶åˆ°å½“å‰Javaè™šæ‹Ÿæœºæ ˆä¸­</span><br><span class="line">46 ldc #10 &lt;33333&gt;</span><br><span class="line">48 invokevirtual #7 &lt;java&#x2F;io&#x2F;PrintStream.println&gt;</span><br><span class="line">51 return</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡è§‚å¯Ÿå­—èŠ‚ç å¯ä»¥å‘ç°ï¼Œfinalä¿®é¥°çš„å˜é‡æœ‰æ ˆå†…å­˜è¯»å–é€Ÿåº¦çš„ä¼˜åŒ–ã€‚</p>
<h2 id="7-4-æ— çŠ¶æ€"><a href="#7-4-æ— çŠ¶æ€" class="headerlink" title="7.4 æ— çŠ¶æ€"></a>7.4 æ— çŠ¶æ€</h2><p>è®¾è®¡Servletæ—¶ä¸ºäº†ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ï¼Œéƒ½ä¼šæœ‰è¿™æ ·çš„å»ºè®®ï¼Œä¸è¦ä¸ºServletè®¾ç½®æˆå‘˜å˜é‡ï¼Œè¿™ç§æ²¡æœ‰ä»»ä½•æˆå‘˜å˜é‡çš„ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>å› ä¸ºæˆå‘˜å˜é‡ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥ç§°ä¸ºæ— çŠ¶æ€ä¿¡æ¯ï¼Œå› ä¸ºæ²¡æœ‰æˆå‘˜å˜é‡å°±ç§°ä¹‹ä¸ºã€æ— çŠ¶æ€ã€‘ã€‚</p>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-1(JVMæ¦‚è¿°)</title>
    <url>/posts/21157/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-1-ğŸ“š-æ¦‚è¿°"><a href="#1-1-ğŸ“š-æ¦‚è¿°" class="headerlink" title="1.1 ğŸ“š æ¦‚è¿°"></a>1.1 ğŸ“š æ¦‚è¿°</h2><blockquote>
<p>ğŸ“– å®šä¹‰</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºå°±æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç çš„è¿è¡Œç¯å¢ƒï¼Œè´Ÿè´£è£…è½½å­—èŠ‚ç åˆ°å…¶å†…éƒ¨ï¼Œè§£é‡Š/ä¾¿äºä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚</p>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<ul>
<li>ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œ</li>
<li>è‡ªåŠ¨å†…å­˜ç®¡ç†</li>
<li>åƒåœ¾è‡ªåŠ¨å›æ”¶</li>
</ul>
<div class="mermaid">graph TD
A[Javaç¨‹åº]
B[å­—èŠ‚ç æ–‡ä»¶]
C[Winç‰ˆJVM]
D[Linuxç‰ˆJVM]
E[Maç‰ˆJVM]
A --&gt; B
B --&gt; C
B --&gt; D
B --&gt; E</div>



<blockquote>
<p>ğŸ•µï¸ Javaä»£ç çš„æ‰§è¡Œæµç¨‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/21157/Java.svg" class="" title="Java"><br />





<blockquote>
<p>ğŸ”° æ‹“å±•</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºä¸ä»…ä»…èƒ½ç”¨æ¥è§£é‡ŠJavaè¯­è¨€ã€‚</p>
<p>JVMæ ¹æœ¬ä¸å…³å¿ƒè¿è¡Œåœ¨å…¶å†…éƒ¨çš„ç¨‹åºåˆ°åº•æ˜¯ä½•ç§è¯­è¨€ç¼–å†™çš„ï¼Œå®ƒåªå…³å¿ƒâ€œå­—èŠ‚ç â€æ–‡ä»¶ã€‚</p>
<p>å³JVMå…·æœ‰è¯­è¨€æ— å…³æ€§ï¼Œå¹¶ä¸ä¼šå•çº¯åœ°ä¸Javaè¯­è¨€ç»ˆèº«ç»‘å®šï¼Œåªè¦å…¶ä»–ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘ç»“æœæ»¡è¶³å¹¶åŒ…å«JVMçš„å†…éƒ¨æŒ‡ä»¤é›†ã€ç¬¦å·è¡¨ä»¥åŠå…¶ä»–çš„è¾…åŠ©ä¿¡æ¯ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œèƒ½å¤Ÿè¢«JVMæ‰€è¯†åˆ«ã€è£…è½½å¹¶è¿è¡Œã€‚</p>
<p><u>Javaå¹¶ä¸æ˜¯æœ€å¼ºå¤§çš„è¯­è¨€ï¼Œä½†JVMæ˜¯æœ€å¼ºå¤§çš„è™šæ‹Ÿæœºã€‚</u></p>
<div class="mermaid">graph TD
A1((Kotlin))
B1((Clojure))
C1((Groovy))
D1((Scala))
E1((Jython))
F1((JRuby))
G1((JavaScript))
A2[ç¼–è¯‘å™¨]
B2[ç¼–è¯‘å™¨]
C2[ç¼–è¯‘å™¨]
D2[ç¼–è¯‘å™¨]
E2[ç¼–è¯‘å™¨]
F2[ç¼–è¯‘å™¨]
G2[ç¼–è¯‘å™¨]
H[å­—èŠ‚ç æ–‡ä»¶]
I[Javaè™šæ‹Ÿæœº]
A1 --&gt; A2
B1 --&gt; B2
C1 --&gt; C2
D1 --&gt; D2 
E1 --&gt; E2
F1 --&gt; F2
G1 --&gt; G2
A2 --&gt; H
B2 --&gt; H
C2 --&gt; H
D2 --&gt; H
E2 --&gt; H
F2 --&gt; H
G2 --&gt; H
H --&gt; I</div>



<h2 id="1-2-ğŸ“‚-ç»“æ„"><a href="#1-2-ğŸ“‚-ç»“æ„" class="headerlink" title="1.2 ğŸ“‚ ç»“æ„"></a>1.2 ğŸ“‚ ç»“æ„</h2><blockquote>
<p>ğŸ“˜ è¯´æ˜</p>
</blockquote>
<ul>
<li>HotSpot VMæ˜¯ç›®å‰å¸‚é¢ä¸Šé«˜æ€§èƒ½è™šæ‹Ÿæœºçš„ä»£è¡¨ä½œä¹‹ä¸€</li>
<li>å®ƒé‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„</li>
</ul>
<blockquote>
<p>ğŸ“· JVMæ¶æ„å›¾</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/21157/JVM.svg" class="" title="JVM"><br />



<h2 id="1-3-â³-ç”Ÿå‘½å‘¨æœŸ"><a href="#1-3-â³-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="1.3 â³ ç”Ÿå‘½å‘¨æœŸ"></a>1.3 â³ ç”Ÿå‘½å‘¨æœŸ</h2><blockquote>
<p>ğŸ è™šæ‹Ÿæœºçš„å¯åŠ¨</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºçš„å¯åŠ¨æ˜¯é€šè¿‡å¼•å¯¼ç±»åŠ è½½å™¨(Bootstrap Class Loader)åˆ›å»ºä¸€ä¸ªåˆå§‹ç±»(initial class)æ¥å®Œæˆçš„ï¼Œè¿™ä¸ªç±»æ˜¯ç”±è™šæ‹Ÿæœºçš„å…·ä½“å®ç°æŒ‡å®šçš„ã€‚</p>
<blockquote>
<p>ğŸ è™šæ‹Ÿæœºçš„æ‰§è¡Œ</p>
</blockquote>
<ul>
<li>ä¸€ä¸ªè¿è¡Œä¸­çš„Javaè™šæ‹Ÿæœºæœ‰ç€ä¸€ä¸ªæ¸…æ™°çš„ä»»åŠ¡ï¼šæ‰§è¡ŒJavaç¨‹åº</li>
<li>ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶ä»–æ‰è¿è¡Œï¼Œç¨‹åºç»“æŸæ—¶ä»–å°±åœæ­¢</li>
<li>æ‰§è¡Œä¸€ä¸ªæ‰€è°“çš„Javaç¨‹åºçš„æ—¶å€™ï¼ŒçœŸçœŸæ­£æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªå«åšJavaè™šæ‹Ÿæœºçš„è¿›ç¨‹</li>
</ul>
<blockquote>
<p>ğŸ è™šæ‹Ÿæœºçš„é€€å‡º</p>
</blockquote>
<ul>
<li>ç¨‹åºæ­£å¸¸æ‰§è¡Œç»“æŸ</li>
<li>ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸æˆ–é”™è¯¯è€Œå¼‚å¸¸ç»ˆæ­¢</li>
<li>ç”±äºæ“ä½œç³»ç»Ÿå‡ºç°é”™è¯¯è€Œå¯¼è‡´Javaè™šæ‹Ÿæœºè¿›ç¨‹ç»ˆæ­¢</li>
<li>æŸçº¿ç¨‹è°ƒç”¨Runtimeç±»æˆ–Systemç±»çš„exitæ–¹æ³•ï¼Œæˆ–Runtimeç±»çš„haltæ–¹æ³•ï¼Œå¹¶ä¸”Javaå®‰å…¨ç®¡ç†å™¨ä¹Ÿå…è®¸è¿™æ¬¡exitæˆ–haltæ“ä½œ</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼ŒJNIè§„èŒƒæè¿°äº†ç”¨JNI Invocation APIæ¥åŠ è½½æˆ–å¸è½½Javaè™šæ‹Ÿæœºæ—¶ï¼ŒJavaè™šæ‹Ÿæœºçš„é€€å‡ºæƒ…å†µã€‚</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-10(ç›´æ¥å†…å­˜)</title>
    <url>/posts/6513/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="10-1-ğŸ“–-æ¦‚è¿°"><a href="#10-1-ğŸ“–-æ¦‚è¿°" class="headerlink" title="10.1 ğŸ“– æ¦‚è¿°"></a>10.1 ğŸ“– æ¦‚è¿°</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<p>ç›´æ¥å†…å­˜ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚</p>
<p>ç›´æ¥å†…å­˜æ˜¯åœ¨Javaå †å¤–çš„ï¼Œç›´æ¥å‘ç³»ç»Ÿç”³è¯·çš„å†…å­˜åŒºé—´ã€‚</p>
<p>æ¥æºäºNIOï¼Œé€šè¿‡å­˜åœ¨å †ä¸­çš„DirectByteBufferæ“ä½œNativeå†…å­˜ã€‚</p>
<blockquote>
<p>âš™ï¸ è®¾ç½®</p>
</blockquote>
<ul>
<li>ç›´æ¥å†…å­˜å¤§å°å¯ä»¥é€šè¿‡<code>MaxDirectMemorySize</code>è®¾ç½®</li>
<li>å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸å †çš„æœ€å¤§å€¼<code>-Xmx</code>å‚æ•°å€¼ä¸€è‡´</li>
</ul>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<p>é€šå¸¸ï¼Œè®¿é—®ç›´æ¥å†…å­˜çš„é€Ÿåº¦ä¼šä¼˜äºJavaå †ï¼Œå³è¯»å†™æ€§èƒ½é«˜ã€‚</p>
<ul>
<li>å› æ­¤å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œè¯»å†™é¢‘ç¹çš„åœºåˆå¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨ç›´æ¥å†…å­˜ã€‚</li>
<li>Javaçš„NIOåº“å…è®¸Javaç¨‹åºä½¿ç”¨ç›´æ¥å†…å­˜ï¼Œç”¨äºæ•°æ®ç¼“å†²åŒºã€‚</li>
</ul>
<blockquote>
<p>âŒ¨ï¸ ç¤ºä¾‹</p>
</blockquote>
<p>ä½¿ç”¨ä¸‹åˆ—ä»£ç ï¼Œç›´æ¥åˆ†é…æœ¬åœ°å†…å­˜ç©ºé—´</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate(BUFFER);</span><br><span class="line">        System.out.println(<span class="string">&quot;ç›´æ¥å†…å­˜åˆ†é…å®Œæ¯•&quot;</span>);</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        scanner.next();</span><br><span class="line">        System.out.println(<span class="string">&quot;ç›´æ¥å†…å­˜å¼€å§‹é‡Šæ”¾&quot;</span>);</span><br><span class="line">        byteBuffer = <span class="keyword">null</span>;</span><br><span class="line">        System.gc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¹‹åå¯ä»¥çœ‹åˆ°è¿›ç¨‹å·²åˆ†é…å†…å­˜ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/6513/image-20210307135732364.png" class="" title="image-20210307135732364"><br />



<h2 id="10-2-ğŸŒ€-éç›´æ¥ç¼“å†²åŒºå’Œç¼“å†²åŒº"><a href="#10-2-ğŸŒ€-éç›´æ¥ç¼“å†²åŒºå’Œç¼“å†²åŒº" class="headerlink" title="10.2 ğŸŒ€ éç›´æ¥ç¼“å†²åŒºå’Œç¼“å†²åŒº"></a>10.2 ğŸŒ€ éç›´æ¥ç¼“å†²åŒºå’Œç¼“å†²åŒº</h2><blockquote>
<p>ğŸŸ£ éç›´æ¥ç¼“å†²åŒº</p>
</blockquote>
<p>è¯»å†™æ–‡ä»¶ï¼Œéœ€è¦ä¸ç£ç›˜äº¤äº’ï¼Œéœ€è¦ç”±ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸ã€‚åœ¨å†…æ ¸æ€æ—¶ï¼Œéœ€è¦å†…å­˜å¦‚ä¸‹å›¾çš„æ“ä½œã€‚</p>
<p>éœ€è¦ä¸¤ä»½å†…å­˜å­˜å‚¨é‡å¤æ•°æ®ï¼Œæ•ˆç‡ä½ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/6513/image-20210307140157439.png" class="" title="image-20210307140157439"><br />



<blockquote>
<p>ğŸŸ  ç›´æ¥ç¼“å†²åŒº</p>
</blockquote>
<p>ä½¿ç”¨NIOæ—¶ï¼Œå¦‚ä¸‹å›¾ã€‚</p>
<p>æ“ä½œç³»ç»Ÿåˆ’å‡ºçš„ç›´æ¥ç¼“å­˜åŒºå¯ä»¥è¢«Javaä»£ç ç›´æ¥è®¿é—®ï¼Œåªæœ‰ä¸€ä»½ã€‚</p>
<p>NIOé€‚åˆå¯¹å¤§æ–‡ä»¶çš„è¯»å†™æ“ä½œã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/6513/image-20210307140437915.png" class="" title="image-20210307140437915"><br />



<blockquote>
<p>âŒ¨ï¸ æµ‹è¯•æ¡ˆä¾‹</p>
</blockquote>
<p>åˆ†åˆ«ä½¿ç”¨BIOå’ŒNIOè¿›è¡Œå¤åˆ¶å¤è”å››ç”µå½±æ–‡ä»¶(3.74GB)ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CopyFileTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MOVIE_NAME = <span class="string">&quot;D:/BaiduNetdiskDownload/å¤ä»‡è€…è”ç›Ÿ4-ç»ˆå±€ä¹‹æˆ˜.mp4&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ONE_HUNDRED_MB = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;BIOè€—æ—¶ï¼š&quot;</span> + inDirectBuffer(MOVIE_NAME, MOVIE_NAME + <span class="string">&quot;.copy.mp4&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;NIOè€—æ—¶ï¼š&quot;</span> + directBuffer(MOVIE_NAME, MOVIE_NAME+ <span class="string">&quot;.copy.mp4&quot;</span>)); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * BIOå¤åˆ¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">inDirectBuffer</span><span class="params">(String src, String dest)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(src);</span><br><span class="line">        FileOutputStream outputStream = <span class="keyword">new</span> FileOutputStream(dest);</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[ONE_HUNDRED_MB];</span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((len = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            outputStream.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        inputStream.close();</span><br><span class="line">        outputStream.close();</span><br><span class="line">        <span class="keyword">return</span> end - start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * NIOå¤åˆ¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">directBuffer</span><span class="params">(String src, String dest)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        FileChannel inChannel = <span class="keyword">new</span> FileInputStream(src).getChannel();</span><br><span class="line">        FileChannel outChannel = <span class="keyword">new</span> FileOutputStream(dest).getChannel();</span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate(ONE_HUNDRED_MB);</span><br><span class="line">        <span class="keyword">while</span> (inChannel.read(byteBuffer) != -<span class="number">1</span>) &#123;</span><br><span class="line">            byteBuffer.flip();</span><br><span class="line">            outChannel.write(byteBuffer);</span><br><span class="line">            byteBuffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        inChannel.close();</span><br><span class="line">        outChannel.close();</span><br><span class="line">        <span class="keyword">return</span> end - start;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BIOè€—æ—¶ï¼š11946</span><br><span class="line">NIOè€—æ—¶ï¼š9079</span><br></pre></td></tr></table></figure>



<h2 id="10-3-ğŸ’¢-å­˜åœ¨çš„é—®é¢˜"><a href="#10-3-ğŸ’¢-å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="10.3 ğŸ’¢ å­˜åœ¨çš„é—®é¢˜"></a>10.3 ğŸ’¢ å­˜åœ¨çš„é—®é¢˜</h2><blockquote>
<p>ğŸ”º é—®é¢˜</p>
</blockquote>
<ul>
<li><p>ä¹Ÿå¯èƒ½å¯¼è‡´OutOfMemoryErrorå¼‚å¸¸ã€‚</p>
</li>
<li><p>ç”±äºç›´æ¥å†…å­˜åœ¨Javaå †å¤–ï¼Œå› æ­¤å®ƒçš„å¤§å°ä¸ä¼šç›´æ¥å—é™äº-XmxæŒ‡å®šçš„æœ€å¤§å †å¤§å°ï¼Œä½†æ˜¯ç³»ç»Ÿå†…å­˜æ˜¯æœ‰é™çš„ï¼ŒJavaå †å’Œç›´æ¥å†…å­˜çš„æ€»å’Œä¾ç„¶å—é™äºæ“ä½œç³»ç»Ÿèƒ½ç»™å‡ºçš„æœ€å¤§å†…å­˜ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ”» ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>åˆ†é…å›æ”¶æˆæœ¬é«˜ã€‚</li>
<li>ä¸å—JVMå†…å­˜å›æ”¶ç®¡ç†ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’Œ æ€»ç»“</p>
</blockquote>
<p>java process memory = java heap + native memory</p>
<p>è¿›ç¨‹å†…å­˜ç©ºé—´ = å †ç©ºé—´ + æœ¬åœ°å†…å­˜</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-12(String Table)</title>
    <url>/posts/59786/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="12-1-ğŸ“–-æ¦‚è¿°"><a href="#12-1-ğŸ“–-æ¦‚è¿°" class="headerlink" title="12.1 ğŸ“– æ¦‚è¿°"></a>12.1 ğŸ“– æ¦‚è¿°</h2><blockquote>
<p>ğŸŒ  åŸºæœ¬ç‰¹æ€§</p>
</blockquote>
<ul>
<li>Stringå­—ç¬¦ä¸²ä½¿ç”¨ä¸€å¯¹â€â€å¼•èµ·æ¥è¡¨ç¤ºã€‚</li>
<li>Stringå£°æ˜ä¸ºfinalï¼Œä¸å¯è¢«ç»§æ‰¿ã€‚</li>
<li>Stringå®ç°äº†Serializableæ¥å£ï¼šè¡¨ç¤ºå­—ç¬¦ä¸²æ˜¯æ”¯æŒåºåˆ—åŒ–çš„ã€‚</li>
<li>Stringå®ç°äº†Comparableæ¥å£ï¼Œè¡¨ç¤ºStringå¯ä»¥æ¯”è¾ƒå¤§å°ã€‚</li>
<li>Stringåœ¨jdk8åŠä»¥å‰å†…éƒ¨å®šä¹‰äº†final char[] valueç”¨äºå­˜å‚¨å­—ç¬¦ä¸²æ•°æ®ã€‚jdk9æ—¶æ”¹ä¸ºbyte[]</li>
</ul>
<blockquote>
<p>â” Stringå­˜å‚¨ç»“æ„å˜æ›´çš„åŸå› </p>
</blockquote>
<p>JDK8åŠä»¥å‰ä¸­Stringç±»çš„å®ç°å°†å­—ç¬¦å­˜å‚¨åœ¨charæ•°ç»„ä¸­ï¼Œæ¯ä¸ªå­—ç¬¦å ç”¨ä¸¤ä¸ªå­—èŠ‚ã€‚ä»è®¸å¤šä¸åŒçš„åº”ç”¨ç¨‹åºæ”¶é›†çš„æ•°æ®è¡¨æ˜ï¼Œå­—ç¬¦ä¸²æ˜¯å †ä½¿ç”¨çš„ä¸»è¦ç»„æˆéƒ¨åˆ†ï¼Œè€Œä¸”ï¼Œå¤§å¤šæ•°å­—ç¬¦ä¸²å¯¹è±¡åªåŒ…å«æ‹‰ä¸å­—ç¬¦ã€‚è¿™äº›å­—ç¬¦åªéœ€è¦ä¸€ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼Œå› æ­¤è¿™äº›å­—ç¬¦ä¸²å¯¹è±¡çš„å†…éƒ¨charæ•°ç»„ä¸­æœ‰ä¸€åŠçš„ç©ºé—´å°†ä¸ä¼šä½¿ç”¨ã€‚</p>
<p>JDK9å°†Stringå†…éƒ¨è¡¨ç¤ºä»UTF-16çš„charæ•°ç»„æ”¹ä¸ºbyteæ•°ç»„+ç¼–ç æ ‡å¿—å­—æ®µã€‚æ–°çš„Stringç±»å°†æ ¹æ®å­—ç¬¦ä¸²çš„å†…å®¹å­˜å‚¨ç¼–ç ä¸ºISO-8859-1/Latin-1(æ¯ä¸ªå­—ç¬¦ä¸€ä¸ªå­—èŠ‚)æˆ–UTF-16(æ¯ä¸ªå­—ç¬¦ä¸¤ä¸ªå­—èŠ‚)çš„å­—ç¬¦ã€‚ç¼–ç æ ‡å¿—å°†æŒ‡ç¤ºä½¿ç”¨å“ªç§ç¼–ç ã€‚</p>
<p>æ€»ç»“ï¼šStringç”±char[]+UTF-16æ”¹ä¸ºbyte[]+encoding-flagï¼ŒèŠ‚çº¦äº†ä¸€äº›ç©ºé—´ã€‚</p>
<blockquote>
<p>ğŸ”˜ ä¸å¯å˜æ€§</p>
</blockquote>
<ul>
<li>å½“å¯¹å­—ç¬¦ä¸²é‡æ–°èµ‹å€¼æ—¶ï¼Œéœ€è¦é‡å†™æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚</li>
<li>å½“å¯¹ç°æœ‰çš„å­—ç¬¦ä¸²è¿›è¡Œè¿æ¥æ“ä½œæ—¶ï¼Œä¹Ÿéœ€è¦é‡æ–°æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚</li>
<li>å½“è°ƒç”¨Stringçš„replace()æ–¹æ³•ä¿®æ”¹æŒ‡å®šå­—ç¬¦æˆ–å­—ç¬¦ä¸²æ—¶ï¼Œä¹Ÿéœ€è¦é‡æ–°æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚</li>
<li>é€šè¿‡å­—é¢é‡çš„æ–¹å¼ï¼ˆåŒºåˆ«äºnewï¼‰ç»™ä¸€ä¸ªå­—ç¬¦ä¸²èµ‹å€¼ï¼Œæ­¤æ—¶çš„å­—ç¬¦ä¸²å£°æ˜åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚</li>
</ul>
<blockquote>
<p>ğŸ‘â€ğŸ—¨ å­—ç¬¦ä¸²å¸¸é‡æ± </p>
</blockquote>
<p>å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯ä¸ä¼šå­˜å‚¨ç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²çš„ã€‚</p>
<ul>
<li>Stringçš„String Poolæ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„HashTableï¼Œé»˜è®¤å€¼å¤§å°é•¿åº¦æ˜¯1009ã€‚å¦‚æœæ”¾è¿›String Poolçš„Stringéå¸¸å¤šï¼Œå°±ä¼šé€ æˆHashå†²çªä¸¥é‡ï¼Œä»è€Œå¯¼è‡´é“¾è¡¨ä¼šå¾ˆé•¿ï¼Œè€Œé“¾è¡¨é•¿äº†åç›´æ¥ä¼šé€ æˆçš„å½±å“å°±æ˜¯å½“è°ƒç”¨String.internæ—¶æ€§èƒ½ä¼šå¤§å¹…ä¸‹é™ã€‚</li>
<li>ä½¿ç”¨-XX:StringTableSizeå¯è®¾ç½®StringTableçš„é•¿åº¦</li>
<li>åœ¨JDK6ä¸­StringTableæ˜¯å›ºå®šçš„ã€‚å°±æ˜¯1009çš„é•¿åº¦ï¼Œæ‰€ä»¥å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²è¿‡å¤šå°±ä¼šå¯¼è‡´æ•ˆç‡ä¸‹é™å¾ˆå¿«ã€‚StringTableSizeè®¾ç½®æ²¡æœ‰è¦æ±‚ã€‚</li>
<li>åœ¨JDK7ä¸­ï¼ŒStringTableçš„é•¿åº¦é»˜è®¤å€¼æ˜¯60013ã€‚</li>
<li>JDK8å¼€å§‹ï¼Œè®¾ç½®StringTableçš„é•¿åº¦çš„è¯ï¼Œ1009æ˜¯å¯è®¾ç½®çš„æœ€å°å€¼ã€‚</li>
</ul>
<h2 id="12-2-ğŸŒŒ-å†…å­˜åˆ†é…"><a href="#12-2-ğŸŒŒ-å†…å­˜åˆ†é…" class="headerlink" title="12.2 ğŸŒŒ å†…å­˜åˆ†é…"></a>12.2 ğŸŒŒ å†…å­˜åˆ†é…</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>åœ¨Javaè¯­è¨€ä¸­æœ‰8ä¸­åŸºæœ¬æ•°æ®ç±»å‹å’Œä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹Stringã€‚è¿™äº›ç±»å‹ä¸ºäº†ä½¿å®ƒä»¬åœ¨è¿è¡Œè¿‡ç¨‹ä¸­é€Ÿåº¦æ›´å¿«ã€æ›´èŠ‚çœå†…å­˜ï¼Œéƒ½æä¾›äº†ä¸€ç§å¸¸é‡æ± çš„æ¦‚å¿µã€‚</li>
<li>å¸¸é‡æ± å°±ç±»ä¼¼ä¸€ä¸ªJavaç³»ç»Ÿçº§åˆ«æä¾›çš„ç¼“å­˜ã€‚8ç§åŸºæœ¬æ•°æ®ç±»å‹çš„å¸¸é‡æ± éƒ½æ˜¯ç³»ç»Ÿåè°ƒçš„ï¼ŒStringç±»å‹çš„å¸¸é‡æ± æ¯”è¾ƒç‰¹æ®Šã€‚å®ƒçš„ä¸»è¦ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯ä½¿ç”¨<strong>å­—é¢é‡å£°æ˜</strong>ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨<strong>String.intern()æ–¹æ³•</strong>ã€‚</li>
<li>åœ¨JDK6åŠä»¥å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ°¸ä¹…ä»£(PermGen)ã€‚</li>
<li>Java7ä¸­Oracleçš„å·¥ç¨‹å¸ˆå¯¹å­—ç¬¦ä¸²æ± çš„é€»è¾‘åšäº†å¾ˆå¤šçš„æ”¹å˜ï¼Œå³å°†å­—ç¬¦ä¸²å¸¸é‡æ± çš„ä½ç½®è°ƒæ•´åˆ°Javaå †å†…ã€‚<ul>
<li>æ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½ä¿å­˜åœ¨å †ï¼ˆHeapï¼‰ä¸­ï¼Œå’Œå…¶ä»–æ™®é€šå¯¹è±¡ä¸€æ ·ï¼Œè¿™æ ·å¯ä»¥è®©ä½ åœ¨è¿›è¡Œè°ƒä¼˜åº”ç”¨æ—¶ä»…éœ€è¦è°ƒæ•´å †å¤§å°å°±å¯ä»¥äº†ã€‚</li>
<li>å­—ç¬¦ä¸²å¸¸é‡æ± æ¦‚å¿µåŸæœ¬ä½¿ç”¨å¾—æ¯”è¾ƒå¤šï¼Œä½†æ˜¯è¿™ä¸ªæ”¹åŠ¨ä½¿å¾—æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„ç†ç”±è®©æˆ‘ä»¬é‡æ–°è€ƒè™‘åœ¨Java 7ä¸­ä½¿ç”¨String.intern()ã€‚</li>
</ul>
</li>
<li>Java8å…ƒç©ºé—´ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± åœ¨å †ã€‚</li>
</ul>
<blockquote>
<p>â” StringTableè°ƒæ•´å†…å­˜ä½ç½®çš„åŸå› </p>
</blockquote>
<ul>
<li>PermSizeé»˜è®¤æ¯”è¾ƒå°</li>
<li>æ°¸ä¹…ä»£åƒåœ¾å›æ”¶é¢‘ç‡ä½</li>
</ul>
<h2 id="12-3-ğŸ› ï¸-å­—ç¬¦ä¸²æ“ä½œ"><a href="#12-3-ğŸ› ï¸-å­—ç¬¦ä¸²æ“ä½œ" class="headerlink" title="12.3 ğŸ› ï¸ å­—ç¬¦ä¸²æ“ä½œ"></a>12.3 ğŸ› ï¸ å­—ç¬¦ä¸²æ“ä½œ</h2><blockquote>
<p>ğŸ—ï¸ å­—ç¬¦ä¸²æ‹¼æ¥</p>
</blockquote>
<ul>
<li>å¸¸é‡ä¸å¸¸é‡çš„æ‹¼æ¥ç»“æœåœ¨å¸¸é‡æ± ï¼Œå¸¸é‡æ‹¼æ¥çš„åŸç†æ˜¯ç¼–è¯‘æœŸä¼˜åŒ–ã€‚</li>
<li>å¸¸é‡æ± ä¸­ä¸ä¼šå­˜åœ¨ç›¸åŒå†…å®¹çš„å¸¸é‡ã€‚</li>
<li>åªè¦æœ‰ä¸€ä¸ªæ˜¯å˜é‡ï¼Œç»“æœå°±åœ¨å †ä¸­ã€‚å˜é‡æ‹¼æ¥çš„åŸç†æ˜¯StringBuilderã€‚</li>
<li>å¦‚æœæ‹¼æ¥çš„ç»“æœæ˜¯è°ƒç”¨intern()æ–¹æ³•ï¼Œåˆ™ä¸»åŠ¨å°†å¸¸é‡æ± ä¸­è¿˜æ²¡æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥æ± ä¸­ï¼Œå¹¶è¿”å›æ­¤å¯¹è±¡åœ°å€ã€‚</li>
</ul>
<blockquote>
<p>ğŸ” æŸ¥çœ‹åº•å±‚</p>
</blockquote>
<p>Javaä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String s1 = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    String s2 = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    String s3 = <span class="string">&quot;ab&quot;</span>;             <span class="comment">// å­—ç¬¦ä¸²å¸¸é‡æ± </span></span><br><span class="line">    String s4 = s1 + s2;          <span class="comment">// å †ç©ºé—´</span></span><br><span class="line">    System.out.println(s3 == s4); <span class="comment">// false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åç¼–è¯‘ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> 0 ldc #3 &lt;a&gt;  &#x2F;&#x2F; å°†aä»è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å‹å…¥æ“ä½œæ•°æ ˆ</span><br><span class="line"> 2 astore_1    &#x2F;&#x2F; å°†aå­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®</span><br><span class="line"> 3 ldc #17 &lt;b&gt; &#x2F;&#x2F; å°†bä»è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å‹å…¥æ“ä½œæ•°æ ˆ</span><br><span class="line"> 5 astore_2    &#x2F;&#x2F; å°†bå­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½®</span><br><span class="line"> 6 ldc #18 &lt;ab&gt;&#x2F;&#x2F; å°†abä»è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å‹å…¥æ“ä½œæ•°æ ˆ</span><br><span class="line"> 8 astore_3    &#x2F;&#x2F; å°†abå­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º3çš„ä½ç½®</span><br><span class="line"> 9 new #19 &lt;java&#x2F;lang&#x2F;StringBuilder&gt; &#x2F;&#x2F; newä¸€ä¸ªStringBuilder</span><br><span class="line">12 dup         &#x2F;&#x2F; å¤åˆ¶æ“ä½œæ“ä½œæ•°æ ˆé¡¶çš„StringBuilderçš„å¼•ç”¨</span><br><span class="line">13 invokespecial #20 &lt;java&#x2F;lang&#x2F;StringBuilder.&lt;init&gt;&gt; &#x2F;&#x2F; è°ƒç”¨StringBuilderçš„åˆå§‹åŒ–æ–¹æ³•</span><br><span class="line">16 aload_1     &#x2F;&#x2F; ä»å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®è£…è½½ä¸€ä¸ªå¯¹è±¡å¼•ç”¨(a)åˆ°æ“ä½œæ•°æ ˆé¡¶</span><br><span class="line">17 invokevirtual #21 &lt;java&#x2F;lang&#x2F;StringBuilder.append&gt; &#x2F;&#x2F; è°ƒç”¨StringBuilderçš„appendæ–¹æ³•ï¼Œè¿æ¥a</span><br><span class="line">20 aload_2     &#x2F;&#x2F; ä»å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½®è£…è½½ä¸€ä¸ªå¯¹è±¡å¼•ç”¨(b)åˆ°æ“ä½œæ•°æ ˆé¡¶</span><br><span class="line">21 invokevirtual #21 &lt;java&#x2F;lang&#x2F;StringBuilder.append&gt; &#x2F;&#x2F; è°ƒç”¨StringBuilderçš„appendæ–¹æ³•ï¼Œè¿æ¥b</span><br><span class="line">24 invokevirtual #22 &lt;java&#x2F;lang&#x2F;StringBuilder.toString&gt; &#x2F;&#x2F; è°ƒç”¨StringBuilderçš„toStringæ–¹æ³•ï¼Œå°†è¯¥å­—ç¬¦ä¸²æ”¾åœ¨å †ä¸­ï¼Œå¼•ç”¨æ”¾åœ¨æ“ä½œæ•°æ ˆä¸­</span><br><span class="line">27 astore 4    &#x2F;&#x2F; å°†abå­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º4çš„ä½ç½®</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>å­—ç¬¦ä¸²æ‹¼æ¥ï¼ŒJDK5.0ä¹‹å‰ä½¿ç”¨çš„æ˜¯StringBufferï¼ŒJDK5.0ä¹‹åä½¿ç”¨çš„æ˜¯StringBuilderã€‚</p>
<p>å…³é”®å°±åœ¨äº<code>toString()</code>æ–¹æ³•ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æºä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// StringBuilder</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Create a copy, don&#x27;t share the array</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(value, <span class="number">0</span>, count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StringBuffer</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (toStringCache == <span class="keyword">null</span>) &#123;</span><br><span class="line">        toStringCache = Arrays.copyOfRange(value, <span class="number">0</span>, count);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(toStringCache, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªæ–¹æ³•ä¸­å‡é‡‡ç”¨äº†<code>new String()</code>çš„æ–¹æ³•ã€‚å› æ­¤å¯¹äºéå­—é¢é‡çš„æ‹¼æ¥æ“ä½œï¼Œéƒ½åœ¨å †ä¸­newäº†ä¸€ä¸ªStringå¯¹è±¡ã€‚</p>
<blockquote>
<p>âŒ¨ï¸ ==æµ‹è¯•</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String s1 = <span class="string">&quot;a&quot;</span> + <span class="string">&quot;b&quot;</span> + <span class="string">&quot;c&quot;</span>;         <span class="comment">// ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œæ‹¼æ¥ç»“æœå­˜æ”¾åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­</span></span><br><span class="line">    String s2 = <span class="string">&quot;abc&quot;</span>;                   <span class="comment">// å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä¸å­˜æ”¾ç›¸åŒçš„å­—ç¬¦ä¸²</span></span><br><span class="line">    System.out.println(s1 ==s2);         <span class="comment">// true</span></span><br><span class="line">    System.out.println(s1.equals(s2));   <span class="comment">// true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String s1 = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    String s2 = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    String s3 = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">    String s4 = s1 + s2;</span><br><span class="line">    System.out.println(s3 == s4);        <span class="comment">// false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test6</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String s1 = <span class="string">&quot;boot&quot;</span>;</span><br><span class="line">    String s2 = <span class="string">&quot;cloud&quot;</span>;</span><br><span class="line">    String s3 = <span class="string">&quot;boot&quot;</span> + <span class="string">&quot;cloud&quot;</span>;        <span class="comment">// å­—ç¬¦ä¸²æ‹¼æ¥ç»“æœæ”¾åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­</span></span><br><span class="line">    String s4 = s1 + <span class="string">&quot;cloud&quot;</span>;            <span class="comment">// å¸¦å˜é‡çš„æ‹¼æ¥ç»“æœæ”¾åœ¨å †ä¸­</span></span><br><span class="line">    String s5 = <span class="string">&quot;boot&quot;</span> + s2;             <span class="comment">// å¸¦å˜é‡çš„æ‹¼æ¥ç»“æœæ”¾åœ¨å †ä¸­</span></span><br><span class="line">    String s6 = s1 + s2;                 <span class="comment">// å¸¦å˜é‡çš„æ‹¼æ¥ç»“æœæ”¾åœ¨å †ä¸­</span></span><br><span class="line">    System.out.println(s3 == s4);        <span class="comment">// flase</span></span><br><span class="line">    System.out.println(s3 == s5);        <span class="comment">// flase</span></span><br><span class="line">    System.out.println(s3 == s6);        <span class="comment">// flase</span></span><br><span class="line">    System.out.println(s4 == s5);        <span class="comment">// flase</span></span><br><span class="line">    <span class="comment">// intern(): åˆ¤æ–­å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯å¦å­˜åœ¨&quot;bootcloud&quot;å€¼</span></span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­&quot;bootcloud&quot;çš„åœ°å€ï¼›</span></span><br><span class="line">    <span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ·»åŠ ä¸€æ¬¡&quot;bootcloud&quot;ï¼Œå¹¶è¿”å›æ­¤å¯¹è±¡çš„åœ°å€</span></span><br><span class="line">    String s7 = s5.intern();</span><br><span class="line">    System.out.println(s3 == s7);        <span class="comment">// true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test7</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String s1 = <span class="string">&quot;c&quot;</span>;               <span class="comment">// å¸¸é‡</span></span><br><span class="line">    <span class="keyword">final</span> String s2 = <span class="string">&quot;d&quot;</span>;               <span class="comment">// å¸¸é‡</span></span><br><span class="line">    String s3 = <span class="string">&quot;cd&quot;</span>; </span><br><span class="line">    String s4 = s1 + s2;                 <span class="comment">// æ‹¼æ¥ç¬¦åˆå·¦å³ä¸¤è¾¹éƒ½æ˜¯å­—ç¬¦ä¸²å¸¸é‡æˆ–è€…å¸¸é‡å¼•ç”¨ï¼Œä»ç„¶ä½¿ç”¨ç¼–è¯‘æœŸä¼˜åŒ–</span></span><br><span class="line">    System.out.println(s3 == s4);        <span class="comment">// true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>âŒ¨ï¸ æ•ˆç‡æµ‹è¯•</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringAppendTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            str = str + <span class="string">&quot;k&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;Stringæ‹¼æ¥èŠ±è´¹æ—¶é—´ï¼š&quot;</span> + (end - start) + <span class="string">&quot;ms&quot;</span>); <span class="comment">// 3935ms</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="number">100000</span>);</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;k&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;StringBuilderæ‹¼æ¥èŠ±è´¹æ—¶é—´ï¼š&quot;</span> + (end - start) + <span class="string">&quot;ms&quot;</span>); <span class="comment">// 3ms</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ•ˆç‡ï¼š</p>
<p>StringBuilderçš„appendAPI &gt;&gt; Stringçš„å­—ç¬¦ä¸²æ‹¼æ¥ </p>
<p>åŸå› ï¼š</p>
<p>(1) StringBuilderæ–¹å¼è‡ªå§‹è‡³ç»ˆåªåˆ›å»ºä¸€ä¸ªStringBuilderå¯¹è±¡ï¼ŒStringæ‹¼æ¥ä¼šåˆ›å»ºå¤šä¸ªStringBuilderå¯¹è±¡ã€‚</p>
<p>(2) ä½¿ç”¨Stringå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå†…å­˜ä¸­ç”±äºåˆ›å»ºäº†å¤šä¸ªStringBuilderå’ŒStringå¯¹è±¡,ä¼šå¢åŠ GCçš„é¢‘ç‡ï¼Œå½±å“æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p>æ”¹è¿›ï¼š</p>
<p>StringBuilderæ— å‚åˆ›å»ºçš„æ•°ç»„ç©ºé—´æ˜¯16ï¼Œå¦‚æœå®é™…å¼€å‘ä¸­é•¿åº¦å¤§äº16ï¼Œåˆ™éœ€è¦ä¸æ–­è¿›è¡Œæ•°ç»„æ‰©å®¹ã€‚</p>
<p>å¦‚æœæ˜ç¡®æ‹¼æ¥åçš„å­—ç¬¦ä¸²é•¿åº¦ä¸é«˜äºæŸä¸ªé™å®šå€¼highLevelï¼Œåœ¨å®šä¹‰StringBuilderçš„æ—¶å€™å³å¯èµ‹äºˆå“åº”ç©ºé—´ï¼Œå³<code>new StringBuilder[highLevel]</code>ã€‚</p>
<blockquote>
<p>ğŸ’¡ intern()æ–¹æ³•</p>
</blockquote>
<p>ç¾å›¢æŠ€æœ¯å›¢é˜Ÿæ²™é¾™-internï¼š<a href="https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html">https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html</a></p>
<p>internæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œè°ƒç”¨çš„æ˜¯åº•å±‚Cè¯­è¨€å®ç°çš„æ–¹æ³•ã€‚</p>
<p>JDK1.8çš„APIè¯´æ˜ï¼šå­—ç¬¦ä¸²æ± æœ€åˆæ˜¯ç©ºçš„ï¼Œç”±Stringç±»ç§æœ‰åœ°ç»´æŠ¤ã€‚åœ¨ç»´æŠ¤internæ–¹æ³•æ—¶ï¼Œå¦‚æœæ± ä¸­å·²ç»åŒ…å«äº†ç”±equals(object)æ–¹æ³•ç¡®å®šçš„ä¸è¯¥å­—ç¬¦ä¸²å¯¹è±¡ç›¸ç­‰çš„å­—ç¬¦ä¸²ï¼Œåˆ™è¿”å›æ± ä¸­çš„å­—ç¬¦ä¸²ã€‚å¦åˆ™ï¼Œè¯¥<strong>å­—ç¬¦ä¸²å¯¹è±¡</strong>å°†è¢«æ·»åŠ åˆ°æ± ä¸­ï¼Œå¹¶è¿”å›å¯¹è¯¥<strong>å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨</strong>ã€‚å¦‚æœä¸æ˜¯ç”¨åŒå¼•å·å£°æ˜çš„stringå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨stringæä¾›çš„internæ–¹æ³•ï¼šinternæ–¹æ³•ä¼šä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥è¯¢å½“å‰å­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å°±ä¼šå°†å½“å‰å­—ç¬¦ä¸²æ”¾å…¥å¸¸é‡æ± ä¸­ã€‚</p>
<p>åœ¨JDK1.6ä¸­ï¼ŒString.intern()æ–¹æ³•å°è¯•å°†å­—ç¬¦ä¸²æ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¼šæŠŠæ­¤å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œæ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¯¹è±¡åœ°å€ã€‚</p>
<p>è‡ªJDK1.7èµ·ï¼ŒString.intern()æ–¹æ³•å°è¯•å°†å­—ç¬¦ä¸²æ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¼šæŠŠæ­¤å¯¹è±¡çš„å¼•ç”¨åœ°å€å¤åˆ¶ä¸€ä»½ï¼Œæ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¼•ç”¨åœ°å€ã€‚</p>
<p>è‡³äºæ›´æ”¹åŸå› ï¼Œä¹Ÿä¸å¿…å¤šè¯´äº†ï¼Œä¹‹å‰æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡æ”¾åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œç°åœ¨æ˜¯å­˜æ”¾ä¸€ä¸ªå †ç©ºé—´ä¸­çš„å¼•ç”¨ï¼Œå½“ç„¶æ›´åŠ èŠ‚çœç©ºé—´ã€‚</p>
<p>å¯¹äºéœ€è¦å¤§é‡ä½¿ç”¨ç›¸åŒå­—ç¬¦ä¸²çš„ç½‘ç«™å¹³å°ï¼Œå»ºè®®ä½¿ç”¨internä¿å­˜åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œä»¥èŠ‚çœå†…å­˜ç©ºé—´ã€‚</p>
<h2 id="12-4-â“-é¢è¯•é¢˜"><a href="#12-4-â“-é¢è¯•é¢˜" class="headerlink" title="12.4 â“ é¢è¯•é¢˜"></a>12.4 â“ é¢è¯•é¢˜</h2><blockquote>
<p>1ï¸âƒ£ new String(â€œabâ€) ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿ</p>
<p>new String(â€œaâ€) + new String(â€œbâ€)ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿ</p>
</blockquote>
<p>å‰è€…åˆ›å»ºäº†ä¸¤ä¸ªå¯¹è±¡ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªæ˜¯new å…³é”®å­—åœ¨å †ç©ºé—´åˆ›å»ºçš„å¯¹è±¡</li>
<li>ç¬¬äºŒä¸ªæ˜¯åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºçš„å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼ˆæŒ‡å‘å †ç©ºé—´çš„åœ°å€ï¼‰</li>
</ul>
<p>åè€…åˆ›å»ºäº†å…­ä¸ªå¯¹è±¡ï¼š</p>
<ul>
<li>å¯¹è±¡1ï¼šnew StringBuilder()</li>
<li>å¯¹è±¡2ï¼šnew String(â€œaâ€)</li>
<li>å¯¹è±¡3ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­açš„å¼•ç”¨</li>
<li>å¯¹è±¡4ï¼šnew String(â€œbâ€)</li>
<li>å¯¹è±¡5ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­bçš„å¼•ç”¨</li>
<li>æ·±å…¥å‰–æ<ul>
<li>å¯¹è±¡6ï¼šStringBuilderçš„toStringæ–¹æ³•ä¸­åˆ›å»ºçš„new String(â€œabâ€)</li>
<li>æ³¨æ„ï¼ŒtoStringæ–¹æ³•çš„è°ƒç”¨æ²¡æœ‰åœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆå­—ç¬¦ä¸²çš„å¼•ç”¨</li>
</ul>
</li>
</ul>
<blockquote>
<p>2ï¸âƒ£ ä¸‹åˆ—ä»£ç çš„æ‰§è¡Œç»“æœæ˜¯ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringInternTest</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">     String s1 = <span class="keyword">new</span> String(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">     s1.intern(); </span><br><span class="line">     String s2 = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">     System.out.println(s1 == s2); </span><br><span class="line"></span><br><span class="line">     String s3 = <span class="keyword">new</span> String(<span class="string">&quot;1&quot;</span>) + <span class="keyword">new</span> String(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">     s3.intern();</span><br><span class="line">     String s4 = <span class="string">&quot;11&quot;</span>;</span><br><span class="line">     System.out.println(s3 == s4); </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>ç»“æœï¼š</p>
<ul>
<li>JDK6: false false</li>
<li>JDK7/8: false true</li>
</ul>
<p>è§£æï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String s1 = <span class="keyword">new</span> String(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="comment">// s1æ˜¯å †ç©ºé—´ä¸­åˆ›å»ºçš„&quot;1&quot;çš„åœ°å€</span></span><br><span class="line">s1.intern();</span><br><span class="line"><span class="comment">// è°ƒç”¨æ­¤æ–¹æ³•ä¹‹å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å·²ç»å­˜åœ¨äº†&quot;1&quot;</span></span><br><span class="line">String s2 = <span class="string">&quot;1&quot;</span>;</span><br><span class="line"><span class="comment">// s2æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­&quot;1&quot;çš„åœ°å€</span></span><br><span class="line">System.out.println(s1 == s2);</span><br><span class="line"><span class="comment">// JDK1.6: false; JDK1.7/1.8: false</span></span><br><span class="line"></span><br><span class="line">String s3 = <span class="keyword">new</span> String(<span class="string">&quot;1&quot;</span>) + <span class="keyword">new</span> String(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="comment">// s3æ˜¯StringBuilderçš„toStringæ–¹æ³•new String(&quot;11&quot;)åœ¨å †ç©ºé—´ä¸­çš„åœ°å€ï¼Œ</span></span><br><span class="line"><span class="comment">// ä½†æ˜¯toStringçš„new Stringå¹¶æ²¡æœ‰æŠŠ&quot;11&quot;æ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± </span></span><br><span class="line">s3.intern();</span><br><span class="line"><span class="comment">// jdk1.6ä¼šå¤åˆ¶ä¸€ä¸ªå †ç©ºé—´ä¸­çš„&quot;11&quot;å¯¹è±¡ï¼Œå³åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œæ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆå…¨æ–°åœ°å€ï¼‰</span></span><br><span class="line"><span class="comment">// jdk1.7/1.8ä¼šå¤åˆ¶ä¸€ä¸ªå †ç©ºé—´ä¸­çš„&quot;11&quot;å¯¹è±¡çš„å¼•ç”¨åœ°å€ï¼Œæ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆå¼•ç”¨åœ°å€ï¼‰</span></span><br><span class="line">String s4 = <span class="string">&quot;11&quot;</span>;</span><br><span class="line"><span class="comment">// s4æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­&quot;11&quot;çš„å¯¹è±¡åœ°å€</span></span><br><span class="line">System.out.println(s3 == s4);</span><br><span class="line"><span class="comment">// JDK1.6: false; JDK1.7/1.8: true</span></span><br></pre></td></tr></table></figure>



<h2 id="12-5-â™»-StringTableåƒåœ¾å›æ”¶"><a href="#12-5-â™»-StringTableåƒåœ¾å›æ”¶" class="headerlink" title="12.5 â™» StringTableåƒåœ¾å›æ”¶"></a>12.5 â™» StringTableåƒåœ¾å›æ”¶</h2><blockquote>
<p>âš™ï¸ å¯åŠ¨æ‰“å°åƒåœ¾å›æ”¶æ—¥å¿—</p>
</blockquote>
<ul>
<li>-XX:+PrintStringTableStatisticsï¼šæ‰“å°å­—ç¬¦ä¸²å¸¸é‡æ± ç»Ÿè®¡ä¿¡æ¯</li>
<li>-XX:+PrintGCDetailsï¼šæ‰“å°GCæ—¥å¿—è¯¦æƒ…</li>
</ul>
<blockquote>
<p>âš™ï¸ G1çš„Stringå»é‡æ“ä½œ</p>
</blockquote>
<ul>
<li>UseStringDeduplication(bool)ï¼šå¼€å¯Stringå»é‡ï¼ˆé»˜è®¤ä¸å¼€å¯ï¼‰</li>
<li>PrintStringDeduplicationStatistics(bool)ï¼šæ‰“å°è¯¦ç»†çš„å»é‡å¹´é¾„ç»Ÿè®¡ä¿¡æ¯</li>
<li>StringDeduplicationAgeThreshold(utinx)ï¼šè¾¾åˆ°å¹´é¾„çš„Stringå¯¹è±¡è¢«è®¤ä¸ºæ˜¯å»é‡çš„å€™é€‰å¯¹è±¡</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-2(ç±»åŠ è½½å­ç³»ç»Ÿ)</title>
    <url>/posts/22607/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="2-1-ğŸ““ç±»åŠ è½½å­ç³»ç»Ÿ"><a href="#2-1-ğŸ““ç±»åŠ è½½å­ç³»ç»Ÿ" class="headerlink" title="2.1 ğŸ““ç±»åŠ è½½å­ç³»ç»Ÿ"></a>2.1 ğŸ““ç±»åŠ è½½å­ç³»ç»Ÿ</h2><blockquote>
<p>ğŸ“· ç±»åŠ è½½å­ç³»ç»Ÿå›¾ç¤º</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/22607/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AD%90%E7%B3%BB%E7%BB%9F.svg" class="" title="ç±»åŠ è½½å­ç³»ç»Ÿ"><br />



<blockquote>
<p>ğŸ”¨ ç±»åŠ è½½å­ç³»ç»Ÿä½œç”¨</p>
</blockquote>
<ul>
<li>ç±»åŠ è½½å­ç³»ç»Ÿè´Ÿè´£ä»æ–‡ä»¶ç³»ç»Ÿæˆ–è€…ç½‘ç»œä¸­åŠ è½½classæ–‡ä»¶ï¼Œclassæ–‡ä»¶åœ¨æ–‡ä»¶å¼€å¤´æœ‰ç‰¹å®šçš„æ–‡ä»¶æ ‡è¯†ã€‚</li>
<li>ClassLoaderåªè´Ÿè´£classæ–‡ä»¶çš„åŠ è½½ï¼Œè‡³äºå®ƒæ˜¯å¦å¯ä»¥è¿è¡Œï¼Œåˆ™ç”±Execution Engine(æ‰§è¡Œå¼•æ“)å†³å®šã€‚</li>
<li>åŠ è½½çš„ç±»ä¿¡æ¯å­˜æ”¾äºä¸€å—ç§°ä¸ºæ–¹æ³•åŒºçš„å†…å­˜ç©ºé—´ã€‚é™¤äº†ç±»çš„ä¿¡æ¯ä»¥å¤–ï¼Œæ–¹æ³•åŒºä¸­è¿˜ä¼šæœ‰å­˜æ”¾è¿è¡Œæ—¶å¸¸é‡æ± ä¿¡æ¯ï¼Œå¯èƒ½è¿˜åŒ…æ‹¬å­—ç¬¦ä¸²é¢é‡å’Œæ•°å­—å¸¸é‡ã€‚</li>
</ul>
<h2 id="2-2-ğŸš€ç±»çš„åŠ è½½è¿‡ç¨‹"><a href="#2-2-ğŸš€ç±»çš„åŠ è½½è¿‡ç¨‹" class="headerlink" title="2.2 ğŸš€ç±»çš„åŠ è½½è¿‡ç¨‹"></a>2.2 ğŸš€ç±»çš„åŠ è½½è¿‡ç¨‹</h2><blockquote>
<p>ğŸ“„ ç±»çš„åŠ è½½å™¨-ClassLoader</p>
</blockquote>
<ol>
<li>class fileå­˜åœ¨äºæœ¬åœ°ç¡¬ç›˜ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºè®¾è®¡å¸ˆç”»åœ¨çº¸ä¸Šçš„æ¨¡æ¿ï¼Œè€Œæœ€ç»ˆè¿™ä¸ªæ¨¡æ¿åœ¨æ‰§è¡Œçš„æ—¶å€™æ˜¯è¦åŠ è½½åˆ°JVMå½“ä¸­æ¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶å®ä¾‹åŒ–å‡ºnä¸ªä¸€æ¨¡ä¸€æ ·çš„å®ä¾‹ã€‚</li>
<li>class fileåŠ è½½åˆ°JVMä¸­ï¼Œè¢«ç§°ä¸ºDNAå…ƒæ•°æ®æ¨¡æ¿ï¼Œæ”¾åœ¨æ–¹æ³•åŒºã€‚</li>
<li>åœ¨.classæ–‡ä»¶ -&gt; JVM -&gt; æœ€ç»ˆæˆä¸ºå…ƒæ•°æ®æ¨¡æ¿ï¼Œæ­¤è¿‡ç¨‹å°±è¦ä¸€ä¸ªè¿è¾“å·¥å…·(ç±»è£…è½½å™¨ClassLoader)ï¼Œæ‰®æ¼”ä¸€ä¸ªå¿«é€’å‘˜çš„è§’è‰²ã€‚</li>
</ol>
<blockquote>
<p>â° ç±»çš„åŠ è½½è¿‡ç¨‹</p>
</blockquote>
<div class="mermaid">graph LR
A(å¼€å§‹)
B{è£…è½½ç±»}
C{é“¾æ¥}
D[åˆå§‹åŒ–]
E[è°ƒç”¨main]
F(ç»“æŸ)
G{ClassLoaderè£…è½½é¡ºåˆ©}
H[è¾“å‡ºå¼‚å¸¸]
A --&gt; B
B --&gt; |Yes| C
C --&gt; D
D --&gt; E
E --&gt; F
B --&gt; |No| G
G --&gt; |Yes| C
G --&gt; |No| H</div>

<ol>
<li>åŠ è½½<ol>
<li>é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµã€‚</li>
<li>å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ã€‚</li>
<li>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚</li>
</ol>
</li>
<li>é“¾æ¥<ol>
<li>éªŒè¯<ul>
<li> ç›®çš„åœ¨äºç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºè¦æ±‚ï¼Œä¿è¯è¢«åŠ è½½ç±»çš„æ­£ç¡®æ€§ï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨ã€‚</li>
<li> ä¸»è¦åŒ…æ‹¬å››ç§éªŒè¯ï¼šæ–‡ä»¶æ ¼å¼éªŒè¯ï¼Œå…ƒæ•°æ®éªŒè¯ï¼Œå­—èŠ‚ç éªŒè¯ï¼Œç¬¦å·å¼•ç”¨éªŒè¯ã€‚</li>
</ul>
</li>
<li>å‡†å¤‡<ul>
<li>ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶ä¸”è®¾ç½®è¯¥ç±»å˜é‡çš„é»˜è®¤åˆå§‹å€¼ï¼Œå³é›¶å€¼ã€‚</li>
<li>è¿™é‡Œä¸åŒ…å«ç”¨finalä¿®é¥°çš„staticï¼Œå› ä¸ºfinalåœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šåˆ†é…äº†ï¼Œå‡†å¤‡é˜¶æ®µä¼šæ˜¾å¼åˆå§‹åŒ–ã€‚</li>
<li>è¿™é‡Œä¸ä¼šä¸ºå®ä¾‹å˜é‡åˆ†é…åˆå§‹åŒ–ï¼Œç±»å˜é‡ä¼šåˆ†é…åœ¨æ–¹æ³•åŒºä¸­ï¼Œè€Œå®ä¾‹å˜é‡æ˜¯ä¼šéšç€å¯¹è±¡ä¸€èµ·åˆ†é…åˆ°Javaå †ä¸­ã€‚</li>
</ul>
</li>
<li>è§£æ<ul>
<li>å°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚</li>
<li>äº‹å®ä¸Šï¼Œè§£ææ“ä½œå¾€å¾€ä¼šä¼´éšç€JVMåœ¨æ‰§è¡Œå®Œåˆå§‹åŒ–ä¹‹åå†æ‰§è¡Œã€‚</li>
<li>ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ã€‚ç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒçš„Classæ–‡ä»¶æ ¼å¼ä¸­ã€‚ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚</li>
<li>è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ç­‰ã€‚å¯¹åº”å¸¸é‡æ± ä¸­çš„CONSTANT_Class_infoã€CONSTANT_Filedref_infoã€CONSTANT_Methodref_infoç­‰ã€‚</li>
</ul>
</li>
</ol>
</li>
<li>åˆå§‹åŒ–<ul>
<li>åˆå§‹åŒ–é˜¶æ®µå°±æ˜¯æ‰§è¡Œç±»æ„é€ å™¨æ–¹æ³•clinit()çš„è¿‡ç¨‹ã€‚</li>
<li>æ­¤æ–¹æ³•ä¸éœ€è¦å®šä¹‰ï¼Œæ˜¯javacç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ä¸­çš„è¯­å¥åˆå¹¶è€Œæ¥ã€‚</li>
<li>æ„é€ å™¨æ–¹æ³•ä¸­æŒ‡ä»¤æŒ‰è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œã€‚</li>
<li>clinit()ä¸åŒäºç±»çš„æ„é€ å™¨ã€‚(æ„é€ å™¨æ˜¯è™šæ‹Ÿæœºè§†è§’ä¸‹çš„init())ã€‚</li>
<li>è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼ŒJVMä¼šä¿è¯å­ç±»çš„clinit()æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„clinit()å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚</li>
<li>è™šæ‹Ÿæœºå¿…é¡»ä¿è¯ä¸€ä¸ªç±»çš„clinit()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”ã€‚</li>
</ul>
</li>
</ol>
<h2 id="2-3-ğŸ“‘ç±»åŠ è½½å™¨è¯¦è§£"><a href="#2-3-ğŸ“‘ç±»åŠ è½½å™¨è¯¦è§£" class="headerlink" title="2.3 ğŸ“‘ç±»åŠ è½½å™¨è¯¦è§£"></a>2.3 ğŸ“‘ç±»åŠ è½½å™¨è¯¦è§£</h2><blockquote>
<p>â¬ ç±»åŠ è½½å™¨çš„åˆ†ç±»</p>
</blockquote>
<ul>
<li>JVMæ”¯æŒä¸¤ç§ç±»å‹çš„ç±»åŠ è½½å™¨ï¼Œåˆ†åˆ«ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨(BootStrap ClassLoader)å’Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨(User-Defined ClassLoader)ã€‚</li>
<li>ä»æ¦‚å¿µä¸Šæ¥è®²ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬æŒ‡çš„æ˜¯ç¨‹åºä¸­ç”±å¼€å‘äººå‘˜è‡ªå®šä¹‰çš„ä¸€ç±»ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒå´æ²¡æœ‰è¿™ä¹ˆå®šä¹‰ï¼Œè€Œæ˜¯å°†æ‰€æœ‰æ´¾ç”ŸäºæŠ½è±¡ç±»ClassLoaderçš„ç±»åŠ è½½å™¨éƒ½åˆ’åˆ†ä¸ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚</li>
<li>æ— è®ºç±»åŠ è½½å™¨çš„ç±»å‹å¦‚ä½•åˆ’åˆ†ï¼Œåœ¨ç¨‹åºä¸­æœ€å¸¸è§çš„ç±»åŠ è½½å™¨å§‹ç»ˆåªæœ‰3ä¸ªï¼Œå¦‚ä¸‹æ‰€ç¤º</li>
</ul>
<div class="mermaid">graph TD
A[...]
B[...]
C[User Defined Class Loader]
D[User Defined Class Loader]
E[User Defined Class Loader]
F[User Defined Class Loader]
G[System Class Loader]
H[Extension Class Loader]
I[Bootstrap Class Loader]
A --&gt; C 
C --&gt; E
B --&gt; D
D --&gt; F
E --&gt; G
F --&gt; G
G --&gt; H
H --&gt; I</div>



<blockquote>
<p>âš¡ï¸ å…³äºClassLoader </p>
</blockquote>
<p>ClassLoaderç±»ï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶åæ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½ç»§æ‰¿è‡ªClassLoaderã€‚</p>
<div class="mermaid">classDiagram
ExtClassLoader --&gt; URLClassLoader
AppClassLoader --&gt; URLClassLoader
AppClassLoader : loadClass(String, booean)
URLClassLoader --&gt; SecureClassLoader
URLClassLoader : findClass(String)
SecureClassLoader --&gt; abstract ClassLoader
abstract ClassLoader : loadClass(String)
abstract ClassLoader : resolveClass(Class&lt;?&gt;)
abstract ClassLoader : findClass(String)
abstract ClassLoader : defineClass(byte[], int, int)</div>


<p>ClassLoaderçš„å¸¸ç”¨æ–¹æ³•</p>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">getParent()</td>
<td align="center">è¿”å›è¯¥ç±»åŠ è½½å™¨çš„è¶…ç±»åŠ è½½å™¨</td>
</tr>
<tr>
<td align="center">loadClass(String name)</td>
<td align="center">åŠ è½½åç§°ä¸ºnameçš„ç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹</td>
</tr>
<tr>
<td align="center">findClass(String name)</td>
<td align="center">æŸ¥æ‰¾åç§°ä¸ºnameçš„ç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹</td>
</tr>
<tr>
<td align="center">findLoadedClass(String name)</td>
<td align="center">æŸ¥æ‰¾åç§°ä¸ºnameçš„å·²ç»è¢«åŠ è½½è¿‡çš„ç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹</td>
</tr>
<tr>
<td align="center">defineClass(String name, byte[] b, int off, int len)</td>
<td align="center">æŠŠå­—èŠ‚æ•°ç»„bä¸­çš„å†…å®¹è½¬æ¢ä¸ºä¸€ä¸ªJavaç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹</td>
</tr>
<tr>
<td align="center">resloveClass(Class&lt;?&gt; c)</td>
<td align="center">è¿æ¥æŒ‡å®šçš„ä¸€ä¸ªJavaç±»</td>
</tr>
</tbody></table>
<p>è·å–ClassLoaderçš„é€”å¾„</p>
<table>
<thead>
<tr>
<th align="center">æè¿°</th>
<th align="center">æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td align="center">è·å–å½“å‰ç±»çš„ClassLoader</td>
<td align="center">clazz.getClassLoader()</td>
</tr>
<tr>
<td align="center">è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ClassLoader</td>
<td align="center">Thread.currentThread().getContextLoader()</td>
</tr>
<tr>
<td align="center">è·å–ç³»ç»Ÿçš„ClassLoader</td>
<td align="center">ClassLoader.getSystemClassLoader()</td>
</tr>
<tr>
<td align="center">è·å–è°ƒç”¨è€…çš„ClassLoader</td>
<td align="center">DriveManager.getCallerClassLoader()</td>
</tr>
</tbody></table>
<blockquote>
<p>ğŸ€ è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨</p>
</blockquote>
<ul>
<li>å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader)<ul>
<li>C/C++è¯­è¨€ç¼–å†™ï¼ŒåµŒå¥—åœ¨JVMå†…éƒ¨ï¼Œæ— æ³•è·å–</li>
<li>å®ƒç”¨æ¥åŠ è½½Javaçš„æ ¸å¿ƒåº“ï¼Œç”¨äºæä¾›JVMè‡ªèº«éœ€è¦çš„ç±»</li>
<li>å¹¶ä¸ç»§æ‰¿è‡ªjava.lang.Classoaderï¼Œæ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨</li>
<li>åŠ è½½æ‰©å±•ç±»å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå¹¶æŒ‡å®šä¸ºä»–ä»¬çš„çˆ¶ç±»åŠ è½½å™¨</li>
<li><strong>å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒBootStrapå¯åŠ¨ç±»åŠ è½½å™¨åªåŠ è½½åŒ…åä¸º<u>java</u>ã€<u>javax</u>ã€<u>sun</u>ç­‰å¼€å¤´çš„ç±»</strong></li>
</ul>
</li>
<li>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨(Application ClassLoader)<ul>
<li>Javaè¯­è¨€ç¼–å†™ï¼Œç”±sun.misc.Launcher$AppClassLoaderå®ç°</li>
<li>æ´¾ç”ŸäºClassLoaderç±»</li>
<li>çˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨</li>
<li>å®ƒè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡classpathæˆ–ç³»ç»Ÿå±æ€§java.class.pathæŒ‡å®šè·¯å¾„ä¸‹çš„ç±»åº“</li>
<li>è¯¥ç±»åŠ è½½æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒJavaåº”ç”¨çš„ç±»éƒ½æ˜¯ç”±å®ƒæ¥å®ŒæˆåŠ è½½</li>
<li>é€šè¿‡ClassLoader$getSystemClassLoader()æ–¹æ³•å¯ä»¥è·å–åˆ°è¯¥ç±»åŠ è½½å™¨</li>
</ul>
</li>
<li>æ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader)<ul>
<li>Javaè¯­è¨€ç¼–å†™ï¼Œç”±sun.misc.Launcher$ExtClassLoaderå®ç°</li>
<li>å®ƒè´Ÿè´£åŠ è½½%JAVA_HOME%\lib\extç›®å½•ä¸­æˆ–è€…è¢«java.ext.dirsç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“</li>
<li>å¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨</li>
</ul>
</li>
</ul>
<blockquote>
<p>ğŸ€ ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨</p>
</blockquote>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>éš”ç¦»åŠ è½½ç±»</li>
<li>ä¿®æ”¹ç±»åŠ è½½çš„æ–¹å¼</li>
<li>æ‰©å±•åŠ è½½æº</li>
<li>é˜²æ­¢æºç æ³„éœ²</li>
</ul>
<p>å®ç°æ­¥éª¤ï¼š</p>
<ul>
<li>å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡ç»§æ‰¿æŠ½è±¡ç±»java.lang.ClassLoaderç±»çš„æ–¹å¼ï¼Œå®ç°è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä»¥æ»¡è¶³ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚ã€‚</li>
<li>åœ¨JDK1.2ä¹‹å‰ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œæ€»ä¼šå»ç»§æ‰¿ClassLoaderç±»å¹¶é‡å†™loadClass()æ–¹æ³•ï¼Œä»è€Œå®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯åœ¨JDK1.2ä¹‹åå·²ä¸å†å»ºè®®ç”¨æˆ·å»è¦†ç›–loadClass()æ–¹æ³•ï¼Œè€Œæ˜¯å»ºè®®æŠŠè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨é€»è¾‘å†™åœ¨findClass()æ–¹æ³•ä¸­ã€‚</li>
<li>åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¤ªè¿‡äºå¤æ‚çš„éœ€æ±‚ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿URLClassLoaderç±»ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…è‡ªå·±å»ç¼–å†™findClass()æ–¹æ³•åŠå…¶è·å–å­—èŠ‚ç æµçš„æ–¹å¼ï¼Œä½¿è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç¼–å†™æ›´åŠ ç®€æ´ã€‚</li>
</ul>
<h2 id="2-5-ğŸ’‘åŒäº²å§”æ´¾æœºåˆ¶"><a href="#2-5-ğŸ’‘åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="2.5 ğŸ’‘åŒäº²å§”æ´¾æœºåˆ¶"></a>2.5 ğŸ’‘åŒäº²å§”æ´¾æœºåˆ¶</h2><blockquote>
<p>ğŸ•µï¸ å·¥ä½œåŸç†</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/22607/%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%9C%BA%E5%88%B6.svg" class="" title="åŒäº²å§”æ´¾æœºåˆ¶"><br />

<p><strong>è´£ä»»é“¾æ¨¡å¼</strong></p>
<ul>
<li>å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œå®ƒå¹¶ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œã€‚</li>
<li>å¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’å½’ï¼Œè¯·æ±‚æœ€ç»ˆå°†åˆ°è¾¾é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ã€‚</li>
<li>å¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå€˜è‹¥çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ  ä¼˜åŠ¿</p>
</blockquote>
<ul>
<li>é¿å…ç±»çš„é‡å¤åŠ è½½</li>
<li>ä¿æŠ¤ç¨‹åºå®‰å…¨ï¼Œé˜²æ­¢æ ¸å¿ƒAPè¢«éšæ„ç¯¡æ”¹</li>
</ul>
<blockquote>
<p>ğŸ“˜ æ²™ç®±å®‰å…¨æœºåˆ¶</p>
</blockquote>
<p>å‡å¦‚åœ¨java.langåŒ…ä¸‹è‡ªå®šä¹‰Stringç±»ï¼Œç¨‹åºä¼šæŠ¥é”™ã€‚</p>
<p>å› ä¸ºåœ¨åŠ è½½è‡ªå®šä¹‰Stringç±»çš„æ—¶å€™å›ç‡å…ˆä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½ï¼Œè€Œå¼•å¯¼ç±»åŠ è½½å™¨åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ä¼šå…ˆåŠ è½½jdkè‡ªå¸¦çš„æ–‡ä»¶(rt.jaråŒ…ä¸­java/lang/String.class)ï¼ŒæŠ¥é”™ä¿¡æ¯æ˜¯æ‰¾ä¸åˆ°mainæ–¹æ³•ï¼Œå°±æ˜¯å› ä¸ºåŠ è½½çš„æ˜¯rt.jarä¸­çš„Stringç±»ã€‚è¿™æ ·å¯ä»¥ä¿è¯å¯¹Javaæ ¸å¿ƒæºä»£ç çš„ä¿æŠ¤ã€‚</p>
<h2 id="2-6-ğŸ”°å…¶ä»–"><a href="#2-6-ğŸ”°å…¶ä»–" class="headerlink" title="2.6 ğŸ”°å…¶ä»–"></a>2.6 ğŸ”°å…¶ä»–</h2><blockquote>
<p>âš“ åœ¨JVMä¸­è¡¨ç¤ºä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ä¸ªç±»å­˜åœ¨çš„ä¸¤ä¸ªå¿…è¦æ¡ä»¶</p>
</blockquote>
<ul>
<li>ç±»çš„å®Œæ•´ç±»åå¿…é¡»ä¸€è‡´ï¼ŒåŒ…æ‹¬åŒ…å</li>
<li>åŠ è½½è¿™ä¸ªç±»çš„ClassLoaderå¿…é¡»ç›¸åŒ</li>
</ul>
<p>æ¢å¥è¯è¯´ï¼Œåœ¨JVMä¸­ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»å¯¹è±¡æ¥æºäºåŒä¸€ä¸ªclassæ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹Ÿæœºæ‰€åŠ è½½ï¼Œä½†åªè¦åŠ è½½å®ƒä»¬çš„ClassLoaderå®ä¾‹å¯¹è±¡ä¸åŒï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å¯¹è±¡ä¹Ÿæ˜¯ä¸ç›¸ç­‰çš„ã€‚</p>
<blockquote>
<p>âš“ å¯¹ç±»åŠ è½½å™¨çš„å¼•ç”¨</p>
</blockquote>
<p>JVMå¿…é¡»çŸ¥é“ä¸€ä¸ªç±»å‹æ˜¯ç”±å¯åŠ¨åŠ è½½å™¨åŠ è½½çš„è¿˜æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ã€‚å¦‚æœä¸€ä¸ªç±»å‹æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œé‚£ä¹ˆJVMä¼šå°†è¿™ä¸ªç±»åŠ è½½å™¨çš„ä¸€ä¸ªå¼•ç”¨ä½œä¸ºç±»å‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†ä¿å­˜åœ¨æ–¹æ³•åŒºä¸­ã€‚å½“è§£æä¸€ä¸ªç±»å‹åˆ°å¦ä¸€ä¸ªç±»å‹çš„å¼•ç”¨çš„æ—¶å€™ï¼ŒJVMéœ€è¦ä¿è¯è¿™ä¸¤ä¸ªç±»å‹çš„ç±»åŠ è½½å™¨æ˜¯ç›¸åŒçš„ã€‚</p>
<blockquote>
<p>âš“ ç±»çš„ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨</p>
</blockquote>
<p>Javaç¨‹åºå¯¹ç±»çš„ä½¿ç”¨æ–¹å¼åˆ†ä¸ºï¼šä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨</p>
<p>ä¸»åŠ¨ä½¿ç”¨ï¼Œåˆ†ä¸ºä¸ƒç§æƒ…å†µï¼š</p>
<ul>
<li>åˆ›å»ºç±»çš„å®ä¾‹</li>
<li>è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡ï¼Œæˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼</li>
<li>è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•</li>
<li>åå°„(æ¯”å¦‚ï¼šClass.forName(â€œtop.parakâ€))</li>
<li>åˆå§‹åŒ–ä¸€ä¸ªç±»çš„å­ç±»</li>
<li>Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»</li>
<li>JDK7å¼€å§‹æä¾›çš„åŠ¨æ€è¯­è¨€æ”¯æŒï¼šjava.lang.invoke.MethodHandleå®ä¾‹çš„è§£æç»“æœ<br>REF_getStaticã€REF_putStaticã€REF_invokeStaticå¥æŸ„å¯¹åº”çš„ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–</li>
</ul>
<p>é™¤äº†ä»¥ä¸Šä¸ƒç§æƒ…å†µï¼Œå…¶ä»–ä½¿ç”¨Javaç±»çš„æ–¹å¼éƒ½è¢«çœ‹åšæ˜¯è¢«åŠ¨ä½¿ç”¨ï¼Œéƒ½ä¸ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-3(è¿è¡Œæ—¶æ•°æ®åŒº)</title>
    <url>/posts/2398/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="3-1-ğŸ“š-æ¦‚è¿°"><a href="#3-1-ğŸ“š-æ¦‚è¿°" class="headerlink" title="3.1 ğŸ“š æ¦‚è¿°"></a>3.1 ğŸ“š æ¦‚è¿°</h2><blockquote>
<p> ğŸ”— å†…å­˜</p>
</blockquote>
<p>å†…å­˜æ˜¯éå¸¸é‡è¦çš„ç³»ç»Ÿèµ„æºï¼Œæ˜¯ç¡¬ç›˜å’ŒCPUçš„ä¸­é—´ä»“åº“åŠæ¡¥æ¢ï¼Œæ‰¿è½½ç€æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„å®æ—¶è¿è¡Œ.ã€‚JVMå†…å­˜å¸ƒå±€è§„å®šäº†Javaåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ç”³è¯·ã€åˆ†é…å’Œç®¡ç†çš„ç­–ç•¥ï¼Œä¿è¯äº†JVMçš„é«˜æ•ˆç¨³å®šè¿è¡Œã€‚ä¸åŒçš„JVMå¯¹äºå†…å­˜çš„åˆ’åˆ†æ–¹å¼å’Œç®¡ç†æœºåˆ¶å­˜åœ¨ç€éƒ¨åˆ†å·®å¼‚ã€‚</p>
<blockquote>
<p>ğŸ“· è¿è¡Œæ—¶æ•°æ®åŒºæ¨¡å‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/2398/%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.svg" class="" title="è¿è¡Œæ—¶æ•°æ®åŒº">



<blockquote>
<p>ğŸ“¸ è¿è¡Œæ—¶æ•°æ®å¿«ç…§</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/2398/image-2021030911201911.jpg" class="" title="image-2021030911201911"><br />



<blockquote>
<p>ğŸ“· çº¿ç¨‹æ•°æ®åŒºæ¨¡å‹</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºå®šä¹‰äº†è‹¥å¹²ç§ç¨‹åºè¿è¡ŒæœŸé—´ä¼šä½¿ç”¨åˆ°çš„è¿è¡Œæ—¶æ•°æ®åŒºï¼Œå…¶ä¸­æœ‰ä¸€äº›ä¼šéšç€è™šæ‹Ÿæœºå¯åŠ¨è€Œåˆ›å»ºï¼Œéšç€è™šæ‹Ÿæœºé€€å‡ºè€Œé”€æ¯ã€‚å¦å¤–åˆ™æ˜¯ä¸çº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„ï¼Œè¿™äº›ä¸çº¿ç¨‹å¯¹åº”çš„æ•°æ®åŒºä¼šéšç€çº¿ç¨‹å¼€å§‹å’Œç»“æŸè€Œåˆ›å»ºå’Œé”€æ¯ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/2398/%E7%BA%BF%E7%A8%8B.svg" class="" title="çº¿ç¨‹">

<p>ä¸Šå›¾ä¸­ï¼Œæ©™è‰²ä¸ºå¤šçº¿ç¨‹å…±äº«çš„ï¼Œç°è‰²ä¸ºå•ç‹¬çº¿ç¨‹ç§æœ‰çš„</p>
<ul>
<li>å…±äº«ï¼šå †(Heap)ã€æ–¹æ³•åŒº(Method Area)ã€å †å¤–å†…å­˜(æ°¸ä¹…ä»£/å…ƒç©ºé—´ã€ä»£ç ç¼“å­˜)</li>
<li>ç§æœ‰ï¼šçº¿ç¨‹è®¡æ•°å™¨(PC)ã€è™šæ‹Ÿæœºæ ˆ(Virtual Machine Stack)ã€æœ¬åœ°æ–¹æ³•æ ˆ(Native Method Stack)</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/2398/%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F.svg" class="" title="å†…å­˜åŒºåŸŸ"><br />



<h2 id="3-2-ğŸ“™-çº¿ç¨‹"><a href="#3-2-ğŸ“™-çº¿ç¨‹" class="headerlink" title="3.2 ğŸ“™ çº¿ç¨‹"></a>3.2 ğŸ“™ çº¿ç¨‹</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>çº¿ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºé‡Œçš„è¿è¡Œå•å…ƒã€‚JVMå…è®¸ä¸€ä¸ªåº”ç”¨æœ‰å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚</li>
<li>åœ¨HotSpot JVMé‡Œï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¸æ“ä½œç³»ç»Ÿçš„æœ¬åœ°çº¿ç¨‹ç›´æ¥æ˜ å°„ã€‚å³å½“ä¸€ä¸ªJavaçº¿ç¨‹å‡†å¤‡å¥½æ‰§è¡Œä»¥åï¼Œæ­¤æ—¶ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„æœ¬åœ°çº¿ç¨‹ä¹ŸåŒæ—¶åˆ›å»ºï¼›Javaçº¿ç¨‹æ‰§è¡Œç»ˆæ­¢åï¼Œæœ¬åœ°çº¿ç¨‹ä¹Ÿä¼šå›æ”¶ã€‚</li>
<li>æ“ä½œç³»ç»Ÿè´Ÿè´£æ‰€æœ‰çº¿ç¨‹çš„å®‰æ’è°ƒåº¦åˆ°ä»»ä½•ä¸€ä¸ªå¯ç”¨çš„CPUä¸Šã€‚ä¸€æ—¦æœ¬åœ°çº¿ç¨‹åˆå§‹åŒ–æˆåŠŸï¼Œå®ƒå°±ä¼šè°ƒç”¨Javaçº¿ç¨‹ä¸­çš„run()æ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>ğŸš¤ JVMç³»ç»Ÿçº¿ç¨‹</p>
</blockquote>
<p>JVMä¸­çš„åå°ç³»ç»Ÿçº¿ç¨‹ï¼š</p>
<ul>
<li>è™šæ‹Ÿæœºçº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹çš„æ“ä½œæ˜¯éœ€è¦JVMè¾¾åˆ°å®‰å…¨ç‚¹æ‰ä¼šå‡ºç°ã€‚æ‰§è¡Œç±»å‹åŒ…æ‹¬åƒåœ¾æ”¶é›†ã€çº¿ç¨‹æ ˆæ”¶é›†ã€çº¿ç¨‹æŒ‚èµ·ä»¥åŠåå‘é”æ’¤é”€ã€‚</li>
<li>å‘¨æœŸä»»åŠ¡çº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹æ˜¯æ—¶é—´å‘¨æœŸäº‹ä»¶çš„ä½“ç°(æ¯”å¦‚ä¸­æ–­)ï¼Œä¸€èˆ¬ç”¨äºå‘¨æœŸæ€§æ“ä½œçš„è°ƒåº¦æ‰§è¡Œã€‚</li>
<li>GCçº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹å¯¹åœ¨JVMé‡Œä¸åŒç§ç±»çš„åƒåœ¾æ”¶é›†è¡Œä¸ºæä¾›äº†æ”¯æŒã€‚</li>
<li>ç¼–è¯‘çº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹åœ¨è¿è¡Œæ—¶ä¼šå°†å­—èŠ‚ç ç¼–è¯‘æˆæœ¬åœ°ä»£ç ã€‚</li>
<li>ä¿¡å·è°ƒåº¦çº¿ç¨‹ï¼šè¿™ç§ç‚¹æˆæ¥æ”¶ä¿¡å·å¹¶å‘é€ç»™JVMï¼Œåœ¨å®ƒå†…éƒ¨é€šè¿‡è°ƒç”¨é€‚å½“çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-4(ç¨‹åºè®¡æ•°å™¨)</title>
    <url>/posts/28643/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>ğŸ”Š ä»‹ç»</p>
</blockquote>
<p>JVMä¸­çš„ç¨‹åºè®¡æ•°å¯„å­˜å™¨(Program Counter Register)ä¸­ï¼Œå¯„å­˜å™¨å­˜å‚¨æŒ‡ä»¤ç›¸å…³çš„ç°åœºä¿¡æ¯ï¼ŒCPUåªæœ‰æŠŠæ•°æ®è£…è½½åˆ°å¯„å­˜å™¨æ‰èƒ½å¤Ÿè¿è¡Œã€‚</p>
<p>JVMä¸­çš„ç¨‹åºè®¡æ•°å™¨æ˜¯å¯¹ç‰©ç†è®¡ç®—æœºå¯„å­˜å™¨çš„ä¸€ç§æ¨¡æ‹Ÿï¼Œå¹¶éæ˜¯æŒ‡å¹¿ä¹‰ä¸Šæ‰€æŒ‡çš„ç‰©ç†å¯„å­˜å™¨ï¼Œä¹Ÿå«PCå¯„å­˜å™¨ã€‚</p>
<blockquote>
<p>ğŸ”¨ ä½œç”¨</p>
</blockquote>
<p>PCå¯„å­˜å™¨ç”¨æ¥å­˜å‚¨ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå³å³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ã€‚ç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/28643/%E7%A8%8B%E5%BA%8F%E8%AE%A1%E6%95%B0%E5%99%A8.svg" class="" title="ç¨‹åºè®¡æ•°å™¨"><br />



<blockquote>
<p>ğŸ“„ è¯¦è¿°</p>
</blockquote>
<ul>
<li>å®ƒæ˜¯ä¸€å—å¾ˆå°çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ä¹Ÿæ˜¯è¿è¡Œé€Ÿåº¦æœ€å¿«çš„å­˜å‚¨åŒºåŸŸã€‚</li>
<li>åœ¨JVMè§„èŒƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ˜¯ç°è½¦ç»™ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ã€‚</li>
<li>ä»»ä½•æ—¶é—´ä¸€ä¸ªçº¿ç¨‹éƒ½åªæœ‰ä¸€ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å½“å‰æ–¹æ³•ã€‚ç¨‹åºè®¡æ•°å™¨ä¼šå­˜å‚¨å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„Javaæ–¹æ³•çš„JVMæŒ‡ä»¤åœ°å€ï¼›æˆ–è€…ï¼Œå¦‚æœæ˜¯åœ¨æ‰§è¡Œnativeæ–¹æ³•ï¼Œåˆ™æ˜¯æœªæŒ‡å®šå€¼(undefined)ã€‚</li>
<li>å®ƒæ˜¯ç¨‹åºæ§åˆ¶æµçš„æŒ‡ç¤ºå™¨ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚</li>
<li>å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</li>
<li>å®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½•OutOfMemoryErroræƒ…å†µçš„åŒºåŸŸã€‚</li>
</ul>
<blockquote>
<p>âŒ¨ï¸ å®ä¾‹</p>
</blockquote>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PCRegisterTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">20</span>;</span><br><span class="line">        <span class="keyword">int</span> k = i + j;</span><br><span class="line">        String s = <span class="string">&quot;KHighness&quot;</span>;</span><br><span class="line">        System.out.println(k);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘åå†åç¼–è¯‘:<code>javap -v PCRegisterTest.java</code></p>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">D:\Java\Test\Test\target\classes\top\parak\chapter01&gt;javap <span class="literal">-v</span> PCRegisterTest.class</span><br><span class="line">Classfile /D:/Java/Test/Test/target/classes/top/parak/chapter01/PCRegisterTest.class</span><br><span class="line">  Last modified <span class="number">2020</span><span class="literal">-10</span><span class="literal">-31</span>; size <span class="number">722</span> bytes</span><br><span class="line">  MD5 checksum <span class="number">8</span>a19ae86b495f9dd8ef414436e2baef5</span><br><span class="line">  Compiled from <span class="string">&quot;PCRegisterTest.java&quot;</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">top</span>.<span class="title">parak</span>.<span class="title">chapter01</span>.<span class="title">PCRegisterTest</span></span></span><br><span class="line"><span class="class">  <span class="title">minor</span> <span class="title">version</span>: 0</span></span><br><span class="line"><span class="class">  <span class="title">major</span> <span class="title">version</span>: 52</span></span><br><span class="line"><span class="class">  <span class="title">flags</span>: <span class="title">ACC_PUBLIC</span>, <span class="title">ACC_SUPER</span></span></span><br><span class="line"><span class="class"><span class="title">Constant</span> <span class="title">pool</span>:</span></span><br><span class="line"><span class="class">   #1 = <span class="title">Methodref</span>          #7.#27         // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Object</span>.&quot;&lt;<span class="title">init</span>&gt;&quot;:()<span class="title">V</span></span></span><br><span class="line"><span class="class">   #2 = <span class="title">String</span>             #28            // <span class="title">KHighness</span></span></span><br><span class="line"><span class="class">   #3 = <span class="title">Fieldref</span>           #29.#30        // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">System</span>.<span class="title">out</span>:<span class="title">Ljava</span>/<span class="title">io</span>/<span class="title">PrintStream</span>;</span></span><br><span class="line"><span class="class">   #4 = <span class="title">Methodref</span>          #31.#32        // <span class="title">java</span>/<span class="title">io</span>/<span class="title">PrintStream</span>.<span class="title">println</span>:(<span class="title">I</span>)<span class="title">V</span></span></span><br><span class="line"><span class="class">   #5 = <span class="title">Methodref</span>          #31.#33        // <span class="title">java</span>/<span class="title">io</span>/<span class="title">PrintStream</span>.<span class="title">println</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;)<span class="title">V</span></span></span><br><span class="line"><span class="class">   #6 = <span class="title">Class</span>              #34            // <span class="title">top</span>/<span class="title">parak</span>/<span class="title">chapter01</span>/<span class="title">PCRegisterTest</span></span></span><br><span class="line"><span class="class">   #7 = <span class="title">Class</span>              #35            // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Object</span></span></span><br><span class="line"><span class="class">   #8 = <span class="title">Utf8</span>               &lt;<span class="title">init</span>&gt;</span></span><br><span class="line"><span class="class">   #9 = <span class="title">Utf8</span>               ()<span class="title">V</span></span></span><br><span class="line"><span class="class">  #10 = <span class="title">Utf8</span>               <span class="title">Code</span></span></span><br><span class="line"><span class="class">  #11 = <span class="title">Utf8</span>               <span class="title">LineNumberTable</span></span></span><br><span class="line"><span class="class">  #12 = <span class="title">Utf8</span>               <span class="title">LocalVariableTable</span></span></span><br><span class="line"><span class="class">  #13 = <span class="title">Utf8</span>               <span class="title">this</span></span></span><br><span class="line"><span class="class">  #14 = <span class="title">Utf8</span>               <span class="title">Ltop</span>/<span class="title">parak</span>/<span class="title">chapter01</span>/<span class="title">PCRegisterTest</span>;</span></span><br><span class="line"><span class="class">  #15 = <span class="title">Utf8</span>               <span class="title">main</span></span></span><br><span class="line"><span class="class">  #16 = <span class="title">Utf8</span>               ([<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;)<span class="title">V</span></span></span><br><span class="line"><span class="class">  #17 = <span class="title">Utf8</span>               <span class="title">args</span></span></span><br><span class="line"><span class="class">  #18 = <span class="title">Utf8</span>               [<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;</span></span><br><span class="line"><span class="class">  #19 = <span class="title">Utf8</span>               <span class="title">i</span></span></span><br><span class="line"><span class="class">  #20 = <span class="title">Utf8</span>               <span class="title">I</span></span></span><br><span class="line"><span class="class">  #21 = <span class="title">Utf8</span>               <span class="title">j</span></span></span><br><span class="line"><span class="class">  #22 = <span class="title">Utf8</span>               <span class="title">k</span></span></span><br><span class="line"><span class="class">  #23 = <span class="title">Utf8</span>               <span class="title">s</span></span></span><br><span class="line"><span class="class">  #24 = <span class="title">Utf8</span>               <span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;</span></span><br><span class="line"><span class="class">  #25 = <span class="title">Utf8</span>               <span class="title">SourceFile</span></span></span><br><span class="line"><span class="class">  #26 = <span class="title">Utf8</span>               <span class="title">PCRegisterTest</span>.<span class="title">java</span></span></span><br><span class="line"><span class="class">  #27 = <span class="title">NameAndType</span>        #8:#9          // &quot;&lt;<span class="title">init</span>&gt;&quot;:()<span class="title">V</span></span></span><br><span class="line"><span class="class">  #28 = <span class="title">Utf8</span>               <span class="title">KHighness</span></span></span><br><span class="line"><span class="class">  #29 = <span class="title">Class</span>              #36            // <span class="title">java</span>/<span class="title">lang</span>/<span class="title">System</span></span></span><br><span class="line"><span class="class">  #30 = <span class="title">NameAndType</span>        #37:#38        // <span class="title">out</span>:<span class="title">Ljava</span>/<span class="title">io</span>/<span class="title">PrintStream</span>;</span></span><br><span class="line"><span class="class">  #31 = <span class="title">Class</span>              #39            // <span class="title">java</span>/<span class="title">io</span>/<span class="title">PrintStream</span></span></span><br><span class="line"><span class="class">  #32 = <span class="title">NameAndType</span>        #40:#41        // <span class="title">println</span>:(<span class="title">I</span>)<span class="title">V</span></span></span><br><span class="line"><span class="class">  #33 = <span class="title">NameAndType</span>        #40:#42        // <span class="title">println</span>:(<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;)<span class="title">V</span></span></span><br><span class="line"><span class="class">  #34 = <span class="title">Utf8</span>               <span class="title">top</span>/<span class="title">parak</span>/<span class="title">chapter01</span>/<span class="title">PCRegisterTest</span></span></span><br><span class="line"><span class="class">  #35 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">lang</span>/<span class="title">Object</span></span></span><br><span class="line"><span class="class">  #36 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">lang</span>/<span class="title">System</span></span></span><br><span class="line"><span class="class">  #37 = <span class="title">Utf8</span>               <span class="title">out</span></span></span><br><span class="line"><span class="class">  #38 = <span class="title">Utf8</span>               <span class="title">Ljava</span>/<span class="title">io</span>/<span class="title">PrintStream</span>;</span></span><br><span class="line"><span class="class">  #39 = <span class="title">Utf8</span>               <span class="title">java</span>/<span class="title">io</span>/<span class="title">PrintStream</span></span></span><br><span class="line"><span class="class">  #40 = <span class="title">Utf8</span>               <span class="title">println</span></span></span><br><span class="line"><span class="class">  #41 = <span class="title">Utf8</span>               (<span class="title">I</span>)<span class="title">V</span></span></span><br><span class="line"><span class="class">  #42 = <span class="title">Utf8</span>               (<span class="title">Ljava</span>/<span class="title">lang</span>/<span class="title">String</span>;)<span class="title">V</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  public top.parak.chapter01.PCRegisterTest();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         <span class="number">1</span>: invokespecial <span class="comment">#1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">14</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        <span class="built_in">Start</span>  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  this   Ltop/parak/chapter01/PCRegisterTest;</span><br><span class="line"></span><br><span class="line">  public <span class="keyword">static</span> void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([<span class="type">Ljava</span>/<span class="type">lang</span>/<span class="built_in">String</span>;)<span class="type">V</span></span><br><span class="line">    <span class="type">flags</span>: <span class="type">ACC_PUBLIC</span>, <span class="type">ACC_STATIC</span></span><br><span class="line">    <span class="type">Code</span>:</span><br><span class="line">      <span class="type">stack</span>=<span class="number">2</span>, <span class="type">locals</span>=<span class="number">5</span>, <span class="type">args_size</span>=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: <span class="type">bipush</span>        <span class="number">10</span></span><br><span class="line">         <span class="number">2</span>: <span class="type">istore_1</span></span><br><span class="line">         <span class="number">3</span>: <span class="type">bipush</span>        <span class="number">20</span></span><br><span class="line">         <span class="number">5</span>: <span class="type">istore_2</span></span><br><span class="line">         <span class="number">6</span>: <span class="type">iload_1</span></span><br><span class="line">         <span class="number">7</span>: <span class="type">iload_2</span></span><br><span class="line">         <span class="number">8</span>: <span class="type">iadd</span></span><br><span class="line">         <span class="number">9</span>: <span class="type">istore_3</span></span><br><span class="line">        <span class="number">10</span>: <span class="type">ldc</span>           <span class="comment">#2                  // String KHighness</span></span><br><span class="line">        <span class="number">12</span>: <span class="type">astore</span>        <span class="number">4</span></span><br><span class="line">        <span class="number">14</span>: <span class="type">getstatic</span>     <span class="comment">#3                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">        <span class="number">17</span>: <span class="type">iload_3</span></span><br><span class="line">        <span class="number">18</span>: <span class="type">invokevirtual</span> <span class="comment">#4                  // Method java/io/PrintStream.println:(I)V</span></span><br><span class="line">        <span class="number">21</span>: <span class="type">getstatic</span>     <span class="comment">#3                  // Field java/lang/System.out:Ljava/io/PrintStream;</span></span><br><span class="line">        <span class="number">24</span>: <span class="type">aload</span>         <span class="number">4</span></span><br><span class="line">        <span class="number">26</span>: <span class="type">invokevirtual</span> <span class="comment">#5                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span></span><br><span class="line">        <span class="number">29</span>: <span class="type">return</span></span><br><span class="line">      <span class="type">LineNumberTable</span>:</span><br><span class="line">        <span class="type">line</span> <span class="number">17</span>: <span class="number">0</span></span><br><span class="line">        <span class="type">line</span> <span class="number">18</span>: <span class="number">3</span></span><br><span class="line">        <span class="type">line</span> <span class="number">19</span>: <span class="number">6</span></span><br><span class="line">        <span class="type">line</span> <span class="number">21</span>: <span class="number">10</span></span><br><span class="line">        <span class="type">line</span> <span class="number">22</span>: <span class="number">14</span></span><br><span class="line">        <span class="type">line</span> <span class="number">23</span>: <span class="number">21</span></span><br><span class="line">        <span class="type">line</span> <span class="number">24</span>: <span class="number">29</span></span><br><span class="line">      <span class="type">LocalVariableTable</span>:</span><br><span class="line">        <span class="type">Start</span>  <span class="type">Length</span>  <span class="type">Slot</span>  <span class="type">Name</span>   <span class="type">Signature</span></span><br><span class="line">            <span class="number">0</span>      <span class="number">30</span>     <span class="number">0</span>  <span class="type">args</span>   [<span class="type">Ljava</span>/<span class="type">lang</span>/<span class="built_in">String</span>;</span><br><span class="line">            <span class="number">3</span>      <span class="number">27</span>     <span class="number">1</span>     <span class="type">i</span>   <span class="type">I</span></span><br><span class="line">            <span class="number">6</span>      <span class="number">24</span>     <span class="number">2</span>     <span class="type">j</span>   <span class="type">I</span></span><br><span class="line">           <span class="number">10</span>      <span class="number">20</span>     <span class="number">3</span>     <span class="type">k</span>   <span class="type">I</span></span><br><span class="line">           <span class="number">14</span>      <span class="number">16</span>     <span class="number">4</span>     <span class="type">s</span>   <span class="type">Ljava</span>/<span class="type">lang</span>/<span class="built_in">String</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">SourceFile</span>: <span class="string">&quot;PCRegisterTest.java&quot;</span></span><br></pre></td></tr></table></figure>

<p>Codeæ¨¡å—è§£æï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/28643/image-20201031134509185.png" class="" title="image-20201031134509185"><br />



<blockquote>
<p>â“ å¸¸è§é—®é¢˜</p>
</blockquote>
<ol>
<li><p>ä¸ºä»€ä¹ˆä½¿ç”¨PCå¯„å­˜å™¨è®°å½•å½“å‰çº¿ç¨‹çš„æ‰§è¡Œåœ°å€ï¼Ÿ</p>
<p>å› ä¸ºCPUéœ€è¦ä¸åœçš„æ¥å›åˆ‡æ¢å„ä¸ªçº¿ç¨‹ï¼Œè¿™æ—¶å€™åˆ‡æ¢å›æ¥ä»¥åï¼Œå°±éœ€è¦çŸ¥é“æ¥ç€ä»å“ªå¼€å§‹ç»§ç»­æ‰§è¡Œã€‚</p>
<p>JVMçš„çš„å­—èŠ‚ç è§£é‡Šå™¨å°±éœ€è¦é€šè¿‡æ”¹å˜PCå¯„å­˜å™¨çš„å€¼æ¥æ˜ç¡®ä¸‹ä¸€æ¡åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</p>
</li>
<li><p>PCå¯„å­˜å™¨ä¸ºä»€ä¹ˆä¼šè¢«è®¾å®šä¸ºçº¿ç¨‹ç§æœ‰ï¼Ÿ</p>
<p>ä¸ºäº†èƒ½å¤Ÿå‡†ç¡®åœ°è®°å½•å„ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å½“å‰å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åˆ†é…ä¸€ä¸ªPCå¯„å­˜å™¨ï¼Œè¿™æ ·ä¸€æ¥å„ä¸ªçº¿ç¨‹ä¹‹é—´å°±å¯ä»¥è¿›è¡Œç‹¬ç«‹è®¡ç®—ï¼Œä»è€Œä¸ä¼šå‡ºç°ç›¸äº’å¹²æ‰°çš„æƒ…å†µã€‚</p>
<p>ç”±äºCPUæ—¶é—´ç‰‡è½®é™åˆ¶ï¼Œä¼—å¤šçº¿ç¨‹å†å¹¶å‘æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨æˆ–è€…å¤šæ ¸å¤„ç†å™¨ä¸­çš„ä¸€ä¸ªå†…æ ¸ï¼Œåªä¼šæ‰§è¡ŒæŸä¸ªçº¿ç¨‹ä¸­çš„ä¸€æ¡æŒ‡ä»¤ã€‚</p>
<p>è¿™æ ·å¿…ç„¶å¯¼è‡´ç»å¸¸ä¸­æ–­æˆ–æ¢å¤ï¼Œå¦‚ä½•ä¿è¯åˆ†æ¯«æ— å·®å‘¢ï¼Ÿæ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºåï¼Œéƒ½ä¼šäº§ç”Ÿè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨å’Œæ ˆå¸§ï¼Œç¨‹åºè®¡æ•°å™¨åœ¨å„ä¸ªçº¿ç¨‹ä¹‹é—´äº’ä¸å½±å“ã€‚</p>
</li>
</ol>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-6(æœ¬åœ°æ–¹æ³•æ¥å£)</title>
    <url>/posts/31917/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="6-1-ğŸ³ï¸â€ğŸŒˆæœ¬åœ°æ–¹æ³•"><a href="#6-1-ğŸ³ï¸â€ğŸŒˆæœ¬åœ°æ–¹æ³•" class="headerlink" title="6.1 ğŸ³ï¸â€ğŸŒˆæœ¬åœ°æ–¹æ³•"></a>6.1 ğŸ³ï¸â€ğŸŒˆæœ¬åœ°æ–¹æ³•</h2><blockquote>
<p>ğŸ“– æ¦‚è¿°</p>
</blockquote>
<p>ç®€å•åœ°è®²ï¼Œä¸€ä¸ªNative Methodå°±æ˜¯ä¸€ä¸ªJavaè°ƒç”¨éJavaä»£ç çš„æ¥å£ã€‚ä¸€ä¸ªNative Methodæ˜¯è¿™æ ·ä¸€ä¸ªJavaæ–¹æ³•ï¼šè¯¥æ–¹æ³•çš„å®ç°ç”±éJavaè¯­è¨€å®ç°ï¼Œæ¯”å¦‚Cã€‚è¿™ä¸ªç‰¹å¾å¹¶éJavaæ‰€æŒæœ‰ï¼Œå¾ˆå¤šå…¶å®ƒçš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰è¿™ä¸€æœºåˆ¶ã€‚æ¯”å¦‚åœ¨C++ä¸­ï¼Œä½ å¯ä»¥ç”¨extern â€œCâ€å‘ŠçŸ¥C++ç¼–è¯‘å™¨å»è°ƒç”¨ä¸€ä¸ªCçš„å‡½æ•°ã€‚</p>
<p>åœ¨å®šä¹‰ä¸€ä¸ªnative methodæ—¶ï¼Œå¹¶ä¸æä¾›å®ç°ä½“ï¼ˆæœ‰äº›åƒå®šä¹‰ä¸€ä¸ªJava interfaceï¼‰ï¼Œå› ä¸ºå…¶å®ç°ä½“æ˜¯ç”±éJavaè¯­è¨€åœ¨å¤–é¢å®ç°çš„ã€‚</p>
<blockquote>
<p>ğŸ”¨ ä½œç”¨</p>
</blockquote>
<p>æœ¬åœ°æ¥å£çš„ä½œç”¨æ˜¯<strong>èåˆä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¸ºJavaæ‰€ç”¨</strong>ï¼Œå®ƒçš„åˆè¡·æ˜¯èåˆC/C++ç¨‹åºã€‚</p>
<p>æœ‰äº›å±‚æ¬¡çš„ä»»åŠ¡ç”¨Javaå®ç°èµ·æ¥ä¸å®¹æ˜“ï¼Œæˆ–è€…åœ¨æ„ç¨‹åºçš„æ•ˆç‡æ—¶ï¼Œé—®é¢˜å°±æ¥äº†ã€‚</p>
<ol>
<li><p>ä¸Javaç¯å¢ƒå¤–äº¤äº’</p>
<p>æœ‰æ—¶Javaåº”ç”¨éœ€è¦ä¸Javaå¤–é¢çš„ç¯å¢ƒäº¤äº’ï¼Œè¿™æ˜¯æœ¬åœ°æ–¹æ³•å­˜åœ¨çš„ä¸»è¦åŸå› ã€‚</p>
<p>æœ¬åœ°æ–¹æ³•å¯ä»¥æä¾›ä¸åº•å±‚ç³»ç»Ÿï¼Œå¦‚æ“ä½œç³»ç»Ÿæˆ–æŸäº›ç¡¬ä»¶äº¤æ¢ä¿¡æ¯æ—¶çš„æƒ…å†µã€‚</p>
<p>å®ƒä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªéå¸¸ç®€æ´çš„æ¥å£ï¼Œè€Œä¸”æˆ‘ä»¬æ— éœ€å»äº†è§£Javaåº”ç”¨ä¹‹å¤–çš„ç¹ççš„ç»†èŠ‚ã€‚</p>
</li>
<li><p>ä¸æ“ä½œç³»ç»Ÿäº¤äº’</p>
<p>JVMæ”¯æŒç€Javaè¯­è¨€æœ¬èº«å’Œè¿è¡Œæ—¶åº“ï¼Œå®ƒæ˜¯Javaç¨‹åºèµ–ä»¥ç”Ÿå­˜çš„å¹³å°ï¼Œå®ƒç”±ä¸€ä¸ªè§£é‡Šå™¨ï¼ˆè§£é‡Šå­—èŠ‚ç ï¼‰å’Œä¸€äº›è¿æ¥åˆ°æœ¬åœ°ä»£ç çš„åº“ç»„æˆã€‚ç„¶è€Œä¸ç®¡æ€æ ·ï¼Œå®ƒæ¯•ç«Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿï¼Œå®ƒç»å¸¸ä¾èµ–äºä¸€äº›åº•å±‚ç³»ç»Ÿçš„æ”¯æŒã€‚è¿™äº›åº•å±‚ç³»ç»Ÿå¸¸å¸¸æ˜¯å¼ºå¤§çš„æ“ä½œç³»ç»Ÿã€‚é€šè¿‡ä½¿ç”¨æœ¬åœ°æ–¹æ³•ï¼Œæˆ‘ä»¬å¾—ä»¥ç”¨Javaå®ç°äº†jreä¸åº•å±‚ç³»ç»Ÿçš„äº¤äº’ï¼Œç”šè‡³JVMçš„ä¸€äº›éƒ¨åˆ†å°±æ˜¯ç”¨Cå†™çš„ã€‚è¿˜æœ‰ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ä¸€äº›Javaè¯­è¨€æœ¬èº«æ²¡æœ‰æä¾›å°è£…çš„æ“ä½œç³»ç»Ÿçš„ç‰¹æ€§æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä½¿ç”¨æœ¬åœ°æ–¹æ³•ã€‚</p>
</li>
<li><p>Sunâ€™s Java</p>
<p>Sunçš„è§£é‡Šå™¨æ˜¯ç”¨Cå®ç°çš„ï¼Œè¿™ä½¿å¾—å®ƒèƒ½åƒä¸€äº›æ™®é€šçš„Cä¸€æ ·ä¸å¤–éƒ¨äº¤äº’ã€‚jreå¤§éƒ¨åˆ†æ˜¯ç”¨Javaå®ç°çš„ï¼Œå®ƒä¹Ÿé€šè¿‡ä¸€äº›æœ¬åœ°æ–¹æ³•ä¸å¤–ç•Œäº¤äº’ã€‚ä¾‹å¦‚ï¼š<code>java.lang.Thread</code>çš„<code>setPriority()</code>æ–¹æ³•æ˜¯ç”¨Javaå®ç°çš„ï¼Œä½†æ˜¯å®ƒå®ç°è°ƒç”¨çš„æ˜¯è¯¥ç±»é‡Œçš„æœ¬åœ°æ–¹æ³•<code>setPriority()</code>ã€‚è¿™ä¸ªæœ¬åœ°æ–¹æ³•æ˜¯ç”¨Cå®ç°çš„ï¼Œå¹¶è¢«æ¤å…¥JVMå†…éƒ¨ï¼Œåœ¨<code>Windows 95</code>çš„å¹³å°ä¸Šï¼Œè¿™ä¸ªæœ¬åœ°æ–¹æ³•æœ€ç»ˆå°†è°ƒç”¨<code>Win 32 SetPriority() API</code>ã€‚è¿™æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•çš„å…·ä½“å®ç°ç”±JVMç›´æ¥æä¾›ï¼Œæ›´å¤šçš„æƒ…å†µæ˜¯æœ¬åœ°æ–¹æ³•ç”±å¤–éƒ¨çš„åŠ¨æ€é“¾æ¥åº“ï¼ˆ<code>external dynamic link library</code>ï¼‰æä¾›ï¼Œç„¶åè¢«JVMè°ƒç”¨ã€‚</p>
</li>
</ol>
<blockquote>
<p>âŒ¨ï¸ ä¸¾ä¾‹</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IHaveNatives</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">Native1</span><span class="params">(<span class="keyword">int</span> x)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">long</span> <span class="title">Native2</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">synchronized</span> <span class="keyword">private</span> <span class="keyword">float</span> <span class="title">Native3</span><span class="params">(Object obj)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">void</span> <span class="title">Native4</span><span class="params">(<span class="keyword">int</span>[] array)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ‡è¯†ç¬¦<code>native</code>å¯ä»¥ä¸æ‰€æœ‰å…¶ä»–çš„Javaæ ‡è¯†ç¬¦è¿ç”¨ï¼Œä½†æ˜¯<code>abstract</code>é™¤å¤–ã€‚</p>
<h2 id="6-2-ğŸ¨æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#6-2-ğŸ¨æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="6.2 ğŸ¨æœ¬åœ°æ–¹æ³•æ ˆ"></a>6.2 ğŸ¨æœ¬åœ°æ–¹æ³•æ ˆ</h2><blockquote>
<p>ğŸ“– æ¦‚è¿°</p>
</blockquote>
<ul>
<li><p>Javaè™šæ‹Ÿæœºæ ˆç”¨äºç®¡ç†Javaæ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆç”¨äºç®¡ç†æœ¬åœ°æ–¹æ³•çš„è°ƒç”¨ã€‚</p>
</li>
<li><p>æœ¬åœ°æ–¹æ³•æ ˆï¼Œä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</p>
</li>
<li><p>å…è®¸è¢«å®ç°æˆå›ºå®šæˆ–è€…æ˜¯å¯åŠ¨æ€æ‰©å±•çš„å†…å­˜å¤§å°ã€‚</p>
<ul>
<li>å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡æœ¬åœ°æ–¹æ³•æ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª<code>StackOverflowError</code>å¼‚å¸¸ã€‚</li>
<li>å¦‚æœæœ¬åœ°æ–¹æ³•æ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„æœ¬åœ°æ–¹æ³•æ ˆï¼Œé‚£ä¹ˆJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª<code>OutofMemoryError</code>å¼‚å¸¸ã€‚</li>
</ul>
</li>
<li><p>æœ¬åœ°æ–¹æ³•æ˜¯ä½¿ç”¨Cè¯­è¨€å®ç°çš„ã€‚</p>
</li>
<li><p>å®ƒçš„å…·ä½“åšæ³•æ˜¯<code>Native Method Stack</code>ä¸­ç™»è®°nativeæ–¹æ³•ï¼Œåœ¨<code>Execution Engine</code>æ‰§è¡Œæ—¶åŠ è½½æœ¬åœ°æ–¹æ³•åº“ã€‚</p>
</li>
<li><p>å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ—¶ï¼Œå®ƒå°±è¿›å…¥äº†ä¸€ä¸ªå…¨æ–°çš„å¹¶ä¸”ä¸å†å—è™šæ‹Ÿæœºé™åˆ¶çš„ä¸–ç•Œã€‚å®ƒå’Œè™šæ‹Ÿæœºæ‹¥æœ‰åŒæ ·çš„æƒé™ã€‚</p>
<ul>
<li>æœ¬åœ°æ–¹æ³•å¯ä»¥é€šè¿‡æœ¬åœ°æ–¹æ³•æ¥å£æ¥å‘ä¸ªæ–‡è™šæ‹Ÿæœºå†…éƒ¨çš„è¿è¡Œæ—¶æ•°æ®åŒºã€‚</li>
<li>å®ƒç”šè‡³å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°å¤„ç†å™¨ä¸­çš„å¯„å­˜å™¨ã€‚</li>
<li>ç›´æ¥ä»æœ¬åœ°å†…å­˜çš„å †ä¸­åˆ†é…ä»»æ„æ•°é‡çš„å†…å­˜ã€‚</li>
</ul>
</li>
<li><p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„JVMéƒ½æ”¯æŒæœ¬åœ°æ–¹æ³•ã€‚å› ä¸ºJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰æ˜ç¡®è¦æ±‚æœ¬åœ°æ–¹æ³•æ ˆçš„ä½¿ç”¨è¯­è¨€ã€å…·ä½“å®ç°æ–¹å¼ã€æ•°æ®ç»“æ„ç­‰ã€‚å¦‚æœJVMäº§å“ä¸æ‰“ç®—æ”¯æŒnativeæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ— éœ€å®ç°æœ¬åœ°æ–¹æ³•æ ˆã€‚</p>
</li>
<li><p>åœ¨Hotspot JVMä¸­ï¼Œç›´æ¥å°†æœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-8(æ–¹æ³•åŒº)</title>
    <url>/posts/19997/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="8-1-ğŸ““-ç†è§£"><a href="#8-1-ğŸ““-ç†è§£" class="headerlink" title="8.1 ğŸ““ ç†è§£"></a>8.1 ğŸ““ ç†è§£</h2><blockquote>
<p>ğŸ“š è§„èŒƒ</p>
</blockquote>
<p>ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æ˜ç¡®è¯´æ˜ï¼šâ€œå°½ç®¡æ‰€æœ‰çš„æ–¹æ³•åŒºåœ¨é€»è¾‘ä¸Šæ˜¯å±äºå †çš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¸€äº›ç®€å•çš„å®ç°å¯èƒ½ä¸ä¼šé€‰æ‹©å»è¿›è¡Œåƒåœ¾æ”¶é›†æˆ–è€…è¿›è¡Œå‹ç¼©ã€‚â€ä½†å¯¹äºHotSpotJVMè€Œè¨€ï¼Œæ–¹æ³•åŒºè¿˜æœ‰ä¸€ä¸ªåˆ«åå«åšNon-Heapï¼ˆéå †ï¼‰ï¼Œç›®çš„å°±æ˜¯è¦å’Œå †åˆ†å¼€ã€‚</p>
<p>æ‰€ä»¥ï¼Œæ–¹æ³•åŒºçœ‹ä½œæ˜¯ä¸€å—ç‹¬ç«‹äºJavaå †çš„å†…å­˜ç©ºé—´ã€‚</p>
<blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<p>æ–¹æ³•åŒºä¸»è¦å­˜æ”¾çš„æ˜¯Classï¼Œè€Œå †ä¸­ä¸»è¦å­˜æ”¾çš„å®ä¾‹åŒ–çš„å¯¹è±¡ã€‚</p>
<ul>
<li><p>æ–¹æ³•åŒºå’ŒJavaå †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸã€‚</p>
</li>
<li><p>æ–¹æ³•åŒºåœ¨JVMå¯åŠ¨çš„æ—¶å€™è¢«åˆ›å»ºï¼Œå¹¶ä¸”å®ƒçš„å®é™…çš„ç‰©ç†å†…å­˜ç©ºé—´å’ŒJavaå †åŒºä¸€æ ·éƒ½å¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚</p>
</li>
<li><p>æ–¹æ³•åŒºçš„å¤§å°ï¼Œè·Ÿå †ä¸€æ ·ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–å¯æ‰©å±•ã€‚</p>
</li>
<li><p>æ–¹æ³•åŒºçš„å¤§å°ï¼Œè·Ÿå †ç©ºé—´ä¸€æ ·ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–è€…å¯æ‰©å±•ã€‚</p>
</li>
<li><p>æ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥ä¿å­˜å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿå®šä¹‰äº†å¤ªå¤šçš„ç±»ï¼Œå¯¼è‡´æ–¹æ³•åŒºæº¢å‡ºï¼Œè™šæ‹ŸæœºåŒæ ·ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºé”™è¯¯<code>java.lang.OutofMemoryError:PermGen space</code>æˆ–è€…<code>java.lang.OutOfMemoryError:Metaspace</code></p>
</li>
<li><ul>
<li>åŠ è½½å¤§é‡çš„ç¬¬ä¸‰æ–¹jaråŒ…</li>
<li>Tomcatéƒ¨ç½²çš„å·¥ç¨‹è¿‡å¤š</li>
<li>å¤§é‡åŠ¨æ€çš„ç”Ÿæˆåå°„ç±»</li>
</ul>
</li>
<li><p>å…³é—­JVMå°±ä¼šé‡Šæ”¾è¿™ä¸ªåŒºåŸŸçš„å†…å­˜ã€‚</p>
</li>
</ul>
<blockquote>
<p>â³ æ¼”è¿›</p>
</blockquote>
<p>JDK7åŠä»¥å‰ï¼Œä¹ æƒ¯ä¸ŠæŠŠæ–¹æ³•åŒºï¼Œç§°ä¸ºæ°¸ä¹…ä»£ã€‚jdk8å¼€å§‹ï¼Œä½¿ç”¨å…ƒç©ºé—´å–ä»£äº†æ°¸ä¹…ä»£ã€‚</p>
<p>JDK8åï¼Œå…ƒç©ºé—´å­˜æ”¾åœ¨å †å¤–å†…å­˜ä¸­</p>
<p>æœ¬è´¨ä¸Šï¼Œæ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£å¹¶ä¸ç­‰ä»·ã€‚ä»…æ˜¯å¯¹hotspotè€Œè¨€çš„ã€‚ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹å¦‚ä½•å®ç°æ–¹æ³•åŒºï¼Œä¸åšç»Ÿä¸€è¦æ±‚ã€‚ä¾‹å¦‚ï¼šBEAJRockit / IBM J9 ä¸­ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„æ¦‚å¿µã€‚</p>
<p>è€Œåˆ°äº†JDK8ï¼Œç»ˆäºå®Œå…¨åºŸå¼ƒäº†æ°¸ä¹…ä»£çš„æ¦‚å¿µï¼Œæ”¹ç”¨ä¸JRockitã€J9ä¸€æ ·åœ¨æœ¬åœ°å†…å­˜ä¸­å®ç°çš„å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰æ¥ä»£æ›¿ã€‚</p>
<p>å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´ä¸åœ¨è™šæ‹Ÿæœºè®¾ç½®çš„å†…å­˜ä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚</p>
<p>æ°¸ä¹…ä»£ã€å…ƒç©ºé—´äºŒè€…å¹¶ä¸åªæ˜¯åå­—å˜äº†ï¼Œå†…éƒ¨ç»“æ„ä¹Ÿè°ƒæ•´äº†ã€‚</p>
<p>æ ¹æ®ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„è§„å®šï¼Œå¦‚æœæ–¹æ³•åŒºæ— æ³•æ»¡è¶³æ–°çš„å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œå°†æŠ›å‡ºOOMå¼‚å¸¸ã€‚</p>
<h2 id="8-2-âš™ï¸è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM"><a href="#8-2-âš™ï¸è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM" class="headerlink" title="8.2 âš™ï¸è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM"></a>8.2 âš™ï¸è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM</h2><p>æ–¹æ³•åŒºçš„å¤§å°æ˜¯ä¸å¿…å›ºå®šçš„ï¼ŒJVMå¯ä»¥æ ¹æ®åº”ç”¨çš„éœ€è¦åŠ¨æ€è°ƒæ•´ã€‚</p>
<blockquote>
<p>7ï¸âƒ£ JDK7ä»¥å‰</p>
</blockquote>
<ul>
<li>-XX:Permsizeï¼šè®¾ç½®æ°¸ä¹…ä»£åˆå§‹åˆ†é…ç©ºé—´ï¼ˆé»˜è®¤å€¼æ˜¯20.75Mï¼‰</li>
<li>-XX:MaxPersizeï¼šè®¾ç½®æ°¸ä¹…ä»£æœ€å¤§åˆ†é…ç©ºé—´ï¼ˆ32ä½æœºå™¨é»˜è®¤æ˜¯64Mï¼Œ64ä½æœºå™¨é»˜è®¤æ˜¯82Mï¼‰</li>
<li>å½“JVMåŠ è½½çš„ç±»ä¿¡æ¯å®¹é‡è¶…è¿‡äº†è¿™ä¸ªå€¼ï¼Œä¼šæŠ¥å¼‚å¸¸OutofMemoryErrorã€‚</li>
</ul>
<blockquote>
<p>8ï¸âƒ£ JDK8ä»¥å</p>
</blockquote>
<ul>
<li>-XX:MetaspaceSizeï¼šè®¾ç½®å…ƒç©ºé—´åˆå§‹åˆ†é…ç©ºé—´</li>
<li>-XX:MaxMetaspaceSizeï¼šè®¾ç½®å…ƒç©ºé—´æœ€å¤§åˆ†é…ç©ºé—´</li>
<li>é»˜è®¤å€¼ä¾èµ–äºå¹³å°ï¼šWindowsä¸‹ï¼Œå…ƒç©ºé—´åˆå§‹ç©ºé—´21Mï¼Œå…ƒç©ºé—´æœ€å¤§ç©ºé—´-1ï¼Œå³æ²¡æœ‰é™åˆ¶ã€‚</li>
<li>ä¸æ°¸ä¹…ä»£ä¸åŒï¼Œå¦‚æœä¸æŒ‡å®šå¤§å°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰çš„å¯ç”¨ç³»ç»Ÿå†…å­˜ã€‚å¦‚æœå…ƒæ•°æ®åŒºå‘ç”Ÿæº¢å‡ºï¼Œè™šæ‹Ÿæœºä¸€æ ·ä¼šæŠ›å‡ºå¼‚å¸¸OutofMemoryErrorã€‚</li>
<li>å¯¹äºä¸€ä¸ª64ä½çš„æœåŠ¡å™¨ç«¯JVMæ¥è¯´ï¼Œå…¶é»˜è®¤çš„-XX:MetaspaceSizeå€¼ä¸º21MBã€‚è¿™å°±æ˜¯åˆå§‹çš„é«˜æ°´ä½çº¿ï¼Œä¸€æ—¦è§¦åŠè¿™ä¸ªæ°´ä½çº¿ï¼ŒFull GCå°†ä¼šè¢«è§¦å‘å¹¶å¸è½½æ²¡ç”¨çš„ç±»ï¼ˆå³è¿™äº›ç±»å¯¹åº”çš„ç±»åŠ è½½å™¨ä¸å†å­˜æ´»ï¼‰ï¼Œç„¶åè¿™ä¸ªé«˜æ°´ä½çº¿å°†ä¼šé‡ç½®ã€‚æ–°çš„é«˜æ°´ä½çº¿çš„å€¼å–å†³äºGCåé‡Šæ”¾äº†å¤šå°‘å…ƒç©ºé—´ã€‚å¦‚æœé‡Šæ”¾çš„ç©ºé—´ä¸è¶³ï¼Œé‚£ä¹ˆåœ¨ä¸è¶…è¿‡MaxMetaspaceSizeæ—¶ï¼Œé€‚å½“æé«˜è¯¥å€¼ï¼›å¦‚æœé‡Šæ”¾ç©ºé—´è¿‡å¤šï¼Œåˆ™é€‚å½“é™ä½è¯¥å€¼ã€‚</li>
<li>å¦‚æœåˆå§‹åŒ–çš„é«˜æ°´ä½çº¿è®¾ç½®è¿‡ä½ï¼Œä¸Šè¿°é«˜æ°´ä½è°ƒæ•´æƒ…å†µä¼šå‘ç”Ÿå¾ˆå¤šæ¬¡ã€‚é€šè¿‡åƒåœ¾å›æ”¶å™¨çš„æ—¥å¿—å¯ä»¥è§‚å¯Ÿåˆ°Full GCå¤šæ¬¡è°ƒç”¨ã€‚ä¸ºäº†é¿å…é¢‘å‘åœ°GCï¼Œå»ºè®®å°†-XX:MetaspaceSizeè®¾ç½®ä¸ºä¸€ä¸ªç›¸å¯¹è¾ƒé«˜çš„å€¼ã€‚</li>
</ul>
<blockquote>
<p>âœ… è§£å†³OOM</p>
</blockquote>
<ol>
<li>è¦è§£å†³OOMå¼‚å¸¸æˆ–è€…heap spaceçš„å¼‚å¸¸ï¼Œä¸€èˆ¬çš„æ‰‹æ®µæ˜¯é¦–å…ˆé€šè¿‡å†…å­˜æ˜ åƒåˆ†æå·¥å…·ï¼ˆå¦‚Eclipse Memory Analyzerï¼‰å¯¹dumpå‡ºæ¥çš„å †è½¬å‚¨å¿«ç…§è¿›è¡Œåˆ†æï¼Œé‡ç‚¹æ˜¯ç¡®è®¤å†…å­˜ä¸­çš„å¯¹è±¡æ˜¯å¦æ˜¯å¿…è¦çš„ï¼Œä¹Ÿå°±æ˜¯è¦åˆ†æ¸…æ¥šåˆ°åº•æ˜¯å‡ºç°äº†å†…å­˜æ³„éœ²ï¼ˆMemory Leakï¼‰è¿˜æ˜¯å†…å­˜æº¢å‡ºï¼ˆMemory Overflowï¼‰ã€‚</li>
<li>å¦‚æœæ˜¯å†…å­˜æ³„éœ²ï¼Œå¯è¿›ä¸€æ­¥é€šè¿‡å·¥å…·æŸ¥çœ‹æ³„éœ²å¯¹è±¡åˆ°GC Rootsçš„å¼•ç”¨é“¾ã€‚äºæ˜¯å°±èƒ½æ‰¾åˆ°æ³„éœ²å¯¹è±¡æ˜¯é€šè¿‡æ€æ ·çš„è·¯å¾„ä¸GC Rootsç›¸å…³è”å¹¶å¯¼è‡´åƒåœ¾æ”¶é›†å™¨æ— æ³•è‡ªåŠ¨å›æ”¶å®ƒä»¬çš„ã€‚æŒæ¡äº†æ³„éœ²å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ï¼Œä»¥åŠGC Rootså¼•ç”¨é“¾çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥æ¯”è¾ƒå‡†ç¡®åœ°å®šä½å‡ºæ³„éœ²ä»£ç çš„ä½ç½®ã€‚</li>
<li>å¦‚æœä¸å­˜åœ¨å†…å­˜æ³„éœ²ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡ç¡®å®éƒ½è¿˜å¿…é¡»å­˜æ´»ç€ï¼Œé‚£å°±åº”å½“æ£€æŸ¥è™šæ‹Ÿæœºçš„å †å‚æ•°ï¼ˆ-Xmxå’Œ-Xmsï¼‰ï¼Œä¸æœºå™¨ç‰©ç†å†…å­˜å¯¹æ¯”çœ‹æ˜¯å¦è¿˜å¯ä»¥è°ƒå¤§ï¼Œä»ä»£ç ä¸Šæ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸäº›å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè¿‡é•¿ã€æŒæœ‰çŠ¶æ€æ—¶é—´è¿‡é•¿çš„æƒ…å†µï¼Œå°è¯•å‡å°‘ç¨‹åºè¿è¡ŒæœŸçš„å†…å­˜æ¶ˆè€—ã€‚</li>
</ol>
<h2 id="8-3-ğŸ“‚æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„"><a href="#8-3-ğŸ“‚æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„" class="headerlink" title="8.3 ğŸ“‚æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„"></a>8.3 ğŸ“‚æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„</h2><blockquote>
<p>ğŸŸ¦ å­˜å‚¨</p>
</blockquote>
<p>å­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰ã€‚</p>
<blockquote>
<p>1ï¸âƒ£ ç±»å‹ä¿¡æ¯</p>
</blockquote>
<p>å¯¹æ¯ä¸ªåŠ è½½çš„ç±»å‹ï¼ˆç±»classã€æ¥å£interfaceã€æšä¸¾enumã€æ³¨è§£annotationï¼‰ï¼ŒJVMå¿…é¡»åœ¨æ–¹æ³•åŒºä¸­å­˜å‚¨ä»¥ä¸‹ç±»å‹ä¿¡æ¯ï¼š</p>
<ul>
<li>è¿™ä¸ªç±»å‹çš„å®Œæ•´æœ‰æ•ˆåç§°ï¼ˆå…¨å=åŒ…å.ç±»åï¼‰</li>
<li>è¿™ä¸ªç±»å‹ç›´æ¥çˆ¶ç±»çš„å®Œæ•´æœ‰æ•ˆå(å¯¹äºinterfaceæˆ–Objectï¼Œéƒ½æ²¡æœ‰çˆ¶ç±»)</li>
<li>è¿™ä¸ªç±»å‹çš„ä¿®é¥°ç¬¦ï¼ˆpublicã€abstractã€finalçš„æŸä¸ªå­é›†ï¼‰</li>
<li>è¿™ä¸ªç±»å‹ç›´æ¥æ¥å£çš„ä¸€ä¸ªæœ‰åºåˆ—è¡¨</li>
</ul>
<blockquote>
<p>2ï¸âƒ£ åŸŸä¿¡æ¯</p>
</blockquote>
<ul>
<li>JVMå¿…é¡»åœ¨æ–¹æ³•åŒºä¿å­˜ç±»å‹çš„æ‰€æœ‰åŸŸç›¸å…³ä¿¡æ¯ä»¥åŠåŸŸçš„å£°æ˜é¡ºåº</li>
<li>åŸŸç›¸å…³ä¿¡æ¯åŒ…æ‹¬ï¼šåŸŸåç§°ã€åŸŸç±»å‹ã€åŸŸä¿®é¥°ç¬¦ï¼ˆpublicã€privateã€protectedã€staticã€finalã€volatileã€transientçš„æŸä¸ªå­é›†ï¼‰</li>
</ul>
<blockquote>
<p>3ï¸âƒ£ æ–¹æ³•ä¿¡æ¯</p>
</blockquote>
<p>JVMå¿…é¡»ä¿å­˜æ‰€æœ‰çš„ä»¥ä¸‹ä¿¡æ¯ä»¥åŠå£°æ˜é¡ºåºï¼š</p>
<ul>
<li>æ–¹æ³•åç§°</li>
<li>æ–¹æ³•çš„è¿”å›ç±»å‹</li>
<li>æ–¹æ³•å‚æ•°çš„æ•°é‡å’Œç±»å‹</li>
<li>æ–¹æ³•çš„ä¿®é¥°ç¬¦ï¼ˆpublicã€privateã€protectedã€staticã€finalã€synchronizedã€nativeã€abstractçš„æŸä¸ªå­é›†ï¼‰</li>
<li>æ–¹æ³•çš„å­—èŠ‚ç ã€æ“ä½œæ•°æ ˆã€å±€éƒ¨å˜é‡è¡¨åŠå¤§å°ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰</li>
<li>å¼‚å¸¸è¡¨ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰<ul>
<li>æ¯ä¸ªå¼‚å¸¸å¤„ç†çš„å¼€å§‹ä½ç½®ã€ç»“æŸä½ç½®ã€ä»£ç å¤„ç†åœ¨ç¨‹åºè®¡æ•°å™¨ä¸­çš„åç§»åœ°å€ã€è¢«æ•è·çš„å¼‚å¸¸ç±»çš„å¸¸é‡æ± ç´¢å¼•</li>
</ul>
</li>
</ul>
<blockquote>
<p>4ï¸âƒ£ static no-finalçš„ç±»å˜é‡</p>
</blockquote>
<ul>
<li>é™æ€å˜é‡å’Œç±»å…³è”åœ¨ä¸€èµ·ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œå®ƒä»¬ç§°ä¸ºç±»æ•°æ®åœ¨é€»è¾‘ä¸Šçš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>ç±»å˜é‡è¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ï¼Œå³ä½¿æ²¡æœ‰ç±»å®ä¾‹æ—¶ä¹Ÿå¯ä»¥è®¿é—®ã€‚</li>
</ul>
<blockquote>
<p>5ï¸âƒ£ static finalçš„å…¨å±€å˜é‡</p>
</blockquote>
<ul>
<li>å…¨å±€å˜é‡åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šè¢«åˆ†é…ã€‚</li>
</ul>
<blockquote>
<p>è¿è¡Œæ—¶å¸¸é‡æ±  ğŸ†š Classæ–‡ä»¶å¸¸é‡æ± </p>
</blockquote>
<ul>
<li>æ–¹æ³•åŒºï¼Œå†…éƒ¨åŒ…å«äº†è¿è¡Œæ—¶å¸¸é‡æ± ã€‚</li>
<li>å­—èŠ‚ç æ–‡ä»¶ï¼Œå†…éƒ¨åŒ…å«äº†Classæ–‡ä»¶å¸¸é‡æ± ã€‚</li>
<li>è¦å¼„æ¸…æ¥šæ–¹æ³•åŒºï¼Œéœ€è¦æ¸…æ¥šClassFileï¼Œå› ä¸ºåŠ è½½ç±»çš„ä¿¡æ¯éƒ½åœ¨æ–¹æ³•åŒºã€‚</li>
<li>éœ€è¦å¼„æ¸…æ¥šæ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œéœ€è¦ç†è§£æ¸…æ¥šClassFileä¸­çš„å¸¸é‡æ± ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“ƒ Classæ–‡ä»¶å¸¸é‡æ± </p>
</blockquote>
<p>classæ–‡ä»¶ä¸­é™¤äº†åŒ…å«ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯å°±æ˜¯å¸¸é‡æ± ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚</p>
<p>å­—é¢é‡å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ã€è¢«å£°æ˜ä¸ºfinalçš„å¸¸é‡å€¼ç­‰ã€‚</p>
<p>ç¬¦å·å¼•ç”¨æ—¶ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ï¼Œç¬¦å·å¯ä»¥æ˜¯ä»»ä½•å½¢å¼çš„å­—é¢é‡ï¼Œåªè¦ä½¿ç”¨æ—¶èƒ½æ— æ­§ä¹‰åœ°å®šä½åˆ°ç›®æ ‡å³å¯ã€‚ä¸€èˆ¬åŒ…æ‹¬ä¸‹é¢ä¸‰ç±»å¸¸é‡ï¼š</p>
<ul>
<li>ç±»å’Œæ¥å£çš„å…¨é™å®šå</li>
<li>å­—æ®µçš„åç§°å’Œæè¿°ç¬¦</li>
<li>æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦</li>
</ul>
<blockquote>
<p>ğŸ“ƒ è¿è¡Œæ—¶å¸¸é‡æ± </p>
</blockquote>
<ul>
<li>è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>å¸¸é‡æ± è¡¨ç¤ºClassæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ä¸ç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚</li>
<li>è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œåœ¨åŠ è½½ç±»å’Œæ¥å£åˆ°è™šæ‹Ÿæœºåï¼Œå°±ä¼šåˆ›å»ºå¯¹åº”çš„è¿è¡Œæ—¶å¸¸é‡æ± ã€‚</li>
<li>JVMä¸ºæ¯ä¸ªå·²åŠ è½½çš„ç±»å‹ï¼ˆç±»æˆ–æ¥å£ï¼‰éƒ½ç»´æŠ¤ä¸€ä¸ªå¸¸é‡æ± ã€‚æ± ä¸­çš„æ•°æ®é¡¹åƒæ•°æ®é¡¹ä¸€æ ·ï¼Œæ˜¯é€šè¿‡ç´¢å¼•è®¿é—®çš„ã€‚</li>
<li>è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å†…å«å¤šç§ä¸åŒçš„å¸¸é‡ï¼ŒåŒ…æ‹¬ç¼–è¯‘æœŸå°±å·²ç»æ˜ç¡®çš„æ•°å€¼å­—é¢é‡ï¼Œä¹ŸåŒ…æ‹¬åˆ°è¿è¡ŒæœŸè§£æåæ‰èƒ½å¤Ÿè·å¾—çš„æ–¹æ³•æˆ–è€…å­—æ®µå¼•ç”¨ã€‚æ­¤æ—¶ä¸å†æ˜¯å¸¸é‡æ± ä¸­çš„ç¬¦å·åœ°å€ï¼Œè¿™é‡Œæ¢ä¸ºçœŸå®åœ°å€ã€‚<ul>
<li>è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œç›¸å¯¹äºClassæ–‡ä»¶å¸¸é‡æ± çš„å¦ä¸€ç§é‡è¦ç‰¹å¾æ˜¯ï¼šå…·å¤‡åŠ¨æ€æ€§ã€‚</li>
</ul>
</li>
<li>è¿è¡Œæ—¶å¸¸é‡æ± ç±»ä¼¼äºä¼ ç»Ÿç¼–ç¨‹è¯­è¨€ä¸­çš„ç¬¦å·è¡¨ï¼Œä½†æ˜¯å®ƒæ‰€åŒ…å«çš„æ•°æ®å´æ¯”ç¬¦å·è¡¨è¦æ›´åŠ ä¸°å¯Œä¸€äº›ã€‚</li>
<li>å½“åˆ›å»ºç±»æˆ–æ¥å£çš„è¿è¡Œæ—¶å¸¸é‡æ± æ—¶ï¼Œå¦‚æœæ„é€ è¿è¡Œæ—¶å¸¸é‡æ± æ‰€éœ€çš„å†…å­˜ç©ºé—´è¶…è¿‡äº†æ–¹æ³•åŒºæ‰€èƒ½æä¾›çš„æœ€å¤§å€¼ï¼Œåˆ™JVMä¼šæŠ›å‡ºOOMå¼‚å¸¸ã€‚</li>
</ul>
<blockquote>
<p>ğŸ”° æ€»ç»“</p>
</blockquote>
<ul>
<li>Classæ–‡ä»¶å¸¸é‡æ± æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™æ¯ä¸ªclasså°±æœ‰çš„ï¼Œå­˜æ”¾çš„æ˜¯å¸¸é‡å’Œç¬¦å·å¼•ç”¨ã€‚</li>
<li>è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯åœ¨ç±»åŠ è½½å®Œæˆä¹‹åï¼Œå°†æ¯ä¸ªClassæ–‡ä»¶å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨å€¼è½¬å­˜åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œ</li>
</ul>
<h2 id="8-4-âŒ¨ï¸-æ–¹æ³•åŒºçš„ä½¿ç”¨ä¸¾ä¾‹"><a href="#8-4-âŒ¨ï¸-æ–¹æ³•åŒºçš„ä½¿ç”¨ä¸¾ä¾‹" class="headerlink" title="8.4 âŒ¨ï¸ æ–¹æ³•åŒºçš„ä½¿ç”¨ä¸¾ä¾‹"></a>8.4 âŒ¨ï¸ æ–¹æ³•åŒºçš„ä½¿ç”¨ä¸¾ä¾‹</h2> <span class="hide-inline"><button type="button" class="hide-button button--animated" style=""> ä¸€ç‚¹å°±çœ‹åˆ°äº†ï¼
  </button><span class="hide-content">æˆ‘ä¸è®¤çœŸï¼Œæ²¡è®°ç¬”è®°ï¼Œçœ‹ä¸‹ä¸€èŠ‚å§ã€‚</span></span>



<h2 id="8-5-ğŸ”­-æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚"><a href="#8-5-ğŸ”­-æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚" class="headerlink" title="8.5 ğŸ”­ æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚"></a>8.5 ğŸ”­ æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚</h2><blockquote>
<p>ã€° å¦‚ä¸‹</p>
</blockquote>
<ol>
<li>é¦–å…ˆæ˜ç¡®ã€‚åªæœ‰HotSpotæ‰æœ‰æ°¸ä¹…ä»£ã€‚BEA JRockitã€IBM J9ç­‰ä¸å­˜åœ¨æ°¸ä¹…ä»£ã€‚åŸåˆ™ä¸Šå¦‚ä½•å®ç°æ–¹æ³•åŒºå±äºè™šæ‹Ÿæœºå®ç°ç»†èŠ‚ï¼Œä¸å—ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ç®¡æŸï¼Œå¹¶ä¸è¦æ±‚ç»Ÿä¸€ã€‚</li>
<li>HotSpotä¸­æ–¹æ³•åŒºçš„å˜åŒ–ï¼š</li>
</ol>
<table>
<thead>
<tr>
<th>ç‰ˆæœ¬</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>JDK1.6åŠä¹‹å‰</td>
<td>æœ‰æ°¸ä¹…ä»£ã€‚é™æ€å˜é‡å­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸Šã€‚</td>
</tr>
<tr>
<td>JDK1.7</td>
<td>æœ‰æ°¸ä¹…ä»£ï¼Œä½†å·²ç»é€æ­¥â€œå»æ°¸ä¹…ä»£â€ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ç§»é™¤ï¼Œä¿å­˜åœ¨å †ä¸­ã€‚</td>
</tr>
<tr>
<td>JDK1.8åŠä¹‹å</td>
<td>æ— æ°¸ä¹…ä»£ï¼Œç±»å‹ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ã€å¸¸é‡ä¿å­˜åœ¨æœ¬åœ°å†…å­˜çš„å…ƒç©ºé—´ï¼Œä½†å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ä»ç„¶åœ¨å †ä¸­ã€‚</td>
</tr>
</tbody></table>
<blockquote>
<p>â“ ä¸ºä»€ä¹ˆæ°¸ä¹…ä»£è¦è¢«å…ƒç©ºé—´æ›¿ä»£</p>
</blockquote>
<p>JRockitæ˜¯å’ŒHotSpotèåˆåçš„ç»“æœï¼Œå› ä¸ºJRockitæ²¡æœ‰æ°¸ä¹…ä»£ï¼Œæ‰€ä»¥ä»–ä»¬ä¸éœ€è¦é…ç½®æ°¸ä¹…ä»£ã€‚</p>
<p>éšç€Java8çš„åˆ°æ¥ï¼ŒHotSpot VMä¸­å†ä¹Ÿè§ä¸åˆ°æ°¸ä¹…ä»£äº†ã€‚ä½†æ˜¯è¿™å¹¶ä¸æ„å‘³ç€ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ä¹Ÿæ¶ˆå¤±äº†ã€‚è¿™äº›æ•°æ®è¢«ç§»åˆ°äº†ä¸€ä¸ªä¸å †ä¸ç›¸è¿çš„æœ¬åœ°å†…å­˜åŒºåŸŸï¼Œè¿™ä¸ªåŒºåŸŸå«åšå…ƒç©ºé—´ï¼ˆMetaspaceï¼‰ã€‚</p>
<p>ç”±äºç±»çš„å…ƒæ•°æ®åˆ†é…åœ¨æœ¬åœ°å†…å­˜ä¸­ã€‚å…ƒç©ºé—´çš„æœ€å¤§å¯åˆ†é…ç©ºé—´å°±æ˜¯ç³»ç»Ÿå¯ç”¨å†…å­˜ç©ºé—´ï¼Œè¿™é¡¹æ”¹åŠ¨æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼ŒåŸå› æœ‰ï¼š</p>
<p>ï¼ˆ1ï¼‰ä¸ºæ°¸ä¹…ä»£è®¾ç½®ç©ºé—´å¤§å°æ˜¯å¾ˆéš¾ç¡®å®šçš„ã€‚</p>
<p>åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¦‚æœåŠ¨æ€åŠ è½½ç±»è¿‡å¤šï¼Œå®¹æ˜“äº§ç”ŸPermåŒºï¼ˆæ°¸ä¹…ä»£ï¼‰çš„OOMã€‚</p>
<p>å…ƒç©ºé—´å’Œæ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ã€‚</p>
<p>ï¼ˆ2ï¼‰å¯¹æ°¸ä¹…ä»£è¿›è¡Œè°ƒä¼˜æ˜¯å¾ˆå›°éš¾çš„ã€‚</p>
<p>ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹æ–¹æ³•åŒºçš„çº¦æŸæ˜¯éå¸¸å®½æ¾çš„ï¼Œæåˆ°è¿‡å¯ä»¥ä¸è¦æ±‚è™šæ‹Ÿæœºåœ¨æ–¹æ³•åŒºä¸­å®ç°åƒåœ¾æ”¶é›†ã€‚äº‹å®ä¸Šä¹Ÿç¡®å®æœ‰æœªå®ç°æˆ–æœªèƒ½å®Œæ•´å®ç°æ–¹æ³•åŒºç±»å‹å¸è½½çš„æ”¶é›†å™¨å­˜åœ¨ï¼ˆå¦‚JDK11æ—¶æœŸçš„ZGCæ”¶é›†å™¨å°±ä¸æ”¯æŒç±»å¸è½½ï¼‰ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´è¿™ä¸ªåŒºåŸŸçš„å›æ”¶æ•ˆæœæ¯”è¾ƒä»¤äººéš¾ä»¥æ»¡æ„ï¼Œå°¤å…¶æ˜¯ç±»å‹çš„å¸è½½ï¼Œæ¡ä»¶ç›¸å½“è‹›åˆ»ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†åŒºåŸŸçš„å›æ”¶æœ‰æ—¶åˆç¡®å®æ˜¯å¿…è¦çš„ã€‚ä»¥å‰Sunå…¬å¸çš„Bugåˆ—è¡¨ä¸­ï¼Œæ›¾å‡ºç°è¿‡çš„è‹¥å¹²ä¸ªä¸¥é‡çš„Bugå°±æ˜¯ç”±äºä½ç‰ˆæœ¬çš„HotSpotè™šæ‹Ÿæœºå¯¹æ­¤åŒºåŸŸæœªå®Œå…¨å›æ”¶è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<p>æ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦æ”¶é›†ä¸¤éƒ¨åˆ†å†…å®¹ï¼šå¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ä½¿ç”¨çš„ç±»å‹ã€‚</p>
<blockquote>
<p>â“ ä¸ºä»€ä¹ˆStringTableè°ƒæ•´ä½ç½®</p>
</blockquote>
<p>JDK7ä¸­å°†StringTableæ”¾åˆ°äº†å †ç©ºé—´ä¸­ã€‚å› ä¸ºæ°¸ä¹…ä»£çš„å›æ”¶æ•ˆç‡å¾ˆä½ï¼Œåœ¨full gcçš„æ—¶å€™æ‰ä¼šè§¦å‘ã€‚è€Œfull gcæ˜¯è€å¹´ä»£çš„ç©ºé—´ä¸è¶³ã€æ°¸ä¹…ä»£ä¸è¶³æ—¶æ‰ä¼šè§¦å‘ï¼Œè¿™å°±å¯¼è‡´StringTableå›æ”¶æ•ˆç‡ä¸é«˜ã€‚</p>
<p>è€Œæˆ‘ä»¬å¼€å‘ä¸­ä¼šæœ‰å¤§é‡çš„å­—ç¬¦ä¸²è¢«åˆ›å»ºï¼Œå›æ”¶æ•ˆç‡ä½ï¼Œå¯¼è‡´æ°¸ä¹…ä»£å†…å­˜ä¸è¶³ã€‚æ”¾åˆ°å †é‡Œï¼Œèƒ½åŠæ—¶å›æ”¶å†…å­˜ã€‚</p>
<h2 id="8-6-â™»-æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶"><a href="#8-6-â™»-æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶" class="headerlink" title="8.6 â™» æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶"></a>8.6 â™» æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶</h2><blockquote>
<p>ğŸ“– æ¦‚è¿°</p>
</blockquote>
<ul>
<li>åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦åºŸå¼ƒè¿˜æ˜¯ç›¸å¯¹ç®€å•ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»å‹æ˜¯å¦å±äºâ€œä¸å†è¢«ä½¿ç”¨çš„ç±»â€çš„æ¡ä»¶å°±æ¯”è¾ƒè‹›åˆ»äº†ã€‚éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ï¼š</li>
</ul>
<ol>
<li><ol>
<li>è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯Javaå †ä¸­ä¸å­˜åœ¨è¯¥ç±»åŠå…¶ä»»ä½•æ´¾ç”Ÿå­ç±»çš„å®ä¾‹ã€‚</li>
<li>åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶ï¼Œè¿™ä¸ªæ¡ä»¶é™¤éæ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„å¯æ›¿æ¢ç±»åŠ è½½å™¨çš„åœºæ™¯ï¼Œå¦‚OSGIã€JSPçš„é‡åŠ è½½ç­‰ï¼Œå¦åˆ™é€šå¸¸æ˜¯å¾ˆéš¾è¾¾æˆçš„ã€‚</li>
<li>è¯¥ç±»å¯¹åº”çš„java.lang.Classå¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹åŒ–è¢«å¼•ç”¨ï¼Œæ— æ³•å†ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚</li>
</ol>
</li>
</ol>
<ul>
<li>Javaè™šæ‹Ÿæœºè¢«å…è®¸å¯¹æ»¡è¶³ä¸Šè¿°æ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œè¢«å…è®¸â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ï¼Œæ²¡æœ‰å¼•ç”¨äº†å°±å¿…ç„¶ä¼šå›æ”¶ã€‚å…³äºæ˜¯å¦è¦å¯¹ç±»å‹è¿›è¡Œå›æ”¶ï¼ŒHotSpotè™šæ‹Ÿæœºæä¾›äº†-Xnoclassgcå‚æ•°è¿›è¡Œæ§åˆ¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨-verbose:classä»¥åŠ-XX:+TranClass-Loadingã€-XX:+TraceClassUnLoadingæŸ¥çœ‹ç±»åŠ è½½å’Œå¸è½½ä¿¡æ¯ã€‚</li>
<li>åœ¨å¤§é‡ä½¿ç”¨åå°„ã€åŠ¨æ€ä»£ç†ã€CGLIBç­‰å­—èŠ‚ç æ¡†æ¶ï¼ŒåŠ¨æ€ç”ŸæˆJSPä»¥åŠOSGIè¿™ç±»é¢‘ç¹è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„åœºæ™¯ä¸­ï¼Œé€šå¸¸éƒ½éœ€è¦Javaè™šæ‹Ÿæœºå…·å¤‡ç±»å‹å¸è½½èƒ½åŠ›ï¼Œä»¥ä¿è¯ä¸ä¼šå¯¹æ–¹æ³•åŒºé€ æˆè¿‡å¤§çš„å†…å­˜å‹åŠ›ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-9(å¯¹è±¡)</title>
    <url>/posts/37633/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="9-1-ğŸ¤¦â€â™‚ï¸å¯¹è±¡å®ä¾‹åŒ–"><a href="#9-1-ğŸ¤¦â€â™‚ï¸å¯¹è±¡å®ä¾‹åŒ–" class="headerlink" title="9.1 ğŸ¤¦â€â™‚ï¸å¯¹è±¡å®ä¾‹åŒ–"></a>9.1 ğŸ¤¦â€â™‚ï¸å¯¹è±¡å®ä¾‹åŒ–</h2><blockquote>
<p>ğŸ“· æ€ç»´å¯¼å›¾</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37633/image-20210518160044708.png" class="" title="image-20210518160044708"><br />



<blockquote>
<p>âŒ¨ï¸ å¯¹è±¡åˆ›å»ºä¸»æµæ–¹å¼</p>
</blockquote>
<p>å®ä½“ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.easy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span> </span><br><span class="line"><span class="meta">@AllArgsConstructor</span> </span><br><span class="line"><span class="meta">@NoArgsConstructor</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoData</span> <span class="keyword">implements</span> <span class="title">Serializable</span>, <span class="title">Cloneable</span> </span>&#123; </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> String stringData; </span><br><span class="line">    <span class="keyword">private</span> Date dateData; </span><br><span class="line">    <span class="keyword">private</span> Integer intData; </span><br><span class="line">    <span class="keyword">private</span> Double douData; </span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.clone(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@org</span>.junit.Test</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClass</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException, CloneNotSupportedException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1 new</span></span><br><span class="line">    DemoData demoData1 = <span class="keyword">new</span> DemoData(<span class="string">&quot;1-start&quot;</span>, <span class="keyword">new</span> Date(), <span class="number">1</span>, <span class="number">0.1</span>);</span><br><span class="line">    System.out.println(demoData1.toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2 åå°„</span></span><br><span class="line">    Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;top.parak.easy.DemoData&quot;</span>);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨Class.newInstance()åˆ›å»º</span></span><br><span class="line">    DemoData demoData2 = (DemoData) clazz.newInstance();</span><br><span class="line">    demoData2.setStringData(<span class="string">&quot;2-start&quot;</span>);</span><br><span class="line">    demoData2.setDateData(<span class="keyword">new</span> Date());</span><br><span class="line">    demoData2.setIntData(<span class="number">2</span>);</span><br><span class="line">    demoData2.setDouData(<span class="number">0.2</span>);</span><br><span class="line">    System.out.println(demoData2.toString());</span><br><span class="line">    <span class="comment">// ä½¿ç”¨Constructor.newInstance()åˆ›å»º</span></span><br><span class="line">    Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(String.class, Date.class, Integer.class, Double.class);</span><br><span class="line">    DemoData demoData3 = (DemoData) constructor.newInstance(<span class="string">&quot;3-start&quot;</span>, <span class="keyword">new</span> Date(), <span class="number">3</span>, <span class="number">0.3</span>);</span><br><span class="line">    System.out.println(demoData3.toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3 clone</span></span><br><span class="line">    DemoData demoData4 = (DemoData) demoData1.clone();</span><br><span class="line">    demoData4.setStringData(<span class="string">&quot;4-start&quot;</span>);</span><br><span class="line">    demoData4.setIntData(<span class="number">4</span>);</span><br><span class="line">    demoData4.setDouData(<span class="number">0.4</span>);</span><br><span class="line">    System.out.println(demoData4.toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4 Serializable</span></span><br><span class="line">    ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;data.ser&quot;</span>));</span><br><span class="line">    objectOutputStream.writeObject(demoData1);</span><br><span class="line">    objectOutputStream.close();</span><br><span class="line">    ObjectInputStream objectInputStream =<span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">&quot;data.ser&quot;</span>));</span><br><span class="line">    DemoData demoData5 = (DemoData) objectInputStream.readObject();</span><br><span class="line">    demoData5.setStringData(<span class="string">&quot;5-start&quot;</span>);</span><br><span class="line">    demoData5.setIntData(<span class="number">5</span>);</span><br><span class="line">    demoData5.setDouData(<span class="number">0.5</span>);</span><br><span class="line">    System.out.println(demoData5.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DemoData(stringData&#x3D;1-start, dateData&#x3D;Tue Dec 15 20:23:31 CST 2020, intData&#x3D;1, douData&#x3D;0.1)</span><br><span class="line">DemoData(stringData&#x3D;2-start, dateData&#x3D;Tue Dec 15 20:23:31 CST 2020, intData&#x3D;2, douData&#x3D;0.2)</span><br><span class="line">DemoData(stringData&#x3D;3-start, dateData&#x3D;Tue Dec 15 20:23:31 CST 2020, intData&#x3D;3, douData&#x3D;0.3)</span><br><span class="line">DemoData(stringData&#x3D;4-start, dateData&#x3D;Tue Dec 15 20:23:31 CST 2020, intData&#x3D;4, douData&#x3D;0.4)</span><br><span class="line">DemoData(stringData&#x3D;5-start, dateData&#x3D;Tue Dec 15 20:23:31 CST 2020, intData&#x3D;5, douData&#x3D;0.5)</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ğŸ¨ å¯¹è±¡åˆ›å»ºå…­å¤§æ­¥éª¤</p>
</blockquote>
<p>ï¼ˆ1ï¼‰åˆ¤æ–­å¯¹è±¡å¯¹åº”çš„ç±»æ˜¯å¦åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–</p>
<p>è™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡newæŒ‡ä»¤ï¼Œé¦–å…ˆå»æ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°èƒ½å¦åœ¨Metaspaceçš„å¸¸é‡æ± ä¸­å®šä½åˆ°ä¸€ä¸ªç±»çš„ç¬¦åˆå¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»å·²ç»è¢«åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–ï¼ˆå³åˆ¤æ–­ç±»å…ƒä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼‰ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆåœ¨åŒäº²å§”æ´¾æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨å½“å‰ç±»åŠ è½½å™¨ä»¥ClassLoader+åŒ…å+ç±»åä¸ºkeyè¿›è¡ŒæŸ¥æ‰¾å¯¹åº”çš„.classæ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œåˆ™æŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ï¼›å¦‚æœæ‰¾åˆ°åˆ™è¿›è¡Œç±»åŠ è½½ï¼Œå¹¶ç”Ÿæˆå“åº”çš„Classå¯¹è±¡ã€‚</p>
<p>ï¼ˆ2ï¼‰ä¸ºå¯¹è±¡åˆ†é…å†…å­˜</p>
<p>é¦–å…ˆè®¡ç®—å¯¹è±¡å ç”¨ææ¡ˆä»¶çš„å¤§å°ï¼Œæ¥ç€åœ¨å †ä¸­åˆ’åˆ†ä¸€å—å†…å­˜ç»™æ–°å¯¹è±¡ã€‚å¦‚æœå®ä¾‹æˆå‘˜å˜é‡æ˜¯å¼•ç”¨å˜é‡ï¼Œä»…åˆ†é…å¼•ç”¨å˜é‡ç©ºé—´å³å¯ï¼Œå³4ä¸ªå­—èŠ‚ã€‚</p>
<p>å¦‚æœå†…å­˜è§„æ•´ï¼šæŒ‡é’ˆç¢°æ’ã€‚</p>
<p>å¦‚æœå†…å­˜ä¸è§„æ•´ï¼šè™šæ‹Ÿæœºéœ€è¦ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨ï¼Œç©ºé—²åˆ—è¡¨ã€‚</p>
<p>å¦‚æœå†…å­˜æ˜¯è§„æ•´çš„ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°†é‡‡ç”¨æŒ‡é’ˆç¢°æ’æ³•ï¼ˆBump The Pointï¼‰æ¥ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚æ„æ€æ˜¯æ‰€æœ‰ç”¨è¿‡çš„å†…å­˜åœ¨ä¸€è¾¹ï¼Œç©ºé—²çš„å†…å­˜æ”¾å¦å¤–ä¸€è¾¹ï¼Œä¸­é—´æ”¾ç€ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºåˆ†ç•Œç‚¹çš„æŒ‡ç¤ºå™¨ï¼Œåˆ†é…å†…å­˜å°±ä»…ä»…æ˜¯æŠŠæŒ‡é’ˆæŒ‡å‘ç©ºé—²é‚£è¾¹æŒªåŠ¨ä¸€æ®µä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»ç½¢äº†ã€‚å¦‚æœåƒåœ¾æ”¶é›†å™¨é€‰æ‹©çš„æ˜¯Serialï¼ŒParNewè¿™ç§åŸºäºå‹ç¼©ç®—æ³•çš„ï¼Œè™šæ‹Ÿæœºé‡‡ç”¨è¿™ç§åˆ†é…æ–¹å¼ã€‚ä¸€èˆ¬ä½¿ç”¨å¸¦Compactï¼ˆæ•´ç†ï¼‰è¿‡ç¨‹çš„æ”¶é›†å™¨æ—¶ï¼Œä½¿ç”¨æŒ‡é’ˆç¢°æ’ã€‚</p>
<p>å¦‚æœå†…å­˜æ˜¯ä¸è§„æ•´çš„ï¼Œå·²ä½¿ç”¨å†…å­˜å’Œæœªä½¿ç”¨çš„å†…å­˜ç›¸äº’äº¤é”™ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°†é‡‡ç”¨çš„æ˜¯ç©ºé—²åˆ—è¡¨æ¥ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚æ„æ€æ˜¯è™šæ‹Ÿæœºç»´æŠ¤äº†ä¸€ä¸ªåˆ—è¡¨ï¼Œè®°å½• ä¸Šé‚£äº›å†…å­˜å—æ˜¯å¯ç”¨çš„ï¼Œå†åˆ†é…çš„æ—¶å€™ä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´åˆ’åˆ†ç»™å¯¹è±¡å®ä¾‹ï¼Œå¹¶æ›´æ–°åˆ—è¡¨ä¸Šçš„å†…å®¹ã€‚è¿™ç§åˆ†é…æ–¹å¼æˆä¸ºäº†â€œç©ºé—²åˆ—è¡¨â€ã€‚</p>
<p>é€‰æ‹©å“ªç§åˆ†é…æ–¹å¼ç”±Javaå †æ˜¯å¦è§„æ•´æ‰€å†³å®šï¼Œè€ŒJavaå †æ˜¯å¦è§„æ•´åˆç”±æ‰€é‡‡ç”¨çš„åƒåœ¾æ”¶é›†å™¨æ˜¯å¦å¸¦æœ‰å‹ç¼©æ•´ç†åŠŸèƒ½å†³å®šã€‚</p>
<p>ï¼ˆ3ï¼‰å¤„ç†å¹¶å‘å®‰å…¨é—®é¢˜</p>
<p>åœ¨åˆ†é…å†…å­˜ç©ºé—´æ—¶ï¼Œå¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯åŠæ—¶ä¿è¯newå¯¹è±¡æ—¶å€™çš„çº¿ç¨‹å®‰å…¨æ€§ï¼šåˆ›å»ºå¯¹è±¡æ˜¯éå¸¸é•¿é¢‘ç¹çš„æ“ä½œï¼Œè™šæ‹Ÿæœºéœ€è¦è§£å†³å¹¶å‘é—®é¢˜ã€‚è™šæ‹Ÿæœºé‡‡ç”¨ä¸¤ç§æ–¹å¼è§£å†³å¹¶å‘é—®é¢˜ï¼š</p>
<ul>
<li><p>CAS(Compare And Swap)å¤±è´¥é‡è¯• ã€åŒºåŸŸåŠ é”ï¼šä¿è¯æŒ‡é’ˆæ›´æ–°æ“ä½œçš„åŸå­æ€§ï¼›</p>
</li>
<li><p>æ¯ä¸ªçº¿ç¨‹é¢„å…ˆåˆ†é…ä¸€å—TLAB(æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²åŒº)ï¼Œæ˜¯å¦ä½¿ç”¨TLABé€šè¿‡-XX:+/-UseTLABå‚æ•°æ¥è®¾å®šã€‚</p>
</li>
</ul>
<p>ï¼ˆ4ï¼‰åˆå§‹åŒ–åˆ†é…åˆ°çš„ç©ºé—´</p>
<p>å†…å­˜åˆ†é…ç»“æŸï¼Œè™šæ‹Ÿæœºå°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–ä¸ºé›¶å€¼ã€‚è¿™ä¸€æ­¥ä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µåœ¨Javaä»£ç ä¸­å¯ä»¥ä¸ç”¨èµ‹åˆå§‹å€¼å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œç¨‹åºèƒ½è®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼ã€‚</p>
<p>ç»™å¯¹è±¡å±æ€§èµ‹å€¼çš„æ“ä½œï¼š</p>
<ul>
<li>å±æ€§çš„é»˜è®¤åˆå§‹åŒ–</li>
<li>æ˜¾ç¤ºåˆå§‹åŒ–</li>
<li>ä»£ç å—ä¸­çš„åˆå§‹åŒ–</li>
<li>æ„é€ å™¨åˆå§‹åŒ–</li>
<li>æ‰€æœ‰å±æ€§è®¾ç½®é»˜è®¤å€¼ï¼Œä¿è¯å¯¹è±¡å®ä¾‹å­—æ®µåœ¨ä¸èµ‹å€¼çš„æƒ…å†µä¸‹å¯ä»¥ç›´æ¥ä½¿ç”¨</li>
</ul>
<p>ï¼ˆ5ï¼‰è®¾ç½®å¯¹è±¡çš„å¯¹è±¡å¤´</p>
<p>å°†å¯¹è±¡çš„æ‰€å±ç±»ï¼ˆå³ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ï¼‰ã€å¯¹è±¡çš„HashCodeå’Œå¯¹è±¡çš„GCä¿¡æ¯ã€é”ä¿¡æ¯ç­‰æ•°æ®å­˜å‚¨åœ¨å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹çš„å…·ä½“è®¾ç½®æ–¹å¼å–å†³äºJVMå®ç°ã€‚</p>
<p>ï¼ˆ6ï¼‰æ‰§è¡Œinitæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–</p>
<p>åœ¨Javaç¨‹åºçš„è§†è§’æ¥çœ‹ï¼Œåˆå§‹åŒ–æ‰æ­£å¼å¼€å§‹ã€‚åˆå§‹åŒ–æˆå‘˜å˜é‡ï¼Œæ‰§è¡Œå®ä¾‹åŒ–ä»£ç å—ï¼Œè°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•ï¼Œå¹¶æŠŠå †å†…å¯¹è±¡çš„é¦–åœ°å€å¤åˆ¶ç»™å¼•ç”¨å˜é‡ã€‚</p>
<p>å› æ­¤ä¸€èˆ¬æ¥è¯´ï¼ˆç”±å­—èŠ‚ç ä¸­è·ŸéšinvokespecialæŒ‡ä»¤æ‰€å†³å®šï¼‰ï¼ŒnewæŒ‡ä»¤ä¹‹åå°±æ˜¯æ‰§è¡Œæ–¹æ³•ï¼ŒæŠŠå¯¹è±¡æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·ä¸€ä¸ªçœŸæ­£å¯ç”¨çš„å¯¹è±¡æ‰ç®—å®Œæ•´åˆ›å»ºå‡ºæ¥ã€‚</p>
<h2 id="9-2-ğŸ”³-å¯¹è±¡å†…å­˜å¸ƒå±€"><a href="#9-2-ğŸ”³-å¯¹è±¡å†…å­˜å¸ƒå±€" class="headerlink" title="9.2 ğŸ”³ å¯¹è±¡å†…å­˜å¸ƒå±€"></a>9.2 ğŸ”³ å¯¹è±¡å†…å­˜å¸ƒå±€</h2><blockquote>
<p>ğŸ“· æ€ç»´å¯¼å›¾</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37633/image-20210518160117665.png" class="" title="image-20210518160117665"><br />



<p>æ™®é€šå¯¹è±¡ Object Headerï¼ˆ64 bitsï¼‰</p>
<table>
<thead>
<tr>
<th>Mark Wordï¼ˆ32 bitsï¼‰</th>
<th>Class Pointerï¼ˆ32 bitsï¼‰</th>
</tr>
</thead>
</table>
<p>æ•°ç»„å¯¹è±¡ Object Headerï¼ˆ96 bitsï¼‰</p>
<table>
<thead>
<tr>
<th>Mark Wordï¼ˆ32 bitsï¼‰</th>
<th>Class Pointerï¼ˆ32 bitsï¼‰</th>
</tr>
</thead>
</table>
<p>å…¶ä¸­Mark Wordç»“æ„ï¼Œåœ¨æ­£å¸¸æ— é”çŠ¶æ€ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>hashcode ï¼ˆ25 bitsï¼‰</th>
<th>gc ageï¼ˆ4 bitsï¼‰</th>
<th>biased_lock ï¼ˆ1 bitsï¼‰</th>
<th>lock state ï¼ˆ2 bitsï¼‰</th>
</tr>
</thead>
</table>
<h2 id="9-3-ğŸ›°ï¸-å¯¹è±¡è®¿é—®å®šä½"><a href="#9-3-ğŸ›°ï¸-å¯¹è±¡è®¿é—®å®šä½" class="headerlink" title="9.3 ğŸ›°ï¸ å¯¹è±¡è®¿é—®å®šä½"></a>9.3 ğŸ›°ï¸ å¯¹è±¡è®¿é—®å®šä½</h2><blockquote>
<p>â” JVMæ˜¯å¦‚ä½•é€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨è®¿é—®åˆ°å…¶å†…éƒ¨çš„å¯¹è±¡å®ä¾‹çš„å‘¢ï¼Ÿ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37633/image-20210307115251686.png" class="" title="image-20210307115251686"><br />



<blockquote>
<p>1ï¸âƒ£ å¥æŸ„è®¿é—®</p>
</blockquote>
<p>æ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œè®°å½•çš„å¯¹è±¡çš„å¼•ç”¨ï¼Œç„¶ååœ¨å †ç©ºé—´ä¸­å¼€è¾Ÿäº†ä¸€å—ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯å¥æŸ„æ± ã€‚</p>
<p>ä¼˜ç‚¹ï¼šreferenceä¸­å­˜å‚¨ç¨³å®šå¥æŸ„åœ°å€ï¼Œå¯¹è±¡è¢«ç§»åŠ¨ï¼ˆåƒåœ¾æ”¶é›†æ—¶ç§»åŠ¨å¯¹è±¡å¾ˆæ™®éï¼‰æ—¶åªä¼šæ”¹å˜å¥æŸ„ä¸­å®ä¾‹æ•°æ®æŒ‡é’ˆå³å¯ï¼Œreferenceæœ¬èº«ä¸éœ€è¦è¢«ä¿®æ”¹ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37633/image-20210307120509642.png" class="" title="image-20210307120509642"><br />





<blockquote>
<p>2ï¸âƒ£ ç›´æ¥æŒ‡é’ˆ</p>
</blockquote>
<p>ç›´æ¥æŒ‡é’ˆæ˜¯å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¼•ç”¨ï¼Œç›´æ¥æŒ‡å‘å †ä¸­çš„å®ä¾‹ï¼Œåœ¨å¯¹è±¡å®ä¾‹ä¸­æœ‰ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯æ–¹æ³•åŒºä¸­çš„å¯¹è±¡ç±»å‹æ•°æ®ã€‚</p>
<p>å¥½å¤„ï¼šèŠ‚çœç©ºé—´ï¼Œé€Ÿåº¦æ›´å¿«ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37633/image-20210307120911877.png" class="" title="image-20210307120911877"><br />

]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JWT</title>
    <url>/posts/1bb08f7a/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ğŸ“–-å®˜æ–¹æ–‡æ¡£"><a href="#ğŸ“–-å®˜æ–¹æ–‡æ¡£" class="headerlink" title="ğŸ“– å®˜æ–¹æ–‡æ¡£"></a>ğŸ“– å®˜æ–¹æ–‡æ¡£</h2><blockquote>
<p>ğŸŒå®˜æ–¹æ–‡æ¡£</p>
</blockquote>
<p><a href="https://jwt.io/introduction/">JWT.IO</a></p>
<blockquote>
<p>ğŸ’°JWTæ¦‚è¿°</p>
</blockquote>
<p><strong>JSON Web Token</strong>æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘ä¸”åŒ…å«çš„æ–¹å¼ï¼Œç”¨äºåœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ä½œä¸ºJSONå¯¹è±¡ã€‚ç”±äºæ­¤ä¿¡æ¯æ˜¯ç»è¿‡æ•°å­—ç­¾åçš„ï¼Œç”¨äºåœ¨å„æ–¹é¢ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ä½œä¸ºJSONå¯¹è±¡ã€‚ç”±äºæ­¤ä¿¡æ¯æ˜¯ç»è¿‡æ•°å­—ç­¾ååœ°ï¼Œå› æ­¤å¯ä»¥è¢«éªŒè¯å’Œä¿¡ä»»ã€‚å¯ä»¥ä½¿ç”¨ç§˜å¯†ï¼ˆæˆ–è€…<strong>HMAC</strong>ç®—æ³•ï¼‰æˆ–ä½¿ç”¨<strong>RSA</strong>æˆ–<strong>ECDSA</strong>çš„å…¬é’¥/ç§é’¥å¯¹å¯¹JWTè¿›è¡Œç­¾åã€‚</p>
<p>å°½ç®¡å¯ä»¥å¯¹JWTè¿›è¡ŒåŠ å¯†ä»¥æä¾›åŒæ–¹ä¹‹é—´çš„ä¿å¯†æ€§ï¼Œä½†æˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨å·²ç­¾åçš„ä»¤ç‰Œã€‚ç­¾åçš„ä»¤ç‰Œå¯ä»¥éªŒè¯å…¶ä¸­åŒ…å«çš„å£°æ˜çš„å®Œæ•´æ€§ï¼Œè€ŒåŠ å¯†çš„ä»¤ç‰Œåˆ™å°†è¿™äº›å£°æ˜éšè—åœ¨å…¶ä»–æ–¹çš„é¢å‰ã€‚å½“ä½¿ç”¨å…¬é’¥/ç§é’¥å¯¹å¯¹ä»¤ç‰Œè¿›è¡Œç­¾åæ—¶ï¼Œç­¾åè¿˜è¯æ˜åªæœ‰æŒæœ‰ç§é’¥çš„ä¸€æ–¹æ‰æ˜¯å¯¹å…¶è¿›è¡Œç­¾åçš„ä¸€æ–¹ã€‚</p>
<br>



<blockquote>
<p>ğŸ”±åº”ç”¨åœºæ™¯</p>
</blockquote>
<ul>
<li>æˆæƒè®¤è¯ï¼šä½¿ç”¨JWTçš„æœ€å¸¸è§æ–¹æ¡ˆã€‚ä¸€æ—¦ç”¨æˆ·ç™»å½•ï¼Œæ¯ä¸ªåç»­è¯·æ±‚å°†åŒ…æ‹¬ä»¤ç‰Œï¼Œä»è€Œå…è®¸ç”¨æˆ·è®¿é—®è¯¥ä»¤ç‰Œå…è®¸çš„è·¯ç”±ã€æœåŠ¡å’Œèµ„æºã€‚å•ç‚¹ç™»å½•æ˜¯å½“ä»Šå¹¿æ³›ä½¿ç”¨JWTçš„ä¸€é¡¹åŠŸèƒ½ï¼Œå› ä¸ºå®ƒçš„å¼€é”€å¾ˆå°å¹¶ä¸”å¯ä»¥åœ¨ä¸åŒçš„åŸŸä¸­è½»æ¾ä½¿ç”¨ã€‚</li>
<li>ä¿¡æ¯äº¤æ¢ï¼šJWTæ˜¯åœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯çš„ä¸€ç§å¥½æ–¹æ³•ã€‚å› ä¸ºå¯ä»¥å¯¹JWTè¿›è¡Œç­¾åï¼Œä¾‹å¦‚ä½¿ç”¨å…¬é’¥/ç§é’¥å¯¹ã€‚æ­¤å¤–ã€‚ç”±äºç­¾åæ˜¯ä½¿ç”¨æ ‡å¤´å’Œæœ‰æ•ˆè´Ÿè½½è®¡ç®—çš„ï¼Œå› æ­¤è¿˜å¯ä»¥éªŒè¯å†…å®¹æ˜¯å¦é­åˆ°ç¯¡æ”¹ã€‚</li>
</ul>
<br>

<h2 id="ğŸš€-è®¤è¯æµç¨‹"><a href="#ğŸš€-è®¤è¯æµç¨‹" class="headerlink" title="ğŸš€ è®¤è¯æµç¨‹"></a>ğŸš€ è®¤è¯æµç¨‹</h2><blockquote>
<p>â›”ï¸sessionè®¤è¯</p>
</blockquote>
<p>ä¼ ç»Ÿæ–¹å¼ï¼šç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚ç™»å½•æ—¶å€™è®¾ç½®sessionï¼Œæ­¤åæ¯æ¬¡è®¿é—®æºå¸¦cookieã€‚</p>
<p>é—®é¢˜ï¼š</p>
<ul>
<li>æ¯ä¸ªç”¨æˆ·ç»è¿‡æˆ‘ä»¬çš„åº”ç”¨è®¤è¯ä¹‹åï¼Œæˆ‘ä»¬çš„åº”ç”¨éƒ½è¦åœ¨æœåŠ¡ç«¯åšä¸€æ¬¡è®°å½•ï¼Œä»¥æ–¹ä¾¿ç”¨æˆ·ä¸‹æ¬¡è¯·æ±‚çš„é‰´åˆ«ï¼Œé€šå¸¸è€Œè¨€sessionéƒ½æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè€Œéšç€ç”¨æˆ·çš„å¢å¤šï¼ŒæœåŠ¡ç«¯çš„å¼€é”€ä¼šæ˜æ˜¾å¢å¤§ã€‚</li>
<li>ç”¨æˆ·è®¤è¯ä¹‹åï¼ŒæœåŠ¡ç«¯åšè®¤è¯è®°å½•ï¼Œå¦‚æœè®¤è¯çš„è®°å½•è¢«ä¿å­˜åœ¨å†…å­˜ä¸­çš„è¯ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·ä¸‹æ¬¡è¯·æ±‚è¿˜å¿…é¡»è¦è¯·æ±‚åœ¨è¿™å°æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·æ‰èƒ½æ‹¿åˆ°æˆæƒçš„èµ„æºï¼Œè¿™æ ·åœ¨åˆ†å¸ƒå¼çš„åº”ç”¨ä¸Šï¼Œç›¸åº”çš„é™åˆ¶äº†è´Ÿè½½å‡è¡¡å™¨çš„èƒ½åŠ›ï¼Œè¿™ä¹Ÿæ„å‘³ç€é™åˆ¶äº†åº”ç”¨çš„æ‰©å±•èƒ½åŠ›ã€‚</li>
<li>å› ä¸ºæ˜¯åŸºäºcookieæ¥è¿›è¡Œç”¨æˆ·è¯†åˆ«çš„ï¼Œcookieå¦‚ä½•è¢«æˆªè·ï¼Œç”¨æˆ·å¾ˆå®¹æ˜“å—åˆ°è·¨ç«™è¯·æ±‚ä¼ªé€ çš„æ”»å‡»ã€‚</li>
</ul>
<br>

<blockquote>
<p>ğŸ”°JWTè®¤è¯</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1bb08f7a/JWT%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B.png" class="" title="JWTè®¤è¯"><br />

<p>è®¤è¯æµç¨‹ï¼š</p>
<p>é¦–å…ˆï¼Œå‰ç«¯é€šè¿‡webè¡¨å•å°†è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç å‘é€åˆ°åç«¯çš„æ¥å£ï¼Œè¿™ä¸€è¿‡ç¨‹ä¸€èˆ¬æ˜¯ä¸€ä¸ªHttp POSTè¯·æ±‚ã€‚</p>
<p>åç«¯æ ¸å¯¹ç”¨æˆ·åå’Œå¯†ç æˆåŠŸåï¼Œå°†ç”¨æˆ·çš„idç­‰å…¶ä»–ä¿¡æ¯ä½œä¸ºJWT payload(è´Ÿè½½)ï¼Œå°†å…¶ä¸å¤´éƒ¨åˆ†åˆ«è¿›è¡ŒBased64ç¼–ç æ‹¼æ¥åç­¾åï¼Œå½¢æˆä¸€ä¸ªJWTã€‚å½¢æˆçš„JWTå°±å½¢åŒxxx.yyy.zzzçš„å­—ç¬¦ä¸²ã€‚</p>
<p>åç«¯å°†JWTå­—ç¬¦ä¸²ä½œä¸ºç™»é™†æˆåŠŸçš„è¿”å›ç»“æœè¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯å¯ä»¥å°†è¿”å›çš„ç»“æœä¿å­˜åœ¨localStorageä¸Šï¼Œé€€å‡ºç™»å½•æ—¶å‰ç«¯åˆ é™¤ä¿å­˜çš„JWTå³å¯ã€‚</p>
<p>å‰ç«¯åœ¨æ¯æ¬¡è¯·æ±‚æ—¶å°†JWTæ”¾å…¥HTTP Headerçš„Authorizationä½ã€‚ï¼ˆè§£å†³XSSå’ŒXSRFé—®é¢˜ï¼‰</p>
<p>åç«¯æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œå¦‚å­˜åœ¨éªŒè¯JWTçš„æœ‰æ•ˆæ€§ã€‚ï¼ˆç­¾åæ˜¯å¦æ­£ç¡®ï¼ŒTokenæ˜¯å¦è¿‡æœŸç­‰ï¼‰</p>
<p>éªŒè¯é€šè¿‡ååç«¯ä½¿ç”¨JWTä¸­åŒ…å«çš„ç”¨æˆ·ä¿¡æ¯è¿›è¡Œå…¶ä»–é€»è¾‘æ“ä½œï¼Œå¹¶è¿”å›ç›¸åº”ç»“æœã€‚</p>
<p>ä¼˜åŠ¿ï¼š</p>
<ul>
<li>ç®€æ´ï¼Œå¯ä»¥é€šè¿‡URLï¼ŒPOSTå‚æ•°æˆ–è€…åœ¨HTTP Headerå‘é€ï¼Œå› ä¸ºæ•°æ®é‡å°ï¼Œä¼ è¾“é€Ÿåº¦ä¹Ÿå¾ˆå¿«</li>
<li>è‡ªåŒ…å«ï¼šè´Ÿè½½ä¸­åŒ…å«äº†æ‰€æœ‰ç”¨æˆ·æ‰€éœ€è¦çš„ä¿¡æ¯ï¼Œé¿å…äº†å¤šæ¬¡æŸ¥è¯¢æ•°æ®åº“</li>
<li>å› ä¸ºTokenæ˜¯JSONåŠ å¯†çš„å½¢å¼ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„ï¼Œæ‰€ä»¥JWTæ˜¯è·¨è¯­è¨€çš„ï¼ŒåŸåˆ™ä¸Šä»»ä½•webå½¢å¼éƒ½æ”¯æŒ</li>
<li>ä¸éœ€è¦å†æœåŠ¡ç«¯ä¿å­˜ä¼šè¯ä¿¡æ¯ï¼Œç‰¹åˆ«é€‚åˆç”¨äºåˆ†å¸ƒå¼å¾®æœåŠ¡</li>
</ul>
<br>

<blockquote>
<p>â›“ä»¤ç‰Œç»“æ„</p>
</blockquote>
<p>JSON Web Tokenä»¥ç´§å‡‘çš„å½¢å¼ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œä¸‰éƒ¨åˆ†ç”±<code>.</code>åˆ†éš”ï¼Œå³<code>xxxxx.yyyyy.zzzzz</code></p>
<ul>
<li><p>æ ‡å¤´(Header)  : Base64ç¼–ç ï¼Œç”±ä»¤ç‰Œç±»å‹å’Œç­¾åç®—æ³•ç»„æˆ</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è´Ÿè½½(Payload) : Base64ç¼–ç ï¼Œç”¨äºæ”¾ç½®æºå¸¦ä¿¡æ¯ï¼Œä¸èƒ½æ”¾æ•æ„Ÿä¿¡æ¯</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Khighness&quot;</span></span><br><span class="line">    <span class="string">&quot;admin&quot;</span>:<span class="literal">true</span></span><br><span class="line">    <span class="string">&quot;gender&quot;</span>:<span class="string">&quot;male&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç­¾å(Signature) : å¯¹æ ‡å¤´å’Œè´Ÿè½½è¿›è¡Œç­¾åï¼Œé˜²æ­¢å†…å®¹è¢«ç¯¡æ”¹</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">HMACSHA256(baseUrlEncode(header)) + &quot;.&quot; + base64UrlEncode(payload).secret)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<br>

<h2 id="ğŸ’»-JWT-Demo"><a href="#ğŸ’»-JWT-Demo" class="headerlink" title="ğŸ’» JWT-Demo"></a>ğŸ’» JWT-Demo</h2><blockquote>
<p>â•æ·»åŠ ä¾èµ–</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- JWT --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jwt.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<br>

<blockquote>
<p>ğŸ“‘Javaä»£ç </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">generateToken</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">    HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    Calendar calendar = Calendar.getInstance();</span><br><span class="line">    calendar.add(Calendar.SECOND, <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">    String token = JWT.create()</span><br><span class="line">            .withHeader(map)                                     <span class="comment">// Header</span></span><br><span class="line">            .withClaim(<span class="string">&quot;userID&quot;</span>, <span class="number">1011</span>)              <span class="comment">// Payload</span></span><br><span class="line">            .withClaim(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;KHighness&quot;</span>)</span><br><span class="line">            .withExpiresAt(calendar.getTime())                  <span class="comment">// æŒ‡å®šä»¤ç‰Œè¿‡æœŸæ—¶é—´: 60S</span></span><br><span class="line">            .sign(Algorithm.HMAC256(<span class="string">&quot;PARAK&quot;</span>));                 <span class="comment">// Signatureï¼Œè®¾ç½®å¯†é’¥PARAK</span></span><br><span class="line"></span><br><span class="line">    System.out.println(token);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;éªŒè¯ä»¤ç‰Œ&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">verifyToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JWTVerifier jwtVerifier = JWT.require(Algorithm.HMAC512(<span class="string">&quot;PARAK&quot;</span>)).build();</span><br><span class="line">    String token = <span class="string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2MDU5NDU0ODQsInVzZXJJRCI6MTAxMSwidXNlcm5hbWUiOiJLSGlnaG5lc3MifQ.Gvwa3vu_LYogcEPFxKOgFgaH6WnTKoo-UDW977W1GAw&quot;</span>;</span><br><span class="line">    DecodedJWT verify = jwtVerifier.verify(token);</span><br><span class="line">    System.out.println(verify.getClaim(<span class="string">&quot;userID&quot;</span>).asInt());</span><br><span class="line">    System.out.println(verify.getClaim(<span class="string">&quot;username&quot;</span>).asString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<blockquote>
<p>â—ï¸ å¸¸è§å¼‚å¸¸</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å¼‚å¸¸</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">TokenExpiredException</td>
<td align="center">ä»¤ç‰Œè¿‡æœŸå¼‚å¸¸</td>
</tr>
<tr>
<td align="center">SignatureVerificationException</td>
<td align="center">ç­¾åä¸ä¸€è‡´å¼‚å¸¸</td>
</tr>
<tr>
<td align="center">AlgorithmMismatchException</td>
<td align="center">åŠ å¯†ç®—æ³•ä¸åŒ¹é…å¼‚å¸¸</td>
</tr>
<tr>
<td align="center">InvalidClaimException</td>
<td align="center">å¤±æ•ˆçš„è´Ÿè½½å¼‚å¸¸</td>
</tr>
</tbody></table>
<br>

<h2 id="ğŸƒ-æ•´åˆSpringboot"><a href="#ğŸƒ-æ•´åˆSpringboot" class="headerlink" title="ğŸƒ æ•´åˆSpringboot"></a>ğŸƒ æ•´åˆSpringboot</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>ç”¨æˆ·åœ¨ç¬¬ä¸€æ¬¡ç™»é™†çš„æ—¶å€™ï¼Œåå°ç”Ÿæˆtokenè¿”å›ç»™å‰ç«¯å­˜å‚¨åœ¨sessionStorageä¸­ï¼Œæ­¤åæ¯æ¬¡å‰ç«¯éœ€è¦è°ƒç”¨åç«¯éœ€è¦è®¤è¯çš„æ¥å£æ—¶éƒ½æŠŠtokenå–å‡ºæ¥æºå¸¦åœ¨http headerä¸­ã€‚åå°è®¾ç½®æ‹¦æˆªå™¨ï¼Œè®¾ç½®éœ€è¦è®¤è¯æ‰èƒ½è®¿é—®çš„æ¥å£ï¼Œæ¯æ¬¡å¤„ç†è¯·æ±‚æ—¶ï¼Œå…ˆä»requestçš„http headerä¸­å–å‡ºtokenè¿›è¡Œè®¤è¯ï¼Œé€šè¿‡åæ‰è¿›è¡Œç›¸å…³æ¥å£å¤„ç†ã€‚</p>
<br>

<blockquote>
<p>ğŸ”§å°è£…å·¥å…·ç±»</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.auth0.jwt.JWT;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.JWTCreator;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.algorithms.Algorithm;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.interfaces.DecodedJWT;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-11-22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KKJWTUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ç­¾åçš„å¯†é’¥[<span class="doctag">@NAME</span>]&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String secret = <span class="string">&quot;@KHIGHNESS&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ç­¾åçš„è¿‡æœŸæ—¶é—´[A Week]&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> accessTokenExpireTime = <span class="number">604800</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ä»¤ç‰Œé¢å¸ƒè€…èº«ä»½æ ‡è¯†[DOMAIN]&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String issuer = <span class="string">&quot;parak.top&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ç”ŸæˆToken&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chaims</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateToken</span><span class="params">(Map&lt;String, String&gt; chaims)</span> </span>&#123;</span><br><span class="line">        JWTCreator.Builder builder = JWT.create();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* æ·»åŠ è´Ÿè½½ */</span></span><br><span class="line">        chaims.forEach((k, v) -&gt; &#123;</span><br><span class="line">            builder.withClaim(k, v);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* è®¾ç½®è¿‡æœŸæ—¶é—´ */</span></span><br><span class="line">        Calendar calendar = Calendar.getInstance();</span><br><span class="line">        calendar.add(Calendar.SECOND, accessTokenExpireTime);</span><br><span class="line">        builder.withExpiresAt(calendar.getTime());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* è®¾ç½®é¢å‘è€…èº«ä»½ */</span></span><br><span class="line">        builder.withIssuer(issuer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* è®¾ç½®åŠ å¯†ç®—æ³•ä»¥åŠå¯†é’¥ */</span></span><br><span class="line">        String token = builder.sign(Algorithm.HMAC256(secret));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;è§£ætoken&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DecodedJWT <span class="title">verifyToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JWT.require(Algorithm.HMAC256(secret)).build().verify(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<blockquote>
<p>ç”¨æˆ·æ§åˆ¶å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.interfaces.DecodedJWT;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> top.parak.common.KKCondition;</span><br><span class="line"><span class="keyword">import</span> top.parak.common.KKDataResponse;</span><br><span class="line"><span class="keyword">import</span> top.parak.common.KKJWTUtil;</span><br><span class="line"><span class="keyword">import</span> top.parak.entity.User;</span><br><span class="line"><span class="keyword">import</span> top.parak.service.UserService;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.validation.Valid;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-11-19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·æ³¨å†Œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/register&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KKDataResponse <span class="title">register</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        String username = user.getUsername();</span><br><span class="line">        String password = user.getPassword();</span><br><span class="line">        log.info(<span class="string">&quot;ç”¨æˆ·æ³¨å†Œ =&gt; [&#123;&#125;]&quot;</span>, username);</span><br><span class="line">        KKCondition condition = <span class="keyword">new</span> KKCondition();</span><br><span class="line">        condition.setName(username);</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(userService.queryUserInCondition(condition))) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;ç”¨æˆ·å&#123;&#125;å·²è¢«æ³¨å†Œï¼Œä¸å¯é‡å¤æ³¨å†Œ&quot;</span>, username);</span><br><span class="line">            <span class="keyword">return</span> KKDataResponse.errorResponse(<span class="string">&quot;è¯¥ç”¨æˆ·åå·²è¢«æ³¨å†Œï¼Œä¸å¯é‡å¤æ³¨å†Œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userService.saveUser(username, password) == <span class="number">1</span> ? KKDataResponse.successResponse(<span class="keyword">true</span>) : KKDataResponse.errorResponse(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·ç™»å½•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KKDataResponse <span class="title">login</span><span class="params">(<span class="meta">@RequestBody</span> String loginDataJson)</span> </span>&#123;</span><br><span class="line">        JSONObject loginData = JSON.parseObject(loginDataJson);</span><br><span class="line">        String username = loginData.get(<span class="string">&quot;username&quot;</span>).toString();</span><br><span class="line">        String password = loginData.get(<span class="string">&quot;password&quot;</span>).toString();</span><br><span class="line">        log.info(<span class="string">&quot;ç”¨æˆ·ç™»å½• =&gt; [&#123;&#125;]&quot;</span>, username);</span><br><span class="line">        Map&lt;String, Object&gt; response = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (userService.authenticate(username, password)) &#123;</span><br><span class="line">            response.put(<span class="string">&quot;loginState&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">/* ç”Ÿæˆä»¤ç‰Œ */</span></span><br><span class="line">            Map&lt;String, String&gt; payload = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            payload.put(<span class="string">&quot;username&quot;</span>, username);</span><br><span class="line">            String token = KKJWTUtil.generateToken(payload);</span><br><span class="line">            response.put(<span class="string">&quot;kktoken&quot;</span>, token);</span><br><span class="line">            <span class="keyword">return</span> KKDataResponse.successResponse(response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.put(<span class="string">&quot;loginState&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">            response.put(<span class="string">&quot;kktoken&quot;</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> KKDataResponse.errorResponse(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KKDataResponse <span class="title">test</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String kktoken = (String) request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        DecodedJWT verify = KKJWTUtil.verifyToken(kktoken);</span><br><span class="line">        String username = verify.getClaim(<span class="string">&quot;username&quot;</span>).asString();</span><br><span class="line">        log.info(<span class="string">&quot;è¯·æ±‚ç”¨æˆ· =&gt; [&#123;&#125;]&quot;</span>, username);</span><br><span class="line">        <span class="keyword">return</span> KKDataResponse.successResponse(<span class="string">&quot;è¯·æ±‚æˆåŠŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<blockquote>
<p>è®¾ç½®æ‹¦æˆªå™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.exceptions.AlgorithmMismatchException;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.exceptions.InvalidClaimException;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.exceptions.SignatureVerificationException;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.exceptions.TokenExpiredException;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.interfaces.DecodedJWT;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> top.parak.common.JwtTokenUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: Springboot-JWT &lt;/P&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.interceptor &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: JWTInterceptor &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: ä»¤ç‰Œæ‹¦æˆªå™¨ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String kktoken = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;è¯·æ±‚ä»¤ç‰Œ =&gt; [&#123;&#125;]&quot;</span>, kktoken);</span><br><span class="line">            DecodedJWT decodedJWT = KKJWTUtil.verifyToken(kktoken);</span><br><span class="line">            log.info(<span class="string">&quot;éªŒè¯ç»“æœ =&gt; [&#123;&#125;]&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TokenExpiredException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;</span>, e.getMessage());</span><br><span class="line">            map.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ä»¤ç‰Œè¿‡æœŸ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SignatureVerificationException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;</span>, e.getMessage());</span><br><span class="line">            map.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç­¾åé”™è¯¯&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AlgorithmMismatchException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;</span>, e.getMessage());</span><br><span class="line">            map.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;åŠ å¯†ç®—æ³•ä¸åŒ¹é…&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidClaimException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;</span>, e.getMessage());</span><br><span class="line">            map.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;å¤±æ•ˆè´Ÿè½½&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;</span>, e.getMessage());</span><br><span class="line">            map.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ä»¤ç‰Œä¸ºç©º&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;</span>, e.getMessage());</span><br><span class="line">            map.put(<span class="string">&quot;msg&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        log.error(<span class="string">&quot;éªŒè¯ç»“æœ =&gt; [&#123;&#125;]&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        map.put(<span class="string">&quot;state&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">/* mapè½¬json */</span></span><br><span class="line">        String json = <span class="keyword">new</span> ObjectMapper().writeValueAsString(map);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        PrintWriter writer = response.getWriter();</span><br><span class="line">        writer.println(json);</span><br><span class="line">        writer.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<blockquote>
<p>æ‹¦æˆªå™¨é…ç½®</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"><span class="keyword">import</span> top.parak.intercepter.JWTIntercepter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-11-22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> JWTInterceptor())</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/api/**/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/api/user/login&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>JWT</tag>
      </tags>
  </entry>
  <entry>
    <title>Java-Serializable</title>
    <url>/posts/29446/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><p>åºåˆ—åŒ–ï¼šå°†Javaå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—ï¼Œä»¥ä¾¿æŒä¹…åŒ–åˆ°ç£ç›˜æˆ–è€…ç½‘ç»œä¼ è¾“ã€‚</p>
<p>ååºåˆ—åŒ–ï¼šå°†ç£ç›˜æ–‡ä»¶æˆ–è€…ç½‘ç»œæ–‡ä»¶ä¸­çš„å­—èŠ‚åºåˆ—æ¢å¤ä¸ºåŸå…ˆçš„Javaå¯¹è±¡ã€‚</p>
<p>Javaå¯¹è±¡çš„åºåˆ—åŒ–çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>å®ç°<code>Serializable</code>æ¥å£ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚</li>
<li>å®ç°<code>Exteranlizable</code>æ¥å£ï¼Œéœ€è¦é‡å†™<code>writeExternal</code>å’Œ<code>readExternal</code>æ–¹æ³•ã€‚</li>
</ul>
<p>å®šä¹‰Userï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AllArgsConstructor</span></span><br><span class="line">    <span class="comment">// ToString</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åºåˆ—åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ObjectOutputStream output = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(</span><br><span class="line">        <span class="keyword">new</span> File(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/src/main/resources/public/&quot;</span> + <span class="string">&quot;user.txt&quot;</span>)));</span><br><span class="line">    output.writeObject(obj);</span><br><span class="line">    output.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ååºåˆ—åŒ–ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> User <span class="title">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    ObjectInputStream input = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(</span><br><span class="line">        <span class="keyword">new</span> File(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/src/main/resources/public/&quot;</span> + <span class="string">&quot;user.txt&quot;</span>)));</span><br><span class="line">    <span class="keyword">return</span> (User) input.readObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">&quot;Khighness&quot;</span>, <span class="keyword">new</span> Date());</span><br><span class="line">    serialize(user);</span><br><span class="line">    User des = deserialize();</span><br><span class="line">    System.out.println(des);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">User[<span class="type">id</span>=<span class="number">1</span>, <span class="type">username</span>=<span class="string">&#x27;Khighness&#x27;</span>, <span class="type">birth</span>=<span class="type">Thu</span> <span class="type">Apr</span> <span class="number">22</span> <span class="number">12</span>:<span class="number">12</span>:<span class="number">48</span> <span class="type">CST</span> <span class="number">2021</span>]</span><br></pre></td></tr></table></figure>

<br />

<h2 id="Serializable"><a href="#Serializable" class="headerlink" title="Serializable"></a>Serializable</h2><p>çœ‹ä¸€ä¸‹æºä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°åªæ˜¯ä¸ªç©ºæ¥å£ï¼Œå› æ­¤è¿™åªæ˜¯ä¸ªæ ‡ç¤ºæ€§æ¥å£ã€‚<br />é‚£æˆ‘ä»¬ç‚¹è¿›åˆšæ‰ä½¿ç”¨çš„<code>writeObject</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (enableOverride) &#123;           <span class="comment">// è¡¨ç¤ºæ˜¯å¦å¯è¦†å†™ï¼Œé»˜è®¤false</span></span><br><span class="line">        writeObjectOverride(obj);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        writeObject0(obj, <span class="keyword">false</span>); <span class="comment">// ä¸»è¦æ‰§è¡Œçš„æ–¹æ³•</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (depth == <span class="number">0</span>) &#123;</span><br><span class="line">            writeFatalException(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨çš„æ˜¯<code>writeObject0</code>æ–¹æ³•ï¼Œå†è¿›å…¥è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// remaining cases åˆ¤æ–­å¯¹è±¡</span></span><br><span class="line"><span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123;              <span class="comment">// æ˜¯å¦ä¸ºå­—ç¬¦ä¸²</span></span><br><span class="line">    writeString((String) obj, unshared);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (cl.isArray()) &#123;                <span class="comment">// æ˜¯å¦ä¸ºæ•°ç»„</span></span><br><span class="line">    writeArray(obj, desc, unshared);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Enum) &#123;         <span class="comment">// æ˜¯å¦ä¸ºæšä¸¾ç±»</span></span><br><span class="line">    writeEnum((Enum&lt;?&gt;) obj, desc, unshared);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Serializable) &#123; <span class="comment">// æ˜¯å¦å®ç°äº†Serializableæ¥å£</span></span><br><span class="line">    writeOrdinaryObject(obj, desc, unshared);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;                                  <span class="comment">// å››éåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotSerializableException(</span><br><span class="line">            cl.getName() + <span class="string">&quot;\n&quot;</span> + debugInfoStack.toString());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotSerializableException(cl.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br />

<h2 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h2><p>ç»§ç»­æµ‹è¯•ï¼Œç»™Userç±»æ·»åŠ å­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> String email;</span><br></pre></td></tr></table></figure>
<p>å°†æµ‹è¯•ä»£ç æ”¹ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    User des = deserialize();</span><br><span class="line">    System.out.println(des);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.io.InvalidClassException: top.parak.entity.User; local <span class="class"><span class="keyword">class</span> <span class="title">incompatible</span>: <span class="title">stream</span> <span class="title">classdesc</span> <span class="title">serialVersionUID</span> = -5676367428859465228, <span class="title">local</span> <span class="title">class</span> <span class="title">serialVersionUID</span> = -1182591043963610802</span></span><br></pre></td></tr></table></figure>
<p>å‘ç°æŠ¥é”™ï¼Œå¹¶ä¸”æŠ›å‡º<code>InvalidClassException</code>å¼‚å¸¸ï¼Œæç¤ºä¿¡æ¯ï¼šæœ¬åœ°ç±»ä¸å…¼å®¹ï¼Œåºåˆ—åŒ–å‰åçš„<code>serialVersionUID</code>ä¸åŒã€‚<br />å› æ­¤ï¼Œæœ‰ä¸¤ä¸ªé‡è¦ç»“è®ºï¼š</p>
<ul>
<li><code>serialVersionUID</code>æ˜¯åºåˆ—åŒ–å‰åçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚</li>
<li>é»˜è®¤å¦‚æœæ²¡æœ‰æ˜¾ç¤ºå®šä¹‰<code>serialVersionUID</code>ï¼Œåˆ™ç¼–è¯‘å™¨ä¼šä¸ºå®ƒè‡ªåŠ¨å£°æ˜ä¸€ä¸ªã€‚</li>
</ul>
<p>æ‰©å±•ï¼š</p>
<ul>
<li><code>serialVersionUID</code>åºåˆ—åŒ–IDï¼Œå¯ä»¥çœ‹æˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ä¸­çš„æš—å·ï¼ˆè¿ä¸Šå½¼æ­¤çš„è®¯å·æ‰æœ‰ä¸ªä¾é ï¼‰ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ï¼ŒJVMä¼šæŠŠå­—èŠ‚æµä¸­çš„åºåˆ—åŒ–IDå’Œè¢«åºåˆ—å·ç±»ä¸­çš„åºåˆ—åŒ–IDåšå¯¹æ¯”ï¼Œåªæœ‰ä¸¤è€…ä¸€è‡´ï¼Œæ‰èƒ½é‡æ–°ååºåˆ—åŒ–ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚</li>
<li>å¦‚æœåœ¨å®šä¹‰ä¸€ä¸ªå¯åºåˆ—åŒ–çš„ç±»æ—¶ï¼Œæ²¡æœ‰äººä¸ºæ˜¾ç¤ºåœ°ç»™å®ƒå®šä¹‰ä¸€ä¸ª<code>serialVersionUID</code>çš„è¯ï¼Œåˆ™Javaè¿è¡Œæ—¶ç¯å¢ƒä¼šæ ¹æ®è¯¥ç±»çš„å„æ–¹é¢ä¿¡æ¯è‡ªåŠ¨åœ°ä¸ºå®ƒç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„<code>serialVersionUID</code>ï¼Œä¸€æ—¦æ›´æ”¹äº†ç±»çš„ç»“æ„æˆ–è€…ä¿¡æ¯ï¼Œåˆ™ç±»çš„<code>serialVersionUID</code>ä¹Ÿä¼šè·Ÿç€å˜åŒ–ã€‚</li>
</ul>
<br />

<h2 id="static-amp-transient"><a href="#static-amp-transient" class="headerlink" title="static&amp;transient"></a>static&amp;transient</h2><p>ç»§ç»­æµ‹è¯•ï¼Œå°†<code>User</code>ç±»çš„<code>email</code>å­—æ®µæ·»åŠ ä¿®é¥°ç¬¦<code>static</code>æˆ–è€…<code>transient</code>ï¼Œå‘ç°æµ‹è¯•æˆåŠŸã€‚<br />äºæ˜¯å¯ä»¥å¾—å‡ºç»“è®ºï¼Œå¯¹äº<code>Serilizable</code>æ¥å£ï¼š</p>
<ol>
<li>å‡¡æ˜¯è¢«<code>static</code>ä¿®é¥°çš„å­—æ®µæ˜¯ä¸ä¼šè¢«åºåˆ—åŒ–çš„</li>
<li>å‡¡æ˜¯è¢«<code>transient</code>ä¿®é¥°çš„å­—æ®µæ˜¯ä¸ä¼šè¢«åºåˆ—åŒ–çš„</li>
</ol>
<blockquote>
<p>transient</p>
</blockquote>
<p><code>transient</code>å…³é”®å­—çš„ä½œç”¨å°±æ˜¯æŠŠè¢«ä¿®é¥°çš„å­—æ®µçš„ç”Ÿå‘½å‘¨æœŸä»…å­˜äºè°ƒç”¨è€…çš„å†…å­˜è€Œä¸ä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚<br /></p>
<blockquote>
<p>æ³¨æ„</p>
</blockquote>
<p>å®ç°<code>Exteranlizable</code>æ¥å£æ—¶ï¼Œ<code>transient</code>æ˜¯æ— æ•ˆçš„ã€‚<br /></p>
<h2 id="å•ä¾‹æ¨¡å¼å¢å¼º"><a href="#å•ä¾‹æ¨¡å¼å¢å¼º" class="headerlink" title="å•ä¾‹æ¨¡å¼å¢å¼º"></a>å•ä¾‹æ¨¡å¼å¢å¼º</h2><p>å•ä¾‹æ¨¡å¼ä¸‹ï¼Œå¯¹è±¡ç»è¿‡åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¹‹åè¿˜æ˜¯ä¸€ä¸ªå¯¹è±¡å—ï¼Ÿ</p>
<p>å¯ä»¥åšä¸€ä¸ªå®éªŒã€‚</p>
<p>é™æ€å†…éƒ¨ç±»çš„å•ä¾‹æ¨¡å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3992737853791586260L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton singleton = <span class="keyword">new</span> Singleton();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.singleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå†™ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–</span></span><br><span class="line">    Singleton instance = Singleton.getInstance();</span><br><span class="line">    ObjectOutputStream output = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(</span><br><span class="line">        <span class="keyword">new</span> File(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/src/main/resources/public/&quot;</span> + <span class="string">&quot;singleton.txt&quot;</span>)));</span><br><span class="line">    output.writeObject(instance);</span><br><span class="line">    output.close();</span><br><span class="line">    <span class="comment">// ååºåˆ—åŒ–</span></span><br><span class="line">    ObjectInputStream input = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(</span><br><span class="line">        <span class="keyword">new</span> File(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/src/main/resources/public/&quot;</span> + <span class="string">&quot;singleton.txt&quot;</span>)));</span><br><span class="line">    Singleton singleton = (Singleton) input.readObject();</span><br><span class="line">    <span class="comment">// è¾“å‡ºç»“æœ</span></span><br><span class="line">    System.out.println(instance == singleton);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¹‹åï¼Œå‘ç°æ§åˆ¶å°æ‰“å°çš„æ˜¯<code>false</code>ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼šåœ¨å•ä¾‹ä¸­é‡å†™<code>readResolve</code>å‡½æ•°ï¼Œç›´æ¥è¿”å›å•ä¾‹å¯¹è±¡ï¼Œæ¥è§„é¿ä¹‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SingletonHolder.singleton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java8-Stream</title>
    <url>/posts/3e51ba23/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><p>â€‹       Stream æ˜¯ Java8 ä¸­å¤„ç†é›†åˆçš„å…³é”®æŠ½è±¡æ¦‚å¿µï¼Œå®ƒå¯ä»¥æŒ‡å®šä½ å¸Œæœ›å¯¹é›†åˆè¿›è¡Œçš„æ“ä½œï¼Œå¯ä»¥æ‰§è¡Œéå¸¸å¤æ‚çš„æŸ¥æ‰¾ã€è¿‡æ»¤å’Œæ˜ å°„æ•°æ®ç­‰æ“ä½œã€‚ä½¿ç”¨Stream API å¯¹é›†åˆæ•°æ®è¿›è¡Œæ“ä½œï¼Œå°±ç±»ä¼¼äºä½¿ç”¨ SQL æ‰§è¡Œçš„æ•°æ®åº“æŸ¥è¯¢ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ Stream API æ¥å¹¶è¡Œæ‰§è¡Œæ“ä½œã€‚ç®€è€Œè¨€ä¹‹ï¼ŒStream API æä¾›äº†ä¸€ç§é«˜æ•ˆä¸”æ˜“äºä½¿ç”¨çš„å¤„ç†æ•°æ®çš„æ–¹å¼ã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li><p>ä¸æ˜¯æ•°æ®ç»“æ„ï¼Œä¸ä¼šä¿å­˜æ•°æ®ã€‚</p>
</li>
<li><p>ä¸ä¼šä¿®æ”¹åŸæ¥çš„æ•°æ®æºï¼Œå®ƒä¼šå°†æ“ä½œåçš„æ•°æ®ä¿å­˜åˆ°å¦å¤–ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚ï¼ˆä¿ç•™æ„è§ï¼šæ¯•ç«Ÿpeekæ–¹æ³•å¯ä»¥ä¿®æ”¹æµä¸­å…ƒç´ ï¼‰</p>
</li>
<li><p>æƒ°æ€§æ±‚å€¼ï¼Œæµåœ¨ä¸­é—´å¤„ç†è¿‡ç¨‹ä¸­ï¼Œåªæ˜¯å¯¹æ“ä½œè¿›è¡Œäº†è®°å½•ï¼Œå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œéœ€è¦ç­‰åˆ°æ‰§è¡Œç»ˆæ­¢æ“ä½œçš„æ—¶å€™æ‰ä¼šè¿›è¡Œå®é™…çš„è®¡ç®—ã€‚</p>
</li>
</ul>
<h2 id="2-åˆ†ç±»"><a href="#2-åˆ†ç±»" class="headerlink" title="2. åˆ†ç±»"></a>2. åˆ†ç±»</h2><table>
<thead>
<tr>
<th align="center">ç±»å‹</th>
<th align="center">çŠ¶æ€</th>
<th align="center">API</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ä¸­é—´æ“ä½œ</td>
<td align="center">æœ‰çŠ¶æ€</td>
<td align="center">unordered() filter() map() mapToInt() mapToDouble() flatMap() flatMapToInt() flatMapToLong() flatMapToDouble() peek()</td>
</tr>
<tr>
<td align="center">ä¸­é—´æ“ä½œ</td>
<td align="center">æ— çŠ¶æ€</td>
<td align="center">distinct() sorted() limit() skip()</td>
</tr>
<tr>
<td align="center">ç»“æŸæ“ä½œ</td>
<td align="center">éçŸ­è·¯æ“ä½œ</td>
<td align="center">foreach() forEachOrdered() toArray() reduce() collect() max() min() count()</td>
</tr>
<tr>
<td align="center">ç»“æŸæ“ä½œ</td>
<td align="center">çŸ­è·¯æ“ä½œ</td>
<td align="center">anyMatch() allMatch() noneMatch() findFirst() findAny()</td>
</tr>
</tbody></table>
<p>æ³¨é‡Šï¼š</p>
<ul>
<li><p>æ— çŠ¶æ€ï¼šæŒ‡å…ƒç´ çš„å¤„ç†ä¸å—ä¹‹å‰å…ƒç´ çš„å½±å“ï¼›</p>
</li>
<li><p>æœ‰çŠ¶æ€ï¼šæŒ‡è¯¥æ“ä½œåªæœ‰æ‹¿åˆ°æ‰€æœ‰å…ƒç´ ä¹‹åæ‰èƒ½ç»§ç»­ä¸‹å»ã€‚</p>
</li>
<li><p>éçŸ­è·¯æ“ä½œï¼šæŒ‡å¿…é¡»å¤„ç†æ‰€æœ‰å…ƒç´ æ‰èƒ½å¾—åˆ°æœ€ç»ˆç»“æœï¼›</p>
</li>
<li><p>çŸ­è·¯æ“ä½œï¼šæŒ‡é‡åˆ°æŸäº›ç¬¦åˆæ¡ä»¶çš„å…ƒç´ å°±å¯ä»¥å¾—åˆ°æœ€ç»ˆç»“æœï¼Œå¦‚ A || Bï¼Œåªè¦Aä¸ºtrueï¼Œåˆ™æ— éœ€åˆ¤æ–­Bçš„ç»“æœã€‚</p>
</li>
</ul>
<h2 id="3-ä½¿ç”¨"><a href="#3-ä½¿ç”¨" class="headerlink" title="3. ä½¿ç”¨"></a>3. ä½¿ç”¨</h2><h3 id="3-1-æµçš„å¸¸ç”¨åˆ›å»ºæ–¹æ³•"><a href="#3-1-æµçš„å¸¸ç”¨åˆ›å»ºæ–¹æ³•" class="headerlink" title="3.1 æµçš„å¸¸ç”¨åˆ›å»ºæ–¹æ³•"></a>3.1 æµçš„å¸¸ç”¨åˆ›å»ºæ–¹æ³•</h3><h4 id="3-1-1ä½¿ç”¨Collectionä¸‹çš„-stream-å’Œ-parallelStream-æ–¹æ³•"><a href="#3-1-1ä½¿ç”¨Collectionä¸‹çš„-stream-å’Œ-parallelStream-æ–¹æ³•" class="headerlink" title="3.1.1ä½¿ç”¨Collectionä¸‹çš„ stream() å’Œ parallelStream() æ–¹æ³•"></a>3.1.1ä½¿ç”¨Collectionä¸‹çš„ <code>stream()</code> å’Œ <code>parallelStream()</code> æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line">    list.add(<span class="number">1</span>);</span><br><span class="line">    list.add(<span class="number">3</span>);</span><br><span class="line">    list.add(<span class="number">5</span>);</span><br><span class="line">    list.add(<span class="number">7</span>);</span><br><span class="line">    list.add(<span class="number">9</span>);</span><br><span class="line">    Stream&lt;Integer&gt; stream = list.stream();</span><br><span class="line">    Stream&lt;Integer&gt; parallelStream = list.parallelStream();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-1-2-ä½¿ç”¨Arraysä¸­çš„-stream-æ–¹æ³•ï¼Œå°†æ•°ç»„è½¬æˆæµ"><a href="#3-1-2-ä½¿ç”¨Arraysä¸­çš„-stream-æ–¹æ³•ï¼Œå°†æ•°ç»„è½¬æˆæµ" class="headerlink" title="3.1.2 ä½¿ç”¨Arraysä¸­çš„ stream() æ–¹æ³•ï¼Œå°†æ•°ç»„è½¬æˆæµ"></a>3.1.2 ä½¿ç”¨Arraysä¸­çš„ <code>stream()</code> æ–¹æ³•ï¼Œå°†æ•°ç»„è½¬æˆæµ</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Double[] nums = <span class="keyword">new</span> Double[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        nums[i] = random();</span><br><span class="line">    &#125;</span><br><span class="line">    Stream&lt;Double&gt; stream = Arrays.stream(nums);</span><br><span class="line">    stream.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-1-3-ä½¿ç”¨Streamä¸­çš„é™æ€æ–¹æ³•-of-ã€iterate-ã€generate"><a href="#3-1-3-ä½¿ç”¨Streamä¸­çš„é™æ€æ–¹æ³•-of-ã€iterate-ã€generate" class="headerlink" title="3.1.3 ä½¿ç”¨Streamä¸­çš„é™æ€æ–¹æ³•: of()ã€iterate()ã€generate()"></a>3.1.3 ä½¿ç”¨Streamä¸­çš„é™æ€æ–¹æ³•: <code>of()</code>ã€<code>iterate()</code>ã€<code>generate()</code></h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Stream&lt;Integer&gt; stream1 = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line">    stream1.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    Stream&lt;Integer&gt; stream2 = Stream.iterate(<span class="number">0</span>, (x) -&gt; x + <span class="number">1</span>).limit(<span class="number">6</span>);</span><br><span class="line">    stream2.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    Stream&lt;Double&gt; stream3 = Stream.generate(Math::random).limit(<span class="number">6</span>);</span><br><span class="line">    stream3.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-1-4-ä½¿ç”¨-BufferedReader-lines-æ–¹æ³•ï¼Œå°†æ¯è¡Œå†…å®¹è½¬æˆæµ"><a href="#3-1-4-ä½¿ç”¨-BufferedReader-lines-æ–¹æ³•ï¼Œå°†æ¯è¡Œå†…å®¹è½¬æˆæµ" class="headerlink" title="3.1.4 ä½¿ç”¨ BufferedReader.lines() æ–¹æ³•ï¼Œå°†æ¯è¡Œå†…å®¹è½¬æˆæµ"></a>3.1.4 ä½¿ç”¨ <code>BufferedReader.lines()</code> æ–¹æ³•ï¼Œå°†æ¯è¡Œå†…å®¹è½¬æˆæµ</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method4</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(<span class="string">&quot;D:/Java/Test/K1.txt&quot;</span>));</span><br><span class="line">    Stream&lt;String&gt; lines = reader.lines();</span><br><span class="line">    lines.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-1-5-ä½¿ç”¨-Pattern-splitAsStream-æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²åˆ†éš”æˆæµ"><a href="#3-1-5-ä½¿ç”¨-Pattern-splitAsStream-æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²åˆ†éš”æˆæµ" class="headerlink" title="3.1.5 ä½¿ç”¨ Pattern.splitAsStream() æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²åˆ†éš”æˆæµ"></a>3.1.5 ä½¿ç”¨ <code>Pattern.splitAsStream()</code> æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²åˆ†éš”æˆæµ</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Pattern pattern = Pattern.compile(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">    Stream&lt;String&gt; stringStream = pattern.splitAsStream(<span class="string">&quot;K,H,I,G,H,N,E,S,S&quot;</span>);</span><br><span class="line">    stringStream.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-æµçš„ä¸­é—´æ“ä½œ"><a href="#3-2-æµçš„ä¸­é—´æ“ä½œ" class="headerlink" title="3.2 æµçš„ä¸­é—´æ“ä½œ"></a>3.2 æµçš„ä¸­é—´æ“ä½œ</h3><h4 id="3-2-1-ç­›é€‰ä¸åˆ‡ç‰‡"><a href="#3-2-1-ç­›é€‰ä¸åˆ‡ç‰‡" class="headerlink" title="3.2.1 ç­›é€‰ä¸åˆ‡ç‰‡"></a>3.2.1 ç­›é€‰ä¸åˆ‡ç‰‡</h4><ul>
<li><code>filter()</code>ï¼šè¿‡æ»¤æµä¸­çš„æŸäº›å…ƒç´ </li>
<li><code>limit()</code>ï¼šè·å–å‰nä¸ªå…ƒç´ </li>
<li><code>skip()</code>ï¼šè·³è¿‡å‰nä¸ªå…ƒç´ </li>
<li><code>limit + skip</code>ï¼šå¯ä»¥å®ç°åˆ†é¡µ<code>skip(PageNumber * PageSize).limit(PageSize)</code></li>
<li><code>distinct()</code>ï¼šé€šè¿‡æµä¸­å…ƒç´ çš„<code>hashCode()</code>å’Œ<code>equals()</code>å»é™¤é‡å¤å…ƒç´ </li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; list = Arrays.asList( <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                       <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>,</span><br><span class="line">                                       <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>,</span><br><span class="line">                                       <span class="number">4</span>, <span class="number">4</span>, <span class="number">4</span>,</span><br><span class="line">                                       <span class="number">5</span>, <span class="number">5</span>, <span class="number">5</span>,</span><br><span class="line">                                       <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>,</span><br><span class="line">                                       <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>,</span><br><span class="line">                                       <span class="number">8</span>, <span class="number">8</span>, <span class="number">8</span>,</span><br><span class="line">                                       <span class="number">9</span>, <span class="number">9</span>, <span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;----------è¿‡æ»¤å¤§äº5çš„å…ƒç´ ----------&quot;</span>);</span><br><span class="line">    Stream&lt;Integer&gt; stream1 = list.stream().filter(x -&gt; x &lt;= <span class="number">5</span>);</span><br><span class="line">    stream1.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;----------åˆ†é¡µæŸ¥è¯¢/5/3----------&quot;</span>);</span><br><span class="line">    Stream&lt;Integer&gt; stream2 = list.stream().skip(<span class="number">5</span> * <span class="number">3</span>).limit(<span class="number">3</span>);</span><br><span class="line">    stream2.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;----------å»æ‰é‡å¤å…ƒç´ ----------&quot;</span>);</span><br><span class="line">    Stream stream3 = list.stream().distinct();</span><br><span class="line">    stream3.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-2-2-æ˜ å°„"><a href="#3-2-2-æ˜ å°„" class="headerlink" title="3.2.2 æ˜ å°„"></a>3.2.2 æ˜ å°„</h4><ul>
<li><code>map()</code>ï¼šæ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°ä¼šè¢«åº”ç”¨åˆ°æ¯ä¸ªå…ƒç´ ä¸Šï¼Œå¹¶å°†å…¶æ˜ å°„æˆä¸€ä¸ªæ–°çš„å…ƒç´ </li>
<li><code>flatMap()</code>ï¼šæ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå°†æµä¸­çš„æ¯ä¸ªå€¼éƒ½æ¢æˆå¦ä¸€ä¸ªæµï¼Œç„¶åæŠŠæ‰€æœ‰æµè¿æ¥æˆä¸€ä¸ªæµ<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;A,B,C&quot;</span>, <span class="string">&quot;1,2,3&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Stream&lt;String&gt; stringStream1 = list.stream().map( x -&gt; x.replaceAll(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>));</span><br><span class="line">    stringStream1.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    Stream&lt;String&gt; stringStream2 = list.stream().flatMap( x -&gt;&#123;</span><br><span class="line">        String[] split = x.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        Stream&lt;String&gt; stringStream = Arrays.stream(split);</span><br><span class="line">        <span class="keyword">return</span> stringStream;</span><br><span class="line">    &#125;);</span><br><span class="line">    stringStream2.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="3-2-3-æ’åº"><a href="#3-2-3-æ’åº" class="headerlink" title="3.2.3 æ’åº"></a>3.2.3 æ’åº</h4><ul>
<li><code>sorted()</code>: è‡ªç„¶æ’åºï¼Œæµä¸­å…ƒç´ éœ€è¦å®ç°Comparableæ¥å£</li>
<li><code>sorted(Comparator c)</code>: è‡ªå®šä¹‰æ’åºï¼Œè‡ªå®šä¹‰Comparatoræ’åºå™¨<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; integers = Arrays.asList(<span class="number">1</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">2</span>);</span><br><span class="line">    integers.stream().sorted().forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; strings = Arrays.asList(<span class="string">&quot;K&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;N&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;S&quot;</span>);</span><br><span class="line">    strings.stream().sorted(</span><br><span class="line">        (s1, s2) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> s1.compareTo(s2);</span><br><span class="line">        &#125;</span><br><span class="line">    ).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">        String name;</span><br><span class="line">        <span class="keyword">int</span> score; </span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Student&gt; students = Arrays.asList( <span class="keyword">new</span> Student(<span class="string">&quot;K&quot;</span>, <span class="number">100</span>),</span><br><span class="line">                                           <span class="keyword">new</span> Student(<span class="string">&quot;H&quot;</span>, <span class="number">91</span>),</span><br><span class="line">                                           <span class="keyword">new</span> Student(<span class="string">&quot;I&quot;</span>, <span class="number">95</span>),</span><br><span class="line">                                           <span class="keyword">new</span> Student(<span class="string">&quot;G&quot;</span>, <span class="number">98</span>),</span><br><span class="line">                                           <span class="keyword">new</span> Student(<span class="string">&quot;N&quot;</span>, <span class="number">88</span>));</span><br><span class="line">    students.stream().sorted(</span><br><span class="line">        (s1, s2) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> s1.score - s2.score;</span><br><span class="line">        &#125;</span><br><span class="line">    ).forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="3-2-4-æ¶ˆè´¹"><a href="#3-2-4-æ¶ˆè´¹" class="headerlink" title="3.2.4 æ¶ˆè´¹"></a>3.2.4 æ¶ˆè´¹</h4><ul>
<li><code>peek()</code>ï¼šæ¥æ”¶<code>Consumer</code>è¡¨è¾¾å¼ï¼Œæ— è¿”å›å€¼<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">        String name;</span><br><span class="line">        <span class="keyword">int</span> score;</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Student&gt; students = Arrays.asList( <span class="keyword">new</span> Student(<span class="string">&quot;K&quot;</span>, <span class="number">100</span>),</span><br><span class="line">                                           <span class="keyword">new</span> Student(<span class="string">&quot;H&quot;</span>, <span class="number">91</span>),</span><br><span class="line">                                           <span class="keyword">new</span> Student(<span class="string">&quot;I&quot;</span>, <span class="number">95</span>),</span><br><span class="line">                                           <span class="keyword">new</span> Student(<span class="string">&quot;G&quot;</span>, <span class="number">98</span>),</span><br><span class="line">                                           <span class="keyword">new</span> Student(<span class="string">&quot;N&quot;</span>, <span class="number">88</span>));</span><br><span class="line">    students.stream().peek(</span><br><span class="line">        s -&gt; &#123;</span><br><span class="line">            s.setScore(<span class="number">99</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    ).forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="4-æµçš„ç»ˆæ­¢æ“ä½œ"><a href="#4-æµçš„ç»ˆæ­¢æ“ä½œ" class="headerlink" title="4. æµçš„ç»ˆæ­¢æ“ä½œ"></a>4. æµçš„ç»ˆæ­¢æ“ä½œ</h3><h4 id="4-1-åŒ¹é…ã€èšåˆæ“ä½œ"><a href="#4-1-åŒ¹é…ã€èšåˆæ“ä½œ" class="headerlink" title="4.1 åŒ¹é…ã€èšåˆæ“ä½œ"></a>4.1 åŒ¹é…ã€èšåˆæ“ä½œ</h4><ul>
<li><code>allMatch()</code>ï¼šæ¥æ”¶ä¸€ä¸ª<code>Predicate</code>å‡½æ•°ï¼Œå½“æµä¸­æ¯ä¸ªå…ƒç´ éƒ½ç¬¦åˆè¯¥æ–­è¨€æ—¶æ‰è¿”å›trueï¼Œå¦åˆ™è¿”å›false</li>
<li><code>noneMatch()</code>ï¼šæ¥æ”¶ä¸€ä¸ª<code>Predicate</code>å‡½æ•°ï¼Œå½“æµä¸­æ¯ä¸ªå…ƒç´ éƒ½ä¸ç¬¦åˆè¯¥æ–­è¨€æ—¶æ‰è¿”å›trueï¼Œå¦åˆ™è¿”å›false</li>
<li><code>anyMatch()</code>ï¼šæ¥æ”¶ä¸€ä¸ª<code>Predicate</code>å‡½æ•°ï¼Œåªè¦æµä¸­æœ‰ä¸€ä¸ªå…ƒç´ æ»¡è¶³è¯¥æ–­è¨€åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</li>
<li><code>findFIrst()</code>ï¼šè¿”å›æµä¸­ç¬¬ä¸€ä¸ªå…ƒç´ </li>
<li><code>findAny()</code>ï¼šè¿”å›æµä¸­çš„ä»»æ„å…ƒç´ </li>
<li><code>count()</code>ï¼šè¿”å›æµä¸­å…ƒç´ æ€»ä¸ªæ•°</li>
<li><code>max()</code>ï¼šè¿”å›æµä¸­å…ƒç´ çš„æœ€å¤§å€¼</li>
<li><code>min()</code>ï¼šè¿”å›æµä¸­å…ƒç´ çš„æœ€å°å€¼</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;----------method1----------&quot;</span>);</span><br><span class="line">    List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">8</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> allMatch = list.stream().anyMatch(e -&gt; e &gt; <span class="number">10</span>);    <span class="comment">// false</span></span><br><span class="line">    <span class="keyword">boolean</span> noneMatch = list.stream().noneMatch(e -&gt; e &gt; <span class="number">10</span>);  <span class="comment">// true</span></span><br><span class="line">    <span class="keyword">boolean</span> anyMatch = list.stream().anyMatch(e -&gt; e &gt; <span class="number">4</span>);     <span class="comment">// true</span></span><br><span class="line">    System.out.println(allMatch + <span class="string">&quot; &quot;</span> + noneMatch + <span class="string">&quot; &quot;</span> + anyMatch);</span><br><span class="line"></span><br><span class="line">    Integer findFirst = list.stream().findFirst().get();</span><br><span class="line">    Integer findAny = list.stream().findAny().get();</span><br><span class="line">    System.out.println(<span class="string">&quot;first = &quot;</span> + findFirst + <span class="string">&quot;, any = &quot;</span> + findAny);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> count = list.stream().count();</span><br><span class="line">    Integer max = list.stream().max(Integer::compareTo).get();</span><br><span class="line">    Integer min = list.stream().min(Integer::compareTo).get();</span><br><span class="line">    System.out.println(<span class="string">&quot;count = &quot;</span> + count + <span class="string">&quot;, max = &quot;</span> + max + <span class="string">&quot;, min = &quot;</span> + min);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-2-è§„çº¦æ“ä½œ"><a href="#4-2-è§„çº¦æ“ä½œ" class="headerlink" title="4.2 è§„çº¦æ“ä½œ"></a>4.2 è§„çº¦æ“ä½œ</h4><ul>
<li><code>Optional&lt;T&gt; reduce(BinaryOperator&lt;T&gt; accumulator)</code>ï¼šç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œ<code>accumulator</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæµä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæµä¸­å…ƒç´ çš„ç¬¬äºŒä¸ªå…ƒç´ ï¼›ç¬¬äºŒæ¬¡æ‰§è¡Œæ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç¬¬ä¸€æ¬¡å‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæµä¸­çš„ç¬¬ä¸‰ä¸ªå…ƒç´ ï¼›ä¾æ¬¡ç±»æ¨ã€‚</li>
<li><code>T reduce(T identity, BinaryOperator&lt;T&gt; accumulator)</code>ï¼šæµç¨‹è·Ÿä¸Šé¢ä¸€æ ·ï¼Œåªæ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œ<code>accumulator</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º<code>identity</code>ï¼Œè€Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæµä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</li>
<li><code>&lt;U&gt; U reduce(U identity,BiFunction&lt;U, ? super T, U&gt; accumulator,BinaryOperator&lt;U&gt; combiner)</code>ï¼šåœ¨ä¸²è¡Œæµ(stream)ä¸­ï¼Œè¯¥æ–¹æ³•è·Ÿç¬¬äºŒä¸ªæ–¹æ³•ä¸€æ ·ï¼Œå³ç¬¬ä¸‰ä¸ªå‚æ•°<code>combiner</code>ä¸ä¼šèµ·ä½œç”¨ã€‚åœ¨å¹¶è¡Œæµ(parallelStream)ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“æµè¢«fork joinå‡ºå¤šä¸ªçº¿ç¨‹è¿›è¡Œæ‰§è¡Œï¼Œæ­¤æ—¶æ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæµç¨‹å°±è·Ÿç¬¬äºŒä¸ªæ–¹æ³•<code>reduce(identity, accumulator)</code>ä¸€æ ·ï¼Œè€Œç¬¬ä¸‰ä¸ªå‚æ•°<code>combiner</code>å‡½æ•°ï¼Œåˆ™æ˜¯å°†æ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœå½“æˆä¸€ä¸ªæ–°çš„æµï¼Œç„¶åä½¿ç”¨ç¬¬ä¸€ä¸ªæ–¹æ³•<code>reduce(accumulator)</code>æµç¨‹è¿›è¡Œè§„çº¦ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ±‚å’Œ</span></span><br><span class="line">    Integer v = list.stream().reduce(<span class="number">0</span>, (x1, x2) -&gt; x1 + x2);</span><br><span class="line">    System.out.println(<span class="string">&quot;sum = &quot;</span>  + v);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 10 + å’Œ</span></span><br><span class="line">    Integer v1 = list.stream().reduce(<span class="number">10</span>, (x1, x2) -&gt; x1 + x2);</span><br><span class="line">    System.out.println(<span class="string">&quot;10 + sum = &quot;</span> + v1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ±‚-å’Œ</span></span><br><span class="line">    Integer v2 = list.stream().reduce(<span class="number">0</span>,</span><br><span class="line">                                      (x1, x2) -&gt; &#123;</span><br><span class="line">                                          System.out.println(<span class="string">&quot;stream accumulator: x1: &quot;</span> + x1 + <span class="string">&quot; x2: &quot;</span> + x2);</span><br><span class="line">                                          <span class="keyword">return</span> x1 - x2;</span><br><span class="line">                                      &#125;</span><br><span class="line">                                     );</span><br><span class="line">    System.out.println(v2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ±‚ç´¯ç§¯</span></span><br><span class="line">    Integer v3 = list.stream().reduce(<span class="number">1</span>,</span><br><span class="line">                                      (x1, x2) -&gt; &#123;</span><br><span class="line">                                          System.out.println(<span class="string">&quot;stream combiner: x1:&quot;</span> + x1 + <span class="string">&quot;  x2:&quot;</span> + x2);</span><br><span class="line">                                          <span class="keyword">return</span> x1 * x2;</span><br><span class="line">                                      &#125;</span><br><span class="line">                                     );</span><br><span class="line">    System.out.println(v3);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­—ç¬¦ä¸²æ‹¼æ¥</span></span><br><span class="line">    List&lt;String&gt; list1 = Arrays.asList(<span class="string">&quot;K&quot;</span>, <span class="string">&quot;Highness&quot;</span>, <span class="string">&quot;. Nice &quot;</span>, <span class="string">&quot;to &quot;</span>, <span class="string">&quot;meet &quot;</span>, <span class="string">&quot;you&quot;</span>);</span><br><span class="line">    String res = list1.stream().reduce(<span class="string">&quot;Hello &quot;</span>, (c1, c2) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> c1 + c2;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-3-æ”¶é›†æ“ä½œ"><a href="#4-3-æ”¶é›†æ“ä½œ" class="headerlink" title="4.3 æ”¶é›†æ“ä½œ"></a>4.3 æ”¶é›†æ“ä½œ</h4><p><code>collect()</code>ï¼šæ¥æ”¶ä¸€ä¸ªCollectorå®ä¾‹ï¼Œå°†æµä¸­å…ƒç´ æ”¶é›†æˆå¦å¤–ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚</p>
<p><code>Collector&lt;T, A, R&gt;</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰ä»¥ä¸‹5ä¸ªæŠ½è±¡æ–¹æ³•ï¼š</p>
<ul>
<li><code>Supplier&lt;A&gt; supplier()</code>ï¼šåˆ›å»ºä¸€ä¸ªç»“æœå®¹å™¨Aã€‚</li>
<li><code>BiConsumer&lt;A, T&gt; accumulator()</code>ï¼šæ¶ˆè´¹å‹æ¥å£ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå®¹å™¨Aï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæµä¸­å…ƒç´ Tã€‚</li>
<li><code>BinaryOperator&lt;A&gt; combiner()</code>ï¼šå‡½æ•°æ¥å£ï¼Œè¯¥å‚æ•°çš„ä½œç”¨è·Ÿä¸Šä¸€ä¸ªæ–¹æ³•(reduce)ä¸­çš„combinerå‚æ•°ä¸€æ ·ï¼Œå°†å¹¶è¡Œæµä¸­å„ä¸ªå­è¿›ç¨‹çš„è¿è¡Œç»“æœ(accumulatorå‡½æ•°æ“ä½œåçš„å®¹å™¨A)è¿›è¡Œåˆå¹¶ã€‚</li>
<li><code>Function&lt;A, R&gt; finisher()</code>ï¼šå‡½æ•°å¼æ¥å£ï¼Œå‚æ•°ä¸ºå®¹å™¨Aï¼Œè¿”å›ç±»å‹ä¸ºcollectæ–¹æ³•æœ€ç»ˆæƒ³è¦çš„ç»“æœRã€‚</li>
<li><code>Set&lt;Characteristics&gt; characteristics()</code>ï¼šè¿”å›ä¸€ä¸ªä¸å¯å˜çš„Seté›†åˆï¼Œç”¨æ¥è¡¨æ˜è¯¥Collectorçš„ç‰¹å¾ã€‚</li>
</ul>
<p>æœ‰ä»¥ä¸‹ä¸‰ä¸ªç‰¹å¾ï¼š</p>
<ul>
<li><code>CONCURRENT</code>ï¼šè¡¨ç¤ºæ­¤æ”¶é›†å™¨æ”¯æŒå¹¶å‘ã€‚</li>
<li><code>UNORDERED</code>ï¼šè¡¨ç¤ºè¯¥æ”¶é›†æ“ä½œä¸ä¼šä¿ç•™æµä¸­å…ƒç´ åŸæœ‰çš„é¡ºåºã€‚</li>
<li><code>IDENTITY_FINISH</code>ï¼šè¡¨ç¤ºfinisherå‚æ•°åªæ˜¯æ ‡è¯†è€Œå·²ï¼Œå¯å¿½ç•¥ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java8</tag>
      </tags>
  </entry>
  <entry>
    <title>LinkedBlockingQueue</title>
    <url>/posts/33015/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ğŸ” åŸºäºJDK1.8çš„LinkedBlockingQueueæºç åˆ†æã€‚</p>
<h2 id="åŸºæœ¬çŸ¥è¯†"><a href="#åŸºæœ¬çŸ¥è¯†" class="headerlink" title="åŸºæœ¬çŸ¥è¯†"></a>åŸºæœ¬çŸ¥è¯†</h2><ul>
<li><p>å§‹äºï¼š<strong>JDK 1.5</strong></p>
</li>
<li><p>ä½œè€…ï¼š<strong>Doug Lea</strong></p>
</li>
<li><p>ç‰¹ç‚¹ï¼šçº¿ç¨‹å®‰å…¨ï¼Œæœ‰ç•Œå¹¶é˜»å¡ï¼Œç”Ÿäº§-æ¶ˆè´¹æ¨¡å‹</p>
</li>
<li><p>ç»“æ„ï¼šå•å‘é“¾è¡¨</p>
</li>
<li><p>ç±»å›¾ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33015/LinkedBlockingQueue.png" class="" title="LinkedBlockingQueue">



</li>
</ul>
<h2 id="ä¸»è¦å±æ€§"><a href="#ä¸»è¦å±æ€§" class="headerlink" title="ä¸»è¦å±æ€§"></a>ä¸»è¦å±æ€§</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** å®¹é‡ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> capacity;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** èŠ‚ç‚¹æ•°é‡ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å¤´èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å°¾èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node&lt;E&gt; last;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æ‰§è¡Œpoll(æ¶ˆè´¹æ€§æ“ä½œ)éœ€è¦è·å–çš„é”ï¼Œç®€ç§°æ¶ˆè´¹é” */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ‰§è¡Œå‡ºé˜Ÿæ“ä½œçš„çº¿ç¨‹ä¼šè¢«æ”¾å…¥çš„æ¡ä»¶é˜Ÿåˆ— */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty = takeLock.newCondition();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æ‰§è¡Œoffer(ç”Ÿäº§æ€§æ“ä½œ)éœ€è¦è·å–çš„é”ï¼Œç®€ç§°ç”Ÿäº§é” */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å½“é˜Ÿåˆ—ä¸ºæ»¡æ—¶ï¼Œæ‰§è¡Œå…¥é˜Ÿæ“ä½œçš„çº¿ç¨‹ä¼šè¢«æ”¾å…¥çš„æ¡ä»¶é˜Ÿåˆ— */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notFull = putLock.newCondition();</span><br></pre></td></tr></table></figure>



<h2 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ— å‚æ„é€ ï¼Œé»˜è®¤å®¹é‡ä¸ºInteger.MAX_VALUE</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¹é‡æ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">    last = head = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é›†åˆæ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(Integer.MAX_VALUE);</span><br><span class="line">    <span class="comment">// è·å–ç”Ÿäº§é”ï¼Œå¹¶åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</span><br><span class="line">    putLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (E e : c) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">            <span class="keyword">if</span> (n == capacity)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Queue full&quot;</span>);</span><br><span class="line">            enqueue(<span class="keyword">new</span> Node&lt;E&gt;(e));</span><br><span class="line">            ++n;</span><br><span class="line">        &#125;</span><br><span class="line">        count.set(n);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾ç”Ÿäº§é”</span></span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="offer-E-e"><a href="#offer-E-e" class="headerlink" title="offer(E e)"></a>offer(E e)</h2><p>ç”¨é€”ï¼šå‘é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœé˜Ÿåˆ—ä¸­æœ‰ç©ºé—²ä½ç½®åˆ™æ’å…¥æˆåŠŸåè¿”å›trueï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡åˆ™ä¸¢å¼ƒå½“å‰å…ƒç´ ç„¶åè¿”å›falseã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (1) å‚æ•°éªŒç©º</span></span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// (2) å¦‚æœå½“å‰é˜Ÿåˆ—æ»¡åˆ™ä¸¢å¼ƒå°†è¦æ”¾å…¥çš„å…ƒç´ ï¼Œè¿”å›false</span></span><br><span class="line">    <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</span><br><span class="line">    <span class="keyword">if</span> (count.get() == capacity)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// (3) æ„é€ æ–°èŠ‚ç‚¹</span></span><br><span class="line">    Node&lt;E&gt; node = <span class="keyword">new</span> Node&lt;E&gt;(e);</span><br><span class="line">    <span class="comment">// (4) è·å–putLockç‹¬å é”ï¼Œå¹¶åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</span><br><span class="line">    putLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// (5) å¦‚æœé˜Ÿåˆ—ä¸æ»¡åˆ™æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œå¹¶é€’å¢å…ƒç´ è®¡æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (count.get() &lt; capacity) &#123;</span><br><span class="line">            enqueue(node);</span><br><span class="line">            c = count.getAndIncrement();</span><br><span class="line">            <span class="comment">// (6) å¦‚æœæ–°å…ƒç´ å…¥é˜Ÿåè¿˜æœ‰å‰©ä½™ç©ºé—´ï¼Œåˆ™å”¤é†’å…¥é˜Ÿé˜»å¡é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">                notFull.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// (7) é‡Šæ”¾putLocké”</span></span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// (8) cä¸ºæ–°èŠ‚ç‚¹æ·»åŠ å‰çš„é˜Ÿåˆ—èŠ‚ç‚¹å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="comment">// c == 0è¡¨ç¤ºæ·»åŠ åé˜Ÿåˆ—ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå”¤é†’å‡ºé˜Ÿæ¡ä»¶é˜Ÿåˆ—ä¸­çš„é˜»å¡çº¿ç¨‹è¿›è¡Œæ¶ˆè´¹</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        signalNotEmpty();</span><br><span class="line">    <span class="keyword">return</span> c &gt;= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ å…ƒç´ åˆ°é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Node&lt;E&gt; node)</span> </span>&#123;</span><br><span class="line">    last = last.next = node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å”¤é†’å‡ºé˜Ÿæ¡ä»¶é˜Ÿåˆ—ä¸­çš„é˜»å¡çº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">signalNotEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">this</span>.takeLock;</span><br><span class="line">    takeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        notEmpty.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="offer-E-e-long-timeout-TimeUnit-unit"><a href="#offer-E-e-long-timeout-TimeUnit-unit" class="headerlink" title="offer(E e, long timeout, TimeUnit unit)"></a>offer(E e, long timeout, TimeUnit unit)</h2><p>ç”¨é€”ï¼šå‘é˜Ÿåˆ—å°¾éƒ¨æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚å¦‚æœé˜Ÿåˆ—ä¸­æœ‰ç©ºé—²ä½ç½®åˆ™æ’å…¥æˆåŠŸåè¿”å›trueï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ç­‰å¾…æŒ‡å®šæ—¶é—´çœ‹æ˜¯å¦æœ‰ç©ºä½™ä½ç½®ï¼Œæœ‰ç©ºé—²ä½ç½®åˆ™æ’å…¥æˆåŠŸåè¿”å›trueï¼Œè¶…æ—¶åè¿”å›falseã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e, <span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// (1) å‚æ•°éªŒç©º</span></span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// (2) è®°å½•éœ€è¦ç­‰å¾…æ—¶é—´</span></span><br><span class="line">    <span class="keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// (3) è·å–putLockç‹¬å é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</span><br><span class="line">    <span class="comment">// (4) è·å–é˜Ÿåˆ—å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</span><br><span class="line">    <span class="comment">// (5) åŠ é”</span></span><br><span class="line">    putLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// (6) é˜Ÿåˆ—å·²æ»¡ï¼Œçœ‹åœ¨è¶…æ—¶æ—¶é—´ä¹‹å†…æ˜¯å¦æœ‰æ¶ˆè´¹æ“ä½œäº§ç”Ÿç©ºä½™ä½ç½®</span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == capacity) &#123;</span><br><span class="line">            <span class="comment">// (7) è¶…æ—¶ï¼Œç›´æ¥è¿”å›false</span></span><br><span class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// (8) awaitNanosè¿”å›æä¾›æ—¶é—´çš„å‰©ä½™æ—¶é—´ï¼Œå°äº0ä»£è¡¨è¶…æ—¶</span></span><br><span class="line">            nanos = notFull.awaitNanos(nanos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// (9) å°†æ–°èŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨ï¼Œé˜Ÿåˆ—å…ƒç´ æ•°é‡é€’å¢</span></span><br><span class="line">        enqueue(<span class="keyword">new</span> Node&lt;E&gt;(e));</span><br><span class="line">        c = count.getAndIncrement();</span><br><span class="line">        <span class="comment">// (10) é˜Ÿåˆ—ä¸­å°šæœ‰ç©ºä½ï¼Œå”¤é†’å…¥é˜Ÿæ¡ä»¶é˜Ÿåˆ—ä¸­çš„é˜»å¡çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">            notFull.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// (11) é‡Šæ”¾é”</span></span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// (12) å”¤é†’å‡ºé˜Ÿæ¡ä»¶é˜Ÿåˆ—ä¸­çš„é˜»å¡çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        signalNotEmpty();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="poll"><a href="#poll" class="headerlink" title="poll()"></a>poll()</h2><p>ç”¨é€”ï¼šä»é˜Ÿåˆ—å¤´éƒ¨è·å–å¹¶ç§»é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å›nullã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (1) å¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å›null</span></span><br><span class="line">    <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</span><br><span class="line">    <span class="keyword">if</span> (count.get() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    E x = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> c = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// (2) è·å–ç‹¬å é”ï¼ŒåŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">this</span>.takeLock;</span><br><span class="line">    takeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// (3) é˜Ÿåˆ—ä¸ç©ºåˆ™å‡ºé˜Ÿï¼Œé€’å‡å…ƒç´ æ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> (count.get() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            x = dequeue();</span><br><span class="line">            c = count.getAndDecrement();</span><br><span class="line">            <span class="comment">// (4) cå¤§äº1ï¼Œå½“å‰çº¿ç¨‹ç§»é™¤é˜Ÿåˆ—é‡Œé¢ä¸€ä¸ªå…ƒç´ åé˜Ÿåˆ—ä¸ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</span><br><span class="line">                notEmpty.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// (5) é‡Šæ”¾é”</span></span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// (6) cä¸ºç§»é™¤èŠ‚ç‚¹å‰çš„é˜Ÿåˆ—å…ƒç´ æ•°é‡</span></span><br><span class="line">    <span class="comment">// c == capacityè¡¨ç¤ºç§»é™¤åäº§ç”Ÿä¸€ä¸ªç©ºä½ï¼Œå”¤é†’å…¥é˜Ÿæ¡ä»¶é˜Ÿåˆ—çš„é˜»å¡çº¿ç¨‹è¿›è¡Œç”Ÿæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (c == capacity)</span><br><span class="line">        signalNotFull();</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç§»é™¤é˜Ÿé¦–èŠ‚ç‚¹head</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">dequeue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node&lt;E&gt; h = head;</span><br><span class="line">    Node&lt;E&gt; first = h.next;</span><br><span class="line">    h.next = h; <span class="comment">// help GC</span></span><br><span class="line">    head = first;</span><br><span class="line">    E x = first.item;</span><br><span class="line">    first.item = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å”¤é†’å…¥é˜Ÿé˜Ÿåˆ—ä¸­é˜»å¡çº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">signalNotFull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</span><br><span class="line">    putLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        notFull.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="remove-Object-o"><a href="#remove-Object-o" class="headerlink" title="remove(Object o)"></a>remove(Object o)</h2><p>ç”¨é€”ï¼šåˆ é™¤é˜Ÿåˆ—ä¸­æŒ‡å®šçš„å…ƒç´ ï¼Œæœ‰åˆ™åˆ é™¤å¹¶è¿”å›trueï¼Œæ²¡æœ‰åˆ™è¿”å›falseã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (1) å‚æ•°éªŒç©º</span></span><br><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// (2) åŒé‡åŠ é”</span></span><br><span class="line">    fullyLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// (3) éå†é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; trail = head, p = trail.next;</span><br><span class="line">             p != <span class="keyword">null</span>;</span><br><span class="line">             trail = p, p = p.next) &#123;</span><br><span class="line">            <span class="comment">// (4) æ‰¾åˆ°èŠ‚ç‚¹ï¼Œåˆ™åˆ é™¤èŠ‚ç‚¹å¹¶è¿”å›true</span></span><br><span class="line">            <span class="keyword">if</span> (o.equals(p.item)) &#123;</span><br><span class="line">                unlink(p, trail);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// (5) æ‰¾ä¸åˆ°åˆ™è¿”å›false</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// (6) åŒé‡è§£é”</span></span><br><span class="line">        fullyUnlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ é™¤èŠ‚ç‚¹p</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlink</span><span class="params">(Node&lt;E&gt; p, Node&lt;E&gt; trail)</span> </span>&#123;</span><br><span class="line">    p.item = <span class="keyword">null</span>;</span><br><span class="line">    trail.next = p.next;</span><br><span class="line">    <span class="keyword">if</span> (last == p)</span><br><span class="line">        last = trail;</span><br><span class="line">    <span class="comment">// å¦‚æœåˆ é™¤å‰é˜Ÿåˆ—ä¸ºæ»¡ï¼Œé‚£ä¹ˆåˆ é™¤ååˆ™äº§ç”Ÿä¸€ä¸ªç©ºä½ï¼Œå”¤é†’å…¥é˜Ÿæ¡ä»¶é˜Ÿåˆ—çš„é˜»å¡çº¿ç¨‹è¿›è¡Œç”Ÿäº§</span></span><br><span class="line">    <span class="keyword">if</span> (count.getAndDecrement() == capacity)</span><br><span class="line">        notFull.signal();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»™ç”Ÿäº§é”å’Œæ¶ˆè´¹é”éƒ½åŠ é”</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fullyLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    putLock.lock();</span><br><span class="line">    takeLock.lock();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”Ÿäº§é”å’Œæ¶ˆè´¹é”éƒ½é‡Šæ”¾é”</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fullyUnlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    takeLock.unlock();</span><br><span class="line">    putLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="size"><a href="#size" class="headerlink" title="size()"></a>size()</h2><p>ç”¨é€”ï¼šè·å–å½“å‰é˜Ÿåˆ—å…ƒç´ ä¸ªæ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> count.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äºè¿›è¡Œå‡ºé˜Ÿã€å…¥é˜Ÿæ“ä½œæ—¶çš„countæ˜¯åŠ é”çš„ï¼Œæ‰€ä»¥ç»“æœç›¸æ¯”<code>ConcurrentLinkedQueue</code>çš„<code>size</code>æ–¹æ³•æ¯”è¾ƒå‡†ç¡®çš„ã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆ<code>ConcurrentLinkedQueue</code>åªèƒ½é€šè¿‡éå†é“¾è¡¨è€Œä¸èƒ½ä½¿ç”¨åŸå­å˜é‡å‘¢ï¼Ÿ</p>
<p>å› ä¸ºä½¿ç”¨åŸå­å˜é‡ä¿å­˜é˜Ÿåˆ—èŠ‚ç‚¹ä¸ªæ•°éœ€è¦ä¿è¯å…¥é˜Ÿã€å‡ºé˜Ÿæ“ä½œå’ŒåŸå­å˜é‡æ“ä½œéƒ½æ˜¯åŸå­æ€§æ“ä½œï¼Œè€Œ<code>ConcurrentLinkedQueue</code>ä½¿ç”¨çš„æ˜¯CASæ— é”ç®—æ³•ï¼Œæ— æ³•ä¿è¯ã€‚</p>
</blockquote>
<h2 id="æœ€åå°ç»“"><a href="#æœ€åå°ç»“" class="headerlink" title="æœ€åå°ç»“"></a>æœ€åå°ç»“</h2><p><code>LinkedBlockingQueue</code>çš„å†…éƒ¨æ˜¯é€šè¿‡å•å‘é“¾è¡¨å®ç°çš„ï¼Œä½¿ç”¨å¤´ã€å°¾èŠ‚ç‚¹æ¥è¿›è¡Œå…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œï¼Œå³å…¥é˜Ÿæ“ä½œéƒ½æ˜¯å¯¹å¤´èŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œå‡ºé˜Ÿæ“ä½œéƒ½æ˜¯å¯¹å°¾èŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33015/operate.svg" class="" title="operate">



<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¯¹å¤´ã€å°¾èŠ‚ç‚¹çš„æ“ä½œåˆ†åˆ«ä½¿ç”¨äº†å•ç‹¬çš„ç‹¬å é”ä»è€Œä¿è¯äº†åŸå­æ€§ï¼Œæ‰€ä»¥å‡ºé˜Ÿå’Œå…¥é˜Ÿæ“ä½œæ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ã€‚å¦å¤–å¯¹å¤´ã€å°¾èŠ‚ç‚¹éƒ½é…å¤‡äº†ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜æ”¾è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œå¹¶ç»“åˆå…¥é˜Ÿã€å‡ºé˜Ÿæ“ä½œå®ç°äº†ä¸€ä¸ªç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>Spring-äº‹åŠ¡åŸç†</title>
    <url>/posts/15536/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="äº‹åŠ¡ä½¿ç”¨"><a href="#äº‹åŠ¡ä½¿ç”¨" class="headerlink" title="äº‹åŠ¡ä½¿ç”¨"></a>äº‹åŠ¡ä½¿ç”¨</h2><p>å¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åŒ…ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">top</span><br><span class="line">â””â”€parak</span><br><span class="line">    â”œâ”€entity</span><br><span class="line">    â”‚   â””â”€User</span><br><span class="line">    â”œâ”€mapper</span><br><span class="line">    â”‚   â””â”€UserMapper</span><br><span class="line">    â”œâ”€service</span><br><span class="line">    â”‚   â”‚   â””â”€UserService</span><br><span class="line">    â”‚   â””â”€impl</span><br><span class="line">    â”‚       â””â”€UserServiceImpl</span><br><span class="line">    â””â”€KHighnessApplication</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºæ•°æ®åº“ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·å&#x27;</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="built_in">int</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·å¹´é¾„&#x27;</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">4</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>
<p>é…ç½®æ–‡ä»¶ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=KAG1823</span><br><span class="line">spring.datasource.url=jdbc:mysql://127.0.0.1:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=GMT%2b8</span><br><span class="line">logging.level.top.parak.mapper=debug</span><br></pre></td></tr></table></figure>
<p>å®ä½“ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºæŒä¹…æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into user(username,age) values(#&#123;username&#125;,#&#123;age&#125;)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºä¸šåŠ¡æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºä¸šåŠ¡å®ç°ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        <span class="keyword">if</span> (!user.getUsername().contains(<span class="string">&quot;K&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;ç”¨æˆ·åä¸å«æœ‰K&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºå¯åŠ¨ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> SpringApplicationBuilder(KHighnessApplication.class)</span><br><span class="line">                .web(WebApplicationType.SERVLET).run(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºæµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KHighnessApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> User user1 = <span class="keyword">new</span> User();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> User user2 = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeEach</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        user1.setUsername(<span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">        user2.setUsername(<span class="string">&quot;Flower&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        userService.saveUser(user1);</span><br><span class="line">        userService.saveUser(user2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image1.png" class="" title="image1"><br />
<p>è¯´æ˜user1æ’å…¥ï¼Œuser2å›æ»šã€‚</p>
<h2 id="äº‹åŠ¡åŸç†"><a href="#äº‹åŠ¡åŸç†" class="headerlink" title="äº‹åŠ¡åŸç†"></a>äº‹åŠ¡åŸç†</h2><h3 id="EnableTransactionManagement"><a href="#EnableTransactionManagement" class="headerlink" title="@EnableTransactionManagement"></a>@EnableTransactionManagement</h3><p>ç›´æ¥æŸ¥çœ‹æ¨¡å—é©±åŠ¨æ³¨è§£<code>@EnableTransactionManagement</code> çš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(TransactionManagementConfigurationSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableTransactionManagement &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">proxyTargetClass</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">AdviceMode <span class="title">mode</span><span class="params">()</span> <span class="keyword">default</span> AdviceMode.PROXY</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">order</span><span class="params">()</span> <span class="keyword">default</span> Ordered.LOWEST_PRECEDENCE</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ³¨è§£é€šè¿‡<code>@Import</code>å‘å®¹å™¨ä¸­å¯¼å…¥äº†ä¸€ä¸ª<code>TransactionManagementConfigurationSelector</code>ç»„ä»¶ï¼ŒæŸ¥çœ‹å…¶æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image2.png" class="" title="image2"><br />


<h3 id="AutoRegistrar"><a href="#AutoRegistrar" class="headerlink" title="AutoRegistrar"></a>AutoRegistrar</h3><p>æŸ¥çœ‹<code>AutoProxyRegistrar</code>çš„æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image3.png" class="" title="image3"><br />
<p>æŸ¥çœ‹<code>AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry)</code>æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image4.png" class="" title="image4"><br />
<p>æŸ¥çœ‹<code>InfrastructureAdvisorAutoProxyCreator</code>çš„å±‚çº§å…³ç³»å›¾ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image5.png" class="" title="image5"><br />
<p>è¿™ä¸ªå’ŒAOPä¸­çš„<code>AnnotationAwareAspectJAutoProxyCreator</code>çš„å±‚çº§å…³ç³»å›¾ä¸€è‡´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ¨æ–­å‡º<code>InfrastructureAdvisorAutoProxyCreator</code>çš„ä½œç”¨ä¸ºï¼šä¸ºç›®æ ‡Serviceåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå¢å¼ºç›®æ ‡Serviceæ–¹æ³•ï¼Œç”¨äºäº‹åŠ¡æ§åˆ¶ã€‚</p>
<h3 id="ProxyTransactionManagementConfiguration"><a href="#ProxyTransactionManagementConfiguration" class="headerlink" title="ProxyTransactionManagementConfiguration"></a>ProxyTransactionManagementConfiguration</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image6.png" class="" title="image6"><br />
<ol>
<li>æ³¨å†Œ<code>BeanFactoryTransactionAttributeSourceAdvisor</code>å¢å¼ºå™¨ï¼Œè¯¥å¢å¼ºå™¨éœ€è¦å¦‚ä¸‹ä¸¤ä¸ªBean<ul>
<li>TransactionAttributeSource</li>
<li>TransactionInterceptor</li>
</ul>
</li>
<li>æ³¨å†ŒTransactionAttributeSource</li>
</ol>
<p>æŸ¥çœ‹<code>AnnotationTransactionAttributeSource</code>æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image7.png" class="" title="image7"><br />
<p>æŸ¥çœ‹<code>SpringTransactionAnnotationParser</code>æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image8.png" class="" title="image8"><br />

<ol start="3">
<li>æ³¨å†Œ<code>TransactionInterceptor</code>äº‹åŠ¡æ‹¦æˆªå™¨</li>
</ol>
<p>æŸ¥çœ‹<code>TransactionInterceptor</code>æºç ï¼Œå…¶å®ç°äº†<code>MethodInterceptor</code>æ–¹æ³•æ‹¦æˆªå™¨æ¥å£ï¼Œç›®æ ‡æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯¹åº”æ‹¦æˆªå™¨çš„<code>invoke</code>æ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥é‡ç‚¹å…³æ³¨<code>TransactionInterceptor</code>å®ç°çš„<code>invoke</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image9.png" class="" title="image9"><br />
<p>æŸ¥çœ‹<code>invokeWithinTransaction</code>æ–¹æ³•æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image10.png" class="" title="image10"><br />
<p>æŸ¥çœ‹<code>completeTransactionAfterThrowing</code>æ–¹æ³•æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image11.png" class="" title="image11"><br />
<p>è¿™é‡Œï¼Œå¦‚æœæ²¡æœ‰åœ¨<code>@Transaction</code>æ³¨è§£ä¸ŠæŒ‡å®šå›æ»šçš„å¼‚å¸¸ç±»å‹çš„è¯ï¼Œé»˜è®¤åªå¯¹<code>RuntimeException</code>å’Œ<code>Error</code>ç±»å‹çš„å¼‚å¸¸è¿›è¡Œå›æ»šï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image12.png" class="" title="image12"><br />
<p>å†çœ‹<code>commitTransactionAfterReturning</code>æ–¹æ³•æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image13.png" class="" title="image13"><br />


<h3 id="DEBUGéªŒè¯"><a href="#DEBUGéªŒè¯" class="headerlink" title="DEBUGéªŒè¯"></a>DEBUGéªŒè¯</h3><p>åœ¨æµ‹è¯•ä»£ç ä¸Šæ‰“ä¸Šæ–­ç‚¹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image14.png" class="" title="image14"><br />
<p>ä»¥DEBUGæ–¹å¼è¿è¡Œtest2ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image15.png" class="" title="image15"><br />
<p>å¯ä»¥çœ‹åˆ°ç›®æ ‡å¯¹è±¡å·²ç»è¢«JDKä»£ç†ï¼ˆå› ä¸ºUserServiceImplå®ç°äº†æ¥å£ï¼Œæ‰€ä»¥é‡‡ç”¨JDKåŠ¨æ€ä»£ç†ï¼‰ã€‚<br>åœ¨æ–­ç‚¹å¤„æ‰§è¡ŒStep Intoï¼Œç¨‹åºè·³è½¬åˆ°<code>JdkDynamicAopProxy</code>çš„<code>invoke</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image16.png" class="" title="image16"><br />
<p>åœ¨<code>invocation.proceed()</code>å¤„ç»§ç»­Step Intoï¼ŒæŸ¥çœ‹å†…éƒ¨è°ƒç”¨è¿‡ç¨‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image17.png" class="" title="image17"><br />
<p>ç‚¹å‡»Step Intoï¼Œç¨‹åºè·³è½¬åˆ°<code>TransactionInterceptor</code>çš„<code>invoke</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image18.png" class="" title="image18"><br />
<p>ç»§ç»­Step Intoï¼Œç¨‹åºè·³è½¬åˆ°<code>TransactionAspectSupport</code>çš„<code>invokeWithinTransaction</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image19.png" class="" title="image19"><br />


<h2 id="ä¸ç”Ÿæ•ˆåœºæ™¯"><a href="#ä¸ç”Ÿæ•ˆåœºæ™¯" class="headerlink" title="ä¸ç”Ÿæ•ˆåœºæ™¯"></a>ä¸ç”Ÿæ•ˆåœºæ™¯</h2><h3 id="åœºæ™¯ä¸€"><a href="#åœºæ™¯ä¸€" class="headerlink" title="åœºæ™¯ä¸€"></a>åœºæ™¯ä¸€</h3><p>Serviceæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ä¸æ˜¯RuntimeExceptionæˆ–è€…Errorç±»å‹ï¼Œå¹¶ä¸”<code>@Transactional</code>æ³¨è§£ä¸Šæ²¡æœ‰æŒ‡å®šå›æ»šå¼‚å¸¸ç±»å‹ã€‚<br>â€‹</p>
<p><strong>åŸå› </strong><br>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpringäº‹åŠ¡åªå¯¹RuntimeExceptionæˆ–è€…Errorç±»å‹å¼‚å¸¸è¿›è¡Œå›æ»šï¼Œæ£€æŸ¥å¼‚å¸¸ï¼ˆé€šå¸¸ä¸ºä¸šåŠ¡ç±»å¼‚å¸¸ï¼‰ä¸ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šã€‚<br>â€‹</p>
<p><strong>è§£å†³</strong></p>
<ol>
<li>æ‰‹åŠ¨åœ¨<code>@Transactional</code>æ³¨è§£ä¸Šå£°æ˜å›æ»šçš„å¼‚å¸¸ç±»å‹<code>rollbackFor</code>ï¼ˆæ–¹æ³•æŠ›å‡ºè¯¥å¼‚å¸¸åŠå…¶æ‰€æœ‰å­ç±»å‹å¼‚å¸¸éƒ½èƒ½å‡ºå‘äº‹åŠ¡å›æ»šï¼‰ï¼š</li>
<li>å°†æ–¹æ³•å†…æŠ›å‡ºçš„å¼‚å¸¸ç»§æ‰¿RuntimeExceptionã€‚</li>
</ol>
<h3 id="åœºæ™¯äºŒ"><a href="#åœºæ™¯äºŒ" class="headerlink" title="åœºæ™¯äºŒ"></a>åœºæ™¯äºŒ</h3><p>éäº‹åŠ¡æ–¹æ³•ç›´æ¥é€šè¿‡<code>this</code>è°ƒç”¨æœ¬ç±»äº‹åŠ¡æ–¹æ³•ã€‚<br>æ¯”å¦‚ï¼Œä¿®æ”¹UserServiceImplå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        <span class="keyword">if</span> (!user.getUsername().contains(<span class="string">&quot;K&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;ç”¨æˆ·åä¸å«æœ‰K&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser2</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.saveUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    userService.saveUser2(user2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/image20.png" class="" title="image20"><br />
<p>å‘ç°æ’å…¥æˆåŠŸï¼Œè¯´æ˜äº‹åŠ¡ä¸ç”Ÿæ•ˆã€‚</p>
<p><strong>åŸå› </strong><br>è¿™è®©æˆ‘æƒ³èµ·é¢è¯•å­—èŠ‚æ—¶ä¸€ä¸ªAOPçš„é¢è¯•é¢˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@log</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">A</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">B</span><span class="params">()</span> </span>&#123; A(); &#125;</span><br></pre></td></tr></table></figure>
<p>é—®ç›´æ¥é€šè¿‡<code>this.B()</code>è°ƒç”¨<code>A()</code>æ–¹æ³•èƒ½å¦æ‰“å°æ—¥å¿—ã€‚ç­”æ¡ˆå½“ç„¶æ˜¯ä¸èƒ½çš„ã€‚<br>AOPçš„å®ç°æ˜¯é€šè¿‡ç›®æ ‡ç±»çš„JDKåŠ¨æ€ä»£ç†ç±»æˆ–è€…CGlibåŠ¨æ€ä»£ç†ç±»æ¥å®ç°çš„ï¼Œç›´æ¥è°ƒç”¨æ–¹æ³•è°ƒç”¨çš„æ˜¯ç›®æ ‡ç±»çš„æ–¹æ³•è€Œä¸æ˜¯ä»£ç†ç±»çš„å¢å¼ºåæ–¹æ³•ï¼Œå› æ­¤ä¸èƒ½æ‰“å°å‡ºæ—¥å¿—ã€‚<br>Springäº‹åŠ¡æ§åˆ¶ä½¿ç”¨AOPä»£ç†å®ç°ï¼Œé€šè¿‡å¯¹ç›®æ ‡å¯¹è±¡çš„ä»£ç†æ¥å¢å¼ºç›®æ ‡æ–¹æ³•ï¼Œç›´æ¥é€šè¿‡<code>this</code>è°ƒç”¨æœ¬ç±»çš„æ–¹æ³•çš„æ—¶å€™ï¼Œ<code>this</code>çš„æŒ‡å‘å¹¶éä»£ç†ç±»ï¼Œè€Œæ˜¯ç›®æ ‡ç±»æœ¬èº«ã€‚<br>â€‹</p>
<p><strong>è§£å†³</strong><br>ä»IOCå®¹å™¨ä¸­è·å–<code>UserService</code>ï¼Œç„¶åè°ƒç”¨<code>saveUser</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span>, <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserMapper userMapper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.save(user);</span><br><span class="line">        <span class="keyword">if</span> (!user.getUsername().contains(<span class="string">&quot;K&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;ç”¨æˆ·åä¸å«æœ‰K&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser2</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        UserService userService = applicationContext.getBean(UserService.class);</span><br><span class="line">        userService.saveUser(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="æœ€ç»ˆæ€»ç»“"><a href="#æœ€ç»ˆæ€»ç»“" class="headerlink" title="æœ€ç»ˆæ€»ç»“"></a>æœ€ç»ˆæ€»ç»“</h2><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/15536/last.png" class="" title="last"><br />

<p>æ¨¡å—é©±åŠ¨æ³¨è§£<code>@EnableTransactionManagement</code>é€šè¿‡<code>@Import</code>å¯¼å…¥äº†ä¸€ä¸ª<code>@TransactionManagementConfigurationSelectorç»„ä»¶</code>ï¼Œå®ƒé€šè¿‡<code>selectImports</code>æ–¹æ³•æ‰¹é‡æ³¨å†Œä¸¤ä¸ªç±»ï¼š</p>
<ol>
<li>æ³¨å†Œå™¨ï¼š<code>AutoProxyRegistrar</code></li>
<li>é…ç½®ç±»ï¼š<code>ProxyTransactionManagementConfiguration</code></li>
</ol>
<p>ï¼ˆ1ï¼‰AutoProxyRegistrar</p>
<p>é€šè¿‡<code>AopConfigUtils</code>å‘å®¹å™¨ä¸­æ³¨å†Œ<code>InfrastructureAdvisorAutoProxyCreator</code>ï¼Œä½œç”¨æ˜¯ä¸ºç›®æ ‡Serviceåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå¢å¼ºServiceæ–¹æ³•ï¼Œç”¨äºäº‹åŠ¡æ§åˆ¶ã€‚</p>
<p>ï¼ˆ2ï¼‰ProxyTransactionManagementConfiguration</p>
<p>ä¸»è¦å‘å®¹å™¨ä¸­æ³¨å†Œä¸¤ä¸ªbeanï¼š</p>
<p>â‘  <code>BeanFactoryTransactionAttributeSourceAdvisor</code></p>
<p>â‘¡ <code>TransactionInterceptor</code></p>
<p>â‘ åˆ›å»º<code>SpringTransactionAnnotationParser</code>ï¼Œè§£æ<code>@Transaction</code>æ³¨è§£ä¸Šçš„å„ä¸ªå±æ€§å€¼ï¼ŒåŒ…è£…ä¸ºTransactionå¯¹è±¡</p>
<p>â‘¡ å®ç°äº†<code>MethodInterceptor</code>æ–¹æ³•æ‹¦æˆªå™¨ï¼Œåœ¨<code>invoke</code>æ–¹æ³•ä¸­å…ˆå¤„ç†å’ŒKotlinç›¸å…³å†…å®¹ï¼Œå†æ‰§è¡Œ<code>invokeWithTransaction</code>æ–¹æ³•ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•æ˜¯äº‹åŠ¡æ ¸å¿ƒï¼Œå…ˆè·å–ç›®æ ‡æ–¹æ³•çš„<code>@Transaction</code>æ³¨è§£çš„å±æ€§ï¼Œå†è·å–äº‹åŠ¡ç®¡ç†å™¨<code>JdbcTransactionManager</code>ï¼Œåœ¨ä¸€ä¸ªtry-catchå—ä¸­é€šè¿‡åå°„æ‰§è¡Œç›®æ ‡æ–¹æ³•<code>proceedWithInvocation</code></p>
<ul>
<li>å‡ºç°å¼‚å¸¸åˆ™æ‰§è¡Œ<code>completeTransactionThrowing</code>æ–¹æ³•ï¼šéœ€è¦åˆ¤æ–­æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸æ˜¯å¦åœ¨æŒ‡å®šçš„èŒƒå›´å†…ï¼Œæ˜¯åˆ™é€šè¿‡äº‹åŠ¡ç®¡ç†å™¨å›æ»šäº‹åŠ¡ï¼Œå¦åˆ™æäº¤äº‹åŠ¡ã€‚</li>
<li>æˆåŠŸåˆ™æ‰§è¡Œ<code>commitTransactionAfterReturning</code>æ–¹æ³•ï¼šé€šè¿‡äº‹åŠ¡ç®¡ç†å™¨æäº¤äº‹åŠ¡ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-json</title>
    <url>/posts/22416/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>å‡†å¤‡</p>
</blockquote>
<p>å®ä½“ç±»User</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3180230416244251692L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// NoArgsConstructor</span></span><br><span class="line">    <span class="comment">// AllArgsConstructor</span></span><br><span class="line">    <span class="comment">// Getter and Setter</span></span><br><span class="line">    <span class="comment">// ToString</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ObjectMapper-API"><a href="#ObjectMapper-API" class="headerlink" title="ObjectMapper API"></a>ObjectMapper API</h2><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/22416/objectmapper.png" class="" title="objectmapper">



<h2 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><p>åºåˆ—åŒ–å±æ€§SerializationFeature</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">WRAP_ROOT_VALUE(<span class="keyword">false</span>),                   </span><br><span class="line">INDENT_OUTPUT(<span class="keyword">false</span>),</span><br><span class="line">FAIL_ON_EMPTY_BEANS(<span class="keyword">true</span>),</span><br><span class="line">FAIL_ON_SELF_REFERENCES(<span class="keyword">true</span>),</span><br><span class="line">WRAP_EXCEPTIONS(<span class="keyword">true</span>),</span><br><span class="line">FAIL_ON_UNWRAPPED_TYPE_IDENTIFIERS(<span class="keyword">true</span>),</span><br><span class="line">CLOSE_CLOSEABLE(<span class="keyword">false</span>),</span><br><span class="line">FLUSH_AFTER_WRITE_VALUE(<span class="keyword">true</span>),</span><br><span class="line">WRITE_DATES_AS_TIMESTAMPS(<span class="keyword">true</span>),</span><br><span class="line">WRITE_DATE_KEYS_AS_TIMESTAMPS(<span class="keyword">false</span>),</span><br><span class="line">WRITE_DATES_WITH_ZONE_ID(<span class="keyword">false</span>),</span><br><span class="line">WRITE_DURATIONS_AS_TIMESTAMPS(<span class="keyword">true</span>),</span><br><span class="line">WRITE_CHAR_ARRAYS_AS_JSON_ARRAYS(<span class="keyword">false</span>),</span><br><span class="line">WRITE_ENUMS_USING_TO_STRING(<span class="keyword">false</span>),</span><br><span class="line">WRITE_ENUMS_USING_INDEX(<span class="keyword">false</span>),</span><br><span class="line">WRITE_ENUM_KEYS_USING_INDEX(<span class="keyword">false</span>),</span><br><span class="line">WRITE_SINGLE_ELEM_ARRAYS_UNWRAPPED(<span class="keyword">false</span>),</span><br><span class="line">WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS(<span class="keyword">true</span>),</span><br><span class="line">ORDER_MAP_ENTRIES_BY_KEYS(<span class="keyword">false</span>),</span><br><span class="line">EAGER_SERIALIZER_FETCH(<span class="keyword">true</span>),</span><br><span class="line">USE_EQUALITY_FOR_OBJECT_ID(<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<p>ååºåˆ—åŒ–å±æ€§DeserializationFeature</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">USE_BIG_DECIMAL_FOR_FLOATS(<span class="keyword">false</span>),</span><br><span class="line">USE_BIG_INTEGER_FOR_INTS(<span class="keyword">false</span>),</span><br><span class="line">USE_LONG_FOR_INTS(<span class="keyword">false</span>),</span><br><span class="line">USE_JAVA_ARRAY_FOR_JSON_ARRAY(<span class="keyword">false</span>),</span><br><span class="line">FAIL_ON_UNKNOWN_PROPERTIES(<span class="keyword">true</span>),</span><br><span class="line">FAIL_ON_NULL_FOR_PRIMITIVES(<span class="keyword">false</span>),</span><br><span class="line">FAIL_ON_NUMBERS_FOR_ENUMS(<span class="keyword">false</span>),</span><br><span class="line">FAIL_ON_INVALID_SUBTYPE(<span class="keyword">true</span>),</span><br><span class="line">FAIL_ON_READING_DUP_TREE_KEY(<span class="keyword">false</span>),</span><br><span class="line">FAIL_ON_IGNORED_PROPERTIES(<span class="keyword">false</span>),</span><br><span class="line">FAIL_ON_UNRESOLVED_OBJECT_IDS(<span class="keyword">true</span>),</span><br><span class="line">FAIL_ON_MISSING_CREATOR_PROPERTIES(<span class="keyword">false</span>),</span><br><span class="line">FAIL_ON_NULL_CREATOR_PROPERTIES(<span class="keyword">false</span>),</span><br><span class="line">FAIL_ON_MISSING_EXTERNAL_TYPE_ID_PROPERTY(<span class="keyword">true</span>),</span><br><span class="line">FAIL_ON_TRAILING_TOKENS(<span class="keyword">false</span>),</span><br><span class="line">WRAP_EXCEPTIONS(<span class="keyword">true</span>),</span><br><span class="line">ACCEPT_SINGLE_VALUE_AS_ARRAY(<span class="keyword">false</span>),</span><br><span class="line">UNWRAP_SINGLE_VALUE_ARRAYS(<span class="keyword">false</span>),</span><br><span class="line">UNWRAP_ROOT_VALUE(<span class="keyword">false</span>),</span><br><span class="line">ACCEPT_EMPTY_STRING_AS_NULL_OBJECT(<span class="keyword">false</span>),</span><br><span class="line">ACCEPT_EMPTY_ARRAY_AS_NULL_OBJECT(<span class="keyword">false</span>),</span><br><span class="line">ACCEPT_FLOAT_AS_INT(<span class="keyword">true</span>),</span><br><span class="line">READ_ENUMS_USING_TO_STRING(<span class="keyword">false</span>),</span><br><span class="line">READ_UNKNOWN_ENUM_VALUES_AS_NULL(<span class="keyword">false</span>),</span><br><span class="line">READ_UNKNOWN_ENUM_VALUES_USING_DEFAULT_VALUE(<span class="keyword">false</span>),</span><br><span class="line">READ_DATE_TIMESTAMPS_AS_NANOSECONDS(<span class="keyword">true</span>),</span><br><span class="line">ADJUST_DATES_TO_CONTEXT_TIME_ZONE(<span class="keyword">true</span>),</span><br><span class="line">EAGER_DESERIALIZER_FETCH(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>



<h2 id="environmenté…ç½®"><a href="#environmenté…ç½®" class="headerlink" title="environmenté…ç½®"></a>environmenté…ç½®</h2><p>å¯é…ç½®</p>
<ul>
<li>spring.jackson.deserialization.<feature_name>=true|false</li>
<li>spring.jackson.generator.<feature_name>=true|false</li>
<li>spring.jackson.mapper.<feature_name>=true|false</li>
<li>spring.jackson.parser.<feature_name>=true|false</li>
<li>spring.jackson.serialization.<feature_name>=true|false</li>
<li>spring.jackson.serialization-inclusion=always|non_null|non_absent|non_default|non_empty</li>
</ul>
<p>application.ymlï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">jackson:</span></span><br><span class="line">    <span class="comment"># æ—¥æœŸæ ¼å¼åŒ–</span></span><br><span class="line">    <span class="attr">date-format:</span> <span class="string">yyyy-MM-dd</span> <span class="string">HH:mm:ss</span></span><br><span class="line">    <span class="comment"># è®¾ç½®ç©ºå±æ€§ä½•å¦‚åºåˆ—åŒ–</span></span><br><span class="line">    <span class="attr">default-property-inclusion:</span> <span class="string">non_empty</span></span><br><span class="line">    <span class="comment"># åºåˆ—åŒ–</span></span><br><span class="line">    <span class="attr">serialization:</span></span><br><span class="line">    <span class="comment"># ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="attr">deserialization:</span></span><br><span class="line">    <span class="comment"># è§£æ    </span></span><br><span class="line">    <span class="attr">parser:</span> </span><br></pre></td></tr></table></figure>



<h2 id="configurationé…ç½®"><a href="#configurationé…ç½®" class="headerlink" title="configurationé…ç½®"></a>configurationé…ç½®</h2><p>åœ¨@Configurationç±»ä¸­ç”Ÿæˆbeanï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JacksonConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(ObjectMapper.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectMapper <span class="title">objectMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–æ—¥æœŸæ ¼å¼</span></span><br><span class="line">        objectMapper.setDateFormat(<span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd&quot;</span>));</span><br><span class="line">        <span class="comment">// æ²¡æœ‰åŒ¹é…çš„å±æ€§åç§°æ—¶ä¸ä½œå¤„ç†</span></span><br><span class="line">        objectMapper.configure(MapperFeature.AUTO_DETECT_FIELDS, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–</span></span><br><span class="line">        <span class="comment">//ç¦æ­¢åºåˆ—åŒ–ç©ºå€¼</span></span><br><span class="line">        objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class="keyword">false</span>);</span><br><span class="line">        objectMapper.configure(SerializationFeature.WRITE_ENUMS_USING_TO_STRING, <span class="keyword">true</span>);</span><br><span class="line">        objectMapper.configure(SerializationFeature.WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS, <span class="keyword">true</span>);</span><br><span class="line">        objectMapper.configure(SerializationFeature.FLUSH_AFTER_WRITE_VALUE, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// ä¸åŒ…å«ç©ºå€¼å±æ€§</span></span><br><span class="line">        objectMapper.setSerializationInclusion(JsonInclude.Include.NON_EMPTY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–</span></span><br><span class="line">        <span class="comment">//ç¦æ­¢é‡åˆ°ç©ºåŸå§‹ç±»å‹æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œç”¨é»˜è®¤å€¼ä»£æ›¿</span></span><br><span class="line">        objectMapper.configure(DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES, <span class="keyword">false</span>);</span><br><span class="line">        objectMapper.configure(DeserializationFeature.READ_ENUMS_USING_TO_STRING, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// ç¦æ­¢é‡åˆ°æœªçŸ¥ï¼ˆæ–°ï¼‰å±æ€§æ—¶æŠ¥é”™ï¼Œæ”¯æŒå…¼å®¹æ‰©å±•</span></span><br><span class="line">        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="keyword">false</span>);</span><br><span class="line">        objectMapper.configure(DeserializationFeature.FAIL_ON_IGNORED_PROPERTIES, <span class="keyword">false</span>);</span><br><span class="line">        objectMapper.configure(DeserializationFeature.ACCEPT_EMPTY_ARRAY_AS_NULL_OBJECT, <span class="keyword">true</span>);</span><br><span class="line">        objectMapper.configure(DeserializationFeature.ACCEPT_EMPTY_STRING_AS_NULL_OBJECT, <span class="keyword">true</span>);</span><br><span class="line">        objectMapper.configure(DeserializationFeature.READ_DATE_TIMESTAMPS_AS_NANOSECONDS, <span class="keyword">true</span>);</span><br><span class="line">        objectMapper.configure(DeserializationFeature.READ_UNKNOWN_ENUM_VALUES_AS_NULL, <span class="keyword">true</span>);</span><br><span class="line">        objectMapper.configure(DeserializationFeature.READ_ENUMS_USING_TO_STRING, <span class="keyword">true</span>);</span><br><span class="line">        objectMapper.configure(DeserializationFeature.READ_ENUMS_USING_TO_STRING, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> objectMapper;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Restæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(UserController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–æ¥å£</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">&quot;KHighness&quot;</span>, <span class="keyword">new</span> Date());</span><br><span class="line">        <span class="keyword">return</span> objectMapper.writeValueAsString(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ååºåˆ—åŒ–æ¥å£</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/save&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(<span class="meta">@RequestBody</span> String userJsonList)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        List&lt;User&gt; userList = objectMapper.readValue(userJsonList, <span class="keyword">new</span> TypeReference&lt;List&lt;User&gt;&gt;() &#123;&#125;);</span><br><span class="line">        userList.forEach(e -&gt; &#123;log.info(e.toString());&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CURLæµ‹è¯•ï¼ˆwindowsä¸‹å»ºè®®ä½¿ç”¨cmdè¿›è¡Œæµ‹è¯•ï¼Œç”¨powershellä¼šåˆ°å¯¼è‡´POSTé”™è¯¯ï¼‰<br />åºåˆ—åŒ–æµ‹è¯•ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> <span class="built_in">curl</span> <span class="literal">-X</span> GET http://localhost:<span class="number">3333</span>/user/get</span><br></pre></td></tr></table></figure>
<p>åºåˆ—åŒ–æµ‹è¯•ç»“æœï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;id&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;KHighness&quot;</span>,<span class="attr">&quot;birth&quot;</span>:<span class="string">&quot;2021-04-15&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>ååºåˆ—åŒ–æµ‹è¯•ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> <span class="built_in">curl</span> <span class="literal">-H</span> <span class="string">&quot;Content-Type:application/json&quot;</span> <span class="literal">-X</span> POST -<span class="literal">-data</span> <span class="string">&quot;[&#123;\&quot;</span>id\<span class="string">&quot;:1, \&quot;</span>name\<span class="string">&quot;:\&quot;</span>Khighness\<span class="string">&quot;, \&quot;</span>birth\<span class="string">&quot;:\&quot;</span><span class="number">2001</span><span class="literal">-09</span><span class="literal">-11</span>\<span class="string">&quot;&#125;, &#123;\&quot;</span>id\<span class="string">&quot;:2, \&quot;</span>name\<span class="string">&quot;:\&quot;</span>FlowerK\<span class="string">&quot;, \&quot;</span>birth\<span class="string">&quot;:\&quot;</span><span class="number">2003</span><span class="literal">-07</span><span class="literal">-24</span>\<span class="string">&quot;&#125;]&quot;</span>  http://localhost:<span class="number">3333</span>/user/save</span><br></pre></td></tr></table></figure>
<p>ååºåˆ—åŒ–æµ‹è¯•ç»“æœï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[&#123;<span class="attr">&quot;id&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;Khighness&quot;</span>,<span class="attr">&quot;birth&quot;</span>:<span class="string">&quot;2001-09-11&quot;</span>&#125;,&#123;<span class="attr">&quot;id&quot;</span>:<span class="number">2</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;FlowerK&quot;</span>,<span class="attr">&quot;birth&quot;</span>:<span class="string">&quot;2003-07-24&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<h2 id="Jacksonæ³¨è§£"><a href="#Jacksonæ³¨è§£" class="headerlink" title="Jacksonæ³¨è§£"></a>Jacksonæ³¨è§£</h2><p>ï¼ˆ1ï¼‰@JsonProperty<br>ä½œç”¨åœ¨å±æ€§ä¸Šï¼Œç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ä¸ºJSON keyæŒ‡å®šä¸€ä¸ªåˆ«åã€‚<br>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonProperty(&quot;bth&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Date birth;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶åºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;id&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;KHighness&quot;</span>,<span class="attr">&quot;bth&quot;</span>:<span class="string">&quot;2021-04-16&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰@JsonIgnore<br>ä½œç”¨åœ¨å±æ€§ä¸Šï¼Œç”¨äºåœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶å¿½ç•¥æ­¤å±æ€§ã€‚<br>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonIgnore</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶åºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;id&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;birth&quot;</span>:<span class="string">&quot;2021-04-16&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰@JsonIgnoreProperties<br>ä½œç”¨åœ¨ç±»ä¸Šï¼Œç”¨äºå¿½ç•¥ä¸€ç»„å±æ€§ã€‚<br>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonIgnoreProperties(&#123;&quot;id&quot;, &quot;birth&quot;&#125;)</span></span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶åºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;KHighness&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ4ï¼‰@JsonFormat<br>ä½œç”¨åœ¨æ—¥æœŸå±æ€§ä¸Šï¼Œç”¨äºæ ¼å¼åŒ–ã€‚<br>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonFormat(pattern = &quot;yyyy.MM.dd&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Date birth;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶åºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;id&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;userName&quot;</span>:<span class="string">&quot;KHighness&quot;</span>,<span class="attr">&quot;birth&quot;</span>:<span class="string">&quot;2021.04.16&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ5ï¼‰@JsonNaming<br>ä½œç”¨åœ¨ç±»ä¸Šï¼Œç”¨äºæŒ‡å®šä¸€ä¸ªå‘½åç­–ç•¥ã€‚</p>
<p>Jacksonè‡ªå¸¦äº†äº”ç§(ä¸¤ç§)å‘½åç­–ç•¥ï¼Œä½¿ç”¨æ–¹å¼ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonNaming(PropertyNamingStrategy.&lt;Strategy&gt;.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"> 	<span class="keyword">private</span> String userName;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>å‘½åç­–ç•¥</th>
<th>ä¸­æ–‡æè¿°</th>
<th>ä½œç”¨ç»“æœ</th>
</tr>
</thead>
<tbody><tr>
<td>KebabCaseStrategy</td>
<td>ä¸­åˆ’çº¿</td>
<td>user-name</td>
</tr>
<tr>
<td>SnakeCaseStrategy</td>
<td>ä¸‹åˆ’çº¿</td>
<td>user_name</td>
</tr>
<tr>
<td>UpperCamelCaseStrategy</td>
<td>å¤§é©¼å³°</td>
<td>UserName</td>
</tr>
<tr>
<td>LowerCaseStrategy</td>
<td>å…¨å°å†™</td>
<td>username</td>
</tr>
<tr>
<td>LowerDotCaseStrategy</td>
<td>å°å†™ç‚¹</td>
<td>user.name</td>
</tr>
</tbody></table>
<p>ï¼ˆ6ï¼‰@JsonSerialize<br>ä½œç”¨åœ¨ç±»ä¸Šï¼ŒæŒ‡å®šä¸€ä¸ªç±»æ¥è‡ªå®šä¹‰åºåˆ—åŒ–ï¼Œè¯¥ç±»å¿…é¡»å®ç°<code>JsonSerializer</code>æ¥å£ã€‚<br>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span> <span class="keyword">extends</span> <span class="title">JsonSerializer</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(User user, JsonGenerator jsonGenerator, </span></span></span><br><span class="line"><span class="function"><span class="params">                          SerializerProvider serializerProvider)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        jsonGenerator.writeStartObject();</span><br><span class="line">        jsonGenerator.writeStringField(<span class="string">&quot;USER-NAME&quot;</span>, user.getUserName());</span><br><span class="line">        jsonGenerator.writeEndObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonSerialize(using = UserSerializer.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3180230416244251692L</span>;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶åºåˆ—åŒ–æ¥å£æµ‹è¯•ç»“æœä¸ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;USER-NAME&quot;</span>:<span class="string">&quot;KHighness&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ7ï¼‰@JsonDeserialize<br>ä½œç”¨åœ¨ç±»ä¸Šï¼ŒæŒ‡å®šä¸€ä¸ªç±»æ¥è‡ªå®šä¹‰ååºåˆ—åŒ–ï¼Œè¯¥ç±»å¿…é¡»å®ç°<code>JsonDeserializer</code>æ¥å£ã€‚<br>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDeserializer</span> <span class="keyword">extends</span> <span class="title">JsonDeserializer</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">deserialize</span><span class="params">(JsonParser jsonParser, DeserializationContext deserializationContext)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, JsonProcessingException </span>&#123;</span><br><span class="line">        JsonNode node = jsonParser.getCodec().readTree(jsonParser);</span><br><span class="line">        String userName = node.get(<span class="string">&quot;user-name&quot;</span>).asText();</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUserName(userName);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonDeserialize(using = UserDeserializer.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3180230416244251692L</span>;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ååºåˆ—åŒ–æµ‹è¯•ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">curl -H &quot;Content-Type:application/json&quot; -X POST --data &quot;[&#123;\&quot;user-name\&quot;:\&quot;Khighness\&quot;&#125;, &#123;\&quot;user-name\&quot;:\&quot;FlowerK\&quot;&#125;]&quot;  http://localhost:3333/user/save</span><br><span class="line">[&#123;<span class="attr">&quot;userName&quot;</span>:<span class="string">&quot;Khighness&quot;</span>&#125;,&#123;<span class="attr">&quot;userName&quot;</span>:<span class="string">&quot;FlowerK&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>ååºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[&#123;<span class="attr">&quot;userName&quot;</span>:<span class="string">&quot;Khighness&quot;</span>&#125;,&#123;<span class="attr">&quot;userName&quot;</span>:<span class="string">&quot;FlowerK&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ8ï¼‰@JsonView<br>ä½œç”¨åœ¨ç±»ã€å±æ€§å’Œæ–¹æ³•ä¸Šï¼Œç”¨æ¥åºåˆ—åŒ–ç»„ã€‚<br>æ¯”å¦‚å¯¹äºUserå¯¹è±¡ï¼ŒæŸäº›æƒ…å†µä¸‹åªè¿”å›userNameå³å¯ï¼Œ</p>
<p>è€ŒæŸäº›æƒ…å†µä¸‹éœ€è¦è¿”å›å…¨éƒ¨å±æ€§ã€‚å› æ­¤Userå¯¹è±¡å¯ä»¥è¿™æ ·å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3180230416244251692L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»…åŒ…å«userName</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserNameView</span> </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒ…å«å…¨éƒ¨å±æ€§</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AllUserFieldView</span> <span class="keyword">extends</span> <span class="title">UserNameView</span> </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonView(AllUserFieldView.class)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonView(UserNameView.class)</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonView(AllUserFieldView.class)</span></span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨controllerçš„æ–¹æ³•ä¸Šä½¿ç”¨@JsonViewï¼Œå¯ä»¥æŒ‡å®šåºåˆ—åŒ–ç»„åã€‚<br />ä½¿ç”¨ç»„åUserNameViewï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@JsonView(User.UserNameView.class)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/get&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">&quot;KHighness&quot;</span>, <span class="keyword">new</span> Date());</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;userName&quot;</span>:<span class="string">&quot;KHighness&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç»„åæŒ‡å®šä¸º<code>AllUserFieldView</code>æ—¶ï¼Œåºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;id&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;userName&quot;</span>:<span class="string">&quot;KHighness&quot;</span>,<span class="attr">&quot;birth&quot;</span>:<span class="string">&quot;2021-04-17&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<br />

<p><strong>å‚è€ƒ</strong><br>[1] ğŸ¦ <a href="https://mrbird.cc/Spring-Boot%20JSON.html">SpringBootä¸­çš„JSONæŠ€æœ¯</a><br>[2] â˜ï¸ <a href="https://www.kancloud.cn/ahutchen/spring-boot-reference-guide/333370">è‡ªå®šä¹‰Jackson ObjectMapper</a></p>
]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>json</tag>
      </tags>
  </entry>
  <entry>
    <title>åŒè›‹é—®é¢˜</title>
    <url>/posts/53991/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h2><p>è°·æ­Œçš„ä¸€é“ç»å…¸é¢è¯•é¢˜ â€”â€”ã€ŒåŒè›‹é—®é¢˜ã€ã€‚</p>
<p>ä¸€ä¸ªç™¾å±‚é«˜å¤§æ¥¼ï¼Œä»ä½å±‚å¾€ä¸‹æ‰”é¸¡è›‹çš„æ—¶å€™ï¼Œé¸¡è›‹ä¸ä¼šç¢ï¼›ä»é«˜å±‚å¾€ä¸‹æ‰”é¸¡è›‹çš„æ—¶å€™ï¼Œé¸¡è›‹æ‰ä¼šç¢ã€‚<br>ä¸­é—´æœ‰ä¸€ä¸ªä¸´ç•Œæ¥¼å±‚ï¼Œåœ¨è¿™ä¸ªä¸´ç•Œæ¥¼å±‚ä»¥ä¸‹çš„æ¥¼å±‚æ‰”ï¼Œé¸¡è›‹ä¸ä¼šç¢ï¼Œè¶…è¿‡è¿™ä¸ªæ¥¼å±‚æ‰”ï¼Œé¸¡è›‹ä¼šç¢æ‰ã€‚</p>
<p>é—®é¢˜ï¼šå¦‚æœæ‹¥æœ‰Nä¸ªé¸¡è›‹ï¼Œæœ€å°‘è¦æ‰”å¤šå°‘æ¬¡ï¼Œè®°ä¸ºMï¼Œæ‰èƒ½æ‰¾å‡ºä¸´ç•Œå±‚ï¼Ÿ</p>
<h2 id="æ€è·¯è§£æ"><a href="#æ€è·¯è§£æ" class="headerlink" title="æ€è·¯è§£æ"></a>æ€è·¯è§£æ</h2><p>ï¼ˆ1ï¼‰N = 1<br>å¦‚æœåªæœ‰1ä¸ªé¸¡è›‹ï¼Œé‚£ä¹ˆåªèƒ½ä»1å±‚å¼€å§‹å°è¯•ï¼Œé€å±‚å°è¯•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1ã€2ã€3ã€4ã€... 100</span><br></pre></td></tr></table></figure>

<p>æœ€åçš„æƒ…å†µå°±æ˜¯åœ¨ç¬¬100å±‚æ‰”é¸¡è›‹ï¼Œé¸¡è›‹æ‰ç¢æ‰ã€‚<br>å› æ­¤ï¼ŒN = 1çš„æ—¶å€™ï¼ŒM=100ã€‚</p>
<p>ï¼ˆ2ï¼‰N = +âš®<br>å¦‚æœæœ‰æ— é™ä¸ªé¸¡è›‹ï¼Œè¿™æ—¶å€™å¯ä»¥é‡‡ç”¨äºŒåˆ†æ³•è¿›è¡Œå°è¯•ï¼š<br>$$<br>2^{M} \ge 100 \<br>$$</p>
<p>$$<br>M \ge \log_{2}{100} \<br>$$</p>
<p>$$<br>M \ge = 6.64 \<br>$$</p>
<p>$$<br>M = 7<br>$$</p>
<p>å› æ­¤ï¼ŒN=+âš®çš„æ—¶å€™ï¼ŒM=7ã€‚</p>
<p>ï¼ˆ3ï¼‰N = 2<br>å¦‚æœåªæœ‰2ä¸ªé¸¡è›‹ï¼Œè®©ç¬¬ä¸€ä¸ªé¸¡è›‹Aåˆ†åˆ«é€å±‚å°è¯•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">10ã€20ã€30ã€40ã€50ã€60ã€70ã€80ã€90ã€100</span><br></pre></td></tr></table></figure>

<p>å¦‚æœAåœ¨ç¬¬ã€ŒXã€å±‚æ²¡ç¢ï¼Œä½†æ˜¯åœ¨ç¬¬ã€ŒX+10ã€å±‚ç¢äº†ï¼Œé‚£ä¹ˆè®©ç¬¬äºŒä¸ªé¸¡è›‹Båœ¨åŒºé—´(X, X+10)å°è¯•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">X+1ã€X+2ã€X+3ã€X+4ã€X+5ã€X+6ã€X+7ã€X+8ã€X+9</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•ï¼Œæœ€å¥½æƒ…å†µä¸‹åªéœ€è¦æ‰”10ï¼ˆA1+B9ï¼‰æ¬¡ï¼Œæœ€åæƒ…å†µä¸‹éœ€è¦æ‰”19ï¼ˆA10+B9ï¼‰æ¬¡ã€‚<br>å®ƒä¸å¹³å‡ï¼ŒåŸå› æ˜¯å› ä¸ºAå®ƒç¡®å®šçš„é—´éš”æ˜¯ç­‰é—´éš”çš„ï¼ŒBçš„å°è¯•æ¬¡æ•°å°±æ˜¯ä¸€æ ·çš„ï¼Œä¸´ç•Œæ¥¼å±‚è¶Šé åï¼ŒAçš„å°è¯•æ¬¡æ•°å°±è¶Šå¤šã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æ€è€ƒï¼Œèƒ½ä¸èƒ½è®©é—´éš”å˜å¾—ä¸ç­‰ï¼Œå°±æ˜¯è¯´ï¼ŒAæ¯å¤šæ‰”ä¸€æ¬¡ï¼ŒBçš„æœç´¢åŒºé—´å°±ç¼©å°ä¸€ç‚¹ï¼Œè¿™æ ·ä¸€æ¥è®©Aå’ŒBçš„æ€»æ¬¡æ•°å¹³å‡ä¸€ç‚¹ã€‚<br>ä¸‹é¢ï¼Œè°ƒæ•´Aæ¯æ¬¡æ‰”é¸¡è›‹çš„é—´éš”ï¼Œç¬¬ä¸€æ¬¡é—´éš”ä¸ºnï¼Œç¬¬äºŒæ¬¡é—´éš”ä¸ºn-1ï¼Œç¬¬ä¸‰æ¬¡é—´éš”ä¸ºn-2ï¼Œæœ€åä¸€æ¬¡é—´éš”ä¸º1å±‚ï¼Œå°è¯•æ¥¼å±‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nã€n+(n-1)ã€n+(n-1)+(n-2)ã€...ã€n(n+1)&#x2F;2</span><br></pre></td></tr></table></figure>

<p>ä»è€Œï¼ŒBçš„æœç´¢åŒºé—´é•¿åº¦å°±ä¼šå‘ˆç°çº¿æ€§é€’å‡è¶‹åŠ¿ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(n, n+(n-1))ã€(n+(n-1), n+(n-1)+(n-2))ã€...(n(n+1)&#x2F;2-1, n(n+1)&#x2F;2)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ï¼ŒAæ¯å¤šæ‰”ä¸€æ¬¡ï¼ŒBå°±å°‘æœç´¢ä¸€æ¬¡ï¼Œå¯ä»¥è¾¾åˆ°Aå’ŒBçš„æƒè¡¡ã€‚</p>
<p>$$<br>\frac{n \times {(n+1)}} {2} = 100 \<br>$$</p>
<p>$$<br>n \ge {13.65} \<br>$$</p>
<p>$$<br>n = 14 \<br>$$</p>
<p>è¿™ç§æ–¹æ³•ï¼Œå¯ä»¥è®©Mç¨³å®šåœ¨14ã€‚</p>
<h2 id="é—®é¢˜æ‹“å±•"><a href="#é—®é¢˜æ‹“å±•" class="headerlink" title="é—®é¢˜æ‹“å±•"></a>é—®é¢˜æ‹“å±•</h2><p>å°†é—®é¢˜æ‹“å±•åˆ°æ›´å…·æœ‰ä¸€èˆ¬æ€§çš„æƒ…å†µï¼Œå¯ä»¥å‚è€ƒã€Œ<a href="https://leetcode-cn.com/problems/super-egg-drop/">leetcode 887. é¸¡è›‹æ‰è½</a>ã€ã€‚<br>ç®€å•æè¿°ï¼šç»™å®šã€Œnã€å±‚æ¥¼å’Œã€Œmã€ä¸ªé¸¡è›‹ï¼Œè¦æ±‚æ‰¾åˆ°ä¸´ç•Œæ¥¼å±‚ã€Œcã€ï¼Œæœ€å°‘éœ€è¦å°è¯•å‡ æ¬¡ï¼Ÿ</p>
<h2 id="æ•°å­¦å»ºæ¨¡"><a href="#æ•°å­¦å»ºæ¨¡" class="headerlink" title="æ•°å­¦å»ºæ¨¡"></a>æ•°å­¦å»ºæ¨¡</h2><p>æ±‚æœ€å€¼ï¼Œä¸éš¾æƒ³åˆ°ç»å…¸DPï¼ˆDynamic Planningï¼‰ï¼Œæ‰“è¡¨æ ¼ã€‚<br>è®¾å°è¯•æ¬¡æ•°ä¸ºã€Œfã€ï¼ŒF(iï¼Œj) è¡¨ç¤ºåœ¨ã€Œiã€å±‚æ¥¼å’Œã€Œjã€ä¸ªé¸¡è›‹ä¸‹æ‰¾ä¸´ç•Œæ¥¼å±‚çš„å°è¯•æ¬¡æ•°ã€‚</p>
<p>åªæœ‰1å±‚æ¥¼æˆ–è€…åªæœ‰1ä¸ªé¸¡è›‹çš„æ—¶å€™éƒ½åªéœ€è¦å°è¯•1æ¬¡ï¼Œåˆå§‹åŒ–è¡¨æ ¼å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="center">i \ f \ j</th>
<th align="center">1</th>
<th align="center">2</th>
<th align="center">3</th>
<th align="center">4</th>
<th align="center">5</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">1</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">1</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">1</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">1</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<p>æ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬æ€»è¦é€‰æ‹©ä¸€å±‚ã€Œkã€ï¼Œç„¶åæ‰”ä¸‹å»ï¼š</p>
<ul>
<li>å¦‚æœç¢äº†ï¼Œé‚£ä¹ˆã€Œcã€ä¸€å®šåœ¨ã€Œkã€å‰é¢ï¼ŒåŒæ—¶é¸¡è›‹æ•°é‡å‡å°‘ä¸€ä¸ªï¼Œæ­¤æ—¶æ±‚è§£ f(k - 1ï¼Œj - 1) ï¼›</li>
<li>å¦‚æœä¸ç¢ï¼Œé‚£ä¹ˆã€Œcã€ä¸€å®šåœ¨ã€Œkã€åé¢ï¼Œä½†æ˜¯é¸¡è›‹æ•°é‡æ²¡æœ‰å˜åŒ–ï¼Œæ­¤æ—¶æ±‚è§£ f(n - kï¼Œj)ã€‚</li>
</ul>
<p>åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å–ä¸€ä¸ªæœ€å¤§å€¼ï¼Œå³ï¼š</p>
<p>$$<br>\max_{}(f(k-1, j-1), f(i-k, j)) \<br>$$</p>
<p>å†åŠ ä¸Šè¿™ä¸€æ¬¡æ‰”çš„æ¬¡æ•°ï¼Œäºæ˜¯å¾—åˆ°ï¼š</p>
<p>$$<br>f(i, j) = \max_{}(f(k-1, j-1), f(i-k, j)) + 1 \<br>$$</p>
<p>è¿™ä¸ªã€Œkã€æ— æ³•ç¡®å®šï¼Œäºæ˜¯æˆ‘ä»¬é€šè¿‡æšä¸¾å–å€¼æ–¹æ¡ˆï¼Œå–æœ€å°å€¼ï¼š<br>â€‹<br>$$<br>f(i, j) = \min_{1 \le k \le i }(\max_{}(f(k-1, j-1), f(i-k, j)) + 1) \<br>$$</p>
<h2 id="åŠ¨æ€è§„åˆ’"><a href="#åŠ¨æ€è§„åˆ’" class="headerlink" title="åŠ¨æ€è§„åˆ’"></a>åŠ¨æ€è§„åˆ’</h2><p>æ ¹æ®ä¸Šé¢çš„çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼Œå¯ä»¥å†™å‡ºåŠ¨æ€è§„åˆ’å¯¹åº”çš„ä»£ç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/53991/code1.png" class="" title="code1">

<br />

<p>è¿™æ ·å†™çš„è¯ï¼Œæ—¶é—´å¤æ‚åº¦è¾¾åˆ°O(KN^2)ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯O(KN)ã€‚</p>
<h2 id="äºŒåˆ†ä¼˜åŒ–"><a href="#äºŒåˆ†ä¼˜åŒ–" class="headerlink" title="äºŒåˆ†ä¼˜åŒ–"></a>äºŒåˆ†ä¼˜åŒ–</h2><p>å†çœ‹è¿™ä¸ªçŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š</p>
<p>$$<br>f[i, j] = \min_{1 \le k \le i }(\max_{}(f[k-1, j-1], f[i-k, j]) + 1) \<br>$$</p>
<p>è®¾ç¢è›‹å‡½æ•°f1 = f(k - 1, j - 1)ï¼Œæœªç¢å‡½æ•°f2 = f(i - k, j)ï¼Œé‚£ä¹ˆf=min(f1, f2)ã€‚<br>æ–¹ç¨‹æœ€å¤–å±‚çš„å˜é‡æ˜¯ã€Œkã€ï¼Œå®ƒæšä¸¾äº†æ‰”ä¸‹é¸¡è›‹çš„æ¥¼å±‚çš„é«˜åº¦ï¼Œè¿™é‡Œå®ƒæ˜¯å‡½æ•°çš„è‡ªå˜é‡ï¼Œå°†ã€Œiã€å’Œã€Œjã€è§†ä¸ºå¸¸æ•°ï¼Œé‚£ä¹ˆï¼š</p>
<ul>
<li>å¯¹äºf1ï¼škå¢å¤§çš„æ—¶å€™ï¼Œæ¥¼å±‚å¤§å°è¶Šå¤§ï¼Œå®ƒçš„å€¼å°±è¶Šå¤§ï¼Œæ‰€ä»¥ç¢è›‹å‡½æ•°æ˜¯ä¸ªå•è°ƒé€’å¢å‡½æ•°ï¼›</li>
<li>å¯¹äºf2ï¼škå¢å¤§çš„æ—¶å€™ï¼Œæ¥¼å±‚å¤§å°è¶Šå°ï¼Œå®ƒçš„å€¼å°±è¶Šå°ï¼Œæ˜¯ä¸ªæœªç¢å‡½æ•°æ˜¯ä¸ªå•è°ƒé€’å‡å‡½æ•°ã€‚</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/53991/f.svg" class="" title="f">

<br />
è¿™å°±ç±»ä¼¼äºå¯»æ‰¾æ•°æ®å³°å€¼é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒã€Œleetcode 162. å¯»æ‰¾å³°å€¼ã€ã€‚

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/53991/code2.png" class="" title="code2">

<br />


<p>æœ€ç»ˆï¼Œä»£ç ä¾¿å¯ä»¥ä¼˜åŒ–æˆå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> K é¸¡è›‹æ•°é‡</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> N æ¥¼å±‚æ•°é‡</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">superEggDrop</span><span class="params">(<span class="keyword">int</span> K, <span class="keyword">int</span> N)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// dp[i][j]è¡¨ç¤ºiå±‚æ¥¼jä¸ªé¸¡è›‹ï¼Œéœ€è¦æ‰”çš„æ¬¡æ•°</span></span><br><span class="line">     <span class="keyword">int</span>[][] dp = <span class="keyword">new</span> <span class="keyword">int</span>[N + <span class="number">1</span>][K + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* åˆå§‹åŒ– */</span></span><br><span class="line">     <span class="comment">// æ±‚æœ€å°å€¼ï¼Œåˆå§‹åŒ–å–ä¸€ä¸ªè¾ƒå¤§å€¼</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++) &#123;</span><br><span class="line">         Arrays.fill(dp[i], i);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// æ¥¼å±‚æ•°é‡ä¸º0ï¼Œæ‰”0æ¬¡</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= K; j++) &#123;</span><br><span class="line">         dp[<span class="number">0</span>][j] = <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// æ¥¼å±‚ä¸º0ï¼Œæ²¡æœ‰é¸¡è›‹ï¼Œæ‰”0æ¬¡</span></span><br><span class="line">     dp[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">     <span class="comment">// æ¥¼å±‚ä¸º1ï¼Œé¸¡è›‹è¶³å¤Ÿï¼Œæ‰”1æ¬¡</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= K; j++) &#123;</span><br><span class="line">         dp[<span class="number">1</span>][j] = <span class="number">1</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// é¸¡è›‹ä¸º0ï¼Œæ— æ³•æµ‹è¯•ï¼Œæ‰”0æ¬¡</span></span><br><span class="line">     <span class="comment">// é¸¡è›‹ä¸º1ï¼Œéœ€è¦è¿›è¡Œé€å±‚å°è¯•</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= N; i++) &#123;</span><br><span class="line">         dp[i][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">         dp[i][<span class="number">1</span>] = i;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* é€’æ¨çŠ¶æ€ */</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= N; i++) &#123;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">2</span>; j &lt;= K; j++) &#123;</span><br><span class="line">             <span class="comment">// åœ¨åŒºé—´[1, i]é‡Œç¡®å®šä¸€ä¸ªæœ€ä¼˜å€¼</span></span><br><span class="line">             <span class="keyword">int</span> l = <span class="number">1</span>, r = i;</span><br><span class="line">             <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">                 <span class="keyword">int</span> m = l + ((r - l + <span class="number">1</span>) &gt;&gt; <span class="number">1</span>);</span><br><span class="line">                 <span class="comment">// ç¢è›‹å‡½æ•°ï¼Œé€’å¢</span></span><br><span class="line">                 <span class="keyword">int</span> f1 = dp[m - <span class="number">1</span>][j - <span class="number">1</span>];</span><br><span class="line">                 <span class="comment">// ä¸ç¢å‡½æ•°ï¼Œé€’å‡</span></span><br><span class="line">                 <span class="keyword">int</span> f2 = dp[i - m][j];</span><br><span class="line">                 <span class="keyword">if</span> (f1 &gt; f2) &#123;</span><br><span class="line">                     r = m - <span class="number">1</span>;</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     l = m;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             dp[i][j] = Math.max(dp[l - <span class="number">1</span>][j - <span class="number">1</span>], dp[i - l][j]) + <span class="number">1</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> dp[N][K];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>[1] ğŸ“º <a href="https://www.bilibili.com/video/BV1KE41137PK">ææ°¸ä¹è€å¸ˆBç«™è§†é¢‘</a><br>[2] ğŸ“„ <a href="https://leetcode-cn.com/problems/super-egg-drop/solution/dong-tai-gui-hua-zhi-jie-shi-guan-fang-ti-jie-fang/">æç»´ç»´å“¥å“¥åŠ›æ‰£é¢˜è§£</a><br>[3] ğŸ’¤ <a href="https://zhuanlan.zhihu.com/p/92288604">labuladongçŸ¥ä¹ä¸“æ </a></p>
]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
      <tags>
        <tag>DP</tag>
      </tags>
  </entry>
  <entry>
    <title>å¶æƒ ç¾</title>
    <url>/posts/f8cdfd0a/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script>
        <div id="aplayer-DpvCiehK" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>
			  <script>
				  var options = {"narrow":false,"autoplay":false,"showlrc":1,"mode":"oredr","mutex":true,"theme":"#e6d0b2","preload":"metadata","listmaxheight":"513px","music":[{"title":"ä»¥çˆ¶ä¹‹å","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/ä»¥çˆ¶ä¹‹å.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"ä»¥çˆ¶ä¹‹å.txt"},{"title":"æ‡¦å¤«","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/æ‡¦å¤«.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"æ‡¦å¤«.txt"},{"title":"æ™´å¤©","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/æ™´å¤©.flac","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"æ™´å¤©.txt"},{"title":"ä¸‰å¹´äºŒç­","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/ä¸‰å¹´äºŒç­.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"ä¸‰å¹´äºŒç­.txt"},{"title":"ä¸œé£ç ´","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/ä¸œé£ç ´.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"ä¸œé£ç ´.txt"},{"title":"ä½ å¬å¾—åˆ°","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/ä½ å¬å¾—åˆ°.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"ä½ å¬å¾—åˆ°.txt"},{"title":"åŒä¸€ç§è°ƒè°ƒ","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/åŒä¸€ç§è°ƒè°ƒ.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"åŒä¸€ç§è°ƒè°ƒ.txt"},{"title":"å¥¹çš„ç«æ¯›","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/å¥¹çš„ç«æ¯›.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"å¥¹çš„ç«æ¯›.txt"},{"title":"çˆ±æƒ…æ‚¬å´–","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/çˆ±æƒ…æ‚¬å´–.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"çˆ±æƒ…æ‚¬å´–.txt"},{"title":"æ¢¯ç”°","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/æ¢¯ç”°.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"æ¢¯ç”°.txt"},{"title":"åŒåˆ€","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/åŒåˆ€.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"åŒåˆ€.txt"}]};
				  options.element = document.getElementById("aplayer-DpvCiehK");
				  var ap = new APlayer(options);
			    window.aplayers || (window.aplayers = []);
				  window.aplayers.push(ap);
			  </script>





]]></content>
      <categories>
        <category>Music</category>
      </categories>
      <tags>
        <tag>å¶æƒ ç¾</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¯ä¸ªå°‘å¹´ï¼Œæ—¢æœ‰å¹»æƒ³ï¼Œä¹Ÿæœ‰æ‚²ä¼¤</title>
    <url>/posts/140645a5/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ã€€ã€€æˆ‘ä¸çŸ¥é“ï¼Œæ˜¯å¦æ¯ä¸ªäººåœ¨å­©ç«¥æ—¶ä»£èº«å¤„å›°å¢ƒçš„æ—¶å€™ï¼Œéƒ½ä¼šå¹»æƒ³å‡ºç°ä¸€ä¸ªäººæ¥æ”¹å˜è¿™ä¸€åˆ‡ã€‚<br>ã€€ã€€<br>ã€€ã€€æˆ‘å°çš„æ—¶å€™ï¼Œè®¨åŒçˆ¶äº²çš„ä¸è‹Ÿè¨€ç¬‘ï¼Œæ—¶å¸¸æ†§æ†¬ç€æ¢ä¸€ä¸ªçˆ¸çˆ¸ã€‚æ¯”å¦‚æˆ‘çš„èˆ…èˆ…ï¼Œæˆ‘å›ºæ‰§åœ°è®¤ä¸ºä»–æœ‰è¶£ã€å¹½é»˜ã€èƒ½ç†è§£æˆ‘çš„è‹¦æ¼ï¼ŒæœŸç›¼ç€ä»–èƒ½æŠŠæˆ‘å¸¦èµ°ã€‚å¯æ˜¯ï¼Œæˆ‘å¿ƒé‡Œåˆå¾ˆæ¸…æ¥šï¼šè¿™æ˜¯ä¸€ä»¶ä¸å¯èƒ½çš„äº‹æƒ…ã€‚<br>ã€€ã€€<br>ã€€ã€€æ‰€ä»¥ï¼Œå…³äºæˆé•¿ï¼Œå…¶å®æ˜¯ä¸€ä¸ªä¸å‘½è¿äº¤é”‹çš„è¿‡ç¨‹ã€‚åˆæ¬¡äº¤é”‹ï¼Œä½ å­¦åˆ°ï¼šæ²¡æœ‰äººå¯ä»¥æ”¹å˜è‡ªå·±çš„å‡ºç”Ÿï¼Œåªèƒ½æ¥å—ã€‚è¿™ä¸ªè¿‡ç¨‹ï¼Œå……æ»¡ç€æ‚²ä¼¤ã€‚è¿™ç§æ‚²ä¼¤ï¼Œå¸¸å¸¸ä¼šè¢«å¤§äººå¿½ç•¥ï¼Œç›´åˆ°â€œé‚£ä¸ªç¥ç§˜äººâ€çš„å‡ºç°ã€‚<br>ã€€ã€€<br>ã€€ã€€æ‰€ä»¥ï¼Œçœ‹åˆ°ç”µå½±ã€Šäºšç‰¹å…°è’‚æ–¯ä¹‹å¿ƒã€‹ï¼Œæˆ‘æ€»è§‰å¾—å®ƒè®²è¿°çš„æ˜¯æ¯ä¸ªå°‘å¹´è„‘å­é‡Œéƒ½æ›¾å¹»æƒ³å‡ºç°è¿‡çš„ä¸€ä¸ªæ•…äº‹â€”â€”<br>ã€€ã€€<br>ã€€ã€€11å²çš„æ‚²ä¼¤å°‘å¹´ï¼Œéš”å£çªç„¶æ¬æ¥ä¸€ä½ç¥ç§˜è€äººã€‚ä»–ä¼¼ä¹çŸ¥é“å¤©ä¸‹çš„ä¸€åˆ‡ç§˜å¯†ã€‚ä»–çƒ­è¡·ä¸å°‘å¹´äº¤è°ˆï¼Œä»æ¥ä¸æŠŠä»–å½“æˆä¸€ä¸ªå­©å­ã€‚ä»–å‘Šè¯‰ä»–ï¼Œä¸è¦å°çœ‹é˜…è¯»çš„åŠ›é‡ï¼Œâ€œåƒç™¾å¹´æ¥ï¼Œä¼Ÿäººå¸¦é¢†æˆ‘ä»¬èµ°å‡ºé»‘æš—â€ã€‚ä»–å¯¹å°‘å¹´è¯´ï¼šâ€œæˆ‘ä»¬éƒ½æ˜¯æ—¶é—´çš„ä¿˜è™ï¼Œæ°¸æ’çš„äººè´¨ã€‚â€ä»–ç”šè‡³å‘Šè¯‰å°‘å¹´ï¼šä½ ä¼šå»é‚£ä¸ªå¥³å­©ï¼Œä½ ä¸€å®šä¼šã€‚å¤šä¹ˆå¯çˆ±çš„å¥³å­©ã€‚åœ¨é‚£ä¸ªå»ä¸­ï¼Œå¥½å¥½æ„Ÿå—è‡ªå·±ã€‚<br>ã€€ã€€<br>ã€€ã€€æœ€åï¼Œè€äººæ¶ˆå¤±äº†ã€‚å¤šå¹´åï¼Œå°‘å¹´å›åˆ°é‚£ä¸ªåŸå¸‚ï¼Œåˆ†ä¸æ¸…æ›¾ç»çš„é‚£æ®µå¥‡é‡åˆ°åº•æ˜¯çœŸçš„è¿˜æ˜¯å‡çš„ã€‚ä½†ä»–çŸ¥é“ï¼Œä¹Ÿè®¸è€äººå¹¶æ²¡æœ‰ä»€ä¹ˆç¥ç§˜çš„èƒ½é‡ï¼Œåªæ˜¯åŠç”Ÿçš„ç»å†è®©ä»–å¯¹äººä¸–å¤ªè¿‡æ´å¯Ÿã€‚</p>
<p>ã€€ã€€æ¯ä¸ªå°‘å¹´éƒ½æœ‰å¹»æƒ³ï¼Œå› ä¸ºä»–ä»¬éƒ½æœ‰æ‚²ä¼¤ã€‚é‚£æ‚²ä¼¤æ¥è‡ªå¤§äººæ€»æ˜¯ä¸å±‘ä¸ä»–ä»¬äº¤è°ˆï¼Œå…¶å®ä»–ä»¬ä»€ä¹ˆéƒ½æ˜ç™½ã€‚ä»–ä»¬çœ‹å¾—åˆ°æ‚²ä¼¤ï¼Œä»–ä»¬æ‡‚å¾—ä»€ä¹ˆæ˜¯çˆ±ã€‚<br>ã€€ã€€<br>ã€€ã€€æ¯ä¸ªå°‘å¹´éƒ½æœ‰æ‚²ä¼¤ã€‚åŒºåˆ«åœ¨äºï¼Œæœ‰äººæŠŠæ‚²ä¼¤åŸ¹å…»æˆä¸€ç§é˜¿Qç²¾ç¥ï¼Œæœ‰äººæŠŠæ‚²ä¼¤è½¬åŒ–æˆå›é€†å’Œæ„¤æ€’ï¼Œæœ‰äººæŠŠè‡ªå·±åŸ‹åœ¨æ‚²ä¼¤é‡Œå†ä¹Ÿèµ°ä¸å‡ºæ¥ã€‚å¹¸è¿çš„è¯ï¼Œè¦åˆ°å¾ˆä¹…ä¹‹åï¼Œæ‰æœ‰äººæ¸æ¸å¼€å§‹æ‡‚å¾—ï¼Œå¦‚æœé‡åˆ°æ‚²ä¼¤ï¼Œæ”¾è½»æ¾ï¼Œå®ƒä¼šæ…¢æ…¢èµ°å¼€ã€‚<br>ã€€ã€€<br>ã€€ã€€è¿™ä¸ªå°‘å¹´ï¼Œæ˜¯æˆ‘ä»¬å½“ä¸­çš„å¹¸è¿å„¿ã€‚ç¥ç§˜è€äººæ¶ˆå¤±äº†ã€‚ä»–ä»¬å†ä¹Ÿä¸æ›¾è§è¿‡ã€‚æœ›ç€è€äººçš„èƒŒå½±ï¼Œä»–è§‰å¾—å¹´å°‘æ—¶å…‰ä¹Ÿä¸€å¹¶ç¦»ä»–è¿œå»äº†ã€‚<br>ã€€ã€€<br>ã€€ã€€â€œçŸ¥é“å—ï¼Ÿåœ¨ä½ å¹´è½»çš„æ—¶å€™ï¼Œæœ‰è®¸å¤šè¿™æ ·ç¾å¥½çš„ç¬é—´ï¼Œä½ è§‰å¾—è‡ªå·±ç”Ÿæ´»åœ¨ä¸€ä¸ªç¥å¥‡çš„åœ°æ–¹ï¼Œä»¥ä¸ºäºšç‰¹å…°è’‚æ–¯ä¸€å®šå­˜åœ¨ã€‚ç„¶åæˆ‘ä»¬å°±é•¿å¤§äº†ï¼Œäºæ˜¯æˆ‘ä»¬çš„å¿ƒç¢äº†ã€‚â€<br>ã€€ã€€<br>ã€€ã€€äºšç‰¹å…°è’‚æ–¯ï¼Œæ®ä¼ æ˜¯ç”±æ³¢å¡å†¬çš„å­å­™æŒç®¡çš„å²å‰å¤å›½ï¼Œå¤§é™†æ–‡æ˜çš„å·…å³°ä¹‹å›½ï¼Œå´åœ¨ä¸€åœºç¾éš¾ä¹‹åï¼Œä¸¾å›½æ²‰å…¥æ°´åº•ã€‚<br>ã€€ã€€<br>ã€€ã€€æˆ‘ä»¬çš„ç«¥å¹´ï¼Œå°±å¦‚é™·è½çš„äºšç‰¹å…°è’‚æ–¯ï¼Œæ›¾ç»å¹»æƒ³è¿‡æ— æ•°ç¥å¥‡çš„æ•…äº‹ï¼Œå¯æ˜¯ï¼Œæœ€åéƒ½æ²¡æœ‰å‘ç”Ÿã€‚æˆ‘ä»¬å˜æˆäº†å¹³å‡¡çš„æ™®é€šäººï¼Œæ²¡æœ‰ä¼ å¥‡ï¼Œæ²¡æœ‰è‡ªç”±ï¼Œæ²¡æœ‰ä¸»å®°ï¼›ç›¸åçš„æ˜¯ï¼Œæ¥å—å¹³æ·¡ï¼Œæ¥å—æŸç¼šï¼Œæ¥å—å‘½è¿ã€‚<br>ã€€ã€€<br>ã€€ã€€å”¯ä¸€çš„å¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬éƒ½æ›¾ç»ä»¥ä¸ºå¿ƒç¢äº†ï¼Œå°±å†ä¹Ÿä¸ä¼šå¥½äº†ã€‚åæ¥ç­‰åˆ°ç¬¬äºŒæ¬¡å¿ƒç¢ï¼Œæ‰çŸ¥é“ï¼ŒåŸæ¥è¿˜å¯ä»¥æ´»ç€ã€‚å†ç­‰åˆ°ç¬¬ä¸‰æ¬¡ç¬¬å››æ¬¡ï¼Œæ‰çŸ¥é“ï¼Œå¿ƒç¢æ˜¯ç”Ÿå‘½çš„å¿…ç»ï¼Œä¸€å¦‚æˆ‘ä»¬æ³¨å®šæ˜¯æ—¶é—´æ°¸æ’çš„äººè´¨ã€‚<br>ã€€ã€€<br>ã€€ã€€èƒ½è®©ç ´ç¢çš„å¿ƒæ¢å¤çš„ä¸œè¥¿ï¼Œå°±æ˜¯æˆé•¿ã€‚åªæœ‰çœ‹åˆ°è‡ªå·±çš„æˆé•¿ï¼Œæˆ‘ä»¬æ‰ä¼šæ‰¿è®¤å¿ƒç¢æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä¹Ÿæ‰ä¼šå› è¿™äº›æˆé•¿ï¼Œå¥‹åŠ›ç«™èµ·æ¥ï¼Œå‹‡äºæ¥å—ä¸‹ä¸€æ¬¡å¿ƒç¢ã€‚<br>ã€€ã€€<br>ã€€ã€€å¯¹æˆ‘æ¥è¯´ï¼Œäºšç‰¹å…°è’‚æ–¯æ°¸æ’åœ°å­˜åœ¨äºå¿ƒé‡Œã€‚å°±åƒé‚£ä¸ªå°‘å¹´ï¼Œæ°¸è¿œä¸ä¼šå¿˜è®°ç¥ç§˜çš„è€äººï¼Œåœ¨ä»–çš„ç”Ÿå‘½é‡ŒçœŸå®å­˜åœ¨è¿‡ï¼Œé‚£å¹¶ä¸æ˜¯ä¸€ä¸ªè™šæ„çš„äººç‰©ï¼Œé‚£æ˜¯ä»–çš„äºšç‰¹å…°è’‚æ–¯ä¹‹å¿ƒçš„æ˜è¯ã€‚æˆ‘æ˜¯é‚£ä¸ªé€‰æ‹©ç»§ç»­ç›¸ä¿¡çš„äººï¼Œä¸åæ‚”çˆ±è¿‡ã€ç—›è¿‡çš„äººï¼Œæˆ‘æ¥å—è¿™ä¸€åˆ‡çš„å­˜åœ¨ï¼Œä¹Ÿå¯¹æ›¾ç»é‚£ä¸ªåˆå‚»åˆåœŸçš„è‡ªå·±å¦ç„¶ç¬‘çº³ã€‚<br>ã€€ã€€<br>ã€€ã€€åªæœ‰æ¥å—ï¼Œæ‰ä¼šåœ¨å¹³å‡¡ä¸­é¢†ç•¥åˆ°ä¸å¹³å‡¡çš„å­˜åœ¨ï¼Œå¹¶ä¸”äºˆä»¥çæƒœã€‚<br>ã€€ã€€<br>ã€€ã€€åªæœ‰æ¥å—ï¼Œä½ æ‰ä¼šå‘ç°ï¼Œæ¯ä¸€ä¸ªå°‘å¹´éƒ½æ˜¯ä¸€æ ·çš„ã€‚åªæ˜¯åæ¥ï¼Œæ‰æ…¢æ…¢å˜å¾—ä¸ä¸€æ ·ï¼Œæœ‰äº›äººçš„å¿ƒå·²ç»æ­»å»ï¼Œæœ‰äº›äººçš„æ¢¦å·²ç»æˆçœŸã€‚</p>
<hr>
<p>è½¬è½½è‡ªã€Šä¸­å›½é’å¹´æŠ¥ã€‹2014å¹´12æœˆ23æ—¥ æ˜ŸæœŸäºŒã€‚</p>
<a class="btn-beautify button--animated block right outline larger" href="http://zqb.cyol.com/html/2014-12/23/nw.D110000zgqnb_20141223_3-11.htm" 
  title="æ¯ä¸ªå°‘å¹´éƒ½æœ‰å¹»æƒ³ä¹Ÿæœ‰æ‚²ä¼¤"><i class="far fa-hand-point-right fa-fw"></i><span>æ¯ä¸ªå°‘å¹´éƒ½æœ‰å¹»æƒ³ä¹Ÿæœ‰æ‚²ä¼¤</span></a>

]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>è½¬è½½</tag>
      </tags>
  </entry>
  <entry>
    <title>çƒ­æ‹</title>
    <url>/posts/26035/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/26035/today.jpg" class="" title="today"><br />

<p>å¤å¤©é è¿‘ï¼Œæˆ‘ä»¬å‡æ¸©ã€‚åæ¥çƒŸé›¨è½ç››äº¬ï¼Œä¸€äººæ’‘ä¼ä¸¤äººè¡Œã€‚</p>
<p>æƒ³æ¥ç³Ÿç³•ï¼Œé¬¼æ··çš„æ„¿æœ›è¿˜æ²¡å®Œæˆï¼Œå°±è¦æ¥å—å¨´å¨´çš„ç®¡è¾–äº†ã€‚</p>
<p style="text-align:right">â€”â€”2021.6.11 12:39</right>


]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>ç–«å¿µ</title>
    <url>/posts/12327/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/12327/p1.jpg" class="" title="p1"><br />

<p>æ–°æ—¶ä»£çš„æµ©ç€šï¼Œæœªæ¥çš„ä¹Œæ‰˜é‚¦ï¼Œæˆ‘ä»¬æœªè°‹å…¶é¢ï¼Œé“¸å‰‘å°å°±è¢«ç—…æ¯’æ‘§æ¯ã€‚</p>
<p>ä¸å¹³å‡¡çš„ä¸€å¹´é‡Œï¼Œåœ¨çº¿æ•™è‚²å—å›½å®¶åˆ¶è£ï¼Œäº’è”ç½‘è¡Œä¸šè¯¸å¦‚OPPOã€çˆ±å¥‡è‰ºå’Œè˜‘è‡è¡—ç­‰å¤§å¹…è£å‘˜ï¼Œè¿˜æœ‰æ•™åŸ¹è½¬è¡Œã€æˆ¿ä¼æš´é›·ã€å¹³å°ç»æµåå„æ–­ç­‰æ¶ˆæ¯æ…åŠ¨å¸‚åœºã€‚</p>
<p>ä¸æ­¤åŒæ—¶ï¼Œâ€œåŒç¢³â€ç›®æ ‡ä¸‹çš„æ–°èƒ½æºå’Œæ–°èƒ½æºè½¦äº§ä¸šè“¬å‹ƒå‘å±•ï¼›ç¡¬ç§‘æŠ€ç«™ä¸Šé£å£æˆä¸ºèµ„æœ¬çœ¼ä¸­çš„é¦™é¥½é¥½ï¼›å…ƒå®‡å®™çˆ†ç«ï¼Œäººç±»å¼€å§‹ç•…äº«åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„ä¸–ç•Œã€‚</p>
<hr>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/12327/p2.jpg" class="" title="p2"><br />

<p>ä¸€ä¸ªä¸–çºªå‰ï¼Œä¸–ç•Œçˆ†å‘çš„æµæ„Ÿæ„ŸæŸ“äº†ä¸–ç•Œä¸Šå››åˆ†ä¹‹ä¸€çš„äººå£ï¼Œè¿™æ¯”ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ˜é€ æˆçš„æ­»äº¡äººæ•°è¿˜è¦å¤šã€‚ä½†æ˜¯ä»å®¢è§‚ä¸Šæ¥è®²ï¼Œç–«æƒ…å’Œä¸–ç•Œå¤§æˆ˜ï¼Œåœ¨ç»æµä¸Šäº§ç”Ÿäº†è¿™æ ·ä¸€ä¸ªé€»è¾‘é“¾æ¡ï¼š</p>
<ol>
<li>ç¾éš¾è¿‡åï¼Œä¸–ç•Œè¿›å…¥æŠ¥å¤æ€§æ¶ˆè´¹ï¼Œéœ€æ±‚ç¬é—´ä¸Šæ¶¨ï¼›</li>
<li>ç¾éš¾æœŸé—´ï¼ŒåŠ³åŠ¨åŠ›å¤§é‡å‡å°‘ï¼Œé¢å¯¹è“¬å‹ƒçš„éœ€æ±‚ï¼Œä¼ä¸šéœ€è¦å¿«é€Ÿè¡¥å……åŠ³åŠ¨åŠ›ï¼›</li>
<li>ä¸ºäº†å¸å¼•åŠ³åŠ¨åŠ›åŠ å…¥ï¼Œä¼ä¸šæé«˜å·¥èµ„å¾…é‡ï¼›</li>
<li>å·¥è–ªé˜¶å±‚æ”¶å…¥æé«˜ï¼Œå½¢æˆäº†ä¸€ä¸ªåºå¤§çš„å¯ä»¥å®ç°â€œç¾å›½æ¢¦â€çš„ä¸­äº§é˜¶çº§ç¾¤ä½“ï¼›</li>
<li>æ‰‹é‡Œæœ‰é—²é’±å°±å»æ¶ˆè´¹ï¼Œå¯¹äºæ¶ˆè´¹å“çš„éœ€æ±‚å¤§å¹…å¢é•¿ï¼Œä¾æ­¤ä¸æ–­å¾ªç¯ã€‚</li>
</ol>
<p>åœ¨ä¸€æˆ˜ä¹‹å‰ï¼Œç¾å›½å·²ç»é«˜é€Ÿå‘å±•ï¼Œåœ¨ç–«æƒ…å’Œä¸€æˆ˜ç»“æŸä»¥åï¼Œç¾å›½ä¸ä»…æ²¡æœ‰å› ä¸ºç¾éš¾ä¸€è¹¶ä¸æŒ¯ï¼Œåè€Œè¿›å…¥äº†ç¬¬äºŒæ³¢é«˜é€Ÿå‘å±•æœŸï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å’†å“®çš„20å¹´ä»£ã€‚</p>
<p>æ—¶è‡³ä»Šæ—¥ï¼Œæˆ‘ä»¬è¿›å…¥äº†ä¸€ä¸ªæ–°çš„20å¹´ä»£ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨å¾ˆå¤§èŒƒå›´ä¸Šï¼Œè§£å†³äº†æœ‰æ²¡æœ‰çš„é—®é¢˜ï¼Œè€Œæˆ‘ä»¬ä¹Ÿåˆ°äº†è¦è§£å†³å¥½ä¸å¥½çš„æ—¶å€™ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦çš„ä¸æ˜¯æ›´å¤šçš„æ´›å…‹è²ç‰¹å»ºç«‹æ›´å¤šå¤§å¹³å°ï¼Œè·Ÿèœå¸‚åœºæˆ–è€…å°å•†è´©æŠ¢ç”Ÿæ„ï¼Œæ‰“å¤–å–å°å“¥äº”é™©ä¸€é‡‘çš„ä¸»æ„ï¼Œè€Œæ˜¯éœ€è¦æ›´å¤šçš„ç¦ç‰¹å’Œäºšå†æ¡‘å¾·æ£®ï¼Œæ¥å‘å±•æ ¸å¿ƒç«äº‰åŠ›ï¼Œæ¨åŠ¨ç¤¾ä¼šçš„å‘å±•ã€‚</p>
<hr>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/12327/p3.jpg" class="" title="p3"><br />

<p>æœ‰ä¸€ä¸ªè¯ï¼Œå«ä½œã€Œå‘æ­»è€Œç”Ÿã€ï¼Œå°±æ˜¯åšæœ€åçš„æ‰“ç®—ï¼Œè¿‡å¥½è‡ªå·±çš„ç”Ÿæ´»ã€‚</p>
<p>ç–«æƒ…å½“ä¸‹ï¼Œæˆ‘è§‰å¾—ä¹Ÿè¦æ€€ç€ä¸€ä¸ªå……æ»¡å¸Œæœ›çš„æ€åº¦ï¼Œå»çœ‹å¾…è¿™ä¸ªæ—¶ä»£å’Œæˆ‘ä»¬çš„ç”Ÿæ´»ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥åƒè§„åˆ’ä»»æœŸä¸€æ ·è§„åˆ’è‡ªå·±çš„ç”Ÿæ´»ï¼Œè®¡åˆ’è™½ç„¶èµ¶ä¸ä¸Šå˜åŒ–ï¼Œä½†æ˜¯å¸Œæœ›æˆ‘ä»¬å¯ä»¥æœç€é‚£ä¸ªæ–¹å‘å»åŠªåŠ›ï¼ŒåŒæ—¶ï¼Œå¾ˆæœŸå¾…è¿™æ¡è·¯ä¸Šçš„æ‰€æœ‰æ„å¤–ã€‚</p>
<hr>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/12327/p4.jpg" class="" title="p4"><br />

<p>å¯’å‡äº†ï¼Œæˆ‘çš„å¤§å­¦ä»é¹°å‡»é•¿ç©ºçš„å¼€å§‹ï¼Œæœ€ç»ˆä¹Ÿåªæ˜¯æ è¿‡äº†ä¸€ç‰‡åŸé‡ã€‚</p>
<p>å¤§å­¦æ•™ä¼šäº†æˆ‘å¾ˆå¤šï¼Œæ¯”å¦‚ç•™é•¿å‘ï¼Ÿæ›´é‡è¦çš„æ˜¯ï¼Œå­¦ä¼šã€Œè·³å‡ºåœˆå­çœ‹ä¸–ç•Œã€ã€‚</p>
<p>å½“æˆ‘åœ¨ä¸Šå¤§å­¦çš„æ—¶å€™ï¼Œæˆ‘èº«è¾¹çš„äººä¹Ÿåœ¨ä¸Šå¤§å­¦ã€‚å½“æˆ‘åœ¨ä¸ºæœŸæœ«å¤‡æˆ˜çš„æ—¶å€™ï¼Œèº«è¾¹çš„äººä¹Ÿåœ¨å›¾ä¹¦é¦†å†…å·ã€‚</p>
<p>æˆ–è®¸å‹¤å¥‹ï¼ŒæŠ«æ˜Ÿæˆ´æœˆï¼Œä¸‰ç‚¹ä¸€çº¿ï¼›æˆ–è®¸å®‰é€¸ï¼Œå°åºŠä¸€èººï¼Œæ¸¸æˆä¸€æ‰“ï¼›æˆ–è®¸å¹³å‡¡ï¼ŒæŒ‰æ—¶ä¸Šè¯¾ï¼Œä»ä¸æŒ‚ç§‘ã€‚</p>
<p>ä¸ºä»€ä¹ˆå‹¤å¥‹ï¼Ÿä¸ºäº†æˆç»©ï¼Ÿè¯æ˜è‡ªå·±ï¼Ÿæ¨å…ç ”ç©¶ç”Ÿï¼Ÿ</p>
<p>ä¸ºä»€ä¹ˆå®‰é€¸ï¼Ÿå®¶æœ‰ä¸‡è´¯ï¼Ÿè‡ªç”˜å •è½ï¼Ÿå°±é€‰æ‹©èººå¹³ï¼Ÿ</p>
<p>å½“æˆ‘ä»¬è·³å‡ºè¯»ä¹¦çš„åœˆå­ï¼Œå°±å‘ç°å¹¶éæ‰€æœ‰äººéƒ½å¦‚æ­¤ã€‚è·³å‡ºæ‰€å¤„çš„ç¯å¢ƒï¼Œå»æ¥è§¦ç¤¾ä¼šçš„å…¶ä»–æ–¹é¢ã€‚</p>
<p>å½“æˆ‘ä»¬èƒ½å¤Ÿè·³å‡ºåœˆå­çœ‹ä¸–ç•Œçš„æ—¶å€™ï¼Œåœ¨ä¸ä¸€æ ·çš„è§’åº¦çœ‹å¾…ä¸–ç•Œï¼Œæˆ–è®¸å°±èƒ½çœ‹åˆ°ä¸ä¸€æ ·çš„æ ¼å±€ï¼Œæ›´å®¹æ˜“çœ‹æ¸…è‡ªå·±åœ¨æ•´ä¸ªä¸–ç•Œçš„å®šä½ï¼Œæˆ‘ä»¬çœŸæ­£æƒ³è¦æˆä¸ºä»€ä¹ˆï¼Œè¿·èŒ«ä¹‹æ—¶ä¸ä¸¢å¤±è‡ªå·±çš„ç›®æ ‡ï¼Œè€Œä¸æ˜¯è·Ÿç€èº«è¾¹äººä¸€æ ·ï¼Œä¸çŸ¥é“ä¸ºä½•è€Œå‹¤å¥‹æˆ–è€…å› ä½•è€Œå •è½ï¼Œä¸çŸ¥é“å¤§å››æ—¶åˆ°åº•ä¸ºä½•è¦è€ƒç ”è¿˜æ˜¯å»æ‰¾å·¥ä½œã€‚</p>
<p>æˆ‘ä»¬çš„äººç”Ÿï¼Œä¹Ÿä¸è¯¥è¢«æŸä¸€ä¸ªåœ°ç‚¹æˆ–è€…å­¦æ ¡æ‰€æ ‡è®°ï¼Œè¯¥å­¦åˆ°çš„æ˜¯ä¸€ç§å­¦ä¹ æ–¹å¼å’Œæ€ç»´æ–¹å¼ï¼Œè€Œä¸æ˜¯å…·ä½“çš„çŸ¥è¯†ç‚¹ã€‚æœªæ¥æˆ‘ä»¬ä¼šå¿˜è®°å¾ˆå¤šäº‹æƒ…ï¼Œé‚£äº›ç•™åœ¨è„‘æµ·é‡Œçš„ä¸œè¥¿ï¼Œå°†ä¼šå¡‘é€ æˆ‘ä»¬çš„æ€ç»´å’Œäººæ ¼ã€‚</p>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>ç››å¤</title>
    <url>/posts/48247/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>çŠ¹ç„¶è®°å¾—ï¼Œ2017å¹´çš„å†¬å¤©ï¼Œæˆ‘çš„ä¸Šä¸€å±Šå­¦é•¿è¯´çš„è¯ï¼š</p>
<blockquote>
<p><em>â€œé«˜è€ƒåªæ˜¯ä¸ªè€ƒè¯•ï¼Œä½†æ˜¯ä½ æ€‚äº†ï¼Œä»¥åä½ ä¹Ÿä¼šæ€‚ä¸‹å»ã€‚â€</em></p>
</blockquote>
<p>ä½ ä»¥ä¸ºæ˜¯è‹¦æµ·ï¼Œå®é™…ä¸Šæ˜¯å¤©å ‚ï¼›</p>
<p>ä½ ä»¥ä¸ºæ˜¯å¼€å§‹ï¼Œå®é™…ä¸Šæ˜¯å·…å³°ï¼›</p>
<p>ä½ ä»¥ä¸ºä¼šè„±ç¦»ï¼Œæ­¤åæ— é™æ€€å¿µã€‚</p>
<br>

<p>è¯¦ç»†è®°å½•ä¸‹æˆ‘çš„æ•´ä¸ªé«˜è€ƒçŠ¶æ€ã€‚</p>
<p>2018.6.6ï¼Œæ™šä¸Š9ç‚¹ï¼Œæˆ‘å¼€å§‹èººåºŠï¼Œè¶Šç¡è¶Šæ¸…é†’ï¼Œæ¯äº²åŠå¤œ1ç‚¹ä¸ºæˆ‘æ¨æ‹¿ï¼Œæœ€åè™½ç„¶æ²¡ç¡ç€ï¼Œä½†è¿˜æ˜¯é—­çœ¼åˆ°äº†å¤©äº®ã€‚</p>
<p>2018.6.7ï¼Œæ•°å­¦è§£ç­”é¢˜ç¬¬ä¸€é¢˜æ²¡å†™ï¼ˆæŠŠå¹³é¢å››è¾¹å½¢çœ‹æˆå¹³è¡Œå››è¾¹å½¢ï¼Œç„¶ååœ¨ç­”é¢˜çº¸ä¸Šå†™äº†æ­¤é¢˜æœ‰è¯¯ï¼‰ï¼Œå¿ƒæ€ç‚¸è£‚ï¼Œåœ¨æ²¸æ²¸æ‰¬æ‰¬çš„150é‡Œï¼Œæ— é¢œé¢è§æˆ‘çš„ç­ä¸»ä»»ï¼Œæˆ‘åªæƒ³è‡ªé—­ï¼ˆä½†æ˜¯ç»“æœè¿˜æ˜¯è¶…äººæ„æ–™ï¼Œä»…ä»…æ‰£äº†é‚£ä¸€é¢˜çš„åˆ†æ•°ï¼‰ã€‚æ™šä¸Š9ç‚¹ï¼Œæ•…äº‹åˆé‡æ¼”ã€‚</p>
<p>ä¸¤å¤©ä¸­åˆçš„åˆç¡æµ…çš„ä¸èƒ½å†æµ…ï¼Œæ­¤å‰æ¨¡æ‹Ÿè¦æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œè€ƒè¯•å¤šå°‘éƒ½ä¼šå‡ºç‚¹é—®é¢˜ï¼Œä½†æ˜¯é«˜è€ƒå®ƒå°±æ˜¯ä¸ä¸€æ ·ï¼Œæ²¡æœ‰çŒç¡ï¼Œä½ åªç®¡è¡¨æ¼”ã€‚</p>
<br>

<p>ä½†æ˜¯2018å¹´çš„ç››å¤ï¼Œç»å¯¹æ˜¯æˆ‘äººç”Ÿä¸­æœ€å€¼å¾—æ€€å¿µçš„å¤å¤©ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/48247/bg.jpg" class="" title="ç››å¤"><br />

<p>2018å¹´çš„æ°ä¼¦ï¼Œã€Šç­‰ä½ ä¸‹è¯¾ã€‹å’Œã€Šä¸çˆ±æˆ‘å°±æ‹‰å€’ã€‹ã€‚</p>
<p>2018å¹´çš„æŠ–éŸ³ï¼Œæœªè¿›å…¥ç—…æ¯’çºªå…ƒçš„å®ƒæ‰¿è½½æ— é™ç¾å¥½ã€‚</p>
<p>2018å¹´çš„å…­æœˆï¼Œå¿ƒä¸­æ»¡æº¢èƒŒèµ·è¡Œå›Šèµ°å‘ä¸–ç•Œçš„å†²åŠ¨ã€‚</p>
<p>2018å¹´çš„ä¸ƒæœˆï¼Œåœ¨æˆ‘æˆå¹´å‰æ‰“äº†ä¸€ä»½æ»¡æ„çš„æš‘å‡å·¥ã€‚</p>
<p>2018å¹´çš„å…«æœˆï¼Œå‡å­¦å®´ä¸Šæ¨æ¯æ¢ç›ä¸é’æ˜¥æœ€åé“åˆ«ã€‚</p>
<br>

<p>ä¸Šäº†å¤§å­¦ï¼Œå†ä¹Ÿæ²¡æœ‰è‡ªå·±å›ºå®šçš„åº§ä½ï¼Œæ²¡æœ‰æ—©è¯»æ—¶çš„æµ·å¹å’Œæ¼”å”±ä¼šï¼Œæ²¡æœ‰â€œèµ°å•Šï¼Œä¸€èµ·ä¸Šå•æ‰€â€ï¼Œæ²¡æœ‰å‚æ™šæ—¶çª—å¤–çš„ä¸€ç‰‡ç»¯çº¢ï¼Œæ²¡æœ‰ä¸‹æ™šè‡ªä¹ åçš„å¥”è·‘ï¼Œå°±è¿ä¸Šè¯¾ç¡è§‰éƒ½æ²¡æœ‰é‚£ä¹ˆé¦™ã€‚ä»æ­¤ï¼Œå†éš¾ä»¥æ‰¾å›é‚£æ—¶çš„æ„æ°”é£å‘å’Œè¸Œèº‡æ»¡å¿—ï¼Œä»¥åŠå•çº¯é’æ¶©çš„æƒ…æ„«ã€‚</p>
<p>ä¸”è¡Œä¸”çæƒœï¼ŒäºŒé›¶äºŒä¸€å±Šã€‚</p>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>ç§‹æ‹›</title>
    <url>/posts/18127/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>è‡³æ­¤ï¼Œ10æœˆæœ«ï¼Œæˆ‘çš„ç§‹æ‹›å‘Šä¸€æ®µè½ã€‚</p>
<p>æ„Ÿè°¢ä»¥ä¸‹å…¬å¸å¯¹æˆ‘çš„è®¤å¯ï¼š</p>
<table>
<thead>
<tr>
<th align="center">company</th>
<th align="center">position</th>
<th align="center">base</th>
</tr>
</thead>
<tbody><tr>
<td align="center">shopee</td>
<td align="center">Golangåç«¯</td>
<td align="center">æ·±åœ³</td>
</tr>
<tr>
<td align="center">58åŒåŸ</td>
<td align="center">å®‰å±…å®¢åç«¯</td>
<td align="center">ä¸Šæµ·</td>
</tr>
<tr>
<td align="center">åŒ—æ£®äº‘è®¡ç®—</td>
<td align="center">ä¸­é—´ä»¶å¼€å‘</td>
<td align="center">åŒ—äº¬</td>
</tr>
</tbody></table>
<p>ä½†æ˜¯ï¼Œä¹‹å‰ç½‘ç­¾çš„åŒ—æ£®ï¼Œæƒ³æ¯çº¦ç­¾è™¾çš®äº†ã€‚</p>
<p>å¯æ˜¯ï¼Œæˆ‘ä¸çŸ¥é“åªèƒ½ç­¾ä¸€ä¸ªå•Šï¼Œè¦ç­‰åˆ°12æœˆæ‰èƒ½æ¯çº¦ï¼Œæå¿ƒæ€ã€‚</p>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>è´Ÿè·ç¦»</title>
    <url>/posts/33422a09/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33422a09/bg.jpg" class="" title="bg"><br />



<p>æƒ³æ˜¯å› ä¸ºä¹…äº†æ‰€ä»¥è®°ä¸èµ·äº†ï¼Œæƒ³æ˜¯å› ä¸ºç©ºæ°”æ¹¿äº†ä¸æ˜¯çœ¼çœ¶çº¢äº†ã€‚</p>
<p>æˆ‘çœ‹è§å‡‹é›¶çš„æ«ï¼Œå¤©ç©ºçš„é¢œè‰²æ¯”æ²¹å½©æ›´å‡é‡ï¼Œå¤§å—ç™½è‰²çš„æµ®äº‘æ è¿‡ï¼Œé‚£æ ‹ç°è‰²çš„å»ºç­‘é—ªçƒé¦™æ§Ÿè‰²çš„å…‰èŠ’ï¼Œæˆ‘ä»æœªæ€€ç–‘è¿‡è‡ªå·±åœ¨æ¢¦é‡Œã€‚</p>
<p>ä¸¤å¹´ä»¥æ¥ï¼Œè‡ªå·±æ˜¯å¦æˆé•¿ï¼Œåˆæ˜¯å¦æ”¹å˜ï¼Ÿå½“åˆæ‡µæ‡‚çš„é€‰æ‹©ï¼Œä¸­é—´åŠªåŠ›çš„è¿·èŒ«ï¼Œè€Œä»Šè¿™å·²æ˜¯ä¸€æ¡ä¸å½’è·¯ã€‚</p>
<p>æ¯ä¸ªäººçš„èº«ä½“å’Œæ„å¿—ï¼Œæ€»æœ‰è¢«ç¯å¢ƒçš„ç‰¢ç¬¼ç¦é”¢é‚£ä¸€éƒ¨åˆ†ï¼Œæƒ³æ–½å±•æ‹³è„šå°±å„ç§Errorã€‚</p>
<p>æˆ–è®¸äººéƒ½åº”è¯¥åšåˆ°å¼ å¼›æœ‰åº¦ï¼Œé€Ÿåº¦ä¸ç¼“ä¸æ€¥ï¼Œè‡ªæœ‰å®‰æ’å¦¥å½“çš„èŠ‚å¥ï¼Œè¯¥æ”¶æ•›çš„æ—¶å€™ä¸é€å¼ºï¼Œè¯¥å‡ºå‡»çš„æ—¶å€™ä¸çŠ¹è±«ï¼Œè¯¥ä¿ç•™çš„æ—¶å€™ä¸ç›²ç›®ï¼Œè¯¥ç«­åŠ›çš„æ—¶å€™ä¸æ°”çŸ­ã€‚</p>
<p>2020ï¼ŒæƒŸæ„¿ä¿¡å¿µä½¿è‡ªå·±è¶…è¶Šã€‚</p>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>è¶Šåˆ</title>
    <url>/posts/59926/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å››æœˆæœ«æ‹¿åˆ°OPPOçš„å®ä¹ offerï¼Œå…­æœˆä¸­æ—¬å¼€å§‹åœ¨ç½‘ç»œä¸Šå’¨è¯¢æ·±åœ³ç§Ÿæˆ¿ï¼Œä¸ƒæœˆåˆæˆåŠŸé€ƒæ‰å­¦é™¢å®‰æ’çš„ä¼ä¸šå®è®­è®¡åˆ’ã€‚</p>
<h2 id="åœ°é“"><a href="#åœ°é“" class="headerlink" title="åœ°é“"></a>åœ°é“</h2><p>ä¸‹ç«è½¦ï¼Œè½¬åœ°é“ï¼Œ5å·çº¿æ¢11å·çº¿ã€‚ä¸åœ¨ä¸‹ç­é«˜å³°ï¼Œä¸ç®—æ‹¥æŒ¤ã€‚</p>
<p>11å·çº¿ï¼Œè½»è½¨ï¼Œåœ¨ç¢§æµ·æ¹¾å’Œæœºåœºçš„éƒ¨åˆ†å¯ä»¥çœ‹åˆ°æ²¿æ±Ÿé«˜é€Ÿå’Œæµ·ã€‚</p>
<p>ä¹¡ä¸‹å­©å­è¡¨ç¤ºæƒŠå‘†äº†ï¼</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="æ²¿æ±Ÿ.jpg" alt="æ²¿æ±Ÿ" style="zoom: 67%;" />



<h2 id="é…’åº—"><a href="#é…’åº—" class="headerlink" title="é…’åº—"></a>é…’åº—</h2><p>æ¥åˆ°é…’åº—ï¼Œå·²ç»æ¥è¿‘5ç‚¹ã€‚</p>
<p>ç¬¬ä¸€æ¬¡ä¸€ä¸ªäººä½åœ¨é…’åº—ï¼Œé…’åº—é—¨å®¢å†·æ¸…ï¼Œç®€å•åŠç†å…¥ä½ï¼›</p>
<p>æ”¾ä¸‹è¡Œæä¾¿å‰å¾€å®å®‰äººæ°‘åŒ»é™¢åšæ ¸æ£€ï¼Œè·¯ä¸ŠæŒ‡ç¤ºæ ‡å¾ˆå¤šï¼›</p>
<p>ä¸€æ­¥æ­¥æŒ‡å¼•æˆ‘è¿›å…¥æ–°å®‰å…¬å›­ï¼ŒæŒ‚å·ï¼Œç¼´è´¹ï¼Œå–æ ·ï¼Œç»“æœã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="æ ¸æ£€.jpg" alt="æ ¸æ£€" style="zoom:50%;" />

<br>

<p>å¤œæ™šï¼Œèƒ½é”çš„å…¨é”äº†ï¼Œä¸æ•¢å…³å°ç¯ï¼Œå› ä¸ºå®³æ€•ã€‚</p>
<p>ç¬¬ä¸€æ™šï¼Œå‡Œæ™¨å› ä¸ºè„šæ­¥å£°é†’äº†ä¸€æ¬¡ï¼Œè¿‡äº†å‡ ä¸ªå°æ—¶åˆå†ç¡ç€ã€‚</p>
<p>ç¬¬äºŒæ™šï¼Œä¸Šèº«å¤§é¢ç§¯çº¢çƒ­ï¼Œæ´—æ¾¡æ—¶æµäº†ä¸€èº«é¼»è¡€ï¼Œæ°´åœŸä¸æœã€‚</p>
<h2 id="ç§Ÿæˆ¿"><a href="#ç§Ÿæˆ¿" class="headerlink" title="ç§Ÿæˆ¿"></a>ç§Ÿæˆ¿</h2><p>æœ‹å‹ä»‹ç»ï¼Œé¾™æ¹–å† å¯“ï¼Œå‡ºé—¨å³æ˜¯åœ°é“å£ï¼Œå¿«é¤åº—ã€ä¾¿åˆ©åº—å’Œæ°´æœåº—éƒ½åœ¨æ¥¼ä¸‹ã€‚</p>
<p>ç¬¬äºŒå¤©å®šé‡‘ï¼Œå’Œæœ‹å‹å»å¤§è¶…å¸‚è´­å›åˆšéœ€ç”¨å“ã€‚ç¬¬ä¸‰å¤©ç­¾çº¦ï¼Œå®‰ç½®è‡ªå·±çš„ç§Ÿæˆ¿ã€‚</p>
<table>
  <tr>
     <td width="50%" align="top"><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="å®¢å….jpg"/></td>
     <td width="50%" align="top"><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="å¨æŸœ.jpg"/></td>
  </tr>
  <tr>
     <td width="50%" align="top"><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="æ¡Œå­.jpg"/></td>
     <td width="50%" align="top"><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="å¢™å£.jpg"/></td>
  </tr>
</table>




<h2 id="é¤é¥®"><a href="#é¤é¥®" class="headerlink" title="é¤é¥®"></a>é¤é¥®</h2><p>ç¬¬ä¸€å¤©ä¸­åˆå’Œæœ‹å‹ä¸€èµ·åƒé¥­ï¼Œä»–çŒªè„šï¼Œæˆ‘å‰çƒ§ï¼Œæ™šä¸Šå›é…’åº—è‡ªå·±ç‚¹äº†ä¸€ä»½é»„ç„–é¸¡ï¼ˆè–…ç¾Šæ¯›ï¼‰ã€‚</p>
<p>ç¬¬äºŒå¤©ä¸­åˆå’Œæœ‹å‹ä¸€èµ·åƒçš„é‡åº†å°é¢ï¼Œæ™šä¸Šæˆ‘ä»¬åˆå»åƒäº†é‚£å®¶é¥­ï¼Œä»–ä¾ç„¶çŒªè„šï¼Œæˆ‘ä¾ç„¶å‰çƒ§ã€‚</p>
<p>æˆ‘ä¸€ç›´ä»¥ä¸ºæˆ‘å¾ˆèƒ½åƒäº†ï¼Œèµ·ç åœ¨å­¦æ ¡é‡Œæ²¡æœ‰äººåƒå¾—è¿‡æˆ‘ï¼Œä½†æ˜¯è¿™æ¬¡æˆ‘ä¼¼ä¹ç¢°åˆ°äº†å¯¹æ‰‹ã€‚</p>
<p>å‰çƒ§é¥­é€å…è´¹æ±¤ï¼Œè™½ç„¶æ˜¯ç´ èœæ±¤ï¼Œä½†æ˜¯ç‰¹åˆ«é²œï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯åŠ äº†çŒªæ²¹ã€‚</p>
<p>å› ä¸ºç–«æƒ…ï¼Œå¾ˆå¤šé¤é¦†å…¶å®æ˜¯åªæä¾›å¤–å–ï¼Œä½†æ˜¯æˆ‘ä»¬æ¥¼ä¸‹åŸºæœ¬éƒ½å¯ä»¥å ‚é£Ÿã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="å‰çƒ§.jpg" alt="å‰çƒ§" style="zoom: 25%;" />



<h2 id="æ´—æ™’"><a href="#æ´—æ™’" class="headerlink" title="æ´—æ™’"></a>æ´—æ™’</h2><p>ä¸‹åˆç”¨æ´—è¡£æœºæŠŠæˆ‘æ–°ä¹°çš„åºŠå•å’Œå¤å‡‰è¢«æ´—äº†ä¸€ä¸‹ï¼Œæ™’å¹²æ™šä¸Šå¥½å¥½ç¡è§‰ã€‚</p>
<p>ç»“æœã€‚ã€‚ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="ä¸‹é›¨.jpg" alt="ä¸‹é›¨" style="zoom:25%;" />

<br>

<p>æŒºé‚£ä¸ªçš„ã€‚ã€‚ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="æ™¾ç€.jpg" alt="æ™¾ç€" style="zoom:25%;" />

<br>

<p>æ¥æ·±è¿™å‡ å¤©ï¼Œç¡®å®è§‰å¾—ä¸å¯¹åŠ²ã€‚</p>
<p>ç¬¬ä¸€å¤©ï¼Œä¸€ä¸‹åˆçš„å¤ªé˜³é›¨ï¼›</p>
<p>ç¬¬äºŒå¤©ï¼Œä¸‹åˆé—´æ–­æ€§ä¸‹é›¨ï¼›</p>
<p>ç¬¬ä¸‰å¤©ï¼Œæ— é¢„è­¦æ— CDä¸‹æš´é›¨ã€‚</p>
<p>æˆ‘è¿˜æ˜¯ä¸ª19å²çš„å­©å­å•Šï¼Œå‘œå‘œå‘œï¼Œæˆ‘å“­çš„å¥½å¤§å£°ã€‚</p>
<h2 id="è´­ç‰©"><a href="#è´­ç‰©" class="headerlink" title="è´­ç‰©"></a>è´­ç‰©</h2><p>ç”Ÿæ´»è´­ç‰©ï¼Œæœ‹å‹ç»™æˆ‘å¼ºçƒˆå®‰åˆ©äº†ã€å¤šå¤šä¹°èœã€ã€‚</p>
<p>æˆ‘æ‰“å¼€ä¸€çœ‹ï¼Œè¿™ä»·æ ¼å°±æŒºé‚£ä¸ªçš„ã€‚ã€‚ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="å¤šå¤š.jpg" alt="å¤šå¤š" style="zoom: 25%;" />



<h2 id="å¤©ç©º"><a href="#å¤©ç©º" class="headerlink" title="å¤©ç©º"></a>å¤©ç©º</h2><p>æˆ‘çœ‹ä¸å‡ºåŸå¸‚å¤©ç©ºä¸å†œæ‘å¤©ç©ºçš„ä¸åŒã€‚äº¦æˆ–è®¸ï¼Œæˆ‘å¹¶ä¸å±äºè¿™åº§åŸå¸‚ã€‚</p>
<table>
  <tr>
     <td width="50%" align="top"><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="å¤©ç©º1.jpg"/></td>
     <td width="50%" align="top"><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="å¤©ç©º2.jpg"/></td>
  </tr>
</table>


<h2 id="ä¸–é¢"><a href="#ä¸–é¢" class="headerlink" title="ä¸–é¢"></a>ä¸–é¢</h2><p>æ²¡è§è¿‡ä¸–é¢çš„å°‘å¹´ï¼Œæ™®æ™®é€šé€šã€‚</p>
<p>åœ¨ä¹¡é•‡ä¸åŸå¸‚çš„äº¤æ¶‰ä¸­ï¼Œéœ€è¦æ›´å¼ºå¤§çš„å¿ƒç†åŠ›é‡ã€‚</p>
<p>åœ¨å„ç§ä¸åˆ«äººå¯¹ç…§çš„å°äº‹ä¸­ï¼Œä¸€çœ¼å°±ç¥è§è‡ªèº«çš„è´«ç˜ ä¹ æ€§å’Œå›ºé™‹è§†é‡ã€‚</p>
<p>ä»–å¸¸å¸¸è¦æ¶ˆåŒ–å¯¹æ–°äº‹ç‰©çš„éœ‡æƒŠï¼ŒæŒ‰è€ä½ä¸å®‰ï¼Œè®©èŒ«ç„¶å°½å¯èƒ½ä¹ ä»¥ä¸ºå¸¸ã€‚</p>
<p>ä¸ç®¡æ˜¯ç¬¬ä¸€æ¬¡åšéœ²å¤©è½»è½¨è¿˜æ˜¯æ¨å¼€æ˜Ÿå·´å…‹çš„é—¨ã€‚</p>
<p>ä»–è®¨åŒé‚£äº›è®©ä»–ç´§å¼ çš„ä¸œè¥¿ï¼Œè®©ä»–æ•°æ¬¡å‡ºç³—ã€‚</p>
<p>ä»–åœ¨æœç´¢å¼•æ“ä¸­æœ‰éš¾ä»¥ç¤ºäººçš„å¥½å¥‡ï¼ŒåŒ…æ‹¬ç¬¬ä¸€æ¬¡åšé£æœºéœ€è¦å“ªäº›æµç¨‹ï¼ŒåŒäº‹çš„æ½®ç‰Œæ˜¯ä»€ä¹ˆæ¥å†ã€‚</p>
<p>ä»–æ²¡æœ‰è‡ªå‘åˆ°è§‰å¾—è‡ªå·±ä¸€è¾ˆå­éƒ½è·Ÿè¿™äº›ä¸œè¥¿æ— ç¼˜ï¼Œä¹Ÿæ²¡æœ‰è‡ªä¿¡åˆ°èŠ±èŠ±ä¸–ç•Œä¸æ¯«ä¸å½±å“è‡ªå·±çš„ç”Ÿæ´»ã€‚</p>
<p>ä»–ä¸è‡³äºå»å†’å……ä»€ä¹ˆï¼Œå°±æ˜¯å°½åŠ›é¿å…è‡ªå·±æ ¼æ ¼ä¸å…¥ã€‚</p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æˆ–è®¸æˆ‘å†ä¹Ÿæ²¡æœ‰æš‘å‡äº†å§ï¼Œä½†æ˜¯æˆ‘è¿˜æ‹¥æœ‰ä¸ƒæœˆã€‚</p>
<p>çˆ±æˆ–è€…ä¸çˆ±ï¼Œå¤ªé˜³å°±åœ¨é‚£é‡Œï¼Œä¸æ‚²ä¸å–œï¼›</p>
<p>å¿µæˆ–è€…ä¸å¿µï¼Œé›ªç³•å°±åœ¨é‚£é‡Œï¼Œä¸å¤šä¸å°‘ï¼›</p>
<p>æ¥æˆ–è€…ä¸æ¥ï¼Œæ¸©åº¦å°±åœ¨é‚£é‡Œï¼Œä¸å¢ä¸å‡ã€‚</p>
<p>ä»²å¤æµ·é£ï¼Œå¸­å·å–§åš£çƒ­æµªï¼›æ©™è‰²é»„æ˜ï¼Œç›¸æ‹¥è–„è·é»æ˜ã€‚</p>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>ConcurrentLinkedQueue</title>
    <url>/posts/29870/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ğŸ” åŸºäºJDK1.8çš„ConcurrentLinkedQueueæºç åˆ†æã€‚</p>
<h2 id="åŸºæœ¬çŸ¥è¯†"><a href="#åŸºæœ¬çŸ¥è¯†" class="headerlink" title="åŸºæœ¬çŸ¥è¯†"></a>åŸºæœ¬çŸ¥è¯†</h2><ul>
<li><p>å§‹äºï¼š<strong>JDK 1.5</strong></p>
</li>
<li><p>ä½œè€…ï¼š<strong>Doug Lea</strong></p>
</li>
<li><p>ç‰¹ç‚¹ï¼šçº¿ç¨‹å®‰å…¨ï¼Œæ— ç•Œéé˜»å¡</p>
</li>
<li><p>ç»“æ„ï¼šå•å‘é“¾è¡¨</p>
</li>
<li><p>ç±»å›¾ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/ConcurrentLinkedQueue.png" class="" title="ConcurrentLinkedQueue">



</li>
</ul>
<h2 id="ä¸»è¦å±æ€§"><a href="#ä¸»è¦å±æ€§" class="headerlink" title="ä¸»è¦å±æ€§"></a>ä¸»è¦å±æ€§</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// èŠ‚ç‚¹ç±»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å€¼</span></span><br><span class="line">    <span class="keyword">volatile</span> E item;</span><br><span class="line">    <span class="comment">// åç»§ç»“ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node&lt;E&gt; next;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°è°ƒç”¨unsafe.putObject</span></span><br><span class="line">    Node(E item) &#123;</span><br><span class="line">        UNSAFE.putObject(<span class="keyword">this</span>, itemOffset, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å€¼å’Œåç»§èŠ‚ç‚¹çš„ä¿®æ”¹æ“ä½œå…¨éƒ¨ä½¿ç”¨CASå®ç°</span></span><br><span class="line">     </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">casItem</span><span class="params">(E cmp, E val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, itemOffset, cmp, val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lazySetNext</span><span class="params">(Node&lt;E&gt; val)</span> </span>&#123;</span><br><span class="line">        UNSAFE.putOrderedObject(<span class="keyword">this</span>, nextOffset, val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">casNext</span><span class="params">(Node&lt;E&gt; cmp, Node&lt;E&gt; val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, nextOffset, cmp, val);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤´èŠ‚ç‚¹ï¼ˆnullï¼Œä¼ªèŠ‚ç‚¹ï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; head;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; tail;</span><br><span class="line"></span><br><span class="line"><span class="comment">// unsafeå¯¹è±¡ï¼Œç”¨äºCASæ“ä½œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> sun.misc.Unsafe UNSAFE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤´èŠ‚ç‚¹çš„åŸŸåç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> headOffset;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°¾èŠ‚ç‚¹çš„åŸŸåç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> tailOffset;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æ€åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        UNSAFE = sun.misc.Unsafe.getUnsafe();</span><br><span class="line">        Class&lt;?&gt; k = ConcurrentLinkedQueue.class;</span><br><span class="line">        headOffset = UNSAFE.objectFieldOffset(k.getDeclaredField(<span class="string">&quot;head&quot;</span>));</span><br><span class="line">        tailOffset = UNSAFE.objectFieldOffset(k.getDeclaredField(<span class="string">&quot;tail&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ— å‚æ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentLinkedQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    head = tail = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é›†åˆæ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentLinkedQueue</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">    Node&lt;E&gt; h = <span class="keyword">null</span>, t = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (E e : c) &#123;</span><br><span class="line">        checkNotNull(e);</span><br><span class="line">        Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;E&gt;(e);</span><br><span class="line">        <span class="keyword">if</span> (h == <span class="keyword">null</span>)</span><br><span class="line">            h = t = newNode;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            t.lazySetNext(newNode);</span><br><span class="line">            t = newNode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="keyword">null</span>)</span><br><span class="line">        h = t = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</span><br><span class="line">    head = h;</span><br><span class="line">    tail = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="offer-E-e"><a href="#offer-E-e" class="headerlink" title="offer(E e)"></a>offer(E e)</h2><p>ç”¨é€”ï¼šåœ¨é˜Ÿåˆ—æœ«å°¾æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// eä¸ºnullæŠ›å‡ºNullPointerException</span></span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œæ„é€ å‡½æ•°å†…éƒ¨è°ƒç”¨unsafe.putObject</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;E&gt;(e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (1) éå†é“¾è¡¨ï¼Œæ— é™å¾ªç¯+CASé‡è¯•ï¼Œç›´åˆ°ä»(3)è¿”å›</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; t = tail, p = t;;) &#123;</span><br><span class="line">        Node&lt;E&gt; q = p.next;</span><br><span class="line">        <span class="comment">// (2) å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜å½“å‰ä¸ºæœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (q == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// (3) ä½¿ç”¨CASæ“ä½œè®¾ç½®pçš„åç»§èŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹  </span></span><br><span class="line">            <span class="keyword">if</span> (p.casNext(<span class="keyword">null</span>, newNode)) &#123;</span><br><span class="line">                <span class="comment">// CASæˆåŠŸï¼Œåˆ™è¯´æ˜æ–°èŠ‚ç‚¹å·²ç»æ’å…¥é“¾è¡¨</span></span><br><span class="line">                <span class="comment">// ç„¶åé€šè¿‡CASæ“ä½œè®¾ç½®å½“å‰å°¾èŠ‚ç‚¹</span></span><br><span class="line">                <span class="comment">// (4) å½“å‰èŠ‚ç‚¹ä¸ä¸ºå°¾èŠ‚ç‚¹ï¼Œè¯´æ˜æœ‰çº¿ç¨‹æŠ¢å…ˆä¸€æ­¥æ›´æ–°äº†å°¾èŠ‚ç‚¹</span></span><br><span class="line">                <span class="comment">// æŠŠå°¾èŠ‚ç‚¹åŸå­æ›´æ–°ä¸ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (p != t) </span><br><span class="line">                    casTail(t, newNode);  <span class="comment">// Failure is OK.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// (5) å½“å‰èŠ‚ç‚¹è¢«è‡ªå¼•ç”¨ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤ é‡æ–°è®¾ç½®pçš„å€¼</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">            <span class="comment">// å¤šçº¿ç¨‹æ“ä½œï¼Œç”±äºpollæ“ä½œå æœ‰å¯èƒ½æŠŠheadå˜ä¸ºè‡ªå¼•ç”¨</span></span><br><span class="line">            <span class="comment">// head.next = nextï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦é‡æ–°æ‰¾æ–°çš„head</span></span><br><span class="line">            <span class="comment">// å› ä¸ºheadåé¢çš„èŠ‚ç‚¹æ‰æ˜¯æ­£å¸¸çš„èŠ‚ç‚¹</span></span><br><span class="line">            p = (t != (t = tail)) ? t : head;</span><br><span class="line">        <span class="comment">// (6) å½“å‰èŠ‚ç‚¹ä¸æ˜¯å°¾èŠ‚ç‚¹ï¼Œé‡æ–°å¯»æ‰¾å°¾èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// p == t || t = tail =&gt; æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ›´æ–°tailï¼Œ</span></span><br><span class="line">            <span class="comment">// p != t &amp;&amp; t != tail =&gt; æœ‰å…¶ä»–çº¿ç¨‹æ›´æ–°tailï¼Œé‚£ä¹ˆæœ€æ–°çš„tailèŠ‚ç‚¹ï¼Œå³qèŠ‚ç‚¹</span></span><br><span class="line">            p = (p != t &amp;&amp; t != (t = tail)) ? t : q;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ1ï¼‰å•çº¿ç¨‹æ‰§è¡Œ<code>offer(item)</code></p>
<p>é¦–å…ˆè¿›è¡Œå‚æ•°åˆ¤ç©ºï¼Œç©ºåˆ™æŠ›å‡ºNPEå¼‚å¸¸ï¼Œä½¿ç”¨itemä½œä¸ºå‚æ•°æ„é€ ä¸€ä¸ªæ–°èŠ‚ç‚¹<code>item</code>ã€‚</p>
<p>æ‰§è¡Œä»£ç ï¼ˆ1ï¼‰ï¼Œè¿™æ—¶å€™<code>head</code>ã€<code>tail</code>ã€<code>p</code>ã€<code>t</code>åŒæ—¶æŒ‡å‘äº†å“¨å…µèŠ‚ç‚¹ã€‚åŒæ—¶<code>q</code>æŒ‡å‘å“¨å…µèŠ‚ç‚¹çš„åç»§ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/offer-1.svg" class="" title="offer-1">



<p>æ‰§è¡Œä»£ç ï¼ˆ2ï¼‰ï¼Œå‘ç° <code>q == null</code>åˆ™æ‰§è¡Œä»£ç ï¼ˆ3ï¼‰ï¼Œé€šè¿‡CASæ“ä½œå°†<code>p.next</code>è®¾ç½®ä¸º<code>item</code>ã€‚</p>
<p>è¿™é‡Œ <code>p == t</code>æˆåŠŸï¼Œæ‰€ä»¥æ²¡æœ‰è®¾ç½®å°¾èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›<code>true</code>ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/offer-2.svg" class="" title="offer-2">



<p>ï¼ˆ2ï¼‰åŒçº¿ç¨‹æ‰§è¡Œ</p>
<p>å‡è®¾ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä»£ç ï¼ˆ3ï¼‰ï¼Œçº¿ç¨‹1è°ƒç”¨<code>offer(item1)</code>ï¼Œçº¿ç¨‹2è°ƒç”¨<code>offer(item2)</code>ã€‚</p>
<p>å‡è®¾çº¿ç¨‹1å…ˆæ‰§è¡ŒCASæ“ä½œï¼Œé‚£ä¹ˆæ›´æ–°<code>p</code>çš„<code>next</code>èŠ‚ç‚¹ä¸º<code>item1</code>ï¼Œé‚£ä¹ˆçº¿ç¨‹2æ‰§è¡ŒCASæ“ä½œçš„æ—¶å€™ï¼Œå‘ç°<code>p</code>çš„<code>next</code>èŠ‚ç‚¹å¹¶ä¸æ˜¯<code>null</code>ï¼Œç„¶åæ‰§è¡Œé‡æ–°å¾ªç¯ï¼Œæ‰§è¡Œä»£ç ï¼ˆ1ï¼‰ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/offer-3.svg" class="" title="offer-3">



<p>çº¿ç¨‹2æ‰§è¡Œä»£ç ï¼ˆ2ï¼‰ï¼Œç”±äº<code>q != null</code>ï¼Œäºæ˜¯çº¿ç¨‹2æ‰§è¡Œä»£ç ï¼ˆ6ï¼‰ï¼Œ<code>p = q</code>ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/offer-4.svg" class="" title="offer-4">



<p>çº¿ç¨‹2é‡æ–°å¾ªç¯ï¼Œæ‰§è¡Œä»£ç ï¼ˆ1ï¼‰ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/offer-5.svg" class="" title="offer-5">



<p>çº¿ç¨‹æ‰§è¡Œä»£ç ï¼ˆ2ï¼‰ï¼Œç”±äº<code>q == null</code>ï¼Œæ¥ç€æ‰§è¡Œä»£ç ï¼ˆ3ï¼‰ï¼Œé€šè¿‡CASæ“ä½œæ›´æ–°<code>p</code>çš„<code>next</code>èŠ‚ç‚¹ä¸º<code>item2</code>ã€‚</p>
<p>ç„¶åæ‰§è¡Œä»£ç ï¼ˆ4ï¼‰ï¼Œç”±äº<code>p != t</code>ï¼Œæ‰€ä»¥é€šè¿‡CASæ“ä½œé‡æ–°è®¾ç½®å°¾èŠ‚ç‚¹ä¸º<code>item2</code>ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/offer-6.svg" class="" title="offer-6">

<p>ï¼ˆ3ï¼‰ç¬¬ä¸‰æƒ…å†µ</p>
<p>åœ¨ä»¥ä¸Šçš„ä¸¤ç§æƒ…å†µä¸­ï¼Œè¿˜å·®ä»£ç ï¼ˆ5ï¼‰çš„æ‰§è¡Œæƒ…å†µæ²¡æœ‰å‡ºç°ã€‚</p>
<p>åœ¨<code>poll</code>æ“ä½œåå¯èƒ½ä¼šå­˜åœ¨çš„ä¸€ç§æƒ…å†µã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/offer-7.svg" class="" title="offer-7">



<p>æ‰§è¡Œä»£ç ï¼ˆ2ï¼‰æ—¶ï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/offer-8.svg" class="" title="offer-8">



<p>æ­¤æ—¶<code>q != null </code>å¹¶ä¸”<code>p == q</code>ï¼ˆ<code>tail</code>ç»“ç‚¹çš„<code>item</code>ä¸ºç©ºï¼Œä½†æ˜¯<code>tail</code>ä¸ä¸ºç©ºï¼‰ï¼Œæ‰€ä»¥æ‰§è¡Œä»£ç ï¼ˆ5ï¼‰ï¼Œç”±äº<code>t == tail</code>ï¼Œæ‰€ä»¥<code>p = head</code>ã€‚</p>
<p>ç„¶åé‡æ–°å¾ªç¯ï¼Œæ‰§è¡Œä»£ç ï¼ˆ1ï¼‰ï¼Œå¹¶ä¸”æ‰§è¡Œåˆ°ï¼ˆ2ï¼‰ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/offer-9.svg" class="" title="offer-9">



<p>æ­¤æ—¶ç”±äº<code>q == null</code>ï¼Œæ‰§è¡Œä»£ç ï¼ˆ3ï¼‰è¿›è¡ŒCASæ“ä½œï¼Œå¦‚æœæ²¡æœ‰ç«äº‰çº¿ç¨‹ï¼Œåˆ™CASæˆåŠŸï¼Œ<code>p</code>çš„<code>next</code>ç»“ç‚¹è®¾ç½®ä¸ºæ–°èŠ‚ç‚¹ï¼Œç„¶åæ‰§è¡Œä»£ç ï¼ˆ4ï¼‰ï¼Œç”±äº<code>p != t</code>ï¼Œæ‰€ä»¥è®¾ç½®æ–°èŠ‚ç‚¹ä¸ºæ–°çš„å°¾èŠ‚ç‚¹ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/offer-10.svg" class="" title="offer-10">



<p>è¿™é‡Œè‡ªå¼•ç”¨çš„ç»“ç‚¹åˆ™ä¼šè¢«GCã€‚</p>
<p>å¯è§ï¼Œ<code>offer</code>æ“ä½œçš„å…³é”®æ­¥éª¤æ˜¯ä»£ç ï¼ˆ3ï¼‰ï¼Œé€šè¿‡CASæ“ä½œæ¥æ§åˆ¶æŸä¸€æ—¶åˆ»åªèƒ½æœ‰1ä¸ªçº¿ç¨‹å¯ä»¥è¿½åŠ å…ƒç´ åˆ°é˜Ÿåˆ—æœ«å°¾ã€‚è¿›è¡ŒCASç«äº‰å¤±è´¥çš„çº¿ç¨‹ä¼šé€šè¿‡å¾ªç¯ä¸æ–­å°è¯•CASæ“ä½œï¼Œç›´åˆ°CASæˆåŠŸæ‰ä¼šè¿”å›ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡æ— çº¿å¾ªç¯ä¸æ–­è¿›è¡ŒCASå°è¯•æ–¹å¼æ¥ä»£æ›¿é˜»å¡ç®—æ³•æŒ‚èµ·è°ƒç”¨çº¿ç¨‹ã€‚ç›¸æ¯”é˜»å¡ç®—æ³•ï¼Œè¿™æ˜¯ä½¿ç”¨CPUèµ„æºæ¢å–é˜»å¡æ‰€å¸¦æ¥çš„å¼€é”€ã€‚</p>
<h2 id="poll"><a href="#poll" class="headerlink" title="poll()"></a>poll()</h2><p>ç”¨é€”ï¼šåœ¨é˜Ÿåˆ—å¤´éƒ¨è·å–å¹¶ç§»é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å›nullã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// gotoæ ‡è®°</span></span><br><span class="line">    restartFromHead:</span><br><span class="line">    <span class="comment">// (1) æ— é™å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// (2) ä»å¤´èŠ‚ç‚¹å¼€å§‹éå†</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; h = head, p = h, q;;) &#123;</span><br><span class="line">            <span class="comment">// (3) ä¿å­˜å½“å‰èŠ‚ç‚¹å€¼</span></span><br><span class="line">            E item = p.item;</span><br><span class="line">			<span class="comment">// (4) å½“å‰èŠ‚ç‚¹å€¼ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡CASæ“ä½œå°†å…¶è®¾ç½®ä¸ºnull</span></span><br><span class="line">            <span class="keyword">if</span> (item != <span class="keyword">null</span> &amp;&amp; p.casItem(item, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                <span class="comment">// (5) CASæˆåŠŸåˆ™æ ‡è®°å½“å‰èŠ‚ç‚¹å¹¶ä»é“¾è¡¨ä¸­ç§»é™¤</span></span><br><span class="line">                <span class="keyword">if</span> (p != h)</span><br><span class="line">                    updateHead(h, ((q = p.next) != <span class="keyword">null</span>) ? q : p);</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// (6) å½“å‰é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¿”å›null</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((q = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                updateHead(h, p);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// (7) å½“å‰èŠ‚ç‚¹è‡ªå¼•ç”¨ï¼Œé‡æ–°å¯»æ‰¾å¤´èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">                <span class="keyword">continue</span> restartFromHead;</span><br><span class="line">            <span class="comment">// (8) å½“å‰èŠ‚ç‚¹æŒ‡å‘ä¸‹ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p = q;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°å¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">updateHead</span><span class="params">(Node&lt;E&gt; h, Node&lt;E&gt; p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (h != p &amp;&amp; casHead(h, p))</span><br><span class="line">        <span class="comment">// è‡ªå¼•ç”¨ï¼Œä»è€Œå­¤ç«‹ï¼Œè¢«GC</span></span><br><span class="line">        h.lazySetNext(h);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ1ï¼‰<code>poll</code>æ“ä½œä»é˜Ÿåˆ—å¤´è·å–å…ƒç´ ï¼Œæ‰€ä»¥å¾ªç¯ä»<code>head</code>èŠ‚ç‚¹å¼€å§‹ï¼Œæ‰§è¡Œä»£ç ï¼ˆ3ï¼‰è·å–å½“å‰é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ã€‚é˜Ÿåˆ—å¼€å§‹ä¸ºç©ºçš„æ—¶å€™çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-1.svg" class="" title="poll-1">



<p>ç”±äº<code>head</code>èŠ‚ç‚¹ä¸ºç©ºï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œåˆ°ä»£ç ï¼ˆ6ï¼‰ï¼Œå¦‚æœè¿™ä¸ªè¿‡ç¨‹ä¸­æ²¡æœ‰çº¿ç¨‹è°ƒç”¨<code>offer</code>æ–¹æ³•ï¼Œåˆ™æ­¤æ—¶<code>q == null</code>ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-2.svg" class="" title="poll-2">



<p>æ‰€ä»¥ä¼šæ‰§è¡Œ<code>updateHead</code>æ–¹æ³•ï¼Œç”±äº<code>h == p</code>ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œ<code>casHead</code>ï¼Œç›´æ¥è¿”å›nullã€‚</p>
<p>ï¼ˆ2ï¼‰å‡è®¾æ‰§è¡Œåˆ°ä»£ç ï¼ˆ6ï¼‰æ—¶å·²ç»æœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†<code>offer</code>æ–¹æ³•å¹¶æˆåŠŸæ·»åŠ ä¸€ä¸ªå…ƒç´ åˆ°é˜Ÿåˆ—ï¼Œè¿™æ—¶å€™<code>q</code>æŒ‡å‘çš„æ˜¯æ–°å¢å…ƒç´ çš„èŠ‚ç‚¹ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-3.svg" class="" title="poll-3">



<p>æ‰§è¡Œä»£ç ï¼ˆ6ï¼‰ï¼Œ<code>q != null</code>ï¼Œç»§ç»­æ‰§è¡Œä»£ç ï¼ˆ7ï¼‰ï¼Œ<code>p != q</code>ï¼Œæœ€åæ‰§è¡Œä»£ç ï¼ˆ8ï¼‰ï¼Œ<code>p = q</code>ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-4.svg" class="" title="poll-4">



<p>ç»§ç»­å¾ªç¯ï¼Œæ‰§è¡Œä»£ç ï¼ˆ3ï¼‰åæ‰§è¡Œä»£ç ï¼ˆ4ï¼‰ï¼Œæ­¤æ—¶<code>p.item</code>ä¸ä¸ºnullï¼Œäºæ˜¯é€šè¿‡CASæ“ä½œå°è¯•å°†<code>p.item</code>è®¾ç½®ä¸ºnullï¼Œå‡è®¾æ­¤æ—¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹è¿›è¡Œ<code>poll</code>æ“ä½œï¼Œåˆ™CASæ“ä½œæˆåŠŸåæ‰§è¡Œä»£ç ï¼ˆ5ï¼‰ï¼Œç”±äºæ­¤æ—¶<code>p != h</code>ï¼Œæ‰€ä»¥è®¾ç½®å¤´èŠ‚ç‚¹ä¸º<code>p</code>ï¼Œå¹¶ä¸”è®¾ç½®<code>h</code>çš„<code>next</code>èŠ‚ç‚¹ä¸º<code>h</code>è‡ªå·±ï¼Œè¿”å›ä»ç§»é™¤èŠ‚ç‚¹å€¼<code>item</code>ã€‚é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-5.svg" class="" title="poll-5">



<p>è¿™ä¸ªçŠ¶æ€å°±æ˜¯<code>offer</code>æ“ä½œæ‰§è¡Œä»£ç ï¼ˆ5ï¼‰çš„çŠ¶æ€ã€‚</p>
<p>ï¼ˆ3ï¼‰å‡è®¾ç°åœ¨ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†<code>poll</code>æ“ä½œï¼Œåˆ™åœ¨æ‰§è¡Œä»£ç ï¼ˆ4ï¼‰æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-6.svg" class="" title="poll-6">



<p>è¿™æ—¶å€™æ‰§è¡Œä»£ç ï¼ˆ6ï¼‰è¿”å›ã€‚</p>
<p>ï¼ˆ4ï¼‰ç°åœ¨è¿˜æœ‰ä»£ç åˆ†æ”¯ï¼ˆ7ï¼‰æ²¡æœ‰æ‰§è¡Œè¿‡ã€‚</p>
<p>å‡è®¾çº¿ç¨‹1æ‰§è¡Œ<code>poll</code>æ“ä½œæ—¶å½“å‰é˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-7.svg" class="" title="poll-7">



<p>é‚£ä¹ˆæ‰§è¡Œä»£ç ï¼ˆ4ï¼‰æ—¶ï¼Œé€šè¿‡CASæ“ä½œè®¾ç½®<code>p.item</code>ä¸ºnullï¼Œå‡è®¾CASè®¾ç½®æˆåŠŸåˆ™æ ‡è®°è¯¥èŠ‚ç‚¹å¹¶ä»é˜Ÿåˆ—ä¸­å°†å…¶æ¸…é™¤ï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-8.svg" class="" title="poll-8">



<p>ç„¶åï¼Œç”±äº<code>p != h</code>ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œ<code>uploadHead</code>æ–¹æ³•ï¼Œå‡å¦‚çº¿ç¨‹1æ‰§è¡Œ<code>uploadHead</code>æ–¹æ³•å‰ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹2å¼€å§‹<code>poll</code>æ“ä½œï¼Œè¿™æ—¶å€™çº¿ç¨‹2çš„<code>p</code>æŒ‡å‘<code>head</code>èŠ‚ç‚¹ï¼Œä½†æ˜¯è¿˜æœªæ‰§è¡Œåˆ°ä»£ç ï¼ˆ6ï¼‰ï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-9.svg" class="" title="poll-9">



<p>ç„¶åçº¿ç¨‹1æ‰§è¡Œ<code>updateHead</code>æ–¹æ³•ï¼Œæ‰§è¡Œå®Œæ¯•åçº¿ç¨‹1é€€å‡ºï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-10.svg" class="" title="poll-10">



<p>ç„¶åçº¿ç¨‹2ç»§ç»­æ‰§è¡Œä»£ç ï¼ˆ6ï¼‰ï¼Œç”±äº<code>p</code>è‡ªå¼•ç”¨ï¼Œæ‰€ä»¥<code>p == q</code>ï¼Œäºæ˜¯è·³è½¬åˆ°å¤–å±‚å¾ªç¯<code>restartFromHead</code>ï¼Œé‡æ–°è·å–<code>head</code>ï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/poll-11.svg" class="" title="poll-11">



<p>æ€»ç»“ï¼š<code>poll</code>æ–¹æ³•åœ¨ç§»é™¤ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œåªæ˜¯ç®€å•åœ°ä½¿ç”¨CASæ“ä½œæŠŠå½“å‰èŠ‚ç‚¹çš„<code>item</code>è®¾ç½®ä¸ºnullï¼Œç„¶åé€šè¿‡è®¾ç½®å¤´èŠ‚ç‚¹å°†è¯¥å…ƒç´ ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œè¢«ç§»é™¤çš„èŠ‚ç‚¹å°±æˆäº†å­¤ç«‹èŠ‚ç‚¹ä»è€Œè¢«GCã€‚å¦å¤–ï¼Œå¦‚æœæ‰§è¡Œåˆ†æ”¯ä¸­å‘ç°å¤´èŠ‚ç‚¹è¢«ä¿®æ”¹äº†ï¼Œè¦è·³è½¬åˆ°å¤–å±‚å¾ªç¯é‡æ–°è·å–æ–°çš„å¤´èŠ‚ç‚¹ã€‚</p>
<h2 id="peek"><a href="#peek" class="headerlink" title="peek()"></a>peek()</h2><p>ç”¨é€”ï¼šè·å–é˜Ÿåˆ—å¤´éƒ¨çš„ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™è¿”å›nullã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">peek</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// gotoæ ‡è®°</span></span><br><span class="line">    restartFromHead:</span><br><span class="line">    <span class="comment">// (1) æ— é™å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// (2) ä»å¤´èŠ‚ç‚¹å¼€å§‹éå†</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; h = head, p = h, q;;) &#123;</span><br><span class="line">            <span class="comment">// (3) ä¿å­˜å½“å‰èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">            E item = p.item;</span><br><span class="line">            <span class="comment">// (4) å½“å‰èŠ‚ç‚¹å€¼ä¸ä¸ºç©ºä¸”ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å€¼ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">if</span> (item != <span class="keyword">null</span> || (q = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                updateHead(h, p);</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// (5) å½“å‰èŠ‚ç‚¹è‡ªå¼•ç”¨ï¼Œé‡æ–°å¯»æ‰¾å¤´èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">                <span class="keyword">continue</span> restartFromHead;</span><br><span class="line">            <span class="comment">// (6) å½“å‰ç»“ç‚¹æŒ‡å‘ä¸‹ä¸ªç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p = q;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ä¼šå‘ç°<code>item</code> ä¸ºç©ºï¼Œç¬¬äºŒæ¬¡å¾ªç¯æ—¶<code>p</code>æŒ‡å‘é˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ‰§è¡Œä»£ç ï¼ˆ4ï¼‰ï¼Œ<code>q == null</code>æˆç«‹ã€‚</p>
<p>ï¼ˆ1ï¼‰é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/peek-1.svg" class="" title="peek-1">



<p>è¿™æ—¶å€™æ‰§è¡Œ<code>updateHead</code>æ–¹æ³•ï¼Œç”±äº<code>p == h</code>ï¼Œæ‰€ä»¥ä¸è¿›è¡Œä»»ä½•æ“ä½œï¼Œç›´æ¥è¿”å›nullã€‚</p>
<p>ï¼ˆ2ï¼‰é˜Ÿåˆ—è‡³å°‘æœ‰ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/peek-2.svg" class="" title="peek-2">



<p>è¿™æ—¶å€™æ‰§è¡Œä»£ç ï¼ˆ6ï¼‰ï¼Œ<code>p = q</code>ï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/peek-3.svg" class="" title="peek-3">



<p>é‡æ–°å¾ªç¯ï¼Œæ‰§è¡Œä»£ç ï¼ˆ4ï¼‰æ—¶ï¼Œ<code>item != null</code>ï¼Œæ‰€ä»¥æ‰§è¡Œ<code>updateHead</code>æ–¹æ³•ï¼Œç”±äº<code>h != p</code>ï¼Œæ‰€ä»¥é‡æ–°å¤´èŠ‚ç‚¹ä¸º<code>p</code>ï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/peek-4.svg" class="" title="peek-4">



<p>å³å‰”é™¤äº†å“¨å…µèŠ‚ç‚¹ã€‚</p>
<p>æ€»ç»“ï¼š<code>peek</code>æ“ä½œå’Œ<code>poll</code>æ“ä½œç±»ä¼¼ï¼Œåªæ˜¯å‰è€…åªè·å–å¤´èŠ‚ç‚¹ä½†ä¸åˆ é™¤ã€‚å¦å¤–ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨<code>peek</code>æ–¹æ³•æ—¶ä¼šåˆ é™¤å“¨å…µèŠ‚ç‚¹ï¼Œå¹¶è®©å¤´èŠ‚ç‚¹æŒ‡å‘é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ æˆ–è€…nullã€‚</p>
<h2 id="size"><a href="#size" class="headerlink" title="size()"></a>size()</h2><p>ç”¨é€”ï¼šè®¡ç®—å½“å‰é˜Ÿåˆ—å€¼ä¸ä¸ºç©ºçš„å…ƒç´ ä¸ªæ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; p = first(); p != <span class="keyword">null</span>; p = succ(p))</span><br><span class="line">        <span class="keyword">if</span> (p.item != <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">// æœ€å¤§å€¼Integer.MAX_VALUE</span></span><br><span class="line">            <span class="keyword">if</span> (++count == Integer.MAX_VALUE)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç¬¬ä¸€ä¸ªé˜Ÿåˆ—å…ƒç´ ï¼Œæ— åˆ™ä¸ºnull</span></span><br><span class="line"><span class="function">Node&lt;E&gt; <span class="title">first</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// gotoæ ‡è®°</span></span><br><span class="line">    restartFromHead:</span><br><span class="line">    <span class="comment">// (1) æ— é™å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// (2) ä»å¤´èŠ‚ç‚¹å¼€å§‹éå†</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; h = head, p = h, q;;) &#123;</span><br><span class="line">            <span class="comment">// (3) æ ‡è®°å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰å€¼</span></span><br><span class="line">            <span class="keyword">boolean</span> hasItem = (p.item != <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// (4) å½“å‰èŠ‚ç‚¹æœ‰å€¼ï¼Œæˆ–è€…å½“å‰èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">            <span class="keyword">if</span> (hasItem || (q = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                updateHead(h, p);</span><br><span class="line">                <span class="keyword">return</span> hasItem ? p : <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// (5) å½“å‰èŠ‚ç‚¹è‡ªå¼•ç”¨ï¼Œé‡æ–°å¯»æ‰¾å¤´èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">                <span class="keyword">continue</span> restartFromHead;</span><br><span class="line">            <span class="comment">// (6) å½“å‰èŠ‚ç‚¹æŒ‡å‘ä¸‹ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p = q;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯è‡ªå¼•ç”¨åˆ™è¿”å›çœŸæ­£çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;E&gt; <span class="title">succ</span><span class="params">(Node&lt;E&gt; p)</span> </span>&#123;</span><br><span class="line">    Node&lt;E&gt; next = p.next;</span><br><span class="line">    <span class="keyword">return</span> (p == next) ? head : next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="remove-Object-o"><a href="#remove-Object-o" class="headerlink" title="remove(Object o)"></a>remove(Object o)</h2><p>ç”¨é€”ï¼šåˆ é™¤æŒ‡å®šå€¼çš„å…ƒç´ ï¼Œé˜Ÿåˆ—ä¸­å­˜åœ¨ä¸€ä¸ªåˆ™ç›´æ¥åˆ é™¤ï¼Œå­˜åœ¨å¤šä¸ªåˆ™åˆ é™¤ç¬¬ä¸€ä¸ªï¼Œå¹¶è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (1) åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (o != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Node&lt;E&gt; next, pred = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// (2) éå†é“¾è¡¨</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; p = first(); p != <span class="keyword">null</span>; pred = p, p = next) &#123;</span><br><span class="line">            <span class="comment">// (3) æ ‡è®°æ˜¯å¦ç§»é™¤</span></span><br><span class="line">            <span class="keyword">boolean</span> removed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// (4) å½“å‰èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">            E item = p.item;</span><br><span class="line">            <span class="comment">// (5) åŒ¹é…æˆåŠŸï¼Œåˆ™ä½¿ç”¨CASè®¾ç½®å½“å‰èŠ‚ç‚¹çš„å€¼è®¾ç½®ä¸ºnull</span></span><br><span class="line">            <span class="comment">// å¤±è´¥çš„çº¿ç¨‹ç»§ç»­å¾ªç¯æŸ¥æ‰¾é˜Ÿåˆ—ä¸­æ˜¯å¦å…¶ä»–åŒ¹é…çš„å…ƒç´ </span></span><br><span class="line">            <span class="keyword">if</span> (item != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!o.equals(item)) &#123;</span><br><span class="line">                    next = succ(p);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                removed = p.casItem(item, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// (6) è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            next = succ(p);</span><br><span class="line">            <span class="comment">// (7) å¦‚æœå‰é©±èŠ‚ç‚¹å’Œåç»§èŠ‚ç‚¹å‡ä¸ä¸ºç©ºï¼Œå°†å‰é©±èŠ‚ç‚¹çš„åç»§æŒ‡å‘åç»§èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (pred != <span class="keyword">null</span> &amp;&amp; next != <span class="keyword">null</span>) </span><br><span class="line">                pred.casNext(p, next);</span><br><span class="line">            <span class="keyword">if</span> (removed)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="æœ€åå°ç»“"><a href="#æœ€åå°ç»“" class="headerlink" title="æœ€åå°ç»“"></a>æœ€åå°ç»“</h2><p><code>ConcurrentLinkedQueue</code>çš„åº•å±‚ä½¿ç”¨å•å‘é“¾è¡¨æ¥ä¿å­˜é˜Ÿåˆ—å…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ ç»™å°è£…æˆèŠ‚ç‚¹ã€‚é˜Ÿåˆ—é å¤´å°¾èŠ‚ç‚¹æ¥ç»´æŠ¤ï¼Œåˆ›å»ºé˜Ÿåˆ—æ—¶å¤´å°¾èŠ‚ç‚¹éƒ½æŒ‡å‘ä¸€ä¸ª<code>item</code>ä¸ºnullçš„å“¨å…µèŠ‚ç‚¹ã€‚ç¬¬ä¸€æ¬¡æ‰§è¡Œ<code>peek</code>æˆ–è€…<code>first</code>æ—¶ä¼šæŠŠåˆ é™¤å“¨å…µèŠ‚ç‚¹ï¼ŒæŠŠå¤´èŠ‚ç‚¹æŒ‡å‘ç¬¬ä¸€ä¸ªçœŸæ­£çš„èŠ‚ç‚¹ã€‚ç”±äºä½¿ç”¨éé˜»å¡CASç®—æ³•ï¼Œæ²¡æœ‰åŠ é”ï¼Œæ‰€ä»¥åœ¨è®¡ç®—<code>size</code>æ—¶æœ‰å¯èƒ½è¿›è¡Œäº†<code>offer</code>ã€<code>poll</code>æˆ–è€…<code>remove</code>æ“ä½œï¼Œå¯¼è‡´è®¡ç®—çš„å…ƒç´ ä¸ªæ•°ä¸ç²¾ç¡®ï¼Œæ‰€ä»¥åœ¨å¹¶å‘æƒ…å†µä¸‹<code>size</code>æ–¹æ³•ä¸æ¨èä½¿ç”¨ã€‚</p>
<p>å…¥é˜Ÿã€å‡ºé˜Ÿéƒ½æ˜¯æ“ä½œ<code>volatile</code>ä¿®é¥°çš„<code>tail</code>å’Œ<code>head</code>èŠ‚ç‚¹ï¼Œè¦ä¿è¯åœ¨å¤šçº¿ç¨‹ä¸‹å‡ºå…¥é˜Ÿçº¿ç¨‹å®‰å…¨ï¼Œåªéœ€è¦ä¿è¯è¿™ä¸ªä¸¤ä¸ªèŠ‚ç‚¹æ“ä½œçš„å¯è§æ€§å’ŒåŸå­æ€§å³å¯ã€‚<code>volatile</code>ä¿è¯æ“ä½œå¯è§æ€§ï¼ŒCASSä¿è¯æ“ä½œåŸå­æ€§ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/29870/operate.svg" class="" title="operate">

<p><code>offer</code>æ“ä½œæ˜¯åœ¨<code>tail</code>åé¢å¢åŠ å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨<code>tail.cadNext</code>æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•ä½¿ç”¨çš„æ˜¯CASæ“ä½œï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šæˆåŠŸï¼Œç„¶åå¤±è´¥çš„çº¿ç¨‹ä¼šå¾ªç¯ï¼Œé‡æ–°è·å–<code>tail</code>ï¼Œå†æ‰§è¡Œ<code>casNext</code>æ–¹æ³•ã€‚<code>poll</code>æ“ä½œä¹Ÿé€šè¿‡ç±»ä¼¼CASçš„ç®—æ³•ä¿è¯å‡ºé˜Ÿæ—¶ç§»é™¤èŠ‚ç‚¹æ“ä½œçš„åŸå­æ€§ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>Java-Excel</title>
    <url>/posts/57208/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><h3 id="POI"><a href="#POI" class="headerlink" title="POI"></a>POI</h3><blockquote>
<p>ç®€ä»‹</p>
</blockquote>
<p>Apache POIæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„å¼€æ”¾æºç å‡½å¼åº“ï¼ŒPOIæä¾›APIç»™Javaç¨‹åºå¯¹Microsoft Officeæ ¼å¼æ¡£æ¡ˆè¯»å’Œå†™çš„åŠŸèƒ½ã€‚</p>
<blockquote>
<p>åŠŸèƒ½</p>
</blockquote>
<p>HSSF ï¼ æä¾›è¯»å†™Microsoft Excelæ ¼å¼æ¡£æ¡ˆçš„åŠŸèƒ½ã€‚</p>
<p>XSSF ï¼ æä¾›è¯»å†™Microsoft Excel OOXMLæ ¼å¼æ¡£æ¡ˆçš„åŠŸèƒ½ã€‚</p>
<p>HWPF ï¼ æä¾›è¯»å†™Microsoft Wordæ ¼å¼æ¡£æ¡ˆçš„åŠŸèƒ½ã€‚</p>
<p>HSLF ï¼ æä¾›è¯»å†™Microsoft PowerPointæ ¼å¼æ¡£æ¡ˆçš„åŠŸèƒ½ã€‚</p>
<p>HDGF ï¼ æä¾›è¯»å†™Microsoft Visio  Visioæ ¼å¼æ¡£æ¡ˆçš„åŠŸèƒ½ã€‚</p>
<h3 id="EasyExcel"><a href="#EasyExcel" class="headerlink" title="EasyExcel"></a>EasyExcel</h3><blockquote>
<p>ç®€ä»‹</p>
</blockquote>
<p>EasyExcelæ˜¯alibabaçš„ä¸€ä¸ªåŸºäºJavaçš„ç®€å•ã€çœå†…å­˜çš„è¯»å†™Excelçš„å¼€æºé¡¹ç›®ã€‚</p>
<blockquote>
<p>æ–‡æ¡£</p>
</blockquote>
<p>yuque: <a href="https://www.yuque.com/easyexcel/doc/easyexcel">https://www.yuque.com/easyexcel/doc/easyexcel</a></p>
<p>github: <a href="https://github.com/alibaba/easyexcel">https://github.com/alibaba/easyexcel</a></p>
<h2 id="POI-1"><a href="#POI-1" class="headerlink" title="POI"></a>POI</h2><h3 id="dependency"><a href="#dependency" class="headerlink" title="dependency"></a>dependency</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- test --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- xls(2003) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- xlsx(2007) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- jodatime --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><blockquote>
<p>HSSFåˆ›å»ºxls(2003ç‰ˆæœ¬)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * HSSFåˆ›å»ºxls</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrite03</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1ã€åˆ›å»ºä¸€ä¸ªå·¥ä½œç°¿</span></span><br><span class="line">    Workbook workbook = <span class="keyword">new</span> HSSFWorkbook();</span><br><span class="line">    <span class="comment">// 2ã€åˆ›å»ºä¸€ä¸ªå·¥ä½œè¡¨</span></span><br><span class="line">    Sheet sheet = workbook.createSheet(<span class="string">&quot;K1&quot;</span>);</span><br><span class="line">    <span class="comment">// 3ã€åˆ›å»ºç¬¬ä¸€è¡Œæ•°æ®</span></span><br><span class="line">    Row row1 = sheet.createRow(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 4ã€åˆ›å»ºä¸¤ä¸ªå•å…ƒæ ¼</span></span><br><span class="line">    Cell cell11 = row1.createCell(<span class="number">0</span>);</span><br><span class="line">    cell11.setCellValue(<span class="string">&quot;ID&quot;</span>);</span><br><span class="line">    Cell cell12 = row1.createCell(<span class="number">1</span>);</span><br><span class="line">    cell12.setCellValue(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 5ã€åˆ›å»ºç¬¬äºŒè¡Œæ•°æ®</span></span><br><span class="line">    Row row2 = sheet.createRow(<span class="number">1</span>);</span><br><span class="line">    Cell cell21 = row2.createCell(<span class="number">0</span>);</span><br><span class="line">    cell21.setCellValue(<span class="string">&quot;å§“å&quot;</span>);</span><br><span class="line">    Cell cell22 = row2.createCell(<span class="number">1</span>);</span><br><span class="line">    cell22.setCellValue(<span class="string">&quot;K1&quot;</span>);</span><br><span class="line">    <span class="comment">// 6ã€åˆ›å»ºç¬¬ä¸‰è¡Œæ•°æ®</span></span><br><span class="line">    Row row3 = sheet.createRow(<span class="number">2</span>);</span><br><span class="line">    Cell cell31 = row3.createCell(<span class="number">0</span>);</span><br><span class="line">    cell31.setCellValue(<span class="string">&quot;æ—¶é—´&quot;</span>);</span><br><span class="line">    Cell cell32 = row3.createCell(<span class="number">1</span>);</span><br><span class="line">    cell32.setCellValue(<span class="keyword">new</span> DateTime().toString(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">    <span class="comment">// 7ã€ç”Ÿæˆä¸€å¼ è¡¨</span></span><br><span class="line">    FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/file/ç»Ÿè®¡è¡¨03.xls&quot;</span>);</span><br><span class="line">    workbook.write(fileOutputStream);</span><br><span class="line">    fileOutputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>XSSFåˆ›å»ºxlsx(2007ç‰ˆæœ¬)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrite07</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1ã€åˆ›å»ºä¸€ä¸ªå·¥ä½œç°¿</span></span><br><span class="line">    Workbook workbook = <span class="keyword">new</span> XSSFWorkbook();</span><br><span class="line">    <span class="comment">// 2ã€åˆ›å»ºä¸€ä¸ªå·¥ä½œè¡¨</span></span><br><span class="line">    Sheet sheet = workbook.createSheet(<span class="string">&quot;K1&quot;</span>);</span><br><span class="line">    <span class="comment">// 3ã€åˆ›å»ºç¬¬ä¸€è¡Œæ•°æ®</span></span><br><span class="line">    Row row1 = sheet.createRow(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 4ã€åˆ›å»ºä¸¤ä¸ªå•å…ƒæ ¼</span></span><br><span class="line">    Cell cell11 = row1.createCell(<span class="number">0</span>);</span><br><span class="line">    cell11.setCellValue(<span class="string">&quot;ID&quot;</span>);</span><br><span class="line">    Cell cell12 = row1.createCell(<span class="number">1</span>);</span><br><span class="line">    cell12.setCellValue(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 5ã€åˆ›å»ºç¬¬äºŒè¡Œæ•°æ®</span></span><br><span class="line">    Row row2 = sheet.createRow(<span class="number">1</span>);</span><br><span class="line">    Cell cell21 = row2.createCell(<span class="number">0</span>);</span><br><span class="line">    cell21.setCellValue(<span class="string">&quot;å§“å&quot;</span>);</span><br><span class="line">    Cell cell22 = row2.createCell(<span class="number">1</span>);</span><br><span class="line">    cell22.setCellValue(<span class="string">&quot;K1&quot;</span>);</span><br><span class="line">    <span class="comment">// 6ã€åˆ›å»ºç¬¬ä¸‰è¡Œæ•°æ®</span></span><br><span class="line">    Row row3 = sheet.createRow(<span class="number">2</span>);</span><br><span class="line">    Cell cell31 = row3.createCell(<span class="number">0</span>);</span><br><span class="line">    cell31.setCellValue(<span class="string">&quot;æ—¶é—´&quot;</span>);</span><br><span class="line">    Cell cell32 = row3.createCell(<span class="number">1</span>);</span><br><span class="line">    cell32.setCellValue(<span class="keyword">new</span> DateTime().toString(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">    <span class="comment">// 7ã€ç”Ÿæˆä¸€å¼ è¡¨</span></span><br><span class="line">    FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/file/ç»Ÿè®¡è¡¨07.xlsx&quot;</span>);</span><br><span class="line">    workbook.write(fileOutputStream);</span><br><span class="line">    fileOutputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> æ³¨æ„åŒºåˆ«</p>
</blockquote>
<ul>
<li>å¯¹è±¡ä¸åŒï¼Œ03ç‰ˆæœ¬æ˜¯<code>HSSFWorkBook</code>ï¼Œ07ç‰ˆæœ¬æ˜¯<code>XSSFWorkBook</code></li>
<li>æ–‡ä»¶åç¼€ï¼Œ03ç‰ˆæœ¬excelåç¼€æ˜¯<code>xls</code>ï¼Œ07ç‰ˆæœ¬excelåç¼€æ˜¯<code>xlsx</code></li>
</ul>
<blockquote>
<p>å¤§æ–‡ä»¶å†™HSSF</p>
</blockquote>
<p>ç¼ºç‚¹ï¼šæœ€å¤šåªèƒ½å¤„ç†65536è¡Œï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸</p>
<p>ä¼˜ç‚¹ï¼šè¿‡ç¨‹ä¸­å†™å…¥ç¼“å­˜ï¼Œä¸æ“ä½œç£ç›˜ï¼Œæœ€åä¸€æ¬¡æ€§å†™å…¥ç£ç›˜ï¼Œé€Ÿåº¦å¿«</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrite03BigData</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// åˆ›å»ºå·¥ä½œç°¿</span></span><br><span class="line">    Workbook workbook = <span class="keyword">new</span> HSSFWorkbook();</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€å¼ è¡¨</span></span><br><span class="line">    Sheet sheet = workbook.createSheet();</span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> rowNum = <span class="number">0</span>; rowNum &lt; <span class="number">65537</span>; rowNum++) &#123;</span><br><span class="line">        Row row = sheet.createRow(rowNum);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> cellNum = <span class="number">0</span>; cellNum &lt; <span class="number">10</span>; cellNum++) &#123;</span><br><span class="line">            Cell cell = row.createCell(cellNum);</span><br><span class="line">            cell.setCellValue(cellNum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/file/testWrite03BigData.xls&quot;</span>);</span><br><span class="line">    workbook.write(fileOutputStream);</span><br><span class="line">    fileOutputStream.close();</span><br><span class="line">    <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;è€—æ—¶ï¼š&quot;</span> + (end - start) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¤§æ–‡ä»¶å†™XSSF</p>
</blockquote>
<p>ç¼ºç‚¹ï¼šå†™æ•°æ®æ—¶é€Ÿåº¦éå¸¸æ…¢ï¼Œéå¸¸è€—å†…å­˜ï¼Œä¹Ÿä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºï¼Œå¦‚100ä¸‡æ¡</p>
<p>ä¼˜ç‚¹ï¼šå¯ä»¥å†™è¾ƒå¤§çš„æ•°æ®é‡ï¼Œå¦‚20ä¸‡æ¡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrite07BigData</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// åˆ›å»ºå·¥ä½œç°¿</span></span><br><span class="line">    Workbook workbook = <span class="keyword">new</span> XSSFWorkbook();</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€å¼ è¡¨</span></span><br><span class="line">    Sheet sheet = workbook.createSheet();</span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> rowNum = <span class="number">0</span>; rowNum &lt; <span class="number">65537</span>; rowNum++) &#123;</span><br><span class="line">        Row row = sheet.createRow(rowNum);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> cellNum = <span class="number">0</span>; cellNum &lt; <span class="number">10</span>; cellNum++) &#123;</span><br><span class="line">            Cell cell = row.createCell(cellNum);</span><br><span class="line">            cell.setCellValue(cellNum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/file/testWrite07BigData.xlsx&quot;</span>);</span><br><span class="line">    workbook.write(fileOutputStream);</span><br><span class="line">    fileOutputStream.close();</span><br><span class="line">    <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;è€—æ—¶ï¼š&quot;</span> + (end - start) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>å¤§æ–‡ä»¶å†™SXSSF</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼šå¯ä»¥å†™éå¸¸å¤§çš„æ•°æ®é‡ï¼Œå¦‚100ä¸‡æ¡ç”šè‡³æ›´å¤šæ¡ï¼Œå†™æ•°æ®é€Ÿåº¦å¿«ï¼Œå ç”¨æ›´å°‘çš„å†…å­˜</p>
<p>æ³¨æ„ï¼š</p>
<p>è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿä¸´æ—¶æ–‡ä»¶ï¼Œéœ€è¦æ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€‚</p>
<p>é»˜è®¤ç”±100æ¡è®°å½•è¢«ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœè¶…è¿‡è¿™æ•°é‡ï¼Œåˆ™æœ€å‰é¢çš„æ•°æ®è¢«å†™å…¥ä¸´æ—¶æ–‡ä»¶ã€‚</p>
<p>å¦‚æœæƒ³è‡ªå®šä¹‰å†…å­˜ä¸­æ•°æ®çš„æ•°é‡ï¼Œå¯ä»¥ä½¿ç”¨new SXSSFWorkBookã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrite07BigDataS</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// åˆ›å»ºå·¥ä½œç°¿</span></span><br><span class="line">    Workbook workbook = <span class="keyword">new</span> SXSSFWorkbook();</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€å¼ è¡¨</span></span><br><span class="line">    Sheet sheet = workbook.createSheet();</span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> rowNum = <span class="number">0</span>; rowNum &lt; <span class="number">10</span> * <span class="number">10000</span>; rowNum++) &#123;</span><br><span class="line">        Row row = sheet.createRow(rowNum);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> cellNum = <span class="number">0</span>; cellNum &lt; <span class="number">10</span>; cellNum++) &#123;</span><br><span class="line">            Cell cell = row.createCell(cellNum);</span><br><span class="line">            cell.setCellValue(cellNum);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/file/testWrite07BigDataS.xlsx&quot;</span>);</span><br><span class="line">    workbook.write(fileOutputStream);</span><br><span class="line">    <span class="comment">// åˆ é™¤ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">    ((SXSSFWorkbook) workbook).dispose();</span><br><span class="line">    fileOutputStream.close();</span><br><span class="line">    <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;è€—æ—¶ï¼š&quot;</span> + (end - start) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><blockquote>
<p>HSSFè¯»å–xls(2003ç‰ˆæœ¬)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRead03</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–æ–‡ä»¶æµ</span></span><br><span class="line">    FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/file/ç»Ÿè®¡è¡¨03.xls&quot;</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªå·¥ä½œç°¿</span></span><br><span class="line">    Workbook workbook = <span class="keyword">new</span> HSSFWorkbook(inputStream);</span><br><span class="line">    <span class="comment">// è·å–è¡¨</span></span><br><span class="line">    Sheet sheet = workbook.getSheetAt(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è·å–è¡Œ</span></span><br><span class="line">    Row row = sheet.getRow(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è·å–åˆ—</span></span><br><span class="line">    Cell cell = row.getCell(<span class="number">0</span>);</span><br><span class="line">    System.out.println(cell.getStringCellValue());</span><br><span class="line">    <span class="comment">// å…³é—­æµ</span></span><br><span class="line">    inputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>XSSFè¯»å–xlsx(2007ç‰ˆæœ¬)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRead07</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–æ–‡ä»¶æµ</span></span><br><span class="line">    FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/file/ç»Ÿè®¡è¡¨07.xlsx&quot;</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªå·¥ä½œç°¿</span></span><br><span class="line">    Workbook workbook = <span class="keyword">new</span> XSSFWorkbook(inputStream);</span><br><span class="line">    <span class="comment">// è·å–è¡¨</span></span><br><span class="line">    Sheet sheet = workbook.getSheetAt(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è·å–è¡Œ</span></span><br><span class="line">    Row row = sheet.getRow(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è·å–åˆ—</span></span><br><span class="line">    Cell cell = row.getCell(<span class="number">0</span>);</span><br><span class="line">    System.out.println(cell.getStringCellValue());</span><br><span class="line">    <span class="comment">// å…³é—­æµ</span></span><br><span class="line">    inputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æµ‹è¯•è¯»å–å®Œæ•´è¡¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadCell</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–æ–‡ä»¶æµ</span></span><br><span class="line">    FileInputStream inputStream = <span class="keyword">new</span> FileInputStream(System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/file/å­¦ç”ŸèŠ±åå†Œ.xlsx&quot;</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»ºå·¥ä½œç°¿</span></span><br><span class="line">    Workbook workbook = <span class="keyword">new</span> XSSFWorkbook(inputStream);</span><br><span class="line">    <span class="comment">// è·å–è¡¨</span></span><br><span class="line">    Sheet sheet = workbook.getSheetAt(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è·å–æ ‡é¢˜</span></span><br><span class="line">    Row rowTitle = sheet.getRow(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è¾“å‡ºæ ‡é¢˜</span></span><br><span class="line">    System.out.print(<span class="string">&quot;|  &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (rowTitle != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> cellCount = rowTitle.getPhysicalNumberOfCells();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> cellNum = <span class="number">0</span>; cellNum &lt; cellCount; cellNum++) &#123;</span><br><span class="line">            Cell cell = rowTitle.getCell(cellNum);</span><br><span class="line">            <span class="keyword">if</span> (cell != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String cellValue = cell.getStringCellValue();</span><br><span class="line">                System.out.print(cellValue + <span class="string">&quot;  |  &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println();</span><br><span class="line">    <span class="comment">// è·å–è¡Œæ•°</span></span><br><span class="line">    <span class="keyword">int</span> rowCount = sheet.getLastRowNum();</span><br><span class="line">    <span class="comment">// è·å–æ•°æ®</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> rowNum = <span class="number">1</span>; rowNum &lt; rowCount; rowNum++) &#123;</span><br><span class="line">        Row rowData = sheet.getRow(rowNum);</span><br><span class="line">        <span class="keyword">if</span> (rowData != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> cellCount = rowData.getPhysicalNumberOfCells();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> cellNum = <span class="number">0</span>; cellNum &lt; cellCount; cellNum++) &#123;</span><br><span class="line">                Cell cell = rowData.getCell(cellNum);</span><br><span class="line">                <span class="comment">// åŒ¹é…å•å…ƒæ ¼çš„æ•°æ®ç±»å‹</span></span><br><span class="line">                <span class="keyword">if</span> (cell != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    String cellValue = cell.getStringCellValue();</span><br><span class="line">                    System.out.print(cellValue + <span class="string">&quot;\t&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    inputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="EasyExcel-1"><a href="#EasyExcel-1" class="headerlink" title="EasyExcel"></a>EasyExcel</h2><h3 id="dependency-1"><a href="#dependency-1" class="headerlink" title="dependency"></a>dependency</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- test --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- easyexcel--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easyexcel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- fastjson --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.75<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- xls(2003) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- xlsx(2007) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="write-1"><a href="#write-1" class="headerlink" title="write"></a>write</h3><blockquote>
<p>å‡†å¤‡æ•°æ®</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoData</span> <span class="keyword">implements</span> <span class="title">Serializable</span>, <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(&quot;å­—ç¬¦ä¸²å­—æ®µ&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String stringData;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(&quot;æ—¥æœŸå­—æ®µ&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date dateData;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(&quot;æ•´æ•°å­—æ®µ&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer intData;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(&quot;æµ®ç‚¹å­—æ®µ&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Double douData;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.clone();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æµ‹è¯•å†™å…¥</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;DemoData&gt; <span class="title">data</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;DemoData&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    Random random = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">        DemoData demoData = <span class="keyword">new</span> DemoData();</span><br><span class="line">        demoData.setStringData(i + <span class="string">&quot;å·&quot;</span>);</span><br><span class="line">        demoData.setDateData(<span class="keyword">new</span> Date());</span><br><span class="line">        demoData.setIntData(random.nextInt(<span class="number">100</span>));</span><br><span class="line">        demoData.setDouData(random.nextDouble());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@org</span>.junit.Test</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String fileName = System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/file/simpleWrite.xlsx&quot;</span>;</span><br><span class="line">    EasyExcel.write(fileName, DemoData.class).sheet(<span class="string">&quot;è¡¨1&quot;</span>).doWrite(data());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="read-1"><a href="#read-1" class="headerlink" title="read"></a>read</h3><blockquote>
<p>æ•°æ®è§£æå™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoDataListener</span> <span class="keyword">extends</span> <span class="title">AnalysisEventListener</span>&lt;<span class="title">DemoData</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BATCH_COUNT = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;DemoData&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æ•°æ®è°ƒç”¨</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(DemoData demoData, AnalysisContext analysisContext)</span> </span>&#123;</span><br><span class="line">        System.out.println(demoData);</span><br><span class="line">        <span class="keyword">if</span> (list.size() == BATCH_COUNT) &#123;</span><br><span class="line">            list.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æå®Œæˆè°ƒç”¨</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterAllAnalysed</span><span class="params">(AnalysisContext analysisContext)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è§£æå®Œæˆ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æµ‹è¯•è¯»å–</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String fileName = System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/file/simpleWrite.xlsx&quot;</span>;</span><br><span class="line">    EasyExcel.read(fileName, DemoData.class, <span class="keyword">new</span> DemoDataListener()).sheet().doRead();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹äºå•çº¯çš„è¡¨æ ¼æ•°æ®æ“ä½œï¼ŒPOIçš„ä½¿ç”¨è¿˜æ˜¯æ¯”è¾ƒå¥½çš„ã€‚</p>
<p>EasyExcelçš„å°è£…æ€§æ¯”è¾ƒå¼ºï¼ŒOOPå’ŒAOPå¾ˆæœ‰é’ˆå¯¹æ€§ã€‚</p>
<p>EasyExcelåšä¸€äº›æ•°æ®åº“çš„æ‰¹é‡å¯¼å‡ºå¯¼å…¥è¿˜æ˜¯ä¸é”™çš„ã€‚</p>
<p>é‰´äºPOIæ“ä½œä¸Šçš„è‡ªç”±æ€§ï¼Œè‡ªå·±å°è£…äº†ä¸€ä¸ªå·¥å…·ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.poi.hssf.usermodel.HSSFFormulaEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.hssf.usermodel.HSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFFormulaEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.time.temporal.TemporalAccessor;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Excelå·¥å…·ç±»</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** office2003 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCEL_TYPE_XLS = <span class="string">&quot;xls&quot;</span>;</span><br><span class="line">    <span class="comment">/** office2007 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EXCEL_TYPE_XLSX = <span class="string">&quot;xlsx&quot;</span>;</span><br><span class="line">    <span class="comment">/** ç©ºå­—ç¬¦ä¸² */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String CHAR_TYPE_BLANK = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">/** é”™è¯¯å­—ç¬¦ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String CHAR_TYPE_ERROR = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    <span class="comment">/** æœªçŸ¥å­—ç¬¦ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String CHAR_TYPE_UNKNOWN = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    <span class="comment">/** åˆ—çš„é•¿åº¦å•ä½ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Integer COLUMN_CELL_WIDTH = <span class="number">1</span> &lt;&lt; <span class="number">10</span>;</span><br><span class="line">    <span class="comment">/** æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String DATE_FORMAT = <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>;</span><br><span class="line">    <span class="comment">/** æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼åŒ–å™¨ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern(DATE_FORMAT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»å–è¡¨æ ¼æ–‡ä»¶å¹¶è§£ææˆå­—ç¬¦ä¸²æ•°ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file è¡¨æ ¼æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®é›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;List&lt;Object&gt;&gt; readExcel(File file) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            checkFile(file);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Workbook workBook = getWorkBook(file);</span><br><span class="line">        <span class="keyword">return</span> readProcess(workBook);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ£€éªŒæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”ä¸ºè¡¨æ ¼æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException æœªæ‰¾åˆ°æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> FileNotFoundException éè¡¨æ ¼æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException åç¼€åé”™è¯¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkFile</span><span class="params">(File file)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;File is null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!file.exists())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">&quot;File &quot;</span> + file + <span class="string">&quot; does not exist&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String fileName = file.getName();</span><br><span class="line">        <span class="keyword">if</span>(!fileName.endsWith(EXCEL_TYPE_XLS) &amp;&amp; !fileName.endsWith(EXCEL_TYPE_XLSX))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(fileName + <span class="string">&quot; is not a kind of excel file&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æ–‡ä»¶å¯¹åº”çš„å·¥ä½œç°¿ï¼Œåˆ†ä¸ºXLSå’ŒXLSXç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file è¡¨æ ¼æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¡¨æ ¼æ–‡ä»¶çš„å·¥ä½œç°¿</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Workbook <span class="title">getWorkBook</span><span class="params">(File file)</span> </span>&#123;</span><br><span class="line">        String fileName = file.getName();</span><br><span class="line">        Workbook workbook = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream in = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            workbook = fileName.endsWith(EXCEL_TYPE_XLS) ? <span class="keyword">new</span> HSSFWorkbook(in) : <span class="keyword">new</span> XSSFWorkbook(in);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> workbook;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»å–å·¥ä½œç°¿ï¼Œä¸€è¡Œæ•°æ®è¯»ä½œä¸€ä¸ªæ•°ç»„ï¼Œæ‰€æœ‰è¡Œä½œä¸ºä¸€ä¸ªé›†åˆè¿”å›</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> workbook å·¥ä½œç°¿</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ•°æ®é›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;List&lt;Object&gt;&gt; readProcess(Workbook workbook) &#123;</span><br><span class="line">        List&lt;List&lt;Object&gt;&gt; res = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        FormulaEvaluator evaluator = (workbook <span class="keyword">instanceof</span> HSSFWorkbook) ?</span><br><span class="line">                <span class="keyword">new</span> HSSFFormulaEvaluator((HSSFWorkbook) workbook) : <span class="keyword">new</span> XSSFFormulaEvaluator((XSSFWorkbook) workbook);</span><br><span class="line">        <span class="keyword">if</span>(workbook != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> sheetNum = <span class="number">0</span>; sheetNum &lt; workbook.getNumberOfSheets(); sheetNum++) &#123;</span><br><span class="line">                Sheet sheet = workbook.getSheetAt(sheetNum);</span><br><span class="line">                <span class="keyword">if</span> (sheet == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">int</span> firstRowNum = sheet.getFirstRowNum();</span><br><span class="line">                <span class="keyword">int</span> lastRowNum = sheet.getLastRowNum();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> rowNum = firstRowNum; rowNum &lt;= lastRowNum; rowNum++) &#123;</span><br><span class="line">                    Row row = sheet.getRow(rowNum);</span><br><span class="line">                    <span class="keyword">if</span> (row == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">int</span> firstCellNum = row.getFirstCellNum();</span><br><span class="line">                    <span class="keyword">int</span> lastCellNum = row.getPhysicalNumberOfCells();</span><br><span class="line">                    List&lt;Object&gt; curr = <span class="keyword">new</span> ArrayList&lt;&gt;(lastCellNum - firstCellNum + <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> cellNum = firstCellNum; cellNum &lt; lastCellNum; cellNum++) &#123;</span><br><span class="line">                        Cell cell = row.getCell(cellNum);</span><br><span class="line">                        curr.add(getCellValue(cell, evaluator));</span><br><span class="line">                    &#125;</span><br><span class="line">                    res.add(curr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                workbook.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å•å…ƒæ ¼çš„å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cell å•å…ƒæ ¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evaluator å…¬å¼è®¡ç®—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å•å…ƒæ ¼çš„å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getCellValue</span><span class="params">(Cell cell, FormulaEvaluator evaluator)</span></span>&#123;</span><br><span class="line">        Object cellValue = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(cell == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> cellValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ•°æ®çš„ç±»å‹</span></span><br><span class="line">        <span class="keyword">switch</span> (cell.getCellType())&#123;</span><br><span class="line">            <span class="keyword">case</span> Cell.CELL_TYPE_NUMERIC: <span class="comment">// æ•°å­—ç±»å‹</span></span><br><span class="line">                cellValue = cell.getNumericCellValue(); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Cell.CELL_TYPE_STRING: <span class="comment">// å­—ç¬¦ä¸²ç±»å‹</span></span><br><span class="line">                cellValue = cell.getStringCellValue(); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Cell.CELL_TYPE_BOOLEAN: <span class="comment">// å¸ƒå°”ç±»å‹</span></span><br><span class="line">                cellValue = cell.getBooleanCellValue(); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Cell.CELL_TYPE_FORMULA: <span class="comment">// å…¬å¼</span></span><br><span class="line">                cellValue = evaluator.evaluate(cell); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Cell.CELL_TYPE_BLANK: <span class="comment">// ç©ºå€¼</span></span><br><span class="line">                cellValue = CHAR_TYPE_BLANK; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Cell.CELL_TYPE_ERROR: <span class="comment">// é”™è¯¯</span></span><br><span class="line">                cellValue = CHAR_TYPE_ERROR; <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: cellValue = CHAR_TYPE_UNKNOWN; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cellValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†æ ‡é¢˜å’Œå†…å®¹å†™å…¥æ–°æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file        æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sheetName   è¡¨æ ¼å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> titleList   æ ‡é¢˜åˆ—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> contentList å†…å®¹åˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeExcel</span><span class="params">(File file, String sheetName, List&lt;String&gt; titleList, List&lt;List&lt;Object&gt;&gt; contentList)</span> </span>&#123;</span><br><span class="line">        String fileName = checkParam(file, sheetName, titleList, contentList);</span><br><span class="line">        Workbook workbook = fileName.endsWith(EXCEL_TYPE_XLS) ? <span class="keyword">new</span> HSSFWorkbook() : <span class="keyword">new</span> XSSFWorkbook();</span><br><span class="line">        Sheet sheet = workbook.createSheet(sheetName);</span><br><span class="line">        initHead(workbook, sheet, titleList);</span><br><span class="line">        writeContent(workbook, sheet, contentList);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream out = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            workbook.write(out);</span><br><span class="line">            out.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ£€æŸ¥å‚æ•°æ˜¯å¦åˆæ³•ï¼Œå¹¶è¿”å›æ–‡ä»¶å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file        æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sheetName   è¡¨æ ¼å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> titleList   æ ‡é¢˜åˆ—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> contentList å†…å®¹åˆ—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ–‡ä»¶å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">checkParam</span><span class="params">(File file, String sheetName, List&lt;String&gt; titleList, List&lt;List&lt;Object&gt;&gt; contentList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (file == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;File is null&quot;</span>);</span><br><span class="line">        String fileName = file.getName();</span><br><span class="line">        <span class="keyword">if</span> (fileName.equals(<span class="string">&quot;&quot;</span>) || !(fileName.endsWith(EXCEL_TYPE_XLS) || fileName.endsWith(EXCEL_TYPE_XLSX)))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;File name is illegal&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sheetName == <span class="keyword">null</span> || sheetName.equals(<span class="string">&quot;&quot;</span>))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Sheet name is blank&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (titleList == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Title list is null&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (contentList == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Content list is null&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–æ ‡é¢˜è¡Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> book      å·¥ä½œç°¿</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sheet     å½“å‰è¡¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> titleList æ ‡é¢˜åˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initHead</span><span class="params">(Workbook book, Sheet sheet, List&lt;String&gt; titleList)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ ‡é¢˜æ ·å¼</span></span><br><span class="line">        CellStyle style = book.createCellStyle();</span><br><span class="line">        <span class="comment">// å±…ä¸­å¯¹é½</span></span><br><span class="line">        style.setAlignment(CellStyle.ALIGN_CENTER);</span><br><span class="line">        style.setVerticalAlignment(CellStyle.VERTICAL_CENTER);</span><br><span class="line">        <span class="comment">// èƒŒæ™¯å¡«å……</span></span><br><span class="line">        style.setFillForegroundColor(IndexedColors.GREY_50_PERCENT.getIndex());</span><br><span class="line">        style.setFillPattern(CellStyle.SOLID_FOREGROUND);</span><br><span class="line">        <span class="comment">// å­—ä½“æ ·å¼</span></span><br><span class="line">        Font font = book.createFont();</span><br><span class="line">        font.setFontName(<span class="string">&quot;åæ–‡æ¥·ä½“&quot;</span>);</span><br><span class="line">        font.setFontHeightInPoints((<span class="keyword">short</span>) <span class="number">13</span>);</span><br><span class="line">        font.setBoldweight(Font.BOLDWEIGHT_BOLD);</span><br><span class="line">        font.setColor(IndexedColors.WHITE.getIndex());</span><br><span class="line">        style.setFont(font);</span><br><span class="line">        <span class="comment">// åˆ›å»ºç¬¬ä¸€è¡Œ</span></span><br><span class="line">        Row head = sheet.createRow(<span class="number">0</span>);</span><br><span class="line">        head.setHeightInPoints(<span class="number">20</span>);</span><br><span class="line">        <span class="comment">// åˆ—çš„å®½åº¦</span></span><br><span class="line">        <span class="keyword">int</span> columnWidth = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; titleList.size(); i++) &#123;</span><br><span class="line">            Cell cell = head.createCell(i);</span><br><span class="line">            cell.setCellStyle(style);</span><br><span class="line">            String s = titleList.get(i);</span><br><span class="line">            cell.setCellValue(s);</span><br><span class="line">            columnWidth = s.length() * COLUMN_CELL_WIDTH;</span><br><span class="line">            sheet.setColumnWidth(i, columnWidth);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¡«å……å†…å®¹è¡Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> book        å·¥ä½œç°¿</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sheet       å½“å‰è¡¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> contentList å†…å®¹åˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeContent</span><span class="params">(Workbook book, Sheet sheet, List&lt;List&lt;Object&gt;&gt; contentList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; contentList.size(); i++) &#123;</span><br><span class="line">            Row curr = sheet.createRow(i + <span class="number">1</span>);</span><br><span class="line">            List&lt;Object&gt; content = contentList.get(i);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; content.size(); c++) &#123;</span><br><span class="line">                writeProcess(book, curr, c, content.get(c));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†å€¼å¡«å…¥å•å…ƒæ ¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> book å·¥ä½œç°¿</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> row å½“å‰è¡Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> col å½“å‰åˆ—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> val å•å…ƒå€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeProcess</span><span class="params">(Workbook book, Row row, <span class="keyword">int</span> col, Object val)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å†…å®¹æ ·å¼</span></span><br><span class="line">        CellStyle style = book.createCellStyle();</span><br><span class="line">        style.setVerticalAlignment(CellStyle.VERTICAL_CENTER);</span><br><span class="line">        style.setBorderRight(CellStyle.BORDER_THIN);</span><br><span class="line">        style.setRightBorderColor(IndexedColors.GREY_50_PERCENT.getIndex());</span><br><span class="line">        style.setBorderLeft(CellStyle.BORDER_THIN);</span><br><span class="line">        style.setLeftBorderColor(IndexedColors.GREY_50_PERCENT.getIndex());</span><br><span class="line">        style.setBorderTop(CellStyle.BORDER_THIN);</span><br><span class="line">        style.setTopBorderColor(IndexedColors.GREY_50_PERCENT.getIndex());</span><br><span class="line">        style.setBorderBottom(CellStyle.BORDER_THIN);</span><br><span class="line">        style.setBottomBorderColor(IndexedColors.GREY_50_PERCENT.getIndex());</span><br><span class="line">        <span class="comment">// å±…ä¸­å¯¹é½</span></span><br><span class="line">        style.setAlignment(CellStyle.ALIGN_CENTER);</span><br><span class="line">        <span class="comment">// å­—ä½“æ ·å¼</span></span><br><span class="line">        Font font = book.createFont();</span><br><span class="line">        font.setFontName(<span class="string">&quot;Arial&quot;</span>);</span><br><span class="line">        font.setFontHeightInPoints((<span class="keyword">short</span>) <span class="number">10</span>);</span><br><span class="line">        style.setFont(font);</span><br><span class="line">        Cell cell = row.createCell(col);</span><br><span class="line">        cell.setCellStyle(style);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (val == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cell.setCellValue(CHAR_TYPE_BLANK);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (val <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    cell.setCellValue((String) val);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val <span class="keyword">instanceof</span> Integer) &#123;</span><br><span class="line">                    cell.setCellValue((<span class="keyword">int</span>) val);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val <span class="keyword">instanceof</span> Long) &#123;</span><br><span class="line">                    cell.setCellValue((Long) val);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val <span class="keyword">instanceof</span> Double) &#123;</span><br><span class="line">                    cell.setCellValue((Double) val);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val <span class="keyword">instanceof</span> Float) &#123;</span><br><span class="line">                    cell.setCellValue((Float) val);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">                    cell.setCellValue((Boolean) val);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (val <span class="keyword">instanceof</span> TemporalAccessor) &#123;</span><br><span class="line">                    cell.setCellValue(DATE_TIME_FORMATTER.format((TemporalAccessor) val));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cell.setCellValue(val.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            cell.setCellValue(CHAR_TYPE_ERROR);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>poi</tag>
        <tag>easyexcel</tag>
      </tags>
  </entry>
  <entry>
    <title>HashMap</title>
    <url>/posts/48482/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ğŸ”åŸºäºJDK1.8çš„HashMapæºç åˆ†æã€‚</p>
<h2 id="1-åŸºæœ¬çŸ¥è¯†"><a href="#1-åŸºæœ¬çŸ¥è¯†" class="headerlink" title="1. åŸºæœ¬çŸ¥è¯†"></a>1. åŸºæœ¬çŸ¥è¯†</h2><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/48482/java8-HashMap.jpg" class="" title="java8-HashMap"><br />



<ul>
<li>HashMapå§‹äº<strong>JDK 1.5</strong>ï¼Œä½œè€…æ˜¯å¤§å¸ˆ<strong>Doug Lea</strong>ã€‚</li>
<li>HashMapæä¾›æ‰€æœ‰å¯é€‰çš„æ˜ å°„æ“ä½œï¼Œå¹¶å…è®¸ä½¿ç”¨nullé”®å’Œnullå€¼ã€‚</li>
<li>HashMapç”±æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ç»„æˆï¼Œé“¾è¡¨çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œçº¢é»‘æ ‘çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(logn)ã€‚</li>
<li>HashMapå¹¶éçº¿ç¨‹å®‰å…¨ï¼Œå½“å­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™å…¥HashMapæ—¶ï¼Œä¼šå¯¼è‡´æ•°æ®è¦†ç›–å’Œç¯ã€‚</li>
</ul>
<h2 id="2-åŸºæœ¬å±æ€§"><a href="#2-åŸºæœ¬å±æ€§" class="headerlink" title="2. åŸºæœ¬å±æ€§"></a>2. åŸºæœ¬å±æ€§</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** é»˜è®¤åˆå§‹åŒ–å®¹é‡ */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æœ€å¤§å®¹é‡ */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** é»˜è®¤è´Ÿè½½å› å­ */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æ ‘åŒ–é˜ˆå€¼ */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** é“¾åŒ–é˜ˆå€¼ */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æœ€å°çš„æ ‘åŒ–å®¹é‡ */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å“ˆå¸Œæ¡¶æ•°ç»„ï¼Œç¬¬ä¸€æ¬¡putæ—¶åˆå§‹åŒ–ï¼Œé•¿åº¦ä¸º2çš„æ¬¡å¹‚ */</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å­˜å‚¨é”®å€¼å¯¹é›†åˆ */</span></span><br><span class="line"><span class="keyword">transient</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** é”®å€¼å¯¹æ•°é‡ */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** ä¿®æ”¹æ¬¡æ•° */</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> modCount;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** æ ‘åŒ–é˜ˆå€¼ */</span></span><br><span class="line"><span class="keyword">int</span> threshold;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** è´Ÿè½½å› å­ */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</span><br></pre></td></tr></table></figure>



<h2 id="3-æ„é€ æ–¹æ³•"><a href="#3-æ„é€ æ–¹æ³•" class="headerlink" title="3. æ„é€ æ–¹æ³•"></a>3. æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¸¦åˆå§‹åŒ–å®¹é‡å’Œè´Ÿè½½å› å­çš„æ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal initial capacity: &quot;</span> +</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                           loadFactor);</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¸¦åˆå§‹åŒ–å®¹é‡çš„æ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ— å‚æ„é€ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œä»»ä½•çš„åˆå§‹åŒ–ï¼Œåªæ˜¯è¿›è¡Œäº†ä¸€äº›ç®€å•çš„èµ‹å€¼å¤„ç†ã€‚</p>
<h2 id="4-hashæ–¹æ³•"><a href="#4-hashæ–¹æ³•" class="headerlink" title="4. hashæ–¹æ³•"></a>4. hashæ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hashè®¡ç®—æ–¹æ³•ï¼šè°ƒç”¨<code>hashcode()</code>è¿›è¡Œä½è¿ç®—ï¼Œå°†<code>hashcode</code>å³ç§»16ä½å–å¾—<code>hashcode</code>çš„é«˜16ä½ï¼Œä¸åŸ<code>hashcode</code>çš„ä½16ä½è¿›è¡Œå¼‚æˆ–è¿ç®—ã€‚</p>
<p>indexè®¡ç®—æ–¹æ³•ï¼šå°†hashå€¼ä¸æ•°ç»„é•¿åº¦-1è¿›è¡Œä¸è¿ç®—å¾—åˆ°æ•°ç»„ä¸‹æ ‡ï¼Œè®¡ç®—å…¬å¼<code>index = hash &amp; (table.length - 1)</code>ã€‚</p>
<h2 id="5-tableSizeForæ–¹æ³•"><a href="#5-tableSizeForæ–¹æ³•" class="headerlink" title="5. tableSizeForæ–¹æ³•"></a>5. tableSizeForæ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>è¿”å›ä¸€ä¸ªå¤§äºç­‰äºç»™å®šç›®æ ‡å®¹é‡çš„æœ€å°2çš„å¹‚æ¬¡æ–¹ã€‚</strong></p>
<p>å¦‚æœn = 0ï¼Œåˆ™åˆå§‹åŒ–ç»“æœä¸º1ã€‚</p>
<p>ç¬¬ä¸€æ¬¡ï¼š<code>n |= n &gt;&gt;&gt; 1</code></p>
<p>å³ç§»1ä½ï¼š000001xxxxxx -&gt; 0000001xxxxx</p>
<p>æˆ–è¿ç®—ï¼šn = 0000011xxxxx</p>
<p>ç¬¬äºŒæ¬¡ï¼š<code>n |= n &gt;&gt;&gt; 2</code></p>
<p>å³ç§»2ä½ï¼š000011xxxxx -&gt; 000000011xxx</p>
<p>æˆ–è¿ç®—ï¼šn = 000001111xxx</p>
<p>å³ç§»1ä½åšæˆ–è¿ç®—åï¼Œæœ€é«˜ä½æœ‰2ä¸ª1ï¼›</p>
<p>å³ç§»2ä½åšæˆ–è¿ç®—åï¼Œæœ€é«˜ä½æœ‰4ä¸ª1ï¼›</p>
<p>å³ç§»4ä½åšæˆ–è¿ç®—åï¼Œæœ€é«˜ä½æœ‰8ä¸ª1ï¼›</p>
<p>å³ç§»8ä½åšæˆ–è¿ç®—åï¼Œæœ€é«˜ä½æœ‰16ä¸ª1ï¼›</p>
<p>å³ç§»16ä½åšæˆ–è¿ç®—åï¼Œæœ€é«˜ä½æœ‰32ä¸ª1ã€‚</p>
<p>intå 32bitï¼Œæœ€å¤šå°±32ä¸ª1ï¼Œè¿™æ—¶å€™å·²ç»å¤§äº<code>MAXIMUM_CAPACITY</code>(1 &lt;&lt; 30 = 2147483647 / 2)ï¼Œæ‰€ä»¥å–å€¼åˆ°äº†<code>MAXIMUM_CAPACITY</code>ã€‚</p>
<div class="note icon simple"><i class="note-icon fab fa-kaggle"></i><p>é‚£ä¹ˆä¸ºä»€ä¹ˆå¿…é¡»ä¸º2çš„æ•´æ•°æ¬¡å¹‚å‘¢ï¼Ÿ</p>
<p><strong>ä¸ºäº†æé«˜è®¡ç®—ä¸å­˜å‚¨æ•ˆç‡ï¼ŒåŒæ—¶å‡å°‘å“ˆå¸Œç¢°æ’çš„å‡ ç‡ã€‚</strong></p>
<p>ç¡®å®šæ•°ç»„ä¸‹æ ‡é‡‡ç”¨çš„ç®—æ³•æ˜¯ hash &amp; (n - 1)ï¼Œnä¸ºå“ˆå¸Œæ¡¶æ•°ç»„çš„å¤§å°ã€‚nä¸º2çš„æ•´æ•°æ¬¡å¹‚ï¼Œn - 1çš„äºŒè¿›åˆ¶å½¢å¼ä¸º000..11111ï¼Œè¿™ä¸ªäºŒè¿›åˆ¶å€¼ä¸ä»»ä½•å€¼è¿›è¡Œä¸è¿ç®—çš„ç»“æœéƒ½åœ¨æŒ‡å®šåŒºé—´[0, n-1]ã€‚</p>
<p>æ­£ä¾‹ï¼šn = 8ï¼Œn - 1 = 7ï¼ŒäºŒè¿›åˆ¶0111ï¼Œä»»ä½•ä¸0111è¿›è¡Œä¸è¿ç®—çš„ç»“æœéƒ½ä¼šæ˜ å°„åˆ°[0ï¼Œ7]ï¼Œå³è½å…¥ç»™å®šçš„8ä¸ªå“ˆå¸Œæ¡¶ä¸­ï¼Œå­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡100%ã€‚</p>
<p>åä¾‹ï¼šn = 7ï¼Œn - 1 = 6ï¼ŒäºŒè¿›åˆ¶0110ï¼Œä»»ä½•ä¸0110è¿›è¡Œä¸è¿ç®—çš„ç»“æœéƒ½ä¼šæ˜ å°„åˆ°{0, 2, 4, 6}å››ä¸ªæ¡¶ä¸­ï¼Œè€Œä¸æ˜¯[0, 6]åŒºé—´ï¼Œå­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡åªæœ‰ 4 / 7 * 100%ã€‚</p>
</div>



<h2 id="6-putæ–¹æ³•"><a href="#6-putæ–¹æ³•" class="headerlink" title="6. putæ–¹æ³•"></a>6. putæ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> hash  æ ¹æ®é”®è®¡ç®—çš„hash</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> onlyIfAbsent trueåªæ˜¯åœ¨å€¼ä¸ºç©ºçš„æ—¶å€™å­˜å‚¨æ•°æ®ï¼Œfalseéƒ½å­˜å‚¨æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> evict ä¸å…³å¿ƒ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è¿”å›è¢«è¦†ç›–çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰è¦†ç›–åˆ™è¿”å›null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡putå€¼çš„æ—¶å€™ä¼šè§¦å‘resize()</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°å…·ä½“çš„æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ­¤ä½ç½®æ²¡æœ‰å€¼ï¼Œé‚£ä¹ˆç›´æ¥åˆå§‹åŒ–ä¸€ä¸‹Nodeå¹¶æ”¾ç½®åœ¨è¿™ä¸ªä½ç½®å³å¯</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// å¦‚æœæ•°ç»„è¯¥ä½ç½®æœ‰å€¼</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="comment">// é¦–å…ˆï¼Œåˆ¤æ–­è¯¥ä½ç½®çš„ç¬¬ä¸€ä¸ªæ•°æ®å’Œè¦æ’å…¥çš„æ•°æ®ï¼Œkeyæ˜¯ä¸æ˜¯ç›¸ç­‰</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ï¼Œå–å‡ºè¿™ä¸ªç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥ç»“ç‚¹æ˜¯ä»£è¡¨çº¢é»‘æ ‘çš„ç»“ç‚¹ï¼Œè°ƒç”¨çº¢é»‘æ ‘çš„æ’å€¼æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥ç»“ç‚¹æ˜¯ä»£è¡¨é“¾è¡¨çš„ç»“ç‚¹ï¼Œåˆ™æ’å…¥åˆ°é“¾è¡¨çš„æœ€åé¢</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">// TREEIFY_THRESHOLD = 8ï¼Œ</span></span><br><span class="line">                    <span class="comment">// å¦‚æœæ–°æ’å…¥çš„å€¼æ˜¯é“¾è¡¨ä¸­çš„ç¬¬8ä¸ªä¼šè§¦å‘æ ‘åŒ–æ“ä½œ</span></span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å¦‚æœåœ¨è¯¥é“¾è¡¨ä¸­æ‰¾åˆ°äº†ç›¸ç­‰çš„key</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// ä½¿ç”¨æ–°ç»“ç‚¹è¦†ç›–æ—§ç»“ç‚¹</span></span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// e != null è¯´æ˜å­˜åœ¨æ—§å€¼çš„keyä¸è¦æ’å…¥çš„keyç›¸ç­‰</span></span><br><span class="line">        <span class="comment">// è¿›è¡Œå€¼è¦†ç›–ï¼Œç„¶åè¿”å›æ—§å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="comment">// å¦‚æœHashMapç”±äºæ–°æ’å…¥è¿™ä¸ªå€¼å¯¼è‡´sizeæŸ¥è¿‡é˜ˆå€¼ï¼Œåˆ™è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿‡ç¨‹æ€»ç»“ï¼š</p>
<p>ï¼ˆ1ï¼‰ç¬¬ä¸€æ¬¡putçš„æ—¶å€™ï¼Œä¼šè§¦å‘<code>resize</code>æ–¹æ³•ï¼Œç»å…¸æ‡’åŠ è½½ï¼Œæ•°ç»„åˆå§‹åŒ–ã€‚</p>
<p>ï¼ˆ2ï¼‰è®¡ç®—æ•°ç»„é•¿åº¦å’Œhashçš„ä¸è¿ç®—ç»“æœå¾—åˆ°keyåœ¨æ•°ç»„ä¸­çš„å…·ä½“ä¸‹æ ‡ï¼Œä»è€Œå¾—åˆ°æ•°ç»„è¯¥ä½ç½®çš„ç¬¬ä¸€èŠ‚ç‚¹ã€‚</p>
<p>ï¼ˆ3ï¼‰å¦‚æœç¬¬ä¸€èŠ‚ç‚¹ä¸ºç©ºï¼Œé‚£ä¹ˆç›´æ¥æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹å¹¶æ”¾åœ¨è¿™ä¸ªä½ç½®å³å¯ã€‚</p>
<p>ï¼ˆ4ï¼‰å¦‚æœç¬¬ä¸€èŠ‚ç‚¹éç©ºï¼Œ é‚£ä¹ˆåˆ¤æ–­ç¬¬ä¸€èŠ‚ç‚¹keyå’Œå½“å‰keyæ˜¯å¦ç›¸ç­‰ã€‚</p>
<p>ï¼ˆ5ï¼‰å¦‚æœç›¸ç­‰ï¼Œåˆ™å–å‡ºè¿™ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>ï¼ˆ6ï¼‰å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™åˆ¤æ–­è¿™ä¸ªèŠ‚ç‚¹çš„ç±»å‹æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹è¿˜æ˜¯é“¾è¡¨èŠ‚ç‚¹ã€‚</p>
<p>ï¼ˆ7ï¼‰å¦‚æœæ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œåˆ™è°ƒç”¨çº¢é»‘æ ‘çš„æ’å€¼æ–¹æ³•ã€‚</p>
<p>ï¼ˆ8ï¼‰å¦‚æœæ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼Œåˆ™éå†æ•´ä¸ªé“¾è¡¨ï¼Œå¦‚æœå­˜åœ¨ç›¸åŒkeyï¼Œåˆ™å–å‡ºè¿™ä¸ªèŠ‚ç‚¹å¹¶breakï¼Œå¦åˆ™ç›´æ¥æ’å…¥åˆ°é“¾è¡¨æœ€åé¢ï¼Œå¦‚æœé“¾è¡¨é•¿åº¦è¶…è¿‡æ ‘åŒ–é˜ˆå€¼8ï¼Œé‚£ä¹ˆè¿›è¡Œæ ‘åŒ–æ“ä½œã€‚</p>
<p>ï¼ˆ9ï¼‰åˆ¤æ–­å–å‡ºçš„èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œéç©ºåˆ™è¿›è¡Œå€¼è¦†ç›–ï¼Œç„¶åè¿”å›æ—§å€¼ã€‚</p>
<p>ï¼ˆ10ï¼‰å¦‚æœå› ä¸ºæ–°æ’å…¥å€¼å¯¼è‡´<code>size</code>è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è¿›è¡Œæ‰©å®¹ï¼Œå¹¶è¿”å›nullã€‚</p>
<h2 id="7-getæ–¹æ³•"><a href="#7-getæ–¹æ³•" class="headerlink" title="7. getæ–¹æ³•"></a>7. getæ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> hash  æ ¹æ®é”®è®¡ç®—çš„hash</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸æ˜¯å°±æŸ¥æ‰¾çš„</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦ä¸ºçº¢é»‘æ ‘èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="comment">// è°ƒç”¨çº¢é»‘æ ‘çš„è·å–å€¼çš„æ–¹æ³•</span></span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            <span class="comment">// èŠ‚ç‚¹ä¸ºé“¾è¡¨èŠ‚ç‚¹ï¼Œç›´æ¥éå†é“¾è¡¨</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿‡ç¨‹æ€»ç»“ï¼š</p>
<p>ï¼ˆ1ï¼‰è®¡ç®—keyçš„hashï¼Œæ ¹æ®hashå€¼æ‰¾åˆ°æ•°ç»„ä¸‹æ ‡ï¼šhash &amp; (length - 1)ã€‚</p>
<p>ï¼ˆ2ï¼‰åˆ¤æ–­è¯¥ä½ç½®çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å¦ä¸ºæ‰€æŸ¥æ‰¾çš„ï¼Œå¦‚æœæ˜¯ç›´æ¥è¿”å›ã€‚</p>
<p>ï¼ˆ3ï¼‰åˆ¤æ–­è¯¥å…ƒç´ ç±»å‹æ˜¯å¦ä¸ºçº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨çº¢é»‘æ ‘çš„æ–¹æ³•è·å–ç»“ç‚¹ã€‚</p>
<p>ï¼ˆ4ï¼‰åˆ°è¿™é‡Œè¯´æ˜å…ƒç´ æ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼Œç›´æ¥éå†é“¾è¡¨ï¼Œå¯»æ‰¾keyç›¸åŒçš„ç»“ç‚¹ã€‚</p>
<p>ï¼ˆ5ï¼‰æœ€åï¼Œè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°ï¼Œç›´æ¥è¿”å›nullã€‚</p>
<h2 id="8-è´Ÿè½½å› å­"><a href="#8-è´Ÿè½½å› å­" class="headerlink" title="8. è´Ÿè½½å› å­"></a>8. è´Ÿè½½å› å­</h2><p>è´Ÿè½½å› å­ = å¡«å…¥å“ˆå¸Œè¡¨ä¸­å…ƒç´ æ•°é‡ / å“ˆå¸Œæ¡¶çš„é•¿åº¦ï¼Œè´Ÿè½½å› å­å†³å®šHashMapçš„æ•°æ®å¯†åº¦ã€‚ </p>
<p>æ‰©å®¹é˜ˆå€¼ = å“ˆå¸Œè¡¨å½“å‰å®¹é‡ * è´Ÿè½½å› å­ï¼Œè´Ÿè½½å› å­å†³å®šHashMapçš„æ‰©å®¹é˜ˆå€¼ã€‚</p>
<ul>
<li>è´Ÿè½½å› å­è¿‡å¤§ï¼Œäº§ç”Ÿæ•°æ®ç¢°æ’çš„å‡ ç‡è¶Šé«˜ï¼Œæ•°ç»„ä¸­çš„é“¾è¡¨ä¹Ÿä¼šè¶Šé•¿ï¼Œä¼šé€ æˆæŸ¥è¯¢å’Œæ’å…¥çš„æ¯”è¾ƒå¢æ¬¡æ•°å¤šã€‚ã€é™ä½ç©ºé—´å¼€é”€ï¼Œæé«˜æŸ¥æ‰¾æˆæœ¬ã€‚ã€</li>
<li>è´Ÿè½½å› å­è¿‡å°ï¼Œè§¦å‘æ‰©å®¹çš„å‡ ç‡è¶Šé«˜ï¼Œäº§ç”Ÿæ•°æ®ç¢°æ’çš„å‡ ç‡è¶Šå°ï¼ŒæŸ¥è¯¢å’Œæ’å…¥çš„æ¯”è¾ƒæ¬¡æ•°å°‘ã€‚ã€é™ä½æ—¶é—´å¼€é”€ï¼Œæé«˜ç©ºé—´æˆæœ¬ã€‚ã€</li>
<li>å› æ­¤åœ¨è´Ÿè½½å› å­çš„é€‰æ‹©ä¸Šï¼Œè¦åšåˆ°æ—¶é—´å’Œç©ºé—´çš„æŠ˜ä¸­ã€‚</li>
</ul>
<p>ä¸¾ä¾‹ï¼š</p>
<p>å½“<code>loadFactor </code>= 1æ—¶ï¼Œhashæ•°ç»„ä¸­çš„16ä¸ªå€¼å…¨éƒ¨å¡«å……çš„æ—¶å€™æ‰ä¼šæ‰©å®¹ï¼Œé€ æˆé“¾è¡¨æˆ–è€…çº¢é»‘æ ‘çš„é•¿åº¦å˜å¤§ï¼Œhashç¢°æ’çš„æ¬¡æ•°å˜å¤šï¼›</p>
<p>å½“<code>loadFactor </code>= 0.5æ—¶ï¼Œhashæ•°ç»„ä¸­çš„å€¼å¡«å……ä¸€åŠå¼€å§‹æ‰©å®¹ï¼Œé€ æˆç©ºé—´åˆ©ç”¨ç‡é™ä½ã€‚</p>
<div class="note icon simple"><i class="note-icon fab fa-korvue"></i><p><strong>å…³äºè´Ÿè½½å› å­0.75çš„è¯æ˜</strong></p>
<p>é€šè¿‡é¢„æµ‹æ¡¶æ˜¯å¦ä¸ºç©ºï¼Œæ¡¶ç©ºä¸éç©ºçš„æ¦‚ç‡ä¸º<strong>0.5</strong>ã€‚</p>
<p>è®¾<strong>s</strong>è¡¨ç¤ºå“ˆå¸Œæ¡¶çš„é•¿åº¦ï¼Œ<strong>n</strong>è¡¨ç¤ºå·²æ·»åŠ çš„å…ƒç´ ä¸ªæ•°ï¼Œè´Ÿè½½å› å­<strong>loadFactor = n / s</strong>ï¼›</p>
<p>å¯¹äºæ¯ä¸ªå…ƒç´ ï¼Œæ¡¶éç©ºçš„æ¦‚ç‡ä¸º<strong>1/s</strong>ï¼Œæ¡¶ç©ºçš„æ¦‚ç‡ä¸º<strong>1 -  1/s</strong>ï¼›</p>
<p>æ ¹æ®äºŒé¡¹å¼å®šç†ï¼Œæ¡¶ç©ºçš„æ¦‚ç‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">P(0) &#x3D; C(n, 0) * [(1 &#x2F; s) ^ 0] * [(1 - 1 &#x2F; s) ^ (n - 0)] </span><br><span class="line">&#x3D;&gt; P(0) &#x3D; (1 - 1 &#x2F; s) ^ n</span><br></pre></td></tr></table></figure>

<p>ä»¤è¿™ä¸ªæ¦‚ç‡å€¼ç­‰äº <strong>1/2</strong>ï¼Œé‚£ä¹ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(1 - 1 &#x2F; s) ^ n &#x3D; 1 &#x2F; 2</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿›è¡Œæé™å˜æ¢æ±‚å€¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(1 - 1 &#x2F; s) ^ n</span><br><span class="line">&#x3D; [1 + 1&#x2F; (-s)] ^ [(-s) * (- n &#x2F; s)]</span><br><span class="line">&#x3D; 1 &#x2F; 2</span><br><span class="line">å½“s -&gt; +âˆæ—¶ï¼Œ[1 + 1 &#x2F; (-s)] ^ (-s) -&gt; e</span><br><span class="line">å³ e ^ (- n &#x2F; s) &#x3D; 1 &#x2F; 2</span><br><span class="line">ä¸¤è¾¹åŒæ—¶å–å¯¹æ•°ï¼Œn &#x2F; s &#x3D; ln 2</span><br></pre></td></tr></table></figure>

<p>ä»è€Œï¼Œ<strong>loadFactor = ln2 =  0.69314718056</strong>ã€‚</p>
<p>ä¸ªäººçŒœæµ‹ï¼Œè´Ÿè½½å› å­åœ¨[ln2, 0.75]è¿™ä¸ªåŒºé—´å†…éƒ½å¯ä»¥ä¿è¯è‰¯å¥½çš„æ€§èƒ½ã€‚</p>
</div>



<h2 id="9-æ ‘åŒ–é˜ˆå€¼"><a href="#9-æ ‘åŒ–é˜ˆå€¼" class="headerlink" title="9. æ ‘åŒ–é˜ˆå€¼"></a>9. æ ‘åŒ–é˜ˆå€¼</h2><p>åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œä½¿ç”¨éšæœºå“ˆå¸Œç ï¼ŒèŠ‚ç‚¹å‡ºç°çš„é¢‘ç‡åœ¨å“ˆå¸Œæ¡¶ä¸­éµå¾ªæ³Šæ¾åˆ†å¸ƒï¼ŒåŒæ—¶ç»™å‡ºäº†æ¡¶ä¸­å…ƒç´ ä¸ªæ•°ï¼ˆé“¾è¡¨é•¿åº¦ï¼‰å’Œå‘½ä¸­æ¦‚ç‡çš„å¯¹ç…§è¡¨ï¼š</p>
<ul>
<li>0:    0.60653066</li>
<li>1:    0.30326533</li>
<li>2:    0.07581633</li>
<li>3:    0.01263606</li>
<li>4:    0.00157952</li>
<li>5:    0.00015795</li>
<li>6:    0.00001316</li>
<li>7:    0.00000094</li>
<li>8:    0.00000006</li>
<li>more: å°äºåƒä¸‡åˆ†ä¹‹ä¸€</li>
</ul>
<p>ä»ä¸Šå¯ä»¥çœ‹å‡ºå½“æ¡¶ä¸­å…ƒç´ é•¿åº¦è¾¾åˆ°8çš„æ—¶å€™ï¼Œæ¯ä¸ªç¢°æ’ä½ç½®çš„é“¾è¡¨é•¿åº¦ä¸º8çš„æ¦‚ç‡ä¸ºä¸€åƒä¸‡åˆ†ä¹‹å…­ï¼Œè¶…è¿‡8çš„æ¦‚ç‡å°äºä¸€åƒä¸‡åˆ†ä¹‹ä¸€ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å“ˆå¸Œç åˆ†å¸ƒå‡åŒ€æ—¶ï¼ŒåŒä¸€ä¸ªä½ç½®ä¸Šå‡ºç°8ä¸ªå…ƒç´ çš„æ¦‚ç‡ä¸ºåƒä¸‡åˆ†ä¹‹å…­ï¼Œä¾§é¢è¯´æ˜å¦‚æœé“¾è¡¨é•¿åº¦è¾¾åˆ°äº†8ï¼Œkeyçš„<code>hashcode()</code>å‡ºç°äº†é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦çº¢é»‘æ ‘æ¥ä¿è¯æ€§èƒ½ã€‚</p>
<h2 id="10-æ‰©å®¹åŸç†"><a href="#10-æ‰©å®¹åŸç†" class="headerlink" title="10. æ‰©å®¹åŸç†"></a>10. æ‰©å®¹åŸç†</h2><h3 id="JDK1-7æ‰©å®¹"><a href="#JDK1-7æ‰©å®¹" class="headerlink" title="JDK1.7æ‰©å®¹"></a>JDK1.7æ‰©å®¹</h3><h4 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h4><p>æ‰©å®¹ï¼Œåˆ›å»ºæ–°çš„å“ˆå¸Œæ¡¶æ•°ç»„ï¼Œè¿›è¡Œæ•°æ®è¿ç§»ã€‚æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>&#123;</span><br><span class="line">    Entry[] oldTable = table;</span><br><span class="line">    <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        threshold = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°çš„table</span></span><br><span class="line">    Entry[] newTable = <span class="keyword">new</span> Entry[newCapacity];</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ–°çš„tableä¸­çš„å…ƒç´ æ˜¯å¦éœ€è¦é‡æ–°æ±‚hashå€¼ï¼Œæºç åœ¨ä¸‹é¢</span></span><br><span class="line">    transfer(newTable, initHashSeedAsNeeded(newCapacity));</span><br><span class="line">    table = newTable;<span class="comment">//æ•°ç»„æ‰©å®¹èµ‹å€¼ç»™table</span></span><br><span class="line">    <span class="comment">// è®¡ç®—æ–°çš„æ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">    threshold = (<span class="keyword">int</span>)Math.min(newCapacity * loadFactor, MAXIMUM_CAPACITY + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•°æ®è¿ç§»ï¼Œå°†æ—§å…ƒç´ é‡æ–°è®¡ç®—hashå€¼ç„¶åæ”¾å…¥åˆ°æ–°çš„tableé‡Œé¢ã€‚æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Entry[] newTable, <span class="keyword">boolean</span> rehash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> newCapacity = newTable.length;</span><br><span class="line">    <span class="comment">// éå†æ¡¶</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123;</span><br><span class="line">        <span class="comment">// é‡‡ç”¨å¤´æ’æ³•</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">null</span> != e) &#123;</span><br><span class="line">            <span class="comment">// è®°å½•å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            Entry&lt;K,V&gt; next = e.next; <span class="comment">// sign A</span></span><br><span class="line">            <span class="comment">// é‡æ–°è®¡ç®—å“ˆå¸Œ</span></span><br><span class="line">            <span class="keyword">if</span> (rehash) &#123;</span><br><span class="line">                e.hash = <span class="keyword">null</span> == e.key ? <span class="number">0</span> : hash(e.key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ–°çš„å“ˆå¸Œå€¼å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">            <span class="keyword">int</span> i = indexFor(e.hash, newCapacity);</span><br><span class="line">            <span class="comment">// æ’å…¥æ–°çš„èŠ‚ç‚¹</span></span><br><span class="line">            e.next = newTable[i];</span><br><span class="line">            newTable[i] = e;</span><br><span class="line">            <span class="comment">// è¿­ä»£</span></span><br><span class="line">            e = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼š</p>
<ol>
<li>åˆ›å»ºæ–°çš„æ•°ç»„newTableï¼›</li>
<li>éå†æ¡¶ï¼Œå°†tableä¸­çš„èŠ‚ç‚¹å…¨éƒ¨é‡æ–°è®¡ç®—hashå€¼ï¼Œé‡‡ç”¨å¤´æ’æ³•æ’å…¥åˆ°newTableä¸­ï¼›</li>
<li>å°†newTableèµ‹å€¼ç»™tableï¼›</li>
<li>é‡æ–°è®¡ç®—æ‰©å®¹é˜ˆå€¼ = æ–°çš„å®¹é‡ * è´Ÿè½½å› å­ã€‚</li>
</ol>
<h4 id="å¹¶å‘é—®é¢˜"><a href="#å¹¶å‘é—®é¢˜" class="headerlink" title="å¹¶å‘é—®é¢˜"></a>å¹¶å‘é—®é¢˜</h4><p><strong>åŸå§‹æƒ…å†µ</strong></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/48482/HashMap-java7-1.svg" class="" title="HashMap-java7-1"><br />



<p><strong>æ­»é“¾æƒ…å†µ</strong></p>
<p>ä¸¤ä¸ªçº¿ç¨‹ï¼šçº¿ç¨‹Aå’Œçº¿ç¨‹B</p>
<p>ï¼ˆ1ï¼‰å‡è®¾çº¿ç¨‹AæŒ‡å®šåˆ°sign Aï¼Œæƒ…å†µå¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/48482/HashMap-java7-a.svg" class="" title="HashMap-java7-a"><br />

<p>ï¼ˆ2ï¼‰æ­¤æ—¶ï¼Œç©¿æ’çº¿ç¨‹Bæ‰§è¡Œï¼Œæ‰§è¡Œå®Œäº†æ•´ä¸ªè¿ç§»è¿‡ç¨‹ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/48482/HashMap-java7-b1.svg" class="" title="HashMap-java7-b1"><br />

<p>ï¼ˆ3ï¼‰çº¿ç¨‹Aç»§ç»­æ‰§è¡Œï¼Œä½¿ç”¨å¤´æ’æ³•æ’å…¥5èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´5èŠ‚ç‚¹å’Œ6èŠ‚ç‚¹ç›¸äº’å¼•ç”¨å¯¼è‡´é“¾è¡¨æˆç¯ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/48482/HashMap-java7-a1.svg" class="" title="HashMap-java7-a1"><br />



<p><strong>æ•°æ®ä¸¢å¤±</strong></p>
<p>ä¸¤ä¸ªçº¿ç¨‹ï¼šçº¿ç¨‹Aå’Œçº¿ç¨‹B</p>
<p>ï¼ˆ1ï¼‰å‡è®¾çº¿ç¨‹AæŒ‡å®šåˆ°sign Aï¼Œæƒ…å†µå¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/48482/HashMap-java7-a.svg" class="" title="HashMap-java7-a"><br />

<p>ï¼ˆ2ï¼‰æ­¤æ—¶ï¼Œç©¿æ’çº¿ç¨‹Bï¼Œæ‰§è¡Œå®Œäº†æ•´ä¸ªè¿ç§»è¿‡ç¨‹ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/48482/HashMap-java7-b2.svg" class="" title="HashMap-java7-b2"><br />

<p>ï¼ˆ3ï¼‰çº¿ç¨‹Aç»§ç»­æ‰§è¡Œï¼Œä½¿ç”¨å¤´æ’æ³•æ’å…¥5èŠ‚ç‚¹ï¼Œç„¶åç»§ç»­æ’å…¥nextèŠ‚ç‚¹ï¼Œç”±äº6èŠ‚ç‚¹çš„nextä¸ºnullï¼Œä¼šå¯¼è‡´7èŠ‚ç‚¹ä¸¢å¤±ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/48482/HashMap-java7-a2.svg" class="" title="HashMap-java7-a2"><br />

<p>æœ€åæ‰©å®¹ç»“æŸï¼Œç”±äºçº¿ç¨‹Bå…ˆæ‰§è¡Œäº†<code>table = newTable</code>ï¼Œçº¿ç¨‹Aåæ‰§è¡Œï¼Œé‚£ä¹ˆAä¸¢å¤±çš„<code>newTable</code>æœ€ç»ˆæˆä¸ºçœŸæ­£çš„å“ˆå¸Œæ¡¶ï¼Œä¸¢å¤±æ•°æ®ã€‚</p>
<h3 id="JDK1-8æ‰©å®¹"><a href="#JDK1-8æ‰©å®¹" class="headerlink" title="JDK1.8æ‰©å®¹"></a>JDK1.8æ‰©å®¹</h3><h4 id="æºç åˆ†æ-1"><a href="#æºç åˆ†æ-1" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h4><p>æ‰©å®¹ï¼Œåˆ›å»ºæ–°æ•°ç»„ï¼Œæ•°æ®è¿ç§»é‡‡ç”¨å°¾æ’æ³•ã€‚æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="comment">// æ‰©å®¹å‰çš„æ•°ç»„é•¿åº¦å’Œæ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="comment">// æ‰©å®¹åçš„æ•°ç»„é•¿åº¦å’Œæ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è¶…è¿‡æœ€å¤§ï¼Œæ— èƒ½ä¸ºåŠ›</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é•¿åº¦å’Œé˜ˆå€¼éƒ½æ‰©å¤§ä¸¤å€</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°çš„å“ˆå¸Œæ¡¶æ•°ç»„</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// éå†åŸå§‹æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="comment">// å¦‚æœåŸå§‹æ•°ç»„ä¸‹æ ‡å¯¹åº”ä½ç½®æœ‰å…ƒç´ </span></span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// å½“å‰èŠ‚ç‚¹æ˜¯ä¸ªç‹¬ç‹¼</span></span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">// ç›´æ¥è®¡ç®—æ–°æ•°ç»„ä¸­çš„ä½ç½®</span></span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="comment">// å½“å‰èŠ‚ç‚¹ä¸ºçº¢é»‘æ ‘èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    <span class="comment">// å•ç‹¬å¤„ç†ï¼Œè¿›è¡ŒèŠ‚ç‚¹æ‹†åˆ†</span></span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="comment">// å½“å‰èŠ‚ç‚¹ä¸ºé“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                   <span class="comment">// æ ¹æ®hashå€¼å’ŒåŸå§‹æ•°ç»„é•¿åº¦é‡æ–°è®¡ç®—ç´¢å¼•å€¼</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="comment">// å¦‚æœç´¢å¼•å€¼ä¸º0ï¼Œé‚£ä¹ˆæ–°æ•°ç»„ä¸‹æ ‡ç­‰äºåŸæ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// å¦‚æœç´¢å¼•å€¼ä¸ä¸º0ï¼Œæ–°æ•°ç»„ä¸‹æ ‡ä¸ºåŸæ•°ç»„ä¸‹æ ‡+åŸæ•°ç»„é•¿åº¦</span></span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼š</p>
<ol>
<li>å…ˆåˆ¤æ–­å½“å‰tableæ˜¯å¦è¿›è¡Œè¿‡åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆå§‹åŒ–é»˜è®¤å€¼ï¼Œå·²ç»åˆå§‹åŒ–åˆ™æ‰©å®¹ä¸ºåŸæ¥çš„2å€ã€‚</li>
<li>æ‰©å®¹åå¯¹åŸå§‹tableè¿›è¡Œéå†ï¼Œå°†æ•°æ®è¿ç§»åˆ°æ–°çš„tableä¸­ï¼š<ol>
<li>å¦‚æœå½“å‰ä½ç½®èŠ‚ç‚¹æ˜¯ä¸ªç‹¬ç‹¼ï¼Œé‚£ä¹ˆç›´æ¥é‡æ–°è®¡ç®—æ•°ç»„ä¸‹æ ‡å¹¶æ”¾åœ¨æ–°çš„tableä¸­ï¼›</li>
<li>å¦‚æœå½“å‰ä½ç½®èŠ‚ç‚¹ä¸ºçº¢é»‘æ ‘èŠ‚ç‚¹ï¼Œé‚£ä¹ˆéœ€è¦å•ç‹¬å¤„ç†ï¼Œè¿›è¡Œé‡æ–°æ‹†åˆ†æ“ä½œï¼›</li>
<li>å¦‚æœå½“å‰èŠ‚ç‚¹èŠ‚ç‚¹ä¸ºé“¾è¡¨èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ ¹æ®å“ˆå¸Œå€¼å’ŒåŸæ•°ç»„é•¿åº¦é‡æ–°è®¡ç®—ç´¢å¼•å€¼ï¼Œç´¢å¼•å€¼ä¸º0åˆ™æ–°æ•°ç»„ä¸‹æ ‡ä¸åŸæ•°ç»„ä¸‹æ ‡ç›¸åŒï¼Œå¦åˆ™æ–°æ•°ç»„ä¸‹æ ‡ä¸ºåŸæ•°ç»„ä¸‹æ ‡+åŸæ•°ç»„é•¿åº¦ã€‚</li>
</ol>
</li>
</ol>
<h4 id="å¹¶å‘é—®é¢˜-1"><a href="#å¹¶å‘é—®é¢˜-1" class="headerlink" title="å¹¶å‘é—®é¢˜"></a>å¹¶å‘é—®é¢˜</h4><p>é‡‡ç”¨å°¾æ’æ³•å¯ä»¥é˜²æ­¢åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹é“¾è¡¨æˆç¯çš„äº§ç”Ÿï¼Œä½†æ˜¯ä¾ç„¶éçº¿ç¨‹å®‰å…¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">               <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// ... </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>putVal</code>çš„ç¬¬å…­è¡Œä»£ç ä¸­åˆ¤æ–­æ˜¯å¦å‡ºç°å“ˆå¸Œç¢°æ’ï¼Œå¦‚æœçº¿ç¨‹Aå’Œçº¿ç¨‹Béƒ½åœ¨è¿›è¡Œputæ“ä½œï¼Œå¹¶ä¸”hashå‡½æ•°è®¡ç®—å‡ºçš„æ’å…¥ä¸‹æ ‡æ˜¯ç›¸åŒçš„çš„ï¼Œå½“çº¿ç¨‹Aæ‰§è¡Œå®Œåè¢«æŒ‚èµ·ï¼Œè€Œçº¿ç¨‹Båœ¨è¯¥ä¸‹æ ‡å¤„æ’å…¥äº†å…ƒç´ ï¼Œå®Œæˆäº†æ­£å¸¸çš„æ’å…¥ï¼Œè¿™æ ·æ•°æ®å°±æ‚„æ— å£°æ¯çš„è¦†ç›–æ‰äº†ï¼Œä»è€Œçº¿ç¨‹ä¸å®‰å…¨ã€‚</p>
<div class="note icon simple"><i class="note-icon fab fa-kickstarter-k"></i><p>JDK1.8ä¸­ç”±å¤´æ’æ³•æ”¹ä¸ºå°¾æ’æ³•çš„å˜æ›´åŸå› ï¼š</p>
<ol>
<li>å¯ä»¥ä¿è¯èŠ‚ç‚¹çš„æœ‰åºæ€§ã€‚ï¼ˆæ ¹æ®ç¼“å­˜çš„æ—¶é—´å±€éƒ¨æ€§åŸåˆ™ï¼Œå¯ä»¥å‡å°‘æŸ¥æ‰¾æ¬¡æ•°ã€‚ï¼‰</li>
<li>é˜²æ­¢å¤šçº¿ç¨‹ä¸‹é“¾è¡¨æˆç¯ã€‚</li>
</ol>
<p>å¦å¤–ï¼ŒJDK1.8ä¸­ä¸éœ€è¦ä¸ºæ¯ä¸ªèŠ‚ç‚¹é‡æ–°è®¡ç®—å“ˆå¸Œï¼Œåªéœ€è¦æ ¹æ®åŸæ¥çš„å“ˆå¸Œå€¼å’ŒåŸæ•°ç»„é•¿åº¦è¿›è¡Œä¸è¿ç®—å¾—åˆ°æ–°çš„ç´¢å¼•å€¼ã€‚</p>
</div>

]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>æºç </tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-1(çº¿ç¨‹åŸºç¡€)</title>
    <url>/posts/9175/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-1-é¡¹ç›®å‡†å¤‡"><a href="#1-1-é¡¹ç›®å‡†å¤‡" class="headerlink" title="1.1 é¡¹ç›®å‡†å¤‡"></a>1.1 é¡¹ç›®å‡†å¤‡</h2><h3 id="1-1-1-ä½•è°“JUC"><a href="#1-1-1-ä½•è°“JUC" class="headerlink" title="1.1.1 ä½•è°“JUC"></a>1.1.1 ä½•è°“JUC</h3><p><code>java.util.concurrent</code></p>
<h3 id="1-1-2-Mavenå·¥ç¨‹"><a href="#1-1-2-Mavenå·¥ç¨‹" class="headerlink" title="1.1.2 Mavenå·¥ç¨‹"></a>1.1.2 Mavenå·¥ç¨‹</h3><p>pom.xmlï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.12<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logback.version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">logback.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jmh.version</span>&gt;</span>1.28<span class="tag">&lt;/<span class="name">jmh.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.13.1<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;logback.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.openjdk.jmh<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jmh-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jmh.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="1-1-3-æ—¥å¿—é…ç½®"><a href="#1-1-3-æ—¥å¿—é…ç½®" class="headerlink" title="1.1.3 æ—¥å¿—é…ç½®"></a>1.1.3 æ—¥å¿—é…ç½®</h3><p>logback.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- å®šä¹‰æ—¥å¿—æ–‡ä»¶çš„å­˜å‚¨åœ°å€ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_HOME&quot;</span> <span class="attr">value</span>=<span class="string">&quot;log/&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- æ§åˆ¶å°è¾“å‡º --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- æ ¼å¼åŒ–è¾“å‡ºï¼š%dè¡¨ç¤ºæ—¥æœŸï¼Œ%threadè¡¨ç¤ºçº¿ç¨‹åï¼Œ%-5levelï¼šçº§åˆ«ä»å·¦æ˜¾ç¤º5ä¸ªå­—ç¬¦å®½åº¦,%msgï¼šæ—¥å¿—æ¶ˆæ¯ï¼Œ%næ˜¯æ¢è¡Œç¬¦ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- æ–‡ä»¶æ—¥å¿—ï¼ŒæŒ‰ç…§æ¯å¤©ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- æ—¥å¿—æ–‡ä»¶è¾“å‡ºçš„æ–‡ä»¶å --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/juc.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- æ—¥å¿—æ–‡ä»¶ä¿ç•™å¤©æ•° --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">MaxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- æ ¼å¼åŒ–è¾“å‡ºï¼š%dè¡¨ç¤ºæ—¥æœŸï¼Œ%threadè¡¨ç¤ºçº¿ç¨‹åï¼Œ%-5levelï¼šçº§åˆ«ä»å·¦æ˜¾ç¤º5ä¸ªå­—ç¬¦å®½åº¦%msgï¼šæ—¥å¿—æ¶ˆæ¯ï¼Œ%næ˜¯æ¢è¡Œç¬¦ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- æ—¥å¿—æ–‡ä»¶æœ€å¤§çš„å¤§å° --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">MaxFileSize</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- æ—¥å¿—è¾“å‡ºçº§åˆ« --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="1-2-ç›¸å…³æ¦‚å¿µ"><a href="#1-2-ç›¸å…³æ¦‚å¿µ" class="headerlink" title="1.2 ç›¸å…³æ¦‚å¿µ"></a>1.2 ç›¸å…³æ¦‚å¿µ</h2><h3 id="1-2-1-çº¿ç¨‹ä¸è¿›ç¨‹"><a href="#1-2-1-çº¿ç¨‹ä¸è¿›ç¨‹" class="headerlink" title="1.2.1 çº¿ç¨‹ä¸è¿›ç¨‹"></a>1.2.1 çº¿ç¨‹ä¸è¿›ç¨‹</h3><p><strong>è¿›ç¨‹</strong></p>
<ul>
<li>ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½è‡³CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ã€ç®¡ç†å†…å­˜ã€ç®¡ç†IOçš„ã€‚</li>
<li>å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ã€‚</li>
<li>è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚IntelliJ IDEAï¼‰ï¼Œä¹Ÿæœ‰çš„ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚QQéŸ³ä¹ï¼‰ã€‚</li>
</ul>
<p><strong>çº¿ç¨‹</strong></p>
<ul>
<li>ä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†åˆ°å¤šä¸ªçº¿ç¨‹ã€‚</li>
<li>ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™CPUæ‰§è¡Œã€‚</li>
<li>Javaä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚åœ¨Windowsä¸­è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œä¸ºçº¿ç¨‹çš„å®¹å™¨ã€‚</li>
</ul>
<p><strong>åŒºåˆ«</strong></p>
<ul>
<li>çº¿ç¨‹æ˜¯ç¨‹åºæ‰§è¡Œçš„æœ€å°å•ä½ï¼Œè¿›ç¨‹æ˜¯OSåˆ†é…èµ„æºçš„æœ€å°å•ä½ã€‚</li>
<li>ä¸€ä¸ªè¿›ç¨‹ç”±ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç»„æˆï¼Œçº¿ç¨‹æ˜¯ä¸€ä¸ªè¿›ç¨‹ä¸­ä»£ç çš„ä¸åŒæ‰§è¡Œè·¯çº¿ã€‚</li>
<li>è¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œä½†åŒä¸€è¿›ç¨‹ä¸‹çš„å„ä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ç¨‹åºçš„å†…å­˜ç©ºé—´(åŒ…æ‹¬ä»£ç æ®µã€æ•°æ®é›†å’Œå †ç­‰)åŠä¸€äº›è¿›ç¨‹çº§çš„èµ„æºï¼Œä¸€ä¸ªè¿›ç¨‹å†…çš„çº¿ç¨‹åœ¨å…¶ä»–è¿›ç¨‹ä¸å¯è§ã€‚</li>
<li>è°ƒåº¦å’Œåˆ‡æ¢ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è¦å¿«å¾—å¤šã€‚</li>
</ul>
<p><strong>è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼</strong></p>
<p>ï¼ˆ1ï¼‰ç®¡é“ï¼šåˆ†ä¸ºæ— åç®¡é“å’Œæœ‰åç®¡é“ï¼Œéƒ½æ˜¯åŠåŒå·¥çš„é€šä¿¡æ–¹å¼</p>
<p>æ— åç®¡é“ï¼šæ•°æ®åªèƒ½å•å‘æµåŠ¨ï¼Œè€Œä¸”åªèƒ½åœ¨å…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ä½¿ç”¨ã€‚</p>
<p>æœ‰åç®¡é“ï¼šå…è®¸æ— äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡ã€‚ï¼ˆäº²ç¼˜å…³ç³»ä¸€èˆ¬æŒ‡çˆ¶å­è¿›ç¨‹ï¼‰</p>
<p>ï¼ˆ2ï¼‰ä¿¡å·é‡</p>
<p>ä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚ä¿¡å·é‡å¸¸ä½œä¸ºä¸€ç§é”æœºåˆ¶ï¼Œç”¨äºå®ç°è¿›ç¨‹é—´çš„äº’æ–¥ä¸åŒæ­¥ï¼ˆæˆ–è€…åŒä¸€ä¸ªè¿›ç¨‹é—´çš„ä¸åŒè¿›ç¨‹é—´çš„åŒæ­¥ï¼‰ï¼Œè€Œä¸æ˜¯ç”¨äºå­˜å‚¨è¿›ç¨‹é—´é€šä¿¡æ•°æ®ã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ä¿¡å·é‡ç”¨äºè¿›ç¨‹é—´åŒæ­¥ï¼Œè‹¥è¦åœ¨è¿›ç¨‹é—´ä¼ é€’æ•°æ®éœ€è¦ç»“åˆå…±äº«å†…å­˜ã€‚</li>
<li>ä¿¡å·é‡åŸºäºæ“ä½œç³»ç»Ÿçš„PVæ“ä½œï¼Œç¨‹åºå¯¹ä¿¡å·é‡çš„æ“ä½œéƒ½æ˜¯åŸå­æ“ä½œã€‚</li>
<li>æ¯æ¬¡å¯¹ä¿¡å·é‡çš„PVæ“ä½œä¸ä»…é™äºå¯¹ä¿¡å·é‡å€¼åŠ 1æˆ–å‡1ï¼Œè€Œä¸”å¯ä»¥åŠ å‡ä»»æ„æ­£æ•´æ•°ã€‚</li>
<li>æ”¯æŒä¿¡å·é‡ç»„ã€‚</li>
</ul>
<p>ï¼ˆ3ï¼‰æ¶ˆæ¯é˜Ÿåˆ—</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ¶ˆæ¯çš„é“¾è¡¨ï¼Œå­˜æ”¾åœ¨å†…æ ¸ä¸­ã€‚ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç”±ä¸€ä¸ªé˜Ÿåˆ—æ ‡è¯†ç¬¦ï¼ˆé˜Ÿåˆ—IDï¼‰æ¥æ ‡è¯†ã€‚æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†ä¿¡å·ä¼ é€’ä¿¡æ¯å°‘ã€ç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç¼ºç‚¹ã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯é¢å‘è®°å½•çš„ï¼Œå…¶ä¸­çš„æ¶ˆæ¯å…·æœ‰ç‰¹å®šçš„æ ¼å¼å’Œç‰¹å®šçš„ä¼˜å…ˆçº§ã€‚</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—ç‹¬ç«‹äºå‘é€å’Œæ¥æ”¶è¿›ç¨‹ã€‚è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—åŠå…¶å†…å®¹å¹¶ä¸ä¼šè¢«åˆ é™¤ã€‚</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å®ç°æ¶ˆæ¯çš„éšæœºæŸ¥è¯¢ï¼Œæ¶ˆæ¯ä¸ä¸€å®šè¦ä»¥å…ˆè¿›å…ˆå‡ºçš„æ¬¡åºè¯»å–ï¼Œä¹Ÿå¯ä»¥æŒ‰æ¶ˆæ¯çš„ç±»å‹è¯»å–ã€‚</li>
</ul>
<p>ï¼ˆ4ï¼‰å…±äº«å†…å­˜</p>
<p>å…±äº«å†…å­˜ï¼ŒæŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹å…±äº«ä¸€ä¸ªç»™å®šçš„å­˜å‚¨åŒºã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å…±äº«å†…å­˜æ˜¯æœ€å¿«çš„ä¸€ç§IPCï¼Œå› ä¸ºè¿›ç¨‹æ˜¯ç›´æ¥å¯¹å†…å­˜è¿›è¡Œå­˜å–ã€‚</li>
<li>å› ä¸ºå¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶æ“ä½œï¼Œæ‰€ä»¥éœ€è¦è¿›è¡ŒåŒæ­¥ã€‚</li>
<li>ä¿¡å·é‡+å…±äº«å†…å­˜é€šå¸¸ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ï¼Œä¿¡å·é‡ç”¨æ¥åŒæ­¥å¯¹å…±äº«å†…å­˜çš„è®¿é—®ã€‚</li>
</ul>
<p>ï¼ˆ5ï¼‰ä¿¡å·</p>
<p>ä¿¡å·æ˜¯ä¸€ç§æ¯”è¾ƒå¤æ‚çš„é€šä¿¡æ–¹å¼ï¼Œç”¨äºé€šçŸ¥æ¥æ”¶è¿›ç¨‹æŸä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿã€‚</p>
<p>ï¼ˆ6ï¼‰å¥—æ¥å­—</p>
<p>å¥—æ¥å­—ä¹Ÿæ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œå¯ç”¨äºä¸åŒä¸»æœºé—´çš„è¿›ç¨‹é€šä¿¡ã€‚</p>
<h3 id="1-2-2-å¹¶å‘ä¸å¹¶è¡Œ"><a href="#1-2-2-å¹¶å‘ä¸å¹¶è¡Œ" class="headerlink" title="1.2.2 å¹¶å‘ä¸å¹¶è¡Œ"></a>1.2.2 å¹¶å‘ä¸å¹¶è¡Œ</h3><p><strong>å¹¶å‘</strong></p>
<p>å•æ ¸CPUä¸‹ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚æ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨å°†CPUçš„æ—¶é—´ç‰‡ï¼ˆWindowsä¸‹æ—¶é—´æœ€å°çº¦15msï¼‰åˆ†ç»™ä¸åŒçš„çº¿ç¨‹ä½¿ç”¨ï¼Œåªæ˜¯ç”±äºCPUåœ¨çº¿ç¨‹é—´ï¼ˆæ—¶é—´ç‰‡å¾ˆçŸ­ï¼‰çš„åˆ‡æ¢éå¸¸å¿«ï¼Œäººç±»æ„Ÿè§‰æ˜¯åŒæ—¶è¿è¡Œçš„ã€‚å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œã€‚</p>
<p>ä¸€èˆ¬ä¼šå°†è¿™ç§çº¿ç¨‹è½®æµä½¿ç”¨CPUçš„åšæ³•å«åšå¹¶å‘ï¼Œconcurrentã€‚</p>
<p><strong>å¹¶è¡Œ</strong></p>
<p>å¤šæ ¸CPUä¸‹ï¼Œæ¯ä¸ªæ ¸éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹å¯ä»¥æ˜¯å¹¶è¡Œçš„ï¼Œparallelã€‚</p>
<p><strong>åŒºåˆ«</strong></p>
<p>å¹¶å‘ï¼šå¤šçº¿ç¨‹æ“ä½œä¸€ä¸ªèµ„æºï¼ˆä¸ä¸€å®šåŒæ—¶ï¼‰ï¼ŒCPUä¸€æ ¸äº¤æ›¿è¿è¡Œå¤šæ¡çº¿ç¨‹</p>
<p>å¹¶è¡Œï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼ˆåŒæ—¶ï¼‰ï¼ŒCPUå¤šæ ¸åŒæ—¶æ‰§è¡Œå¤šæ¡çº¿ç¨‹</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/9175/BFBX.jpg" class="" title="BFBX">



<blockquote>
<p>TIPï¼šæŸ¥çœ‹CPUæ ¸æ•°ï¼š<code>Runtime.getRuntime().availableProcessors()</code></p>
</blockquote>
<h3 id="1-2-3-åº”ç”¨"><a href="#1-2-3-åº”ç”¨" class="headerlink" title="1.2.3 åº”ç”¨"></a>1.2.3 åº”ç”¨</h3><p><strong>å¼‚æ­¥è°ƒç”¨</strong></p>
<p>ä»æ–¹æ³•è°ƒç”¨çš„è§’åº¦æ¥è®²ï¼Œå¦‚æœï¼š</p>
<ul>
<li>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥</li>
<li>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</li>
</ul>
<p>æ³¨æ„ï¼šåŒæ­¥åœ¨å¤šçº¿ç¨‹ä¸­è¿˜æœ‰ä¸€å±‚æ„æ€ï¼Œæ˜¯è®©å¤šä¸ªçº¿ç¨‹æ­¥è°ƒä¸€è‡´ã€‚</p>
<p><strong>è®¾è®¡</strong></p>
<p>å¤šçº¿ç¨‹å¯ä»¥è®©æ–¹æ³• æ‰§è¡Œå˜ä¸ºå¼‚æ­¥çš„ã€‚</p>
<ul>
<li>æ¯”å¦‚åœ¨é¡¹ç›®ä¸­ï¼Œè§†é¢‘æ–‡ä»¶éœ€è¦è½¬æ¢æ ¼å¼ç­‰æ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œè¿™æ—¶å¼€ä¸€ä¸ªçº¿ç¨‹å¤„ç†è§†é¢‘è½¬æ¢ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚</li>
<li>tomcatçš„å¼‚æ­¥servletyä¹Ÿæ˜¯ç±»ä¼¼çš„ç›®çš„ï¼Œè®©ç”¨æˆ·çº¿ç¨‹å¤„ç†è€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œé¿å…é˜»å¡tomcatçš„å·¥ä½œçº¿ç¨‹ã€‚</li>
<li>UIç¨‹åºä¸­ï¼Œå¼€çº¿ç¨‹è¿›è¡Œå…¶ä»–æ“ä½œï¼Œé¿å…é˜»å¡UIçº¿ç¨‹ã€‚</li>
</ul>
<h2 id="1-3-Javaçº¿ç¨‹"><a href="#1-3-Javaçº¿ç¨‹" class="headerlink" title="1.3 Javaçº¿ç¨‹"></a>1.3 Javaçº¿ç¨‹</h2><h3 id="1-3-1-åˆ›å»ºçº¿ç¨‹"><a href="#1-3-1-åˆ›å»ºçº¿ç¨‹" class="headerlink" title="1.3.1 åˆ›å»ºçº¿ç¨‹"></a>1.3.1 åˆ›å»ºçº¿ç¨‹</h3><p>ï¼ˆ1ï¼‰æ–¹å¼ä¸€ï¼šç»§æ‰¿<code>Thread</code>ï¼Œé‡å†™<code>run()</code>æ–¹æ³•ã€‚</p>
<p>ä¼˜ç‚¹ï¼šåœ¨<code>run()</code>æ–¹æ³•å†…è·å–å½“å‰çº¿ç¨‹ç›´æ¥ä½¿ç”¨<code>this</code>å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;I am a child thread.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MyThread thread = <span class="keyword">new</span> MyThread();</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ï¼ˆ2ï¼‰æ–¹å¼äºŒï¼šå®ç°<code>Runnable</code>ï¼Œå®ç°<code>run()</code>æ–¹æ³•ã€‚</p>
<p>ä¼˜ç‚¹ï¼šä»»åŠ¡ä¸é€»è¾‘åˆ†ç¦»ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnableTaskTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I am a child thread.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RunnableTaskTest task = <span class="keyword">new</span> RunnableTaskTest();</span><br><span class="line">        <span class="keyword">new</span> Thread(task).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(task).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ï¼ˆ3ï¼‰æ–¹å¼ä¸‰ï¼šå®ç°<code>Callable</code>æ¥å£ï¼Œå®ç°<code>call</code>æ–¹æ³•ï¼Œé€šè¿‡<code>FutureTask</code>åˆ›å»ºçº¿ç¨‹ã€‚</p>
<p>ä¼˜ç‚¹ï¼šä»»åŠ¡å¯ä»¥æºå¸¦è¿”å›å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallerTaskTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CallerTask</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String  <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;KHighness&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">        FutureTask&lt;String&gt; futureTask = <span class="keyword">new</span> FutureTask&lt;&gt;(<span class="keyword">new</span> CallerTask());</span><br><span class="line">        <span class="keyword">new</span> Thread(futureTask).start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String result = futureTask.get();</span><br><span class="line">            System.out.println(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-2-æŸ¥çœ‹çº¿ç¨‹"><a href="#1-3-2-æŸ¥çœ‹çº¿ç¨‹" class="headerlink" title="1.3.2 æŸ¥çœ‹çº¿ç¨‹"></a>1.3.2 æŸ¥çœ‹çº¿ç¨‹</h3><p>Windowsç³»ç»Ÿï¼š</p>
<ul>
<li><code>taskmgr</code>ï¼šæ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨</li>
<li><code>tasklist | findstr &lt;pid&gt;/&lt;pname&gt;  </code>ï¼šæ ¹æ®è¿›ç¨‹idæˆ–è€…åç§°æŸ¥æ‰¾è¿›ç¨‹</li>
<li><code>taskkill /pid &lt;pid&gt;  </code> ï¼šæ ¹æ®è¿›ç¨‹idç»ˆæ­¢è¿›ç¨‹</li>
<li><code>taskkill /im &lt;pname&gt;</code>ï¼šæ ¼å±€è¿›ç¨‹åç§°ç»ˆæ­¢è¿›ç¨‹</li>
<li><code>/t</code>ï¼šç»ˆæ­¢æŒ‡å®šçš„è¿›ç¨‹å’Œç”±å®ƒå¯ç”¨çš„å­è¿›ç¨‹</li>
<li><code>/f</code>ï¼šæŒ‡å®šå¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹</li>
</ul>
<p>Linuxç³»ç»Ÿï¼š</p>
<ul>
<li><code>ps -ef</code>ï¼šæŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹</li>
<li><code>ps -fT -p &lt;pid&gt;</code>ï¼šæŸ¥çœ‹æŸä¸ªè¿›ç¨‹(ID)çš„æ‰€æœ‰çº¿ç¨‹</li>
<li><code>kill</code>ï¼šç»ˆæ­¢è¿›ç¨‹</li>
<li><code>top -H -p &lt;pid&gt;</code>ï¼šæŸ¥çœ‹æŸä¸ªè¿›ç¨‹(ID)çš„æ‰€æœ‰çº¿ç¨‹</li>
</ul>
<p>jvmï¼š</p>
<ul>
<li><code>jps</code>ï¼šæŸ¥çœ‹æ‰€æœ‰javaè¿›ç¨‹</li>
<li><code>jstack &lt;pid&gt;</code>ï¼šæŸ¥çœ‹æŸä¸ªJavaè¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€</li>
</ul>
<blockquote>
<p><strong>jconsoleè¿œç¨‹ç›‘æ§</strong></p>
<p>éœ€è¦å¦‚ä¸‹æ–¹å¼è¿è¡Œç±»ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -Djava.rmi.server.hostname=&lt;ip&gt; -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=&lt;port&gt; -Dcom.sun.management.jmxremote.ssl=&lt;true/false&gt; -Dcom.sun.management.jmxremote.authenticate=&lt;true/false&gt; &lt;class&gt;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè®¤è¯è®¿é—®åˆ™éœ€è¦ï¼š</p>
<ul>
<li>å¤åˆ¶jmxremote.passwordæ–‡ä»¶</li>
<li>ä¿®æ”¹jmxremote.passwordå’Œjmxremote.accessæ–‡ä»¶çš„æƒé™ä¸º600</li>
<li>è¿æ¥æ—¶å€™å¡«å…¥c</li>
</ul>
</blockquote>
<h3 id="1-3-3-è¿è¡ŒåŸç†"><a href="#1-3-3-è¿è¡ŒåŸç†" class="headerlink" title="1.3.3 è¿è¡ŒåŸç†"></a>1.3.3 è¿è¡ŒåŸç†</h3><p><strong>æ ˆä¸æ ˆå¸§</strong></p>
<p>Java Virtual Machine Stacksï¼ˆJavaè™šæ‹Ÿæœºæ ˆï¼‰</p>
<ul>
<li>æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å çš„å†…å­˜</li>
<li>æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•</li>
</ul>
<p><strong>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p>
<p>å› ä¸ºä»¥ä¸‹åŸå› å¯¼è‡´CPUä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç ï¼š</p>
<ul>
<li>çº¿ç¨‹çš„CPUæ—¶é—´ç‰‡ç”¨å®Œ</li>
<li>åƒåœ¾å›æ”¶</li>
<li>æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ</li>
<li>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº†sleepã€yieldã€waitã€joinã€parkã€sychronizedã€lockç­‰æ–¹æ³•</li>
</ul>
<p>å½“Thread Context Switchå‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJavaä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡JVMæŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</p>
<ul>
<li>çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰</li>
<li>Thread Context Switché¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½</li>
</ul>
<h3 id="1-3-4-å¸¸è§æ–¹æ³•"><a href="#1-3-4-å¸¸è§æ–¹æ³•" class="headerlink" title="1.3.4 å¸¸è§æ–¹æ³•"></a>1.3.4 å¸¸è§æ–¹æ³•</h3><table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>åŠŸèƒ½</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>start()</code></td>
<td>å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåœ¨æ–°çš„çº¿ç¨‹è¿è¡Œrunæ–¹æ³•ä¸­çš„ä»£ç </td>
<td>startæ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥å°±ç»ªï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç†ç§‘è¿è¡Œï¼ˆCPUçš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„startæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç°<code>IllegalThreadStateException</code>ã€‚</td>
</tr>
<tr>
<td><code>run()</code></td>
<td>æ–°çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨çš„æ–¹æ³•</td>
<td>å¦‚æœåœ¨æ„é€ <code>Thread</code>å¯¹è±¡æ—¶ä¼ é€’äº†<code>Runnable</code>å‚æ•°ï¼Œåˆ™çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨<code>Runnable</code>ä¸­çš„runæ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º<code>Thread</code>çš„å­ç±»å¯¹è±¡ï¼Œæ¥è¦†ç›–é»˜è®¤è¡Œä¸ºã€‚</td>
</tr>
<tr>
<td><code>join()</code></td>
<td>ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸ</td>
<td></td>
</tr>
<tr>
<td><code>join(long n)</code></td>
<td>ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸï¼Œæœ€å¤šç­‰å¾…næ¯«ç§’</td>
<td></td>
</tr>
<tr>
<td><code>getId()</code></td>
<td>è·å–çº¿ç¨‹é•¿æ•´å‹çš„id</td>
<td>idå”¯ä¸€</td>
</tr>
<tr>
<td><code>getName()</code></td>
<td>è·å–çº¿ç¨‹å</td>
<td></td>
</tr>
<tr>
<td><code>setName(String)</code></td>
<td>ä¿®æ”¹çº¿ç¨‹å</td>
<td></td>
</tr>
<tr>
<td><code>getPriority()</code></td>
<td>è·å–çº¿ç¨‹ä¼˜å…ˆçº§</td>
<td></td>
</tr>
<tr>
<td><code>setPriority(int)</code></td>
<td>ä¿®æ”¹çº¿ç¨‹ä¼˜å…ˆçº§</td>
<td>Javaä¸­è§„å®šçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯1~10çš„æ•´æ•°ï¼Œè¾ƒå¤§çš„ä¼˜å…ˆçº§èƒ½æé«˜è¯¥çº¿ç¨‹è¢«CPUè°ƒåº¦çš„å‡ ç‡</td>
</tr>
<tr>
<td><code>getState()</code></td>
<td>è·å–çº¿ç¨‹çŠ¶æ€</td>
<td>Javaä¸­çº¿ç¨‹çŠ¶æ€æ˜¯ç”¨6ä¸ª<code>enum</code>è¡¨ç¤ºï¼Œåˆ†åˆ«ä¸ºï¼š<code>NEW</code>ã€<code>RUNNABLE</code>ã€<code>BLOCKED</code>ã€<code>WAITING</code>ã€<code>TIMED_WAITING</code>ã€<code>TERMINATED</code>ã€‚</td>
</tr>
<tr>
<td><code>isInterrupted()</code></td>
<td>åˆ¤æ–­æ˜¯å¦ç»™æ‰“æ–­</td>
<td>ä¸ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°ã€‚çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ä¸å—æ­¤æ–¹æ³•çš„å½±å“ã€‚</td>
</tr>
<tr>
<td><code>isAlive()</code></td>
<td>çº¿ç¨‹æ˜¯å¦å­˜æ´»</td>
<td></td>
</tr>
<tr>
<td><code>interrupt()</code></td>
<td>æ‰“æ–­çº¿ç¨‹</td>
<td>å¦‚æœè¢«æ‰“æ–­çº¿ç¨‹æ­£åœ¨sleepã€waitã€joinä¼šå¯¼è‡´è¢«æ‰“æ–­çš„çº¿ç¨‹æŠ›å‡º<code>InterruptedException</code>ï¼Œå¹¶æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼›å¦‚æœæ‰“æ–­çš„æ˜¯æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œåˆ™ä¼šè®¾ç½®æ‰“æ–­æ ‡è®°ï¼›parkçš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œä¹Ÿä¼šè®¾ç½®æ‰“æ–­æ ‡è®°ã€‚</td>
</tr>
<tr>
<td><code>interrupted()</code> static</td>
<td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­</td>
<td>æ¸…é™¤çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ã€‚å¦‚æœè¿™ä¸ªæ–¹æ³•è¿ç»­è°ƒç”¨ä¸¤æ¬¡ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è°ƒç”¨å°†è¿”å›falseã€‚</td>
</tr>
<tr>
<td><code>currentThread()</code> static</td>
<td>è·å–å½“å‰çº¿ç¨‹</td>
<td></td>
</tr>
<tr>
<td><code>sleep()</code> static</td>
<td>è®©å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ä¼‘çœ næ¯«ç§’ï¼Œä¼‘çœ æ—¶é—´è®©å‡ºCPUçš„æ—¶é—´ç‰‡ç»™å…¶ä»–çº¿ç¨‹</td>
<td></td>
</tr>
<tr>
<td><code>yield()</code> static</td>
<td>æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹CPUçš„ä½¿ç”¨</td>
<td>ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•å’Œè°ƒè¯•</td>
</tr>
</tbody></table>
<h3 id="1-3-5-startå’Œrun"><a href="#1-3-5-startå’Œrun" class="headerlink" title="1.3.5 startå’Œrun"></a>1.3.5 startå’Œrun</h3><ul>
<li>startï¼šè®©çº¿ç¨‹å¤„äºå°±ç»ªçŠ¶æ€ï¼Œå¹¶æ²¡æœ‰è¿è¡Œï¼Œä¸€æ—¦å¾—åˆ°CPUæ—¶é—´ç‰‡ï¼Œå°±å¼€å§‹è¿è¡Œrun()æ–¹æ³•ã€‚</li>
<li>runï¼šå¦‚æœè¯¥çº¿ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„<code>Runnable</code>è¿è¡Œå¯¹è±¡æ„é€ çš„ï¼Œåˆ™è°ƒç”¨è¯¥<code>Runnable</code>å¯¹è±¡çš„run()æ–¹æ³•ï¼Œå¦åˆ™ï¼Œè¯¥æ–¹æ³•ä¸æ‰§è¡Œä»»ä½•æ“ä½œè¿”å›ã€‚</li>
<li>æ€»ç»“ï¼šè°ƒç”¨<code>start</code>æ–¹æ³•å¯å¯åŠ¨çº¿ç¨‹ï¼Œè€Œ<code>run</code>æ–¹æ³•åªæ˜¯<code>Thread</code>ç±»ä¸­çš„ä¸€ä¸ªæ™®é€šè°ƒç”¨ï¼Œè¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹é‡Œæ‰§è¡Œã€‚</li>
</ul>
<h3 id="1-3-6-sleepä¸yield"><a href="#1-3-6-sleepä¸yield" class="headerlink" title="1.3.6 sleepä¸yield"></a>1.3.6 sleepä¸yield</h3><p><code>sleep</code>æ–¹æ³•</p>
<ul>
<li>è°ƒç”¨<code>sleep</code>ä¼šè®©å½“å‰çº¿ç¨‹ä»<code>RUNNING</code>è¿›å…¥åˆ°<code>TIMED_WAITING</code>çŠ¶æ€</li>
<li>å…¶ä»–çº¿ç¨‹å¯ä»¥ä½¿ç”¨<code>interrupt</code>æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ã€‚</li>
<li>ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œã€‚</li>
<li>å»ºè®®ä½¿ç”¨<code>TimeUnit</code>çš„<code>sleep</code>ä»£æ›¿<code>Thread</code>çš„<code>sleep</code>æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§ã€‚</li>
</ul>
<p><code>yield</code>æ–¹æ³•</p>
<ul>
<li>è°ƒç”¨<code>yield</code>ä¼šè®©å½“å‰çº¿ç¨‹ä»<code>RUNNING</code>è¿›å…¥<code>RUNNABLE</code>å°±ç»ªçŠ¶æ€ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚</li>
<li>å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨ã€‚</li>
</ul>
<h3 id="1-3-7-çº¿ç¨‹ä¼˜å…ˆçº§"><a href="#1-3-7-çº¿ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="1.3.7 çº¿ç¨‹ä¼˜å…ˆçº§"></a>1.3.7 çº¿ç¨‹ä¼˜å…ˆçº§</h3><ul>
<li>çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤ºè°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒã€‚</li>
<li>å¦‚æœCPUæ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½†æ˜¯CPUé—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡æœ‰ä½œç”¨ã€‚</li>
</ul>
<h3 id="1-3-8-join"><a href="#1-3-8-join" class="headerlink" title="1.3.8 join"></a>1.3.8 join</h3><p>åœ¨ä¸‹é¢çš„ç¨‹åºä¸­ï¼Œæƒ³è®©<code>update</code>è¾“å‡ºiä¿®æ”¹åçš„ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;Join&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> i = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        update();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;main thread start&quot;</span>);</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;child thread start&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;child thread end&quot;</span>);</span><br><span class="line">            i *= i;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        log.debug(<span class="string">&quot;i =&gt; [&#123;&#125;]&quot;</span>, i);</span><br><span class="line">        log.debug(<span class="string">&quot;main thread end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">52.692</span> [main] DEBUG Join - main thread start</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">52.726</span> [t1] DEBUG Join - child thread start</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">52.726</span> [main] DEBUG Join - i =&gt; [<span class="number">3</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">52.727</span> [main] DEBUG Join - main thread end</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">53.734</span> [t1] DEBUG Join - child thread end</span><br></pre></td></tr></table></figure>

<p>åœ¨ç¬¬22è¡Œåæ·»åŠ <code>t1.join();</code>æ–¹æ³•åçš„è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">14</span>:<span class="number">53.431</span> [main] DEBUG Join - main thread start</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">14</span>:<span class="number">53.461</span> [t1] DEBUG Join - child thread start</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">14</span>:<span class="number">54.474</span> [t1] DEBUG Join - child thread end</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">14</span>:<span class="number">54.474</span> [main] DEBUG Join - i =&gt; [<span class="number">9</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">14</span>:<span class="number">54.475</span> [main] DEBUG Join - main thread end</span><br></pre></td></tr></table></figure>



<h3 id="1-3-9-interrupt"><a href="#1-3-9-interrupt" class="headerlink" title="1.3.9 interrupt"></a>1.3.9 interrupt</h3><p>ç›¸å…³APIï¼š</p>
<ul>
<li><code>interrupt()</code>ï¼šå£°æ˜æ­¤çº¿ç¨‹ä¸­æ–­ï¼Œä½†æ˜¯çº¿ç¨‹å¹¶ä¸ä¼šç«‹å³ä¸­æ–­</li>
<li><code>isInterrupted</code>ï¼šåˆ¤æ–­æ­¤çº¿ç¨‹æ˜¯å¦å·²ä¸­æ–­ï¼Œåˆ¤æ–­å®Œåä¸ä¿®æ”¹å¿åŸç®¡çš„ä¸­æ–­çŠ¶æ€</li>
<li><code>interrupted()</code>ï¼šåˆ¤æ–­æ­¤çº¿ç¨‹å·²ä¸­æ–­ï¼Œåˆ¤æ–­å®Œåæ¸…é™¤çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€</li>
</ul>
<p>ç†è§£å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>interrupt()</code>ï¼šçš‡ä¸Šï¼ˆçº¿ç¨‹ï¼‰æ¯æ™šæŒ‘é€‰ä¸€ä¸ªå¦ƒå­ä¾å¯ï¼Œåˆ°äº†æ—¶é—´ï¼Œå¤ªç›‘ä¼šå‘Šè¯‰çš‡ä¸Šï¼Œæ—¶é—´åˆ°äº†ï¼ˆå£°æ˜çº¿ç¨‹ä¸­æ–­ï¼‰ï¼Œçš‡ä¸ŠçŸ¥é“äº†ï¼Œåœä¸åœè¿˜æ˜¯çš‡ä¸Šè¯´äº†ç®—ã€‚</li>
<li><code>isInterrupted()</code>ï¼šå¦‚æœï¼ˆ<code>isInterrupted = true</code>ï¼‰åˆ™å¯ä»¥æ§åˆ¶çš‡ä¸Šï¼ˆçº¿ç¨‹ï¼‰åœæ­¢ï¼Œçš‡ä¸Šåœæ­¢åï¼Œçº¿ç¨‹è¿˜æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œå³<code>interruptes = true</code>ã€‚</li>
<li><code>interrupted()</code>ï¼šå¦‚æœï¼ˆ<code>isInterrupted = true</code>ï¼‰åˆ™å¯ä»¥æ§åˆ¶çš‡ä¸Šï¼ˆçº¿ç¨‹ï¼‰åœæ­¢ï¼Œçš‡ä¸Šåœæ­¢åï¼Œçº¿ç¨‹ä¼šæ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œå³<code>interruptes = false</code>ã€‚</li>
</ul>
<p>è¯æ˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;InterruptAPI&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterruptDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            Thread thread = Thread.currentThread();</span><br><span class="line">            <span class="keyword">while</span> (!thread.isInterrupted()) &#123;  <span class="comment">// (1) isInterrupted</span></span><br><span class="line"><span class="comment">//            while (!Thread.interrupted()) &#123;      // (2) interrupted(static)</span></span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, thread.isInterrupted());</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, thread.isInterrupted());</span><br><span class="line">        &#125;, <span class="string">&quot;t&quot;</span>);</span><br><span class="line">        t.start();</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        t.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨é‡Šï¼ˆ2ï¼‰ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">14</span>:<span class="number">04</span>:<span class="number">26.851</span> [t] DEBUG InterruptAPI - <span class="keyword">false</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">14</span>:<span class="number">04</span>:<span class="number">26.853</span> [t] DEBUG InterruptAPI - <span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>è¯æ˜<code>isInterrupted()</code>ä¸ä¼šä¿®æ”¹ä¸­æ–­çŠ¶æ€ã€‚</p>
<p>æ³¨é‡Šï¼ˆ1ï¼‰ç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">14</span>:<span class="number">04</span>:<span class="number">54.046</span> [t] DEBUG InterruptAPI - <span class="keyword">false</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">14</span>:<span class="number">04</span>:<span class="number">54.049</span> [t] DEBUG InterruptAPI - <span class="keyword">false</span></span><br></pre></td></tr></table></figure>

<p>è¯æ˜<code>interrupted()</code>ä¼šé‡ç½®ä¸­æ–­çŠ¶æ€ã€‚</p>
<h3 id="1-3-10-ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼"><a href="#1-3-10-ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼" class="headerlink" title="1.3.10 ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼"></a>1.3.10 ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">graph TD</span><br><span class="line">w(&quot;while(true)&quot;) --&gt; a</span><br><span class="line">a(&quot;æœ‰æ²¡æœ‰è¢«æ‰“æ–­&quot;) -- æ˜¯ --&gt; b(æ–™ç†åäº‹)</span><br><span class="line">b --&gt; c((ç»“æŸå¾ªç¯))</span><br><span class="line">a -- å¦ --&gt; d(ç¡çœ 2S)</span><br><span class="line">d -- æ— å¼‚å¸¸ --&gt; e(æ‰§è¡Œç›‘æ§è®°å½•)</span><br><span class="line">d -- æœ‰å¼‚å¸¸ --&gt; i(è®¾ç½®æ‰“æ–­æ ‡è®°)</span><br><span class="line">i --&gt; w</span><br><span class="line">e --&gt; w</span><br></pre></td></tr></table></figure>



<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;TwoStageTermination&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TwoStageTermination</span> </span>&#123;</span><br><span class="line">     Thread monitor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        monitor = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Thread current = Thread.currentThread();</span><br><span class="line">                <span class="comment">// æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œç›´æ¥è®¾ç½®æ‰“æ–­æ ‡è®°</span></span><br><span class="line">                <span class="keyword">if</span> (current.isInterrupted()) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ–™ç†åäº‹&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    log.info(<span class="string">&quot;æ‰§è¡Œç›‘æ§...&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    log.debug(e.getMessage());</span><br><span class="line">                    <span class="comment">// æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œä¼šè¢«æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œéœ€è¦é‡æ–°è®¾ç½®è®¾ç½®æ‰“æ–­æ ‡è®°</span></span><br><span class="line">                    current.interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœæ­¢ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        monitor.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">14</span>:<span class="number">26</span>:<span class="number">23.321</span> [Thread-<span class="number">0</span>] INFO  TwoStageTermination - æ‰§è¡Œç›‘æ§...</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">14</span>:<span class="number">26</span>:<span class="number">24.329</span> [Thread-<span class="number">0</span>] INFO  TwoStageTermination - æ‰§è¡Œç›‘æ§...</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">14</span>:<span class="number">26</span>:<span class="number">25.336</span> [Thread-<span class="number">0</span>] INFO  TwoStageTermination - æ‰§è¡Œç›‘æ§...</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">14</span>:<span class="number">26</span>:<span class="number">25.823</span> [Thread-<span class="number">0</span>] DEBUG TwoStageTermination - sleep interrupted</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">24</span> <span class="number">14</span>:<span class="number">26</span>:<span class="number">25.823</span> [Thread-<span class="number">0</span>] DEBUG TwoStageTermination - æ–™ç†åäº‹</span><br></pre></td></tr></table></figure>



<p><code>LockSupport</code>çš„<code>park()</code>å¯ç”¨äºæš‚åœå½“å‰çº¿ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;Park&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParkDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        park();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">park</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;isInterrupted =&gt; [&#123;&#125;]&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;isInterrupted =&gt; [&#123;&#125;]&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            Thread.interrupted();</span><br><span class="line">            log.debug(<span class="string">&quot;isInterrupted =&gt; [&#123;&#125;]&quot;</span>, Thread.currentThread().isInterrupted());</span><br><span class="line">            log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        t1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">08.234</span> [t1] DEBUG Park - park...</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">08.237</span> [t1] DEBUG Park - isInterrupted =&gt; [<span class="keyword">false</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">09.234</span> [t1] DEBUG Park - unpark...</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">09.234</span> [t1] DEBUG Park - isInterrupted =&gt; [<span class="keyword">true</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">09.234</span> [t1] DEBUG Park - isInterrupted =&gt; [<span class="keyword">false</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">06</span> <span class="number">20</span>:<span class="number">23</span>:<span class="number">09.234</span> [t1] DEBUG Park - unpark...</span><br></pre></td></tr></table></figure>



<p><strong>æ‰“æ–­çº¿ç¨‹çš„é”™è¯¯æ€è·¯</strong></p>
<ul>
<li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„<code>stop()</code>æ–¹æ³•åœæ­¢çº¿ç¨‹ï¼š<code>stop()</code>æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•é‡Šæ”¾é”ã€‚</li>
<li>ä½¿ç”¨<code>System.exit(int)</code>æ–¹æ³•ç»ˆæ­¢çº¿ç¨‹ï¼šç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢ã€‚</li>
</ul>
<p>ä»¥ä¸‹æ–¹æ³•ä¸æ¨èä½¿ç”¨ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td><code>stop()</code></td>
<td>åœæ­¢çº¿ç¨‹è¿è¡Œ</td>
</tr>
<tr>
<td><code>suspend()</code></td>
<td>æŒ‚èµ·çº¿ç¨‹è¿è¡Œ</td>
</tr>
<tr>
<td><code>resume()</code></td>
<td>æ¢å¤çº¿ç¨‹è¿è¡Œ</td>
</tr>
</tbody></table>
<h3 id="1-3-11-ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹"><a href="#1-3-11-ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹" class="headerlink" title="1.3.11 ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹"></a>1.3.11 ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒJavaè¿›ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸï¼Œæ‰ä¼šç»“æŸã€‚æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶ä»–éå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚</p>
<p>å®ˆæŠ¤çº¿ç¨‹ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</span><br><span class="line">    Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125; end&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">    log.debug(<span class="string">&quot;&#123;&#125; end&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">07</span> <span class="number">10</span>:<span class="number">37</span>:<span class="number">04</span>.<span class="number">886</span> [main] DEBUG Daemon - main end</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶mainçº¿ç¨‹ç»ˆæ­¢ï¼Œä½†æ˜¯t1çº¿ç¨‹å¹¶æœªç»ˆæ­¢ã€‚</p>
<p>ä½†æ˜¯<code>t1.setDaemon(true);</code>ä¹‹åï¼Œmainçº¿ç¨‹ç»ˆæ­¢ï¼Œt1çº¿ç¨‹ç«‹é©¬ç»ˆæ­¢ã€‚</p>
<h3 id="1-3-12-äº”ç§çŠ¶æ€"><a href="#1-3-12-äº”ç§çŠ¶æ€" class="headerlink" title="1.3.12 äº”ç§çŠ¶æ€"></a>1.3.12 äº”ç§çŠ¶æ€</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/9175/image-20210407110528028.png" class="" title="image-20210407110528028"><br />

<ul>
<li>ã€åˆå§‹çŠ¶æ€ã€‘ï¼šä»…æ˜¯åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”</li>
<li>ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼šè¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼Œä¸æ“ä½œç³»ç»Ÿå…³è”ï¼Œå¤„äºå°±ç»ªçŠ¶æ€ï¼Œå¯ä»¥ç”±CPUè°ƒåº¦æ‰§è¡Œ</li>
<li>ã€è¿è¡ŒçŠ¶æ€ã€‘ï¼šè·å–äº†CPUæ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€<ul>
<li>å½“CPUæ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»è¿è¡ŒçŠ¶æ€è½¬æ¢æˆå¯è¿è¡ŒçŠ¶æ€ï¼Œä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
</ul>
</li>
<li>ã€é˜»å¡çŠ¶æ€ã€‘ï¼š<ul>
<li>å¦‚æœè°ƒç”¨äº†é˜»å¡APIï¼Œå¦‚BIOè¯»å†™æ–‡ä»¶ï¼Œè¿™æ—¶è¯¥çº¿ç¨‹å®é™…ä¸ä¼šç”¨åˆ°CPUï¼Œä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€</li>
<li>ç­‰BIOæ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘</li>
</ul>
</li>
<li>ã€ç»ˆæ­¢çŠ¶æ€ã€‘ï¼šè¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶ä»–çŠ¶æ€ã€‚</li>
</ul>
<h3 id="1-3-13-å…­ç§çŠ¶æ€"><a href="#1-3-13-å…­ç§çŠ¶æ€" class="headerlink" title="1.3.13 å…­ç§çŠ¶æ€"></a>1.3.13 å…­ç§çŠ¶æ€</h3><p>ä»Java APIå±‚é¢æè¿°ï¼Œæ ¹æ®<code>Thread.State</code>æšä¸¾ï¼Œåˆ†ä¸ºå…­ç§çŠ¶æ€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">NEW            æ–°å»ºçŠ¶æ€</span><br><span class="line">RUNNABLE       è¿è¡ŒçŠ¶æ€ï¼ˆå°±ç»ªçŠ¶æ€ã€è¿è¡Œä¸­çŠ¶æ€ï¼‰</span><br><span class="line">BLOCKED        é˜»å¡çŠ¶æ€</span><br><span class="line">WAITING        ç­‰å¾…çŠ¶æ€</span><br><span class="line">TIMED_WAITING  è®¡æ—¶ç­‰å¾…çŠ¶æ€</span><br><span class="line">TERMINATED     ç»ˆæ­¢çŠ¶æ€</span><br></pre></td></tr></table></figure>

<ul>
<li>NEWçº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è°ƒç”¨<code>start()</code>æ–¹æ³•</li>
<li>RUNNABLEå½“è°ƒç”¨äº†<code>start()</code>æ–¹æ³•ä¹‹åï¼Œæ³¨æ„ï¼ŒJava APIå±‚é¢çš„RUNNABLEçŠ¶æ€æ¶µç›–äº†æ“ä½œç³»ç»Ÿå±‚é¢çš„ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ã€ã€è¿è¡ŒçŠ¶æ€ã€‘å’Œã€é˜»å¡çŠ¶æ€ã€‘ï¼ˆç”±äºBIOå¯¼è‡´çš„çº¿ç¨‹é˜»å¡ï¼Œåœ¨Javaé‡Œæ— æ³•åŒºåˆ†ï¼Œä»ç„¶è®¤ä¸ºæ˜¯å¯è¿è¡Œï¼‰ã€‚</li>
<li>BLOCKEDã€WAITINGã€TIMED_WAITINGéƒ½æ˜¯Java APIå±‚é¢å¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„ç»†åˆ†ã€‚â€˜</li>
<li>TERMINATEDå½“çº¿ç¨‹ä»£ç è¿è¡Œç»“æŸã€‚</li>
</ul>
<p>å›¾ç¤ºï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/9175/image-20210407114128028.svg" class="" title="image-20210407114128028"><br />



<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;State&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StateDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; log.debug(<span class="string">&quot;&#123;&#125; running...&quot;</span>, Thread.currentThread().getName()), <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123; <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;&#125; &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        Thread t3 = <span class="keyword">new</span> Thread(() -&gt; log.debug(<span class="string">&quot;&#123;&#125; running...&quot;</span>, Thread.currentThread().getName()), <span class="string">&quot;t3&quot;</span>);</span><br><span class="line">        Thread t4 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (StateDemo.class) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t4&quot;</span>);</span><br><span class="line">        Thread t5 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t2.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t5&quot;</span>);</span><br><span class="line">        Thread t6 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (StateDemo.class) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t4&quot;</span>);</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">        t4.start();</span><br><span class="line">        t5.start();</span><br><span class="line">        t6.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;t1 =&gt; [&#123;&#125;]&quot;</span>, t1.getState());   <span class="comment">// TERMINATED</span></span><br><span class="line">        log.debug(<span class="string">&quot;t2 =&gt; [&#123;&#125;]&quot;</span>, t2.getState());   <span class="comment">// RUNNABLE</span></span><br><span class="line">        log.debug(<span class="string">&quot;t3 =&gt; [&#123;&#125;]&quot;</span>, t3.getState());   <span class="comment">// TERMINATED</span></span><br><span class="line">        log.debug(<span class="string">&quot;t4 =&gt; [&#123;&#125;]&quot;</span>, t4.getState());   <span class="comment">// TIMED_WAITING</span></span><br><span class="line">        log.debug(<span class="string">&quot;t5 =&gt; [&#123;&#125;]&quot;</span>, t5.getState());   <span class="comment">// WAITING</span></span><br><span class="line">        log.debug(<span class="string">&quot;t6 =&gt; [&#123;&#125;]&quot;</span>, t6.getState());   <span class="comment">// BLOCKED</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-14-ä¹ é¢˜"><a href="#1-3-14-ä¹ é¢˜" class="headerlink" title="1.3.14 ä¹ é¢˜"></a>1.3.14 ä¹ é¢˜</h3><p>åº”ç”¨ä¹‹ç»Ÿç­¹ï¼ˆçƒ§æ°´æ³¡èŒ¶ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç»Ÿç­¹æ–¹æ³•ï¼Œæ˜¯ä¸€ç§å®‰æ’å·¥ä½œè¿›ç¨‹çš„æ•°å­¦æ–¹æ³•ã€‚å®ƒçš„å®ç”¨èŒƒå›´æå¹¿æ³›ï¼Œåœ¨ä¼ä¸šç®¡ç†å’ŒåŸºæœ¬å»ºè®¾ä¸­ï¼Œä»¥åŠå…³ç³»å¤æ‚çš„ç§‘ç ”é¡¹ç›®çš„ç»„ç»‡ä¸ç®¡ç†ä¸­ï¼Œéƒ½å¯ä»¥åº”ç”¨ã€‚</span><br><span class="line">æ€æ ·åº”ç”¨å‘¢ï¼Ÿä¸»è¦æ˜¯æŠŠå·¥åºå®‰æ’å¥½ã€‚</span><br><span class="line">æ¯”å¦‚ï¼Œæƒ³æ³¡å£¶èŒ¶å–ã€‚å½“æ—¶çš„æƒ…å†µæ˜¯ï¼šå¼€æ°´æ²¡æœ‰ï¼›æ°´å£¶è¦æ´—ï¼ŒèŒ¶å£¶ã€èŒ¶æ¯è¦æ´—ï¼›ç«å·²ç”Ÿäº†ï¼ŒèŒ¶å¶ä¹Ÿæœ‰äº†ã€‚æ€ä¹ˆåŠï¼Ÿ</span><br><span class="line"></span><br><span class="line">- åŠæ³•ç”²ï¼šæ´—å¥½æ°´å£¶ï¼ŒçŒä¸Šå‡‰æ°´ï¼Œæ”¾åœ¨ç«ä¸Šï¼›åœ¨ç­‰å¾…æ°´å¼€çš„æ—¶é—´é‡Œï¼Œæ´—èŒ¶å£¶ã€æ´—èŒ¶æ¯ã€æ‹¿èŒ¶å¶ï¼›ç­‰æ°´å¼€äº†ï¼Œæ³¡èŒ¶å–ã€‚</span><br><span class="line">- åŠæ³•ä¹™ï¼šå…ˆåšå¥½ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ´—æ°´å£¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ï¼Œæ‹¿èŒ¶å¶ï¼›ä¸€åˆ‡å°±ç»ªï¼ŒçŒæ°´çƒ§æ°´ï¼›åå¾…æ°´å¼€äº†ï¼Œæ³¡èŒ¶å–ã€‚</span><br><span class="line">- åŠæ³•ä¸™ï¼šæ´—å‡€æ°´å£¶ï¼ŒçŒä¸Šå‡‰æ°´ï¼Œæ”¾åœ¨ç«ä¸Šï¼Œåå¾…æ°´å¼€ï¼›æ°´å¼€äº†ä¹‹åï¼Œæ€¥æ€¥å¿™å¿™æ‰¾èŒ¶å¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ï¼Œæ³¡èŒ¶å–ã€‚</span><br><span class="line"></span><br><span class="line">å“ªä¸€ç§æ–¹æ³•çœæ—¶é—´ï¼Ÿæˆ‘ä»¬èƒ½ä¸€çœ¼çœ‹å‡ºï¼Œç¬¬ä¸€ç§åŠæ³•å¥½ï¼Œåä¸¤ç§åŠæ³•éƒ½çªäº†å·¥ã€‚</span><br><span class="line">â€”â€”åç½—åºšã€Šç»Ÿç­¹æ–¹æ³•ã€‹</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">graph LR</span><br><span class="line">a(æ´—æ°´å£¶) --&gt; b(çƒ§å¼€æ°´)</span><br><span class="line">c(æ´—èŒ¶å£¶,æ´—èŒ¶æ¯,æ‹¿èŒ¶å¶)</span><br><span class="line">b --&gt; d(æ³¡èŒ¶)</span><br><span class="line">c --&gt; d(æ³¡èŒ¶)</span><br></pre></td></tr></table></figure>

<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;BoilWaterToMakeTea&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PlanDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ´—æ°´å£¶&quot;</span>);</span><br><span class="line">            sleep(<span class="number">60</span>);      <span class="comment">// æ´—æ°´å£¶ 1åˆ†é’Ÿ</span></span><br><span class="line">            log.debug(<span class="string">&quot;çƒ§å¼€æ°´&quot;</span>);</span><br><span class="line">            sleep(<span class="number">60</span> * <span class="number">5</span>);  <span class="comment">// çƒ§å¼€æ°´ 5åˆ†é’Ÿ</span></span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ´—èŒ¶å£¶&quot;</span>);</span><br><span class="line">            sleep(<span class="number">60</span>);      <span class="comment">// æ´—æ°´å£¶ 1åˆ†é’Ÿ</span></span><br><span class="line">            log.debug(<span class="string">&quot;æ´—èŒ¶æ¯&quot;</span>);</span><br><span class="line">            sleep(<span class="number">60</span> * <span class="number">2</span>);  <span class="comment">// æ´—èŒ¶æ¯ 2åˆ†é’Ÿ</span></span><br><span class="line">            log.debug(<span class="string">&quot;æ‹¿èŒ¶å¶&quot;</span>);</span><br><span class="line">            sleep(<span class="number">60</span> );     <span class="comment">// çƒ§å¼€æ°´ 1åˆ†é’Ÿ</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t1.join();               <span class="comment">// ç­‰å¾…t1çƒ§æ°´</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;æ³¡èŒ¶&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">int</span> nanoSeconds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.NANOSECONDS.sleep(nanoSeconds);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-07 14:12:12.989 [t1] DEBUG top.parak.demo.BoilWaterToMakeTea - æ´—æ°´å£¶</span><br><span class="line">2021-04-07 14:12:12.989 [t2] DEBUG top.parak.demo.BoilWaterToMakeTea - æ´—èŒ¶å£¶</span><br><span class="line">2021-04-07 14:12:12.994 [t1] DEBUG top.parak.demo.BoilWaterToMakeTea - çƒ§å¼€æ°´</span><br><span class="line">2021-04-07 14:12:12.994 [t2] DEBUG top.parak.demo.BoilWaterToMakeTea - æ´—èŒ¶æ¯</span><br><span class="line">2021-04-07 14:12:12.996 [t2] DEBUG top.parak.demo.BoilWaterToMakeTea - æ‹¿èŒ¶å¶</span><br><span class="line">2021-04-07 14:12:12.998 [t2] DEBUG top.parak.demo.BoilWaterToMakeTea - æ³¡èŒ¶</span><br></pre></td></tr></table></figure>



<blockquote>
<p>å°ç»“</p>
<ul>
<li><code>sleep</code>ä¸é‡Šæ”¾é”ï¼Œé‡Šæ”¾CPU</li>
<li><code>join</code>é‡Šæ”¾é”ï¼ŒæŠ¢å CPU</li>
<li><code>yield</code>ä¸é‡Šæ”¾é”ï¼Œé‡Šæ”¾CPU</li>
<li><code>wait</code>é‡Šæ”¾é”ï¼Œé‡Šæ”¾CPU</li>
</ul>
</blockquote>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-4(å…±äº«æ¨¡å‹ä¹‹æ— é”)</title>
    <url>/posts/62265/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="4-1-é—®é¢˜æå‡º"><a href="#4-1-é—®é¢˜æå‡º" class="headerlink" title="4.1 é—®é¢˜æå‡º"></a>4.1 é—®é¢˜æå‡º</h2><h3 id="4-1-1-æå–æ¬¾é—®é¢˜"><a href="#4-1-1-æå–æ¬¾é—®é¢˜" class="headerlink" title="4.1.1 æå–æ¬¾é—®é¢˜"></a>4.1.1 æå–æ¬¾é—®é¢˜</h3><p>æœ‰å¦‚ä¸‹éœ€æ±‚ï¼Œä¿è¯accountã€withdrawå–æ¬¾æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–ä½™é¢</span></span><br><span class="line">    <span class="function">Integer <span class="title">geBalance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// å–æ¬¾</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Integer amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•å†…ä¼šå¯åŠ¨1000ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš-10å…ƒæ“ä½œ</span></span><br><span class="line"><span class="comment">     * å¦‚æœåˆå§‹ä½™é¢ä¸º10000ï¼Œé‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”è¯¥æ˜¯0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> account è´¦æˆ·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">demo</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">        List&lt;Thread&gt; ts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            ts.add(<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                account.withdraw(<span class="number">10</span>);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">        ts.forEach(Thread::start);</span><br><span class="line">        ts.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        ts.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">long</span> end = System.nanoTime();</span><br><span class="line">        System.out.printf(<span class="string">&quot;final balance: %d, spend time(ms): %d] &quot;</span>, account.geBalance(), (end - start) / <span class="number">1000_000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶ä»¥ä¸Šåšæ³•æ— æ³•ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<h3 id="4-1-2-é”è§£å†³æ–¹æ¡ˆ"><a href="#4-1-2-é”è§£å†³æ–¹æ¡ˆ" class="headerlink" title="4.1.2 é”è§£å†³æ–¹æ¡ˆ"></a>4.1.2 é”è§£å†³æ–¹æ¡ˆ</h3><p>ä¿æŠ¤å…±äº«å˜é‡ï¼Œç»™ä¸´ç•ŒåŒºåŠ é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AccountSafe</span> <span class="keyword">implements</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä½™é¢</span></span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccountSafe</span><span class="params">(Integer balance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">geBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Integer amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.balance -= amount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-1-2-æ— é”è§£å†³æ–¹æ¡ˆ"><a href="#4-1-2-æ— é”è§£å†³æ–¹æ¡ˆ" class="headerlink" title="4.1.2 æ— é”è§£å†³æ–¹æ¡ˆ"></a>4.1.2 æ— é”è§£å†³æ–¹æ¡ˆ</h3><p>ä½¿ç”¨åŸå­æ•´æ•°è¿›è¡ŒCASæ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AccountCAS</span> <span class="keyword">implements</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger balance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccountCAS</span><span class="params">(Integer balance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.balance = <span class="keyword">new</span> AtomicInteger(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">geBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> balance.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Integer amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–ä½™é¢çš„æœ€æ–°å€¼</span></span><br><span class="line">            <span class="keyword">int</span> prev = <span class="keyword">this</span>.balance.get();</span><br><span class="line">            <span class="comment">// ä¿®æ”¹åçš„ä½™é¢</span></span><br><span class="line">            <span class="keyword">int</span> next = prev - amount;</span><br><span class="line">            <span class="comment">// åŒæ­¥åˆ°ä¸»å­˜</span></span><br><span class="line">            <span class="comment">// CAS(é¢„æœŸå€¼ï¼Œä¿®æ”¹å€¼) =&gt; boolean(æ˜¯å¦ä¿®æ”¹æˆåŠŸ)</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.balance.compareAndSet(prev, next)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-1-3-æµ‹è¯•"><a href="#4-1-3-æµ‹è¯•" class="headerlink" title="4.1.3 æµ‹è¯•"></a>4.1.3 æµ‹è¯•</h3><p>ç¼–å†™ä»¥ä¸‹ä»£ç è¿›è¡Œæµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.print(<span class="string">&quot;[Unsafe =&gt; &quot;</span>);</span><br><span class="line">        Account a1 = <span class="keyword">new</span> AccountUnsafe(<span class="number">10000</span>);</span><br><span class="line">        Account.demo(a1);</span><br><span class="line">        System.out.print(<span class="string">&quot;[synchronized =&gt; &quot;</span>);</span><br><span class="line">        Account a2 = <span class="keyword">new</span> AccountSafe(<span class="number">10000</span>);</span><br><span class="line">        Account.demo(a2);</span><br><span class="line">        System.out.print(<span class="string">&quot;[compareAndSet =&gt; &quot;</span>);</span><br><span class="line">        Account a3 = <span class="keyword">new</span> AccountCAS(<span class="number">10000</span>);</span><br><span class="line">        Account.demo(a3);</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•è„šæœ¬ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> <span class="operator">-le</span> <span class="number">10</span>; <span class="variable">$i</span>++) &#123; java top.parak.none.AccountDemo &#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62265/image-20210426225654053.png" class="" title="image-20210426225654053"><br />



<h3 id="4-1-5-compareAndSet"><a href="#4-1-5-compareAndSet" class="headerlink" title="4.1.5 compareAndSet"></a>4.1.5 compareAndSet</h3><p>compareAndSetï¼Œç®€ç§°CASï¼ˆä¹Ÿæœ‰Compare And Swapçš„è¯´æ³•ï¼‰ï¼Œå®ƒå¿…é¡»æ˜¯åŸå­æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">// è·å–ä½™é¢çš„æœ€æ–°å€¼</span></span><br><span class="line">    <span class="keyword">int</span> prev = <span class="keyword">this</span>.balance.get();</span><br><span class="line">    <span class="comment">// ä¿®æ”¹åçš„ä½™é¢</span></span><br><span class="line">    <span class="keyword">int</span> next = prev - amount;</span><br><span class="line">    <span class="comment">// åŒæ­¥åˆ°ä¸»å­˜</span></span><br><span class="line">    <span class="comment">// CAS(é¢„æœŸå€¼ï¼Œä¿®æ”¹å€¼) =&gt; boolean(æ˜¯å¦ä¿®æ”¹æˆåŠŸ)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.balance.compareAndSet(prev, next)) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62265/image-20210426230136937.png" class="" title="image-20210426230136937"><br />



<h2 id="4-2-CASä¸volatile"><a href="#4-2-CASä¸volatile" class="headerlink" title="4.2 CASä¸volatile"></a>4.2 CASä¸volatile</h2><h3 id="4-2-1-volatile"><a href="#4-2-1-volatile" class="headerlink" title="4.2.1 volatile"></a>4.2.1 volatile</h3><p>è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨volatileä¿®é¥°ã€‚</p>
<p>å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œå®ƒå¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œvolatileå˜é‡éƒ½æ˜¯æ“ä½œä¸»å­˜ã€‚å³ä¸€ä¸ªçº¿ç¨‹å¯¹volatileå˜é‡çš„ä¿®æ”¹ï¼Œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚</p>
<p>CASå¿…é¡»å€ŸåŠ©volatileæ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°ã€æ¯”è¾ƒå¹¶äº¤æ¢ã€‘çš„æ•ˆæœã€‚</p>
<h3 id="4-2-2-ä¸ºä»€ä¹ˆCAS-é‡è¯•æ•ˆç‡é«˜ï¼Ÿ"><a href="#4-2-2-ä¸ºä»€ä¹ˆCAS-é‡è¯•æ•ˆç‡é«˜ï¼Ÿ" class="headerlink" title="4.2.2 ä¸ºä»€ä¹ˆCAS+é‡è¯•æ•ˆç‡é«˜ï¼Ÿ"></a>4.2.2 ä¸ºä»€ä¹ˆCAS+é‡è¯•æ•ˆç‡é«˜ï¼Ÿ</h3><ul>
<li>åœ¨æ— é”æƒ…å†µä¸‹ï¼Œå³ä½¿é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œï¼Œæ²¡æœ‰åœæ­‡ï¼Œè€Œsynchronizedä¼šè®©çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶å€™ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡ã€‚</li>
<li>ä½†æ˜¯ï¼Œåœ¨æ— é”æƒ…å†µä¸‹ï¼Œå› ä¸ºçº¿ç¨‹è¦ä¿æŒè¿è¡Œï¼Œéœ€è¦é¢å¤–CPUçš„æ”¯æŒï¼ŒCPUåœ¨è¿™é‡Œå°±å¥½æ¯”é«˜é€Ÿè·‘é“ï¼Œæ²¡æœ‰é¢å¤–çš„è·‘é“ï¼Œçº¿ç¨‹æƒ³é«˜é€Ÿè¿è¡Œä¹Ÿæ— ä»è°ˆèµ·ï¼Œè™½ç„¶ä¹Ÿä¸ä¼šè¿›å…¥é˜»å¡ï¼Œä½†ç”±äºæ²¡æœ‰åˆ†åˆ°æ—¶é—´ç‰‡ï¼Œä»ç„¶ä¼šè¿›å…¥å¯è¿è¡ŒçŠ¶æ€ï¼Œè¿˜æ˜¯ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li>
</ul>
<h3 id="4-2-3-CASåº”ç”¨åœºæ™¯"><a href="#4-2-3-CASåº”ç”¨åœºæ™¯" class="headerlink" title="4.2.3 CASåº”ç”¨åœºæ™¯"></a>4.2.3 CASåº”ç”¨åœºæ™¯</h3><p>ç»“åˆCASå’Œvolatileå¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºçº¿ç¨‹æ•°å°‘ã€å¤šæ ¸CPUçš„åœºæ™¯ä¸‹ï¼š</p>
<ul>
<li>CASæ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³ï¼šéå¸¸ä¹è§‚ï¼Œå‡è®¾æ²¡æœ‰åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†å½“å‰çº¿ç¨‹å°±å†æ¬¡é‡è¯•ã€‚</li>
<li>synchronizedæ˜¯åŸºäºæ‚²è§‚é”çš„æ€æƒ³ï¼šéå¸¸æ‚²è§‚ï¼Œæé˜²å…¶ä»–çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå½“å‰çº¿ç¨‹è·å–èµ„æºå°±ç«‹é©¬ä¸Šé”ï¼Œå…¶ä»–äº‰æŠ¢èµ„æºå¤±è´¥çš„çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä¿®æ”¹ç»“æŸæ‰å¼€é”ï¼Œ</li>
<li>CASä½“ç°çš„æ˜¯æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘<ul>
<li>å› ä¸ºæ²¡æœ‰ä½¿ç”¨æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘ï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ã€‚</li>
<li>ä½†æ˜¯å¦‚æœç«äº‰æ¿€çƒˆï¼Œé‡è¯•å¿…ç„¶ é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šæ”¶åˆ°å½±å“ã€‚</li>
</ul>
</li>
</ul>
<h3 id="4-2-4-CASç‰¹ç‚¹"><a href="#4-2-4-CASç‰¹ç‚¹" class="headerlink" title="4.2.4 CASç‰¹ç‚¹"></a>4.2.4 CASç‰¹ç‚¹</h3><p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¯ä»¥ä¿è¯å˜é‡æ“ä½œçš„åŸå­æ€§</li>
<li>å¹¶å‘é‡ä½æ—¶ï¼ŒCASæ•ˆç‡é«˜äºsynchronized</li>
<li>åœ¨çº¿ç¨‹å¯¹å…±äº«èµ„æºå ç”¨æ—¶é—´è¾ƒçŸ­çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨CASæœºåˆ¶æ•ˆç‡ä¹Ÿä¼šè¾ƒé«˜</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ— æ³•è§£å†³ABAé—®é¢˜</li>
<li>å¯èƒ½ä¼šæ¶ˆè€—è¾ƒé«˜çš„CPU</li>
<li>ä¸èƒ½ä¿è¯ä»£ç å—çš„åŸå­æ€§</li>
</ul>
<h2 id="4-3-åŸå­æ•´æ•°"><a href="#4-3-åŸå­æ•´æ•°" class="headerlink" title="4.3 åŸå­æ•´æ•°"></a>4.3 åŸå­æ•´æ•°</h2><p>JUCæä¾›å¦‚ä¸‹åŸå­æ•´æ•°ç±»ï¼š</p>
<ul>
<li><code>AtomicBoolean</code></li>
<li><code>AtomicInteger</code></li>
<li><code>AtomicLong</code></li>
</ul>
<p><code>AtomicInteger</code>å¸¸ç”¨APIå¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62265/image-20220107145512276.png" class="" title="image-20220107145512276"><br />



<h2 id="4-4-åŸå­å¼•ç”¨"><a href="#4-4-åŸå­å¼•ç”¨" class="headerlink" title="4.4 åŸå­å¼•ç”¨"></a>4.4 åŸå­å¼•ç”¨</h2><p>JUCæä¾›å¦‚ä¸‹åŸå­å¼•ç”¨ç±»ï¼š</p>
<ul>
<li><code>AtomicReference</code>ï¼šæ™®é€šåŸå­å¼•ç”¨ç±»å‹ï¼Œå¯¹å¯¹è±¡è¿›è¡ŒåŸå­æ“ä½œ</li>
<li><code>AtomicStampedReference</code>ï¼šå¸¦intç±»å‹ç‰ˆæœ¬æˆ³çš„åŸå­å¼•ç”¨ç±»å‹ï¼Œè®°å½•æ›´æ”¹æ¬¡æ•°</li>
<li><code>AtomicMarkableReference</code>ï¼šå¸¦booleanç±»å‹ç‰ˆæœ¬æˆ³çš„åŸå­å¼•ç”¨ç±»å‹ï¼Œè®°å½•æ˜¯å¦æ›´æ”¹</li>
</ul>
<p>ä½œç”¨ï¼šä¿è¯å¼•ç”¨ç±»å‹çš„å…±äº«å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>ä½¿ç”¨<code>BigDemical</code>å®ç°æå–æ¬¾é—®é¢˜çš„çº¿ç¨‹å®‰å…¨è§£å†³æ–¹æ¡ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecimalAccountCAS</span> <span class="keyword">implements</span> <span class="title">DecimalAccount</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicReference&lt;BigDecimal&gt; balance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DecimalAccountCAS</span><span class="params">(BigDecimal balance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.balance = <span class="keyword">new</span> AtomicReference&lt;&gt;(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> balance.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(BigDecimal amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            BigDecimal prev = balance.get();</span><br><span class="line">            BigDecimal next = prev.subtract(amount);</span><br><span class="line">            <span class="keyword">if</span> (balance.compareAndSet(prev, next)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DecimalAccount</span> </span>&#123;</span><br><span class="line">    <span class="function">BigDecimal <span class="title">getBalance</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(BigDecimal amount)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-1-ABAé—®é¢˜"><a href="#4-4-1-ABAé—®é¢˜" class="headerlink" title="4.4.1 ABAé—®é¢˜"></a>4.4.1 ABAé—®é¢˜</h3><p>å¦‚ä¸‹ç¨‹åºæ‰€ç¤ºï¼Œè™½ç„¶åœ¨<code>other</code>æ–¹æ³•ä¸­å­˜åœ¨ä¸¤ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œä½†æ˜¯ç»è¿‡äº†ä¸¤è½®ä¿®æ”¹åˆå˜æˆäº†åŸå€¼ï¼Œmainçº¿ç¨‹å¯¹ä¿®æ”¹å…±äº«å˜é‡çš„è¿‡ç¨‹æ˜¯ä¸å¯è§çš„ï¼Œè¿™ç§æ“ä½œå¯¹ä¸šåŠ¡ä»£ç å¹¶æ— å½±å“ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ABAAtomicReference&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ABAAtomicReferenceDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicReference&lt;String&gt; ref = <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;main start...&quot;</span>);</span><br><span class="line">        String prev = ref.get();</span><br><span class="line">        other();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;change A -&gt; K ? &#123;&#125;&quot;</span>, ref.compareAndSet(prev, <span class="string">&quot;K&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">other</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; log.debug(<span class="string">&quot;change A -&gt; B ? &#123;&#125;&quot;</span>, ref.compareAndSet(ref.get(), <span class="string">&quot;B&quot;</span>)), <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; log.debug(<span class="string">&quot;change B -&gt; A ? &#123;&#125;&quot;</span>, ref.compareAndSet(ref.get(), <span class="string">&quot;A&quot;</span>)), <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-27 17:29:12.538 [main] DEBUG ABAAtomicReference - main start...</span><br><span class="line">2021-04-27 17:29:12.575 [A] DEBUG ABAAtomicReference - change B -&gt; A ? true</span><br><span class="line">2021-04-27 17:29:12.575 [B] DEBUG ABAAtomicReference - change A -&gt; B ? true</span><br><span class="line">2021-04-27 17:29:13.580 [main] DEBUG ABAAtomicReference - change A -&gt; K ? true</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶ABAå¯¹ä¸šåŠ¡æ²¡æœ‰å½±å“ï¼Œä½†æ˜¯å¦‚ä½•è®©ä¸»çº¿ç¨‹æ„ŸçŸ¥åˆ°å…¶ä»–çº¿ç¨‹çš„ä¿®æ”¹å‘¢ï¼Ÿ</p>
<h3 id="4-4-2-AtomicStampedReference"><a href="#4-4-2-AtomicStampedReference" class="headerlink" title="4.4.2 AtomicStampedReference"></a>4.4.2 AtomicStampedReference</h3><p>è§£å†³ABAé—®é¢˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ABAAtomicStampedReference&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ABAAtomicStampedReferenceDemo</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> AtomicStampedReference&lt;String&gt; ref = <span class="keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="string">&quot;A&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;main start...&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> stamp = ref.getStamp();</span><br><span class="line">        other();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">boolean</span> res = ref.compareAndSet(ref.getReference(), <span class="string">&quot;K&quot;</span>, stamp, stamp + <span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;change A -&gt; K ? &#123;&#125;&quot;</span>, res);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">other</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> stamp = ref.getStamp();</span><br><span class="line">            <span class="keyword">boolean</span> res = ref.compareAndSet(ref.getReference(), <span class="string">&quot;B&quot;</span>, stamp, stamp + <span class="number">1</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;change A -&gt; B ? &#123;&#125;&quot;</span>, res);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> stamp = ref.getStamp();</span><br><span class="line">            <span class="keyword">boolean</span> res = ref.compareAndSet(ref.getReference(), <span class="string">&quot;A&quot;</span>, stamp, stamp + <span class="number">1</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;change B -&gt; A ? &#123;&#125;&quot;</span>, res);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-27 18:18:00.754 [main] DEBUG ABAAtomicStampedReference - main start...</span><br><span class="line">2021-04-27 18:18:00.787 [A] DEBUG ABAAtomicStampedReference - change B -&gt; A ? true</span><br><span class="line">2021-04-27 18:18:00.787 [B] DEBUG ABAAtomicStampedReference - change A -&gt; B ? true</span><br><span class="line">2021-04-27 18:18:01.792 [main] DEBUG ABAAtomicStampedReference - change A -&gt; K ? false</span><br></pre></td></tr></table></figure>



<h3 id="4-4-3-AtomicMarkableReference"><a href="#4-4-3-AtomicMarkableReference" class="headerlink" title="4.4.3 AtomicMarkableReference"></a>4.4.3 AtomicMarkableReference</h3><p>ä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹äº†å‡ æ¬¡ï¼Œåªæ˜¯å•çº¯çš„å…³å¿ƒæ˜¯å¦æ›´æ”¹è¿‡ã€‚</p>
<p>æ¡ˆä¾‹ï¼š</p>
<p>å®¶é‡Œæœ‰æ¸…æ´æœºå™¨äººå’Œä¿æ´é˜¿å§¨ï¼Œåƒåœ¾è¢‹æ»¡æ—¶ï¼Œéœ€è¦æ›´æ¢ï¼Œæœºå™¨äººæ¢äº†é˜¿å§¨åˆ™ä¸éœ€è¦æ¢ï¼Œåä¹‹äº¦ç„¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ABAAtomicMarkableReference&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ABAAtomicMarkableReferenceDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> GarbageBag bag = <span class="keyword">new</span> GarbageBag(<span class="string">&quot;è£…æ»¡åƒåœ¾&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicMarkableReference&lt;GarbageBag&gt; ref = <span class="keyword">new</span> AtomicMarkableReference&lt;&gt;(bag, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;å®¶é‡Œéœ€è¦æ¢åƒåœ¾è¢‹...&quot;</span>);</span><br><span class="line">        GarbageBag prev = ref.getReference();</span><br><span class="line">        robot();</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        aunt();</span><br><span class="line">        TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">        log.debug(ref.getReference().toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…æ´æœºå™¨äºº</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">robot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ¸…æ´æœºå™¨äººå¼€å§‹æ‰“æ‰«å«ç”Ÿ...&quot;</span>);</span><br><span class="line">            <span class="keyword">boolean</span> res = ref.compareAndSet(ref.getReference(), <span class="keyword">new</span> GarbageBag(<span class="string">&quot;æ–°åƒåœ¾è¢‹&quot;</span>),</span><br><span class="line">                    <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;æœºå™¨äººæ˜¯å¦æ¢äº†åƒåœ¾è¢‹ ? &#123;&#125;&quot;</span>, res);</span><br><span class="line">        &#125;, <span class="string">&quot;robot&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿æ´é˜¿å§¨</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">aunt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;ä¿æ´é˜¿å§¨å¼€å§‹æ‰“æ‰«å«ç”Ÿ...&quot;</span>);</span><br><span class="line">            bag.setDesc(<span class="string">&quot;ç©ºåƒåœ¾è¢‹&quot;</span>);</span><br><span class="line">            <span class="keyword">boolean</span> res = ref.compareAndSet(ref.getReference(), <span class="keyword">new</span> GarbageBag(<span class="string">&quot;æ–°åƒåœ¾è¢‹&quot;</span>),</span><br><span class="line">                    <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;é˜¿å§¨æ˜¯å¦æ¢äº†åƒåœ¾è¢‹ ? &#123;&#125;&quot;</span>, res);</span><br><span class="line">        &#125;, <span class="string">&quot;aunt&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GarbageBag</span> </span>&#123;</span><br><span class="line">    String desc;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GarbageBag</span><span class="params">(String desc)</span> </span>&#123; <span class="keyword">this</span>.desc = desc; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDesc</span><span class="params">(String desc)</span> </span>&#123; <span class="keyword">this</span>.desc = desc; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">&quot;GarbageBag[desc=&#x27;&quot;</span> + desc + <span class="string">&quot;&#x27;]&quot;</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-27 20:01:20.764 [main] DEBUG ABAAtomicMarkableReference - éœ€è¦æ¢åƒåœ¾è¢‹...</span><br><span class="line">2021-04-27 20:01:20.796 [robot] DEBUG ABAAtomicMarkableReference - æ¸…æ´æœºå™¨äººå¼€å§‹æ‰“æ‰«å«ç”Ÿ...</span><br><span class="line">2021-04-27 20:01:20.796 [robot] DEBUG ABAAtomicMarkableReference - æœºå™¨äººæ˜¯å¦æ¢äº†åƒåœ¾è¢‹ ? true</span><br><span class="line">2021-04-27 20:01:20.809 [aunt] DEBUG ABAAtomicMarkableReference - ä¿æ´é˜¿å§¨å¼€å§‹æ‰“æ‰«å«ç”Ÿ...</span><br><span class="line">2021-04-27 20:01:20.809 [aunt] DEBUG ABAAtomicMarkableReference - é˜¿å§¨æ˜¯å¦æ¢äº†åƒåœ¾è¢‹ ? false</span><br><span class="line">2021-04-27 20:01:20.823 [main] DEBUG ABAAtomicMarkableReference - GarbageBag[desc&#x3D;&#39;æ–°åƒåœ¾è¢‹&#39;]</span><br></pre></td></tr></table></figure>



<h2 id="4-5-åŸå­æ•°ç»„"><a href="#4-5-åŸå­æ•°ç»„" class="headerlink" title="4.5 åŸå­æ•°ç»„"></a>4.5 åŸå­æ•°ç»„</h2><p>JUCæä¾›å¦‚ä¸‹åŸå­æ•°ç»„ç±»ï¼š</p>
<ul>
<li><code>AtomicIntegerArray</code></li>
<li><code>AtomicLongArray</code></li>
<li><code>AtomicReferenceArray</code></li>
</ul>
<p>ä½œç”¨ï¼šä¿è¯æ•°ç»„å†…çš„å…ƒç´ çš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;AtomicArray&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicArrayDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        demo(</span><br><span class="line">                () -&gt; <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>],</span><br><span class="line">                array -&gt; array.length,</span><br><span class="line">                (array, index) -&gt; array[index]++,</span><br><span class="line">                array -&gt;  log.debug(<span class="string">&quot;æ™®é€šæ•°ç»„ï¼š&#123;&#125;&quot;</span>, Arrays.toString(array))</span><br><span class="line">        );</span><br><span class="line">        demo(</span><br><span class="line">                () -&gt; <span class="keyword">new</span> AtomicIntegerArray(<span class="number">10</span>),</span><br><span class="line">                AtomicIntegerArray::length,</span><br><span class="line">                AtomicIntegerArray::getAndIncrement,</span><br><span class="line">                array -&gt; log.debug(<span class="string">&quot;å®‰å…¨æ•°ç»„ï¼š&#123;&#125;&quot;</span>, array)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> arraySupplier   æä¾›æ•°ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lengthFunction  è·å–æ•°ç»„é•¿åº¦çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> putConsumer     æŒ‡å®šå…ƒç´ çš„è‡ªå¢æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> printConsumer   æ‰“å°æ•°ç»„å…ƒç´ çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@apiNote</span></span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Supplier æä¾›è€… æ— ä¸­ç”Ÿæœ‰         () -&gt; ç»“æœ &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Function  å‡½æ•°  ä¸€ä¸ªå‚æ•°ä¸€ä¸ªç»“æœ (å‚æ•°) -&gt; ç»“æœ  | BiFunction (å‚æ•°1ï¼Œå‚æ•°2) -&gt; ç»“æœ &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt; Consumer æ¶ˆè´¹è€… ä¸€ä¸ªå‚æ•°æ²¡æœ‰ç»“æœ (å‚æ•°) -&gt; Void  | BiConsumer (å‚æ•°1ï¼Œå‚æ•°2) -&gt; Void &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">demo</span><span class="params">(Supplier&lt;T&gt; arraySupplier, Function&lt;T, Integer&gt; lengthFunction,</span></span></span><br><span class="line"><span class="function"><span class="params">            BiConsumer&lt;T, Integer&gt; putConsumer, Consumer&lt;T&gt; printConsumer)</span> </span>&#123;</span><br><span class="line">        List&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        T array = arraySupplier.get();</span><br><span class="line">        <span class="keyword">int</span> length = lengthFunction.apply(array);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123; <span class="comment">// æ­£ç¡®ç»“æœåº”è¯¥æ˜¯æ•°ç»„å…ƒç´ éƒ½ä¸º10000</span></span><br><span class="line">                    putConsumer.accept(array, j % length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        list.forEach(Thread::start);</span><br><span class="line">        list.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        printConsumer.accept(array);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-27 21:09:01.160 [main] DEBUG AtomicArray - æ™®é€šæ•°ç»„ï¼š[6531, 6533, 6501, 6566, 6515, 6508, 6499, 6519, 6489, 6527]</span><br><span class="line">2021-04-27 21:09:01.166 [main] DEBUG AtomicArray - å®‰å…¨æ•°ç»„ï¼š[10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000]</span><br></pre></td></tr></table></figure>



<h2 id="4-6-å­—æ®µæ›´æ–°å™¨"><a href="#4-6-å­—æ®µæ›´æ–°å™¨" class="headerlink" title="4.6 å­—æ®µæ›´æ–°å™¨"></a>4.6 å­—æ®µæ›´æ–°å™¨</h2><p>JUCæä¾›å¦‚ä¸‹å­—æ®µæ›´æ–°å™¨ï¼š</p>
<ul>
<li><code>AtomicReferenceFeildUpdater</code>ï¼šå¼•ç”¨ç±»å‹çš„å±æ€§</li>
<li><code>AtomicIntegerFieldUpdater</code>ï¼šæ•´å½¢çš„å±æ€§</li>
<li><code>AtomicLongFeildUpdater</code>ï¼šé•¿æ•´å½¢çš„å±æ€§</li>
</ul>
<p>æ³¨æ„ï¼šåˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆvolatileä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.IllegalArgumentException: Must be volatile type</span><br></pre></td></tr></table></figure>



<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;AtomicFieldUpdater&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicFieldUpdaterDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Student stu = <span class="keyword">new</span> Student();</span><br><span class="line">        AtomicReferenceFieldUpdater updater = AtomicReferenceFieldUpdater.newUpdater(Student.class, String.class, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;update ? &#123;&#125;&quot;</span>, updater.compareAndSet(stu, <span class="keyword">null</span>, <span class="string">&quot;RubbishK&quot;</span>));</span><br><span class="line">        log.debug(<span class="string">&quot;update ? &#123;&#125;&quot;</span>, updater.compareAndSet(stu, stu.getName(), <span class="string">&quot;FlowerK&quot;</span>));</span><br><span class="line">        log.debug(stu.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">&quot;Student[name=&#x27;&quot;</span> + name + <span class="string">&quot;&#x27;]&quot;</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-27 21:36:51.784 [main] DEBUG AtomicFieldUpdater - update ? true</span><br><span class="line">2021-04-27 21:36:51.786 [main] DEBUG AtomicFieldUpdater - update ? true</span><br><span class="line">2021-04-27 21:36:51.786 [main] DEBUG AtomicFieldUpdater - Student[name&#x3D;&#39;FlowerK&#39;]</span><br></pre></td></tr></table></figure>



<h2 id="4-7-åŸå­ç´¯åŠ å™¨"><a href="#4-7-åŸå­ç´¯åŠ å™¨" class="headerlink" title="4.7 åŸå­ç´¯åŠ å™¨"></a>4.7 åŸå­ç´¯åŠ å™¨</h2><p>JUCæä¾›å¦‚ä¸‹åŸå­ç´¯åŠ å™¨ï¼š</p>
<ul>
<li><code>LongAddr</code></li>
<li><code>LongAccumulator</code></li>
<li><code>DouleAddr</code></li>
<li><code>DoubleAccumulator</code></li>
</ul>
<h3 id="4-7-1-ç´¯åŠ æ€§èƒ½æ¯”è¾ƒ"><a href="#4-7-1-ç´¯åŠ æ€§èƒ½æ¯”è¾ƒ" class="headerlink" title="4.7.1 ç´¯åŠ æ€§èƒ½æ¯”è¾ƒ"></a>4.7.1 ç´¯åŠ æ€§èƒ½æ¯”è¾ƒ</h3><p>ç´¯åŠ æ€§èƒ½æ¯”è¾ƒ<code>AtomicLong</code>ï¼Œ<code>LongAddr</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;Compare&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PerformanceCompareDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            demo(AtomicLong::<span class="keyword">new</span>, AtomicLong::getAndIncrement);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            demo(LongAdder::<span class="keyword">new</span>, LongAdder::increment);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">demo</span><span class="params">(Supplier&lt;T&gt; supplier, Consumer&lt;T&gt; consumer)</span> </span>&#123;</span><br><span class="line">        T adder = supplier.get();</span><br><span class="line">        <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">        List&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">40</span>; i++) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">50_0000</span>; k++) &#123;</span><br><span class="line">                    consumer.accept(adder);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        list.forEach(Thread::start);</span><br><span class="line">        list.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">long</span> end = System.nanoTime();</span><br><span class="line">        log.debug(<span class="string">&quot;&#123;&#125; cost: &#123;&#125;(ns)&quot;</span>, adder.getClass().getSimpleName(), (end - start));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">27</span> <span class="number">22</span>:<span class="number">34</span>:<span class="number">29.842</span> [main] DEBUG Compare - AtomicLong cost: <span class="number">363865900</span>(ns)</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">27</span> <span class="number">22</span>:<span class="number">34</span>:<span class="number">30.176</span> [main] DEBUG Compare - AtomicLong cost: <span class="number">331326300</span>(ns)</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">27</span> <span class="number">22</span>:<span class="number">34</span>:<span class="number">30.565</span> [main] DEBUG Compare - AtomicLong cost: <span class="number">388361700</span>(ns)</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">27</span> <span class="number">22</span>:<span class="number">34</span>:<span class="number">30.961</span> [main] DEBUG Compare - AtomicLong cost: <span class="number">396090500</span>(ns)</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">27</span> <span class="number">22</span>:<span class="number">34</span>:<span class="number">31.349</span> [main] DEBUG Compare - AtomicLong cost: <span class="number">386800900</span>(ns)</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">27</span> <span class="number">22</span>:<span class="number">34</span>:<span class="number">31.404</span> [main] DEBUG Compare - LongAdder cost: <span class="number">53539000</span>(ns)</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">27</span> <span class="number">22</span>:<span class="number">34</span>:<span class="number">31.438</span> [main] DEBUG Compare - LongAdder cost: <span class="number">33946400</span>(ns)</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">27</span> <span class="number">22</span>:<span class="number">34</span>:<span class="number">31.479</span> [main] DEBUG Compare - LongAdder cost: <span class="number">40203000</span>(ns)</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">27</span> <span class="number">22</span>:<span class="number">34</span>:<span class="number">31.511</span> [main] DEBUG Compare - LongAdder cost: <span class="number">32314300</span>(ns)</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">27</span> <span class="number">22</span>:<span class="number">34</span>:<span class="number">31.546</span> [main] DEBUG Compare - LongAdder cost: <span class="number">34245400</span>(ns)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°ï¼Œ<code>LongAddr</code>çš„é€Ÿåº¦è¦æ¯”<code>AtomicLong</code>é«˜å‡ºä¸€ä¸ªæ•°é‡çº§ã€‚</p>
<h3 id="4-7-2-LongAdderæºç åˆ†æ"><a href="#4-7-2-LongAdderæºç åˆ†æ" class="headerlink" title="4.7.2 LongAdderæºç åˆ†æ"></a>4.7.2 LongAdderæºç åˆ†æ</h3><p>å…ˆè´´ä¸€ä¸‹å‰è¾ˆçš„ä¸»é¡µï¼š<a href="http://gee.cs.oswego.edu/">http://gee.cs.oswego.edu</a></p>
<p>ä½œä¸ºå¹¶å‘å¤§å¸ˆ@Doug lea çš„ä½œå“<code>LongAdder</code>ï¼Œå®ƒçš„è®¾è®¡éå¸¸ç²¾å·§ã€‚</p>
<p><code>LongAdder</code>ç±»æœ‰å‡ ä¸ªå…³é”®åŸŸï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç´¯åŠ å•å…ƒæ•°ç»„ï¼Œæ‡’æƒ°åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºç¡€å€¼ï¼Œå¦‚æœæ²¡æœ‰ç«äº‰ï¼Œåˆ™ç”¨CASç´¯åŠ è¿™ä¸ªåŸŸ</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> base;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨cellsåˆ›å»ºæˆ–è€…æ‰©å®¹æ—¶ï¼Œç½®ä¸º1ï¼Œè¡¨ç¤ºåŠ é”</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br></pre></td></tr></table></figure>



<h4 id="4-7-2-1-CASé”"><a href="#4-7-2-1-CASé”" class="headerlink" title="4.7.2.1 CASé”"></a>4.7.2.1 CASé”</h4><p>åˆ‡å‹¿ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Slf4j(topic &#x3D; &quot;LockCAS&quot;)</span><br><span class="line">public class LockCASDemo &#123;</span><br><span class="line">    &#x2F;&#x2F; 0è¡¨ç¤ºæ²¡åŠ é”</span><br><span class="line">    &#x2F;&#x2F; 1è¡¨ç¤ºåŠ äº†é”</span><br><span class="line">    private final AtomicInteger state &#x3D; new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">    private void lock() &#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            if (state.compareAndSet(0, 1)) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void unlock() &#123;</span><br><span class="line">        log.debug(&quot;unlock...&quot;);</span><br><span class="line">        state.set(0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-7-2-1-åŸç†ä¹‹ä¼ªå…±äº«"><a href="#4-7-2-1-åŸç†ä¹‹ä¼ªå…±äº«" class="headerlink" title="4.7.2.1 åŸç†ä¹‹ä¼ªå…±äº«"></a>4.7.2.1 åŸç†ä¹‹ä¼ªå…±äº«</h4><p>Cellå³ä¸ºç´¯åŠ å•å…ƒã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«ï¼ˆä¸€ä¸ªç¼“å­˜è¡Œå®¹çº³å¤šä¸ªCellå¯¹è±¡ï¼‰</span></span><br><span class="line"><span class="meta">@Sun</span>.misc.Contented</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Cell</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> value;</span><br><span class="line">    Cell(<span class="keyword">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ€é‡è¦çš„æ–¹æ³•ï¼Œç”¨CASæ–¹å¼è¿›è¡Œç´¯åŠ ï¼Œprevè¡¨ç¤ºæ—§å€¼ï¼Œnextè¡¨ç¤ºæ–°å€¼</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">cas</span><span class="params">(<span class="keyword">long</span> prev, <span class="keyword">long</span> next)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="keyword">this</span>, valueOffset, prev, next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»ç¼“å­˜è¯´èµ·ï¼Œç¼“å­˜ä¸å†…å­˜çš„é€Ÿåº¦æ¯”è¾ƒï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62265/image-20210427234550770.png" class="" title="image-20210427234550770"><br />

<table>
<thead>
<tr>
<th align="center">ä»CPUåˆ°</th>
<th align="center">å¤§çº¦éœ€è¦çš„æ—¶é’Ÿå‘¨æœŸ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">å¯„å­˜å™¨</td>
<td align="center">1 cycleï¼ˆ4GHzçš„CPUçº¦ä¸º0.25nsï¼‰</td>
</tr>
<tr>
<td align="center">L1</td>
<td align="center">3~4 cycle</td>
</tr>
<tr>
<td align="center">L2</td>
<td align="center">10~20 cycle</td>
</tr>
<tr>
<td align="center">L3</td>
<td align="center">40~45 cycle</td>
</tr>
<tr>
<td align="center">å†…å­˜</td>
<td align="center">120~240 cycle</td>
</tr>
</tbody></table>
<p>å› ä¸ºCPUä¸å†…å­˜çš„é€Ÿåº¦å·®å¼‚å¾ˆå¤§ï¼Œéœ€è¦é é¢„è¯»æ•°æ®è‡³ç¼“å­˜æ¥æå‡æ•ˆç‡ã€‚</p>
<p>è€Œç¼“å­˜ä»¥ç¼“å­˜è¡Œä¸ºå•ä½ï¼Œæ¯ä¸ªç¼“å­˜å¯¹åº”ç€ä¸€å—å†…å­˜ï¼Œä¸€èˆ¬æ˜¯64 byteï¼ˆ8ä¸ªlongï¼‰ã€‚</p>
<p>ç¼“å­˜çš„åŠ å…¥ä¼šé€ æˆæ•°æ®å‰¯æœ¬çš„äº§ç”Ÿï¼Œå³åŒä¸€ä»½æ•°æ®ä¼šç¼“å­˜åœ¨ä¸åŒæ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­ã€‚</p>
<p>CPUè¦ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¦‚æœæŸä¸ªCPUæ ¸å¿ƒæ›´æ”¹äº†æ•°æ®ï¼Œå…¶ä»–CPUæ ¸å¿ƒå¯¹åº”çš„æ•´ä¸ªç¼“å­˜è¡Œå¿…é¡»å¤±æ•ˆã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62265/image-20210428124344773.png" class="" title="image-20210428124344773"><br />

<p>å› ä¸ºCellæ˜¯æ•°ç»„å½¢å¼ï¼Œåœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œä¸€ä¸ªCellä¸º24å­—èŠ‚ï¼ˆ16å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ8å­—èŠ‚çš„valueï¼‰ï¼Œå› æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹2ä¸ªçš„Cellå¯¹è±¡ã€‚è¿™æ ·é—®é¢˜æ¥äº†ï¼›</p>
<ul>
<li>Core-0è¦ä¿®æ”¹Cell[0]</li>
<li>Core-1è¦ä¿®æ”¹Cell[1]</li>
</ul>
<p>æ— è®ºè°ä¿®æ”¹æˆåŠŸï¼Œéƒ½ä¼šå¯¼è‡´å¯¹æ–¹Coreçš„ç¼“å­˜è¡Œå¤±æ•ˆï¼Œæ¯”å¦‚Core-0ä¸­Cell[0] = 6000ï¼ŒCell[1] = 8000ã€‚è¦ç´¯åŠ Cell[0] = 6001ï¼ŒCell[1] = 8000ï¼Œè¿™æ—¶ä¼šè®©Core-1ç¼“å­˜è¡Œå¤±æ•ˆã€‚</p>
<p><code>@sun.misc.Contented</code>ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„åŸç†æ˜¯åœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„å‰åå„å¢åŠ 128å­—èŠ‚å¤§å°çš„paddingï¼Œä»è€Œè®©CPUå°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œï¼Œè¿™æ ·ï¼Œä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62265/image-20210428200500865.png" class="" title="image-20210428200500865"><br />



<h4 id="4-7-2-2-ä¸»è¦æ–¹æ³•"><a href="#4-7-2-2-ä¸»è¦æ–¹æ³•" class="headerlink" title="4.7.2.2 ä¸»è¦æ–¹æ³•"></a>4.7.2.2 ä¸»è¦æ–¹æ³•</h4><p><code>add</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">long</span> x)</span> </span>&#123;</span><br><span class="line">    Cell[] as; <span class="keyword">long</span> b, v; <span class="keyword">int</span> m; Cell a;</span><br><span class="line">    <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span>         <span class="comment">/* cellsæ˜¯å¦ä¸ºç©º */</span> </span><br><span class="line">        || !casBase(b = base, b + x) <span class="comment">/* cas baseç´¯åŠ ï¼ŒæˆåŠŸåˆ™ä¸ä¼šè¿›å…¥ifä»£ç å— */</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            (a = as[getProbe() &amp; m]) == <span class="keyword">null</span> || <span class="comment">/* å½“å‰çº¿ç¨‹cellæ˜¯å¦åˆ›å»º */</span></span><br><span class="line">            !(uncontended = a.cas(v = a.value, v + x))) <span class="comment">/* cas baseç´¯åŠ ï¼Œå¤±è´¥åˆ™è¿›å…¥ */</span></span><br><span class="line">            longAccumulate(x, <span class="keyword">null</span>, uncontended);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62265/image-20210428203546219.png" class="" title="image-20210428203546219"><br />



<p><code>longAccumulate</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">longAccumulate</span><span class="params">(<span class="keyword">long</span> x, LongBinaryOperator fn,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> wasUncontended)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        ThreadLocalRandom.current(); <span class="comment">// force initialization</span></span><br><span class="line">        h = getProbe();</span><br><span class="line">        wasUncontended = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> collide = <span class="keyword">false</span>;                <span class="comment">// True if last slot nonempty</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123; <span class="comment">// ä¸æ–­å°è¯•</span></span><br><span class="line">        Cell[] as; Cell a; <span class="keyword">int</span> n; <span class="keyword">long</span> v;</span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="keyword">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ï¼ˆ1ï¼‰cellså·²åˆ›å»ºï¼ŒCellæœªåˆ›å»º</span></span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;       <span class="comment">// å°è¯•è·å–cellsæ•°ç»„</span></span><br><span class="line">                    Cell r = <span class="keyword">new</span> Cell(x);   <span class="comment">// ä¹è§‚åˆ›å»ºCellå¯¹è±¡</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                        <span class="comment">// å½“å‰æ— äººä¸Šé”ï¼Œè‡ªå·±å°è¯•ä¸Šé”</span></span><br><span class="line">                        <span class="keyword">boolean</span> created = <span class="keyword">false</span>;  <span class="comment">// æ˜¯å¦å·²åˆ›å»º</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;               <span class="comment">// Recheck under lock</span></span><br><span class="line">                            Cell[] rs; <span class="keyword">int</span> m, j;</span><br><span class="line">                            <span class="keyword">if</span> ((rs = cells) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// å†æ¬¡æ£€æŸ¥æ•°ç»„æ•°ç»„ä¸ä¸ºç©ºä¸”é•¿åº¦å¤§äº0</span></span><br><span class="line">                                <span class="comment">// ä¸”æ•°ç»„ä¸­ç©ºç½®çš„æ§½ä½ä¸ºç©º</span></span><br><span class="line">                                rs[j] = r;  <span class="comment">// å°†åˆ›å»ºçš„æ–°çš„Cellå¯¹è±¡å¡«å……åˆ°æ•°ç»„çš„ç©ºæ§½ä½</span></span><br><span class="line">                                created = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;  <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (created)</span><br><span class="line">                            <span class="keyword">break</span>;          <span class="comment">// åˆ›å»ºæˆåŠŸåˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">                        <span class="keyword">continue</span>;           <span class="comment">// Slot is now non-empty</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ï¼ˆ2ï¼‰cellså·²åˆ›å»ºã€‚Cellå·²åˆ›å»º</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)       <span class="comment">// CAS already known to fail</span></span><br><span class="line">                wasUncontended = <span class="keyword">true</span>;      <span class="comment">// Continue after rehash</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="keyword">null</span>) ? v + x :</span><br><span class="line">                                         fn.applyAsLong(v, x))))</span><br><span class="line">                <span class="comment">// å¯¹ç´¯åŠ å•å…ƒaè¿›è¡ŒCAS+xï¼Œæ“ä½œæˆåŠŸåˆ™é€€å‡º</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)</span><br><span class="line">                <span class="comment">// æ£€æŸ¥å½“å‰næ˜¯å¦è¶…è¿‡æœºå™¨çš„CPUä¸Šé™</span></span><br><span class="line">                collide = <span class="keyword">false</span>;            <span class="comment">// At max size or stale</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)  </span><br><span class="line">                <span class="comment">// ä¸Šä¸ªæ¡ä»¶åŒ¹é…ä¹‹åï¼Œä¸‹æ¬¡å¾ªç¯å°±èµ°è¿™ä¸ªåˆ¤æ–­ï¼Œä¸ä¼šè¿›å…¥ä¸‹é¢çš„æ‰©å®¹é€»è¾‘</span></span><br><span class="line">                collide = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                <span class="comment">// æ‰©å®¹</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cells == as) &#123;      <span class="comment">// Expand table unless stale</span></span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> Cell[n &lt;&lt; <span class="number">1</span>];  <span class="comment">// å·¦ç§»ä¸€ä½ï¼Œæ‰©å®¹ä¸¤å€</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];  <span class="comment">// å°†æ—§æ•°ç»„æ‹·è´åˆ°æ–°æ•°ç»„</span></span><br><span class="line">                        cells = rs;         <span class="comment">// æ›¿æ¢cells</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">continue</span>;                   <span class="comment">// Retry with expanded table</span></span><br><span class="line">            &#125;</span><br><span class="line">            h = advanceProbe(h);  <span class="comment">// ä»¥ä¸Šæ¡ä»¶å‡ä¸åŒ¹é…ï¼Œæ”¹å˜çº¿ç¨‹å¯¹åº”çš„cellå¯¹è±¡</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">            <span class="comment">// ï¼ˆ3ï¼‰cellsæ•°ç»„æœªåˆ›å»ºï¼Œä¸‰ä¸ªæ¡ä»¶å¦‚ä¸‹</span></span><br><span class="line">            <span class="comment">// cellsBusyæ˜¯æ ‡è®°ä½ï¼Œ0ä»£è¡¨æœªåŠ é”ï¼Œ1ä»£è¡¨å·²åŠ é”</span></span><br><span class="line">            <span class="comment">// cells == asä»£è¡¨æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ”¹å˜cellsæ•°ç»„ï¼Œasæ˜¯ç¬¬ä¸€æ¬¡ifåˆ¤æ–­è¯»å–åˆ°çš„æ•°ç»„å¼•ç”¨</span></span><br><span class="line">            <span class="comment">// casCellsBusy()è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°è¯•é€šè¿‡CASå°†cellsBusyä»0æ”¹ä¸º1ï¼ŒæˆåŠŸè¯´æ˜åŠ é”æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">boolean</span> init = <span class="keyword">false</span>;             <span class="comment">// æ˜¯å¦åˆå§‹åŒ–</span></span><br><span class="line">            <span class="keyword">try</span> &#123;                             <span class="comment">// Initialize table</span></span><br><span class="line">                <span class="keyword">if</span> (cells == as) &#123;            <span class="comment">// å†æ¬¡åˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†cells</span></span><br><span class="line">                    Cell[] rs = <span class="keyword">new</span> Cell[<span class="number">2</span>];  <span class="comment">// åˆå§‹å¤§å°ä¸º2</span></span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> Cell(x);  <span class="comment">// èµ‹åˆå§‹å€¼1</span></span><br><span class="line">                    cells = rs;               <span class="comment">// å°†åˆšåˆšåˆ›å»ºçš„æ•°ç»„èµ‹å€¼ç»™æˆå‘˜å˜é‡</span></span><br><span class="line">                    init = <span class="keyword">true</span>;              </span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                cellsBusy = <span class="number">0</span>;                <span class="comment">// å°†æ ‡è®°ä½è®¾ä¸º0ï¼Œä»£è¡¨è§£é”</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (init)                         <span class="comment">// åˆå§‹åŒ–æˆåŠŸåˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;                           </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="keyword">null</span>) ? v + x :</span><br><span class="line">                                    fn.applyAsLong(v, x))))</span><br><span class="line">            <span class="comment">// åŠ é”å¤±è´¥ï¼Œè¿›è¡Œcas baseç´¯åŠ ï¼ŒæˆåŠŸåˆ™breakï¼Œå¤±è´¥åˆ™ç»§ç»­å¾ªç¯</span></span><br><span class="line">            <span class="keyword">break</span>;                          <span class="comment">// Fall back on using base</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62265/image-20210428211351713.png" class="" title="image-20210428211351713"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62265/image-20210428220931544.png" class="" title="image-20210428220931544"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62265/image-20210428204940662.png" class="" title="image-20210428204940662"><br />



<p><code>sum</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="keyword">long</span> sum = base;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123; <span class="comment">// åˆ¤ç©º</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>) <span class="comment">// å¯¹æ¯ä¸ªå…ƒç´ åˆ¤ç©º</span></span><br><span class="line">                sum += a.value;      <span class="comment">// ç´¯åŠ æ¯ä¸ªå•å…ƒå€¼</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-8-Unsafe"><a href="#4-8-Unsafe" class="headerlink" title="4.8 Unsafe"></a>4.8 Unsafe</h2><h3 id="4-8-1-æ¦‚è¿°"><a href="#4-8-1-æ¦‚è¿°" class="headerlink" title="4.8.1 æ¦‚è¿°"></a>4.8.1 æ¦‚è¿°</h3><p><code>Unsafe</code>å¯¹è±¡æä¾›äº†éå¸¸åº•å±‚çš„ï¼Œæ“ä½œå†…å­˜ã€çº¿ç¨‹çš„åŠæ³•ï¼Œ<code>Unsafe</code>å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾—ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeAccessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Unsafe unsafe;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field theUnsafe = Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            theUnsafe.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            unsafe = (Unsafe) theUnsafe.get(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Unsafe <span class="title">getUnsafe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-8-2-CASæ“ä½œ"><a href="#4-8-2-CASæ“ä½œ" class="headerlink" title="4.8.2 CASæ“ä½œ"></a>4.8.2 CASæ“ä½œ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException </span>&#123;</span><br><span class="line">        Unsafe unsafe = UnsafeAccessor.getUnsafe();</span><br><span class="line">        Field id = User.class.getDeclaredField(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        Field name = User.class.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å¾—åŸŸçš„åç§»åœ°å€</span></span><br><span class="line">        <span class="keyword">long</span> idOffset = unsafe.objectFieldOffset(id);</span><br><span class="line">        <span class="keyword">long</span> nameOffset = unsafe.objectFieldOffset(name);</span><br><span class="line">        <span class="comment">// ä½¿ç”¨CASæ–¹æ³•æ›¿æ¢æˆå‘˜å˜é‡</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        unsafe.compareAndSwapInt(user, idOffset, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        unsafe.compareAndSwapObject(user, nameOffset, <span class="keyword">null</span>, <span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">volatile</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> id; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123; <span class="keyword">this</span>.id = id; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">this</span>.name = name; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User[&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User[id=<span class="number">1</span>, name=<span class="string">&#x27;KHighness&#x27;</span>]</span><br></pre></td></tr></table></figure>



<h3 id="4-8-3-è‡ªå®šä¹‰åŸå­å®ç°ç±»"><a href="#4-8-3-è‡ªå®šä¹‰åŸå­å®ç°ç±»" class="headerlink" title="4.8.3 è‡ªå®šä¹‰åŸå­å®ç°ç±»"></a>4.8.3 è‡ªå®šä¹‰åŸå­å®ç°ç±»</h3><p>ä½¿ç”¨è‡ªå®šä¹‰çš„<code>AtomicData</code>å®ç°ä¹‹å‰çº¿ç¨‹å®‰å…¨çš„åŸå­æ•´æ•°<code>Account</code>å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KAtomicInteger</span> <span class="keyword">implements</span> <span class="title">Account</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe UNSAFE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        UNSAFE = UnsafeAccessor.getUnsafe();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            valueOffset = UNSAFE.objectFieldOffset(KAtomicInteger.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KAtomicInteger</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">(<span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> prev = <span class="keyword">this</span>.value;</span><br><span class="line">            <span class="keyword">int</span> next = prev - amount;</span><br><span class="line">            <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="keyword">this</span>, valueOffset, prev, next)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">geBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Integer amount)</span> </span>&#123;</span><br><span class="line">        decrement(amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-3(å…±äº«æ¨¡å‹ä¹‹å†…å­˜)</title>
    <url>/posts/37386/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>JMMå³Java Memory Modelï¼Œå®ƒå®šä¹‰äº†ä¸»å­˜ã€å·¥ä½œå†…å­˜æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€CPUå¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€CPUæŒ‡ä»¤ä¼˜åŒ–ç­‰ã€‚</p>
<p>JMMä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>åŸå­æ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“</li>
<li>å¯è§æ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—CPUç¼“å­˜çš„å½±å“</li>
<li>æœ‰åºæ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—CPUæŒ‡ä»¤å¹¶è¡Œä¼˜åŒ–çš„å½±å“</li>
</ul>
<h2 id="3-1-JMM"><a href="#3-1-JMM" class="headerlink" title="3.1 JMM"></a>3.1 JMM</h2><h3 id="3-1-1-JMMå†…å­˜æ¨¡å‹"><a href="#3-1-1-JMMå†…å­˜æ¨¡å‹" class="headerlink" title="3.1.1 JMMå†…å­˜æ¨¡å‹"></a>3.1.1 JMMå†…å­˜æ¨¡å‹</h3><p>Javaçº¿ç¨‹çš„é€šä¿¡ç”±JMMæ§åˆ¶ï¼ŒJMMçš„ä¸»è¦ç›®çš„æ˜¯å®šä¹‰ç¨‹åºä¸­å„ç§å˜é‡çš„è®¿é—®è§„åˆ™ã€‚å˜é‡åŒ…æ‹¬å®ä¾‹å­—æ®µã€é™æ€å­—æ®µï¼Œä½†ä¸åŒ…æ‹¬å±€éƒ¨å˜é‡ä¸æ–¹æ³•å‚æ•°ï¼Œå› ä¸ºå®ƒä»¬æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ã€‚</p>
<p>JMMéµå¾ªä¸€ä¸ªåŸºæœ¬åŸåˆ™ï¼šåªè¦ä¸æ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ€ä¹ˆä¼˜åŒ–éƒ½å¯ä»¥ã€‚</p>
<p>JMMè§„å®šæ‰€æœ‰å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼Œæ¯æ¡çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå·¥ä½œå†…å­˜ä¸­ä¿å­˜è¢«è¯¥çº¿ç¨‹ä½¿ç”¨çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œç©ºé—´è¿›è¡Œï¼Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜æ•°æ®ã€‚ä¸åŒçº¿ç¨‹é—´æ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œçº¿ç¨‹é€šä¿¡å¿…é¡»ç»è¿‡ä¸»å†…å­˜ã€‚</p>
<p>Javaå†…å­˜æ¨¡å‹è·ŸCPUç¼“å­˜æ¨¡å‹ç±»ä¼¼ï¼Œæ˜¯åŸºäºCPUç¼“å­˜æ¨¡å‹æ¥å»ºç«‹çš„ï¼ŒJavaçº¿ç¨‹å†…æ¨¡å‹æ˜¯æ ‡å‡†åŒ–çš„ï¼Œå±è”½äº†åº•å±‚ä¸åŒæ“ä½œç³»ç»Ÿçš„åŒºåˆ«ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥æ“ä½œä¸»å†…å­˜ï¼Œåœ¨è¯»å–çš„æ—¶å€™æŠŠä¸»å†…å­˜ä¸­çš„å…±äº«å˜é‡å¤åˆ¶åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ã€‚</p>
<p>å…³äºä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜çš„äº¤äº’ï¼Œå³å˜é‡å¦‚ä½•ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ã€ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ï¼ŒJMM å®šä¹‰äº† 8 ç§åŸå­æ“ä½œï¼š</p>
<table>
<thead>
<tr>
<th><strong>æ“ä½œ</strong></th>
<th><strong>ä½œç”¨å˜é‡èŒƒå›´</strong></th>
<th><strong>ä½œç”¨</strong></th>
</tr>
</thead>
<tbody><tr>
<td>lock</td>
<td>ä¸»å†…å­˜</td>
<td>æŠŠå˜é‡æ ‡è¯†ä¸ºçº¿ç¨‹ç‹¬å çŠ¶æ€</td>
</tr>
<tr>
<td>unlock</td>
<td>ä¸»å†…å­˜</td>
<td>é‡Šæ”¾å¤„äºé”å®šçŠ¶æ€çš„å˜é‡</td>
</tr>
<tr>
<td>read</td>
<td>ä¸»å†…å­˜</td>
<td>æŠŠå˜é‡å€¼ä»ä¸»å†…å­˜ä¼ åˆ°å·¥ä½œå†…å­˜</td>
</tr>
<tr>
<td>load</td>
<td>å·¥ä½œå†…å­˜</td>
<td>æŠŠ read å¾—åˆ°çš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬</td>
</tr>
<tr>
<td>user</td>
<td>å·¥ä½œå†…å­˜</td>
<td>æŠŠå·¥ä½œå†…å­˜ä¸­çš„å˜é‡å€¼ä¼ ç»™æ‰§è¡Œå¼•æ“</td>
</tr>
<tr>
<td>assign</td>
<td>å·¥ä½œå†…å­˜</td>
<td>æŠŠä»æ‰§è¡Œå¼•æ“æ¥æ”¶çš„å€¼èµ‹ç»™å·¥ä½œå†…å­˜å˜é‡</td>
</tr>
<tr>
<td>store</td>
<td>å·¥ä½œå†…å­˜</td>
<td>æŠŠå·¥ä½œå†…å­˜çš„å˜é‡å€¼ä¼ åˆ°ä¸»å†…å­˜</td>
</tr>
<tr>
<td>write</td>
<td>ä¸»å†…å­˜</td>
<td>æŠŠ store å–åˆ°çš„å˜é‡å€¼æ”¾å…¥ä¸»å†…å­˜å˜é‡ä¸­</td>
</tr>
</tbody></table>
<h3 id="3-1-2-as-if-serial"><a href="#3-1-2-as-if-serial" class="headerlink" title="3.1.2 as-if-serial"></a>3.1.2 as-if-serial</h3><p>ä¸ç®¡æ€ä¹ˆé‡æ’åºï¼Œå•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½æ”¹å˜ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¿…é¡»éµå¾ª as-if-serial è¯­ä¹‰ã€‚</p>
<p>ä¸ºäº†éµå¾ª as-if-serialï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œé‡æ’åºï¼Œå› ä¸ºè¿™ç§é‡æ’åºä¼šæ”¹å˜æ‰§è¡Œç»“æœã€‚ä½†æ˜¯å¦‚æœæ“ä½œä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œè¿™äº›æ“ä½œå°±å¯èƒ½è¢«ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºã€‚</p>
<p>as-if-serial æŠŠå•çº¿ç¨‹ç¨‹åºä¿æŠ¤èµ·æ¥ï¼Œç»™ç¨‹åºå‘˜ä¸€ç§å¹»è§‰ï¼šå•çº¿ç¨‹ç¨‹åºæ˜¯æŒ‰ç¨‹åºçš„é¡ºåºæ‰§è¡Œçš„ã€‚</p>
<h3 id="3-1-3-happens-before"><a href="#3-1-3-happens-before" class="headerlink" title="3.1.3 happens-before"></a>3.1.3 happens-before</h3><p>å…ˆè¡Œå‘ç”ŸåŸåˆ™ï¼ŒJMM å®šä¹‰çš„ä¸¤é¡¹æ“ä½œé—´çš„ååºå…³ç³»ï¼Œæ˜¯åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ç«äº‰çš„é‡è¦æ‰‹æ®µã€‚</p>
<p>JMM å°† happens-before è¦æ±‚ç¦æ­¢çš„é‡æ’åºæŒ‰æ˜¯å¦ä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœåˆ†ä¸ºä¸¤ç±»ã€‚å¯¹äºä¼šæ”¹å˜ç»“æœçš„é‡æ’åº JMM è¦æ±‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¿…é¡»ç¦æ­¢ï¼Œå¯¹äºä¸ä¼šæ”¹å˜ç»“æœçš„é‡æ’åºï¼ŒJMM ä¸åšè¦æ±‚ã€‚</p>
<p>JMM å­˜åœ¨ä¸€äº›å¤©ç„¶çš„ happens-before å…³ç³»ï¼Œæ— éœ€ä»»ä½•åŒæ­¥å™¨ååŠ©å°±å·²ç»å­˜åœ¨ã€‚å¦‚æœä¸¤ä¸ªæ“ä½œçš„å…³ç³»ä¸åœ¨æ­¤åˆ—ï¼Œå¹¶ä¸”æ— æ³•ä»è¿™äº›è§„åˆ™æ¨å¯¼å‡ºæ¥ï¼Œå®ƒä»¬å°±æ²¡æœ‰é¡ºåºæ€§ä¿éšœï¼Œè™šæ‹Ÿæœºå¯ä»¥å¯¹å®ƒä»¬éšæ„è¿›è¡Œé‡æ’åºã€‚</p>
<ul>
<li><p><strong>ç¨‹åºæ¬¡åºè§„åˆ™ï¼š</strong>ä¸€ä¸ªçº¿ç¨‹å†…å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢çš„ã€‚</p>
</li>
<li><p><strong>ç®¡ç¨‹é”å®šè§„åˆ™ï¼š</strong> unlock æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œã€‚</p>
</li>
<li><p><strong>volatile è§„åˆ™ï¼š</strong>å¯¹ volatile å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢çš„è¯»æ“ä½œã€‚</p>
</li>
<li><p><strong>çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼š</strong>çº¿ç¨‹çš„ start æ–¹æ³•å…ˆè¡Œå‘ç”Ÿäºçº¿ç¨‹çš„æ¯ä¸ªåŠ¨ä½œã€‚</p>
</li>
<li><p><strong>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼š</strong>çº¿ç¨‹ä¸­æ‰€æœ‰æ“ä½œå…ˆè¡Œå‘ç”Ÿäºå¯¹çº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ã€‚</p>
</li>
<li><p><strong>å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼š</strong>å¯¹è±¡çš„åˆå§‹åŒ–å…ˆè¡Œå‘ç”Ÿäº finalize æ–¹æ³•ã€‚</p>
</li>
<li><p><strong>ä¼ é€’æ€§ï¼š</strong>å¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œæ“ä½œ B å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œé‚£ä¹ˆæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ C ã€‚</p>
</li>
</ul>
<h2 id="3-2-å¯è§æ€§"><a href="#3-2-å¯è§æ€§" class="headerlink" title="3.2 å¯è§æ€§"></a>3.2 å¯è§æ€§</h2><h3 id="3-2-1-é€€ä¸å‡ºçš„å¾ªç¯"><a href="#3-2-1-é€€ä¸å‡ºçš„å¾ªç¯" class="headerlink" title="3.2.1 é€€ä¸å‡ºçš„å¾ªç¯"></a>3.2.1 é€€ä¸å‡ºçš„å¾ªç¯</h3><p>å…ˆçœ‹ä¸€ä¸ªç°è±¡ï¼Œmainçº¿ç¨‹å¯¹runå˜é‡çš„ä¿®æ”¹å¯¹äºtçº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº†tçº¿ç¨‹æ— æ³•åœæ­¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;While&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WhileDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> run = <span class="keyword">true</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (run) &#123; &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t&quot;</span>);</span><br><span class="line">        t.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        run = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-2-åˆ†æ"><a href="#3-2-2-åˆ†æ" class="headerlink" title="3.2.2 åˆ†æ"></a>3.2.2 åˆ†æ</h3><ol>
<li>åˆå§‹çŠ¶æ€ï¼Œtçº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº†runçš„å€¼åˆ°å·¥ä½œå†…å­˜ã€‚</li>
</ol>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37386/image-20210423224812159.png" class="" title="image-20210423224812159">

<ol start="2">
<li><p>å› ä¸ºtçº¿ç¨‹è¦é¢‘ç¹åœ°ä»ä¸»å†…å­˜ä¸­è¯»å–runçš„å€¼ï¼ŒJITç¼–è¯‘å™¨ä¼šå°†runçš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå‡å°‘å¯¹ä¸»å­˜ä¸­runçš„è®¿é—®ï¼Œæé«˜æ•ˆç‡ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37386/image-20210423225409195.png" class="" title="image-20210423225409195">
</li>
<li><p>1ç§’ä¹‹åï¼Œmainçº¿ç¨‹ä¿®æ”¹äº†runçš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œtæ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37386/image-20210423230248092.png" class="" title="image-20210423230248092">



</li>
</ol>
<h3 id="3-2-3-è§£å†³åŠæ³•"><a href="#3-2-3-è§£å†³åŠæ³•" class="headerlink" title="3.2.3 è§£å†³åŠæ³•"></a>3.2.3 è§£å†³åŠæ³•</h3><p>ï¼ˆ1ï¼‰ç»™å˜é‡<code>run</code>åŠ ä¸Šä¿®é¥°ç¬¦<code>volatile</code>ã€‚</p>
<p>å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ<code>volitale</code>å˜é‡éƒ½è¯´ç›´æ¥æ“ä½œä¸»å­˜ã€‚</p>
<p>ï¼ˆ2ï¼‰ä½¿ç”¨<code>synchronized</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;While&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WhileDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> run = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (run) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (lock) &#123; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t&quot;</span>);</span><br><span class="line">        t.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        run = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            run = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰åœ¨<code>while</code>å¾ªç¯ä¸­ä½¿ç”¨<code>System.out.println()</code>ä¹Ÿä¼šç»ˆæ­¢å¾ªç¯ï¼ŒåŸå› å¯ä»¥çœ‹<code>println()</code>çš„æºä»£ç ï¼Œå…¶ä¸­æ‰§è¡Œçš„æ˜¯<code>PrintStream#newLine()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">newLine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;  <span class="comment">// åŠ é”</span></span><br><span class="line">            ensureOpen();</span><br><span class="line">            textOut.newLine();</span><br><span class="line">            textOut.flushBuffer();</span><br><span class="line">            charOut.flushBuffer();</span><br><span class="line">            <span class="keyword">if</span> (autoFlush)</span><br><span class="line">                out.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InterruptedIOException x) &#123;</span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">        trouble = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-4-synchronized-volatile"><a href="#3-2-4-synchronized-volatile" class="headerlink" title="3.2.4 synchronized/volatile"></a>3.2.4 synchronized/volatile</h3><ul>
<li><code>synchronized</code>å¯ä»¥ä¿®é¥°å˜é‡å’Œæ–¹æ³•ï¼Œ<code>volatile</code>åªèƒ½ä¿®é¥°å˜é‡ã€‚</li>
<li><code>synchronized</code>ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œ<code>volatile</code>ä¿æŒå˜é‡çš„å¯è§æ€§ã€‚</li>
<li><code>synchronized</code>é€šå¸¸é€‚ç”¨äºå†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œ<code>volatile</code>é€šå¸¸é€‚ç”¨äºå†™å°‘è¯»å¤šçš„åœºæ™¯ã€‚</li>
</ul>
<h2 id="3-3-æ¨¡å¼"><a href="#3-3-æ¨¡å¼" class="headerlink" title="3.3 æ¨¡å¼"></a>3.3 æ¨¡å¼</h2><h3 id="3-3-1-ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼"><a href="#3-3-1-ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼" class="headerlink" title="3.3.1 ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼"></a>3.3.1 ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</h3><p>ä½¿ç”¨<code>volatile</code>å®ç°ä¸¤é˜¶æ®µç»ˆæ­¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TwoStageTerminationDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        TwoStageTermination tst = <span class="keyword">new</span> TwoStageTermination();</span><br><span class="line">        tst.start();</span><br><span class="line">        Thread.sleep(<span class="number">3500</span>);</span><br><span class="line">        tst.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;TwoStageTermination&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TwoStageTermination</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> Thread monitorThread;</span><br><span class="line">    <span class="comment">// æ˜¯å¦è¢«æ‰“æ–­</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        monitorThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Thread current = Thread.currentThread();</span><br><span class="line">                <span class="comment">// æ˜¯å¦è¢«æ‰“æ–­</span></span><br><span class="line">                <span class="keyword">if</span> (stop) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ–™ç†åäº‹&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    log.info(<span class="string">&quot;æ‰§è¡Œç›‘æ§...&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="comment">// ç¡çœ è¢«æ‰“æ–­è¢«æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œéœ€è¦é‡æ–°è®¾ç½®</span></span><br><span class="line">                    current.interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;monitor&quot;</span>);</span><br><span class="line">        monitorThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stop = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-3-2-åŒæ­¥æ¨¡å¼ä¹‹Balking"><a href="#3-3-2-åŒæ­¥æ¨¡å¼ä¹‹Balking" class="headerlink" title="3.3.2 åŒæ­¥æ¨¡å¼ä¹‹Balking"></a>3.3.2 åŒæ­¥æ¨¡å¼ä¹‹Balking</h3><p>Balkingï¼ˆçŠ¹è±«ï¼‰æ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹å°±æ— éœ€å†åšäº†ï¼Œç›´æ¥ç»“æŸè¿”å›ï¼Œå®é™…ä¸Šæ˜¯ä¸€ç§å•ä¾‹æ¨¡å¼ã€‚</p>
<p>ä¿®æ”¹ä¸¤é˜¶æ®µç»ˆæ­¢å¦‚ä¸‹ï¼Œç›‘æ§çº¿ç¨‹æ‰§è¡Œä¸€æ¬¡ä¹‹åå°±ä¸å†æ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BalkingTwoStageTerminationDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        BalkingTwoStageTermination btst = <span class="keyword">new</span> BalkingTwoStageTermination();</span><br><span class="line">        btst.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        btst.stop();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        btst.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        btst.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;BalkingTwoStageTermination&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BalkingTwoStageTermination</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> Thread monitorThread;</span><br><span class="line">    <span class="comment">// æ˜¯å¦è¢«æ‰“æ–­</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å·²æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (started) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            stop = <span class="keyword">false</span>;</span><br><span class="line">            started = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        monitorThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Thread current = Thread.currentThread();</span><br><span class="line">                <span class="comment">// æ˜¯å¦è¢«æ‰“æ–­</span></span><br><span class="line">                <span class="keyword">if</span> (stop) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;åœæ­¢ç›‘æ§&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">&quot;æ‰§è¡Œç›‘æ§...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;monitor&quot;</span>);</span><br><span class="line">        monitorThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æš‚åœ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stop = <span class="keyword">true</span>;</span><br><span class="line">        started = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-4-æœ‰åºæ€§"><a href="#3-4-æœ‰åºæ€§" class="headerlink" title="3.4 æœ‰åºæ€§"></a>3.4 æœ‰åºæ€§</h2><h3 id="3-4-1-æŒ‡ä»¤é‡æ’åº"><a href="#3-4-1-æŒ‡ä»¤é‡æ’åº" class="headerlink" title="3.4.1 æŒ‡ä»¤é‡æ’åº"></a>3.4.1 æŒ‡ä»¤é‡æ’åº</h3><p>JITå³æ—¶ç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŒ‡ä»¤é‡æ’ã€‚JVMä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œè°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚</p>
<p>ï¼ˆ1ï¼‰ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ“ä½œ</span></span><br><span class="line">i = <span class="number">0</span>;</span><br><span class="line">j = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>å¯¹äº<code>i</code>å’Œ<code>j</code>çš„èµ‹å€¼æ“ä½œé¡ºåºï¼Œå¯¹æœ€ç»ˆçš„ç»“æœéƒ½æ²¡æœ‰å½±å“ã€‚å› æ­¤åœ¨çœŸæ­£æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯èƒ½<code>i</code>ä¹Ÿå¯èƒ½æ˜¯<code>j</code>å…ˆè¢«èµ‹å€¼ã€‚ä½†æ˜¯åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æŒ‡ä»¤é‡æ’åºä¼šå½±å“æ­£ç¡®æ€§ã€‚</p>
<p>ï¼ˆ2ï¼‰æ¯”å¦‚<code>new</code>ä¸€ä¸ªå¯¹è±¡ï¼š                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ä¸€èˆ¬é¡ºåºä¸ºï¼ˆ1ï¼‰åˆ†é…å†…å­˜ï¼ˆ2ï¼‰å¯¹è±¡åˆå§‹åŒ–ï¼ˆ3ï¼‰å»ºç«‹æŒ‡é’ˆå¯¹åº”å…³ç³»ï¼Œé«˜å¹¶å‘æƒ…å†µä¸‹é¡ºåºå¯èƒ½ä¹±æˆ132ï¼Œå¯¹è±¡åˆå§‹åŒ–æ—¶å°±è¢«å¦ä¸€ä¸ªçº¿ç¨‹è¯»å–é€ æˆé—®é¢˜ã€‚</p>
<h3 id="3-4-2-è¯¡å¼‚çš„ç»“æœ"><a href="#3-4-2-è¯¡å¼‚çš„ç»“æœ" class="headerlink" title="3.4.2 è¯¡å¼‚çš„ç»“æœ"></a>3.4.2 è¯¡å¼‚çš„ç»“æœ</h3><p>åœ¨å¦‚ä¸‹ä»£ç ä¸­ï¼Œ<code>I_Result</code> æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§<code>r1</code>ç”¨æ¥ä¿å­˜ç»“æœã€‚</p>
<p>çº¿ç¨‹1æ‰§è¡Œ<code>actor1</code>æ–¹æ³•ï¼Œçº¿ç¨‹2æ‰§è¡Œ<code>actor2</code>æ–¹æ³•ï¼Œæ€è€ƒ<code>r1</code>çš„å¯èƒ½ç»“æœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">boolean</span> ready = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actor1</span><span class="params">(I_Result r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ready) &#123;</span><br><span class="line">        r.r1 = num + num;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.r1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actor2</span><span class="params">(I_Result r)</span> </span>&#123;</span><br><span class="line">    num = <span class="number">2</span>;</span><br><span class="line">    ready = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>çº¿ç¨‹1å…ˆæ‰§è¡Œï¼Œçº¿ç¨‹2åæ‰§è¡Œï¼Œæ­¤æ—¶ç»“æœä¸º1</li>
<li>çº¿ç¨‹2å…ˆæ‰§è¡Œï¼Œçº¿ç¨‹1åæ‰§è¡Œï¼Œæ­¤æ—¶ç»“æœä¸º4</li>
<li>çº¿ç¨‹2å…ˆæ‰§è¡Œï¼Œæ‰§è¡Œåˆ°<code>num = 2</code>ï¼Œçº¿ç¨‹1å¼€å§‹æ‰§è¡Œï¼Œæ­¤æ—¶ç»“æœä¸º1</li>
<li>çº¿ç¨‹2å…ˆæ‰§è¡Œï¼Œä½†æ˜¯æŒ‡ä»¤é‡æ’ï¼Œå…ˆæ‰§è¡Œ<code>ready = true</code>ï¼Œçº¿ç¨‹1å¼€å§‹æ‰§è¡Œï¼Œè¿›å…¥<code>if (ready)</code>ï¼Œæ­¤æ—¶ç»“æœä¸º2</li>
</ol>
<p>è§£å†³æ–¹æ³•ï¼šç»™<code>ready</code>åŠ ä¸Šä¿®å¤ç¬¦<code>volatile</code>ã€‚</p>
<h3 id="3-4-3-é‡æ’åºè§„åˆ™"><a href="#3-4-3-é‡æ’åºè§„åˆ™" class="headerlink" title="3.4.3 é‡æ’åºè§„åˆ™"></a>3.4.3 é‡æ’åºè§„åˆ™</h3><ul>
<li>æŒ‡ä»¤é‡æ’åºä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œè¿›è¡Œé‡æ’åºã€‚æ¯”å¦‚ï¼š<code>a= 1; b = a;</code>ã€‚</li>
<li>é‡æ’åºæ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œä½†æ˜¯ä¸ç®¡å¦‚ä½•é‡æ’ï¼Œå•çº¿ç¨‹ä¸‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½æ”¹å˜ã€‚</li>
<li>æŒ‡ä»¤é‡æ’åºä¿è¯å•çº¿ç¨‹æ¨¡å¼ä¸‹çš„ç»“æœæ­£ç¡®æ€§ï¼Œä½†æ˜¯ä¸ä¿è¯å¤šçº¿ç¨‹æ¨¡å¼ä¸‹çš„æ­£ç¡®æ€§ã€‚</li>
<li>è§£å†³æ–¹æ³•ï¼š<code>volatile</code>ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ã€‚</li>
</ul>
<h2 id="3-5-volatileåŸç†"><a href="#3-5-volatileåŸç†" class="headerlink" title="3.5 volatileåŸç†"></a>3.5 volatileåŸç†</h2><h3 id="3-5-1-double-checked-locking"><a href="#3-5-1-double-checked-locking" class="headerlink" title="3.5.1 double-checked locking"></a>3.5.1 double-checked locking</h3><p>ä»¥è‘—åçš„DCL(double-checked locking)å•ä¾‹æ¨¡å¼ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DCLSingleton</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DCLSingleton</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DCLSingleton INSTANCE = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨ç¬¬ä¸€æ¬¡çº¿ç¨‹è°ƒç”¨getInstance()ï¼Œç›´æ¥åœ¨synchronizedå¤–ï¼Œåˆ¤æ–­instanceå¯¹è±¡æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">     * å¦‚æœä¸å­˜åœ¨ï¼Œæ‰ä¼šå»è·å–é”ï¼Œç„¶ååˆ›å»ºå•ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”è¿”å›ï¼›ç¬¬äºŒä¸ªçº¿ç¨‹è°ƒç”¨getInstance()ï¼Œ</span></span><br><span class="line"><span class="comment">     * ä¼šè¿›è¡Œinstanceçš„ç©ºåˆ¤æ–­ï¼Œå¦‚æœå·²ç»æœ‰å•ä¾‹å¯¹è±¡å°±ä¸ä¼šå»åŒæ­¥å—ä¸­è·å–é”ï¼Œæé«˜æ•ˆç‡ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DCLSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿™ä¸ªåˆ¤æ–­å¹¶ä¸åœ¨synchronizedåŒæ­¥ä»£ç å—ä¸­ï¼Œ</span></span><br><span class="line">            <span class="comment">// ä¸èƒ½ä¿è¯åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œå¯èƒ½å¯¼è‡´æŒ‡ä»¤é‡æ’</span></span><br><span class="line">            <span class="keyword">synchronized</span> (DCLSingleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> DCLSingleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šå®ç°çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å»¶è¿Ÿå®ä¾‹åŒ–</li>
<li>é¦–æ¬¡ä½¿ç”¨<code>getInstance()</code>æ‰ä½¿ç”¨<code>synchronbized</code>åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”ã€‚</li>
<li>æœ‰éšå«çš„ï¼Œä½†å¾ˆå…³é”®çš„ä¸€ç‚¹ï¼šç¬¬ä¸€ä¸ª<code>if</code>ä½¿ç”¨äº†<code>INSTANCE</code>å˜é‡ï¼Œæ˜¯åœ¨åŒæ­¥å—ä¹‹å¤–ã€‚</li>
</ul>
<p>ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œ<code>getInstance()</code>æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> 0 getstatic #2 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton.INSTANCE&gt;  # è·å–é™æ€å˜é‡INSTANCE</span><br><span class="line"> 3 ifnonnull 37 (+34)                                  # åˆ¤æ–­INSTANCEæ˜¯å¦ä¸ºç©º</span><br><span class="line"> 6 ldc #3 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton&gt;                 # ä»è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å°†DCLSingetonçš„classå¯¹è±¡æ¨å…¥æ“ä½œæ•°æ ˆ</span><br><span class="line"> 8 dup                                                 # å¤åˆ¶æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å€¼ï¼Œå³DCLSingletonçš„classå¯¹è±¡</span><br><span class="line"> 9 astore_0                                            # å°†DCLSingletonçš„classå¯¹è±¡å­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º0çš„ä½ç½®</span><br><span class="line">10 monitorenter                                        # è¿›å…¥INSTANCEå¯¹è±¡çš„monitor</span><br><span class="line">11 getstatic #2 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton.INSTANCE&gt;  # è·å–é™æ€å˜é‡INSTANCE</span><br><span class="line">14 ifnonnull 27 (+13)                                  # åˆ¤æ–­INSTANCEæ˜¯å¦ä¸ºç©º</span><br><span class="line">17 new #3 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton&gt;                 # newä¸€ä¸ªDCLSingleton</span><br><span class="line">20 dup                                                 # å¤åˆ¶æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å€¼ï¼Œå³DCLSingletonçš„classå¯¹è±¡</span><br><span class="line">21 invokespecial #4 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton.&lt;init&gt;&gt;# è°ƒç”¨DCLSingetonçš„æ„é€ æ–¹æ³•</span><br><span class="line">24 putstatic #2 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton.INSTANCE&gt;  # å°†æ–°å¯¹è±¡èµ‹å€¼ç»™é™æ€å˜é‡INSTANCE</span><br><span class="line">27 aload_0                                             # ä»å±€éƒ¨å˜é‡è¡¨å¯¼å‡ºç´¢å¼•ä¸º0ä½ç½®çš„å…ƒç´ </span><br><span class="line">28 monitorexit                                         # é€€å‡ºINSTANCEå¯¹è±¡çš„monitor</span><br><span class="line">29 goto 37 (+8)                                        # goto37è¡Œå¤„ç†</span><br><span class="line">32 astore_1                                            # 32-35æ˜¯å¼‚å¸¸</span><br><span class="line">33 aload_0</span><br><span class="line">34 monitorexit</span><br><span class="line">35 aload_1</span><br><span class="line">36 athrow</span><br><span class="line">37 getstatic #2 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton.INSTANCE&gt; # è·å–é™æ€å˜é‡INSTANCE</span><br><span class="line">40 areturn</span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹å…³æ³¨17-24è¡Œï¼š</p>
<ul>
<li>17ï¼šåˆ›å»º<code>DCLSingleton</code>å¯¹è±¡</li>
<li>20ï¼šå¤åˆ¶<code>DCLSingleton</code>çš„classå¯¹è±¡</li>
<li>21ï¼šè°ƒç”¨classå¯¹è±¡çš„é»˜è®¤æ„é€ æ–¹æ³•</li>
<li>24ï¼šå°†æ–°å¯¹è±¡èµ‹å€¼ç»™é™æ€å˜é‡<code>INSTANCE</code></li>
</ul>
<p>ä¹Ÿè®¸JVMä¼šä¼˜åŒ–ä¸ºï¼šå…ˆæ‰§è¡Œ24ï¼Œå†æ‰§è¡Œ21ï¼Œå³å…ˆèµ‹å€¼ï¼Œå†è°ƒæ„é€ ã€‚</p>
<p>å¯èƒ½é€ æˆï¼šä¸€ä¸ªçº¿ç¨‹æ­£åœ¨é€ å¯¹è±¡ï¼Œå¯¹è±¡è¿˜ä¸ºç©ºçš„æ—¶å€™å°±è¢«å¦ä¸€çº¿ç¨‹æ‹¿å»ä½¿ç”¨ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DCLSingleton</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DCLSingleton</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> DCLSingleton INSTANCE = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DCLSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (DCLSingleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> DCLSingleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»å­—èŠ‚ç ä¸Šçœ‹ä¸å‡ºvolatileçš„æ•ˆæœï¼Œä½†æ˜¯æˆ‘ä»¬ä»å±éšœçš„è§’åº¦åˆ†æï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> # &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; åŠ å…¥å¯¹INSTANCEçš„è¯»å±éšœ</span><br><span class="line"> # ä¿è¯æ­¤åçš„è¯»å–ï¼ŒåŠ è½½çš„éƒ½æ˜¯ä¸»å­˜ä¸­çš„æœ€æ–°æ•°æ®</span><br><span class="line"> 0 getstatic #2 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton.INSTANCE&gt;</span><br><span class="line"> 3 ifnonnull 37 (+34)</span><br><span class="line"> 6 ldc #3 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton&gt;</span><br><span class="line"> 8 dup</span><br><span class="line"> 9 astore_0</span><br><span class="line">10 monitorenter # &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; ä¿è¯åŸå­æ€§å’Œå¯è§æ€§</span><br><span class="line">11 getstatic #2 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton.INSTANCE&gt;</span><br><span class="line">14 ifnonnull 27 (+13)</span><br><span class="line">17 new #3 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton&gt;</span><br><span class="line">20 dup</span><br><span class="line">21 invokespecial #4 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton.&lt;init&gt;&gt;</span><br><span class="line">24 putstatic #2 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton.INSTANCE&gt;</span><br><span class="line"> # &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; åŠ å…¥å¯¹INSTANCEçš„å†™å±éšœ</span><br><span class="line"> # ä¿è¯æ­¤å‰çš„å†™å…¥ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</span><br><span class="line">27 aload_0</span><br><span class="line">28 monitorexit  # &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; ä¿è¯åŸå­æ€§å’Œå¯è§æ€§</span><br><span class="line">29 goto 37 (+8)</span><br><span class="line">32 astore_1</span><br><span class="line">33 aload_0</span><br><span class="line">34 monitorexit</span><br><span class="line">35 aload_1</span><br><span class="line">36 athrow</span><br><span class="line">37 getstatic #2 &lt;top&#x2F;parak&#x2F;jmm&#x2F;DCLSingleton.INSTANCE&gt;</span><br><span class="line">40 areturn</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37386/image-20210425100017250.png" class="" title="image-20210425100017250">



<h3 id="3-5-2-ç¼“å­˜ä¸€è‡´æ€§åè®®"><a href="#3-5-2-ç¼“å­˜ä¸€è‡´æ€§åè®®" class="headerlink" title="3.5.2 ç¼“å­˜ä¸€è‡´æ€§åè®®"></a>3.5.2 ç¼“å­˜ä¸€è‡´æ€§åè®®</h3><p>Intelå¤„ç†å™¨å¯¹åº”çš„ç¼“å­˜ä¸€è‡´æ€§åè®®ä¸ºMESIã€‚</p>
<p>CPUç¼“å­˜è¡Œå­˜åœ¨å››ç§çŠ¶æ€ï¼š</p>
<table>
<thead>
<tr>
<th>çŠ¶æ€</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>M(modifed)</td>
<td>ç¼“å­˜è¡Œæœ‰æ•ˆï¼Œæ•°æ®è¢«ä¿®æ”¹ï¼Œä¸å†…å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´ï¼Œæ•°æ®åªå­˜åœ¨äºè¯¥CPUç¼“å­˜è¡Œä¸­ã€‚</td>
</tr>
<tr>
<td>E(exclusive)</td>
<td>ç¼“å­˜è¡Œæœ‰æ•ˆï¼Œæ•°æ®ä¸å†…å­˜ä¸­çš„æ•°æ®ä¸€è‡´ï¼Œæ•°æ®åªå­˜åœ¨äºè¯¥CPUç¼“å­˜è¡Œä¸­ã€‚</td>
</tr>
<tr>
<td>S(shared)</td>
<td>ç¼“å­˜è¡Œæœ‰æ•ˆï¼Œæ•°æ®ä¸å†…å­˜ä¸­çš„æ•°æ®ä¸€è‡´ï¼Œæ•°æ®å­˜åœ¨äºå¾ˆå¤šCPUç¼“å­˜è¡Œä¸­ã€‚</td>
</tr>
<tr>
<td>I(invalid)ï¼š</td>
<td>ç¼“å­˜è¡Œæ— æ•ˆã€‚</td>
</tr>
</tbody></table>
<p>ç¼“å­˜ä¸€è‡´æ€§åè®®éœ€è¦ä¸å¤šå¤„ç†å™¨çš„æ€»çº¿å—…æ¢æœºåˆ¶ç»“åˆä½¿ç”¨ã€‚</p>
<p>å¼€å¯äº†ç¼“å­˜ä¸€è‡´æ€§åè®®åï¼Œå¤„ç†å™¨éœ€è¦å¯¹æ€»çº¿è¿›è¡Œå—…æ¢ï¼Œç›‘å¬æ€»çº¿ä¸­è¿™ä¸ªå¤„ç†å™¨æ‰€æ„Ÿå…´è¶£çš„æ•°æ®ã€‚</p>
<p>å¦‚æœä¸»å†…å­˜ä¸­æ‰€æ„Ÿå…´è¶£çš„æ•°æ®è¢«å…¶ä»–å¤„ç†å™¨ä¿®æ”¹ï¼Œé‚£ä¹ˆçº¿ç¨‹å·¥ä½œå†…å­˜ä¸­çš„å¯¹åº”æ•°æ®ä¼šè¢«ç«‹å³å¤±æ•ˆã€‚</p>
<h3 id="3-5-3-å®ç°å¯è§æ€§åŸç†"><a href="#3-5-3-å®ç°å¯è§æ€§åŸç†" class="headerlink" title="3.5.3 å®ç°å¯è§æ€§åŸç†"></a>3.5.3 å®ç°å¯è§æ€§åŸç†</h3><p>JVMä¸­volatileéœ€è¦å®ç°çš„å†…å­˜å±éšœï¼Œåœ¨æºä»£ç bytecodeInterpreterä¸­å®ç°ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">OrderAccess:storeload();</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•æ ¹æ®æ“ä½œç³»ç»Ÿå’ŒCPUçš„ä¸åŒä¼šæœ‰ä¸åŒçš„å®ç°ï¼ˆè·¨å¹³å°å°±æ˜¯å®ç°äº†ä¸åŒå¹³å°çš„æŒ‡ä»¤é›†çš„å±è”½ï¼‰ï¼Œæ¯”å¦‚Linux_X86çš„å®ç°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">OrderAccess::storeload</span><span class="params">()</span> </span>&#123; fence(); &#125;</span><br></pre></td></tr></table></figure>

<p><code>fence</code>çš„å®ç°è°ƒç”¨æ±‡ç¼–æŒ‡ä»¤ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">OrderAccess::fence</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> 	<span class="keyword">if</span> (os::is_MP()) &#123; <span class="comment">// åˆ¤æ–­æ˜¯å¦å¤šæ ¸å¤„ç†å™¨ï¼Œå¦‚æœæ˜¯æ‰æœ‰å¿…è¦å¢åŠ å†…å­˜å±éšœ</span></span><br><span class="line">        <span class="comment">// always use locked addl since mfence is sometimes expensive</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> AMD64</span></span><br><span class="line">        <span class="comment">// __asm__ volatileåµŒå…¥æ±‡ç¼–æŒ‡ä»¤</span></span><br><span class="line">        <span class="function">__asm__ <span class="title">volatile</span> <span class="params">(<span class="string">&quot;lock; addl $0, 0(%%rsp)&quot;</span> : : : <span class="string">&quot;cc&quot;</span>, <span class="string">&quot;memory&quot;</span>)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> </span></span><br><span class="line">        <span class="function">__asm__ <span class="title">volatile</span> <span class="params">(<span class="string">&quot;lock; addl $0, 0(%%esp)&quot;</span> : : : <span class="string">&quot;cc&quot;</span>, <span class="string">&quot;memory&quot;</span>)</span></span>; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>lock</code>å‰ç¼€æŒ‡ä»¤åœ¨å¤šæ ¸å¤„ç†å™¨ä¸‹ä¼šå¼•å‘ä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>å°†å½“å‰CPUç¼“å­˜è¡Œçš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜ã€‚</li>
<li>è¿™ä¸ªå†™å›å†…å­˜çš„æ“ä½œä¼šä½¿åœ¨å…¶ä»–CPUé‡Œç¼“å­˜äº†è¯¥å†…å­˜åœ°å€çš„æ•°æ®æ— æ•ˆã€‚</li>
</ol>
<p>ä¸ºäº†æé«˜æé«˜å¤„ç†é€Ÿåº¦ï¼ŒCPUä¸ç›´æ¥å’Œå†…å­˜è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯å…ˆå°†ç³»ç»Ÿå†…å­˜çš„æ•°æ®è¯»åˆ°å†…éƒ¨ç¼“å­˜ï¼ˆL1ã€L2æˆ–è€…L3ï¼‰åå†è¿›è¡Œæ“ä½œï¼Œä½†æ“ä½œå®Œä¸çŸ¥é“ä½•æ—¶ä¼šå†™åˆ°å†…å­˜ã€‚å¦‚æœå¯¹å£°æ˜äº†volatileçš„å˜é‡è¿›è¡Œå†™æ“ä½œï¼ŒJVMå°±ä¼šå‘CPUå‘é€Lockå‰ç¼€çš„æŒ‡ä»¤ï¼Œå°†è¿™ä¸ªå˜é‡æ‰€åœ¨ç¼“å­˜è¡Œçš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜ã€‚ä½†æ˜¯ï¼Œå°±ç®—å†™å›åˆ°å†…å­˜ï¼Œå¦‚æœå…¶ä»–CPUç¼“å­˜çš„å€¼è¿˜æ˜¯æ—§çš„ï¼Œå†æ‰§è¡Œè®¡ç®—æ“ä½œå°±ä¼šæœ‰é—®é¢˜ã€‚æ‰€ä»¥ï¼Œåœ¨å¤šæ ¸å¤„ç†å™¨ä¸‹ï¼Œä¸ºäº†ä¿è¯å„ä¸ªCPUçš„ç¼“å­˜æ˜¯ä¸€è‡´çš„ï¼Œå°±ä¼šå®ç°ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œæ¯ä¸ªCPUé€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜çš„å€¼æ˜¯å¦è¿‡æœŸï¼Œå½“CPUå‘ç°è‡ªå·±ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€è¢«ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰CPUçš„ç¼“å­˜è¡Œè®¾ç½®æˆæ— æ•ˆçŠ¶æ€ï¼Œå½“CPUå¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šé‡æ–°ä»ç³»ç»Ÿå†…å­˜ä¸­æŠŠæ•°æ®è¯»åˆ°CPUç¼“å­˜é‡Œã€‚</p>
<p>1ï¼‰Lockå‰ç¼€æŒ‡ä»¤ä¼šå¼•èµ·CPUç¼“å­˜å›å†™åˆ°å†…å­˜ã€‚</p>
<p>Lockå‰ç¼€æŒ‡ä»¤å¯¼è‡´åœ¨æ‰§è¡ŒæŒ‡ä»¤æœŸé—´ï¼Œå£°è¨€CPUçš„LOCK#ä¿¡å·ã€‚åœ¨å¤šæ ¸å¤„ç†å™¨ç¯å¢ƒä¸­ï¼ŒLOCK#ä¿¡å·ç¡®ä¿åœ¨å£°è¨€è¯¥ä¿¡å·æœŸé—´ï¼ŒCPUå¯ä»¥ç‹¬å ä»»ä½•å…±äº«å†…å­˜ã€‚ä½†æ˜¯ï¼Œåœ¨æœ€è¿‘çš„å¤„ç†å™¨é‡Œï¼ŒLOCK#ä¿¡å·ä¸€èˆ¬ä¸é”æ€»çº¿ï¼Œè€Œæ˜¯é”ç¼“å­˜ï¼Œæ¯•ç«Ÿé”æ€»çº¿å¼€é”€çš„æ¯”è¾ƒå¤§ã€‚</p>
<p>å¯¹äºIntel486å’ŒPentiumå¤„ç†å™¨ï¼Œåœ¨é”æ“ä½œæ—¶ï¼Œæ€»æ˜¯åœ¨æ€»çº¿ä¸Šå£°è¨€LOCK#ä¿¡å·ã€‚ä½†åœ¨P6å’Œç›®å‰çš„å¤„ç†å™¨ä¸­ï¼Œå¦‚æœè®¿é—®çš„å†…å­˜åŒºåŸŸå·²ç»ç¼“å­˜åœ¨CPUå†…éƒ¨ï¼Œåˆ™ä¸ä¼šå£°éŸ³LOCK#ä¿¡å·ã€‚ç›¸åï¼Œå®ƒä¼šé”å®šè¿™å—å†…å­˜åŒºåŸŸçš„ç¼“å­˜å¹¶å›å†™åˆ°å†…å­˜ï¼Œå¹¶ä½¿ç”¨ç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶æ¥ç¡®ä¿ä¿®æ”¹çš„åŸå­æ€§ï¼Œæ­¤æ“ä½œè¢«æˆä¸ºâ€œç¼“å­˜é”å®šâ€ï¼Œç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶ä¼šé˜»æ­¢åŒæ—¶ä¿®æ”¹ä¸¤ä¸ªä»¥ä¸ŠCPUç¼“å­˜çš„å†…å­˜åŒºåŸŸæ•°æ®ã€‚</p>
<p>2ï¼‰ä¸€ä¸ªCPUçš„ç¼“å­˜å›å†™åˆ°å†…å­˜ä¼šå¯¼è‡´å…¶ä»–CPUçš„ç¼“å­˜å¤±æ•ˆã€‚</p>
<p>IA-32å¤„ç†å™¨å’ŒIntel 64å¤„ç†å™¨ä½¿ç”¨MESIæ§åˆ¶åè®®å»ç»´æŠ¤å†…å­˜ç¼“å­˜å’Œå…¶ä»–CPUç¼“å­˜çš„ä¸€è‡´æ€§ã€‚åœ¨å¤šæ ¸å¤„ç†å™¨ç³»ç»Ÿä¸­è¿›è¡Œæ“ä½œçš„æ—¶å€™ï¼ŒIA-32å’ŒIntel 64å¤„ç†å™¨èƒ½å—…æ¢å…¶ä»–å¤„ç†å™¨è®¿é—®ç³»ç»Ÿå†…å­˜å’Œå®ƒä»¬çš„å†…éƒ¨ç¼“å­˜ã€‚CPUé€šè¿‡å—…æ¢æŠ€æœ¯ä¿è¯å®ƒçš„å†…éƒ¨ç¼“å­˜ã€ç³»ç»Ÿå†…å­˜å’Œå…¶ä»–å¤„ç†å™¨çš„ç¼“å­˜çš„æ•°æ®åœ¨æ€»çº¿ä¸Šä¿æŒä¸€è‡´ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨Pentiumå’ŒP6 familyå¤„ç†å™¨ä¸­ï¼Œå¦‚æœé€šè¿‡å—…æ¢ä¸€ä¸ªCPUæ¥æ£€æµ‹å…¶ä»–CPUæ‰“ç®—å†™å†…å­˜åœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€å½“å‰å¤„äºå…±äº«çŠ¶æ€ï¼Œé‚£ä¹ˆæ­£åœ¨å—…æ¢çš„å¤„ç†å™¨å°†ä½¿å®ƒçš„ç¼“å­˜è¡Œæ— æ•ˆï¼Œåœ¨ä¸‹æ¬¡è®¿é—®ç›¸åŒå†…å­˜åœ°å€æ—¶ï¼Œå¼ºåˆ¶æ‰§è¡Œç¼“å­˜è¡Œå¡«å……ã€‚</p>
<h3 id="3-5-4-å®ç°æœ‰åºæ€§åŸç†"><a href="#3-5-4-å®ç°æœ‰åºæ€§åŸç†" class="headerlink" title="3.5.4 å®ç°æœ‰åºæ€§åŸç†"></a>3.5.4 å®ç°æœ‰åºæ€§åŸç†</h3><p>ä¸ºäº†å®ç°volatileçš„å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ä¼šé€šè¿‡æ’å…¥å†…å­˜å±éšœæ¥ç¦æ­¢æŒ‡ä»¤é‡æ’åºã€‚</p>
<p>å†…å­˜å±éšœï¼šå†…å­˜å±éšœæ˜¯ä¸€ç§CPUæŒ‡ä»¤ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¯¹è¯¥æŒ‡ä»¤å‰å’ŒæŒ‡ä»¤åçš„ä¸€äº›æ“ä½œäº§ç”Ÿä¸€å®šçš„çº¦æŸï¼Œä¿è¯ä¸€äº›æ“ä½œæŒ‰é¡ºåºæ‰§è¡Œã€‚</p>
<p>æ’å…¥å†…å­˜å±éšœçš„ç­–ç•¥ï¼š</p>
<table>
<thead>
<tr>
<th><strong>å±éšœç±»å‹</strong></th>
<th><strong>æŒ‡ä»¤ç¤ºä¾‹</strong></th>
<th><strong>è¯´æ˜</strong></th>
</tr>
</thead>
<tbody><tr>
<td>LoadLoad Barriers</td>
<td>Load1;LoadLoad;Load2</td>
<td>ä¿è¯Load1æ•°æ®çš„è¯»å–å…ˆäºLoad2åŠåç»­æ‰€æœ‰è¯»å–æŒ‡ä»¤çš„æ‰§è¡Œ</td>
</tr>
<tr>
<td>StoreStore Barriers</td>
<td>Store1;StoreStore;Store2</td>
<td>ä¿è¯Store1æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜å…ˆäºStore2åŠåç»­æ‰€æœ‰å­˜å‚¨æŒ‡ä»¤</td>
</tr>
<tr>
<td>LoadStore Barriers</td>
<td>Load1;LoadStore;Store2</td>
<td>ä¿è¯Load1æ•°æ®çš„è¯»å–å…ˆäºStore2åŠåç»­çš„æ‰€æœ‰å­˜å‚¨æŒ‡ä»¤åˆ·æ–°åˆ°ä¸»å†…å­˜</td>
</tr>
<tr>
<td>StoreLoad Barriers</td>
<td>Store1;StoreLoad;Load2</td>
<td>ä¿è¯Store1æ•°æ®åˆ·æ–°åˆ°ä¸»å†…å­˜å…ˆäºLoad2åŠåç»­æ‰€æœ‰è¯»å–æŒ‡ä»¤çš„æ‰§è¡Œ</td>
</tr>
</tbody></table>
<p>Javaå†…å­˜æ¨¡å‹å¯¹ç¼–è¯‘å™¨æŒ‡å®šçš„volatileé‡æ’åºè§„åˆ™ä¸ºï¼š</p>
<ul>
<li><p>å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileè¯»æ—¶ï¼Œæ— è®ºç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆéƒ½ä¸èƒ½è¿›è¡Œé‡æ’åºï¼›</p>
</li>
<li><p>å½“ç¬¬äºŒä¸ªæ“ä½œæ˜¯volatileå†™æ—¶ï¼Œæ— è®ºç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆéƒ½ä¸èƒ½è¿›è¡Œé‡æ’åºï¼›</p>
</li>
<li><p>å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯volatileå†™æ—¶ï¼Œç¬¬äºŒä¸ªæ“ä½œä¸ºvolatileè¯»æ—¶ï¼Œä¸èƒ½è¿›è¡Œé‡æ’åºã€‚</p>
</li>
</ul>
<p>volatileè¯»ï¼šåœ¨æ¯ä¸ªvolatileè¯»åé¢åˆ†åˆ«æ’å…¥LoadLoadå±éšœåŠLoadStoreå±éšœã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37386/image-20220112001118653.png" class="" title="image-20220112001118653">

<ul>
<li>LoadLoadå±éšœçš„ä½œç”¨ï¼šç¦æ­¢ä¸Šé¢æ‰€æœ‰çš„æ™®é€šè¯»æ“ä½œå’Œä¸Šé¢çš„volatileè¯»æ“ä½œè¿›è¡Œé‡æ’åºã€‚</li>
<li>LoadStoreå±éšœçš„ä½œç”¨ï¼šç¦æ­¢ä¸‹é¢çš„æ™®é€šå†™å’Œä¸Šé¢çš„volatileè¯»è¿›è¡Œé‡æ’åºã€‚</li>
</ul>
<p>volatileå†™ï¼šåœ¨æ¯ä¸ªvolatileå†™å‰é¢æ’å…¥ä¸€ä¸ªStoreStoreå±éšœï¼Œåœ¨æ¯ä¸ªvolatileå†™åé¢æ’å…¥ä¸€ä¸ªStoreLoadå±éšœã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/37386/image-20220112001156795.png" class="" title="image-20220112001156795">



<ul>
<li>StoreStoreå±éšœçš„ä½œç”¨ï¼šç¦æ­¢ä¸‹é¢çš„æ™®é€šå†™å’Œä¸‹é¢çš„volatileå†™é‡æ’åºã€‚</li>
<li>StoreLoadå±éšœçš„ä½œç”¨ï¼šé˜²æ­¢ä¸Šé¢çš„volatileå†™ä¸ä¸‹é¢å¯èƒ½å‡ºç°çš„volatileè¯»/å†™é‡æ’åºã€‚</li>
</ul>
<h2 id="3-6-ä¹ é¢˜"><a href="#3-6-ä¹ é¢˜" class="headerlink" title="3.6 ä¹ é¢˜"></a>3.6 ä¹ é¢˜</h2><h3 id="3-6-1-balkingæ¨¡å¼"><a href="#3-6-1-balkingæ¨¡å¼" class="headerlink" title="3.6.1 balkingæ¨¡å¼"></a>3.6.1 balkingæ¨¡å¼</h3><p>å¸Œæœ›<code>doInit()</code>æ–¹æ³•ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹é¢çš„å®ç°æ˜¯å¦æœ‰é—®é¢˜ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;BalkingPractice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BalkingPractice</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        doInit();</span><br><span class="line">        initialized = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;init...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰é—®é¢˜ï¼Œ<code>volatile</code>æ— æ³•ä¿è¯åŸå­æ€§ï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨<code>init()</code>æ–¹æ³•æ—¶ï¼Œæ­¤æ—¶éƒ½è¿›å…¥åˆ°<code>if</code>åˆ¤æ–­ï¼Œéƒ½è°ƒç”¨<code>doInit()</code>æ–¹æ³•ï¼Œæ­¤æ—¶å°±è°ƒç”¨äº†å¤šæ¬¡ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼šå¯¹<code>init()</code>æ–¹æ³•çš„æ–¹æ³•ä½“ï¼Œé€šè¿‡<code>synchronized</code>åŠ é”ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹å…±äº«<code>initialized</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;BalkingPractice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BalkingPractice</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            doInit();</span><br><span class="line">            initialized = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;init...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-6-2-çº¿ç¨‹å®‰å…¨å•ä¾‹"><a href="#3-6-2-çº¿ç¨‹å®‰å…¨å•ä¾‹" class="headerlink" title="3.6.2 çº¿ç¨‹å®‰å…¨å•ä¾‹"></a>3.6.2 çº¿ç¨‹å®‰å…¨å•ä¾‹</h3><p>é¥¿æ±‰å¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜1ï¼šä¸ºä»€ä¹ˆåŠ finalï¼Ÿ</span></span><br><span class="line"><span class="comment">// ç­”ï¼šé˜²æ­¢å­ç±»ç»§æ‰¿ä¿®æ”¹ã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> <span class="title">implaments</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é—®é¢˜2ï¼šä¸ºä»€ä¹ˆæ„é€ å‡½æ•°è®¾ä¸ºç§æœ‰ï¼Ÿæ˜¯å¦èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹ï¼Ÿ</span></span><br><span class="line">    <span class="comment">// ç­”ï¼šé˜²æ­¢å…¶ä»–ç±»ä¸­ä½¿ç”¨newç”Ÿæˆæ–°çš„å®ä¾‹ï¼Œä¸èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é—®é¢˜3ï¼šè¿™æ ·åˆå§‹åŒ–æ˜¯å¦èƒ½ä¿è¯å•ä¾‹å¯¹è±¡åˆ›å»ºæ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Ÿ</span></span><br><span class="line">    <span class="comment">// ç­”ï¼šèƒ½ï¼Œç±»å˜é‡åœ¨JVMç±»åŠ è½½çš„åˆå§‹åŒ–(clinit)é˜¶æ®µå®Œæˆèµ‹å€¼ï¼ŒJVMä¿è¯æ­¤æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton INSTANCE = <span class="keyword">new</span> Singleton();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é—®é¢˜4ï¼šä¸ºä»€ä¹ˆæä¾›é™æ€æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥å°†INSTANCEè®¾ç½®ä¸ºpublicï¼Ÿ</span></span><br><span class="line">    <span class="comment">// ç­”ï¼šï¼ˆ1ï¼‰æä¾›æ›´å¥½çš„å°è£…æ€§ï¼ˆ2ï¼‰æä¾›æ³›å‹çš„æ”¯æŒ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é—®é¢˜5ï¼šè¿™ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆä½œç”¨?</span></span><br><span class="line">    <span class="comment">// ç­”ï¼šé˜²æ­¢ååºåˆ—åŒ–æ—¶ç”Ÿæˆä¸åŒçš„å•ä¾‹å¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>DCLæ‡’æ±‰å¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DCLSingleton</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DCLSingleton</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="comment">// é—®é¢˜1ï¼šä¸ºä»€ä¹ˆè¦ç»™å•ä¾‹å˜é‡åŠ ä¸Švolatileå…³é”®å­—ä¿®é¥°ï¼Ÿ</span></span><br><span class="line">    <span class="comment">// ç­”ï¼šé˜²æ­¢ç¬¬ä¸€æ¬¡åˆ›å»ºå¯¹è±¡æ—¶æŒ‡ä»¤é‡æ’åºã€‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> DCLSingleton INSTANCE = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DCLSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (DCLSingleton.class) &#123;</span><br><span class="line">                <span class="comment">// é—®é¢˜3ï¼šå‰é¢å·²ç»è¿›è¡Œä¸€æ¬¡åˆ¤ç©ºï¼Œä¸ºä»€ä¹ˆè¿˜è¦åœ¨è¿™é‡ŒåŠ ä¸Šä¸ºç©ºåˆ¤æ–­ï¼Ÿ</span></span><br><span class="line">				<span class="comment">// ç­”ï¼šé˜²æ­¢å¤šçº¿ç¨‹å¹¶å‘å¯¼è‡´ä¸å®‰å…¨çš„é—®é¢˜ï¼šå•ä¾‹å¯¹è±¡é‡å¤åˆ›å»ºã€‚</span></span><br><span class="line">                <span class="comment">// æ¯”å¦‚ï¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹ã€‚éƒ½è¿›å…¥äº†ç¬¬ä¸€æ¬¡åˆ¤ç©ºï¼Œå®ƒä»¬éƒ½åˆ¤æ–­å•ä¾‹ä¸ºç©ºã€‚</span></span><br><span class="line">                <span class="comment">// ï¼ˆ1ï¼‰t1çº¿ç¨‹è·å–åˆ°å•ä¾‹å¯¹è±¡é”ï¼Œç„¶ååˆ›å»ºå¯¹è±¡ï¼Œé‡Šæ”¾é”ã€‚</span></span><br><span class="line">                <span class="comment">// ï¼ˆ2ï¼‰t2çº¿ç¨‹è·å–åˆ°å•ä¾‹å¯¹è±¡é”ï¼Œç”±äºç¬¬ä¸€æ¬¡åˆ¤ç©ºä¸ºçœŸï¼Œ</span></span><br><span class="line">                <span class="comment">//     å¦‚æœæ²¡æœ‰è¿›è¡Œç¬¬äºŒæ¬¡åˆ¤ç©ºï¼Œå®ƒä¹Ÿä¼šåˆ›å»ºå•ä¾‹å¯¹è±¡ï¼Œç ´åå•ä¾‹ã€‚</span></span><br><span class="line">                <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> DCLSingleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>é™æ€å†…éƒ¨ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="comment">// é—®é¢˜1ï¼šé™æ€å†…éƒ¨ç±»å±äºé¥¿æ±‰å¼è¿˜æ˜¯æ‡’æ±‰å¼ï¼Ÿ</span></span><br><span class="line">    <span class="comment">// ç­”ï¼šå±äºæ‡’æ±‰å¼ï¼Œå½“SinletonåŠ è½½çš„æ—¶å€™ï¼ŒSingletonHolderå¹¶æ²¡æœ‰åŠ è½½è¿›å†…å­˜ï¼Œåªè¦å½“ç¬¬ä¸€æ¬¡è°ƒç”¨getInstanceçš„æ—¶å€™ï¼ŒSingletonHolderæ‰ä¼šåŠ è½½è¿›å†…å­˜ï¼Œå¹¶ä¸”åˆå§‹åŒ–INSTANCEå®ä¾‹ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">        <span class="comment">// é—®é¢˜2ï¼šè¿™æ ·åˆ›å»ºå•ä¾‹å¯¹è±¡æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</span></span><br><span class="line">        <span class="comment">// ç­”ï¼šç±»åŠ è½½æ—¶JVMä¼šä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Singleton INSTANCE = <span class="keyword">new</span> Singleton();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Singletonolder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æšä¸¾ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é—®é¢˜1ï¼šæšä¸¾å•ä¾‹æ˜¯å¦‚ä½•é™åˆ¶å®ä¾‹ä¸ªæ•°çš„ï¼Ÿ</span></span><br><span class="line"><span class="comment">// ç­”ï¼šåˆ›å»ºæšä¸¾ç±»çš„æ—¶å€™å°±å·²ç»å®šä¹‰å¥½äº†ï¼Œæ¯ä¸ªæšä¸¾å¸¸é‡å…¶å®å°±æ˜¯æšä¸¾ç±»çš„ä¸€ä¸ªé™æ€æˆå‘˜å˜é‡ã€‚</span></span><br><span class="line"><span class="comment">// é—®é¢˜2ï¼šæšä¸¾å•ä¾‹åœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜ï¼Ÿ</span></span><br><span class="line"><span class="comment">// ç­”ï¼šæ²¡æœ‰å¹¶å‘é—®é¢˜ï¼Œæšä¸¾ç±»æˆå‘˜åº•å±‚æ˜¯ä¸€ä¸ªé™æ€æˆå‘˜è¾¹æ¡†ï¼Œåœ¨ç±»åŠ è½½æ—¶å°±åˆ›å»ºäº†ï¼ŒJVMä¼šä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</span></span><br><span class="line"><span class="comment">// é—®é¢˜3ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«åå°„ç ´åå•ä¾‹?</span></span><br><span class="line"><span class="comment">// ç­”ï¼šä¸èƒ½ï¼Œåå°„åœ¨newInstanceçš„æ—¶å€™ä¼šæ£€æŸ¥ï¼Œå¦‚æœæ˜¯æšä¸¾ç±»å‹å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="comment">// é—®é¢˜4ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«ååºåˆ—åŒ–ç ´åå•ä¾‹ï¼Ÿ</span></span><br><span class="line"><span class="comment">// ç­”ï¼šä¸èƒ½ï¼Œæšä¸¾ç±»çš„å®ç°è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œååºåˆ—åŒ–åä¾ç„¶æ˜¯ä»å‰çš„å•ä¾‹ã€‚</span></span><br><span class="line"><span class="comment">// é—®é¢˜5ï¼šæšä¸¾å•ä¾‹å¦‚æœå¸Œæœ›åŠ å…¥ä¸€äº›å•ä¾‹åˆ›å»ºæ—¶çš„åˆå§‹åŒ–é€»è¾‘åº”è¯¥å¦‚ä½•åšï¼Ÿ</span></span><br><span class="line"><span class="comment">// ç­”ï¼šåŠ æ„é€ æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Singleton</span></span>&#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-11(æ‰§è¡Œå¼•æ“)</title>
    <url>/posts/58113/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="11-1-ğŸ“–-æ¦‚è¿°"><a href="#11-1-ğŸ“–-æ¦‚è¿°" class="headerlink" title="11.1 ğŸ“– æ¦‚è¿°"></a>11.1 ğŸ“– æ¦‚è¿°</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>æ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰æ˜¯Javaè™šæ‹Ÿæœºæ ¸å¿ƒçš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚</li>
<li>â€œè™šæ‹Ÿæœºâ€æ˜¯ä¸€ä¸ªç›¸å¯¹äºâ€œç‰©ç†æœºâ€çš„æ¦‚å¿µï¼Œè¿™ä¸¤ç§æœºå™¨éƒ½æœ‰ä»£ç æ‰§è¡Œèƒ½åŠ›ï¼Œå…¶åŒºåˆ«æ˜¯ç‰©ç†æœºçš„æ‰§è¡Œå¼•æ“æ˜¯ç›´æ¥å»ºç«‹åœ¨å¤„ç†å™¨ã€ç¼“å­˜ã€æŒ‡ä»¤é›†å’Œæ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„ï¼Œè€Œè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“åˆ™æ˜¯ç”±è½¯ä»¶è‡ªè¡Œå®ç°çš„ï¼Œå› æ­¤å¯ä»¥ä¸å—ç‰©ç†æ¡ä»¶åˆ¶çº¦åœ°å®šåˆ¶æŒ‡ä»¤é›†ä¸æ‰§è¡Œå¼•æ“çš„ç»“æ„ä½“ç³»ï¼Œèƒ½å¤Ÿæ‰§è¡Œé‚£äº›ä¸è¢«ç¡¬ä»¶ç›´æ¥æ”¯æŒçš„æŒ‡ä»¤é›†æ ¼å¼ã€‚</li>
</ul>
<blockquote>
<p>âœ¨ æ„ä¹‰</p>
</blockquote>
<p>JVMçš„ä¸»è¦ä»»åŠ¡æ˜¯è´Ÿè´£è£…è½½å­—èŠ‚ç åˆ°å…¶å†…éƒ¨ï¼Œä½†å­—èŠ‚ç å¹¶ä¸èƒ½å¤Ÿç›´æ¥è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œå› ä¸ºå­—èŠ‚ç æŒ‡ä»¤å¹¶éç­‰ä»·äºæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œå®ƒå†…éƒ¨åŒ…å«çš„ä»…ä»…åªæ˜¯ä¸€äº›èƒ½å¤Ÿè¢«JVMæ‰€è¯†åˆ«çš„å­—èŠ‚ç æŒ‡ä»¤ã€ç¬¦å·è¡¨ä»¥åŠå…¶ä»–è¾…åŠ©ä¿¡æ¯ã€‚</p>
<p>é‚£ä¹ˆï¼Œæƒ³è¦è®©ä¸€ä¸ªJavaç¨‹åºè¿è¡Œèµ·æ¥ï¼Œæ‰§è¡Œå¼•æ“çš„ä»»åŠ¡å°±æ˜¯å°†å­—èŠ‚ç æŒ‡ä»¤è§£é‡Š/ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰å¯ä»¥ã€‚ç®€å•æ¥è¯´ï¼ŒJVMä¸­çš„æ‰§è¡Œå¼•æ“å……å½“äº†å°†é«˜çº§è¯­è¨€ç¿»è¯‘ä¸ºæœºå™¨è¯­è¨€çš„è¯‘è€…ã€‚</p>
<h2 id="11-2-â³-Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹"><a href="#11-2-â³-Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="11.2 â³ Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹"></a>11.2 â³ Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹</h2><blockquote>
<p>ğŸ“‹ å·¥ä½œæµç¨‹</p>
</blockquote>
<p>ï¼ˆ1ï¼‰æ‰§è¡Œå¼•æ“åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ç©¶ç«Ÿéœ€è¦æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤å®Œå…¨ä¾èµ–äºPCå¯„å­˜å™¨ã€‚</p>
<p>ï¼ˆ2ï¼‰æ¯å½“æ‰§è¡Œå®Œä¸€é¡¹æŒ‡ä»¤æ“ä½œåï¼ŒPCå¯„å­˜å™¨å°±ä¼šæ›´æ–°ä¸‹ä¸€æ¡éœ€è¦è¢«æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚</p>
<p>ï¼ˆ3ï¼‰å½“ç„¶æ–¹æ³•åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œå¼•æ“æœ‰å¯èƒ½ä¼šé€šè¿‡å­˜å‚¨åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¯¹è±¡å¼•ç”¨å‡†ç¡®å®šä½åˆ°å­˜å‚¨åœ¨Javaå †åŒºä¸­çš„å¯¹è±¡å®ä¾‹ä¿¡æ¯ï¼Œä»¥åŠé€šè¿‡å¯¹è±¡å¤´ä¸­çš„å…ƒæ•°æ®æŒ‡é’ˆå®šä½åˆ°ç›®æ ‡å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ã€‚</p>
<p>ä»å¤–è§‚ä¸Šæ¥çœ‹ï¼Œæ‰€æœ‰çš„Javaè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“è¾“å…¥ã€è¾“å‡ºéƒ½æ˜¯ä¸€è‡´çš„ï¼›è¾“å…¥çš„æ˜¯å­—èŠ‚ç äºŒè¿›åˆ¶æµï¼Œå¤„ç†è¿‡ç¨‹æ˜¯å­—èŠ‚ç è§£æçš„ç­‰æ•ˆè¿‡ç¨‹ï¼Œè¾“å‡ºçš„æ˜¯æ‰§è¡Œè¿‡ç¨‹ã€‚</p>
<blockquote>
<p>ğŸ“¼ æµç¨‹å›¾ç¤º</p>
</blockquote>
<p>å¤§éƒ¨åˆ†çš„ç¨‹åºä»£ç è½¬æ¢æˆç‰©ç†æœºçš„ç›®æ ‡ä»£ç æˆ–è™šæ‹Ÿæœºèƒ½æ‰§è¡Œçš„æŒ‡ä»¤é›†ä¹‹å‰ï¼Œéƒ½éœ€è¦ç»è¿‡ä¸‹å›¾ä¸­çš„å„ä¸ªæ­¥éª¤ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/58113/image-20210307160507117.png" class="" title="image-20210307160507117"><br />



<blockquote>
<p>ğŸ“· ç¼–è¯‘è¿‡ç¨‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/58113/image-20210307161035463.png" class="" title="image-20210307161035463"><br />



<blockquote>
<p>ğŸ“· æ‰§è¡Œè¿‡ç¨‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/58113/image-20210307161149256.png" class="" title="image-20210307161149256"><br />



<blockquote>
<p>â” ä»€ä¹ˆæ˜¯è§£é‡Šå™¨ï¼Œä»€ä¹ˆæ˜¯ä½ JITç¼–è¯‘å™¨ï¼Ÿ</p>
</blockquote>
<p>è§£é‡Šå™¨ï¼šå½“Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶ä¼šæ ¹æ®é¢„å®šä¹‰çš„è§„èŒƒå¯¹å­—èŠ‚ç é‡‡ç”¨é€è¡Œè§£é‡Šçš„æ–¹å¼æ‰§è¡Œï¼Œå°†æ¯æ¡å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å†…å®¹â€œç¿»è¯‘â€ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚</p>
<p>JITï¼ˆJust In Time Compilerï¼‰ç¼–è¯‘å™¨ï¼šå°±æ˜¯è™šæ‹Ÿæœºå°†æºä»£ç ç›´æ¥ç¼–è¯‘æˆå’Œæœ¬åœ°æœºå™¨å¹³å°ç›¸å…³çš„æœºå™¨è¯­è¨€ã€‚</p>
<p>æ¯”è¾ƒï¼š</p>
<p>è§£é‡Šå™¨å¯ä»¥çœå»ç¼–è¯‘çš„æ—¶é—´ï¼Œå¯ä»¥å¿«é€Ÿæ‰§è¡Œç¨‹åºï¼›</p>
<p>å³æ—¶ç¼–è¯‘å™¨æŠŠä»£ç ç¼–è¯‘æˆæœ¬åœ°æœºå™¨è¯­è¨€ï¼Œæ‰§è¡Œæ•ˆç‡é«˜ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/58113/image-20210307163417053.png" class="" title="image-20210307163417053"><br />



<blockquote>
<p>â” ä¸ºä»€ä¹ˆè¯´Javaæ˜¯åŠç¼–è¯‘åŠè§£é‡Šå‹è¯­è¨€ï¼Ÿ</p>
</blockquote>
<p>JDK1.0æ—¶ä»£ï¼Œå°†Javaè¯­è¨€å®šä½ä¸ºâ€œè§£é‡Šæ‰§è¡Œâ€è¿˜æ˜¯æ¯”è¾ƒå‡†å¤‡çš„ã€‚å†åæ¥ï¼ŒJavaä¹Ÿå‘å±•å‡ºå¯ä»¥ç›´æ¥ç”Ÿæˆæœ¬åœ°ä»£ç çš„ç¼–è¯‘å™¨ã€‚</p>
<p>ç°åœ¨JVMåœ¨æ‰§è¡ŒJavaä»£ç çš„æ—¶å€™ï¼Œé€šå¸¸éƒ½ä¼šå°†è§£é‡Šæ‰§è¡Œä¸ç¼–è¯‘æ‰§è¡ŒäºŒè€…ç»“åˆèµ·æ¥è¿›è¡Œã€‚</p>
<h2 id="11-3-ğŸ’¤-æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€"><a href="#11-3-ğŸ’¤-æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€" class="headerlink" title="11.3 ğŸ’¤ æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€"></a>11.3 ğŸ’¤ æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€</h2><blockquote>
<p>ğŸ“” æœºå™¨ç </p>
</blockquote>
<p>å„ç§ç”¨äºŒè¿›åˆ¶ç¼–ç æ–¹å¼è¡¨ç¤ºçš„æŒ‡ä»¤ï¼Œå«åšæœºå™¨æŒ‡ä»¤ç ã€‚å¼€å§‹ï¼Œäººä»¬å°±ç”¨å®ƒé‡‡ç¼–å†™ç¨‹åºï¼Œè¿™å°±æ˜¯æœºå™¨è¯­è¨€ã€‚</p>
<p>æœºå™¨è¯­è¨€è™½ç„¶èƒ½å¤Ÿè¢«è®¡ç®—æœºç†è§£å’Œæ¥å—ï¼Œä½†å’Œäººä»¬çš„è¯­è¨€å·®åˆ«å¤ªå¤§ï¼Œä¸æ˜“è¢«äººä»¬ç†è§£å’Œè®°å¿†ï¼Œå¹¶ä¸”ç”¨å®ƒç¼–ç¨‹å®¹æ˜“å‡ºå·®é”™ã€‚</p>
<p>ç”¨å®ƒç¼–å†™çš„ç¨‹åºä¸€ç»è¾“å…¥è®¡ç®—æœºï¼ŒCPUç›´æ¥è¯»å–è¿è¡Œï¼Œå› æ­¤å’Œå…¶ä»–è¯­è¨€ç¼–çš„ç¨‹åºç›¸æ¯”ï¼Œæ‰§è¡Œé€Ÿåº¦æœ€å¿«ã€‚</p>
<p>æœºå™¨æŒ‡ä»¤ä¸CPUç´§å¯†ç›¸å…³ï¼Œæ‰€ä»¥ä¸åŒç§ç±»çš„CPUæ‰€å¯¹åº”çš„æœºå™¨æŒ‡ä»¤ä¹Ÿå°±ä¸åŒã€‚</p>
<blockquote>
<p>ğŸ“• æŒ‡ä»¤</p>
</blockquote>
<p>ç”±äºæœºå™¨ç æ˜¯æœ‰0å’Œ1ç»„æˆçš„äºŒè¿›åˆ¶åºåˆ—ï¼Œå¯è¯»æ€§å®åœ¨å¤ªå·®ï¼Œäºæ˜¯äººä»¬å‘æ˜äº†æŒ‡ä»¤ã€‚</p>
<p>æŒ‡ä»¤å°±æ˜¯æŠŠæœºå™¨ç ä¸­ç‰¹å®šçš„0å’Œ1åºåˆ—ï¼Œç®€åŒ–æˆå¯¹åº”çš„æŒ‡ä»¤ï¼ˆä¸€èˆ¬ä¸ºè‹±æ–‡ç®€å†™ï¼Œå¦‚movï¼Œincç­‰ï¼‰ï¼Œå¯è¯»æ€§ç¨å¥½</p>
<p>ç”±äºä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œæ‰§è¡ŒåŒä¸€ä¸ªæ“ä½œï¼Œå¯¹åº”çš„æœºå™¨ç å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥ä¸åŒçš„ç¡¬ä»¶å¹³å°çš„åŒä¸€ç§æŒ‡ä»¤ï¼ˆæ¯”å¦‚movï¼‰ï¼Œå¯¹åº”çš„æœºå™¨ç ä¹Ÿå¯èƒ½ä¸åŒã€‚</p>
<blockquote>
<p>ğŸ“— æŒ‡ä»¤é›†</p>
</blockquote>
<p>ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œå„è‡ªæ”¯æŒçš„æŒ‡ä»¤ï¼Œæ˜¯æœ‰å·®åˆ«çš„ã€‚å› æ­¤æ¯ä¸ªå¹³å°æ‰€æ”¯æŒçš„æŒ‡ä»¤ï¼Œç§°ä¹‹ä¸ºå¯¹åº”å¹³å°çš„æŒ‡ä»¤é›†ã€‚ å¦‚å¸¸è§çš„</p>
<ul>
<li>x86æŒ‡ä»¤é›†ï¼Œå¯¹åº”çš„æ˜¯x86æ¶æ„çš„å¹³å°</li>
<li>ARMæŒ‡ä»¤é›†ï¼Œå¯¹åº”çš„æ˜¯ARMæ¶æ„çš„å¹³å°</li>
</ul>
<blockquote>
<p>ğŸ“˜ æ±‡ç¼–è¯­è¨€</p>
</blockquote>
<p>ç”±äºæŒ‡ä»¤çš„å¯è¯»æ€§è¿˜æ˜¯å¤ªå·®ï¼Œäºæ˜¯äººä»¬åˆå‘æ˜äº†æ±‡ç¼–è¯­è¨€ã€‚</p>
<p>åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œç”¨åŠ©è®°ç¬¦ï¼ˆMnemonicsï¼‰ä»£æ›¿æœºå™¨æŒ‡ä»¤çš„æ“ä½œç ï¼Œç”¨åœ°å€ç¬¦å·ï¼ˆSymbo1ï¼‰æˆ–æ ‡å·ï¼ˆLabe1ï¼‰ä»£æ›¿æŒ‡ä»¤æˆ–æ“ä½œæ•°çš„åœ°å€ã€‚åœ¨ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œæ±‡ç¼–è¯­è¨€å¯¹åº”ç€ä¸åŒçš„æœºå™¨è¯­è¨€æŒ‡ä»¤é›†ï¼Œé€šè¿‡æ±‡ç¼–è¿‡ç¨‹è½¬æ¢æˆæœºå™¨æŒ‡ä»¤ã€‚</p>
<p>ç”±äºè®¡ç®—æœºåªè®¤è¯†æŒ‡ä»¤ç ï¼Œæ‰€ä»¥ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ç¨‹åºè¿˜å¿…é¡»ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ç ï¼Œè®¡ç®—æœºæ‰èƒ½è¯†åˆ«å’Œæ‰§è¡Œã€‚</p>
<blockquote>
<p>ğŸ“™ é«˜çº§è¯­è¨€</p>
</blockquote>
<p>ä¸ºäº†ä½¿è®¡ç®—æœºç”¨æˆ·ç¼–ç¨‹åºæ›´å®¹æ˜“äº›ï¼Œåæ¥å°±å‡ºç°äº†å„ç§é«˜çº§è®¡ç®—æœºè¯­è¨€ã€‚</p>
<p>é«˜çº§è¯­è¨€æ¯”æœºå™¨è¯­è¨€ã€æ±‡ç¼–è¯­è¨€æ›´æ¥è¿‘äººçš„è¯­è¨€å½“è®¡ç®—æœºæ‰§è¡Œé«˜çº§è¯­è¨€ç¼–å†™çš„ç¨‹åºæ—¶ï¼Œä»ç„¶éœ€è¦æŠŠç¨‹åºè§£é‡Šå’Œç¼–è¯‘æˆæœºå™¨çš„æŒ‡ä»¤ç ã€‚å®Œæˆè¿™ä¸ªè¿‡ç¨‹çš„ç¨‹åºå°±å«åšè§£é‡Šç¨‹åºæˆ–ç¼–è¯‘ç¨‹åºã€‚</p>
<blockquote>
<p>ğŸ“’ å­—èŠ‚ç </p>
</blockquote>
<p>å­—èŠ‚ç æ˜¯ä¸€ç§ä¸­é—´çŠ¶æ€ï¼ˆä¸­é—´ç ï¼‰çš„äºŒè¿›åˆ¶ä»£ç ï¼ˆæ–‡ä»¶ï¼‰ï¼Œå®ƒæ¯”æœºå™¨ç æ›´æŠ½è±¡ï¼Œéœ€è¦ç›´è¯‘å™¨è½¬è¯‘åæ‰èƒ½æˆä¸ºæœºå™¨ç </p>
<p>å­—èŠ‚ç ä¸»è¦ä¸ºäº†å®ç°ç‰¹å®šè½¯ä»¶è¿è¡Œå’Œè½¯ä»¶ç¯å¢ƒã€ä¸ç¡¬ä»¶ç¯å¢ƒæ— å…³ã€‚</p>
<p>å­—èŠ‚ç çš„å®ç°æ–¹å¼æ˜¯é€šè¿‡ç¼–è¯‘å™¨å’Œè™šæ‹Ÿæœºå™¨ã€‚ç¼–è¯‘å™¨å°†æºç ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œç‰¹å®šå¹³å°ä¸Šçš„è™šæ‹Ÿæœºå™¨å°†å­—èŠ‚ç è½¬è¯‘ä¸ºå¯ä»¥ç›´æ¥æ‰§è¡Œçš„æŒ‡ä»¤ã€‚</p>
<ul>
<li>å­—èŠ‚ç å…¸å‹çš„åº”ç”¨ä¸ºï¼šJava bytecode</li>
</ul>
<h2 id="11-4-ğŸ›©ï¸-è§£é‡Šå™¨"><a href="#11-4-ğŸ›©ï¸-è§£é‡Šå™¨" class="headerlink" title="11.4 ğŸ›©ï¸ è§£é‡Šå™¨"></a>11.4 ğŸ›©ï¸ è§£é‡Šå™¨</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<p>è§£é‡Šå™¨çœŸæ­£æ„ä¹‰ä¸Šæ‰€æ‰¿æ‹…çš„è§’è‰²å°±æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶â€œç¿»è¯‘è€…â€ï¼Œå°†å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å†…å®¹â€œç¿»è¯‘â€ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚</p>
<p>å½“ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤è¢«è§£é‡Šæ‰§è¡Œå®Œæˆåï¼Œæ¥ç€å†æ ¹æ®PCå¯„å­˜å™¨ä¸­è®°å½•çš„ä¸‹ä¸€æ¡éœ€è¦è¢«æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤æ‰§è¡Œè§£é‡Šæ“ä½œã€‚</p>
<blockquote>
<p>ğŸ”± è§£é‡Šå™¨åˆ†ç±»</p>
</blockquote>
<p>åœ¨Javaçš„å‘å±•å†å²é‡Œï¼Œä¸€å…±æœ‰ä¸¤å¥—è§£é‡Šæ‰§è¡Œå™¨ï¼Œå³å¤è€çš„å­—èŠ‚ç è§£é‡Šå™¨ã€ç°åœ¨æ™®éä½¿ç”¨çš„æ¨¡æ¿è§£é‡Šå™¨ã€‚</p>
<p>å­—èŠ‚ç è§£é‡Šå™¨åœ¨æ‰§è¡Œæ—¶é€šè¿‡çº¯è½¯ä»¶ä»£ç æ¨¡æ‹Ÿå­—èŠ‚ç çš„æ‰§è¡Œï¼Œæ•ˆç‡éå¸¸ä½ä¸‹ã€‚</p>
<p>è€Œæ¨¡æ¿è§£é‡Šå™¨å°†æ¯ä¸€æ¡å­—èŠ‚ç å’Œä¸€ä¸ªæ¨¡æ¿å‡½æ•°ç›¸å…³è”ï¼Œæ¨¡æ¿å‡½æ•°ä¸­ç›´æ¥äº§ç”Ÿè¿™æ¡å­—èŠ‚ç æ‰§è¡Œæ—¶çš„æœºå™¨ç ï¼Œä»è€Œå¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜äº†è§£é‡Šå™¨çš„æ€§èƒ½ã€‚</p>
<p>åœ¨HotSpot VMä¸­ï¼Œè§£é‡Šå™¨ä¸»è¦ç”±Interpreteræ¨¡å—å’ŒCodeæ¨¡å—æ„æˆã€‚</p>
<ul>
<li>Interpreteræ¨¡å—ï¼šå®ç°äº†è§£é‡Šå™¨çš„æ ¸å¿ƒåŠŸèƒ½</li>
<li>Codeæ¨¡å—ï¼šç”¨äºç®¡ç†HotSpot VMåœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤</li>
</ul>
<blockquote>
<p>ğŸ—“ï¸ ç°çŠ¶</p>
</blockquote>
<p>ç”±äºè§£é‡Šå™¨åœ¨è®¾è®¡å’Œå®ç°ä¸Šéå¸¸ç®€å•ï¼Œå› æ­¤é™¤äº†Javaè¯­è¨€ä¹‹å¤–ï¼Œè¿˜æœ‰è®¸å¤šé«˜çº§è¯­è¨€åŒæ ·ä¹Ÿæ˜¯åŸºäºè§£é‡Šå™¨æ‰§è¡Œçš„ï¼Œæ¯”å¦‚Pythonã€Per1ã€Rubyç­‰ã€‚ä½†æ˜¯åœ¨ä»Šå¤©ï¼ŒåŸºäºè§£é‡Šå™¨æ‰§è¡Œå·²ç»æ²¦è½ä¸ºä½æ•ˆçš„ä»£åè¯ï¼Œå¹¶ä¸”æ—¶å¸¸è¢«ä¸€äº›C/C++ç¨‹åºå‘˜æ‰€è°ƒä¾ƒã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJVMå¹³å°æ”¯æŒä¸€ç§å«ä½œå³æ—¶ç¼–è¯‘çš„æŠ€æœ¯ã€‚å³æ—¶ç¼–è¯‘çš„ç›®çš„æ˜¯é¿å…å‡½æ•°è¢«è§£é‡Šæ‰§è¡Œï¼Œè€Œæ˜¯å°†æ•´ä¸ªå‡½æ•°ä½“ç¼–è¯‘æˆä¸ºæœºå™¨ç ï¼Œæ¯æ¬¡å‡½æ•°æ‰§è¡Œæ—¶ï¼Œåªæ‰§è¡Œç¼–è¯‘åçš„æœºå™¨ç å³å¯ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ä½¿æ‰§è¡Œæ•ˆç‡å¤§å¹…åº¦æå‡ã€‚</p>
<p>ä¸è¿‡æ— è®ºå¦‚ä½•ï¼ŒåŸºäºè§£é‡Šå™¨çš„æ‰§è¡Œæ¨¡å¼ä»ç„¶ä¸ºä¸­é—´è¯­è¨€çš„å‘å±•åšå‡ºäº†ä¸å¯ç£¨ç­çš„è´¡çŒ®ã€‚</p>
<h2 id="11-5-âœˆï¸-JITç¼–è¯‘å™¨"><a href="#11-5-âœˆï¸-JITç¼–è¯‘å™¨" class="headerlink" title="11.5 âœˆï¸ JITç¼–è¯‘å™¨"></a>11.5 âœˆï¸ JITç¼–è¯‘å™¨</h2><blockquote>
<p>ğŸ’» HotSpot JVMæ‰§è¡Œæ–¹å¼</p>
</blockquote>
<p>å½“è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™ï¼Œè§£é‡Šå™¨å¯ä»¥é¦–å…ˆå‘æŒ¥ä½œç”¨ï¼Œè€Œä¸å¿…ç­‰å¾…å³æ—¶ç¼–è¯‘å™¨å…¨éƒ¨ç¼–è¯‘å®Œæˆå†æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥çœå»è®¸å¤šä¸å¿…è¦çš„ç¼–è¯‘æ—¶é—´ã€‚å¹¶ä¸”éšç€ç¨‹åºè¿è¡Œæ—¶é—´çš„æ¨ç§»ï¼Œå³æ—¶ç¼–è¯‘å™¨é€æ¸å‘æŒ¥ä½œç”¨ï¼Œæ ¹æ®çƒ­ç‚¹æ¢æµ‹åŠŸèƒ½ï¼Œå°†æœ‰ä»·å€¼çš„å­—èŠ‚ç ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œä»¥æ¢å–æ›´é«˜çš„ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚</p>
<blockquote>
<p>ğŸ’¬ è§£é‡Š</p>
</blockquote>
<ul>
<li>Javaè¯­è¨€çš„â€œç¼–è¯‘æœŸâ€å…¶å®æ˜¯ä¸€æ®µâ€œä¸ç¡®å®šâ€çš„æ“ä½œè¿‡ç¨‹ï¼Œå› ä¸ºå®ƒå¯èƒ½æ˜¯æŒ‡ä¸€ä¸ªå‰ç«¯ç¼–è¯‘å™¨æŠŠ.javaæ–‡ä»¶è½¬å˜æˆ.classæ–‡ä»¶çš„è¿‡ç¨‹ã€‚</li>
<li>ä¹Ÿå¯èƒ½æ˜¯æŒ‡è™šæ‹Ÿæœºçš„åç«¯è¿è¡ŒæœŸç¼–è¯‘å™¨ï¼ˆJITç¼–è¯‘å™¨ï¼‰æŠŠå­—èŠ‚ç è½¬å˜æˆæœºå™¨ç çš„è¿‡ç¨‹ã€‚</li>
<li>è¿˜å¯èƒ½æ˜¯æŒ‡ä½¿ç”¨é™æ€æå‰ç¼–è¯‘å™¨ï¼ˆAOTç¼–è¯‘å™¨ï¼‰ç›´æ¥æŠŠ.javaæ–‡ä»¶ç¼–è¯‘æˆæœ¬åœ°æœºå™¨ä»£ç çš„è¿‡ç¨‹ã€‚</li>
</ul>
<p>å‰ç«¯ç¼–è¯‘å™¨ï¼šSunçš„Javacã€Eclipse JDTä¸­çš„å¢é‡å¼ç¼–è¯‘ï¼ˆECJï¼‰ã€‚</p>
<p>JITç¼–è¯‘å™¨ï¼šHotSpot VMçš„C1ã€C2ç¼–è¯‘å™¨ã€‚</p>
<p>AOTç¼–è¯‘å™¨ï¼šGUN Compiler for Javaï¼ˆGCJï¼‰ã€Excelsior JETã€‚</p>
<blockquote>
<p>ğŸ”¥ çƒ­ç‚¹ä»£ç </p>
</blockquote>
<p>æ˜¯å¦éœ€è¦å¯åŠ¨JITç¼–è¯‘å™¨å°†å­—èŠ‚ç ç›´æ¥ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œåˆ™éœ€è¦æ ¹æ®ä»£ç è¢«è°ƒç”¨æ‰§è¡Œçš„é¢‘ç‡è€Œå®šã€‚å…³äºé‚£äº›éœ€è¦è¢«ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç çš„å­—èŠ‚ç ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºâ€œçƒ­ç‚¹ä»£ç â€ï¼ŒJITç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶ä¼šé’ˆå¯¹é‚£äº›é¢‘ç¹è¢«è°ƒç”¨çš„â€œçƒ­ç‚¹ä»£ç â€åšå‡ºæ·±åº¦ä¼˜åŒ–ï¼Œå°†å…¶ç›´æ¥ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œä»¥æ­¤æå‡Javaç¨‹åºçš„æ‰§è¡Œæ€§èƒ½ã€‚</p>
<blockquote>
<p>ğŸ³â€ğŸŒˆçƒ­ç‚¹æ¢æµ‹æŠ€æœ¯</p>
</blockquote>
<ul>
<li>ä¸€ä¸ªè¢«å¤šæ¬¡è°ƒç”¨çš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ–¹æ³•ä½“å†…å¾ªç¯æ¬¡æ•°è¾ƒå¤šçš„å¾ªç¯ä½“éƒ½å¯ä»¥è¢«ç§°ä¹‹ä¸ºâ€œçƒ­ç‚¹ä»£ç â€ï¼Œå› æ­¤éƒ½å¯ä»¥é€šè¿‡JITç¼–è¯‘å™¨ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤ã€‚ç”±äºè¿™ç§ç¼–è¯‘æ–¹å¼å‘ç”Ÿåœ¨æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¹‹ä¸ºæ ˆä¸Šæ›¿æ¢ï¼Œæˆ–ç®€ç§°ä¸ºOSRï¼ˆOn Stack Replacementï¼‰ç¼–è¯‘ã€‚</li>
<li>ä¸€ä¸ªæ–¹æ³•ç©¶ç«Ÿè¦è¢«è°ƒç”¨å¤šå°‘æ¬¡ï¼Œæˆ–è€…ä¸€ä¸ªå¾ªç¯ä½“ç©¶ç«Ÿéœ€è¦æ‰§è¡Œå¤šå°‘æ¬¡æ‰å¯ä»¥è¾¾åˆ°è¿™ä¸ªæ ‡å‡†ï¼Ÿå¿…ç„¶éœ€è¦ä¸€ä¸ªæ˜ç¡®çš„é˜ˆå€¼ï¼ŒJITç¼–è¯‘å™¨æ‰ä¼šå°†è¿™äº›â€œçƒ­ç‚¹ä»£ç â€ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚è¿™é‡Œä¸»è¦ä¾é çƒ­ç‚¹æ¢æµ‹åŠŸèƒ½ã€‚</li>
<li>ç›®å‰HotSpot VMæ‰€é‡‡ç”¨çš„çƒ­ç‚¹æ¢æµ‹æ–¹å¼æ˜¯åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ã€‚</li>
<li>é‡‡ç”¨åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ï¼ŒHotSpot VMå°†ä¼šä¸ºæ¯ä¸€ä¸ªæ–¹æ³•éƒ½å»ºç«‹2ä¸ªä¸åŒç±»å‹çš„è®¡æ•°å™¨ï¼Œåˆ†åˆ«æ˜¯æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼ˆInvocation Counterï¼‰å’Œå›è¾¹è®¡æ•°å™¨ï¼ˆBack Edge Counterï¼‰ã€‚<ul>
<li>æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ç”¨äºç»Ÿè®¡æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°</li>
<li>å›è¾¹è®¡æ•°å™¨åˆ™ç”¨äºç»Ÿè®¡å¾ªç¯ä½“æ‰§è¡Œçš„å¾ªç¯æ¬¡æ•°</li>
</ul>
</li>
</ul>
<blockquote>
<p>ğŸ”¢ æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨</p>
</blockquote>
<ul>
<li>è¿™ä¸ªè®¡æ•°å™¨å°±ç”¨äºç»Ÿè®¡æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ï¼Œå®ƒçš„é»˜è®¤é˜ˆå€¼åœ¨Clientæ¨¡å¼ä¸‹æ˜¯1500æ¬¡ï¼Œåœ¨Serveræ¨¡å¼ä¸‹æ˜¯10000æ¬¡è¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œå°±ä¼šè§¦å‘JITç¼–è¯‘ã€‚</li>
<li>è¿™ä¸ªé˜ˆå€¼å¯ä»¥é€šè¿‡è™šæ‹Ÿæœºå‚æ•°-XX:CompileThresholdæ¥äººä¸ºè®¾å®šã€‚</li>
<li>å½“ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥è¯¥æ–¹æ³•æ˜¯å¦å­˜åœ¨è¢«JITç¼–è¯‘è¿‡çš„ç‰ˆæœ¬ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ç¼–è¯‘åçš„æœ¬åœ°ä»£ç æ¥æ‰§è¡Œï¼›å¦‚æœä¸å­˜åœ¨å·²è¢«ç¼–è¯‘è¿‡çš„ç‰ˆæœ¬ï¼Œåˆ™å°†æ­¤æ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨åŠ ä¸€ï¼Œç„¶ååˆ¤æ–­æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ä¸å›è¾¹è®¡æ•°å™¨ä¹‹å’Œæ˜¯å¦è¶…è¿‡æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çš„é˜ˆå€¼ã€‚å¦‚æœå·²è¶…è¿‡é˜ˆå€¼ï¼Œé‚£ä¹ˆå°†ä¼šå‘å³æ—¶ç¼–è¯‘å™¨æäº¤ä¸€ä¸ªè¯¥æ–¹æ³•çš„ä»£ç ç¼–è¯‘è¯·æ±‚ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’§ çƒ­ç‚¹è¡°å‡</p>
</blockquote>
<p>å¦‚æœä¸åšä»»ä½•è®¾ç½®ï¼Œæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ç»Ÿè®¡çš„å¹¶ä¸æ˜¯æ–¹æ³•è¢«è°ƒç”¨çš„ç»å¯¹æ¬¡æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªç›¸å¯¹çš„æ‰§è¡Œé¢‘ç‡ï¼Œå³ä¸€æ®µæ—¶é—´ä¹‹å†…æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚å½“è¶…è¿‡ä¸€å®šçš„æ—¶é—´é™åº¦ï¼Œå¦‚æœæ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ä»ç„¶ä¸è¶³ä»¥è®©å®ƒæäº¤ç»™å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘ï¼Œé‚£è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨å°±ä¼šè¢«å‡å°‘ä¸€åŠï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çƒ­åº¦çš„è¡°å‡ï¼ˆCounter Decayï¼‰ï¼Œè€Œè¿™æ®µæ—¶é—´å°±ç§°ä¸ºæ­¤æ–¹æ³•ç»Ÿè®¡çš„åŠè¡°å‘¨æœŸï¼ˆCounter Half Life Timeï¼‰</p>
<p>è¿›è¡Œçƒ­åº¦è¡°å‡çš„åŠ¨ä½œæ˜¯åœ¨è™šæ‹Ÿæœºè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶é¡ºä¾¿è¿›è¡Œçš„ï¼Œå¯ä»¥ä½¿ç”¨è™šæ‹Ÿæœºå‚æ•° -XX:-UseCounterDecay æ¥å…³é—­çƒ­åº¦è¡°å‡ï¼Œè®©æ–¹æ³•è®¡æ•°å™¨ç»Ÿè®¡æ–¹æ³•è°ƒç”¨çš„ç»å¯¹æ¬¡æ•°ï¼Œè¿™æ ·ï¼Œåªè¦ç³»ç»Ÿè¿è¡Œæ—¶é—´è¶³å¤Ÿé•¿ï¼Œç»å¤§éƒ¨åˆ†æ–¹æ³•éƒ½ä¼šè¢«ç¼–è¯‘æˆæœ¬åœ°ä»£ç ã€‚</p>
<p>å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨-XX:CounterHalfLifeTimeå‚æ•°è®¾ç½®åŠè¡°å‘¨æœŸçš„æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚</p>
<blockquote>
<p>ğŸ”¢ å›è¾¹è®¡æ•°å™¨</p>
</blockquote>
<p>å®ƒçš„ä½œç”¨æ˜¯ç»Ÿè®¡ä¸€ä¸ªæ–¹æ³•ä½“ä¸­å¾ªç¯ä½“ä»£ç æ‰§è¡Œçš„æ¬¡æ•°ï¼Œåœ¨å­—èŠ‚ç ä¸­é‡åˆ°æ§åˆ¶æµå‘åè·³è½¬çš„æŒ‡ä»¤ç§°ä¸ºâ€œå›è¾¹â€ï¼ˆBack Edgeï¼‰ã€‚æ˜¾ç„¶ï¼Œå»ºç«‹å›è¾¹è®¡æ•°å™¨ç»Ÿè®¡çš„ç›®çš„å°±æ˜¯ä¸ºäº†è§¦å‘OSRç¼–è¯‘ã€‚</p>
<blockquote>
<p>ğŸ”± HotSpot VMå¯ä»¥è®¾ç½®ç¨‹åºæ‰§è¡Œæ–¹å¼</p>
</blockquote>
<p>ç¼ºçœæƒ…å†µä¸‹HotSpot VMæ˜¯é‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„ï¼Œå½“ç„¶å¼€å‘äººå‘˜å¯ä»¥æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯ï¼Œé€šè¿‡å‘½ä»¤æ˜¾ç¤ºåœ°ä¸ºJavaè™šæ‹ŸæœºæŒ‡å®šåœ¨è¿è¡Œæ—¶åˆ°åº•æ˜¯é‡‡ç”¨è§£é‡Šå™¨æ‰§è¡Œè¿˜æ˜¯å®Œå…¨é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨æ‰§è¡Œã€‚</p>
<ul>
<li>-Xint: å®Œå…¨é‡‡ç”¨è§£é‡Šå™¨æ¨¡å¼æ‰§è¡Œç¨‹åºã€‚</li>
<li>Xcompï¼šå®Œå…¨é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨æ¨¡å¼æ‰§è¡Œç¨‹åºã€‚å¦‚æœå³æ—¶ç¼–è¯‘å‡ºç°é—®é¢˜ï¼Œè§£é‡Šå™¨ä¼šä»‹å…¥æ‰§è¡Œã€‚</li>
<li>-Xmixedï¼šé‡‡ç”¨è§£é‡Šå™¨+å³æ—¶ç¼–è¯‘å™¨çš„æ··åˆæ¨¡å¼å…±åŒæ‰§è¡Œç¨‹åºã€‚</li>
</ul>
<blockquote>
<p>ğŸ”± HotSpot VMä¸­JITåˆ†ç±»</p>
</blockquote>
<p>åœ¨HotSpot VMä¸­å†…åµŒæœ‰ä¸¤ä¸ªJITç¼–è¯‘å™¨ï¼Œåˆ†åˆ«ä¸ºClient Compilerå’ŒServer Compilerï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬ç®€ç§°ä¸ºC1ç¼–è¯‘å™¨å’ŒC2ç¼–è¯‘å™¨ã€‚å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ˜¾ç¤ºæŒ‡å®šJavaè™šæ‹Ÿæœºåœ¨è¿è¡Œæ—¶åˆ°åº•ä½¿ç”¨å“ªä¸€ç§å³æ—¶ç¼–è¯‘å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li>-clientï¼šæŒ‡å®šJavaè™šæ‹Ÿæœºè¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨C1ç¼–è¯‘å™¨<ul>
<li>C1ç¼–è¯‘å™¨ä¼šå¯¹å­—èŠ‚ç è¿›è¡Œç®€å•å’Œå¯é çš„ä¼˜åŒ–ï¼Œè€—æ—¶çŸ­ã€‚ä»¥è¾¾åˆ°æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦ã€‚</li>
</ul>
</li>
<li>-serverï¼šæŒ‡å®šJavaè™šæ‹Ÿæœºè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨C2ç¼–è¯‘å™¨ã€‚<ul>
<li>C2è¿›è¡Œè€—æ—¶è¾ƒé•¿çš„ä¼˜åŒ–ï¼Œä»¥åŠæ¿€è¿›ä¼˜åŒ–ã€‚ä½†ä¼˜åŒ–çš„ä»£ç æ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>ğŸ”° C1å’ŒC2ç¼–è¯‘å™¨ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥</p>
</blockquote>
<p>åœ¨ä¸åŒçš„ç¼–è¯‘å™¨ä¸Šæœ‰ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<p>C1ç¼–è¯‘å™¨ä¸Šä¸»è¦æœ‰æ–¹æ³•å†…è”ï¼Œå»è™šæ‹ŸåŒ–ã€å†—ä½™æ¶ˆé™¤ï¼š</p>
<ul>
<li>æ–¹æ³•å†…è”ï¼šå°†å¼•ç”¨çš„å‡½æ•°ä»£ç ç¼–è¯‘åˆ°å¼•ç”¨ç‚¹å¤„ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ ˆå¸§çš„ç”Ÿæˆï¼Œå‡å°‘å‚æ•°ä¼ é€’ä»¥åŠè·³è½¬è¿‡ç¨‹ã€‚</li>
<li>å»è™šæ‹ŸåŒ–ï¼šå¯¹å”¯ä¸€çš„å®ç°ç±»è¿›è¡Œå†…è”ã€‚</li>
<li>å†—ä½™æ¶ˆé™¤ï¼šåœ¨è¿è¡ŒæœŸé—´æŠŠä¸€äº›ä¸ä¼šæ‰§è¡Œçš„ä»£ç æŠ˜å æ‰ã€‚</li>
</ul>
<p>C2çš„ä¼˜åŒ–ä¸»è¦æ˜¯åœ¨å…¨å±€å±‚é¢ï¼Œé€ƒé€¸åˆ†ææ˜¯ä¼˜åŒ–çš„åŸºç¡€ã€‚åŸºäºé€ƒé€¸åˆ†æåœ¨C2ä¸Šæœ‰å¦‚ä¸‹çš„å‡ ç§ä¼˜åŒ–ï¼š</p>
<ul>
<li>æ ‡é‡æ›¿æ¢ï¼šç”¨æ ‡é‡å€¼æ›¿æ¢èšåˆå¯¹è±¡çš„å±æ€§å€¼</li>
<li>æ ˆä¸Šåˆ†é…ï¼šå¯¹äºæœªé€ƒé€¸çš„å¯¹è±¡åˆ†é…å¯¹è±¡åœ¨æ ˆè€Œä¸æ˜¯å †</li>
<li>åŒæ­¥æ¶ˆé™¤ï¼šæ¸…é™¤åŒæ­¥æ“ä½œï¼Œé€šå¸¸æŒ‡synchronized</li>
</ul>
<blockquote>
<p>ğŸ”° åˆ†å±‚ç¼–è¯‘ç­–ç•¥</p>
</blockquote>
<p>åˆ†å±‚ç¼–è¯‘ï¼ˆTiered Compilationï¼‰ç­–ç•¥ï¼šç¨‹åºè§£é‡Šæ‰§è¡Œï¼ˆä¸å¼€å¯æ€§èƒ½ç›‘æ§ï¼‰å¯ä»¥è§¦å‘C1ç¼–è¯‘ï¼Œå°†å­—èŠ‚ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œå¯ä»¥è¿›è¡Œç®€å•ä¼˜åŒ–ï¼Œä¹Ÿå¯ä»¥åŠ ä¸Šæ€§èƒ½ç›‘æ§ï¼ŒC2ç¼–è¯‘ä¼šæ ¹æ®æ€§èƒ½ç›‘æ§ä¿¡æ¯è¿›è¡Œæ¿€è¿›ä¼˜åŒ–ã€‚</p>
<p>ä¸è¿‡åœ¨Java7ç‰ˆæœ¬ä¹‹åï¼Œä¸€æ—¦å¼€å‘äººå‘˜åœ¨ç¨‹åºä¸­æ˜¾ç¤ºæŒ‡å®šå‘½ä»¤â€œ-serverâ€æ—¶ï¼Œé»˜è®¤ä¼šå¼€å¯åˆ†å±‚ç¼–è¯‘ç­–ç•¥ï¼Œç”±C1ç¼–è¯‘å™¨å’ŒC2ç¼–è¯‘å™¨ç›¸äº’åä½œå…±åŒæ¥æ‰§è¡Œç¼–è¯‘ä»»åŠ¡ã€‚</p>
<blockquote>
<p>ğŸ‘â€ğŸ—¨  Graalç¼–è¯‘å™¨</p>
</blockquote>
<ul>
<li>è‡ªJDK10èµ·ï¼ŒHotSpotåˆåŠ å…¥ä¸€ä¸ªå…¨æ–°çš„å³æ—¶ç¼–è¯‘å™¨ï¼šGraalç¼–è¯‘å™¨</li>
<li>ç¼–è¯‘æ•ˆæœçŸ­çŸ­å‡ å¹´æ—¶é—´å°±è¿½å¹³äº†C2ç¼–è¯‘å™¨ï¼Œæœªæ¥å¯æœŸã€‚</li>
<li>ç›®å‰ï¼Œå¸¦ç€â€œå®éªŒçŠ¶æ€â€æ ‡ç­¾ï¼Œéœ€è¦ä½¿ç”¨å¼€å…³å‚æ•°-XX:+UnlockExperimentalVMOptions -XX:+UseJVMCICompilerå»æ¿€æ´»ï¼Œæ‰å¯ä»¥ä½¿ç”¨ã€‚</li>
</ul>
<blockquote>
<p>ğŸ‘â€ğŸ—¨ AOTç¼–è¯‘å™¨</p>
</blockquote>
<ul>
<li>JDK9å¼•å…¥äº†AOTç¼–è¯‘å™¨ï¼ˆé™æ€æå‰ç¼–è¯‘å™¨ï¼ŒAhead of Time Compilerï¼‰</li>
<li>Java 9å¼•å…¥äº†å®éªŒæ€§AOTç¼–è¯‘å·¥å…·jaotcã€‚å®ƒå€ŸåŠ©äº†Graalç¼–è¯‘å™¨ï¼Œå°†æ‰€è¾“å…¥çš„Javaç±»æ–‡ä»¶è½¬æ¢æˆ‘æœºå™¨ç ï¼Œå¹¶å­˜æ”¾è‡³ç”Ÿæˆçš„åŠ¨æ€å…±äº«åº“ä¸­ã€‚</li>
<li>æ‰€è°“AOTç¼–è¯‘å™¨ï¼Œæ˜¯ä¸å³æ—¶ç¼–è¯‘å™¨ç›¸å¯¹ç«‹çš„ä¸€ä¸ªæ¦‚å¿µã€‚å³æ—¶ç¼–è¯‘æŒ‡çš„æ˜¯åœ¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå°†å­—èŠ‚ç è½¬æ¢ä¸ºå¯åœ¨ç¡¬ä»¶ä¸Šç›´æ¥è¿è¡Œçš„æœºå™¨ç ï¼Œå¹¶éƒ¨ç½²è‡³æ‰˜ç®¡ç¯å¢ƒä¸­çš„è¿‡ç¨‹ã€‚è€ŒAOTç¼–è¯‘æŒ‡çš„åˆ™æ˜¯ï¼Œåœ¨ç¨‹åºè¿è¡Œä¹‹å‰ï¼Œä¾¿å°†å­—èŠ‚ç è½¬æ¢ä¸ºæœºå™¨ç çš„è¿‡ç¨‹ã€‚</li>
</ul>
<p>å¥½å¤„ï¼šJavaè™šæ‹ŸæœºåŠ è½½å·²ç»é¢„ç¼–è¯‘æˆäºŒè¿›åˆ¶åº“ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œã€‚ä¸å¿…ç­‰å¾…å³æ—¶ç¼–è¯‘å™¨çš„é¢„çƒ­ï¼Œå‡å°‘Javaåº”ç”¨ç»™äººå¸¦æ¥â€œç¬¬ä¸€æ¬¡è¿è¡Œæ…¢â€çš„ä¸è‰¯ä½“éªŒã€‚</p>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>ç ´åäº†Javaâ€œä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œâ€çš„ç‰¹ç‚¹ï¼Œå¿…é¡»ä¸ºæ¯ä¸ªä¸åŒç¡¬ä»¶ã€OSç¼–è¯‘å¯¹åº”çš„å‘è¡ŒåŒ…ã€‚</p>
</li>
<li><p>é™ä½äº†Javaé“¾æ¥è¿‡ç¨‹çš„åŠ¨æ€æ€§ï¼ŒåŠ è½½çš„ä»£ç åœ¨ç¼–è¯‘æœŸå°±å¿…é¡»å…¨éƒ¨å·²çŸ¥ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-13(åƒåœ¾å›æ”¶ç®—æ³•)</title>
    <url>/posts/25/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="13-1-ğŸ“–-åƒåœ¾å›æ”¶æ¦‚è¿°"><a href="#13-1-ğŸ“–-åƒåœ¾å›æ”¶æ¦‚è¿°" class="headerlink" title="13.1 ğŸ“– åƒåœ¾å›æ”¶æ¦‚è¿°"></a>13.1 ğŸ“– åƒåœ¾å›æ”¶æ¦‚è¿°</h2><blockquote>
<p>ğŸ—‘ï¸ ä»€ä¹ˆæ˜¯åƒåœ¾</p>
</blockquote>
<p>åƒåœ¾æ˜¯æŒ‡åœ¨è¿è¡Œç¨‹åºä¸­æ²¡æœ‰ä»»ä½•æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯éœ€è¦è¢«å›æ”¶çš„åƒåœ¾ã€‚</p>
<p>å¦‚æœä¸åŠæ—¶å¯¹å†…å­˜ä¸­çš„åƒåœ¾è¿›è¡Œæ¸…ç†ï¼Œé‚£ä¹ˆï¼Œè¿™äº›åƒåœ¾å¯¹è±¡æ‰€å çš„å†…å­˜ç©ºé—´ä¼šä¸€ç›´ä¿ç•™åˆ°åº”ç”¨ç¨‹åºçš„ç»“æŸï¼Œè¢«ä¿ç•™çš„ç©ºé—´æ— æ³•è¢«å…¶å®ƒå¯¹è±¡ä½¿ç”¨ï¼Œç”šè‡³å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚</p>
<blockquote>
<p>â“ å¤§å‚é¢è¯•é¢˜</p>
</blockquote>
<p><strong>èš‚èšé‡‘æœ</strong></p>
<ul>
<li>ä½ çŸ¥é“å“ªå‡ ç§åƒåœ¾å›æ”¶å™¨ï¼Œå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œé‡ç‚¹è®²ä¸€ä¸‹cmså’ŒG1ï¼Ÿ</li>
<li>JVM GCç®—æ³•æœ‰å“ªäº›ï¼Œç›®å‰çš„JDKç‰ˆæœ¬é‡‡ç”¨ä»€ä¹ˆå›æ”¶ç®—æ³•ï¼Ÿ</li>
<li>G1å›æ”¶å™¨è®²ä¸‹å›æ”¶è¿‡ç¨‹GCæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦æœ‰GCï¼Ÿ</li>
<li>GCçš„ä¸¤ç§åˆ¤å®šæ–¹æ³•ï¼ŸCMSæ”¶é›†å™¨ä¸G1æ”¶é›†å™¨çš„ç‰¹ç‚¹ã€‚</li>
</ul>
<p><strong>ç™¾åº¦</strong></p>
<ul>
<li>è¯´ä¸€ä¸‹GCç®—æ³•ï¼Œåˆ†ä»£å›æ”¶è¯´ä¸‹ã€‚</li>
<li>åƒåœ¾ç­–ç•¥å’Œç®—æ³•ã€‚</li>
</ul>
<p><strong>å¤©çŒ«</strong></p>
<ul>
<li>JVM GCåŸç†ï¼ŒJVMæ€ä¹ˆå›æ”¶å†…å­˜ã€‚</li>
<li>CMSç‰¹ç‚¹ï¼Œåƒåœ¾å›æ”¶ç®—æ³•æœ‰å“ªäº›ï¼Ÿå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œä»–ä»¬å…±åŒçš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</li>
</ul>
<p><strong>æ»´æ»´</strong></p>
<p>Javaçš„åƒåœ¾å›æ”¶å™¨éƒ½æœ‰å“ªäº›ï¼Œè¯´ä¸‹G1çš„åº”ç”¨åœºæ™¯ï¼Œå¹³æ—¶ä½ æ˜¯å¦‚ä½•æ­é…ä½¿ç”¨åƒåœ¾å›æ”¶å™¨çš„ã€‚</p>
<p><strong>äº¬ä¸œ</strong></p>
<ul>
<li>ä½ çŸ¥é“å“ªå‡ ç§åƒåœ¾å™¨ï¼Œå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œé‡ç‚¹è®²ä¸‹CMSå’ŒG1ã€‚</li>
<li>åŒ…æ‹¬åŸç†ï¼Œæµç¨‹ï¼Œä¼˜ç¼ºç‚¹ã€‚åƒåœ¾å›æ”¶ç®—æ³•çš„å®ç°åŸç†ã€‚</li>
</ul>
<p><strong>é˜¿é‡Œå·´å·´</strong></p>
<ul>
<li>è®²ä¸€è®²åƒåœ¾å›æ”¶ç®—æ³•ã€‚</li>
<li>ä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘åƒåœ¾å›æ”¶ï¼Ÿ</li>
<li>å¦‚ä½•é€‰æ‹©åˆé€‚çš„åƒåœ¾ç®—æ³•ï¼Ÿ</li>
<li>JVMæœ‰å“ªä¸‰ç§åƒåœ¾å›æ”¶å™¨ï¼Ÿ</li>
</ul>
<p><strong>å­—èŠ‚è·³åŠ¨</strong></p>
<ul>
<li>å¸¸è§çš„åƒåœ¾å›æ”¶å™¨ç®—æ³•æœ‰å“ªäº›ï¼Œå„æœ‰ä»€ä¹ˆä¼˜åŠ£ï¼Ÿ</li>
<li>System.gcï¼ˆï¼‰å’ŒRuntime.gcï¼ˆï¼‰ä¼šåšä»€ä¹ˆäº‹æƒ…ï¼Ÿ</li>
<li>Java GCæœºåˆ¶ï¼ŸGC Rootsæœ‰å“ªäº›ï¼Ÿ</li>
<li>Javaå¯¹è±¡çš„å›æ”¶æ–¹å¼ï¼Œå›æ”¶ç®—æ³•ã€‚</li>
<li>CMSå’ŒG1äº†è§£ä¹ˆï¼ŒCMSè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œè¯´ä¸€ä¸‹å›æ”¶çš„è¿‡ç¨‹ã€‚</li>
<li>CMSå›æ”¶åœé¡¿äº†å‡ æ¬¡ï¼Œä¸ºä»€ä¹ˆè¦åœé¡¿ä¸¤æ¬¡?</li>
</ul>
<blockquote>
<p>â™»  GC</p>
</blockquote>
<p>å¯¹äºé«˜çº§è¯­è¨€æ¥è¯´ï¼Œä¸€ä¸ªåŸºæœ¬è®¤çŸ¥æ˜¯å¦‚æœä¸è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå†…å­˜è¿Ÿæ—©éƒ½ä¼šè¢«æ¶ˆè€—å®Œï¼Œå› ä¸ºä¸æ–­åœ°åˆ†é…å†…å­˜ç©ºé—´è€Œä¸è¿›è¡Œå›æ”¶ï¼Œå°±å¥½åƒä¸åœåœ°ç”Ÿäº§ç”Ÿæ´»åƒåœ¾è€Œä»æ¥ä¸æ‰“æ‰«ä¸€æ ·ã€‚</p>
<p>é™¤äº†é‡Šæ”¾æ²¡ç”¨çš„å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶ä¹Ÿå¯ä»¥æ¸…é™¤å†…å­˜é‡Œçš„è®°å½•ç¢ç‰‡ã€‚ç¢ç‰‡æ•´ç†å°†æ‰€å ç”¨çš„å †å†…å­˜ç§»åˆ°å †çš„ä¸€ç«¯ï¼Œä»¥ä¾¿JVMå°†æ•´ç†å‡ºçš„å†…å­˜åˆ†é…ç»™æ–°çš„å¯¹è±¡ã€‚</p>
<p>éšç€åº”ç”¨ç¨‹åºæ‰€åº”ä»˜çš„ä¸šåŠ¡è¶Šæ¥è¶Šåºå¤§ã€å¤æ‚ï¼Œç”¨æˆ·è¶Šæ¥è¶Šå¤šï¼Œæ²¡æœ‰GCå°±ä¸èƒ½ä¿è¯åº”ç”¨ç¨‹åºçš„æ­£å¸¸è¿›è¡Œã€‚è€Œç»å¸¸é€ æˆSTWçš„GCåˆè·Ÿä¸ä¸Šå®é™…çš„éœ€æ±‚ï¼Œæ‰€ä»¥æ‰ä¼šä¸æ–­åœ°å°è¯•å¯¹GCè¿›è¡Œä¼˜åŒ–ã€‚</p>
<blockquote>
<p>ğŸ”° åƒåœ¾å›æ”¶æœºåˆ¶</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<p>è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œæ— éœ€å¼€å‘äººå‘˜æ‰‹åŠ¨å‚ä¸å†…å­˜çš„åˆ†é…ä¸å›æ”¶ï¼Œè¿™æ ·é™ä½å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºçš„é£é™©ã€‚</p>
<p>æ²¡æœ‰åƒåœ¾å›æ”¶å™¨ï¼Œjavaä¹Ÿä¼šå’Œcppä¸€æ ·ï¼Œå„ç§æ‚¬å‚æŒ‡é’ˆï¼Œé‡æŒ‡é’ˆï¼Œæ³„éœ²é—®é¢˜è®©ä½ å¤´ç–¼ä¸å·²ã€‚</p>
<p>è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå°†ç¨‹åºå‘˜ä»ç¹é‡çš„å†…å­˜ç®¡ç†ä¸­é‡Šæ”¾å‡ºæ¥ï¼Œå¯ä»¥æ›´ä¸“å¿ƒåœ°ä¸“æ³¨äºä¸šåŠ¡å¼€å‘ã€‚</p>
<p>oracleå®˜ç½‘å…³äºåƒåœ¾å›æ”¶çš„ä»‹ç» <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html</a></p>
<p>æ‹…å¿§ï¼š</p>
<p>å¯¹äºJavaå¼€å‘äººå‘˜è€Œè¨€ï¼Œè‡ªåŠ¨å†…å­˜ç®¡ç†å°±åƒæ˜¯ä¸€ä¸ªé»‘åŒ£å­ï¼Œå¦‚æœè¿‡åº¦ä¾èµ–äºâ€œè‡ªåŠ¨â€ï¼Œé‚£ä¹ˆè¿™å°†ä¼šæ˜¯ä¸€åœºç¾éš¾ï¼Œæœ€ä¸¥é‡çš„å°±ä¼šå¼±åŒ–Javaå¼€å‘äººå‘˜åœ¨ç¨‹åºå‡ºç°å†…å­˜æº¢å‡ºæ—¶å®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜çš„èƒ½åŠ›ã€‚</p>
<p>æ­¤æ—¶ï¼Œäº†è§£JVMçš„è‡ªåŠ¨å†…å­˜åˆ†é…å’Œå†…å­˜å›æ”¶åŸç†å°±æ˜¾å¾—éå¸¸é‡è¦ï¼Œåªæœ‰åœ¨çœŸæ­£äº†è§£JVMæ˜¯å¦‚ä½•ç®¡ç†å†…å­˜åï¼Œæˆ‘ä»¬æ‰èƒ½å¤Ÿåœ¨é‡è§outofMemoryErroræ—¶ï¼Œå¿«é€Ÿåœ°æ ¹æ®é”™è¯¯å¼‚å¸¸æ—¥å¿—å®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜ã€‚</p>
<p>å½“éœ€è¦æ’æŸ¥å„ç§å†…å­˜æº¢å‡ºã€å†…å­˜æ³„æ¼é—®é¢˜æ—¶ï¼Œå½“åƒåœ¾æˆä¸ºç³»ç»Ÿè¾¾åˆ°æ›´é«˜å¹¶å‘é‡çš„ç“¶é¢ˆæ—¶ï¼Œæˆ‘ä»¬å°±å¿…é¡»å¯¹è¿™äº›â€œè‡ªåŠ¨åŒ–â€çš„æŠ€æœ¯å®æ–½å¿…è¦çš„ç›‘æ§å’Œè°ƒèŠ‚ã€‚</p>
<p>GCä¸»è¦å…³æ³¨çš„åŒºåŸŸï¼šå †å’Œæ–¹æ³•åŒºã€‚</p>
<h2 id="13-2-ğŸ³â€ğŸŒˆ-æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•"><a href="#13-2-ğŸ³â€ğŸŒˆ-æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•" class="headerlink" title="13.2 ğŸ³â€ğŸŒˆ æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•"></a>13.2 ğŸ³â€ğŸŒˆ æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>å¼•ç”¨è®¡æ•°ç®—æ³•ï¼ˆReference Countingï¼‰æ¯”è¾ƒç®€å•ï¼Œå¯¹æ¯ä¸ªå¯¹è±¡ä¿å­˜ä¸€ä¸ªæ•´å‹çš„å¼•ç”¨è®¡æ•°å™¨å±æ€§ã€‚ç”¨äºè®°å½•å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µã€‚</li>
<li>å¯¹ä¸€ä¸ªå¯¹è±¡Aï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå¯¹è±¡å¼•ç”¨äº†Aï¼Œåˆ™Açš„è®¡æ•°å™¨å°±åŠ ä¸€ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œå¼•ç”¨è®¡æ•°å™¨å°±å‡ä¸€ã€‚åªè¦å¯¹è±¡Açš„å¼•ç”¨è®¡æ•°å™¨çš„å€¼ä¸º0ï¼Œå³è¡¨ç¤ºå¯¹è±¡Aä¸å¯èƒ½å†è¢«ä½¿ç”¨ï¼Œå¯è¿›è¡Œå›æ”¶ã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å®ç°ç®€å•ï¼Œåƒåœ¾å¯¹è±¡ä¾¿äºè¾¨è¯†ã€‚</li>
<li>åˆ¤å®šæ•ˆç‡é«˜ï¼Œå›æ”¶æ²¡æœ‰å»¶è¿Ÿæ€§ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>å®ƒéœ€è¦å•ç‹¬çš„å­—æ®µå­˜å‚¨è®¡æ•°å™¨ï¼Œè¿™æ ·çš„åšæ³•å¢åŠ äº†å­˜å‚¨ç©ºé—´çš„å¼€é”€ã€‚</li>
<li>æ¯æ¬¡èµ‹å€¼éƒ½éœ€è¦æ›´æ–°è®¡æ•°å™¨ï¼Œä¼´éšç€åŠ æ³•å’Œå‡æ³•æ“ä½œï¼Œå¢åŠ äº†æ—¶é—´å¼€é”€ã€‚</li>
<li>å¼•ç”¨è®¡æ•°å™¨æœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå³æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„æƒ…å†µã€‚è¿™æ˜¯ä¸€æ¡è‡´å‘½ç¼ºé™·ï¼Œå¯¼è‡´åœ¨Javaçš„åƒåœ¾å›æ”¶å™¨ä¸­æ²¡æœ‰ä½¿ç”¨è¿™ç±»ç®—æ³•ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“¸ å¾ªç¯å¼•ç”¨</p>
</blockquote>
<p>å†…å­˜æ³„éœ²ï¼šç¨‹åºä¸­å·²åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› ç¨‹åºæœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœã€‚</p>
<br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/25/image-20210309175155047.png" class="" title="image-20210309175155047"><br />

<br>


<blockquote>
<p>ğŸ“‘ å°ç»“</p>
</blockquote>
<ul>
<li>å¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œæ˜¯å¾ˆå¤šè¯­è¨€çš„èµ„æºå›æ”¶é€‰æ‹©ï¼Œä¾‹å¦‚Pythonï¼Œå®ƒæ›´æ˜¯åŒæ—¶æ”¯æŒå¼•ç”¨è®¡æ•°å’Œåƒåœ¾æœºåˆ¶ã€‚</li>
<li>Javaå¹¶æ²¡æœ‰é€‰æ‹©å¼•ç”¨è®¡æ•°ï¼Œæ˜¯å› ä¸ºå…¶å­˜åœ¨ä¸€ä¸ªåŸºæœ¬çš„éš¾é¢˜ï¼Œä¹Ÿå°±æ˜¯å¾ˆéš¾å¤„ç†å¾ªç¯å¼•ç”¨å…³ç³»ã€‚</li>
<li>Pythonå¦‚ä½•è§£å†³å¾ªç¯å¼•ç”¨ï¼š<ul>
<li>æ‰‹åŠ¨è§£é™¤ï¼šåœ¨åˆé€‚çš„æ—¶æœºï¼Œè§£é™¤å¼•ç”¨å…³ç³»ã€‚</li>
<li>ä½¿ç”¨å¼±å¼•ç”¨weakrefï¼ˆPythonæ ‡å‡†åº“ï¼Œæ—¨åœ¨è§£å†³å¾ªç¯å¼•ç”¨ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h2 id="13-3-ğŸ¦†-æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#13-3-ğŸ¦†-æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="13.3 ğŸ¦† æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•"></a>13.3 ğŸ¦† æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>ç›¸å¯¹äºå¼•ç”¨è®¡æ•°ç®—æ³•è€Œè¨€ï¼Œå¯è¾¾æ€§åˆ†æç®—æ³•ä¸ä»…åŒæ ·å…·å¤‡å®ç°ç®€å•å’Œæ‰§è¡Œé«˜æ•ˆç­‰ç‰¹ç‚¹ï¼Œæ›´é‡è¦çš„æ˜¯æ”¹ç®—æ³•å¯ä»¥æœ‰æ•ˆåœ°è§£å†³åœ¨å¼•ç”¨è®¡æ•°ç®—æ³•ä¸­å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²å‘ç”Ÿã€‚</li>
<li>ç›¸è¾ƒäºå¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œè¿™é‡Œçš„å¯è¾¾æ€§åˆ†æå°±æ˜¯Javaã€C#é€‰æ‹©çš„ã€‚è¿™ç§ç±»å‹çš„åƒåœ¾é€šå¸¸ä¹Ÿå«ä½œè¿½è¸ªæ€§åƒåœ¾ï¼ˆTracing Garbage Collectionï¼‰</li>
</ul>
<blockquote>
<p>ğŸ” æ€è·¯</p>
</blockquote>
<ul>
<li>å¯è¾¾æ€§åˆ†æç®—æ³•æ˜¯ä»¥æ ¹å¯¹è±¡é›†åˆï¼ˆGC Rootsï¼‰ä¸ºèµ·å§‹ç‚¹ï¼ŒæŒ‰ç…§ä»ä¸Šè‡³ä¸‹çš„æ–¹å¼æœç´¢è¢«æ ¹å¯¹è±¡é›†åˆæ‰€è¿æ¥çš„ç›®æ ‡å¯¹è±¡æ˜¯å¦å¯è¾¾ã€‚</li>
<li>ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•åï¼Œå†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡éƒ½ä¼šè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–é—´æ¥è¿æ¥ç€ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼ˆReference Chainï¼‰ã€‚</li>
<li>å¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼Œåˆ™æ˜¯ä¸å¯è¾¾çš„ï¼Œå°±æ„å‘³ç€è¯¥å¯¹è±¡å·²ç»æ­»äº¡ï¼Œå¯ä»¥æ ‡è®°ä¸ºåƒåœ¾å¯¹è±¡ã€‚</li>
<li>åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­ï¼Œåªæœ‰èƒ½å¤Ÿè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–è€…é—´æ¥è¿æ¥çš„å¯¹è±¡æ‰æ˜¯å­˜æ´»å¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>â™ GC Roots</p>
</blockquote>
<ul>
<li><p>è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡</p>
</li>
<li><p>æœ¬åœ°æ–¹æ³•æ ˆå†…JNIï¼ˆæœ¬åœ°æ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡</p>
</li>
<li><p>æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</p>
</li>
<li><p>æ‰€æœ‰è¢«åŒæ­¥é”synchronizedæŒæœ‰çš„å¯¹è±¡</p>
</li>
<li><p>Javaè™šæ‹Ÿæœºå†…éƒ¨çš„å¼•ç”¨</p>
</li>
<li><p>åæ˜ Javaè™šæ‹Ÿæœºå†…éƒ¨æƒ…å†µçš„JMXBeanã€JVMTIä¸­æ³¨å†Œçš„å›è°ƒã€æœ¬åœ°ä»£ç ç¼“å­˜ç­‰</p>
</li>
<li><p>é™¤äº†è¿™äº›å›ºå®šçš„GC Rootsé›†åˆä»¥å¤–ï¼Œæ ¹æ®ç”¨æˆ·æ‰€é€‰ç”¨çš„åƒåœ¾å™¨ä»¥åŠå½“å‰å›æ”¶çš„å†…å­˜åŒºåŸŸä¸åŒï¼Œè¿˜å¯ä»¥æœ‰å…¶ä»–å¯¹è±¡â€œä¸´æ—¶æ€§â€åœ°åŠ å…¥ï¼Œå…±åŒæ„æˆå®Œæ•´GC Rootsé›†åˆã€‚æ¯”å¦‚ï¼šåˆ†ä»£å’Œå±€éƒ¨å›æ”¶ã€‚</p>
</li>
<li><ul>
<li>å¦‚æœåªé’ˆå¯¹Javaå †åŒºä¸­çš„æŸä¸€å—åŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå¿…é¡»è€ƒè™‘åˆ°å†…å­˜åŒºåŸŸæ˜¯è™šæ‹Ÿæœºè‡ªå·±çš„å®ç°ç»†èŠ‚ï¼Œæ›´ä¸æ˜¯å­¤ç«‹å°é—­çš„ï¼Œè¿™ä¸ªåŒºåŸŸçš„å¯¹è±¡å®Œå…¨æœ‰å¯èƒ½è¢«å…¶ä»–åŒºåŸŸçš„å¯¹è±¡æ‰€å¼•ç”¨ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä¸€å¹¶å°†å…³è”çš„åŒºåŸŸå¯¹è±¡ä¹ŸåŠ å…¥GC Rootsé›†åˆä¸­å»è€ƒè™‘ï¼Œæ‰èƒ½ä¿è¯å¯è¾¾æ€§åˆ†æçš„å‡†ç¡®æ€§ã€‚</li>
</ul>
</li>
<li><p>å°æŠ€å·§ï¼šç”±äºæ ˆæ–¹å¼å­˜æ”¾å˜é‡å’ŒæŒ‡é’ˆï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒä¿å­˜äº†å †å†…å­˜é‡Œé¢çš„å¯¹è±¡ï¼Œä½†æ˜¯è‡ªå·±ç”±ä¸å­˜æ”¾åœ¨å †å†…å­˜é‡Œé¢ï¼Œé‚£å®ƒå°±æ˜¯ä¸€ä¸ªRootã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸŸ¨ æ³¨æ„</p>
</blockquote>
<ul>
<li>å¦‚æœè¦ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•æ¥åˆ¤æ–­å†…å­˜æ˜¯å¦å¯å›æ”¶ï¼Œé‚£ä¹ˆåˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½å¤Ÿä¿éšœä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œã€‚è¿™ç‚¹éƒ½ä¸æ»¡è¶³çš„è¯åˆ†æç»“æœçš„å‡†ç¡®æ€§å°±æ— æ³•ä¿è¯ã€‚</li>
<li>è¿™ç‚¹ä¹Ÿæ˜¯å¯¼è‡´GCè¿›è¡Œæ—¶å¿…é¡»â€Stop the worldâ€çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚å³ä½¿æ˜¯ï¼ˆå‡ ä¹ï¼‰ä¸ä¼šåœé¡¿çš„CMSæ”¶é›†å™¨ä¸­ï¼Œæšä¸¾æ ¹èŠ‚ç‚¹æ—¶ä¹Ÿæ˜¯å¿…é¡»è¦åœé¡¿çš„ã€‚</li>
</ul>
<h2 id="13-4-ğŸ-å¯¹è±¡çš„finalizationæœºåˆ¶"><a href="#13-4-ğŸ-å¯¹è±¡çš„finalizationæœºåˆ¶" class="headerlink" title="13.4 ğŸ å¯¹è±¡çš„finalizationæœºåˆ¶"></a>13.4 ğŸ å¯¹è±¡çš„finalizationæœºåˆ¶</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li><p>Javaè¯­è¨€æä¾›äº†å¯¹è±¡ç»ˆæ­¢ï¼ˆfinalizationï¼‰æœºåˆ¶æ¥å…è®¸å¼€å‘äººå‘˜æä¾›å¯¹è±¡è¢«é”€æ¯ä¹‹å‰çš„è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚</p>
</li>
<li><p>å½“åƒåœ¾å›æ”¶å™¨å‘ç°æ²¡æœ‰å¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå³ï¼šåƒåœ¾å›æ”¶æ­¤å¯¹è±¡ä¹‹å‰ï¼Œæ€»ä¼šå…ˆè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•ã€‚</p>
</li>
<li><p>finalize()æ–¹æ³•å…è®¸åœ¨å­ç±»ä¸­è¢«é‡å†™ï¼Œç”¨äºåœ¨å¯¹è±¡è¢«å›æ”¶æ—¶è¿›è¡Œèµ„æºé‡Šæ”¾ã€‚é€šå¸¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æºé‡Šæ”¾å’Œæ¸…ç†çš„å·¥ä½œï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶ã€å¥—æ¥å­—å’Œæ•°æ®åº“è¿æ¥ç­‰ã€‚</p>
</li>
<li><p>æ°¸è¿œä¸è¦ä¸»åŠ¨è°ƒç”¨æŸä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•ï¼Œåº”è¯¥äº¤ç»™åƒåœ¾æœºåˆ¶è°ƒç”¨ã€‚ç†ç”±å¦‚ä¸‹ï¼š</p>
</li>
<li><ul>
<li>åœ¨finalize()æ—¶å¯èƒ½ä¼šå¯¼è‡´å¯¹è±¡å¤æ´»ã€‚</li>
<li>finalize()æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´æ˜¯æ²¡æœ‰ä¿éšœçš„ï¼Œå®ƒå®Œå…¨ç”±GCçº¿ç¨‹å†³å®šï¼Œæç«¯æƒ…å†µä¸‹ï¼Œè‹¥ä¸å‘ç”ŸGCï¼Œåˆ™finalize()æ–¹æ³•å°†æ²¡æœ‰æ‰§è¡Œæœºä¼šã€‚</li>
<li>ä¸€ä¸ªç³Ÿç³•çš„finalize()ä¼šä¸¥é‡å½±å“GCçš„æ€§èƒ½ã€‚</li>
</ul>
</li>
<li><p>ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œfinalize()æ–¹æ³•ä¸Cä¸­çš„ææ„å‡½æ•°æ¯”è¾ƒç›¸ä¼¼ï¼Œä½†æ˜¯Javaé‡‡ç”¨çš„æ˜¯åŸºäºåƒåœ¾å›æ”¶å™¨çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæ‰€ä»¥finalize()æ–¹æ³•åœ¨æœ¬è´¨ä¸Šä¸ç”¨äºCä¸­çš„ææ„å‡½æ•°ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ¼ çŠ¶æ€</p>
</blockquote>
<p>ç”±äºfinalize()æ–¹æ³•çš„å­˜åœ¨ï¼Œè™šæ‹Ÿæœºä¸­çš„å¯¹è±¡ä¸€èˆ¬å¤„äºä¸‰ç§å¯èƒ½çš„çŠ¶æ€ã€‚</p>
<p>å¦‚æœä»æ‰€æœ‰çš„æ ¹èŠ‚ç‚¹éƒ½æ— æ³•è®¿é—®åˆ°æŸä¸ªå¯¹è±¡ï¼Œè¯´æ˜å¯¹è±¡å·²ç»ä¸å†ä½¿ç”¨äº†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ­¤å¯¹è±¡éœ€è¦è¢«å›æ”¶ã€‚ä½†äº‹å®ä¸Šï¼Œä¹Ÿå¹¶éæ˜¯â€œéæ­»ä¸å¯â€çš„ï¼Œè¿™æ—¶å€™å®ƒä»¬æš‚æ—¶å¤„äºâ€œç¼“åˆ‘â€é˜¶æ®µã€‚ä¸€ä¸ªæ— æ³•è§¦åŠçš„å¯¹è±¡æœ‰å¯èƒ½åœ¨æŸä¸€ä¸ªæ¡ä»¶ä¸‹â€œå¤æ´»â€è‡ªå·±ï¼Œå¦‚æœè¿™æ ·ï¼Œé‚£ä¹ˆå¯¹å®ƒçš„å›æ”¶å°±æ˜¯ä¸åˆç†çš„ï¼Œä¸ºæ­¤ï¼Œå®šä¹‰è™šæ‹Ÿæœºä¸­çš„å¯¹è±¡å¯èƒ½çš„ä¸‰ç§çŠ¶æ€ã€‚</p>
<p>å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¯è§¦åŠçš„ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå¯ä»¥åˆ°è¾¾è¿™ä¸ªå¯¹è±¡ã€‚</li>
<li>å¯å¤æ´»çš„ï¼šå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨éƒ½è¢«é‡Šæ”¾ï¼Œä½†æ˜¯å¯¹è±¡æœ‰å¯èƒ½åœ¨finalize()ä¸­å¤æ´»ã€‚</li>
<li>ä¸å¯è§¦åŠçš„ï¼šå¯¹è±¡çš„finalize()è¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ²¡æœ‰å¤æ´»ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥ä¸å¯è§¦åŠçŠ¶æ€ã€‚ä¸å¯è§¦åŠçš„å¯¹è±¡ä¸å¯èƒ½è¢«å¤æ´»ï¼Œå› ä¸ºfinalize()åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</li>
</ul>
<p>ä»¥ä¸Šä¸‰ç§çŠ¶æ€ä¸­ï¼Œæ˜¯ç”±äºfinalize()æ–¹æ³•çš„å­˜åœ¨ï¼Œè¿›è¡Œçš„åŒºåˆ†ã€‚åªæœ‰åœ¨å¯¹è±¡ä¸å¯è§¦åŠæ—¶æ‰å¯ä»¥è¢«å›æ”¶ã€‚</p>
<blockquote>
<p>â³ æ‰§è¡Œè¿‡ç¨‹</p>
</blockquote>
<p>åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡objAæ˜¯å¦å¯å›æ”¶ï¼Œè‡³å°‘è¦ç»å†ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ï¼š</p>
<ol>
<li><p>å¦‚æœå¯¹è±¡objAåˆ°GC Rootsæ²¡æœ‰å¼•ç”¨é“¾ï¼Œåˆ™è¿›è¡Œç¬¬ä¸€æ¬¡æ ‡è®°ã€‚</p>
</li>
<li><p>è¿›è¡Œç­›é€‰ï¼Œåˆ¤æ–­æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ï¼š</p>
</li>
<li><ol>
<li>å¦‚æœå¯¹è±¡objAæ²¡æœ‰é‡å†™finalize()æ–¹æ³•ï¼Œæˆ–è€…finalize()æ–¹æ³•å·²ç»è¢«è™šæ‹Ÿæœºè°ƒç”¨è¿‡ï¼Œåˆ™è™šæ‹Ÿæœºè§†ä¸ºâ€œæ²¡æœ‰å¿…è¦æ‰§è¡Œâ€ï¼ŒobjAè¢«åˆ¤å®šä¸ºä¸å¯è§¦åŠçš„ã€‚</li>
<li>å¦‚æœå¯¹è±¡objAé‡å†™äº†finalize()æ–¹æ³•ï¼Œä¸”è¿˜æœªæ‰§è¡Œè¿‡ï¼Œé‚£ä¹ˆobjAä¼šæ’å…¥åˆ°F-Queueé˜Ÿåˆ—ä¸­ï¼Œç”±ä¸€ä¸ªè™šæ‹Ÿæœºè‡ªåŠ¨åˆ›å»ºçš„ã€ä½ä¼˜å…ˆçº§çš„Finalizerçº¿ç¨‹è§¦å‘å…¶finalize()æ–¹æ³•æ‰§è¡Œã€‚</li>
<li>finalize()æ–¹æ³•æ˜¯å¯¹è±¡é€ƒè„±æ­»äº¡çš„æœ€åæœºä¼šï¼Œç¨åGCä¼šå¯¹F-Queueé˜Ÿåˆ—ä¸­çš„å¯¹è±¡è¿›è¡Œç¬¬äºŒæ¬¡æ ‡è®°ã€‚å¦‚æœobjAåœ¨finalize()æ–¹æ³•ä¸­ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹äº†è”ç³»ï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒæ¬¡æ ‡è®°æ—¶ï¼ŒobjAä¼šè¢«ç§»å‡ºâ€œå³å°†å›æ”¶â€é›†åˆã€‚ä¹‹åï¼Œå¯¹è±¡ä¼šå†æ¬¡å‡ºç°æ²¡æœ‰å¼•ç”¨å­˜åœ¨çš„æƒ…å†µã€‚åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œfinalizeæ–¹æ³•ä¸ä¼šè¢«å†æ¬¡è°ƒç”¨ï¼Œå¯¹è±¡ä¼šç›´æ¥ç¼–ç¨‹ä¸å¯è§¦åŠçš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªå¯¹è±¡çš„finalizeæ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚ã€åˆ€ä¸‹ç•™äººï¼Œåªæœ‰ä¸€æ¬¡ã€‚ã€‘</li>
</ol>
</li>
</ol>
<h2 id="13-5-ğŸ§°-MATçš„GC-Rootsæº¯æº"><a href="#13-5-ğŸ§°-MATçš„GC-Rootsæº¯æº" class="headerlink" title="13.5 ğŸ§° MATçš„GC Rootsæº¯æº"></a>13.5 ğŸ§° MATçš„GC Rootsæº¯æº</h2><blockquote>
<p>â¬‡ï¸ ä¸‹è½½</p>
</blockquote>
<p>å®˜ç½‘ï¼š<a href="https://www.eclipse.org/mat/">https://www.eclipse.org/mat/</a></p>
<blockquote>
<p>ğŸ“°è·å–dumpæ–‡ä»¶</p>
</blockquote>
<p>åº”ç”¨ç¨‹åº -&gt; è¿›ç¨‹ -&gt; ç›‘è§† -&gt; å †dump -&gt; å³é”®ä¿å­˜</p>
<h2 id="13-6-ğŸ³â€ğŸŒˆ-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#13-6-ğŸ³â€ğŸŒˆ-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="13.6 ğŸ³â€ğŸŒˆ æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•"></a>13.6 ğŸ³â€ğŸŒˆ æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•</h2><blockquote>
<p>ğŸŒƒ èƒŒæ™¯</p>
</blockquote>
<p>æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark-Sweepï¼‰æ˜¯ä¸€ç§éå¸¸åŸºç¡€å’Œå¸¸è§çš„åƒåœ¾ç®—æ³•ï¼Œè¯¥ç®—æ³•è¢«J.McCarthyç­‰äººåœ¨1960å¹´æå‡ºå¹¶åº”ç”¨äºLispè¯­è¨€ã€‚</p>
<blockquote>
<p>â³ æ‰§è¡Œè¿‡ç¨‹</p>
</blockquote>
<p>å½“å †ä¸­çš„æœ‰æ•ˆå†…å­˜ç©ºé—´ï¼ˆavailable memoryï¼‰ç­‰è¢«è€—å°½çš„æ—¶å€™ï¼Œå°±ä¼šåœæ­¢æ•´ä¸ªç¨‹åºï¼ˆä¹Ÿè¢«ç§°ä¸ºstop the worldï¼Œç®€ç§°STWï¼‰ï¼Œç„¶åè¿›è¡Œä¸¤é¡¹å·¥ä½œï¼Œç¬¬ä¸€é¡¹æ˜¯æ ‡è®°ï¼Œç¬¬äºŒé¡¹æ˜¯æ¸…é™¤ï¼š</p>
<ul>
<li>æ ‡è®°ï¼šCollectorä»å¼•ç”¨æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œæ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼ˆéåƒåœ¾å¯¹è±¡ï¼‰ã€‚ä¸€èˆ¬æ˜¯åœ¨å¯¹è±¡çš„Headerä¸­è®°å½•ä¸ºå¯è¾¾å¯¹è±¡ã€‚</li>
<li>æ¸…é™¤ï¼šCollectorå¯¹å †å†…å­˜ä»å¤´åˆ°å°¾è¿›è¡Œçº¿æ€§çš„éå†ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡åœ¨å…¶Headerä¸­æ²¡æœ‰æ ‡è®°ä¸ºå¯è¾¾å¯¹è±¡ï¼Œåˆ™å°†å…¶å›æ”¶ã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ•ˆç‡ä¸å¤Ÿé«˜ã€‚</li>
<li>åœ¨è¿›è¡ŒGCçš„æ—¶å€™ï¼Œéœ€è¦åœæ­¢æ•´ä¸ªåº”ç”¨ï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒå·®ã€‚</li>
<li>è¿™ç§æ–¹å¼æ¸…ç†å‡ºæ¥çš„ç©ºé—²å†…å­˜æ˜¯ä¸è¿ç»­çš„ï¼Œäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚éœ€è¦ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨ã€‚</li>
</ul>
<h2 id="13-7-ğŸ”˜-æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•"><a href="#13-7-ğŸ”˜-æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•" class="headerlink" title="13.7 ğŸ”˜ æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•"></a>13.7 ğŸ”˜ æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•</h2><blockquote>
<p>ğŸŒƒ èƒŒæ™¯</p>
</blockquote>
<p>ä¸ºäº†è§£å†³æ ‡è®°-æ¸…æ¥šç®—æ³•åœ¨åƒåœ¾æ•ˆç‡æ–¹é¢çš„ç¼ºé™·ï¼ŒM.L.Minskyäº1963å¹´å‘è¡¨äº†è‘—åçš„è®ºæ–‡ï¼Œâ€œä½¿ç”¨åŒå­˜å‚¨åŒºçš„Lispè¯­è¨€åƒåœ¾å™¨CALISP Garbage Collector Algorithm Using Serial Secondary Storageâ€ã€‚M.L.Minskyåœ¨è®ºæ–‡ä¸­æè¿°çš„ç®—æ³•è¢«äººä»¬ç§°ä¸ºå¤åˆ¶ç®—æ³•ï¼Œå®ƒä¹Ÿè¢«M.L.Minskyæœ¬äººæˆåŠŸåœ°å¼•å…¥åˆ°äº†Lispè¯­è¨€çš„ä¸€ä¸ªå®ç°ç‰ˆæœ¬ä¸­ã€‚</p>
<blockquote>
<p>ğŸ”°æ ¸å¿ƒæ€æƒ³</p>
</blockquote>
<p>å°†æ´»ç€çš„å†…å­˜ç©ºé—´åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶å°†æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æœªè¢«ä½¿ç”¨çš„å†…å­˜å—ä¸­ï¼Œä¹‹åæ¸…é™¤æ­£åœ¨ä½¿ç”¨çš„å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œäº¤æ¢ä¸¤ä¸ªå†…å­˜çš„è§’è‰²ï¼Œæœ€åå®Œæˆåƒåœ¾å›æ”¶ã€‚</p>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ²¡æœ‰æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆã€‚</li>
<li>å¤åˆ¶è¿‡å»ä»¥åä¿è¯ç©ºé—´çš„è¿ç»­æ€§ï¼Œä¸ä¼šå‡ºç°â€œç¢ç‰‡â€é—®é¢˜ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>éœ€è¦ä¸¤å€çš„å†…å­˜ç©ºé—´ã€‚</li>
<li>å¯¹äºG1è¿™ç§åˆ†æ‹†æˆä¸ºå¤§é‡regiençš„GCï¼Œå¤åˆ¶è€Œä¸æ˜¯ç§»åŠ¨ï¼Œæ„å‘³ç€GCéœ€è¦ç»´æŠ¤regionä¹‹é—´å¯¹è±¡å¼•ç”¨å…³ç³»ï¼Œä¸ç®¡æ˜¯å†…å­˜å ç”¨æˆ–è€…æ—¶é—´å¼€é”€ä¹Ÿä¸å°ã€‚</li>
</ul>
<p>ç‰¹åˆ«ï¼š</p>
<ul>
<li>å¦‚æœç³»ç»Ÿä¸­çš„åƒåœ¾å¯¹è±¡å¾ˆå¤šï¼Œå¤åˆ¶ç®—æ³•éœ€è¦å¤åˆ¶çš„å­˜æ´»å¯¹è±¡æ•°é‡å¹¶ä¸ä¼šå¤ªå¤§ï¼Œæˆ–è€…è¯´éå¸¸ä½æ‰è¡Œã€‚ï¼ˆè€å¹´ä»£çš„å¯¹è±¡å­˜æ´»ï¼Œé‚£ä¹ˆå¤åˆ¶çš„å¯¹è±¡å°†ä¼šæœ‰å¾ˆå¤šï¼Œæ•ˆç‡ä¼šå¾ˆä½ã€‚é€‚åˆä½¿ç”¨åœ¨æ–°ç”Ÿä»£å’Œå¹¸å­˜è€…åŒºï¼Œæœç”Ÿå¤•æ­»ã€‚ï¼‰</li>
</ul>
<h2 id="13-8-â›”-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-å‹ç¼©ç®—æ³•"><a href="#13-8-â›”-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-å‹ç¼©ç®—æ³•" class="headerlink" title="13.8 â›” æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-å‹ç¼©ç®—æ³•"></a>13.8 â›” æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-å‹ç¼©ç®—æ³•</h2><blockquote>
<p>ğŸŒƒ èƒŒæ™¯</p>
</blockquote>
<p>å¤åˆ¶ç®—æ³•çš„é«˜æ•ˆæ€§æ˜¯å»ºç«‹åœ¨å­˜æ´»å¯¹è±¡å°‘ã€åƒåœ¾å¯¹è±¡å¤šçš„å‰æä¸‹ã€‚è¿™ç§æƒ…å†µåœ¨æ–°ç”Ÿä»£ç»å¸¸å‘ç”Ÿï¼Œä½†æ˜¯åœ¨è€å¹´ä»£ï¼Œæ›´å¸¸è§çš„æƒ…å†µæ˜¯å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯å­˜æ´»å¯¹è±¡ã€‚å¦‚æœä¾ç„¶ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œç”±äºå­˜æ´»å¯¹è±¡è¾ƒå¤šï¼Œå¤åˆ¶çš„æˆæœ¬ä¹Ÿå°†å¾ˆé«˜ã€‚å› æ­¤ï¼ŒåŸºäºè€å¹´ä»£åƒåœ¾å›æ”¶çš„ç‰¹æ€§ï¼Œéœ€è¦ä½¿ç”¨å…¶ä»–çš„ç®—æ³•ã€‚</p>
<p>æ ‡è®°-æ¸…é™¤ç®—æ³•çš„ç¡®å¯ä»¥åº”ç”¨åœ¨è€å¹´ä»£ä¸­ï¼Œä½†æ˜¯è¯¥ç®—æ³•ä¸ä»…æ‰§è¡Œæ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”åœ¨æ‰§è¡Œå®Œå†…å­˜å›æ”¶åè¿˜ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œæ‰€ä»¥JVMçš„è®¾è®¡è€…éœ€è¦åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ”¹é€ ã€‚æ ‡è®°-å‹ç¼©ç®—æ³•ï¼ˆMark-Compactï¼‰ç”±æ­¤è¯ç”Ÿã€‚</p>
<p>1970å¹´å‰åï¼ŒG.L.Steeleã€C.J.Cheneå’ŒD.D.Wiseç­‰ç ”ç©¶è€…å‘å¸ƒæ ‡è®°-å‹ç¼©ç®—æ³•ã€‚åœ¨è®¸å¤šç°ä»£çš„åƒåœ¾å™¨ä¸­ï¼Œäººä»¬éƒ½ä½¿ç”¨æ ‡è®°-å‹ç¼©ç®—æ³•æˆ–å…¶æ”¹è¿›ç‰ˆæœ¬ã€‚</p>
<blockquote>
<p>â³ æ‰§è¡Œè¿‡ç¨‹</p>
</blockquote>
<p>ç¬¬ä¸€é˜¶æ®µï¼šå’Œæ ‡è®°æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹æ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚</p>
<p>ç¬¬äºŒé˜¶æ®µï¼šå°†æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜çš„ä¸€ç«¯ï¼ŒæŒ‰é¡ºåºæ’æ”¾ã€‚</p>
<p>ä¹‹åï¼Œæ¸…ç†è¾¹ç•Œå¤–æ‰€æœ‰çš„ç©ºé—´ã€‚</p>
<blockquote>
<p>æ ‡è®°-å‹ç¼©ğŸ†šæ ‡è®°-æ¸…é™¤</p>
</blockquote>
<p>æ ‡è®°-å‹ç¼©ç®—æ³•çš„æœ€ç»ˆç»“æœç­‰åŒäºæ ‡è®°-æ¸…é™¤ç®—æ³•æ‰§è¡Œå®Œæˆåï¼Œå†è¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡æ•´ç†ï¼Œå› æ­¤ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒç§°ä¸ºæ ‡è®°-æ¸…é™¤-å‹ç¼©ï¼ˆMark-Sweep-Compactï¼‰ç®—æ³•ã€‚</p>
<p>äºŒè€…çš„æœ¬è´¨å·®å¼‚åœ¨äºæ ‡è®°-æ¸…é™¤ç®—æ³•æ˜¯ä¸€ç§éç§»åŠ¨å¼çš„å›æ”¶ç®—æ³•ï¼Œæ ‡è®°-å‹ç¼©æ˜¯ç§»åŠ¨å¼ã€‚æ˜¯å¦ç§»åŠ¨å›æ”¶åçš„å­˜æ´»å¯¹è±¡æ˜¯ä¸€é¡¹ä¼˜ç¼ºç‚¹å¹¶å­˜çš„é£é™©å†³ç­–ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ ‡è®°çš„å­˜æ´»å¯¹è±¡å°†ä¼šè¢«æ•´ç†ï¼ŒæŒ‰ç…§å†…å­˜åœ°å€ä¸€æ¬¡æ’åˆ—ï¼Œè€Œæœªè¢«æ ‡è®°çš„å†…å­˜å°†ä¼šè¢«æ¸…ç†æ‰ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå½“æˆ‘ä»¬éœ€è¦ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒJVMåªéœ€è¦ç»´æŒä¸€ä¸ªå†…å­˜çš„èµ·å§‹åœ°å€å³å¯ï¼Œè¿™æ¯”ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨æ˜¾ç„¶å°‘äº†è®¸å¤šå¼€é”€ã€‚</p>
<blockquote>
<p>ğŸ’¥ æŒ‡é’ˆç¢°æ’</p>
</blockquote>
<p>å¦‚æœå†…å­˜ç©ºé—´ä»¥è§„æ•´å’Œæœ‰åºçš„æ–¹å¼åˆ†å¸ƒï¼Œå³å·²ç”¨å’Œæœªç”¨çš„å†…å­˜éƒ½å„è‡ªä¸€è¾¹ï¼Œå½¼æ­¤ä¹‹é—´ç»´ç³»ç€ä¸€ä¸ªè®°å½•ä¸‹ä¸€æ¬¡åˆ†é…èµ·å§‹ç‚¹çš„æ ‡è®°æŒ‡é’ˆï¼Œå½“ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œåªéœ€è¦é€šè¿‡ä¿®æ”¹æŒ‡é’ˆçš„åç§»é‡å°†æ–°å¯¹åˆ†é…å­ç¬¬ä¸€ä¸ªç©ºé—²å†…å­˜ä½ç½®ä¸Šï¼Œè¿™ç§åˆ†é…æ–¹å¼å°±å«åšæŒ‡é’ˆç¢°æ’ï¼ˆBump the Pointerï¼‰ã€‚</p>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆé™¤äº†æ ‡è®°-æ¸…é™¤ç®—æ³•å½“ä¸­ï¼Œå†…å­˜åŒºåŸŸåˆ†æ•£çš„ç¼ºç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒJVMåªéœ€è¦æŒæœ‰ä¸€ä¸ªå†…å­˜çš„èµ·å§‹åœ°å€å³å¯ã€‚</li>
<li>æ¶ˆé™¤äº†å¤åˆ¶ç®—æ³•å½“ä¸­ï¼Œå†…å­˜å‡åŠçš„é«˜é¢ä»£ä»·ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä»æ•ˆç‡ä¸Šæ¥è¯´ï¼Œæ ‡è®°-æ•´ç†ç®—æ³•è¦ä½äºå¤åˆ¶ç®—æ³•ã€‚</li>
<li>ç§»åŠ¨å¯¹è±¡çš„åŒæ—¶ï¼Œå¦‚æœå¯¹è±¡è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œåˆ™è¿˜éœ€è¦è°ƒæ•´å¼•ç”¨çš„åœ°å€ã€‚</li>
<li>ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å…¨ç¨‹æš‚åœç”¨æˆ·åº”ç”¨ç¨‹åºï¼Œå³STWã€‚</li>
</ul>
<blockquote>
<p>ğŸ“‹ å°ç»“</p>
</blockquote>
<table>
<thead>
<tr>
<th>é¡¹ç›®\ç®—æ³•</th>
<th>Mark-Sweep</th>
<th>Mark-Compact</th>
<th>Copying</th>
</tr>
</thead>
<tbody><tr>
<td>é€Ÿåº¦</td>
<td>ä¸­ç­‰</td>
<td>æœ€æ…¢</td>
<td>æœ€å¿«</td>
</tr>
<tr>
<td>ç©ºé—´å¼€é”€</td>
<td>å°‘ï¼ˆä¼šå †ç§¯ç¢ç‰‡ï¼‰</td>
<td>å°‘ï¼ˆä¸å †ç§¯ç¢ç‰‡ï¼‰</td>
<td>å¤§ï¼ˆä¸å †ç§¯ç¢ç‰‡ï¼‰</td>
</tr>
<tr>
<td>ç§»åŠ¨å¯¹è±¡</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
</tbody></table>
<h2 id="13-9-ğŸ§“ğŸ½-åˆ†ä»£ç®—æ³•"><a href="#13-9-ğŸ§“ğŸ½-åˆ†ä»£ç®—æ³•" class="headerlink" title="13.9 ğŸ§“ğŸ½ åˆ†ä»£ç®—æ³•"></a>13.9 ğŸ§“ğŸ½ åˆ†ä»£ç®—æ³•</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<p>ç›®å‰å‡ ä¹æ‰€æœ‰çš„GCéƒ½æ˜¯é‡‡ç”¨åˆ†ä»£ï¼ˆGenerational Collectingï¼‰ç®—æ³•æ‰§è¡Œåƒåœ¾å›æ”¶çš„ã€‚</p>
<p>åœ¨HotSpotä¸­ï¼ŒåŸºäºåˆ†ä»£çš„æ¦‚å¿µï¼ŒGCæ‰€ä½¿ç”¨çš„å†…å­˜å›æ”¶ç®—æ³•å¿…é¡»ç»“åˆå¹´è½»ä»£å’Œè€å¹´ä»£å„è‡ªçš„ç‰¹ç‚¹ã€‚</p>
<p>ä»¥HotSpotä¸­çš„CMSå›æ”¶å™¨ä¸ºä¾‹ï¼ŒCMSæ˜¯åŸºäºMark-Sweepå®ç°çš„ï¼Œå¯¹äºå¯¹è±¡çš„å›æ”¶æ•ˆç‡å¾ˆé«˜ã€‚è€Œå¯¹äºç¢ç‰‡é—®é¢˜ï¼ŒCMSé‡‡ç”¨åŸºäºMark-Compactç®—æ³•çš„Serial Oldå›æ”¶å™¨ä½œä¸ºè¡¥å¿æªæ–½ï¼šå½“å†…å­˜å›æ”¶ä¸ä½³ï¼ˆç¢ç‰‡å¯¼è‡´çš„Concurrent Mode Failureæ—¶ï¼‰ï¼Œå°†é‡‡ç”¨Serial Oldæ‰§è¡ŒFull GCä»¥è¾¾åˆ°å¯¹è€å¹´ä»£å†…å­˜çš„æ•´ç†ã€‚</p>
<p>åˆ†ä»£çš„æ€æƒ³è¢«ç°åœ¨çš„è™šæ‹Ÿæœºå¹¿æ³›ä½¿ç”¨ã€‚å‡ ä¹æ‰€æœ‰çš„åƒåœ¾å›æ”¶å™¨éƒ½åŒºåˆ†æ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚</p>
<blockquote>
<p>ğŸ‘¶ å¯¹äºæ–°ç”Ÿä»£</p>
</blockquote>
<p>å¹´è½»ä»£ç‰¹ç‚¹ï¼šåŒºåŸŸç›¸å¯¹äºè€å¹´ä»£è¾ƒå°ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œå­˜æ´»ç‡ä½ï¼Œå›æ”¶é¢‘ç¹ã€‚</p>
<p>è¿™ç§æƒ…å†µå¤åˆ¶ç®—æ³•çš„å›æ”¶æ•´ç†ï¼Œé€Ÿåº¦æ˜¯æœ€å¿«çš„ã€‚å¤åˆ¶ç®—æ³•çš„æ•ˆç‡åªå’Œå½“å‰å­˜æ´»å¯¹è±¡å¤§å°æœ‰å…³ï¼Œå› æ­¤å¾ˆé€‚ç”¨äºå¹´è½»ä»£çš„å›æ”¶ã€‚è€Œå¤åˆ¶ç®—æ³•å†…å­˜åˆ©ç”¨ç‡ä¸é«˜çš„é—®é¢˜ï¼Œé€šè¿‡HotSpotä¸­çš„ä¸¤ä¸ªSuivivorçš„è®¾è®¡å¾—åˆ°ç¼“è§£ã€‚</p>
<blockquote>
<p>ğŸ‘µ å¯¹äºè€å¹´ä»£</p>
</blockquote>
<p>è€å¹´ä»£ç‰¹ç‚¹ï¼šåŒºåŸŸè¾ƒå¤§ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸé•¿ã€å­˜æ´»ç‡é«˜ï¼Œå›æ”¶ä¸åŠå¹´è½»ä»£é¢‘ç¹ã€‚</p>
<p>è¿™ç§æƒ…å†µå­˜åœ¨å¤§é‡å­˜æ´»ç‡é«˜çš„å¯¹è±¡ï¼Œå¤åˆ¶ç®—æ³•æ˜æ˜¾å˜å¾—ä¸åˆé€‚ã€‚ä¸€èˆ¬æ˜¯ç”±æ ‡è®°-æ¸…é™¤æˆ–è€…æ˜¯æ ‡è®°-æ¸…é™¤ä¸æ ‡è®°-æ•´ç†çš„æ··åˆå®ç°ã€‚</p>
<p>ï¼ˆ1ï¼‰Marké˜¶æ®µçš„å¼€é”€ä¸å­˜æ´»å¯¹è±¡çš„æ•°é‡æˆæ­£æ¯”ã€‚</p>
<p>ï¼ˆ2ï¼‰Sweepé˜¶æ®µçš„å¼€é”€ä¸æ‰€ç®¡ç†åŒºåŸŸçš„å¤§å°æˆæ­£ç›¸å…³ã€‚</p>
<p>ï¼ˆ3ï¼‰Compacté˜¶æ®µçš„å¼€é”€ä¸å­˜è´§å¯¹è±¡çš„æ•°æ®æˆæ­£æ¯”ã€‚</p>
<h2 id="13-10-â™-å¢é‡ç®—æ³•"><a href="#13-10-â™-å¢é‡ç®—æ³•" class="headerlink" title="13.10 â™ å¢é‡ç®—æ³•"></a>13.10 â™ å¢é‡ç®—æ³•</h2><blockquote>
<p>ğŸŒƒ èƒŒæ™¯</p>
</blockquote>
<p>ä¸Šè¿°ç°æœ‰çš„ç®—æ³•ï¼Œåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨è½¯ä»¶å°†å¤„äºä¸€ç§Stop the Worldçš„çŠ¶æ€ã€‚åœ¨Stop the WorldçŠ¶æ€ä¸‹ï¼Œåº”ç”¨ç¨‹åºæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šæŒ‚èµ·ï¼Œæš‚åœä¸€åˆ‡æ­£å¸¸çš„å·¥ä½œï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆã€‚å¦‚æœåƒåœ¾å›æ”¶æ—¶é—´è¿‡é•¿ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«æŒ‚èµ·å¾ˆä¹…ï¼Œå°†ä¸¥é‡å½±å“åˆ°ç”¨æˆ·ä½“éªŒæˆ–è€…ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå³å¯¹å®æ—¶åƒåœ¾ç®—æ³•çš„ç ”ç©¶ç›´æ¥çš„ç ”ç©¶ç›´æ¥å¯¼è‡´äº†å¢é‡ï¼ˆIncremental Collectingï¼‰ç®—æ³•çš„è¯ç”Ÿã€‚</p>
<blockquote>
<p>ğŸ”° åŸºæœ¬æ€æƒ³</p>
</blockquote>
<p>å¦‚æœä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„åƒåœ¾è¿›è¡Œå¤„ç†ï¼Œéœ€è¦é€ æˆç³»ç»Ÿé•¿æ—¶é—´çš„åœé¡¿ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®©åƒåœ¾çº¿ç¨‹å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚æ¯æ¬¡ï¼Œåƒåœ¾çº¿ç¨‹åªä¸€å°ç‰‡åŒºåŸŸçš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€åˆ‡æ¢åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚æ¯æ¬¡ï¼Œåƒåœ¾çº¿ç¨‹åªä¸€å°ç‰‡åŒºåŸŸçš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€åˆ‡æ¢åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹ã€‚ä¾æ¬¡åå¤ï¼Œç›´åˆ°åƒåœ¾å®Œæˆã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼Œå¢é‡ç®—æ³•çš„åŸºç¡€ä»æ˜¯ä¼ ç»Ÿçš„æ ‡è®°-æ¸…é™¤å’Œå¤åˆ¶ç®—æ³•ã€‚å¢é‡ç®—æ³•é€šè¿‡å¯¹çº¿ç¨‹é—´å†²çªçš„å¦¥å–„å¤„ç†ï¼Œå…è®¸åƒåœ¾çº¿ç¨‹ä»¥åˆ†é˜¶æ®µçš„æ–¹å¼å®Œæˆæ ‡è®°ã€æ¸…ç†æˆ–å¤åˆ¶å·¥ä½œã€‚</p>
<blockquote>
<p>ğŸ“› ç¼ºç‚¹</p>
</blockquote>
<p>ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œç”±äºåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œé—´æ–­æ€§åœ°è¿˜æ‰§è¡Œäº†åº”ç”¨ç¨‹åºä»£ç ï¼Œæ‰€ä»¥èƒ½å‡å°‘ç³»ç»Ÿçš„åœé¡¿æ—¶é—´ã€‚ä½†æ˜¯ï¼Œå› ä¸ºçº¿ç¨‹åˆ‡æ¢å’Œä¸Šä¸‹æ–‡çš„æ¶ˆè€—ï¼Œä¼šä½¿å¾—åƒåœ¾å›æ”¶çš„æ€»ä½“æˆæœ¬ä¸Šå‡ï¼Œé€ æˆç³»ç»Ÿååé‡çš„ä¸‹é™ã€‚</p>
<h2 id="13-11-ğŸ’ -åˆ†åŒºç®—æ³•"><a href="#13-11-ğŸ’ -åˆ†åŒºç®—æ³•" class="headerlink" title="13.11 ğŸ’  åˆ†åŒºç®—æ³•"></a>13.11 ğŸ’  åˆ†åŒºç®—æ³•</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ç›¸åŒæ¡ä»¶ä¸‹ï¼Œå †ç©ºé—´è¶Šå¤§ï¼Œä¸€æ¬¡GCæ—¶æ‰€éœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ï¼Œæœ‰å…³GCäº§ç”Ÿçš„åœé¡¿ä¹Ÿå°±è¶Šé•¿ã€‚ä¸ºäº†æ›´å¥½åœ°æ§åˆ¶GCäº§ç”Ÿçš„åœé¡¿æ—¶é—´ï¼Œå°†ä¸€å—å¤§çš„å†…å­˜åŒºåŸŸåˆ†å‰²æˆå¤šä¸ªå°å—ï¼Œæ ¹æ®ç›®æ ‡çš„åœé¡¿æ—¶é—´ï¼Œæ¯æ¬¡åˆç†åœ°å›æ”¶è‹¥å¹²ä¸ªå°åŒºé—´ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå †ç©ºé—´ï¼Œä»è€Œå‡å°‘ä¸€æ¬¡GCæ‰€äº§ç”Ÿçš„åœé¡¿ã€‚</p>
<p>åˆ†ä»£ç®—æ³•å°†æŒ‰ç…§å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸé•¿çŸ­åˆ’åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åŒºç®—æ³•æ•´ä¸ªå †ç©ºé—´åˆ’åˆ†æˆè¿ç»­çš„ä¸åŒå°åŒºé—´ã€‚</p>
<p>æ¯ä¸€ä¸ªå°åŒºé—´éƒ½ç‹¬ç«‹ä½¿ç”¨ï¼Œç‹¬ç«‹å›æ”¶ã€‚è¿™ç§ç®—æ³•çš„å¥½å¤„æ˜¯å¯ä»¥æ§åˆ¶ä¸€æ¬¡å›æ”¶å¤šå°‘ä¸ªå°åŒºé—´ã€‚</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-14(åƒåœ¾å›æ”¶æ¦‚å¿µ)</title>
    <url>/posts/31658/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="14-1-ğŸ’»-System-gc"><a href="#14-1-ğŸ’»-System-gc" class="headerlink" title="14.1 ğŸ’» System.gc()"></a>14.1 ğŸ’» System.gc()</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œé€šè¿‡System.gc()æˆ–è€…Runtime.getRuntime().gc()çš„è°ƒç”¨ï¼Œä¼šæ˜¾å¼è§¦å‘Full GCï¼ŒåŒæ—¶å¯¹è€å¹´ä»£å’Œæ–°ç”Ÿä»£è¿›è¡Œå›æ”¶ï¼Œå°è¯•é‡Šæ”¾è¢«ä¸¢å¼ƒå¯¹è±¡å ç”¨çš„å†…å­˜ã€‚</li>
<li>System.gc()è°ƒç”¨é™„å¸¦ä¸€ä¸ªå…è´£å£°æ˜ï¼Œæ— æ³•ä¿è¯å¯¹åƒåœ¾å›æ”¶å™¨çš„è°ƒç”¨ã€‚</li>
<li>JVMå®ç°ç€å¯ä»¥é€šè¿‡System.gc()è°ƒç”¨æ¥å†³å®šJVMçš„GCè¡Œä¸ºã€‚è€Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåƒåœ¾å›æ”¶åº”è¯¥æ˜¯è‡ªåŠ¨è¿›è¡Œçš„ï¼Œæ— é¡»æ‰‹åŠ¨è§¦å‘ï¼Œå¦åˆ™å°±å¤ªè¿‡äºéº»çƒ¦äº†ã€‚åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¦‚æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ€§èƒ½åŸºå‡†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œä¹‹é—´è°ƒç”¨System.gc()ã€‚</li>
</ul>
<blockquote>
<p>âŒ¨ï¸ æµ‹è¯•</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class LocalVarGC &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * è§¦å‘Minor GCæ²¡æœ‰å›æ”¶å¯¹è±¡ï¼Œç„¶ååœ¨Full GCå°†è¯¥å¯¹è±¡å­˜å…¥oldåŒº</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void localVarGC1() &#123;</span><br><span class="line">        byte[] buffer &#x3D; new byte[10 * 1024 * 1024]; &#x2F;&#x2F; 10MB</span><br><span class="line">        System.gc(); &#x2F;&#x2F; æ— æ³•å›æ”¶</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * è§¦å‘Young GCçš„æ—¶å€™ï¼Œå·²ç»è¢«å›æ”¶äº†</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void localVarGC2() &#123;</span><br><span class="line">        byte[] buffer &#x3D; new byte[10 * 1024 * 1024]; &#x2F;&#x2F; 10MB</span><br><span class="line">        buffer &#x3D; null;</span><br><span class="line">        System.gc(); &#x2F;&#x2F; å¯ä»¥å›æ”¶</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * ä¸ä¼šå›æ”¶ï¼Œå› ä¸ºå®ƒè¿˜å­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„æ§½ä¸­</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void localVarGC3() &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            byte[] buffer &#x3D; new byte[10 * 1024 * 1024]; &#x2F;&#x2F; 10MB</span><br><span class="line">        &#125;</span><br><span class="line">        System.gc(); &#x2F;&#x2F; ä¸ä¼šå›æ”¶</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * ä¼šè¢«å›æ”¶ï¼Œå› ä¸ºå®ƒè¿˜å­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„æ§½ä¸­ï¼Œä½†æ˜¯åé¢å®šä¹‰çš„valueæŠŠè¿™ä¸ªæ§½ç»™æ›¿æ¢äº†</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void localVarGC4() &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            byte[] buffer &#x3D; new byte[10 * 1024 * 1024]; &#x2F;&#x2F; 10MB</span><br><span class="line">        &#125;</span><br><span class="line">        int value &#x3D; 10;</span><br><span class="line">        System.gc(); &#x2F;&#x2F; å¯ä»¥å›æ”¶</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * å›æ”¶localVarGC1ä¸­çš„buffer</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void localVarGC5() &#123;</span><br><span class="line">        localVarGC1();</span><br><span class="line">        System.gc(); &#x2F;&#x2F; å¯ä»¥å›æ”¶</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        LocalVarGC localVarGC &#x3D; new LocalVarGC();</span><br><span class="line">        localVarGC.localVarGC5();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="14-2-ğŸŠå†…å­˜æº¢å‡º"><a href="#14-2-ğŸŠå†…å­˜æº¢å‡º" class="headerlink" title="14.2 ğŸŠå†…å­˜æº¢å‡º"></a>14.2 ğŸŠå†…å­˜æº¢å‡º</h2><blockquote>
<p>ğŸ“– æ¦‚è¿°</p>
</blockquote>
<p>å†…å­˜æº¢å‡ºç›¸å¯¹äºå†…å­˜æ³„éœ²æ¥è¯´ï¼Œå°½ç®¡æ›´å®¹æ˜“è¢«ç†è§£ï¼Œä½†æ˜¯åŒæ ·çš„ï¼Œå†…å­˜æº¢å‡ºä¹Ÿæ˜¯å¼•å‘ç¨‹åºå´©æºƒçš„ç½ªé­ç¥¸é¦–ä¹‹ä¸€ã€‚</p>
<p>ç”±äºGCä¸€ç›´åœ¨å‘å±•ï¼Œæ‰€æœ‰ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé™¤éåº”ç”¨ç¨‹åºå ç”¨çš„å†…å­˜å¢é•¿é€Ÿåº¦éå¸¸å¿«ï¼Œé€ æˆåƒåœ¾å›æ”¶å·²ç»è·Ÿä¸ä¸Šå†…å­˜æ¶ˆè€—çš„é€Ÿåº¦ï¼Œå¦åˆ™ä¸å¤ªå®¹æ˜“å‡ºç°OOMçš„æƒ…å†µã€‚</p>
<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒGCä¼šè¿›è¡Œå„ç§å¹´é¾„æ®µçš„åƒåœ¾å›æ”¶ï¼Œå®åœ¨ä¸è¡Œäº†å°±æ”¾å¤§æ‹›ï¼Œæ¥ä¸€æ¬¡ç‹¬å å¼çš„FULL FCæ“ä½œï¼Œè¿™æ—¶å€™ä¼šå›æ”¶å¤§é‡çš„å†…å­˜ï¼Œä¾›åº”ç”¨ç¨‹åºç»§ç»­ä½¿ç”¨ã€‚</p>
<p>javadocå¯¹OutOfMemoryErrorçš„è§£é‡Šæ˜¯ï¼Œæ²¡æœ‰ç©ºé—²å†…å­˜ï¼Œå¹¶ä¸”åƒåœ¾å™¨ä¹Ÿæ— æ³•æä¾›æ›´å¤šå†…å­˜ã€‚</p>
<p>æ²¡æœ‰ç©ºé—²å†…å­˜çš„æƒ…å†µï¼ŒåŸå› æœ‰äºŒï¼š</p>
<ul>
<li>Javaè™šæ‹Ÿæœºçš„å †å†…å­˜è®¾ç½®ä¸å¤Ÿã€‚</li>
<li>ä»£ç ä¸­åˆ›å»ºäº†å¤§é‡çš„å¯¹è±¡ï¼Œå¹¶ä¸”é•¿æ—¶é—´ä¸èƒ½è¢«åƒåœ¾å™¨ï¼ˆå­˜åœ¨è¢«å¼•ç”¨ï¼‰ã€‚</li>
<li>è¿™é‡Œé¢éšå«çš„ä¸€å±‚æ„æ€æ˜¯ï¼Œåœ¨æŠ›å‡ºOutOfMemoryä¹‹å‰ï¼Œé€šå¸¸åƒåœ¾å™¨ä¼šè¢«è§¦å‘ï¼Œå°½å…¶æ‰€èƒ½å»æ¸…ç†ç©ºé—´ã€‚</li>
<li>å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯åœ¨ä»»ä½•æƒ…å†µä¸‹åƒåœ¾å™¨éƒ½ä¼šè¢«è§¦å‘çš„ã€‚</li>
</ul>
<h2 id="14-3-ğŸ‰-å†…å­˜æ³„éœ²"><a href="#14-3-ğŸ‰-å†…å­˜æ³„éœ²" class="headerlink" title="14.3 ğŸ‰ å†…å­˜æ³„éœ²"></a>14.3 ğŸ‰ å†…å­˜æ³„éœ²</h2><blockquote>
<p>ğŸ“– æ¦‚è¿°</p>
</blockquote>
<p>ä¸¥æ ¼æ¥è¯´ï¼Œåªæœ‰å¯¹è±¡ä¸ä¼šå†è¢«ç¨‹åºç”¨åˆ°äº†ï¼Œä½†æ˜¯GCåˆä¸èƒ½å›æ”¶ä»–ä»¬çš„æƒ…å†µï¼Œæ‰å«åšå†…å­˜æ³„éœ²ã€‚</p>
<p>ä½†å®é™…æƒ…å†µå¾ˆå¤šæ—¶å€™ä¸€äº›ä¸å¤ªå¥½çš„å®è·µï¼ˆæˆ–ç–å¿½ï¼‰ä¼šå¯¼è‡´å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå˜å¾—å¾ˆé•¿ç”šè‡³å¯¼è‡´00Mï¼Œä¹Ÿå¯ä»¥å«åšå®½æ³›æ„ä¹‰ä¸Šçš„â€œå†…å­˜æ³„æ¼â€ã€‚</p>
<p>å°½ç®¡å†…å­˜æ³„æ¼å¹¶ä¸ä¼šç«‹åˆ»å¼•èµ·ç¨‹åºå´©æºƒï¼Œä½†æ˜¯ä¸€æ—¦å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œç¨‹åºä¸­çš„å¯ç”¨å†…å­˜å°±ä¼šè¢«é€æ­¥èš•é£Ÿï¼Œç›´è‡³è€—å°½æ‰€æœ‰å†…å­˜ï¼Œæœ€ç»ˆå‡ºç°OutofMemoryå¼‚å¸¸ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p>
<p>æ³¨æ„ï¼Œè¿™é‡Œçš„å­˜å‚¨ç©ºé—´å¹¶ä¸æ˜¯æŒ‡ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯æŒ‡è™šæ‹Ÿå†…å­˜å¤§å°ï¼Œè¿™ä¸ªè™šæ‹Ÿå†…å­˜å¤§å°å–å†³äºç£ç›˜äº¤æ¢åŒºè®¾å®šçš„å¤§å°ã€‚</p>
<blockquote>
<p>ğŸ¥– ä¸¾ä¾‹</p>
</blockquote>
<p>ï¼ˆ1ï¼‰å•ä¾‹æ¨¡å¼</p>
<p>å•ä¾‹çš„ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç¨‹åºæ˜¯ä¸€æ ·é•¿çš„ï¼Œæ‰€ä»¥å•ä¾‹æ¨¡å¼ä¸­ï¼Œå¦‚æœæŒæœ‰å¯¹å¤–éƒ¨å¯¹è±¡çš„å¼•ç”¨çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå¤–éƒ¨å¯¹è±¡æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ï¼Œåˆ™ä¼šå¯¼è‡´å†…å­˜æ³„éœ²çš„äº§ç”Ÿã€‚</p>
<p>ï¼ˆ2ï¼‰ä¸€äº›æä¾›closeçš„èµ„æºæœªå…³é—­</p>
<p>æ•°æ®åº“è¿æ¥ã€ç½‘ç»œè¿æ¥å’ŒIOè¿æ¥å¿…é¡»å—åˆ°closeï¼Œå¦åˆ™æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ã€‚</p>
<h2 id="14-4-â¹ï¸-Stop-The-World"><a href="#14-4-â¹ï¸-Stop-The-World" class="headerlink" title="14.4 â¹ï¸ Stop The World"></a>14.4 â¹ï¸ Stop The World</h2><blockquote>
<p>ğŸ“– æ¦‚è¿°</p>
</blockquote>
<p>stop-the-worldï¼Œç®€ç§°STWï¼ŒæŒ‡çš„æ˜¯GCäº‹ä»¶å‘ç”Ÿè¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿåº”ç”¨ç¨‹åºçš„åœé¡¿ã€‚åœé¡¿äº§ç”Ÿæ—¶æ•´ä¸ªåº”ç”¨ç¨‹åºçº¿ç¨‹éƒ½ä¼šè¢«æš‚åœï¼Œæ²¡æœ‰ä»»ä½•å“åº”ï¼Œæœ‰ç‚¹åƒå¡æ­»çš„æ„Ÿè§‰ï¼Œè¿™ä¸ªåœé¡¿ç§°ä¸ºSTWã€‚</p>
<p>å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­æšä¸¾æ ¹èŠ‚ç‚¹ï¼ˆGC Rootsï¼‰ä¼šå¯¼è‡´æ‰€æœ‰Javaæ‰§è¡Œçº¿ç¨‹åœé¡¿ã€‚</p>
<ul>
<li>åˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ç¡®ä¿ä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œ</li>
<li>ä¸€è‡´æ€§æŒ‡æ•´ä¸ªåˆ†ææœŸé—´æ•´ä¸ªæ‰§è¡Œç³»ç»Ÿçœ‹èµ·æ¥åƒè¢«å†»ç»“åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Š</li>
<li>å¦‚æœå‡ºç°åˆ†æè¿‡ç¨‹ä¸­å¯¹è±¡å¼•ç”¨å…³ç³»è¿˜åœ¨ä¸æ–­å˜åŒ–ï¼Œåˆ™åˆ†æç»“æœçš„å‡†ç¡®æ€§æ— æ³•ä¿è¯</li>
</ul>
<p>è¢«STWä¸­æ–­çš„åº”ç”¨ç¨‹åºçº¿ç¨‹ä¼šåœ¨å®ŒæˆGCä¹‹åæ¢å¤ï¼Œé¢‘ç¹ä¸­æ–­ä¼šè®©ç”¨æˆ·æ„Ÿè§‰åƒæ˜¯ç½‘é€Ÿä¸å¿«é€ æˆç”µå½±å¡å¸¦ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å‡å°‘STWçš„å‘ç”Ÿã€‚</p>
<blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<p>STWäº‹ä»¶å’Œé‡‡ç”¨å“ªæ¬¾GCæ— å…³æ‰€æœ‰çš„GCéƒ½æœ‰è¿™ä¸ªäº‹ä»¶ã€‚</p>
<p>å“ªæ€•æ˜¯G1ä¹Ÿä¸èƒ½å®Œå…¨é¿å…Stop-the-worldæƒ…å†µå‘ç”Ÿï¼Œåªèƒ½è¯´åƒåœ¾å›æ”¶å™¨è¶Šæ¥è¶Šä¼˜ç§€ï¼Œå›æ”¶æ•ˆç‡è¶Šæ¥è¶Šé«˜ï¼Œå°½å¯èƒ½åœ°ç¼©çŸ­äº†æš‚åœæ—¶é—´ã€‚</p>
<p>STWæ˜¯JVMåœ¨åå°è‡ªåŠ¨å‘èµ·å’Œè‡ªåŠ¨å®Œæˆçš„ã€‚åœ¨ç”¨æˆ·ä¸å¯è§çš„æƒ…å†µä¸‹ï¼ŒæŠŠç”¨æˆ·æ­£å¸¸çš„å·¥ä½œçº¿ç¨‹å…¨éƒ¨åœæ‰ã€‚</p>
<p>å¼€å‘ä¸­ä¸è¦ç”¨<code>System.gc()</code>ä¼šå¯¼è‡´stop-the-worldçš„å‘ç”Ÿã€‚</p>
<h2 id="14-5-ğŸ“–-åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘"><a href="#14-5-ğŸ“–-åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘" class="headerlink" title="14.5 ğŸ“– åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘"></a>14.5 ğŸ“– åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘</h2><blockquote>
<p>ğŸš å¹¶å‘</p>
</blockquote>
<ul>
<li>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œå¹¶å‘æ˜¯æŒ‡ä¸€ä¸ªæ—¶é—´æ®µä¸­æœ‰å‡ ä¸ªç¨‹åºéƒ½å¤„äºå·²å¯åŠ¨è¿è¡Œåˆ°è¿è¡Œå®Œæ¯•ä¹‹é—´ï¼Œä¸”è¿™å‡ ä¸ªç¨‹åºéƒ½æ˜¯åœ¨åŒä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œã€‚</li>
<li>å¹¶å‘ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„â€åŒæ—¶è¿›è¡Œâ€œï¼Œåªæ˜¯CPUæŠŠä¸€ä¸ªæ—¶é—´æ®µåˆ’åˆ†æˆå‡ ä¸ªæ—¶é—´ç‰‡æ®µï¼ˆæ—¶é—´åŒºé—´ï¼‰ï¼Œç„¶ååœ¨è¿™å‡ ä¸ªæ—¶é—´åŒºé—´ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œç”±äºCPUçš„å¤„ç†çš„é€Ÿåº¦éå¸¸å¿«ï¼Œåªè¦æ—¶é—´é—´éš”å¤„ç†å¾—å½“ï¼Œå³å¯è®©ç”¨æˆ·æ„Ÿè§‰æ˜¯å¤šä¸ªåº”ç”¨ç¨‹åºåŒæ—¶åœ¨è¿›è¡Œã€‚</li>
</ul>
<blockquote>
<p>ğŸš— å¹¶è¡Œ</p>
</blockquote>
<ul>
<li>å½“ç³»ç»Ÿæœ‰ä¸€ä¸ªä»¥ä¸ŠCPUæ—¶ï¼Œå½“ä¸€ä¸ªCPUæ‰§è¡Œä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œå¦ä¸€ä¸ªCPUå¯ä»¥æ‰§è¡Œå¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸¤ä¸ªè¿›ç¨‹äº’è¡¥æŠ¢å CPUèµ„æºï¼Œå¯ä»¥åŒæ—¶è¿›è¡Œï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå¹¶è¡Œã€‚</li>
<li>å…¶å®å†³å®šå¹¶è¡Œçš„å› ç´ ä¸æ˜¯CPUçš„æ•°é‡ï¼Œè€Œæ˜¯CPUçš„æ ¸å¿ƒæ•°é‡ï¼Œæ¯”å¦‚ä¸€ä¸ªCPUå¤šä¸ªæ ¸ä¹Ÿå¯ä»¥å¹¶è¡Œã€‚</li>
</ul>
<blockquote>
<p>å¹¶è¡Œ ğŸ†š å¹¶å‘</p>
</blockquote>
<p>å¹¶å‘ï¼ŒæŒ‡çš„æ˜¯å¤šä¸ªäº‹æƒ…ï¼Œåœ¨åŒä¸€æ—¶é—´æ®µå†…åŒæ—¶å‘ç”Ÿäº†ã€‚</p>
<p>å¹¶è¡Œï¼ŒæŒ‡çš„æ˜¯å¤šä¸ªäº‹æƒ…ï¼Œåœ¨åŒä¸€æ—¶é—´ç‚¹å†…åŒæ—¶å‘ç”Ÿäº†ã€‚</p>
<p>å¹¶å‘çš„å¤šä¸ªä»»åŠ¡ä¹‹é—´æ˜¯äº’ç›¸æŠ¢å èµ„æºçš„ï¼Œå¹¶è¡Œçš„å¤šä¸ªä»»åŠ¡ä¹‹é—´æ˜¯ä¸äº’ç›¸æŠ¢å èµ„æºçš„ã€‚</p>
<p>åªæœ‰åœ¨å¤šæ ¸CPUæˆ–è€…ä¸€ä¸ªCPUå¤šæ ¸çš„æƒ…å†µä¸­ï¼Œæ‰ä¼šå‘ç”Ÿå¹¶è¡Œã€‚</p>
<p>å¦åˆ™ï¼Œçœ‹ä¼¼åŒæ—¶å‘ç”Ÿçš„äº‹æƒ…ï¼Œå…¶å®éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚</p>
<blockquote>
<p>ğŸ—‘ï¸ åƒåœ¾å›æ”¶</p>
</blockquote>
<p>å¹¶å‘å’Œå¹¶è¡Œï¼Œåœ¨è°ˆè®ºåƒåœ¾å™¨çš„ä¸Šä¸‹æ–‡è¯­å¢ƒä¸­ï¼Œå®ƒä»¬å¯ä»¥è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li>å¹¶è¡Œï¼šæŒ‡å¤šæ¡åƒåœ¾çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œä½†æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä»å¤„äºç­‰å¾…çŠ¶æ€ã€‚</li>
<li>ä¸²è¡Œï¼šç›¸è¾ƒäºå¹¶è¡Œçš„æ¦‚å¿µï¼Œå•çº¿ç¨‹æ‰§è¡Œã€‚å¦‚æœå†…å­˜ä¸å¤Ÿï¼Œåˆ™ç¨‹åºæš‚åœï¼Œå¯åŠ¨JVMåƒåœ¾å›æ”¶å™¨è¿›è¡Œåƒåœ¾å›æ”¶ã€‚å›æ”¶å®Œï¼Œå†å¯åŠ¨ç¨‹åºçš„çº¿ç¨‹ã€‚</li>
</ul>
<h2 id="14-6-â›‘ï¸-å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºåŸŸ"><a href="#14-6-â›‘ï¸-å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºåŸŸ" class="headerlink" title="14.6 â›‘ï¸ å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºåŸŸ"></a>14.6 â›‘ï¸ å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºåŸŸ</h2><blockquote>
<p>ğŸ“— å®‰å…¨ç‚¹(Safe Point)</p>
</blockquote>
<p>ç¨‹åºæ‰§è¡Œæ—¶å¹¶éåœ¨æ‰€æœ‰åœ°æ–¹éƒ½èƒ½åœé¡¿ä¸‹æ¥å¼€å§‹GCï¼Œåªæœ‰åœ¨ç‰¹å®šçš„ä½ç½®æ‰èƒ½åœé¡¿ä¸‹æ¥å¼€å§‹GCï¼Œè¿™äº›ä½ç½®ç§°ä¸ºâ€œå®‰å…¨ç‚¹â€ã€‚</p>
<p>å®‰å…¨ç‚¹çš„é€‰æ‹©å¾ˆé‡è¦ï¼Œå¦‚æœå¤ªå°‘å¯èƒ½å¯¼è‡´GCç­‰å¾…çš„æ—¶é—´å¤ªé•¿ï¼Œå¦‚æœå¤ªé¢‘ç¹å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶çš„æ€§èƒ½é—®é¢˜ã€‚å¤§éƒ¨åˆ†æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´éƒ½éå¸¸çŸ­æš‚ï¼Œé€šå¸¸ä¼šæ ¹æ®â€æ˜¯å¦å…·æœ‰è®©ç¨‹åºé•¿æ—¶é—´æ‰§è¡Œçš„ç‰¹å¾â€œä¸ºæ ‡å‡†ã€‚æ¯”å¦‚ï¼šé€‰æ‹©ä¸€äº›æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„æŒ‡ä»¤ä½œä¸ºSafe Pointï¼Œå¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬å’Œå¼‚å¸¸è·³è½¬ã€‚</p>
<blockquote>
<p>â” å¦‚ä½•åœ¨GCå‘ç”Ÿæ—¶ï¼Œæ£€æŸ¥æ‰€æœ‰çº¿ç¨‹éƒ½è·‘åˆ°æœ€è¿‘çš„å®‰å…¨ç‚¹åœé¡¿ä¸‹æ¥å‘¢ï¼Ÿ</p>
</blockquote>
<ul>
<li><p>æŠ¢å…ˆå¼è°ƒç”¨ï¼ˆç›®å‰æ²¡æœ‰è™šæ‹Ÿæœºä½¿ç”¨ï¼‰ï¼šé¦–å…ˆä¸­æ–­æ‰€æœ‰çº¿ç¨‹ã€‚å¦‚æœè¿˜æœ‰çº¿ç¨‹ä¸åœ¨å®‰å…¨ç‚¹ï¼Œå°±æ¢å¤çº¿ç¨‹ï¼Œè®©çº¿ç¨‹è·‘åˆ°å®‰å…¨ç‚¹ã€‚</p>
</li>
<li><p>ä¸»åŠ¨å¼ä¸­æ–­ï¼šè®¾ç½®ä¸€ä¸ªä¸­æ–­æ ‡å¿—ï¼Œå„ä¸ªçº¿ç¨‹è¿è¡Œåˆ°Safe Pointçš„æ—¶å€™ä¸»åŠ¨è½®è¯¢è¿™ä¸ªæ ‡å¿—ï¼Œå¦‚æœä¸­æ–­æ ‡å¿—ä¸ºçœŸï¼Œåˆ™å°†è‡ªå·±è¿›è¡Œä¸­æ–­æŒ‚èµ·ã€‚</p>
</li>
</ul>
<blockquote>
<p>â• è¡¥å……</p>
</blockquote>
<p>Safe Pointæœºåˆ¶ä¿è¯äº†ç¨‹åºæ‰§è¡Œæ—¶ï¼Œåœ¨ä¸å¤ªé•¿çš„æ—¶é—´å†…å°±ä¼šé‡åˆ°å¯è¿›å…¥GCçš„Safe Pointã€‚ä½†æ˜¯ï¼Œç¨‹åºâ€œä¸æ‰§è¡Œâ€çš„æ—¶å€™å‘¢ï¼Ÿä¾‹å¦‚çº¿ç¨‹å¤„äºSleepçŠ¶æ€æˆ–BlockedçŠ¶æ€ï¼Œè¿™æ—¶å€™çº¿ç¨‹æ— æ³•å“åº”JVMçš„ä¸­æ–­è¯·æ±‚ï¼Œâ€œèµ°â€åˆ°å®‰å…¨ç‚¹å»ä¸­æ–­æŒ‚èµ·ï¼ŒJVMä¹Ÿä¸å¤ªå¯èƒ½ç­‰å¾…çº¿ç¨‹è¢«å”¤é†’ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå°±éœ€è¦å®‰å…¨åŒºåŸŸæ¥è§£å†³ã€‚</p>
<blockquote>
<p>âœ… å®‰å…¨åŒºåŸŸ(Safe Region)</p>
</blockquote>
<p>å®‰å…¨åŒºåŸŸæ˜¯æŒ‡åœ¨ä¸€æ®µä»£ç ç‰‡æ®µä¸­ï¼Œå¯¹è±¡çš„å¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨è¿™ä¸ªåŒºåŸŸä¸­çš„ä»»ä½•ä½ç½®å¼€å§‹GCéƒ½æ˜¯å®‰å…¨çš„ã€‚å¯ä»¥æŠŠSafe Regionçœ‹åšæ˜¯è¢«æ‰©å±•äº†çš„Safe Pointã€‚</p>
<blockquote>
<p>ğŸ”° å®é™…æ‰§è¡Œæ—¶</p>
</blockquote>
<ol>
<li><p>å½“çº¿ç¨‹è¿è¡Œåˆ°Safe Regionçš„ä»£ç æ—¶ï¼Œé¦–å…ˆæ ‡è¯†å·²ç»è¿›å…¥äº†Safe Regionï¼Œå¦‚æœè¿™æ®µæ—¶é—´å†…å‘ç”ŸGCï¼ŒJVMä¼šå¿½ç•¥è¡¨ç¤ºä¸ºSafe RegionçŠ¶æ€çš„çº¿ç¨‹ï¼›</p>
</li>
<li><p>å½“çº¿ç¨‹å³å°†ç¦»å¼€Safe Regionæ—¶ï¼Œä¼šæ£€æŸ¥JVMæ˜¯å¦å·²ç»å®ŒæˆGCï¼Œå¦‚æœå®Œæˆäº†ï¼Œåˆ™ç»§ç»­è¿è¡Œï¼Œå¦åˆ™çº¿ç¨‹å¿…é¡»ç­‰å¾…çŸ¥é“å¯ä»¥æ”¶åˆ°å¯ä»¥å®‰å…¨ç¦»å¼€Safe Regionçš„ä¿¡å·ä¸ºæ­¢ã€‚</p>
</li>
</ol>
<h2 id="14-7-ğŸ“œ-å¼•ç”¨"><a href="#14-7-ğŸ“œ-å¼•ç”¨" class="headerlink" title="14.7 ğŸ“œ å¼•ç”¨"></a>14.7 ğŸ“œ å¼•ç”¨</h2><blockquote>
<p>ğŸ“– æ¦‚è¿°</p>
</blockquote>
<ul>
<li>å¼ºå¼•ç”¨ï¼šæœ€ä¼ ç»Ÿçš„â€œå¼•ç”¨â€çš„å®šä¹‰ï¼Œæ˜¯æŒ‡åœ¨ç¨‹åºä»£ç ä¸­æ™®éå­˜åœ¨çš„å¼•ç”¨èµ‹å€¼ï¼Œå³ç±»ä¼¼<code>Object obj = new Object();</code>è¿™ç§å¼•ç”¨å…³ç³»ã€‚æ— è®ºä»»ä½•æƒ…å†µä¸‹ï¼Œåªè¦å¼ºå¼•ç”¨å…³ç³»è¿˜å­˜åœ¨ï¼Œåƒåœ¾å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶æ‰è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚</li>
<li>è½¯å¼•ç”¨ï¼šåœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºä¹‹å‰ï¼Œå°†ä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—å…¥å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ã€‚å¦‚æœè¿™æ¬¡å›æ”¶åè¿˜æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</li>
<li>å¼±å¼•ç”¨ï¼šè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾ä¹‹å‰ã€‚å½“åƒåœ¾å™¨å·¥ä½œæ—¶ï¼Œæ— è®ºå†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚</li>
<li>è™šå¼•ç”¨ï¼šä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥è·å¾—ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„å°±æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«å™¨å›æ”¶å‰æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚</li>
</ul>
<blockquote>
<p>1ï¸âƒ£ å¼ºå¼•ç”¨ï¼ˆStrong Reference/æ°¸ä¸å›æ”¶ï¼‰</p>
</blockquote>
<p>åœ¨Javaç¨‹åºä¸­ï¼Œæœ€å¸¸è§çš„å¼•ç”¨ç±»å‹æ˜¯å¼ºå¼•ç”¨ï¼ˆæ™®é€šç³»ç»Ÿ99%ä»¥ä¸Šéƒ½æ˜¯å¼ºå¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œä¹Ÿæ˜¯é»˜è®¤çš„å¼•ç”¨ç±»å‹ã€‚</p>
<p>å½“åœ¨Javaè¯­è¨€ä¸­ä½¿ç”¨newæ“ä½œç¬¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™å¦ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œè¿™ä¸ªå˜é‡å°±æˆä¸ºæŒ‡å‘è¯¥å¯¹è±¡çš„ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚</p>
<p>å¼ºå¼•ç”¨çš„å¯¹è±¡æ˜¯å¯è§¦åŠçš„ï¼Œåƒåœ¾å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶æ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼ŒJVMå®æ„¿æŠ›å‡ºOutOfMemoryå¼‚å¸¸ä¹Ÿä¸ä¼šå›æ”¶è¿™ç§å¯¹è±¡ã€‚</p>
<p>å¯¹äºä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çš„å¼•ç”¨å…³ç³»ï¼Œåªè¦è¶…è¿‡äº†å¼•ç”¨çš„ä½œç”¨åŸŸæˆ–è€…æ˜¾ç¤ºåœ°å°†ç›¸åº”å¼ºå¼•ç”¨èµ‹å€¼ä¸ºnullï¼Œå°±æ˜¯å¯ä»¥å½“ä½œåƒåœ¾è¢«äº†ï¼Œå½“ç„¶å…·ä½“å›æ”¶æ—¶æœºè¿˜æ˜¯è¦çœ‹åƒåœ¾ç­–ç•¥ã€‚</p>
<p>ç›¸å¯¹çš„ï¼Œè½¯å¼•ç”¨ã€å¼±å¼•å’Œè™šå¯¹è±¡æ˜¯è½¯å¯è§¦åŠã€å¼±å¯è§¦åŠå’Œè™šå¯è§¦åŠçš„ï¼Œåœ¨ä¸€å®šæ¡ä»¶ä¸‹ï¼Œéƒ½æ˜¯å¯ä»¥è¢«å›æ”¶çš„ã€‚æ‰€ä»¥ï¼Œå¼ºå¼•ç”¨æ˜¯é€ æˆJavaå†…å­˜æ³„æ¼çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</p>
<p>å®ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class StrongReferenceTest &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * -Xmx1m -Xms1m</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Object[] objs &#x3D; new Object[1000 * 1000];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space</span><br></pre></td></tr></table></figure>



<blockquote>
<p>2ï¸âƒ£ è½¯å¼•ç”¨ï¼ˆSoft Reference/æº¢å‡ºå›æ”¶ï¼‰</p>
</blockquote>
<p>è½¯å¼•ç”¨æ˜¯ç”¨æ¥æè¿°ä¸€äº›è¿˜æœ‰ï¼Œä½†éå¿…éœ€çš„å¯¹è±¡ã€‚åªè¢«è½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ï¼Œåœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸å‰ï¼Œä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—è¿›å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ï¼Œå¦‚æœè¿™æ¬¡å›æ”¶è¿˜æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</p>
<p>è½¯å¼•ç”¨é€šå¸¸ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„ç¼“å­˜ã€‚æ¯”å¦‚ï¼šé«˜é€Ÿç¼“å­˜å°±æœ‰ç”¨åˆ°è½¯å¼•ç”¨ï¼Œå¦‚æœè¿˜æœ‰ç©ºé—²å†…å­˜ï¼Œå°±å¯ä»¥æš‚æ—¶ä¿ç•™ç¼“å­˜ï¼Œå½“å†…å­˜ä¸è¶³æ—¶æ¸…ç†æ‰ï¼Œè¿™æ ·å°±ä¿è¯äº†ä½¿ç”¨ç¼“å­˜çš„åŒæ—¶ï¼Œä¸ä¼šè€—å°½å†…å­˜ã€‚</p>
<p>åƒåœ¾å›æ”¶å™¨åœ¨æŸä¸ªæ—¶åˆ»å†³å®šå›æ”¶è½¯å¯è¾¾çš„å¯¹è±¡çš„æ—¶å€™ï¼Œä¼šæ¸…ç†è½¯å¼•ç”¨ï¼Œå¹¶å¯é€‰åœ°æŠŠå¼•ç”¨å­˜æ”¾åˆ°ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ã€‚</p>
<p>ç±»ä¼¼å¼±å¼•ç”¨ï¼Œåªä¸è¿‡Javaè™šæ‹Ÿæœºä¼šå°½é‡è®©è½¯å¼•ç”¨çš„å­˜æ´»æ—¶é—´é•¿ä¸€ç‚¹ï¼Œè¿«ä¸å¾—å·²æ‰æ¸…ç†ã€‚</p>
<p>å®ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class SoftReferenceTest &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * -Xmx10m -Xms10m</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        &#x2F;* å£°æ˜å¼ºå¼•ç”¨ *&#x2F;</span><br><span class="line">        Object obj &#x3D; new Object();</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">        SoftReference&lt;Object&gt; softReference &#x3D; new SoftReference&lt;Object&gt;(obj);</span><br><span class="line">        &#x2F;* é”€æ¯å¼ºå¼•ç”¨ *&#x2F;</span><br><span class="line">        obj &#x3D; null;</span><br><span class="line">        System.out.println(softReference.get());</span><br><span class="line">        &#x2F;* ä¸»åŠ¨è¿›è¡ŒGC *&#x2F;</span><br><span class="line">        System.gc();</span><br><span class="line">        System.out.println(softReference.get());</span><br><span class="line"></span><br><span class="line">        &#x2F;* è®©ç³»ç»Ÿèµ„æºç´§å¼  *&#x2F;</span><br><span class="line">        try &#123;</span><br><span class="line">            byte[] bytes &#x3D; new byte[1024 * 1024 * 7]; &#x2F;&#x2F; 7m</span><br><span class="line">        &#125; catch (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            System.out.println(softReference.get()); &#x2F;&#x2F; nullä»£è¡¨å·²ç»è¢«å›æ”¶</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.lang.Object@1b6d3586</span><br><span class="line">java.lang.Object@1b6d3586</span><br><span class="line">java.lang.Object@1b6d3586</span><br><span class="line">java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">    at top.parak.SoftReferenceTest.main(SoftReferenceTest.java:35)</span><br><span class="line">null</span><br></pre></td></tr></table></figure>



<blockquote>
<p>3ï¸âƒ£ å¼±å¼•ç”¨ï¼ˆWeak Reference/å‘ç°å›æ”¶ï¼‰</p>
</blockquote>
<p>å¼±å¼•ç”¨ä¹Ÿæ˜¯ç”¨æ¥æè¿°é‚£äº›éå¿…é¡»å¯¹è±¡ï¼Œåªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾å‘ç”Ÿä¸ºæ­¢ã€‚åœ¨ç³»ç»ŸGCæ—¶ï¼Œåªè¦å‘ç°å¼±å¼•ç”¨ï¼Œä¸ç®¡ç³»ç»Ÿå †ç©ºé—´ä½¿ç”¨æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶æ‰åªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚</p>
<p>ä½†æ˜¯ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨çš„çº¿ç¨‹é€šå¸¸ä¼˜å…ˆçº§å¾ˆä½ï¼Œå› æ­¤ï¼Œå¹¶ä¸ä¸€å®šèƒ½å¾ˆå¿«åœ°å‘ç°æŒæœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¼±å¼•ç”¨å¯¹è±¡å¯ä»¥å­˜åœ¨è¾ƒé•¿çš„æ—¶é—´ã€‚</p>
<p>å¼±å¼•ç”¨å’Œè½¯å¼•ç”¨ä¸€æ ·ï¼Œåœ¨æ„é€ å¼±å¼•ç”¨æ—¶ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼Œå½“å¼±å¼•ç”¨å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œå°±ä¼šåŠ å…¥æŒ‡å®šçš„å¼•ç”¨é˜Ÿåˆ—ï¼Œé€šè¿‡è¿™ä¸ªé˜Ÿåˆ—å¯ä»¥è·Ÿè¸ªå¯¹è±¡çš„å›æ”¶æƒ…å†µã€‚</p>
<p>è½¯å¼•ç”¨ã€å¼±å¼•ç”¨éƒ½éå¸¸é€‚åˆæ¥ä¿å­˜é‚£äº›å¯æœ‰å¯æ— çš„ç¼“å­˜æ•°æ®ã€‚å¦‚æœè¿™ä¹ˆåšï¼Œå½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼Œè¿™äº›ç¼“å­˜æ•°æ®ä¼šè¢«å›æ”¶ï¼Œä¸ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚è€Œå½“å†…å­˜èµ„æºå……è¶³æ—¶ï¼Œè¿™äº›ç¼“å­˜åˆå¯ä»¥å­˜åœ¨ç›¸å½“é•¿çš„æ—¶é—´ï¼Œä»è€Œèµ·åˆ°åŠ é€Ÿç³»ç»Ÿçš„ä½œç”¨ã€‚</p>
<p>å®ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class WeakReferenceTest &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Object obj &#x3D; new Object();</span><br><span class="line">        WeakReference&lt;Object&gt; weakReference &#x3D; new WeakReference&lt;Object&gt;(obj);</span><br><span class="line">        System.out.println(weakReference.get());</span><br><span class="line">       &#x2F;* è§£é™¤å¼ºå¼•ç”¨ *&#x2F;</span><br><span class="line">        obj &#x3D; null;</span><br><span class="line">        &#x2F;* ä¸»åŠ¨GC *&#x2F;</span><br><span class="line">        System.gc();</span><br><span class="line">        System.out.println(weakReference.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.lang.Object@1b6d3586</span><br><span class="line">null</span><br></pre></td></tr></table></figure>



<blockquote>
<p>4ï¸âƒ£ è™šå¼•ç”¨ï¼ˆPhantom Reference/å›æ”¶è·Ÿè¸ªï¼‰</p>
</blockquote>
<p>è™šå¼•ç”¨ä¹Ÿç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œæ˜¯æ‰€æœ‰å¼•ç”¨ç±»å‹ä¸­æœ€å¼±çš„ä¸€ä¸ªã€‚</p>
<p>ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå’Œå®ƒæ²¡æœ‰å¼•ç”¨å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œéšæ—¶éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</p>
<p>å®ƒä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥è·å–è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚å½“è¯•å›¾é€šè¿‡è™šå¼•ç”¨çš„get()æ–¹æ³•å–å¾—å¯¹è±¡æ—¶ï¼Œæ€»æ˜¯nullã€‚</p>
<p>ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„åœ¨äºè·Ÿè¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚æ¯”å¦‚ï¼šèƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚</p>
<p>å®ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class PhantomReferenceTest &#123;</span><br><span class="line">    public static PhantomReferenceTest obj;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * å¼•ç”¨é˜Ÿåˆ—</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static ReferenceQueue&lt;PhantomReferenceTest&gt; phantomQueue &#x3D; null;</span><br><span class="line"></span><br><span class="line">    public static class CheckRefQueue extends Thread &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                if (phantomQueue !&#x3D; null) &#123;</span><br><span class="line">                    PhantomReference&lt;PhantomReferenceTest&gt; objt &#x3D; null;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        objt &#x3D; (PhantomReference&lt;PhantomReferenceTest&gt;) phantomQueue.remove();</span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (objt !&#x3D; null) &#123;</span><br><span class="line">                        System.out.println(&quot;è¿½è¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹ï¼šPhantRefernceTestå®ä¾‹è¢«GCäº†&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void finalize() throws Throwable &#123;</span><br><span class="line">        super.finalize();</span><br><span class="line">        System.out.println(&quot;è°ƒç”¨å½“å‰ç±»çš„finalize()æ–¹æ³•&quot;);</span><br><span class="line">        obj &#x3D; this;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Thread t &#x3D; new CheckRefQueue();</span><br><span class="line">        t.setDaemon(true);  &#x2F;&#x2F; å®ˆæŠ¤çº¿ç¨‹</span><br><span class="line">        t.start();</span><br><span class="line"></span><br><span class="line">        phantomQueue &#x3D; new ReferenceQueue&lt;PhantomReferenceTest&gt;();</span><br><span class="line">        obj &#x3D; new PhantomReferenceTest();</span><br><span class="line">        &#x2F;&#x2F; æ„é€ äº†PhantomReferenceå¯¹è±¡çš„è™šå¼•ç”¨ï¼Œå¹¶æŒ‡å®šäº†å¼•ç”¨é˜Ÿåˆ—</span><br><span class="line">        PhantomReference&lt;PhantomReferenceTest&gt; phantomRef &#x3D; new PhantomReference&lt;&gt;(obj, phantomQueue);</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; ä¸å¯è·å–è™šå¼•ç”¨ä¸­çš„å¯¹è±¡</span><br><span class="line">            System.out.println(&quot;phantomRef.get() &#x3D; &quot; + phantomRef.get());</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; ç¬¬ä¸€æ¬¡GCï¼Œç”±äºå¯¹è±¡å¯å¤æ´»ï¼Œå¹¶æŒ‡å®šäº†å¼•ç”¨é˜Ÿåˆ—</span><br><span class="line">            System.out.println(&quot;&#x3D;&gt;&gt;&gt; ç¬¬ä¸€æ¬¡GCæ“ä½œ&quot;);</span><br><span class="line">            obj &#x3D; null; &#x2F;&#x2F; è§£é™¤å¼ºå¼•ç”¨</span><br><span class="line">            System.gc();</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">            System.out.println(obj &#x3D;&#x3D; null ? &quot;obj &#x3D;&#x3D; null&quot; : &quot;obj !&#x3D; null&quot;);</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;&#x3D;&gt;&gt;&gt; ç¬¬äºŒæ¬¡GC&quot;);</span><br><span class="line">            obj &#x3D; null; &#x2F;&#x2F; è§£é™¤å¼ºå¼•ç”¨</span><br><span class="line">            System.gc();</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">            System.out.println(obj &#x3D;&#x3D; null ? &quot;obj &#x3D;&#x3D; null&quot; : &quot;obj !&#x3D; null&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">phantomRef.get() &#x3D; null</span><br><span class="line">&#x3D;&gt;&gt;&gt; ç¬¬ä¸€æ¬¡GCæ“ä½œ</span><br><span class="line">è°ƒç”¨å½“å‰ç±»çš„finalize()æ–¹æ³•</span><br><span class="line">obj !&#x3D; null</span><br><span class="line">&#x3D;&gt;&gt;&gt; ç¬¬äºŒæ¬¡GC</span><br><span class="line">è¿½è¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹ï¼šPhantRefernceTestå®ä¾‹è¢«GCäº†</span><br><span class="line">obj &#x3D;&#x3D; null</span><br></pre></td></tr></table></figure>



<blockquote>
<p>5ï¸âƒ£ ç»ˆç»“å™¨å¼•ç”¨</p>
</blockquote>
<ul>
<li>å®ƒç”¨ä»¥å®ç°å¯¹è±¡çš„finalize()æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æˆä¸ºç»ˆç»“å™¨å¼•ç”¨ã€‚</li>
<li>æ— éœ€æ‰‹åŠ¨ç¼–ç ï¼Œå…¶å†…éƒ¨é…åˆå¼•ç”¨é˜Ÿåˆ—ä½¿ç”¨ã€‚</li>
<li>åœ¨GCæ—¶ï¼Œç»ˆç»“å™¨å¼•ç”¨å…¥é˜Ÿã€‚ç”±Finalizerçº¿ç¨‹é€šè¿‡ç»ˆç»“å™¨å¼•ç”¨æ‰¾åˆ°è¢«å¼•ç”¨å¯¹è±¡å¹¶è°ƒç”¨å®ƒçš„finalize()æ–¹æ³•ï¼Œç¬¬äºŒæ¬¡GCæ—¶æ‰èƒ½å›æ”¶è¢«å¼•ç”¨å¯¹è±¡ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-5(è™šæ‹Ÿæœºæ ˆ)</title>
    <url>/posts/31700/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="5-1-ğŸ“š-æ¦‚è¿°"><a href="#5-1-ğŸ“š-æ¦‚è¿°" class="headerlink" title="5.1 ğŸ“š æ¦‚è¿°"></a>5.1 ğŸ“š æ¦‚è¿°</h2><blockquote>
<p>ğŸ“Œ å†…å­˜ä¸­çš„æ ˆä¸å †</p>
</blockquote>
<p>æ ˆæ˜¯è¿è¡Œæ—¶çš„å•ä½ï¼Œå †æ˜¯å­˜å‚¨æ—¶çš„å•ä½ã€‚</p>
<p>æ ˆè§£å†³ç¨‹åºçš„è¿è¡Œé—®é¢˜ï¼Œå³ç¨‹åºå¦‚ä½•æ‰§è¡Œï¼Œæˆ–è€…è¯´å¦‚ä½•å¤„ç†æ•°æ®ã€‚</p>
<p>å †è§£å†³çš„æ—¶æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œå³æ•°æ®æ€ä¹ˆæ”¾ã€æ”¾åœ¨å“ªå„¿ã€‚</p>
<blockquote>
<p>ğŸ“– Javaè™šæ‹Ÿæœºæ ˆ</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºæ ˆï¼Œæ—©æœŸä¹Ÿå«Javaæ ˆã€‚</p>
<p>æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿å­˜ä¸€ä¸ªä¸ªçš„æ ˆå¸§ï¼Œå¯¹åº”ç€ä¸€æ¬¡æ¬¡çš„Javaæ–¹æ³•è°ƒç”¨ã€‚</p>
<blockquote>
<p>âŒ› ç”Ÿå‘½å‘¨æœŸ</p>
</blockquote>
<p>ä¸çº¿ç¨‹ä¸€è‡´ã€‚</p>
<blockquote>
<p>ğŸ”¨ ä½œç”¨</p>
</blockquote>
<p>ä¸»ç®¡Javaç¨‹åºçš„è¿è¡Œï¼Œå®ƒä¿å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€éƒ¨åˆ†ç»“æœï¼Œå¹¶å‚ä¸æ–¹æ³•çš„è°ƒç”¨å’Œè¿”å›ã€‚</p>
<blockquote>
<p>ğŸŒ  ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>æ ˆæ˜¯ä¸€ç§å¿«é€Ÿæœ‰æ•ˆçš„åˆ†é…å­˜å‚¨æ–¹å¼ï¼Œè®¿é—®é€Ÿåº¦ä»…æ¬¡äºç¨‹åºè®¡æ•°å™¨</li>
<li>JVMç›´æ¥å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼š<ul>
<li>æ¯ä¸ªæ–¹æ³•æ‰§è¡Œï¼Œä¼´éšç€è¿›æ ˆ</li>
<li>æ‰§è¡Œç»“æŸåçš„å‡ºæ ˆå·¥ä½œ</li>
</ul>
</li>
<li>å¯¹äºæ ˆæ¥è¯´ä¸å­˜åœ¨åƒåœ¾å›æ”¶é—®é¢˜</li>
</ul>
<blockquote>
<p>â— æ ˆä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºè§„èŒƒå…è®¸Javaæ ˆçš„å¤§å°æ˜¯åŠ¨æ€çš„æˆ–è€…å›ºå®šä¸å˜çš„ã€‚</p>
<ul>
<li><p>å¦‚æœé‡‡ç”¨å›ºå®šå¤§å°çš„Javaè™šæ‹Ÿæœºæ ˆï¼Œé‚£æ¯ä¸€ä¸ªçº¿ç¨‹çš„Javaè™šæ‹Ÿæœºæ ˆå®¹é‡å¯ä»¥åœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ç‹¬ç«‹é€‰å®šã€‚å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡Javaè™šæ‹Ÿæœºæ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ªStackOverflowErrorå¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ ˆæº¢å‡ºå…¸å‹å®ä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StackOverflow</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> StackOverflow().keep();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">keep</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        keep();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¦‚æœJavaè™šæ‹Ÿæœºå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œé‚£Javaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ªOutOfMemoryErrorå¼‚å¸¸ã€‚</p>
</li>
</ul>
<h2 id="5-2-ğŸ”³-æ ˆçš„å­˜å‚¨å•ä½"><a href="#5-2-ğŸ”³-æ ˆçš„å­˜å‚¨å•ä½" class="headerlink" title="5.2 ğŸ”³ æ ˆçš„å­˜å‚¨å•ä½"></a>5.2 ğŸ”³ æ ˆçš„å­˜å‚¨å•ä½</h2><blockquote>
<p>ğŸ“¦ æ ˆä¸­å­˜å‚¨ä»€ä¹ˆ</p>
</blockquote>
<ul>
<li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œæ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ä»¥æ ˆå¸§(Stack Frame)çš„æ ¼å¼å­˜åœ¨ã€‚</li>
<li>åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªæ–¹æ³•éƒ½å„è‡ªå¯¹åº”ä¸€ä¸ªæ ˆå¸§(Stack Frame)ã€‚</li>
<li>æ ˆå¸§æ˜¯ä¸€ä¸ªå†…å­˜åŒºå—ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®é›†ï¼Œç»´ç³»ç€æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§æ•°æ®ä¿¡æ¯ã€‚</li>
</ul>
<blockquote>
<p>ğŸ” æ ˆçš„è¿è¡ŒåŸç†</p>
</blockquote>
<ul>
<li>JVMç›´æ¥å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å¯¹æ ˆå¸§çš„å‹æ ˆå’Œå‡ºæ ˆï¼Œéµå¾ªâ€œå…ˆè¿›åå‡ºâ€æˆ–è€…â€œåè¿›å…ˆå‡ºâ€åŸåˆ™ã€‚</li>
<li>åœ¨ä¸€æ¡æ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œåªä¼šæœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ã€‚å³åªæœ‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•çš„æ ˆå¸§ï¼ˆæ ˆé¡¶æ ˆå¸§ï¼‰æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªæ ˆå¸§è¢«ç§°ä¸ºå½“å‰æ ˆå¸§ï¼ˆCurrent Frameï¼‰ï¼Œä¸å½“å‰æ ˆå¸§ç›¸å¯¹åº”çš„æ–¹æ³•å°±æ˜¯å½“å‰æ–¹æ³•ï¼ˆCurrent Methodï¼‰ï¼Œå®šä¹‰è¿™ä¸ªæ–¹æ³•çš„ç±»å°±æ˜¯å½“å‰ç±»ï¼ˆCurrent Classï¼‰ã€‚</li>
<li>æ‰§è¡Œå¼•æ“è¿è¡Œçš„æ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤åªé’ˆå¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œã€‚</li>
<li>å¦‚æœåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œå¯¹åº”çš„æ–°çš„æ ˆå¸§ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œæ”¾åœ¨æ ˆçš„é¡¶ç«¯ï¼Œæˆä¸ºæ–°çš„å½“å‰å¸§ã€‚</li>
<li>ä¸åŒçº¿ç¨‹ä¸­æ‰€åŒ…å«çš„æ ˆå¸§æ˜¯ä¸å…è®¸å­˜åœ¨ç›¸äº’å¼•ç”¨çš„ï¼Œå³ä¸å¯èƒ½åœ¨ä¸€ä¸ªå¸§ä¹‹ä¸­å¼•ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ ˆå¸§ã€‚</li>
<li>å¦‚æœå½“å‰æ–¹æ³•è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œæ–¹æ³•è¿”å›ä¹‹é™…ï¼Œå½“å‰æ ˆå¸§ä¼šä¼ å›æ­¤æ–¹æ³•çš„æ‰§è¡Œç»“æœç»™å‰ä¸€ä¸ªæ ˆå¸§ï¼Œæ¥ç€ï¼Œè™šæ‹Ÿæœºä¼šä¸¢å¼ƒå½“å‰æ ˆå¸§ï¼Œä½¿å¾—å‰ä¸€ä¸ªæ ˆå¸§é‡æ–°æˆä¸ºå½“å‰æ ˆå¸§ã€‚</li>
<li>Javaæ–¹æ³•æœ‰ä¸¤ç§è¿”å›å‡½æ•°çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯æ­£å¸¸çš„å‡½æ•°è¿”å›ï¼Œä½¿ç”¨returnæŒ‡ä»¤ï¼›å¦å¤–ä¸€ç§æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚ä¸ç®¡ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡ºã€‚</li>
</ul>
<blockquote>
<p>ğŸ”© æ ˆå¸§å†…éƒ¨ç»“æ„</p>
</blockquote>
<ul>
<li>å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰</li>
<li>æ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰</li>
<li>åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰</li>
<li>æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰</li>
<li>ä¸€äº›é™„åŠ ä¿¡æ¯</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/31700/%E6%A0%88%E5%B8%A7%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%84.svg" class="" title="æ ˆå¸§å†…éƒ¨ç»“æ„"><br />



<h2 id="5-3-ğŸ“…-å±€éƒ¨å˜é‡è¡¨"><a href="#5-3-ğŸ“…-å±€éƒ¨å˜é‡è¡¨" class="headerlink" title="5.3 ğŸ“… å±€éƒ¨å˜é‡è¡¨"></a>5.3 ğŸ“… å±€éƒ¨å˜é‡è¡¨</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>å±€éƒ¨å˜é‡è¡¨ä¹Ÿè¢«ç§°ä¹‹ä¸ºå±€éƒ¨å˜é‡æ•°ç»„æˆ–æœ¬åœ°å˜é‡è¡¨ã€‚</li>
<li>å®šä¹‰ä¸ºä¸€ä¸ªæ•°å­—æ•°ç»„ï¼Œä¸»è¦ç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡ï¼Œè¿™äº›æ•°æ®ç±»å‹åŒ…æ‹¬å„ç±»åŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceï¼‰ï¼Œä»¥åŠreturnAddressç±»å‹ã€‚</li>
<li>ç”±äºå±€éƒ¨å˜é‡è¡¨ç¤ºå»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šï¼Œæ˜¯çº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œå› æ­¤ä¸å­˜åœ¨æ•°æ®å®‰å…¨é—®é¢˜ã€‚</li>
<li>å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å®¹é‡å¤§å°æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šä¸‹æ¥ï¼Œå¹¶ä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§çš„maximum local variablesç±»å‹ã€‚</li>
<li>ç”±äºå±€éƒ¨å˜é‡è¡¨æ˜¯å»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šï¼Œæ˜¯çº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œå› æ­¤ä¸å­˜åœ¨æ•°æ®å®‰å…¨é—®é¢˜ã€‚</li>
<li>å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å®¹é‡å¤§å°æ˜¯åœ¨ç¼–è¯‘å™¨ç¡®å®šä¸‹æ¥çš„ï¼Œå¹¶ä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§çš„maximum local variablesæ•°æ®é¡¹ä¸­ã€‚åœ¨æ–¹æ³•è¿è¡ŒæœŸé—´æ˜¯ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°çš„ã€‚</li>
<li>æ–¹æ³•åµŒå¥—è°ƒç”¨çš„æ¬¡æ•°ç”±æ ˆçš„å¤§å°å†³å®šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ ˆè¶Šå¤§ï¼Œæ–¹æ³•åµŒå¥—è°ƒç”¨æ¬¡æ•°è¶Šå¤šã€‚å¯¹ä¸€ä¸ªå‡½æ•°è€Œè¨€ï¼Œå®ƒçš„å‚æ•°å’Œå±€éƒ¨å˜é‡è¶Šå¤šï¼Œä½¿å¾—å±€éƒ¨å˜é‡è¡¨è†¨èƒ€ï¼Œå®ƒçš„æ ˆå¸§å°±è¶Šå¤§ï¼Œä»¥æ»¡è¶³æ–¹æ³•è°ƒç”¨æ‰€éœ€ä¼ é€’çš„ä¿¡æ¯å¢å¤§çš„éœ€æ±‚ã€‚è¿›è€Œå‡½æ•°è°ƒç”¨å°±ä¼šå ç”¨æ›´å¤šçš„æ ˆç©ºé—´ï¼Œå¯¼è‡´å…¶åµŒå¥—è°ƒç”¨æ¬¡æ•°å°±ä¼šå‡å°‘ã€‚</li>
<li>å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡åªåœ¨å½“å‰æ–¹æ³•è°ƒç”¨ä¸­æœ‰æ•ˆã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºé€šè¿‡ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆå‚æ•°å€¼åˆ°å‚æ•°å˜é‡åˆ—è¡¨çš„ä¼ é€’è¿‡ç¨‹ã€‚å½“æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œéšç€æ–¹æ³•æ ˆå¸§çš„é”€æ¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¹Ÿä¼šéšä¹‹é”€æ¯ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“¬ Slot</p>
</blockquote>
<ul>
<li><p>å‚æ•°å€¼çš„å­˜æ”¾æ€»æ˜¯åœ¨å±€éƒ¨å˜é‡æ•°ç»„çš„index0å¼€å§‹ï¼Œåˆ°æ•°ç»„é•¿åº¦-1çš„ç´¢å¼•ç»“æŸã€‚</p>
</li>
<li><p>å±€éƒ¨å˜é‡è¡¨ï¼Œæœ€åŸºæœ¬çš„å­˜å‚¨å•å…ƒæ˜¯Slotï¼ˆå˜é‡æ§½ï¼‰ã€‚</p>
</li>
<li><p>å±€éƒ¨å˜é‡è¡¨ä¸­å­˜æ”¾ç¼–è¯‘å™¨å¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆ8ç§ï¼‰ï¼Œå¼•ç”¨ç±»å‹ï¼ˆreferenceï¼‰ï¼ŒreturnAddressç±»å‹çš„å˜é‡ã€‚</p>
</li>
<li><p>åœ¨å±€éƒ¨å˜é‡è¡¨é‡Œï¼Œ32ä½ä»¥å†…çš„ç±»å‹åªå ç”¨ä¸€ä¸ªSlotï¼ˆåŒ…æ‹¬returnAddressç±»å‹ï¼‰ï¼Œ64ä½çš„ç±»å‹ï¼ˆlongå’Œdoubleï¼‰å ç”¨ä¸¤ä¸ªslotã€‚</p>
<ul>
<li>byteã€shortã€charåœ¨å­˜å‚¨å‰è¢«è½¬æ¢ä¸ºintï¼Œbooleanä¹Ÿè¢«è½¬æ¢ä¸ºintï¼Œ0è¡¨ç¤ºfalseï¼Œé0è¡¨ç¤ºtrueã€‚</li>
<li>longå’Œdoubleåˆ™å æ®ä¸¤ä¸ªSlotã€‚</li>
</ul>
</li>
<li><p>JVMä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªSlotéƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å‘ƒå±€éƒ¨å˜é‡å€¼ã€‚</p>
</li>
<li><p>å½“ä¸€ä¸ªå®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„æ–¹æ³•å‚æ•°å’Œæ–¹æ³•ä½“å†…éƒ¨å®šä¹‰çš„å±€éƒ¨ä¾¿ä»¤éƒ½ä¼šæŒ‰ç…§é¡ºåºè¢«å¤åˆ¶åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼ã€‚</p>
</li>
<li><p>å¦‚æœéœ€è¦è®¿é—®å±€éƒ¨å˜é‡è¡¨ä¸­ä¸€ä¸ª64bitçš„å±€éƒ¨å˜é‡å€¼æ—¶ï¼Œåªéœ€è¦ä½¿ç”¨å‰ä¸€ä¸ªç´¢å¼•å³å¯ã€‚</p>
</li>
<li><p>å¦‚æœå½“å‰å¸§æ˜¯ç”±æ„é€ æ–¹æ³•æˆ–è€…å®ä¾‹æ–¹æ³•åˆ›å»ºçš„ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å¼•ç”¨thiså°†ä¼šå­˜æ”¾åœ¨indexä¸º0çš„slotå¤„ï¼Œå…¶ä½™çš„å‚æ•°æŒ‰ç…§å‚æ•°è¡¨é¡ºåºç»§ç»­æ’åºã€‚</p>
</li>
<li><p>JVMä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªSlotéƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼ã€‚</p>
</li>
<li><p>å½“ä¸€ä¸ªå®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„æ–¹æ³•å‚æ•°å’Œæ–¹æ³•ä½“å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡å°†ä¼šæŒ‰ç…§é¡ºåºè¢«å¤åˆ¶åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªSlotä¸Šã€‚</p>
</li>
<li><p>å¦‚æœéœ€è¦è®¿é—®å±€éƒ¨å˜é‡è¡¨ä¸­ä¸€ä¸ª64bitçš„å±€éƒ¨å˜é‡å€¼æ—¶ï¼Œåªéœ€è¦ä½¿ç”¨å‰ä¸€ä¸ªç´¢å¼•å³å¯ã€‚</p>
</li>
<li><p>å¦‚æœå½“å‰å¸§æ˜¯ç”±æ„é€ æ–¹æ³•æˆ–è€…å®ä¾‹æ–¹æ³•åˆ›å»ºçš„ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å¼•ç”¨thiså°†ä¼šå­˜æ”¾åœ¨indexä¸º0çš„Slotå¤„ï¼Œå…¶ä½™çš„å‚æ•°æŒ‰ç…§å‚æ•°è¡¨çš„é¡ºåºç»§ç»­æ’åˆ—ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ—³ Slotçš„é‡å¤åˆ©ç”¨</p>
</blockquote>
<p>æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ§½ä½æ˜¯å¯ä»¥é‡ç”¨çš„ï¼Œå¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸï¼Œé‚£ä¹ˆåœ¨å…¶ä½œç”¨åŸŸä¹‹åç”³æ˜çš„æ–°çš„å±€éƒ¨å˜é‡å°±å¾ˆæœ‰å¯èƒ½ä¼šå¤ç”¨è¿‡æœŸå±€éƒ¨å˜é‡çš„æ§½ä½ï¼Œä»è€Œè¾¾åˆ°èŠ‚çœèµ„æºçš„ç›®çš„ã€‚</p>
<blockquote>
<p>é™æ€å˜é‡ ğŸ†š å±€éƒ¨å˜é‡</p>
</blockquote>
<p>å˜é‡æŒ‰ç…§åœ¨ç±»ä¸­å£°æ˜çš„ä½ç½®åˆ†ï¼š</p>
<ul>
<li>æˆå‘˜å˜é‡ï¼šåœ¨ä½¿ç”¨å‰ï¼Œéƒ½ç»å†è¿‡é»˜è®¤åˆå§‹åŒ–å€¼<ul>
<li>é™æ€å˜é‡ï¼ˆç±»å˜é‡/staticå˜é‡ï¼‰ï¼šé“¾æ¥çš„å‡†å¤‡é˜¶æ®µï¼Œç»™ç±»å˜é‡é»˜è®¤èµ‹å€¼ â€”&gt; initialé˜¶æ®µï¼šç»™ç±»å˜é‡æ˜¾ç¤ºèµ‹å€¼å³é™æ€ä»£ç å—èµ‹å€¼ã€‚</li>
<li>å®ä¾‹å˜é‡ï¼ˆéstaticå˜é‡ï¼‰ï¼šéšç€å¯¹è±¡çš„åˆ›å»ºï¼Œä¼šåœ¨å †ç©ºé—´ä¸­åˆ†é…å®ä¾‹å˜é‡ç©ºé—´ï¼Œå¹¶è¿›è¡Œé»˜è®¤èµ‹å€¼ã€‚</li>
</ul>
</li>
<li>å±€éƒ¨å˜é‡ï¼šåœ¨ä½¿ç”¨å‰ï¼Œå¿…é¡»è¦è¿›è¡Œæ˜¾ç¤ºèµ‹å€¼ï¼Œå¦åˆ™ç¼–è¯‘ä¸é€šè¿‡ã€‚</li>
</ul>
<blockquote>
<p>ğŸ”” è¡¥å……</p>
</blockquote>
<ul>
<li>åœ¨æ ˆå¸§ä¸­ï¼Œä¸æ€§èƒ½è°ƒä¼˜å…³ç³»æœ€ä¸ºå¯†åˆ‡çš„éƒ¨åˆ†å°±æ˜¯å‰é¢æåˆ°çš„å±€éƒ¨å˜é‡è¡¨ã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆæ–¹æ³•çš„ä¼ é€’ã€‚</li>
<li>å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡ä¹Ÿæ˜¯é‡è¦çš„åƒåœ¾å›æ”¶æ ¹èŠ‚ç‚¹ï¼Œåªè¦è¢«å±€éƒ¨å˜é‡è¡¨ä¸­ç›´æ¥æˆ–ç®€ä»‹å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶ã€‚</li>
</ul>
<h2 id="5-4-ğŸ“¥-æ“ä½œæ•°æ ˆ"><a href="#5-4-ğŸ“¥-æ“ä½œæ•°æ ˆ" class="headerlink" title="5.4 ğŸ“¥ æ“ä½œæ•°æ ˆ"></a>5.4 ğŸ“¥ æ“ä½œæ•°æ ˆ</h2><blockquote>
<p>ğŸ’¬ æ¦‚è¿°</p>
</blockquote>
<ul>
<li>æ¯ä¸€ä¸ªç‹¬ç«‹åœ°æ ˆå¸§ä¸­é™¤äº† åŒ…å«å±€éƒ¨å˜é‡è¡¨ä»¥å¤–ï¼Œè¿˜åŒ…å«ä¸€ä¸ªåè¿›å…ˆå‡ºï¼ˆLast-In-First-Outï¼‰çš„æ“ä½œæ•°æ ˆï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºè¡¨è¾¾å¼æ ˆï¼ˆExpress Stackï¼‰ã€‚</li>
<li>æ“ä½œæ•°æ ˆï¼Œåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¾€æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼Œå³å…¥æ ˆ(push)/å‡ºæ ˆ(pop)ã€‚<ul>
<li>æŸäº›å­—èŠ‚ç æŒ‡ä»¤å°†å€¼å‹å…¥æ“ä½œæ•°æ ˆï¼Œå…¶ä½™çš„å­—èŠ‚ç æŒ‡ä»¤å°†æ“ä½œæ•°å–å‡ºæ ˆã€‚ä½¿ç”¨å®ƒä»¬åå†æŠŠç»“æœå‹å…¥æ ˆã€‚</li>
<li>æ¯”å¦‚ï¼šæ‰§è¡Œå¤åˆ¶ã€äº¤æ¢ã€æ±‚å’Œç­‰æ“ä½œã€‚</li>
</ul>
</li>
<li>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦æœ‰è¿”å›å€¼çš„è¯ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­ï¼Œå¹¶æ›´æ–°PCå¯„å­˜å™¨ä¸­ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</li>
<li>æ“ä½œæ•°æ ˆä¸­å…ƒç´ çš„æ•°æ®ç±»å‹å¿…é¡»ä¸å­—èŠ‚ç æŒ‡ä»¤çš„åºåˆ—ä¸¥æ ¼åŒ¹é…ï¼Œè¿™ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´è¿›è¡ŒéªŒè¯ï¼ŒåŒæ—¶åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„ç±»æ£€éªŒé˜¶æ®µçš„æ•°æ®æµåˆ†æé˜¶æ®µè¦å†æ¬¡éªŒè¯ã€‚</li>
<li>Javaè™šæ‹Ÿæœºçš„è§£é‡Šå¼•æ“åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“ï¼Œå…¶ä¸­çš„æ ˆæŒ‡çš„å°±æ˜¯æ“ä½œæ•°æ ˆã€‚</li>
</ul>
<blockquote>
<p>ğŸ“– ç†è®º</p>
</blockquote>
<ul>
<li>æ“ä½œæ•°æ ˆï¼Œä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´ã€‚</li>
<li>æ“ä½œæ•°æ ˆå°±æ˜¯JVMæ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥ä½œåŒºï¼Œå½“ä¸€ä¸ªæ–¹æ³•åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§ä¹Ÿä¼šéšä¹‹è¢«åˆ›å»ºå‡ºæ¥ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„ã€‚</li>
<li>æ¯ä¸€ä¸ªæ“ä½œæ•°æ ˆéƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ˆæ·±åº¦ç”¨äºå­˜å‚¨æ•°å€¼ï¼Œå…¶æ‰€éœ€çš„æœ€å¤§æ·±åº¦åœ¨ç¼–è¯‘æœŸå°±å®šä¹‰å¥½äº†ï¼Œä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§ä¸­ï¼Œä¸ºmax_stackçš„å€¼ã€‚</li>
<li>æ ˆä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯å¯ä»¥ä»»æ„çš„Javaæ•°æ®ç±»å‹ã€‚<ul>
<li>32bitçš„ç±»å‹å ç”¨ä¸€ä¸ªæ ˆå•ä½æ·±åº¦ã€‚</li>
<li>64bitçš„ç±»å‹å ç”¨ä¸¤ä¸ªæ ˆå•ä½æ·±åº¦ã€‚</li>
</ul>
</li>
<li>æ“ä½œæ•°æ ˆå¹¶éé‡‡ç”¨è®¿é—®ç´¢å¼•çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®è®¿é—®çš„ã€‚è€Œæ˜¯åªèƒ½é€šè¿‡æ ‡å‡†çš„å…¥æ ˆ(push)å’Œå‡ºæ ˆ(pop)æ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®ã€‚</li>
</ul>
<h2 id="5-5-ğŸ“¡-ä»£ç è¿½è¸ª"><a href="#5-5-ğŸ“¡-ä»£ç è¿½è¸ª" class="headerlink" title="5.5 ğŸ“¡ ä»£ç è¿½è¸ª"></a>5.5 ğŸ“¡ ä»£ç è¿½è¸ª</h2><blockquote>
<p>âŒ¨ï¸ ä»£ç </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperandStackTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> m = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">int</span> n = <span class="number">20</span>;</span><br><span class="line">        <span class="keyword">int</span> k = m + n;</span><br><span class="line">        <span class="keyword">return</span> k;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è·å–ä¸Šä¸€ä¸ªæ ˆå¸§è¿”å›çš„ç»“æœï¼Œå¹¶ä¿å­˜åœ¨æ“ä½œæ•°æ ˆä¸­</span></span><br><span class="line">        <span class="keyword">int</span> i = getSum();</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ğŸ” è§£æ</p>
</blockquote>
<p>jclasslibå­—èŠ‚ç å¦‚ä¸‹ï¼š</p>
<ul>
<li>getSumå‡½æ•°</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">æŒ‡ä»¤åœ°å€ æ“ä½œæŒ‡ä»¤</span><br><span class="line">     <span class="number">0</span> bipush <span class="number">10</span>  <span class="comment">// å°†10å‹å…¥æ“ä½œæ•°æ ˆ</span></span><br><span class="line">     <span class="number">2</span> istore_1   <span class="comment">// æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®</span></span><br><span class="line">     <span class="number">3</span> bipush <span class="number">20</span>  <span class="comment">// å°†20å‹å…¥æ“ä½œæ•°æ ˆ</span></span><br><span class="line">     <span class="number">5</span> istore_2   <span class="comment">// æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½®</span></span><br><span class="line">     <span class="number">6</span> iload_1    <span class="comment">// ä»å±€éƒ¨å˜é‡è¡¨ä¸­å–å‡ºç´¢å¼•ä¸º1çš„æ•°æ®ï¼Œå‹å…¥æ“ä½œæ•°æ ˆ</span></span><br><span class="line">     <span class="number">7</span> iload_2    <span class="comment">// ä»å±€éƒ¨å˜é‡è¡¨ä¸­å–å‡ºç´¢å¼•ä¸º2çš„æ•°æ®ï¼Œå‹å…¥æ“ä½œæ•°æ ˆ</span></span><br><span class="line">     <span class="number">8</span> iadd       <span class="comment">// å°†æ ˆé¡¶çš„ä¸¤ä¸ªæ•°å‡ºæ ˆå¹¶ç›¸åŠ ï¼Œå‹å›æ“ä½œæ•°æ ˆ</span></span><br><span class="line">     <span class="number">9</span> istore_3   <span class="comment">// æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨</span></span><br><span class="line">    <span class="number">10</span> ireturn    <span class="comment">// ä»å½“å‰å¸§çš„æ“ä½œæ•°æ ˆå¼¹å‡ºå€¼ï¼Œå¹¶å°†å…¶å‹å…¥è°ƒç”¨è€…çš„å¸§çš„æ“ä½œæ•°æ ˆï¼Œå½“å‰æ–¹æ³•çš„æ“ä½œæ•°å †æ ˆä¸Šçš„ä»»ä½•å…¶ä»–å€¼éƒ½å°†è¢«ä¸¢å¼ƒ</span></span><br></pre></td></tr></table></figure>

<ul>
<li>testGetSumå‡½æ•°</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">æŒ‡ä»¤åœ°å€ æ“ä½œæŒ‡ä»¤   </span><br><span class="line">	<span class="number">0</span> aload_0      <span class="comment">// åŠ è½½thiså˜é‡ï¼Œå°†thisçš„å¼•ç”¨å‹å…¥æ“ä½œæ•°æ ˆ</span></span><br><span class="line">    1 invokevirtual #2 &lt;top/parak/OperandStackTest.getSum&gt; // è°ƒç”¨this.getSumæ–¹æ³•</span><br><span class="line">    <span class="number">4</span> istore_1     <span class="comment">// å°†æ–¹æ³•è¿”å›å€¼å­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®</span></span><br><span class="line">    <span class="number">5</span> bipush <span class="number">10</span>    <span class="comment">// å°†10å‹å…¥æ“ä½œæ•°æ ˆ</span></span><br><span class="line">    <span class="number">7</span> istore_2     <span class="comment">// æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½®</span></span><br><span class="line">    <span class="number">8</span> <span class="keyword">return</span>       <span class="comment">// ç›´æ¥è¿”å›</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>i++ ğŸ†š ++i</p>
</blockquote>
<p>æºä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i1 = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> i3 = i1++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i2 = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> i4 = ++i2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­—èŠ‚ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">æŒ‡ä»¤åœ°å€ æ“ä½œæŒ‡ä»¤ </span><br><span class="line">     <span class="number">0</span> bipush <span class="number">10</span>    <span class="comment">// å°†10å‹å…¥æ“ä½œæ•°æ ˆ</span></span><br><span class="line">     <span class="number">2</span> istore_1     <span class="comment">// æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½® </span></span><br><span class="line">     <span class="number">3</span> iload_1      <span class="comment">// ä»å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1ä½ç½®åŠ è½½å˜é‡åˆ°æ ˆå¸§ä¸­</span></span><br><span class="line">     <span class="number">4</span> iinc <span class="number">1</span> by <span class="number">1</span>  <span class="comment">// å¯¹ç´¢å¼•ä¸º1ä½ç½®çš„å˜é‡è¿›è¡Œ+1æ“ä½œ </span></span><br><span class="line">     <span class="number">7</span> istore_2     <span class="comment">// æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½® </span></span><br><span class="line">     <span class="number">8</span> bipush <span class="number">10</span>    <span class="comment">// å°†10å‹å…¥æ“ä½œæ•°æ ˆ</span></span><br><span class="line">    <span class="number">10</span> istore_3     <span class="comment">// æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º3çš„ä½ç½® </span></span><br><span class="line">    <span class="number">11</span> iinc <span class="number">3</span> by <span class="number">1</span>  <span class="comment">// å¯¹ç´¢å¼•ä¸º3ä½ç½®çš„å˜é‡è¿›è¡Œ+1æ“ä½œ </span></span><br><span class="line">    <span class="number">14</span> iload_3      <span class="comment">// ä»å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º3ä½ç½®åŠ è½½å˜é‡åˆ°æ ˆå¸§ä¸­</span></span><br><span class="line">    <span class="number">15</span> istore <span class="number">4</span>     <span class="comment">// å°†æ ˆå¸§çš„å€¼ä¿å­˜åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º4çš„ä½ç½®</span></span><br><span class="line">    <span class="number">17</span> <span class="keyword">return</span>	    <span class="comment">// è¿”å›</span></span><br></pre></td></tr></table></figure>



<h2 id="5-6-ğŸ“¤-æ ˆé¡¶ç¼“å­˜æŠ€æœ¯"><a href="#5-6-ğŸ“¤-æ ˆé¡¶ç¼“å­˜æŠ€æœ¯" class="headerlink" title="5.6 ğŸ“¤ æ ˆé¡¶ç¼“å­˜æŠ€æœ¯"></a>5.6 ğŸ“¤ æ ˆé¡¶ç¼“å­˜æŠ€æœ¯</h2><blockquote>
<p>ğŸ”˜ èƒŒæ™¯</p>
</blockquote>
<p>ç”±äºæ“ä½œæ•°æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œå› æ­¤é¢‘ç¹åœ°æ‰§è¡Œå†…å­˜è¯»/å†™å¿…ç„¶ä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHotSpot JVMçš„è®¾è®¡è€…ä»¬æå‡ºäº†æ ˆé¡¶ç¼“å­˜ï¼ˆToS, Top-of-Stack Cashingï¼‰æŠ€æœ¯ï¼Œå°†æ ˆé¡¶å…ƒç´ å…¨éƒ¨ç¼“å­˜åœ¨ç‰©ç†CPUçš„å¯„å­˜å™¨ï¼ˆæŒ‡ä»¤æ›´å°‘ï¼Œé€Ÿåº¦æ›´å¿«ï¼‰ä¸­ï¼Œä»¥æ­¤é™ä½å¯¹å†…å­˜çš„è¯»/å†™æ¬¡æ•°ï¼Œæå‡æ‰§è¡Œå¼•æ“çš„æ‰§è¡Œæ•ˆç‡ã€‚</p>
<h2 id="5-7-ğŸ“-åŠ¨æ€é“¾æ¥"><a href="#5-7-ğŸ“-åŠ¨æ€é“¾æ¥" class="headerlink" title="5.7 ğŸ“ åŠ¨æ€é“¾æ¥"></a>5.7 ğŸ“ åŠ¨æ€é“¾æ¥</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>æ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨ã€‚åŒ…å«è¿™ä¸ªå¼•ç”¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç èƒ½å¤Ÿå®ç°åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰ã€‚æ¯”å¦‚ï¼š<code>invokedynamic</code>æŒ‡ä»¤</li>
<li>ä¸ºJavaæºæ–‡ä»¶è¢«ç¼–è¯‘åˆ°å­—èŠ‚ç æ–‡ä»¶ä¸­æ—¶ï¼Œæ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨ï¼ˆSysmbolic Refrenceï¼‰ä¿å­˜åœ¨classæ–‡ä»¶çš„å¸¸é‡æ± é‡Œã€‚æ¯”å¦‚ï¼šæè¿°ä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†å¦å¤–çš„å…¶ä»–æ–¹æ³•æ—¶ï¼Œå°±æ˜¯é€šè¿‡å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ¥è¡¨ç¤ºçš„ï¼Œé‚£ä¹ˆåŠ¨æ€é“¾æ¥çš„ä½œç”¨å°±æ˜¯ä¸ºäº†å°†è¿™äº›ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“· å›¾ç¤º</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/31700/image-20210131234913621.png" class="" title="image-20210131234913621"><br />



<blockquote>
<p>ğŸ”¨ å¸¸é‡æ± çš„ä½œç”¨</p>
</blockquote>
<p>æä¾›ä¸€äº›ç¬¦å·å’Œå¸¸é‡ï¼Œä¾¿äºæŒ‡ä»¤çš„è¯†åˆ«ã€‚</p>
<h2 id="5-8-ğŸ”±-æ–¹æ³•çš„è°ƒç”¨ï¼šè§£æä¸åˆ†æ´¾"><a href="#5-8-ğŸ”±-æ–¹æ³•çš„è°ƒç”¨ï¼šè§£æä¸åˆ†æ´¾" class="headerlink" title="5.8 ğŸ”± æ–¹æ³•çš„è°ƒç”¨ï¼šè§£æä¸åˆ†æ´¾"></a>5.8 ğŸ”± æ–¹æ³•çš„è°ƒç”¨ï¼šè§£æä¸åˆ†æ´¾</h2><blockquote>
<p>ğŸ”— é“¾æ¥</p>
</blockquote>
<p>åœ¨JVMä¸­ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ä¸æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ç›¸å…³ã€‚</p>
<ul>
<li>é™æ€é“¾æ¥ï¼š</li>
</ul>
<p>å½“ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶è¢«è£…è½½è¿›JVMå†…éƒ¨æ—¶ï¼Œå¦‚æœè¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ã€‚è¿™ç§æƒ…å†µä¸‹å°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºé™æ€é“¾æ¥ã€‚</p>
<ul>
<li>åŠ¨æ€é“¾æ¥ï¼š</li>
</ul>
<p>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸå°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œç”±äºè¿™ç§å¼•ç”¨è½¬æ¢è¿‡ç¨‹å…·å¤‡åŠ¨æ€æ€§ï¼Œå› æ­¤ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºåŠ¨æ€é“¾æ¥ã€‚</p>
<blockquote>
<p>ğŸ— ç»‘å®š</p>
</blockquote>
<p>å¯¹åº”çš„æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ä¸ºï¼šæ—©æœŸç»‘å®šï¼ˆEarly Bindingï¼‰å’Œæ™šæœŸç»‘å®šï¼ˆLate Bindingï¼‰ã€‚ç»‘å®šæ˜¯ä¸€ä¸ªå­—æ®µã€æ–¹æ³•æˆ–è€…ç±»åœ¨ç¬¦å·å¼•ç”¨è¢«æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œè¿™ä»…ä»…å‘ç”Ÿä¸€æ¬¡ã€‚</p>
<ul>
<li>æ—©æœŸç»‘å®šï¼š</li>
</ul>
<p>æ—©æœŸç»‘å®šå°±æ˜¯æŒ‡è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•å¦‚æœåœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ï¼Œå³å¯å°†è¿™ä¸ªæ–¹æ³•ä¸æ‰€å±çš„ç±»å‹è¿›è¡Œç»‘å®šï¼Œè¿™æ ·ä¸€æ¥ï¼Œç”±äºæ˜ç¡®äº†è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥ä½¿ç”¨é™æ€é“¾æ¥çš„æ–¹å¼å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚</p>
<ul>
<li>æ™šæœŸç»‘å®šï¼š</li>
</ul>
<p>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸæ ¹æ®å®é™…çš„ç±»å‹ç»‘å®šç›¸å…³çš„æ–¹æ³•ï¼Œè¿™ç§ç»‘å®šæ–¹å¼ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºæ™šæœŸç»‘å®šã€‚</p>
<blockquote>
<p>ğŸ¹ æ‹“å±•</p>
</blockquote>
<p>éšç€é«˜çº§è¯­è¨€çš„æ¨ªè·¨å‡ºä¸–ï¼Œç±»ä¼¼äºJavaä¸€æ ·çš„åŸºäºé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€å¦‚ä»Šè¶Šæ¥è¶Šå¤šï¼Œå°½ç®¡è¿™ç±»ç¼–ç¨‹è¯­è¨€åœ¨è¯­æ³•é£æ ¼ä¸Šå­˜åœ¨ä¸€å®šçš„å·®åˆ«ï¼Œä½†æ˜¯å®ƒä»¬å½¼æ­¤ä¹‹é—´å§‹ç»ˆä¿æŒç€ä¸€ä¸ªå…±æ€§ï¼Œé‚£å°±æ˜¯éƒ½æ”¯æŒå°è£…ã€ç»§æ‰¿å’Œå¤šæ€ç­‰é¢å‘å¯¹è±¡ç‰¹æ€§ï¼Œæ—¢ç„¶è¿™ä¸€ç±»çš„ç¼–ç¨‹è¯­è¨€å…·å¤‡å¤šæ€ç‰¹æ€§ï¼Œé‚£ä¹ˆè‡ªç„¶ä¹Ÿå°±å…·å¤‡æ—©æœŸç»‘å®šå’Œæ™šæœŸç»‘å®šä¸¤åªç»‘å®šæ–¹å¼ã€‚</p>
<p>Javaä¸­ä»»ä½•ä¸€ä¸ªæ™®é€šçš„æ–¹æ³•å…¶å®éƒ½å…·å¤‡å‡½æ•°çš„ç‰¹å¾ï¼Œå®ƒä»¬ç›¸å½“äºC++è¯­è¨€ä¸­çš„è™šå‡½æ•°ï¼ˆC++ä¸­åˆ™éœ€è¦ä½¿ç”¨å…³é”®å­—virtualæ¥æ˜¾ç¤ºå®šä¹‰ï¼‰ã€‚å¦‚æœåœ¨Javaç¨‹åºä¸­ä¸å¸Œæœ›æŸä¸ªæ–¹æ³•æ‹¥æœ‰ è™šå‡½æ•°çš„ç‰¹å¾æ—¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å…³é”®å­—<code>final</code>æ¥æ ‡è®°è¿™ä¸ªæ–¹æ³•ã€‚</p>
<blockquote>
<p>ğŸŒ€ éè™šæ–¹æ³•</p>
</blockquote>
<p>å¦‚æœæ–¹æ³•åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šäº†å…·ä½“çš„è°ƒç”¨ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬åœ¨è¿è¡Œæ—¶æ˜¯ä¸å¯å˜çš„ï¼Œè¿™æ ·çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•ã€‚</p>
<ul>
<li>é™æ€æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€finalæ–¹æ³•ã€å®ä¾‹æ„é€ å™¨å’Œçˆ¶ç±»æ–¹æ³•éƒ½æ˜¯éè™šæ–¹æ³•ã€‚</li>
<li>å…¶ä»–æ–¹æ³•ç§°ä¸ºè™šæ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p> ğŸ“‘ æ–¹æ³•è°ƒç”¨æŒ‡ä»¤</p>
</blockquote>
<p>æ™®é€šè°ƒç”¨æŒ‡ä»¤ï¼š</p>
<ul>
<li><code>invokestatic</code>ï¼šè°ƒç”¨é™æ€æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬</li>
<li><code>invokespecial</code>: è°ƒç”¨<init>æ–¹æ³•ã€ç§æœ‰åŠçˆ¶ç±»æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬</li>
<li><code>invokevirtual</code>ï¼šè°ƒç”¨æ‰€æœ‰è™šæ–¹æ³•</li>
<li><code>invokeinterface</code>: è°ƒç”¨æ¥å£æ–¹æ³•</li>
</ul>
<p>åŠ¨æ€è°ƒç”¨æŒ‡ä»¤ï¼š</p>
<ul>
<li><code>invokedynamic</code>: åŠ¨æ€è§£æå‡ºéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œ</li>
</ul>
<p>æ™®é€šè°ƒç”¨æŒ‡ä»¤å›ºåŒ–åœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œæ–¹æ³•çš„è°ƒç”¨æ‰§è¡Œä¸å¯äººä¸ºå¹²é¢„ï¼Œè€Œ<code>invokedynamic</code>æŒ‡ä»¤åˆ™æ”¯æŒç”±ç”¨æˆ·ç¡®å®šæ–¹æ³•ç‰ˆæœ¬ï¼Œå…¶ä¸­<code>invokestatic</code>æŒ‡ä»¤å’Œ<code>invokespecial</code>æŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•ï¼Œå…¶ä½™çš„ï¼ˆfinalä¿®é¥°çš„é™¤å¤–ï¼‰ç§°ä¸ºè™šæ–¹æ³•ã€‚</p>
<blockquote>
<p>åŠ¨æ€ç±»å‹è¯­è¨€ ğŸ†š é™æ€ç±»å‹è¯­è¨€</p>
</blockquote>
<p>åŒºåˆ«ï¼šå¯¹ç±»å‹çš„æ£€æŸ¥æ˜¯åœ¨ç¼–è¯‘æœŸè¿˜æ˜¯åœ¨è¿è¡ŒæœŸï¼Œæ»¡è¶³å‰è€…å°±æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œåä¹‹å°±æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ã€‚</p>
<p>é™æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡è‡ªèº«çš„ç±»å‹ä¿¡æ¯ï¼›åŠ¨æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡å€¼çš„ç±»å‹ä¿¡æ¯ï¼Œå˜é‡æ²¡æœ‰ç±»å‹ä¿¡æ¯ï¼Œå˜é‡å€¼æ‰æœ‰ç±»å‹ä¿¡æ¯ï¼Œè¿™æ˜¯åŠ¨æ€è¯­è¨€çš„ä¸€ä¸ªé‡è¦ç‰¹å¾ã€‚</p>
<blockquote>
<p>ğŸ” æ–¹æ³•é‡å†™çš„æœ¬è´¨</p>
</blockquote>
<ol>
<li>æ‰¾åˆ°æ“ä½œæ•°æ ˆé¡¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ‰€æ‰§è¡Œçš„å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œè®°åšCã€‚</li>
<li>å¦‚æœåœ¨ç±»å‹Cä¸­æ‰¾åˆ°ä¸å¸¸é‡ä¸­çš„æè¿°ç¬¦åˆç®€å•åç§°éƒ½ç›¸ç¬¦çš„æ–¹æ³•ï¼Œåˆ™è¿›è¡Œè®¿é—®æƒé™æ ¡éªŒï¼Œå¦‚æœé€šè¿‡åˆ™è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç»“æŸï¼›å¦‚æœä¸é€šè¿‡ï¼Œåˆ™è¿”å›<code>java.lang.IllegalAccessError</code>å¼‚å¸¸ã€‚</li>
<li>å¦åˆ™ï¼ŒæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šä¾æ¬¡å¯¹Cçš„å„ä¸ªçˆ¶ç±»è¿›è¡Œç¬¬2æ­¥çš„æœç´¢å’ŒéªŒè¯è¿‡ç¨‹ã€‚</li>
<li>å¦‚æœå§‹ç»ˆæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ–¹æ³•ï¼Œåˆ™æŠ›å‡º<code>java.lang.AbstractMethodError</code>å¼‚å¸¸ã€‚</li>
</ol>
<p>ã€</p>
<blockquote>
<p>ğŸŸ¨ è™šæ–¹æ³•è¡¨</p>
</blockquote>
<ul>
<li>åœ¨é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ä¸­ï¼Œä¼šå¾ˆé¢‘ç¹çš„ä½¿ç”¨åˆ°åŠ¨æ€åˆ†æ´¾ï¼Œå¦‚æœåœ¨æ¯æ¬¡åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ä¸­éƒ½è¦é‡æ–°åœ¨ç±»çš„æ–¹æ³•å…ƒæ•°æ®ä¸­æœç´¢åˆé€‚çš„ç›®æ ‡çš„è¯å¯èƒ½å½±å“åˆ°æ‰§è¡Œæ•ˆç‡ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼ŒHVMé‡‡ç”¨åœ¨ç±»çš„æ–¹æ³•åŒºå»ºç«‹ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œä½¿ç”¨ç´¢å¼•è¡¨æ¥ä»£æ›¿æŸ¥æ‰¾ã€‚</li>
<li>æ¯ä¸ªç±»ä¸­éƒ½æœ‰ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œè¡¨ä¸­å­˜æ”¾ç€å„ä¸ªæ–¹æ³•çš„å®é™…å…¥å£ã€‚</li>
<li>è™šæ–¹æ³•è¡¨åˆ›å»ºçš„æ—¶é—´ï¼šè™šæ–¹æ³•è¡¨ä¼šåœ¨ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µè¢«åˆ›å»ºå¹¶å¼€å§‹åˆå§‹åŒ–ï¼Œç±»çš„å˜é‡åˆå§‹å€¼å‡†å¤‡å®Œæˆä¹‹åï¼ŒJVMä¼šæŠŠè¯¥ç±»çš„æ–¹æ³•è¡¨ä¹Ÿåˆå§‹åŒ–å®Œæ¯•ã€‚</li>
</ul>
<h2 id="5-9-â­•-æ–¹æ³•è¿”å›åœ°å€"><a href="#5-9-â­•-æ–¹æ³•è¿”å›åœ°å€" class="headerlink" title="5.9 â­• æ–¹æ³•è¿”å›åœ°å€"></a>5.9 â­• æ–¹æ³•è¿”å›åœ°å€</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>å­˜æ”¾è°ƒç”¨è¯¥æ–¹æ³•çš„PCå¯„å­˜å™¨çš„å€¼ã€‚</li>
<li>ä¸€ä¸ªæ–¹æ³•çš„ç»“æŸï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š<ul>
<li>æ­£å¸¸æ‰§è¡Œå®Œæˆ</li>
<li>å‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œéæ­£å¸¸é€€å‡º</li>
</ul>
</li>
<li>æ— è®ºé€šè¿‡å“ªç§æ–¹å¼é€€å‡ºï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½è¿”å›è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ã€‚æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„PCè®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚è€Œé€šè¿‡å¼‚å¸¸é€€å‡ºçš„ï¼Œè¿”å›åœ°å€æ˜¯è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®šï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’¨ é€€å‡º</p>
</blockquote>
<p>å½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œåï¼Œåªæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é€€å‡ºè¿™ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li><p>æ‰§è¡Œå¼•æ“é‡åˆ°ä»»æ„ä¸€ä¸ªæ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ï¼ˆreturnï¼‰ï¼Œä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™ä¸Šå±‚çš„æ–¹æ³•è°ƒç”¨è€…ï¼Œç®€ç§°æ­£å¸¸å®Œæˆå‡ºå£ã€‚</p>
<ul>
<li>ä¸€ä¸ªæ–¹æ³•åœ¨æ­£å¸¸è°ƒç”¨å®Œæˆä¹‹åç©¶ç«Ÿéœ€è¦ä½¿ç”¨å“ªä¸€ä¸ªè¿”å›æŒ‡ä»¤è¿˜éœ€è¦æ ¹æ®æ–¹æ³•çš„è¿”å›å€¼çš„å®é™…æ•°æ®ç±»å‹è€Œå®šã€‚</li>
<li>åœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­ï¼Œè¿”å›æŒ‡ä»¤åŒ…å«ireturnï¼ˆå½“è¿”å›å€¼æ˜¯booleanã€byteã€charã€shortå’Œintç±»å‹æ—¶ä½¿ç”¨ï¼‰ã€lreturnï¼ˆlongï¼‰ã€freturnï¼ˆfloatï¼‰ä»¥åŠareturnï¼ˆStringï¼‰ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªreturnæŒ‡ä»¤ä¾›å£°æ˜ä¸ºvoidçš„æ–¹æ³•ã€å®ä¾‹åˆå§‹åŒ–æ–¹æ³•ã€ç±»å’Œæ¥å£çš„åˆå§‹åŒ–æ–¹æ³•ä½¿ç”¨ã€‚</li>
</ul>
</li>
<li><p>åœ¨æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸ï¼ˆExceptionï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨æ–¹æ³•å†…è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯åªè¦åœ¨æœ¬æ–¹æ³•çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æœç´¢åˆ°åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œå°±ä¼šå¯¼è‡´æ–¹æ³•é€€å‡ºï¼Œç®€ç§°å¼‚å¸¸å®Œæˆå‡ºå£ã€‚</p>
<ul>
<li>æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶çš„å¼‚å¸¸å¤„ç†ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªå¼‚å¸¸å¤„ç†è¡¨ï¼Œæ–¹ä¾¿åœ¨å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æ‰¾åˆ°å¤„ç†å¼‚å¸¸çš„ä»£ç ã€‚</li>
</ul>
</li>
</ol>
<blockquote>
<p>ğŸ‘â€ğŸ—¨ æœ¬è´¨</p>
</blockquote>
<p>æœ¬è´¨ä¸Šï¼Œæ–¹æ³•çš„é€€å‡ºå°±æ˜¯å½“å‰å¸§å‡ºæ ˆçš„è¿‡ç¨‹ã€‚æ­¤æ—¶ï¼Œéœ€è¦æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å°†è¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆã€è®¾ç½®PCå¯„å­˜å™¨å€¼ç­‰ï¼Œè®©è°ƒç”¨è€…æ–¹æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</p>
<p>æ­£å¸¸å®Œæˆå‡ºå£å’Œå¼‚å¸¸å®Œæˆå‡ºå£çš„åŒºåˆ«åœ¨äºï¼šé€šè¿‡å¼‚å¸¸å®Œæˆå‡ºå£é€€å‡ºçš„ä¸ä¼šç»™ä»–çš„ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿä»»ä½•çš„è¿”å›å€¼ã€‚</p>
<h2 id="5-10-â•-é™„åŠ ä¿¡æ¯"><a href="#5-10-â•-é™„åŠ ä¿¡æ¯" class="headerlink" title="5.10 â• é™„åŠ ä¿¡æ¯"></a>5.10 â• é™„åŠ ä¿¡æ¯</h2><p>ä¸»è¦çœ‹è™šæ‹Ÿæœºçš„å®ç°ã€‚</p>
<p>æ ˆå¸§ä¸­è¿˜å…è®¸æºå¸¦ä¸Javaè™šæ‹Ÿæœºå®ç°ç›¸å…³çš„ä¸€äº›é™„åŠ ä¿¡æ¯ã€‚</p>
<p>ä¾‹å¦‚ï¼šå¯¹ç¨‹åºè°ƒè¯•æä¾›æ”¯æŒçš„ä¿¡æ¯ã€‚</p>
<h2 id="5-11-â“-ç›¸å…³é¢è¯•é¢˜"><a href="#5-11-â“-ç›¸å…³é¢è¯•é¢˜" class="headerlink" title="5.11 â“ ç›¸å…³é¢è¯•é¢˜"></a>5.11 â“ ç›¸å…³é¢è¯•é¢˜</h2><p>1ï¸âƒ£ ä¸¾ä¾‹æ ˆæº¢å‡ºçš„æƒ…å†µï¼ˆStackOverlowErrorï¼‰</p>
<p>é€šè¿‡-Xssè®¾ç½®æ ˆçš„å¤§å°ï¼šOOM</p>
<p>2ï¸âƒ£ è°ƒæ•´æ ˆå¤§å°ï¼Œå°±èƒ½ä¿è¯ä¸å‡ºç°æº¢å‡ºå—</p>
<p>ä¸èƒ½</p>
<p>3ï¸âƒ£ åˆ†é…çš„æ ˆå†…å­˜è¶Šå¤§è¶Šå¥½å—</p>
<p>ä¸æ˜¯</p>
<p>4ï¸âƒ£ åƒåœ¾å›æ”¶æ˜¯å¦ä¼šæ¶‰åŠåˆ°è™šæ‹Ÿæœºæ ˆ</p>
<p>ä¸ä¼š</p>
<p>5ï¸âƒ£ æ–¹æ³•ä¸­å®šä¹‰çš„å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨</p>
<p>å…·ä½“é—®é¢˜å…·ä½“åˆ†æ</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-7(å †)</title>
    <url>/posts/11581/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="7-1-ğŸ“š-æ¦‚è¿°"><a href="#7-1-ğŸ“š-æ¦‚è¿°" class="headerlink" title="7.1 ğŸ“š æ¦‚è¿°"></a>7.1 ğŸ“š æ¦‚è¿°</h2><blockquote>
<p>ğŸ“– å®šä¹‰</p>
</blockquote>
<p>æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½åº”å½“åœ¨è¿è¡Œæ—¶åˆ†é…åœ¨å †ä¸Šã€‚</p>
<blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>æ•°ç»„å’Œå¯¹è±¡å¯èƒ½æ°¸è¿œä¸ä¼šå­˜å‚¨åœ¨æ ˆä¸Šï¼Œå› ä¸ºæ ˆå¸§ä¸­ä¿å­˜å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æŒ‡å‘å¯¹è±¡æˆ–è€…æ•°ç»„åœ¨å †ä¸­çš„ä½ç½®ã€‚</li>
<li>åœ¨æ–¹æ³•ç»“æŸåï¼Œå †ä¸­çš„å¯¹è±¡ä¸ä¼šé©¬ä¸Šè¢«ç§»é™¤ï¼Œä»…ä»…åœ¨åƒåœ¾æ”¶é›†çš„æ—¶å€™æ‰ä¼šè¢«ç§»é™¤ã€‚</li>
<li>å †ï¼Œæ˜¯GCï¼ˆGarbage Collectionï¼Œåƒåœ¾æ”¶é›†å™¨ï¼‰æ‰§è¡Œåƒåœ¾å›æ”¶çš„é‡ç‚¹åŒºåŸŸã€‚</li>
<li>ä¸€ä¸ªJVMå®ä¾‹åªå­˜åœ¨ä¸€ä¸ªå †å†…å­˜ï¼Œå †ä¹Ÿæ˜¯Javaå†…å­˜ç®¡ç†çš„æ ¸å¿ƒåŒºåŸŸã€‚</li>
<li>Javaå †åŒºåœ¨JVMå¯åŠ¨çš„æ—¶å€™å³è¢«åˆ›å»ºï¼Œå…¶ç©ºé—´å¤§å°ä¹Ÿå°±ç¡®å®šäº†ï¼Œæ˜¯JVMç®¡ç†çš„æœ€å¤§ä¸€å—å†…å­˜ç©ºé—´ï¼ˆå †å†…å­˜çš„å¤§å°æ˜¯å¯ä»¥è°ƒèŠ‚çš„ï¼‰ã€‚</li>
<li>å †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œä½†åœ¨é€»è¾‘ä¸Šå®ƒåº”è¯¥è¢«è§†ä¸ºè¿ç»­çš„ã€‚</li>
<li>æ‰€æœ‰çš„çº¿ç¨‹å…±äº«Javaå †ï¼Œåœ¨è¿™é‡Œè¿˜å¯ä»¥åˆ’åˆ†çº¿ç¨‹ç§æœ‰çš„ç¼“å†²åŒºï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰ã€‚</li>
</ul>
<blockquote>
<p>âœ‚ï¸ å†…å­˜ç»†åˆ†</p>
</blockquote>
<p><strong>ç°ä»£åƒåœ¾æ”¶é›†å™¨å¤§éƒ¨åˆ†éƒ½åŸºäºåˆ†ä»£æ”¶é›†ç†è®ºè®¾è®¡</strong></p>
<p>Java 7åŠä¹‹å‰ï¼š</p>
<table>
<thead>
<tr>
<th>ä¸­æ–‡</th>
<th>æ´‹æ–‡</th>
<th>ç®€ç§°</th>
</tr>
</thead>
<tbody><tr>
<td>æ–°ç”ŸåŒº</td>
<td>Young Generation Sapce</td>
<td>Young (Eden + Survivor)</td>
</tr>
<tr>
<td>å…»è€åŒº</td>
<td>Tenure Generation Space</td>
<td>Old</td>
</tr>
<tr>
<td>æ°¸ä¹…åŒº</td>
<td>Permanent Space</td>
<td>Perm</td>
</tr>
</tbody></table>
<p>Java 8åŠä¹‹å</p>
<table>
<thead>
<tr>
<th>ä¸­æ–‡</th>
<th>æ´‹æ–‡</th>
<th>ç®€ç§°</th>
</tr>
</thead>
<tbody><tr>
<td>æ–°ç”ŸåŒº</td>
<td>Young Generation Sapce</td>
<td>Young (Eden + Survivor)</td>
</tr>
<tr>
<td>å…»è€åŒº</td>
<td>Tenure Generation Space</td>
<td>Old</td>
</tr>
<tr>
<td>å…ƒç©ºé—´</td>
<td>Meta Space</td>
<td>Meta</td>
</tr>
</tbody></table>
<p>çº¦å®šï¼šæ–°ç”ŸåŒºâ†”ï¸æ–°ç”Ÿä»£â†”ï¸å¹´è½»ä»£  å…»è€åŒºâ†”ï¸è€å¹´åŒºâ†”ï¸è€å¹´ä»£  æ°¸ä¹…åŒºâ†”ï¸æ°¸ä¹…ä»£</p>
<h2 id="7-2-âš™ï¸-è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM"><a href="#7-2-âš™ï¸-è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM" class="headerlink" title="7.2 âš™ï¸ è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM"></a>7.2 âš™ï¸ è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>Javaå †åŒºç”¨äºå­˜å‚¨Javaå¯¹è±¡å®ä¾‹ï¼Œé‚£ä¹ˆå †çš„å¤§å°åœ¨JVMå¯åŠ¨æ—¶å°±å·²ç»è®¾å®šå¥½äº†ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡é€‰é¡¹<code>-Xms</code>å’Œ<code>-Xms</code>æ¥è¿›è¡Œè®¾ç½®ã€‚<ul>
<li><code>-Xms</code>ï¼šç”¨äºè¡¨ç¤ºå †åŒºçš„èµ·å§‹å†…å­˜ï¼Œç­‰ä»·äº<code>-XX:InitialHeapSize</code></li>
<li><code>-Xmx</code>ï¼šç”¨äºè¡¨ç¤ºå †åŒºçš„æœ€å¤§å†…å­˜ï¼Œç­‰ä»·äº<code>-XX:MaxHeapSize</code></li>
</ul>
</li>
<li>ä¸€æ—¦å †åŒºä¸­çš„å†…å­˜å¤§å°è¶…è¿‡<code>-Xmx</code>æ‰€æŒ‡å®šçš„æœ€å¤§å†…å­˜æ—¶ï¼Œå°†ä¼šæŠ›å‡º<code>OutOfMemoryError</code>å¼‚å¸¸ã€‚</li>
<li>é€šå¸¸ä¼šå°†<code>-Xms</code>å’Œ<code>-Xmx</code>ä¸¤ä¸ªå‚æ•°é…ç½®ç›¸åŒçš„å€¼ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨Javaåƒåœ¾å›æ”¶æœºåˆ¶æ¸…ç†å®Œå †åŒºåä¸éœ€è¦é‡æ–°åˆ†éš”è®¡ç®—å †åŒºçš„å¤§å°ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹<ul>
<li>åˆå§‹å†…å­˜å¤§å° = ç‰©ç†ç”µè„‘å†…å­˜å¤§å° / 64</li>
<li>æœ€å¤§å†…å­˜å¤§å° = ç‰©ç†ç”µè„‘å†…å­˜å¤§å° / 4</li>
</ul>
</li>
<li>æŸ¥çœ‹è®¾ç½®å‚æ•°<ul>
<li>æ–¹å¼ä¸€ï¼š<code>jps</code>  +  <code>jstat -gc &lt;è¿›ç¨‹ID&gt;</code></li>
<li>æ–¹å¼äºŒï¼š<code>-XX:PrintGCDetails</code></li>
</ul>
</li>
</ul>
<h2 id="7-3-ğŸ§šâ€â™‚ï¸-å¹´è½»ä»£ä¸è€å¹´ä»£"><a href="#7-3-ğŸ§šâ€â™‚ï¸-å¹´è½»ä»£ä¸è€å¹´ä»£" class="headerlink" title="7.3 ğŸ§šâ€â™‚ï¸ å¹´è½»ä»£ä¸è€å¹´ä»£"></a>7.3 ğŸ§šâ€â™‚ï¸ å¹´è½»ä»£ä¸è€å¹´ä»£</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>å­˜å‚¨åœ¨JVMä¸­çš„Javaå¯¹è±¡å¯ä»¥è¢«åˆ’åˆ†ä¸ºä¸¤ç±»ï¼š<ul>
<li>ä¸€ç±»æ˜¯ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ç¬æ—¶å¯¹è±¡ï¼Œè¿™ç±»å¯¹è±¡çš„åˆ›å»ºå’Œæ¶ˆäº¡éƒ½éå¸¸è¿…é€Ÿã€‚</li>
<li>å¦å¤–ä¸€ç±»å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå´éå¸¸é•¿ï¼Œåœ¨æŸäº›æç«¯çš„æƒ…å†µä¸‹è¿˜èƒ½å¤Ÿä¸JVMçš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ã€‚</li>
</ul>
</li>
<li>Javaå †åŒºè¿›ä¸€æ­¥ç»†åˆ†çš„è¯ï¼Œå¯ä»¥åˆ’åˆ†ä¸ºå¹´è½»ä»£ï¼ˆYoungGenï¼‰å’Œè€å¹´ä»£ï¼ˆOldGenï¼‰ã€‚</li>
<li>å…¶ä¸­å¹´è½»ä»£åˆå¯ä»¥åˆ’åˆ†ä¸ºEdenç©ºé—´ã€Survior0ç©ºé—´å’ŒSurvivor1ç©ºé—´ï¼ˆæœ‰æ—¶ä¹Ÿå«åšfromåŒºã€toåŒºï¼‰ã€‚</li>
<li>åœ¨HotSpotä¸­ï¼ŒEdenåŒºå’Œå¦å¤–ä¸¤ä¸ªSurvivorç©ºé—´ç¼ºçœæ¯”ä¾‹æ˜¯8:1:1ã€‚</li>
<li>å‡ ä¹æ‰€æœ‰çš„Javaå¯¹è±¡éƒ½æ˜¯åœ¨EdenåŒºè¢«newå‡ºæ¥çš„ï¼Œç»å¤§éƒ¨åˆ†çš„Javaå¯¹è±¡çš„é”€æ¯éƒ½åœ¨æ–°ç”Ÿä»£è¿›è¡Œäº†ã€‚IBMå…¬å¸çš„ä¸“é—¨ç ”ç©¶è¡¨æ˜ï¼Œæ–°ç”Ÿä»£ä¸­80%çš„å¯¹è±¡éƒ½æ˜¯æœç”Ÿå¤•æ­»çš„ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“· å›¾ç¤º</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/%E5%A0%86.svg" class="" title="å †"><br />



<blockquote>
<p>ğŸ’  é…ç½®</p>
</blockquote>
<p>é…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”ã€‚</p>
<ul>
<li><p><code>-Xmn</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£æœ€å¤§å†…å­˜å¤§å°</p>
</li>
<li><p><code>-XX:NewRatio=x</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£å æ•´ä¸ªå †çš„1/(x+1)ï¼Œè€å¹´ä»£å æ•´ä¸ªå †çš„x/(x+1)ã€‚ï¼ˆé»˜è®¤å€¼æ˜¯2ï¼‰</p>
</li>
<li><p><code>-XX:SurvivorRatio</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£ä¸­EdenåŒºä¸SurvivoråŒºçš„æ¯”ä¾‹ã€‚ï¼ˆé»˜è®¤å€¼æ˜¯8ï¼‰</p>
</li>
<li><p><code>-XX:UseAdaptiveSizePolicy</code>ï¼šå…³é—­è‡ªé€‚åº”çš„å†…å­˜åˆ†é…ç­–ç•¥ã€‚ï¼ˆæš‚æ—¶ç”¨ä¸åˆ°ï¼‰</p>
</li>
</ul>
<h2 id="7-4-ğŸ“·-å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹"><a href="#7-4-ğŸ“·-å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹" class="headerlink" title="7.4 ğŸ“· å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹"></a>7.4 ğŸ“· å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹</h2><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<p>ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜æ˜¯ä¸€ä»¶éå¸¸ä¸¥è°¨å’Œå¤æ‚çš„ä»»åŠ¡ã€‚JVMçš„è®¾è®¡è€…ä»¬ä¸ä»…éœ€è¦è€ƒè™‘å†…å­˜å¦‚ä½•åˆ†é…ã€åœ¨å“ªé‡Œåˆ†é…ç­‰é—®é¢˜ï¼Œå¹¶ä¸”ç”±äºå†…å­˜åˆ†é…ç®—æ³•ä¸å†…å­˜å›æ”¶ç®—æ³•å¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥è¿˜éœ€è¦è€ƒè™‘GCæ‰§è¡Œå®Œå†…å­˜å›æ”¶åæ˜¯å¦ä¼šåœ¨å†…å­˜ç©ºé—´ä¸­äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</p>
<blockquote>
<p>â³ è¿‡ç¨‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/image-20210206235400990.png" class="" title="image-20210206235400990"><br />

<ol>
<li>newçš„å¯¹è±¡å…ˆæ”¾åœ¨ä¼Šç”¸å›­åŒºï¼Œæ­¤åŒºæœ‰å¤§å°é™åˆ¶ã€‚</li>
<li>å½“ä¼Šç”¸å›­åŒºçš„ç©ºé—´å¡«æ»¡æ—¶ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVMçš„åƒåœ¾å›æ”¶å™¨å°†å¯¹ä¼Šç”¸å›­è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå°†ä¼Šç”¸å›­åŒºä¸­çš„ä¸å†è¢«å…¶ä»–å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚å†åŠ è½½æ–°çš„å¯¹è±¡æ”¾åˆ°ä¼Šç”¸å›­åŒºã€‚</li>
<li>ç„¶åå°†ä¼Šç”¸å›­åŒºçš„å‰©ä½™å¯¹è±¡ç§»åŠ¨åˆ°å¹¸å­˜è€…0åŒºã€‚</li>
<li>å¦‚æœå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¸Šæ¬¡å¹¸å­˜ä¸‹æ¥çš„æ”¾åˆ°å¹¸å­˜è€…0åŒºï¼Œå¦‚æœæ²¡æœ‰å›æ”¶ï¼Œå°±ä¼šæ”¾åˆ°å¹¸å­˜è€…1åŒºã€‚</li>
<li>å¦‚æœå†æ¬¡ç»å†åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¼šé‡æ–°æ”¾å›å¹¸å­˜è€…0åŒºï¼Œæ¥ç€å†å»å¹¸å­˜è€…1åŒºã€‚</li>
<li>è‡³äºå•¥æ—¶å€™å»å…»è€åŒºï¼Œå¯ä»¥è®¾ç½®æ¬¡æ•°ã€‚é»˜è®¤æ˜¯15æ¬¡ã€‚</li>
<li>åœ¨å…»è€åŒºï¼Œç›¸å¯¹æ‚ é—²ã€‚å½“å…»è€åŒºå†…å­˜ä¸è¶³æ—¶ï¼Œå†æ¬¡è§¦å‘GC: Major GCï¼Œè¿›è¡Œå…»è€åŒºçš„å†…å­˜æ¸…ç†ã€‚</li>
<li>è‹¥å…»è€åŒºæ‰§è¡Œäº†Major GCä¹‹åå‘ç°ä¾ç„¶æ— æ³•è¿›è¡Œå¯¹è±¡çš„ä¿å­˜ï¼Œå°±ä¼šäº§ç”ŸOOMå¼‚å¸¸ã€‚</li>
</ol>
<blockquote>
<p>ğŸ”¬ å›¾è§£</p>
</blockquote>
<p>æˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡ï¼Œä¸€èˆ¬éƒ½æ˜¯å­˜æ”¾åœ¨EdenåŒºçš„ï¼Œå½“æˆ‘ä»¬EdenåŒºæ»¡äº†åï¼Œå°±ä¼šè§¦å‘GCæ“ä½œï¼Œä¸€èˆ¬è¢«ç§°ä¸º YGC / Minor GC æ“ä½œã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/image-20210206235609719.png" class="" title="image-20210206235609719"><br />

<p>å½“æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†åï¼Œçº¢è‰²çš„å°†ä¼šè¢«å›æ”¶ï¼Œè€Œç»¿è‰²çš„è¿˜ä¼šè¢«å ç”¨ç€ï¼Œå­˜æ”¾åœ¨S0(Survivor From)åŒºã€‚åŒæ—¶æˆ‘ä»¬ç»™æ¯ä¸ªå¯¹è±¡è®¾ç½®äº†ä¸€ä¸ªå¹´é¾„è®¡æ•°å™¨ï¼Œä¸€æ¬¡å›æ”¶åå°±æ˜¯1ã€‚</p>
<p>åŒæ—¶EdenåŒºç»§ç»­å­˜æ”¾å¯¹è±¡ï¼Œå½“EdenåŒºå†æ¬¡å­˜æ»¡çš„æ—¶å€™ï¼Œåˆä¼šè§¦å‘ä¸€ä¸ªMinor GCæ“ä½œï¼Œæ­¤æ—¶GCå°†ä¼šæŠŠEdenå’ŒS0(Survivor From)ä¸­çš„å¯¹è±¡è¿›è¡Œä¸€æ¬¡æ”¶é›†ï¼ŒæŠŠå­˜æ´»çš„å¯¹è±¡æ”¾åˆ° S1(Survivor To)AåŒºï¼ŒåŒæ—¶è®©å¹´é¾„ + 1ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/image-20210206235625078.png" class="" title="image-20210206235625078"><br />

<p>æˆ‘ä»¬ç»§ç»­ä¸æ–­çš„è¿›è¡Œå¯¹è±¡ç”Ÿæˆå’Œåƒåœ¾å›æ”¶ï¼Œå½“Survivorä¸­çš„å¯¹è±¡çš„å¹´é¾„è¾¾åˆ°15çš„æ—¶å€™ï¼Œå°†ä¼šè§¦å‘ä¸€æ¬¡ Promotionæ™‹å‡çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯å°†å¹´è½»ä»£ä¸­çš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/image-20210206235645912.png" class="" title="image-20210206235645912"><br />



<blockquote>
<p>â“ æ€è€ƒ</p>
</blockquote>
<p>å½“ä¼Šç”¸å›­åŒºæ»¡äº†ä¹‹åä¼šè§¦å‘Minor GCï¼Œé‚£ä¹ˆå¹¸å­˜è€…åŒºæ»¡äº†ä¹‹åä¼šè§¦å‘Minor GCå—ï¼Ÿ</p>
<p>è§£æï¼š</p>
<p>å¹¸å­˜è€…åŒºæ»¡äº†ä¹‹åä¸ä¼šè§¦å‘Minor GCï¼Œä½†æ˜¯ä¼šè§¦å‘ä¸€äº›ç‰¹æ®Šçš„è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½ç›´æ¥æ™‹å‡è€å¹´ä»£ã€‚</p>
<p>å¹´é¾„å°äº15ç”šè‡³æ–°çš„å¯¹è±¡éƒ½å¯èƒ½ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚</p>
<blockquote>
<p>ğŸŒˆ æ€»ç»“</p>
</blockquote>
<ul>
<li>é’ˆå¯¹å¹¸å­˜è€…S0å’ŒS1åŒºï¼šå¤åˆ¶ä¹‹åæœ‰äº¤æ¢ï¼Œè°ç©ºè°æ˜¯to</li>
<li>å…³äºåƒåœ¾å›æ”¶ï¼šé¢‘ç¹åœ¨æ–°ç”ŸåŒºæ”¶é›†ï¼Œå¾ˆå°‘åœ¨å…»è€åŒºæ”¶é›†ï¼Œå‡ ä¹ä¸åœ¨æ°¸ä¹…åŒº/å…ƒç©ºé—´æ”¶é›†ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“Š ç‰¹æ®Šæƒ…å†µ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/image-20200707091058346.png" class="" title="image-20200707091058346"><br />



<blockquote>
<p>âŒ¨ï¸ ç¤ºä¾‹</p>
</blockquote>
<p>ä¸æ–­åˆ›å»ºå¤§å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeapInstanceTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span> * <span class="number">3000</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;HeapInstanceTest&gt; list = <span class="keyword">new</span> ArrayList&lt;HeapInstanceTest&gt;();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> HeapInstanceTest());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IDEA Configurationè®¾ç½®JVMå‚æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-Xms600m -Xmx600m</span><br></pre></td></tr></table></figure>

<p>CMDè¾“å…¥æŒ‡ä»¤ï¼Œæ‰“å¼€VisualVMï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">jvisualvm</span><br></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/HeapInstanceTest.gif" class="" title="HeapInstanceTest"><br />

<p>æœ€ç»ˆè€å¹´ä»£å’Œæ–°ç”Ÿä»£éƒ½æ»¡äº†ï¼Œå‡ºç°OOM</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.OutOfMemoryError: Java heap space</span><br><span class="line">	at top.parak.HeapInstanceTest.&lt;init&gt;(HeapInstanceTest.java:<span class="number">18</span>)</span><br><span class="line">	at top.parak.HeapInstanceTest.main(HeapInstanceTest.java:<span class="number">23</span>)</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ğŸ”§ è°ƒä¼˜å·¥å…·</p>
</blockquote>
<ul>
<li>JDKå‘½ä»¤è¡Œ</li>
<li>Eclipseï¼šMemory Analyzer Tool</li>
<li>Jconsole</li>
<li>Visual VMï¼ˆå®æ—¶ç›‘æ§ æ¨èï¼‰</li>
<li>Jprofilerï¼ˆæ¨èï¼‰</li>
<li>Java Flight Recorderï¼ˆå®æ—¶ç›‘æ§ï¼‰</li>
<li>GCViewer</li>
<li>GCEasy</li>
</ul>
<h2 id="7-5-â™»-Minor-GCã€Major-GCã€Full-GC"><a href="#7-5-â™»-Minor-GCã€Major-GCã€Full-GC" class="headerlink" title="7.5 â™» Minor GCã€Major GCã€Full GC"></a>7.5 â™» Minor GCã€Major GCã€Full GC</h2><blockquote>
<p>ğŸ“– æ¦‚è¿°</p>
</blockquote>
<p>JVMåœ¨è¿›è¡ŒGCæ—¶ï¼Œå¹¶éæ¯æ¬¡éƒ½å¯¹ä¸‰ä¸ªå†…å­˜åŒºåŸŸï¼ˆæ–°ç”Ÿä»£ã€è€å¹´ä»£ã€æ–¹æ³•åŒºï¼‰ä¸€èµ·å›æ”¶çš„ï¼Œå¤§éƒ¨åˆ†æ—¶å€™å›æ”¶çš„éƒ½æ˜¯æŒ‡æ–°ç”Ÿä»£ã€‚é’ˆå¯¹HotSpot VMçš„å®ç°ï¼Œå®ƒé‡Œé¢çš„GCæŒ‰ç…§å›æ”¶åŒºåŸŸåˆåˆ†ä¸ºä¸¤å¤§ç§ç±»å‹</p>
<ul>
<li>éƒ¨åˆ†æ”¶é›†<ul>
<li>Minor GC(Young GC): æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†</li>
<li>Major GC(Old GC): è€å¹´ä»£çš„åƒåœ¾æ”¶é›†<ul>
<li>ç›®å‰ï¼Œåªæœ‰CMS GCä¼šæœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸º</li>
<li>æ³¨æ„ï¼Œå¾ˆå¤šæ—¶å€™Major GCä¼šå’ŒFull GCæ··æ·†ä½¿ç”¨ï¼Œéœ€è¦å…·ä½“åˆ†è¾¨æ˜¯è€å¹´ä»£å›æ”¶è¿˜æ˜¯æ•´å †å›æ”¶</li>
</ul>
</li>
<li>Mixed GC: æ··åˆæ”¶é›†ï¼Œæ•´ä¸ªæ–°ç”Ÿä»£ä»¥åŠéƒ¨åˆ†è€å¹´ä»£çš„åƒåœ¾</li>
</ul>
</li>
<li>æ•´å †æ”¶é›†(Full GC): æ”¶é›†æ•´ä¸ªJavaå †å’Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†</li>
</ul>
<blockquote>
<p>ğŸ”† è§¦å‘æœºåˆ¶</p>
</blockquote>
<p>1ï¸âƒ£ Minor GC</p>
<ul>
<li>å½“å¹´è½»ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œå°±ä¼šè§¦å‘Minor GCï¼Œè¿™é‡Œçš„å¹´è½»ä»£æ»¡æŒ‡çš„æ˜¯Edenä»£æ»¡ï¼ŒSurvivoræ»¡ä¸ä¼šå¼•å‘GCã€‚</li>
<li>å› ä¸ºJavaå¯¹è±¡å¤§å¤šéƒ½å…·å¤‡æœç”Ÿå¤•ç­çš„ç‰¹æ€§ï¼Œæ‰€ä»¥Minor GCéå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚</li>
<li>Minor GCä¼šå¼•å‘STWï¼Œæš‚åœå…¶ä»–çš„ç”¨æˆ·çš„çº¿ç¨‹ï¼Œç­‰åƒåœ¾å›æ”¶ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¢å¤è¿è¡Œã€‚</li>
</ul>
<p>2ï¸âƒ£ Major GC / Full GC</p>
<ul>
<li>å¯¹è±¡ä»è€å¹´ä»£æ¶ˆå¤±ï¼Œæˆ‘ä»¬è¯´â€Major GCâ€æˆ–â€Full GCâ€å‘ç”Ÿäº†ã€‚</li>
<li>å‡ºç°äº†â€Major GCâ€ï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„Minor GCï¼ˆä½†éç»å¯¹çš„ï¼Œåœ¨Parallel Scavengeæ”¶é›†å™¨çš„æ”¶é›†ç­–ç•¥é‡Œå°±æœ‰ç›´æ¥è¿›è¡Œçš„Major GCçš„ç­–ç•¥é€‰æ‹©è¿‡ç¨‹ï¼‰ã€‚å³åœ¨è€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šå°è¯•è§¦å‘Minor GCï¼›å¦‚æœä¹‹åç©ºé—´è¿˜ä¸è¶³ï¼Œåˆ™è§¦å‘Major GCã€‚</li>
<li>Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10å€ä»¥ä¸Šï¼ŒSTWçš„æ—¶é—´æ›´é•¿ã€‚</li>
<li>å¦‚æœMajor GCåï¼Œå†…å­˜è¿˜ä¸è¶³ï¼Œå°±æŠ¥OOMäº†ã€‚</li>
<li>Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10å€ä»¥ä¸Šã€‚</li>
</ul>
<p>3ï¸âƒ£ Full GCè§¦å‘æœºåˆ¶</p>
<ol>
<li>è°ƒç”¨<code>System.gc()</code>æ—¶ï¼Œç³»ç»Ÿå»ºè®®æ‰§è¡ŒFull GCï¼Œä½†æ˜¯ä¸å¿…ç„¶æ‰§è¡Œ</li>
<li>è€å¹´ä»£ç©ºé—´ä¸è¶³</li>
<li>æ–¹æ³•åŒºç©ºé—´ä¸è¶³</li>
<li>é€šè¿‡Minor GCåè¿›å…¥è€å¹´ä»£çš„å¹³å‡å¤§å°å¤§äºè€å¹´ä»£çš„å¯ç”¨å†…å­˜</li>
<li>ç”±EdenåŒºã€Survivor Space 0 (From Space)åŒºå‘Survivor Space 1 (To Space)åŒºå¤åˆ¶æ—¶ï¼Œå¯¹è±¡å¤§å°å¤§äºTo Spaceå¯ç”¨å†…å­˜ï¼Œåˆ™æŠŠè¯¥å¯¹è±¡è½¬å­˜åˆ°è€å¹´ä»£ï¼Œåˆ‡è€å¹´ä»£çš„å¯ç”¨å†…å­˜å°äºè¯¥å¯¹è±¡å¤§å°</li>
</ol>
<p>è¯´æ˜ï¼šFull GCæ˜¯å¼€å‘æˆ–è°ƒä¼˜ä¸­å°½é‡è¦é¿å…çš„ã€‚</p>
<h2 id="7-6-ğŸ§ -å †ç©ºé—´åˆ†ä»£æ€æƒ³"><a href="#7-6-ğŸ§ -å †ç©ºé—´åˆ†ä»£æ€æƒ³" class="headerlink" title="7.6 ğŸ§  å †ç©ºé—´åˆ†ä»£æ€æƒ³"></a>7.6 ğŸ§  å †ç©ºé—´åˆ†ä»£æ€æƒ³</h2><blockquote>
<p>ğŸ”¸ åˆ†ä»£åŸå› </p>
</blockquote>
<p>å…¶å®ä¸åˆ†ä»£å®Œå…¨å¯ä»¥ï¼Œåˆ†ä»£çš„å”¯ä¸€ç†ç”±å°±æ˜¯ä¼˜åŒ–GCæ€§èƒ½ã€‚å¦‚æœæ²¡æœ‰åˆ†ä»£ï¼Œé‚£æ‰€æœ‰çš„å¯¹è±¡éƒ½åœ¨ä¸€å—ï¼Œå°±å¦‚åŒæŠŠä¸€ä¸ªå­¦æ ¡çš„äººéƒ½å…³åœ¨ä¸€ä¸ªæ•™å®¤ã€‚GCçš„æ—¶å€™è¦æ‰¾åˆ°å“ªäº›å¯¹è±¡æ²¡ç”¨ï¼Œè¿™æ ·å°±ä¼šå¯¹å †çš„æ‰€æœ‰åŒºåŸŸè¿›è¡Œæ‰«æã€‚è€Œå¾ˆå¤šå¯¹è±¡æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œå¦‚æœåˆ†ä»£çš„è¯ï¼ŒæŠŠæ–°åˆ›å»ºçš„å¯¹è±¡æ”¾åœ¨æŸä¸€åœ°æ–¹ï¼Œå½“GCçš„æ—¶å€™å…ˆæŠŠè¿™å—å­˜å‚¨â€œæœç”Ÿå¤•æ­»â€å¯¹è±¡çš„åŒºåŸŸè¿›è¡Œå›æ”¶ï¼Œè¿™æ ·å°±ä¼šè…¾å‡ºå¾ˆå¤§çš„ç©ºé—´æ¥ã€‚</p>
<h2 id="7-7-ğŸ”°-å†…å­˜åˆ†é…ç­–ç•¥"><a href="#7-7-ğŸ”°-å†…å­˜åˆ†é…ç­–ç•¥" class="headerlink" title="7.7 ğŸ”° å†…å­˜åˆ†é…ç­–ç•¥"></a>7.7 ğŸ”° å†…å­˜åˆ†é…ç­–ç•¥</h2><blockquote>
<p>ğŸ“‹ æ€»ç»“</p>
</blockquote>
<p>å¦‚æœå¯¹è±¡åœ¨Edenå‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡Minor GCåä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢«Survivorå®¹çº³çš„è¯ï¼Œå°†è¢«ç§»åŠ¨åˆ°Survivorç©ºé—´ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º1ã€‚å¯¹è±¡åœ¨SurvivoråŒºä¸­æ¯ç†¬è¿‡ä¸€æ¬¡Minor GCï¼Œå¹´é¾„å°±å¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤5å²ï¼Œå…¶å®æ¯ä¸ªJVMã€æ¯ä¸ªGCéƒ½æœ‰æ‰€ä¸åŒï¼‰æ—¶ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚</p>
<p>å¯¹è±¡æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡é€‰é¡¹<code>-XX:MaxTenuringThreshold</code>æ¥è®¾ç½®ã€‚</p>
<blockquote>
<p>ğŸŒ€ åŸåˆ™</p>
</blockquote>
<ul>
<li>ä¼˜å…ˆåˆ†é…åˆ°Eden</li>
<li>å¤§å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£<ul>
<li>å°½é‡é¿å…ç¨‹åºä¸­é•¿æœŸå­˜æ´»çš„å¯¹è±¡åˆ†é…åˆ°è€å¹´ä»£å‡ºç°è¿‡å¤šçš„å¤§å¯¹è±¡</li>
</ul>
</li>
<li>åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤æ–­<ul>
<li>å¦‚æœSurvivoråŒºä¸­ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€èˆ¬ï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œæ— é¡»ç­‰åˆ°MaxTenuringThresholdä¸­è¦æ±‚çš„å¹´é¾„ã€‚</li>
</ul>
</li>
<li>ç©ºé—´åˆ†é…æ‹…ä¿<ul>
<li>-XX:HandlePromotionFailure</li>
</ul>
</li>
</ul>
<h2 id="7-8-ğŸŒŒ-ä¸ºå¯¹è±¡åˆ†é…å†…å­˜"><a href="#7-8-ğŸŒŒ-ä¸ºå¯¹è±¡åˆ†é…å†…å­˜" class="headerlink" title="7.8 ğŸŒŒ ä¸ºå¯¹è±¡åˆ†é…å†…å­˜"></a>7.8 ğŸŒŒ ä¸ºå¯¹è±¡åˆ†é…å†…å­˜</h2><blockquote>
<p>â˜ª å‡ºç°èƒŒæ™¯</p>
</blockquote>
<ul>
<li>å †åŒºæ˜¯çº¿ç¨‹å…±äº«åŒºåŸŸï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®åˆ°å †åŒºä¸­çš„å…±äº«æ•°æ®</li>
<li>ç”±äºå¯¹è±¡å®ä¾‹çš„åˆ›å»ºåœ¨JVMä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä»å †åŒºåˆ’åˆ†å†…å­˜ç©ºé—´æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</li>
<li>ä¸ºé¿å…å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€åœ°å€ï¼Œéœ€è¦ä½¿ç”¨åŠ é”ç­‰æœºåˆ¶ï¼Œè¿›è€Œå½±å“åˆ†é…é€Ÿåº¦</li>
</ul>
<blockquote>
<p>ğŸ’« TLAB(Thread Local Allocation Buffer)</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/image-20210211230044163.png" class="" title="image-20210211230044163"><br />

<ul>
<li>ä»å†…å­˜æ¨¡å‹è€Œä¸æ˜¯åƒåœ¾æ”¶é›†çš„è§’åº¦ï¼Œå¯¹EdenåŒºåŸŸç»§ç»­è¿›è¡Œåˆ’åˆ†ï¼ŒJVMä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œå®ƒåŒ…å«åœ¨Edenç©ºé—´å†…ã€‚</li>
<li>å¤šçº¿ç¨‹åŒæ—¶åˆ†é…å†…å­˜æ—¶ï¼Œä½¿ç”¨TLABå¯ä»¥é¿å…ä¸€ç³»åˆ—çš„éçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿæå‡å†…å­˜åˆ†é…çš„ååé‡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¿™ç§å†…å­˜åˆ†é…æ–¹å¼ç§°ä¹‹ä¸ºå¿«é€Ÿåˆ†é…ç­–ç•¥ã€‚</li>
</ul>
<blockquote>
<p>â³ åˆ†é…è¿‡ç¨‹</p>
</blockquote>
<p>å¯¹è±¡é¦–å…ˆæ˜¯é€šè¿‡TLABå¼€è¾Ÿç©ºé—´ï¼Œå¦‚æœä¸èƒ½æ”¾å…¥ï¼Œé‚£ä¹ˆéœ€è¦é€šè¿‡Edenæ¥è¿›è¡Œåˆ†é…ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/image-20210211225613422.png" class="" title="image-20210211225613422"><br />



<blockquote>
<p>ğŸ’¬ å†è¯´æ˜</p>
</blockquote>
<ul>
<li>å°½ç®¡ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½èƒ½å¤Ÿåœ¨TLABä¸­åˆ†é…å†…å­˜ï¼Œä½†JVMç¡®å®æ—¶å°†TLABä½œä¸ºå†…å­˜åˆ†é…çš„é¦–é€‰ã€‚</li>
<li>åœ¨ç¨‹åºä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰æ‹©<code>-XX:UseTLAB</code>è®¾ç½®æ˜¯å¦å¼€å¯TLABç©ºé—´ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒTLABç©ºé—´çš„å†…å­˜éå¸¸å°ï¼Œä»…å æœ‰æ•´ä¸ªEdenç©ºé—´çš„1%ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡é€‰å‹â€-XX:TLABWasteTargetPercentâ€è®¾ç½®TLABç©ºé—´æ‰€å Edenç©ºé—´çš„ç™¾åˆ†æ¯”å¤§å°ã€‚</li>
<li>ä¸€æ—¦å¯¹è±¡åœ¨TLABç©ºé—´åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼ŒJVMå°±ä¼šå°è¯•ç€é€šè¿‡åŠ é”æœºåˆ¶ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§ï¼Œä»è€Œç›´æ¥åœ¨Edenç©ºé—´ä¸­åˆ†é…å†…å­˜ã€‚</li>
</ul>
<h2 id="7-9-ğŸ’¤-å †ç©ºé—´çš„å‚æ•°è®¾ç½®"><a href="#7-9-ğŸ’¤-å †ç©ºé—´çš„å‚æ•°è®¾ç½®" class="headerlink" title="7.9 ğŸ’¤ å †ç©ºé—´çš„å‚æ•°è®¾ç½®"></a>7.9 ğŸ’¤ å †ç©ºé—´çš„å‚æ•°è®¾ç½®</h2><blockquote>
<p>ğŸ“‹ æ€»ç»“</p>
</blockquote>
<ul>
<li><code>-XX:+PrintFlagsInitial</code>ï¼šæŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°çš„é»˜è®¤åˆå§‹å€¼</li>
<li><code>-XX:+PrintFlagsFinal</code>ï¼šæŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°çš„æœ€ç»ˆå€¼ï¼ˆå¯èƒ½ä¼šå­˜åœ¨ä¿®æ”¹ï¼Œä¸å†æ˜¯åˆå§‹å€¼ï¼‰</li>
<li><code>-Xms</code>ï¼šåˆå§‹å †ç©ºé—´å†…å­˜ï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/64ï¼‰</li>
<li><code>-Xmx</code>ï¼šæœ€å¤§å †ç©ºé—´å†…å­˜ï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/4ï¼‰</li>
<li><code>-Xmn</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£çš„å¤§å°ã€‚ï¼ˆåˆå§‹å€¼åŠæœ€å¤§å€¼ï¼‰</li>
<li><code>-XX:NewRatio</code>ï¼šé…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”</li>
<li><code>-XX:SurvivorRatio</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£ä¸­Edenå’ŒS0/S1ç©ºé—´çš„æ¯”ä¾‹</li>
<li><code>-XX:MaxTenuringThreshold</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£åƒåœ¾çš„æœ€å¤§å¹´é¾„</li>
<li><code>-XX:+PrintGCDetails</code>ï¼šè¾“å‡ºè¯¦ç»†çš„GCå¤„ç†æ—¥å¿—<ul>
<li>æ‰“å°gcç®€è¦ä¿¡æ¯ï¼šâ‘ <code>-XX:+PrintGC</code> â‘¡<code> - verbose:gc</code></li>
</ul>
</li>
<li><code>-XX:HandlePromotionFalilure</code>ï¼šæ˜¯å¦è®¾ç½®ç©ºé—´åˆ†é…æ‹…ä¿</li>
<li><code>-XX:PretenureSizeThreshold</code>ï¼šå¯ç›´æ¥è¿›å…¥è€å¹´ä»£çš„newå¯¹è±¡å¤§å°</li>
</ul>
<p>åœ¨å‘ç”ŸMinor GCä¹‹å‰ï¼Œè™šæ‹Ÿæœºä¼šæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡çš„æ€»ç©ºé—´ã€‚</p>
<ul>
<li>å¦‚æœå¤§äºï¼Œåˆ™æ­¤æ¬¡Minor GCæ˜¯å®‰å…¨çš„ã€‚</li>
<li>å¦‚æœå°äºï¼Œåˆ™è™šæ‹Ÿæœºä¼šæŸ¥çœ‹-XX:HandlePromotionFailureè®¾ç½®å€¼æ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥ã€‚<ul>
<li>å¦‚æœHandlePromotionFailure=trueï¼Œé‚£ä¹ˆä¼šç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¯¹è±¡çš„å¹³å‡å¤§å°ã€‚<ul>
<li>å¦‚æœå¤§äºï¼Œåˆ™å°è¯•è¿›è¡Œä¸€æ¬¡Minor GCï¼Œä½†è¿™æ¬¡Minor GCä¾ç„¶æ˜¯æœ‰é£é™©çš„ï¼›</li>
<li>å¦‚æœå°äºï¼Œåˆ™æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡Full GCã€‚</li>
</ul>
</li>
<li>å¦‚æœHandlePromotionFailure=falseï¼Œåˆ™æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡Full GCã€‚</li>
</ul>
</li>
</ul>
<p>åœ¨JDK6 Update24ä¹‹åï¼ŒHandlePromotionFailureå‚æ•°ä¸ä¼šå†å½±å“åˆ°è™šæ‹Ÿæœºçš„ç©ºé—´åˆ†é…æ‹…ä¿ç­–ç•¥ï¼Œè§‚å¯ŸopenJDKä¸­çš„æºç å˜åŒ–ï¼Œè™½ç„¶æºç ä¸­è¿˜å®šä¹‰äº†HandlePromotionFailureå‚æ•°ï¼Œä½†æ˜¯åœ¨ä»£ç ä¸­å·²ç»ä¸ä¼šå†ä½¿ç”¨å®ƒã€‚JDK6 Update 24ä¹‹åçš„è§„åˆ™å˜ä¸ºåªè¦è€å¹´ä»£çš„è¿ç»­ç©ºé—´å¤§äºæ–°ç”Ÿä»£å¯¹è±¡æ€»å¤§å°æˆ–è€…å†æ¬¡æ™‹å‡çš„å¹³å‡å¤§å°å°±ä¼šè¿›è¡ŒMinor GCï¼Œå¦åˆ™å°†è¿›è¡ŒFullGCã€‚</p>
<h2 id="7-10-â“-å †æ˜¯åˆ†é…å¯¹è±¡å­˜å‚¨çš„å”¯ä¸€é€‰æ‹©å—"><a href="#7-10-â“-å †æ˜¯åˆ†é…å¯¹è±¡å­˜å‚¨çš„å”¯ä¸€é€‰æ‹©å—" class="headerlink" title="7.10 â“ å †æ˜¯åˆ†é…å¯¹è±¡å­˜å‚¨çš„å”¯ä¸€é€‰æ‹©å—"></a>7.10 â“ å †æ˜¯åˆ†é…å¯¹è±¡å­˜å‚¨çš„å”¯ä¸€é€‰æ‹©å—</h2><blockquote>
<p>ğŸ“˜ å¼•ç”¨</p>
</blockquote>
<p>åœ¨ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­å…³äºJavaå †å†…å­˜æœ‰è¿™æ ·ä¸€æ®µæè¿°ï¼š</p>
<p>éšç€JITç¼–è¯‘æœŸçš„å‘å±•ä¸é€ƒé€¸åˆ†ææŠ€æœ¯é€æ¸æˆç†Ÿï¼Œæ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢ä¼˜åŒ–æŠ€æœ¯å°†ä¼šå¯¼è‡´ä¸€äº›å¾®ç§’çš„å˜åŒ–ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½åˆ†é…åˆ°å †ä¸Šä¹Ÿæ¸æ¸å˜å¾—ä¸é‚£ä¹ˆç»å¯¹äº†ã€‚</p>
<p>åœ¨Javaè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡æ˜¯åœ¨Javaå †ä¸­åˆ†é…å†…å­˜çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæ™®éçš„å¸¸è¯†ã€‚ä½†æ˜¯æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œé‚£å°±æ˜¯å¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰åå‘ç°ï¼Œä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œé‚£ä¹ˆä¹…å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚è¿™æ ·å°±æ— éœ€åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œä¹Ÿæ— éœ€è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚è¿™ä¹Ÿæ˜¯æœ€å¸¸è§çš„å †å¤–å­˜å‚¨æŠ€æœ¯ã€‚</p>
<p>æ­¤å¤–ï¼Œå‰é¢æåˆ°çš„åŸºäºOpenJDKæ·±åº¦å®šåˆ¶çš„TaoBaoVMï¼Œå…¶ä¸­åˆ›æ–°çš„GCIHï¼ˆGC invisible heapï¼‰æŠ€æœ¯å®ç°çš„off-heapï¼Œå°†ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„Javaå¯¹è±¡ä»heapä¸­ç§»è‡³heapå¤–ï¼Œå¹¶ä¸”GCä¸èƒ½ç®¡ç†GCIHå†…éƒ¨çš„Javaå¯¹è±¡ï¼Œä»¥æ­¤è¾¾åˆ°é™ä½GCçš„å›æ”¶é¢‘ç‡å’Œæå‡GCçš„å›æ”¶æ•ˆç‡çš„ç›®çš„ã€‚</p>
<blockquote>
<p>ğŸ“– é€ƒé€¸åˆ†ææ¦‚è¿°</p>
</blockquote>
<ul>
<li>å¦‚ä½•å°†å †ä¸Šçš„å¯¹è±¡åˆ†é…åˆ°æ ˆï¼Œéœ€è¦ä½¿ç”¨é€ƒé€¸åˆ†ææ‰‹æ®µã€‚</li>
<li>è¿™æ˜¯ä¸€ç§æœ‰æ•ˆå‡å°‘Javaç¨‹åºä¸­åŒæ­¥è´Ÿè½½å’Œå†…å­˜å †å†…å­˜çš„è·¨å‡½æ•°å…¨å±€æ•°æ®æµåˆ†æç®—æ³•ã€‚</li>
<li>é€šè¿‡é€ƒé€¸åˆ†æï¼ŒJava Hotspotç¼–è¯‘å™¨èƒ½å¤Ÿåˆ†æå‡ºä¸€ä¸ªæ–°çš„å¯¹è±¡çš„å¼•ç”¨çš„ä½¿ç”¨èŒƒå›´ä»è€Œå†³å®šæ˜¯å¦å°†è¿™ä¸ªå¯¹è±¡åˆ†é…åˆ°å †ä¸Šã€‚</li>
<li>é€ƒé€¸åˆ†æçš„åŸºæœ¬è¡Œä¸ºå°±æ˜¯åˆ†æå¯¹è±¡åŠ¨æ€ä½œç”¨åŸŸï¼š<ul>
<li>å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•å†…è¢«å®šä¹‰åï¼Œå¯¹è±¡åªåœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œåˆ™è®¤ä¸ºæ²¡æœ‰å‘ç”Ÿé€ƒé€¸ã€‚</li>
<li>å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­è¢«å®šä¹‰åï¼Œå®ƒè¢«å¤–éƒ¨æ–¹æ³•æ‰€å¼•ç”¨ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿé€ƒé€¸ã€‚ä¾‹å¦‚ä½œä¸ºè°ƒç”¨å‚æ•°ä¼ é€’åˆ°å…¶ä»–æ–¹æ³•ä¸­ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>âš™ï¸ å‚æ•°è®¾ç½®</p>
</blockquote>
<p>åœ¨JDK 1.7 ç‰ˆæœ¬ä¹‹åï¼ŒHotSpotä¸­é»˜è®¤å°±å·²ç»å¼€å¯äº†é€ƒé€¸åˆ†æ</p>
<p>å¦‚æœä½¿ç”¨çš„æ˜¯è¾ƒæ—©çš„ç‰ˆæœ¬ï¼Œå¼€å‘äººå‘˜åˆ™å¯ä»¥é€šè¿‡ï¼š</p>
<ul>
<li>é€‰é¡¹<code>-xx:+DoEscapeAnalysis</code>æ˜¾å¼å¼€å¯é€ƒé€¸åˆ†æ</li>
<li>é€‰é¡¹<code>-xx:+PrintEscapeAnalysis</code>æŸ¥çœ‹é€ƒé€¸åˆ†æçš„ç­›é€‰ç»“æœ</li>
</ul>
<blockquote>
<p>âœ… ç»“è®º</p>
</blockquote>
<p>å¼€å‘ä¸­èƒ½ä½¿ç”¨å±€éƒ¨å˜é‡çš„ï¼Œå°±ä¸ç”¨ä½¿ç”¨åœ¨æ–¹æ³•å¤–å®šä¹‰ã€‚</p>
<p>ä½¿ç”¨é€ƒé€¸åˆ†æï¼Œç¼–è¯‘å™¨å¯ä»¥å¯¹ä»£ç åšå¦‚ä¸‹ä¼˜åŒ–ï¼š</p>
<ul>
<li>æ ˆä¸Šåˆ†é…ï¼šå°†å †åˆ†é…è½¬åŒ–ä¸ºæ ˆåˆ†é…ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨å­ç¨‹åºä¸­è¢«åˆ†é…ï¼Œè¦ä½¿æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆæ°¸è¿œä¸ä¼šå‘ç”Ÿé€ƒé€¸ï¼Œå¯¹è±¡å¯èƒ½æ˜¯æ ˆä¸Šåˆ†é…çš„å€™é€‰ï¼Œè€Œä¸æ˜¯å †ä¸Šåˆ†é…ã€‚</li>
<li>åŒæ­¥çœç•¥ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è¢«å‘ç°åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªå¯¹è±¡çš„æ“ä½œå¯ä»¥ä¸è€ƒè™‘åŒæ­¥ã€‚</li>
<li>åˆ†ç¦»å¯¹è±¡æˆ–æ ‡é‡æ›¿æ¢ï¼šæœ‰çš„å¯¹è±¡å¯èƒ½ä¸éœ€è¦ä½œä¸ºä¸€ä¸ªè¿ç»­çš„å†…å­˜ç»“æ„å­˜åœ¨ä¹Ÿä¹Ÿå¯ä»¥è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹è±¡çš„éƒ¨åˆ†ï¼ˆæˆ–å…¨éƒ¨ï¼‰å¯ä»¥ä¸å­˜å‚¨åœ¨å†…å­˜ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨CPUå¯„å­˜å™¨ä¸­ã€‚</li>
</ul>
<blockquote>
<p>âŒ¨ï¸ ä»£ç ç¤ºä¾‹</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021/2/12</span></span><br><span class="line"><span class="comment"> * é€ƒé€¸åˆ†æï¼šå°±çœ‹newçš„å¯¹è±¡æ˜¯å¦æœ‰å¯èƒ½åœ¨æ–¹æ³•å¤–è¢«è°ƒç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EscapeAnalysis</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> EscapeAnalysis obj;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•è¿”å›EscapeAnalysiså¯¹è±¡ï¼Œå‘ç”Ÿé€ƒé€¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EscapeAnalysis <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> obj == <span class="keyword">null</span> ? <span class="keyword">new</span> EscapeAnalysis() : obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸ºæˆå‘˜å±æ€§èµ‹å€¼ï¼Œå‘ç”Ÿé€ƒé€¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setObj</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.obj = <span class="keyword">new</span> EscapeAnalysis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯¹è±¡çš„ä½œç”¨åŸŸä»…åœ¨å½“å‰æ–¹æ³•ä¸­æœ‰æ•ˆï¼Œæ²¡æœ‰å‘ç”Ÿé€ƒé€¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">useEscapeAnalysis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EscapeAnalysis escapeAnalysis = <span class="keyword">new</span> EscapeAnalysis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼•ç”¨æˆå‘˜å˜é‡çš„å€¼ï¼Œå‘ç”Ÿé€ƒé€¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">useEscapeAnalysis1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EscapeAnalysis escapeAnalysis = getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>1ï¸âƒ£ æ ˆä¸Šåˆ†é…</p>
</blockquote>
<p>JITç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®é€ƒé€¸åˆ†æçš„ç»“æœï¼Œå‘ç°å¦‚æœä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚åˆ†é…å®Œæˆåï¼Œç»§ç»­åœ¨è°ƒç”¨æ ˆå†…æ‰§è¡Œï¼Œæœ€åçº¿ç¨‹ç»“æŸï¼Œæ ˆç©ºé—´è¢«å›æ”¶ï¼Œå±€éƒ¨å˜é‡å¯¹è±¡ä¹Ÿè¢«å›æ”¶ã€‚è¿™æ ·å°±æ— é¡»è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚</p>
<p>åœºæ™¯ï¼šæˆå‘˜å˜é‡èµ‹å€¼ã€æ–¹æ³•è¿”å›å€¼ã€å®ä¾‹å¼•ç”¨ä¼ é€’ã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021/2/22</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String age;</span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StackAllocation</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// åˆ†é…ä¸€ç™¾ä¸‡ä¸ªå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000000</span>; i++) &#123;</span><br><span class="line">            alloc();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// æŸ¥çœ‹æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œæ—¶é—´ =&gt; [&quot;</span> + (end - start)+ <span class="string">&quot;ms]&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¼‘çœ ä»¥æŸ¥çœ‹å†…å­˜</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">alloc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æœªå‘ç”Ÿé€ƒé€¸</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸å¼€å¯é€ƒé€¸åˆ†æï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-Xmx1G -Xms1G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ‰§è¡Œæ—¶é—´ &#x3D;&gt; [4ms]</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æŠ½æ ·å™¨æŸ¥çœ‹å†…å­˜æƒ…å†µï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/image-20210222170206155.png" class="" title="image-20210222170206155"><br />

<p>å‘ç°å†…å­˜ä¸­æœ‰8w+çš„Userå®ä¾‹ã€‚</p>
<p>å¼€å¯é€ƒé€¸åˆ†æï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-Xmx1G -Xms1G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ‰§è¡Œæ—¶é—´ &#x3D;&gt; [5ms]</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æŠ½æ ·å™¨æŸ¥çœ‹å†…å­˜æƒ…å†µï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11581/image-20210222170124218.png" class="" title="image-20210222170124218"><br />

<p>å‘ç°å†…å­˜ä¸­æœ‰9w+çš„å†…å­˜å®ä¾‹ã€‚</p>
<p>è¿™å¯¹æ¯”æ˜¯ç¥é©¬ç©æ„ï¼Œå“‡åäº†â€¦â€¦</p>
<blockquote>
<p>2ï¸âƒ£ åŒæ­¥çœç•¥</p>
</blockquote>
<p>çº¿ç¨‹åŒæ­¥çš„ä»£ä»·æ˜¯ç›¸å½“é«˜çš„ï¼ŒåŒæ­¥çš„åæœæ˜¯é™ä½å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚</p>
<p>åœ¨åŠ¨æ€ç¼–è¯‘åŒæ­¥å—çš„æ—¶å€™ï¼ŒJITç¼–è¯‘å™¨å¯ä»¥å€ŸåŠ©é€ƒé€¸åˆ†æåŒæ­¥å—æ‰€ä½¿ç”¨çš„é”å¯¹è±¡æ˜¯å¦èƒ½å¤Ÿè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®è€Œæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶ä»–çº¿ç¨‹ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆJITç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿™ä¸ªåŒæ­¥å—çš„æ—¶å€™å°±ä¼šå–æ¶ˆå¯¹è¿™ä¸ªä»£ç å—çš„åŒæ­¥ã€‚è¿™æ ·å°±èƒ½å¤§å¤§æé«˜å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚è¿™ä¸ªå–æ¶ˆåŒæ­¥çš„è¿‡ç¨‹å°±å«åŒæ­¥çœç•¥ï¼Œä¹Ÿå«é”æ¶ˆé™¤ã€‚</p>
<p>å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object obj = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">synchronized</span>(obj) &#123;</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»£ç å—å¯¹<code>obj</code>è¿™ä¸ªå¯¹è±¡åŠ é”ï¼Œä½†æ˜¯<code>obj</code>å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåªåœ¨æ–¹æ³•ä¸­ï¼Œå¹¶ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹é”è®¿é—®åˆ°ï¼Œæ‰€ä»¥åœ¨JITç¼–è¯‘é˜¶æ®µå°±ä¼šè¢«ä¼˜åŒ–æ‰ï¼Œä¼˜åŒ–æˆï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object obj = <span class="keyword">new</span> Object();</span><br><span class="line">    System.out.println(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>3ï¸âƒ£ åˆ†ç¦»å¯¹è±¡å’Œæ ‡é‡æ›¿æ¢</p>
</blockquote>
<p>æ ‡é‡ï¼ˆscalarï¼‰æ˜¯æŒ‡ä¸€ä¸ªæ— æ³•å†åˆ†è§£æˆæ›´å°çš„æ•°æ®çš„æ•°æ®ã€‚Javaä¸­çš„åŸå§‹æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ã€‚</p>
<p>ç›¸å¯¹çš„ï¼Œé‚£ä¹ˆè¿˜å¯ä»¥åˆ†è§£çš„æ•°æ®å«åšèšåˆé‡ï¼ˆAggregateï¼‰ï¼ŒJavaä¸­çš„å¯¹è±¡å°±æ˜¯èšåˆé‡ï¼Œå› ä¸ºä»–å¯ä»¥åˆ†è§£æˆå…¶ä»–èšåˆé‡å’Œæ ‡é‡ã€‚</p>
<p>åœ¨JITé˜¶æ®µï¼Œå¦‚ä½•ç»è¿‡é€ƒé€¸åˆ†æï¼Œå‘ç°ä¸€ä¸ªå¯¹è±¡ä¸ä¼šè¢«å¤–ç•Œè®¿é—®çš„è¯ï¼Œé‚£ä¹ˆç»è¿‡JITä¼˜åŒ–ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå¯¹è±¡æ‹†è§£æˆè‹¥å¹²ä¸ªå…¶ä¸­åŒ…å«çš„è‹¥å¹²ä¸ªæˆå‘˜å˜é‡æ¥ä»£æ›¿ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ ‡é‡æ›¿æ¢ã€‚</p>
<p>å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">    alloc();</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">alloc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Point point = <span class="keyword">new</span> Point(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;point.x&quot;</span> + point.x + <span class="string">&quot;;point.y&quot;</span> + point.y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»è¿‡æ ‡é‡æ›¿æ¢åï¼Œå°±ä¼šå˜æˆï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">alloc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> y = <span class="number">2</span>;</span><br><span class="line">    System.out.println(<span class="string">&quot;point.x = &quot;</span> + x + <span class="string">&quot;; point.y=&quot;</span> + y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>Point</code>è¿™ä¸ªèšåˆé‡ç»è¿‡é€ƒé€¸åˆ†æåï¼Œå‘ç°å®ƒå¹¶æ²¡æœ‰é€ƒé€¸ï¼Œå°±è¢«æ›¿æ¢æˆä¸¤ä¸ªæ ‡é‡äº†ã€‚é‚£ä¹ˆæ ‡é‡æ›¿æ¢æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿå°±æ˜¯å¯ä»¥å¤§å¤§å‡å°‘å†…å­˜çš„å ç”¨ã€‚å› ä¸ºä¸€æ—¦ä¸éœ€è¦åˆ›å»ºå¯¹è±¡äº†ï¼Œé‚£ä¹ˆä¹…ä¸å†éœ€è¦åˆ†é…å†…å­˜äº†ã€‚æ ‡é‡æ›¿æ¢ä¸ºæ ˆä¸Šåˆ†é…æä¾›äº†å¾ˆå¥½çš„åŸºç¡€ã€‚</p>
<blockquote>
<p>ğŸ“‹ ä»£ç ä¼˜åŒ–</p>
</blockquote>
<ul>
<li><p>XX:+DoEscapeAnalysisï¼šå¯ç”¨é€ƒé€¸åˆ†æ</p>
</li>
<li><p>XX:+EliminateAllocationsï¼šå¼€å¯äº†æ ‡é‡æ›¿æ¢ï¼ˆé»˜è®¤æ‰“å¼€ï¼‰ï¼Œå…è®¸å°†å¯¹è±¡æ‰“æ•£åˆ†é…åœ¨æ ˆä¸Šã€‚æ¯”å¦‚å¯¹è±¡æ‹¥æœ‰idå’Œnameä¸¤ä¸ªå­—æ®µï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå­—æ®µå°†ä¼šè¢«è§†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å±€éƒ¨å˜é‡è¿›è¡Œåˆ†é…ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ”º é€ƒé€¸åˆ†æçš„ä¸è¶³</p>
</blockquote>
<p>å…³äºé€ƒé€¸åˆ†æçš„è®ºæ–‡åœ¨1999å¹´å°±å·²ç»å‘è¡¨äº†ï¼Œä½†ç›´åˆ°JDK1.6æ‰æœ‰å®ç°ï¼Œè€Œä¸”è¿™é¡¹æŠ€æœ¯åˆ°å¦‚ä»Šä¹Ÿå¹¶ä¸æ˜¯ååˆ†æˆç†Ÿã€‚</p>
<p>å…¶æ ¹æœ¬åŸå› å°±æ˜¯æ— æ³•ä¿è¯é€ƒé€¸åˆ†æçš„æ€§èƒ½æ¶ˆè€—ä¸€å®šèƒ½é«˜äºä»–çš„æ¶ˆè€—ã€‚è™½ç„¶ç»è¿‡é€ƒé€¸åˆ†æå¯ä»¥åšæ ‡é‡æ›¿æ¢ã€æ ˆä¸Šåˆ†é…ã€å’Œé”æ¶ˆé™¤ã€‚ä½†æ˜¯é€ƒé€¸åˆ†æè‡ªèº«ä¹Ÿæ˜¯éœ€è¦è¿›è¡Œä¸€ç³»åˆ—å¤æ‚çš„åˆ†æçš„ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹è€—æ—¶çš„è¿‡ç¨‹ã€‚ ä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼Œå°±æ˜¯ç»è¿‡é€ƒé€¸åˆ†æä¹‹åï¼Œå‘ç°æ²¡æœ‰ä¸€ä¸ªå¯¹è±¡æ˜¯ä¸é€ƒé€¸çš„ã€‚é‚£è¿™ä¸ªé€ƒé€¸åˆ†æçš„è¿‡ç¨‹å°±ç™½ç™½æµªè´¹æ‰äº†ã€‚</p>
<p>è™½ç„¶è¿™é¡¹æŠ€æœ¯å¹¶ä¸ååˆ†æˆç†Ÿï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯å³æ—¶ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ä¸­ä¸€ä¸ªååˆ†é‡è¦çš„æ‰‹æ®µã€‚æ³¨æ„åˆ°æœ‰ä¸€äº›è§‚ç‚¹ï¼Œè®¤ä¸ºé€šè¿‡é€ƒé€¸åˆ†æï¼ŒJVMä¼šåœ¨æ ˆä¸Šåˆ†é…é‚£äº›ä¸ä¼šé€ƒé€¸çš„å¯¹è±¡ï¼Œè¿™åœ¨ç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å–å†³äºJvMè®¾è®¡è€…çš„é€‰æ‹©ã€‚æ®æˆ‘æ‰€çŸ¥ï¼Œoracle Hotspot JVMä¸­å¹¶æœªè¿™ä¹ˆåšï¼Œè¿™ä¸€ç‚¹åœ¨é€ƒé€¸åˆ†æç›¸å…³çš„æ–‡æ¡£é‡Œå·²ç»è¯´æ˜ï¼Œæ‰€ä»¥å¯ä»¥æ˜ç¡®æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ›å»ºåœ¨å †ä¸Šã€‚</p>
<p>ç›®å‰å¾ˆå¤šä¹¦ç±è¿˜æ˜¯åŸºäºJDK7ä»¥å‰çš„ç‰ˆæœ¬ï¼ŒJDKå·²ç»å‘ç”Ÿäº†å¾ˆå¤§å˜åŒ–ï¼Œinternå­—ç¬¦ä¸²çš„ç¼“å­˜å’Œé™æ€å˜é‡æ›¾ç»éƒ½è¢«åˆ†é…åœ¨æ°¸ä¹…ä»£ä¸Šï¼Œè€Œæ°¸ä¹…ä»£å·²ç»è¢«å…ƒæ•°æ®åŒºå–ä»£ã€‚ä½†æ˜¯ï¼Œinternå­—ç¬¦ä¸²ç¼“å­˜å’Œé™æ€å˜é‡å¹¶ä¸æ˜¯è¢«è½¬ç§»åˆ°å…ƒæ•°æ®åŒºï¼Œè€Œæ˜¯ç›´æ¥åœ¨å †ä¸Šåˆ†é…ï¼Œæ‰€ä»¥è¿™ä¸€ç‚¹åŒæ ·ç¬¦åˆå‰é¢ä¸€ç‚¹çš„ç»“è®ºï¼šå¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ†é…åœ¨å †ä¸Šã€‚</p>
<div class="note icon simple"><i class="note-icon fab fa-korvue"></i><p><strong>å°ç»“</strong></p>
<p>å¹´è½»ä»£æ˜¯å¯¹è±¡çš„è¯ç”Ÿã€æˆé•¿ã€æ¶ˆäº¡çš„åŒºåŸŸï¼Œä¸€ä¸ªå¯¹è±¡åœ¨è¿™é‡Œäº§ç”Ÿã€åº”ç”¨ï¼Œæœ€åè¢«åƒåœ¾å›æ”¶å™¨æ”¶é›†ã€ç»“æŸç”Ÿå‘½ã€‚</p>
<p>è€å¹´ä»£æ”¾ç½®é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼Œé€šå¸¸éƒ½æ˜¯ä»survivoråŒºåŸŸç­›é€‰æ‹·è´è¿‡æ¥çš„Javaå¯¹è±¡ã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰ç‰¹æ®Šæƒ…å†µï¼Œæˆ‘ä»¬çŸ¥é“æ™®é€šçš„å¯¹è±¡ä¼šè¢«åˆ†é…åœ¨TLABä¸Šï¼›å¦‚æœå¯¹è±¡è¾ƒå¤§ï¼ŒJVMä¼šè¯•å›¾ç›´æ¥åˆ†é…åœ¨Edenå…¶ä»–ä½ç½®ä¸Šï¼›å¦‚æœå¯¹è±¡å¤ªå¤§ï¼Œå®Œå…¨æ— æ³•åœ¨æ–°ç”Ÿä»£æ‰¾åˆ°è¶³å¤Ÿé•¿çš„è¿ç»­ç©ºé—²ç©ºé—´ï¼ŒJVMå°±ä¼šç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ã€‚å½“GCåªå‘ç”Ÿåœ¨å¹´è½»ä»£ä¸­ï¼Œå›æ”¶å¹´è½»ä»£å¯¹è±¡çš„è¡Œä¸ºè¢«ç§°ä¸ºMinorGcã€‚</p>
<p>å½“GCå‘ç”Ÿåœ¨è€å¹´ä»£æ—¶åˆ™è¢«ç§°ä¸ºMajorGcæˆ–è€…FullGCã€‚ä¸€èˆ¬çš„ï¼ŒMinorGcçš„å‘ç”Ÿé¢‘ç‡è¦æ¯”MajorGCé«˜å¾ˆå¤šï¼Œå³è€å¹´ä»£ä¸­åƒåœ¾å›æ”¶å‘ç”Ÿçš„é¢‘ç‡å°†å¤§å¤§ä½äºå¹´è½»ä»£ã€‚</p>
</div>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis-plus</title>
    <url>/posts/fd1960c6/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ğŸ“–-å®˜æ–¹æ–‡æ¡£"><a href="#ğŸ“–-å®˜æ–¹æ–‡æ¡£" class="headerlink" title="ğŸ“– å®˜æ–¹æ–‡æ¡£"></a>ğŸ“– å®˜æ–¹æ–‡æ¡£</h2><blockquote>
<p>ğŸŒæ–‡æ¡£</p>
</blockquote>
<p>ğŸ‘‰ <a href="https://mybatis.plus/">mybatis-plus</a></p>
<blockquote>
<p>â˜„ï¸ç‰¹æ€§</p>
</blockquote>
<ul>
<li>æ¶¦ç‰©æ— å£°ï¼šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œå¼•å…¥å®ƒä¸ä¼šå¯¹ç°æœ‰å·¥ç¨‹äº§ç”Ÿå½±å“ï¼Œå¦‚ä¸èˆ¬é¡ºæ»‘ã€‚</li>
<li>æ•ˆç‡è‡³ä¸Šï¼šåªéœ€ç®€å•é…ç½®ï¼Œå³å¯å¿«é€Ÿè¿›è¡Œå•è¡¨ CRUD æ“ä½œï¼Œä»è€ŒèŠ‚çœå¤§é‡æ—¶é—´ã€‚</li>
<li>ä¸°å¯ŒåŠŸèƒ½ï¼šä»£ç ç”Ÿæˆã€ç‰©ç†åˆ†é¡µã€æ€§èƒ½åˆ†æç­‰åŠŸèƒ½ä¸€åº”ä¿±å…¨ã€‚</li>
</ul>
<blockquote>
<p>â›“ç»“æ„</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/fd1960c6/mybatis-plus-framework.jpg" class="" title="mybatis-plus-framework"><br />

<br />

<a id="more"></a>



<h2 id="â•-æ·»åŠ ä¾èµ–"><a href="#â•-æ·»åŠ ä¾èµ–" class="headerlink" title="â• æ·»åŠ ä¾èµ–"></a>â• æ·»åŠ ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.20<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fastjson.version</span>&gt;</span>1.2.58<span class="tag">&lt;/<span class="name">fastjson.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">gson.version</span>&gt;</span>2.8.6<span class="tag">&lt;/<span class="name">gson.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis-plus.version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">mybatis-plus.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">common-io.version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">common-io.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">common-fileupload.version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">common-fileupload.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis-plus-generate.version</span>&gt;</span>2.3.3<span class="tag">&lt;/<span class="name">mybatis-plus-generate.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generate<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus-generate.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;fastjson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<br />

<h2 id="ğŸ’¥é…ç½®æ–‡ä»¶"><a href="#ğŸ’¥é…ç½®æ–‡ä»¶" class="headerlink" title="ğŸ’¥é…ç½®æ–‡ä»¶"></a>ğŸ’¥é…ç½®æ–‡ä»¶</h2><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Server</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">3333</span></span><br><span class="line"><span class="meta">server.tomcat.uri-encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Database</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowMultiQueries=true</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">KAG1823</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Mybatis-plus</span></span><br><span class="line"><span class="meta">mybatis-plus.mapper-locations</span>=<span class="string">classpath*:/mapper/**/*.xml</span></span><br><span class="line"><span class="meta">mybatis-plus.type-aliases-package</span>=<span class="string">top.parak.entity</span></span><br><span class="line"><span class="meta">mybatis-plus.configuration.map-underscore-to-camel-case</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">mybatis-plus.global-config.banner</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">mybatis-plus.configuration.log-impl</span>=<span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line"><span class="comment"># Logic-Delete</span></span><br><span class="line"><span class="meta">mybatis-plus.global-config.db-config.logic-delete-value</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">mybatis-plus.global-config.db-config.logic-not-delete-value</span>=<span class="string">0</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># Log</span></span><br><span class="line"><span class="meta">logging.level.top.parak.mapper</span>=<span class="string">debug</span></span><br><span class="line"><span class="meta">logging.level.top.parak.controller</span>=<span class="string">debug</span></span><br></pre></td></tr></table></figure>

<br />

<h2 id="ğŸŒ€ä¸»é”®ç”Ÿæˆç­–ç•¥"><a href="#ğŸŒ€ä¸»é”®ç”Ÿæˆç­–ç•¥" class="headerlink" title="ğŸŒ€ä¸»é”®ç”Ÿæˆç­–ç•¥"></a>ğŸŒ€ä¸»é”®ç”Ÿæˆç­–ç•¥</h2><blockquote>
<p>â„ï¸Snowflake</p>
</blockquote>
<p><code>SnowFlake</code>æ˜¯<code>Twitter</code>å¼€æºçš„åˆ†å¸ƒå¼<code>ID</code>ç”Ÿæˆç®—æ³•ã€‚</p>
<blockquote>
<p>ğŸ†”IDç»“æ„</p>
</blockquote>
<p><code>SnowFlake</code>ç”Ÿæˆ<code>ID</code>å›ºå®šæ˜¯ä¸€ä¸ª<code>long</code>å‹çš„æ•°å­—ï¼Œä¸€ä¸ª<code>long</code>å‹å 8ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯64ä¸ª<code>bit</code>ï¼Œåˆ†é…å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/fd1960c6/SnowFlakeID.jpg" class="" title="SnowFlake"><br />

<ol>
<li>ç¬¬ä¸€ä¸ªbitæ˜¯æ ‡è¯†ä½éƒ¨åˆ†ï¼Œåœ¨<code>Java</code>ä¸­ç”±äº<code>long</code>çš„æœ€é«˜ä½æ˜¯ç¬¦å·ä½ï¼Œæ­£æ•°æ˜¯<code>0</code>ï¼Œè´Ÿæ•°æ˜¯<code>1</code>ï¼Œä¸€èˆ¬ç”Ÿæˆçš„<code>ID</code>ä¸ºæ­£æ•°ï¼Œæ‰€ä»¥å›ºå®šä¸º<code>0</code>ã€‚</li>
<li>æ—¶é—´æˆ³éƒ¨åˆ†å <code>41bit</code>ï¼Œè¿™ä¸ªæ˜¯æ¯«ç§’çº§çš„æ—¶é—´ï¼Œä¸€èˆ¬å®ç°ä¸Šä¸ä¼šå­˜å‚¨å½“å‰çš„æ—¶é—´æˆ³ï¼Œè€Œæ˜¯æ—¶é—´æˆ³çš„å·®å€¼(å½“å‰æ—¶é—´-å›ºå®šçš„å¼€å§‹æ—¶é—´)ï¼Œè¿™æ ·å¯ä»¥ä½¿äº§ç”Ÿçš„<code>ID</code>ä»æ›´å°å€¼å¼€å§‹ã€‚<code>41</code>ä½çš„æ—¶é—´æˆ³å¯ä»¥ä½¿ç”¨<code>69</code>å¹´ã€‚</li>
<li>å·¥ä½œæœºå™¨<code>ID</code>å <code>10bit</code>ï¼Œè¿™é‡Œæ¯”è¾ƒçµæ´»ï¼Œæ¯”å¦‚ï¼Œå¯ä»¥ä½¿ç”¨å‰<code>5</code>ä½ä½œä¸ºæ•°æ®ä¸­å¿ƒæœºæˆ¿æ ‡è¯†ï¼Œå<code>5</code>ä½ä½œä¸ºå•æœºæˆ¿æœºå™¨æ ‡è¯†ï¼Œå¯ä»¥éƒ¨ç½²<code>1024</code>ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>åºåˆ—å·éƒ¨åˆ†å <code>12bit</code>ï¼Œæ”¯æŒåŒä¸€æ¯«ç§’å†…åŒä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥ç”Ÿæˆ2^12^=<code>4096</code>ä¸ª<code>ID</code>ã€‚</li>
</ol>
<blockquote>
<p>ğŸŒ  ä¼˜ç‚¹å’Œç¼ºç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ¯«ç§’æ•°åœ¨é«˜ä½ï¼Œè‡ªå¢åºåˆ—åœ¨ä½ä½ï¼Œ<code>ID</code>è¶‹åŠ¿é€’å¢ã€‚</li>
<li>ä»¥æœåŠ¡æ–¹å¼éƒ¨ç½²ï¼Œå¯ä»¥åšé«˜å¯ç”¨ã€‚</li>
<li>æ ¹æ®ä¸šåŠ¡åˆ†é…<code>bit</code>ä½ï¼Œçµæ´»ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ¯å°æœºå™¨çš„æ—¶é’Ÿä¸åŒï¼Œå½“æ—¶é’Ÿå›æ‹¨å¯èƒ½ä¼šå‘ç”Ÿé‡å¤IDã€‚</li>
<li>å½“æ•°æ®é‡å¤§æ—¶ï¼Œéœ€è¦å¯¹<code>ID</code>å–æ¨¡åˆ†åº“åˆ†è¡¨ï¼Œåœ¨è·¨æ¯«ç§’æ—¶ï¼Œåºåˆ—å·æ€»æ˜¯å½’<code>0</code>ï¼Œä¼šå‘ç”Ÿå–æ¨¡ååˆ†å¸ƒä¸å‡è¡¡ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’» Javaå®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: Mybatis-plus &lt;/P&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.common &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: SnowShakeUntil &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: é›ªèŠ±ç®—æ³• &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SnowFlakeUntil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;å¼€å§‹æ—¶é—´æˆ³&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> START_STMP;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        String startDateTime = <span class="string">&quot;2001-09-11 00:00:00&quot;</span>;</span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/* 13ä½æ—¶é—´æˆ³ */</span></span><br><span class="line">            START_STMP = simpleDateFormat.parse(startDateTime).getTime();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;åºåˆ—å·å ç”¨çš„ä½æ•°&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> SEQUENCE_BIT = <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æ•°æ®ä¸­å¿ƒæ ‡è¯†å ç”¨çš„ä½æ•°&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MACHINE_BIT = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æœºå™¨æ ‡è¯†å ç”¨çš„ä½æ•°&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> DATACENTER_BIT = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ¯ä¸€éƒ¨åˆ†çš„æœ€å¤§å€¼ï¼šå…ˆè¿›è¡Œå·¦ç§»è¿ç®—ï¼Œå†åŒ-1è¿›è¡Œå¼‚æˆ–è¿ç®— */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ç”¨ä½è¿ç®—è®¡ç®—å‡ºæœ€å¤§æ”¯æŒçš„æ•°æ®ä¸­å¿ƒæ•°é‡ï¼š31&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MAX_DATACENTER_NUM = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; DATACENTER_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ç”¨ä½è¿ç®—è®¡ç®—å‡ºæœ€å¤§æ”¯æŒçš„æœºå™¨æ•°é‡&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MAX_MACHINE_NUM = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; MACHINE_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ç”¨ä½è¿ç®—è®¡ç®—å‡ºæœ€å¤§æ”¯æŒçš„æœ€å¤§æ­£æ•´æ•°4095&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MAX_SEQUENCE = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; SEQUENCE_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æœºå™¨æ ‡å¿—è¾ƒåºåˆ—å·çš„åç§»é‡&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MACHINE_LEFT = SEQUENCE_BIT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æ•°æ®ä¸­å¿ƒè¾ƒæœºå™¨æ ‡å¿—çš„åç§»é‡&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> DATACENTER_LEFT = SEQUENCE_BIT + MACHINE_BIT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æ—¶é—´æˆ³è¾ƒæ•°æ®ä¸­å¿ƒçš„åç§»é‡&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> TIMESTMP_LEFT = DATACENTER_LEFT + DATACENTER_BIT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æ•°æ®ä¸­å¿ƒ&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> dataCenterId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æœºå™¨æ ‡è¯†&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> machineId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;åºåˆ—å·&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> sequence = <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4&lt;p&gt;ä¸Šä¸€æ¬¡æ—¶é—´æˆ³&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> lastStmp = -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æ­¤å¤„æ— å‚æ„é€ ç§æœ‰ï¼ŒåŒæ—¶æ²¡æœ‰ç»™å‡ºæœ‰å‚æ„é€ ï¼Œåœ¨äºé¿å…ä»¥ä¸‹ä¸¤ç‚¹é—®é¢˜ï¼š&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;1. ç§æœ‰åŒ–é¿å…äº†é€šè¿‡newçš„æ–¹å¼è¿›è¡Œè°ƒç”¨ï¼Œä¸»è¦æ˜¯è§£å†³äº†åœ¨forå¾ªç¯ä¸­é€šè¿‡newçš„æ–¹å¼è°ƒç”¨äº§ç”Ÿçš„idä¸ä¸€å®šå”¯ä¸€é—®é¢˜é—®é¢˜ï¼Œå› ä¸ºç”¨äºè®°å½•ä¸Šä¸€æ¬¡æ—¶é—´æˆ³çš„lastStmpæ°¸è¿œæ— æ³•å¾—åˆ°æ¯”å¯¹&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;2. æ²¡æœ‰ç»™å‡ºæœ‰å‚æ„é€ åœ¨ç¬¬ä¸€ç‚¹çš„åŸºç¡€ä¸Šè€ƒè™‘äº†ä¸€å¥—åˆ†å¸ƒå¼ç³»ç»Ÿäº§ç”Ÿçš„å”¯ä¸€åºåˆ—å·åº”è¯¥æ˜¯åŸºäºç›¸åŒçš„å‚æ•°&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SnowFlakeUntil</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ç”ŸæˆID&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">nextID</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* è·å–å½“å‰æ—¶é—´æˆ³*/</span></span><br><span class="line">        <span class="keyword">long</span> currStmp = getNewStmp();</span><br><span class="line">        <span class="comment">/* å¦‚æœå½“å‰æ—¶é—´æˆ³å°äºä¸Šæ¬¡æ—¶é—´æˆ³åˆ™æŠ›å‡ºå¼‚å¸¸ */</span></span><br><span class="line">        <span class="keyword">if</span> (currStmp &lt; lastStmp) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Clock moved backwards. Refusing to generate id&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* ç›¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·è‡ªå¢ */</span></span><br><span class="line">        <span class="keyword">if</span> (currStmp == lastStmp) &#123;</span><br><span class="line">            sequence = (sequence + <span class="number">1</span>) &amp; MAX_SEQUENCE;</span><br><span class="line">            <span class="comment">/* åŒä¸€æ¯«ç§’çš„åºåˆ—æ•°å·²ç»è¾¾åˆ°æœ€å¤§*/</span></span><br><span class="line">            <span class="keyword">if</span> (sequence == <span class="number">0L</span>) &#123;</span><br><span class="line">                currStmp = getNextStmp();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* ä¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·è®¾ä¸º0 */</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            sequence = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å½“å‰æ—¶é—´æˆ³å­˜æ¡£è®°å½•*/</span></span><br><span class="line">        lastStmp = currStmp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (currStmp - START_STMP) &lt;&lt; TIMESTMP_LEFT  <span class="comment">// æ—¶é—´æˆ³éƒ¨åˆ†</span></span><br><span class="line">                | dataCenterId &lt;&lt; DATACENTER_LEFT        <span class="comment">// æ•°æ®ä¸­å¿ƒéƒ¨åˆ†</span></span><br><span class="line">                | machineId &lt;&lt; MACHINE_LEFT              <span class="comment">// æœºå™¨æ ‡è¯†éƒ¨åˆ†</span></span><br><span class="line">                | sequence;                              <span class="comment">// åºåˆ—å·éƒ¨åˆ†</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;å½“å‰æ—¶é—´æˆ³&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getNewStmp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ä¸‹ä¸€æ—¶é—´çš„æ—¶é—´æˆ³&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getNextStmp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> mill = getNewStmp();</span><br><span class="line">        <span class="keyword">while</span> (mill &lt;= lastStmp) &#123;</span><br><span class="line">            mill = getNewStmp();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ğŸ”±åœ¨Mybatis-plusä¸­è‡ªå®šä¹‰IDç”Ÿæˆå™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomIdGenerator</span> <span class="keyword">implements</span> <span class="title">IdentifierGenerator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">nextId</span><span class="params">(Object entity)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">// å¯ä»¥å°†å½“å‰ä¼ å…¥çš„classå…¨ç±»åæ¥ä½œä¸ºbizKey,æˆ–è€…æå–å‚æ•°æ¥ç”ŸæˆbizKeyè¿›è¡Œåˆ†å¸ƒå¼Idè°ƒç”¨ç”Ÿæˆ.</span></span><br><span class="line">      	String bizKey = entity.getClass().getName();</span><br><span class="line">        <span class="comment">// æ ¹æ®bizKeyè°ƒç”¨åˆ†å¸ƒå¼IDç”Ÿæˆ</span></span><br><span class="line">        <span class="keyword">long</span> id = ....;</span><br><span class="line">      	<span class="comment">// è¿”å›ç”Ÿæˆçš„idå€¼å³å¯.</span></span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br />

<h2 id="ğŸš€-CRUDæ‹“å±•"><a href="#ğŸš€-CRUDæ‹“å±•" class="headerlink" title="ğŸš€ CRUDæ‹“å±•"></a>ğŸš€ CRUDæ‹“å±•</h2><blockquote>
<p>å»ºè¡¨</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="built_in">tinyint</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`email`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">18</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®ä½“</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Email</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br />

<h3 id="ğŸŒŒè‡ªåŠ¨å¡«å……"><a href="#ğŸŒŒè‡ªåŠ¨å¡«å……" class="headerlink" title="ğŸŒŒè‡ªåŠ¨å¡«å……"></a>ğŸŒŒè‡ªåŠ¨å¡«å……</h3><p>å¯¹äºæ™®é€šå­—æ®µ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">FieldFill</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* é»˜è®¤ä¸å¤„ç† */</span></span><br><span class="line">    DEFAULT,</span><br><span class="line">    <span class="comment">/* æ’å…¥å¡«å……å­—æ®µ */</span></span><br><span class="line">    INSERT,</span><br><span class="line">    <span class="comment">/*æ›´æ–°å¡«å……å­—æ®µ */</span></span><br><span class="line">    UPDATE,</span><br><span class="line">    <span class="comment">/* æ’å…¥å’Œæ›´æ–°å¡«å……å­—æ®µ */</span></span><br><span class="line">    INSERT_UPDATE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æ‰€æœ‰çš„æ•°æ®åº“è¡¨éƒ½åº”è¯¥åŒ…å«åˆ›å»ºæ—¶é—´gmt_createå’Œä¿®æ”¹æ—¶é—´gmt_modifiedï¼Œè€Œä¸”éœ€è¦è‡ªåŠ¨åŒ–ã€‚â€”â€”ã€Šé˜¿é‡Œå·´å·´å¼€å‘æ‰‹å†Œã€‹</p>
<blockquote>
<p>ğŸ›¢æ•°æ®åº“çº§åˆ«</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> <span class="keyword">ADD</span> update_time DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> <span class="keyword">ADD</span> create_time DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>âŒ¨ï¸ä»£ç çº§åˆ«</p>
</blockquote>
<ul>
<li>æ•°æ®è¡¨æ·»åŠ å­—æ®µ</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> <span class="keyword">ADD</span> update_time DATETIME;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> <span class="keyword">ADD</span> create_time DATETIME;</span><br></pre></td></tr></table></figure>

<ul>
<li>å®ä½“ç±»æ·»åŠ å­—æ®µå’Œæ³¨è§£</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableField(fill = FieldFill.INSERT)</span></span><br><span class="line"><span class="keyword">private</span> Date createTime;</span><br><span class="line"><span class="meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span></span><br><span class="line"><span class="keyword">private</span> Date updateTime;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¼–å†™å¤„ç†å™¨å¤„ç†æ³¨è§£</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.reflection.MetaObject;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: Mybatis-plus &lt;/P&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.handler &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: DataObjectHandler &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: è‡ªåŠ¨å¡«å……å¤„ç†å™¨ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/9</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataObjectHandler</span> <span class="keyword">implements</span> <span class="title">MetaObjectHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æ’å…¥æ—¶çš„å¡«å……ç­–ç•¥&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metaObject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">&quot;createTime&quot;</span>, <span class="keyword">new</span> Date(), metaObject);</span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">&quot;updateTime&quot;</span>, <span class="keyword">new</span> Date(), metaObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æ›´æ–°æ—¶çš„å¡«å……ç­–ç•¥&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metaObject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">&quot;updateTime&quot;</span>, <span class="keyword">new</span> Date(), metaObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br />

<h3 id="ğŸ”æ‚²è§‚é”"><a href="#ğŸ”æ‚²è§‚é”" class="headerlink" title="ğŸ”æ‚²è§‚é”"></a>ğŸ”æ‚²è§‚é”</h3><blockquote>
<p>ğŸ“–ç†è§£</p>
</blockquote>
<p>å½“è¦å¯¹æ•°æ®åº“çš„ä¸€æ¡æ•°æ®è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…åŒæ—¶è¢«å…¶ä»–äººä¿®æ”¹ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯ç›´æ¥å¯¹æ•°æ®è¿›è¡ŒåŠ é”é˜²æ­¢å¹¶å‘ã€‚</p>
<p>è¿™ç§å€ŸåŠ©æ•°æ®åº“é”æœºåˆ¶ï¼Œåœ¨ä¿®æ”¹æ•°æ®ä¹‹å‰å…ˆé”å®šï¼Œå†ä¿®æ”¹çš„æ–¹å¼è¢«ç§°ä¸ºæ‚²è§‚å¹¶å‘æ§åˆ¶(Pessimistic Concurrency Controlï¼Œç¼©å†™PCCï¼Œåˆåæ‚²è§‚é”)ã€‚</p>
<blockquote>
<p>ğŸ’ å®ç°</p>
</blockquote>
<p>æ‚²è§‚é”çš„å®ç°ï¼Œå¾€å¾€ä¾é æ•°æ®åº“æä¾›çš„é”æœºåˆ¶(åªæœ‰æ•°æ®åº“å±‚æä¾›çš„é”æœºåˆ¶æ‰èƒ½çœŸæ­£ä¿è¯æ•°æ®è®¿é—®çš„æ’ä»–æ€§ï¼Œå¦åˆ™ï¼Œå³ä½¿åœ¨æœ¬ç³»ç»Ÿä¸­å®ç°äº†åŠ é”æœºåˆ¶ï¼Œä¹Ÿæ— æ³•ä¿è¯å¤–éƒ¨ç³»ç»Ÿä¸ä¼šä¿®æ”¹æ•°æ®)ã€‚æ‚²è§‚é”çš„å®ç°ï¼š</p>
<ul>
<li>ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ä½¿ç”¨è¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ã€è¡¨é”ã€è¯»é”ã€å†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨åšæ“ä½œä¹‹å‰å…ˆä¸Šé”</li>
<li>Javaé‡Œé¢çš„åŒæ­¥<code>synchronized</code>å…³é”®å­—çš„å®ç°</li>
<li><code>JUC</code>ä¸­çš„<code>lock</code>åŠ é”</li>
</ul>
<blockquote>
<p>ğŸ”±åˆ†ç±» </p>
</blockquote>
<ul>
<li>å…±äº«é”ï¼šåˆç§°ä¸ºè¯»é”ï¼Œç®€ç§°Sé”ã€‚é¡¾åæ€ä¹‰ï¼Œå…±äº«é”å°±æ˜¯å¤šä¸ªäº‹åŠ¡å¯¹äºåŒä¸€ä¸ªæ•°ä¹å¯ä»¥å…±äº«ä¸€æŠŠé”ï¼Œéƒ½èƒ½è®¿é—®åˆ°æ•°æ®ï¼Œä½†æ˜¯åªèƒ½è¯»ä¸èƒ½ä¿®æ”¹ã€‚</li>
<li>æ’ä»–é”ï¼šåˆç§°ä¸ºå†™é”ï¼Œç®€ç§°Xé”ã€‚é¡¾åæ€ä¹‰ï¼Œæ’ä»–é”å°±æ˜¯ä¸èƒ½ä¸å…¶ä»–é”å¹¶å­˜ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡è·å–äº†ä¸€ä¸ªæ•°æ®è¡Œçš„æ’å®ƒé”ï¼Œå…¶ä»–äº‹åŠ¡å°±ä¸èƒ½å†è·å–è¯¥è¡Œçš„å…¶ä»–é”ï¼ŒåŒ…æ‹¬å…±äº«é”å’Œæ’ä»–é”ï¼Œä½†æ˜¯è·å–åˆ°æ’ä»–é”çš„äº‹åŠ¡å¯ä»¥å¯¹æ•°æ®è¿›è¡Œè¯»å–å’Œä¿®æ”¹ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>æ‚²è§‚å¹¶å‘æ§åˆ¶å®è´¨ä¸Šæ˜¯<strong>å…ˆå–é”å†è®¿é—®</strong>çš„ä¿å®ˆç­–ç•¥ï¼Œä¸ºæ•°æ®å¤„ç†çš„å®‰å…¨æä¾›äº†ä¿è¯ã€‚</p>
<p>ä½†æ˜¯åœ¨æ•ˆç‡æ–¹é¢ï¼Œå¤„ç†åŠ é”çš„æœºåˆ¶ä¼šè®©æ•°æ®åº“äº§ç”Ÿé¢å¤–çš„å¼€é”€ï¼Œè¿˜æœ‰å¢åŠ äº§ç”Ÿæ­»é”çš„æœºä¼šã€‚</p>
<p>å¦å¤–è¿˜ä¼šé™ä½å¹¶è¡Œæ€§ï¼Œä¸€ä¸ªäº‹åŠ¡å¦‚æœé”å®šäº†æŸè¡Œæ•°æ®ï¼Œå…¶ä»–äº‹åŠ¡å°±å¿…é¡»ç­‰å¾…è¯¥äº‹åŠ¡å¤„ç†å®Œæ‰å¯ä»¥å¤„ç†é‚£è¡Œæ•°æ®ã€‚</p>
<br />

<h3 id="ğŸ”“ä¹è§‚é”"><a href="#ğŸ”“ä¹è§‚é”" class="headerlink" title="ğŸ”“ä¹è§‚é”"></a>ğŸ”“ä¹è§‚é”</h3><blockquote>
<p>ğŸ“–ç†è§£</p>
</blockquote>
<p>ä¹è§‚é”å‡è®¾æ•°æ®åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šé€ æˆå†²çªï¼Œæ‰€ä»¥åœ¨æ•°æ®è¿›è¡Œæäº¤æ›´æ–°çš„æ—¶å€™ï¼Œæ‰ä¼šæ­£å¼å¯¹æ•°æ®çš„å†²çªä¸å¦è¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœå‘ç°å†²çªäº†ï¼Œåˆ™è¿”å›ç»™ç”¨æˆ·é”™è¯¯çš„ä¿¡æ¯ï¼Œè®©ç”¨æˆ·å†³å®šå¦‚ä½•å»åšã€‚ä¹è§‚é”é€‚ç”¨äºè¯»æ“ä½œå¤šçš„åœºæ™¯ï¼Œè¿™æ ·å¯ä»¥æé«˜ç¨‹åºçš„ååé‡ã€‚</p>
<blockquote>
<p>ğŸ’ å®ç°</p>
</blockquote>
<p>ä¹è§‚é”ä¸ä¼šå¯ä»¥ä½¿ç”¨æ•°æ®åº“æœ¬èº«çš„é”æœºåˆ¶ï¼Œè€Œæ˜¯ä¾æ®æ•°æ®æœ¬èº«æ¥ä¿è¯æ•°æ®çš„æ­£ç¡®æ€§ã€‚ä¹è§‚é”çš„å®ç°ï¼š</p>
<ul>
<li><p>CASå®ç°ï¼š<code>Java </code>ä¸­<code>java.concurrent.atomic</code>åŒ…ä¸‹é¢çš„åŸå­å˜é‡ä½¿ç”¨äº†ä¹è§‚é”çš„ä¸€ç§ <code>CAS</code> å®ç°æ–¹å¼</p>
</li>
<li><p>ç‰ˆæœ¬å·æ§åˆ¶ï¼šä¸€èˆ¬æ˜¯åœ¨æ•°æ®è¡¨ä¸­æ·»åŠ ä¸€ä¸ªæ•°æ®ç‰ˆæœ¬å·<code>version</code>å­—æ®µï¼Œè¡¨ç¤ºæ•°æ®è¢«ä¿®æ”¹çš„æ¬¡æ•°ã€‚å½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œ<code>version</code>å€¼ä¼š+1ã€‚å½“çº¿ç¨‹Aæ›´æ–°æ•°æ®å€¼æ—¶ï¼Œåœ¨è¯»å–æ•°æ®çš„åŒæ—¶ä¹Ÿä¼šè¯»å–<code>version</code>å€¼ï¼Œåœ¨æäº¤æ›´æ–°æ—¶ï¼Œè‹¥åˆšæ‰è¯»å–åˆ°<code>version</code>å€¼ä¸å½“å‰æ•°æ®åº“ä¸­çš„<code>version</code>å€¼ç›¸ç­‰æ—¶æ‰æ›´æ–°ï¼Œå¦åˆ™é‡è¯•æ›´æ–°æ“ä½œï¼Œç›´åˆ°æ›´æ–°æˆåŠŸã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 1 æŸ¥è¯¢ç‰ˆæœ¬å·</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">version</span> <span class="keyword">as</span> oldversion <span class="keyword">where</span> <span class="keyword">id</span> = <span class="comment">#&#123;id&#125;</span></span><br><span class="line"><span class="comment">-- 2 æ›´æ–°æ“ä½œ</span></span><br><span class="line"><span class="keyword">update</span> <span class="keyword">set</span> ... , <span class="keyword">version</span> = <span class="keyword">version</span>  + <span class="number">1</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="comment">#&#123;id&#125;  and version = oldversion</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>ä¹è§‚å¹¶å‘æ§åˆ¶ç›¸ä¿¡äº‹åŠ¡ä¹‹é—´çš„æ•°æ®ç«äº‰æ¦‚ç‡æ˜¯æ¯”è¾ƒå°çš„ã€‚å› æ­¤å°½å¯èƒ½ç›´æ¥åšä¸‹å»ï¼Œç›´åˆ°æäº¤çš„æ—¶å€™æ‰å»é”å®šï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿä»»ä½•é”æˆ–æ­»é”ã€‚</p>
<blockquote>
<p>ğŸ”§æ’ä»¶</p>
</blockquote>
<ul>
<li>æ•°æ®è¡¨æ·»åŠ å­—æ®µ</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> <span class="keyword">ADD</span> <span class="keyword">version</span> <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>; </span><br></pre></td></tr></table></figure>

<ul>
<li>å®ä½“ç±»æ·»åŠ å±æ€§å’Œæ³¨è§£</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* ä¹è§‚é” */</span></span><br><span class="line"><span class="meta">@Version</span></span><br><span class="line"><span class="keyword">private</span> Integer version;</span><br></pre></td></tr></table></figure>

<ul>
<li>åœ¨mybatis-plusé…ç½®ç±»ä¸­å¢åŠ ä¹è§‚é”æ‹¦æˆªå™¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        MybatisPlusInterceptor mybatisPlusInterceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">        <span class="comment">/* ä¹è§‚é”æ’ä»¶ */</span></span><br><span class="line">        mybatisPlusInterceptor.addInnerInterceptor(<span class="keyword">new</span> OptimisticLockerInnerInterceptor());</span><br><span class="line">        <span class="keyword">return</span> mybatisPlusInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¹è§‚é”æµ‹è¯•</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;ä¹è§‚é”æµ‹è¯•1&lt;/p&gt;</span></span><br><span class="line"><span class="comment">    */</span>    </span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">optimisticLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// æŸ¥è¯¢ä¿¡æ¯</span></span><br><span class="line">       User user1 = userMapper.selectById(<span class="number">10L</span>);</span><br><span class="line">       <span class="comment">// ä¿®æ”¹ä¿¡æ¯</span></span><br><span class="line">       user1.setName(<span class="string">&quot;Khighness10&quot;</span>);</span><br><span class="line">       user1.setAge(<span class="number">10</span>);</span><br><span class="line">       user1.setEmail(<span class="string">&quot;khighness10@qq.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// æ’é˜Ÿæ“ä½œ: æŠ¢å…ˆæ›´æ–°ï¼Œä¼šæ›´æ–°ç‰ˆæœ¬å·</span></span><br><span class="line">       User user2 = userMapper.selectById(<span class="number">10L</span>);</span><br><span class="line">       user2.setAge(<span class="number">100</span>);</span><br><span class="line">       userMapper.updateById(user2);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// æ‰§è¡Œæ›´æ–°ï¼šæ›´æ–°å¤±è´¥ï¼Œç‰ˆæœ¬å·ä¸å¯¹</span></span><br><span class="line">       userMapper.updateById(user1);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># æµ‹è¯•ç»“æœ</span><br><span class="line">JDBC Connection [HikariProxyConnection@597623166 wrapping com.mysql.cj.jdbc.ConnectionImpl@38cedb7d] will not be managed by Spring</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: SELECT id,name,age,email,create_time,update_time,version FROM user WHERE id&#x3D;? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 10(Long)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name, age, email, create_time, update_time, version</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 10, Khighness10, 10, khighness10@qq.com, 2020-11-09 13:30:04, 2020-11-09 13:35:49, 2</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@12a14b74]</span><br><span class="line">Creating a new SqlSession</span><br><span class="line">SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6a9344f5] was not registered for synchronization because synchronization is not active</span><br><span class="line">JDBC Connection [HikariProxyConnection@1434769862 wrapping com.mysql.cj.jdbc.ConnectionImpl@38cedb7d] will not be managed by Spring</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: SELECT id,name,age,email,create_time,update_time,version FROM user WHERE id&#x3D;? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 10(Long)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name, age, email, create_time, update_time, version</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 10, Khighness10, 10, khighness10@qq.com, 2020-11-09 13:30:04, 2020-11-09 13:35:49, 2</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6a9344f5]</span><br><span class="line">Creating a new SqlSession</span><br><span class="line">SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3234474] was not registered for synchronization because synchronization is not active</span><br><span class="line">JDBC Connection [HikariProxyConnection@1137013089 wrapping com.mysql.cj.jdbc.ConnectionImpl@38cedb7d] will not be managed by Spring</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: UPDATE user SET name&#x3D;?, age&#x3D;?, email&#x3D;?, create_time&#x3D;?, update_time&#x3D;?, version&#x3D;? WHERE id&#x3D;? AND version&#x3D;? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: Khighness10(String), 100(Integer), khighness10@qq.com(String), 2020-11-09 13:30:04.0(Timestamp), 2020-11-09 13:59:41.434(Timestamp), 3(Integer), 10(Long), 2(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Updates: 1   &#x2F;&#x2F; æ’é˜Ÿæ›´æ–°ï¼Œå½±å“è¡Œæ•°ä¸º1&#x3D;&gt;æˆåŠŸ</span><br><span class="line">Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3234474]</span><br><span class="line">Creating a new SqlSession</span><br><span class="line">SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@58658f63] was not registered for synchronization because synchronization is not active</span><br><span class="line">JDBC Connection [HikariProxyConnection@1424043852 wrapping com.mysql.cj.jdbc.ConnectionImpl@38cedb7d] will not be managed by Spring</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: UPDATE user SET name&#x3D;?, age&#x3D;?, email&#x3D;?, create_time&#x3D;?, update_time&#x3D;?, version&#x3D;? WHERE id&#x3D;? AND version&#x3D;? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: Khighness10(String), 10(Integer), khighness10@qq.com(String), 2020-11-09 13:30:04.0(Timestamp), 2020-11-09 13:59:41.45(Timestamp), 3(Integer), 10(Long), 2(Integer)</span><br><span class="line">&lt;&#x3D;&#x3D;    Updates: 0   &#x2F;&#x2F; æ‰§è¡Œæ›´æ–°ï¼Œå½±å“è¡Œæ•°ä¸º0&#x3D;&gt;å¤±è´¥</span><br><span class="line">Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@58658f63]</span><br></pre></td></tr></table></figure>

<br />

<h3 id="ğŸ”–åˆ†é¡µæŸ¥è¯¢"><a href="#ğŸ”–åˆ†é¡µæŸ¥è¯¢" class="headerlink" title="ğŸ”–åˆ†é¡µæŸ¥è¯¢"></a>ğŸ”–åˆ†é¡µæŸ¥è¯¢</h3><ul>
<li>mybatis-plusé…ç½®ç±»ä¸­å¢åŠ åˆ†é¡µæ‹¦æˆªå™¨</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        MybatisPlusInterceptor mybatisPlusInterceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">        <span class="comment">/* åˆ†é¡µæ’ä»¶ */</span></span><br><span class="line">        mybatisPlusInterceptor.addInnerInterceptor(<span class="keyword">new</span> PaginationInnerInterceptor(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> mybatisPlusInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç›´æ¥ä½¿ç”¨<code>Page</code>å¯¹è±¡</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†é¡µæŸ¥è¯¢ï¼Œä½¿ç”¨page</span></span><br><span class="line"><span class="comment"> * æ„é€ å‡½æ•°Page(current, size)</span></span><br><span class="line"><span class="comment"> * current: é¡µå·</span></span><br><span class="line"><span class="comment"> * size: é¡µé¢å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">page</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Page&lt;User&gt; userPage = <span class="keyword">new</span> Page&lt;&gt;(<span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line">    userMapper.selectPage(userPage, <span class="keyword">null</span>);</span><br><span class="line">    log.info(<span class="string">&quot;æ€»è®°å½•æ•°é‡: &#123;&#125;&quot;</span>, userPage.getTotal());</span><br><span class="line">    log.info(<span class="string">&quot;ç¬¬3é¡µç»“æœå¦‚ä¸‹&quot;</span>);</span><br><span class="line">    userPage.getRecords().stream().forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># æµ‹è¯•ç»“æœ</span><br><span class="line">Creating a new SqlSession</span><br><span class="line">SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@d5556bf] was not registered for synchronization because synchronization is not active</span><br><span class="line">2020-11-09 15:44:02.969  INFO 6560 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...</span><br><span class="line">2020-11-09 15:44:03.107  INFO 6560 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.</span><br><span class="line">JDBC Connection [HikariProxyConnection@2068279617 wrapping com.mysql.cj.jdbc.ConnectionImpl@784223e9] will not be managed by Spring</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: SELECT COUNT(1) FROM user</span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: </span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: COUNT(1)</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 12</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 1</span><br><span class="line">&#x3D;&#x3D;&gt;  Preparing: SELECT id,name,age,email,create_time,update_time,version FROM user LIMIT ?,?</span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 6(Long), 3(Long)</span><br><span class="line">&lt;&#x3D;&#x3D;    Columns: id, name, age, email, create_time, update_time, version</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 7, UnknownK, 3, unknownk@gmail.@32423.com, 2020-11-09 15:33:38, 2020-11-09 15:33:38, 1</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 8, UnknownK, 3, unknownk@gmail.@32423.com, 2020-11-09 15:33:38, 2020-11-09 15:33:38, 1</span><br><span class="line">&lt;&#x3D;&#x3D;        Row: 9, UnknownK, 3, unknownk@gmail.com, 2020-11-09 13:28:49, 2020-11-09 13:28:49, 1</span><br><span class="line">&lt;&#x3D;&#x3D;      Total: 3</span><br><span class="line">Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@d5556bf]</span><br><span class="line">2020-11-09 15:44:03.170  INFO 6560 --- [           main] top.parak.mapper.UserMapperTest          : æ€»è®°å½•æ•°é‡: 12</span><br><span class="line">2020-11-09 15:44:03.170  INFO 6560 --- [           main] top.parak.mapper.UserMapperTest          : ç¬¬3é¡µç»“æœå¦‚ä¸‹</span><br><span class="line">User(id&#x3D;7, name&#x3D;UnknownK, age&#x3D;3, email&#x3D;unknownk@gmail.@32423.com, createTime&#x3D;Mon Nov 09 15:33:38 CST 2020, updateTime&#x3D;Mon Nov 09 15:33:38 CST 2020, version&#x3D;1)</span><br><span class="line">User(id&#x3D;8, name&#x3D;UnknownK, age&#x3D;3, email&#x3D;unknownk@gmail.@32423.com, createTime&#x3D;Mon Nov 09 15:33:38 CST 2020, updateTime&#x3D;Mon Nov 09 15:33:38 CST 2020, version&#x3D;1)</span><br><span class="line">User(id&#x3D;9, name&#x3D;UnknownK, age&#x3D;3, email&#x3D;unknownk@gmail.com, createTime&#x3D;Mon Nov 09 13:28:49 CST 2020, updateTime&#x3D;Mon Nov 09 13:28:49 CST 2020, version&#x3D;1)</span><br></pre></td></tr></table></figure>

<br />

<h3 id="ğŸ“›é€»è¾‘åˆ é™¤"><a href="#ğŸ“›é€»è¾‘åˆ é™¤" class="headerlink" title="ğŸ“›é€»è¾‘åˆ é™¤"></a>ğŸ“›é€»è¾‘åˆ é™¤</h3><blockquote>
<p>ç‰©ç†åˆ é™¤ï¼šä»æ•°æ®åº“ä¸­ç›´æ¥åˆ é™¤ã€‚</p>
<p>é€»è¾‘åˆ é™¤ï¼šä¸ä»æ•°æ®åº“ä¸­ç§»é™¤ï¼Œé€šè¿‡ä¸€ä¸ªå˜é‡ä½¿å…¶å¤±æ•ˆã€‚å®è´¨ä¸Šæ˜¯æ›´æ–°ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚</p>
</blockquote>
<ul>
<li>æ•°æ®åº“æ·»åŠ å­—æ®µ</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="keyword">user</span> <span class="keyword">ADD</span> deleted </span><br></pre></td></tr></table></figure>
<ul>
<li>å®ä½“ç±»æ·»åŠ å±æ€§å’Œæ³¨è§£</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* é€»è¾‘åˆ é™¤ */</span></span><br><span class="line"><span class="meta">@TableLogic</span></span><br><span class="line"><span class="keyword">private</span> Integer deleted;</span><br></pre></td></tr></table></figure>

<ul>
<li>Application.propertiesä¸­å¢åŠ é…ç½®</li>
</ul>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é€»è¾‘åˆ é™¤</span></span><br><span class="line"><span class="meta">mybatis-plus.global-config.db-config.logic-delete-value</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">mybatis-plus.global-config.db-config.logic-not-delete-value</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>

<br />

<h3 id="ğŸ”æ€§èƒ½åˆ†æ"><a href="#ğŸ”æ€§èƒ½åˆ†æ" class="headerlink" title="ğŸ”æ€§èƒ½åˆ†æ"></a><del>ğŸ”æ€§èƒ½åˆ†æ</del></h3><p>3.4.Xç‰ˆæœ¬ä¸­è¯¥æ’ä»¶å·²ç»ç§»é™¤ã€‚</p>
<br />

<h3 id="ğŸ’¤æ¡ä»¶æ„é€ å™¨"><a href="#ğŸ’¤æ¡ä»¶æ„é€ å™¨" class="headerlink" title="ğŸ’¤æ¡ä»¶æ„é€ å™¨"></a>ğŸ’¤æ¡ä»¶æ„é€ å™¨</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/fd1960c6/image-20201112160607792.png" class="" title="image-20201112160607792"><br />

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WrapperTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        <span class="comment">// å§“åä¸ä¸ºç©º</span></span><br><span class="line">        <span class="comment">// é‚®ç®±ä¸ä¸ºç©º</span></span><br><span class="line">        <span class="comment">// å¹´é¾„å¤§äºç­‰äº18</span></span><br><span class="line">        wrapper</span><br><span class="line">                .isNotNull(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">                .isNotNull(<span class="string">&quot;email&quot;</span>)</span><br><span class="line">                .ge(<span class="string">&quot;age&quot;</span>, <span class="number">18</span>);</span><br><span class="line">        userMapper.selectList(wrapper).stream().forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;RubbishK&quot;</span>);</span><br><span class="line">        <span class="comment">// åªèƒ½æŸ¥è¯¢ä¸€ä¸ªç”¨æˆ·ï¼Œç»“æœå¤šäº1ä¸ªä¼šæŠ¥é”™</span></span><br><span class="line">        System.out.println(userMapper.selectOne(wrapper));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢å¹´é¾„åœ¨13åˆ°19çš„ç”¨æˆ·æ•°é‡</span></span><br><span class="line">        wrapper.between(<span class="string">&quot;age&quot;</span>, <span class="number">13</span>, <span class="number">19</span>);</span><br><span class="line">        System.out.println(userMapper.selectCount(wrapper));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        <span class="comment">// æ¨¡ç³ŠæŸ¥è¯¢</span></span><br><span class="line">        wrapper</span><br><span class="line">                .likeRight(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;K&quot;</span>)  <span class="comment">// K%</span></span><br><span class="line">                .likeLeft(<span class="string">&quot;email&quot;</span>, <span class="string">&quot;@gmail.com&quot;</span>);  <span class="comment">// %@gmail.com</span></span><br><span class="line">        userMapper.selectList(wrapper).stream().forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        <span class="comment">// æ‹¼æ¥sqlè¯­å¥</span></span><br><span class="line">        wrapper.inSql(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;select id from user where id &lt; 3&quot;</span>);</span><br><span class="line">        userMapper.selectList(wrapper).stream().forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test6</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QueryWrapper&lt;User&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        <span class="comment">// é€šè¿‡IDé™åºæ’åº</span></span><br><span class="line">        wrapper.orderByDesc(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        userMapper.selectList(wrapper).stream().forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br />

<h3 id="ğŸ”°ä»£ç ç”Ÿæˆå™¨"><a href="#ğŸ”°ä»£ç ç”Ÿæˆå™¨" class="headerlink" title="ğŸ”°ä»£ç ç”Ÿæˆå™¨"></a>ğŸ”°ä»£ç ç”Ÿæˆå™¨</h3><blockquote>
<p>è‡ªåŠ¨ç”Ÿæˆ entityã€mapperã€serviceã€controllerå±‚çš„ä»£ç </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.generator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.FieldFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.TableField;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.AutoGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.InjectionConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.DataSourceConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.GlobalConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.PackageConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.StrategyConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.po.TableFill;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.DateType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: Mybatis-plus &lt;/P&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.generator &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: ParaKCode &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/12</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParaKCodeGenerator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä»£ç ç”Ÿæˆå™¨</span></span><br><span class="line">        AutoGenerator autoGenerator = <span class="keyword">new</span> AutoGenerator();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…¨å±€é…ç½®</span></span><br><span class="line">        GlobalConfig globalConfig = <span class="keyword">new</span> GlobalConfig();</span><br><span class="line">        String projectPath = System.getProperty(<span class="string">&quot;user.dir&quot;</span>);</span><br><span class="line">        globalConfig.setOutputDir(projectPath + <span class="string">&quot;/src/main/java&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®ä½œè€…å</span></span><br><span class="line">        globalConfig.setAuthor(<span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">        <span class="comment">// æ“ä½œå®Œæˆæ˜¯å¦æ‰“å¼€èµ„æºç®¡ç†å™¨</span></span><br><span class="line">        globalConfig.setOpen(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// æ˜¯å¦è¦†ç›–åŸæœ‰æ–‡ä»¶</span></span><br><span class="line">        globalConfig.setFileOverride(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// å»Serviceçš„Iå‰ç¼€</span></span><br><span class="line">        globalConfig.setServiceName(<span class="string">&quot;%sService&quot;</span>); </span><br><span class="line">        globalConfig.setIdType(IdType.ID_WORKER);</span><br><span class="line">        globalConfig.setDateType(DateType.ONLY_DATE);</span><br><span class="line">        autoGenerator.setGlobalConfig(globalConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ•°æ®æºé…ç½®</span></span><br><span class="line">        DataSourceConfig dataSourceConfig = <span class="keyword">new</span> DataSourceConfig();</span><br><span class="line">        dataSourceConfig.setDbType(DbType.MYSQL);</span><br><span class="line">        dataSourceConfig.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&quot;</span>);</span><br><span class="line">        dataSourceConfig.setDriverName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">        dataSourceConfig.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        dataSourceConfig.setPassword(<span class="string">&quot;KAG1823&quot;</span>);</span><br><span class="line">        autoGenerator.setDataSource(dataSourceConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŒ…é…ç½®</span></span><br><span class="line">        PackageConfig packageConfig = <span class="keyword">new</span> PackageConfig();</span><br><span class="line">        packageConfig.setModuleName(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        packageConfig.setParent(<span class="string">&quot;top.parak&quot;</span>);</span><br><span class="line">        packageConfig.setEntity(<span class="string">&quot;entity&quot;</span>);</span><br><span class="line">        packageConfig.setMapper(<span class="string">&quot;mapper&quot;</span>);</span><br><span class="line">        packageConfig.setService(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">        packageConfig.setController(<span class="string">&quot;controller&quot;</span>);</span><br><span class="line">        autoGenerator.setPackageInfo(packageConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç­–ç•¥é…ç½®</span></span><br><span class="line">        StrategyConfig strategyConfig = <span class="keyword">new</span> StrategyConfig();</span><br><span class="line">        <span class="comment">// æ˜ å°„è¡¨å</span></span><br><span class="line">        strategyConfig.setInclude(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        strategyConfig.setNaming(NamingStrategy.underline_to_camel);</span><br><span class="line">        strategyConfig.setColumnNaming(NamingStrategy.underline_to_camel);</span><br><span class="line">        <span class="comment">// Lombokå®ä½“ç±»</span></span><br><span class="line">        strategyConfig.setEntityLombokModel(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// é©¼å³°å‘½å</span></span><br><span class="line">        strategyConfig.setRestControllerStyle(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// é€»è¾‘åˆ é™¤</span></span><br><span class="line">        strategyConfig.setLogicDeleteFieldName(<span class="string">&quot;deleted&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ—¶é—´</span></span><br><span class="line">        TableFill gmt_create = <span class="keyword">new</span> TableFill(<span class="string">&quot;create_time&quot;</span>, FieldFill.INSERT);</span><br><span class="line">        <span class="comment">// æ›´æ–°æ—¶é—´</span></span><br><span class="line">        TableFill gmt_modify = <span class="keyword">new</span> TableFill(<span class="string">&quot;update_time&quot;</span>, FieldFill.INSERT);</span><br><span class="line">        List&lt;TableFill&gt; tableFills = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        tableFills.add(gmt_create);</span><br><span class="line">        tableFills.add(gmt_modify);</span><br><span class="line">        strategyConfig.setTableFillList(tableFills);</span><br><span class="line">        <span class="comment">// ä¹è§‚é”</span></span><br><span class="line">        strategyConfig.setVersionFieldName(<span class="string">&quot;version&quot;</span>);</span><br><span class="line">        strategyConfig.setControllerMappingHyphenStyle(<span class="keyword">true</span>);</span><br><span class="line">        autoGenerator.setStrategy(strategyConfig);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è‡ªå®šä¹‰é…ç½®</span></span><br><span class="line">        InjectionConfig injectionConfig = <span class="keyword">new</span> InjectionConfig() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œç”Ÿæˆ</span></span><br><span class="line">        autoGenerator.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>CRUD</category>
      </categories>
      <tags>
        <tag>Mybatis-plus</tag>
      </tags>
  </entry>
  <entry>
    <title>Regex</title>
    <url>/posts/83c5d7ce/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p>æ­£åˆ™è¡¨è¾¾å¼ï¼ŒRegular Expressionï¼Œä¸€ç§å­—ç¬¦ä¸²åŒ¹é…çš„æ¨¡å¼ã€‚</p>
<p>ç”¨é€”ï¼šæ–‡æœ¬çš„å¤æ‚å¤„ç†ï¼Œå¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€ã€æ•°æ®åº“ã€æ–‡æœ¬ç¼–è¾‘å™¨ã€å¼€å‘ç¯å¢ƒéƒ½æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ã€‚</p>
<blockquote>
<p>å¼€å‘ä¸­ä½¿ç”¨</p>
</blockquote>
<ul>
<li>åˆ†ææ‰€è¦åŒ¹é…çš„æ•°æ®ï¼Œå†™å‡ºæµ‹è¯•ç”¨çš„å…¸å‹æ•°æ®</li>
<li>åœ¨å·¥å…·è½¯ä»¶ä¸­è¿›è¡ŒåŒ¹é…æµ‹è¯•</li>
<li>åœ¨ç¨‹åºä¸­è°ƒç”¨æµ‹è¯•çš„æ­£åˆ™è¡¨è¾¾å¼</li>
</ul>
<h2 id="2-è¯­æ³•"><a href="#2-è¯­æ³•" class="headerlink" title="2. è¯­æ³•"></a>2. è¯­æ³•</h2><h3 id="2-1-æ ‡å‡†å­—ç¬¦é›†åˆ"><a href="#2-1-æ ‡å‡†å­—ç¬¦é›†åˆ" class="headerlink" title="2.1 æ ‡å‡†å­—ç¬¦é›†åˆ"></a>2.1 æ ‡å‡†å­—ç¬¦é›†åˆ</h3><ul>
<li>èƒ½å¤Ÿä¸â€å¤šç§å­—ç¬¦â€åŒ¹é…çš„è¡¨è¾¾å¼</li>
<li>æ³¨æ„åŒºåˆ†å¤§å°å†™ï¼Œå¤§å†™æ˜¯ç›¸åçš„æ„æ€</li>
</ul>
<table>
<thead>
<tr>
<th align="center">å­—ç¬¦</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\d</td>
<td align="center">ä»»æ„ä¸€ä¸ªæ•°å­—ï¼Œ0-9ä¸­çš„ä»»æ„ä¸€ä¸ª</td>
</tr>
<tr>
<td align="center">\w</td>
<td align="center">ä»»æ„ä¸€ä¸ªå­—æ¯æˆ–æ•°å­—æˆ–ä¸‹åˆ’çº¿ï¼Œä¹Ÿå°±æ˜¯A-Zã€a-zã€0-9ã€_ä¸­ä»»æ„ä¸€ä¸ª</td>
</tr>
<tr>
<td align="center">\s</td>
<td align="center">åŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ç­‰ç©ºç™½å­—ç¬¦çš„å…¶ä¸­ä¸€ä¸ª</td>
</tr>
<tr>
<td align="center">.</td>
<td align="center">å°æ•°ç‚¹å¯ä»¥åŒ¹é…ä»»æ„ä¸€ä¸ªå­—ç¬¦(é™¤äº†æ¢è¡Œç¬¦)ï¼Œ å¦‚æœè¦åŒ¹é…åŒ…æ‹¬â€\nâ€åœ¨å†…çš„æ‰€æœ‰å­—ç¬¦ï¼Œä¸€èˆ¬ç”¨<code>[\s\S]</code></td>
</tr>
</tbody></table>
<p>å¦‚æœè¦åŒ¹é…çœŸæ­£çš„â€™.â€™ã€â€™+â€™ã€â€™-â€˜ã€â€™\&#39; ï¼Œ å°±è¦è½¬ä¹‰ï¼Œç”¨<code>\.</code>ã€<code>\+</code>ã€<code>\-</code>ã€<code>\\</code></p>
<h3 id="2-2-è‡ªå®šä¹‰å­—ç¬¦é›†åˆ"><a href="#2-2-è‡ªå®šä¹‰å­—ç¬¦é›†åˆ" class="headerlink" title="2.2 è‡ªå®šä¹‰å­—ç¬¦é›†åˆ"></a>2.2 è‡ªå®šä¹‰å­—ç¬¦é›†åˆ</h3><ul>
<li>[]æ–¹æ‹¬å·åŒ¹é…æ–¹å¼ï¼Œèƒ½å¤ŸåŒ¹é…æ–¹æ‹¬å·ä¸­ä»»æ„ä¸€ä¸ªå­—ç¬¦</li>
<li>æ­£åˆ™è¡¨è¾¾å¼çš„ç‰¹æ®Šç¬¦å·ï¼Œè¢«åŒ…å«åˆ°ä¸­æ‹¬å·ä¸­ï¼Œåˆ™å¤±å»äº†ç‰¹æ®Šæ„ä¹‰ï¼Œé™¤äº†^ã€-ä¹‹å¤–</li>
<li>æ ‡å‡†å­—ç¬¦é›†åˆï¼Œé™¤å°æ•°ç‚¹å¤–ï¼Œå¦‚æœè¢«åŒ…å«äºä¸­æ‹¬å·ï¼Œè‡ªå®šä¹‰å­—ç¬¦é›†åˆè¢«åŒ…å«è¯¥é›†åˆ<ul>
<li>[\d.-+]å°†åŒ¹é…ï¼šæ•°å­—ã€å°æ•°ç‚¹ã€+ã€-</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ä¾‹å¦‚</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">[ab5@]</td>
<td align="center">åŒ¹é…â€aâ€æˆ–â€bâ€æˆ–â€5â€æˆ–â€@â€</td>
</tr>
<tr>
<td align="center">[^abc]</td>
<td align="center">åŒ¹é…â€aâ€ã€â€bâ€ã€â€câ€ä¹‹å¤–çš„ä»»æ„ä¸€ä¸ªå­—ç¬¦</td>
</tr>
<tr>
<td align="center">[f-k]</td>
<td align="center">åŒ¹é…â€fâ€-â€œkâ€ä¹‹é—´çš„ä»»æ„ä¸€ä¸ªå­—æ¯</td>
</tr>
<tr>
<td align="center">[^A-F0-3]</td>
<td align="center">åŒ¹é…â€Aâ€-â€œFâ€ã€â€0â€-â€œ3â€ä¹‹å¤–çš„ä»»æ„ä¸€ä¸ªå­—ç¬¦</td>
</tr>
</tbody></table>
<h3 id="2-3-é‡è¯"><a href="#2-3-é‡è¯" class="headerlink" title="2.3 é‡è¯"></a>2.3 é‡è¯</h3><ul>
<li>ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„ç‰¹æ®Šç¬¦å·</li>
<li>åŒ¹é…æ¬¡æ•°ä¸­çš„è´ªå©ªæ¨¡å¼(åŒ¹é…å­—ç¬¦è¶Šå¤šè¶Šå¥½ï¼Œé»˜è®¤)</li>
<li>åŒ¹é…æ¬¡æ•°ä¸­çš„éè´ªå©ªæ¨¡å¼(åŒ¹é…å­—ç¬¦è¶Šå°‘è¶Šå¥½ï¼Œåœ¨ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„ç‰¹æ®Šç¬¦å·åå†åŠ ä¸Šä¸€ä¸ªâ€?â€å·)</li>
</ul>
<table>
<thead>
<tr>
<th align="center">é‡è¯</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">{n}</td>
<td align="center">è¡¨è¾¾å¼é‡å¤næ¬¡</td>
</tr>
<tr>
<td align="center">{m,n}</td>
<td align="center">è¡¨è¾¾å¼è‡³å°‘é‡å¤mæ¬¡ï¼Œæœ€å¤šé‡å¤næ¬¡</td>
</tr>
<tr>
<td align="center">{m,}</td>
<td align="center">è¡¨è¾¾å¼è‡³å°‘é‡å¤mæ¬¡</td>
</tr>
<tr>
<td align="center">?</td>
<td align="center">è¡¨è¾¾å¼åŒ¹é…0æ¬¡æˆ–1æ¬¡ï¼Œç›¸å½“äº{0,1}</td>
</tr>
<tr>
<td align="center">+</td>
<td align="center">è¡¨è¾¾å¼è‡³å°‘å‡ºç°1æ¬¡ï¼Œç›¸å½“äº{1,}</td>
</tr>
<tr>
<td align="center">*</td>
<td align="center">è¡¨è¾¾å¼ä¸å‡ºç°æˆ–å‡ºç°ä»»æ„æ¬¡ï¼Œç›¸å½“äº{0,}</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li><code>[A-Za-z]+</code>å¯ä»¥åŒ¹é…å•è¯</li>
</ul>
<p>ä¾‹å¦‚æ–‡æœ¬ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">6ã€7ã€8ã€9ã€</span><br><span class="line">1ã€2ã€3ã€4ã€5ã€6ã€7ã€8ã€9ã€</span><br><span class="line">ab a1b a12b a123b a1234b a12345b </span><br></pre></td></tr></table></figure>

<p><code>(\dã€)&#123;1,3&#125;</code>çš„åŒ¹é…ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">6ã€7ã€8ã€</span><br><span class="line">9ã€</span><br><span class="line">1ã€2ã€3ã€</span><br><span class="line">4ã€5ã€6ã€</span><br><span class="line">7ã€8ã€9ã€</span><br></pre></td></tr></table></figure>

<p><code>(\dã€)&#123;1,3&#125;?</code>çš„åŒ¹é…ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">6ã€</span><br><span class="line">7ã€</span><br><span class="line">8ã€</span><br><span class="line">9ã€</span><br><span class="line">1ã€</span><br><span class="line">2ã€</span><br><span class="line">3ã€</span><br><span class="line">4ã€</span><br><span class="line">5ã€</span><br><span class="line">6ã€</span><br><span class="line">7ã€</span><br><span class="line">8ã€</span><br><span class="line">9ã€</span><br></pre></td></tr></table></figure>

<p><code>a\d?b</code>çš„åŒ¹é…ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ab</span><br><span class="line">a1b</span><br></pre></td></tr></table></figure>

<p><code>a\d+b</code>çš„åŒ¹é…ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a1b</span><br><span class="line">a12b</span><br><span class="line">a123b</span><br><span class="line">a1234b</span><br><span class="line">a12345b</span><br></pre></td></tr></table></figure>

<p><code>a\d-b</code>çš„åŒ¹é…ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ab</span><br><span class="line">a1b</span><br><span class="line">a12b</span><br><span class="line">a123b</span><br><span class="line">a1234b</span><br><span class="line">a12345b</span><br></pre></td></tr></table></figure>



<h3 id="2-4-å­—ç¬¦è¾¹ç•Œ"><a href="#2-4-å­—ç¬¦è¾¹ç•Œ" class="headerlink" title="2.4 å­—ç¬¦è¾¹ç•Œ"></a>2.4 å­—ç¬¦è¾¹ç•Œ</h3><table>
<thead>
<tr>
<th align="center">å­—ç¬¦</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">^</td>
<td align="center">ä¸å­—ç¬¦ä¸²å¼€å§‹çš„åœ°æ–¹åŒ¹é…</td>
</tr>
<tr>
<td align="center">$</td>
<td align="center">ä¸å­—ç¬¦ä¸²ç»“æŸçš„åœ°æ–¹åŒ¹é…</td>
</tr>
<tr>
<td align="center">\b</td>
<td align="center">åŒ¹é…ä¸€ä¸ªå•è¯è¾¹ç•Œ</td>
</tr>
</tbody></table>
<p><code>\b</code>åŒ¹é…è¿™æ ·ä¸€ä¸ªä½ç½®ï¼šå‰é¢çš„å­—ç¬¦å’Œåé¢çš„å­—ç¬¦ä¸å…¨æ˜¯\wã€‚</p>
<p>ä¾‹å¦‚æ–‡æœ¬:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Khighness </span><br><span class="line">Khighness1 Khighness2</span><br><span class="line">3Khighness </span><br><span class="line">4Khighness </span><br><span class="line">Khighness5 Khighness6</span><br><span class="line">7Khighness </span><br><span class="line">8Khighness</span><br></pre></td></tr></table></figure>

<p><code>^K</code>åŒ¹é…æœ€åˆçš„â€Kâ€ï¼Œ<code>s$</code>åŒ¹é…æœ€åçš„â€sâ€ï¼›</p>
<p><code>Khighness\b</code>åŒ¹é…ç¬¬1ã€3ã€4ã€6ã€7è¡Œçš„â€Khighnessâ€ï¼›</p>
<p><code>\bKhighness</code>åŒ¹é…ç¬¬1ã€2ã€5è¡Œçš„â€Khighnessâ€ï¼›</p>
<p><code>\bKhighness\b</code>åŒ¹é…ç¬¬1è¡Œçš„â€Khighnessâ€ã€‚</p>
<h3 id="2-5-åŒ¹é…æ¨¡å¼"><a href="#2-5-åŒ¹é…æ¨¡å¼" class="headerlink" title="2.5 åŒ¹é…æ¨¡å¼"></a>2.5 åŒ¹é…æ¨¡å¼</h3><ul>
<li>IGNORECASE-å¿½ç•¥å¤§å°å†™æ¨¡å¼<ul>
<li>åŒ¹é…æ—¶å¿½ç•¥å¤§å°å†™</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­£åˆ™è¡¨è¾¾å¼æ˜¯è¦åŒºåˆ†å¤§å°å†™çš„</li>
</ul>
</li>
<li>SINGLELINE-å•è¡Œæ¨¡å¼<ul>
<li>æ•´ä¸ªæ–‡æœ¬çœ‹åšä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåªæœ‰ä¸€ä¸ªå¼€å¤´ï¼Œä¸€ä¸ªç»“å°¾</li>
<li>ä½¿å°æ•°ç‚¹â€.â€å¯ä»¥åŒ¹é…åŒ…å«æ¢è¡Œç¬¦(\n)åœ¨å†…çš„ä»»æ„å­—ç¬¦</li>
</ul>
</li>
<li>MULTILINE-å¤šè¡Œæ¨¡å¼<ul>
<li>æ¯è¡Œéƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œéƒ½æœ‰å¼€å¤´å’Œç»“å°¾</li>
<li>åœ¨æŒ‡å®šäº†MULTILINEä¹‹åï¼Œå¦‚æœéœ€è¦ä»…åŒ¹é…å­—ç¬¦ä¸²å¼€å§‹å’Œç»“æŸä¸ºæ­¢ï¼Œå¯ä»¥ä½¿ç”¨<code>\A</code>å’Œ<code>\Z</code></li>
</ul>
</li>
</ul>
<h3 id="2-7-é€‰æ‹©ç¬¦å’Œåˆ†ç»„"><a href="#2-7-é€‰æ‹©ç¬¦å’Œåˆ†ç»„" class="headerlink" title="2.7 é€‰æ‹©ç¬¦å’Œåˆ†ç»„"></a>2.7 é€‰æ‹©ç¬¦å’Œåˆ†ç»„</h3><table>
<thead>
<tr>
<th align="center">è¡¨è¾¾å¼</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">åˆ†æ”¯ç»“æ„: |</td>
<td align="center">å·¦å³ä¸¤è¾¹è¡¨è¾¾å¼ä¹‹é—´â€œæˆ–â€å…³ç³»ï¼ŒåŒ¹é…å·¦è¾¹æˆ–è€…å³è¾¹</td>
</tr>
<tr>
<td align="center">æ•è·ç»„: ()</td>
<td align="center">(1) åœ¨è¢«ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„æ—¶å€™ï¼Œæ‹¬å·ä¸­çš„è¡¨è¾¾å¼å¯ä»¥ä½œä¸ºæ•´ä½“è¢«ä¿®é¥°; (2) å–åŒ¹é…ç»“æœçš„æ—¶å€™ï¼Œæ‹¬å·ä¸­çš„è¡¨è¾¾å¼åŒ¹é…åˆ°çš„å†…å®¹å¯ä»¥è¢«å•ç‹¬å¾—åˆ°; (3) æ¯ä¸€å¯¹æ‹¬å·ä¼šåˆ†é…ä¸€ä¸ªç¼–å·ï¼Œä½¿ç”¨()çš„æ•è·æ ¹æ®å·¦æ‹¬å·çš„é¡ºåºä»1å¼€å§‹è‡ªåŠ¨ç¼–å·ã€‚æ•è·å…ƒç´ ç¼–å·ä¸ºé›¶çš„ç¬¬ä¸€ä¸ªæ•è·æ˜¯ç”±æ•´ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…çš„æ–‡æœ¬</td>
</tr>
<tr>
<td align="center">éæ•è·ç»„: (?:Exception)</td>
<td align="center">ä¸€äº›è¡¨è¾¾å¼ä¸­ï¼Œä¸å¾—ä¸ä½¿ç”¨()ï¼Œä½†åˆä¸éœ€è¦ä¿å­˜()ä¸­å­è¡¨è¾¾å¼åŒ¹é…çš„å†…å®¹ï¼Œè¿™æ—¶å¯ä»¥ç”¨éæ•è·ç»„æ¥æŠµæ¶ˆä½¿ç”¨()å¸¦æ¥çš„å‰¯ä½œç”¨</td>
</tr>
</tbody></table>
<p>åå‘å¼•ç”¨(\num)ï¼šæ¯ä¸€å¯¹()ä¼šåˆ†é…ä¸€ä¸ªç¼–å·ï¼Œä½¿ç”¨()çš„æ•è·æ¨¡å¼</p>
<p>ä¾‹å¦‚<code>([a-z]&#123;2&#125;)\1</code>å¯ä»¥åŒ¹é…ç±»ä¼¼â€ababâ€ã€â€gogoâ€ã€â€totoâ€çš„å­—ç¬¦ä¸²ã€‚</p>
<h3 id="2-8-é¢„æœç´¢-é›¶å®½æ–­è¨€"><a href="#2-8-é¢„æœç´¢-é›¶å®½æ–­è¨€" class="headerlink" title="2.8 é¢„æœç´¢(é›¶å®½æ–­è¨€)"></a>2.8 é¢„æœç´¢(é›¶å®½æ–­è¨€)</h3><ul>
<li>åªè¿›è¡Œå­è¡¨è¾¾å¼çš„åŒ¹é…ï¼ŒåŒ¹é…å†…å®¹ä¸è®¡å…¥æœ€ç»ˆçš„åŒ¹é…ç»“æœï¼Œæ˜¯é›¶å®½åº¦</li>
<li>è¿™ä¸ªä½ç½®åº”è¯¥ç¬¦åˆæŸä¸ªæ¡ä»¶ã€‚åˆ¤æ–­å½“å‰ä½ç½®çš„å‰åå­—ç¬¦ï¼Œæ˜¯å¦ç¬¦åˆæŒ‡å®šçš„æ¡ä»¶ï¼Œä½†ä¸åŒ¹é…å‰åçš„å­—ç¬¦ã€‚æ˜¯å¯¹ä½ç½®çš„åŒ¹é…</li>
<li>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå­è¡¨è¾¾å¼åŒ¹é…åˆ°çš„æ˜¯å­—ç¬¦å†…å®¹ï¼Œè€Œéä½ç½®ï¼Œå¹¶è¢«ä¿å­˜åˆ°æœ€ç»ˆçš„åŒ¹é…ç»“æœä¸­ï¼Œé‚£ä¹ˆä¹…è®¤ä¸ºè¿™ä¸ªå­è¡¨è¾¾å¼æ˜¯å æœ‰å­—ç¬¦çš„ï¼›å¦‚æœå­è¡¨è¾¾å¼åŒ¹é…çš„ä»…ä»…æ˜¯ä½ç½®ï¼Œæˆ–è€…åŒ¹é…çš„å†…å®¹å¹¶ä¸ä¿å­˜åˆ°æœ€ç»ˆçš„åŒ¹é…ç»“æœä¸­ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè¿™ä¸ªå­è¡¨è¾¾å¼æ˜¯é›¶å®½åº¦çš„ã€‚å æœ‰å­—ç¬¦è¿˜æ˜¯é›¶å®½åº¦ï¼Œæ˜¯é’ˆå¯¹åŒ¹é…çš„å†…å®¹å±å¦ä¿å­˜åˆ°æœ€ç»ˆçš„åŒ¹é…ç»“æœä¸­è€Œè¨€çš„ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th align="center">è¡¨è¾¾å¼</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">(?=exp)</td>
<td align="center">æ–­è¨€è‡ªèº«å‡ºç°çš„ä½ç½®çš„åé¢èƒ½åŒ¹é…è¡¨è¾¾å¼exp</td>
</tr>
<tr>
<td align="center">(?&lt;=exp)</td>
<td align="center">æ–­è¨€è‡ªèº«å‡ºç°çš„ä½ç½®çš„å‰é¢èƒ½åŒ¹é…è¡¨è¾¾å¼exp</td>
</tr>
<tr>
<td align="center">(?!exp)</td>
<td align="center">æ–­è¨€æ­¤ä½ç½®çš„åé¢ä¸èƒ½åŒ¹é…è¡¨è¾¾å¼exp</td>
</tr>
<tr>
<td align="center">(?&lt;exp)</td>
<td align="center">æ–­è¨€æ­¤ä½ç½®çš„å‰é¢ä¸èƒ½åŒ¹é…è¡¨è¾¾å¼exp</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li><p><code>[A-Za-z]+(?=ing)</code>å¯ä»¥åŒ¹é…æ‰€æœ‰ä»¥â€ingâ€ç»“å°¾çš„å•è¯(åŒ¹é…ç»“æœä¸åŒ…å«â€ingâ€ï¼Œ<code>[A-Za-z]+ing</code>çš„åŒ¹é…ç»“æœåŒ…å«â€ingâ€)</p>
</li>
<li><p><code>(?&lt;=in)[A-Za-z]+</code>å¯ä»¥åŒ¹é…æ‰€æœ‰ä»¥â€inâ€ä¸ºå‰ç¼€çš„å•è¯(åŒ¹é…ç»“æœä¸åŒ…å«â€inâ€ï¼Œ<code>in[A-Za-z]+</code>çš„åŒ¹é…ç»“æœåŒ…å«â€inâ€)</p>
</li>
</ul>
<h2 id="3-éªŒè¯"><a href="#3-éªŒè¯" class="headerlink" title="3. éªŒè¯"></a>3. éªŒè¯</h2><h3 id="3-1-ç”µè¯å·ç éªŒè¯"><a href="#3-1-ç”µè¯å·ç éªŒè¯" class="headerlink" title="3.1 ç”µè¯å·ç éªŒè¯"></a>3.1 ç”µè¯å·ç éªŒè¯</h3><blockquote>
<p>è¦æ±‚</p>
</blockquote>
<ul>
<li>å›ºå®šç”µè¯å·ç ç”±æ•°å­—å’Œâ€-â€œæ„æˆï¼Œç”µè¯å·ç ä¸º7åˆ°8ä½</li>
<li>å¦‚æœå›ºå®šç”µè¯å·ç ä¸­åŒ…å«æœ‰åŒºå·ï¼Œé‚£ä¹ˆåŒºå·ä¸ºä¸‰ä½æˆ–å››ä½ï¼Œé¦–ä½æ˜¯0ï¼ŒåŒºå·ç”¨â€-â€œå’Œå…¶ä»–éƒ¨åˆ†éš”å¼€</li>
<li>ç§»åŠ¨ç”µè¯å·ç ä¸º11ä½ï¼Œç¬¬ä¸€ä½å’Œç¬¬äºŒä½ä¸ºâ€13â€ã€â€14â€ã€15â€ã€â€17â€ã€18â€ã€â€19â€</li>
</ul>
<blockquote>
<p>åˆ†æï¼š</p>
</blockquote>
<ul>
<li>å›ºå®šç”µè¯å·ç ï¼š<code>0\d&#123;2,3&#125;-\d&#123;7,9&#125;</code></li>
<li>ç§»åŠ¨ç”µè¯å·ç : <code>1[3|4|5|7|8|9]\d&#123;9&#125;</code></li>
<li>åˆèµ·æ¥å°±æ˜¯ï¼š<code>^0\d&#123;2,3&#125;-\d&#123;7,9&#125;|1[3|4|5|7|8|9]\d&#123;9&#125;$</code></li>
</ul>
<h3 id="3-3-ç”µå­é‚®ç®±éªŒè¯"><a href="#3-3-ç”µå­é‚®ç®±éªŒè¯" class="headerlink" title="3.3 ç”µå­é‚®ç®±éªŒè¯"></a>3.3 ç”µå­é‚®ç®±éªŒè¯</h3><blockquote>
<p>è¦æ±‚</p>
</blockquote>
<ul>
<li>ç”µå­é‚®ç®±æ ¼å¼ï¼šåç§°@åŸŸå</li>
<li>é‚®ç®±åç§°éƒ¨åˆ†ï¼šå…è®¸æ±‰å­—ã€å­—æ¯ã€æ•°å­—ã€ä¸­åˆ’çº¿å’Œä¸‹åˆ’çº¿</li>
<li>é‚®ç®±åŸŸåéƒ¨åˆ†ï¼šå…è®¸å­—æ¯ã€æ•°å­—ã€è‹±è¯­å¥å·</li>
</ul>
<blockquote>
<p>åˆ†æ</p>
</blockquote>
<ul>
<li>é‚®ç®±åç§°è¡¨è¾¾å¼ï¼š<ul>
<li>æ±‰å­—<code>[\u4e00-\u9fa5]</code></li>
<li>å­—æ¯<code>[A-Za-z]</code></li>
<li>æ•°å­—<code>[0-9]</code></li>
<li>ä¸­åˆ’çº¿å’Œä¸‹åˆ’çº¿<code>[-_]</code></li>
<li>ç»¼ä¸Šå¾—åˆ°åç§°è¡¨è¾¾å¼<code>[\u4e00-\u9fa5A-Za-z0-9-_]+</code></li>
</ul>
</li>
<li>é‚®ç®±åŸŸåè¡¨è¾¾å¼ï¼š<ul>
<li>åŸŸåçš„ä¸€èˆ¬è§„å¾‹ä¸º[Nçº§åŸŸå].[ä¸‰çº§åŸŸå].[äºŒçº§åŸŸå].[ä¸€çº§åŸŸå]ï¼Œæ ¼å¼ç±»ä¼¼ä¸º<code>**.**.**.**</code></li>
<li>ä¸€çº§åŸŸååªåŒ…å«å­—æ¯(å¦‚comã€topã€cnç­‰)ï¼Œé•¿åº¦ä¸º2-4ä½</li>
<li><code>**</code>éƒ¨åˆ†å¯ä»¥è¡¨ç¤ºä¸º<code>[A-Za-z0-9-_]+</code></li>
<li><code>.**</code>éƒ¨åˆ†å¯ä»¥è¡¨ç¤ºä¸º<code>\.[A-Za-z0-9-_]+</code></li>
<li>é›¶æˆ–å¤šä¸ª<code>&quot;.**&quot;</code>å¯ä»¥è¡¨ç¤ºä¸º <code> (\.[A-Za-z0-9-_]+)*</code></li>
<li>ä¸€çº§åŸŸåéƒ¨åˆ†<code>.**</code>å¯ä»¥è¡¨ç¤ºä¸º.<code>\.[a-z]&#123;2,4&#125;</code></li>
<li>ç»¼ä¸Šå¾—åˆ°åŸŸåè¡¨è¾¾å¼<code>[A-Za-z0-9-_]+(\.[A-Za-z0-9-_]+)*\.[a-z]&#123;2,4&#125;</code></li>
</ul>
</li>
<li>é‚®ç®±æœ€ç»ˆè¡¨è¾¾å¼ï¼š<ul>
<li>ä½¿ç”¨<code>^</code>åŒ¹é…é‚®ç®±æœ€å¼€å§‹çš„éƒ¨åˆ†ï¼Œä½¿ç”¨<code>$</code>åŒ¹é…é‚®ç®±ç»“æŸéƒ¨åˆ†ä»¥ä¿è¯é‚®ç®±å‰åä¸èƒ½æœ‰å…¶ä»–å­—ç¬¦</li>
<li>ç”±â€åç§°@åŸŸåâ€å¾—åˆ°æœ€ç»ˆè¡¨è¾¾å¼ï¼š<code>[\u4e00-\u9fa5A-Za-z0-9-_]+@[A-Za-z0-9-_]+(\.[A-Za-z0-9-_]+)*\.[a-z]&#123;2,4&#125;</code></li>
<li>ç®€å†™å³ä¸ºï¼š<code>^[\u4e00-\u9fa5-\w]+@[-\w]+(\.[-\w]+)*\.[a-z]&#123;2,4&#125;$</code></li>
</ul>
</li>
</ul>
<br>

<h2 id="4-ä½¿ç”¨"><a href="#4-ä½¿ç”¨" class="headerlink" title="4. ä½¿ç”¨"></a>4. ä½¿ç”¨</h2><p>Javaç¨‹åºä¸­ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œç›¸å…³ç±»ä½äº<code>java.util.regex</code>åŒ…ä¸‹é¢</p>
<ul>
<li>ç±»<code>Pattern</code>:<ul>
<li>æ­£åˆ™è¡¨è¾¾å››çš„ç¼–è¯‘è¡¨ç¤ºå½¢å¼</li>
<li>å»ºç«‹æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶å¯ç”¨ç›¸åº”æ¨¡å¼ï¼š<code>Pattern pattern = Pattern.compile(Regular Expression);</code></li>
</ul>
</li>
<li>ç±»<code>Matcher</code>:<ul>
<li>é€šè¿‡è§£é‡Š<code>Pattern</code>å¯¹<code>character squence</code>æ‰§è¡ŒåŒ¹é…æ“ä½œçš„å¼•æ“</li>
<li>åŒ¹é…strå­—ç¬¦ä¸²ï¼š<code>Matcher matcher = pattern.matcher(str);</code></li>
<li>å°†æ•´ä¸ªå­—ç¬¦ä¸²åºåˆ—ä¸è¯¥æ¨¡å¼åŒ¹é…ï¼š<code>boolean res1 = matcher.matches();</code></li>
<li>æ‰«æå­—ç¬¦ä¸²åºåˆ—ï¼ŒæŸ¥æ‰¾ä¸è¯¥æ¨¡å¼åŒ¹é…çš„ä¸‹ä¸€ä¸ªå­åºåˆ—ï¼š<code>boolean res2 = matcher.find();</code></li>
</ul>
</li>
</ul>
<h3 id="4-1-åŸºæœ¬æ“ä½œ"><a href="#4-1-åŸºæœ¬æ“ä½œ" class="headerlink" title="4.1 åŸºæœ¬æ“ä½œ"></a>4.1 åŸºæœ¬æ“ä½œ</h3><blockquote>
<p>ä»£ç </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/7 15:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: åŸºæœ¬æ“ä½œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ­£åˆ™åŒ¹é…æ¨¡å¼</span></span><br><span class="line">        Pattern pattern = Pattern.compile(<span class="string">&quot;\\w+&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŒ¹é…æ“ä½œå¼•æ“</span></span><br><span class="line">        Matcher matcher = pattern.matcher(<span class="string">&quot;KHighness||ParaK||FlowerK||18236763&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®Œæ•´åŒ¹é…</span></span><br><span class="line">        System.out.println(<span class="string">&quot;----------å®Œæ•´åŒ¹é…----------&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> res = matcher.matches();</span><br><span class="line">        System.out.println(<span class="string">&quot;åŒ¹é…ç»“æœï¼š&quot;</span> + res + <span class="string">&quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot;</span> + (res ? matcher.group() : <span class="string">&quot;NULL&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¯æ¬¡æ“ä½œå®Œå¼•æ“ä¸­çš„å­—ç¬¦ä¸²éƒ½ä¼šåˆ°è¾¾æœ«å°¾ï¼Œéœ€è¦é‡æ–°å†™</span></span><br><span class="line">        matcher = pattern.matcher(<span class="string">&quot;KHighness||ParaK||FlowerK||18236763&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å­ä¸²åŒ¹é…</span></span><br><span class="line">        System.out.println(<span class="string">&quot;----------å­ä¸²åŒ¹é…----------&quot;</span>);</span><br><span class="line">        <span class="keyword">boolean</span> res1 = matcher.find();</span><br><span class="line">        System.out.println(<span class="string">&quot;åŒ¹é…ç»“æœï¼š&quot;</span> + res1 + <span class="string">&quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot;</span> + (res1 ? matcher.group() : <span class="string">&quot;NULL&quot;</span>));</span><br><span class="line">        <span class="keyword">boolean</span> res2 = matcher.find();</span><br><span class="line">        System.out.println(<span class="string">&quot;åŒ¹é…ç»“æœï¼š&quot;</span> + res2 + <span class="string">&quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot;</span> + (res2 ? matcher.group() : <span class="string">&quot;NULL&quot;</span>));</span><br><span class="line">        <span class="keyword">boolean</span> res3 = matcher.find();</span><br><span class="line">        System.out.println(<span class="string">&quot;åŒ¹é…ç»“æœï¼š&quot;</span> + res3 + <span class="string">&quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot;</span> + (res3 ? matcher.group() : <span class="string">&quot;NULL&quot;</span>));</span><br><span class="line">        <span class="keyword">boolean</span> res4 = matcher.find();</span><br><span class="line">        System.out.println(<span class="string">&quot;åŒ¹é…ç»“æœï¼š&quot;</span> + res4 + <span class="string">&quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot;</span> + (res4 ? matcher.group() : <span class="string">&quot;NULL&quot;</span>));</span><br><span class="line">        <span class="keyword">boolean</span> res5 = matcher.find();</span><br><span class="line">        System.out.println(<span class="string">&quot;åŒ¹é…ç»“æœï¼š&quot;</span> + res5 + <span class="string">&quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot;</span> + (res5 ? matcher.group() : <span class="string">&quot;NULL&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾ªç¯æŸ¥æ‰¾</span></span><br><span class="line">        matcher = pattern.matcher(<span class="string">&quot;KHighness||ParaK||FlowerK||18236763&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;----------å¾ªç¯åŒ¹é…----------&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">            System.out.println(matcher.group());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">----------å®Œæ•´åŒ¹é…----------</span><br><span class="line">åŒ¹é…ç»“æœï¼šfalseï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼šNULL</span><br><span class="line">----------å­ä¸²åŒ¹é…----------</span><br><span class="line">åŒ¹é…ç»“æœï¼štrueï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼šKHighness</span><br><span class="line">åŒ¹é…ç»“æœï¼štrueï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼šParaK</span><br><span class="line">åŒ¹é…ç»“æœï¼štrueï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼šFlowerK</span><br><span class="line">åŒ¹é…ç»“æœï¼štrueï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š<span class="number">18236763</span></span><br><span class="line">åŒ¹é…ç»“æœï¼šfalseï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼šNULL</span><br><span class="line">----------å¾ªç¯åŒ¹é…----------</span><br><span class="line">KHighness</span><br><span class="line">ParaK</span><br><span class="line">FlowerK</span><br><span class="line"><span class="number">18236763</span></span><br></pre></td></tr></table></figure>



<h3 id="4-2-åˆ†ç»„æ“ä½œ"><a href="#4-2-åˆ†ç»„æ“ä½œ" class="headerlink" title="4.2 åˆ†ç»„æ“ä½œ"></a>4.2 åˆ†ç»„æ“ä½œ</h3><blockquote>
<p>ä»£ç </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/7 15:46</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: åˆ†ç»„æ“ä½œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ­£åˆ™åŒ¹é…æ¨¡å¼</span></span><br><span class="line">        <span class="comment">// åˆ†ç»„ä¸¤ç»„åŒ¹é…ï¼šå­—æ¯å’Œæ•°å­—</span></span><br><span class="line">        Pattern pattern = Pattern.compile(<span class="string">&quot;([A-Za-z]+)([0-9]+)&quot;</span>);</span><br><span class="line">        <span class="comment">// åŒ¹é…æ“ä½œå¼•æ“</span></span><br><span class="line">        Matcher matcher = pattern.matcher(<span class="string">&quot;KHighness18||ParaK23||FlowerK67||KAG63||KAG72&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;-----ç¬¬%dç»„-----\n&quot;</span>, index++);</span><br><span class="line">            System.out.println(<span class="string">&quot;group[0]: &quot;</span> + matcher.group(<span class="number">0</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;group[1]: &quot;</span> + matcher.group(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">-----ç¬¬<span class="number">1</span>ç»„-----</span><br><span class="line"><span class="built_in">group</span>[<span class="number">0</span>]: KHighness18</span><br><span class="line"><span class="built_in">group</span>[<span class="number">1</span>]: KHighness</span><br><span class="line">-----ç¬¬<span class="number">2</span>ç»„-----</span><br><span class="line"><span class="built_in">group</span>[<span class="number">0</span>]: ParaK23</span><br><span class="line"><span class="built_in">group</span>[<span class="number">1</span>]: ParaK</span><br><span class="line">-----ç¬¬<span class="number">3</span>ç»„-----</span><br><span class="line"><span class="built_in">group</span>[<span class="number">0</span>]: FlowerK67</span><br><span class="line"><span class="built_in">group</span>[<span class="number">1</span>]: FlowerK</span><br><span class="line">-----ç¬¬<span class="number">4</span>ç»„-----</span><br><span class="line"><span class="built_in">group</span>[<span class="number">0</span>]: KAG63</span><br><span class="line"><span class="built_in">group</span>[<span class="number">1</span>]: KAG</span><br><span class="line">-----ç¬¬<span class="number">5</span>ç»„-----</span><br><span class="line"><span class="built_in">group</span>[<span class="number">0</span>]: KAG72</span><br><span class="line"><span class="built_in">group</span>[<span class="number">1</span>]: KAG</span><br></pre></td></tr></table></figure>



<h3 id="4-3-æ›¿æ¢æ“ä½œ"><a href="#4-3-æ›¿æ¢æ“ä½œ" class="headerlink" title="4.3 æ›¿æ¢æ“ä½œ"></a>4.3 æ›¿æ¢æ“ä½œ</h3><blockquote>
<p>ä»£ç </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/7 16:09</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: æ›¿æ¢æ“ä½œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ­£åˆ™åŒ¹é…æ¨¡å¼</span></span><br><span class="line">        Pattern pattern = Pattern.compile(<span class="string">&quot;[0-9]&quot;</span>);</span><br><span class="line">        <span class="comment">// åŒ¹é…æ“ä½œå¼•æ“</span></span><br><span class="line">        Matcher matcher = pattern.matcher(<span class="string">&quot;KHighness18||ParaK23||FlowerK67||KAG63||KAG72&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ•°å­—å…¨éƒ¨æ›¿æ¢ä¸º##</span></span><br><span class="line">        String newStr = matcher.replaceAll(<span class="string">&quot;#&quot;</span>);</span><br><span class="line">        System.out.println(newStr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">KHighness<span class="comment">##||ParaK##||FlowerK##||KAG##||KAG##</span></span><br></pre></td></tr></table></figure>



<h3 id="4-4-åˆ†å‰²æ“ä½œ"><a href="#4-4-åˆ†å‰²æ“ä½œ" class="headerlink" title="4.4 åˆ†å‰²æ“ä½œ"></a>4.4 åˆ†å‰²æ“ä½œ</h3><blockquote>
<p>ä»£ç </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/7 16:12</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: åˆ†å‰²æ“ä½œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String str = <span class="string">&quot;K18H23I67G63H72N18E23S67S6372&quot;</span>;</span><br><span class="line">        String[] arr = str.split(<span class="string">&quot;\\d+&quot;</span>); <span class="comment">// ä»¥æ•°å­—ä¸ºè¾¹ç•Œè¿›è¡Œåˆ‡å‰²</span></span><br><span class="line">        System.out.println(Arrays.toString(arr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">K</span>, <span class="type">H</span>, <span class="type">I</span>, <span class="type">G</span>, <span class="type">H</span>, <span class="type">N</span>, <span class="type">E</span>, <span class="type">S</span>, <span class="type">S</span>]</span><br></pre></td></tr></table></figure>



<h3 id="4-5-çˆ¬å–è…¾è®¯å®˜ç½‘æ‰€æœ‰çš„è¶…é“¾æ¥"><a href="#4-5-çˆ¬å–è…¾è®¯å®˜ç½‘æ‰€æœ‰çš„è¶…é“¾æ¥" class="headerlink" title="4.5 çˆ¬å–è…¾è®¯å®˜ç½‘æ‰€æœ‰çš„è¶…é“¾æ¥"></a>4.5 çˆ¬å–è…¾è®¯å®˜ç½‘æ‰€æœ‰çš„è¶…é“¾æ¥</h3><blockquote>
<p>ä»£ç </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/7 16:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: çˆ¬å–è…¾è®¯å®˜ç½‘çš„æ‰€æœ‰è¶…é“¾æ¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSpider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€šè¿‡URLè·å–html</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urlStr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getURLContent</span><span class="params">(String urlStr)</span> </span>&#123;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(urlStr);</span><br><span class="line">            BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(url.openStream(), Charset.forName(<span class="string">&quot;UTF-8&quot;</span>)));</span><br><span class="line">            String temp = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">while</span> ((temp = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stringBuilder.append(temp + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†åŒ¹é…ç»“æœè£…è¿›list</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> destStr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> regex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getMatcherSubs</span><span class="params">(String destStr, String regex)</span> </span>&#123;</span><br><span class="line">        Pattern pattern = Pattern.compile(regex);</span><br><span class="line">        Matcher matcher = pattern.matcher(destStr);</span><br><span class="line">        List&lt;String&gt; result = <span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">while</span> (matcher.find()) &#123;</span><br><span class="line">            result.add(matcher.group(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String url = <span class="string">&quot;https://www.tencent.com/zh-cn&quot;</span>;</span><br><span class="line">        WebSpider spider = <span class="keyword">new</span> WebSpider();</span><br><span class="line">        <span class="comment">// è·å–è¶…é“¾æ¥æ ‡ç­¾açš„å†…å®¹ &lt;a\s\S]+?&lt;/a&gt;</span></span><br><span class="line">        <span class="comment">// è·å–hrefçš„å†…å®¹ href=\&quot;(.+?)\&quot;</span></span><br><span class="line">        spider.getMatcherSubs(spider.getURLContent(url), <span class="string">&quot;href=\\\&quot;([\\w\\s./:]+?)\\\&quot;&quot;</span>).stream().forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">/css/base.css</span><br><span class="line">/css/index.css</span><br><span class="line">https://weibo.com/tencent</span><br><span class="line">https://twitter.com/TencentGlobal</span><br><span class="line">https://www.linkedin.com/company/tencent/</span><br><span class="line">https://careers.tencent.com/</span><br><span class="line">https://join.qq.com/</span><br><span class="line">https://spd.tencent.com/portal</span><br><span class="line">https://ipr.tencent.com/</span><br><span class="line">http://beian.miit.gov.cn/</span><br><span class="line">http://beian.miit.gov.cn/</span><br><span class="line">http://beian.miit.gov.cn/</span><br><span class="line">/css/rem.css</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
      <tags>
        <tag>Regex</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring-beançš„ç”Ÿå‘½å‘¨æœŸ</title>
    <url>/posts/55590/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>æ‡’å¾—ä»springæºç è§’åº¦åˆ†æï¼Œç›´æ¥é€šè¿‡Demoæ¼”ç¤ºæ€»ç»“beançš„ç”Ÿå‘½è½¨è¿¹ã€‚</p>
<h2 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h2><h3 id="ä¾èµ–"><a href="#ä¾èµ–" class="headerlink" title="ä¾èµ–"></a>ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">top.parak.springlearn</span><br><span class="line">â”œâ”€â”€â”€config</span><br><span class="line">â”‚   â””â”€â”€â”€Config</span><br><span class="line">â”œâ”€â”€â”€common</span><br><span class="line">â”‚   â””â”€â”€â”€KHighnessExecutingLog</span><br><span class="line">â”œâ”€â”€â”€life</span><br><span class="line">â”‚   â””â”€â”€â”€KHighnessAwareBeanPostProcessor</span><br><span class="line">â”‚   â””â”€â”€â”€KHighnessBeanFactoryPostProcessor</span><br><span class="line">â”‚   â””â”€â”€â”€KHighnessBeanPostProcessor</span><br><span class="line">â””â”€â”€â”€service</span><br><span class="line">â”‚   â””â”€â”€â”€UserInterface</span><br><span class="line">â”‚   â””â”€â”€â”€UserService</span><br><span class="line">â””â”€â”€â”€KHighnessApplication </span><br></pre></td></tr></table></figure>
<h3 id="ç¼–ç "><a href="#ç¼–ç " class="headerlink" title="ç¼–ç "></a>ç¼–ç </h3><p>æ—¥å¿—è¾“å‡ºè®°å½•ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.springlearn.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessExecutingLog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> AtomicLong COUNTER = <span class="keyword">new</span> AtomicLong();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(FORMATTER.format(LocalDateTime.now()) + <span class="string">&quot; [&quot;</span> + COUNTER.incrementAndGet() + <span class="string">&quot;] =&gt; &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨æˆ·ä¸šåŠ¡æ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.springlearn.service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-04-01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨æˆ·ä¸šåŠ¡æ¥å£å®ç°ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.springlearn.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ResourceLoader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringValueResolver;</span><br><span class="line"><span class="keyword">import</span> top.parak.springlearn.common.KHighnessExecutingLog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.PreDestroy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-04-01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        /* ä¸šåŠ¡æ¥å£ */  <span class="title">UserInterface</span>,</span></span><br><span class="line"><span class="class">        /* <span class="title">Bean</span>æ¥å£ */ <span class="title">BeanNameAware</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">BeanFactoryAware</span>,</span></span><br><span class="line"><span class="class">        /* ç¯å¢ƒæ¥å£ */ <span class="title">EnvironmentAware</span>, <span class="title">EmbeddedValueResolverAware</span>, <span class="title">ResourceLoaderAware</span>, <span class="title">MessageSourceAware</span>, <span class="title">ApplicationEventPublisherAware</span>, <span class="title">ApplicationContextAware</span>,</span></span><br><span class="line"><span class="class">        /* åç½®æ¥å£ */ <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;æ„é€ å‡½æ•°: UserService.UserService() &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;setå‡½æ•°: UserService.setName() &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;è‡ªå®šä¹‰åˆå§‹åŒ–: UserService.initMethod()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;è‡ªå®šä¹‰é”€æ¯: UserService.destroyMethod()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¼ å…¥beanåç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> BeanNameAware</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanName</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;ä¼ å…¥beanåç§°: BeanNameAware.setBeanName()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¼ å…¥beanç±»åŠ è½½å™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> BeanClassLoaderAware</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;ä¼ å…¥beanç±»åŠ è½½å™¨: BeanClassLoaderAware.setBeanClassLoader()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¼ å…¥beanå·¥å‚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> BeanFactoryAware</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;ä¼ å…¥beanå·¥å‚: BeanFactoryAware.setBeanFactory()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¼ å…¥è¿è¡Œæ—¶ç¯å¢ƒ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> EnvironmentAware</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;ä¼ å…¥è¿è¡Œæ—¶ç¯å¢ƒ: EnvironmentAware.setEnvironment()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¼ å…¥æ–‡ä»¶è§£æå™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> EmbeddedValueResolverAware</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmbeddedValueResolver</span><span class="params">(StringValueResolver stringValueResolver)</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;ä¼ å…¥æ–‡ä»¶è§£æå™¨: EmbeddedValueResolverAware.setEmbeddedValueResolver()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¼ å…¥èµ„æºåŠ è½½å™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ResourceLoaderAware</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;ä¼ å…¥èµ„æºåŠ è½½å™¨: ResourceLoaderAware.setResourceLoader()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¼ å…¥äº‹ä»¶å‘å¸ƒå™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ApplicationEventPublisherAware</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;ä¼ å…¥äº‹ä»¶å‘å¸ƒå™¨: ApplicationEventPublisherAware.setApplicationEventPublisher()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¼ å…¥è¯­è¨€å›½é™…åŒ–</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> MessageSourceAware</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMessageSource</span><span class="params">(MessageSource messageSource)</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;ä¼ å…¥è¯­è¨€å›½é™…åŒ–: MessageSourceAware.setMessageSource()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¼ å…¥åº”ç”¨ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ApplicationContextAware</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;ä¼ å…¥åº”ç”¨ä¸Šä¸‹æ–‡: ApplicationContextAware.setApplicationContext()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;å¦‚åï¼Œå±æ€§è®¾ç½®ä¹‹åæ‰§è¡Œ&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> InitializingBean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;åˆå§‹åŒ–: InitializingBean.afterPropertiesSet()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„é€ ä¹‹å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postConstruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;æ„é€ ä¹‹å: @PostConstruct postConstruct()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”€æ¯ä¹‹å‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;é”€æ¯ä¹‹å‰: @PreDestroy preDestroy()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”€æ¯bean</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> DisposableBean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;é”€æ¯bean: DisposableBean.destroy()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®ç°ä¸šåŠ¡æ¥å£</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> UserInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;ä¸šåŠ¡é€»è¾‘: UserInterface.test() &quot;</span> + <span class="keyword">this</span>.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åç½®å¤„ç†å™¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.springlearn.life;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanFactoryPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> top.parak.springlearn.common.KHighnessExecutingLog;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory configurableListableBeanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;å®ä¾‹åŒ–å‰: BeanFactoryPostProcessor.postProcessBeanFactory()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.springlearn.life;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> top.parak.springlearn.common.KHighnessExecutingLog;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;åˆå§‹åŒ–å‰: BeanPostProcessor.postProcessBeforeInitialization()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        KHighnessExecutingLog.info(<span class="string">&quot;åˆå§‹åŒ–å: BeanPostProcessor.postProcessAfterInitialization()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.springlearn.life;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.InstantiationAwareBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> top.parak.springlearn.common.KHighnessExecutingLog;</span><br><span class="line"><span class="keyword">import</span> top.parak.springlearn.service.UserService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-04-01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">InstantiationAwareBeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInstantiation</span><span class="params">(Class&lt;?&gt; beanClass, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanClass.equals(UserService.class)) &#123;</span><br><span class="line">            KHighnessExecutingLog.info(<span class="string">&quot;å®ä¾‹åŒ–å‰: UserServiceBeanPostProcessor.postProcessBeforeInstantiation()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›falseåˆ™ç»ˆæ­¢beanå±æ€§æ³¨å…¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">postProcessAfterInstantiation</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bean.getClass().equals(UserService.class)) &#123;</span><br><span class="line">            KHighnessExecutingLog.info(<span class="string">&quot;å®ä¾‹åŒ–å: UserServiceBeanPostProcessor.postProcessAfterInstantiation() &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanName.equals(<span class="string">&quot;userService&quot;</span>)) &#123;</span><br><span class="line">            KHighnessExecutingLog.info(<span class="string">&quot;åˆå§‹åŒ–å‰: UserServiceBeanPostProcessor.postProcessBeforeInitialization()&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (Method method : bean.getClass().getMethods()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (method.isAnnotationPresent(PostConstruct.class)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        method.invoke(bean);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IllegalAccessException | InvocationTargetException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beanName.equals(<span class="string">&quot;userService&quot;</span>)) &#123;</span><br><span class="line">            KHighnessExecutingLog.info(<span class="string">&quot;åˆå§‹åŒ–å: UserServiceBeanPostProcessor.postProcessAfterInitialization() &quot;</span>);</span><br><span class="line">            <span class="comment">// æ¨¡æ‹ŸåŠ¨æ€ä»£ç†AOP</span></span><br><span class="line">            <span class="keyword">return</span> Proxy.newProxyInstance(bean.getClass().getClassLoader(), bean.getClass().getInterfaces(), (proxy, method, args) -&gt; &#123;</span><br><span class="line">                KHighnessExecutingLog.info(<span class="string">&quot;åŠ¨æ€ä»£ç†: Proxy.newProxyInstance()&quot;</span>);</span><br><span class="line">                method.invoke(bean, args);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é…ç½®ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.springlearn.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> top.parak.springlearn.service.UserService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;top.parak.springlearn&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(initMethod = &quot;initMethod&quot;, destroyMethod = &quot;destroyMethod&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserService <span class="title">userService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserService userService = <span class="keyword">new</span> UserService();</span><br><span class="line">        userService.setName(<span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> userService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.springlearn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> top.parak.springlearn.config.Config;</span><br><span class="line"><span class="keyword">import</span> top.parak.springlearn.service.UserInterface;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-03-30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(Config.class);</span><br><span class="line">        UserInterface userInterface = (UserInterface) applicationContext.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        userInterface.test();</span><br><span class="line">        applicationContext.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.085</span> [<span class="number">1</span>] =&gt; å®ä¾‹åŒ–å‰: BeanFactoryPostProcessor.postProcessBeanFactory()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.118</span> [<span class="number">2</span>] =&gt; å®ä¾‹åŒ–å‰: InstantiationAwareBeanPostProcessor.postProcessBeforeInstantiation()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.128</span> [<span class="number">3</span>] =&gt; æ„é€ å‡½æ•°: UserService.UserService() </span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.129</span> [<span class="number">4</span>] =&gt; <span class="built_in">set</span>å‡½æ•°: UserService.setName() </span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.131</span> [<span class="number">5</span>] =&gt; å®ä¾‹åŒ–å: InstantiationAwareBeanPostProcessor.postProcessAfterInstantiation() </span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.136</span> [<span class="number">6</span>] =&gt; ä¼ å…¥beanåç§°: BeanNameAware.setBeanName()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.136</span> [<span class="number">7</span>] =&gt; ä¼ å…¥beanç±»åŠ è½½å™¨: BeanClassLoaderAware.setBeanClassLoader()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.136</span> [<span class="number">8</span>] =&gt; ä¼ å…¥beanå·¥å‚: BeanFactoryAware.setBeanFactory()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.137</span> [<span class="number">9</span>] =&gt; ä¼ å…¥è¿è¡Œæ—¶ç¯å¢ƒ: EnvironmentAware.setEnvironment()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.137</span> [<span class="number">10</span>] =&gt; ä¼ å…¥æ–‡ä»¶è§£æå™¨: EmbeddedValueResolverAware.setEmbeddedValueResolver()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.137</span> [<span class="number">11</span>] =&gt; ä¼ å…¥èµ„æºåŠ è½½å™¨: ResourceLoaderAware.setResourceLoader()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.137</span> [<span class="number">12</span>] =&gt; ä¼ å…¥äº‹ä»¶å‘å¸ƒå™¨: ApplicationEventPublisherAware.setApplicationEventPublisher()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.137</span> [<span class="number">13</span>] =&gt; ä¼ å…¥è¯­è¨€å›½é™…åŒ–: MessageSourceAware.setMessageSource()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.137</span> [<span class="number">14</span>] =&gt; ä¼ å…¥åº”ç”¨ä¸Šä¸‹æ–‡: ApplicationContextAware.setApplicationContext()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.137</span> [<span class="number">15</span>] =&gt; åˆå§‹åŒ–å‰: InstantiationAwareBeanPostProcessor.postProcessBeforeInitialization()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.137</span> [<span class="number">16</span>] =&gt; æ„é€ ä¹‹å: @PostConstruct postConstruct()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.137</span> [<span class="number">17</span>] =&gt; åˆå§‹åŒ–: InitializingBean.afterPropertiesSet()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.138</span> [<span class="number">18</span>] =&gt; è‡ªå®šä¹‰åˆå§‹åŒ–: UserService.initMethod()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.138</span> [<span class="number">19</span>] =&gt; åˆå§‹åŒ–å: InstantiationAwareBeanPostProcessor.postProcessAfterInitialization() </span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.140</span> [<span class="number">20</span>] =&gt; åˆå§‹åŒ–å: BeanPostProcessor.postProcessAfterInitialization()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.153</span> [<span class="number">21</span>] =&gt; åŠ¨æ€ä»£ç†: Proxy.newProxyInstance()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.153</span> [<span class="number">22</span>] =&gt; ä¸šåŠ¡é€»è¾‘: UserInterface.test() KHighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.154</span> [<span class="number">23</span>] =&gt; é”€æ¯ä¹‹å‰: @PreDestroy preDestroy()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.154</span> [<span class="number">24</span>] =&gt; é”€æ¯bean: DisposableBean.destroy()</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-14</span> <span class="number">14</span>:<span class="number">37</span>:<span class="number">37.154</span> [<span class="number">25</span>] =&gt; è‡ªå®šä¹‰é”€æ¯: UserService.destroyMethod()</span><br></pre></td></tr></table></figure>


<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>å®ä¾‹åŒ–<ol>
<li>å®ä¾‹åŒ–å‰ï¼šBeanFactoryPostProcessor#postProcessBeanFactory()</li>
<li>å®ä¾‹åŒ–å‰ï¼šInstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation()</li>
<li>æ‰§è¡Œbeançš„æ„é€ å‡½æ•°</li>
<li>å®ä¾‹åŒ–åï¼šInstantiationAwareBeanPostProcessor#postProcessAfterInstantiation()</li>
<li>ä¸ºbeanæ³¨å…¥å±æ€§</li>
</ol>
</li>
<li>Beanæ¥å£å›è°ƒ<ol>
<li>ä¼ å…¥beanåç§°ï¼šBeanNameAware#setBeanName()</li>
<li>ä¼ å…¥beanç±»åŠ è½½å™¨ï¼šBeanClassLoaderAware#setBeanClassLoader()</li>
<li>ä¼ å…¥beanå·¥å‚ï¼šBeanFactoryAware#setBeanFactory()</li>
</ol>
</li>
<li>Springæ¥å£å›è°ƒ<ol>
<li>ä¼ å…¥è¿è¡Œæ—¶ç¯å¢ƒï¼šEnvironmentAware#setEnvironment()</li>
<li>ä¼ å…¥æ–‡ä»¶è§£æå™¨ï¼šEmbeddedValueResolverAware#setEmbeddedValueResolver()</li>
<li>ä¼ å…¥èµ„æºåŠ è½½å™¨ï¼šResourceLoaderAware#setResourceLoader()</li>
<li>ä¼ å…¥äº‹ä»¶å‘å¸ƒå™¨ï¼šApplicationEventPublisherAware#setApplicationEventPublisher()</li>
<li>ä¼ å…¥è¯­è¨€å›½å®¶åŒ–ï¼šMessageSourceAware#setMessageSourceAware()</li>
<li>ä¼ å…¥åº”ç”¨ä¸Šä¸‹æ–‡ï¼šApplicationContextAware#setApplicaionAware()</li>
</ol>
</li>
<li>åˆå§‹åŒ–<ol>
<li>åˆå§‹åŒ–å‰ï¼šInstantiationAwareBeanPostProcessor#postProcessBeforeInitialization()</li>
<li>æ„é€ ä¹‹åï¼š@PostConstructæ ‡æ³¨çš„æ–¹æ³•</li>
<li>åˆå§‹åŒ–ï¼šInitializingBean#afterPropertiesSet()</li>
<li>è‡ªå®šä¹‰åˆå§‹åŒ–ï¼šbeanæŒ‡å®šçš„initMethod</li>
<li>åˆå§‹åŒ–åï¼šInstantiationAwareBeanPostProcessor#postProcessAfterIntialization()</li>
<li>åˆå§‹åŒ–åï¼šBeanPostProcessor#postProcessAfterInitialization()</li>
</ol>
</li>
<li>é”€æ¯<ol>
<li>é”€æ¯ä¹‹å‰ï¼š@PreDestroyæ ‡æ³¨çš„æ–¹æ³•</li>
<li>é”€æ¯beanï¼šDisposableBean#destroy()</li>
<li>è‡ªå®šä¹‰é”€æ¯ï¼šbeanæŒ‡å®šçš„destroyMethod</li>
</ol>
</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>[1] ğŸš€ æ·±ç©¶Springä¸­Beançš„ç”Ÿå‘½å‘¨æœŸï¼š<a href="https://www.cnblogs.com/javazhiyin/p/10905294.html">https://www.cnblogs.com/javazhiyin/p/10905294.html</a><br />[2] ğŸš¢ Spring Beançš„ç”Ÿå‘½å‘¨æœŸï¼š<a href="https://www.cnblogs.com/zrtqsk/p/3735273.html">https://www.cnblogs.com/zrtqsk/p/3735273.html</a></p>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring-aopåŸç†</title>
    <url>/posts/54880/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>AOP(Aspect Oritented Programming)ï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œé€šè¿‡é¢„ç¼–è¯‘å’Œè¿è¡ŒæœŸåŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½çš„å”¯ä¸€ç»´æŠ¤çš„ä¸€ç§æŠ€æœ¯ã€‚AOPæ˜¯OOPçš„å»¶ç»­ï¼Œä¹Ÿæ˜¯å¯¹OOPçš„è¡¥å……ã€‚å®ƒæ˜¯Springæ¡†æ¶ä¸­çš„ä¸€ä¸ªé‡è¦å†…å®¹ï¼Œæ˜¯å‡½æ•°å¼å˜æˆçš„ä¸€ç§è¡ç”Ÿæ³›å‹ã€‚åˆ©ç”¨AOPå¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»ï¼Œå¯¹MVCçš„å‚ç›´æ¶æ„è¿›è¡Œæ¨ªå‘åˆ‡å…¥ï¼Œä»è€Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚<br>â€‹</p>
<h2 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h2><p>ä»£ç†æ¨¡å¼æ˜¯GOF23ç§è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œä¸ºå…¶ä»–å¯¹è±¡æä¾›äº†ä¸€ä¸ªä»£ç†ä»¥æä¾›å¯¹æŸä¸ªå¯¹è±¡çš„è®¿é—®ã€‚</p>
<p>ä¸»è¦åŒ…æ‹¬:</p>
<ol>
<li>æŠ½è±¡æ¥å£</li>
<li>å…·ä½“å®ç°ç±»</li>
<li>ä»£ç†ç±»</li>
</ol>
<p>é™æ€ä»£ç†æ˜¯ä»£ç†æ¨¡å¼çš„å®ç°æ–¹å¼ä¹‹ä¸€ï¼Œæ˜¯åœ¨ç¨‹åºè¿è¡Œå‰ï¼Œç”±ç¨‹åºå‘˜åˆ›å»ºæˆ–è€…ç‰¹å®šå·¥å…·è‡ªåŠ¨ç”Ÿæˆæºä»£ç å¹¶å¯¹å…¶ç¼–ç¨‹ç”Ÿæˆ<code>.class</code>æ–‡ä»¶ã€‚</p>
<p><strong>å¯¹äºé™æ€ä»£ç†è€Œè¨€ï¼Œå…·ä½“å®ç°ç±»ä¸ä»£ç†ç±»æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œè¿™ä¹Ÿæ˜¯å¹¿ä¹‰ä¸Šçš„ä»£ç†æ¨¡å¼ç‰¹ç‚¹ã€‚ä½†æ˜¯ï¼Œå¦‚æœæŠ½è±¡æ¥å£æœ‰Kä¸ªå®ç°ç±»ï¼Œé‚£ä¹ˆä¹Ÿå¿…ç„¶éœ€è¦æ‰‹åŠ¨åˆ›å»ºKä¸ªä»£ç†ç±»ï¼Œè¿™ä¾¿æ˜¯é™æ€ä»£ç†çš„ç—›ç‚¹ã€‚</strong></p>
<p>ç›¸è¾ƒäºåœ¨ç¼–è¯‘æœŸå®ç°çš„é™æ€ä»£ç†ï¼ŒåŠ¨æ€ä»£ç†åˆ™åœ¨ç¨‹åºè¿è¡ŒæœŸå®ç°ã€‚åŠ¨æ€ä»£ç†å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹å§”æ‰˜ç±»çš„ç›¸å…³æ–¹æ³•è¿›è¡Œç»Ÿä¸€å¢å¼ºå¤„ç†ã€‚</p>
<p>ä¸‹é¢ä»¥æ¼”å”±ä¼šä¸ºåœºæ™¯è¿›è¡Œæ¼”ç¤ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ã€‚</p>
<h3 id="é™æ€ä»£ç†"><a href="#é™æ€ä»£ç†" class="headerlink" title="é™æ€ä»£ç†"></a>é™æ€ä»£ç†</h3><p>é™æ€ä»£ç†çš„å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®šä¹‰ä¸šåŠ¡æ¥å£ï¼›</li>
<li>åˆ›å»ºä¸šåŠ¡æ¥å£å®ç°ç±»ï¼›</li>
<li>å®šä¹‰ä»£ç†ç±»å¹¶å®ç°ä¸šåŠ¡æ¥å£ã€‚</li>
</ol>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ¼”å”±ä¼šæ¥å£ï¼Œå®šä¹‰æ¼”å”±ä¼šçš„ä¸¤ä¸ªåŠŸèƒ½ï¼Œå¼€å§‹å’Œç»“æŸï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Concert</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">(String song)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">end</span><span class="params">(String song)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ç€åˆ›å»ºå…·ä½“çš„æ¼”å”±ä¼šå®ç°ç±»ï¼Œåœ¨è¯¥ç±»ä¸­çœŸæ­£å®ç°æ¼”å”±ä¼šçš„åŠŸèƒ½ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RealConcert</span> <span class="keyword">implements</span> <span class="title">Concert</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="keyword">private</span> String singerName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RealConcert</span><span class="params">(String singerName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.singerName = singerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(String song)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;æ¼”å”±ä¼šå³å°†å¼€å§‹&quot;</span>, singerName);</span><br><span class="line">        log.info(<span class="string">&quot;ç¬¬ä¸€é¦–ï¼šã€Š&#123;&#125;&#125;ã€‹&quot;</span>, song);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">(String song)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æœ€åä¸€é¦–ï¼šã€Š&#123;&#125;ã€‹&quot;</span>, song);</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;æ¼”å”±ä¼šå³å°†ç»“æŸ&quot;</span>, singerName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæ¼”å”±ä¼šæ˜¯éœ€è¦åœºåœ°ä¸¾åŠï¼Œåœºåœ°ä¸Šè¦è¿›è¡Œå…¶ä»–çš„å¹¿å‘Šæ’å…¥å’Œå®‰å…¨æªæ–½ï¼Œé€šè¿‡ä»£ç†åˆ›å»ºæœ€ç»ˆçš„æ¼”å”±ä¼šï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyRealConcert</span> <span class="keyword">implements</span> <span class="title">Concert</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="keyword">private</span> Concert concert;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyRealConcert</span><span class="params">(Concert concert, String address)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.concert = concert;</span><br><span class="line">        <span class="keyword">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(String song)</span> </span>&#123;</span><br><span class="line">        startNotice();</span><br><span class="line">        concert.start(song);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">(String song)</span> </span>&#123;</span><br><span class="line">        concert.end(song);</span><br><span class="line">        endNotice();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startNotice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ¬¢è¿æ¥åˆ°&#123;&#125;çœ‹æ¼”å”±ä¼šï¼Œè§å…‰æ£’ã€ç²‰ä¸ç‰Œ9.8æŠ˜ï¼Œæ¬¢è¿è´­ä¹°ï¼&quot;</span>, address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">endNotice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ¼”å”±ä¼šå·²ç»ç»“æŸï¼Œè¯·å¸¦èµ°ç§äººç‰©å“å’Œåƒåœ¾ï¼Œå®¶é•¿æ³¨æ„çœ‹å¥½å°å­©&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åç¼–å†™æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticProxyTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä¸šåŠ¡å®ç°ç±»</span></span><br><span class="line">        Concert originConcert = <span class="keyword">new</span> RealConcert(<span class="string">&quot;å‘¨æ°ä¼¦&quot;</span>);</span><br><span class="line">        <span class="comment">// ç›®æ ‡ä»£ç†ç±»</span></span><br><span class="line">        Concert proxyConcert = <span class="keyword">new</span> ProxyRealConcert(originConcert, <span class="string">&quot;é¸Ÿå·¢&quot;</span>);</span><br><span class="line">        proxyConcert.start(<span class="string">&quot;èŠ±æµ·&quot;</span>);</span><br><span class="line">        proxyConcert.end(<span class="string">&quot;å®‰é™&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">33</span>:<span class="number">55.064</span> [<span class="type">main</span>] INFO top.parak.quiet.SuperRealConcert - æ¬¢è¿æ¥åˆ°é¸Ÿå·¢çœ‹æ¼”å”±ä¼šï¼Œè§å…‰æ£’ã€ç²‰ä¸ç‰Œ<span class="number">9.8</span>æŠ˜ï¼Œæ¬¢è¿è´­ä¹°ï¼</span><br><span class="line"><span class="number">15</span>:<span class="number">33</span>:<span class="number">55.067</span> [<span class="type">main</span>] INFO top.parak.quiet.RealConcert - å‘¨æ°ä¼¦æ¼”å”±ä¼šå³å°†å¼€å§‹</span><br><span class="line"><span class="number">15</span>:<span class="number">33</span>:<span class="number">55.067</span> [<span class="type">main</span>] INFO top.parak.quiet.RealConcert - ç¬¬ä¸€é¦–ï¼šã€ŠèŠ±æµ·ã€‹</span><br><span class="line"><span class="number">15</span>:<span class="number">33</span>:<span class="number">55.067</span> [<span class="type">main</span>] INFO top.parak.quiet.RealConcert - æœ€åä¸€é¦–ï¼šã€Šå®‰é™ã€‹</span><br><span class="line"><span class="number">15</span>:<span class="number">33</span>:<span class="number">55.067</span> [<span class="type">main</span>] INFO top.parak.quiet.RealConcert - å‘¨æ°ä¼¦æ¼”å”±ä¼šå³å°†ç»“æŸ</span><br><span class="line"><span class="number">15</span>:<span class="number">33</span>:<span class="number">55.067</span> [<span class="type">main</span>] INFO top.parak.quiet.SuperRealConcert - æ¼”å”±ä¼šå·²ç»ç»“æŸï¼Œè¯·å¸¦èµ°ç§äººç‰©å“å’Œåƒåœ¾ï¼Œå®¶é•¿æ³¨æ„çœ‹å¥½å°å­©</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä»£ç†æ¨¡å¼å¯ä»¥åœ¨ä¸ä¿®æ”¹ä»£ç†å¯¹è±¡çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡æ‰©å±•ä»£ç†ç±»ï¼Œè¿›è¡Œä¸€äº›åŠŸèƒ½çš„é™„åŠ ä¸å¢å¼ºã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä»£ç†ç±»å’Œè¢«ä»£ç†ç±»åº”è¯¥å…±åŒå®ç°ä¸€ä¸ªæ¥å£ï¼Œæˆ–è€…æ˜¯å…±åŒç»§æ‰¿æŸä¸ªæŠ½è±¡ç±»ã€‚</p>
<h3 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h3><p>JDKåŠ¨æ€ä»£ç†éœ€è¦ä½¿ç”¨åˆ°<code>java.lang.reflect</code>åŒ…ä¸‹çš„ä¸‰ä¸ªç±»ï¼š<code>InvocationHanler</code>ã€<code>Method</code>å’Œ<code>Proxy</code>ã€‚</p>
<p><code>InvocationHanler</code>çš„<code>invoke</code>æ–¹æ³•å¢å¼ºåŸå®ç°ç±»çš„åŠŸèƒ½ï¼Œè¯¥æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ol>
<li><code>Object proxy</code>ï¼šJDKåˆ›å»ºçš„ä»£ç†å¯¹è±¡ï¼›</li>
<li><code>Method method</code>ï¼šç›®æ ‡ç±»ä¸­çš„æ–¹æ³•ï¼›</li>
<li><code>Object[] args</code>ï¼šç›®æ ‡ç±»ä¸­çš„å‚æ•°ã€‚</li>
</ol>
<p><code>Proxy</code>çš„<code>newProxyInstance</code>æ–¹æ³•ç”¨äºç”Ÿæˆä»£ç†ç±»ï¼Œè¯¥æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ul>
<li><code>ClassLoader loader</code>ï¼šç›®æ ‡ç±»çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬é€šè¿‡åå°„<code>class.getClassLoader()</code>è·å–ï¼›</li>
<li><code>Class[] interfaces</code>ï¼šç›®æ ‡ç±»å®ç°çš„æ¥å£ï¼Œä¸€èˆ¬é€šè¿‡åå°„<code>class.getInterfaces()</code>è·å–ï¼›</li>
<li><code>InvocationHandler h</code>ï¼š éœ€è¦å…·ä½“å®ç°ç±»å®ç°è¿™ä¸ªæ¥å£ï¼Œéœ€è¦<code>new</code>å‡ºæ¥å½“ä½œå‚æ•°ã€‚</li>
</ul>
<p>åŠ¨æ€ä»£ç†çš„æ¥å£å’Œè¢«ä»£ç†ç±»ä¸é™æ€ä»£ç†ç›¸åŒï¼Œåªéœ€è¦ä¿®æ”¹å…·ä½“å®ç°ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyRealConcert</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="keyword">private</span> Object concert;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProxyRealConcert</span><span class="params">(Object concert, String address)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.concert = concert;</span><br><span class="line">        <span class="keyword">this</span>.address = address;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;start&quot;</span>)) &#123;</span><br><span class="line">            startNotice();</span><br><span class="line">            method.invoke(concert, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;end&quot;</span>)) &#123;</span><br><span class="line">            method.invoke(concert, args);</span><br><span class="line">            endNotice();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startNotice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ¬¢è¿æ¥åˆ°&#123;&#125;çœ‹æ¼”å”±ä¼šï¼Œè§å…‰æ£’ã€ç²‰ä¸ç‰Œ9.8æŠ˜ï¼Œæ¬¢è¿è´­ä¹°ï¼&quot;</span>, address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">endNotice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ¼”å”±ä¼šå·²ç»ç»“æŸï¼Œè¯·å¸¦èµ°ç§äººç‰©å“å’Œåƒåœ¾ï¼Œå®¶é•¿æ³¨æ„çœ‹å¥½å°å­©&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxyTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä¸šåŠ¡å®ç°ç±»</span></span><br><span class="line">        Concert originConcert = <span class="keyword">new</span> RealConcert(<span class="string">&quot;å‘¨æ°ä¼¦&quot;</span>);</span><br><span class="line">        InvocationHandler invocationHandler = <span class="keyword">new</span> ProxyRealConcert(originConcert, <span class="string">&quot; é¸Ÿå·¢&quot;</span>);</span><br><span class="line">        <span class="comment">// ç›®æ ‡ä»£ç†ç±»</span></span><br><span class="line">        Concert proxyConcert = (Concert) Proxy.newProxyInstance(RealConcert.class.getClassLoader(), RealConcert.class.getInterfaces(), invocationHandler);</span><br><span class="line">        proxyConcert.start(<span class="string">&quot;èŠ±æµ·&quot;</span>);</span><br><span class="line">        proxyConcert.end(<span class="string">&quot;å®‰é™&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œå®ç°æ•ˆæœä¸é™æ€ä»£ç†ç›¸åŒã€‚<br>â€‹</p>
<h2 id="AOPçš„æœ¯è¯­"><a href="#AOPçš„æœ¯è¯­" class="headerlink" title="AOPçš„æœ¯è¯­"></a>AOPçš„æœ¯è¯­</h2><p>åœ¨AOPä¸­ï¼Œåˆ‡é¢çš„å·¥ä½œè¢«ç§°ä¸ºé€šçŸ¥ã€‚<br>é€šçŸ¥å®šä¹‰äº†åˆ‡é¢æ˜¯ä»€ä¹ˆä»¥åŠä½•æ—¶ä½¿ç”¨ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<ol>
<li>è¿æ¥ç‚¹ï¼ˆJpinPointï¼‰ï¼šåœ¨åº”ç”¨æ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿæ’å…¥åˆ‡é¢çš„ä¸€ä¸ªç‚¹ã€‚è¿™ä¸ªç‚¹æ˜¯è°ƒç”¨æ–¹æ³•æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œç”šè‡³æ˜¯ä¿®æ”¹ä¸€ä¸ªå­—æ®µæ—¶ã€‚åˆ‡é¢ä»£ç å¯ä»¥åˆ©ç”¨è¿™äº›ç‚¹æ’å…¥åˆ°åº”ç”¨çš„æ­£å¸¸æµç¨‹ä¹‹ä¸­ï¼Œå¹¶æ·»åŠ æ–°çš„è¡Œä¸ºã€‚</li>
<li>åˆ‡ç‚¹ï¼ˆPointcutï¼‰ï¼šåˆ‡ç‚¹çš„å®šä¹‰ä¼šåŒ¹é…é€šçŸ¥æ‰€è¦ç»‡å…¥çš„ä¸€ä¸ªæˆ–å¤šä¸ªè¿æ¥ç‚¹ã€‚æˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ˜ç¡®çš„ç±»å’Œæ–¹æ³•åç§°æ¥æŒ‡å®šè¿™äº›åˆ‡ç‚¹ï¼Œæˆ–æ˜¯åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼å®šä¹‰è¦åŒ¹é…çš„ç±»å’Œæ–¹æ³•åç§°æ¥æŒ‡å®šè¿™äº›åˆ‡ç‚¹ã€‚</li>
<li>åˆ‡é¢ï¼ˆAspectï¼‰ï¼šåˆ‡é¢æ˜¯é€šçŸ¥å’Œåˆ‡ç‚¹çš„ç»“åˆã€‚é€šçŸ¥å’Œåˆ‡ç‚¹å…±åŒå®šä¹‰äº†å…³äºåˆ‡é¢çš„å…¨éƒ¨å†…å®¹â€”â€”å®ƒæ˜¯ä»€ä¹ˆï¼Œåœ¨ä½•æ—¶å’Œä½•å¤„å®Œæˆå…¶åŠŸèƒ½ã€‚</li>
<li>å¼•å…¥ï¼ˆIntrodutionï¼‰ï¼šå¼•å…¥å…è®¸æˆ‘ä»¬å‘ç°æœ‰çš„ç±»æ·»åŠ æ–°çš„æ–¹æ³•å’Œå±æ€§ã€‚</li>
<li>ç»‡å…¥ï¼ˆWeavingï¼‰ï¼šç»‡å…¥æ˜¯å°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡æ¥åˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚åˆ‡é¢åœ¨æŒ‡å®šçš„è¿æ¥ç‚¹è¢«ç»‡å…¥åˆ°ç›®æ ‡å¯¹è±¡ä¸­ã€‚åœ¨ç›®æ ‡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸé‡Œæœ‰å¤šä¸ªç‚¹å¯ä»¥è¿›è¡Œç»‡å…¥ï¼š<ul>
<li>ç¼–è¯‘æœŸï¼šåˆ‡é¢åœ¨ç›®æ ‡ç±»ç¼–è¯‘æœŸæ—¶è¢«ç»‡å…¥</li>
<li>ç±»åŠ è½½æœŸï¼šåˆ‡é¢åœ¨ç›®æ ‡ç±»åŠ è½½åˆ°JVMæ—¶è¢«ç»‡å…¥</li>
<li>è¿è¡ŒæœŸï¼šåˆ‡é¢åœ¨åº”ç”¨è¿è¡Œçš„æŸä¸ªæ—¶å€™è¢«ç»‡å…¥ï¼ˆSpringä½¿ç”¨ï¼‰</li>
</ul>
</li>
</ol>
<p>Springåˆ‡é¢å¯ä»¥åº”ç”¨äº”ç§ç±»å‹çš„é€šçŸ¥ï¼š</p>
<ol>
<li>Beforeï¼šåœ¨æ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰è°ƒç”¨é€šçŸ¥</li>
<li>Afterï¼šåœ¨æ–¹æ³•å®Œæˆä¹‹åè°ƒç”¨é€šçŸ¥ï¼Œæ— è®ºæ–¹æ³•æ˜¯å¦æ‰§è¡ŒæˆåŠŸ</li>
<li>After-returningï¼šåœ¨æ–¹æ³•æˆåŠŸæ‰§è¡Œä¹‹åè°ƒç”¨é€šçŸ¥</li>
<li>After-throwingï¼šåœ¨æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ä¹‹åè°ƒç”¨é€šçŸ¥</li>
<li>Aroundï¼šé€šçŸ¥åŒ…æ‹¬äº†è¢«é€šçŸ¥çš„æ–¹æ³•ï¼Œåœ¨è¢«é€šçŸ¥çš„æ–¹æ³•è°ƒç”¨ä¹‹å‰å’Œè°ƒç”¨ä¹‹åæ‰§è¡Œè‡ªå®šä¹‰çš„è¡Œä¸º</li>
</ol>
<h2 id="AOPçš„ä½¿ç”¨"><a href="#AOPçš„ä½¿ç”¨" class="headerlink" title="AOPçš„ä½¿ç”¨"></a>AOPçš„ä½¿ç”¨</h2><p>æ–°å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºä¸€ä¸ªç›®æ ‡ç±»ï¼Œé‡Œé¢åŒ…å«éœ€è¦è¢«AOPä»£ç†å¢å¼ºçš„æ–¹æ³•<code>test</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TargetClass</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">&quot;: test()è¢«æ‰§è¡Œ&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasLength(value)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;valueä¸èƒ½ä¸ºç©º&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;new&quot;</span> + value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–å†™åˆ‡é¢ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(public * top.parak.TargetClass.test(..))&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;pointcut()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBefore</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;onBefore: &quot;</span> + joinPoint.getSignature().getName() +</span><br><span class="line">                <span class="string">&quot;()å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š&quot;</span> + Arrays.asList(joinPoint.getArgs()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;pointcut()&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAfter</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;onAfter: &quot;</span> + joinPoint.getSignature().getName() +</span><br><span class="line">                <span class="string">&quot;()æ‰§è¡Œç»“æŸï¼Œå‚æ•°ï¼š&quot;</span> + Arrays.asList(joinPoint.getArgs()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning(value = &quot;pointcut()&quot;, returning = &quot;result&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(JoinPoint joinPoint, Object result)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterReturning: &quot;</span> + joinPoint.getSignature().getName() +</span><br><span class="line">                <span class="string">&quot;()æ‰§è¡Œè¿”å›ï¼Œå‚æ•°ï¼š&quot;</span> + Arrays.asList(joinPoint.getArgs()) + <span class="string">&quot;ï¼Œè¿”å›å€¼ï¼š&quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing(value = &quot;pointcut()&quot;, throwing = &quot;exception&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowing</span><span class="params">(JoinPoint joinPoint, Exception exception)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterThrowing: &quot;</span> + joinPoint.getSignature().getName() +</span><br><span class="line">                <span class="string">&quot;()æ‰§è¡Œå‡ºé”™ï¼Œå‚æ•°ï¼š&quot;</span> + Arrays.asList(joinPoint.getArgs()) + <span class="string">&quot;ï¼Œå¼‚å¸¸ï¼š&quot;</span> + exception.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¯¥åˆ‡é¢åŒ…å«äº†4ä¸ªé€šçŸ¥æ–¹æ³•ï¼š</p>
<ol>
<li>å‰ç½®é€šçŸ¥ï¼ˆ@Beforeï¼‰ï¼šåœ¨ç›®æ ‡æ–¹æ³•è°ƒç”¨ä¹‹å‰è°ƒç”¨é€šçŸ¥</li>
<li>åç½®é€šçŸ¥ï¼ˆ@Afterï¼‰ï¼šåœ¨ç›®æ ‡æ–¹æ³•å®Œæˆä¹‹åè°ƒç”¨é€šçŸ¥</li>
<li>è¿”å›é€šçŸ¥ï¼ˆ@AfterReturningï¼‰ï¼šåœ¨ç›®æ ‡æ–¹æ³•æˆåŠŸæ‰§è¡Œä¹‹åé€šçŸ¥</li>
<li>å¼‚å¸¸é€šçŸ¥ï¼ˆ@AfterThrowingï¼‰ï¼šåœ¨ç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ä¹‹åé€šçŸ¥</li>
</ol>
<p>é€šçŸ¥æ˜¯é¡ºåºåœ¨ä¸åŒçš„Springç‰ˆæœ¬ä¸­ä¼šæœ‰æ‰€ä¸åŒï¼š</p>
<ul>
<li>Spring4.x<ol>
<li>æ­£å¸¸æƒ…å†µï¼š@Before â€”&gt; ç›®æ ‡æ–¹æ³• â€”&gt; @After â€”&gt; @AfterReturning</li>
<li>å¼‚å¸¸æƒ…å†µï¼š@Before â€”&gt; ç›®æ ‡æ–¹æ³• â€”&gt; @After â€”&gt; @AfterThrowing</li>
</ol>
</li>
<li>Spring5.x<ol>
<li>æ­£å¸¸æƒ…å†µï¼š@Before â€”&gt; ç›®æ ‡æ–¹æ³• â€”&gt; @AfterReturning â€”&gt; @After</li>
<li>å¼‚å¸¸æƒ…å†µï¼š@Before â€”&gt; ç›®æ ‡æ–¹æ³• â€”&gt; @AfterThrowing â€”&gt; @After</li>
</ol>
</li>
</ul>
<p>ç¼–å†™SpringBootå¯åŠ¨ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AOPApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = SpringApplication.run(AOPApplication.class, args);</span><br><span class="line">        TargetClass targetClass = applicationContext.getBean(TargetClass.class);</span><br><span class="line">        targetClass.test(<span class="string">&quot;aop&quot;</span>);</span><br><span class="line">        targetClass.test(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‚æ•°ï¼š&quot;aop&quot;</span></span><br><span class="line">onBefore: test()å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[<span class="type">aop</span>]</span><br><span class="line">TargetClass: test()è¢«æ‰§è¡Œ</span><br><span class="line">afterReturning: test()æ‰§è¡Œè¿”å›ï¼Œå‚æ•°ï¼š[<span class="type">aop</span>]ï¼Œè¿”å›å€¼ï¼šnewaop</span><br><span class="line">onAfter: test()æ‰§è¡Œç»“æŸï¼Œå‚æ•°ï¼š[<span class="type">aop</span>]</span><br><span class="line"><span class="comment"># å‚æ•°ï¼š&quot;&quot;</span></span><br><span class="line">onBefore: test()å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[]</span><br><span class="line">TargetClass: test()è¢«æ‰§è¡Œ</span><br><span class="line">afterThrowing: test()æ‰§è¡Œå‡ºé”™ï¼Œå‚æ•°ï¼š[]ï¼Œå¼‚å¸¸ï¼švalueä¸èƒ½ä¸ºç©º</span><br><span class="line">onAfter: test()æ‰§è¡Œç»“æŸï¼Œå‚æ•°ï¼š[]</span><br></pre></td></tr></table></figure>


<h2 id="EnableAspectAutoProxy"><a href="#EnableAspectAutoProxy" class="headerlink" title="@EnableAspectAutoProxy"></a>@EnableAspectAutoProxy</h2><p>åœ¨å‰é¢å¼•å…¥çš„<code>spring-boot-starter-aop</code>ä¸­ï¼Œ@Enableæ¨¡å—é©±åŠ¨æ³¨è§£<code>@EnableAspectJAutoProxy</code>ç”¨äºå¼€å¯AspectJè‡ªåŠ¨ä»£ç†ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(AspectJAutoProxyRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAspectJAutoProxy &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">proxyTargetClass</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">exposeProxy</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ³¨è§£ç±»é€šè¿‡<code>@Import</code>å¯¼å…¥äº†<code>AspectJAutoProxyRegistrar</code>AspectJè‡ªåŠ¨ä»£ç†æ³¨å†Œå™¨ï¼ŒæŸ¥çœ‹<code>AspectJAutoProxyRegistrar</code>æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image1.png" class="" title="image1"><br />
<p>è¿™ä¸ªç±»å®ç°äº†<code>ImportBeanDefinitionRegistrar</code>æ¥å£ï¼Œé€šè¿‡æ³¨é‡Šå¯ä»¥äº†è§£ï¼Œè¿™ä¸ªæ³¨å†Œå™¨çš„ä½œç”¨æ˜¯å¾€IOCå®¹å™¨ä¸­æ³¨å†Œä¸€ä¸ª<code>AnnotationAwareAspectJAutoProxyCreator</code>ï¼ˆæ³¨è§£é©±åŠ¨çš„AspectJè‡ªåŠ¨ä»£ç†åˆ›å»ºå™¨)çš„Beanã€‚<br>é‡ç‚¹å…³æ³¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BeanDefinition <span class="title">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šè°ƒç”¨ä¸‹é¢æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image2.png" class="" title="image2"><br />
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒé€»è¾‘ä¸ºé€šè¿‡<code>RootBeanDefinition</code>å‘IOCæ³¨å†Œäº†åç§°ä¸º<code>AUTO_PROXY_CREATOR_BEAN_NAME</code>ï¼ˆå¸¸é‡ï¼Œå€¼ä¸º<code>org.springframework.aop.config.internalAutoProxyCreator</code>ï¼‰ï¼Œç±»å‹ä¸º<code>AnnotationAwareAspectJAutoProxyCreator</code>çš„Beanã€‚<br>0pâ€™lo</p>
<blockquote>
<p>æ€»ç»“ï¼š@EnableAspectJAutoProxyæ¨¡å—é©±åŠ¨æ³¨è§£å‘IOCå®¹å™¨ä¸­æ³¨å†Œäº†ç±»å‹ä¸º<code>AnnotationAwareAspectJAutoProxyCreator</code>çš„beanã€‚</p>
</blockquote>
<h2 id="AnnotationAwareAspectJAutoProxyCreator"><a href="#AnnotationAwareAspectJAutoProxyCreator" class="headerlink" title="AnnotationAwareAspectJAutoProxyCreator"></a>AnnotationAwareAspectJAutoProxyCreator</h2><p>é€šè¿‡å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬çš„ç›®å…‰èšç„¦åœ¨<code>AnnotationAwareAspectJAutoProxyCreator</code>ç±»ä¸Šï¼Œä¸ºäº†ææ¸…æ¥šè¿™ä¸ªç±»çš„ä½œç”¨ï¼Œå…ˆæ‹æ¸…ç±»çš„å±‚çº§å…³ç³»ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image3.png" class="" title="image3"><br />
<p>å¯ä»¥çœ‹åˆ°<code>AnnotationAwareAspectJAutoProxyCreator</code>çš„çˆ¶ç±»<code>AbstractAutoProxyCreator</code>å®ç°äº†<code>SmartInstantiationAwareBeanPostProcessor</code>å’Œ<code>BeanFactoryAware</code>æ¥å£ã€‚å®ç°<code>BeanFactoryAware</code>ç”¨äºåœ¨Beanåˆå§‹åŒ–æ—¶æ³¨å…¥<code>BeanFactory</code>ï¼Œè€Œ<code>SmartInstantiationAwareBeanPostProcessor</code>æ¥å£çš„çˆ¶ç±»ä¸º<code>InstantiationAwareBeanPostProcessor</code>ï¼Œè¯¥æ¥å£ç»§æ‰¿è‡ª<code>BeanPostProcesor</code>ã€‚<code>BeanPostProcessor</code>å’Œ<code>InstantiationAwareBeanProcessor</code>æ¥å£åŒ…å«ä¸€äº›ç”¨äºBeanå®ä¾‹åŒ–å’Œåˆå§‹åŒ–å‰åè¿›è¡Œè‡ªå®šä¹‰æ“ä½œçš„æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥å¤§ä½“çŒœæµ‹å‡ºç›®æ ‡çš„ä»£ç†æ˜¯åœ¨è¿™äº›æ¥å£æ–¹æ³•ä¸­å®ç°çš„ã€‚<br>æŸ¥çœ‹<code>AbstractAutoProxyCreator</code>çš„æºä»£ç ï¼Œå®ƒå®ç°äº†<code>BeanPostProcessor</code>å’Œ<code>InstantiationAwareBeanProcessor</code>æ¥å£ï¼Œé‡å†™äº†<code>InstantiationAwareBeanProcessor</code>çš„<code>postProcessBeforeInstantiation</code>æ–¹æ³•ï¼ˆè‡ªå®šä¹‰Beanå®ä¾‹åŒ–å‰çš„æ“ä½œé€»è¾‘ï¼‰å’Œ<code>BeanPostProcessor</code>çš„<code>postProcessAfterInitialization</code>æ–¹æ³•ï¼ˆè‡ªå®šä¹‰Beanåˆå§‹åŒ–åçš„æ“ä½œé€»è¾‘ï¼‰ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image4.png" class="" title="image4"><br />
<p>æ‰€ä»¥åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸Šæ‰“ä¸Šä¸¤ä¸ªæ–­ç‚¹ï¼Œç”¨äºåç»­Debugï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image5.png" class="" title="image5"><br />


<h2 id="AOPåˆ›å»ºä»£ç†è¿‡ç¨‹"><a href="#AOPåˆ›å»ºä»£ç†è¿‡ç¨‹" class="headerlink" title="AOPåˆ›å»ºä»£ç†è¿‡ç¨‹"></a>AOPåˆ›å»ºä»£ç†è¿‡ç¨‹</h2><p>ä½¿ç”¨Debugæ–¹å¼å¯åŠ¨ä¸Šè¿°AOPçš„Demoï¼Œå› ä¸ºåç½®å¤„ç†å™¨å¯¹æ‰€æœ‰Beanéƒ½ç”Ÿæ•ˆï¼Œæ‰€ä»¥æ¯ä¸ªBeanåˆ›å»ºæ—¶éƒ½ä¼šè¿›å…¥æˆ‘ä»¬åˆšåˆšæ‰“æ–­ç‚¹çš„ä¸¤ä¸ªæ–¹æ³•ä¸­ã€‚ä½†æˆ‘ä»¬åªå…³å¿ƒSpring AOPæ˜¯å¦‚ä½•å¢å¼ºæˆ‘ä»¬çš„ç›®æ ‡ç±»<code>TargetClass</code>çš„ï¼Œæ‰€ä»¥å¦‚æœBeanç±»å‹ä¸æ˜¯<code>TargetClass</code>ï¼Œæˆ‘ä»¬ç›´æ¥ç‚¹å‡»Resume Programè·³è¿‡ï¼ŒçŸ¥é“Beanç±»å‹æ˜¯<code>TargetClass</code>ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image6.png" class="" title="image6"><br />
<p><code>postProcessBeforeInstantiation</code>æ–¹æ³•ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image7.png" class="" title="image7"><br />
<p>ï¼ˆ1ï¼‰é€šè¿‡Beanåç§°å’ŒBeanç±»å‹è·å–è¯¥Beançš„å”¯ä¸€ç¼“å­˜é”®åï¼Œ<code>getCache</code>æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image8.png" class="" title="image8"><br />
<p>åœ¨è¿™é‡Œï¼ŒcacheKeyçš„å€¼ä¸ºtargetClassã€‚<br>ï¼ˆ2ï¼‰åˆ¤æ–­å½“å‰Beanï¼ˆTargetClassï¼‰æ˜¯å¦åŒ…å«åœ¨advisedBeansé›†åˆä¸­ï¼ˆAbstractAutoProxyCreatorçš„æˆå‘˜å˜é‡ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** Default is global AdvisorAdapterRegistry. */</span></span><br><span class="line"><span class="keyword">private</span> AdvisorAdapterRegistry advisorAdapterRegistry = GlobalAdvisorAdapterRegistry.getInstance();</span><br></pre></td></tr></table></figure>
<p>advisedBeansç”¨äºå­˜æ”¾Beanæ˜¯å¦éœ€è¦å¢å¼ºçš„æ ‡è®°ï¼Œé”®ä¸ºæ¯ä¸ªBeançš„cacheKeyï¼Œå€¼ä¸ºå¸ƒå°”ç±»å‹ï¼Œtrueè¡¨ç¤ºéœ€è¦å¢å¼ºï¼Œfalseè¡¨ç¤ºä¸éœ€è¦å¢å¼ºï¼Œæ­¤æ—¶TargetClassè¿˜æœªå®ä¾‹åŒ–ï¼Œæ‰€ä»¥è‡ªç„¶ä¸åœ¨è¯¥é›†åˆä¸­ã€‚<br>ï¼ˆ3ï¼‰åˆ¤æ–­å½“å‰Beanï¼ˆTargetClassï¼‰æ˜¯å¦åŸºç¡€ç±»ï¼ŒæŸ¥çœ‹<code>AnnotationAwareAspectJAutoProxyCreator</code>çš„<code>isInfrastructureClass</code>æ–¹æ³•æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image9.png" class="" title="image9"><br />
<p>å…¶ä¸­<code>isInfrastructureClass</code>è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image10.png" class="" title="image10"><br />
<p><code>this.aspectAdvisorFactory.isAspect</code>æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image11.png" class="" title="image11"><br />
<p>æ‰€ä»¥è¿™ä¸€æ­¥çš„é€»è¾‘ä¸ºï¼šåˆ¤æ–­è¯¥å½“å‰Beanï¼ˆTargetClassï¼‰æ˜¯å¦æ˜¯<code>Advice</code>ã€<code>PointCut</code>ã€<code>Advisor</code>ã€<code>AopInfrastructureBean</code>çš„å­ç±»æˆ–è€…æ˜¯å¦ä¸ºåˆ‡é¢ç±»ï¼ˆè¢«<code>@Aspect</code>æ³¨è§£æ ‡æ³¨ï¼‰ã€‚<br>ï¼ˆ4ï¼‰åˆ¤æ–­æ˜¯å¦éœ€è¦è·³è¿‡ï¼Œ<code>shouldSkip</code>æ–¹æ³•æºç å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image12.png" class="" title="image12"><br />
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image13.png" class="" title="image13"><br />
<p>é€šè¿‡Beanåç§°åˆ¤æ–­æ˜¯å¦ä»¥<code>AutowireCapableBeanFactory._ORIGINAL_INSTANCE_SUFFIX_</code>ï¼ˆ.ORIGINALï¼‰ç»“å°¾ï¼Œæ˜¯çš„è¯è¿”å›trueä»£è¡¨è·³è¿‡å¤„ç†ã€‚<br>æ˜¾ç„¶ï¼ŒTargetClassä¸ç¬¦åˆ3å’Œ4ï¼Œç»§ç»­èµ°ç¬¬5æ­¥ã€‚<br>ï¼ˆ5ï¼‰å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†TargetSourceï¼Œåˆ™åœ¨æ­¤å¤„ç†Beanä»£ç†ï¼Œä»¥å–ä»£ç›®æ ‡Beançš„åç»­é»˜è®¤å®ä¾‹åŒ–æ–¹å¼ã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰è‡ªå®šä¹‰TargetClassï¼Œæ‰€ä»¥ç›´æ¥è·³è¿‡ã€‚</p>
<p>ç»è¿‡ä»¥ä¸Šäº”æ­¥ï¼Œå°±TargetClassè¿™ä¸ªBeanè€Œè¨€ï¼Œ<code>postProcessBeforeInstantiation</code>æ–¹æ³•æœ€ç»ˆè¿”å›nullã€‚Beanå®ä¾‹åŒ–å‰ç½®å¤„ç†åˆ°æ­¤å®Œæ¯•ï¼Œç‚¹å‡»Resume Programï¼Œç»§ç»­Beançš„åç»­ç”Ÿå‘½å‘¨æœŸå¤„ç†é€»è¾‘ï¼Œç¨‹åºè·³è½¬åˆ°Beanåˆå§‹åŒ–åç½®å¤„ç†æ–¹æ³•<code>postProcessAfterInitialization</code>ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image14.png" class="" title="image14"><br />
<p>é‡ç‚¹å…³æ³¨<code>wrapIfNecessary</code>æ–¹æ³•ï¼ŒæŸ¥çœ‹<code>wrapIfNecessary</code>æ–¹æ³•æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image15.png" class="" title="image15"><br />
<p>ï¼ˆ1ï¼‰getAdvicesAndAdvisorsæ–¹æ³•å†…éƒ¨ä¸»è¦åŒ…å«ä»¥ä¸‹è¿™äº›é€»è¾‘ï¼š</p>
<ol>
<li>è·å–æ‰€æœ‰çš„é€šçŸ¥æ–¹æ³•ï¼ˆåˆ‡é¢é‡Œå®šä¹‰çš„å„ä¸ªæ–¹æ³•ï¼‰ï¼›</li>
<li>é€šè¿‡åˆ‡ç‚¹è¡¨è¾¾å¼åˆ¤æ–­è¿™äº›é€šçŸ¥æ–¹æ³•æ˜¯å¦ä¸ºå½“å‰Beanæ‰€ç”¨ï¼›</li>
<li>å¦‚æœæœ‰ç¬¦åˆçš„é€šçŸ¥æ–¹æ³•ï¼Œåˆ™å¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼ˆæ’åºè§„åˆ™ä¸åŒç‰ˆæœ¬Springæœ‰æ‰€ä¸åŒï¼Œä¸Šé¢å·²ç»æåŠï¼‰ã€‚</li>
</ol>
<p>åœ¨å‰é¢çš„AOPä¾‹å­ä¸­ï¼Œåˆ‡é¢MyAspecté‡Œçš„é€šçŸ¥æ–¹æ³•å°±æ˜¯ä¸ºäº†å¢å¼ºTargetClassæ‰€è®¾çš„ï¼ˆæ ¹æ®åˆ‡ç‚¹è¡¨è¾¾å¼ï¼‰ï¼Œæ‰€ä»¥<code>getAdvicesAndAdvisorsForBean</code>æ–¹æ³•è¿”å›å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image16.png" class="" title="image16"><br />
<p>è¿™äº›é€šçŸ¥æ–¹æ³•å°±æ˜¯æˆ‘ä»¬åœ¨MyAspectåˆ‡é¢é‡Œå®šä¹‰çš„é€šçŸ¥æ–¹æ³•ã€‚<br>ï¼ˆ2ï¼‰å¦‚æœè¯¥Beançš„é€šçŸ¥æ–¹æ³•é›†åˆä¸ä¸ºç©ºçš„è¯ï¼Œåˆ™åˆ›å»ºè¯¥Beançš„ä»£ç†å¯¹è±¡ï¼Œå…·ä½“æŸ¥çœ‹<code>createProxy</code>æ–¹æ³•æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image17.png" class="" title="image17"><br />
<p>ç»§ç»­è·Ÿè¸ª<code>proxyFactory.getProxy(getProxyClassLoader())</code>æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image18.png" class="" title="image18"><br />
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image19.png" class="" title="image19"><br />
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image20.png" class="" title="image20"><br />
<p>Springä¼šåˆ¤æ–­å½“å‰ä½¿ç”¨å“ªç§ä»£ç†å¯¹è±¡ï¼ˆä¸€èˆ¬æ¥è¯´Beanæœ‰å®ç°æ¥å£æ—¶ï¼Œä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼Œå½“Beanæ²¡æœ‰å®ç°æ¥å£æ—¶ï¼Œä½¿ç”¨CglibåŠ¨æ€ä»£ç†ã€‚åœ¨SpirngBootä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡spring.aop.proxy-target-class=trueé…ç½®æ¥å¼ºåˆ¶ä½¿ç”¨Cglibä»£ç†ï¼‰ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image21.png" class="" title="image21"><br />
<p>åç»­ä»IOCå®¹å™¨ä¸­è·å¾—çš„TargetClasså°±æ˜¯è¢«ä»£ç†åçš„å¯¹è±¡ï¼Œæ‰§è¡Œä»£ç†å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•çš„æ—¶å€™ï¼Œä»£ç†å¯¹è±¡ä¼šæ‰§è¡Œç›¸åº”çš„é€šçŸ¥æ–¹æ³•é“¾ã€‚<br>â€‹</p>
<h2 id="ç”Ÿæˆæ‹¦æˆªå™¨é“¾"><a href="#ç”Ÿæˆæ‹¦æˆªå™¨é“¾" class="headerlink" title="ç”Ÿæˆæ‹¦æˆªå™¨é“¾"></a>ç”Ÿæˆæ‹¦æˆªå™¨é“¾</h2><p>AOPä»£ç†å¯¹è±¡ç”Ÿæˆåï¼Œæˆ‘ä»¬æ¥ç€å…³æ³¨ä»£ç†å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œé€šçŸ¥æ–¹å¼æ˜¯æ€ä¹ˆè¢«æ‰§è¡Œçš„ã€‚<br>å…ˆå°†å‰é¢çš„æ‰€æœ‰æ–­ç‚¹å»æ‰ï¼Œç„¶ååœ¨AOPApplicationçš„å¦‚ä¸‹ä½ç½®æ‰“ä¸Šæ–­ç‚¹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image22.png" class="" title="image22"><br />
<p>å†æ¬¡ä»¥Debugæ–¹å¼å¯åŠ¨ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°è·å–åˆ°çš„TargetClasså°±æ˜¯å‰é¢Cglibä»£ç†åçš„Beanï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image23.png" class="" title="image23"><br />
<p>ç‚¹å‡»Step Intoè¿›å…¥<code>test</code>æ–¹æ³•å†…éƒ¨è°ƒç”¨é€»è¾‘ï¼Œä¼šå‘ç°ç¨‹åºè·³è½¬åˆ°äº†<code>CglibAopProxy</code>çš„<code>intercept</code>æ–¹æ³•ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•è¢«<code>CglibAopProxy</code>çš„<code>intercept</code>æ–¹æ³•æ‹¦æˆªäº†ï¼Œè¯¥æ‹¦æˆªæ–¹æ³•ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image24.png" class="" title="image24"><br />
<p>è¿™é‡Œé‡ç‚¹å…³æ³¨<code>getInterceptorsAndDynamicInterceptionAdvice</code>æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image25.png" class="" title="image25"><br />

<blockquote>
<p>æ‰€è°“çš„æ‹¦æˆªå™¨é“¾ï¼Œå°±æ˜¯åœ¨ä»£ç†å¯¹è±¡çš„æŸä¸ªæ–¹æ³•è¢«æ‰§è¡Œæ—¶ï¼Œä»é€šçŸ¥æ–¹æ³•é›†åˆï¼ˆåˆ›å»ºä»£ç†å¯¹è±¡çš„æ—¶å€™å°±å·²ç»é€šçŸ¥é›†åˆä¿å­˜åœ¨ä»£ç†å¯¹è±¡ä¸­äº†ï¼‰ä¸­ç­›é€‰å‡ºé€‚ç”¨äºè¯¥æ–¹æ³•çš„é€šçŸ¥ï¼Œç„¶åå°è£…ä¸ºæ‹¦æˆªå™¨å¯¹è±¡é›†åˆï¼ˆç±»å‹ä¸ºMethodInterceptorï¼‰ã€‚</p>
</blockquote>
<p>ç»§ç»­æŸ¥çœ‹<code>this.advisorChainFactory.getInterceptorsAndDynamicInterceptionAdvice</code>æ–¹æ³•æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image26.png" class="" title="image26"><br />
<p>åœ¨<code>intercept</code>æ–¹æ³•çš„<code>this.advised.getInterceptorsAndDynamicInterceptionAdvice_(_method, targetClass_)_</code>è¿™ä¸€è¡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œç‚¹å‡»Resume Programï¼Œçœ‹åˆ°æ‹¦æˆªå™¨é“¾çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image27.png" class="" title="image27"><br />
<p>æ‹¦æˆªå™¨é“¾ç¬¬ä¸€ä¸ªå…ƒç´ ç±»å‹ä¸º<code>ExposeInvocationInterceptor</code>ï¼Œæ˜¯é»˜è®¤çš„æ‹¦æˆªå™¨ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ã€‚<br>å‰©ä¸‹å››ä¸ªç±»å‹ä¾æ¬¡ä¸ºï¼š</p>
<ul>
<li><code>MethodBeforeAdviceInterceptor</code></li>
<li><code>AspectJAfterAdvice</code></li>
<li><code>AfterReturningAdviceInterceptor</code></li>
<li><code>AspectJAfterThrowingAdvice</code></li>
</ul>
<p>å®ƒä»¬éƒ½æ˜¯<code>MethodInterceptor</code>çš„å®ç°ç±»ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image28.png" class="" title="image28"><br />


<h2 id="é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³•"><a href="#é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³•" class="headerlink" title="é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³•"></a>é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³•</h2><p>è·å–åˆ°äº†ä»£ç†å¯¹è±¡ç›®æ ‡æ–¹æ³•çš„æ‹¦æˆªå™¨é“¾åï¼Œæˆ‘ä»¬æœ€åæ¥å…³æ³¨è¿™äº›æ‹¦æˆªå™¨æ˜¯å¦‚ä½•é“¾å¼è°ƒç”¨é€šçŸ¥æ–¹æ³•çš„ã€‚è·å–æ‹¦æˆªå™¨é“¾å¹¶ä¸”æ‹¦æˆªå™¨é“¾ä¸ä¸ºç©ºæ—¶ï¼Œ<code>CglibAopProxy</code>çš„<code>intercept</code>æ–¹æ³•åˆ›å»º<code>CglibMethodInvoation</code>å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å®ƒçš„<code>proceed</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image29.png" class="" title="image29"><br />
<p>æŸ¥çœ‹<code>CglibMethodInvocation</code>æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image30.png" class="" title="image30"><br />
<p>æŸ¥çœ‹çˆ¶ç±»<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•æºç ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image31.png" class="" title="image31"><br />
<p>æ¸…é™¤ä¹‹å‰æ‰“çš„æ‰€æœ‰æ–­ç‚¹ï¼Œåœ¨è¯¥æ–¹æ³•ä¸Šç¬¬ä¸€è¡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œé‡æ–°ä»¥Debugæ–¹å¼å¯åŠ¨ç¨‹åºï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image32.png" class="" title="image32"><br />
<p>ç¨‹åºç¬¬ä¸€æ¬¡è¿›å…¥è¯¥æ–¹æ³•æ—¶<code>currentInterceptorIndex</code>å€¼ä¸º-1ï¼Œ<code>this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex)</code>å–å‡ºæ‹¦æˆªå™¨é“¾ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨<code>ExposeInvocationInterceptor</code>ï¼Œæ–¹æ³•æœ€åè°ƒç”¨è¯¥æ‹¦æˆªå™¨çš„<code>invoke</code>æ–¹æ³•ï¼Œç‚¹å‡»Step intoï¼Œè¿›å…¥<code>ExposeInvocationInterceptor</code>çš„<code>invoke</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image33.png" class="" title="image33"><br />
<p><code>mi</code>å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„<code>ReflectiveMethodInvocation</code>å¯¹è±¡ï¼Œç¨‹åºæ‰§è¡Œåˆ°<code>mi.proceed</code>æ–¹æ³•æ—¶ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image34.png" class="" title="image34"><br />
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶ç¨‹åºç¬¬äºŒæ¬¡æ‰§è¡Œ<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•ï¼Œ<code>currentInterceptorIndex</code>å€¼ä¸º0ï¼Œ<code>this.interceptorsAndDynamicMethodMatchers.get_(_++this.currentInterceptorIndex_)_</code>å–æ‹¦æˆªå™¨é“¾ç¬¬äºŒä¸ªæ‹¦æˆªå™¨<code>MethodBeforeInterceptor</code>ï¼Œæ–¹æ³•æœ€åè°ƒç”¨è¯¥æ‹¦æˆªå™¨çš„<code>invoke</code>æ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image35.png" class="" title="image35"><br />
<p>å¯ä»¥çœ‹åˆ°<code>MethodBeforeInterceptor</code>çš„<code>invoke</code>æ–¹æ³•ç¬¬ä¸€è¡Œè°ƒç”¨é€šçŸ¥æ–¹æ³•<code>before</code>ï¼Œæ­¤æ—¶æ§åˆ¶å°æ‰“å°å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">onBefore: test()å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[<span class="type">aop</span>]</span><br></pre></td></tr></table></figure>
<p>æ¥ç€åˆé€šè¿‡<code>mi.proceed</code>å†æ¬¡è°ƒç”¨<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image36.png" class="" title="image36"><br />
<p>æ­¤æ—¶ç¨‹åºç¬¬ä¸‰æ¬¡æ‰§è¡Œ<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•ï¼Œ<code>currentInterceptorIndex</code>å€¼ä¸º1ï¼Œ<code>this.interceptorsAndDynamicMethodMatchers.get_(_++this.currentInterceptorIndex_)_</code>å–æ‹¦æˆªå™¨é“¾ç¬¬ä¸‰ä¸ªæ‹¦æˆªå™¨<code>AspectJAfterAdvice</code>ï¼Œæ–¹æ³•æœ€åè°ƒç”¨è¯¥æ‹¦æˆªå™¨çš„<code>invoke</code>æ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image37.png" class="" title="image37"><br />
<p>å¯ä»¥çœ‹åˆ°<code>AspectJAfterAdvice</code>çš„<code>invoke</code>æ–¹æ³•å†…é€šè¿‡<code>mi.proceed</code>å†æ¬¡è°ƒç”¨<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image38.png" class="" title="image38"><br />
<p>æ­¤æ—¶ç¨‹åºç¬¬å››æ¬¡æ‰§è¡Œ<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•ï¼Œ<code>currentInterceptorIndex</code>çš„å€¼ä¸º2ï¼Œ<code>this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex)</code>å–å‡ºæ‹¦æˆªå™¨é“¾ç¬¬å››ä¸ªæ‹¦æˆªå™¨<code>AfterReturningAdviceInterceptor</code>ï¼Œæ–¹æ³•æœ€åè°ƒç”¨è¯¥æ‹¦æˆªå™¨çš„<code>invoke</code>æ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image39.png" class="" title="image39"><br />
<p>å¯ä»¥çœ‹åˆ°<code>AfterReturningAdviceInterceptor</code>çš„<code>invoke</code>æ–¹æ³•å†…é€šè¿‡<code>mi.proceed</code>å†æ¬¡è°ƒç”¨<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image40.png" class="" title="image40"><br />
<p>æ­¤æ—¶ç¨‹åºç¬¬äº”æ¬¡æ‰§è¡Œ<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•ï¼Œ<code>currentInterceptorIndex</code>å€¼ä¸º3ï¼Œ<code>this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex)</code>å–å‡ºæ‹¦æˆªå™¨é“¾ç¬¬äº”ä¸ªæ‹¦æˆªå™¨<code>AspectJAfterThrowingAdvice</code>ï¼Œæ–¹æ³•æœ€åè°ƒç”¨è¯¥æ‹¦æˆªå™¨çš„<code>invoke</code>æ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image41.png" class="" title="image41"><br />
<p>å¯ä»¥çœ‹åˆ°<code>AspectJAfterThrowingAdvice</code>çš„<code>invoke</code>æ–¹æ³•å†…é€šè¿‡<code>mi.proceed</code>å†æ¬¡è°ƒç”¨<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•ï¼ŒStep Intoè¿›å…¥è¯¥æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image42.png" class="" title="image42"><br />
<p>æ­¤æ—¶ç¨‹åºç¬¬å…­æ¬¡æ‰§è¡Œ<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•ï¼Œ<code>currentInterceptorIndex</code>å€¼ä¸º4ï¼Œæ¡ä»¶ç¨‹åºï¼Œæ‰€ä»¥æ‰§è¡Œ<code>invokeJoinPoint</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨é€šè¿‡åå°„è°ƒç”¨äº†ç›®æ ‡æ–¹æ³•ï¼Œæ‰§è¡Œåï¼Œæ§åˆ¶å°æ‰“å°å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">onBefore: test()å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[<span class="type">aop</span>]</span><br><span class="line">TargetClass: test()è¢«æ‰§è¡Œ</span><br></pre></td></tr></table></figure>
<p>éšç€<code>invokeJoinpoint()</code>æ–¹æ³•æ‰§è¡Œç»“æŸè¿”å›å‡ºæˆ˜ï¼Œç¨‹åºå›åˆ°<code>AspectJAfterThrowingAdvice</code>çš„<code>invoke</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image43.png" class="" title="image43"><br />
<p><code>this.advice.afterReturning</code>æ‰§è¡Œ<code>afterReturning</code>é€šçŸ¥æ–¹æ³•ï¼Œæ§åˆ¶å°æ‰“å°å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">onBefore: test()å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[<span class="type">aop</span>]</span><br><span class="line">TargetClass: test()è¢«æ‰§è¡Œ</span><br><span class="line">onAfter: test()æ‰§è¡Œç»“æŸï¼Œå‚æ•°ï¼š[<span class="type">aop</span>]</span><br></pre></td></tr></table></figure>
<p><code>AfterReturningAdviceInterceptor</code>çš„<code>invoke</code>æ–¹æ³•æ‰§è¡Œç»“æŸå‡ºæ ˆï¼Œç¨‹åºå›åˆ°<code>AspectJAfterAdvice</code>çš„<code>invoke</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image44.png" class="" title="image44"><br />
<p><code>AspectJAfterAdvice</code>çš„<code>invoke</code>æ–¹æ³•æœ€ç»ˆæ‰§è¡Œfinally afteré€»è¾‘ï¼Œæ§åˆ¶å°æ‰“å°å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">onBefore: test()å¼€å§‹æ‰§è¡Œï¼Œå‚æ•°ï¼š[<span class="type">aop</span>]</span><br><span class="line">TargetClass: test()è¢«æ‰§è¡Œ</span><br><span class="line">onAfter: test()æ‰§è¡Œç»“æŸï¼Œå‚æ•°ï¼š[<span class="type">aop</span>]</span><br><span class="line">afterReturning: test()æ‰§è¡Œè¿”å›ï¼Œå‚æ•°ï¼š[<span class="type">aop</span>]ï¼Œè¿”å›å€¼ï¼šnewaop</span><br></pre></td></tr></table></figure>
<p><code>AspectJAfterAdvice</code>çš„<code>invoke</code>æ–¹æ³•æ‰§è¡Œç»“æŸå‡ºæ ˆï¼Œç¨‹åºå›åˆ°<code>MethodBeforeAdviceInterceptor</code>çš„<code>invoke</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image45.png" class="" title="image45"><br />
<p><code>MethodBeforeAdviceInterceptor</code>çš„<code>invoke</code>æ–¹æ³•æ­£å¸¸æ‰§è¡Œç»“æŸï¼Œå‡ºæ ˆï¼Œç¨‹åºå›åˆ°<code>ExposeInvocationInterceptor</code>çš„<code>invoke</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image46.png" class="" title="image46"><br />
<p><code>ExposeInvocationInterceptor</code>çš„<code>invoke</code>æ–¹æ³•æ‰§è¡Œç»“æŸå‡ºæ ˆï¼Œç¨‹åºå›åˆ°<code>CglibAopProxy</code>çš„<code>intercept</code>æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/image47.png" class="" title="image47"><br />
<p><code>CglibAopProxy</code>çš„<code>intercep</code>æ‰§è¡Œå®Œæ¯•åï¼Œæ•´ä¸ªAOPçš„æ‹¦æˆªå™¨é“¾è°ƒç”¨ä¹Ÿéšä¹‹ç»“æŸäº†ã€‚<br>â€‹</p>
<p>ä¸‹é¢ç”¨ä¸€å¼ å›¾æ€»ç»“æ‹¦æˆªå™¨é“¾è°ƒç”¨è¿‡ç¨‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/54880/spring-aop.svg" class="" title="spring-aop"><br />


<h2 id="æœ€ç»ˆæ€»ç»“"><a href="#æœ€ç»ˆæ€»ç»“" class="headerlink" title="æœ€ç»ˆæ€»ç»“"></a>æœ€ç»ˆæ€»ç»“</h2><p>ï¼ˆ1ï¼‰ç”Ÿæˆä»£ç†å¯¹è±¡</p>
<p><code>@EnableAspectJAutoProxy</code>æ¨¡å—é©±åŠ¨æ³¨è§£ç”¨äºå¼€å¯AspectJè‡ªåŠ¨ä»£ç†ï¼Œè¿™ä¸ªæ³¨è§£ä½¿ç”¨<code>@Import</code>å¯¼å…¥ä¸€ä¸ª<code>AspectJAutoProxyRegistrar</code>AspectJè‡ªåŠ¨ä»£ç†æ³¨å†Œå™¨ï¼Œè¿™ä¸ªç±»çš„ä½œç”¨æ˜¯å‘IOCå®¹å™¨ä¸­æ³¨å†Œ<code>AnnotationAwareAspectJAutoProxyCreator</code>ç»„ä»¶ã€‚</p>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code>çš„çˆ¶ç±»<code>AbstractAutoProxyCreator</code>é‡å†™äº†<code>InstantiationAwareBeanPostProcessor</code>çš„<code>postProcessBeforeInstantiation</code>æ–¹æ³•å’Œ<code>BeanPostProcessor</code>çš„<code>postProcessAfterInitialization</code>æ–¹æ³•ã€‚è‡ªå®šä¹‰Beançš„å®ä¾‹åŒ–å‰é€»è¾‘ä¸­åŒ…å«äº”ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼Œä¸»è¦ç›®çš„æ˜¯è¿›è¡Œä¸€äº›æ ¡éªŒï¼Œå¦‚æœBeanæœ¬èº«å°±æ˜¯åˆ‡é¢ç±»ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¢«ä»£ç†äº†ï¼›å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†TargetClassï¼Œåˆ™è¿”å›ä»£ç†åçš„Beanã€‚è‡ªå®šä¹‰Beançš„åˆå§‹åŒ–åé€»è¾‘ä¸­ï¼Œä¸»è¦è¿›è¡Œ<code>wrapIfNecessary</code>æ–¹æ³•ï¼Œå…ˆé€šè¿‡<code>getAdvicesAndAdvisors</code>æ–¹æ³•è·å–Beançš„é€šçŸ¥æ–¹æ³•é›†åˆå¹¶ä¸”è¿›è¡Œæ’åºï¼Œå¦‚æœé›†åˆä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡<code>createProxy</code>åˆ›å»ºè¯¥Beançš„ä»£ç†å¯¹è±¡ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>DefaultAopProxyFactory</code>çš„<code>createAopProxy</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šåˆ¤æ–­ä½¿ç”¨CGLIBè¿˜æ˜¯JDKåŠ¨æ€ä»£ç†ã€‚</p>
<p>ï¼ˆå¦‚æœä»£ç†å¯¹è±¡æ²¡æœ‰å®ç°æ¥å£æˆ–è€…å®ç°çš„éƒ½æ˜¯ç©ºæ¥å£ï¼Œåˆ™ä½¿ç”¨CGLIBåŠ¨æ€ä»£ç†ï¼›é»˜è®¤ä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼‰</p>
<p>ï¼ˆ2ï¼‰ç”Ÿæˆæ‹¦æˆªå™¨é“¾</p>
<p>ç›®æ ‡æ–¹æ³•ä¼šè¢«<code>CglibAopProxy</code>çš„<code>intercept</code>æ–¹æ³•æ‹¦æˆªï¼Œæ–¹æ³•é‡Œä¼šé€šè¿‡<code>getInterceptorsAndDynamicInterceptionAdvice</code>æ–¹æ³•è·å–ç›®æ ‡å¯¹è±¡çš„æ‹¦æˆªå™¨é“¾ï¼Œåˆ›å»ºç›®æ ‡æ–¹æ³•çš„ç¼“å­˜keyï¼Œé¦–å…ˆä»<code>methodCache</code>ç¼“å­˜ä¸­è·å–æ‹¦æˆªå™¨é“¾ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶è·å–åˆ°çš„å¿…ç„¶ä¸ºç©ºï¼Œé‚£ä¹ˆåˆ™è°ƒç”¨<code>advisorChainFactory</code>çš„<code>getInterceptorsAndDynamicInterceptionAdvice</code>æ–¹æ³•å°è£…æ‹¦æˆªå™¨é“¾ï¼Œå¹¶ä¸”å°†æ‹¦æˆªå™¨é“¾å­˜å…¥ç¼“å­˜ï¼Œæ­¤åè°ƒç”¨ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œæé«˜AOPçš„æ€§èƒ½ã€‚</p>
<p>ã€springboot2.4.0ã€(ä¹‹å‰çš„ç‰ˆæœ¬åé¢å››ä¸ªæ‹¦æˆªå™¨é¡ºåºåè½¬)æœ€ç»ˆç”Ÿæˆçš„æ‹¦æˆªå™¨é“¾çš„ç±»å‹é¡ºåºï¼š</p>
<ol>
<li><p><code>ExposeInvocationInterceptor</code>(é»˜è®¤æ‹¦æˆªå™¨)</p>
</li>
<li><p><code>MethodBeforeAdviceInterceptor</code>(æ–¹æ³•æ‰§è¡Œå‰æ‹¦æˆªå™¨)</p>
</li>
<li><p><code>AspectJAfterAdvice</code>(æ–¹æ³•æ‰§è¡Œå®Œæˆæ‹¦æˆªå™¨)</p>
</li>
<li><p><code>AfterReturningAdviceInterceptor</code>(æ–¹æ³•æ‰§è¡ŒæˆåŠŸæ‹¦æˆªå™¨)</p>
</li>
<li><p><code>AspectJAfterThrowingAdvice</code>(æ–¹æ³•æ‰§è¡Œå¼‚å¸¸æ‹¦æˆªå™¨)</p>
</li>
</ol>
<p>ï¼ˆ3ï¼‰é“¾å¼è°ƒç”¨é€šçŸ¥</p>
<p>å¦‚æœæ‹¦æˆªå™¨é“¾ä¸ºç©ºï¼Œåˆ™ç›´æ¥é€šè¿‡åå°„æ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼›ä¸ä¸ºç©ºåˆ™åˆ›å»ºä¸€ä¸ª<code>CglibMethodInvocation</code>å¯¹è±¡ï¼Œå®ƒæ˜¯<code>ReflectiveMethodInvocation</code>çš„å­ç±»ï¼Œå†…éƒ¨çš„<code>proceed</code>æ–¹æ³•ä¸»è¦é€»è¾‘è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªç´¢å¼•<code>currentInterceptorIndex</code>ï¼Œåˆå§‹å€¼ä¸º-1ï¼Œä¸€æ­¥æ­¥å–å‡ºæ‹¦æˆªå™¨é“¾ä¸­çš„æ‹¦æˆªå™¨ï¼Œå¹¶æ‰§è¡Œ<code>invoke</code>æ–¹æ³•ï¼Œ<code>invoke</code>æ–¹æ³•ä¸­ä¼šé€šè¿‡å‚æ•°<code>this</code>ç»§ç»­è°ƒç”¨<code>ReflectiveMethodInvocation</code>çš„<code>proceed</code>æ–¹æ³•å®ç°é“¾å¼è°ƒç”¨ã€‚</p>
<p>å¯¹äºæ‹¦æˆªå™¨ï¼Œ<code>ExposeInterceptorInvocation</code>ç›´æ¥è°ƒç”¨<code>proceed</code>ï¼Œ<code>MethodBeforeAdviceInterceptor</code>å…ˆæ‰§è¡Œ<code>before</code>å†æ‰§è¡Œ<code>proceed</code>ï¼Œ<code>AspectJAfterAdvice</code>å…ˆè°ƒç”¨<code>proceed</code>å†æ‰§è¡Œ<code>invokeAdviceMethod</code>ï¼Œ<code>AfterReturningAdviceInterceptor</code>å…ˆè°ƒç”¨<code>proceed</code>å†æ‰§è¡Œ<code>afterReturning</code>ï¼Œ<code>AspectJAfterThrowingAdvice</code>å…ˆè°ƒç”¨<code>proceed</code>å†æ‰§è¡Œ<code>invokeAdviceMethod</code>ï¼Œå…ˆé“¾å¼è°ƒç”¨ç„¶åæ–¹æ³•å‡ºæ ˆï¼Œæœ€åå›åˆ°<code>CglibAopProxy</code>çš„<code>intercept</code>æ–¹æ³•ï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œæ‹¦æˆªå™¨é“¾è°ƒç”¨éšä¹‹ç»“æŸã€‚</p>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring-å¾ªç¯ä¾èµ–</title>
    <url>/posts/408/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å¾ªç¯ä¾èµ–"><a href="#å¾ªç¯ä¾èµ–" class="headerlink" title="å¾ªç¯ä¾èµ–"></a>å¾ªç¯ä¾èµ–</h2><p>å¾ªç¯ä¾èµ–å…¶å®å°±æ˜¯å¾ªç¯å¼•ç”¨ï¼Œå³ä¸¤ä¸ªæˆ–è€…ä¸¤ä¸ªä»¥ä¸Šçš„beanäº’ç›¸æŒæœ‰å¯¹æ–¹ï¼Œæœ€ç»ˆå½¢æˆé—­ç¯</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/408/image1.png" class="" title="image1"><br />

<h2 id="ä¸¤å¤§åœºæ™¯"><a href="#ä¸¤å¤§åœºæ™¯" class="headerlink" title="ä¸¤å¤§åœºæ™¯"></a>ä¸¤å¤§åœºæ™¯</h2><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/408/image2.png" class="" title="image2"><br />


<p>ç¬¬ä¸€ç§ï¼šæ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AService</span><span class="params">(BService bService)</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BService</span><span class="params">(AService aService)</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">The dependencies of some of the beans <span class="keyword">in</span> the application context form a cycle:</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”</span><br><span class="line">|  AService defined <span class="keyword">in</span> file [<span class="type">D</span>:\<span class="type">Java</span>\<span class="type">springboot</span>\<span class="type">springboot</span>\<span class="type">target</span>\<span class="type">classes</span>\<span class="type">top</span>\<span class="type">parak</span>\<span class="type">depend</span>\<span class="type">AService.class</span>]</span><br><span class="line">â†‘     â†“</span><br><span class="line">|  BService defined <span class="keyword">in</span> file [<span class="type">D</span>:\<span class="type">Java</span>\<span class="type">springboot</span>\<span class="type">springboot</span>\<span class="type">target</span>\<span class="type">classes</span>\<span class="type">top</span>\<span class="type">parak</span>\<span class="type">depend</span>\<span class="type">BService.class</span>]</span><br><span class="line">â””â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>
<p>Springè§£å†³å¾ªç¯ä¾èµ–ä¾é çš„æ˜¯Beançš„ä¸­é—´æ€ï¼Œè€Œè¿™ä¸ªä¸­é—´æ€æ˜¯æŒ‡å·²ç»å®ä¾‹åŒ–ï¼Œä½†æœªåˆå§‹åŒ–ã€‚æ„é€ å™¨æ‰§è¡Œæ˜¯åœ¨ä¸­é—´æ€ä¹‹å‰ï¼Œå› æ­¤æ„é€ å™¨çš„å¾ªç¯ä¾èµ–æ— æ³•è§£å†³ã€‚</p>
<p>ç¬¬äºŒç§ï¼šå•ä¾‹çš„setteræ³¨å…¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BService bService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AService aService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§åœºæ™¯ç»å¸¸ä½¿ç”¨ï¼Œæ²¡æœ‰é—®é¢˜ã€‚</p>
<p>ç¬¬ä¸‰ç§ï¼šå¤šä¾‹çš„setteræ³¨å…¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BService bService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AService aService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Scope(ConfigurableBeanFactory.SCOPE_SINGLETON)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AService aService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">The dependencies of some of the beans <span class="keyword">in</span> the application context form a cycle:</span><br><span class="line"></span><br><span class="line">   c (field private top.parak.depend.AService top.parak.depend.C.aService)</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”</span><br><span class="line">|  AService (field private top.parak.depend.BService top.parak.depend.AService.bService)</span><br><span class="line">â†‘     â†“</span><br><span class="line">|  BService (field private top.parak.depend.AService top.parak.depend.BService.aService)</span><br><span class="line">â””â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure>
<p>æ²¡æœ‰ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°å¯¹è±¡ã€‚</p>
<blockquote>
<p>æ€»ç»“</p>
<ol>
<li>æ„é€ å™¨æ³¨å…¥å’Œprototypeç±»å‹çš„fieldæ³¨å…¥å‘ç”Ÿå¾ªç¯ä¾èµ–æ—¶éƒ½æ— æ³•åˆå§‹åŒ–</li>
<li>fieldæ³¨å…¥å•ä¾‹çš„beanæ—¶ï¼Œå°½ç®¡æœ‰å¾ªç¯ä¾èµ–ï¼Œä½†æ˜¯beanå¯ä»¥æˆåŠŸåˆå§‹åŒ–</li>
</ol>
</blockquote>
<h2 id="å¦‚ä½•æ£€æµ‹"><a href="#å¦‚ä½•æ£€æµ‹" class="headerlink" title="å¦‚ä½•æ£€æµ‹"></a>å¦‚ä½•æ£€æµ‹</h2><p>Beanåœ¨åˆ›å»ºçš„æ—¶å€™å¯ä»¥ç»™è¯¥Beanæ‰“ä¸ªæ ‡å¿—ï¼Œå¦‚æœé€’å½’è°ƒç”¨å›æ¥å‘ç°æ­£åœ¨åˆ›å»ºä¸­çš„è¯ï¼Œå³è¯´æ˜äº§ç”Ÿäº†å¾ªç¯ä¾èµ–ã€‚</p>
<h2 id="å¦‚ä½•è§£å†³"><a href="#å¦‚ä½•è§£å†³" class="headerlink" title="å¦‚ä½•è§£å†³"></a>å¦‚ä½•è§£å†³</h2><p><code>DefaultSingletonBeanRegistry</code></p>
<p>å†…éƒ¨å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title">SingletonBeanRegistry</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** ä¸€çº§ç¼“å­˜  */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; singletonObjects = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** ä¸‰çº§ç¼“å­˜ */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** äºŒçº§ç¼“å­˜ */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; earlySingletonObjects = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** ä¿å­˜æ‰€æœ‰å·²ç»æ³¨å†Œçš„beançš„åå­— */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; registeredSingletons = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** æ ‡è¯†æŒ‡å®šåå­—çš„beanå¯¹è±¡æ˜¯å¦å¤„äºåˆ›å»ºçŠ¶æ€ */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; singletonsCurrentlyInCreation =</span><br><span class="line">			Collections.newSetFromMap(<span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‰çº§ç¼“å­˜ï¼š</p>
<table>
<thead>
<tr>
<th>ç¼“å­˜</th>
<th>çº§åˆ«</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td>singletonObjects</td>
<td>ä¸€çº§</td>
<td>å­˜æ”¾æœ€ç»ˆå•ä¾‹ï¼Œkeyä¸ºbeanåç§°ï¼Œvalueä¸ºbeanå®ä¾‹ã€‚è¿™é‡Œçš„beanå®ä¾‹æŒ‡çš„æ˜¯å·²ç»å®Œå…¨åˆ›å»ºå¥½çš„ï¼Œå³å·²ç»ç»å†å®ä¾‹åŒ–-&gt;å±æ€§å¡«å……-&gt;åˆå§‹åŒ–-&gt;åç½®å¤„ç†è¿‡ç¨‹çš„beanï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</td>
</tr>
<tr>
<td>earlySingletonObjects</td>
<td>äºŒçº§</td>
<td>å­˜æ”¾æ—©æœŸå¯¹è±¡ï¼Œkeyä¸ºbeanåç§°ï¼Œvalueä¸ºbeanå®ä¾‹ã€‚è¿™é‡Œçš„beanå®ä¾‹æŒ‡çš„æ˜¯ä»…å®Œæˆå®ä¾‹åŒ–çš„beanï¼Œè¿˜æœªè¿›è¡Œå±æ€§å¡«å……ç­‰åç»­æ“ä½œã€‚ç”¨äºæå‰æ›å…‰ï¼Œä¾›åˆ«çš„beanå¼•ç”¨ï¼Œè§£å†³å¾ªç¯ä¾èµ–ã€‚</td>
</tr>
<tr>
<td>singletonFactories</td>
<td>ä¸‰çº§</td>
<td>å­˜æ”¾å›è°ƒæ–¹æ³•ï¼Œkeyä¸ºbeanåç§°ï¼Œvalueä¸ºbeanå·¥å‚ã€‚åœ¨beanå®ä¾‹åŒ–ä¹‹åï¼Œå±æ€§å¡«å……ä¹‹å‰ï¼Œå¦‚æœå…è®¸æå‰æ›å…‰ï¼ŒSpringä¼šæŠŠè¯¥beanè½¬æ¢ä¸ºbeanå·¥å‚å¹¶åŠ å…¥åˆ°ä¸‰çº§ç¼“å­˜ã€‚åœ¨éœ€è¦å¼•ç”¨æå‰æ›å…‰å¯¹è±¡æ—¶å†é€šè¿‡å·¥å‚å¯¹è±¡çš„getObjectæ–¹æ³•è·å–ã€‚</td>
</tr>
</tbody></table>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>IOCå®¹å™¨è·å–beançš„å…¥å£ä¸º<code>AbstractBeanFactory</code>çš„<code>getBean</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBeanFactory</span> <span class="keyword">extends</span> <span class="title">FactoryBeanRegistrySupport</span> <span class="keyword">implements</span> <span class="title">ConfigurableBeanFactory</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> doGetBean(name, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœŸæ­£å®ç°</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doGetBean</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, <span class="meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="meta">@Nullable</span> Object[] args, <span class="keyword">boolean</span> typeCheckOnly)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String beanName = transformedBeanName(name);</span><br><span class="line">        Object bean;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…ˆå»è·å–ä¸€æ¬¡ï¼Œå¦‚æœä¸ä¸ºnullï¼Œæ­¤å¤„å°±ä¼šèµ°ç¼“å­˜</span></span><br><span class="line">        Object sharedInstance = getSingleton(beanName);</span><br><span class="line">        <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸ä¸ºç©ºï¼Œåˆ™è¿›è¡Œåç»­å¤„ç†å¹¶è¿”å›</span></span><br><span class="line">            bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ...</span><br><span class="line">                RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span><br><span class="line">                ...</span><br><span class="line">                <span class="comment">// ä»ä¸‰çº§ç¼“å­˜ä¸­æ²¡æœ‰è·å–åˆ°Beanå®ä¾‹ï¼Œå¹¶ä¸”ç›®æ ‡Beanæ˜¯å•å®ä¾‹Beançš„è¯</span></span><br><span class="line">                <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">                    <span class="comment">// é€šè¿‡getSingletonæ–¹æ³•åˆ›å»ºBeanå®ä¾‹</span></span><br><span class="line">                    sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">// åˆ›å»ºBeanå®ä¾‹</span></span><br><span class="line">                            <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="comment">// åç»­å¤„ç†ï¼Œå¹¶è¿”å›</span></span><br><span class="line">                    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">                &#125;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆé€šè¿‡<code>getSingleton(String beanName)</code>æ–¹æ³•ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–beanå®ä¾‹ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™è¿›è¡Œåç»­å¤„ç†ï¼›å¦‚æœä¸ºç©ºï¼Œåˆ™é€šè¿‡<code>getSingleton(String beanName, ObjectFactory&lt;?) singletonFactory</code>æ–¹æ³•åˆ›å»ºbeanå®ä¾‹å¹¶è¿›è¡Œåç»­å¤„ç†ã€‚</p>
<p>ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–beanå®ä¾‹çš„æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSingletonBeanRegistry</span> <span class="keyword">extends</span> <span class="title">SimpleAliasRegistry</span> <span class="keyword">implements</span> <span class="title">SingletonBeanRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSingleton(beanName, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, <span class="keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä»ä¸€çº§ç¼“å­˜ä¸­è·å–bean</span></span><br><span class="line">        Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">        <span class="comment">// ä¸€çº§ç¼“å­˜ä¸­çš„beanä¸ºç©ºï¼Œä¸”å½“å‰beanæ­£åœ¨åˆ›å»º</span></span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">            <span class="comment">// åŠ é”</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">                <span class="comment">// ä»äºŒçº§ç¼“å­˜ä¸­è·å–bean</span></span><br><span class="line">                singletonObject = <span class="keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">                <span class="comment">// äºŒçº§ç¼“å­˜ä¸­çš„beanä¸ºç©ºï¼Œä¸”å…è®¸æå‰åˆ›å»º</span></span><br><span class="line">                <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                    <span class="comment">// ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–å¯¹åº”çš„ObjectFactory</span></span><br><span class="line">                    ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                    <span class="comment">// ObjectFactoryä¸ä¸ºç©º</span></span><br><span class="line">                    <span class="keyword">if</span> (singletonFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// ä»å•ä¾‹å·¥å‚ä¸­è·å–bean</span></span><br><span class="line">                        singletonObject = singletonFactory.getObject();</span><br><span class="line">                        <span class="comment">// æ·»åŠ åˆ°äºŒçº§ç¼“å­˜</span></span><br><span class="line">                        <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                        <span class="comment">// ä»ä¸‰çº§ç¼“å­˜ä¸­åˆ é™¤</span></span><br><span class="line">                        <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singletonObject;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦æµç¨‹ï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œå°è¯•ä»ä¸€çº§ç¼“å­˜ä¸­<code>singletonObjects</code>ä¸­è·å–å•ä¾‹Bean</li>
<li>è·å–ä¸åˆ°ï¼Œåˆ™ä»äºŒçº§ç¼“å­˜<code>earlySingletonObjects</code>ä¸­è·å–å•ä¾‹Bean</li>
<li>è·å–ä¸åˆ°ï¼Œåˆ™ä»ä¸‰çº§ç¼“å­˜<code>singletonFactories</code>ä¸­è·å–å•ä¾‹<code>ObjectFactory</code></li>
<li>å¦‚æœä»ä¸‰çº§ç¼“å­˜ä¸­è·å–æˆåŠŸï¼Œåˆ™å°†<code>ObjectFactory</code>ä¸­çš„<code>object</code>å–å‡ºæ”¾å…¥åˆ°äºŒçº§ç¼“å­˜ä¸­ï¼Œå¹¶å°†<code>ObjectFactory</code>ä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤</li>
</ul>
<p>å¦‚æœé€šè¿‡ä¸‰çº§ç¼“å­˜çš„æŸ¥æ‰¾éƒ½æ²¡æœ‰æ‰¾åˆ°ç›®æ ‡beanå®ä¾‹ï¼Œåˆ™é€šè¿‡<code>getSingleton(String beanName, ObjectFactory&lt;?&gt; singleton)</code>æ–¹æ³•åˆ›å»ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSingleton</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// æ·»åŠ äº’æ–¥é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">        <span class="comment">// ä»ä¸€çº§ç¼“å­˜è·å–</span></span><br><span class="line">        Object singletonObject = <span class="keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line">        <span class="keyword">if</span> (singletonObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">// ä¸ºç©ºåˆ™ç»§ç»­</span></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">// å°†å½“å‰beanåç§°æ·»åŠ åˆ°æ­£åœ¨åˆ›å»ºbeançš„é›†åˆsingletonsCurrentlyInCreation</span></span><br><span class="line">            beforeSingletonCreation(beanName);</span><br><span class="line">            <span class="keyword">boolean</span> newSingleton = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">boolean</span> recordSuppressedExceptions = (<span class="keyword">this</span>.suppressedExceptions == <span class="keyword">null</span>);</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// é€šè¿‡å‡½æ•°å¼æ¥å£åˆ›å»ºbeanå®ä¾‹ï¼Œè¯¥å®ä¾‹å·²ç»ç»å†å®ä¾‹åŒ–ã€å±æ€§å¡«å……ã€åˆå§‹åŒ–å’Œåç½®å¤„ç†ï¼Œå¯ç›´æ¥ä½¿ç”¨</span></span><br><span class="line">                singletonObject = singletonFactory.getObject();</span><br><span class="line">                newSingleton = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­åœ¨æ­¤æœŸé—´æ˜¯å¦éšå¼å‡ºç°äº†å•ä¾‹å¯¹è±¡</span></span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// å°†å½“å‰beanåç§°ä»æ­£åœ¨åˆ›å»ºçš„é›†åˆsingletonsCurrentlyInCreationä¸­ç§»é™¤</span></span><br><span class="line">                afterSingletonCreation(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (newSingleton) &#123;</span><br><span class="line">                <span class="comment">// æ·»åŠ åˆ°ç¼“å­˜ä¸­</span></span><br><span class="line">                addSingleton(beanName, singletonObject);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singletonObject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingleton</span><span class="params">(String beanName, Object singletonObject)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">this</span>.singletonObjects.put(beanName, singletonObject);</span><br><span class="line">        <span class="comment">// åˆ é™¤å¯¹åº”çš„äºŒçº§ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">        <span class="comment">// åˆ é™¤å¯¹åº”çš„ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ°å·²æ³¨å†Œå•ä¾‹</span></span><br><span class="line">        <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹å…³æ³¨<code>singletonFactory.getObject()</code>ï¼Œ<code>singletonFactory</code>æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œå¯¹åº”<code>AbstractBeanFactory</code>çš„<code>doGetBean</code>æ–¹æ³•ä¸­çš„lambdaè¡¨è¾¾å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºbeanå®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">        destroySingleton(beanName);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹å…³æ³¨<code>createBean</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œç”±<code>AbstractBeanFactory</code>å­ç±»<code>AbstractAutowireCapableBeanFactory</code>å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Object beanInstance = doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">			<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(<span class="string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> beanInstance;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doCreateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> BeanCreationException </span>&#123;</span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ–bean</span></span><br><span class="line">    BeanWrapper instanceWrapper = <span class="keyword">null</span>;</span><br><span class="line">    ...</span><br><span class="line">    Object bean = instanceWrapper.getWrappedInstance();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡ŒMergedBeanDefinitionPostProcessorç±»å‹åç½®å¤„ç†å™¨</span></span><br><span class="line">                applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            mbd.postProcessed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥beanæ˜¯å•ä¾‹ï¼Œå¹¶ä¸”å…è®¸å¾ªç¯ä¾èµ–çš„å‡ºç°ä»¥åŠè¯¥beanæ­£åœ¨åˆ›å»ºä¸­</span></span><br><span class="line">    <span class="comment">// é‚£ä¹ˆå°±æ ‡è¯†å…è®¸å•ä¾‹beanæå‰æš´éœ²åŸå§‹å¯¹è±¡å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">                                      isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">    <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ°å•å®ä¾‹é›†åˆä¸­ï¼Œå³ä¸‰çº§ç¼“å­˜å¯¹è±¡ï¼Œè¯¥æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°ç±»å‹ä¸ºObjectFactoryå‡½æ•°å¼æ¥å£</span></span><br><span class="line">        addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–bean</span></span><br><span class="line">    Object exposedObject = bean;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å±æ€§èµ‹å€¼</span></span><br><span class="line">        populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">        exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…è®¸beanæå‰æš´éœ²</span></span><br><span class="line">    <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">        <span class="comment">// ç¬¬äºŒä¸ªå‚æ•°ä¸ºfalseæ ‡è¯†ä»…ä»ä¸€çº§å’ŒäºŒçº§ç¼“å­˜ä¸­è·å–beanå•ä¾‹</span></span><br><span class="line">        Object earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœä»ä¸€çº§å’ŒäºŒçº§ç¼“å­˜ä¸­è·å–åˆ°beanå®ä¾‹ä¸ºç©º</span></span><br><span class="line">                exposedObject = earlySingletonReference;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register bean as disposable.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>addSingletonFactory</code>æ–¹æ³•åœ¨çˆ¶ç±»<code>DefaultSingletonBeanRegistry</code>å·²å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addSingletonFactory</span><span class="params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ·»åŠ äº’æ–¥é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸€çº§ç¼“å­˜æ²¡æœ‰ï¼Œé‚£ä¹ˆæ·»åŠ åˆ°ä¸‰çº§ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.singletonObjects.containsKey(beanName)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.singletonFactories.put(beanName, singletonFactory);</span><br><span class="line">            <span class="keyword">this</span>.earlySingletonObjects.remove(beanName);</span><br><span class="line">            <span class="keyword">this</span>.registeredSingletons.add(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ•´ä¸ªæµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/408/image3.svg" class="" title="getBean"><br />

<h2 id="é¢è¯•é€¼é—®"><a href="#é¢è¯•é€¼é—®" class="headerlink" title="é¢è¯•é€¼é—®"></a>é¢è¯•é€¼é—®</h2><p>ï¼ˆ1ï¼‰åªç”¨ä¸€çº§ç¼“å­˜æ˜¯å¦å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–ï¼Ÿ<br>å¯ä»¥è§£å†³ã€‚</p>
<blockquote>
<p>å¯¹äºä¸€çº§ç¼“å­˜ï¼Œæˆ‘ä»¬ä¸ç­‰å¯¹è±¡åˆå§‹åŒ–å®Œæˆä¹‹åå†å­˜å…¥ç¼“å­˜ï¼Œè€Œæ˜¯ç­‰å¯¹è±¡å®ä¾‹åŒ–å®Œæˆåå°±æå‰æš´éœ²ï¼Œå­˜å…¥ä¸€çº§ç¼“å­˜ï¼Œç”±äºæ­¤æ—¶ç¼“å­˜å¯¹è±¡å¹¶æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå³æ—©æœŸå¯¹è±¡ã€‚é‚£ä¹ˆAå®ä¾‹åŒ–å®Œæˆæå‰æš´éœ²æ—©æœŸå¯¹è±¡ï¼ŒAåœ¨å±æ€§æ³¨å…¥æ—¶ï¼Œå‘ç°Bä¸åœ¨å®¹å™¨ä¸­ï¼Œä¹Ÿæ²¡æœ‰æå‰æš´éœ²ï¼Œé‚£ä¹ˆå»è¿›è¡ŒBçš„ç”Ÿå‘½å‘¨æœŸï¼ŒBå®ä¾‹åŒ–åè¿›è¡Œå±æ€§æ³¨å…¥ï¼Œå‘ç°Aæå‰æš´éœ²ï¼Œé‚£ä¹ˆBå¯ä»¥ä»ä¸€çº§ç¼“å­˜ä¸­è·å–åˆ°Açš„æ—©æœŸå¯¹è±¡å®Œæˆåˆå§‹åŒ–ï¼Œå›åˆ°Açš„ç”Ÿå‘½å‘¨æœŸä»è€ŒAä¹Ÿå¯ä»¥å®Œæˆåˆå§‹åŒ–ã€‚<br>ä½†æ˜¯è¿™æ ·ä¼šå¼•å‘å¦ä¸€ä¸ªé—®é¢˜ï¼šæ—©æœŸå¯¹è±¡å’Œå®Œæ•´å¯¹è±¡éƒ½å­˜åœ¨ä¸€çº§ç¼“å­˜ä¸­ï¼Œå¦‚æœæ­¤æ—¶æ¥äº†å…¶ä»–çº¿ç¨‹å¹¶å‘è·å–beanï¼Œå°±å¯èƒ½ä»ä¸€çº§ç¼“å­˜ä¸­è·å–åˆ°beançš„æ—©æœŸå¯¹è±¡ï¼Œè¿™æ ·æ˜æ˜¾ä¸è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å¾—å·²åœ¨ä»ä¸€çº§ç¼“å­˜è·å–å¯¹è±¡å¤„åŠ ä¸€ä¸ªäº’æ–¥é”ï¼Œä»¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚<br>åŠ äº’æ–¥é”ä»£ç†æ¥å¦ä¸€ä¸ªé—®é¢˜ï¼šå®¹å™¨åˆ·æ–°å®Œæˆåçš„æ™®é€šè·å–beançš„è¯·æ±‚éƒ½éœ€è¦ç«äº‰é”ï¼Œå¦‚æœè¿™æ ·å¤„ç†ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä½¿ç”¨Springçš„æ€§èƒ½å¿…ç„¶é™ä½ã€‚</p>
</blockquote>
<p>ï¼ˆ2ï¼‰åŠ ä¸ŠäºŒçº§ç¼“å­˜æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</p>
<p>ä¼˜åŒ–ä¸€çº§å¾ªç¯åŠ é”å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚</p>
<blockquote>
<p>å°†å¯¹è±¡çš„æ—©æœŸå¯¹è±¡å­˜å…¥äºŒçº§ç¼“å­˜ä¸­ï¼Œä¸€çº§ç¼“å­˜ç”¨äºå­˜å‚¨å®Œæ•´å¯¹è±¡ã€‚<br>è¿™æ ·Båœ¨åˆ›å»ºè¿‡ç¨‹ä¸­è¿›è¡Œå±æ€§æ³¨å…¥æ—¶ï¼Œå…ˆä»ä¸€çº§ç¼“å­˜ä¸­è·å–Aï¼Œè·å–å¤±è´¥åˆ™ä»äºŒçº§ç¼“å­˜ä¸­è·å–ã€‚<br>è¿™ç§è·å–beançš„é€»è¾‘ä¹Ÿå¯èƒ½å‡ºç°å…¶ä»–çº¿ç¨‹è·å–åˆ°æ—©æœŸå¯¹è±¡çš„é—®é¢˜ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦åŠ äº’æ–¥é”ã€‚åªä¸è¿‡è¿™é‡Œçš„åŠ é”é€»è¾‘å¯ä»¥ä¸‹æ²‰åˆ°äºŒçº§ç¼“å­˜ã€‚é‚£ä¹ˆæ™®é€šçš„getBeanè¯·æ±‚å¯ä»¥ç›´æ¥ä»ä¸€çº§ç¼“å­˜è·å–å¯¹è±¡ï¼Œè€Œä¸ç”¨å»ç«äº‰é”ã€‚</p>
</blockquote>
<p>ï¼ˆ3ï¼‰äºŒçº§ç¼“å­˜å¦‚ä½•è§£å†³AOPé—®é¢˜ï¼Ÿ</p>
<p>ä»£ç†å¯¹è±¡æå‰åˆ›å»ºã€‚</p>
<blockquote>
<p>Springæ”¯æŒä»¥CGLIBå’ŒJDKåŠ¨æ€ä»£ç†çš„æ–¹å¼ä¸ºå¯¹è±¡åˆ›å»ºä»£ç†ç±»ä»¥æä¾›AOPæ”¯æŒï¼Œä»£ç†å¯¹è±¡çš„åˆ›å»ºé€šå¸¸æ˜¯åœ¨beanåˆå§‹åŒ–å®Œæˆä¹‹åè¿›è¡Œï¼ˆé€šè¿‡BeanPostProcessoråç½®å¤„ç†å™¨ï¼‰ã€‚<br>å¦‚æœæ²¡æœ‰å¾ªç¯ä¾èµ–ï¼Œé‚£ä¹ˆä»£ç†å¯¹è±¡ä¾ç„¶åœ¨åˆå§‹åŒ–å®Œæˆååˆ›å»ºï¼Œå¦‚æœæœ‰å¾ªç¯ä¾èµ–ï¼Œé‚£ä¹ˆæå‰åˆ›å»ºä»£ç†å¯¹è±¡ã€‚<br>å¦‚ä½•åˆ¤æ–­å‘ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼Ÿ<br>åœ¨Båˆ›å»ºçš„è¿‡ç¨‹ä¸­è·å–Açš„æ—¶å€™ï¼Œå‘ç°äºŒçº§ç¼“å­˜ä¸­æœ‰Aï¼Œå°±è¯´æ˜å‘ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼Œæ­¤æ—¶å°±ä¸ºAåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå°†å…¶è¦†ç›–åˆ°äºŒçº§ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”å°†ä»£ç†å¯¹è±¡å¤åˆ¶ç»™Bçš„å¯¹åº”æ•°å­—ã€‚<br>å½“å‡ºç°å¤šçº§å¾ªç¯ä¾èµ–çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨å¯¹è±¡å®ä¾‹åŒ–å®Œæˆä¹‹åï¼Œå°†beanNameå­˜åœ¨ä¸€ä¸ªSetä¸­ï¼Œæ ‡è¯†å¯¹åº”çš„beanæ­£åœ¨åˆ›å»ºä¸­ï¼Œè€Œå½“å…¶ä»–å¯¹è±¡åˆ›å»ºçš„è¿‡ç¨‹ä¾èµ–æŸä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œåˆ¤æ–­å…¶æ˜¯å¦åœ¨è¿™ä¸ªSetä¸­ï¼Œå¦‚æœåœ¨å°±è¯´æ˜å‘ç”Ÿäº†å¾ªç¯ä¾èµ–ã€‚</p>
</blockquote>
<p>ï¼ˆ4ï¼‰é‚£ä¹ˆä¸‰çº§ç¼“å­˜æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</p>
<p>è™½ç„¶ä»…ä»…ä¾é äºŒçº§ç¼“å­˜èƒ½å¤Ÿè§£å†³å¾ªç¯ä¾èµ–å’ŒAOPçš„é—®é¢˜ï¼Œä½†æ˜¯ä»è§£å†³æ–¹æ¡ˆä¸Šæ¥çœ‹ï¼Œç»´æŠ¤ä»£ç†å¯¹è±¡çš„é€»è¾‘å’ŒgetBeançš„é€»è¾‘è¿‡äºè€¦åˆã€‚</p>
<blockquote>
<p>ä¸‰çº§ç¼“å­˜çš„keyè¿˜æ˜¯ä¸ºbeanNameï¼Œä½†æ˜¯valueæ˜¯ä¸€ä¸ªå‡½æ•°ï¼ˆObjectFactory#getBeanæ–¹æ³•ï¼‰ï¼Œåœ¨è¯¥å‡½æ•°ä¸­æ‰§è¡Œè·å–æ—©æœŸå¯¹è±¡çš„é€»è¾‘ï¼šgetEarlyBeanReferenceæ–¹æ³•ã€‚ åœ¨getEarlyBeanReferenceæ–¹æ³•ä¸­ï¼ŒSpringä¼šè°ƒç”¨æ‰€æœ‰SmartInstantiationAwareBeanPostProcessorçš„getEarlyBeanReferenceæ–¹æ³•ï¼Œé€šè¿‡è¯¥æ–¹æ³•å¯ä»¥ä¿®æ”¹æ—©æœŸå¯¹è±¡çš„å±æ€§æˆ–è€…æ›¿æ¢æ—©æœŸå¯¹è±¡ã€‚è¿™ä¸ªæ˜¯Springç•™ç»™å¼€å‘è€…çš„å¦ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œè™½ç„¶æˆ‘ä»¬å¾ˆå°‘ä½¿ç”¨ï¼Œä¸è¿‡åœ¨å¾ªç¯ä¾èµ–é‡åˆ°AOPçš„æ—¶å€™ï¼Œä»£ç†å¯¹è±¡å°±æ˜¯é€šè¿‡è¿™ä¸ªåç½®å¤„ç†å™¨åˆ›å»ºã€‚</p>
</blockquote>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>[1] ğŸ•Šï¸ <a href="https://mrbird.cc/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Spring%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.html">é¸Ÿå”åšå®¢</a><br /><br>[2] ğŸ’¤ <a href="https://zhuanlan.zhihu.com/p/375308988">é»‘å“¥çŸ¥ä¹</a></p>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring-ç»„ä»¶æ³¨å†Œ</title>
    <url>/posts/39013/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ä½ åªç®¡ä½¿ç”¨ï¼Œä¸€åˆ‡äº¤ç»™IOCã€‚</p>
<p>é€šè¿‡ç»„ä»¶æ³¨å†Œï¼ŒIOCå®¹å™¨å°±è‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬ç®¡ç†beanã€‚â€‹</p>
<p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="Beanæ³¨å†Œç»„ä»¶"><a href="#Beanæ³¨å†Œç»„ä»¶" class="headerlink" title="@Beanæ³¨å†Œç»„ä»¶"></a>@Beanæ³¨å†Œç»„ä»¶</h2><p>åˆ›å»ºä¸€ä¸ªå®ä¾‹ç±»<code>User</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ç€åˆ›å»ºä¸€ä¸ªé…ç½®ç±»ï¼Œåœ¨é…ç½®ç±»ä¸­é€šè¿‡<code>@Bean</code>æ³¨è§£æ³¨å†Œ<code>User</code>ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨SpringBootå…¥å£ç±»ä¸­ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = <span class="keyword">new</span> SpringApplicationBuilder(KHighnessApplication.class)</span><br><span class="line">                .web(WebApplicationType.SERVLET)</span><br><span class="line">                .run(args);</span><br><span class="line">        User user = applicationContext.getBean(User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">User(id=<span class="number">1</span>, name=KHighness)</span><br></pre></td></tr></table></figure>

<h2 id="ComponentSacnæ‰«æåŒ…"><a href="#ComponentSacnæ‰«æåŒ…" class="headerlink" title="@ComponentSacnæ‰«æåŒ…"></a>@ComponentSacnæ‰«æåŒ…</h2><p>åœ¨è¿™ä¸ªSpringBootå¯åŠ¨ç±»æ‰€åœ¨åŒ…ä¸‹åˆ›å»ºå…¶ä»–ç±»ï¼šUserDaoã€UserServiceã€UserControllerï¼Œå¹¶ä¸”æ ‡æ³¨ä¸Šå“åº”æ³¨è§£ï¼Œç»™<code>User</code>ç±»æ ‡æ³¨<code>@Component</code>æ³¨è§£ã€‚</p>
<p>å¹¶ä¿®æ”¹é…ç½®ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;top.parak&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å¯åŠ¨ç±»ä¸­è·å–æ‰€æœ‰çš„beanï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = <span class="keyword">new</span> SpringApplicationBuilder(KHighnessApplication.class)</span><br><span class="line">                .web(WebApplicationType.SERVLET)</span><br><span class="line">                .run(args);</span><br><span class="line">        String[] names = applicationContext.getBeanDefinitionNames();</span><br><span class="line">        Arrays.stream(names).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œæœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">KHighnessApplication</span><br><span class="line">org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory</span><br><span class="line">webConfig</span><br><span class="line">userController</span><br><span class="line">userDao</span><br><span class="line">user</span><br><span class="line">userService</span><br></pre></td></tr></table></figure>

<h2 id="Scopeç»„ä»¶ä½œç”¨åŸŸ"><a href="#Scopeç»„ä»¶ä½œç”¨åŸŸ" class="headerlink" title="@Scopeç»„ä»¶ä½œç”¨åŸŸ"></a>@Scopeç»„ä»¶ä½œç”¨åŸŸ</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨Springçš„IOCå®¹å™¨ä¸­æ¯ä¸ªç»„ä»¶éƒ½æ˜¯å•ä¾‹çš„ï¼Œå³æ— è®ºåœ¨ä»»ä½•åœ°æ–¹æ³¨å…¥å¤šå°‘æ¬¡ï¼Œè¿™äº›å¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ªã€‚</p>
<p>å°†é…ç½®ç±»ä¿®æ”¹å›å»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="number">1L</span>, <span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹SpringBootå¯åŠ¨ç±»å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = <span class="keyword">new</span> SpringApplicationBuilder(KHighnessApplication.class)</span><br><span class="line">                .web(WebApplicationType.SERVLET)</span><br><span class="line">                .run(args);</span><br><span class="line">        Object user1 = applicationContext.getBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        Object user2 = applicationContext.getBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        System.out.println(user1 == user2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">true</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥é€šè¿‡<code>@Scope</code>ä¿®æ”¹ä½œç”¨åŸŸï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>singleton</td>
<td>å•å®ä¾‹ï¼ˆé»˜è®¤ï¼‰ï¼Œåœ¨Spring IOCå®¹å™¨å¯åŠ¨çš„æ—¶å€™ä¼šè°ƒç”¨æ–¹æ³•åˆ›å»ºå¯¹è±¡ç„¶åçº³å…¥åˆ°IOCå®¹å™¨ä¸­ï¼Œä»¥åæ¯æ¬¡è·å–éƒ½æ˜¯ç›´æ¥ä»IOCå®¹å™¨ä¸­è·å–</td>
</tr>
<tr>
<td>prototype</td>
<td>å¤šå®ä¾‹ï¼ŒIOCå®¹å™¨å¯åŠ¨çš„æ—¶å€™å¹¶ä¸ä¼šå»åˆ›å»ºå¯¹è±¡ï¼Œè€Œæ˜¯åœ¨æ¯æ¬¡è·å–çš„æ—¶å€™æ‰ä¼šå»è°ƒç”¨æ–¹æ³•åˆ›å»ºå¯¹è±¡</td>
</tr>
<tr>
<td>request</td>
<td>ä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªå®ä¾‹</td>
</tr>
<tr>
<td>session</td>
<td>åŒä¸€ä¸ªsessionå¯¹åº”ä¸€ä¸ªå®ä¾‹</td>
</tr>
</tbody></table>
<h2 id="Lazyæ‡’åŠ è½½"><a href="#Lazyæ‡’åŠ è½½" class="headerlink" title="@Lazyæ‡’åŠ è½½"></a>@Lazyæ‡’åŠ è½½</h2><p>æ‡’åŠ è½½æ˜¯é’ˆå¯¹å•ä¾‹æ¨¡å¼è€Œè¨€çš„ï¼Œå®¹å™¨å¯åŠ¨çš„æ—¶å€™ä¼šè°ƒç”¨æ–¹æ³•åˆ›å»ºå¯¹è±¡ç„¶åçº³å…¥åˆ°IOCå®¹å™¨ä¸­ã€‚</p>
<p>åœ¨Useræ³¨å†Œçš„åœ°æ–¹æ‰“å°ä¸€å¥è¯ä»¥è§‚å¯Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;å‘IOCå®¹å™¨ä¸­æ³¨å†Œuser&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="number">1L</span>, <span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨IOCå®¹å™¨å¯åŠ¨ååŠ å…¥ä¸€å¥è¯ä»¥è§‚å¯Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ConfigurableApplicationContext applicationContext = <span class="keyword">new</span> SpringApplicationBuilder(KHighnessApplication.class)</span><br><span class="line">                .web(WebApplicationType.SERVLET)</span><br><span class="line">                .run(args);</span><br><span class="line">System.out.println(<span class="string">&quot;IOCå®¹å™¨åˆ›å»ºå®Œæ¯•&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œæœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">å‘IOCå®¹å™¨ä¸­æ³¨å†Œuser</span><br><span class="line"><span class="number">2021</span><span class="literal">-06</span><span class="literal">-28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">13.064</span>  INFO <span class="number">49772</span> --- [           <span class="type">main</span>] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService <span class="string">&#x27;applicationTaskExecutor&#x27;</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-06</span><span class="literal">-28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">13.165</span>  INFO <span class="number">49772</span> --- [           <span class="type">main</span>] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): <span class="number">8080</span> (http) with context path <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-06</span><span class="literal">-28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">13.168</span>  INFO <span class="number">49772</span> --- [           <span class="type">main</span>] top.parak.KHighnessApplication           : Started KHighnessApplication <span class="keyword">in</span> <span class="number">1.081</span> seconds (JVM running <span class="keyword">for</span> <span class="number">1.667</span>)</span><br><span class="line">IOCå®¹å™¨åˆ›å»ºå®Œæ¯•</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨IOCå®¹å™¨åˆ›å»ºå®Œæ¯•ä¹‹å‰ï¼Œç»„ä»¶å·²ç»æ³¨å†Œåˆ°å®¹å™¨ä¸­ã€‚</p>
<p>å°†Userä¿®æ”¹ä¸ºæ‡’åŠ è½½æ³¨å†Œï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Lazy</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;å‘IOCå®¹å™¨ä¸­æ³¨å†Œuser&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="number">1L</span>, <span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†å¯åŠ¨ç±»ä¿®æ”¹ä¸€ä¸‹ï¼Œè·å–userï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = <span class="keyword">new</span> SpringApplicationBuilder(KHighnessApplication.class)</span><br><span class="line">                .web(WebApplicationType.SERVLET)</span><br><span class="line">                .run(args);</span><br><span class="line">        System.out.println(<span class="string">&quot;IOCå®¹å™¨åˆ›å»ºå®Œæ¯•&quot;</span>);</span><br><span class="line">        Object user = applicationContext.getBean(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œæœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">IOCå®¹å™¨åˆ›å»ºå®Œæ¯•</span><br><span class="line">å‘IOCå®¹å™¨ä¸­æ³¨å†Œuser</span><br><span class="line">User(id=<span class="number">1</span>, name=KHighness)</span><br></pre></td></tr></table></figure>
<p>ä»è¾“å‡ºçœ‹åˆ°ï¼Œåˆ›å»ºæ—¶å¹¶æ²¡æœ‰æ³¨å†Œuserï¼Œè·å–æ—¶æ‰å»æ³¨å†Œï¼Œå¯ä»¥è¯æ˜æ‡’åŠ è½½æˆåŠŸã€‚â€‹</p>
<h2 id="æ¡ä»¶æ³¨å†Œ"><a href="#æ¡ä»¶æ³¨å†Œ" class="headerlink" title="æ¡ä»¶æ³¨å†Œ"></a>æ¡ä»¶æ³¨å†Œ</h2><h3 id="Conditional"><a href="#Conditional" class="headerlink" title="@Conditional"></a>@Conditional</h3><p>ä½¿ç”¨<code>@Conditional</code>æ³¨è§£æˆ‘ä»¬æŒ‡å®šç»„ä»¶æ³¨å†Œçš„æ¡ä»¶ï¼Œå³æ»¡è¶³ç‰¹å®šæ¡ä»¶æ‰å°†ç»„ä»¶çº³å…¥åˆ°IOCå®¹å™¨ä¸­ã€‚</p>
<p>åœ¨ä½¿ç”¨è¯¥æ³¨è§£ä¹‹å‰ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªç±»ï¼Œå®ç°<code>Condition</code>æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext conditionContext, AnnotatedTypeMetadata annotatedTypeMetadata)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ¥å£åŒ…å«ä¸€ä¸ª<code>matches</code>æ–¹æ³•ï¼ŒåŒ…å«ä¸¤ä¸ªå…¥å‚ï¼š</p>
<ol>
<li><code>ConditionContext</code>ï¼šä¸Šä¸‹æ–‡ä¿¡æ¯ï¼›</li>
<li><code>AnnotatedTypeMetadata</code>ï¼šæ³¨è§£ä¿¡æ¯ã€‚</li>
</ol>
<p>ç®€å•å®Œå–„ä¸€ä¸‹å®ç°ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCondition</span> <span class="keyword">implements</span> <span class="title">Condition</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext conditionContext, AnnotatedTypeMetadata annotatedTypeMetadata)</span> </span>&#123;</span><br><span class="line">        String osName = conditionContext.getEnvironment().getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> osName != <span class="keyword">null</span> &amp;&amp; osName.contains(<span class="string">&quot;windows&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†è¿™ä¸ªæ¡ä»¶æ·»åŠ åˆ°æ³¨å†ŒUserçš„åœ°æ–¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Conditional(MyCondition.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;å‘IOCå®¹å™¨ä¸­æ³¨å†Œuser&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="number">1L</span>, <span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨Windowsç³»ç»Ÿä¸‹ï¼ŒUserä¼šè¢«æˆåŠŸæ³¨å†Œï¼Œå…¶ä»–æ“ä½œç³»ç»Ÿä¸‹ï¼Œè¿™ä¸ªç»„ä»¶åˆ™ä¸ä¼šè¢«æ³¨å†Œåˆ°IOCå®¹å™¨ä¸­ã€‚</p>
<h3 id="Profile"><a href="#Profile" class="headerlink" title="@Profile"></a>@Profile</h3><p><code>@Profile</code>å¯ä»¥æ ¹æ®ä¸åŒçš„ç¯å¢ƒå˜é‡æ¥æ³¨å†Œä¸åŒçš„ç»„ä»¶ã€‚</p>
<p>æ–°å»ºä¸€ä¸ªæ¥å£<code>CalculateService</code>ï¼Œç”¨äºæ±‚å’Œï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CalculateService</span> </span>&#123;</span><br><span class="line">    <span class="function">Integer <span class="title">sum</span><span class="params">(Integer... value)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ¥ç€æ·»åŠ ä¸¤ä¸ªå®ç°ç±»<code>Java7CalculateServiceImpl</code>å’Œ<code>Java8CalculateServiceImpl</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Profile(&quot;java7&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Java7CalculateServiceImpl</span> <span class="keyword">implements</span> <span class="title">CalculateService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">sum</span><span class="params">(Integer... value)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Java7ç¯å¢ƒä¸‹æ‰§è¡Œ&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> val : value)</span><br><span class="line">            res += val;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Profile(&quot;java8&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Java8CalculateServiceImpl</span> <span class="keyword">implements</span> <span class="title">CalculateService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">sum</span><span class="params">(Integer... value)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Java8ç¯å¢ƒä¸‹æ‰§è¡Œ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Arrays.stream(value).reduce(<span class="number">0</span>, Integer::sum);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>@Profile</code>æ³¨è§£æˆ‘ä»¬å®ç°äº†ï¼šå½“ç¯å¢ƒå˜é‡åŒ…å«<code>java7</code>çš„æ—¶å€™ï¼Œ<code>Java7CalculateServiceImpl</code>å°†ä¼šè¢«æ³¨å†Œåˆ°IOCå®¹å™¨ä¸­ï¼›å½“ç¯å¢ƒå˜é‡åŒ…å«<code>java8</code>çš„æ—¶å€™ï¼Œ<code>Java8CalculateServiceImpl</code>å°†ä¼šè¢«æ³¨å†Œåˆ°IOCå®¹å™¨ä¸­ã€‚</p>
<p>ä¿®æ”¹å¯åŠ¨ç±»å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = <span class="keyword">new</span> SpringApplicationBuilder(KHighnessApplication.class)</span><br><span class="line">                .web(WebApplicationType.SERVLET)</span><br><span class="line">                .profiles(<span class="string">&quot;java8&quot;</span>)</span><br><span class="line">                .run(args);</span><br><span class="line">        CalculateService service = applicationContext.getBean(CalculateService.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ±‚å’Œç»“æœï¼š&quot;</span> + service.sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œæœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Java8ç¯å¢ƒä¸‹æ‰§è¡Œ</span><br><span class="line">æ±‚å’Œç»“æœï¼š<span class="number">15</span></span><br></pre></td></tr></table></figure>
<p>åŒç†ï¼Œå¦‚æœè®¾ç½®äº†ç¯å¢ƒå˜é‡<code>java7</code>çš„æ—¶å€™ï¼Œå°†ä¼šè¾“å‡º<code>Java7ç¯å¢ƒä¸‹æ‰§è¡Œ</code>ã€‚<br /></p>
<h2 id="å¯¼å…¥ç»„ä»¶"><a href="#å¯¼å…¥ç»„ä»¶" class="headerlink" title="å¯¼å…¥ç»„ä»¶"></a>å¯¼å…¥ç»„ä»¶</h2><h3 id="Import"><a href="#Import" class="headerlink" title="@Import"></a>@Import</h3><p>ä¸Šé¢å­¦ä¹ äº†ä½¿ç”¨<code>@Bean</code>å’Œ@<code>@ComponentScan</code>æ‰«æå®ç°ç»„ä»¶æ³¨å†Œï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨<code>@Import</code>æ¥å¿«é€Ÿåœ°å¾€IOCå®¹å™¨ä¸­æ·»åŠ ç»„ä»¶ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»<code>Hello</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨é…ç½®ç±»ä¸­å¯¼å…¥è¿™ä¸ªç»„ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(&#123;Hello.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;...</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹å¯åŠ¨ç±»ï¼ŒæŸ¥çœ‹æ‰€æœ‰ç»„ä»¶çš„åç§°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KHighnessApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = <span class="keyword">new</span> SpringApplicationBuilder(KHighnessApplication.class)</span><br><span class="line">                .web(WebApplicationType.SERVLET)</span><br><span class="line">                .run(args);</span><br><span class="line">        String[] names = applicationContext.getBeanDefinitionNames();</span><br><span class="line">        Arrays.stream(names).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œæœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">top.parak.entity.Hello</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡<code>@Import</code>æˆ‘ä»¬å¯ä»¥å¿«é€Ÿå‘å®¹å™¨ä¸­æ·»åŠ ç»„ä»¶ï¼Œé»˜è®¤åç§°ä¸ºå…¨ç±»åã€‚</p>
<h3 id="ImportSelector"><a href="#ImportSelector" class="headerlink" title="ImportSelector"></a>ImportSelector</h3><p>é€šè¿‡<code>@Import</code>å¯ä»¥å®ç°ç»„ä»¶å¯¼å…¥ï¼Œå¦‚æœéœ€è¦ä¸€æ¬¡æ€§å¯¼å…¥è¾ƒå¤šç»„ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>@ImportSelector</code>æ¥å®ç°ã€‚</p>
<p>æŸ¥çœ‹<code>ImportSelector</code>æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Select and return the names of which class(es) should be imported based on</span></span><br><span class="line"><span class="comment">	 * the &#123;<span class="doctag">@link</span> AnnotationMetadata&#125; of the importing @&#123;<span class="doctag">@link</span> Configuration&#125; class.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String[] selectImports(AnnotationMetadata importingClassMetadata);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ImportSelector</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼ŒåŒ…å«ä¸€ä¸ª<code>selectImports</code>æ–¹æ³•ï¼Œæ–¹æ³•è¿”å›çš„ç±»çš„å…¨ç±»åæ•°ç»„ï¼ˆå³éœ€è¦å¯¼å…¥åˆ°IOCå®¹å™¨ä¸­ç»„ä»¶çš„å…¨ç±»åæ•°ç»„ï¼‰ï¼ŒåŒ…å«ä¸€ä¸ª<code>@AnnotationMetadata</code>ç±»å‹å…¥å‚ï¼Œé€šè¿‡è¿™ä¸ªå‚æ•°æˆ‘ä»¬å¯ä»¥è·å–åˆ°ä½¿ç”¨<code>ImportSelector</code>çš„ç±»çš„å…¨éƒ¨æ³¨è§£ä¿¡æ¯ã€‚</p>
<p>æ–°å»ºä¸‰ä¸ªç±»ï¼Œåˆ†åˆ«ä¸º<code>Orange</code>ã€<code>Banana</code>å’Œ<code>Pineapple</code>ã€‚</p>
<p>æ–°å»ºä¸€ä¸ª<code>ImportSelector</code>å®ç°ç±»<code>MyImportSelector</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyImportSelector</span> <span class="keyword">implements</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123;</span><br><span class="line">                <span class="string">&quot;top.parak.entity.Orange&quot;</span>,</span><br><span class="line">                <span class="string">&quot;top.parak.entity.Banana&quot;</span>,</span><br><span class="line">                <span class="string">&quot;top.parak.entity.Pineapple&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ç€é€šè¿‡<code>@Import</code>æ³¨è§£å°†<code>MyImportSelector</code>æŠŠä¸§ç»„ä»¶å¿«é€Ÿå¯¼å…¥åˆ°å®¹å™¨ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(MyImportSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;...</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œå‘ç°æœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">top.parak.entity.Orange</span><br><span class="line">top.parak.entity.Banana</span><br><span class="line">top.parak.entity.Pineapple</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ä¸‰ä¸ªç»„ä»¶å·²ç»æ‰¹é‡å¯¼å…¥ã€‚</p>
<h3 id="ImportBeanDefinitionRegistor"><a href="#ImportBeanDefinitionRegistor" class="headerlink" title="ImportBeanDefinitionRegistor"></a>ImportBeanDefinitionRegistor</h3><p>é™¤äº†ä¸Šè¿°ä¸¤ç§å‘IOCå®¹å™¨ä¸­å¯¼å…¥ç»„ä»¶çš„æ–¹æ³•å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨<code>ImportBeanDefinitionRegistrar</code>æ¥æ‰‹åŠ¨å¾€IOCå®¹å™¨ä¸­å¯¼å…¥ç»„ä»¶ã€‚</p>
<p>æŸ¥çœ‹<code>ImportBeanDefinitionRegistrar</code>æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ImportBeanDefinitionRegistrar</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼ŒåŒ…å«ä¸€ä¸ª<code>registerBeanDefinitions</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åŒ…å«ä¸¤ä¸ªå…¥å‚ï¼š</p>
<ol>
<li><code>AnnotationMetadata</code>ï¼šå¯ä»¥é€šè¿‡å®ƒè·å–ç±»çš„æ³¨è§£ä¿¡æ¯ï¼›</li>
<li><code>BeanDefinitionRegistry</code>ï¼šBeanå®šä¹‰æ³¨å†Œå™¨ï¼ŒåŒ…å«äº†ä¸€äº›å’ŒBeanæœ‰å…³çš„æ–¹æ³•ï¼š<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinitionRegistry</span> <span class="keyword">extends</span> <span class="title">AliasRegistry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> BeanDefinitionStoreException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">removeBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">BeanDefinition <span class="title">getBeanDefinition</span><span class="params">(String beanName)</span> <span class="keyword">throws</span> NoSuchBeanDefinitionException</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">containsBeanDefinition</span><span class="params">(String beanName)</span></span>;</span><br><span class="line"></span><br><span class="line">	String[] getBeanDefinitionNames();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getBeanDefinitionCount</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isBeanNameInUse</span><span class="params">(String beanName)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
è¿™é‡Œå€ŸåŠ©<code>BeanDefinitionRegistry</code>çš„<code>registerBeanDefinition</code>æ–¹æ³•å¾€IOCå®¹å™¨ä¸­æ³¨å†ŒBeanã€‚è¯¥æ–¹æ³•åŒ…å«ä¸¤ä¸ªå…¥å‚ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºéœ€è¦æ³¨å†Œçš„Beanåç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºBeançš„å®šä¹‰ä¿¡æ¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å…¶å®ç°ç±»<code>RootBeanDefinition</code>æ¥å®Œæˆï¼š</li>
</ol>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/39013/image1.png" class="" title="image1"><br />

<p>ä¸ºäº†æ¼”ç¤º<code>ImportBeanDefinitionRegistrar</code>çš„ä½¿ç”¨ï¼Œæ–°å¢ä¸€ä¸ªç±»<code>Blueberry</code>ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ª<code>ImportBeanDefinitionRegistrar</code>å®ç°ç±»<code>MyImportBeanDefinitionRegistrar</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyImportBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String beanName = <span class="string">&quot;blueberry&quot;</span>;</span><br><span class="line">        <span class="keyword">boolean</span> contain = registry.containsBeanDefinition(beanName);</span><br><span class="line">        <span class="keyword">if</span> (!contain) &#123;</span><br><span class="line">            RootBeanDefinition rootBeanDefinition = <span class="keyword">new</span> RootBeanDefinition(Blueberry.class);</span><br><span class="line">            registry.registerBeanDefinition(beanName, rootBeanDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨é…ç½®ç±»ä¸­å¯¼å…¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import(&#123;MyImportBeanDefinitionRegistrar.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;...</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œæœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">blueberry</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ç»„ä»¶æ³¨å†ŒæˆåŠŸã€‚</p>
<h3 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h3><p>Springæä¾›äº†<code>FactoryBean</code>æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥æ¥å£æ¥æ³¨å†Œç»„ä»¶ï¼Œè¯¥æ¥å£åŒ…å«ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•å’Œä¸€ä¸ªé»˜è®¤æ–¹æ³•ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/39013/image2.png" class="" title="image2">
<br />

<p>ä¸ºäº†æ¼”ç¤º<code>FactoryBean</code>çš„ä½œç”¨ï¼Œæ–°å»ºä¸€ä¸ªç±»<code>Cherry</code>ã€‚</p>
<p>ç„¶ååˆ›å»º<code>FactoryBean</code>çš„å®ç°ç±»<code>CherryFactoryBean</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CherryFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">Cherry</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cherry <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Cherry();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> Cherry.class;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ååœ¨é…ç½®ç±»ä¸­æ³¨å†Œå³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CherryFactoryBean <span class="title">cherryFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CherryFactoryBean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹å¯åŠ¨ç±»ï¼Œè·å–<code>cherryFactoryBean</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object bean = applicationContext.getBean(<span class="string">&quot;cherryFactoryBean&quot;</span>);</span><br><span class="line">System.out.println(bean.getClass());</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå¯åŠ¨ç±»ï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œæœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">top</span>.<span class="title">parak</span>.<span class="title">entity</span>.<span class="title">Cherry</span></span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶è·å–çš„æ˜¯IDä¸º<code>cherryFactoryBean</code>çš„ç»„ä»¶ï¼Œä½†æ˜¯å®é™…ä¸Šè·å–åˆ°çš„æ˜¯<code>getObject</code>é‡Œè¿”å›çš„å¯¹è±¡ã€‚</p>
<p>å¦‚æœè¦è·å–<code>cherryFactoryBean</code>æœ¬èº«ï¼Œåˆ™å¯ä»¥è¿™æ ·åšï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object bean = applicationContext.getBean(<span class="string">&quot;&amp;cherryFactoryBean&quot;</span>);</span><br><span class="line">System.out.println(bean.getClass());</span><br></pre></td></tr></table></figure>
<p>é‡æ–°è¿è¡Œï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">top</span>.<span class="title">parak</span>.<span class="title">entity</span>.<span class="title">CherryFactoryBean</span></span></span><br></pre></td></tr></table></figure>

<div class="note icon simple"><i class="note-icon fas fa-bolt"></i><p>ä¸ºä»€ä¹ˆè¿™é‡ŒåŠ ä¸Š<code>&amp;</code>å‰ç¼€å°±å¯ä»¥è·å–åˆ°ç›¸åº”çš„å·¥å‚ç±»ï¼Ÿ</p>
<p>æŸ¥çœ‹<code>BeanFactory</code>æºç å°±å¯ä»¥çœ‹åˆ°åŸå› ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Used to dereference a &#123;<span class="doctag">@link</span> FactoryBean&#125; instance and distinguish it from</span></span><br><span class="line"><span class="comment">	 * beans &lt;i&gt;created&lt;/i&gt; by the FactoryBean. For example, if the bean named</span></span><br><span class="line"><span class="comment">	 * &#123;<span class="doctag">@code</span> myJndiObject&#125; is a FactoryBean, getting &#123;<span class="doctag">@code</span> &amp;myJndiObject&#125;</span></span><br><span class="line"><span class="comment">	 * will return the factory, not the instance returned by the factory.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String FACTORY_BEAN_PREFIX = <span class="string">&quot;&amp;&quot;</span>;</span><br></pre></td></tr></table></figure>
</div>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>ZooKeeper</title>
    <url>/posts/7340/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-Zookeeperæ¦‚è¿°"><a href="#1-Zookeeperæ¦‚è¿°" class="headerlink" title="1. Zookeeperæ¦‚è¿°"></a>1. Zookeeperæ¦‚è¿°</h2><h3 id="1-1-ç®€ä»‹"><a href="#1-1-ç®€ä»‹" class="headerlink" title="1.1 ç®€ä»‹"></a>1.1 ç®€ä»‹</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/7340/Zookeeper.jpg" class="" title="Zookeeper">

<br />

<p>Zookeeperæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„ä¸€ä¸ªè½¯ä»¶é¡¹ç›®ï¼Œå®ƒä¸ºå¤§å‹åˆ†å¸ƒå¼è®¡ç®—æä¾›å¼€æºçš„åˆ†å¸ƒå¼é…ç½®æœåŠ¡ã€åŒæ­¥æœåŠ¡å’Œå‘½åæ³¨å†Œã€‚</p>
<h3 id="1-2-æ¶æ„"><a href="#1-2-æ¶æ„" class="headerlink" title="1.2 æ¶æ„"></a>1.2 æ¶æ„</h3><p>é€šè¿‡å†—ä½™æœåŠ¡å®ç°é«˜å¯ç”¨æ€§ã€‚</p>
<h3 id="1-3-è®¾è®¡ç›®æ ‡"><a href="#1-3-è®¾è®¡ç›®æ ‡" class="headerlink" title="1.3 è®¾è®¡ç›®æ ‡"></a>1.3 è®¾è®¡ç›®æ ‡</h3><p>å°†å¤æ‚ä¸”å®¹æ˜“å‡ºé”™çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§æœåŠ¡å°è£…èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªé«˜æ•ˆå¯é çš„åŸè¯­é›†ï¼Œå¹¶ä»¥ä¸€ç³»åˆ—ç®€å•æ˜“ç”¨çš„æ¥å£æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ã€‚</p>
<h3 id="1-4-åŠŸèƒ½ç‰¹æ€§"><a href="#1-4-åŠŸèƒ½ç‰¹æ€§" class="headerlink" title="1.4 åŠŸèƒ½ç‰¹æ€§"></a>1.4 åŠŸèƒ½ç‰¹æ€§</h3><p>ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆï¼Œåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥åŸºäºå®ƒå®ç°è¯¸å¦‚æ•°æ®å‘å¸ƒ/è®¢é˜…ã€è´Ÿè½½å‡è¡¡ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼åè°ƒ/é€šçŸ¥ã€é›†ç¾¤ç®¡ç†ã€Masteré€‰ä¸¾ã€åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é˜Ÿåˆ—ç­‰åŠŸèƒ½ã€‚</p>
<h3 id="1-5-CAPç†è®º"><a href="#1-5-CAPç†è®º" class="headerlink" title="1.5 CAPç†è®º"></a>1.5 CAPç†è®º</h3><p>å¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œä»¥ä¸‹ä¸‰ç‚¹ä¸èƒ½åŒæ—¶æ»¡è¶³ï¼š</p>
<ul>
<li>Consistencyï¼šä¸€è‡´æ€§ï¼Œä¸€ä¸ªèŠ‚ç‚¹åœ¨æ•°æ®ä¸€è‡´çš„çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°æ“ä½œåï¼Œåº”è¯¥ä¿è¯ç³»ç»Ÿçš„æ•°æ®ä»ç„¶å¤„äºä¸€è‡´çš„çŠ¶æ€ã€‚</li>
<li>Availabilityï¼šå¯ç”¨æ€§ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„å“åº”ï¼Œä½†æ˜¯ä¸ä¿è¯è·å–çš„æ•°æ®ä¸ºæœ€æ–°æ•°æ®</li>
<li>Partion toleranceï¼šåˆ†åŒºå®¹é”™æ€§ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨é‡åˆ°ä»»ä½•ç½‘ç»œåˆ†åŒºæ•…éšœçš„æ—¶å€™ï¼Œä»ç„¶éœ€è¦èƒ½å¤Ÿä¿è¯å¯¹å¤–æä¾›æ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§çš„æœåŠ¡ï¼Œé™¤éæ•´ä¸ªç½‘ç»œç¯å¢ƒéƒ½å‘ç”Ÿäº†æ•…éšœã€‚</li>
</ul>
<p>ä¸‰å¤§å¤è€çš„æ³¨å†Œä¸­å¿ƒå¯¹æ¯”</p>
<table>
<thead>
<tr>
<th>ç»„ä»¶å</th>
<th>è¯­è¨€</th>
<th>CAP</th>
<th>æœåŠ¡å¥åº·æ£€æŸ¥</th>
<th>å¯¹å¤–æš´éœ²æ¥å£</th>
<th>Spring Cloudé›†æˆ</th>
</tr>
</thead>
<tbody><tr>
<td>Eureka</td>
<td>Java</td>
<td>AP</td>
<td>å¯é…æ”¯æŒ</td>
<td>HTTP</td>
<td>å·²é›†æˆ</td>
</tr>
<tr>
<td>Consul</td>
<td>Go</td>
<td>CP</td>
<td>æ”¯æŒ</td>
<td>HTTP/DNS</td>
<td>å·²é›†æˆ</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>Java</td>
<td>CP</td>
<td>æ”¯æŒ</td>
<td>å®¢æˆ·ç«¯</td>
<td>å·²é›†æˆ</td>
</tr>
</tbody></table>
<h3 id="1-6-BASEç†è®º"><a href="#1-6-BASEç†è®º" class="headerlink" title="1.6 BASEç†è®º"></a>1.6 BASEç†è®º</h3><p>BASEç†è®ºæ˜¯ä»¥ä¸‹ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ï¼š</p>
<ul>
<li>Basically Availableï¼šåŸºæœ¬å¯ç”¨ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå‡ºç°æ•…éšœï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼ˆæœåŠ¡é™çº§ï¼‰</li>
<li>Soft-stateï¼šè½¯çŠ¶æ€ï¼Œå…è®¸åˆ†å¸ƒå¼ç³»ç»Ÿå‡ºç°ä¸­é—´çŠ¶æ€ï¼Œè€Œä¸”ä¸­é—´çŠ¶æ€ä¸å½±å“ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡ŒåŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨æ—¶å»¶ã€‚</li>
<li>Eventually Consistentï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½è¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚</li>
</ul>
<p>BASEç†è®ºæ˜¯å¯¹CAPä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§è¿›è¡Œä¸€ä¸ªæƒè¡¡çš„ç»“æœï¼Œæ ¸å¿ƒæ€æƒ³ï¼šæ— æ³•åšåˆ°å¼ºä¸€è‡´ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<h2 id="2-Zookeeperå®‰è£…"><a href="#2-Zookeeperå®‰è£…" class="headerlink" title="2. Zookeeperå®‰è£…"></a>2. Zookeeperå®‰è£…</h2><blockquote>
<p>æ³¨æ„</p>
</blockquote>
<p>3.4ç‰ˆæœ¬æ˜¯åŸºäºjdk8æ„å»ºçš„ï¼Œ3.5ç‰ˆæœ¬ä¹‹åæ˜¯åŸºäºjdk11æ„å»ºçš„ã€‚</p>
<h3 id="2-1-Linuxå®‰è£…"><a href="#2-1-Linuxå®‰è£…" class="headerlink" title="2.1 Linuxå®‰è£…"></a>2.1 Linuxå®‰è£…</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹è½½jdk8</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install -y java-1.8.0-openjdk-devel.x86_64</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é…ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim /etc/profile</span></span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.292.b10-1.el7_9.x86_64/jre/bin </span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä½¿é…ç½®ç”Ÿæ•ˆ</span></span><br><span class="line">source /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹è½½æºç </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è§£å‹å®‰è£…åŒ…</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar -zxvf zookeeper-3.4.14.tar.gz</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¿®æ”¹é…ç½®</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> conf/ &amp;&amp; cp zoo_sample.cfg zoo.cfg</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨æœåŠ¡ç«¯</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ../bin/ &amp;&amp; sh zkServer.sh start</span></span><br></pre></td></tr></table></figure>



<h3 id="2-2-Dockerå®‰è£…"><a href="#2-2-Dockerå®‰è£…" class="headerlink" title="2.2 Dockerå®‰è£…"></a>2.2 Dockerå®‰è£…</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æ‹‰å–é•œåƒ</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker pull zookeeper:3.4.14</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨æœåŠ¡</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -d -p 2181:2181 -d --name zookeeper zookeeper:3.4.14</span></span><br></pre></td></tr></table></figure>



<h2 id="3-Zookeeperæ•°æ®æ¨¡å‹"><a href="#3-Zookeeperæ•°æ®æ¨¡å‹" class="headerlink" title="3. Zookeeperæ•°æ®æ¨¡å‹"></a>3. Zookeeperæ•°æ®æ¨¡å‹</h2><h3 id="3-1-æ¨¡å‹ç»“æ„"><a href="#3-1-æ¨¡å‹ç»“æ„" class="headerlink" title="3.1 æ¨¡å‹ç»“æ„"></a>3.1 æ¨¡å‹ç»“æ„</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/7340/structure.jpg" class="" title="structure">

<br />

<h3 id="3-2-æ¨¡å‹ç‰¹ç‚¹"><a href="#3-2-æ¨¡å‹ç‰¹ç‚¹" class="headerlink" title="3.2 æ¨¡å‹ç‰¹ç‚¹"></a>3.2 æ¨¡å‹ç‰¹ç‚¹</h3><ul>
<li>æ¯ä¸ªå­ç›®å½•å¦‚/app1éƒ½è¢«ç§°ä½œä¸€ä¸ªznode(èŠ‚ç‚¹)ï¼Œè¿™ä¸ªznodeæ˜¯è¢«å®ƒæ‰€åœ¨çš„è·¯å¾„å”¯ä¸€æ ‡è¯†</li>
<li>znodeå¯ä»¥æœ‰å­èŠ‚ç‚¹ç›®å½•ï¼Œå¹¶ä¸”æ¯ä¸ªznodeå¯ä»¥å­˜å‚¨æ•°æ®</li>
<li>znodeæ˜¯æœ‰ç‰ˆæœ¬çš„ï¼Œæ¯ä¸ªznodeä¸­å­˜å‚¨çš„æ•°æ®å¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè®¿é—®è·¯å¾„ä¸­å¯ä»¥å­˜å‚¨å¤šä»½æ•°æ®</li>
<li>znodeå¯ä»¥è¢«ç›‘æ§ï¼ŒåŒ…æ‹¬è¿™ä¸ªç›®å½•ä¸­å­˜å‚¨çš„æ•°æ®ä¿®æ”¹ï¼Œå­èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–ç­‰ï¼Œä¸€æ—¦å˜åŒ–å¯ä»¥é€šçŸ¥è®¾ç½®ç›‘æ§çš„å®¢æˆ·ç«¯</li>
</ul>
<h3 id="3-3-èŠ‚ç‚¹åˆ†ç±»"><a href="#3-3-èŠ‚ç‚¹åˆ†ç±»" class="headerlink" title="3.3 èŠ‚ç‚¹åˆ†ç±»"></a>3.3 èŠ‚ç‚¹åˆ†ç±»</h3><p>ï¼ˆ1ï¼‰æŒä¹…èŠ‚ç‚¹ï¼ˆPERSISTENTï¼‰</p>
<p>æ˜¯æŒ‡åœ¨èŠ‚ç‚¹åˆ›å»ºåï¼Œå°±ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°æœ‰åˆ é™¤æ“ä½œæ¥ä¸»åŠ¨åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹â€”â€”ä¸ä¼šå› ä¸ºåˆ›å»ºè¯¥èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆè€Œæ¶ˆå¤±ã€‚</p>
<p>ï¼ˆ2ï¼‰æŒä¹…é¡ºåºèŠ‚ç‚¹ï¼ˆPERSISTENT_SEQUENTIALï¼‰</p>
<p>è¿™ç±»èŠ‚ç‚¹çš„åŸºæœ¬ç‰¹æ€§å’Œä¸Šé¢çš„èŠ‚ç‚¹ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚é¢å¤–çš„ç‰¹æ€§æ˜¯ï¼Œåœ¨ZKä¸­ï¼Œæ¯ä¸ªçˆ¶èŠ‚ç‚¹ä¼šä¸ºå®ƒçš„ç¬¬ä¸€çº§å­èŠ‚ç‚¹ç»´æŠ¤ä¸€ä»½æ—¶åºï¼Œä¼šè®°å½•æ¯ä¸ªå­èŠ‚ç‚¹åˆ›å»ºçš„å…ˆåé¡ºåºã€‚åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œåœ¨åˆ›å»ºå­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¯ä»¥è®¾ç½®è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºèŠ‚ç‚¹è¿‡ç¨‹ä¸­ï¼ŒZKä¼šè‡ªåŠ¨ä¸ºç»™å®šèŠ‚ç‚¹ååŠ ä¸Šä¸€ä¸ªæ•°å­—åç¼€ï¼Œä½œä¸ºæ–°çš„èŠ‚ç‚¹åã€‚è¿™ä¸ªæ•°å­—åç¼€çš„èŒƒå›´æ˜¯æ•´å½¢çš„æœ€å¤§å€¼ã€‚</p>
<p>ï¼ˆ3ï¼‰ä¸´æ—¶èŠ‚ç‚¹ï¼ˆEPHEMERALï¼‰</p>
<p>å’ŒæŒä¹…åŒ–èŠ‚ç‚¹ä¸åŒçš„æ˜¯ï¼Œä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸå’Œå®¢æˆ·ç«¯ä¼šè¯ç»‘å®šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè‡ªåŠ¨è¢«æ¸…é™¤æ‰ã€‚æ³¨æ„ï¼Œè¿™é‡Œæåˆ°çš„æ˜¯ä¼šè¯å¤±æ•ˆï¼Œè€Œéè¿æ¥æ–­å¼€ã€‚å¦å¤–ï¼Œåœ¨ä¸´æ—¶èŠ‚ç‚¹ä¸‹é¢ä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ã€‚</p>
<p>ï¼ˆ4ï¼‰ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼ˆEPHEMERAL SEQUETIALï¼‰</p>
<p>å…·æœ‰ä¸´æ—¶èŠ‚ç‚¹ç‰¹ç‚¹ï¼Œé¢å¤–çš„ç‰¹æ€§æ˜¯ï¼Œæ¯ä¸ªçˆ¶èŠ‚ç‚¹ä¼šä¸ºå®ƒçš„ç¬¬ä¸€çº§å­èŠ‚ç‚¹ç»´æŠ¤ä¸€ä»½æ—¶åºï¼Œè¿™ç‚¹å’Œåˆšæ‰æåˆ°çš„æŒä¹…é¡ºåºèŠ‚ç‚¹ç±»ä¼¼ã€‚</p>
<h2 id="4-zookeeperé…ç½®æ–‡ä»¶"><a href="#4-zookeeperé…ç½®æ–‡ä»¶" class="headerlink" title="4. zookeeperé…ç½®æ–‡ä»¶"></a>4. zookeeperé…ç½®æ–‡ä»¶</h2><h3 id="4-1-zoo-cfg"><a href="#4-1-zoo-cfg" class="headerlink" title="4.1 zoo.cfg"></a>4.1 zoo.cfg</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime&#x3D;2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit&#x3D;10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit&#x3D;5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use &#x2F;tmp for storage, &#x2F;tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line">dataDir&#x3D;&#x2F;tmp&#x2F;zookeeper</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort&#x3D;2181</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns&#x3D;60</span><br><span class="line"></span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line"># http:&#x2F;&#x2F;zookeeper.apache.org&#x2F;doc&#x2F;current&#x2F;zookeeperAdmin.html#sc_maintenance</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount&#x3D;3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval&#x3D;1</span><br><span class="line"></span><br><span class="line">## Metrics Providers</span><br><span class="line"># https:&#x2F;&#x2F;prometheus.io Metrics Exporter</span><br><span class="line">#metricsProvider.className&#x3D;org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider</span><br><span class="line">#metricsProvider.httpHost&#x3D;0.0.0.0</span><br><span class="line">#metricsProvider.httpPort&#x3D;7000</span><br><span class="line">#metricsProvider.exportJvmInfo&#x3D;true</span><br></pre></td></tr></table></figure>



<h3 id="4-2-å‚æ•°è¯´æ˜"><a href="#4-2-å‚æ•°è¯´æ˜" class="headerlink" title="4.2 å‚æ•°è¯´æ˜"></a>4.2 å‚æ•°è¯´æ˜</h3><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>tickTime</td>
<td align="left">é›†ç¾¤æœåŠ¡å™¨èŠ‚ç‚¹ä¹‹é—´æˆ–è€…æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´ç»´æŒå¿ƒè·³çš„æ—¶é—´é—´éš”ï¼Œå³æ¯éš”tickTimeä¼šå‘ç”Ÿå¿ƒè·³åŒ…ï¼Œæ—¶é—´å•ä½ä¸ºmsï¼Œå¹¶ä¸”æœ€å°sessionè¶…æ—¶æ—¶é—´ä¸º2 * tickTimeã€‚</td>
</tr>
<tr>
<td>initLimit</td>
<td align="left">åˆå§‹åŒ–é›†ç¾¤æ—¶Leaderä¸Followerä¹‹é—´çš„æœ€å¤šå¿ƒè·³æ•°ï¼Œé™å®šFollowerè¿æ¥åˆ°Leaderçš„æ—¶é™ä¸ºinitLimit * tickTimeã€‚</td>
</tr>
<tr>
<td>syncLimit</td>
<td align="left">é›†ç¾¤è¿è¡Œæ—¶Leaderä¸Followerä¹‹é—´åŒæ­¥çš„æœ€å¤§å“åº”æ—¶é—´å•ä½ï¼Œå³å“åº”æ—¶é—´è¶…è¿‡syncLimit * tickTimeï¼ŒLeaderè®¤ä¸ºFolloweræ­»äº¡ï¼Œä»æœåŠ¡å™¨åˆ—è¡¨åˆ é™¤Followerã€‚</td>
</tr>
<tr>
<td>dataDir</td>
<td align="left">æ•°æ®å­˜å‚¨ä½ç½®ã€‚</td>
</tr>
<tr>
<td>clientPort</td>
<td align="left">æœåŠ¡ç›‘å¬ç«¯å£ã€‚</td>
</tr>
<tr>
<td>maxClientCnxns</td>
<td align="left">æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°é‡ã€‚</td>
</tr>
<tr>
<td>autopurge.snapRetainCount</td>
<td align="left">å¿«ç…§ä¿å­˜æ•°é‡ï¼Œåˆ°è¾¾è¿™ä¸ªæ•°é‡è‡ªåŠ¨è¿›è¡Œå¿«ç…§åˆå¹¶ã€‚</td>
</tr>
<tr>
<td>autopurge.purgeInterval</td>
<td align="left">å¿«ç…§æ¸…ç†é¢‘ç‡ï¼Œå•ä½ä¸ºå°æ—¶ï¼Œå³è¿™ä¸ªæ—¶é—´é—´éš”å†…å¿«ç…§æ•°é‡åˆ°è¾¾ä¸Šè¿°æŒ‡å®šæ•°é‡ï¼Œå°±è¿›è¡Œå¿«ç…§åˆå¹¶ã€‚</td>
</tr>
</tbody></table>
<h2 id="5-ZooKeeperåŸºæœ¬æŒ‡ä»¤"><a href="#5-ZooKeeperåŸºæœ¬æŒ‡ä»¤" class="headerlink" title="5. ZooKeeperåŸºæœ¬æŒ‡ä»¤"></a>5. ZooKeeperåŸºæœ¬æŒ‡ä»¤</h2><blockquote>
<p>è¿›å…¥dockerå†…éƒ¨å®¢æˆ·ç«¯</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it zookeeper bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bin/zkCli.sh</span></span><br></pre></td></tr></table></figure>



<h3 id="5-1-åŸºæœ¬æŒ‡ä»¤"><a href="#5-1-åŸºæœ¬æŒ‡ä»¤" class="headerlink" title="5.1 åŸºæœ¬æŒ‡ä»¤"></a>5.1 åŸºæœ¬æŒ‡ä»¤</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls path                 <span class="comment"># æŸ¥çœ‹ç‰¹å®šèŠ‚ç‚¹ä¸‹é¢çš„å­èŠ‚ç‚¹</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> create path data        <span class="comment"># åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ç»™èŠ‚ç‚¹ç»‘å®šæ•°æ®ï¼ˆé»˜è®¤æ˜¯æŒä¹…æ€§èŠ‚ç‚¹ï¼‰</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> create -s path data     <span class="comment"># åˆ›å»ºæŒä¹…æ€§é¡ºåºèŠ‚ç‚¹</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> create -e path data     <span class="comment"># åˆ›å»ºä¸´æ—¶æ€§èŠ‚ç‚¹ï¼ˆä¸´æ—¶æ€§èŠ‚ç‚¹ä¸èƒ½å«æœ‰ä»»ä½•å­èŠ‚ç‚¹ï¼‰</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> create -e -s path data  <span class="comment"># åˆ›å»ºä¸´æ—¶æ€§é¡ºåºèŠ‚ç‚¹ï¼ˆä¸´æ—¶æ€§èŠ‚ç‚¹ä¸èƒ½å«æœ‰ä»»ä½•å­èŠ‚ç‚¹ï¼‰</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">stat</span> path               <span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">set</span> path data           <span class="comment"># ä¿®æ”¹èŠ‚ç‚¹æ•°æ®</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls2 path                <span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹ä¸‹å­©å­å’Œå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">history</span>                 <span class="comment"># æŸ¥çœ‹æ“ä½œå†å²</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> get path                <span class="comment"># è·å¾—èŠ‚ç‚¹ä¸Šç»‘å®šçš„æ•°æ®ä¿¡æ¯</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> delete path             <span class="comment"># åˆ é™¤èŠ‚ç‚¹ï¼ˆåˆ é™¤èŠ‚ç‚¹ä¸èƒ½å«æœ‰å­èŠ‚ç‚¹ï¼‰</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rmr path                <span class="comment"># é€’å½’åˆ é™¤èŠ‚ç‚¹ï¼ˆä¼šå°†å½“å‰èŠ‚ç‚¹ä¸‹æ‰€æœ‰èŠ‚ç‚¹åˆ é™¤ï¼‰</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> quit                    <span class="comment"># é€€å‡ºå½“å‰ä¼šè¯</span></span></span><br></pre></td></tr></table></figure>



<h3 id="5-2-statç»“æœè¯¦è§£"><a href="#5-2-statç»“æœè¯¦è§£" class="headerlink" title="5.2 statç»“æœè¯¦è§£"></a>5.2 statç»“æœè¯¦è§£</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1) czxid - åˆ›å»ºèŠ‚ç‚¹çš„äº‹åŠ¡çš„zxid</span><br><span class="line">2) ctime - åˆ›å»ºèŠ‚ç‚¹çš„æ¯«ç§’æ•°(ä»1970å¹´å¼€å§‹)</span><br><span class="line">3) mzxid - æ›´æ–°èŠ‚ç‚¹çš„äº‹åŠ¡zxid</span><br><span class="line">4) mtime - æœ€åæ›´æ–°çš„æ¯«ç§’æ•°(ä»1970å¹´å¼€å§‹)</span><br><span class="line">5) pZxid - æœ€åæ›´æ–°å­èŠ‚ç‚¹çš„äº‹åŠ¡zxid</span><br><span class="line">6) cversion - å­èŠ‚ç‚¹å˜åŒ–å·ï¼Œå­èŠ‚ç‚¹ä¿®æ”¹æ¬¡æ•°</span><br><span class="line">7) dataversion - æ•°æ®å˜åŒ–å·</span><br><span class="line">8) aclVersion - è®¿é—®æ§åˆ¶åˆ—è¡¨çš„å˜åŒ–å·</span><br><span class="line">9) ephemeralOwner - å¦‚æœæ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ˜¯znodeæ‹¥æœ‰è€…çš„session idï¼›å¦‚æœä¸æ˜¯ä¸´æ—¶èŠ‚ç‚¹åˆ™æ˜¯0</span><br><span class="line">10) dataLength - æ•°æ®é•¿åº¦</span><br><span class="line">11) numChildren - å­èŠ‚ç‚¹æ•°é‡</span><br></pre></td></tr></table></figure>



<h3 id="5-3-èŠ‚ç‚¹ç›‘å¬æœºåˆ¶"><a href="#5-3-èŠ‚ç‚¹ç›‘å¬æœºåˆ¶" class="headerlink" title="5.3 èŠ‚ç‚¹ç›‘å¬æœºåˆ¶"></a>5.3 èŠ‚ç‚¹ç›‘å¬æœºåˆ¶</h3><p>å®¢æˆ·ç«¯å¯ä»¥ç›‘æµ‹znodeèŠ‚ç‚¹çš„å˜åŒ–ï¼Œ<strong>znodeèŠ‚ç‚¹çš„å˜åŒ–è§¦å‘ç›¸åº”çš„äº‹ä»¶ï¼Œç„¶åæ¸…é™¤å¯¹è¯¥èŠ‚ç‚¹çš„ç›‘æµ‹</strong>ã€‚å½“ç›‘æµ‹ä¸€ä¸ªznodeèŠ‚ç‚¹æ—¶å€™ï¼Œzookeeperä¼šå‘é€é€šçŸ¥ç»™ç›‘æµ‹èŠ‚ç‚¹ã€‚ä¸€ä¸ªwatchäº‹ä»¶æ˜¯ä¸€ä¸ªä¸€æ¬¡æ€§çš„è§¦å‘å™¨ï¼Œå½“è¢«è®¾ç½®äº†watchçš„æ•°æ®è·å–ç›®å½•å‘ç”Ÿäº†æ”¹å˜çš„æ—¶å€™ï¼Œåˆ™æœåŠ¡å™¨å°†è¿™ä¸ªæ”¹å˜å‘é€ç»™è®¾ç½®äº†watchçš„å®¢æˆ·ç«¯ä»¥ä¾¿é€šçŸ¥å®ƒä»¬ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls /path <span class="literal">true</span>            <span class="comment"># ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> get /path <span class="literal">true</span>           <span class="comment"># ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–</span></span></span><br></pre></td></tr></table></figure>



<h2 id="6-Zookeeperé›†ç¾¤æ­å»º"><a href="#6-Zookeeperé›†ç¾¤æ­å»º" class="headerlink" title="6. Zookeeperé›†ç¾¤æ­å»º"></a>6. Zookeeperé›†ç¾¤æ­å»º</h2><h3 id="6-1-dockeræ­å»ºä¼ªé›†ç¾¤"><a href="#6-1-dockeræ­å»ºä¼ªé›†ç¾¤" class="headerlink" title="6.1 dockeræ­å»ºä¼ªé›†ç¾¤"></a>6.1 dockeræ­å»ºä¼ªé›†ç¾¤</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/7340/cluster.jpg" class="" title="cluster">

<br />

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹æœ€å°å®¹å™¨ip</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker network inspect bridge</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºä¸‰ä¸ªzkçš„ipåˆ†åˆ«åœ¨è¿™ä¸ªæœ€å°çš„ipä¸ŠåŠ ä¸Š1ï¼Œ2ï¼Œ3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zk1: 172.17.0.7</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zk2: 172.17.0.8</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> zk3: 172.17.0.9</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºé›†ç¾¤çš„æŒ‚è½½ç›®å½•</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p /opt/zookeeper/cluster/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºé…ç½®å’Œæ•°æ®ç›®å½•</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p node1/conf node1/data node2/conf node2/data node3/conf node3/data</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºé…ç½®æ–‡ä»¶å’Œmyid</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> touch node1/conf/zoo.cfg node2/conf/zoo.cfg node3/conf/zoo.cfg node1/data/myid node2/data/myid node3/data/myid</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸‰ä¸ªæ–‡ä»¶ç›¸åŒï¼Œå†…å®¹å¦‚ä¸‹</span></span><br><span class="line">dataDir=/data</span><br><span class="line">dataLogDir=/data/log</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">autopurge.snapRetainCount=3</span><br><span class="line">autopurge.purgeInterval=0</span><br><span class="line">maxClientCnxns=60</span><br><span class="line">standaloneEnabled=true</span><br><span class="line">admin.enableServer=true</span><br><span class="line">4lw.commands.whitelist=*</span><br><span class="line">clientPort=2181</span><br><span class="line">server.1=172.17.0.7:2888:3888</span><br><span class="line">server.2=172.17.0.8:2888:3888</span><br><span class="line">server.3=172.17.0.9:2888:3888</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¼–è¾‘myid</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;1&quot;</span> &gt;&gt; node1/data/myid</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;2&quot;</span> &gt;&gt; node2/data/myid</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;3&quot;</span> &gt;&gt; node3/data/myid</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨ä¸‰ä¸ªå®¹å™¨</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -d -p 2182:2181 -v /opt/zookeeper/cluster/node1/conf:/conf -v /opt/zookeeper/cluster/node1/data:/data --name zk1 zookeeper:3.4.14</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -d -p 2183:2181 -v /opt/zookeeper/cluster/node2/conf:/conf -v /opt/zookeeper/cluster/node2/data:/data --name zk2 zookeeper:3.4.14</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -d -p 2184:2181 -v /opt/zookeeper/cluster/node3/conf:/conf -v /opt/zookeeper/cluster/node3/data:/data --name zk3 zookeeper:3.4.14</span></span><br></pre></td></tr></table></figure>



<h3 id="6-2-æŸ¥çœ‹èŠ‚ç‚¹znodeçŠ¶æ€"><a href="#6-2-æŸ¥çœ‹èŠ‚ç‚¹znodeçŠ¶æ€" class="headerlink" title="6.2 æŸ¥çœ‹èŠ‚ç‚¹znodeçŠ¶æ€"></a>6.2 æŸ¥çœ‹èŠ‚ç‚¹znodeçŠ¶æ€</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it zk&lt;i&gt; bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./bin/zkServer.sh status</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> zk1</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line"><span class="meta">#</span><span class="bash"> zk2</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line"><span class="meta">#</span><span class="bash"> zk3</span></span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /conf/zoo.cfg</span><br><span class="line">Mode: leader</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°leaderç»“ç‚¹ä¸ºzk3ï¼Œzk1å’Œzk2ä¸ºfollowerèŠ‚ç‚¹ã€‚</p>
<h2 id="7-Javaå®¢æˆ·ç«¯æ“ä½œ"><a href="#7-Javaå®¢æˆ·ç«¯æ“ä½œ" class="headerlink" title="7. Javaå®¢æˆ·ç«¯æ“ä½œ"></a>7. Javaå®¢æˆ·ç«¯æ“ä½œ</h2><h3 id="7-1-å¼•å…¥ä¾èµ–"><a href="#7-1-å¼•å…¥ä¾èµ–" class="headerlink" title="7.1 å¼•å…¥ä¾èµ–"></a>7.1 å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.101tec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="7-2-æ—¥å¿—é…ç½®"><a href="#7-2-æ—¥å¿—é…ç½®" class="headerlink" title="7.2 æ—¥å¿—é…ç½®"></a>7.2 æ—¥å¿—é…ç½®</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">log4j.rootLogger</span> = <span class="string">INFO,CONSOLE,FILE,HIGHNESS,</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºæ—¥å¿—åˆ°æ§åˆ¶å°</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE.Threshold</span>=<span class="string">INFO</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE.Target</span>=<span class="string">System.out</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE.layout.ConversionPattern</span>=<span class="string">%-d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; HIGHNESS %-5p [%c] [%t] [%F:%L]- %m%n</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºæ—¥å¿—åˆ°æ–‡ä»¶</span></span><br><span class="line"><span class="meta">log4j.appender.FILE</span>=<span class="string">org.apache.log4j.FileAppender</span></span><br><span class="line"><span class="meta">log4j.appender.FILE.File</span>=<span class="string">log/project.log</span></span><br><span class="line"><span class="meta">log4j.appender.FILE.Append</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">log4j.appender.FILE.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.FILE.layout.ConversionPattern</span>=<span class="string">%d HIGHNESS %-5p [%c] - %m%n</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¯æ—¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"><span class="meta">log4j.appender.HIGHNESS</span>=<span class="string">org.apache.log4j.DailyRollingFileAppender</span></span><br><span class="line"><span class="comment"># æ—¥å¿—æœ€ä½çš„è¾“å‡ºçº§åˆ«</span></span><br><span class="line"><span class="meta">log4j.appender.HIGHNESS.Threshold</span>=<span class="string">INFO</span></span><br><span class="line"><span class="comment"># æ—¥å¿—æ—¥æœŸæ ¼å¼</span></span><br><span class="line"><span class="meta">log4j.appender.HIGHNESS.DatePattern</span>=<span class="string">&#x27;_&#x27;yyyy-MM-dd</span></span><br><span class="line"><span class="comment"># æ—¥å¿—ç¼–ç æ ¼å¼</span></span><br><span class="line"><span class="meta">log4j.appender.HIGHNESS.encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"><span class="comment"># æœ‰æ—¥å¿—æ—¶ç«‹å³è¾“å‡º</span></span><br><span class="line"><span class="meta">log4j.appender.HIGHNESS.ImmediateFlush</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># æ—¥å¿—æ–‡ä»¶çš„ä¿å­˜ä½ç½®åŠæ–‡ä»¶å</span></span><br><span class="line"><span class="meta">log4j.appender.HIGHNESS.File</span>=<span class="string">log/ProjectDaily.log</span></span><br><span class="line"><span class="comment"># æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°</span></span><br><span class="line"><span class="meta">log4j.appender.HIGHNESS.maxFileSize</span>=<span class="string">10KB</span></span><br><span class="line"><span class="comment"># æ—¥å¿—å¸ƒå±€æ–¹å¼</span></span><br><span class="line"><span class="meta">log4j.appender.HIGHNESS.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="comment"># æ—¥å¿—æ–‡ä»¶ä¸­æ—¥å¿—çš„æ ¼å¼</span></span><br><span class="line"><span class="meta">log4j.appender.HIGHNESS.layout.ConversionPattern</span>=<span class="string">%-d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; HIGHNESS %-5p [%c]- %m%n</span></span><br></pre></td></tr></table></figure>



<h3 id="7-3-æ­å»ºå®¢æˆ·ç«¯"><a href="#7-3-æ­å»ºå®¢æˆ·ç«¯" class="headerlink" title="7.3 æ­å»ºå®¢æˆ·ç«¯"></a>7.3 æ­å»ºå®¢æˆ·ç«¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(ZKClient.class);</span><br><span class="line"><span class="keyword">private</span> ZkClient zkClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨ip:port</span></span><br><span class="line">    <span class="comment">// ä¼šè¯è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="comment">// è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">    zkClient = <span class="keyword">new</span> ZkClient(<span class="string">&quot;192.168.117.155:2181&quot;</span>, <span class="number">6000</span> * <span class="number">30</span>, <span class="number">6000</span>, <span class="keyword">new</span> SerializableSerializer());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@After</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    zkClient.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(Integer id, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> + <span class="string">&quot;id=&quot;</span> + id + <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-4-åˆ›å»ºèŠ‚ç‚¹"><a href="#7-4-åˆ›å»ºèŠ‚ç‚¹" class="headerlink" title="7.4 åˆ›å»ºèŠ‚ç‚¹"></a>7.4 åˆ›å»ºèŠ‚ç‚¹</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span> <span class="comment">// åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. æŒä¹…èŠ‚ç‚¹</span></span><br><span class="line">    String k1 = zkClient.create(<span class="string">&quot;/para1&quot;</span>, <span class="string">&quot;k1&quot;</span>, CreateMode.PERSISTENT);</span><br><span class="line">    log.info(<span class="string">&quot;åˆ›å»ºæŒä¹…èŠ‚ç‚¹: &#123;&#125;&quot;</span>, k1);</span><br><span class="line">    <span class="comment">// 2. æŒä¹…é¡ºåºèŠ‚ç‚¹</span></span><br><span class="line">    String k2 = zkClient.create(<span class="string">&quot;/para2&quot;</span>, <span class="string">&quot;k2&quot;</span>, CreateMode.PERSISTENT_SEQUENTIAL);</span><br><span class="line">    log.info(<span class="string">&quot;åˆ›å»ºæŒä¹…é¡ºåºèŠ‚ç‚¹: &#123;&#125;&quot;</span>, k2);</span><br><span class="line">    <span class="comment">// 3. ä¸´æ—¶èŠ‚ç‚¹</span></span><br><span class="line">    String k3 = zkClient.create(<span class="string">&quot;/para3&quot;</span>, <span class="string">&quot;k3&quot;</span>, CreateMode.EPHEMERAL);</span><br><span class="line">    log.info(<span class="string">&quot;åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹: &#123;&#125;&quot;</span>, k3);</span><br><span class="line">    <span class="comment">// 4. ä¸´æ—¶é¡ºåºèŠ‚ç‚¹</span></span><br><span class="line">    String k4 = zkClient.create(<span class="string">&quot;/para4&quot;</span>, <span class="string">&quot;k4&quot;</span>, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">    log.info(<span class="string">&quot;åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼š&#123;&#125;&quot;</span>,k4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-5-æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®"><a href="#7-5-æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®" class="headerlink" title="7.5 æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®"></a>7.5 æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span> <span class="comment">// æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object data = zkClient.readData(<span class="string">&quot;/para1&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;è¯»å–/para1æ•°æ®ï¼š&#123;&#125;&quot;</span>, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-6-æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€"><a href="#7-6-æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="7.6 æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€"></a>7.6 æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span> <span class="comment">// æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line">    Object o = zkClient.readData(<span class="string">&quot;/para1&quot;</span>, stat);</span><br><span class="line">    log.info(<span class="string">&quot;èŠ‚ç‚¹/para1çŠ¶æ€ï¼š&#123;&#125;&quot;</span>, stat);</span><br><span class="line">    log.info(<span class="string">&quot;åˆ›å»ºèŠ‚ç‚¹çš„äº‹åŠ¡zxIDï¼š&#123;&#125;&quot;</span>, stat.getCzxid());</span><br><span class="line">    log.info(<span class="string">&quot;åˆ›å»ºæ¯«ç§’æ•°ï¼š&#123;&#125;&quot;</span>, stat.getCtime());</span><br><span class="line">    log.info(<span class="string">&quot;æ›´æ–°èŠ‚ç‚¹çš„äº‹åŠ¡zxIDï¼š&#123;&#125;&quot;</span>, stat.getMzxid());</span><br><span class="line">    log.info(<span class="string">&quot;æ›´æ–°æ¯«ç§’æ•°ï¼š&#123;&#125;&quot;</span>, stat.getMtime());</span><br><span class="line">    log.info(<span class="string">&quot;æ•°æ®é•¿åº¦: &#123;&#125;&quot;</span>, stat.getDataLength());</span><br><span class="line">    log.info(<span class="string">&quot;è®¿é—®æ§åˆ¶åˆ—è¡¨å˜åŒ–å·: &#123;&#125;&quot;</span>, stat.getAversion());</span><br><span class="line">    log.info(<span class="string">&quot;æ›´æ–°å­èŠ‚ç‚¹çš„äº‹åŠ¡zxIDï¼š&#123;&#125;&quot;</span>, stat.getPzxid());</span><br><span class="line">    log.info(<span class="string">&quot;å­èŠ‚ç‚¹çš„ä¿®æ”¹æ¬¡æ•°ï¼š&#123;&#125;&quot;</span>, stat.getCversion());</span><br><span class="line">    log.info(<span class="string">&quot;å­èŠ‚ç‚¹æ•°é‡ï¼š&#123;&#125;&quot;</span>, stat.getNumChildren());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-7-ä¿®æ”¹èŠ‚ç‚¹æ•°æ®"><a href="#7-7-ä¿®æ”¹èŠ‚ç‚¹æ•°æ®" class="headerlink" title="7.7 ä¿®æ”¹èŠ‚ç‚¹æ•°æ®"></a>7.7 ä¿®æ”¹èŠ‚ç‚¹æ•°æ®</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span> <span class="comment">// ä¿®æ”¹èŠ‚ç‚¹æ•°æ®</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    zkClient.writeData(<span class="string">&quot;/para1&quot;</span>, <span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">&quot;KHighness&quot;</span>));</span><br><span class="line">    User user = zkClient.readData(<span class="string">&quot;/para1&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;ä¿®æ”¹åçš„/para1: &#123;&#125;&quot;</span>, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-8-åˆ é™¤èŠ‚ç‚¹"><a href="#7-8-åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="7.8 åˆ é™¤èŠ‚ç‚¹"></a>7.8 åˆ é™¤èŠ‚ç‚¹</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span> <span class="comment">// åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> delete = zkClient.delete(<span class="string">&quot;/para1&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;delete /para1: &#123;&#125;&quot;</span>, delete);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-9-ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–"><a href="#7-9-ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–" class="headerlink" title="7.9 ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–"></a>7.9 ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span> <span class="comment">// ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–ï¼Œéä¸€æ¬¡æ€§ï¼Œæ°¸ä¹…ç›‘å¬</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getTrue</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    zkClient.subscribeDataChanges(<span class="string">&quot;/para1&quot;</span>, <span class="keyword">new</span> IZkDataListener() &#123;</span><br><span class="line">        <span class="comment">// nodeNameï¼šå½“å‰ä¿®æ”¹èŠ‚ç‚¹çš„åç§°ï¼Œresultï¼šèŠ‚ç‚¹ä¿®æ”¹ä¹‹åçš„æ•°æ®</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataChange</span><span class="params">(String nodeName, Object result)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            log.info(<span class="string">&quot;ä¿®æ”¹èŠ‚ç‚¹çš„åç§°ï¼š&#123;&#125;&quot;</span>, nodeName);</span><br><span class="line">            log.info(<span class="string">&quot;ä¿®æ”¹åèŠ‚ç‚¹æ•°æ®ï¼š&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// nodeNameï¼šå½“å‰ä¿®æ”¹èŠ‚ç‚¹çš„åç§°</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataDeleted</span><span class="params">(String nodeName)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            log.info(<span class="string">&quot;åˆ é™¤èŠ‚ç‚¹çš„åç§°ï¼š&#123;&#125;&quot;</span>, nodeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// é˜»å¡å®¢æˆ·ç«¯</span></span><br><span class="line">    System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-10-ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–"><a href="#7-10-ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–" class="headerlink" title="7.10 ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–"></a>7.10 ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span> <span class="comment">// ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–ï¼Œéä¸€æ¬¡æ€§ï¼Œæ°¸ä¹…ç›‘å¬</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lsTrue</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    zkClient.subscribeChildChanges(<span class="string">&quot;/para1&quot;</span>, <span class="keyword">new</span> IZkChildListener() &#123;</span><br><span class="line">        <span class="comment">// nodeNameï¼šå½“å‰ä¿®æ”¹èŠ‚ç‚¹çš„åç§°ï¼Œlistï¼šå‘ç”Ÿä¿®æ”¹çš„æ‰€æœ‰å­èŠ‚ç‚¹åç§°</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleChildChange</span><span class="params">(String nodeName, List&lt;String&gt; list)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            log.info(<span class="string">&quot;ä¿®æ”¹èŠ‚ç‚¹çš„åç§°ï¼š&#123;&#125;&quot;</span>, nodeName);</span><br><span class="line">            log.info(<span class="string">&quot;å‘ç”Ÿä¿®æ”¹çš„æ‰€æœ‰å­èŠ‚ç‚¹åç§°ï¼š&#123;&#125;&quot;</span>, list.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// é˜»å¡å®¢æˆ·ç«¯</span></span><br><span class="line">    System.in.read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-11-æ“ä½œé›†ç¾¤"><a href="#7-11-æ“ä½œé›†ç¾¤" class="headerlink" title="7.11 æ“ä½œé›†ç¾¤"></a>7.11 æ“ä½œé›†ç¾¤</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span> <span class="comment">// é›†ç¾¤æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cluster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¯ä»¥å°†æ‰€æœ‰èŠ‚ç‚¹çš„ip:portéƒ½æ”¾å…¥æ„é€ å‡½æ•°ï¼Œä¸­é—´ç”¨é€—å·éš”å¼€ï¼Œä¸è¦åŠ ç©ºæ ¼</span></span><br><span class="line">    ZkClient cluster = <span class="keyword">new</span> ZkClient(<span class="string">&quot;192.168.117.155:2182,192.168.117.155:2183,192.168.117.155:2184&quot;</span>);</span><br><span class="line">    Object o = zkClient.readData(<span class="string">&quot;/para1&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;é›†ç¾¤è¯»å–/para1: &#123;&#125;&quot;</span>, o.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p>æš‚æ—¶å®Œç»“ï¼Œåé¢åˆ†å¸ƒå¼é”çš„è¯ï¼Œå¾…æ›´~</p>
]]></content>
      <categories>
        <category>MiddleWare</category>
      </categories>
      <tags>
        <tag>Distributed</tag>
      </tags>
  </entry>
  <entry>
    <title>Hadoop-lab</title>
    <url>/posts/ec060e02/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-å®‰è£…CentOS7"><a href="#1-å®‰è£…CentOS7" class="headerlink" title="1. å®‰è£…CentOS7"></a>1. å®‰è£…CentOS7</h2><h3 id="1-ä¸‹è½½é•œåƒ"><a href="#1-ä¸‹è½½é•œåƒ" class="headerlink" title="1. ä¸‹è½½é•œåƒ"></a>1. ä¸‹è½½é•œåƒ</h3><blockquote>
<p>ISO: <a href="https://www.centos.org/download/">CentOS7 X86_64</a></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915192222693.png" class="" title="image-20200915192222693"><br />



<a id="more"></a>



<h3 id="2-å®‰è£…ç³»ç»Ÿ"><a href="#2-å®‰è£…ç³»ç»Ÿ" class="headerlink" title="2. å®‰è£…ç³»ç»Ÿ"></a>2. å®‰è£…ç³»ç»Ÿ</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914201854650.png" class="" title="image-20200914201854650"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914201950325.png" class="" title="image-20200914201950325"><br />



<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914202216056.png" class="" title="image-20200914202216056"><br />



<h3 id="3-è™šæ‹Ÿæœºå®Œæˆ"><a href="#3-è™šæ‹Ÿæœºå®Œæˆ" class="headerlink" title="3. è™šæ‹Ÿæœºå®Œæˆ"></a>3. è™šæ‹Ÿæœºå®Œæˆ</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914204312121.png" class="" title="image-20200914204312121"><br />



<h3 id="4-å®‰è£…Docker"><a href="#4-å®‰è£…Docker" class="headerlink" title="4. å®‰è£…Docker"></a>4. å®‰è£…Docker</h3><blockquote>
<p>Dockerè¦æ±‚CentOSç³»ç»Ÿçš„å†…æ ¸ç‰ˆæœ¬é«˜äº 3.10ï¼ŒæŸ¥çœ‹CentOSç‰ˆæœ¬æ˜¯å¦æ”¯æŒ Docker</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">uname -r</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922202458823.png" class="" title="image-20200922202458823"><br />

<blockquote>
<p>ç¡®ä¿yumåŒ…æ›´æ–°åˆ°æœ€æ–°</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo yum update</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922202118583.png" class="" title="image-20200922202118583"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922202544937.png" class="" title="image-20200922202544937"><br />

<blockquote>
<p>å®‰è£…è¿‡Dockeråˆ™å¸è½½æ—§ç‰ˆæœ¬</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo yum remove docker  docker-common docker-selinux docker-engine</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922204747806.png" class="" title="image-20200922204747806"><br />

<blockquote>
<p>å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…ï¼Œ yum-util æä¾›yum-config-manageråŠŸèƒ½ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯devicemapperé©±åŠ¨ä¾èµ–çš„</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922203530629.png" class="" title="image-20200922203530629"><br />

<blockquote>
<p>è®¾ç½®yumæºï¼ˆä½¿ç”¨é˜¿é‡Œäº‘åœ°å€ï¼‰</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922203620500.png" class="" title="image-20200922203620500"><br />

<blockquote>
<p>å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»“åº“ä¸­æ‰€æœ‰çš„dockerç‰ˆæœ¬ï¼Œå¹¶é€‰æ‹©ç‰¹å®šç‰ˆæœ¬å®‰è£…</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922203726104.png" class="" title="image-20200922203726104"><br />

<blockquote>
<p>å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Docker Engine-Community å’Œ containerd</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922204125206.png" class="" title="image-20200922204125206"><br />

<blockquote>
<p>éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker version</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922204248819.png" class="" title="image-20200922204248819"><br />

<blockquote>
<p>å¯åŠ¨Docker</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922204613291.png" class="" title="image-20200922204613291"><br />

<blockquote>
<p>è¿è¡ŒHello World</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922204637363.png" class="" title="image-20200922204637363"><br />



<h2 id="2-æ­å»ºHadoopé›†ç¾¤"><a href="#2-æ­å»ºHadoopé›†ç¾¤" class="headerlink" title="2. æ­å»ºHadoopé›†ç¾¤"></a>2. æ­å»ºHadoopé›†ç¾¤</h2><h3 id="1-ä¸‹è½½å¹¶é…ç½®JDK"><a href="#1-ä¸‹è½½å¹¶é…ç½®JDK" class="headerlink" title="1. ä¸‹è½½å¹¶é…ç½®JDK"></a>1. ä¸‹è½½å¹¶é…ç½®JDK</h3><blockquote>
<p>ä¸‹è½½ jdk</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk* -y</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914205909499.png" class="" title="image-20200914205909499"><br />

<blockquote>
<p>è·å–JAVA_HOME</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">dirname $(readlink $(readlink $(which java))) </span><br></pre></td></tr></table></figure>

<blockquote>
<p>é…ç½®ç¯å¢ƒå˜é‡</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.262.b10-0.el7_8.x86_64</span><br><span class="line">export JRE_HOME=$JAVA_HOME/jre</span><br><span class="line">export CLASSPATH=$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH</span><br><span class="line">export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914210707353.png" class="" title="image-20200914210707353"><br />

<blockquote>
<p>æŸ¥çœ‹JAVA_HOME</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">source /etc/profile</span><br><span class="line">echo $JAVA_HOME</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200930135506971.png" class="" title="image-20200930135506971"><br />

<blockquote>
<p>æµ‹è¯•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200930135637993.png" class="" title="image-20200930135637993"><br />



<h3 id="2-é…ç½®Hostsåˆ—è¡¨"><a href="#2-é…ç½®Hostsåˆ—è¡¨" class="headerlink" title="2. é…ç½®Hostsåˆ—è¡¨"></a>2. é…ç½®Hostsåˆ—è¡¨</h3><p>ç”±äºä¸¤å°è™šæ‹Ÿæœºæ˜¯åŒä¸€å°è™šæ‹Ÿæœºå¤åˆ¶è€Œæ¥ï¼Œæ‰€ä»¥å¿…é¡»å…ˆé‡æ–°ç”ŸæˆMacåœ°å€</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200930135951474.png" class="" title="image-20200930135951474"><br />

<blockquote>
<p>master å’Œ slave ç¦ç”¨é˜²ç«å¢™</p>
</blockquote>
<p>åœæ­¢é˜²ç«å¢™ </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure>

<p>ç¦ç”¨é˜²ç«å¢™</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200913225928453.png" class="" title="image-20200913225928453"><br />

<blockquote>
<p>master å’Œ slave ä¿®æ”¹ä¸»æœºå</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;sysconfig&#x2F;network</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200913230804529.png" class="" title="image-20200913230804529"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200913230917724.png" class="" title="image-20200913230917724"><br />

<blockquote>
<p>ç¡®è®¤ä¿®æ”¹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200913231003539.png" class="" title="image-20200913231003539"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200913231047961.png" class="" title="image-20200913231047961"><br />

<blockquote>
<p>master å’Œ slave æ‰§è¡Œ ifconfig æŸ¥è¯¢ IP</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ifconfig</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914215339951.png" class="" title="image-20200914215339951"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914215731073.png" class="" title="image-20200914215731073"><br />

<blockquote>
<p> master å’Œ slave å°†IPåœ°å€å’Œä¸»æœºååˆ†åˆ«æ·»åŠ è‡³/etc/hostsä¸­</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi /etc/hosts</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914215942690.png" class="" title="image-20200914215942690"><br />

<blockquote>
<p>master å’Œ slave ä¹‹é—´äº’ping</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914220102245.png" class="" title="image-20200914220102245"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914220213547.png" class="" title="image-20200914220213547"><br />



<h3 id="3-é›†ç¾¤sshå…å¯†ç™»å½•"><a href="#3-é›†ç¾¤sshå…å¯†ç™»å½•" class="headerlink" title="3. é›†ç¾¤sshå…å¯†ç™»å½•"></a>3. é›†ç¾¤sshå…å¯†ç™»å½•</h3><p>å¯¹masteræ“ä½œï¼š</p>
<blockquote>
<p>master ç”Ÿæˆå…¬é’¥</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914220829338.png" class="" title="image-20200914220829338"><br />

<blockquote>
<p>å°†å…¬é’¥è¿½åŠ åˆ°æˆæƒåˆ—è¡¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914221008829.png" class="" title="image-20200914221008829"><br />

<blockquote>
<p>ä¿®æ”¹authorized_keysæ–‡ä»¶çš„æƒé™</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod 600 ~/.ssh/authorized_keys </span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914221036706.png" class="" title="image-20200914221036706"><br />

<blockquote>
<p>å°†authorized_keysæ–‡ä»¶å¤åˆ¶åˆ°slaveèŠ‚ç‚¹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scp ~/.ssh/authorized_keys parak@slave:~/.ssh</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914221427275.png" class="" title="image-20200914221427275"><br />

<blockquote>
<p>æŸ¥çœ‹slaveçš„.sshçš„ç›®å½•</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914221514758.png" class="" title="image-20200914221514758"><br />

<blockquote>
<p>ä¿®æ”¹masterå’Œslaveçš„SSHé…ç½®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">su root</span><br><span class="line">vi /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914221856072.png" class="" title="image-20200914221856072"><br />

<blockquote>
<p>ä½¿ç”¨ssh-addæŒ‡ä»¤å°†ç§é’¥åŠ å…¥å¹¶é‡å¯sshdæœåŠ¡</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-add ~/.ssh/id_rsa</span><br><span class="line">service sshd restart</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æµ‹è¯•å…å¯†ç™»å½•</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914223950719.png" class="" title="image-20200914223950719"><br />

<p>sshç™»å½•ä¾ç„¶éœ€è¦å¯†ç ï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€ä¸‹masterçš„æ—¥å¿—æ–‡ä»¶</p>
<blockquote>
<p>cat  var/log/secure </p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200916160625256.png" class="" title="image-20200916160625256"><br />

<blockquote>
<p><strong>åŸå› </strong></p>
<p>sshdä¸ºäº†å®‰å…¨ï¼Œå¯¹å±ä¸»çš„ç›®å½•å’Œæ–‡ä»¶æƒé™æœ‰æ‰€è¦æ±‚ã€‚</p>
<p>å¦‚æœæƒé™ä¸å¯¹ï¼Œåˆ™sshçš„å…å¯†ç ç™»é™†ä¸ç”Ÿæ•ˆã€‚</p>
</blockquote>
<blockquote>
<p><strong>è§£å†³</strong></p>
<p>å°†.sshç›®å½•çš„æƒé™æ”¹ä¸º755</p>
<p>id_rsa.pubå’Œauthorized_keysæƒé™æ”¹ä¸º644</p>
<p>id_rsaæƒé™å¿…é¡»ä¸º600</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod 755 .ssh</span><br><span class="line">cd .ssh</span><br><span class="line">chmod 644 id_rsa.pub authorized_keys</span><br><span class="line">chmod 600 id_rsa</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å†æ¬¡æµ‹è¯•å…å¯†ç™»å½•</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914224837430.png" class="" title="image-20200914224837430"><br />



<h3 id="4-ä¸‹è½½å¹¶é…ç½®Hadoop"><a href="#4-ä¸‹è½½å¹¶é…ç½®Hadoop" class="headerlink" title="4. ä¸‹è½½å¹¶é…ç½®Hadoop"></a>4. ä¸‹è½½å¹¶é…ç½®Hadoop</h3><blockquote>
<p>ä¸‹è½½ï¼š<a href="https://www.apache.org/dyn/closer.cgi/hadoop/common/hadoop-3.3.0/hadoop-3.3.0.tar.gz">hadoop-2.9.2</a>    é€‰æ‹©bsfuçš„åŒ—äº¬å¤–å›½è¯­å­¦é™¢çš„é•œåƒ, é€Ÿåº¦æµæ‰¹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914211714263.png" class="" title="image-20200914211714263"><br />

<blockquote>
<p>è§£å‹ä¸‹è½½çš„å‹ç¼©åŒ…</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -zxvf hadoop-2.3.2.tar.gz</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914211633182.png" class="" title="image-20200914211633182"><br />

<blockquote>
<p>ä¿®æ”¹æ–‡ä»¶æƒé™</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod 777 hadoop-env.sh core-site.xml hdfs-site.xml yarn-site.xml mapred-site.xml slaves</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914212318855.png" class="" title="image-20200914212318855"><br />

<blockquote>
<p>é…ç½®ç¯å¢ƒå˜é‡</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gedit /home/parak/hadoop/hadoop-2.9.2/etc/hadoop/hadoop-env.sh</span><br><span class="line"></span><br><span class="line">æ·»åŠ </span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.262.b10-0.el7_8.x86_64</span><br><span class="line">export HADOOP_HOME=/home/parak/hadoop/hadoop-2.9.2</span><br><span class="line">export PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;HADOOP_HOME&#125;/bin:$&#123;HADOOP_HOME&#125;/sbin:$PATH</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é…ç½®æ ¸å¿ƒç»„ä»¶  <strong><em>core-site.xml</em></strong></p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">  you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License. See accompanying LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Put site-specific property overrides in this file. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/parak/hadoopdata<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>



<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914213003704.png" class="" title="image-20200914213003704"><br />

<blockquote>
<p>é…ç½®æ–‡ä»¶ç³»ç»Ÿ  <strong><em>hdfs.site.xml</em></strong></p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">  you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License. See accompanying LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Put site-specific property overrides in this file. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>



<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914213047280.png" class="" title="image-20200914213047280"><br />

<blockquote>
<p>é…ç½®æ–‡ä»¶ç³»ç»Ÿ  <strong><em>yarn-site.xml</em></strong></p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">  you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License. See accompanying LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Site specific YARN configuration properties --&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>master:18040<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.scheduler.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>master:18030<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.resource-tracker.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">value</span>&gt;</span>master:18025<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.admin.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">value</span>&gt;</span>master:18141<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.webapp.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        	<span class="tag">&lt;<span class="name">value</span>&gt;</span>master:18088<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>



<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914213215770.png" class="" title="image-20200914213215770"><br />

<blockquote>
<p>é…ç½®è®¡ç®—æ¡†æ¶  <strong><em>mapred-site.xml</em></strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line">  you may not use this file except in compliance with the License.</span><br><span class="line">  You may obtain a copy of the License at</span><br><span class="line"></span><br><span class="line">    http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"></span><br><span class="line">  Unless required by applicable law or agreed to in writing, software</span><br><span class="line">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">  See the License for the specific language governing permissions and</span><br><span class="line">  limitations under the License. See accompanying LICENSE file.</span><br><span class="line"><span class="meta">--&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!-- Put site-specific property overrides in this file. --&gt;</span><br><span class="line"></span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">	&lt;property&gt;</span><br><span class="line">		&lt;name&gt;mapreduce.framework.name&lt;/name&gt;</span><br><span class="line">		&lt;value&gt;yarn&lt;/value&gt;</span><br><span class="line">	&lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>



<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914213254714.png" class="" title="image-20200914213254714"><br />

<blockquote>
<p>åœ¨masterèŠ‚ç‚¹é…ç½®slavesæ–‡ä»¶ </p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914225547865.png" class="" title="image-20200914225547865"><br />



<h3 id="5-å¯åŠ¨Hadooé›†ç¾¤"><a href="#5-å¯åŠ¨Hadooé›†ç¾¤" class="headerlink" title="5. å¯åŠ¨Hadooé›†ç¾¤"></a>5. å¯åŠ¨Hadooé›†ç¾¤</h3><blockquote>
<p>åˆ‡æ¢ç”¨æˆ·  <strong><em>parak</em></strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">su parak</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é…ç½®Hadoopå¯åŠ¨çš„ç³»ç»Ÿç¯å¢ƒå˜é‡</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd</span><br><span class="line">gedit ~/.bash_profile</span><br><span class="line"></span><br><span class="line">æ·»åŠ ï¼š</span><br><span class="line"><span class="meta">#</span><span class="bash">HADOOP</span></span><br><span class="line">export HADOOP_HOME=/home/parak/hadoop/hadoop-2.9.2</span><br><span class="line">export PATH=$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$PATH</span><br><span class="line"></span><br><span class="line">æ‰§è¡Œï¼š</span><br><span class="line">source ~/.bash_profile</span><br><span class="line"></span><br><span class="line">éªŒè¯ï¼š</span><br><span class="line">echo $&#123;HADOOP_HOME&#125;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914213558226.png" class="" title="image-20200914213558226"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914230053210.png" class="" title="image-20200914230053210"><br />

<blockquote>
<p>åˆ›å»ºæ•°æ®ç›®å½•  <strong><em>hadoopdata</em></strong></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir /home/parak/hadoopdata</span><br><span class="line">chmod 777 hadoopdata/</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914225858363.png" class="" title="image-20200914225858363"><br />

<blockquote>
<p>æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hdfs namenode -format</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914230347627.png" class="" title="image-20200914230347627"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914230450.png" class="" title="image-20200914230450"><br />

<blockquote>
<p>å¯åŠ¨Hadoop</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sbin/start-all.sh</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914232331519.png" class="" title="image-20200914232331519"><br />

<blockquote>
<p>æŸ¥çœ‹è¿›ç¨‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jps</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914232056642.png" class="" title="image-20200914232056642"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914232211741.png" class="" title="image-20200914232211741"><br />



<blockquote>
<p>è¿›å…¥ <strong>FireFox</strong> è¾“å…¥ï¼š<a href="http://master:50070/">http://master:50070/</a>   </p>
<p>æ£€æŸ¥ <strong>namenode</strong> å’Œ <strong>datanode</strong> æ˜¯å¦æ­£å¸¸</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914232603284.png" class="" title="image-20200914232603284"><br />



<blockquote>
<p>è¿›å…¥ <strong>FireFox</strong> è¾“å…¥ï¼š<a href="http://master:18088/">http://master:18088/</a></p>
<p>æ£€æŸ¥ <strong>Yarn</strong> æ˜¯å¦æ­£å¸¸</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914232824073.png" class="" title="image-20200914232824073"><br />



<blockquote>
<p>è¿è¡ŒPIå®ä¾‹æ£€æŸ¥Hadoopé›†ç¾¤æ˜¯å¦æ­å»ºæˆåŠŸ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/hadoop/hadoop-2.9.2/share/hadoop/mapreduce/</span><br><span class="line">hadoop jar hadoop-mapreduce-examples-2.9.2.jar pi 10 10</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915083538083.png" class="" title="image-20200915083538083"><br />

<blockquote>
<p> <strong>æŠ¥é”™</strong>ï¼šæœªæ‰¾åˆ°ä¸»æœºè·¯ç”±</p>
<p><strong>åˆ†æ</strong>ï¼šslaveçš„é˜²ç«å¢™æ²¡æœ‰å…³é—­</p>
</blockquote>
<blockquote>
<p>æ£€æŸ¥slaveçš„é˜²ç«å¢™</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl status firewalld</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915084136061.png" class="" title="image-20200915084136061"><br />

<blockquote>
<p>å…³é—­ä¸”ç¦ç”¨é˜²ç«å¢™</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915084354244.png" class="" title="image-20200915084354244"><br />

<blockquote>
<p>å†æ¬¡è¿è¡ŒPIå®ä¾‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915084909905.png" class="" title="image-20200915084909905"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915084933355.png" class="" title="image-20200915084933355"><br />

<p>å¯ä»¥çœ‹åˆ°è¿è¡Œç»“æœï¼šPI = 3.20000000000000000000</p>
<p><strong>ç»¼ä¸Šï¼Œé›†ç¾¤æ­£å¸¸å¯åŠ¨</strong></p>
<blockquote>
<p>å…³é—­Hadoopé›†ç¾¤</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915085606053.png" class="" title="image-20200915085606053"><br />





<h2 id="3-åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„æ“ä½œ"><a href="#3-åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„æ“ä½œ" class="headerlink" title="3. åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„æ“ä½œ"></a>3. åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„æ“ä½œ</h2><h3 id="1-åˆ©ç”¨Shellå‘½ä»¤ä¸HDFSè¿›è¡Œäº¤äº’"><a href="#1-åˆ©ç”¨Shellå‘½ä»¤ä¸HDFSè¿›è¡Œäº¤äº’" class="headerlink" title="1. åˆ©ç”¨Shellå‘½ä»¤ä¸HDFSè¿›è¡Œäº¤äº’"></a>1. åˆ©ç”¨Shellå‘½ä»¤ä¸HDFSè¿›è¡Œäº¤äº’</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs    //é€‚ç”¨äºä»»ä½•ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå’ŒHDFSæ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">hadoop dfa   //åªèƒ½é€‚ç”¨äºHDFSæ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">hdfs dfs     //è·Ÿhadoop dfsçš„å‘½ä»¤ä½œç”¨ä¸€æ ·ï¼Œä¹Ÿåªèƒ½é€‚ç”¨äºHDFSæ–‡ä»¶ç³»ç»Ÿ</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915091307833.png" class="" title="image-20200915091307833"><br />

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -help put</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915091423474.png" class="" title="image-20200915091423474"><br />



<h4 id="1-ç›®å½•æ“ä½œ"><a href="#1-ç›®å½•æ“ä½œ" class="headerlink" title="(1) ç›®å½•æ“ä½œ"></a>(1) ç›®å½•æ“ä½œ</h4><blockquote>
<p>åœ¨HDFSä¸­ä¸ºparakç”¨æˆ·åˆ›å»ºä¸€ä¸ªç”¨æˆ·ç›®å½•ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -mkdir -p /user/parak</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ˜¾ç¤ºHDFSä¸­/userç›®å½•ä¸‹çš„å†…å®¹ï¼š</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -ls /user</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915091936795.png" class="" title="image-20200915091936795"><br />

<blockquote>
<p>åˆ›å»º/user/parak/inputç›®å½•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -mkdir -p /user/parak/input</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æŸ¥çœ‹/user/parak/inputç›®å½•æ˜¯å¦åˆ›å»ºæˆåŠŸ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -ls /user/parak</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915094202790.png" class="" title="image-20200915094202790"><br />

<blockquote>
<p>åˆ›å»º/inputç›®å½•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -mkdir -p /input</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ é™¤/inputç›®å½•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -rm -r /input</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æŸ¥çœ‹/inputç›®å½•æ˜¯å¦åˆ é™¤æˆåŠŸ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -ls /</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915094415033.png" class="" title="image-20200915094415033"><br />



<h4 id="2-æ–‡ä»¶æ“ä½œ"><a href="#2-æ–‡ä»¶æ“ä½œ" class="headerlink" title="(2) æ–‡ä»¶æ“ä½œ"></a>(2) æ–‡ä»¶æ“ä½œ</h4><p>â€‹       åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç»å¸¸éœ€è¦ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå‘HDFSä¸­ä¸Šä¼ æ–‡ä»¶ï¼Œæˆ–è€…æŠŠHDFSä¸­çš„æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p>
<blockquote>
<p>é¦–å…ˆï¼Œä½¿ç”¨vimç¼–è¾‘å™¨ï¼Œåœ¨æœ¬åœ°Linuxæ–‡ä»¶ç³»ç»Ÿçš„â€œ/home/parak/â€ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶myLocalFile.txtï¼Œé‡Œé¢è¾“å…¥ï¼š</p>
</blockquote>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">Hadoop</span><br><span class="line">MapReduce</span><br><span class="line">Spark</span><br><span class="line">Khighness</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç„¶åï¼ŒæŠŠæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„â€œ/home/parak/myLocalFile.txtâ€ä¸Šä¼ åˆ°HDFSä¸­çš„å½“å‰ç”¨æˆ·ç›®å½•çš„inputç›®å½•ä¸‹ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¼ åˆ°HDFSçš„â€œ/user/parak/input/â€ç›®å½•ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -put /home/parak/myLocalFile.txt /user/parak/input</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸Šä¼ åˆ°HDFSä¸­ï¼š</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -ls /user/parak/input</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æŸ¥çœ‹HDFSä¸­çš„myLocalFile.txtè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -cat /user/parak/input/myLocalFile.txt</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915094905208.png" class="" title="image-20200915094905208"><br />

<blockquote>
<p>æŠŠHDFSä¸­çš„myLocalFile.txtæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„â€œ/home/parak/ä¸‹è½½/â€è¿™ä¸ªç›®å½•ä¸‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -get /user/parak/input/myLocalFile.txt /home/parak/ä¸‹è½½</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨æœ¬åœ°æŸ¥çœ‹ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶myLocalFile.txt</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ä¸‹è½½</span><br><span class="line">ll</span><br><span class="line">cat myLocalFile.txt</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915100241999.png" class="" title="image-20200915100241999"><br />

<blockquote>
<p>æŠŠHDFSçš„â€œ/user/parak/input/myLocalFile.txtâ€æ–‡ä»¶ï¼Œæ‹·è´åˆ°HDFSçš„å¦å¤–ä¸€ä¸ªç›®å½•â€œ/inputâ€ä¸­</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -mkdir /input</span><br><span class="line">hadoop fs -cp /user/parak/input/myLocalFile.txt /input</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915100148440.png" class="" title="image-20200915100148440"><br />



<h3 id="2-åˆ©ç”¨Webç•Œé¢ç®¡ç†HDFS"><a href="#2-åˆ©ç”¨Webç•Œé¢ç®¡ç†HDFS" class="headerlink" title="2. åˆ©ç”¨Webç•Œé¢ç®¡ç†HDFS"></a>2. åˆ©ç”¨Webç•Œé¢ç®¡ç†HDFS</h3><blockquote>
<p>åœ¨æœ¬æœºChormeè¾“å…¥ <a href="http://192.168.117.141:50070/">http://192.168.117.141:50070</a> , å³å¯çœ‹åˆ°HDFSçš„Webç®¡ç†ç•Œé¢</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915093904228.png" class="" title="image-20200915093904228"><br />





<h2 id="4-åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„ç¼–ç¨‹å®è·µ"><a href="#4-åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„ç¼–ç¨‹å®è·µ" class="headerlink" title="4. åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„ç¼–ç¨‹å®è·µ"></a>4. åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„ç¼–ç¨‹å®è·µ</h2><h3 id="1-å®‰è£…Eclipse"><a href="#1-å®‰è£…Eclipse" class="headerlink" title="1. å®‰è£…Eclipse"></a>1. å®‰è£…Eclipse</h3><h4 id="1-å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…"><a href="#1-å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…" class="headerlink" title="(1) å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…"></a>(1) å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…</h4><blockquote>
<p>è¿›å…¥FireFoxæ‰“å¼€ä¸‹è½½: <a href="http://www.eclipse.org/downloads/packages/release/neon/1a/eclipse-ide-java-ee-developers">eclipe</a></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915190751901.png" class="" title="image-20200915190751901"><br />

<blockquote>
<p>æˆ–è€…</p>
<p>ç™¾åº¦ç½‘ç›˜ä¸‹è½½</p>
<p>é“¾æ¥: <a href="https://pan.baidu.com/s/1P4vDgBEj_eOSakabM93rew">https://pan.baidu.com/s/1P4vDgBEj_eOSakabM93rew</a></p>
<p>å¯†ç : eujp</p>
</blockquote>
<h4 id="2-è§£å‹å®‰è£…åŒ…"><a href="#2-è§£å‹å®‰è£…åŒ…" class="headerlink" title="(2) è§£å‹å®‰è£…åŒ…"></a>(2) è§£å‹å®‰è£…åŒ…</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar xzvf eclipse-inst-linux64.tar.gz </span><br><span class="line">cd eclipse-installer/</span><br><span class="line">ll</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915191250751.png" class="" title="image-20200915191250751"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915191446018.png" class="" title="image-20200915191446018"><br />

<h4 id="3-å®‰è£…Eclipse-For-JavaEE"><a href="#3-å®‰è£…Eclipse-For-JavaEE" class="headerlink" title="(3) å®‰è£…Eclipse For JavaEE"></a>(3) å®‰è£…Eclipse For JavaEE</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">eclipse-inst.ini</span><br></pre></td></tr></table></figure>




<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915191721107.png" class="" title="image-20200915191721107.png"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915191841247.png" class="" title="image-20200915191841247.png"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915192946961.png" class="" title="image-20200915192946961.png"><br />



<h4 id="4-åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼"><a href="#4-åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼" class="headerlink" title="(4) åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼"></a>(4) åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼</h4><blockquote>
<p>1ã€åˆ‡æ¢rootèº«ä»½ï¼šsu root</p>
<p>2ã€è¿›å…¥usr/share/applicationsç›®å½•ï¼šcd /usr/share/applications</p>
<p>3ã€åˆ›å»ºeclipase.desktopæ–‡ä»¶ï¼štouch eclipase.desktop</p>
<p>4ã€è¾“å…¥ä»¥ä¸‹å†…å®¹åä¿å­˜ï¼švi eclipase.desktop</p>
<p>5ã€æœ€åå°†å¿«æ·æ–¹å¼å¤åˆ¶åˆ°æ¡Œé¢ï¼Œå¹¶æ·»åŠ ä¿¡ä»»å³å¯</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Desktop Entry]</span><br><span class="line">Name&#x3D;Eclipse</span><br><span class="line">Exec&#x3D;&#x2F;home&#x2F;parak&#x2F;eclipse&#x2F;eclipse-j2e&#x2F;eclipse&#x2F;eclipse</span><br><span class="line">Type&#x3D;Application</span><br><span class="line">Icon&#x3D;&#x2F;home&#x2F;parak&#x2F;eclipse&#x2F;eclipse-j2e&#x2F;eclipse&#x2F;icon.xpm</span><br><span class="line">Terminal&#x3D;false</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915195019210.png" class="" title="image-20200915195019210"><br />



<h3 id="2-åˆ›å»ºeclipseå·¥ç¨‹"><a href="#2-åˆ›å»ºeclipseå·¥ç¨‹" class="headerlink" title="2. åˆ›å»ºeclipseå·¥ç¨‹"></a>2. åˆ›å»ºeclipseå·¥ç¨‹</h3><blockquote>
<p>åŒå‡»eclipseæ¡Œé¢å¿«æ·æ–¹å¼</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915195625107.png" class="" title="image-20200915195625107"><br />

<blockquote>
<p>è¿›å…¥eclipseIDE</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915195720416.png" class="" title="image-20200915195720416"><br />

<blockquote>
<p>ç‚¹å‡»ï¼šFile â€”&gt; Project â€”&gt; Java Project</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915200231455.png" class="" title="image-20200915200231455"><br />

<blockquote>
<p>è®¾ç½®JRE</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915200448059.png" class="" title="image-20200915200448059"><br />

<blockquote>
<p>æ·»åŠ JAR</p>
</blockquote>
<ul>
<li><strong>/home/parak/hadoop/hadoop-2.9.2/share/hadoop/common/</strong>:  <strong>hadoop-common-2.9.2.jar</strong>å’Œ<strong>hadoop-nfs-2.9.2.jar</strong></li>
<li><strong>/home/parak/hadoop/hadoop-2.9.2/share/hadoop/common/</strong>:  <strong>lib</strong>ç›®å½•ä¸‹çš„æ‰€æœ‰jaråŒ…</li>
<li><strong>/home/parak/hadoop/hadoop-2.9.2/share/hadoop/hdfs/</strong>:  <strong>hadoop-hdfs-2.9.2.jar</strong>å’Œ<strong>hadoop-hdfs-nfs-2.9.2.jar</strong></li>
<li><strong>/home/parak/hadoop/hadoop-2.9.2/share/hadoop/hdfs/</strong>:  <strong>lib</strong>ç›®å½•ä¸‹çš„æ‰€æœ‰jaråŒ…</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915202106984.png" class="" title="image-20200915202106984"><br />

<blockquote>
<p>ç‚¹å‡»Finishï¼Œç‚¹å‡»Open Perspectiveï¼Œå¹¶ä¸”å‹¾é€‰Remember my decision</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915202239806.png" class="" title="image-20200915202239806"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915202452808.png" class="" title="image-20200915202452808"><br />



<h3 id="3-ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºæ£€æµ‹HDFSä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶"><a href="#3-ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºæ£€æµ‹HDFSä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶" class="headerlink" title="3. ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºæ£€æµ‹HDFSä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶"></a>3. ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºæ£€æµ‹HDFSä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶</h3><h4 id="1-ç¼–å†™Javaç¨‹åº"><a href="#1-ç¼–å†™Javaç¨‹åº" class="headerlink" title="(1) ç¼–å†™Javaç¨‹åº"></a>(1) ç¼–å†™Javaç¨‹åº</h4><blockquote>
<p>å³å‡»HDFSExample â€”&gt; New â€”&gt; Class</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915203644447.png" class="" title="image-20200915203644447"><br />

<blockquote>
<p>Name = HDFSFileIfExistï¼Œç„¶åFinish</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915203811679.png" class="" title="image-20200915203811679"><br />

<blockquote>
<p>ç¼–å†™ä»£ç </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> parak</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>   2020-9-15 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HDFSFileIfExist</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            String fileName = <span class="string">&quot;/user/parak/input/myLocalFile.txt&quot;</span>;</span><br><span class="line">            Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">            conf.set(<span class="string">&quot;fs.defaultFS&quot;</span>, <span class="string">&quot;hdfs://master:9000&quot;</span>);</span><br><span class="line">            conf.set(<span class="string">&quot;fs.hdfs.impl&quot;</span>, <span class="string">&quot;org.apache.hadoop.hdfs.DistributedFileSystem&quot;</span>);</span><br><span class="line">            FileSystem fs = FileSystem.get(conf);</span><br><span class="line">            <span class="keyword">if</span>(fs.exists(<span class="keyword">new</span> Path(fileName)))&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ–‡ä»¶å­˜åœ¨&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;æ–‡ä»¶ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-è¿è¡Œç¨‹åº"><a href="#2-è¿è¡Œç¨‹åº" class="headerlink" title="(2) è¿è¡Œç¨‹åº"></a>(2) è¿è¡Œç¨‹åº</h4><blockquote>
<p>å¯åŠ¨Hadoopé›†ç¾¤</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915204824967.png" class="" title="image-20200915204824967"><br />

<blockquote>
<p>è¿è¡Œç¨‹åº</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915205051079.png" class="" title="image-20200915205051079"><br />

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915205218013.png" class="" title="image-20200915205218013"><br />

<h4 id="3-éƒ¨ç½²åˆ°Hadoopå¹³å°ä¸Šè¿è¡Œ"><a href="#3-éƒ¨ç½²åˆ°Hadoopå¹³å°ä¸Šè¿è¡Œ" class="headerlink" title="(3) éƒ¨ç½²åˆ°Hadoopå¹³å°ä¸Šè¿è¡Œ"></a>(3) éƒ¨ç½²åˆ°Hadoopå¹³å°ä¸Šè¿è¡Œ</h4><blockquote>
<p>åœ¨hadoopå®‰è£…ç›®å½•ä¸‹æ–°å»ºmyappç›®å½•ï¼Œå­˜æ”¾Hadoopåº”ç”¨ç¨‹åº</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir ~/hadoop/hadoop-2.9.2/myapp</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915205811634.png" class="" title="image-20200915205811634"><br />

<blockquote>
<p>å³å‡»HDFSExample â€”&gt; Export â€”&gt; Java â€”&gt; Runnable JAR file â€”&gt; Next</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915210022617.png" class="" title="image-20200915210022617"><br />

<blockquote>
<p>Lauch configuration: HDFSFileIfExist -HDFSExsmple</p>
<p>Export destination: /home/parak/hadoop/hadoop-2.9.2/myapp/HDFSExample.jar</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915210640358.png" class="" title="image-20200915210640358"><br />

<blockquote>
<p>å‡ºç°è­¦å‘Šï¼Œé€‰æ‹©OK</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915210911473.png" class="" title="image-20200915210911473"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915211215820.png" class="" title="image-20200915211215820"><br />

<blockquote>
<p>æŸ¥çœ‹myappä¸­ç”Ÿæˆçš„HDFSExample.jaræ–‡ä»¶</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915211618901.png" class="" title="image-20200915211618901"><br />

<blockquote>
<p>è¿è¡Œç¨‹åº</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar ~/hadoop/hadoop-2.9.2/myapp/HDFSExample.jar </span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915211802010.png" class="" title="image-20200915211802010"><br />



<h3 id="4-ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºè¯»-å†™HDFSæ–‡ä»¶"><a href="#4-ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºè¯»-å†™HDFSæ–‡ä»¶" class="headerlink" title="4. ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºè¯»/å†™HDFSæ–‡ä»¶"></a>4. ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºè¯»/å†™HDFSæ–‡ä»¶</h3><h4 id="1-è¯»å–HDFSæ–‡ä»¶ç¨‹åº"><a href="#1-è¯»å–HDFSæ–‡ä»¶ç¨‹åº" class="headerlink" title="(1) è¯»å–HDFSæ–‡ä»¶ç¨‹åº"></a>(1) è¯»å–HDFSæ–‡ä»¶ç¨‹åº</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FSDataInputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> parak</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-9-15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HDFSReadFile</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">			conf.set(<span class="string">&quot;fs.defaultFS&quot;</span>, <span class="string">&quot;hdfs://master:9000&quot;</span>);</span><br><span class="line">			conf.set(<span class="string">&quot;fs.hdfs.impl&quot;</span>,</span><br><span class="line">					<span class="string">&quot;org.apache.hadoop.hdfs.DistributedFileSystem&quot;</span>);</span><br><span class="line">			FileSystem fs = FileSystem.get(conf);</span><br><span class="line">			Path file = <span class="keyword">new</span> Path(<span class="string">&quot;/user/parak/input/myLocalFile.txt&quot;</span>);</span><br><span class="line">			FSDataInputStream getIt = fs.open(file);</span><br><span class="line">			BufferedReader d = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(getIt));</span><br><span class="line">			String content = <span class="keyword">null</span>;</span><br><span class="line">			<span class="keyword">while</span>((content = d.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">				System.out.println(content);</span><br><span class="line">			&#125;</span><br><span class="line">			d.close(); <span class="comment">// å…³é—­æ–‡ä»¶</span></span><br><span class="line">			fs.close(); <span class="comment">// å…³é—­hdfs</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915213406899.png" class="" title="image-20200915213406899"><br />

<h4 id="2-å†™HDFSæ–‡ä»¶ç¨‹åº"><a href="#2-å†™HDFSæ–‡ä»¶ç¨‹åº" class="headerlink" title="(2) å†™HDFSæ–‡ä»¶ç¨‹åº"></a>(2) å†™HDFSæ–‡ä»¶ç¨‹åº</h4> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FSDataOutputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> parak</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-9-15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HDFSWriteFile</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">			conf.set(<span class="string">&quot;fs.defaultFS&quot;</span>, <span class="string">&quot;hdfs://master:9000&quot;</span>);</span><br><span class="line">			conf.set(<span class="string">&quot;fs.hdfs.impl&quot;</span>,</span><br><span class="line">					<span class="string">&quot;org.apache.hadoop.hdfs.DistributedFileSystem&quot;</span>);</span><br><span class="line">			FileSystem fs = FileSystem.get(conf);</span><br><span class="line">			<span class="keyword">byte</span>[] buff = <span class="string">&quot;Hello, Khighness&quot;</span>.getBytes(); <span class="comment">// è¦å†™å…¥çš„å†…å®¹</span></span><br><span class="line">			String filename = <span class="string">&quot;/user/parak/test.txt&quot;</span>; <span class="comment">// è¦å†™å…¥çš„æ–‡ä»¶å</span></span><br><span class="line">			FSDataOutputStream os = fs.create(<span class="keyword">new</span> Path(filename));</span><br><span class="line">			os.write(buff, <span class="number">0</span>, buff.length);</span><br><span class="line">			System.out.println(<span class="string">&quot;Create:&quot;</span> + filename);</span><br><span class="line">			os.close();</span><br><span class="line">			fs.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915213012019.png" class="" title="image-20200915213012019"><br />



<h2 id="5-Eclipseä¸Šçš„HDFSæ“ä½œ"><a href="#5-Eclipseä¸Šçš„HDFSæ“ä½œ" class="headerlink" title="5. Eclipseä¸Šçš„HDFSæ“ä½œ"></a>5. Eclipseä¸Šçš„HDFSæ“ä½œ</h2><h3 id="1-å®‰è£…Hadoop-Eclipse-Plugin"><a href="#1-å®‰è£…Hadoop-Eclipse-Plugin" class="headerlink" title="1. å®‰è£…Hadoop-Eclipse-Plugin"></a>1. å®‰è£…Hadoop-Eclipse-Plugin</h3><p>(1) ä¸‹è½½ç›¸å…³æ’ä»¶ï¼š<a href="https://github.com/winghc/hadoop2x-eclipse-plugin">hadoop-eclipse-plugin</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922203150692.png" class="" title="image-20200922203150692"><br />

<p>æˆ‘æ˜¯vpnä¸‹è½½ä¸‹æ¥çš„ï¼Œåˆ†äº«ä¸€ä¸‹ï¼š</p>
<blockquote>
<p>å®Œæ•´åŒ…</p>
<p>ç½‘ç›˜é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1Q72HyCSUnh-Q0JRQK03Jjg">https://pan.baidu.com/s/1Q72HyCSUnh-Q0JRQK03Jjg</a></p>
<p>æå–ç ï¼škkkk</p>
<p>æ’ä»¶åŒ…</p>
<p>ç½‘ç›˜é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1dfBm7JB4ZXTR3bwF7PSaKA">https://pan.baidu.com/s/1dfBm7JB4ZXTR3bwF7PSaKA</a></p>
<p>æå–ç ï¼škkkk</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922222447098.png" class="" title="image-20200922222447098"><br />



<p>(2) ä¸‹è½½åå°†releaseä¸­çš„<code>hadoop-eclipse-plugin-2.6.0.jar</code>å¤åˆ¶åˆ° Eclipse å®‰è£…ç›®å½•çš„ plugins æ–‡ä»¶å¤¹ä¸­</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922223813270.png" class="" title="image-20200922223813270"><br />

<p>(3) è¿è¡Œ <code>eclipse-clean</code> é‡å¯ Eclipse</p>
<h3 id="2-é…ç½®Hadoop-Eclipse-Plugin"><a href="#2-é…ç½®Hadoop-Eclipse-Plugin" class="headerlink" title="2. é…ç½®Hadoop-Eclipse-Plugin"></a>2. é…ç½®Hadoop-Eclipse-Plugin</h3><p>é…ç½®å‰å¼€å¯Hadoop</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928131439434.png" class="" title="image-20200928131439434"><br />

<p>(1) åˆ‡æ¢åˆ°â€œMap/Reduceâ€å¼€å‘è§†å›¾</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928131546990.png" class="" title="image-20200928131546990"><br />



<p>(2) å»ºç«‹ä¸Hadoopé›†ç¾¤çš„è¿æ¥</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928131720837.png" class="" title="image-20200928131720837"><br />

<p>(3) å¡«å†™Hadoopè¿æ¥é…ç½®</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928131907971.png" class="" title="image-20200928131907971"><br />



<h3 id="3-åœ¨Eclipseä¸­æ“ä½œHDFSä¸­çš„æ–‡ä»¶"><a href="#3-åœ¨Eclipseä¸­æ“ä½œHDFSä¸­çš„æ–‡ä»¶" class="headerlink" title="3. åœ¨Eclipseä¸­æ“ä½œHDFSä¸­çš„æ–‡ä»¶"></a>3. åœ¨Eclipseä¸­æ“ä½œHDFSä¸­çš„æ–‡ä»¶</h3><p>ç‚¹å‡»å·¦ä¾§DFS Locationså³å¯æŸ¥çœ‹HDFSçš„æ–‡ä»¶åˆ—è¡¨</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928132219334.png" class="" title="image-20200928132219334"><br />



<h2 id="6-åœ¨Eclipseä¸­è¿è¡Œâ€Wold-Countâ€MapReduceç¨‹åº"><a href="#6-åœ¨Eclipseä¸­è¿è¡Œâ€Wold-Countâ€MapReduceç¨‹åº" class="headerlink" title="6. åœ¨Eclipseä¸­è¿è¡Œâ€Wold Countâ€MapReduceç¨‹åº"></a>6. åœ¨Eclipseä¸­è¿è¡Œâ€Wold Countâ€MapReduceç¨‹åº</h2><h3 id="1-åœ¨Eclipseä¸­åˆ›å»ºâ€WordCountâ€MapReduceé¡¹ç›®"><a href="#1-åœ¨Eclipseä¸­åˆ›å»ºâ€WordCountâ€MapReduceé¡¹ç›®" class="headerlink" title="1. åœ¨Eclipseä¸­åˆ›å»ºâ€WordCountâ€MapReduceé¡¹ç›®"></a>1. åœ¨Eclipseä¸­åˆ›å»ºâ€WordCountâ€MapReduceé¡¹ç›®</h3><blockquote>
<p>é€‰æ‹©File -&gt; New -&gt; Project -&gt; Map/Reduce Project</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928133415156.png" class="" title="image-20200928133415156"><br />

<blockquote>
<p>é¡¹ç›®åç§°=MyWordCountï¼Œç„¶åConfigure Hadoop install directory -&gt; Finish</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928133508525.png" class="" title="image-20200928133508525"><br />

<blockquote>
<p>æ–°å»ºJavaæ–‡ä»¶ï¼Œname = WordCountTest</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928134118935.png" class="" title="image-20200928134118935"><br />

<blockquote>
<p>ä»£ç å¦‚ä¸‹</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.StringTokenizer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.GenericOptionsParser;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> parak</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>   2020-9-28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCountTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WordCountTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        String[] otherArgs = (<span class="keyword">new</span> GenericOptionsParser(conf, args)).getRemainingArgs();</span><br><span class="line">        <span class="keyword">if</span>(otherArgs.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Usage: wordcount &lt;in&gt; [&lt;in&gt;...] &lt;out&gt;&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        Job job = Job.getInstance(conf, <span class="string">&quot;word count test&quot;</span>);</span><br><span class="line">        job.setJarByClass(WordCountTest.class);</span><br><span class="line">        job.setMapperClass(WordCountTest.TokenizerMapper.class);</span><br><span class="line">        job.setCombinerClass(WordCountTest.IntSumReducer.class);</span><br><span class="line">        job.setReducerClass(WordCountTest.IntSumReducer.class);</span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(IntWritable.class);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; otherArgs.length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">            FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(otherArgs[i]));</span><br><span class="line"> </span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>]));</span><br><span class="line">        System.exit(job.waitForCompletion(<span class="keyword">true</span>)?<span class="number">0</span>:<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntSumReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> IntWritable result = <span class="keyword">new</span> IntWritable();</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IntSumReducer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values, Reducer&lt;Text, IntWritable, Text, IntWritable&gt;.Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">            IntWritable val;</span><br><span class="line">            <span class="keyword">for</span>(Iterator itr = values.iterator(); itr.hasNext(); sum += val.get()) &#123;</span><br><span class="line">                val = (IntWritable)itr.next();</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">this</span>.result.set(sum);</span><br><span class="line">            context.write(key, <span class="keyword">this</span>.result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenizerMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> IntWritable one = <span class="keyword">new</span> IntWritable(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">private</span> Text word = <span class="keyword">new</span> Text();</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TokenizerMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Mapper&lt;Object, Text, Text, IntWritable&gt;.Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            StringTokenizer itr = <span class="keyword">new</span> StringTokenizer(value.toString());</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">while</span>(itr.hasMoreTokens()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.word.set(itr.nextToken());</span><br><span class="line">                context.write(<span class="keyword">this</span>.word, one);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-æ·»åŠ log4j-propertiesé…ç½®æ–‡ä»¶åˆ°srcç›®å½•ä¸‹"><a href="#2-æ·»åŠ log4j-propertiesé…ç½®æ–‡ä»¶åˆ°srcç›®å½•ä¸‹" class="headerlink" title="2. æ·»åŠ log4j.propertiesé…ç½®æ–‡ä»¶åˆ°srcç›®å½•ä¸‹"></a>2. æ·»åŠ log4j.propertiesé…ç½®æ–‡ä»¶åˆ°srcç›®å½•ä¸‹</h3><blockquote>
<p>æ–°å»ºæ–‡ä»¶</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928205438905.png" class="" title="image-20200928205438905"><br />

<blockquote>
<p>å†…å®¹å¦‚ä¸‹</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">log4j.rootLogger</span> = <span class="string">INFO,KAG,CONSOLE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">log4j.appender.KAG.Threshold</span>=<span class="string">INFO</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"></span><br><span class="line"><span class="meta">log4j.appender.KAG</span> = <span class="string">org.apache.log4j.DailyRollingFileAppender</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.File</span>=<span class="string">log/sHadoop.log</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.ImmediateFlush</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.DatePattern</span>=<span class="string">&#x27;_&#x27;yyyy-MM-dd</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.layout.ConversionPattern</span>=<span class="string">%-d&#123;yyyy-MM-dd HH:mm:ss&#125; KAG %-5p [%c] - %m%n</span></span><br><span class="line"></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="meta">log4j.appender.Threshold</span>=<span class="string">INFO</span></span><br><span class="line"></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE.Target</span>=<span class="string">System.out</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE.layout.ConversionPattern</span>=<span class="string">%-d&#123;yyyy-MM-dd HH:mm:ss&#125; KAG %-5p [%c] - %m%n</span></span><br></pre></td></tr></table></figure>



<h3 id="3-é€šè¿‡Eclipseè¿è¡Œâ€œMyWordCountâ€-MapReduceé¡¹ç›®"><a href="#3-é€šè¿‡Eclipseè¿è¡Œâ€œMyWordCountâ€-MapReduceé¡¹ç›®" class="headerlink" title="3. é€šè¿‡Eclipseè¿è¡Œâ€œMyWordCountâ€ MapReduceé¡¹ç›®"></a>3. é€šè¿‡Eclipseè¿è¡Œâ€œMyWordCountâ€ MapReduceé¡¹ç›®</h3><blockquote>
<p>æ›´æ”¹è¿è¡Œé…ç½®</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928183606296.png" class="" title="image-20200928183606296"><br />

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928184930876.png" class="" title="image-20200928184930876"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928184947160.png" class="" title="image-20200928184947160"><br />

<blockquote>
<p>æŸ¥çœ‹/user/parak/outputç›®å½•ï¼Œå’Œç›®å½•ä¸‹çš„æ–‡ä»¶</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928185257730.png" class="" title="image-20200928185257730"><br />

<blockquote>
<p>é‡å¯Eclipseï¼Œåœ¨Eclipseä¸­æŸ¥çœ‹HDFSæ–‡ä»¶ç³»ç»Ÿï¼Œ/user/parak/output</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928185548345.png" class="" title="image-20200928185548345"><br />



<h3 id="4-åœ¨Hadoopå¹³å°ä¸Šéƒ¨ç½²WordCountç¨‹åº"><a href="#4-åœ¨Hadoopå¹³å°ä¸Šéƒ¨ç½²WordCountç¨‹åº" class="headerlink" title="4. åœ¨Hadoopå¹³å°ä¸Šéƒ¨ç½²WordCountç¨‹åº"></a>4. åœ¨Hadoopå¹³å°ä¸Šéƒ¨ç½²WordCountç¨‹åº</h3><blockquote>
<p>å³é”® WordCountTest â€”&gt; Export</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928205719777.png" class="" title="image-20200928205719777"><br />

<blockquote>
<p>é€‰æ‹© Java â€”&gt; Runnable JAR File â€”&gt; Next</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928205756522.png" class="" title="image-20200928205756522"><br />

<blockquote>
<p>å¡«å…¥å†…å®¹ï¼š</p>
<p>Lauch configuration: WordCountTest - MyWordCount</p>
<p>Export destination: /home/parak/hadoop/hadoop-2.9.2/myapp/WordCount.jar</p>
<p>ç„¶åFinishå³å¯</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928210235072.png" class="" title="image-20200928210235072"><br />

<blockquote>
<p>è¿è¡Œç¨‹åº</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar /home/parak/hadoop/hadoop-<span class="number">2.9</span>.<span class="number">2</span>/myapp/WordCount.jar</span><br></pre></td></tr></table></figure>



<h2 id="7-ç»Ÿè®¡æŸç”µå•†ç½‘ç«™ä¹°å®¶æ”¶è—å•†å“æ•°é‡"><a href="#7-ç»Ÿè®¡æŸç”µå•†ç½‘ç«™ä¹°å®¶æ”¶è—å•†å“æ•°é‡" class="headerlink" title="7. ç»Ÿè®¡æŸç”µå•†ç½‘ç«™ä¹°å®¶æ”¶è—å•†å“æ•°é‡"></a>7. ç»Ÿè®¡æŸç”µå•†ç½‘ç«™ä¹°å®¶æ”¶è—å•†å“æ•°é‡</h2><p><strong>è¦æ±‚</strong></p>
<p>ç°æœ‰æŸç”µå•†ç½‘ç«™ç”¨æˆ·å¯¹å•†å“çš„æ”¶è—æ•°æ®ï¼Œè®°å½•äº†ç”¨æˆ·æ”¶è—çš„å•†å“idä»¥åŠæ”¶è—æ—¥æœŸï¼Œåä¸ºbuyer_favorite1ã€‚buyer_favorite1åŒ…å«ï¼šä¹°å®¶idï¼Œå•†å“idï¼Œæ”¶è—æ—¥æœŸè¿™ä¸‰ä¸ªå­—æ®µï¼Œæ•°æ®ä»¥â€œ\tâ€åˆ†å‰²ï¼Œæ ·æœ¬æ•°æ®åŠæ ¼å¼å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>ä¹°å®¶id  å•†å“id  æ”¶è—æ—¥æœŸ </p>
</li>
<li><p>10181  1000481  2010-04-04 16:54:31 </p>
</li>
<li><p>20001  1001597  2010-04-07 15:07:52 </p>
</li>
<li><p>20001  1001560  2010-04-07 15:08:27 </p>
</li>
<li><p>20042  1001368  2010-04-08 08:20:30 </p>
</li>
<li><p>20067  1002061  2010-04-08 16:45:33 </p>
</li>
<li><p>20056  1003289  2010-04-12 10:50:55 </p>
</li>
<li><p>20056  1003290  2010-04-12 11:57:35 </p>
</li>
<li><p>20056  1003292  2010-04-12 12:05:29 </p>
</li>
<li><p>20054  1002420  2010-04-14 15:24:12 </p>
</li>
<li><p>20055  1001679  2010-04-14 19:46:04 </p>
</li>
<li><p>20054  1010675  2010-04-14 15:23:53 </p>
</li>
<li><p>20054  1002429  2010-04-14 17:52:45 </p>
</li>
<li><p>20076  1002427  2010-04-14 19:35:39 </p>
</li>
<li><p>20054  1003326  2010-04-20 12:54:44 </p>
</li>
<li><p>20056  1002420  2010-04-15 11:24:49 </p>
</li>
<li><p>20064  1002422  2010-04-15 11:35:54 </p>
</li>
<li><p>20056  1003066  2010-04-15 11:43:01 </p>
</li>
<li><p>20056  1003055  2010-04-15 11:43:06 </p>
</li>
<li><p>20056  1010183  2010-04-15 11:45:24 </p>
</li>
<li><p>20056  1002422  2010-04-15 11:45:49 </p>
</li>
<li><p>20056  1003100  2010-04-15 11:45:54 </p>
</li>
<li><p>20056  1003094  2010-04-15 11:45:57 </p>
</li>
<li><p>20056  1003064  2010-04-15 11:46:04 </p>
</li>
<li><p>20056  1010178  2010-04-15 16:15:20 </p>
</li>
<li><p>20076  1003101  2010-04-15 16:37:27 </p>
</li>
<li><p>20076  1003103  2010-04-15 16:37:05 </p>
</li>
<li><p>20076  1003100  2010-04-15 16:37:18 </p>
</li>
<li><p>20076  1003066  2010-04-15 16:37:31 </p>
</li>
<li><p>20054  1003103  2010-04-15 16:40:14 </p>
</li>
<li><p>20054  1003100  2010-04-15 16:40:16 </p>
</li>
</ol>
<p>è¦æ±‚ç¼–å†™MapReduceç¨‹åºï¼Œç»Ÿè®¡æ¯ä¸ªä¹°å®¶æ”¶è—å•†å“æ•°é‡ã€‚</p>
<h3 id="1-åœ¨æ–‡æ¡£ä¸‹æ–°å»ºæ–‡ä»¶buyer-favourite9"><a href="#1-åœ¨æ–‡æ¡£ä¸‹æ–°å»ºæ–‡ä»¶buyer-favourite9" class="headerlink" title="1. åœ¨æ–‡æ¡£ä¸‹æ–°å»ºæ–‡ä»¶buyer_favourite9"></a>1. åœ¨æ–‡æ¡£ä¸‹æ–°å»ºæ–‡ä»¶buyer_favourite9</h3><blockquote>
<p>å†™å…¥æ•°æ®</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">10181   1000481   2010-04-04æ·»åŠ åˆ°æ—¥å† 16:54:31</span><br><span class="line">20001   1001597   2010-04-07 15:07:52</span><br><span class="line">20001   1001560   2010-04-07 15:08:27</span><br><span class="line">20042   1001368   2010-04-08 08:20:30</span><br><span class="line">20067   1002061   2010-04-08 16:45:33</span><br><span class="line">20056   1003289   2010-04-12 10:50:55</span><br><span class="line">20056   1003290   2010-04-12 11:57:35</span><br><span class="line">20056   1003292   2010-04-12 12:05:29</span><br><span class="line">20054   1002420   2010-04-14 15:24:12</span><br><span class="line">20055   1001679   2010-04-14 19:46:04</span><br><span class="line">20054   1010675   2010-04-14 15:23:53</span><br><span class="line">20054   1002429   2010-04-14 17:52:45</span><br><span class="line">20076   1002427   2010-04-14 19:35:39</span><br><span class="line">20054   1003326   2010-04-20 12:54:44</span><br><span class="line">20056   1002420   2010-04-15 11:24:49</span><br><span class="line">20064   1002422   2010-04-15 11:35:54</span><br><span class="line">20056   1003066   2010-04-15 11:43:01</span><br><span class="line">20056   1003055   2010-04-15 11:43:06</span><br><span class="line">20056   1010183   2010-04-15 11:45:24</span><br><span class="line">20056   1002422   2010-04-15 11:45:49</span><br><span class="line">20056   1003100   2010-04-15 11:45:54</span><br><span class="line">20056   1003094   2010-04-15 11:45:57</span><br><span class="line">20056   1003064   2010-04-15 11:46:04</span><br><span class="line">20056   1010178   2010-04-15 16:15:20</span><br><span class="line">20076   1003101   2010-04-15 16:37:27</span><br><span class="line">20076   1003103   2010-04-15 16:37:05</span><br><span class="line">20076   1003100   2010-04-15 16:37:18</span><br><span class="line">20076   1003066   2010-04-15 16:37:31</span><br><span class="line">20054   1003103   2010-04-15 16:40:14</span><br><span class="line">20054   1003100   2010-04-15 16:40:16 </span><br></pre></td></tr></table></figure>



<h3 id="2-å°†buyer-favourite9ä¸Šä¼ åˆ°HDFSæ–‡ä»¶ç³»ç»Ÿ"><a href="#2-å°†buyer-favourite9ä¸Šä¼ åˆ°HDFSæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="2. å°†buyer_favourite9ä¸Šä¼ åˆ°HDFSæ–‡ä»¶ç³»ç»Ÿ"></a>2. å°†buyer_favourite9ä¸Šä¼ åˆ°HDFSæ–‡ä»¶ç³»ç»Ÿ</h3><blockquote>
<p>å³é”®input â€”&gt; Upload files to DFS</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928222920023.png" class="" title="image-20200928222920023"><br />

<blockquote>
<p>é€‰æ‹©buyer_favourite1åç¡®å®š</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928225427432.png" class="" title="image-20200928225427432"><br />



<h3 id="3-æ–°å»ºjavaæ–‡ä»¶ProductNumber"><a href="#3-æ–°å»ºjavaæ–‡ä»¶ProductNumber" class="headerlink" title="3. æ–°å»ºjavaæ–‡ä»¶ProductNumber"></a>3. æ–°å»ºjavaæ–‡ä»¶ProductNumber</h3><blockquote>
<p>ä»£ç å¦‚ä¸‹</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.util.StringTokenizer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;  </span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;  </span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;  </span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;  </span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;  </span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;  </span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat; </span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> parak</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-9-28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductNumber</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">		Job job = Job.getInstance();</span><br><span class="line">		job.setJobName(<span class="string">&quot;ProductNumber&quot;</span>);</span><br><span class="line">		job.setJarByClass(ProductNumber.class);</span><br><span class="line">		job.setMapperClass(MapperHandler.class);  </span><br><span class="line">		job.setReducerClass(ReducerHandler.class);  </span><br><span class="line">		job.setOutputKeyClass(Text.class);  </span><br><span class="line">		job.setOutputValueClass(IntWritable.class);  </span><br><span class="line">		Path inputPath = <span class="keyword">new</span> Path(<span class="string">&quot;hdfs://master:9000/user/parak/input/buyer_favourite1&quot;</span>);</span><br><span class="line">		Path outputPath = <span class="keyword">new</span> Path(<span class="string">&quot;hdfs://master:9000/user/parak/output/buyer_favourite1_analysis_result&quot;</span>);</span><br><span class="line">		FileInputFormat.addInputPath(job, inputPath);</span><br><span class="line">		FileOutputFormat.setOutputPath(job, outputPath);</span><br><span class="line">		<span class="keyword">boolean</span> flag = job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">		Logger log = Logger.getLogger(ProductNumber.class);</span><br><span class="line">		log.info(<span class="string">&quot;Falg = &quot;</span> + flag);</span><br><span class="line">		System.exit(flag ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperHandler</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IntWritable intWritable = <span class="keyword">new</span> IntWritable(<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">static</span> Text word = <span class="keyword">new</span> Text();</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">			StringTokenizer tokenizer = <span class="keyword">new</span> StringTokenizer(value.toString(), <span class="string">&quot;   &quot;</span>);</span><br><span class="line">			word.set(tokenizer.nextToken());</span><br><span class="line">			context.write(word, intWritable);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReducerHandler</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line">		<span class="keyword">private</span> IntWritable intWritable = <span class="keyword">new</span> IntWritable(<span class="number">1</span>);</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">			<span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span> (IntWritable value : values) &#123;</span><br><span class="line">				sum += value.get();</span><br><span class="line">			&#125;</span><br><span class="line">			intWritable.set(sum);</span><br><span class="line">			context.write(key, intWritable);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928223752502.png" class="" title="image-20200928223752502"><br />

<blockquote>
<p>è¿è¡Œåçš„HDFSæ–‡ä»¶ç³»ç»Ÿ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928225133967.png" class="" title="image-20200928225133967"><br />



<blockquote>
<p>part-r-00000æ–‡ä»¶å†…å®¹å³ä¸ºç»Ÿè®¡ç»“æœ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928225154667.png" class="" title="image-20200928225154667"><br />





<h2 id="8-å®‰è£…éƒ¨ç½²HBase"><a href="#8-å®‰è£…éƒ¨ç½²HBase" class="headerlink" title="8. å®‰è£…éƒ¨ç½²HBase"></a>8. å®‰è£…éƒ¨ç½²HBase</h2><p>HBaseä¸Hadoopç‰ˆæœ¬æ”¯æŒå…³ç³»</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20201002211137852.png" class="" title="image-20201002211137852"><br />





<h3 id="1-ä¸‹è½½å®‰è£…HBase-1-6-0"><a href="#1-ä¸‹è½½å®‰è£…HBase-1-6-0" class="headerlink" title="1. ä¸‹è½½å®‰è£…HBase-1.6.0"></a>1. ä¸‹è½½å®‰è£…HBase-1.6.0</h3><blockquote>
<p>ä½¿ç”¨é•œåƒï¼š<a href="https://mirrors.bfsu.edu.cn/apache/hbase/">https://mirrors.bfsu.edu.cn/apache/hbase/</a></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929100114445.png" class="" title="image-20200929100114445"><br />

<blockquote>
<p>é€‰æ‹©1.6.0ï¼Œä¸‹è½½tar.gzå‹ç¼©åŒ…</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929100159559.png" class="" title="image-20200929100159559"><br />

<blockquote>
<p>è§£å‹</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar xzvf hbase-1.6.0-bin.tar.gz </span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929102107183.png" class="" title="image-20200929102107183"><br />

<blockquote>
<p>æŸ¥çœ‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929102212291.png" class="" title="image-20200929102212291"><br />



<h3 id="2-é…ç½®Hbase"><a href="#2-é…ç½®Hbase" class="headerlink" title="2. é…ç½®Hbase"></a>2. é…ç½®Hbase</h3><blockquote>
<p>è¿›å…¥HBaseå®‰è£…ä¸»ç›®å½•çš„confç›®å½•ï¼Œç„¶åä¿®æ”¹é…ç½®æ–‡ä»¶</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd conf/</span><br></pre></td></tr></table></figure>



<h4 id="1-ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-env-sh"><a href="#1-ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-env-sh" class="headerlink" title="(1) ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-env.sh"></a>(1) ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-env.sh</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gedit hbase-env.sh</span><br><span class="line"></span><br><span class="line">ä¿®æ”¹JAVA_HOME:</span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.262.b10-0.el7_8.x86_64</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929103119874.png" class="" title="image-20200929103119874"><br />

<h4 id="2-ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-site-xml"><a href="#2-ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-site-xml" class="headerlink" title="(2) ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-site.xml"></a>(2) ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-site.xml</h4><blockquote>
<p>å°†hbase-site.xmlä¿®æ”¹ä¸ºâ€˜</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="comment"> * or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="comment"> * distributed with this work for additional information</span></span><br><span class="line"><span class="comment"> * regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="comment"> * to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="comment"> * &quot;License&quot;); you may not use this file except in compliance</span></span><br><span class="line"><span class="comment"> * with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>master<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.master.info.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>60010<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929103343424.png" class="" title="image-20200929103343424"><br />

<h4 id="3-è®¾ç½®-regionservers"><a href="#3-è®¾ç½®-regionservers" class="headerlink" title="(3) è®¾ç½® regionservers"></a>(3) è®¾ç½® regionservers</h4><blockquote>
<p>å°†regionserversä¸­çš„localhostä¿®æ”¹ä¸º: slave</p>
</blockquote>
<h4 id="4-è®¾ç½®ç¯å¢ƒå˜é‡"><a href="#4-è®¾ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="(4) è®¾ç½®ç¯å¢ƒå˜é‡"></a>(4) è®¾ç½®ç¯å¢ƒå˜é‡</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gedit ~/.bash_profile</span><br><span class="line"></span><br><span class="line">å°†ä¸‹é¢ä»£ç æ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼š</span><br><span class="line"><span class="meta">#</span><span class="bash">HBase</span></span><br><span class="line">export HBASE_HOME=/home/parak/HBase/hbase-1.6.0</span><br><span class="line">export PATH=$HBASE_HOME/bin:$PATH</span><br><span class="line">export HADOOP_CLASSPATH=$HBASE_HOME/lib/*</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929104148521.png" class="" title="image-20200929104148521"><br />

<h4 id="5-å°†HBaseå¤åˆ¶åˆ°Slaveç»“ç‚¹"><a href="#5-å°†HBaseå¤åˆ¶åˆ°Slaveç»“ç‚¹" class="headerlink" title="(5) å°†HBaseå¤åˆ¶åˆ°Slaveç»“ç‚¹"></a>(5) å°†HBaseå¤åˆ¶åˆ°Slaveç»“ç‚¹</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scp -r /home/parak/HBase/hbase-1.6.0 slave:/home/parak/HBase/</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929104703378.png" class="" title="image-20200929104703378"><br />

<blockquote>
<p>æŸ¥çœ‹slaveç»“ç‚¹çš„HBaseæ–‡ä»¶å¤¹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929104827983.png" class="" title="image-20200929104827983"><br />



<h3 id="3-éªŒè¯å¹¶å¯åŠ¨HBase"><a href="#3-éªŒè¯å¹¶å¯åŠ¨HBase" class="headerlink" title="3. éªŒè¯å¹¶å¯åŠ¨HBase"></a>3. éªŒè¯å¹¶å¯åŠ¨HBase</h3><blockquote>
<p>å…ˆå¯åŠ¨Hadoop: start-all.sh</p>
<p>å†å¯åŠ¨Hbase: start-hbase.sh</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929105006101.png" class="" title="image-20200929105006101"><br />

<blockquote>
<p>å¯åŠ¨HBaseå‡ºç°é”™è¯¯</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929110647176.png" class="" title="image-20200929110647176"><br />

<p>æˆ‘æ„è¯†åˆ°æ˜¯Hadoop-2.9.2ä¸HBase-1.6.0çš„ç‰ˆæœ¬åŒ¹é…é—®é¢˜ï¼Œäºæ˜¯æˆ‘ä¸‹è½½HBase-2.2.6ã€‚</p>
<h3 id="4-é‡æ–°ä¸‹è½½é…ç½®HBase-2-2-6"><a href="#4-é‡æ–°ä¸‹è½½é…ç½®HBase-2-2-6" class="headerlink" title="4. é‡æ–°ä¸‹è½½é…ç½®HBase-2.2.6"></a>4. é‡æ–°ä¸‹è½½é…ç½®HBase-2.2.6</h3><blockquote>
<p>ä¸‹è½½</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929110514041.png" class="" title="image-20200929110514041"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929110553845.png" class="" title="image-20200929110553845"><br />

<blockquote>
<p>è§£å‹: tar xzvf hbase-2.2.6-bin.tar.gz</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929110818266.png" class="" title="image-20200929110818266"><br />

<blockquote>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-env.sh</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929111024747.png" class="" title="image-20200929111024747"><br />

<blockquote>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-site.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="comment"> * or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="comment"> * distributed with this work for additional information</span></span><br><span class="line"><span class="comment"> * regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="comment"> * to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="comment"> * &quot;License&quot;); you may not use this file except in compliance</span></span><br><span class="line"><span class="comment"> * with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    The following properties are set for running HBase as a single process on a</span></span><br><span class="line"><span class="comment">    developer workstation. With this configuration, HBase is running in</span></span><br><span class="line"><span class="comment">    &quot;stand-alone&quot; mode and without a distributed file system. In this mode, and</span></span><br><span class="line"><span class="comment">    without further configuration, HBase and ZooKeeper data are stored on the</span></span><br><span class="line"><span class="comment">    local filesystem, in a path under the value configured for `hbase.tmp.dir`.</span></span><br><span class="line"><span class="comment">    This value is overridden from its default value of `/tmp` because many</span></span><br><span class="line"><span class="comment">    systems clean `/tmp` on a regular basis. Instead, it points to a path within</span></span><br><span class="line"><span class="comment">    this HBase installation directory.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Running against the `LocalFileSystem`, as opposed to a distributed</span></span><br><span class="line"><span class="comment">    filesystem, runs the risk of data integrity issues and data loss. Normally</span></span><br><span class="line"><span class="comment">    HBase will refuse to run in such an environment. Setting</span></span><br><span class="line"><span class="comment">    `hbase.unsafe.stream.capability.enforce` to `false` overrides this behavior,</span></span><br><span class="line"><span class="comment">    permitting operation. This configuration is for the developer workstation</span></span><br><span class="line"><span class="comment">    only and __should not be used in production!__</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    See also https://hbase.apache.org/book.html#standalone_dist</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>./tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.unsafe.stream.capability.enforce<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>master<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.master.info.port<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">value</span>&gt;</span>60010<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929111344171.png" class="" title="image-20200929111344171"><br />

<blockquote>
<p>ä¿®æ”¹regionserversæ–‡ä»¶</p>
</blockquote>
<p><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="Hadoop%5Cimage-20200929113716160.png" alt="image-20200929113716160"><br /></p>
<blockquote>
<p>å°†HBaseå¤åˆ¶åˆ°SlaveèŠ‚ç‚¹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scp -r /home/parak/HBase/hbase-2.2.6 slave:/home/parak/HBase</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929112324004.png" class="" title="image-20200929112324004"><br />

<blockquote>
<p>å†æ¬¡å¯åŠ¨Hbase</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929113827901.png" class="" title="image-20200929113827901"><br />

<blockquote>
<p>æ‰“å¼€FireFoxï¼Œè¿›å…¥<a href="http://master:60010/">http://master:60010</a></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929113959833.png" class="" title="image-20200929113959833"><br />

<p>è¯´æ˜HBaseå¯åŠ¨æˆåŠŸ</p>
<h3 id="4-å…³é—­HBase"><a href="#4-å…³é—­HBase" class="headerlink" title="4. å…³é—­HBase"></a>4. å…³é—­HBase</h3><blockquote>
<p>å…ˆå…³é—­HBase: stop-hbase.sh</p>
<p>å†å…³é—­Hadoop: stop-all.sh</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929114148065.png" class="" title="image-20200929114148065"><br />



<h2 id="9-HBase-Shellå‘½ä»¤æ“ä½œ"><a href="#9-HBase-Shellå‘½ä»¤æ“ä½œ" class="headerlink" title="9. HBase Shellå‘½ä»¤æ“ä½œ"></a>9. HBase Shellå‘½ä»¤æ“ä½œ</h2><h3 id="1-å¯åŠ¨HBase-Shell"><a href="#1-å¯åŠ¨HBase-Shell" class="headerlink" title="1. å¯åŠ¨HBase Shell"></a>1. å¯åŠ¨HBase Shell</h3><h4 id="1-å¯åŠ¨HBase-Shellç•Œé¢"><a href="#1-å¯åŠ¨HBase-Shellç•Œé¢" class="headerlink" title="(1) å¯åŠ¨HBase Shellç•Œé¢"></a>(1) å¯åŠ¨HBase Shellç•Œé¢</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hbase shell</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929191351747.png" class="" title="image-20200929191351747"><br />

<h4 id="2-HBase-Shellçš„helpå‘½ä»¤"><a href="#2-HBase-Shellçš„helpå‘½ä»¤" class="headerlink" title="(2) HBase Shellçš„helpå‘½ä»¤"></a>(2) HBase Shellçš„helpå‘½ä»¤</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">help</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929191531507.png" class="" title="image-20200929191531507"><br />

<blockquote>
<p>æŸ¥çœ‹HBaseå»ºè¡¨å‘½ä»¤createçš„ç”¨æ³•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">help &quot;create&quot;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929191618099.png" class="" title="image-20200929191618099"><br />



<h3 id="2-åˆ›å»ºHBaseæ•°æ®è¡¨"><a href="#2-åˆ›å»ºHBaseæ•°æ®è¡¨" class="headerlink" title="2. åˆ›å»ºHBaseæ•°æ®è¡¨"></a>2. åˆ›å»ºHBaseæ•°æ®è¡¨</h3><blockquote>
<p>HBaseä¸­ç”¨createå‘½ä»¤åˆ›å»ºè¡¨</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="string">&#x27;student&#x27;</span>, <span class="string">&#x27;Sname&#x27;</span>, <span class="string">&#x27;Ssex&#x27;</span>, <span class="string">&#x27;Sage&#x27;</span>, <span class="string">&#x27;Sdept&#x27;</span>, <span class="string">&#x27;course&#x27;</span></span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929191856923.png" class="" title="image-20200929191856923"><br />

<blockquote>
<p>æŸ¥çœ‹â€™studentâ€™è¡¨çš„å±æ€§</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">describe &#x27;student&#x27;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929191953519.png" class="" title="image-20200929191953519"><br />



<h3 id="3-HBaseæ•°æ®åº“åŸºæœ¬æ“ä½œ"><a href="#3-HBaseæ•°æ®åº“åŸºæœ¬æ“ä½œ" class="headerlink" title="3. HBaseæ•°æ®åº“åŸºæœ¬æ“ä½œ"></a>3. HBaseæ•°æ®åº“åŸºæœ¬æ“ä½œ</h3><h4 id="1-æ·»åŠ æ•°æ®"><a href="#1-æ·»åŠ æ•°æ®" class="headerlink" title="(1) æ·»åŠ æ•°æ®"></a>(1) æ·»åŠ æ•°æ®</h4><blockquote>
<p>putå‘½ä»¤æ·»åŠ æ•°æ®ï¼Œä¸€æ¬¡åªèƒ½ä¸ºä¸€ä¸ªè¡¨çš„ä¸€è¡Œæ•°æ®çš„ä¸€ä¸ªåˆ—æ·»åŠ ä¸€ä¸ªæ•°æ®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">put &#x27;student&#x27;, &#x27;95001&#x27;, &#x27;Sname&#x27;, &#x27;Li Ying&#x27;</span><br><span class="line">put &#x27;student&#x27;, &#x27;95001&#x27;, &#x27;Sdept&#x27;, &#x27;CS&#x27;</span><br><span class="line">put &#x27;student&#x27;, &#x27;95001&#x27;, &#x27;course:math&#x27;, &#x27;81&#x27;</span><br><span class="line">put &#x27;student&#x27;, &#x27;95001&#x27;, &#x27;course:english&#x27;, &#x27;85&#x27;</span><br><span class="line">put &#x27;student&#x27;, &#x27;95002&#x27;, &#x27;course:math&#x27;, &#x27;83&#x27;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929193655517.png" class="" title="image-20200929193655517"><br />



<h4 id="2-æŸ¥çœ‹æ•°æ®"><a href="#2-æŸ¥çœ‹æ•°æ®" class="headerlink" title="(2) æŸ¥çœ‹æ•°æ®"></a>(2) æŸ¥çœ‹æ•°æ®</h4><blockquote>
<p>æŸ¥çœ‹è¡¨æŸä¸€è¡Œçš„æ•°æ®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">get &#x27;student&#x27;, &#x27;95001&#x27;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929194017359.png" class="" title="image-20200929194017359"><br />

<blockquote>
<p>æŸ¥çœ‹è¡¨çš„å…¨éƒ¨æ•°æ®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scan &#x27;student&#x27;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929194135877.png" class="" title="image-20200929194135877"><br />



<h4 id="3-åˆ é™¤æ•°æ®"><a href="#3-åˆ é™¤æ•°æ®" class="headerlink" title="(3) åˆ é™¤æ•°æ®"></a>(3) åˆ é™¤æ•°æ®</h4><blockquote>
<p>deleteå‘½ä»¤åˆ é™¤æŸä¸€é¡¹æ•°æ®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">delete &#x27;student&#x27;, &#x27;95001&#x27;, &#x27;Ssex&#x27;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929194514884.png" class="" title="image-20200929194514884"><br />

<blockquote>
<p>deleteå‘½ä»¤åˆ é™¤æŸè¡Œçš„å…¨éƒ¨æ•°æ®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">delete &#x27;student&#x27;,&#x27;95001&#x27;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929194626605.png" class="" title="image-20200929194626605"><br />



<h4 id="4-åˆ é™¤è¡¨"><a href="#4-åˆ é™¤è¡¨" class="headerlink" title="(4) åˆ é™¤è¡¨"></a>(4) åˆ é™¤è¡¨</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">disable &#x27;student&#x27;</span><br><span class="line">drop &#x27;student&#x27;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929193442627.png" class="" title="image-20200929193442627"><br />



<h3 id="4-æŸ¥è¯¢HBaseæ•°æ®è¡¨çš„å†å²æ•°æ®"><a href="#4-æŸ¥è¯¢HBaseæ•°æ®è¡¨çš„å†å²æ•°æ®" class="headerlink" title="4. æŸ¥è¯¢HBaseæ•°æ®è¡¨çš„å†å²æ•°æ®"></a>4. æŸ¥è¯¢HBaseæ•°æ®è¡¨çš„å†å²æ•°æ®</h3><blockquote>
<p>åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ï¼ŒæŒ‡å®šä¿å­˜çš„ç‰ˆæœ¬æ•°</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">create &#x27;teacher&#x27;, &#123;NAME=&gt;&#x27;username&#x27;, VERSIONS=&gt;5&#125;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929203801474.png" class="" title="image-20200929203801474"><br />

<blockquote>
<p>æ’å…¥æ•°æ®ç„¶åæ›´æ–°æ•°æ®ï¼Œä½¿å…¶äº§ç”Ÿå†å²ç‰ˆæœ¬æ•°æ®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">put &#x27;teacher&#x27;, &#x27;91001&#x27;, &#x27;username&#x27;, &#x27;Mary&#x27;</span><br><span class="line">put &#x27;teacher&#x27;, &#x27;91001&#x27;, &#x27;username&#x27;, &#x27;Mary1&#x27;</span><br><span class="line">put &#x27;teacher&#x27;, &#x27;91001&#x27;, &#x27;username&#x27;, &#x27;Mary2&#x27;</span><br><span class="line">put &#x27;teacher&#x27;, &#x27;91001&#x27;, &#x27;username&#x27;, &#x27;Mary3&#x27;</span><br><span class="line">put &#x27;teacher&#x27;, &#x27;91001&#x27;, &#x27;username&#x27;, &#x27;Mary4&#x27;</span><br><span class="line">put &#x27;teacher&#x27;, &#x27;91001&#x27;, &#x27;username&#x27;, &#x27;Mary5&#x27;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929204220031.png" class="" title="image-20200929204220031"><br />

<blockquote>
<p>æŸ¥è¯¢æ—¶ï¼ŒæŒ‡å®šæŸ¥è¯¢çš„å†å²ç‰ˆæœ¬ä¹¦ï¼ˆé»˜è®¤ä¼šæŸ¥è¯¢å‡ºæœ€æ–°çš„æ•°æ®ï¼‰</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">get &#x27;teacher&#x27;, &#x27;91001&#x27;, &#123;COLUMN=&gt;&#x27;username&#x27;, VERSIONS=&gt;5&#125;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929204245861.png" class="" title="image-20200929204245861"><br />



<h3 id="5-é€€å‡ºHBase-Shell"><a href="#5-é€€å‡ºHBase-Shell" class="headerlink" title="5. é€€å‡ºHBase Shell"></a>5. é€€å‡ºHBase Shell</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>BigData</category>
      </categories>
      <tags>
        <tag>Hadoop</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-6(å¹¶å‘å·¥å…·ä¹‹çº¿ç¨‹æ± )</title>
    <url>/posts/62082/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>çº¿ç¨‹æ± çš„æ„ä¹‰ï¼š</p>
<ol>
<li><p>é™ä½èµ„æºæ¶ˆè€—ï¼Œå¤ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹ï¼Œé™ä½å¼€é”€ã€æ§åˆ¶æœ€å¤§å¹¶å‘æ•°ï¼›</p>
</li>
<li><p>éš”ç¦»çº¿ç¨‹ç¯å¢ƒï¼Œå¯ä»¥é…ç½®ç‹¬ç«‹çº¿ç¨‹æ± ï¼Œå°†è¾ƒæ…¢çš„çº¿ç¨‹ä¸è¾ƒå¿«çš„éš”ç¦»å¼€ï¼Œé¿å…ç›¸äº’å½±å“ï¼›</p>
</li>
<li><p>å®ç°ä»»åŠ¡çº¿ç¨‹é˜Ÿåˆ—ç¼“å†²ç­–ç•¥å’Œæ‹’ç»ç­–ç•¥ï¼›</p>
</li>
<li><p>å®ç°æŸäº›ä¸æ—¶é—´ç›¸å…³çš„åŠŸèƒ½ï¼Œå¦‚å®šæ—¶æ‰§è¡Œå’Œå‘¨æœŸæ‰§è¡Œç­‰ã€‚</p>
</li>
</ol>
<h2 id="6-1-è‡ªå®šä¹‰çº¿ç¨‹æ± "><a href="#6-1-è‡ªå®šä¹‰çº¿ç¨‹æ± " class="headerlink" title="6.1 è‡ªå®šä¹‰çº¿ç¨‹æ± "></a>6.1 è‡ªå®šä¹‰çº¿ç¨‹æ± </h2><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62082/image-20210430145117537.png" class="" title="image-20210430145117537.png"><br />

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayDeque;</span><br><span class="line"><span class="keyword">import</span> java.util.Deque;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-04-30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;ParaKThreadPoolDemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParaKThreadPoolDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ParaKThreadPool threadPool = <span class="keyword">new</span> ParaKThreadPool(</span><br><span class="line">                <span class="number">1</span>, <span class="number">1000</span>, TimeUnit.MILLISECONDS, <span class="number">1</span>,</span><br><span class="line">                <span class="comment">// (1) ä¸€ç›´ç­‰å¾…</span></span><br><span class="line">                <span class="comment">// BlockingQueue::put</span></span><br><span class="line"><span class="comment">//                (2) è¶…æ—¶ç­‰å¾…</span></span><br><span class="line">                (queue, task) -&gt; &#123;</span><br><span class="line">                    queue.offer(task, <span class="number">1500</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// (3) æ”¾å¼ƒæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//                (queue, task) -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                    log.debug(&quot;æ”¾å¼ƒæ‰§è¡Œ: &#123;&#125;&quot;, task);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line">                <span class="comment">// (4) æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="comment">//                (queue, task) -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                    throw new RuntimeException(&quot;ä»»åŠ¡æ‰§è¡Œå¤±è´¥: &quot; + task);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line">                <span class="comment">// (5) è‡ªå·±æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//                (queue, task) -&gt; &#123;</span></span><br><span class="line"><span class="comment">//                    task.run();</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> k = i;</span><br><span class="line">            threadPool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>, k);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;ParaKThreadPool&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParaKThreadPool</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Runnable&gt; taskQueue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿ç¨‹é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> coreSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ—¶é—´å•ä½</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TimeUnit timeUnit;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹’ç»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">private</span> RejectPolicy&lt;Runnable&gt; rejectPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParaKThreadPool</span><span class="params">(<span class="keyword">int</span> coreSize, <span class="keyword">long</span> timeout, TimeUnit timeUnit, <span class="keyword">int</span> queueCapacity, RejectPolicy&lt;Runnable&gt; rejectPolicy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.coreSize = coreSize;</span><br><span class="line">        <span class="keyword">this</span>.timeout = timeout;</span><br><span class="line">        <span class="keyword">this</span>.timeUnit = timeUnit;</span><br><span class="line">        <span class="keyword">this</span>.taskQueue = <span class="keyword">new</span> BlockingQueue&lt;&gt;(queueCapacity);</span><br><span class="line">        <span class="keyword">this</span>.rejectPolicy = rejectPolicy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å½“ä»»åŠ¡æ•°æ²¡æœ‰è¶…è¿‡coreSizeæ—¶ï¼Œç›´æ¥äº¤ç»™workerå¯¹è±¡æ‰§è¡Œ</span></span><br><span class="line">        <span class="comment">// å¦‚æœä»»åŠ¡æ•°è¶…è¿‡coreSizeæ—¶ï¼ŒåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—æš‚å­˜</span></span><br><span class="line">        <span class="keyword">synchronized</span> (workers) &#123;</span><br><span class="line">            <span class="keyword">if</span> (workers.size() &lt; coreSize) &#123;</span><br><span class="line">                Worker worker = <span class="keyword">new</span> Worker(task);</span><br><span class="line">                log.debug(<span class="string">&quot;æ‰§è¡Œçº¿ç¨‹æ–°å¢: &#123;&#125;&quot;</span>, worker);</span><br><span class="line">                workers.add(worker);</span><br><span class="line">                worker.start();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// (1) ä¸€ç›´ç­‰å¾…</span></span><br><span class="line">                <span class="comment">// (2) è¶…æ—¶ç­‰å¾…</span></span><br><span class="line">                <span class="comment">// (3) æ”¾å¼ƒæ‰§è¡Œ</span></span><br><span class="line">                <span class="comment">// (4) æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="comment">// (5) è®©è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                taskQueue.tryPut(rejectPolicy, task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Runnable task;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Worker</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">            <span class="comment">// (1) å½“taskä¸ä¸ºç©ºï¼Œæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">            <span class="comment">// (2) å½“taskæ‰§è¡Œå®Œæ¯•ï¼Œå†æ¥ç€ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡å¹¶æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//            while (task != null || (task = taskQueue.take()) != null) &#123;</span></span><br><span class="line">            <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = taskQueue.poll(timeout, timeUnit)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ­£åœ¨æ‰§è¡Œ =&gt; &#123;&#125;&quot;</span>, task);</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    task = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (workers) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ‰§è¡Œçº¿ç¨‹ç§»é™¤: &#123;&#125;&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">                workers.remove(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;BlockingQueue&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlockingQueue</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;T&gt; queue = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿäº§è€…æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition fullWaitSet = lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¶ˆè´¹è€…æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition emptyWaitSet = lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸¦è¶…æ—¶çš„é˜»å¡è·å–</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">poll</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// å°†è¶…æ—¶æ—¶é—´ç»Ÿä¸€è½¬æ¢ä¸ºçº³ç§’</span></span><br><span class="line">            <span class="keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">            <span class="keyword">while</span> (queue.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// è¿”å›å‰©ä½™æ—¶é—´</span></span><br><span class="line">                    <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    nanos = emptyWaitSet.awaitNanos(nanos);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            T t = queue.removeFirst();</span><br><span class="line">            fullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜»å¡è·å–</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">take</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—ä¸ºç©ºï¼Œé˜»å¡</span></span><br><span class="line">            <span class="keyword">while</span> (queue.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    emptyWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            T t = queue.removeFirst();</span><br><span class="line">            fullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é˜»å¡æ·»åŠ </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(T element)</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—å·²æ»¡ï¼Œé˜»å¡</span></span><br><span class="line">            <span class="keyword">while</span> (queue.size() == capacity) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—: &#123;&#125;...&quot;</span>, element);</span><br><span class="line">                fullWaitSet.await();</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—: &#123;&#125;&quot;</span>, element);</span><br><span class="line">            queue.addLast(element);</span><br><span class="line">            emptyWaitSet.signal();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸¦è¶…æ—¶æ—¶é—´æ·»åŠ </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(T element, <span class="keyword">long</span> timeout, TimeUnit timeUnit)</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> nanos = timeUnit.toNanos(timeout);</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—å·²æ»¡ï¼Œé˜»å¡</span></span><br><span class="line">            <span class="keyword">while</span> (queue.size() == capacity) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—: &#123;&#125;...&quot;</span>, element);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    nanos = fullWaitSet.awaitNanos(nanos);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—: &#123;&#125;&quot;</span>, element);</span><br><span class="line">            queue.addLast(element);</span><br><span class="line">            emptyWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å¤§å°</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> queue.size();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tryPut</span><span class="params">(RejectPolicy&lt;T&gt; rejectPolicy, T task)</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡</span></span><br><span class="line">            <span class="keyword">if</span> (queue.size() == capacity) &#123;</span><br><span class="line">                rejectPolicy.reject(<span class="keyword">this</span>, task);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// æœ‰ç©ºé—²</span></span><br><span class="line">                log.debug(<span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ— &#123;&#125;&quot;</span>, task);</span><br><span class="line">                queue.addLast(task);</span><br><span class="line">                emptyWaitSet.signal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RejectPolicy</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reject</span><span class="params">(BlockingQueue&lt;T&gt; queue, T task)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-2-ThreadPoolExecutor"><a href="#6-2-ThreadPoolExecutor" class="headerlink" title="6.2 ThreadPoolExecutor"></a>6.2 ThreadPoolExecutor</h2><h3 id="6-2-1-çº¿ç¨‹æ± çš„ç»§æ‰¿å…³ç³»"><a href="#6-2-1-çº¿ç¨‹æ± çš„ç»§æ‰¿å…³ç³»" class="headerlink" title="6.2.1 çº¿ç¨‹æ± çš„ç»§æ‰¿å…³ç³»"></a>6.2.1 çº¿ç¨‹æ± çš„ç»§æ‰¿å…³ç³»</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62082/image-20210804224714619.png" class="" title="image-20210804224714619"><br />



<h3 id="6-2-2-Executoræ¡†æ¶ç»“æ„"><a href="#6-2-2-Executoræ¡†æ¶ç»“æ„" class="headerlink" title="6.2.2 Executoræ¡†æ¶ç»“æ„"></a>6.2.2 Executoræ¡†æ¶ç»“æ„</h3><p>ä¸‰å¤§éƒ¨åˆ†ï¼š</p>
<ul>
<li>ä»»åŠ¡ç±»ï¼ˆRunnable / Callableï¼‰ï¼šæ‰§è¡Œä»»åŠ¡éœ€è¦å®ç°çš„<code>Runnable</code>æˆ–è€…<code>Callable</code>æ¥å£ã€‚</li>
<li>ä»»ä½•çš„æ‰§è¡Œï¼ˆExecutorï¼‰ï¼šä»»åŠ¡æ‰§è¡Œæœºåˆ¶çš„æ ¸å¿ƒæ¥å£<code>Executor</code>ï¼Œä»¥åŠç»§æ‰¿è‡ª<code>Executor</code>æ¥å£çš„<code>ExecutorService</code>æ¥å£ã€‚</li>
<li>å¼‚æ­¥è®¡ç®—ç»“æœï¼ˆFutureï¼‰ï¼š<code>Future</code>æ¥å£ä»¥åŠ<code>FutureTask</code>ç±»éƒ½å¯ä»¥ä»£è¡¨å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚</li>
</ul>
<p>ä½¿ç”¨ç¤ºæ„ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62082/image-20210430184722889.png" class="" title="image-20210430184722889.png"><br />



<h3 id="6-2-3-çº¿ç¨‹æ± çŠ¶æ€"><a href="#6-2-3-çº¿ç¨‹æ± çŠ¶æ€" class="headerlink" title="6.2.3 çº¿ç¨‹æ± çŠ¶æ€"></a>6.2.3 çº¿ç¨‹æ± çŠ¶æ€</h3><p><code>ThreadPoolExecutor</code>ä½¿ç”¨intçš„é«˜3ä½æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½29ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡ã€‚</p>
<table>
<thead>
<tr>
<th>çŠ¶æ€å</th>
<th>é«˜3ä½</th>
<th>æ¥æ”¶æ–°ä»»åŠ¡</th>
<th>å¤„ç†é˜»å¡é˜Ÿåˆ—ä»»åŠ¡</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>RUNNING</td>
<td>111</td>
<td>Y</td>
<td>Y</td>
<td>æ¥æ”¶æ–°ä»»åŠ¡ï¼ŒåŒæ—¶å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</td>
</tr>
<tr>
<td>SHUTDOWN</td>
<td>000</td>
<td>N</td>
<td>Y</td>
<td>ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†ä¼šå¤„ç†é˜»å¡é˜Ÿåˆ—å‰©ä½™ä»»åŠ¡</td>
</tr>
<tr>
<td>STOP</td>
<td>001</td>
<td>N</td>
<td>N</td>
<td>ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å¼ƒé˜»å¡é˜Ÿåˆ—ä»»åŠ¡</td>
</tr>
<tr>
<td>TIDYING</td>
<td>010</td>
<td>-</td>
<td>-</td>
<td>ä»»åŠ¡å…¨æ‰§è¡Œå®Œæ¯•ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸º0å³å°†è¿›å…¥ç»ˆç»“</td>
</tr>
<tr>
<td>TERMINATED</td>
<td>011</td>
<td>-</td>
<td>-</td>
<td>ç»ˆç»“çŠ¶æ€</td>
</tr>
</tbody></table>
<p>ä»æ•°å­—ä¸Šæ¯”è¾ƒï¼ˆç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½ï¼‰ï¼ŒTERMINATED &gt; TIDYING &gt; STOP &gt; SHUTDOWN &gt; RUNNINGã€‚</p>
<p>è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåŸå­å˜é‡ctlä¸­ï¼Œç›®çš„æ˜¯å°†çº¿ç¨‹æ± çŠ¶æ€ä¸çº¿ç¨‹ä¸ªæ•°åˆäºŒä¸ºä¸€ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸€æ¬¡CASåŸå­æ“ä½œè¿›è¡Œèµ‹å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// cä¸ºæ—§å€¼ï¼ŒctlOfè¿”å›ç»“æœä¸ºæ–°å€¼</span></span><br><span class="line">ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// rsä¸ºé«˜ä¸‰ä½ä»£è¡¨çº¿ç¨‹æ± çŠ¶æ€ï¼Œwcä¸ºä½29ä½ä»£è¡¨çº¿ç¨‹ä¸ªæ•°ï¼Œctlæ˜¯åˆå¹¶å®ƒä»¬</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-2-4-çº¿ç¨‹æ± å±æ€§"><a href="#6-2-4-çº¿ç¨‹æ± å±æ€§" class="headerlink" title="6.2.4 çº¿ç¨‹æ± å±æ€§"></a>6.2.4 çº¿ç¨‹æ± å±æ€§</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** å·¥ä½œçº¿ç¨‹ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/** æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ */</span></span><br><span class="line">    <span class="keyword">final</span> Thread thread;</span><br><span class="line">    <span class="comment">/** åˆå§‹åŒ–ä»»åŠ¡ */</span></span><br><span class="line">    Runnable firstTask;</span><br><span class="line">    <span class="comment">/** å·²å®Œæˆçš„ä»»åŠ¡æ•°é‡ */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> completedTasks;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/** é˜»å¡é˜Ÿåˆ— */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line"><span class="comment">/** é” */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="comment">/** çº¿ç¨‹å®¹å™¨ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> HashSet&lt;Worker&gt;();</span><br></pre></td></tr></table></figure>



<h3 id="6-2-5-æ„é€ å‡½æ•°å’Œå‚æ•°"><a href="#6-2-5-æ„é€ å‡½æ•°å’Œå‚æ•°" class="headerlink" title="6.2.5 æ„é€ å‡½æ•°å’Œå‚æ•°"></a>6.2.5 æ„é€ å‡½æ•°å’Œå‚æ•°</h3><p>æœ€å…¨æ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                          TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                          ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                          RejectedExecutionHandler handler)</span></span></span><br></pre></td></tr></table></figure>

<p>å‚æ•°è§£é‡Šï¼š</p>
<ul>
<li><code>corePoolSize</code>ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°é‡</li>
<li><code>maximumPoolSize</code>ï¼šæœ€å¤§çº¿ç¨‹æ•°é‡<ul>
<li><code>maximumPool - corePoolSize</code>ï¼šæ•‘æ€¥çº¿ç¨‹æ•°é‡</li>
<li>åœ¨æ²¡æœ‰ç©ºé—²çš„æ ¸å¿ƒçº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—æ»¡äº†çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨æ•‘æ€¥çº¿ç¨‹</li>
</ul>
</li>
<li><code>keepAliveTime</code>ï¼šæœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼ˆå¯¹äºæ•‘æ€¥çº¿ç¨‹ï¼‰</li>
<li><code>unit</code>ï¼šæ—¶é—´å•ä½</li>
<li><code>workQueue</code>ï¼šé˜»å¡é˜Ÿåˆ—ï¼ˆå­˜æ”¾ä»»åŠ¡ï¼‰<ul>
<li>æœ‰ç•Œé˜»å¡é˜Ÿåˆ—<code>ArrayBlockingQueue</code></li>
<li>æ— ç•Œé˜»å¡é˜Ÿåˆ—<code>LinkedBlockingQueue</code></li>
<li>æœ€å¤šåªæœ‰ä¸€ä¸ªåŒæ­¥å…ƒç´ çš„<code>SynchronousQueue</code></li>
<li>ä¼˜å…ˆé˜Ÿåˆ—<code>PriorityBlockingQueue</code></li>
</ul>
</li>
<li><code>threadFactory</code>ï¼šçº¿ç¨‹å·¥å‚</li>
<li><code>handler</code>ï¼šæ‹’ç»ç­–ç•¥</li>
</ul>
<p>å·¥ä½œæµç¨‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62082/image-20210430203563881.png" class="" title="image-20210430203563881.png"><br />





<h3 id="6-2-6-æ‹’ç»ç­–ç•¥å’Œåœºæ™¯"><a href="#6-2-6-æ‹’ç»ç­–ç•¥å’Œåœºæ™¯" class="headerlink" title="6.2.6 æ‹’ç»ç­–ç•¥å’Œåœºæ™¯"></a>6.2.6 æ‹’ç»ç­–ç•¥å’Œåœºæ™¯</h3><p>å¦‚æœçº¿ç¨‹æ•°é‡è¾¾åˆ°<code>maximumPoolSize</code>ä»ç„¶æœ‰æ–°äººç‰©æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼ŒJDKæä¾›äº†å››ç§å®ç°ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62082/image-20210430215158450.png" class="" title="image-20210430215158450"><br />

<p>å…·ä½“ï¼š</p>
<p>ï¼ˆ1ï¼‰<code>AbortPolicy</code>ç»ˆæ­¢ç­–ç•¥ï¼šä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡º<code>RejectedExecutionException</code>å¼‚å¸¸ï¼Œè¿™æ˜¯é»˜è®¤ç­–ç•¥ã€‚</p>
<ul>
<li>è¯¦è¿°ï¼šè¿™æ˜¯çº¿ç¨‹æ± é»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼Œåœ¨ä»»åŠ¡ä¸èƒ½å†æäº¤çš„æ—¶å€™ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼ŒåŠæ—¶åé¦ˆç¨‹åºè¿è¡ŒçŠ¶æ€ã€‚å¦‚æœæ˜¯æ¯”è¾ƒå…³é”®çš„ä¸šåŠ¡ï¼Œæ¨èä½¿ç”¨æ­¤æ‹’ç»ç­–ç•¥ï¼Œè¿™æ ·å­åœ¨ç³»ç»Ÿä¸èƒ½æ‰¿è½½æ›´å¤§çš„å¹¶å‘é‡çš„æ—¶å€™ï¼Œèƒ½å¤ŸåŠæ—¶çš„é€šè¿‡å¼‚å¸¸å‘ç°ã€‚</li>
<li>åŠŸèƒ½ï¼šå½“è§¦å‘æ‹’ç»ç­–ç•¥æ—¶ï¼Œç›´æ¥æŠ›å‡ºæ‹’ç»æ‰§è¡Œçš„å¼‚å¸¸ï¼Œä¸­æ­¢ç­–ç•¥çš„æ„æ€ä¹Ÿå°±æ˜¯æ‰“æ–­å½“å‰æ‰§è¡Œæµç¨‹ã€‚</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šè¿™ä¸ªå°±æ²¡æœ‰ç‰¹æ®Šçš„åœºæ™¯äº†ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹è¦æ­£ç¡®å¤„ç†æŠ›å‡ºçš„å¼‚å¸¸ã€‚ThreadPoolExecutorä¸­é»˜è®¤çš„ç­–ç•¥å°±æ˜¯AbortPolicyï¼ŒExecutorServiceæ¥å£çš„ç³»åˆ—ThreadPoolExecutorå› ä¸ºéƒ½æ²¡æœ‰æ˜¾ç¤ºçš„è®¾ç½®æ‹’ç»ç­–ç•¥ï¼Œæ‰€ä»¥é»˜è®¤çš„éƒ½æ˜¯è¿™ä¸ªã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼ŒExecutorServiceä¸­çš„çº¿ç¨‹æ± å®ä¾‹é˜Ÿåˆ—éƒ½æ˜¯æ— ç•Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠå†…å­˜æ’‘çˆ†äº†éƒ½ä¸ä¼šè§¦å‘æ‹’ç»ç­–ç•¥ã€‚å½“è‡ªå·±è‡ªå®šä¹‰çº¿ç¨‹æ± å®ä¾‹æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªç­–ç•¥ä¸€å®šè¦å¤„ç†å¥½è§¦å‘ç­–ç•¥æ—¶æŠ›çš„å¼‚å¸¸ï¼Œå› ä¸ºä»–ä¼šæ‰“æ–­å½“å‰çš„æ‰§è¡Œæµç¨‹ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰<code>DiscardPolicy</code>ä¸¢å¼ƒç­–ç•¥ï¼šä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœçº¿ç¨‹é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™åç»­æäº¤çš„ä»»åŠ¡éƒ½ä¼šè¢«ä¸¢å¼ƒï¼Œä¸”é™é»˜ä¸¢å¼ƒã€‚</p>
<ul>
<li>è¯¦è¿°ï¼šä½¿ç”¨æ­¤ç­–ç•¥ï¼Œå¯èƒ½ä½¿æˆ‘ä»¬æ— æ³•å‘ç°ç³»ç»Ÿçš„å¼‚å¸¸çŠ¶æ€ã€‚å»ºè®®æ˜¯ä¸€äº›æ— å…³ç´§è¦çš„ä¸šåŠ¡é‡‡ç”¨æ­¤ç­–ç•¥ã€‚</li>
<li>åŠŸèƒ½ï¼šç›´æ¥é™é™åœ°ä¸¢å¼ƒè¿™ä¸ªä»»åŠ¡ï¼Œä¸è§¦å‘ä»»ä½•åŠ¨ä½œã€‚</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä½ æäº¤çš„ä»»åŠ¡æ— å…³ç´§è¦ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨å®ƒ ã€‚å› ä¸ºå®ƒå°±æ˜¯ä¸ªç©ºå®ç°ï¼Œä¼šæ‚„æ— å£°æ¯çš„åå™¬ä½ çš„çš„ä»»åŠ¡ã€‚æ‰€ä»¥è¿™ä¸ªç­–ç•¥åŸºæœ¬ä¸Šä¸ç”¨äº†ã€‚</li>
</ul>
<p>ï¼ˆ3ï¼‰<code>DiscardOldestPolicy</code>å¼ƒè€ç­–ç•¥ï¼šä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°æäº¤è¢«æ‹’ç»çš„ä»»åŠ¡ã€‚</p>
<ul>
<li>è¯¦è¿°ï¼šå–œæ–°åŒæ—§çš„æ‹’ç»ç­–ç•¥ã€‚æ˜¯å¦é‡‡ç”¨è¿˜æ˜¯å¾—æ ¹æ®å®é™…ä¸šåŠ¡æ˜¯å¦å…è®¸ä¸¢å¼ƒè€ä»»åŠ¡æ¥è®¤çœŸè¡¡é‡ã€‚</li>
<li>åŠŸèƒ½ï¼šå¦‚æœçº¿ç¨‹æ± æœªå…³é—­ï¼Œå°±å¼¹å‡ºé˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ï¼Œç„¶åå°è¯•æ‰§è¡Œã€‚</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šè¿™ä¸ªç­–ç•¥è¿˜æ˜¯ä¼šä¸¢å¼ƒä»»åŠ¡ï¼Œä¸¢å¼ƒæ—¶ä¹Ÿæ˜¯æ¯«æ— å£°æ¯ï¼Œä½†æ˜¯ç‰¹ç‚¹æ˜¯ä¸¢å¼ƒçš„æ˜¯è€çš„æœªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œä¸”æ˜¯å¾…æ‰§è¡Œä¼˜å…ˆçº§è¾ƒé«˜çš„ä»»åŠ¡ã€‚åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œæƒ³åˆ°çš„åœºæ™¯å°±æ˜¯ï¼Œå‘å¸ƒæ¶ˆæ¯å’Œä¿®æ”¹æ¶ˆæ¯ï¼Œå½“æ¶ˆæ¯å‘å¸ƒå‡ºå»åï¼Œè¿˜æœªæ‰§è¡Œï¼Œæ­¤æ—¶æ›´æ–°çš„æ¶ˆæ¯åˆæ¥äº†ï¼Œè¿™ä¸ªæ—¶å€™æœªæ‰§è¡Œçš„æ¶ˆæ¯çš„ç‰ˆæœ¬æ¯”ç°åœ¨æäº¤çš„æ¶ˆæ¯ç‰ˆæœ¬è¦ä½å°±å¯ä»¥è¢«ä¸¢å¼ƒäº†ã€‚å› ä¸ºé˜Ÿåˆ—ä¸­è¿˜æœ‰å¯èƒ½å­˜åœ¨æ¶ˆæ¯ç‰ˆæœ¬æ›´ä½çš„æ¶ˆæ¯ä¼šæ’é˜Ÿæ‰§è¡Œï¼Œæ‰€ä»¥åœ¨çœŸæ­£å¤„ç†æ¶ˆæ¯çš„æ—¶å€™ä¸€å®šè¦åšå¥½æ¶ˆæ¯çš„ç‰ˆæœ¬æ¯”è¾ƒã€‚</li>
</ul>
<p>ï¼ˆ4ï¼‰<code>CallerRunsPolicy</code>è°ƒç”¨è€…è¿è¡Œç­–ç•¥ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†è¯¥ä»»åŠ¡ã€‚</p>
<ul>
<li>åŠŸèƒ½ï¼šå½“è§¦å‘æ‹’ç»ç­–ç•¥æ—¶ï¼Œåªè¦çº¿ç¨‹æ²¡æœ‰å…³é—­ï¼Œå°±ç”±æäº¤ä»»åŠ¡çš„å½“å‰çº¿ç¨‹å¤„ç†ã€‚</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šä¸€èˆ¬åœ¨ä¸å…è®¸å¤±è´¥çš„ã€å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜ã€å¹¶å‘é‡è¾ƒå°çš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œå› ä¸ºçº¿ç¨‹æ± ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå…³é—­ï¼Œä¹Ÿå°±æ˜¯æäº¤çš„ä»»åŠ¡ä¸€å®šä¼šè¢«è¿è¡Œï¼Œä½†æ˜¯ç”±äºæ˜¯è°ƒç”¨è€…çº¿ç¨‹è‡ªå·±æ‰§è¡Œçš„ï¼Œå½“å¤šæ¬¡æäº¤ä»»åŠ¡æ—¶ï¼Œå°±ä¼šé˜»å¡åç»­ä»»åŠ¡æ‰§è¡Œï¼Œæ€§èƒ½å’Œæ•ˆç‡è‡ªç„¶å°±æ…¢äº†ã€‚</li>
</ul>
<blockquote>
<p>å…¶ä»–æ¡†æ¶å®ç°</p>
<ul>
<li>Dubboï¼šåœ¨æŠ›å‡º<code>RejectedExecutionException</code>å¼‚å¸¸ä¹‹å‰ä¼šè®°å½•æ—¥å¿—å’Œdumpçº¿ç¨‹æ ˆä¿¡æ¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜</li>
<li>Nettyï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</li>
<li>ActiveMQï¼šè¶…æ—¶ç­‰å¾…(60s)ï¼Œå°è¯•æ”¾å…¥é˜Ÿåˆ—</li>
<li>PinPointï¼šä½¿ç”¨äº†ä¸€ç§æ‹’ç»ç­–ç•¥é“¾ï¼Œä¼šé€ä¸€å°è¯•ç­–ç•¥é“¾ä¸­æ¯ç§æ‹’ç»ç­–ç•¥</li>
</ul>
</blockquote>
<p>å£è¯€ï¼šæ‹’ç»ˆä¸¢è€è°ƒï¼ˆçº¿ç¨‹æ± æ‹’ç»ç­–ç•¥ï¼šç»ˆæ­¢ç­–ç•¥ã€ä¸¢å¼ƒç­–ç•¥ã€å¼ƒè€ç­–ç•¥ã€è°ƒç”¨è€…è¿è¡Œç­–ç•¥ï¼‰</p>
<p>åœºæ™¯ï¼š</p>
<ul>
<li>ç»ˆæ­¢ç­–ç•¥ï¼šæ— ç‰¹æ®Šåœºæ™¯</li>
<li>ä¸¢å¼ƒç­–ç•¥ï¼šæ— å…³ç´§è¦çš„ä»»åŠ¡</li>
<li>å¼ƒè€ç­–ç•¥ï¼šå‘å¸ƒæ¶ˆæ¯</li>
<li>è°ƒç”¨è€…è¿è¡Œç­–ç•¥ï¼šä¸å…è®¸å¤±è´¥</li>
</ul>
<p>è¿‡ç¨‹ï¼š</p>
<ol>
<li>çº¿ç¨‹æ± ä¸­åˆšå¼€å§‹æ²¡æœ‰çº¿ç¨‹ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</li>
<li>å½“çº¿ç¨‹æ•°è¾¾åˆ°<code>corePoolSize</code>å¹¶æ²¡æœ‰çº¿ç¨‹ç©ºé—²ï¼Œè¿™æ—¶å†åŠ å…¥ä»»åŠ¡ï¼Œæ–°åŠ çš„ä»»åŠ¡ä¼šè¢«åŠ å…¥<code>workQueue</code>é˜Ÿåˆ—ï¼Œç›´åˆ°æœ‰ç©ºé—²çš„çº¿ç¨‹ã€‚</li>
<li>å¦‚æœé˜Ÿåˆ—é€‰æ‹©äº†æœ‰ç•Œé˜Ÿåˆ—ï¼Œé‚£ä¹ˆä»»åŠ¡è¶…è¿‡äº†é˜Ÿåˆ—å¤§å°æ—¶ï¼Œä¼šåˆ›å»º<code>maximumPoolSize</code>-<code>corePoolSize</code>æ•°ç›®çš„çº¿ç¨‹æ¥æ•‘æ€¥ã€‚</li>
<li>å¦‚æœçº¿ç¨‹è¾¾åˆ°<code>maximumPoolSize</code>ä»ç„¶æœ‰æ–°ä»»åŠ¡æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</li>
<li>å½“é«˜å³°è¿‡å»åï¼Œè¶…è¿‡<code>corePoolSize</code>çš„æ•‘æ€¥çº¿ç¨‹å¦‚æœä¸€æ®µæ—¶é—´æ²¡æœ‰ä»»åŠ¡åšï¼Œéœ€è¦ç»“æŸèŠ‚çœèµ„æºï¼Œè¿™ä¸ªæ—¶é—´<code>kepAliveTime</code>å’Œ<code>unit</code>æ¥æ§åˆ¶ã€‚</li>
</ol>
<h3 id="6-2-7-å›ºå®šå¤§å°çº¿ç¨‹æ± "><a href="#6-2-7-å›ºå®šå¤§å°çº¿ç¨‹æ± " class="headerlink" title="6.2.7 å›ºå®šå¤§å°çº¿ç¨‹æ± "></a>6.2.7 å›ºå®šå¤§å°çº¿ç¨‹æ± </h3><p><code>newFixedThreadPool</code></p>
<p>æ„é€ æ–¹æ³•çš„å‚æ•°ï¼š</p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š<code>nThreads</code></li>
<li>çº¿ç¨‹å·¥å‚ï¼š<code>threadFactory</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads, ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                  <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(),</span><br><span class="line">                                  threadFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•° = æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹ï¼Œæ— éœ€è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚</li>
<li>é˜»å¡é˜Ÿåˆ—æ˜¯æ— ç•Œçš„ï¼Œå¯ä»¥æ”¾ä»»æ„æ•°é‡çš„ä»»åŠ¡ã€‚</li>
</ul>
<p>åœºæ™¯ï¼šé€‚ç”¨äºä»»åŠ¡é‡å·²çŸ¥ï¼Œç›¸å¯¹è€—æ—¶çš„ä»»åŠ¡ã€‚</p>
<h3 id="6-2-8-æ— ç•Œé™åˆ¶çº¿ç¨‹æ± "><a href="#6-2-8-æ— ç•Œé™åˆ¶çº¿ç¨‹æ± " class="headerlink" title="6.2.8 æ— ç•Œé™åˆ¶çº¿ç¨‹æ± "></a>6.2.8 æ— ç•Œé™åˆ¶çº¿ç¨‹æ± </h3><p><code>newCachedThreadPool</code></p>
<p>æ„é€ æ–¹æ³•çš„å‚æ•°ï¼š</p>
<ul>
<li>çº¿ç¨‹å·¥å‚ï¼š<code>threadFactory</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                  <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(),</span><br><span class="line">                                  threadFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ˜¯<code>0</code>ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯<code>Integer.MAX_VALUE</code>ï¼Œæ•‘æ€¥çº¿ç¨‹çš„ç©ºé—²ç”Ÿå­˜æ—¶é—´æ˜¯<code>60S</code>ï¼Œæ„å‘³ç€<ul>
<li>å…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼ˆç©ºé—²60Såå¯ä»¥å›æ”¶ï¼‰</li>
<li>æ•‘æ€¥çº¿ç¨‹å¯ä»¥æ— é™åˆ›å»º</li>
</ul>
</li>
<li>ä»»åŠ¡é˜Ÿåˆ—é‡‡ç”¨<code>SyncheonousQueue</code>å®ç°ç‰¹ç‚¹æ˜¯ï¼Œå®ƒæ²¡æœ‰å®¹é‡ï¼Œæ²¡æœ‰çº¿ç¨‹æ¥å–æ˜¯æ”¾ä¸è¿›å»çš„</li>
</ul>
<p>åœºæ™¯ï¼š</p>
<ul>
<li>æ•´ä¸ªçº¿ç¨‹æ± è¡¨ç°ä¸ºçº¿ç¨‹æ•°ä¼šæ ¹æ®ä»»åŠ¡é‡ä¸æ–­å¢é•¿ï¼Œæ²¡æœ‰ä¸Šé™ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç©ºé—²1åˆ†é’Ÿåé‡Šæ”¾çº¿ç¨‹ã€‚</li>
<li>é€‚åˆä»»åŠ¡æ•°æ¯”è¾ƒå¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µã€‚</li>
</ul>
<p><code>SyncheonousQueue</code>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;SynchronousQueue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronousQueueDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        SynchronousQueue&lt;Integer&gt; integers = <span class="keyword">new</span> SynchronousQueue&lt;&gt;();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;putting &#123;&#125;&quot;</span>, <span class="number">1</span>);</span><br><span class="line">                integers.put(<span class="number">1</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125; finish&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                log.debug(<span class="string">&quot;putting &#123;&#125;&quot;</span>, <span class="number">2</span>);</span><br><span class="line">                integers.put(<span class="number">2</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125; finish&quot;</span>, <span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               log.debug(<span class="string">&quot;taking &#123;&#125;&quot;</span>, <span class="number">1</span>);</span><br><span class="line">               integers.take();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;taking &#123;&#125;&quot;</span>, <span class="number">2</span>);</span><br><span class="line">                integers.take();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t3&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-05-01 15:19:10.611 [t1] DEBUG SynchronousQueue - putting 1</span><br><span class="line">2021-05-01 15:19:11.621 [t2] DEBUG SynchronousQueue - taking 1</span><br><span class="line">2021-05-01 15:19:11.621 [t1] DEBUG SynchronousQueue - 1 finish</span><br><span class="line">2021-05-01 15:19:11.621 [t1] DEBUG SynchronousQueue - putting 2</span><br><span class="line">2021-05-01 15:19:12.632 [t3] DEBUG SynchronousQueue - taking 2</span><br><span class="line">2021-05-01 15:19:12.633 [t1] DEBUG SynchronousQueue - 2 finish</span><br></pre></td></tr></table></figure>



<h3 id="6-2-9-å§‹ç»ˆå¦‚ä¸€çº¿ç¨‹æ± "><a href="#6-2-9-å§‹ç»ˆå¦‚ä¸€çº¿ç¨‹æ± " class="headerlink" title="6.2.9 å§‹ç»ˆå¦‚ä¸€çº¿ç¨‹æ± "></a>6.2.9 å§‹ç»ˆå¦‚ä¸€çº¿ç¨‹æ± </h3><p><code>newSingleThreadExecutor</code></p>
<p>æ„é€ æ–¹æ³•çš„å‚æ•°ï¼š</p>
<ul>
<li>çº¿ç¨‹å·¥å‚ï¼š<code>threadFactory</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static ExecutorService newSingleThreadExecutor(ThreadFactory threadFactory) &#123;</span><br><span class="line">    return new FinalizableDelegatedExecutorService</span><br><span class="line">        (new ThreadPoolExecutor(1, 1,</span><br><span class="line">                                0L, TimeUnit.MILLISECONDS,</span><br><span class="line">                                new LinkedBlockingQueue&lt;Runnable&gt;(),</span><br><span class="line">                                threadFactory));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœºæ™¯ï¼šå¸Œæœ›å¤šä¸ªä»»åŠ¡æ’é˜Ÿæ‰§è¡Œã€‚çº¿ç¨‹æ•°å›ºå®šä¸º1ï¼Œä»»åŠ¡æ•°å¤šäº1æ—¶ï¼Œä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿã€‚ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å”¯ä¸€çš„çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚</p>
<p>åŒºåˆ«ï¼š</p>
<ul>
<li>å¯¹æ¯”ï¼šåˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œä»»åŠ¡<ul>
<li>å•çº¿ç¨‹å¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥è€Œç»ˆæ­¢é‚£ä¹ˆæ²¡æœ‰ä»»ä½•è¡¥æ•‘æªæ–½ã€‚</li>
<li><code>newSingleThreadExecutor</code>çº¿ç¨‹æ± è¿˜ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿è¯çº¿ç¨‹æ± çš„æ­£å¸¸å·¥ä½œã€‚</li>
</ul>
</li>
<li>å¯¹æ¯”ï¼š<code>Executors.newFixedThreadPool(1)</code><ul>
<li><code>newFixedThreadPool</code>å¯¹å¤–æš´éœ²çš„æ˜¯<code>ThreadPoolExecutor</code>å¯¹è±¡ï¼Œå¯ä»¥å¼ºè½¬åè°ƒç”¨<code>setCoreSize</code>ç­‰æ–¹æ³•è¿›è¡Œä¿®æ”¹ã€‚</li>
<li><code>FinalizableDelegatedExecutorService</code>åº”ç”¨çš„æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåªå¯¹å¤–æš´éœ²äº†<code>ExecutorService</code>æ¥å£ï¼Œå› æ­¤ä¸èƒ½<code>ThreadPoolExecutor</code>ä¸­ç‰¹æœ‰çš„æ–¹æ³•ã€‚</li>
</ul>
</li>
</ul>
<h3 id="6-2-10-æ‰§è¡Œ-æäº¤ä»»åŠ¡"><a href="#6-2-10-æ‰§è¡Œ-æäº¤ä»»åŠ¡" class="headerlink" title="6.2.10 æ‰§è¡Œ/æäº¤ä»»åŠ¡"></a>6.2.10 æ‰§è¡Œ/æäº¤ä»»åŠ¡</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æäº¤ä»»åŠ¡taskï¼Œç”¨è¿”å›å€¼Futureè·å¾—ä»»åŠ¡æ‰§è¡Œç»“æœ</span></span><br><span class="line">&lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æäº¤tasksä¸­æ‰€æœ‰ä»»åŠ¡</span></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æäº¤taksä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå¸¦è¶…æ—¶æ—¶é—´</span></span><br><span class="line">&lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="keyword">long</span> timeout, TimeUnit unit) <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æäº¤tasksä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶ä»–ä»»åŠ¡å–æ¶ˆ</span></span><br><span class="line">&lt;T&gt; <span class="function">T <span class="title">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æäº¤tasksä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶ä»–ä»»åŠ¡å–æ¶ˆ</span></span><br><span class="line">&lt;T&gt; <span class="function">T <span class="title">invokeAny</span><span class="params">(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, <span class="keyword">long</span> timeout, TimeUnit unit)</span> sthrows InterruptedException, ExecutionException, TimeoutException</span>;</span><br></pre></td></tr></table></figure>



<h3 id="6-2-11-å…³é—­çº¿ç¨‹æ± "><a href="#6-2-11-å…³é—­çº¿ç¨‹æ± " class="headerlink" title="6.2.11 å…³é—­çº¿ç¨‹æ± "></a>6.2.11 å…³é—­çº¿ç¨‹æ± </h3><p><code>shutdown</code></p>
<ul>
<li>å°†çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹ä¸º<code>SHUTDOWN</code></li>
<li>ä¸å†æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šå°†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œ</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        <span class="comment">// ä»…æ‰“æ–­ç©ºé—²çº¿ç¨‹</span></span><br><span class="line">        interruptIdleWorkers();</span><br><span class="line">        onShutdown(); <span class="comment">// hook for ScheduledThreadPoolExecutor</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è¯•ç»ˆç»“</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>shutdownNow</code></p>
<ul>
<li>å°†çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹ä¸º<code>STOP</code></li>
<li>ä¸å†æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šå†æ‰§è¡Œé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</li>
<li>ä¼šå°†é˜»å¡é˜Ÿåˆ—ä¸­æœªæ‰§è¡Œçš„ä»»åŠ¡ä½œä¸ºæ–¹æ³•è¿”å›å€¼</li>
<li>å¹¶ç”¨<code>interrupt</code>çš„æ–¹å¼ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title">shutdownNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        advanceRunState(STOP);</span><br><span class="line">        <span class="comment">// æ‰“æ–­æ‰€æœ‰çº¿ç¨‹</span></span><br><span class="line">        interruptWorkers();</span><br><span class="line">        <span class="comment">// è·å–é˜Ÿåˆ—ä¸­å‰©ä½™ä»»åŠ¡</span></span><br><span class="line">        tasks = drainQueue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è¯•ç»ˆç»“</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä»–æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯éRUNNING</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isShutdown</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯TERMINATED</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTerminated</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨shutdownåï¼Œç”±äºè°ƒç”¨çº¿ç¨‹å¹¶ä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡è¿è¡Œç»“æŸï¼Œå› æ­¤å¦‚æœå®ƒæƒ³åœ¨çº¿ç¨‹æ± TERMINATEDååšäº›äº‹æƒ…ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ–¹æ³•ç­‰å¾…</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">awaitTermination</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="6-3-å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹"><a href="#6-3-å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹" class="headerlink" title="6.3 å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹"></a>6.3 å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹</h2><h3 id="6-3-1-æ¦‚è¿°"><a href="#6-3-1-æ¦‚è¿°" class="headerlink" title="6.3.1 æ¦‚è¿°"></a>6.3.1 æ¦‚è¿°</h3><p><strong>å®šä¹‰</strong>ï¼šè®©æœ‰é™çš„å·¥ä½œçº¿ç¨‹ï¼ˆWorker Threadï¼‰æ¥è½®æµç§»é™¤å¤„ç†æ— é™å¤šçš„ä»»åŠ¡ã€‚ä¹Ÿå¯ä»¥å°†å…¶å½’ç±»ä¸ºåˆ†å·¥æ¨¡å¼ï¼Œå®ƒçš„å…¸å‹å®ç°å°±æ˜¯çº¿ç¨‹æ± ï¼Œä¹Ÿä½“ç°äº†ç»å…¸è®¾è®¡æ¨¡å¼ä¸­çš„äº«å…ƒæ¨¡å¼ã€‚</p>
<p><strong>ä¾‹å¦‚</strong>ï¼šæµ·åº•æçš„æœåŠ¡å‘˜ï¼ˆçº¿ç¨‹ï¼‰ï¼Œè½®æµå¤„ç†æ¯ä½å®¢äººçš„ç‚¹é¤ï¼ˆä»»åŠ¡ï¼‰ï¼Œå¦‚æœä¸ºæ¯ä½å®¢äººéƒ½é…ä¸€åä¸“å±çš„æœåŠ¡å‘˜ï¼Œé‚£ä¹ˆæˆæœ¬å°±å¤ªé«˜äº†ã€‚ï¼ˆå¯¹æ¯”å¦ä¸€ç§å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼ï¼šThread-Per-Messageï¼‰</p>
<p><strong>æ³¨æ„</strong>ï¼šä¸åŒä»»åŠ¡ç±»å‹åº”è¯¥ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼Œè¿™æ ·èƒ½å¤Ÿé¿å…é¥¥é¥¿ï¼Œå¹¶èƒ½æå‡æ•ˆç‡ã€‚</p>
<p><strong>ä¾‹å¦‚</strong>ï¼šå¦‚æœä¸€ä¸ªé¤é¦†çš„å·¥äººæ—¢è¦æ‹›å‘¼å®¢äººï¼ˆä»»åŠ¡ç±»å‹Aï¼‰ï¼Œåˆè¦åˆ°åå¨åšèœï¼ˆä»»åŠ¡ç±»å‹Bï¼‰æ˜¾ç„¶æ•ˆç‡ä¸å’‹åœ°ï¼Œåˆ†æˆæœåŠ¡å‘˜ï¼ˆçº¿ç¨‹æ± Aï¼‰ä¸å¨å¸ˆï¼ˆçº¿ç¨‹æ± Bï¼‰æ›´ä¸ºåˆç†ï¼Œå½“ç„¶è¿˜æœ‰æ›´ç»†çš„åˆ†å·¥ã€‚</p>
<p><strong>é¥¥é¥¿</strong>ï¼šå›ºå®šå¤§å°çº¿ç¨‹æ± ä¼šæœ‰é¥¥é¥¿ç°è±¡</p>
<ul>
<li>ä¸¤ä¸ªå·¥äººæ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„ä¸¤ä¸ªçº¿ç¨‹</li>
<li>ä»–ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šä¸ºå®¢äººç‚¹é¤å’Œåˆ°åå¨åšèœï¼Œè¿™æ˜¯ä¸¤ä¸ªé˜¶æ®µçš„å·¥ä½œ<ul>
<li>å®¢äººç‚¹é¤ï¼šå¿…é¡»å…ˆç‚¹å®Œé¤ï¼Œç­‰èœåšå¥½ï¼Œä¸Šèœï¼Œåœ¨æ­¤æœŸé—´å¤„ç†ç‚¹é¤çš„å·¥äººå¿…é¡»ç­‰å¾…</li>
<li>åå¨åšèœï¼šåšå°±å®Œäº†</li>
</ul>
</li>
<li>å¦‚æœåªæœ‰ä¸€ä¸ªå®¢äººï¼Œå·¥äººAå¤„ç†äº†ç‚¹é¤ä»»åŠ¡ï¼Œæ¥ä¸‹æ¥å®ƒè¦ç­‰ç€å·¥äººBå»æŠŠèœåšå¥½ï¼Œç„¶åä¸Šèœ</li>
<li>å¦‚æœåŒæ—¶æ¥äº†ä¸¤ä¸ªå®¢äººï¼Œè¿™ä¸ªæ—¶å€™å·¥äººAå’Œå·¥äººBéƒ½å»å¤„ç†ç‚¹é¤äº†ï¼Œè¿™æ—¶æ²¡äººåšé¥­äº†ï¼Œé¥¥é¥¿</li>
</ul>
<p><strong>è§£å†³</strong>ï¼š</p>
<p>å¯ä»¥å¢åŠ çº¿ç¨‹æ± çš„å¤§å°ï¼Œä½†æ˜¯ä¸æ˜¯æ ¹æœ¬è§£å†³ä¹‹é“ã€‚ä¸åŒçš„ä»»åŠ¡ç±»å‹ï¼Œåˆ›å»ºä¸åŒçš„çº¿ç¨‹æ± ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;Starvation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StarvationDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èœå•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; MENU = Arrays.asList(<span class="string">&quot;é±¼é¦™è‚‰ä¸&quot;</span>, <span class="string">&quot;å®«ä¿é¸¡ä¸&quot;</span>, <span class="string">&quot;çº¢çƒ§è‚‰&quot;</span>, <span class="string">&quot;çƒ¤é¸¡ç¿…&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Random RANDOM = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éšæœºåšä¸ªèœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">cooking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æœåŠ¡å‘˜</span></span><br><span class="line">        ExecutorService waiterPool = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// å¨å¸ˆ</span></span><br><span class="line">        ExecutorService cookPool =  Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 10ä½å®¢äºº</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            waiterPool.execute(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤&quot;</span>);</span><br><span class="line">                Future&lt;String&gt; future = cookPool.submit(() -&gt; &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> cooking();</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;ä¸Šèœ: &#123;&#125;&quot;</span>, future.get());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-3-2-åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚"><a href="#6-3-2-åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚" class="headerlink" title="6.3.2 åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚"></a>6.3.2 åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚</h3><ul>
<li>è¿‡å°ä¼šå¯¼è‡´ç¨‹åºä¸èƒ½å……åˆ†åœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºã€å®¹æ˜“å¯¼è‡´é¥¥é¥¿</li>
<li>è¿‡å¤§åå¯¼è‡´æ›´å¤šçš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå ç”¨æ›´å¤šå†…å­˜</li>
</ul>
<p><strong>CPUå¯†é›†å‹è¿ç®—</strong></p>
<p>é€šå¸¸é‡‡ç”¨CPUæ ¸æ•° + 1èƒ½å¤Ÿå®ç°æœ€ä¼˜çš„CPUåˆ©ç”¨ç‡ï¼Œ+1æ˜¯ä¿è¯å½“çº¿ç¨‹ç”±äºé¡µç¼ºå¤±æ•…éšœï¼ˆæ“ä½œç³»ç»Ÿï¼‰æˆ–å…¶ä»–åŸå› å¯¼è‡´æš‚åœæ—¶ï¼Œé¢å¤–çš„è¿™ä¸ªçº¿ç¨‹å°±èƒ½é¡¶ä¸Šå»ï¼Œä¿è¯CPUæ—¶é’Ÿå‘¨æœŸä¸è¢«æµªè´¹ã€‚</p>
<p><strong>I/Oå¯†é›†å‹è¿ç®—</strong></p>
<p>CPUä¸æ€»æ˜¯å¤„äºç¹å¿™çŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œå½“ä½ æ‰§è¡Œä¸šåŠ¡è®¡ç®—æ—¶ï¼Œè¿™æ—¶å€™ä¼šä½¿ç”¨CPUèµ„æºï¼Œä½†å½“ä½ æ‰§è¡ŒIOæ“ä½œæ—¶ã€è¿œç¨‹RPCè°ƒç”¨æ—¶ï¼ŒåŒ…æ‹¬è¿›è¡Œæ•°æ®æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™CPUå°±é—²ä¸‹æ¥äº†ï¼Œä½ å¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æé«˜å®ƒçš„åˆ©ç”¨ç‡ã€‚</p>
<p>ç»éªŒå…¬å¼ï¼š<code>çº¿ç¨‹æ•° = æ ¸æ•° * æœŸæœ›CPUåˆ©ç”¨ç‡ * æ€»æ—¶é—´(CPUè®¡ç®—æ—¶é—´ + ç­‰å¾…æ—¶é—´) / CPUè®¡ç®—æ—¶é—´</code></p>
<h3 id="6-3-3-ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± "><a href="#6-3-3-ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± " class="headerlink" title="6.3.3 ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± "></a>6.3.3 ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </h3><p>åœ¨ã€ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ã€åŠŸèƒ½åŠ å…¥ä¹‹å‰ï¼Œå¯ä»¥ä½¿ç”¨<code>java.util.Timer</code>æ¥å®ç°å®šæ—¶åŠŸèƒ½ï¼Œ<code>Timer</code>çš„ä¼˜ç‚¹åœ¨äºç®€å•æ˜“ç”¨ï¼Œä½†ç”±äºæ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è°ƒåº¦ï¼Œå› æ­¤æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡å†æ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡çš„å»¶è¿Ÿæˆ–å¼‚å¸¸éƒ½å°†ä¼šå½±å“åˆ°ä¹‹åçš„ä»»åŠ¡ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;Timer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimerDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Timer timer = <span class="keyword">new</span> Timer();</span><br><span class="line">        TimerTask task1 = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        TimerTask task2 = <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;task2&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">        timer.schedule(task1, <span class="number">1000</span>);</span><br><span class="line">        timer.schedule(task2, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-05-01 22:34:08.514 [main] DEBUG Timer - start...</span><br><span class="line">2021-05-01 22:34:09.528 [Timer-0] DEBUG Timer - task1</span><br><span class="line">2021-05-01 22:34:11.541 [Timer-0] DEBUG Timer - task2</span><br></pre></td></tr></table></figure>

<p>ç”±äºtask1çš„åŸå› å¯¼è‡´task2è¢«å»¶è¿Ÿæ‰§è¡Œã€‚</p>
<p>ä½¿ç”¨<code>ScheduledThreadPool</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;NewScheduledThreadPool&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewScheduledThreadPoolDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ScheduledExecutorService pool = Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">        pool.schedule(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">        &#125;, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        pool.schedule(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task2&quot;</span>);</span><br><span class="line">        &#125;, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-05-01 22:46:23.053 [pool-1-thread-2] DEBUG NewScheduledThreadPool - task2</span><br><span class="line">2021-05-01 22:46:23.053 [pool-1-thread-1] DEBUG NewScheduledThreadPool - task1</span><br></pre></td></tr></table></figure>

<p>task1å‡ºç°å»¶è¿Ÿæˆ–è€…æŠ›å‡ºå¼‚å¸¸éƒ½ä¸ä¼šå½±å“åˆ°task2çš„æ‰§è¡Œã€‚</p>
<p><code>scheduleAtFixedRate</code>ï¼šåˆ›å»ºå¹¶æ‰§è¡Œå‘¨æœŸæ€§æ“ä½œã€‚è¯¥æ“ä½œåœ¨ç»™å®šçš„åˆå§‹å»¶è¿ŸinitialDelayåé¦–å…ˆå¯ç”¨ï¼Œéšååœ¨ç»™å®šçš„å‘¨æœŸperiodå†…å¯ç”¨ã€‚</p>
<p>ä½œç”¨ï¼šç»™ä¸€ä¸ªæ‰§è¡Œçš„å¼€å§‹å’Œä¸‹ä¸€ä¸ªæ‰§è¡Œçš„å¼€å§‹åŠ ä¸Šç»™å®šçš„å»¶è¿Ÿperiodã€‚</p>
<p>å¼‚å¸¸ï¼šå¦‚æœä»»åŠ¡çš„ä»»ä½•æ‰§è¡Œé‡åˆ°å¼‚å¸¸ï¼Œåˆ™ä¼šæŠ‘åˆ¶åç»­æ‰§è¡Œã€‚å¦åˆ™ï¼Œä»»åŠ¡å°†ä»…é€šè¿‡å–æ¶ˆæˆ–ç»ˆæ­¢æ‰§è¡Œç¨‹åºæ¥ç»ˆæ­¢ã€‚å¦‚æœæ­¤ä»»åŠ¡çš„ä»»ä½•æ‰§è¡Œæ—¶é—´è¶…è¿‡å…¶å‘¨æœŸï¼Œåˆ™åç»­æ‰§è¡Œå¯èƒ½ä¼šè¾ƒæ™šå¼€å§‹ï¼Œä½†ä¸ä¼šå¹¶å‘æ‰§è¡Œã€‚ã€ä»»åŠ¡çš„å¼‚å¸¸è¢«catchåˆ™ä¸å½±å“åç»­æ‰§è¡Œã€</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å»¶è¿Ÿä¸€ç§’æ‰§è¡Œï¼Œé—´éš”æ—¶é—´ä¸ºMax&#123;è®¾ç½®é—´éš”æ—¶é—´ï¼Œçº¿ç¨‹æ‰§è¡Œæ—¶é—´&#125;</span></span><br><span class="line">pool.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>

<p><code>scheduleWithFixedDelay</code>ï¼šåˆ›å»ºå¹¶æ‰§è¡Œå‘¨æœŸæ€§æ“ä½œã€‚è¯¥æ“ä½œåœ¨ç»™å®šçš„åˆå§‹å»¶è¿ŸinitialDelayåé¦–å…ˆå¯ç”¨ï¼Œéšååœ¨ç»™å®šçš„å‘¨æœŸperiodå†…å¯ç”¨ã€‚</p>
<p>ä½œç”¨ï¼šç»™ä¸€ä¸ªæ‰§è¡Œçš„ç»ˆæ­¢å’Œä¸‹ä¸€ä¸ªæ‰§è¡Œçš„å¼€å§‹åŠ ä¸Šç»™å®šçš„å»¶è¿Ÿperiodã€‚</p>
<p>å¼‚å¸¸ï¼šå¦‚æœä»»åŠ¡çš„ä»»ä½•æ‰§è¡Œé‡åˆ°å¼‚å¸¸ï¼Œåˆ™ä¼šæŠ‘åˆ¶åç»­æ‰§è¡Œã€‚å¦åˆ™ï¼Œä»»åŠ¡å°†ä»…é€šè¿‡å–æ¶ˆæˆ–ç»ˆæ­¢æ‰§è¡Œç¨‹åºæ¥ç»ˆæ­¢ã€‚ã€ä»»åŠ¡çš„å¼‚å¸¸è¢«catchåˆ™ä¸å½±å“åç»­æ‰§è¡Œã€</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å»¶è¿Ÿä¸€ç§’æ‰§è¡Œï¼Œé—´éš”æ—¶é—´ä¸ºè®¾ç½®æ—¶é—´+çº¿ç¨‹ç¡çœ æ—¶é—´</span></span><br><span class="line">pool.scheduleWithFixedDelay(() -&gt; &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>



<h3 id="6-3-4-æ­£ç¡®å¤„ç†å¼‚å¸¸"><a href="#6-3-4-æ­£ç¡®å¤„ç†å¼‚å¸¸" class="headerlink" title="6.3.4 æ­£ç¡®å¤„ç†å¼‚å¸¸"></a>6.3.4 æ­£ç¡®å¤„ç†å¼‚å¸¸</h3><p>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå¦‚æœä»»åŠ¡æŠ›å‡ºäº†å¼‚å¸¸ï¼Œé»˜è®¤æ˜¯ä¸­æ–­è¯¥ä»»åŠ¡è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸æˆ–è€…æ‰“å°å¼‚å¸¸ä¿¡æ¯ã€‚</p>
<ul>
<li>ä¸»åŠ¨æ•è·å¼‚å¸¸</li>
<li>ä½¿ç”¨Future</li>
</ul>
<h3 id="6-3-5-å®ç°å®šæ—¶ä»»åŠ¡"><a href="#6-3-5-å®ç°å®šæ—¶ä»»åŠ¡" class="headerlink" title="6.3.5 å®ç°å®šæ—¶ä»»åŠ¡"></a>6.3.5 å®ç°å®šæ—¶ä»»åŠ¡</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;Schedule&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ScheduledExecutorService pool = Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ¯å‘¨å…­15ï¼š16ï¼š00æ‰“å°KHighness</span></span><br><span class="line">        solution(DayOfWeek.SUNDAY, <span class="number">15</span>, <span class="number">16</span>, <span class="number">00</span>, () -&gt; &#123; log.debug(<span class="string">&quot;KHighness&quot;</span>); &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŒ‡å®šæ—¶é—´æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> day     å‘¨å‡ </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hour    å‡ æ—¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> minute  å‡ åˆ†</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> second  å‡ ç§’</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task    ä»»åŠ¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">solution</span><span class="params">(DayOfWeek day, <span class="keyword">int</span> hour, <span class="keyword">int</span> minute, <span class="keyword">int</span> second, Runnable task)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å½“å‰æ—¶é—´</span></span><br><span class="line">        LocalDateTime now = LocalDateTime.now();</span><br><span class="line">        <span class="comment">// ç›®æ ‡æ—¶é—´</span></span><br><span class="line">        LocalDateTime tar = now.withHour(hour).withMinute(minute).withSecond(second).with(day);</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰æ—¶é—´ &gt; ç›®æ ‡æ—¶é—´ï¼Œåˆ™ä¸ºä¸‹å‘¨</span></span><br><span class="line">        <span class="keyword">if</span> (now.compareTo(tar) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            tar.plusWeeks(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é—´éš”æ—¶é—´</span></span><br><span class="line">        <span class="keyword">long</span> initialDelay = Duration.between(now, tar).toMillis();</span><br><span class="line">        <span class="comment">// å¾ªç¯å‘¨æœŸ</span></span><br><span class="line">        <span class="keyword">long</span> period = <span class="number">7</span> * <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">        pool.scheduleAtFixedRate(task, initialDelay, period, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-4-Tomcatçº¿ç¨‹æ± "><a href="#6-4-Tomcatçº¿ç¨‹æ± " class="headerlink" title="6.4 Tomcatçº¿ç¨‹æ± "></a>6.4 Tomcatçº¿ç¨‹æ± </h2><h3 id="6-4-1-æ€»ä½“ç»“æ„"><a href="#6-4-1-æ€»ä½“ç»“æ„" class="headerlink" title="6.4.1 æ€»ä½“ç»“æ„"></a>6.4.1 æ€»ä½“ç»“æ„</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62082/image-20210502151900797.png" class="" title="image-20210502151900797"><br />

<ul>
<li>LimitLatchç”¨æ¥é™æµï¼Œå¯ä»¥æ§åˆ¶æœ€å¤§è¿æ¥ä¸ªæ•°ï¼Œç±»ä¼¼JUCä¸­çš„Semaphore</li>
<li>Acceptoråªè´Ÿè´£æ¥æ”¶æ–°çš„socketè¿æ¥</li>
<li>Polleråªè´Ÿè´£ç›‘å¬socket channelæ˜¯å¦æœ‰æ–°çš„å¯è¯»çš„I/Oäº‹ä»¶</li>
<li>ä¸€æ—¦å¯è¯»ï¼Œå°è£…ä¸€ä¸ªä»»åŠ¡å¯¹è±¡socketProcessorï¼Œæäº¤ç»™Executorçº¿ç¨‹æ± å¤„ç†</li>
<li>Executorçº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æœ€ç»ˆè´Ÿè´£å¤„ç†è¯·æ±‚</li>
</ul>
<h3 id="6-4-2-ä¸åŒä¹‹å¤„"><a href="#6-4-2-ä¸åŒä¹‹å¤„" class="headerlink" title="6.4.2 ä¸åŒä¹‹å¤„"></a>6.4.2 ä¸åŒä¹‹å¤„</h3><p>Tomcatçº¿ç¨‹æ± æ‰©å±•äº†ThreadPoolExecutorï¼Œè¡Œä¸ºç¨æœ‰ä¸åŒ</p>
<ul>
<li>å¦‚æœæ€»çº¿ç¨‹æ•°è¾¾åˆ°<code>maximumPoolSize</code><ul>
<li>è¿™æ—¶ä¸ä¼šç«‹åˆ»æŠ›<code>RejectedExecutionException</code></li>
<li>è€Œæ˜¯å°è¯•å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œå¦‚æœè¿˜å¤±è´¥ï¼Œæ‰æŠ›å‡º<code>RejectedExecutionException</code></li>
</ul>
</li>
</ul>
<p><code>tomcat-7.0.42</code>æºç  ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command, <span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">    submittedCount.incrementAndGet();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.execute(command);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException rx) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">super</span>.getQueue() <span class="keyword">instanceof</span> TaskQueue) &#123;</span><br><span class="line">            <span class="keyword">final</span> TaskQueue queue = (TaskQueue)<span class="keyword">super</span>.getQueue();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å°è¯•å°†ä»»åŠ¡é‡æ–°åŠ å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">                <span class="keyword">if</span> (!queue.force(command, timeout, unit)) &#123;</span><br><span class="line">                    submittedCount.decrementAndGet();</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">&quot;Queue capacity is full.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException x) &#123;</span><br><span class="line">                <span class="comment">// ä¾ç„¶å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                submittedCount.decrementAndGet();</span><br><span class="line">                Thread.interrupted();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(x);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            submittedCount.decrementAndGet();</span><br><span class="line">            <span class="keyword">throw</span> rx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">force</span><span class="params">(Runnable o, <span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( parent.isShutdown() )</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(</span><br><span class="line">                <span class="string">&quot;Executor not running, can&#x27;t force a command into the queue&quot;</span></span><br><span class="line">        );</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.offer(o,timeout,unit); <span class="comment">//forces the item onto the queue, to be used if the task is rejected</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-4-3-å¯é…ç½®é¡¹"><a href="#6-4-3-å¯é…ç½®é¡¹" class="headerlink" title="6.4.3 å¯é…ç½®é¡¹"></a>6.4.3 å¯é…ç½®é¡¹</h3><p>Connectoré…ç½®</p>
<table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>é»˜è®¤å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>acceptorThreadCount</td>
<td>1</td>
<td>accterçº¿ç¨‹æ•°é‡</td>
</tr>
<tr>
<td>pollerThreadCount</td>
<td>1</td>
<td>pollerçº¿ç¨‹æ•°é‡</td>
</tr>
<tr>
<td>minSpareThreads</td>
<td>10</td>
<td>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³corePoolSize</td>
</tr>
<tr>
<td>maxThreads</td>
<td>200</td>
<td>æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³maximumPoolSize</td>
</tr>
<tr>
<td>executor</td>
<td>-</td>
<td>Executoråç§°ï¼Œç”¨æ¥å¼•ç”¨ä¸‹é¢çš„Executor</td>
</tr>
</tbody></table>
<p>Executoré…ç½®</p>
<table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>é»˜è®¤å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>threadPriority</td>
<td>5</td>
<td>çº¿ç¨‹ä¼˜å…ˆçº§</td>
</tr>
<tr>
<td>daemon</td>
<td>true</td>
<td>æ˜¯å¦å®ˆæŠ¤çº¿ç¨‹</td>
</tr>
<tr>
<td>minSpareThreads</td>
<td>25</td>
<td>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³corePoolSize</td>
</tr>
<tr>
<td>maxThreads</td>
<td>200</td>
<td>æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³maximumPoolSize</td>
</tr>
<tr>
<td>maxIdleTime</td>
<td>60000</td>
<td>çº¿ç¨‹ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œé»˜è®¤å€¼å³1åˆ†é’Ÿ</td>
</tr>
<tr>
<td>maxQueueSize</td>
<td>Integer.MAX_VALUE</td>
<td>é˜Ÿåˆ—é•¿åº¦</td>
</tr>
<tr>
<td>prestartminSpareThreads</td>
<td>false</td>
<td>æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å¯åŠ¨</td>
</tr>
</tbody></table>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62082/image-20210502155938527.png" class="" title="image-20210502155938527"><br />



<h2 id="6-5-Fork-Join"><a href="#6-5-Fork-Join" class="headerlink" title="6.5 Fork/Join"></a>6.5 Fork/Join</h2><h3 id="6-5-1-æ¦‚è¿°"><a href="#6-5-1-æ¦‚è¿°" class="headerlink" title="6.5.1 æ¦‚è¿°"></a>6.5.1 æ¦‚è¿°</h3><p>Fork/Joinæ˜¯JDK1.7åŠ å…¥çš„æ–°çš„çº¿ç¨‹æ± å®ç°ï¼Œå®ƒä½“ç°çš„æ˜¯ä¸€ç§åˆ†æ²»æ€æƒ³ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„CPUå¯†é›†å‹è¿ç®—ã€‚</p>
<p>æ‰€è°“çš„ä»»åŠ¡æ‹†åˆ†ï¼Œæ˜¯å°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†æˆç®—æ³•ä¸Šç›¸åŒçš„å°äººç‰©ï¼Œç›´è‡³ä¸èƒ½æ‹†åˆ†æˆå¯ä»¥ç›´æ¥æ±‚è§£ã€‚è·Ÿé€’å½’ç›¸å…³çš„ä¸€äº›è®¡ç®—ï¼Œå¦‚å½’å¹¶æ’åºã€æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œéƒ½å¯ä»¥ç”¨åˆ†æ²»æ€æƒ³è¿›è¡Œæ±‚è§£ã€‚</p>
<p>Fork/Joinåœ¨åˆ†æ²»çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å¤šçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæ¯ä¸ªä»»åŠ¡çš„åˆ†è§£å’Œåˆå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥å®Œæˆï¼Œè¿›ä¸€æ­¥æå‡äº†è¿ç®—æ•ˆç‡ã€‚</p>
<p>Fork/Joiné»˜è®¤ä¼šåˆ›å»ºä¸CPUæ ¸å¿ƒæ•°å¤§å°ç›¸åŒçš„çº¿ç¨‹æ± ã€‚</p>
<h3 id="6-5-2-ä½¿ç”¨"><a href="#6-5-2-ä½¿ç”¨" class="headerlink" title="6.5.2 ä½¿ç”¨"></a>6.5.2 ä½¿ç”¨</h3><p>æäº¤ç»™Fork/Joinçº¿ç¨‹æ± çš„ä»»åŠ¡éœ€è¦ç»§æ‰¿<code>RecursiveTask</code>ï¼ˆæœ‰è¿”å›å€¼ï¼‰æˆ–<code>RecuisiveAction</code>ï¼ˆæ²¡æœ‰è¿”å›å€¼ï¼‰ï¼Œä¾‹å¦‚ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå¯¹1~nä¹‹é—´çš„æ•´æ•°æ±‚å’Œçš„ä»»åŠ¡ã€‚</p>
<p>å¦‚ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå¯¹1~nä¹‹é—´çš„æ•´æ•°æ±‚å’Œçš„ä»»åŠ¡</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ForkJoin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ForkJoinPool pool = <span class="keyword">new</span> ForkJoinPool(<span class="number">4</span>);</span><br><span class="line">        System.out.println(pool.invoke(<span class="keyword">new</span> Task(<span class="number">5</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Task&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Task</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.n = n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ã€&quot;</span> + n +  <span class="string">&quot;ã€&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Integer <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        Task tas = <span class="keyword">new</span> Task(n - <span class="number">1</span>);</span><br><span class="line">        tas.fork();</span><br><span class="line">        log.debug(<span class="string">&quot;fork: &#123;&#125; &#123;&#125;&quot;</span>, n, tas);</span><br><span class="line">        <span class="keyword">int</span> res = n + tas.join();</span><br><span class="line">        log.debug(<span class="string">&quot;join: &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, n, tas, res);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-05-02 17:04:41.631 [ForkJoinPool-1-worker-2] DEBUG Task - fork: 4 ã€3ã€</span><br><span class="line">2021-05-02 17:04:41.631 [ForkJoinPool-1-worker-1] DEBUG Task - fork: 5 ã€4ã€</span><br><span class="line">2021-05-02 17:04:41.631 [ForkJoinPool-1-worker-0] DEBUG Task - fork: 2 ã€1ã€</span><br><span class="line">2021-05-02 17:04:41.631 [ForkJoinPool-1-worker-3] DEBUG Task - fork: 3 ã€2ã€</span><br><span class="line">2021-05-02 17:04:41.634 [ForkJoinPool-1-worker-0] DEBUG Task - join: 2 + ã€1ã€ &#x3D; 3</span><br><span class="line">2021-05-02 17:04:41.634 [ForkJoinPool-1-worker-3] DEBUG Task - join: 3 + ã€2ã€ &#x3D; 6</span><br><span class="line">2021-05-02 17:04:41.634 [ForkJoinPool-1-worker-2] DEBUG Task - join: 4 + ã€3ã€ &#x3D; 10</span><br><span class="line">2021-05-02 17:04:41.634 [ForkJoinPool-1-worker-1] DEBUG Task - join: 5 + ã€4ã€ &#x3D; 15</span><br><span class="line">15</span><br></pre></td></tr></table></figure>

<p>æµç¨‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62082/image-20210502171007613.png" class="" title="image-20210502171007613"><br />

<p>æ”¹è¿›ï¼šä»»åŠ¡æ‹†åˆ†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;AddTask&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddTask</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> begin;</span><br><span class="line">    <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AddTask</span><span class="params">(<span class="keyword">int</span> begin, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.begin = begin;</span><br><span class="line">        <span class="keyword">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ã€&quot;</span> + begin + <span class="string">&quot;, &quot;</span> + end + <span class="string">&quot;ã€&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Integer <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (begin == end) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;join: &#123;&#125;&quot;</span>, begin);</span><br><span class="line">            <span class="keyword">return</span> begin;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (end - begin == <span class="number">1</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;join: &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, begin, end, begin + end);</span><br><span class="line">            <span class="keyword">return</span> begin + end;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> mid = begin + (end - begin &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        AddTask task1 = <span class="keyword">new</span> AddTask(begin, mid);</span><br><span class="line">        task1.fork();</span><br><span class="line">        AddTask task2 = <span class="keyword">new</span> AddTask(mid + <span class="number">1</span>, end);</span><br><span class="line">        task2.fork();</span><br><span class="line">        log.debug(<span class="string">&quot;fork: &#123;&#125; + &#123;&#125; = ?&quot;</span>, task1, task2);</span><br><span class="line">        <span class="keyword">int</span> res = task1.join() + task2.join();</span><br><span class="line">        log.debug(<span class="string">&quot;join: &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, task1, task2, res);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµç¨‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-05-02 17:39:00.721 [ForkJoinPool-1-worker-0] DEBUG AddTask - join: 1 + 2 &#x3D; 3</span><br><span class="line">2021-05-02 17:39:00.721 [ForkJoinPool-1-worker-2] DEBUG AddTask - fork: ã€1, 2ã€ + ã€3, 3ã€ &#x3D; ?</span><br><span class="line">2021-05-02 17:39:00.721 [ForkJoinPool-1-worker-3] DEBUG AddTask - join: 4 + 5 &#x3D; 9</span><br><span class="line">2021-05-02 17:39:00.721 [ForkJoinPool-1-worker-1] DEBUG AddTask - fork: ã€1, 3ã€ + ã€4, 5ã€ &#x3D; ?</span><br><span class="line">2021-05-02 17:39:00.724 [ForkJoinPool-1-worker-0] DEBUG AddTask - join: 3</span><br><span class="line">2021-05-02 17:39:00.724 [ForkJoinPool-1-worker-2] DEBUG AddTask - join: ã€1, 2ã€ + ã€3, 3ã€ &#x3D; 6</span><br><span class="line">2021-05-02 17:39:00.724 [ForkJoinPool-1-worker-1] DEBUG AddTask - join: ã€1, 3ã€ + ã€4, 5ã€ &#x3D; 15</span><br><span class="line">15</span><br></pre></td></tr></table></figure>

<p>æµç¨‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62082/image-20210502174452155.png" class="" title="image-20210502174452155"><br />

]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-8(å¹¶å‘å·¥å…·ä¹‹åŒæ­¥å™¨)</title>
    <url>/posts/23706/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="8-1-CountDownLatch"><a href="#8-1-CountDownLatch" class="headerlink" title="8.1 CountDownLatch"></a>8.1 CountDownLatch</h2><p><code>CountDownLatch</code>è®¡æ•°å™¨</p>
<p>ç‰¹ç‚¹ï¼šå†…éƒ¨è®¡æ•°å™¨é€’å‡ã€‚</p>
<p>åŠŸèƒ½ï¼šä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•è¿›è¡Œæ±‡æ€»ã€‚</p>
<h3 id="8-1-1-æ¡ˆä¾‹"><a href="#8-1-1-æ¡ˆä¾‹" class="headerlink" title="8.1.1 æ¡ˆä¾‹"></a>8.1.1 æ¡ˆä¾‹</h3><p>ä»»åŠ¡åˆ†è§£ï¼Œç¬¬ä¸‰ä¸ªä»»åŠ¡éœ€è¦ç­‰å¾…ç¬¬ä¸€ä¸ªä»»åŠ¡å’Œç¬¬äºŒä¸ªä»»åŠ¡æ‰§è¡Œè®¡ç®—åè¿›è¡Œæ±‡æ€»ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;CountDownLatch&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> total = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">int</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            unit.sleep(timeout);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;state = &#123;&#125;&quot;</span>, countDownLatch.getCount());</span><br><span class="line">            total += <span class="number">1</span>;</span><br><span class="line">            sleep(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; run over&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">            log.debug(<span class="string">&quot;state = &#123;&#125;&quot;</span>, countDownLatch.getCount());</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;state = &#123;&#125;&quot;</span>, countDownLatch.getCount());</span><br><span class="line">            total += <span class="number">2</span>;</span><br><span class="line">            sleep(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; run over&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">            log.debug(<span class="string">&quot;state = &#123;&#125;&quot;</span>, countDownLatch.getCount());</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;state = &#123;&#125;&quot;</span>, countDownLatch.getCount());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                countDownLatch.await();</span><br><span class="line">                log.debug(<span class="string">&quot;result: total = &#123;&#125;&quot;</span>, total);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;&#123;&#125; run over&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">        sleep(<span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        executorService.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">58.374</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">1</span>] DEBUG CountDownLatch - state = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">58.374</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">2</span>] DEBUG CountDownLatch - state = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">58.374</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">3</span>] DEBUG CountDownLatch - state = <span class="number">2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">59.379</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">2</span>] DEBUG CountDownLatch - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-2</span> run over</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">59.379</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">1</span>] DEBUG CountDownLatch - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-1</span> run over</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">59.380</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">2</span>] DEBUG CountDownLatch - state = <span class="number">1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">59.380</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">1</span>] DEBUG CountDownLatch - state = <span class="number">0</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">59.380</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">3</span>] DEBUG CountDownLatch - result: total = <span class="number">3</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">59.380</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">3</span>] DEBUG CountDownLatch - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-3</span> run over</span><br></pre></td></tr></table></figure>



<h3 id="8-1-2-åŸç†"><a href="#8-1-2-åŸç†" class="headerlink" title="8.1.2 åŸç†"></a>8.1.2 åŸç†</h3><p>ç±»å›¾</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/23706/image-20210508154726370.png" class="" title="image-20210508154726370"><br />



<p>ï¼ˆ1ï¼‰æ„é€ æ–¹æ³•</p>
<p>å…¥å‚ï¼š<code>count</code>ï¼Œä¼šå°†è®¡æ•°å™¨å€¼<code>count</code>èµ‹ç»™äº†AQSçš„çŠ¶æ€å˜é‡<code>state</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CountDownLatch</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CountDownLatch</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;count &lt; 0&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.sync = <span class="keyword">new</span> Sync(count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sync</span></span><br><span class="line">Sync(<span class="keyword">int</span> count) &#123;</span><br><span class="line">    setState(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰<code>void await()</code>æ–¹æ³•</p>
<p>å½“çº¿ç¨‹è°ƒç”¨<code>CountDownLatch</code>çš„<code>await</code>æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹å°±ä¼šé˜»å¡ï¼Œç›´åˆ°ï¼š</p>
<ul>
<li>æ‰€æœ‰çº¿ç¨‹éƒ½è°ƒç”¨äº†<code>CountDownLatch</code>å¯¹è±¡çš„<code>countDown</code>æ–¹æ³•åï¼Œå³è®¡æ•°å™¨å€¼ä¸º0æ—¶</li>
<li>å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•ä¸­æ–­äº†å½“å‰çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹æŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CountDownLatch</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AQS</span></span><br><span class="line"><span class="comment">// è·å–å…±äº«èµ„æºæ—¶å¯è¢«ä¸­æ–­</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­å³æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">// æŸ¥çœ‹å½“å‰è®¡æ•°å™¨å€¼æ˜¯å¦ä¸º0ï¼Œä¸º0åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™è¿›å…¥AQSçš„é˜Ÿåˆ—ç­‰å¾…</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sync</span></span><br><span class="line"><span class="comment">// å®ç°çš„AQSæ¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (getState() == <span class="number">0</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰<code>boolean await(long timeout, TimeUnit unit)</code>æ–¹æ³•</p>
<p>å½“çº¿ç¨‹è°ƒç”¨äº†<code>CountDownLatch</code>çš„è¯¥æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°ï¼š</p>
<ul>
<li>æ‰€æœ‰çº¿ç¨‹éƒ½è°ƒç”¨äº†<code>CountDownLatch</code>å¯¹è±¡çš„<code>countDown</code>æ–¹æ³•åï¼Œå³è®¡æ•°å™¨å€¼ä¸º0æ—¶</li>
<li>è®¾ç½®çš„<code>timeout</code>æ—¶é—´åˆ°äº†ï¼Œå› ä¸ºè¶…æ—¶è¿”å›<code>false</code></li>
<li>å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•ä¸­æ–­äº†å½“å‰çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹æŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CountDownLatch</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.tryAcquireSharedNanos(<span class="number">1</span>, unit.toNanos(timeout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ4ï¼‰<code>void countDown()</code>æ–¹æ³•</p>
<p>çº¿ç¨‹è°ƒç”¨è¯¥æ–¹æ³•åï¼Œè®¡æ•°å™¨çš„å€¼é€’å‡ï¼Œé€’å‡åå¦‚æœè®¡æ•°å™¨çš„å€¼ä¸º0åˆ™å”¤é†’æ‰€æœ‰å› è°ƒç”¨awaitæ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚</p>
<p>å¦‚æœstateåŸå§‹å€¼ä¸ºnï¼Œæœ‰(n+1)ä¸ªçº¿ç¨‹è°ƒç”¨äº†<code>countDown</code>æ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬(n+1)ä¸ªçº¿ç¨‹è°ƒç”¨æ— æ•ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CountDownLatch</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AQS</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨Syncçš„å®ç°ï¼ŒæˆåŠŸåˆ™å”¤é†’é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        <span class="comment">// AQSé‡Šæ”¾èµ„æº</span></span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sync</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¾ªç¯CASä½¿è®¡æ•°å™¨ï¼ˆçŠ¶æ€å€¼stateï¼‰å‡1å¹¶æ›´æ–°ï¼Œç›´åˆ°æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="comment">// é˜²æ­¢stateå˜æˆè´Ÿæ•°</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">int</span> nextc = c-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ5ï¼‰<code>long getCount()</code>æ–¹æ³•</p>
<p>è·å–å½“å‰è®¡æ•°å™¨çš„å€¼ï¼Œå³AQSçš„<code>state</code>å€¼ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CountDownLatch</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.getCount();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AQS</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-1-3-å°ç»“"><a href="#8-1-3-å°ç»“" class="headerlink" title="8.1.3 å°ç»“"></a>8.1.3 å°ç»“</h3><p><code>CountDownLatch</code>ç›¸æ¯”äºä½¿ç”¨çº¿ç¨‹çš„<code>join</code>æ–¹æ³•æ¥å®ç°çº¿ç¨‹é—´åŒæ­¥ï¼Œå‰è€…æ›´å…·æœ‰çµæ´»æ€§å’Œæ–¹ä¾¿æ€§ï¼Œå› ä¸ºåœ¨<code>ExecutorService</code>çº¿ç¨‹æ± ä¸­æ— æ³•ç›´æ¥è°ƒç”¨å…¶ä»–çº¿ç¨‹çš„<code>join</code>æ–¹æ³•ã€‚</p>
<p><code>CountDownLatch</code>ä½¿ç”¨AQSçš„çŠ¶æ€å˜é‡<code>state</code>æ¥å­˜æ”¾è®¡æ•°å™¨çš„å€¼ã€‚é¦–å…ˆåœ¨åˆå§‹åŒ–è®¾ç½®è®¡æ•°å™¨å€¼ï¼ˆAQSçŠ¶æ€å€¼ï¼‰ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨<code>countDown</code>æ–¹æ³•å®é™…æ˜¯åŸå­æ€§é€’å‡AQSçš„çŠ¶æ€å€¼ã€‚å½“çº¿ç¨‹è°ƒç”¨<code>await</code>æ–¹æ³•åå½“å‰çº¿ç¨‹ä¼šè¢«æ”¾å…¥AQSçš„é˜»å¡é˜Ÿåˆ—ç­‰å¾…ï¼Œå¾…è®¡æ•°å™¨ä¸º0å†è¿”å›ã€‚å…¶ä»–çº¿ç¨‹è°ƒç”¨<code>countDown</code>æ–¹æ³•è®©è®¡æ•°å™¨å€¼é€’å‡1ï¼Œå½“è®¡æ•°å™¨å€¼å˜æˆ0æ—¶ï¼Œå½“å‰çº¿ç¨‹è¿˜è¦è°ƒç”¨AQSçš„<code>doReleaseSShared</code>æ–¹æ³•æ¥æ¿€æ´»ç”±äºè°ƒç”¨<code>await</code>æ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹ã€‚</p>
<h2 id="8-2-CyclicBarrier"><a href="#8-2-CyclicBarrier" class="headerlink" title="8.2 CyclicBarrier"></a>8.2 CyclicBarrier</h2><p><code>CyclicBarrier</code>å›ç¯<a href="%E5%9B%9E%E7%8E%AF%E6%98%AF%E5%9B%A0%E4%B8%BA%E5%BD%93%E6%89%80%E6%9C%89%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95%EF%BC%8C%E5%B9%B6%E9%87%8D%E7%BD%AE%60CylicBarrier%60%E7%9A%84%E7%8A%B6%E6%80%81%E4%BB%A5%E4%BE%BF%E9%87%8D%E7%94%A8%E3%80%82">^1</a>å±éšœ<a href="%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%60await%60%E6%96%B9%E6%B3%95%E5%90%8E%E5%B0%B1%E4%BC%9A%E8%A2%AB%E9%98%BB%E5%A1%9E%EF%BC%8C%E8%BF%99%E4%B8%AA%E9%98%BB%E5%A1%9E%E7%82%B9%E5%B0%B1%E7%A7%B0%E4%B8%BA%E5%B1%8F%E9%9A%9C%E7%82%B9%EF%BC%8C%E7%AD%89%E6%89%80%E6%9C%89%E7%BA%BF%E7%A8%8B%E9%83%BD%E8%B0%83%E7%94%A8%E4%BA%86%60await%60%E6%96%B9%E6%B3%95%E5%90%8E%EF%BC%8C%E7%BA%BF%E7%A8%8B%E4%BB%AC%E5%B0%B1%E4%BC%9A%E5%86%B2%E7%A0%B4%E5%B1%8F%E9%9A%9C%EF%BC%8C%E7%BB%A7%E7%BB%AD%E5%90%91%E4%B8%8B%E8%BF%90%E8%A1%8C%E3%80%82">^2</a></p>
<p>ç‰¹ç‚¹ï¼šå†…éƒ¨è®¡æ•°å™¨é€’å‡ã€‚</p>
<p>åŠŸèƒ½ï¼šè®©ä¸€ç»„çº¿ç¨‹å…¨éƒ¨è¾¾åˆ°ä¸€ä¸ªçŠ¶æ€åå†å…¨éƒ¨åŒæ—¶æ‰§è¡Œã€‚</p>
<p>[^ 1]ï¼š å›ç¯æ˜¯å› ä¸ºå½“æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶é‡ç½®<code>CylicBarrier</code>çš„çŠ¶æ€ä»¥ä¾¿é‡ç”¨ã€‚</p>
<p>[^ 2]ï¼šçº¿ç¨‹è°ƒç”¨<code>await</code>æ–¹æ³•åå°±ä¼šè¢«é˜»å¡ï¼Œè¿™ä¸ªé˜»å¡ç‚¹å°±ç§°ä¸ºå±éšœç‚¹ï¼Œç­‰æ‰€æœ‰çº¿ç¨‹éƒ½è°ƒç”¨äº†<code>await</code>æ–¹æ³•åï¼Œçº¿ç¨‹ä»¬å°±ä¼šå†²ç ´å±éšœï¼Œç»§ç»­å‘ä¸‹è¿è¡Œã€‚</p>
<h3 id="8-2-1-æ¡ˆä¾‹"><a href="#8-2-1-æ¡ˆä¾‹" class="headerlink" title="8.2.1 æ¡ˆä¾‹"></a>8.2.1 æ¡ˆä¾‹</h3><p>ä¸€ä¸ªä»»åŠ¡éœ€è¦ä¸‰æ­¥å®Œæˆï¼Œéœ€è¦æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;CyclicBarrier&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CyclicBarrier cyclicBarrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">3</span>, () -&gt; &#123;log.debug(<span class="string">&quot;==========================&quot;</span>);&#125;);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">int</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            unit.sleep(timeout);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;&#123;&#125; first step&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">                    sleep(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">                    cyclicBarrier.await();</span><br><span class="line">                    log.debug(<span class="string">&quot;&#123;&#125; second step&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">                    sleep(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">                    cyclicBarrier.await();</span><br><span class="line">                    log.debug(<span class="string">&quot;&#123;&#125; third step&quot;</span>, Thread.currentThread().getName());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">58.549</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">2</span>] DEBUG CyclicBarrier - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-2</span> first step</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">58.549</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">1</span>] DEBUG CyclicBarrier - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-1</span> first step</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">58.549</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">3</span>] DEBUG CyclicBarrier - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-3</span> first step</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">59.558</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">2</span>] DEBUG CyclicBarrier - ==========================</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">59.559</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">2</span>] DEBUG CyclicBarrier - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-2</span> second step</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">59.559</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">3</span>] DEBUG CyclicBarrier - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-3</span> second step</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">28</span>:<span class="number">59.559</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">1</span>] DEBUG CyclicBarrier - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-1</span> second step</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">00.570</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">2</span>] DEBUG CyclicBarrier - ==========================</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">00.570</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">2</span>] DEBUG CyclicBarrier - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-2</span> third step</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">00.570</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">1</span>] DEBUG CyclicBarrier - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-1</span> third step</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-08</span> <span class="number">16</span>:<span class="number">29</span>:<span class="number">00.570</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">3</span>] DEBUG CyclicBarrier - pool<span class="literal">-1</span><span class="literal">-thread</span><span class="literal">-3</span> third step</span><br></pre></td></tr></table></figure>



<h3 id="8-2-2-åŸç†"><a href="#8-2-2-åŸç†" class="headerlink" title="8.2.2 åŸç†"></a>8.2.2 åŸç†</h3><p>ç±»å›¾</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/23706/image-20210508154851790.png" class="" title="image-20210508154851790"><br />

<p><code>CyclicBarrier</code>åŸºäºç‹¬å é”å®ç°ï¼Œæœ¬è´¨åº•å±‚è¿˜æ˜¯åŸºäºAQSçš„ã€‚</p>
<p>å±æ€§ï¼š</p>
<ul>
<li><p><code>lock</code>ï¼šç‹¬å é”ã€‚</p>
</li>
<li><p><code>trip</code>ï¼šæ¡ä»¶å˜é‡ã€‚</p>
</li>
<li><p><code>barrierCommand</code>ï¼šåˆ°è¾¾å±éšœç‚¹æ‰§è¡Œçš„ä»»åŠ¡ã€‚</p>
</li>
<li><p><code>parties</code>ï¼šçº¿ç¨‹è®¡æ•°å™¨ï¼Œè¿™é‡Œè¡¨ç¤ºå¤šå°‘çº¿ç¨‹è°ƒç”¨<code>await</code>åï¼Œæ‰€æœ‰çº¿ç¨‹æ‰ä¼šå†²ç ´å±éšœç»§ç»­å‘ä¸‹å…è®¸ã€‚</p>
</li>
<li><p><code>count</code>ï¼šæ‰§è¡Œè®°å½•å™¨ï¼Œä¸€å¼€å§‹ç­‰äº<code>parties</code>ï¼Œæ¯å½“æœ‰çº¿ç¨‹è°ƒç”¨<code>await</code>å°±é€’å‡1ï¼Œå½“<code>count</code>ä¸º0æ—¶å°±è¡¨ç¤ºæ‰€æœ‰çº¿ç¨‹éƒ½åˆ°äº†å±éšœç‚¹ã€‚</p>
</li>
</ul>
<p><code>parties</code>å§‹ç»ˆç”¨æ¥è®°å½•æ€»çš„çº¿ç¨‹ä¸ªæ•°ï¼Œå½“<code>count</code>è®¡æ•°å™¨å€¼å˜ä¸º0åï¼Œä¼šå°†<code>parties</code>çš„å€¼èµ‹ç»™<code>count</code>ï¼Œè¿›è€Œè¿›è¡Œæœç”¨ã€‚</p>
<p>å†…éƒ¨ç±»<code>Generation</code>ä»…æœ‰ä¸€ä¸ªå±æ€§<code>broken</code>ï¼Œç”¨æ¥è®°å½•å½“å‰å±éšœæ˜¯å¦è¢«æ‰“ç ´ã€‚æ˜¯åœ¨é”å†…ä½¿ç”¨å˜é‡ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰å£°æ˜ä¸º<code>volatile</code>ã€‚</p>
<p>ï¼ˆ1ï¼‰æ„é€ æ–¹æ³•</p>
<p>å…¥å‚ï¼š<code>parties</code>ï¼ˆå¿…é€‰ï¼‰ã€<code>barrierAction</code>ï¼ˆå¯é€‰ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CyclicBarrier</span><span class="params">(<span class="keyword">int</span> parties, Runnable barrierAction)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parties &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">this</span>.parties = parties;</span><br><span class="line">    <span class="keyword">this</span>.count = parties;</span><br><span class="line">    <span class="keyword">this</span>.barrierCommand = barrierAction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰<code>int await()</code>æ–¹æ³•</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨äº†<code>CyclicBarrier</code>çš„è¯¥æ–¹æ³•æ—¶ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°ï¼š</p>
<ul>
<li><code>parties</code>ä¸ªçº¿ç¨‹éƒ½è°ƒç”¨äº†<code>await</code>æ–¹æ³•ï¼Œçº¿ç¨‹åˆ°è¾¾å±éšœç‚¹</li>
<li>å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•ä¸­æ–­äº†å½“å‰çº¿ç¨‹ï¼Œåˆ™å½“å‰çº¿ç¨‹æŠ›å‡º<code>InterruptedExcetion</code>å¼‚å¸¸</li>
<li>ä¸å½“å‰å±éšœç‚¹å…³è”çš„<code>Generation</code>å¯¹è±¡çš„<code>broken</code>æ ‡å¿—è¢«è®¾ç½®ä¸º<code>true</code>æ—¶ï¼Œä¼šæŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸</li>
</ul>
<p>å†…éƒ¨è°ƒç”¨<code>dowait</code>æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºfalseè¯´æ˜ä¸è®¾ç½®è¶…æ—¶æ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dowait(<span class="keyword">false</span>, <span class="number">0L</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TimeoutException toe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error(toe); <span class="comment">// cannot happen</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰<code>boolean await(long timeout, TimeUnit unit)</code>æ–¹æ³•</p>
<p>å½“å…ˆçº¿ç¨‹è°ƒç”¨äº†<code>CyclicBarrier</code>çš„è¯¥æ–¹æ³•æ—¶ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°ï¼š</p>
<ul>
<li><code>parties</code>ä¸ªçº¿ç¨‹éƒ½è°ƒç”¨äº†<code>await</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹éƒ½åˆ°äº†å±éšœç‚¹ï¼Œè¿™æ—¶å€™è¿”å›<code>true</code></li>
<li>è®¾ç½®çš„<code>timeout</code>æ—¶é—´åˆ°äº†ï¼Œå› ä¸ºè¶…æ—¶è¿”å›<code>false</code></li>
<li>å…¶ä»–çº¿ç¨‹è°ƒç”¨å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•ä¸­æ–­äº†å½“å‰çº¿ç¨‹ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šæŠ›å‡º<code>InterruptedException</code></li>
<li>ä¸å½“å‰å±éšœç‚¹å…³è”çš„<code>Generation</code>å¯¹è±¡çš„<code>broken</code>æ ‡å¿—è¢«è®¾ç½®ä¸º<code>true</code>æ—¶ï¼Œä¼šæŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸</li>
</ul>
<p>å†…éƒ¨è°ƒç”¨<code>dowait</code>æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¯´æ˜è®¾ç½®è¶…æ—¶ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¶…æ—¶æ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException, TimeoutException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dowait(<span class="keyword">true</span>, unit.toNanos(timeout));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰<code>int dowait(boolean timed, long nanos)</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">dowait</span><span class="params">(<span class="keyword">boolean</span> timed, <span class="keyword">long</span> nanos)</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException, TimeoutException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1)å¦‚æœindex=0åˆ™è¯´æ˜æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°äº†å±éšœç‚¹ï¼Œæ­¤æ—¶æ‰§è¡Œåˆå§‹åŒ–æ—¶ä¼ é€’çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">int</span> index = --count;</span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;  <span class="comment">// tripped</span></span><br><span class="line">            <span class="keyword">boolean</span> ranAction = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// (2) æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">                <span class="keyword">final</span> Runnable command = barrierCommand;</span><br><span class="line">                <span class="keyword">if</span> (command != <span class="keyword">null</span>)</span><br><span class="line">                    command.run();</span><br><span class="line">                ranAction = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">// (3)æ¿€æ´»å…¶ä»–å› è°ƒç”¨awaitæ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹ï¼Œå¹¶ä¸”é‡ç½®CyclicBarrier</span></span><br><span class="line">                nextGeneration();</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!ranAction)</span><br><span class="line">                    breakBarrier();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (4)å¦‚æœindex!=0</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// (5)æœªè®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">                <span class="keyword">if</span> (!timed)</span><br><span class="line">                    trip.await();</span><br><span class="line">               	<span class="comment">// ï¼ˆ6ï¼‰è®¾ç½®äº†è¶…æ—¶æ—¶é—´</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; <span class="number">0L</span>)</span><br><span class="line">                    nanos = trip.awaitNanos(nanos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">			...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">nextGeneration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (7)å”¤é†’æ¡ä»¶é˜Ÿåˆ—ä¸­çš„é˜»å¡çº¿ç¨‹</span></span><br><span class="line">    trip.signalAll();</span><br><span class="line">    <span class="comment">// (8)é‡ç½®CyclicBarrier</span></span><br><span class="line">    count = parties;</span><br><span class="line">    generation = <span class="keyword">new</span> Generation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-2-3-å°ç»“"><a href="#8-2-3-å°ç»“" class="headerlink" title="8.2.3 å°ç»“"></a>8.2.3 å°ç»“</h3><p><code>CycleBarrier</code>ä¸<code>CountDownLatch</code>çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå‰è€…æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œå¹¶ä¸”å‰è€…ç‰¹åˆ«é€‚åˆåˆ†æ®µä»»åŠ¡æœ‰åºæ‰§è¡Œçš„åœºæ™¯ã€‚</p>
<p>å†…éƒ¨é€šè¿‡<code>ReentrantLock</code>ç‹¬å é”å®ç°è®¡æ•°å™¨åŸå­æ€§æ›´æ–°ï¼Œå¹¶ä½¿ç”¨æ¡ä»¶å˜é‡é˜Ÿåˆ—æ¥å®ç°çº¿ç¨‹åŒæ­¥ã€‚</p>
<h2 id="8-3-Semaphore"><a href="#8-3-Semaphore" class="headerlink" title="8.3 Semaphore"></a>8.3 Semaphore</h2><p><code>Semaphore</code>ä¿¡å·é‡</p>
<p>ç‰¹ç‚¹ï¼šå†…éƒ¨è®¡æ•°å™¨é€’å¢ã€‚</p>
<p>åŠŸèƒ½ï¼šé™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™ã€‚</p>
<h3 id="8-3-1-æ¡ˆä¾‹"><a href="#8-3-1-æ¡ˆä¾‹" class="headerlink" title="8.3.1 æ¡ˆä¾‹"></a>8.3.1 æ¡ˆä¾‹</h3><p>ä¸»çº¿ç¨‹ç­‰å¾…ä¸¤ä¸ªå­ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;CountDownLatch&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">int</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            unit.sleep(timeout);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            sleep(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">        executorService.submit(() -&gt; &#123;</span><br><span class="line">            sleep(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">        log.debug(<span class="string">&quot;wait all child thread over&quot;</span>);</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">        log.debug(<span class="string">&quot;all child thread over&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-3-2-åŸç†"><a href="#8-3-2-åŸç†" class="headerlink" title="8.3.2 åŸç†"></a>8.3.2 åŸç†</h3><p>ç±»å›¾</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/23706/image-20210508204931688.png" class="" title="image-20210508204931688"><br />

<p><code>Semaphore</code>è¿˜æ˜¯ä½¿ç”¨AQSå®ç°çš„ï¼Œ<code>Sync</code>åªæ˜¯å¯¹AQSçš„ä¸€ä¸ªä¿®é¥°ï¼Œå¹¶ä¸”<code>Sync</code>æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œç”¨æ¥æŒ‡å®šè·å–ä¿¡å·é‡æ—¶æ˜¯å¦é‡‡ç”¨å…¬å¹³ç­–ç•¥ã€‚</p>
<p>ï¼ˆ1ï¼‰æ„é€ æ–¹æ³•</p>
<p>å…¥å‚ï¼š<code>permits</code>ï¼ˆå¿…é€‰ï¼‰ã€<code>fair</code>ï¼ˆå¯é€‰ï¼‰</p>
<p><code>Semphore</code>é»˜è®¤é‡‡ç”¨éå…¬å¹³ç­–ç•¥ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨å…¬å¹³ç­–ç•¥éœ€è¦ä½¿ç”¨åŒå‚æ„é€ æ–¹æ³•ã€‚åˆå§‹åŒ–ä¿¡å·é‡ä¸ªæ•°<code>permits</code>è¢«èµ‹ç»™äº†AQSçš„çŠ¶æ€å˜é‡<code>state</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Semophore</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Semaphore</span><span class="params">(<span class="keyword">int</span> permits, <span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> FairSync(permits) : <span class="keyword">new</span> NonfairSync(permits);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sync</span></span><br><span class="line">Sync(<span class="keyword">int</span> permits) &#123;</span><br><span class="line">    setState(permits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰<code>void acquire()</code>æ–¹æ³•</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨è¯¥æ–¹æ³•çš„ç›®çš„æ˜¯å¸Œæœ›è·å–ä¸€ä¸ªä¿¡å·é‡èµ„æºã€‚</p>
<p>å¦‚æœå½“å‰ä¿¡å·é‡ä¸ªæ•°å¤§äº0ï¼Œåˆ™å½“å‰ä¿¡å·é‡çš„è®¡æ•°ä¼šå‡1ï¼Œç„¶åç›´æ¥è¿”å›ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"> 	<span class="comment">// ä¼ é€’å‚æ•°ä¸º1ï¼Œè¯´æ˜è¦è·å–ä¸€ä¸ªä¿¡å·é‡èµ„æº</span></span><br><span class="line">    sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireSharedInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// (1)å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡ºä¸­æ–­å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">// (2)å¦åˆ™è°ƒç”¨Syncå­ç±»æ–¹æ³•å°è¯•è·å–ï¼Œè¿™é‡Œæ ¹æ®æ„é€ æ–¹æ³•ç¡®å®šNonfairSyncè¿˜æ˜¯FairSync</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äº<code>tryAcquireShared</code>ï¼Œåˆ†ä¸¤ç§æƒ…å†µè®¨è®ºï¼š</p>
<ol>
<li><p>éå…¬å¹³é”</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NonfairSync</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquireShared(acquires);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sync</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">nonfairTryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰ä¿¡å·é‡</span></span><br><span class="line">        <span class="keyword">int</span> available = getState();</span><br><span class="line">        <span class="comment">// è®¡ç®—å½“å‰å‰©ä½™é‡</span></span><br><span class="line">        <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰å‰©ä½™å€¼å°äº0æˆ–è€…CASè®¾ç½®æˆåŠŸåˆ™è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            <span class="keyword">return</span> remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè·å–å½“å‰ä¿¡å·é‡ï¼Œç„¶åå‡å»éœ€è¦è·å–çš„å€¼ï¼Œå¾—åˆ°å‰©ä½™ä¿¡å·é‡ä¸ªæ•°ï¼Œå¦‚æœå‰©ä½™ä¿¡å·é‡å°äº0åˆ™è¯´æ˜å½“å‰ä¿¡å·é‡ä¸ªæ•°æ»¡è¶³ä¸äº†éœ€æ±‚ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›è´Ÿæ•°ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹ä¼šè¢«æ”¾å…¥AQSçš„é˜»å¡é˜Ÿåˆ—è€Œè¢«æŒ‚èµ·ã€‚å¦‚æœå‰©ä½™å€¼å¤§äº0ï¼Œåˆ™ä½¿ç”¨CASæ“ä½œè®¾ç½®å½“å‰ä¿¡å·é‡å€¼ä¸ºå‰©ä½™å€¼ï¼Œç„¶åè¿”å›å‰©ä½™å€¼ã€‚</p>
<p>å¦å¤–ï¼Œç”±äº<code>NonfairSync</code>æ˜¯éå…¬å¹³è·å–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å…ˆè°ƒç”¨<code>acquire</code>æ–¹æ³•è·å–ä¿¡å·é‡çš„çº¿ç¨‹ä¸ä¸€å®šæ¯”åæ¥è€…å…ˆè·å–åˆ°ä¿¡å·é‡ã€‚</p>
</li>
<li><p>å…¬å¹³é”</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// å…ˆæ£€æŸ¥é˜»å¡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (hasQueuedPredecessors())</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> available = getState();</span><br><span class="line">        <span class="keyword">int</span> remaining = available - acquires;</span><br><span class="line">        <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            <span class="keyword">return</span> remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AQSå…¬å¹³æ€§çš„ä¿è¯å°±é <code>hasQueuedPredecessors</code>è¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœå½“å‰çº¿ç¨‹èŠ‚ç‚¹çš„å‰é©±ç»“ç‚¹æ˜¯å¦ä¹Ÿåœ¨ç­‰å¾…è·å–è¯¥èµ„æºï¼Œæ˜¯åˆ™æ”¾å¼ƒè‡ªå·±è·å–ä¿¡å·é‡çš„èµ„æ ¼ã€‚</p>
</li>
</ol>
<p>ï¼ˆ3ï¼‰<code>void acquire(int permits)</code>æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•ä¸<code>acquire()</code>æ–¹æ³•ä¸åŒï¼Œåè€…åªéœ€è¦è·å–ä¸€ä¸ªä¿¡å·é‡å€¼ï¼Œè€Œå‰è€…åˆ™è·å–<code>perimits</code>ä¸ªã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> permits)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permits &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    sync.acquireSharedInterruptibly(permits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ4ï¼‰<code>void acquireUninterruptibly()</code>æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•ä¸<code>acquire()</code>ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºè¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸å“åº”ï¼Œä¹Ÿå°±æ˜¯å½“å½“å‰çº¿ç¨‹è°ƒç”¨äº†<code>acquireUninterruptibly</code>è·å–èµ„æºæ—¶ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•è®¾ç½®äº†å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ï¼Œæ­¤æ—¶å½“å‰çº¿ç¨‹å¹¶ä¸ä¼šæŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸è€Œè¿”å›ã€‚</p>
<p>ï¼ˆ5ï¼‰<code>void accquireUninterruptibly(int permits)</code>æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•ä¸<code>acquire(int permits)</code>æ–¹æ³•çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œè¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸å“åº”ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquireUninterruptibly</span><span class="params">(<span class="keyword">int</span> permits)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permits &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    sync.acquireShared(permits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ6ï¼‰<code>void release()</code>æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯æŠŠå½“å‰<code>Semaphore</code>å¯¹è±¡çš„ä¿¡å·é‡å¢åŠ <code>1</code>ï¼Œå¦‚æœå½“å‰æœ‰çº¿ç¨‹å› ä¸ºè°ƒç”¨<code>acquire</code>æ–¹æ³•è¢«é˜»å¡è€Œè¢«æ”¾å…¥AQSçš„é˜»å¡é˜Ÿåˆ—ï¼Œåˆ™ä¼šæ ¹æ®å…¬å¹³ç­–ç•¥é€‰æ‹©ä¸€ä¸ªä¿¡å·é‡ä¸ªæ•°èƒ½è¢«æ»¡è¶³çš„çº¿ç¨‹è¿›è¡Œæ¿€æ´»ï¼Œæ¿€æ´»çš„çº¿ç¨‹ä¼šå°è¯•è·å–åˆšå¢åŠ çš„ä¿¡å·é‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Semaphore</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (1)arg=1</span></span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AQS</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (2) å°è¯•é‡Šæ”¾èµ„æºé”</span></span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        <span class="comment">// (3)èµ„æºé‡Šæ”¾æˆåŠŸåˆ™è°ƒç”¨parkæ–¹æ³•å”¤é†’AQSé˜Ÿåˆ—é‡Œé¢æœ€å…ˆæŒ‚èµ·çš„çº¿ç¨‹</span></span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sync</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// (4)è·å–å½“å‰ä¿¡å·é‡å€¼</span></span><br><span class="line">        <span class="keyword">int</span> current = getState();</span><br><span class="line">        <span class="comment">// (5)å½“å‰ä¿¡å·é‡å€¼+1</span></span><br><span class="line">        <span class="keyword">int</span> next = current + releases;</span><br><span class="line">        <span class="keyword">if</span> (next &lt; current) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum permit count exceeded&quot;</span>);</span><br><span class="line">       <span class="comment">// (6)é€šè¿‡CASæ›´æ–°ä¿¡å·é‡çš„å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(current, next))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ7ï¼‰<code>void release(int permits)</code>æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•ä¸<code>release()</code>çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå‰è€…è®©ä¿¡å·é‡åŠ <code>permits</code>ï¼Œåè€…åŠ <code>1</code>ã€‚</p>
<h3 id="8-3-3-å°ç»“"><a href="#8-3-3-å°ç»“" class="headerlink" title="8.3.3 å°ç»“"></a>8.3.3 å°ç»“</h3><p><code>Semaphore</code>å®Œå…¨å¯ä»¥è¾¾åˆ°<code>CountDownLatch</code>çš„æ•ˆæœï¼Œä½†æ˜¯<code>Semaphore</code>çš„è®¡æ•°å™¨æ˜¯ä¸å¯ä»¥è‡ªåŠ¨é‡ç½®çš„ï¼Œä¸è¿‡é€šè¿‡å˜ç›¸çš„æ”¹å˜<code>acquire</code>æ–¹æ³•çš„å‚æ•°è¿˜æ˜¯å¯ä»¥å®ç°<code>CyclicBarrier</code>çš„åŠŸèƒ½çš„ã€‚</p>
<h2 id="8-4-ç»å…¸é¢˜ç›®"><a href="#8-4-ç»å…¸é¢˜ç›®" class="headerlink" title="8.4 ç»å…¸é¢˜ç›®"></a>8.4 ç»å…¸é¢˜ç›®</h2><h3 id="8-4-1-äº¤é”™æ‰§è¡Œ"><a href="#8-4-1-äº¤é”™æ‰§è¡Œ" class="headerlink" title="8.4.1 äº¤é”™æ‰§è¡Œ"></a>8.4.1 äº¤é”™æ‰§è¡Œ</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Aï¼ŒBï¼ŒCä¸‰ä¸ªçº¿ç¨‹æœ‰åºäº¤æ›¿æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Alternately&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlternatelyDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸‰ä¸ªä¿¡å·é‡åˆ†åˆ«æ§åˆ¶Aï¼ŒBï¼ŒCçš„æ‰“å°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Semaphore[] s = &#123; <span class="keyword">new</span> Semaphore(<span class="number">1</span>), <span class="keyword">new</span> Semaphore(<span class="number">1</span>), <span class="keyword">new</span> Semaphore(<span class="number">1</span>)&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> size = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span>[] arr = &#123;<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        s[<span class="number">1</span>].acquire();</span><br><span class="line">        s[<span class="number">2</span>].acquire();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> finalI = i;</span><br><span class="line">            executorService.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        s[finalI].acquire();</span><br><span class="line">                        TimeUnit.MILLISECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">                        log.debug(<span class="string">&quot;&#123;&#125; =&gt; [&#123;&#125;]&quot;</span>, arr[finalI], System.nanoTime());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        s[(finalI + <span class="number">1</span>) % size].release();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-4-2-ç”Ÿäº§è€…-æ¶ˆè´¹è€…"><a href="#8-4-2-ç”Ÿäº§è€…-æ¶ˆè´¹è€…" class="headerlink" title="8.4.2 ç”Ÿäº§è€…-æ¶ˆè´¹è€…"></a>8.4.2 ç”Ÿäº§è€…-æ¶ˆè´¹è€…</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-08-03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;SemaphoreProducerConsumerModel&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerConsumerDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** æ•°æ®é˜Ÿåˆ— */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Queue&lt;Character&gt; QUEUE = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    <span class="comment">/** æœ€å¤§å®¹é‡ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> QUEUE_MAX_SIZE = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/** éšæœºå˜é‡ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadLocalRandom RANDOM = ThreadLocalRandom.current();</span><br><span class="line">    <span class="comment">/** è¡¨ç¤ºå¯æ¶ˆè´¹çš„èµ„æºæ•° */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Semaphore FULL = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">/** è¡¨ç¤ºé˜Ÿåˆ—çš„å‰©ä½™ç©ºé—´ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Semaphore EMPTY = <span class="keyword">new</span> Semaphore(QUEUE_MAX_SIZE);</span><br><span class="line">    <span class="comment">/** äº§å“é˜Ÿåˆ—è®¿é—®äº’æ–¥çš„ä¿¡å·é‡ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Semaphore MUTEX = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆéšæœºæ•°å­—/å­—æ¯å­—ç¬¦</span></span><br><span class="line"><span class="comment">     * ascii  char</span></span><br><span class="line"><span class="comment">     * 48-57  0~9</span></span><br><span class="line"><span class="comment">     * 65-90  A~Z</span></span><br><span class="line"><span class="comment">     * 97-122 a~z</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> asciiç å­—ç¬¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Character <span class="title">randomChar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> choice = RANDOM.nextInt(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">if</span> (choice == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">char</span>) (RANDOM.nextInt(<span class="number">10</span>) + <span class="number">48</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">char</span>) (RANDOM.nextInt(<span class="number">26</span>) + <span class="number">65</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">char</span>) (RANDOM.nextInt(<span class="number">26</span>) + <span class="number">97</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿäº§è€…</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="string">&quot;ç”Ÿäº§è€…&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SneakyThrows</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Character c = randomChar();         <span class="comment">// ç”Ÿäº§æ•°æ®</span></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);  <span class="comment">// æ¨¡æ‹Ÿå»¶æ—¶</span></span><br><span class="line">                EMPTY.acquire();                    <span class="comment">// è¯·æ±‚ç©ºé—´</span></span><br><span class="line">                MUTEX.acquire();                    <span class="comment">// è¯·æ±‚è®¿é—®</span></span><br><span class="line">                log.debug(<span class="string">&quot;ç”Ÿäº§ =&gt; [&#123;&#125;]&quot;</span>, c);        <span class="comment">// è¾“å‡ºæ—¥å¿—</span></span><br><span class="line">                QUEUE.add(c);                       <span class="comment">// æ”¾å…¥é˜Ÿåˆ—</span></span><br><span class="line">                MUTEX.release();                    <span class="comment">// é‡Šæ”¾é˜Ÿåˆ—</span></span><br><span class="line">                FULL.release();                     <span class="comment">// æ•°æ®å¢åŠ </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¶ˆè´¹è€…</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="string">&quot;æ¶ˆè´¹è€…&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SneakyThrows</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                FULL.acquire();                     <span class="comment">// è¯·æ±‚æ•°æ®</span></span><br><span class="line">                MUTEX.acquire();                    <span class="comment">// è¯·æ±‚è®¿é—®</span></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);  <span class="comment">// æ¨¡æ‹Ÿå»¶æ—¶</span></span><br><span class="line">                Character c = QUEUE.poll();         <span class="comment">// æ¶ˆè´¹æ•°æ®</span></span><br><span class="line">                log.debug(<span class="string">&quot;æ¶ˆè´¹ =&gt; [&#123;&#125;]&quot;</span>, c);        <span class="comment">// è¾“å‡ºæ—¥å¿—</span></span><br><span class="line">                MUTEX.release();                    <span class="comment">// é‡Šæ”¾é˜Ÿåˆ—</span></span><br><span class="line">                EMPTY.release();                    <span class="comment">// ç©ºé—´å¢åŠ </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Producer().start();</span><br><span class="line">        <span class="keyword">new</span> Consumer().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-4-3-è¯»å†™è€…"><a href="#8-4-3-è¯»å†™è€…" class="headerlink" title="8.4.3 è¯»å†™è€…"></a>8.4.3 è¯»å†™è€…</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯»å†™è€…é—®é¢˜</span></span><br><span class="line"><span class="comment"> * æœ‰è¯»è€…å’Œå†™è€…ä¸¤ç»„å¹¶å‘è¿›ç¨‹ï¼Œå…±äº«ä¸€ä¸ªæ–‡ä»¶ï¼Œå½“ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„è¯»è¿›ç¨‹åŒæ—¶è®¿é—®å…±äº«æ•°æ®æ—¶</span></span><br><span class="line"><span class="comment"> * ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼Œä½†è‹¥æŸä¸ªå†™è¿›ç¨‹å’Œå…¶ä»–è¿›ç¨‹ï¼ˆè¯»è¿›ç¨‹æˆ–å†™è¿›ç¨‹ï¼‰åŒæ—¶è®¿é—®å…±äº«æ•°æ®æ—¶åˆ™</span></span><br><span class="line"><span class="comment"> * å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é”™è¯¯ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;è¦æ±‚ï¼š</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;(1) å…è®¸å¤šä¸ªè¯»è€…å¯ä»¥åŒæ—¶å¯¹æ–‡ä»¶æ‰§è¡Œè¯»æ“ä½œ</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;(2) åªå…è®¸ä¸€ä¸ªå†™è€…å¾€æ–‡ä»¶ä¸­å†™ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;(3) ä»»ä¸€å†™è€…åœ¨å®Œæˆå†™æ“ä½œä¹‹å‰ä¸å…è®¸å…¶ä»–è¯»è€…æˆ–å†™è€…å·¥ä½œ</span></span><br><span class="line"><span class="comment"> * &lt;li&gt;(4) å†™è€…æ‰§è¡Œå†™æ“ä½œå‰ï¼Œåº”è®©å·²æœ‰çš„è¯»è€…å’Œå†™è€…å…¨éƒ¨é€€å‡º</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-08-03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;ReaderWriterDemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderWriterDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** ç”¨äºè¯»å†™è€…äº’æ–¥è®¿é—®æ–‡ä»¶ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Semaphore FILE_MUTEX = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">/** å½“å‰è¯»è€…æ•°é‡ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> READER_COUNT = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/** å¯¹READER_COUNTæ“ä½œçš„äº’æ–¥å˜é‡ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Semaphore COUNT_MUTEX = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å†™è€…</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Writer</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="string">&quot;å†™è€…&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SneakyThrows</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                FILE_MUTEX.acquire();   <span class="comment">// è¯·æ±‚è®¿é—®æ–‡ä»¶</span></span><br><span class="line">                log.debug(<span class="string">&quot;å†™å…¥æ–‡ä»¶&quot;</span>);    <span class="comment">// è¾“å‡ºæ—¥å¿—</span></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                FILE_MUTEX.release();   <span class="comment">// é‡Šæ”¾å…±äº«æ–‡ä»¶</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Reader</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="string">&quot;è¯»è€…&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SneakyThrows</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                COUNT_MUTEX.acquire();    <span class="comment">// è¯·æ±‚è®¿é—®COUNT</span></span><br><span class="line">                <span class="keyword">if</span> (READER_COUNT == <span class="number">0</span>)    <span class="comment">// ç¬¬ä¸€ä¸ªè¯»è¿›ç¨‹</span></span><br><span class="line">                    FILE_MUTEX.acquire(); <span class="comment">// é˜»æ­¢å†™è¿›ç¨‹å†™</span></span><br><span class="line">                READER_COUNT++;           <span class="comment">// è¯»è€…è®¡æ•°å™¨é€’å¢</span></span><br><span class="line">                COUNT_MUTEX.release();    <span class="comment">// æ¢å¤è®¿é—®COUNT</span></span><br><span class="line">                log.debug(<span class="string">&quot;é˜…è¯»æ–‡ä»¶&quot;</span>);      <span class="comment">// è¾“å‡ºæ—¥å¿—</span></span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                COUNT_MUTEX.acquire();    <span class="comment">// è¯·æ±‚è®¿é—®COUNT</span></span><br><span class="line">                READER_COUNT--;           <span class="comment">// è¯»è€…è®¡æ•°å™¨é€’å‡</span></span><br><span class="line">                <span class="keyword">if</span> (READER_COUNT == <span class="number">0</span>)    <span class="comment">// æœ€åä¸€ä¸ªè¯»è¿›ç¨‹</span></span><br><span class="line">                    FILE_MUTEX.release(); <span class="comment">// å…è®¸å†™è¿›ç¨‹å†™</span></span><br><span class="line">                COUNT_MUTEX.release();    <span class="comment">// æ¢å¤è®¿é—®COUNT</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Writer().start();</span><br><span class="line">        <span class="keyword">new</span> Reader().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-4-4-å“²å­¦å®¶å°±é¤"><a href="#8-4-4-å“²å­¦å®¶å°±é¤" class="headerlink" title="8.4.4 å“²å­¦å®¶å°±é¤"></a>8.4.4 å“²å­¦å®¶å°±é¤</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å“²å­¦å®¶å°±é¤é—®é¢˜</span></span><br><span class="line"><span class="comment"> * å½“ä¸€åå“²å­¦å®¶å·¦å³ä¸¤è¾¹çš„ç­·å­éƒ½å¯ç”¨æ—¶ï¼Œæ‰å…è®¸æ‹¿èµ·ç­·å­ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-08-03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;PhilosopherDinnerDemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhilosopherDinnerDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** ç­·å­ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Semaphore[] CHOPSTICKS = &#123;<span class="keyword">new</span> Semaphore(<span class="number">1</span>), <span class="keyword">new</span> Semaphore(<span class="number">1</span>),</span><br><span class="line">            <span class="keyword">new</span> Semaphore(<span class="number">1</span>), <span class="keyword">new</span> Semaphore(<span class="number">1</span>), <span class="keyword">new</span> Semaphore(<span class="number">1</span>)&#125;;</span><br><span class="line">    <span class="comment">/** äº’æ–¥å–ç­·å­ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Semaphore MUTEX = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å“²å­¦å®¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="string">&quot;å“²å­¦å®¶-&quot;</span> + index);</span><br><span class="line">            <span class="keyword">this</span>.index = index;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SneakyThrows</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                MUTEX.acquire();</span><br><span class="line">                CHOPSTICKS[index].acquire();</span><br><span class="line">                CHOPSTICKS[(index + <span class="number">1</span>) % <span class="number">5</span>].acquire();</span><br><span class="line">                MUTEX.release();</span><br><span class="line">                log.debug(<span class="string">&quot;è¿›é¤&quot;</span>);</span><br><span class="line">                CHOPSTICKS[index].release();</span><br><span class="line">                CHOPSTICKS[(index + <span class="number">1</span>) % <span class="number">5</span>].release();</span><br><span class="line">                log.debug(<span class="string">&quot;æ€è€ƒ&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Philosopher[] philosophers = <span class="keyword">new</span> Philosopher[<span class="number">5</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; philosophers.length; i++) &#123;</span><br><span class="line">            philosophers[i] = <span class="keyword">new</span> Philosopher(i);</span><br><span class="line">            philosophers[i].start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-4-5-å’Œå°šå’Œæ°´"><a href="#8-4-5-å’Œå°šå’Œæ°´" class="headerlink" title="8.4.5 å’Œå°šå’Œæ°´"></a>8.4.5 å’Œå°šå’Œæ°´</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å’Œå°šä¸æ°´é—®é¢˜</span></span><br><span class="line"><span class="comment"> * å¯ºåº™æœ‰å°å’Œå°šå’Œè€å’Œå°šè‹¥å¹²ï¼Œæœ‰ä¸€æ°´ç¼¸ï¼Œç”±å°å’Œå°šææ°´å…¥ç¼¸ä¾›è€å’Œå°šå¼•ç”¨ã€‚</span></span><br><span class="line"><span class="comment"> * æ°´ç¼¸å¯å®¹10æ¡¶æ°´ï¼Œäº•æ¯æ¬¡åªèƒ½å®¹ä¸€ä¸ªæ¡¶å–æ°´ã€‚æ°´æ¡¶æ€»æ•°ä¸º3ä¸ªï¼Œæ¯æ¬¡å…¥ç¼¸ä»…å–1æ¡¶æ°´ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-08-03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;MonkAndWaterDemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MonkAndWaterDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** ç”¨äºäº’æ–¥åœ°è®¿é—®æ°´äº•*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Semaphore WELL = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">/** ç”¨äºäº’æ–¥åœ°è®¿é—®æ°´ç¼¸ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Semaphore VAT = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">/** ç”¨äºè¡¨ç¤ºæ°´ç¼¸ä¸­å‰©ä½™ç©ºé—´æ‰€èƒ½å®¹çº³çš„æ°´çš„æ¡¶æ•° */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Semaphore EMPTY = <span class="keyword">new</span> Semaphore(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">/** è¡¨ç¤ºæ°´ç¼¸ä¸­æ°´çš„æ¡¶æ•° */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Semaphore FULL = <span class="keyword">new</span> Semaphore(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">/** è¡¨ç¤ºæœ‰å¤šå°‘ä¸ªæ°´æ¡¶å¯ç”¨ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Semaphore BUCKET = <span class="keyword">new</span> Semaphore(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è€å’Œå°š</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OldMonk</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OldMonk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="string">&quot;è€å’Œå°š&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SneakyThrows</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                FULL.acquire();    <span class="comment">// è¯·æ±‚æ°´ç¼¸çš„æ°´</span></span><br><span class="line">                BUCKET.acquire();  <span class="comment">// è¯·æ±‚æ°´æ¡¶èµ„æº</span></span><br><span class="line">                VAT.acquire();     <span class="comment">// è¯·æ±‚æ°´ç¼¸èµ„æº</span></span><br><span class="line">                log.debug(<span class="string">&quot;ä»æ°´ç¼¸ä¸­æ‰“ä¸€æ¡¶æ°´&quot;</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                VAT.release();     <span class="comment">// é‡Šæ”¾æ°´ç¼¸èµ„æº</span></span><br><span class="line">                EMPTY.release();   <span class="comment">// æ¶ˆè€—æ°´èµ„æº</span></span><br><span class="line">                log.debug(<span class="string">&quot;å–æ°´æ°´&quot;</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                BUCKET.release();  <span class="comment">// é‡Šæ”¾æ°´æ¡¶èµ„æº</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°å’Œå°š</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">YoungMonk</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">YoungMonk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="string">&quot;å°å’Œå°š&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SneakyThrows</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                EMPTY.acquire();   <span class="comment">// è¯·æ±‚æ°´ç¼¸ç©ºé—´</span></span><br><span class="line">                BUCKET.acquire();  <span class="comment">// è¯·æ±‚æ¡¶èµ„æº</span></span><br><span class="line">                WELL.acquire();    <span class="comment">// è¯·æ±‚æ°´äº•èµ„æº</span></span><br><span class="line">                log.debug(<span class="string">&quot;ä»æ°´äº•ä¸­æ‰“ä¸€æ¡¶æ°´&quot;</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                WELL.release();    <span class="comment">// é‡Šæ”¾æ°´äº•èµ„æº</span></span><br><span class="line">                VAT.acquire();     <span class="comment">// è¯·æ±‚æ°´ç¼¸èµ„æº</span></span><br><span class="line">                log.debug(<span class="string">&quot;å€’æ°´æ°´&quot;</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                VAT.release();     <span class="comment">// é‡Šæ”¾æ°´ç¼¸èµ„æº</span></span><br><span class="line">                FULL.release();    <span class="comment">// å¢åŠ æ°´ç¼¸çš„æ°´</span></span><br><span class="line">                BUCKET.release();  <span class="comment">// é‡Šæ”¾æ°´æ¡¶èµ„æº</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> OldMonk().start();</span><br><span class="line">        <span class="keyword">new</span> YoungMonk().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-15(åƒåœ¾å›æ”¶å™¨)</title>
    <url>/posts/11567/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="15-1-ğŸš€GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡"><a href="#15-1-ğŸš€GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="15.1 ğŸš€GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡"></a>15.1 ğŸš€GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡</h3><blockquote>
<p>ğŸ’¬ åƒåœ¾å›æ”¶å™¨æ¦‚è¿°</p>
</blockquote>
<ul>
<li>åƒåœ¾å™¨æ²¡æœ‰åœ¨è§„èŒƒä¸­è¿›è¡Œè¿‡å¤šè§„å®šï¼Œå¯ä»¥ç”±ä¸åŒçš„å‚å•†ã€ä¸åŒç‰ˆæœ¬çš„JVMæ¥å®ç°ã€‚</li>
<li>ç”±äºJDKçš„ç‰ˆæœ¬å¤„äºé«˜é€Ÿè¿­ä»£è¿‡ç¨‹ä¸­ï¼Œå› æ­¤Javaå‘å±•è‡³ä»Šå·²ç»è¡ç”Ÿäº†ä¼—å¤šçš„GCç‰ˆæœ¬ã€‚</li>
<li>ä»ä¸åŒè§’åº¦åˆ†æåƒåœ¾å›æ”¶å™¨ï¼Œå¯å°†GCåˆ†ä¸ºä¸åŒçš„ç±»å‹ã€‚</li>
</ul>
<blockquote>
<p>ğŸ““ åƒåœ¾å›æ”¶å™¨åˆ†ç±»</p>
</blockquote>
<p>æŒ‰ç…§å·¥ä½œæ¨¡å¼åˆ†ï¼š</p>
<ul>
<li>å¹¶å‘å¼åƒåœ¾å›æ”¶å™¨ï¼šä¸åº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿å·¥ä½œï¼Œä»¥å°½å¯èƒ½å‡å°‘åº”ç”¨ç¨‹åºçš„åœé¡¿æ—¶é—´ã€‚</li>
<li>ç‹¬å å¼åƒåœ¾å›æ”¶å™¨ï¼šä¸€æ—¦è¿è¡Œï¼Œå°±åœæ­¢åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ï¼Œç›´åˆ°åƒåœ¾å›æ”¶è¿‡ç¨‹å®Œå…¨ç»“æŸã€‚</li>
</ul>
<p>æŒ‰ç…§ç¢ç‰‡å¤„ç†æ–¹å¼åˆ†ï¼š</p>
<ul>
<li>å‹ç¼©å¼åƒåœ¾å›æ”¶å™¨ï¼šå›æ”¶å®Œæˆåï¼Œå¯¹å­˜æ´»å¯¹è±¡è¿›è¡Œå‹ç¼©æ•´ç†ï¼Œæ¶ˆé™¤å›æ”¶åçš„ç¢ç‰‡ã€‚</li>
<li>éå‹ç¼©å¼çš„åƒåœ¾å›æ”¶å™¨ï¼šå›æ”¶å®Œæˆä¸è¿›è¡Œå‹ç¼©ã€‚</li>
</ul>
<p>æŒ‰ç…§å·¥ä½œçš„å†…å­˜åŒºé—´åˆ†ï¼š</p>
<ul>
<li>å¹´è½»ä»£åƒåœ¾å›æ”¶å™¨</li>
<li>è€å¹´ä»£åƒåœ¾å›æ”¶å™¨</li>
</ul>
<blockquote>
<p>ğŸ“ˆ è¯„ä¼°GCçš„æ€§èƒ½æŒ‡æ ‡</p>
</blockquote>
<ul>
<li>ååé‡ï¼šè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´å æ€»è¿è¡Œæ—¶é—´çš„æ¯”ä¾‹ï¼ˆæ€»è¿è¡Œæ—¶é—´ = ç¨‹åºçš„è¿è¡Œæ—¶é—´ + å†…å­˜å›æ”¶çš„æ—¶é—´ï¼‰</li>
<li>åƒåœ¾å¼€é”€ï¼šååé‡çš„è¡¥æ•°ï¼Œåƒåœ¾æ‰€ç”¨æ—¶é—´å æ€»è¿è¡Œæ—¶é—´çš„æ¯”ä¾‹</li>
<li>æš‚åœæ—¶é—´ï¼šæ‰§è¡Œåƒåœ¾æ—¶ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹è¢«æš‚åœçš„æ—¶é—´</li>
<li>é¢‘ç‡ï¼šç›¸å¯¹äºåº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼Œæ“ä½œå‘ç”Ÿçš„é¢‘ç‡</li>
<li>å†…å­˜å ç”¨ï¼šJavaå †åŒºæ‰€å çš„å†…å­˜å¤§å°</li>
<li>å¿«é€Ÿï¼šä¸€ä¸ªå¯¹è±¡ä»è¯ç”Ÿåˆ°è¢«å›æ”¶æ‰€ç»å†çš„æ—¶é—´</li>
</ul>
<p>ä¸»è¦æŠ“ä½ä¸¤ç‚¹ï¼šååé‡å’Œæš‚åœæ—¶é—´</p>
<p>ç”±äºé«˜ååé‡å’Œä½æš‚åœæ—¶é—´æ˜¯ä¸¤ä¸ªå¯¹ç«‹çš„æ¡ä»¶ï¼Œä¸€ä¸ªGCç®—æ³•åªå¯èƒ½é’ˆå¯¹ä¸¤ä¸ªç›®æ ‡ä¹‹ä¸€ï¼Œæˆ–è€…å°è¯•ä¸€ä¸ªäºŒè€…çš„æŠ˜ä¸­ã€‚</p>
<p>ç°åœ¨æ ‡å‡†ï¼šåœ¨æœ€å¤§ååé‡ä¼˜å…ˆçš„æƒ…å†µä¸‹ï¼Œé™ä½åœé¡¿æ—¶é—´ã€‚</p>
<h3 id="15-2-ğŸ“–-ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°"><a href="#15-2-ğŸ“–-ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°" class="headerlink" title="15.2 ğŸ“– ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°"></a>15.2 ğŸ“– ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°</h3><blockquote>
<p>ğŸ› å†å²</p>
</blockquote>
<div class="tabs" id="jvm-timeline"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#jvm-timeline-1">jvm-timeline 1</button></li><li class="tab"><button type="button" data-href="#jvm-timeline-2">jvm-timeline 2</button></li><li class="tab"><button type="button" data-href="#jvm-timeline-3">jvm-timeline 3</button></li><li class="tab"><button type="button" data-href="#jvm-timeline-4">jvm-timeline 4</button></li><li class="tab"><button type="button" data-href="#jvm-timeline-5">jvm-timeline 5</button></li><li class="tab"><button type="button" data-href="#jvm-timeline-6">jvm-timeline 6</button></li><li class="tab"><button type="button" data-href="#jvm-timeline-7">jvm-timeline 7</button></li><li class="tab"><button type="button" data-href="#jvm-timeline-8">jvm-timeline 8</button></li><li class="tab"><button type="button" data-href="#jvm-timeline-9">jvm-timeline 9</button></li><li class="tab"><button type="button" data-href="#jvm-timeline-10">jvm-timeline 10</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="jvm-timeline-1"><p><strong>2001-05-17[JDK1.3.1]ï¼šç¬¬ä¸€æ¬¾GCâ€”â€”ä¸²è¡ŒSerial GCå‘å¸ƒã€‚PerNew GCæ˜¯Serial GCçš„å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="jvm-timeline-2"><p><strong>2003-06-26[JDK1.4.2]: Parallel GCå’ŒConsurrent Mark Sweep GCå‘å¸ƒã€‚</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="jvm-timeline-3"><p><strong>2006-12-11[JDK1.6]: Parallel GCç”ŸæˆHotspoté»˜è®¤GCã€‚</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="jvm-timeline-4"><p><strong>2012[JDK1.7u4]: G1å¯ç”¨ã€‚</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="jvm-timeline-5"><p><strong>2017-09-21[JDK9]: G1æˆä¸ºé»˜è®¤å›æ”¶å™¨ï¼Œä»£æ›¿CMSã€‚</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="jvm-timeline-6"><p><strong>2018-03-21[JDK10]: G1åƒåœ¾å›æ”¶å™¨çš„å¹¶è¡Œå®Œæ•´åƒåœ¾å›æ”¶ï¼Œå®ç°å¹¶è¡Œæ€§æ¥æ”¹å–„æœ€åæƒ…å†µä¸‹çš„å»¶è¿Ÿã€‚</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="jvm-timeline-7"><p><strong>2018-09-25[JDK11]: å¼•å…¥Epsilonåƒåœ¾å™¨ï¼ŒåŒæ—¶å¼•å…¥ZGCã€‚</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="jvm-timeline-8"><p><strong>2019-03-19[JDK12]: å¢å¼ºG1ï¼ˆè‡ªåŠ¨è¿”å›æœªç”¨å †å†…å­˜ç»™æ“ä½œç³»ç»Ÿï¼‰ã€‚åŒæ—¶ï¼Œå¼•å…¥Shenandoah GCã€‚</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="jvm-timeline-9"><p><strong>2019-09-17[JDK13]: å¢å¼ºZGCï¼ˆè‡ªåŠ¨è¿”å›æœªç”¨å †å†…å­˜ç»™æ“ä½œç³»ç»Ÿï¼‰ã€‚</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="jvm-timeline-10"><p><strong>2020-03-17[JDK14]: åˆ é™¤CMSï¼Œæ‰©å±•ZGCåœ¨macOSå’ŒWindowsä¸Šçš„åº”ç”¨ã€‚</strong></p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div>





<blockquote>
<p>ğŸ¨ åˆ†ç±»</p>
</blockquote>
<ul>
<li>ä¸²è¡Œå›æ”¶å™¨ï¼šSerialã€Serial Old</li>
<li>å¹¶è¡Œå›æ”¶å™¨ï¼šParNewã€Parallel Scavengeã€Parallel Old</li>
<li>å¹¶å‘å›æ”¶å™¨ï¼šCMSã€G1</li>
</ul>
<blockquote>
<p>ğŸ“· å›¾ç¤º</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11567/GC.svg" class="" title="GC"><br />

<ul>
<li>æ–°ç”Ÿä»£å›æ”¶å™¨ï¼šSerialã€ParNewã€Parallel Scavenge</li>
<li>è€å¹´ä»£å›æ”¶å™¨ï¼šSerial Oldã€Parallel Oldã€CMS</li>
<li>æ•´å †å›æ”¶å™¨ï¼šG1</li>
</ul>
<blockquote>
<p>â“ ä¸ºä»€ä¹ˆè¦æœ‰å¾ˆå¤šåƒåœ¾å›æ”¶å™¨ï¼Œä¸€ä¸ªä¸å¤Ÿå—ï¼Ÿ</p>
</blockquote>
<p>å› ä¸ºJavaçš„ä½¿ç”¨åœºæ™¯å¾ˆå¤šï¼Œç§»åŠ¨ç«¯ã€æœåŠ¡ç«¯ç­‰ã€‚æ‰€ä»¥å°±éœ€è¦é’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œæä¾›ä¸åŒçš„åƒåœ¾å›æ”¶å™¨ï¼Œæé«˜åƒåœ¾çš„æ€§èƒ½ã€‚</p>
<p>è™½ç„¶æˆ‘ä»¬ä¼šå¯¹å„ä¸ªå™¨è¿›è¡Œæ¯”è¾ƒï¼Œä½†å¹¶éä¸ºäº†æŒ‘é€‰ä¸€ä¸ªæœ€å¥½çš„å™¨å‡ºæ¥ã€‚æ²¡æœ‰ä¸€ç§æ”¾ä¹‹å››æµ·è€Œçš†å‡†ã€ä»»ä½•åœºæ™¯éƒ½é€‚ç”¨çš„å®Œç¾å™¨å­˜åœ¨ï¼Œæ›´åŠ æ²¡æœ‰ä¸‡èƒ½çš„å™¨ã€‚æ‰€ä»¥æˆ‘ä»¬é€‰æ‹©çš„åªæ˜¯å¯¹å…·ä½“åº”ç”¨æœ€åˆé€‚çš„å™¨ã€‚</p>
<blockquote>
<p>â“ å¦‚ä½•æŸ¥çœ‹é»˜è®¤çš„åƒåœ¾å™¨ï¼Ÿ</p>
</blockquote>
<ul>
<li>ç¨‹åºä¸­ï¼š<code>-XX:+PrintCommandLineFlags</code></li>
<li>å‘½ä»¤è¡Œï¼š<code>jinfo -flag &lt;å‚æ•°&gt; &lt;è¿›ç¨‹ID&gt;</code></li>
</ul>
<h3 id="15-3-1ï¸âƒ£-Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶"><a href="#15-3-1ï¸âƒ£-Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶" class="headerlink" title="15.3 1ï¸âƒ£ Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶"></a>15.3 1ï¸âƒ£ Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶</h3><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>Serialå›æ”¶å™¨æ˜¯æœ€åŸºæœ¬ã€å†å²æœ€æ‚ ä¹…çš„åƒåœ¾å›æ”¶å™¨äº†ã€‚JDK1.3ä¹‹å‰å›æ”¶æ–°ç”Ÿä»£çš„å”¯ä¸€é€‰æ‹©ã€‚</li>
<li>Serialå›æ”¶å™¨ä½œä¸ºHotSpotä¸­Clientæ¨¡å¼ä¸‹çš„é»˜è®¤æ–°ç”Ÿä»£åƒåœ¾å™¨ã€‚</li>
<li>Serialå›æ”¶å™¨é‡‡ç”¨å¤åˆ¶ç®—æ³•ã€ä¸²è¡Œå›æ”¶å’ŒSTWæœºåˆ¶çš„æ–¹å¼æ‰§è¡Œå†…å­˜å›æ”¶ã€‚</li>
<li>é™¤äº†å¹´è½»ä»£ä¹‹å¤–ï¼ŒSerialå›æ”¶å™¨è¿˜æä¾›äº†ç”¨äºæ‰§è¡Œè€å¹´ä»£åƒåœ¾æ”¶é›†çš„Serial Oldå›æ”¶å™¨ã€‚Serial Oldæ”¶é›†å™¨åŒæ ·ä¹Ÿé‡‡ç”¨äº†ä¸²è¡Œå›æ”¶å’ŒSTWæœºåˆ¶ï¼Œåªä¸è¿‡å†…å­˜å›æ”¶ç®—æ³•ä½¿ç”¨çš„æ˜¯æ ‡è®°-å‹ç¼©ç®—æ³•ã€‚</li>
<li>Serial Oldæ˜¯è¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹é»˜è®¤çš„è€å¹´ä»£çš„åƒåœ¾å›æ”¶å™¨ã€‚</li>
<li>Serial Oldåœ¨Serveræ¨¡å¼ä¸‹ä¸»è¦æœ‰ä¸¤ä¸ªç”¨é€”ï¼šä¸æ–°ç”Ÿä»£çš„Parallel Scanvengeé…åˆä½¿ç”¨ï¼Œä½œä¸ºè€å¹´ä»£CMSå›æ”¶å™¨çš„åå¤‡åƒåœ¾æ–¹æ¡ˆã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<p>Serialå›æ”¶å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„å›æ”¶å™¨ï¼Œä½†å®ƒå•çº¿ç¨‹çš„æ„ä¹‰å¹¶ä¸ä»…ä»…è¯´æ˜å®ƒåªä¼šä½¿ç”¨ä¸€ä¸ªCPUæˆ–ä¸€æ¡å›æ”¶çº¿ç¨‹å»å®Œæˆåƒåœ¾å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯åœ¨å®ƒè¿›è¡Œåƒåœ¾æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°å®ƒç»“æŸã€‚</p>
<p>ä¼˜åŠ¿ï¼šç®€å•è€Œé«˜æ•ˆï¼Œå¯¹äºé™å®šå•ä¸ªCPUçš„ç¯å¢ƒæ¥è¯´ï¼ŒSerialæ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œä¸“å¿ƒåšåƒåœ¾å›æ”¶è‡ªç„¶å¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ•ˆç‡ã€‚è¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
<p>åœ¨ç”¨æˆ·çš„æ¡Œé¢åº”ç”¨åœºæ™¯ä¸­ï¼Œå¯ç”¨å†…å­˜ä¸€èˆ¬ä¸å¤§ï¼Œå¯ä»¥åœ¨è¾ƒçŸ­æ—¶é—´å†…å®Œæˆåƒåœ¾ï¼Œåªè¦ä¸é¢‘ç¹å‘ç”Ÿï¼Œä½¿ç”¨ä¸²è¡Œå›æ”¶å™¨æ˜¯å¯ä»¥æ¥å—çš„ã€‚</p>
<p>å¯¹äºäº¤äº’æ€§è¾ƒå¼ºçš„åº”ç”¨è€Œè¨€ï¼Œè¿™ç§åƒåœ¾å›æ”¶å™¨æ˜¯ä¸èƒ½æ¥å—çš„ã€‚ä¸€èˆ¬Java Webåº”ç”¨ç¨‹åºä¸­æ˜¯ä¸ä¼šé‡‡ç”¨ä¸²è¡Œåƒåœ¾å™¨çš„ã€‚</p>
<blockquote>
<p>âš™ï¸ é…ç½®</p>
</blockquote>
<p>åœ¨HotSpotè™šæ‹Ÿæœºä¸­ï¼Œä½¿ç”¨<code>-XX:+UseSerialGC</code>å‚æ•°å¯ä»¥æŒ‡å®šå¹´è½»ä»£å’Œè€å¹´ä»£éƒ½ä½¿ç”¨ä¸²è¡Œå™¨ã€‚ç­‰ä»·äºæ–°ç”Ÿä»£ä½¿ç”¨Serial GCï¼Œä¸”è€å¹´ä»£è¿˜æœ‰é‚£ä¸ªSerial Old GCã€‚</p>
<h3 id="15-4-2ï¸âƒ£-ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶"><a href="#15-4-2ï¸âƒ£-ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶" class="headerlink" title="15.4 2ï¸âƒ£ ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶"></a>15.4 2ï¸âƒ£ ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶</h3><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>å¦‚æœè¯´Serial GCæ˜¯å¹´è½»ä»£ä¸­çš„å•çº¿ç¨‹åƒåœ¾å›æ”¶å™¨ï¼Œé‚£ä¹ˆParNewæ”¶é›†å™¨åˆ™æ˜¯Serialå›æ”¶å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚ï¼ˆParæ˜¯Parallelçš„ç¼©å†™ï¼ŒNewåªèƒ½å¤„ç†æ–°ç”Ÿä»£ï¼‰</li>
<li>ParNewå›æ”¶å™¨é™¤äº†é‡‡ç”¨å¹¶è¡Œå›æ”¶çš„æ–¹å¼æ‰§è¡Œå†…å­˜å›æ”¶å¤–ï¼Œä¸¤æ¬¾åƒåœ¾å›æ”¶å™¨ä¹‹é—´å‡ ä¹æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚ParNewæ”¶é›†å™¨åœ¨å¹´è½»ä»£ä¸­åŒæ ·ä¹Ÿæ˜¯é‡‡ç”¨å¤åˆ¶ç®—æ³•ã€STWæœºåˆ¶ã€‚</li>
<li>ParNewæ˜¯å¾ˆå¤šJVMè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹æ–°ç”Ÿä»£çš„é»˜è®¤åƒåœ¾æ”¶é›†å™¨ã€‚</li>
<li>å¯¹äºæ–°ç”Ÿä»£ï¼Œå›æ”¶æ¬¡æ•°é¢‘ç¹ï¼Œä½¿ç”¨å¹¶è¡Œæ–¹å¼é«˜æ•ˆã€‚</li>
<li>å¯¹äºè€å¹´ä»£ï¼Œå›æ”¶æ¬¡æ•°å°‘ï¼Œä½¿ç”¨ä¸²è¡Œæ–¹å¼èŠ‚çœèµ„æºã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<ul>
<li>åœ¨å¤šCPUçš„ç¯å¢ƒä¸‹ï¼ŒParNewç”±äºå¯ä»¥å……åˆ†åˆ©ç”¨å¤šCPUã€å¤šæ ¸å¿ƒç­‰ç‰©ç†ç¡¬ä»¶ç­‰èµ„æºä¼˜åŠ¿ï¼Œå¯ä»¥æ›´å¿«é€Ÿåœ°å®Œæˆåƒåœ¾æ”¶é›†ï¼Œæå‡ç¨‹åºçš„ååé‡ã€‚</li>
<li>ä½†æ˜¯åœ¨å•ä¸ªCPUçš„ç¯å¢ƒä¸‹ï¼ŒParNewå›æ”¶å™¨å¹¶æ²¡æœ‰Serialé«˜æ•ˆã€‚</li>
<li>é™¤äº†Serialå¤–ï¼Œç›®å‰åªæœ‰ParNew GCèƒ½ä¸CMSæ”¶é›†å™¨é…åˆå·¥ä½œã€‚</li>
</ul>
<blockquote>
<p>âš™ï¸ é…ç½®</p>
</blockquote>
<ul>
<li><code>-XX:+UseParNewGC</code>ï¼šæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨ParNewå›æ”¶å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ã€‚ï¼ˆè¡¨ç¤ºå¹´è½»ä»£ä½¿ç”¨å¹¶è¡Œå›æ”¶å™¨ï¼Œä¸å½±å“è€å¹´ä»£ï¼‰</li>
<li><code>-XX:ParallelGCThreads</code>ï¼šé™åˆ¶çº¿ç¨‹æ•°é‡ã€‚ï¼ˆé»˜è®¤å¼€å¯å’ŒCPUæ•°æ®ç›¸åŒçš„çº¿ç¨‹æ•°ï¼‰</li>
</ul>
<h3 id="15-5-3ï¸âƒ£-Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ"><a href="#15-5-3ï¸âƒ£-Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ" class="headerlink" title="15.5 3ï¸âƒ£ Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ"></a>15.5 3ï¸âƒ£ Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ</h3><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>HotSpotçš„å¹´è½»ä»£é™¤äº†æ‹¥æœ‰ParNewå›æ”¶å™¨æ˜¯åŸºäºå¹¶è¡Œå›æ”¶çš„ä»¥å¤–ï¼ŒParallel ScavengeåŒæ ·ä¹Ÿé‡‡ç”¨äº†å¤åˆ¶ç®—æ³•ã€å¹¶è¡Œå›æ”¶å’ŒSTWæœºåˆ¶ã€‚</li>
<li>å’ŒParNewå›æ”¶å™¨ä¸åŒï¼ŒParallel Scavengeå›æ”¶å™¨çš„ç›®æ ‡åˆ™æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ï¼Œå®ƒä¹Ÿè¢«ç§°ä¸ºååé‡ä¼˜å…ˆçš„åƒåœ¾å›æ”¶å™¨ï¼Œè‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ä¹Ÿæ˜¯Parallel Scavengeçš„ä¸€ä¸ªé‡è¦åŒºåˆ«ã€‚</li>
<li>é«˜ååé‡åˆ™å¯ä»¥é«˜æ•ˆç‡åœ°åˆ©ç”¨CPUæ—¶é—´ï¼Œå°½å¿«å®Œæˆç¨‹åºçš„è¿ç®—ä»»åŠ¡ï¼Œä¸»è¦é€‚åˆåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡ã€‚å› æ­¤ï¼Œå¸¸è§åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œé‚£äº›æ‰§è¡Œæ‰¹é‡å¤„ç†ã€è®¢å•å¤„ç†ã€å·¥èµ„æ”¯ä»˜ã€ç§‘å­¦è®¡ç®—çš„åº”ç”¨ç¨‹åºã€‚</li>
<li>Parallelå›æ”¶å™¨åœ¨JDK1.6æ—¶æä¾›äº†ç”¨äºæ‰§è¡Œè€å¹´ä»£åƒåœ¾æ”¶é›†çš„Parallel Oldæ”¶é›†å™¨ï¼Œç”¨æ¥ä»£æ›¿è€å¹´ä»£çš„Serial Oldæ”¶é›†å™¨ã€‚</li>
<li>Parallel Oldå›æ”¶å™¨é‡‡ç”¨äº†æ ‡è®°-å‹ç¼©ç®—æ³•ï¼Œä½†åŒæ ·ä¹Ÿæ˜¯åŸºäºå¹¶è¡Œå›æ”¶å’ŒSTWæœºåˆ¶ã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<p>åœ¨ç¨‹åºååé‡ä¼˜å…ˆçš„åº”ç”¨åœºæ™¯ä¸­ï¼ŒParallel Oldæ”¶é›†å™¨çš„ç»„åˆï¼Œåœ¨Serveræ¨¡å¼ä¸‹çš„å†…å­˜å›æ”¶æ€§èƒ½å¾ˆä¸é”™ã€‚</p>
<blockquote>
<p>âš™ï¸ é…ç½®</p>
</blockquote>
<ul>
<li><code>-XX:+UseParallelGC</code>ï¼šæ‰‹åŠ¨æŒ‡å®šå¹´è½»ä»£ä½¿ç”¨Parallelå¹¶è¡Œå›æ”¶å™¨ã€‚</li>
<li><code>-XX:+UseParallelOldGC</code>ï¼šæ‰‹åŠ¨æŒ‡å®šè€å¹´ä»£ä½¿ç”¨Parallelå¹¶è¡Œå›æ”¶å™¨ã€‚</li>
<li><code>-XX:ParallelGCThreads</code>ï¼šè®¾ç½®å¹´è½»ä»£å¹¶è¡Œå›æ”¶å™¨çš„çº¿ç¨‹æ•°ã€‚ä¸€èˆ¬åœ°ï¼Œæœ€å¥½ä¸CPUæ•°é‡ç›¸ç­‰ï¼Œä»¥é¿å…è¿‡å¤šçš„çº¿ç¨‹æ•°å½±å“åƒåœ¾æ”¶é›†æ€§èƒ½ã€‚</li>
<li><code>-XX:MaxGCPauseMills=N</code>ï¼šè®¾ç½®åƒåœ¾å›æ”¶å™¨æœ€å¤§åœé¡¿æ—¶é—´ï¼ˆå³STWçš„æ—¶é—´ï¼‰ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚ä¸ºäº†å°½å¯èƒ½æŠŠåœé¡¿æ—¶é—´æ§åˆ¶åœ¨<code>MaxGCPauseMills</code>ä»¥å†…ï¼Œæ”¶é›†å™¨åœ¨å·¥ä½œæ—¶ä¼šè°ƒæ•´Javaå †å¤§å°æˆ–è€…å…¶ä»–ä¸€äº›å‚æ•°ã€‚å¯¹äºç”¨æˆ·æ¥è®²ï¼Œåœé¡¿æ—¶é—´è¶ŠçŸ­ä½“éªŒè¶Šå¥½ï¼›ä½†æ˜¯åœ¨æœåŠ¡ç«¯ï¼Œæˆ‘ä»¬æ³¨é‡é«˜å¹¶å‘ï¼Œæ•´ä½“çš„ååé‡ã€‚æ‰€ä»¥æœåŠ¡å™¨ç«¯é€‚åˆParallelï¼Œè¿›è¡Œæ§åˆ¶ã€‚</li>
<li><code>-XX:GCTimeRatio=N</code>ï¼šåƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ä¾‹ï¼ˆ= 1 / [N + 1]ï¼‰ï¼Œç”¨äºè¡¡é‡ååé‡çš„å¤§å°ã€‚0&lt;N&lt;100ï¼Œé»˜è®¤å€¼99ï¼Œå³åƒåœ¾å›æ”¶æ—¶é—´ä¸è¶…è¿‡1%ã€‚ä¸ä¸Šä¸€ä¸ªå‚æ•°æœ‰ä¸€å®šçŸ›ç›¾æ€§ï¼Œæš‚åœæ—¶é—´è¶Šé•¿ï¼ŒRadioå‚æ•°å°±å®¹æ˜“è¶…è¿‡è®¾å®šçš„æ¯”ä¾‹ã€‚</li>
<li><code>-XX:+UseAdaptiveSizePolicy</code>ï¼šè®¾ç½®Parallel Scavengeæ”¶é›†å™¨å…·æœ‰è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¹´è½»ä»£çš„å¤§å°ã€Edenå’ŒSurvivorçš„æ¯”ä¾‹ã€æ™‹å‡è€å¹´ä»£çš„å¯¹è±¡å¹´é¾„ç­‰å‚æ•°ä¼šè¢«è‡ªåŠ¨è°ƒæ•´ï¼Œå·²è¾¾åˆ°åœ¨å †å¤§å°ã€ååé‡å’Œåœé¡¿æ—¶é—´ä¹‹é—´çš„å¹³è¡¡ç‚¹ã€‚åœ¨æ‰‹åŠ¨è°ƒä¼˜æ¯”è¾ƒå›°éš¾çš„åœºåˆï¼Œè¯¾ç›´æ¥ä½¿ç”¨è¿™ç§è‡ªé€‚åº”çš„æ–¹å¼ï¼Œä»…æŒ‡å®šè™šæ‹Ÿæœºçš„æœ€å¤§å †ã€ç›®æ ‡çš„ååé‡ï¼ˆGCTimeRatioï¼‰å’Œåœé¡¿æ—¶é—´ï¼ˆMaxGCPauseMillsï¼‰ï¼Œè®©è™šæ‹Ÿæœºè‡ªå·±å®Œæˆè°ƒä¼˜å·¥ä½œã€‚</li>
<li>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“CPUæ•°é‡å°äº8ä¸ªæ—¶ï¼ŒParallelGCThreadsçš„å€¼ç­‰äºCPUæ•°é‡ï¼›åœ¨CPUæ•°é‡å¤§äº8ä¸ªæ—¶ï¼ŒParallelGCThreadsçš„å€¼ç­‰äº3 + [5 * CPU_COUNT / 8]ã€‚</li>
<li>JDK8é»˜è®¤ä½¿ç”¨Parallelå¹¶è¡Œå›æ”¶å™¨ï¼ŒåæœŸçš„JDKä¸­å¹´è½»ä»£å’Œè€å¹´ä»£ä»»æ„ä¸€ä¸ªå¼€å¯Parallelå¹¶è¡Œå›æ”¶å™¨ï¼Œå¦ä¸€ä¸ªä¹Ÿä¼šè¢«å¼€å¯ï¼Œäº’ç›¸æ¿€æ´»ã€‚</li>
</ul>
<h3 id="15-6-4ï¸âƒ£-CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ"><a href="#15-6-4ï¸âƒ£-CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ" class="headerlink" title="15.6 4ï¸âƒ£ CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ"></a>15.6 4ï¸âƒ£ CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ</h3><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li>åœ¨JDK1.5æ—¶æœŸï¼ŒHotSpotæ¨å‡ºäº†ä¸€æ¬¾åœ¨å¼ºäº¤äº’åº”ç”¨ä¸­å‡ ä¹å¯è®¤ä¸ºæœ‰åˆ’æ—¶ä»£æ„ä¹‰çš„åƒåœ¾å›æ”¶å™¨ï¼šCMS(Concurrent-Mark-Sweep)å›æ”¶å™¨ï¼Œè¿™æ¬¾å›æ”¶å™¨æ˜¯HotSpotè™šæ‹Ÿæœºä¸­ç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘å›æ”¶å™¨ï¼Œå®ƒç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å·¥ä½œã€‚</li>
<li>CMSå›æ”¶å™¨çš„å…³æ³¨ç‚¹æ˜¯å°½å¯èƒ½ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ã€‚åœé¡¿æ—¶é—´è¶ŠçŸ­ï¼ˆä½å»¶è¿Ÿï¼‰å°±è¶Šé€‚åˆä¸ç”¨æˆ·äº¤äº’çš„ç¨‹åºï¼Œè‰¯å¥½çš„å“åº”é€Ÿåº¦èƒ½æå‡ç”¨æˆ·ä½“éªŒã€‚</li>
<li>CMSçš„åƒåœ¾æ”¶é›†ç®—æ³•é‡‡ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œå¹¶ä¸”ä¹Ÿä¼šSTWã€‚</li>
<li>ä¸å¹¸çš„æ˜¯ï¼ŒCMSä½œä¸ºè€å¹´ä»£çš„å›æ”¶å™¨ï¼Œå´æ— æ³•ä¸JDK1.4.0ä¸­å·²ç»å­˜åœ¨çš„æ–°ç”Ÿä»£å›æ”¶å™¨Parallel Scavengeé…åˆå·¥ä½œï¼Œæ‰€ä»¥åœ¨JDK1.5ä¸­ä½¿ç”¨CMSæ¥æ”¶é›†è€å¹´ä»£çš„æ—¶å€™ï¼Œæ–°ç”Ÿä»£åªèƒ½é€‰æ‹©ParNewæˆ–è€…Serialæ”¶é›†å™¨ä¸­çš„ä¸€ä¸ªã€‚</li>
<li>JDK9ä¸­CMSè¢«æ ‡è®°ä¸ºDeprecateï¼ŒJDK14ä¸­CMSè¢«å½»åº•åˆ é™¤ã€‚</li>
<li>åœ¨G1å‡ºç°ä¹‹å‰ï¼ŒCMSçš„ä½¿ç”¨è¿˜æ˜¯éå¸¸å¹¿æ³›çš„ã€‚ä¸€ç›´åˆ°ä»Šå¤©ï¼Œä»ç„¶æœ‰å¾ˆå¤šç³»ç»Ÿä½¿ç”¨CMSã€‚</li>
</ul>
<blockquote>
<p>ğŸ” è¿‡ç¨‹</p>
</blockquote>
<p>CMSæ•´ä¸ªè¿‡ç¨‹æ¯”ä¹‹å‰çš„æ”¶é›†å™¨è¦å¤æ‚ï¼Œæ•´ä¸ªè¿‡ç¨‹åˆ†ä¸º4ä¸ªä¸»è¦é˜¶æ®µï¼Œå³åˆå§‹æ ‡è®°é˜¶æ®µã€å¹¶å‘æ ‡è®°é˜¶æ®µã€é‡æ–°æ ‡è®°é˜¶æ®µå’Œå¹¶å‘æ¸…é™¤é˜¶æ®µã€‚</p>
<p>ï¼ˆ1ï¼‰åˆå§‹æ ‡è®°ï¼ˆInitial-Markï¼‰é˜¶æ®µï¼šåœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼Œç¨‹åºæ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹éƒ½å°†ä¼šå› ä¸ºSTWæœºåˆ¶è€Œå‡ºç°çŸ­æš‚çš„æš‚åœï¼Œè¿™ä¸ªé˜¶æ®µçš„ä¸»è¦ä»»åŠ¡ä»…ä»…åªæ˜¯æ ‡è®°å‡ºGC Rootsèƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ã€‚ä¸€æ—¦æ ‡è®°å®Œæˆä¹‹åå°±ä¼šæ¢å¤ä¹‹å‰è¢«æš‚åœçš„æ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚ç”±äºç›´æ¥å…³è”å¯¹è±¡æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™é‡Œçš„é€Ÿåº¦éå¸¸å¿«ã€‚</p>
<p>ï¼ˆ2ï¼‰å¹¶å‘æ ‡è®°ï¼ˆConcurrent-Markï¼‰é˜¶æ®µï¼šä»GC Rootsçš„ç›´æ¥å…³è”å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹è€—æ—¶è¾ƒé•¿ä½†æ˜¯ä¸éœ€è¦åœé¡¿ç”¨æˆ·çº¿ç¨‹ï¼Œå¯ä»¥ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸€èµ·å¹¶å‘è¿è¡Œã€‚</p>
<p>ï¼ˆ3ï¼‰é‡æ–°æ ‡è®°ï¼ˆRemarkï¼‰é˜¶æ®µï¼šç”±äºåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µä¸­ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹ä¼šå’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œï¼Œå› æ­¤ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´ï¼Œå› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œè¿™ä¸ªé˜¶æ®µçš„åœé¡¿æ—¶é—´é€šå¸¸ä¼šæ¯”åˆå§‹æ ‡è®°é˜¶æ®µç¨é•¿ä¸€äº›ï¼Œä½†ä¹Ÿè¿œæ¯”å¹¶å‘æ ‡è®°é˜¶æ®µçš„æ—¶é—´çŸ­ã€‚</p>
<p>ï¼ˆ4ï¼‰å¹¶å‘æ¸…é™¤ï¼ˆConcurrent-Sweepï¼‰é˜¶æ®µï¼šæ­¤é˜¶æ®µæ¸…ç†åˆ é™¤æ ‡è®°é˜¶æ®µåˆ¤æ–­çš„å·²ç»æ­»äº¡çš„å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜ç©ºé—´ã€‚ç”±äºä¸éœ€è¦ç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µä¹Ÿæ˜¯å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å¹¶å‘çš„ã€‚</p>
<p>å°½ç®¡CMSæ”¶é›†å™¨é‡‡ç”¨çš„æ˜¯å¹¶å‘å›æ”¶ï¼ˆéç‹¬å å¼ï¼‰ï¼Œä½†æ˜¯åœ¨å…¶åˆå§‹åŒ–æ ‡è®°å’Œå†æ¬¡æ ‡è®°è¿™ä¸¤ä¸ªé˜¶æ®µä¸­ä»ç„¶éœ€è¦æ‰§è¡Œâ€œStop-the-Worldâ€æœºåˆ¶æš‚åœç¨‹åºä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œä¸è¿‡æš‚åœæ—¶é—´å¹¶ä¸ä¼šå¤ªé•¿ï¼Œå› æ­¤å¯ä»¥è¯´æ˜ç›®å‰æ‰€æœ‰çš„åƒåœ¾æ”¶é›†å™¨éƒ½åšä¸åˆ°å®Œå…¨ä¸éœ€è¦â€œstop-the-Worldâ€ï¼Œåªæ˜¯å°½å¯èƒ½åœ°ç¼©çŸ­æš‚åœæ—¶é—´ã€‚</p>
<p>ç”±äºæœ€è€—è´¹æ—¶é—´çš„å¹¶å‘æ ‡è®°ä¸å¹¶å‘æ¸…é™¤é˜¶æ®µéƒ½ä¸éœ€è¦æš‚åœå·¥ä½œï¼Œæ‰€ä»¥æ•´ä½“çš„å›æ”¶æ˜¯ä½åœé¡¿çš„ã€‚</p>
<p>å¦å¤–ï¼Œç”±äºåœ¨åƒåœ¾æ”¶é›†é˜¶æ®µç”¨æˆ·çº¿ç¨‹æ²¡æœ‰ä¸­æ–­ï¼Œæ‰€ä»¥åœ¨CMSå›æ”¶è¿‡ç¨‹ä¸­ï¼Œè¿˜åº”è¯¥ç¡®ä¿åº”ç”¨ç¨‹åºç”¨æˆ·çº¿ç¨‹æœ‰è¶³å¤Ÿçš„å†…å­˜å¯ç”¨ã€‚å› æ­¤ï¼ŒCMSæ”¶é›†å™¨ä¸èƒ½åƒå…¶ä»–æ”¶é›†å™¨é‚£æ ·ç­‰åˆ°è€å¹´ä»£å‡ ä¹å®Œå…¨è¢«å¡«æ»¡äº†å†è¿›è¡Œæ”¶é›†ï¼Œè€Œæ˜¯å½“å †å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ°æŸä¸€é˜ˆå€¼æ—¶ï¼Œä¾¿å¼€å§‹è¿›è¡Œå›æ”¶ï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºåœ¨CMSå·¥ä½œè¿‡ç¨‹ä¸­ä¾ç„¶æœ‰è¶³å¤Ÿçš„ç©ºé—´æ”¯æŒåº”ç”¨ç¨‹åºè¿è¡Œã€‚è¦æ˜¯CMSè¿è¡ŒæœŸé—´é¢„ç•™çš„å†…å­˜æ— æ³•æ»¡è¶³ç¨‹åºéœ€è¦ï¼Œå°±ä¼šå‡ºç°ä¸€æ¬¡â€œConcurrent Mode Failureâ€ å¤±è´¥ï¼Œè¿™æ—¶è™šæ‹Ÿæœºå°†å¯åŠ¨åå¤‡é¢„æ¡ˆï¼šä¸´æ—¶å¯ç”¨Serial oldæ”¶é›†å™¨æ¥é‡æ–°è¿›è¡Œè€å¹´ä»£çš„åƒåœ¾æ”¶é›†ï¼Œè¿™æ ·åœé¡¿æ—¶é—´å°±å¾ˆé•¿äº†ã€‚</p>
<p>CMSæ”¶é›†å™¨çš„åƒåœ¾æ”¶é›†ç®—æ³•é‡‡ç”¨çš„æ˜¯æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡æ‰§è¡Œå®Œå†…å­˜å›æ”¶åï¼Œç”±äºè¢«æ‰§è¡Œå†…å­˜å›æ”¶çš„æ— ç”¨å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ææœ‰å¯èƒ½æ˜¯ä¸è¿ç»­çš„ä¸€äº›å†…å­˜å—ï¼Œä¸å¯é¿å…åœ°å°†ä¼šäº§ç”Ÿä¸€äº›å†…å­˜ç¢ç‰‡ã€‚é‚£ä¹ˆCMSåœ¨ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´æ—¶ï¼Œå°†æ— æ³•ä½¿ç”¨æŒ‡é’ˆç¢°æ’ï¼ˆBump the Pointerï¼‰æŠ€æœ¯ï¼Œè€Œåªèƒ½å¤Ÿé€‰æ‹©ç©ºé—²åˆ—è¡¨ï¼ˆFree Listï¼‰æ‰§è¡Œå†…å­˜åˆ†é…ã€‚</p>
<p>é‚£ä¹ˆCMSä¸ºä»€ä¹ˆä¸é‡‡ç”¨æ ‡è®°æ•´ç†ç®—æ³•å‘¢ï¼Ÿå› ä¸ºå¹¶å‘æ”¶é›†åƒåœ¾çš„æ—¶å€™ï¼Œç”¨æˆ·çº¿ç¨‹ä¸ä¼šæš‚åœï¼Œæ•´ç†å†…å­˜ä¼šå¯¼è‡´ç”¨æˆ·çº¿ç¨‹çš„å¯¹è±¡å†…å­˜åœ°å€æ”¹å˜ã€‚</p>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¹¶å‘æ”¶é›†</li>
<li>ä½å»¶è¿Ÿ</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚å¯¼è‡´å¹¶å‘æ¸…é™¤åï¼Œç”¨æˆ·çº¿ç¨‹å¯ç”¨çš„ç©ºé—´ä¸è¶³ã€‚åœ¨æ— æ³•åˆ†é…å¤§å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œä¸å¾—ä¸æå‰è§¦å‘Full GCã€‚</li>
<li>CMSæ”¶é›†å™¨å¯¹CPUèµ„æºéå¸¸æ•æ„Ÿã€‚åœ¨å¹¶å‘é˜¶æ®µï¼Œå®ƒè™½ç„¶ä¸ä¼šå¯¼è‡´ç”¨æˆ·åœé¡¿ï¼Œä½†æ˜¯ä¼šå› ä¸ºå ç”¨äº†ä¸€éƒ¨åˆ†çº¿ç¨‹è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢ï¼Œæ€»ååé‡ä¼šé™ä½ã€‚</li>
<li>CMSæ”¶é›†å™¨æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ã€‚åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µç”±äºç¨‹åºçš„å·¥ä½œçº¿ç¨‹å’Œåƒåœ¾æ”¶é›†çº¿ç¨‹æ˜¯åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œçš„ï¼Œé‚£ä¹ˆåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µå¦‚æœäº§ç”Ÿæ–°çš„åƒåœ¾å¯¹è±¡ï¼ŒCMSå°†æ— æ³•å¯¹è¿™äº›åƒåœ¾å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œæœ€ç»ˆä¼šå¯¼è‡´è¿™äº›æ–°äº§ç”Ÿçš„åƒåœ¾å¯¹è±¡æ²¡æœ‰è¢«åŠæ—¶å›æ”¶ï¼Œä»è€Œåªèƒ½åœ¨ä¸‹ä¸€æ¬¡æ‰§è¡ŒGCæ—¶é‡Šæ”¾è¿™äº›ä¹‹å‰è¿èƒŒå›æ”¶çš„å†…å­˜ç©ºé—´ã€‚</li>
</ul>
<blockquote>
<p>âš™ï¸ é…ç½®</p>
</blockquote>
<ul>
<li><code>-XX:+UseConcMarkSweepGC</code>ï¼šæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨CMSæ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ã€‚å¼€å¯è¯¥å‚æ•°åè‡ªåŠ¨å°†<code>-XX:+UseParNewGC</code>æ‰“å¼€ï¼Œå³ï¼šParNew(Young) + CMS(Old) + Serial Oldçš„ç»„åˆã€‚</li>
<li><code>-XX:CMSInitiatingOccupanyFraction</code>ï¼šè®¾ç½®å †å†…å­˜ä½¿ç”¨ç‡çš„é˜ˆå€¼ï¼Œä¸€æ—¦è¾¾åˆ°è¯¥é˜ˆå€¼ï¼Œä¾¿å¼€å§‹å›æ”¶ã€‚</li>
<li><code>-XX:+UseCMSCompactAtFullCollection</code>ï¼šç”¨äºæŒ‡å®šåœ¨æ‰§è¡Œå®ŒFull GCåå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©æ•´ç†ï¼Œä»¥æ­¤é¿å…å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿã€‚ä¸è¿‡ç”±äºå†…å­˜å‹ç¼©æ•´ç†è¿‡ç¨‹æ— æ³•å¹¶å‘æ‰§è¡Œï¼Œæ‰€å¸¦æ¥çš„é—®é¢˜å°±æ˜¯åœé¡¿æ—¶é—´å˜å¾—æ›´é•¿äº†ã€‚</li>
<li><code>-XX:CMSFullGCsBeforeCompaction</code>ï¼šè®¾ç½®åœ¨æ‰§è¡Œå¤šå°‘æ¬¡Full GCåå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©æ•´ç†ã€‚</li>
<li><code>-XX:ParallelCMSThreads</code>ï¼šè®¾ç½®CMSçš„çº¿ç¨‹æ•°é‡ã€‚CMSé»˜è®¤å¯åŠ¨çš„çº¿ç¨‹æ•°æ˜¯ï¼ˆParallelGCThreads + 3ï¼‰/ 4ï¼ŒParallelGCThreadsæ˜¯å¹´è½»ä»£å¹¶è¡Œå›æ”¶å™¨çš„çº¿ç¨‹æ•°ã€‚å½“CPUèµ„æºæ¯”è¾ƒç´§å¼ æ—¶ï¼Œå—åˆ°CMSæ”¶é›†å™¨çº¿ç¨‹çš„å½±å“ï¼Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½åœ¨åƒåœ¾å›æ”¶é˜¶æ®µä¼šéå¸¸ç³Ÿç³•ã€‚</li>
</ul>
<blockquote>
<p>âœ¨ å°ç»“</p>
</blockquote>
<ul>
<li>å¦‚æœä½ æœ€æƒ³è¦æœ€å°åŒ–åœ°ä½¿ç”¨å†…å­˜å’Œå¹¶è¡Œå¼€é”€ï¼Œé€‰æ‹©Serial GC</li>
<li>å¦‚æœä½ æƒ³è¦æœ€å¤§åŒ–åº”ç”¨ç¨‹åºçš„ååé‡ï¼Œé€‰æ‹©Parallel GC</li>
<li>å¦‚æœä½ æƒ³è¦æœ€å°åŒ–GCçš„ä¸­æ–­æˆ–è€…åœé¡¿æ—¶é—´ï¼Œé€‰æ‹©CMS GC</li>
</ul>
<h3 id="15-7-5ï¸âƒ£-G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼"><a href="#15-7-5ï¸âƒ£-G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼" class="headerlink" title="15.7 5ï¸âƒ£ G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼"></a>15.7 5ï¸âƒ£ G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼</h3><blockquote>
<p>ğŸŒƒ èƒŒæ™¯</p>
</blockquote>
<p>éšç€åº”ç”¨ç¨‹åºæ‰€åº”å¯¹çš„ä¸šåŠ¡è¶Šæ¥è¶Šåºå¤§ã€å¤æ‚ï¼Œç”¨æˆ·è¶Šæ¥è¶Šå¤šï¼Œæ²¡æœ‰GCå°±ä¸èƒ½ä¿è¯åº”ç”¨ç¨‹åºæ­£å¸¸è¿›è¡Œï¼Œè€Œé€ æˆSTWçš„GCåˆè·Ÿä¸ä¸Šå®é™…çš„éœ€æ±‚ï¼Œæ‰€ä»¥æ‰ä¼šä¸æ–­å°è¯•å¯¹GCè¿›è¡Œä¼˜åŒ–ã€‚G1(Garbage-First)åƒåœ¾å›æ”¶å™¨æ˜¯åœ¨Java7 update 4ä¹‹åå¼•å…¥çš„ä¸€ä¸ªæ–°çš„åƒåœ¾å›æ”¶å™¨ï¼Œæ˜¯å½“ä»Šå›æ”¶å™¨æŠ€æœ¯å‘å±•çš„æœ€å‰æ²¿æˆæœä¹‹ä¸€ã€‚</p>
<p>ä¸æ­¤åŒæ—¶ï¼Œä¸ºäº†é€‚åº”ç°åœ¨ä¸æ–­æ‰©å¤§çš„å†…å­˜å’Œä¸æ–­å¢åŠ çš„å¤„ç†å™¨æ•°é‡ï¼Œè¿›ä¸€æ­¥é™ä½æš‚åœæ—¶é—´ï¼ŒåŒæ—¶å…¼é¡¾è‰¯å¥½çš„ååé‡ã€‚</p>
<p>å®˜æ–¹ç»™G1è®¾å®šçš„ç›®æ ‡æ˜¯åœ¨å»¶è¿Ÿå¯æ§çš„æƒ…å†µä¸‹è·å¾—å°½å¯èƒ½é«˜çš„ååé‡ï¼Œæ‰€ä»¥æ‰æ‹…èµ·â€œå…¨åŠŸèƒ½æ”¶é›†å™¨â€çš„è´£ä»»ä¸æœŸæœ›ã€‚</p>
<blockquote>
<p>âš¡ åå­—</p>
</blockquote>
<ul>
<li>å› ä¸ºG1æ˜¯ä¸€ä¸ªå¹¶è¡Œå›æ”¶å™¨ï¼Œå®ƒæŠŠå †å†…å­˜åˆ†å‰²ä¸ºå¾ˆå¤šä¸ç›¸å…³çš„åŒºåŸŸï¼ˆRegionï¼‰ï¼ˆç‰©ç†ä¸Šä¸è¿ç»­çš„ï¼‰ã€‚ä½¿ç”¨ä¸åŒçš„Regionæ¥è¡¨ç¤ºEdenã€å¹¸å­˜è€…0åŒºã€å¹¸å­˜è€…1åŒºï¼Œè€å¹´ä»£ç­‰ã€‚</li>
<li>G1 GCæœ‰è®¡åˆ’åœ°é¿å…åœ¨æ•´ä¸ªJavaå †ä¸­è¿›è¡Œå…¨åŒºåŸŸçš„åƒåœ¾æ”¶é›†ã€‚G1è·Ÿè¸ªå„ä¸ªRegioné‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„åŒºåŸŸã€‚</li>
<li>ç”±äºè¿™ç§æ–¹å¼çš„ä¾§é‡ç‚¹åœ¨äºå›æ”¶åƒåœ¾æœ€å¤§é‡çš„Regionï¼Œæ‰€ä»¥æˆ‘ä»¬ç»™G1èµ·ä¸€ä¸ªåå­—ï¼šåƒåœ¾ä¼˜å…ˆï¼ˆGarbage-Firstï¼‰ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<p>G1æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„åƒåœ¾å›æ”¶å™¨ï¼Œä¸»è¦é’ˆå¯¹é…å¤‡å¤šæ ¸CPUåŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨ï¼Œä»¥æé«˜æ¦‚ç‡æ»¡è¶³GCåœé¡¿æ—¶é—´çš„åŒæ—¶ï¼Œè¿˜å…¼å…·é«˜ååé‡çš„æ€§èƒ½ç‰¹å¾ã€‚</p>
<p>åœ¨JDK1.7ç‰ˆæœ¬æ­£å¼å¯ç”¨ï¼Œç§»é™¤äº†Experimentalçš„æ ‡è¯†ã€‚åœ¨JDK8ä¸­è¿˜ä¸æ˜¯é»˜è®¤çš„åƒåœ¾å›æ”¶å™¨ï¼Œéœ€è¦ä½¿ç”¨<code>-XX:+UseG1GC</code>æ¥å¯ç”¨ã€‚åœ¨JDK9ä»¥åæˆä¸ºé»˜è®¤åƒåœ¾å›æ”¶å™¨ï¼Œå–ä»£äº†CMSå›æ”¶å™¨ä»¥åŠParallel + Parallel Oldç»„åˆï¼Œè¢«Oracleå®˜æ–¹ç§°ä¸ºå…¨åŠŸèƒ½çš„åƒåœ¾æ”¶é›†å™¨ã€‚</p>
<blockquote>
<p>ğŸŒ  ç‰¹ç‚¹</p>
</blockquote>
<p>ä¸å…¶å®ƒçš„GCå›æ”¶å™¨ç›¸æ¯”ï¼ŒG1ä½¿ç”¨äº†å…¨æ–°çš„åˆ†åŒºç®—æ³•ï¼Œç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆ1ï¼‰å¹¶è¡Œä¸å¹¶å‘</p>
<ul>
<li>å¹¶è¡Œæ€§ï¼šG1åœ¨å›æ”¶æœŸé—´ï¼Œå¯ä»¥æœ‰å¤šä¸ªGCçº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œæœ‰æ•ˆåˆ©ç”¨å¤šæ ¸è®¡ç®—èƒ½åŠ›ã€‚</li>
<li>å¹¶å‘æ€§ï¼šG1æ‹¥æœ‰ä¸åº”ç”¨ç¨‹åºäº¤æ›¿æ‰§è¡Œçš„èƒ½åŠ›ï¼Œéƒ¨åˆ†å·¥ä½œå¯ä»¥å’Œåº”ç”¨ç¨‹åºåŒæ—¶æ‰§è¡Œï¼Œå› æ­¤ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸ä¼šåœ¨æ•´ä¸ªå›é¦–é˜¶æ®µå‘ç”Ÿå®Œå…¨é˜»å¡åº”ç”¨ç¨‹åºçš„æƒ…å†µã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰åˆ†ä»£æ”¶é›†</p>
<ul>
<li>ä»åˆ†ä»£ä¸Šçœ‹ï¼ŒG1ä¾ç„¶å±äºåˆ†ä»£å‹åƒåœ¾å›æ”¶å™¨ï¼Œå®ƒä¼šåŒºåˆ†å¹´è½»ä»£å’Œè€å¹´ä»£ï¼Œå¹´è½»ä»£ä¾ç„¶æœ‰EdenåŒºå’ŒSurvivoråŒºã€‚ä½†ä»å †çš„ç»“æ„ä¸Šçœ‹ï¼Œå®ƒä¸è¦æ±‚æ•´ä¸ªEdenåŒºã€å¹´è½»ä»£æˆ–è€…è€å¹´ä»£éƒ½æ˜¯è¿ç»­çš„ï¼Œä¹Ÿä¸å†åšæŒå›ºå®šå¤§å°å’Œå›ºå®šæ•°é‡ã€‚</li>
<li>å°†å †ç©ºé—´åˆ†ä¸ºè‹¥å¹²ä¸ªåŒºåŸŸï¼Œè¿™äº›åŒºåŸŸä¸­åŒ…å«äº†é€»è¾‘ä¸Šçš„å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚</li>
<li>å’Œä¹‹å‰çš„å„ç±»å›æ”¶å™¨ä¸åŒï¼Œå®ƒåŒæ—¶å…¼é¡¾å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚å¯¹æ¯”å…¶ä»–å›æ”¶å™¨ï¼Œæˆ–è€…å·¥ä½œåœ¨å¹´è½»ä»£ã€æˆ–è€…å·¥ä½œåœ¨è€å¹´ä»£ã€‚</li>
</ul>
<p>ï¼ˆ3ï¼‰ç©ºé—´æ•´åˆ</p>
<ul>
<li>CMSï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•ã€å†…å­˜ç¢ç‰‡ã€è‹¥å¹²æ¬¡GCåä¸€æ¬¡ç¢ç‰‡æ•´ç†ã€‚</li>
<li>G1å°†å†…å­˜åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªçš„regionï¼Œå†…å­˜çš„å›æ”¶æ˜¯ä»¥regionä½œä¸ºåŸºæœ¬å•ä½çš„ã€‚regionä¹‹é—´æ˜¯å¤åˆ¶ç®—æ³•ï¼Œä½†æ•´ä½“ä¸Šå®é™…å¯çœ‹åšæ˜¯æ ‡è®°-å‹ç¼©ç®—æ³•ï¼Œä¸¤ç§ç®—æ³•éƒ½å¯ä»¥é¿å…å†…å­˜ç¢ç‰‡ã€‚è¿™ç§ç‰¹æ€§æœ‰åˆ©äºç¨‹åºé•¿æ—¶é—´è¿è¡Œï¼Œåˆ†é…å¤§å¯¹è±¡æ—¶ä¸ä¼šå› ä¸ºæ— æ³•æ‰¾åˆ°è¿ç»­å†…å­˜ç©ºé—´è€Œæå‰è§¦å‘ä¸‹ä¸€æ¬¡GCã€‚å°¤å…¶æ˜¯å½“Javaå †éå¸¸å¤§çš„æ—¶å€™ã€‚G1çš„ä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ã€‚</li>
</ul>
<p>ï¼ˆ4ï¼‰å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹</p>
<p>è¿™æ˜¯G1ç›¸å¯¹äºCMSçš„å¦ä¸€å¤§ä¼˜åŠ¿ï¼ŒG1é™¤äº†è¿½æ±‚ä½åœé¡¿å¤–ï¼Œè¿˜èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼Œèƒ½è®©ä½¿ç”¨è€…æ˜ç¡®æŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸ºMæ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œæ¶ˆè€—åœ¨åƒåœ¾æ”¶é›†ä¸Šçš„æ—¶é—´ä¸å¾—è¶…è¿‡Næ¯«ç§’ã€‚</p>
<ul>
<li>ç”±äºåˆ†åŒºçš„åŸå› ï¼ŒG1å¯ä»¥åªé€‰å–éƒ¨åˆ†åŒºåŸŸè¿›è¡Œå†…å­˜å›æ”¶ï¼Œè¿™æ ·ç¼©å°äº†å›æ”¶çš„èŒƒå›´ï¼Œå› æ­¤å¯¹äºå…¨å±€åœé¡¿æƒ…å†µçš„å‘ç”Ÿä¹Ÿèƒ½å¾—åˆ°è¾ƒå¥½çš„æ§åˆ¶ã€‚</li>
<li>G1è·Ÿè¸ªå„ä¸ªregioné‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€çš„æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„regionã€‚ä¿è¯äº†G1å›æ”¶å™¨åœ¨æœ‰é™çš„æ—¶é—´å†…å¯ä»¥è·å–å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡ã€‚</li>
<li>ç›¸æ¯”äºCMS GCï¼ŒG1æœªå¿…èƒ½åšåˆ°CMSåœ¨åšå¥½çš„æƒ…å†µä¸‹çš„å»¶æ—¶åœé¡¿ï¼Œä½†æ˜¯æœ€å·®æƒ…å†µè¦å¥½å¾ˆå¤šã€‚</li>
</ul>
<blockquote>
<p>ğŸ“› ç¼ºç‚¹</p>
</blockquote>
<p>ç›¸è¾ƒäºCMSï¼ŒG1è¿˜ä¸å…·å¤‡å…¨æ–¹ä½ã€å‹å€’æ€§ä¼˜åŠ¿ã€‚æ¯”å¦‚åœ¨ç”¨æˆ·ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒG1æ— è®ºæ˜¯ä¸ºäº†åƒåœ¾æ”¶é›†äº§ç”Ÿçš„å†…å­˜å ç”¨è¿˜æ˜¯ç¨‹åºè¿è¡Œæ—¶çš„é¢å¤–æ‰§è¡Œè´Ÿè½½éƒ½è¦æ¯”CMSè¦é«˜ã€‚</p>
<p>ä»ç»éªŒä¸Šæ¥è¯´ï¼Œåœ¨å°å†…å­˜åº”ç”¨ä¸ŠCMSçš„è¡¨ç°å¤§æ¦‚ç‡ä¼šä¼˜äºG1ï¼Œè€ŒG1åœ¨å¤§å†…å­˜åº”ç”¨ä¸Šåˆ™å‘æŒ¥å…¶ä¼˜åŠ¿ã€‚å¹³è¡¡ç‚¹åœ¨6~8GBä¹‹é—´ã€‚</p>
<blockquote>
<p>âš™ï¸ é…ç½®</p>
</blockquote>
<ul>
<li><code>-XX:+UseG1GC</code>ï¼šæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨G1æ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ã€‚</li>
<li><code>-XX:G1HeapRegionSize</code>ï¼šè®¾ç½®æ¯ä¸ªregionçš„å¤§å°ã€‚å€¼æ˜¯2çš„å¹‚ï¼ŒèŒƒå›´æ˜¯1MBåˆ°32MBä¹‹é—´ï¼Œç›®æ ‡æ˜¯æ ¹æ®æœ€å°çš„Javaå †å¤§å°åˆ’åˆ†å‡ºçº¦2048ä¸ªåŒºåŸŸã€‚é»˜è®¤æ˜¯å †å†…å­˜çš„1/2000ã€‚</li>
<li><code>-XX:MaxGCPauseMills</code>ï¼šè®¾ç½®æœŸæœ›è¾¾åˆ°çš„æœ€å¤§GCåœé¡¿æ—¶é—´æŒ‡æ ‡ï¼ˆJVMä¼šå°½åŠ›å®ç°ï¼Œä½†ä¸ä¿è¯è¾¾åˆ°ï¼‰ã€‚é»˜è®¤å€¼æ˜¯200msã€‚</li>
<li><code>-XX:ParallelGCThread</code>ï¼šè®¾ç½®STWå·¥ä½œçº¿ç¨‹çš„å€¼ã€‚æœ€å¤šè®¾ç½®ä¸º8ã€‚</li>
<li><code>-XX:ConcGCThreads</code>ï¼šè®¾ç½®å¹¶å‘æ ‡è®°çš„çº¿ç¨‹æ•°ã€‚å°†nè®¾ç½®ä¸ºå¹¶å‘åƒåœ¾å›æ”¶çº¿ç¨‹æ•°ï¼ˆParallelGCThreadsï¼‰çš„1/4å·¦å³ã€‚</li>
<li><code>-XX:InitiatingHeapOccupancyPercent</code>ï¼šè®¾ç½®è§¦å‘å¹¶å‘GCå‘¨æœŸçš„Javaå †å ç”¨ç‡é˜ˆå€¼ã€‚è¶…è¿‡æ­¤å€¼ï¼Œå°±è§¦å‘GCã€‚é»˜è®¤å€¼æ˜¯45ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’» ä½¿ç”¨</p>
</blockquote>
<p>G1çš„è®¾è®¡åŸåˆ™å°±æ˜¯ç®€åŒ–JVMæ€§èƒ½è°ƒä¼˜ï¼Œå¼€å‘äººå‘˜åªéœ€è¦ç®€å•çš„ä¸‰æ­¥å³å¯å®Œæˆè°ƒä¼˜ï¼š</p>
<p>ï¼ˆ1ï¼‰å¼€å¯G1åƒåœ¾å›æ”¶å™¨</p>
<p>ï¼ˆ2ï¼‰è®¾ç½®å †çš„æœ€å¤§å†…å­˜</p>
<p>ï¼ˆ3ï¼‰è®¾ç½®æœ€å¤§çš„åœé¡¿æ—¶é—´</p>
<p>G1æä¾›äº†ä¸‰ç§åƒåœ¾å›æ”¶æ¨¡å¼ï¼šYoung GCã€Mixed GCå’ŒFull GCï¼Œåœ¨ä¸åŒçš„æ¡ä»¶ä¸‹è¢«è§¦å‘ã€‚</p>
<blockquote>
<p>ğŸ”® é€‚ç”¨åœºæ™¯</p>
</blockquote>
<ul>
<li><p>é¢å‘æœåŠ¡ç«¯åº”ç”¨ï¼Œé’ˆå¯¹å…·æœ‰å¤§å†…å­˜ã€å¤šå¤„ç†å™¨çš„æœºå™¨ã€‚</p>
</li>
<li><p>æœ€ä¸»è¦çš„åº”ç”¨éœ€è¦ä½GCå»¶è¿Ÿï¼Œå¹¶å…·æœ‰å¤§å †çš„åº”ç”¨ç¨‹åºæä¾›è§£å†³æ–¹æ¡ˆã€‚</p>
</li>
<li><p>ç”¨æ¥æ›¿æ¢æ‰JDK1.5ä¸­çš„CMSæ”¶é›†å™¨ï¼Œåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼Œä½¿ç”¨G1æ¯”CMSå¥½ï¼š</p>
<ul>
<li>è¶…è¿‡50%çš„Javaå †è¢«æ´»åŠ¨æ•°æ®å ç”¨</li>
<li>å¯¹è±¡åˆ†é…é¢‘ç‡æˆ–å¹´ä»£æå‡é¢‘ç‡å˜åŒ–å¾ˆå¤§</li>
<li>GCåœé¡¿æ—¶é—´è¿‡é•¿</li>
</ul>
</li>
<li><p>HotSpotåƒåœ¾å›æ”¶å™¨é‡Œï¼Œé™¤äº†G1ä»¥å¤–ï¼Œå…¶ä»–çš„åƒåœ¾å›æ”¶å™¨ä½¿ç”¨å†…ç½®çš„JVMçº¿ç¨‹æ‰§è¡ŒGCçš„å¤šçº¿ç¨‹æ“ä½œï¼Œè€ŒG1 GCå¯ä»¥é‡‡ç”¨åº”ç”¨ç¨‹åºæ‰¿æ‹…åå°è¿è¡Œçš„GCå·¥ä½œï¼Œå³å½“JVMçš„GCçº¿ç¨‹å¤„ç†é€Ÿåº¦æ…¢æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨åº”ç”¨ç¨‹åºçº¿ç¨‹å¸®åŠ©åŠ é€Ÿåƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ”² åˆ†åŒºregionï¼šåŒ–æ•´ä¸ºé›¶</p>
</blockquote>
<p>ä½¿ç”¨G1å›æ”¶å™¨æ—¶ï¼Œå®ƒå°†æ•´ä¸ªJavaå †åˆ’åˆ†ä¸ºçº¦2048 ä¸ªå¤§å°ç›¸åŒçš„ç‹¬ç«‹regionå—ï¼Œæ¯ä¸ªregionå—å¤§å°æ ¹æ®å †ç©ºé—´çš„å®é™…å¤§å°è€Œå®šï¼Œæ•´ä½“è¢«æ§åˆ¶åœ¨1MBåˆ°32MBä¹‹é—´ï¼Œä¸”ä¸º2çš„Næ¬¡å¹‚ï¼Œå³1MBï¼Œ2MBï¼Œ4MBï¼Œ8MBï¼Œ16MBï¼Œ32MBã€‚å¯ä»¥é€šè¿‡<code>-XX:G1HeapRegionSize</code>è®¾å®šã€‚æ‰€æœ‰çš„regionå¤§å°éƒ½ç›¸åŒï¼Œä¸”åœ¨JVMç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šè¢«æ”¹å˜ã€‚</p>
<p>è™½ç„¶è¿˜ä¿ç•™ç€æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸å†æ˜¯ç‰©ç†éš”ç¦»çš„äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸€éƒ¨åˆ†regionï¼ˆä¸éœ€è¦è¿ç»­ï¼‰çš„é›†åˆã€‚é€šè¿‡regionçš„åŠ¨æ€åˆ†é…æ–¹å¼å®ç°é€»è¾‘ä¸Šçš„è¿ç»­ã€‚</p>
<p>ä¸€ä¸ªregionæœ‰å¯èƒ½å±äºEdenï¼ŒSurvivoræˆ–è€…Oldå†…å­˜åŒºåŸŸã€‚ä½†æ˜¯ä¸€ä¸ªregionåªå¯èƒ½å±äºä¸€ä¸ªè§’è‰²ã€‚G1åƒåœ¾å›æ”¶å™¨è¿˜å¢åŠ äº†ä¸€ç§æ–°çš„å†…å­˜åŒºåŸŸï¼Œå«åšHumongouså†…å­˜åŒºåŸŸã€‚</p>
<p>è®¾ç½®Humongousçš„åŸå› ï¼šå¯¹äºå †ä¸­çš„å¤§å¯¹è±¡ï¼Œé»˜è®¤ç›´æ¥ä¼šè¢«åˆ†é…åˆ°è€å¹´ä»£ï¼Œä½†æ˜¯å¦‚æœå®ƒæ˜¯ä¸€ä¸ªçŸ­æœŸå­˜åœ¨çš„å¤§å¯¹è±¡ï¼Œå°±ä¼šå¯¹åƒåœ¾æ”¶é›†å™¨é€ æˆè´Ÿé¢å½±å“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒG1åˆ’åˆ†äº†ä¸€ä¸ªHumongousåŒºï¼Œå®ƒç”¨æ¥ä¸“é—¨å­˜æ”¾å¤§å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªHåŒºè£…ä¸ä¸‹ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œé‚£ä¹ˆG1ä¼šå¯»æ‰¾è¿ç»­çš„HumongousåŒºæ¥å­˜å‚¨ã€‚ä¸ºäº†èƒ½æ‰¾åˆ°è¿ç»­çš„HumongousåŒºï¼Œæœ‰æ—¶å€™ä¸å¾—ä¸å¯åŠ¨Full GCã€‚G1çš„å¤§å¤šæ•°è¡Œä¸ºéƒ½æŠŠHåŒºä½œä¸ºè€å¹´ä»£çš„ä¸€éƒ¨åˆ†æ¥çœ‹å¾…ã€‚</p>
<blockquote>
<p>â³ å›æ”¶è¿‡ç¨‹</p>
</blockquote>
<p>G1 GCçš„åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ä¸‰ä¸ªç¯èŠ‚ï¼š</p>
<ul>
<li>å¹´è½»ä»£ GCï¼ˆYoung GCï¼‰</li>
<li>è€å¹´ä»£å¹¶å‘æ ‡è®°è¿‡ç¨‹ ï¼ˆConcurrent Markï¼‰</li>
<li>æ··åˆå›æ”¶ï¼ˆMixed GCï¼‰</li>
<li>å¦‚æœéœ€è¦ï¼Œå•çº¿ç¨‹ã€ç‹¬å å¼ã€é«˜å¼ºåº¦çš„Full GCè¿˜æ˜¯ç»§ç»­å­˜åœ¨çš„ã€‚å®ƒé’ˆå¯¹GCçš„è¯„ä¼°å¤±è´¥æä¾›äº†ä¸€ç§å¤±è´¥ä¿æŠ¤æœºåˆ¶ï¼Œå³å¼ºåŠ›å›æ”¶ã€‚</li>
</ul>
<p>åº”ç”¨ç¨‹åºåˆ†é…å†…å­˜ï¼Œå½“å¹´è½»ä»£çš„EdenåŒºç”¨å°½æ—¶å¼€å§‹å¹´è½»ä»£å›æ”¶è¿‡ç¨‹ï¼šG1çš„å¹´è½»ä»£æ”¶é›†é˜¶æ®µæ˜¯ä¸€ä¸ªå¹¶è¡Œçš„ç‹¬å å¼æ”¶é›†å™¨ã€‚åœ¨å¹´è½»ä»£å›æ”¶æœŸï¼ŒG1 GCæš‚åœæ‰€æœ‰åº”ç”¨ç¨‹åºçº¿ç¨‹ï¼Œå¯åŠ¨å¤šçº¿ç¨‹æ‰§è¡Œå¹´è½»ä»£å›æ”¶ã€‚ç„¶åä»å¹´è½»ä»£åŒºé—´ç§»åŠ¨å­˜æ´»å¯¹è±¡åˆ°SurvivoråŒºé—´æˆ–è€…è€å¹´åŒºé—´ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸¤ä¸ªåŒºé—´éƒ½ä¼šæ¶‰åŠã€‚</p>
<p>å½“å †å†…å­˜ä½¿ç”¨è¾¾åˆ°ä¸€å®šå€¼ï¼ˆé»˜è®¤45%ï¼‰æ—¶ï¼Œå¼€å§‹è€å¹´ä»£å¹¶å‘æ ‡è®°è¿‡ç¨‹ã€‚</p>
<p>æ ‡è®°å®Œæˆé©¬ä¸Šå¼€å§‹æ··åˆå›æ”¶è¿‡ç¨‹ã€‚å¯¹äºä¸€ä¸ªæ··åˆå›æ”¶æœŸï¼ŒG1 GCä»è€å¹´åŒºé—´ç§»åŠ¨å­˜æ´»å¯¹è±¡åˆ°ç©ºé—²åŒºé—´ï¼Œè¿™äº›ç©ºé—²åŒºé—´ä¹Ÿå°±æˆä¸ºäº†è€å¹´ä»£çš„ä¸€éƒ¨åˆ†ã€‚å’Œå¹´è½»ä»£ä¸åŒï¼Œè€å¹´ä»£çš„G1å›æ”¶å™¨å’Œå…¶ä»–GCä¸åŒï¼ŒG1çš„è€å¹´ä»£å›æ”¶å™¨ä¸éœ€è¦æ•´ä¸ªè€å¹´ä»£è¢«å›æ”¶ï¼Œä¸€æ¬¡åªéœ€è¦æ‰«æ/å›æ”¶ä¸€éƒ¨åˆ†è€å¹´ä»£çš„regionå°±å¯ä»¥äº†ã€‚åŒæ—¶ï¼Œè¿™ä¸ªè€å¹´ä»£regionæ˜¯å’Œå¹´è½»ä»£ä¸€èµ·è¢«å›æ”¶çš„ã€‚</p>
<blockquote>
<p>ğŸŸª Remembered Set</p>
</blockquote>
<p>ä¸€ä¸ªå¯¹è±¡è¢«ä¸åŒåŒºåŸŸå¼•ç”¨çš„é—®é¢˜</p>
<p>ä¸€ä¸ªregionä¸å¯èƒ½æ˜¯å­¤ç«‹çš„ï¼Œä¸€ä¸ªregionä¸­çš„å¯¹è±¡å¯èƒ½è¢«å…¶ä»–ä»»æ„regionä¸­å¯¹è±¡å¼•ç”¨ï¼Œåˆ¤æ–­å¯¹è±¡å­˜æ´»æ—¶ï¼Œæ˜¯å¦éœ€è¦æ‰«ææ•´ä¸ªJavaå †æ‰èƒ½ä¿è¯å‡†ç¡®ï¼Ÿ</p>
<p>åœ¨å…¶ä»–çš„åˆ†ä»£å›æ”¶å™¨ï¼Œä¹Ÿå­˜åœ¨åœ¨è¿™æ ·çš„é—®é¢˜ï¼ŒG1æ›´çªå‡ºã€‚å›æ”¶æ–°ç”Ÿä»£ä¹Ÿä¸å¾—ä¸åŒæ—¶æ‰«æè€å¹´ä»£ï¼Ÿè¿™æ ·çš„è¯ä¼šé™ä½Minor GCçš„æ•ˆç‡ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<p>æ— è®ºG1è¿˜æ˜¯å…¶ä»–åˆ†ä»£å›æ”¶å™¨ï¼ŒJVMéƒ½æ˜¯ä½¿ç”¨Remembered Setæ¥é¿å…å…¨å±€æ‰«æã€‚</p>
<p>æ¯ä¸ªRegionéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„Remembered Setï¼›æ¯æ¬¡Referenceç±»å‹æ•°æ®å†™æ“ä½œæ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªWrite Barrieræš‚æ—¶ä¸­æ–­æ“ä½œï¼›ç„¶åæ£€æŸ¥å°†è¦å†™å…¥çš„å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦å’Œè¯¥Regerenceç±»å‹æ•°æ®åœ¨ä¸åŒçš„Regionï¼ˆå…¶ä»–å›æ”¶å™¨ï¼šæ£€æŸ¥è€å¹´ä»£å¯¹è±¡æ˜¯å¦å¼•ç”¨äº†æ–°ç”Ÿä»£å¯¹è±¡ï¼‰ã€‚å¦‚æœä¸åŒï¼Œé€šè¿‡CardTableæŠŠç›¸å…³å¼•ç”¨ä¿¡æ¯è®°å½•åˆ°å¼•ç”¨æŒ‡å‘å¯¹è±¡çš„æ‰€åœ¨regionå¯¹åº”çš„Remembered Setä¸­ã€‚</p>
<p>å½“è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œåœ¨GCæ ¹èŠ‚ç‚¹çš„æšä¸¾èŒƒå›´åŠ å…¥Remembered Setï¼›å°±å¯ä»¥ä¿è¯ä¸è¿›è¡Œå…¨å±€æ‰«æï¼Œä¹Ÿä¸ä¼šé—æ¼ã€‚</p>
<blockquote>
<p>ğŸ” å›æ”¶ç»†èŠ‚</p>
</blockquote>
<p>ï¼ˆ1ï¼‰å¹´è½»ä»£GC</p>
<p>JVMå¯åŠ¨æ—¶ï¼ŒG1å…ˆå‡†å¤‡å¥½EdenåŒºï¼Œç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¸æ–­åˆ›é€ å¯¹è±¡åˆ°EdenåŒºï¼Œå½“Edenç©ºé—´è€—å°½æ—¶ï¼ŒG1ä¼šå¯åŠ¨ä¸€æ¬¡å¹´è½»ä»£åƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚</p>
<p>å¹´è½»ä»£åƒåœ¾å›æ”¶åªä¼šå›æ”¶EdenåŒºå’ŒSurvivoråŒºã€‚</p>
<p>Young GCæ—¶ï¼Œé¦–å…ˆG1åœæ­¢åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼ˆSTWï¼‰ï¼ŒG1åˆ›å»ºå›æ”¶é›†ï¼ˆCollection Setï¼‰ï¼Œå›æ”¶é›†æ˜¯æŒ‡éœ€è¦è¢«å›æ”¶çš„å†…å­˜åˆ†æ®µçš„é›†åˆï¼Œå¹´è½»ä»£å›æ”¶è¿‡ç¨‹çš„å›æ”¶é›†åŒ…å«å¹´è½»ä»£EdenåŒºå’ŒSurvivoråŒºæ‰€æœ‰çš„å†…å­˜åˆ†æ®µã€‚</p>
<p>ç„¶åå¼€å§‹å¦‚ä¸‹å›æ”¶è¿‡ç¨‹ï¼š</p>
<p>ç¬¬ä¸€é˜¶æ®µï¼šæ‰«ææ ¹ã€‚æ ¹æ˜¯æŒ‡staticå˜é‡æŒ‡å‘çš„å¯¹è±¡ï¼Œæ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•è°ƒç”¨é“¾ä¸Šçš„å±€éƒ¨å˜é‡ç­‰ã€‚æ ¹å¼•ç”¨è¿åŒRSetè®°å½•çš„å¤–éƒ¨å¼•ç”¨ä½œä¸ºæ‰«æå­˜æ´»å¯¹è±¡çš„å…¥å£ã€‚</p>
<p>ç¬¬äºŒé˜¶æ®µï¼šæ›´æ–°RSetã€‚å¤„ç†dirty card queueä¸­çš„cardï¼Œæ›´æ–°RSetã€‚æ­¤é˜¶æ®µå®Œæˆåï¼ŒRSetå¯ä»¥å‡†ç¡®çš„åæ˜ è€å¹´ä»£æ‰€åœ¨çš„å†…å­˜åˆ†æ®µä¸­å¯¹è±¡çš„å¼•ç”¨ã€‚</p>
<p>ç¬¬ä¸‰é˜¶æ®µï¼šå¤„ç†RSetã€‚è¯†åˆ«è¢«è€å¹´ä»£å¯¹è±¡æŒ‡å‘çš„Edenä¸­çš„å¯¹è±¡ï¼Œè¿™äº›è¢«æŒ‡å‘çš„Edenä¸­çš„å¯¹è±¡è¢«è®¤ä¸ºæ˜¯å­˜æ´»çš„å¯¹è±¡ã€‚</p>
<p>ç¬¬å››é˜¶æ®µï¼šå¤åˆ¶å¯¹è±¡ã€‚æ­¤é˜¶æ®µï¼Œå¯¹è±¡æ ‘è¢«éå†ï¼ŒEdenåŒºå†…å­˜æ®µä¸­å­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°SurvicoråŒºä¸­ç©ºçš„å†…å­˜åˆ†æ®µï¼ŒSurvivoråŒºå†…å­˜æ®µä¸­å­˜æ´»çš„å¯¹è±¡å¦‚æœå¹´é¾„æœªè¾¾åˆ°é˜ˆå€¼ï¼Œå¹´é¾„ä¼šåŠ 1ï¼Œè¾¾åˆ°é˜ˆå€¼ä¼šè¢«å¤åˆ¶åˆ°OldåŒºä¸­ç©ºçš„å†…å­˜åˆ†æ®µã€‚å¦‚æœSurvivorç©ºé—´ä¸å¤Ÿï¼ŒEdenç©ºé—´çš„éƒ¨åˆ†æ•°æ®ä¼šç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£ç©ºé—´ã€‚</p>
<p>ç¬¬äº”é˜¶æ®µï¼šå¤„ç†å¼•ç”¨ã€‚å¤„ç†Softï¼ŒWeakï¼ŒPhantomï¼ŒFinalï¼ŒJNI Weakç­‰å¼•ç”¨ã€‚æœ€ç»ˆEdenç©ºé—´çš„æ•°æ®ä¸ºç©ºï¼ŒGCåœæ­¢å·¥ä½œï¼Œè€Œç›®æ ‡å†…å­˜ä¸­çš„å¯¹è±¡éƒ½æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œæ²¡æœ‰ç¢ç‰‡ï¼Œæ‰€ä»¥å¤åˆ¶è¿‡ç¨‹å¯ä»¥è¾¾åˆ°å†…å­˜æ•´ç†çš„æ•ˆæœï¼Œå‡å°‘ç¢ç‰‡ã€‚</p>
<p>ï¼ˆ2ï¼‰å¹¶å‘æ ‡è®°</p>
<p>ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹æ ‡è®°é˜¶æ®µã€‚æ ‡è®°ä»æ ¹èŠ‚ç‚¹ç›´æ¥å¯è¾¾çš„å¯¹è±¡ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯STWçš„ï¼Œå¹¶ä¸”ä¼šè§¦å‘ä¸€æ¬¡å¹´è½»ä»£GCã€‚</p>
<p>ç¬¬äºŒé˜¶æ®µï¼šæ ¹åŒºåŸŸæ‰«æã€‚G1 GCæ‰«æSurvivoråŒºç›´æ¥å¯è¾¾çš„è€å¹´ä»£åŒºåŸŸå¯¹è±¡ï¼Œå¹¶æ ‡è®°è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚è¿™ä¸€è¿‡ç¨‹å¿…é¡»åœ¨Young GCä¹‹å‰å®Œæˆã€‚</p>
<p>ç¬¬ä¸‰é˜¶æ®µï¼šå¹¶å‘æ ‡è®°ã€‚åœ¨æ•´ä¸ªå †ä¸­è¿›è¡Œå¹¶å‘æ ‡è®°ï¼ˆå’Œåº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œï¼‰ï¼Œæ­¤è¿‡ç¨‹å¯èƒ½è¢«Young GCä¸­æ–­ã€‚åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œè‹¥å‘ç°åŒºåŸŸå¯¹è±¡ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯åƒåœ¾ï¼Œé‚£è¿™ä¸ªåŒºåŸŸä¼šè¢«ç«‹å³å›æ”¶ã€‚åŒæ—¶ï¼Œå¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œä¼šè®¡ç®—æ¯ä¸ªåŒºåŸŸçš„å¯¹è±¡æ´»æ€§ï¼ˆåŒºåŸŸä¸­å­˜æ´»å¯¹è±¡çš„æ¯”ä¾‹ï¼‰ã€‚</p>
<p>ç¬¬å››é˜¶æ®µï¼šå†æ¬¡æ ‡è®°ã€‚ç”±äºåº”ç”¨ç¨‹åºæŒç»­è¿›è¡Œï¼Œéœ€è¦ä¿®æ­£ä¸Šä¸€æ¬¡çš„æ ‡è®°ç»“æœã€‚æ˜¯STWçš„ã€‚G1ä¸­é‡‡ç”¨äº†æ¯”CMSæ›´å¿«çš„åˆå§‹å¿«ç…§ç®—æ³•ï¼šsnapshot-at-the-beginningï¼ˆSATBï¼‰ã€‚</p>
<p>ç¬¬äº”é˜¶æ®µï¼šç‹¬å æ¸…ç†ã€‚è®¡ç®—å„ä¸ªåŒºåŸŸçš„å­˜è´§å¯¹è±¡å’ŒGCå›æ”¶æ¯”ä¾‹ï¼Œå¹¶è¿›è¡Œæ’åºï¼Œè¯†åˆ«å¯ä»¥æ··åˆå›æ”¶çš„åŒºåŸŸã€‚ä¸ºä¸‹é˜¶æ®µåšé“ºå«ï¼Œæ˜¯STWçš„ã€‚</p>
<p>ç¬¬å…­é˜¶æ®µï¼šå¹¶å‘æ¸…ç†é˜¶æ®µï¼šè¯†åˆ«å¹¶æ¸…ç†å®Œå…¨ç©ºé—²çš„åŒºåŸŸã€‚</p>
<p>ï¼ˆ3ï¼‰æ··åˆå›æ”¶</p>
<p>å½“è¶Šæ¥è¶Šå¤šçš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£Old Regionæ—¶ï¼Œä¸ºäº†é¿å…å †å†…å­˜è¢«è€—å°½ï¼Œè™šæ‹Ÿæœºä¼šè§¦å‘ä¸€ä¸ªæ··åˆçš„åƒåœ¾æ”¶é›†å™¨ï¼Œå³Mixed GCï¼Œè¯¥ç®—æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªOld GCï¼Œè¯¥ç®—æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªOld GCï¼Œé™¤äº†å›æ”¶æ•´ä¸ªYoung Regionï¼Œè¿˜ä¼šå›æ”¶ä¸€éƒ¨åˆ†çš„Old Regionã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼šæ˜¯ä¸€éƒ¨åˆ†è€å¹´ä»£ï¼Œè€Œä¸æ˜¯å…¨éƒ¨è€å¹´ä»£ã€‚å¯ä»¥é€‰æ‹©å“ªäº›Old Regionè¿›è¡Œæ”¶é›†ï¼Œä»è€Œå¯ä»¥å¯¹åƒåœ¾å›æ”¶çš„è€—æ—¶æ—¶é—´è¿›è¡Œæ§åˆ¶ã€‚ä¹Ÿè¦æ³¨æ„çš„Mixed GCå¹¶ä¸æ˜¯Full GCã€‚</p>
<p>å¹¶å‘æ ‡è®°ç»“æŸä»¥åï¼Œè€å¹´ä»£ä¸­ç™¾åˆ†ç™¾ä¸ºåƒåœ¾çš„å†…å­˜åˆ†æ®µè¢«å›æ”¶äº†ï¼Œéƒ¨åˆ†ä¸ºåƒåœ¾çš„å†…å­˜åˆ†æ®µè¢«è®¡ç®—äº†å‡ºæ¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›è€å¹´ä»£çš„å†…å­˜åˆ†æ®µä¼šåˆ†8æ¬¡ï¼ˆå¯ä»¥é€šè¿‡<code>-XX:G1MixedGCCountTarget</code>è®¾ç½®ï¼‰è¢«å›æ”¶ã€‚</p>
<p>æ··åˆå›æ”¶çš„å›æ”¶é›†ï¼ˆCollection Setï¼‰åŒ…æ‹¬å…«åˆ†ä¹‹ä¸€çš„è€å¹´ä»£å†…å­˜åˆ†æ®µï¼ŒEdenåŒºå†…å­˜åˆ†æ®µï¼ŒSurvivoråŒºå†…å­˜åˆ†æ®µã€‚æ··åˆå›æ”¶çš„ç®—æ³•å’Œå¹´è½»ä»£å›æ”¶çš„ç®—æ³•å®Œå…¨ä¸€æ ·ï¼Œåªæ˜¯å›æ”¶é›†å¤šäº†è€å¹´ä»£çš„å†…å­˜åˆ†æ®µã€‚</p>
<p>ç”±äºè€å¹´ä»£ä¸­çš„å†…å­˜åˆ†æ®µé»˜è®¤åˆ†8æ¬¡å›æ”¶ï¼ŒG1ä¼šä¼˜å…ˆå›æ”¶åƒåœ¾å¤šçš„å†…å­˜åˆ†æ®µã€‚åƒåœ¾å å†…å­˜åˆ†æ®µæ¯”ä¾‹è¶Šé«˜çš„ï¼Œè¶Šä¼šè¢«å…ˆå›æ”¶ã€‚å¹¶ä¸”æœ‰ä¸€ä¸ªé˜ˆå€¼ä¼šå†³å®šå†…å­˜åˆ†æ®µæ˜¯å¦è¢«å›æ”¶ï¼Œ<code>-XX:G1MixedGCLiveThresholdPercent</code>ï¼Œé»˜è®¤ä¸º65%ï¼Œæ„æ€æ˜¯åƒåœ¾å å†…å­˜åˆ†æ®µæ¯”ä¾‹è¦è¾¾åˆ°65%æ‰ä¼šè¢«å›æ”¶ã€‚å¦‚æœåƒåœ¾å æ¯”å¤ªä½ï¼Œæ„å‘³ç€å­˜æ´»çš„å¯¹è±¡å æ¯”é«˜ï¼Œåœ¨å¤åˆ¶çš„æ—¶å€™ä¼šèŠ±è´¹æ›´å¤šçš„æ—¶é—´ã€‚</p>
<p>æ··åˆå›æ”¶å¹¶ä¸ä¸€å®šè¦è¿›è¡Œ8æ¬¡ã€‚æœ‰ä¸€ä¸ªé˜ˆå€¼<code>-XX:G1HeapWastePercent</code>ï¼Œé»˜è®¤å€¼ä¸º10%ï¼Œæ„æ€æ˜¯å…è®¸æ•´ä¸ªå †å†…å­˜ä¸­æœ‰10%çš„ç©ºé—´è¢«æµªè´¹ï¼Œæ„å‘³ç€å¦‚æœå‘ç°å¯ä»¥å›æ”¶çš„åƒåœ¾å å †å†…å­˜çš„æ¯”ä¾‹ä½äº10%ï¼Œåˆ™ä¸å†è¿›è¡Œæ··åˆå›æ”¶ã€‚å› ä¸ºGCä¼šèŠ±è´¹å¾ˆå¤šçš„æ—¶é—´ä½†æ˜¯å›æ”¶åˆ°çš„å†…å­˜å´å¾ˆå°‘ã€‚</p>
<p>ï¼ˆ4ï¼‰å¯é€‰è¿‡ç¨‹ï¼šFull GC</p>
<p>G1çš„åˆè¡·å°±æ˜¯è¦é¿å…Full GCçš„å‡ºç°ã€‚ä½†æ˜¯å¦‚æœä¸Šè¿°æ–¹å¼ä¸èƒ½æ­£å¸¸å·¥ä½œï¼ŒG1ä¼šåœæ­¢åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼ˆSTWï¼‰ï¼Œä½¿ç”¨å•çº¿ç¨‹çš„å†…å­˜å›æ”¶ç®—æ³•è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œæ€§èƒ½ä¼šéå¸¸å·®ï¼Œåº”ç”¨ç¨‹åºåœé¡¿æ—¶é—´ä¼šå¾ˆé•¿ã€‚</p>
<p>è¦é¿å…Full GCçš„å‘ç”Ÿï¼Œä¸€æ—¦å‘ç”Ÿéœ€è¦è¿›è¡Œè°ƒæ•´ã€‚ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”ŸFull GCå‘¢ï¼Ÿæ¯”å¦‚å †å†…å­˜å¤ªå°ï¼Œå½“G1åœ¨å¤åˆ¶å­˜è´§å¯¹è±¡çš„æ—¶å€™æ²¡æœ‰ç©ºçš„å†…å­˜åˆ†æ®µå¯ç”¨ï¼Œåˆ™ä¼šå›é€€åˆ°Full GCï¼Œè¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡å¢å¤§å†…å­˜è§£å†³ã€‚</p>
<p>å¯¼è‡´G1 Full GCçš„åŸå› å¯èƒ½æœ‰ä¸¤ä¸ªï¼š</p>
<p>Evacuationçš„æ—¶å€™æ²¡æœ‰è¶³å¤Ÿçš„to-spaceæ¥å­˜æ”¾æ™‹å‡çš„å¯¹è±¡ï¼›å¹¶å‘å¤„ç†è¿‡ç¨‹å®Œæˆä¹‹å‰ç©ºé—´è€—å°½ã€‚</p>
<blockquote>
<p>ğŸ¤ ä¼˜åŒ–å»ºè®®</p>
</blockquote>
<p>å¹´è½»ä»£å¤§å°ï¼š</p>
<ul>
<li>é¿å…ä½¿ç”¨<code>-Xmn</code>æˆ–<code>-XX:NewRatio</code>ç­‰ç›¸å…³é€‰é¡¹æ˜¾ç¤ºè®¾ç½®å¹´è½»ä»£å¤§å°</li>
<li>å›ºå®šå¹´è½»ä»£çš„å¤§å°ä¼šè¦†ç›–æš‚åœæ—¶é—´ç›®æ ‡</li>
</ul>
<p>æš‚åœæ—¶é—´ç›®æ ‡ä¸è¦å¤ªè¿‡ä¸¥è‹›</p>
<ul>
<li>G1 GCçš„ååé‡æ˜¯90%çš„åº”ç”¨ç¨‹åºæ—¶é—´å’Œ10%çš„åƒåœ¾å›æ”¶æ—¶é—´</li>
<li>è¯„ä¼°G1 GCçš„ååé‡æ—¶ï¼Œæš‚åœæ—¶é—´ç›®æ ‡ä¸è¦å¤ªè¿‡ä¸¥è‹›ã€‚ç›®æ ‡å¤ªè¿‡ä¸¥è‹›è¡¨ç¤ºä½ åŸå› æ‰¿å—æ›´å¤šçš„åƒåœ¾å›æ”¶å¼€é”€ï¼Œè€Œè¿™äº›ä¼šç›´æ¥å½±å“åˆ°ååé‡ã€‚</li>
</ul>
<h3 id="15-8-ğŸŒˆ-åƒåœ¾å›æ”¶å™¨æ€»ç»“"><a href="#15-8-ğŸŒˆ-åƒåœ¾å›æ”¶å™¨æ€»ç»“" class="headerlink" title="15.8 ğŸŒˆ åƒåœ¾å›æ”¶å™¨æ€»ç»“"></a>15.8 ğŸŒˆ åƒåœ¾å›æ”¶å™¨æ€»ç»“</h3><blockquote>
<p>ğŸ†š æ¯”è¾ƒ</p>
</blockquote>
<table>
<thead>
<tr>
<th>åƒåœ¾å›æ”¶å™¨</th>
<th>åˆ†ç±»</th>
<th>ä½œç”¨ä½ç½®</th>
<th>ä½¿ç”¨ç®—æ³•</th>
<th>ç‰¹ç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>Serial</td>
<td>ä¸²è¡Œè¿è¡Œ</td>
<td>æ–°ç”Ÿä»£</td>
<td>å¤åˆ¶ç®—æ³•</td>
<td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td>
<td>é€‚ç”¨äºå•CPUç¯å¢ƒä¸‹çš„Clientæ¨¡å¼</td>
</tr>
<tr>
<td>ParNew</td>
<td>å¹¶è¡Œè¿è¡Œ</td>
<td>æ–°ç”Ÿä»£</td>
<td>å¤åˆ¶ç®—æ³•</td>
<td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td>
<td>å¤šCPUç¯å¢ƒServeræ¨¡å¼ä¸‹ä¸CMSé…åˆä½¿ç”¨</td>
</tr>
<tr>
<td>Parallel</td>
<td>å¹¶è¡Œè¿è¡Œ</td>
<td>æ–°ç”Ÿä»£</td>
<td>å¤åˆ¶ç®—æ³•</td>
<td>ååé‡ä¼˜å…ˆ</td>
<td>é€‚ç”¨äºåå°è®¡ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„åœºæ™¯</td>
</tr>
<tr>
<td>Serial Old</td>
<td>ä¸²è¡Œè¿è¡Œ</td>
<td>è€å¹´ä»£</td>
<td>æ ‡è®°-å‹ç¼©ç®—æ³•</td>
<td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td>
<td>é€‚ç”¨äºå•CPUç¯å¢ƒä¸‹çš„Clientæ¨¡å¼</td>
</tr>
<tr>
<td>Parallel Old</td>
<td>å¹¶è¡Œè¿è¡Œ</td>
<td>è€å¹´ä»£</td>
<td>æ ‡è®°-å‹ç¼©ç®—æ³•</td>
<td>ååé‡ä¼˜å…ˆ</td>
<td>é€‚ç”¨äºåå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„åœºæ™¯</td>
</tr>
<tr>
<td>CMS</td>
<td>å¹¶å‘è¿è¡Œ</td>
<td>è€å¹´ä»£</td>
<td>æ ‡è®°-æ¸…é™¤ç®—æ³•</td>
<td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td>
<td>é€‚ç”¨äºäº’è”ç½‘æˆ–è€…B/Sä¸šåŠ¡</td>
</tr>
<tr>
<td>G1</td>
<td>å¹¶å‘ã€å¹¶è¡Œè¿è¡Œ</td>
<td>æ–°ç”Ÿä»£ã€è€å¹´ä»£</td>
<td>æ ‡è®°-å‹ç¼©ç®—æ³•ã€å¤åˆ¶ç®—æ³•</td>
<td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td>
<td>é¢å‘æœåŠ¡ç«¯</td>
</tr>
</tbody></table>
<blockquote>
<p>ğŸ“· æ­é…</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11567/image-20210601165415818.png" class="" title="image-20210601165415818"><br />



<blockquote>
<p>ğŸ’¡ æç¤º</p>
</blockquote>
<ul>
<li>æ²¡æœ‰æœ€å¥½çš„å›æ”¶å™¨ï¼Œæ›´æ²¡æœ‰ä¸‡èƒ½çš„å›æ”¶å™¨ã€‚</li>
<li>è°ƒä¼˜æ°¸è¿œæ˜¯é’ˆå¯¹ç‰¹å®šåœºæ™¯ã€ç‰¹å®šéœ€æ±‚ï¼Œä¸å­˜åœ¨ä¸€åŠ³æ°¸é€¸çš„å›æ”¶å™¨</li>
</ul>
<h3 id="15-9-ğŸ“„-GCæ—¥å¿—åˆ†æ"><a href="#15-9-ğŸ“„-GCæ—¥å¿—åˆ†æ" class="headerlink" title="15.9 ğŸ“„ GCæ—¥å¿—åˆ†æ"></a>15.9 ğŸ“„ GCæ—¥å¿—åˆ†æ</h3><blockquote>
<p>âš™ï¸ å‚æ•°</p>
</blockquote>
<p>é€šè¿‡é˜…è¯»GCæ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£Javaè™šæ‹Ÿæœºå†…å­˜åˆ†é…å’Œå›æ”¶ç­–ç•¥ã€‚</p>
<ul>
<li><code>-XX:+PrintGC</code>ï¼šè¾“å‡ºGCæ—¥å¿—</li>
<li><code>-XX:+PrintGCDetails</code>ï¼šè¾“å‡ºGCçš„è¯¦ç»†æ—¥å¿—</li>
<li><code>-XX:+PrintGCTimeStamps</code>ï¼šè¾“å‡ºGCçš„æ—¶é—´æˆ³</li>
<li><code>-XX:+PrintGCDateStamps</code>ï¼šè¾“å‡ºGCçš„æ—¶é—´æˆ³</li>
<li><code>-XX:+PrintHeapAtGC</code>ï¼šåœ¨è¿›è¡ŒGCçš„å‰åæ‰“å°å‡ºå †çš„ä¿¡æ¯</li>
<li><code>-Xloggc:..logs/gc.log</code>ï¼šæ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„</li>
</ul>
<blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<ul>
<li><code>GC</code>å’Œ<code>Full GC</code>è¯´æ˜äº†è¿™æ¬¡åƒåœ¾æ”¶é›†çš„åœé¡¿ç±»å‹ï¼Œå¦‚æœæœ‰<code>Full</code>åˆ™è¯´æ˜GCå‘ç”Ÿäº†STWã€‚</li>
<li>ä½¿ç”¨Serialæ”¶é›†å™¨åœ¨æ–°ç”Ÿä»£çš„åå­—æ˜¯Default New Generationï¼Œå› æ­¤æ˜¾ç¤ºçš„æ˜¯<code>DefNew</code>ã€‚</li>
<li>ä½¿ç”¨ParNewå›æ”¶å™¨åœ¨æ–°ç”Ÿä»£çš„åå­—ä¼šå˜æˆ<code>ParNew</code>ï¼Œæ„æ€æ˜¯Parallel New Generationã€‚</li>
<li>ä½¿ç”¨Parallel Scavengeå›æ”¶å™¨åœ¨æ–°ç”Ÿä»£çš„åå­—æ˜¯<code>PSYoungGen</code>ã€‚</li>
<li>è€å¹´ä»£çš„æ”¶é›†å’Œæ–°ç”Ÿä»£çš„é“ç†ä¸€æ ·ï¼Œåå­—ä¹Ÿæ˜¯å›æ”¶å™¨å†³å®šçš„ã€‚</li>
<li>ä½¿ç”¨G1å›æ”¶å™¨çš„è¯ï¼Œä¼šæ˜¾ç¤ºä¸º<code>garbage-first heap</code>ã€‚</li>
<li><code>Allocation Failure</code>ï¼šè¡¨æ˜æœ¬æ¬¡å¼•èµ·GCçš„åŸå› æ˜¯å› ä¸ºåœ¨å¹´è½»ä»£ä¸­æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´èƒ½å¤Ÿå­˜å‚¨æ–°çš„æ•°æ®äº†ã€‚</li>
<li><code>[PSYoungGen: XXXK -&gt; XXXK(XXXK)] XXXK -&gt; XXXK(XXXK)</code>ï¼šä¸­æ‹¬å·å†…ï¼šGCå›æ”¶å‰å¹´è½»ä»£å¤§å°ï¼Œå›æ”¶åå¤§å°ï¼Œï¼ˆå¹´è½»ä»£æ€»å¤§å°ï¼‰ï¼›æ‹¬å·å¤–ï¼šGCå›æ”¶å‰å¹´è½»ä»£å’Œè€å¹´ä»£å¤§å°ï¼Œå›æ”¶åå¤§å°ï¼Œï¼ˆå¹´è½»ä»£å’Œè€å¹´ä»£æ€»å¤§å°ï¼‰</li>
<li><code>user</code>ç”¨æˆ·æ€å›æ”¶è€—æ—¶ï¼Œ<code>sys</code>å†…æ ¸æ€å›æ”¶è€—æ—¶ï¼Œ<code>real</code>å®é™…è€—æ—¶ã€‚ç”±äºå¤šæ ¸çš„åŸå› ï¼Œæ—¶é—´æ€»å’Œå¯èƒ½ä¼šè¶…è¿‡realæ—¶é—´ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“· å®ä¾‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11567/image-20210404181555136.png" class="" title="image-20210404181555136"><br />



<blockquote>
<p>ğŸ”¨ å·¥å…·</p>
</blockquote>
<ul>
<li>GC viewerï¼š<a href="https://github.com/chewiebug/GCViewer">https://github.com/chewiebug/GCViewer</a></li>
<li>GC easyï¼š<a href="https://gceasy.io/">https://gceasy.io/</a></li>
</ul>
<h3 id="15-10-6ï¸âƒ£-ZGCå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ"><a href="#15-10-6ï¸âƒ£-ZGCå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ" class="headerlink" title="15.10 6ï¸âƒ£ ZGCå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ"></a>15.10 6ï¸âƒ£ ZGCå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ</h3><blockquote>
<p>ğŸ’¬ è¯´æ˜</p>
</blockquote>
<p>GCä»ç„¶å¤„äºé£é€Ÿå‘å±•ä¸­ï¼Œç›®å‰çš„é»˜è®¤é€‰é¡¹G1 GCåœ¨ä¸æ–­çš„è¿›è¡Œæ”¹è¿›ï¼Œå¾ˆå¤šæˆ‘ä»¬åŸæ¥è®¤ä¸ºçš„ç¼ºç‚¹ï¼Œä¾‹å¦‚ä¸²è¡Œçš„Full GCã€Card Tableæ‰«æçš„ä½æ•ˆç­‰ï¼Œéƒ½å·²ç»è¢«å¤§å¹…æ”¹è¿›ï¼Œä¾‹å¦‚ï¼ŒJDK 10ä»¥åï¼ŒFull GCå·²ç»æ˜¯å¹¶è¡Œè¿è¡Œï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œå…¶è¡¨ç°è¿˜ä¼˜äºParallel GCçš„å¹¶è¡ŒFull GCå®ç°ã€‚</p>
<p>å³ä½¿æ˜¯Serial GCï¼Œè™½ç„¶æ¯”è¾ƒå¤è€ï¼Œä½†æ˜¯ç®€å•çš„è®¾è®¡å’Œå®ç°æœªå¿…å°±æ˜¯è¿‡æ—¶çš„ï¼Œå®ƒæœ¬èº«çš„å¼€é”€ï¼Œä¸ç®¡æ˜¯GCç›¸å…³æ•°æ®ç»“æ„çš„å¼€é”€ï¼Œè¿˜æ˜¯çº¿ç¨‹çš„å¼€é”€ï¼Œéƒ½æ˜¯éå¸¸å°çš„ï¼Œæ‰€ä»¥éšç€äº‘è®¡ç®—çš„å…´èµ·ï¼Œåœ¨Serverlessç­‰æ–°çš„åº”ç”¨åœºæ™¯ä¸‹ï¼ŒSerial GCæ‰¾åˆ°äº†æ–°çš„èˆå°ã€‚</p>
<p>æ¯”è¾ƒä¸å¹¸çš„æ˜¯CMS GCï¼Œå› ä¸ºå…¶ç®—æ³•çš„ç†è®ºç¼ºé™·ç­‰åŸå› ï¼Œè™½ç„¶ç°åœ¨è¿˜æœ‰éå¸¸å¤§çš„ç”¨æˆ·ç¾¤ä½“ï¼Œä½†åœ¨JDK9ä¸­å·²ç»è¢«æ ‡è®°ä¸ºåºŸå¼ƒï¼Œå¹¶åœ¨JDK14ç‰ˆæœ¬ä¸­ç§»é™¤ã€‚</p>
<blockquote>
<p>ğŸ’« Oracle JDK11çš„ZGC</p>
</blockquote>
<p>ZGCä¸G1éƒ½æ˜¯åŸºäºRegionï¼Œä¸åˆ†ä»£ã€‚</p>
<p>ZGCä¸Shenandoahç›®æ ‡é«˜åº¦ç›¸ä¼¼ï¼Œåœ¨å°½å¯èƒ½å¯¹ååé‡å½±å“ä¸å¤§çš„å‰æä¸‹ï¼Œå®ç°åœ¨ä»»æ„å †å†…å­˜å¤§å°ä¸‹éƒ½å¯ä»¥æŠŠåƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´é™åˆ¶åœ¨10msä»¥å†…çš„ä½å»¶è¿Ÿã€‚</p>
<p>ZGCçš„å·¥ä½œè¿‡ç¨‹å¯ä»¥åˆ†ä¸º4ä¸ªé˜¶æ®µï¼šå¹¶å‘æ ‡è®°ã€å¹¶å‘é¢„å¤‡é‡åˆ†é…ã€å¹¶å‘é‡åˆ†é…ã€å¹¶å‘é‡æ˜ å°„ã€‚</p>
<p>ZGCå‡ ä¹åœ¨æ‰€æœ‰åœ°æ–¹å¹¶å‘æ‰§è¡Œçš„ï¼Œé™¤äº†åˆå§‹æ ‡è®°çš„æ˜¯STWçš„ã€‚æ‰€ä»¥åœé¡¿æ—¶é—´å‡ ä¹å°±è€—è´¹åœ¨åˆå§‹æ ‡è®°ä¸Šï¼Œè¿™éƒ¨åˆ†çš„å®é™…éƒ¨åˆ†æ˜¯éå¸¸å°‘çš„ã€‚</p>
<p>2018å¹´ï¼Œåœé¡¿æ—¶é—´å¯¹æ¯”ï¼ŒZGCå·²ç»æŠŠåœé¡¿æ—¶é—´æ‰¼åˆ¶åœ¨10msä»¥å†…ï¼Œä»¤äººææ€–çš„æä½å»¶æ—¶ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11567/image-20210601130647580.png" class="" title="image-20210601130647580"><br />

<br>

<p><a class="btn-beautify button--animated " href="https://malloc.se" target="_blank" rel="noopener" title="å¼€å‘è€…åšå®¢"><i class="far fa-hand-point-right fa-fw"></i> å¼€å‘è€…åšå®¢</a></p>
<p><a class="btn-beautify button--animated " href="http://cr.openjdk.java.net/~pliden/slides" target="_blank" rel="noopener" title="æ‰€æœ‰æ–‡çŒ®"><i class="far fa-hand-point-right fa-fw"></i> æ‰€æœ‰æ–‡çŒ®</a></p>
<p><a class="btn-beautify button--animated " href="http://cr.openjdk.java.net/~pliden/slides/ZGC-OracleDevLive-2020.pdf" target="_blank" rel="noopener" title="å¼€å‘è€…åšå®¢"><i class="far fa-hand-point-right fa-fw"></i> 2020å¹´PDF</a></p>
<blockquote>
<p>ğŸ” ZGCçš„é»‘æŠ€å·§ï¼šæŸ“è‰²æŒ‡é’ˆ+å¤šé‡æ˜ å°„</p>
</blockquote>
<p><a href="https://www.baeldung.com/jvm-compressed-oops">å‹ç¼©æŒ‡é’ˆ</a>ï¼šæœ€åˆJVMæ˜¯32ä½çš„ï¼Œéšç€64ä½ç³»ç»Ÿçš„å…´èµ·ï¼ŒJVMä¹Ÿè¿æ¥äº†è½¬æ¢ã€‚ä½†æ˜¯64ä½å¼•ç”¨æ˜¯32ä½å¼•ç”¨çš„ä¸¤å€ï¼Œå¯¼è‡´äº†ç©ºé—´æµªè´¹ã€‚é€šè¿‡<code>-XX:+UseCompressedOops</code>å¯ä»¥å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼Œæ”¹å˜æ­£å¸¸æŒ‡é’ˆçš„éšæœºåœ°å€åˆ†é…ç‰¹æ€§<strong>ï¼Œ</strong>å¼ºåˆ¶å †åœ°å€ä»é›¶å¼€å§‹åˆ†é…ã€‚é€šè¿‡å¯¹é½å’Œåç§»é‡ï¼Œå¯ä»¥å°†64ä½æŒ‡é’ˆå‹ç¼©æˆ32ä½ã€‚</p>
<p><a href="https://www.jianshu.com/p/b6356e0ec63c">è™šæ‹Ÿåœ°å€</a>ï¼šä¸€ä¸ªè¿›ç¨‹èƒ½å¤Ÿçœ‹åˆ°çš„åœ°å€ç©ºé—´å«åšè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¯¹åº”ç€è®¡ç®—æœºçš„ç‰©ç†åœ°å€ç©ºé—´ã€‚å¤šä¸ªè™šæ‹Ÿåœ°å€å¯ä»¥å¯¹åº”ä¸€ä¸ªç‰©ç†åœ°å€ã€‚ç¢ç‰‡åŒ–çš„ç‰©ç†å†…å­˜å¯ä»¥æ˜ å°„æˆå®Œæ•´è¿ç»­çš„è™šæ‹Ÿå†…å­˜ï¼Œä¸€ä¸ªåº”ç”¨å¯ä»¥ç”³è¯·æ¯”ç‰©ç†å†…å­˜æ›´å¤§çš„å†…å­˜ï¼Œä»è€Œä½¿å¾—å¤šä¸ªè¿›ç¨‹äº’ä¸å¹²æ‰°ã€‚</p>
<p>å¯¹äºä¸€ä¸ª64bitçš„æŒ‡é’ˆåœ°å€æ¥è¯´ï¼Œå¯¹è±¡åœ°å€åªèƒ½å¯»å€44bitï¼Œå‰©ä¸‹çš„20ä½éƒ½æ˜¯æ²¡æœ‰ç”¨çš„ã€‚</p>
<p><strong>æŸ“è‰²æŒ‡é’ˆ</strong>ï¼šåœ¨å¯¹å †è¿›è¡ŒGCçš„æ—¶å€™ï¼Œå¯¹è±¡ä¼šæœ‰å„ç§çŠ¶æ€ï¼šæ˜¯å¦æ‰«æï¼Œæ˜¯å¦æ‹·è´ç­‰ç­‰ï¼Œä¼ ç»ŸGCéƒ½æ˜¯æŠŠè¿™äº›å­˜åœ¨é¢å¤–çš„å†…å­˜ç©ºé—´ä¸­ï¼ŒZGCç›´æ¥å°†è¿™äº›å­˜åœ¨å‰©ä½™çš„4ä½æŒ‡é’ˆä¸­ï¼Œcolor bitsï¼ˆæŸ“è‰²æŒ‡é’ˆï¼‰ï¼Œä¸åŒçš„é¢œè‰²ä»£è¡¨å¯¹è±¡ä¸åŒçš„çŠ¶æ€ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11567/image-20210601134700690.png" class="" title="image-20210601134700690"><br />

<p><strong>å¤šé‡æ˜ å°„</strong>ï¼šå°†ä¸€ä¸ªç‰©ç†åœ°å€æ˜ å°„åˆ°å¤šä¸ªè™šæ‹Ÿåœ°å€ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/11567/image-20210601134730306.png" class="" title="image-20210601134730306"><br />

<p>è¿™æ ·åšå¸¦æ¥äº†ä¸€äº›é—®é¢˜ï¼šï¼ˆ1ï¼‰ä¸èƒ½ä½¿ç”¨OOPSï¼ˆå‹ç¼©æŒ‡é’ˆï¼‰ï¼Œå¯¼è‡´åº”ç”¨å ç”¨å†…å­˜æ˜¾è‘—å¢å¤§ï¼›ï¼ˆ2ï¼‰ç³»ç»Ÿé”™è¯¯æ˜¾ç¤ºå†…å­˜å ç”¨ï¼Œå ç”¨äº†å®é™…å†…å­˜çš„3å€ï¼Œå¯èƒ½å¯¼è‡´Linuxå†…æ ¸çš„OutOfMemory Killerã€‚</p>
<blockquote>
<p>ğŸ”° è¯»å±éšœLoad Barrier</p>
</blockquote>
<p>ç”±äºæŸ“è‰²æŒ‡é’ˆçš„å­˜åœ¨ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶è®¿é—®å¯¹è±¡çš„æ—¶å€™ï¼Œå¯ä»¥è½»æ˜“çŸ¥é“å¯¹è±¡åœ¨å†…å­˜çš„å­˜å‚¨çŠ¶æ€ï¼Œè‹¥è¯·æ±‚è¯»çš„å†…å­˜è¢«æŸ“è‰²äº†ï¼Œåˆ™ä¼šè§¦å‘è¯»å±éšœï¼Œè¯»å±éšœä¼šæ›´æ–°æŒ‡é’ˆå†è¿”å›ç»“æœï¼Œæ­¤è¿‡ç¨‹æœ‰ä¸€å®šçš„è€—è´¹ï¼Œä»è€Œè¾¾åˆ°ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘çš„æ•ˆæœã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Object o &#x3D; obj.field;</span><br><span class="line">&lt;load_barrier&gt;</span><br><span class="line">    </span><br><span class="line">mov 0x10(%rax), $rbx</span><br><span class="line">test %rbx, 0x20(%r15)</span><br><span class="line">jne slow_path</span><br></pre></td></tr></table></figure>

<ul>
<li>æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„é¢œè‰²</li>
<li>å¦‚æœé¢œè‰²é”™è¯¯ =&gt; slow path</li>
</ul>
<p class="div-border blue">ä¸æ ‡è®°å¯¹è±¡çš„ä¼ ç»Ÿç®—æ³•ç›¸æ¯”ï¼ŒZGCåœ¨æŒ‡é’ˆä¸Šåšæ ‡è®°ï¼Œåœ¨è®¿é—®æŒ‡é’ˆæ—¶åŠ å…¥Load Barrierï¼ˆè¯»å±éšœï¼‰ï¼Œæ¯”å¦‚å½“å¯¹è±¡æ­£è¢«GCç§»åŠ¨ï¼ŒæŒ‡é’ˆä¸Šçš„é¢œè‰²å°±ä¼šä¸å¯¹ï¼Œè¿™ä¸ªå±éšœå°±ä¼šå…ˆæŠŠæŒ‡é’ˆæ›´æ–°ä¸ºæœ‰æ•ˆåœ°å€å†è¿”å›ï¼Œä¹Ÿå°±æ˜¯ï¼Œæ°¸è¿œåªæœ‰å•ä¸ªå¯¹è±¡è¯»å–æ—¶æœ‰æ¦‚ç‡è¢«å‡é€Ÿï¼Œè€Œä¸å­˜åœ¨ä¸ºäº†ä¿æŒåº”ç”¨ä¸GCä¸€è‡´è€Œç²—æš´æ•´ä½“çš„Stop The Worldã€‚</p>



<h3 id="15-11-7ï¸âƒ£Shenandoah-GCï¼šä½åœé¡¿ã€ä½åå"><a href="#15-11-7ï¸âƒ£Shenandoah-GCï¼šä½åœé¡¿ã€ä½åå" class="headerlink" title="15.11 7ï¸âƒ£Shenandoah GCï¼šä½åœé¡¿ã€ä½åå"></a>15.11 7ï¸âƒ£Shenandoah GCï¼šä½åœé¡¿ã€ä½åå</h3><blockquote>
<p>âœˆï¸ Open JDK12çš„Shenandoah GC</p>
</blockquote>
<p>Shenandoah ï¼Œæ— ç–‘æ˜¯ä¼—å¤šGCä¸­æœ€å­¤ç‹¬çš„ä¸€ä¸ªã€‚æ˜¯ç¬¬ä¸€æ¬¾ä¸ç”±Oracleå…¬å¸å›¢é˜Ÿé¢†å¯¼å¼€å‘çš„HotSpotåƒåœ¾å›æ”¶å™¨ï¼Œã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­è¯´å®ƒå› æ­¤è€Œä¸å¯é¿å…åœ°æ”¶åˆ°å®˜æ–¹çš„æ’æŒ¤ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œå¦‚æœOracleå°†å®ƒå‘å¸ƒåˆ°Oracle JDKçš„å•†ä¸šç‰ˆæœ¬ä¸­ï¼Œå‡ºç°é—®é¢˜å°†éš¾ä»¥ç»´æŠ¤ã€‚</p>
<p>Shenandoahåƒåœ¾å›æ”¶å™¨æœ€åˆç”±RedHatè¿›è¡Œçš„ä¸€é¡¹åƒåœ¾å›æ”¶å™¨ç ”ç©¶é¡¹ç›®Pauseless GCçš„å®ç°ï¼Œæ—¨åœ¨é’ˆå¯¹JVMä¸Šçš„å†…å­˜å›æ”¶å®ç°ä½åœé¡¿çš„éœ€æ±‚ã€‚åœ¨2014å¹´è´¡çŒ®ç»™Open JDKã€‚</p>
<p>RedHatç ”å‘Shenandoahå›¢é˜Ÿå¯¹å¤–å®£ç§°ï¼ŒShenandoahåƒåœ¾å›æ”¶å™¨çš„æš‚åœæ—¶é—´ä¸å †å¤§å°æ— å…³ï¼Œè¿™æ„å‘³ç€å°†å †è®¾ç½®ä¸º200MBè¿˜æ˜¯200GBï¼Œ99.9%çš„ç›®æ ‡éƒ½å¯ä»¥æŠŠåƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´é™åˆ¶åœ¨åæ¯«ç§’ä»¥å†…ã€‚ä¸è¿‡å®é™…ä½¿ç”¨æ€§èƒ½å°†å–å†³äºå®é™…å·¥ä½œå †çš„å¤§å°å’Œå·¥ä½œè´Ÿè½½ã€‚</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker</title>
    <url>/posts/f5f9fa9b/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ğŸ“–æ¦‚è¿°"><a href="#ğŸ“–æ¦‚è¿°" class="headerlink" title="ğŸ“–æ¦‚è¿°"></a>ğŸ“–æ¦‚è¿°</h2>

<blockquote>
<p>æ•…äº‹</p>
</blockquote>
<p>2010å¹´ï¼Œå‡ ä¸ªæ IT çš„å¹´è½»äººï¼Œåœ¨ç¾å›½æ—§é‡‘å±±æˆç«‹äº†ä¸€å®¶åå« <code>dotCloud </code>çš„å…¬å¸ã€‚<code>dotCloud </code>çš„å¹³å°å³æœåŠ¡ï¼ˆPlatform-as-a-Serviceï¼‰æä¾›å•†ã€‚åº•å±‚æŠ€æœ¯ä¸Šï¼Œ<code>dotCloud</code> å¹³å°åˆ©ç”¨äº†<code>Linux</code>çš„ <code>LXC </code>å®¹å™¨æŠ€æœ¯ã€‚ä¸ºäº†æ–¹ä¾¿åˆ›å»ºå’Œç®¡ç†è¿™äº›å®¹å™¨ï¼Œ<code>dotCloud </code>åŸºäº Google å…¬å¸æ¨å‡ºçš„ <code>Go </code>è¯­è¨€å¼€å‘äº†ä¸€å¥—å†…éƒ¨å·¥å…·ï¼Œä¹‹åè¢«å‘½åä¸º <code>Docker</code>ã€‚<code>Docker </code>å°±æ˜¯è¿™æ ·è¯ç”Ÿçš„ã€‚</p>
<p>2013å¹´çš„åç«¯æŠ€æœ¯é¢†åŸŸå·²ç»å¤ªä¹…æ²¡æœ‰å‡ºç°è®©äººæŒ¯å¥‹çš„ä¸œè¥¿äº†ã€‚å½“ç„¶<code>Docker</code>åœ¨å‘è¡Œä¹‹åä¹Ÿæ²¡ç”¨å¼•èµ·è¡Œä¸šçš„å…³æ³¨ã€‚åœ¨å¼€æºä¹‹åæ‰çˆ†ç«ã€‚</p>
<p><code>Docker</code>å®šä¹‰å®¹å™¨æŠ€æœ¯æ ‡ç –ä½¿å¾—å®¹å™¨æŠ€æœ¯çš„è½åœ°å˜å¾—ååˆ†ç®€å•ï¼Œåº”ç”¨å¯ä»¥ç¨³å®šä¾¿æºçš„è¿è¡Œåœ¨å®¹å™¨ä¸­ã€‚</p>
<a id="more"></a>



<blockquote>
<p>ç‰¹ç‚¹</p>
</blockquote>
<ul>
<li><strong>æ›´å¿«é€Ÿçš„åº”ç”¨äº¤ä»˜å’Œéƒ¨ç½²</strong></li>
<li><strong>æ›´ä¾¿æ·çš„å‡çº§å’Œæ‰©ç¼©å®¹</strong></li>
<li><strong>æ›´é«˜æ•ˆçš„è®¡ç®—èµ„æºåˆ©ç”¨</strong></li>
<li><strong>æ›´ç®€å•çš„ç³»ç»Ÿè¿ç»´</strong></li>
</ul>
<blockquote>
<p>æ¶æ„</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/Docker%E6%9E%B6%E6%9E%84.jpg" class="" title="Docker">

<p><strong>é•œåƒï¼ˆimageï¼‰ï¼š</strong> ç›¸å½“äºä¸€ä¸ªæ¨¡æ¿ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ¨¡æ¿æ¥åˆ›å»ºå®¹å™¨æœåŠ¡</p>
<p><strong>å®¹å™¨ï¼ˆcontainerï¼‰ï¼š</strong> ç‹¬ç«‹è¿è¡Œä¸€ä¸ªæˆ–è€…ä¸€ä¸ªç»„åº”ç”¨</p>
<p><strong>ä»“åº“ï¼ˆrepositoryï¼‰ï¼š</strong> å­˜æ”¾é•œåƒçš„åœ°æ–¹</p>
<br>

<h2 id="ğŸ”¨å®‰è£…"><a href="#ğŸ”¨å®‰è£…" class="headerlink" title="ğŸ”¨å®‰è£…"></a>ğŸ”¨å®‰è£…</h2><blockquote>
<p>å®˜æ–¹æ–‡æ¡£</p>
</blockquote>
<p>CentOS 7å®‰è£…ï¼š<a href="https://docs.docker.com/engine/install/centos/">https://docs.docker.com/engine/install/centos/</a></p>
<blockquote>
<p>å¸è½½æ—§ç‰ˆæœ¬</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum remove docker \</span></span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure>



<blockquote>
<p>è®¾ç½®å­˜å‚¨åº“</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install -y yum-utils</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>æ›´æ¢é•œåƒæº</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>æ›´æ–°YUMåŒ…</p>
<p>æ›´æ–°YUMç´¢å¼•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum update</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo yum makecache fast</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>å®‰è£…dockerå¼•æ“å’Œå®¹å™¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install docker-ce docker-ce-cli containerd.io</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>å¯åŠ¨Dockerå¹¶æµ‹è¯•hello-world</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl start docker</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo docker run hello-world</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>å¸è½½æ–¹å¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum remove docker-ce docker-ce-cli containerd.io</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo rm -rf /var/lib/docker</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>é•œåƒåŠ é€Ÿ</p>
</blockquote>
<p>1ï¸âƒ£ä½¿ç”¨é˜¿é‡Œé•œåƒåŠ é€Ÿå™¨</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201206122604398.png" class="" title="image-20201206122604398">

<p>2ï¸âƒ£ä½¿ç”¨ä¸­ç§‘å¤§æˆ–è€…ç½‘æ˜“é•œåƒåŠ é€Ÿ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æ·»åŠ daemon.json</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> touch /etc/docker/daemon.json</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å†™å…¥å†…å®¹å¹¶ä¿å­˜</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç§‘å¤§æº: https://docker.mirrors.ustc.edu.cn/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç½‘æ˜“æºï¼šhttp://hub-mirror.c.163.com</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn/&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é‡å¯Docker</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl restart docker</span></span><br></pre></td></tr></table></figure>

<br>

<h2 id="ğŸš€åŸç†"><a href="#ğŸš€åŸç†" class="headerlink" title="ğŸš€åŸç†"></a>ğŸš€åŸç†</h2><blockquote>
<p>docker runçš„æ‰§è¡Œæµç¨‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201203233730702.png" class="" title="image-20201203233730702">

<blockquote>
<p>Dockerçš„å·¥ä½œ</p>
</blockquote>
<p>Dockeræ˜¯ä¸€ä¸ªClient-Serverç»“æ„çš„ç³»ç»Ÿï¼ŒDockerçš„å®ˆæŠ¤è¿›ç¨‹è¿è¡Œåœ¨ä¸»æœºä¸Šã€‚é€šè¿‡Socketä»å®¢æˆ·ç«¯è®¿é—®ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆDockeræ¯”VMå¿«ï¼Ÿ</strong></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201204003500802.png" class="" title="image-20201204003500802">

<p>1ã€Dockeræœ‰æ¯”è™šæ‹Ÿæœºæ›´å°‘çš„æŠ½è±¡å±‚ã€‚Dockerä¸éœ€è¦Hypervisorå®ç°ç¡¬ä»¶èµ„æºè™šæ‹ŸåŒ–ï¼Œè¿è¡Œåœ¨Dockerå®¹å™¨ä¸Šçš„ç¨‹åºç›´æ¥ä½¿ç”¨çš„æ˜¯å®é™…ç‰©ç†æœºçš„ç¡¬ä»¶èµ„æºï¼Œå› æ­¤åœ¨CPUã€å†…å­˜åˆ©ç”¨ç‡ä¸ŠDockerå°†ä¼šåœ¨æ•ˆç‡ä¸Šæœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚</p>
<p>2ã€Dockeråˆ©ç”¨çš„æ˜¯å®¿ä¸»æœºçš„å†…æ ¸ï¼Œè€Œä¸éœ€è¦Guest OSã€‚å› æ­¤åˆ›å»ºä¸€ä¸ªå®¹å™¨æ—¶ï¼Œä¸éœ€è¦å’Œè™šæ‹Ÿæœºä¸€æ ·é‡æ–°åŠ è½½ä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸ã€‚ä»è€Œé¿å…å¼•å¯»ã€åŠ è½½æ“ä½œç³»ç»Ÿå†…æ ¸è¿”å›æ—¶è€—æ—¶è€—èµ„æºçš„è¿‡ç¨‹ï¼Œå½“æ–°å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ—¶ï¼Œè™šæ‹Ÿæœºè½¯ä»¶éœ€è¦åŠ è½½Guest OSï¼Œè¿”å›æ–°å»ºè¿‡ç¨‹æ˜¯åˆ†é’Ÿçº§åˆ«çš„ã€‚è€Œæ–°å»ºä¸€ä¸ªDockerå®¹å™¨åªéœ€è¦å‡ ç§’é’Ÿã€‚</p>
<p>3ã€Dockerä¸VMç›¸æ¯”ï¼š</p>
<ul>
<li>Dockerçµæ´»ï¼ŒVMç¬¨é‡</li>
<li>Dockerå­˜å‚¨çš„é•œåƒå°ï¼Œä¾¿äºå­˜å‚¨å’Œä¼ è¾“ï¼ŒVMé•œåƒåºå¤§</li>
</ul>
<br>

<h2 id="ğŸ”°å‘½ä»¤"><a href="#ğŸ”°å‘½ä»¤" class="headerlink" title="ğŸ”°å‘½ä»¤"></a>ğŸ”°å‘½ä»¤</h2><blockquote>
<p>ğŸŒå®˜æ–¹æ–‡æ¡£</p>
</blockquote>
<p>Command-line referenceï¼š<a href="https://docs.docker.com/reference/">https://docs.docker.com/reference/</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201204225734966.png" class="" title="image-20201204225734966">

<br>

<h3 id="1ï¸âƒ£å¸®åŠ©å‘½ä»¤"><a href="#1ï¸âƒ£å¸®åŠ©å‘½ä»¤" class="headerlink" title="1ï¸âƒ£å¸®åŠ©å‘½ä»¤"></a>1ï¸âƒ£å¸®åŠ©å‘½ä»¤</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker version    <span class="comment"># æ˜¾ç¤ºDockerç‰ˆæœ¬ä¿¡æ¯</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker info       <span class="comment"># æ˜¾ç¤ºDockerç³»ç»Ÿä¿¡æ¯</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker --<span class="built_in">help</span>     <span class="comment"># Dockerå‘½ä»¤å¸®åŠ©ä¿¡æ¯</span></span></span><br></pre></td></tr></table></figure>

<br>

<h3 id="2ï¸âƒ£é•œåƒå‘½ä»¤"><a href="#2ï¸âƒ£é•œåƒå‘½ä»¤" class="headerlink" title="2ï¸âƒ£é•œåƒå‘½ä»¤"></a>2ï¸âƒ£é•œåƒå‘½ä»¤</h3><blockquote>
<p>æŸ¥çœ‹é•œåƒ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker images</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯é€‰é¡¹</span></span><br><span class="line">-a, --all             # åˆ—å‡ºæ‰€æœ‰é•œåƒ</span><br><span class="line">    --digests         # æ˜¾ç¤ºé•œåƒçš„æ‘˜è¦ä¿¡æ¯</span><br><span class="line">-q, --quiet           # åªæ˜¾ç¤ºé•œåƒçš„ID</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿è¡Œ</span></span><br><span class="line">[root@parak khighness]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">hello-world         latest              bf756fb1ae65        11 months ago       13.3kB</span><br><span class="line"><span class="meta">#</span><span class="bash"> è§£é‡Š</span></span><br><span class="line">REPOSITORY  é•œåƒçš„ä»“åº“æº</span><br><span class="line">TAG         é•œåƒçš„æ ‡ç­¾</span><br><span class="line">IMAGE ID    é•œåƒçš„ID</span><br><span class="line">CREATED     é•œåƒçš„åˆ›å»ºæ—¶é—´</span><br><span class="line">SIZE        é•œåƒçš„å¤§å°</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æœç´¢é•œåƒ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker search &lt;IMAGE&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯é€‰é¡¹</span></span><br><span class="line">--filter=STARS=1000 # é•œåƒçš„STARSå¤§äº1000</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ä¸‹è½½é•œåƒ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull &lt;IMAGE&gt;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker pull .io/library/mysql:latest</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¦‚æœä¸å†™tagï¼Œé»˜è®¤å°±æ˜¯æœ€æ–°çš„</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŒ‡å®šç‰ˆæœ¬ä¸‹è½½</span></span><br><span class="line">[root@parak khighness]# docker pull mysql:8.0.20</span><br><span class="line">8.0.20: Pulling from library/mysql  # åˆ†å±‚ä¸‹è½½</span><br><span class="line">8559a31e96f4: Pull complete </span><br><span class="line">d51ce1c2e575: Pull complete </span><br><span class="line">c2344adc4858: Pull complete </span><br><span class="line">fcf3ceff18fc: Pull complete </span><br><span class="line">16da0c38dc5b: Pull complete </span><br><span class="line">b905d1797e97: Pull complete </span><br><span class="line">4b50d1c6b05c: Pull complete </span><br><span class="line">c75914a65ca2: Pull complete </span><br><span class="line">1ae8042bdd09: Pull complete </span><br><span class="line">453ac13c00a3: Pull complete </span><br><span class="line">9e680cd72f08: Pull complete </span><br><span class="line">a6b5dc864b6c: Pull complete </span><br><span class="line">Digest: sha256:8b7b328a7ff6de46ef96bcf83af048cb00a1c86282bfca0cb119c84568b4caf6</span><br><span class="line">Status: Downloaded newer image for mysql:8.0.20</span><br><span class="line">docker.io/library/mysql:8.0.20</span><br></pre></td></tr></table></figure>



<blockquote>
<p>åˆ é™¤é•œåƒ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> é€šè¿‡é•œåƒIDåˆ é™¤</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker rmi -f &lt;IMAGE ID&gt; ...</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ é™¤æ‰€æœ‰é•œåƒ</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker rmi -f $(docker images -aq)0</span></span><br></pre></td></tr></table></figure>

<br>

<h3 id="3ï¸âƒ£å®¹å™¨å‘½ä»¤"><a href="#3ï¸âƒ£å®¹å™¨å‘½ä»¤" class="headerlink" title="3ï¸âƒ£å®¹å™¨å‘½ä»¤"></a>3ï¸âƒ£å®¹å™¨å‘½ä»¤</h3><blockquote>
<p>ä¸‹è½½ä¸€ä¸ªCentOSé•œåƒæ¥æµ‹è¯•å­¦(å¥—)ä¹ (å¨ƒ)</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@parak khighness]# docker pull centos</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/centos</span><br><span class="line">3c72a8ed6814: Pull complete </span><br><span class="line">Digest: sha256:76d24f3ba3317fa945743bb3746fbaf3a0b752f10b10376960de01da70685fbd</span><br><span class="line">Status: Downloaded newer image for centos:latest</span><br><span class="line">docker.io/library/centos:latest</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æ–°å»ºå®¹å™¨å¹¶å¯åŠ¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run [å¯é€‰å‚æ•°] &lt;IMAGE&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å‚æ•°è¯´æ˜</span></span><br><span class="line">--name=&quot;NAME&quot;   å®¹å™¨åå­—ï¼Œç”¨äºåŒºåˆ†å®¹å™¨</span><br><span class="line">-d              åå°æ–¹å¼è¿è¡Œ</span><br><span class="line">-it             ä½¿ç”¨äº¤äº’æ–¹å¼è¿è¡Œï¼Œè¿›å¦‚å®¹å™¨æŸ¥çœ‹å†…å®¹</span><br><span class="line">-p              æŒ‡å®šå®¹å™¨ç«¯å£  -p 8080:8080</span><br><span class="line">	-p ip:ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£</span><br><span class="line">	-p ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£</span><br><span class="line">	-p å®¹å™¨ç«¯å£</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æµ‹è¯•ï¼Œå¯åŠ¨å¹¶è¿›å…¥å®¹å™¨</span></span><br><span class="line">[root@parak khighness]# docker run -it centos /bin/bash</span><br><span class="line">[root@e4efa1c507b8 /]# ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä»å®¹å™¨ä¸­é€€å›ä¸»æœº</span></span><br><span class="line">[root@e4efa1c507b8 /]# exit</span><br><span class="line">exit</span><br><span class="line">[root@parak khighness]# ls</span><br><span class="line">å…¬å…±  æ¨¡æ¿  è§†é¢‘  å›¾ç‰‡  æ–‡æ¡£  ä¸‹è½½  éŸ³ä¹  æ¡Œé¢</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æŸ¥çœ‹å®¹å™¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker ps  <span class="comment"># æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span></span></span><br><span class="line">-a           # æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨+å†å²è¿è¡Œè¿‡çš„å®¹å™¨</span><br><span class="line">-n=?         # æ˜¾ç¤ºæœ€è¿‘åˆ›å»ºçš„nä¸ªå®¹å™¨</span><br><span class="line">-q           # åªæ˜¾ç¤ºå®¹å™¨çš„ç¼–å·</span><br></pre></td></tr></table></figure>



<blockquote>
<p>é€€å‡ºå®¹å™¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">exit</span>        </span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>åˆ é™¤å®¹å™¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker rm &lt;Container ID/NAME&gt;    <span class="comment"># åˆ é™¤æŒ‡å®šçš„å®¹å™¨ï¼Œä¸èƒ½åˆ é™¤åªåœ¨è¿è¡Œçš„å®¹å™¨</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker rm -f $(docker ps -aq)    <span class="comment"># åˆ é™¤æ‰€æœ‰çš„å®¹å™¨</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker ps -a -q|xargs docker rm  <span class="comment"># åˆ é™¤æ‰€æœ‰çš„å®¹å™¨ </span></span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>å®¹å™¨æ“ä½œ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker start   &lt;Container ID/NAME&gt;  <span class="comment"># å¯åŠ¨å®¹å™¨ </span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker restart &lt;Container ID/NAME&gt;  <span class="comment"># é‡å¯å®¹å™¨</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker stop    &lt;Container ID/NAME&gt;  <span class="comment"># åœæ­¢å½“å‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">kill</span>    &lt;Container ID/NAME&gt;  <span class="comment"># å¼ºåˆ¶åœæ­¢å½“å‰å®¹å™¨</span></span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>æŸ¥çœ‹æ—¥å¿—</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker logs -tf --tail &lt;n&gt; &lt;Container ID/NAME&gt; <span class="comment"># æ˜¾ç¤ºæŒ‡å®šè¡Œæ•°çš„æ—¥å¿—</span></span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>æŸ¥çœ‹å®¹å™¨ä¸­è¿›ç¨‹ä¿¡æ¯</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker top &lt;Container ID/NAME&gt;</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>æŸ¥çœ‹é•œåƒçš„å…ƒæ•°æ®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker inspect</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>è¿›å…¥å½“å‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it &lt;Container ID&gt; bashShell  </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿›å…¥å®¹å™¨åå¼€å¯ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œå¯ä»¥åœ¨é‡Œé¢æ“ä½œï¼›</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exec</span>ä¹‹åä¸ä¼šç»ˆç»“å½“å‰å®¹å™¨è¿›ç¨‹</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker attach &lt;Container ID&gt;              </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿›å…¥å®¹å™¨ä¸­æ­£åœ¨æ‰§è¡Œçš„ç»ˆç«¯ï¼Œä¸ä¼šå¯åŠ¨æ–°çš„è¿›ç¨‹</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">exec</span>ä¹‹åç»ˆç»“å½“å‰å®¹å™¨è¿›ç¨‹</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>ä»å®¹å™¨æ‹·è´æ–°çš„ä¸œè¥¿åˆ°ä¸»æœº</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¼€å¯CentOSå®¹å™¨</span></span><br><span class="line">[root@parak khighness]# docker start b9ace468ea7d</span><br><span class="line">b9ace468ea7d</span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿›å…¥CentOSå®¹å™¨</span></span><br><span class="line">[root@parak khighness]# docker attach b9ace468ea7d</span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºæ–‡ä»¶å¤¹å’Œæ–‡ä»¶</span></span><br><span class="line">[root@b9ace468ea7d /]# cd home/</span><br><span class="line">[root@b9ace468ea7d home]# mkdir document </span><br><span class="line">[root@b9ace468ea7d home]# vi K1.java</span><br><span class="line"><span class="meta">#</span><span class="bash"> é€€å‡ºå®¹å™¨</span></span><br><span class="line">[root@b9ace468ea7d document]# exit</span><br><span class="line">exit</span><br><span class="line"><span class="meta">#</span><span class="bash"> å°†å®¹å™¨æ–‡ä»¶å¤åˆ¶åˆ°ä¸»æœºä¸Š</span></span><br><span class="line">[root@parak khighness]# docker cp b9ace468ea7d:/home/document/K1.java document/</span><br><span class="line">[root@parak khighness]# cd document/</span><br><span class="line">[root@parak document]# ll</span><br><span class="line">æ€»ç”¨é‡ 4</span><br><span class="line">-rw-r--r--. 1 root root 186 12æœˆ  5 11:33 K1.java</span><br></pre></td></tr></table></figure>

<br>

<h2 id="ğŸ”±ç»ƒä¹ "><a href="#ğŸ”±ç»ƒä¹ " class="headerlink" title="ğŸ”±ç»ƒä¹ "></a>ğŸ”±ç»ƒä¹ </h2><br>

<h3 id="ğŸŒ -å®‰è£…Nginx"><a href="#ğŸŒ -å®‰è£…Nginx" class="headerlink" title="ğŸŒ  å®‰è£…Nginx"></a>ğŸŒ  å®‰è£…Nginx</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æœç´¢é•œåƒ</span></span><br><span class="line">[root@parak khighness]# docker search nginx</span><br><span class="line">NAME                               DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span><br><span class="line">nginx                              Official build of Nginx.                        14063               [OK]                </span><br><span class="line">jwilder/nginx-proxy                Automated Nginx reverse proxy for docker conâ€¦   1912                                    [OK]</span><br><span class="line">richarvey/nginx-php-fpm            Container running Nginx + PHP-FPM capable ofâ€¦   795                                     [OK]</span><br><span class="line">linuxserver/nginx                  An Nginx container, brought to you by LinuxSâ€¦   131                                     </span><br><span class="line">jc21/nginx-proxy-manager           Docker container for managing Nginx proxy hoâ€¦   115                                     </span><br><span class="line">tiangolo/nginx-rtmp                Docker image with Nginx using the nginx-rtmpâ€¦   105                                     [OK]</span><br><span class="line">bitnami/nginx                      Bitnami nginx Docker Image                      90                                      [OK]</span><br><span class="line">alfg/nginx-rtmp                    NGINX, nginx-rtmp-module and FFmpeg from souâ€¦   80                                      [OK]</span><br><span class="line">jlesage/nginx-proxy-manager        Docker container for Nginx Proxy Manager        72                                      [OK]</span><br><span class="line">nginxdemos/hello                   NGINX webserver that serves a simple page coâ€¦   63                                      [OK]</span><br><span class="line">nginx/nginx-ingress                NGINX Ingress Controller for Kubernetes         45                                      </span><br><span class="line">privatebin/nginx-fpm-alpine        PrivateBin running on an Nginx, php-fpm &amp; Alâ€¦   42                                      [OK]</span><br><span class="line">nginxinc/nginx-unprivileged        Unprivileged NGINX Dockerfiles                  21                                      </span><br><span class="line">schmunk42/nginx-redirect           A very simple container to redirect HTTP traâ€¦   19                                      [OK]</span><br><span class="line">nginx/nginx-prometheus-exporter    NGINX Prometheus Exporter                       15                                      </span><br><span class="line">centos/nginx-112-centos7           Platform for running nginx 1.12 or building â€¦   15                                      </span><br><span class="line">staticfloat/nginx-certbot          Opinionated setup for automatic TLS certs loâ€¦   14                                      [OK]</span><br><span class="line">raulr/nginx-wordpress              Nginx front-end for the official wordpress:fâ€¦   13                                      [OK]</span><br><span class="line">centos/nginx-18-centos7            Platform for running nginx 1.8 or building nâ€¦   13                                      </span><br><span class="line">mailu/nginx                        Mailu nginx frontend                            8                                       [OK]</span><br><span class="line">bitwarden/nginx                    The Bitwarden nginx web server acting as a râ€¦   7                                       </span><br><span class="line">flashspys/nginx-static             Super Lightweight Nginx Image                   7                                       [OK]</span><br><span class="line">bitnami/nginx-ingress-controller   Bitnami Docker Image for NGINX Ingress Contrâ€¦   6                                       [OK]</span><br><span class="line">wodby/nginx                        Generic nginx                                   1                                       [OK]</span><br><span class="line">ansibleplaybookbundle/nginx-apb    An APB to deploy NGINX                          1                                       [OK]</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹è½½é•œåƒ</span></span><br><span class="line">[root@parak khighness]# docker pull nginx</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/nginx</span><br><span class="line">852e50cd189d: Pull complete </span><br><span class="line">571d7e852307: Pull complete </span><br><span class="line">addb10abd9cb: Pull complete </span><br><span class="line">d20aa7ccdb77: Pull complete </span><br><span class="line">8b03f1e11359: Pull complete </span><br><span class="line">Digest: sha256:6b1daa9462046581ac15be20277a7c75476283f969cb3a61c8725ec38d3b01c3</span><br><span class="line">Status: Downloaded newer image for nginx:latest</span><br><span class="line">docker.io/library/nginx:latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹é•œåƒ</span></span><br><span class="line">[root@parak khighness]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">nginx               latest              bc9a0695f571        10 days ago         133MB</span><br><span class="line">centos              latest              0d120b6ccaa8        3 months ago        215MB</span><br><span class="line">mysql               8.0.20              be0dbf01a0f3        5 months ago        541MB</span><br><span class="line">hello-world         latest              bf756fb1ae65        11 months ago       13.3kB</span><br><span class="line"><span class="meta">#</span><span class="bash"> åå°å¯åŠ¨80ç«¯å£nginxï¼Œå¯¹å¤–å¼€æ”¾3355ç«¯å£</span></span><br><span class="line">[root@parak khighness]# docker run -d --name nginx1 -p 3355:80 nginx </span><br><span class="line">b6072408f44cd78594f01c95bc63da6baf911f74d62bf232ec42c1cd8b08b4d0</span><br><span class="line">[root@parak khighness]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                  NAMES</span><br><span class="line">b6072408f44c        nginx               &quot;/docker-entrypoint.â€¦&quot;   6 seconds ago       Up 4 seconds        0.0.0.0:3355-&gt;80/tcp   nginx1</span><br><span class="line"><span class="meta">#</span><span class="bash"> æµ‹è¯•ï¼Œå¯ä»¥ç”¨ip:3355åœ¨æµè§ˆå™¨è®¿é—®</span></span><br><span class="line">[root@parak khighness]# curl localhost:3355</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="ğŸŒ -å®‰è£…Tomcat"><a href="#ğŸŒ -å®‰è£…Tomcat" class="headerlink" title="ğŸŒ  å®‰è£…Tomcat"></a>ğŸŒ  å®‰è£…Tomcat</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@parak khighness]# docker pull tomcat:9.0</span><br><span class="line">9.0: Pulling from library/tomcat</span><br><span class="line">756975cb9c7e: Pull complete </span><br><span class="line">d77915b4e630: Pull complete </span><br><span class="line">5f37a0a41b6b: Pull complete </span><br><span class="line">96b2c1e36db5: Pull complete </span><br><span class="line">27a2d52b526e: Pull complete </span><br><span class="line">a867dba77389: Pull complete </span><br><span class="line">0939c055fb79: Pull complete </span><br><span class="line">0b0694ce0ae2: Pull complete </span><br><span class="line">81a5f8099e05: Pull complete </span><br><span class="line">c3d7917d545e: Pull complete </span><br><span class="line">Digest: sha256:a319b10d8729817c7ce0bcc2343a6f97711c7870395019340d96b6aafd6ccbea</span><br><span class="line">Status: Downloaded newer image for tomcat:9.0</span><br><span class="line">docker.io/library/tomcat:9.0</span><br><span class="line"></span><br><span class="line">[root@parak khighness]# docker run -d -p 3355:8080 --name tomcat1 tomcat</span><br><span class="line">48c7de09007af158b13a9bef1f2d2b77bed0c4bc2f93a4887eac427911118a9b</span><br><span class="line">[root@parak khighness]# docker exec -it tomcat1 /bin/bash</span><br><span class="line">root@48c7de09007a:/usr/local/tomcat# ls -al</span><br><span class="line">total 128</span><br><span class="line">drwxr-xr-x. 1 root root    30 Nov 19 06:16 .</span><br><span class="line">drwxr-xr-x. 1 root root    20 Nov 19 06:12 ..</span><br><span class="line">-rw-r--r--. 1 root root 18982 Nov 12 15:41 BUILDING.txt</span><br><span class="line">-rw-r--r--. 1 root root  5409 Nov 12 15:41 CONTRIBUTING.md</span><br><span class="line">-rw-r--r--. 1 root root 57092 Nov 12 15:41 LICENSE</span><br><span class="line">-rw-r--r--. 1 root root  2333 Nov 12 15:41 NOTICE</span><br><span class="line">-rw-r--r--. 1 root root  3257 Nov 12 15:41 README.md</span><br><span class="line">-rw-r--r--. 1 root root  6898 Nov 12 15:41 RELEASE-NOTES</span><br><span class="line">-rw-r--r--. 1 root root 16507 Nov 12 15:41 RUNNING.txt</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Nov 19 06:16 bin</span><br><span class="line">drwxr-xr-x. 1 root root    22 Dec  5 13:15 conf</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Nov 19 06:16 lib</span><br><span class="line">drwxrwxrwx. 1 root root   177 Dec  5 13:15 logs</span><br><span class="line">drwxr-xr-x. 2 root root   134 Nov 19 06:16 native-jni-lib</span><br><span class="line">drwxrwxrwx. 2 root root    30 Nov 19 06:16 temp</span><br><span class="line">drwxr-xr-x. 2 root root     6 Nov 19 06:16 webapps</span><br><span class="line">drwxr-xr-x. 7 root root    81 Nov 12 15:38 webapps.dist</span><br><span class="line">drwxrwxrwx. 2 root root     6 Nov 12 15:35 work</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯ä»¥å‘ç°webappsç›®å½•ä¸ºç©º</span></span><br><span class="line">root@48c7de09007a:/usr/local/tomcat# cd webapps</span><br><span class="line">root@48c7de09007a:/usr/local/tomcat/webapps# ls -l</span><br><span class="line">total 0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å°†webapps.listç›®å½•ä¸‹çš„å†…å®¹æ‹·è´åˆ°webappsä¸‹ï¼Œå†ç”¨æµè§ˆå™¨æµ‹è¯•è®¿é—®</span></span><br><span class="line">root@48c7de09007a:/usr/local/tomcat/webapps# cd ..</span><br><span class="line">root@48c7de09007a:/usr/local/tomcat# cd webapps.dist/</span><br><span class="line">root@48c7de09007a:/usr/local/tomcat/webapps.dist# ls</span><br><span class="line">ROOT  docs  examples  host-manager  manager</span><br><span class="line">root@48c7de09007a:/usr/local/tomcat/webapps.dist# cd ..</span><br><span class="line">root@48c7de09007a:/usr/local/tomcat# cp -r webapps.dist/* webapps/</span><br><span class="line">root@48c7de09007a:/usr/local/tomcat# cd webapps</span><br><span class="line">root@48c7de09007a:/usr/local/tomcat/webapps# ls</span><br><span class="line">ROOT  docs  examples  host-manager  manager</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æµ‹è¯•è®¿é—® <a href="http://192.168.117.155:3355/">http://192.168.117.155:3355/</a></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201205214537503.png" class="" title="image-20201205214537503">

<br>

<h3 id="ğŸŒ å®‰è£…es-kibana"><a href="#ğŸŒ å®‰è£…es-kibana" class="headerlink" title="ğŸŒ å®‰è£…es + kibana"></a>ğŸŒ å®‰è£…es + kibana</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> --net somenetwork ç½‘ç»œé…ç½®</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -d --name es1 -p 9200:9200 -p 9300:9300 -e <span class="string">&quot;discovery.type=single-node&quot;</span> elasticsearch:7.6.2</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹ä¸»æœºçŠ¶æ€</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> doucker stats</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹è½½å¹¶è¿è¡ŒES</span></span><br><span class="line">[root@parak khighness]#  docker run -d --name es1 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:7.6.2</span><br><span class="line">Unable to find image &#x27;elasticsearch:7.6.2&#x27; locally</span><br><span class="line">7.6.2: Pulling from library/elasticsearch</span><br><span class="line">ab5ef0e58194: Pull complete </span><br><span class="line">c4d1ca5c8a25: Pull complete </span><br><span class="line">941a3cc8e7b8: Pull complete </span><br><span class="line">43ec483d9618: Pull complete </span><br><span class="line">c486fd200684: Pull complete </span><br><span class="line">1b960df074b2: Pull complete </span><br><span class="line">1719d48d6823: Pull complete </span><br><span class="line">Digest: sha256:1b09dbd93085a1e7bca34830e77d2981521a7210e11f11eda997add1c12711fa</span><br><span class="line">Status: Downloaded newer image for elasticsearch:7.6.2</span><br><span class="line">51441d9abfb966c4baa0402ceb99e702f58ec68cd427710a2b8c8043983412e9</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹ä¸»æœºçŠ¶æ€</span></span><br><span class="line">[root@parak khighness]# docker stats</span><br><span class="line">CONTAINER ID    NAME   CPU %   MEM USAGE/LIMIT  MEM %     NET I/O    BLOCK I/O      PIDS</span><br><span class="line">51441d9abfb9    es1   42.74%  495.6MiB/972.4MiB 50.97%    656B/0B   4.76GB/629MB     46</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœæ­¢es1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker stop es1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ é™¤es1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker rm es1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é™åˆ¶å†…å­˜ï¼Œå¯åŠ¨ES</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -d --name es1 -p 9200:9200 -p 9300:9300 -e <span class="string">&quot;discovery.type=single-node&quot;</span> -e ES_JAVA_OPTS=<span class="string">&quot;-Xms64m -Xmx512m&quot;</span> elasticsearch:7.6.2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é‡æ–°å¯åŠ¨es1</span></span><br><span class="line">[root@parak khighness]# docker run -d --name es1 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; elasticsearch:7.6.2</span><br><span class="line">ca4494f52e5642d5992c49816b636b1858f2e2f5c1aaf38621c76001262e8e4d</span><br><span class="line"><span class="meta">#</span><span class="bash"> å†æ¬¡æŸ¥çœ‹çŠ¶æ€</span></span><br><span class="line">[root@parak khighness]# docker stats</span><br><span class="line">CONTAINER ID    NAME   CPU %   MEM USAGE/LIMIT   MEM %     NET I/O   BLOCK I/O       PIDS</span><br><span class="line">ca4494f52e56    es1    0.68%   357.5MiB/972.4MiB 36.77%    737B/0B   476MB/1.78MB     45</span><br><span class="line"><span class="meta">#</span><span class="bash"> æµ‹è¯•è®¿é—®</span></span><br><span class="line">[root@parak khighness]# curl localhost:9200</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;ca4494f52e56&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;docker-cluster&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;aDKZlZW_T7Ss3Dr0CXZQlQ&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;7.6.2&quot;,</span><br><span class="line">    &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot; : &quot;docker&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;ef48eb35cf30adf4db14086e8aabd07ef6fb113f&quot;,</span><br><span class="line">    &quot;build_date&quot; : &quot;2020-03-26T06:34:37.794943Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;8.4.0&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h2 id="ğŸ“ˆå¯è§†åŒ–"><a href="#ğŸ“ˆå¯è§†åŒ–" class="headerlink" title="ğŸ“ˆå¯è§†åŒ–"></a>ğŸ“ˆå¯è§†åŒ–</h2><p>Y1S1å¯è§†åŒ–é¢æ¿çš„å‰ç«¯å†™çš„çœŸå¥½çœ‹ï¼Œæˆ‘çˆ±äº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…è¿è¡Œ</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -d -p 8088:9000 --name=pt --restart=always -v /var/run/docker.sock:/var/run/docker.sock --privileged=<span class="literal">true</span> portainer/portainer</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>è®¿é—®æµ‹è¯• <a href="http://192.168.117.155:8088/">http://192.168.117.155:8088/</a></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="Docker/image-20201205232646075.png" alt="image-20201205232646075"  />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="Docker/image-20201206105337297.png" alt="image-20201206105337297"  />





<h2 id="ğŸ“‘DockerFile"><a href="#ğŸ“‘DockerFile" class="headerlink" title="ğŸ“‘DockerFile"></a>ğŸ“‘DockerFile</h2><p>DockerFileå°±æ˜¯ç”¨æ¥æ„å»ºdockeré•œåƒçš„æ„å»ºæ–‡ä»¶-å‘½ä»¤è„šæœ¬ã€‚</p>
<blockquote>
<p>å‘½ä»¤</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
<th align="center">ç†è§£</th>
</tr>
</thead>
<tbody><tr>
<td align="center">FROM</td>
<td align="center">æŒ‡å®šåŸºç¡€é•œåƒ</td>
<td align="center">å…¬å¸çš„çˆ¶å…¬å¸</td>
</tr>
<tr>
<td align="center">MAINTAINER</td>
<td align="center">æŒ‡å®šç»´æŠ¤è€…ä¿¡æ¯</td>
<td align="center">å…¬å¸æ³¨å†Œä¿¡æ¯</td>
</tr>
<tr>
<td align="center">RUN</td>
<td align="center">æŠŠå‘½ä»¤å‰é¢åŠ ä¸ŠRUNå³å¯</td>
<td align="center">å…¬å¸æ³¨å†Œæµç¨‹</td>
</tr>
<tr>
<td align="center">ADD</td>
<td align="center">COPYæ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨è§£å‹</td>
<td align="center">å…¬å¸æ³¨å†Œèµ„é‡‘</td>
</tr>
<tr>
<td align="center">WORKDIR</td>
<td align="center">è®¾ç½®å½“å‰å·¥ä½œç›®å½•</td>
<td align="center">å…¬å¸å¤§æ¥¼ä»“åº“</td>
</tr>
<tr>
<td align="center">VOLUMN</td>
<td align="center">æŒ‚è½½ä¸»æœºç›®å½•</td>
<td align="center">å…¬å¸çš„ä¸»ä»“åº“</td>
</tr>
<tr>
<td align="center">EXPOSE</td>
<td align="center">æŒ‡å®šå¯¹å¤–ç«¯å£</td>
<td align="center">å…¬å¸å¼€æ”¾å¤§é—¨</td>
</tr>
<tr>
<td align="center">RUN</td>
<td align="center">è¿›ç¨‹è¦ä¸€ç›´è¿è¡Œä¸‹å»</td>
<td align="center">å…¬å¸æ°¸ä¸å€’é—­</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">CMD</td>
<td align="center">æŒ‡å®šè¿™å®¹å™¨å¯åŠ¨çš„æ—¶å€™è¦è¿è¡Œçš„å‘½ä»¤åªæœ‰æœ€åä¸€ä¸ªä¼šç”Ÿæ•ˆï¼Œå¯è¢«æ›¿ä»£ã€‚</td>
</tr>
<tr>
<td align="center">ENTRYPOINT</td>
<td align="center">æŒ‡å®šè¿™ä¸ªå®¹å™¨å¯åŠ¨çš„æ—¶å€™è¦è¿è¡Œçš„å‘½ä»¤ï¼Œå¯ä»¥è¿½åŠ å‘½ä»¤ã€‚</td>
</tr>
<tr>
<td align="center">ONBUILD</td>
<td align="center">å½“æ„å»ºä¸€ä¸ªè¢«ç»§æ‰¿DockerFileè¿™å°±ä¼šè¿è¡ŒONBUILDæŒ‡ä»¤ã€‚è§¦å‘æŒ‡ä»¤.</td>
</tr>
<tr>
<td align="center">COPY</td>
<td align="center">ç±»ä¼¼ADDï¼Œå°†æ–‡ä»¶æ‹·è´åˆ°é•œåƒä¸­ã€‚</td>
</tr>
<tr>
<td align="center">ENV</td>
<td align="center">æ„å»ºçš„æ—¶å€™è®¾ç½®ç¯å¢ƒå˜é‡ã€‚</td>
</tr>
</tbody></table>
<blockquote>
<p>å®ä¾‹1-æµ‹è¯•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@parak home]# mkdir volume</span><br><span class="line">[root@parak home]# cd volume/</span><br><span class="line">[root@parak volume]# vim dockerfile1</span><br><span class="line">[root@parak volume]# cat dockerfile1 </span><br><span class="line">FROM centos</span><br><span class="line">VOLUME [&quot;volume01&quot;,&quot;volume02&quot;]</span><br><span class="line">CMD echo &quot;---end---&quot;</span><br><span class="line">CMD /bin/bash</span><br><span class="line">[root@parak volume]# docker build -f /home/volume/dockerfile1 -t khighness/centos:1.0 .</span><br><span class="line">Sending build context to Docker daemon  2.048kB</span><br><span class="line">Step 1/4 : FROM centos</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 0d120b6ccaa8</span></span><br><span class="line">Step 2/4 : VOLUME [&quot;volume01&quot;,&quot;volume02&quot;]</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 79dc7b449286</span></span><br><span class="line">Removing intermediate container 79dc7b449286</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 9a6608557c9a</span></span><br><span class="line">Step 3/4 : CMD echo &quot;---end---&quot;</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 8b8c40056f99</span></span><br><span class="line">Removing intermediate container 8b8c40056f99</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 2158b18dedff</span></span><br><span class="line">Step 4/4 : CMD /bin/bash</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 9d76c3598d69</span></span><br><span class="line">Removing intermediate container 9d76c3598d69</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 240a84cdfbef</span></span><br><span class="line">Successfully built 240a84cdfbef</span><br><span class="line">Successfully tagged khighness/centos:1.0</span><br></pre></td></tr></table></figure>



<blockquote>
<p>å®ä¾‹2-æ„å»ºè‡ªå·±çš„centos</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1ã€ç¼–å†™DockerFileæ–‡ä»¶</span></span><br><span class="line">[root@parak dockerfile]# vim mydockerfile-centos</span><br><span class="line">[root@parak dockerfile]# cat mydockerfile-centos </span><br><span class="line">FROM centos</span><br><span class="line">MAINTAINER khighness&lt;1823676372@qq.com&gt;</span><br><span class="line"></span><br><span class="line">ENV MYPATH /usr/local</span><br><span class="line">WORKDIR $MYPATH </span><br><span class="line"></span><br><span class="line">RUN yum -y install vim</span><br><span class="line">RUN yum -y install net-tools</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">CMD echo $MYPATH</span><br><span class="line">CMD echo &quot;---end---&quot;</span><br><span class="line">CMD /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2ã€é€šè¿‡DockerFileæ„å»ºé•œåƒ</span></span><br><span class="line">[root@parak dockerfile]# docker build -f mydockerfile-centos  -t mycentos:1.0 .</span><br><span class="line">Sending build context to Docker daemon  2.048kB</span><br><span class="line">Step 1/10 : FROM centos</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 0d120b6ccaa8</span></span><br><span class="line">Step 2/10 : MAINTAINER khighness&lt;1823676372@qq.com&gt;</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 024da1b1d4cc</span></span><br><span class="line">Removing intermediate container 024da1b1d4cc</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 6c9b636504d2</span></span><br><span class="line">Step 3/10 : ENV MYPATH /usr/local</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 4046d4e257ac</span></span><br><span class="line">Removing intermediate container 4046d4e257ac</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> a5710fdc760e</span></span><br><span class="line">Step 4/10 : WORKDIR $MYPATH</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 252416d49e94</span></span><br><span class="line">Removing intermediate container 252416d49e94</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> fdbae7da4ca4</span></span><br><span class="line">Step 5/10 : RUN yum -y install vim</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 9eb786294022</span></span><br><span class="line">CentOS-8 - AppStream                            288 kB/s | 6.2 MB     00:22    </span><br><span class="line">CentOS-8 - Base                                 703 kB/s | 2.3 MB     00:03    </span><br><span class="line">CentOS-8 - Extras                               1.3 kB/s | 8.1 kB     00:06    </span><br><span class="line">Dependencies resolved.</span><br><span class="line">================================================================================</span><br><span class="line"> Package             Arch        Version                   Repository      Size</span><br><span class="line">================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> vim-enhanced        x86_64      2:8.0.1763-15.el8         AppStream      1.4 M</span><br><span class="line">Installing dependencies:</span><br><span class="line"> gpm-libs            x86_64      1.20.7-15.el8             AppStream       39 k</span><br><span class="line"> vim-common          x86_64      2:8.0.1763-15.el8         AppStream      6.3 M</span><br><span class="line"> vim-filesystem      noarch      2:8.0.1763-15.el8         AppStream       48 k</span><br><span class="line"> which               x86_64      2.21-12.el8               BaseOS          49 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">================================================================================</span><br><span class="line">Install  5 Packages</span><br><span class="line"></span><br><span class="line">Total download size: 7.8 M</span><br><span class="line">Installed size: 30 M</span><br><span class="line">Downloading Packages:</span><br><span class="line">(1/5): gpm-libs-1.20.7-15.el8.x86_64.rpm        340 kB/s |  39 kB     00:00    </span><br><span class="line">(2/5): vim-filesystem-8.0.1763-15.el8.noarch.rp 664 kB/s |  48 kB     00:00    </span><br><span class="line">(3/5): which-2.21-12.el8.x86_64.rpm             315 kB/s |  49 kB     00:00    </span><br><span class="line">(4/5): vim-enhanced-8.0.1763-15.el8.x86_64.rpm  543 kB/s | 1.4 MB     00:02    </span><br><span class="line">(5/5): vim-common-8.0.1763-15.el8.x86_64.rpm    387 kB/s | 6.3 MB     00:16    </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Total                                           448 kB/s | 7.8 MB     00:17     </span><br><span class="line">warning: /var/cache/dnf/AppStream-02e86d1c976ab532/packages/gpm-libs-1.20.7-15.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 8483c65d: NOKEY</span><br><span class="line">CentOS-8 - AppStream                            1.6 MB/s | 1.6 kB     00:00    </span><br><span class="line">Importing GPG key 0x8483C65D:</span><br><span class="line"> Userid     : &quot;CentOS (CentOS Official Signing Key) &lt;security@centos.org&gt;&quot;</span><br><span class="line"> Fingerprint: 99DB 70FA E1D7 CE22 7FB6 4882 05B5 55B3 8483 C65D</span><br><span class="line"> From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial</span><br><span class="line">Key imported successfully</span><br><span class="line">Running transaction check</span><br><span class="line">Transaction check succeeded.</span><br><span class="line">Running transaction test</span><br><span class="line">Transaction test succeeded.</span><br><span class="line">Running transaction</span><br><span class="line">  Preparing        :                                                        1/1 </span><br><span class="line">  Installing       : which-2.21-12.el8.x86_64                               1/5 </span><br><span class="line">  Installing       : vim-filesystem-2:8.0.1763-15.el8.noarch                2/5 </span><br><span class="line">  Installing       : vim-common-2:8.0.1763-15.el8.x86_64                    3/5 </span><br><span class="line">  Installing       : gpm-libs-1.20.7-15.el8.x86_64                          4/5 </span><br><span class="line">  Running scriptlet: gpm-libs-1.20.7-15.el8.x86_64                          4/5 </span><br><span class="line">  Installing       : vim-enhanced-2:8.0.1763-15.el8.x86_64                  5/5 </span><br><span class="line">  Running scriptlet: vim-enhanced-2:8.0.1763-15.el8.x86_64                  5/5 </span><br><span class="line">  Running scriptlet: vim-common-2:8.0.1763-15.el8.x86_64                    5/5 </span><br><span class="line">  Verifying        : gpm-libs-1.20.7-15.el8.x86_64                          1/5 </span><br><span class="line">  Verifying        : vim-common-2:8.0.1763-15.el8.x86_64                    2/5 </span><br><span class="line">  Verifying        : vim-enhanced-2:8.0.1763-15.el8.x86_64                  3/5 </span><br><span class="line">  Verifying        : vim-filesystem-2:8.0.1763-15.el8.noarch                4/5 </span><br><span class="line">  Verifying        : which-2.21-12.el8.x86_64                               5/5 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  gpm-libs-1.20.7-15.el8.x86_64         vim-common-2:8.0.1763-15.el8.x86_64    </span><br><span class="line">  vim-enhanced-2:8.0.1763-15.el8.x86_64 vim-filesystem-2:8.0.1763-15.el8.noarch</span><br><span class="line">  which-2.21-12.el8.x86_64             </span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">Removing intermediate container 9eb786294022</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 491907dac3e2</span></span><br><span class="line">Step 6/10 : RUN yum -y install net-tools</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 3a13d71952e5</span></span><br><span class="line">Last metadata expiration check: 0:00:24 ago on Mon Dec  7 11:45:38 2020.</span><br><span class="line">Dependencies resolved.</span><br><span class="line">================================================================================</span><br><span class="line"> Package         Architecture Version                        Repository    Size</span><br><span class="line">================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> net-tools       x86_64       2.0-0.52.20160912git.el8       BaseOS       322 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">================================================================================</span><br><span class="line">Install  1 Package</span><br><span class="line"></span><br><span class="line">Total download size: 322 k</span><br><span class="line">Installed size: 942 k</span><br><span class="line">Downloading Packages:</span><br><span class="line">net-tools-2.0-0.52.20160912git.el8.x86_64.rpm   1.0 MB/s | 322 kB     00:00    </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Total                                           141 kB/s | 322 kB     00:02     </span><br><span class="line">Running transaction check</span><br><span class="line">Transaction check succeeded.</span><br><span class="line">Running transaction test</span><br><span class="line">Transaction test succeeded.</span><br><span class="line">Running transaction</span><br><span class="line">  Preparing        :                                                        1/1 </span><br><span class="line">  Installing       : net-tools-2.0-0.52.20160912git.el8.x86_64              1/1 </span><br><span class="line">  Running scriptlet: net-tools-2.0-0.52.20160912git.el8.x86_64              1/1 </span><br><span class="line">  Verifying        : net-tools-2.0-0.52.20160912git.el8.x86_64              1/1 </span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  net-tools-2.0-0.52.20160912git.el8.x86_64                                     </span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">Removing intermediate container 3a13d71952e5</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 0d095f331d4a</span></span><br><span class="line">Step 7/10 : EXPOSE 80</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 66d8aceea20c</span></span><br><span class="line">Removing intermediate container 66d8aceea20c</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> a86402c5f9b7</span></span><br><span class="line">Step 8/10 : CMD echo $MYPATH</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> b6af3ea8ff6a</span></span><br><span class="line">Removing intermediate container b6af3ea8ff6a</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 17533352607f</span></span><br><span class="line">Step 9/10 : CMD echo &quot;---end---&quot;</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> f015d24c9277</span></span><br><span class="line">Removing intermediate container f015d24c9277</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> cf7d78851a04</span></span><br><span class="line">Step 10/10 : CMD /bin/bash</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> d0f70eaa39ec</span></span><br><span class="line">Removing intermediate container d0f70eaa39ec</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> d59930f07e43</span></span><br><span class="line">Successfully built d59930f07e43</span><br><span class="line">Successfully tagged mycentos:1.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3ã€æµ‹è¯•è¿è¡Œï¼Œå®˜æ–¹çš„centosé•œåƒä¸­æ˜¯æ²¡æœ‰ç½‘ç»œå‘½ä»¤å’ŒVIMå‘½ä»¤çš„ï¼Œè€Œè‡ªå·±æ„å»ºçš„centosä¸­å·²ç»æœ‰</span></span><br><span class="line">[root@parak dockerfile]# docker run -it --name=mycen mycentos:1.0 </span><br><span class="line">[root@43b0b7eb76d8 local]# pwd</span><br><span class="line">/usr/local</span><br><span class="line">[root@43b0b7eb76d8 local]# vim test</span><br><span class="line">[root@43b0b7eb76d8 local]# cat test </span><br><span class="line">Khighness</span><br><span class="line">[root@43b0b7eb76d8 local]# ifconfig</span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.0.4  netmask 255.255.0.0  broadcast 172.17.255.255</span><br><span class="line">        ether 02:42:ac:11:00:04  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 8  bytes 656 (656.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0    </span><br><span class="line">[root@43b0b7eb76d8 local]# exit</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4ã€æŸ¥çœ‹é•œåƒçš„å˜æ›´å†å²</span></span><br><span class="line">[root@parak dockerfile]# docker history mycentos:1.0 </span><br><span class="line">IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT</span><br><span class="line">d59930f07e43        23 minutes ago      /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;/binâ€¦   0B          </span><br><span class="line">cf7d78851a04        23 minutes ago      /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;echoâ€¦   0B               </span><br><span class="line">17533352607f        23 minutes ago      /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;echoâ€¦   0B                  </span><br><span class="line">a86402c5f9b7        23 minutes ago      /bin/sh -c #(nop)  EXPOSE 80                    0B                  </span><br><span class="line">0d095f331d4a        23 minutes ago      /bin/sh -c yum -y install net-tools             23.2MB              </span><br><span class="line">491907dac3e2        23 minutes ago      /bin/sh -c yum -y install vim                   57.7MB              </span><br><span class="line">fdbae7da4ca4        24 minutes ago      /bin/sh -c #(nop) WORKDIR /usr/local            0B                  </span><br><span class="line">a5710fdc760e        24 minutes ago      /bin/sh -c #(nop)  ENV MYPATH=/usr/local        0B                  </span><br><span class="line">6c9b636504d2        24 minutes ago      /bin/sh -c #(nop)  MAINTAINER khighness&lt;1823â€¦   0B                  </span><br><span class="line">0d120b6ccaa8        3 months ago        /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B                  </span><br><span class="line">&lt;missing&gt;           3 months ago        /bin/sh -c #(nop)  LABEL org.label-schema.scâ€¦   0B                  </span><br><span class="line">&lt;missing&gt;           3 months ago        /bin/sh -c #(nop) ADD file:538afc0c5c964ce0dâ€¦   215MB         </span><br></pre></td></tr></table></figure>



<blockquote>
<p>CMDå’ŒENTRYPOINTçš„åŒºåˆ«</p>
</blockquote>
<p><strong>æµ‹è¯•CMD</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ç¼–å†™æµ‹è¯•CMDçš„dockerfile</span></span><br><span class="line">[root@parak dockerfile]# vim dockerfile-cmd-test1</span><br><span class="line"><span class="meta">#</span><span class="bash"> å†…å®¹å°±æ˜¯ä¸€ä¸ªCMDå‘½ä»¤</span></span><br><span class="line">[root@parak dockerfile]# cat dockerfile-cmd-test1 </span><br><span class="line">FROM centos</span><br><span class="line">CMD [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ„å»ºé•œåƒ</span></span><br><span class="line">[root@parak dockerfile]# docker build -f dockerfile-cmd-test1 -t cmdtest .</span><br><span class="line">Sending build context to Docker daemon  3.072kB</span><br><span class="line">Step 1/2 : FROM centos</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 0d120b6ccaa8</span></span><br><span class="line">Step 2/2 : CMD [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> e4df49ad7ca4</span></span><br><span class="line">Removing intermediate container e4df49ad7ca4</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 4be395747805</span></span><br><span class="line">Successfully built 4be395747805</span><br><span class="line">Successfully tagged cmdtest:latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿è¡Œé•œåƒå°±ç›¸å½“äºè¿è¡ŒCMDå‘½ä»¤ï¼šls -a</span></span><br><span class="line">[root@parak dockerfile]# docker run cmdtest</span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">lost+found</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿½åŠ å‘½ä»¤-lï¼Œå³ls -al</span></span><br><span class="line">[root@parak dockerfile]# docker run cmdtest -l</span><br><span class="line">docker: Error response from daemon: OCI runtime create failed: container_linux.go:349: starting container process caused &quot;exec: \&quot;-l\&quot;: executable file not found in $PATH&quot;: unknown.</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>æµ‹è¯•ENTRYPOINT</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ç¼–å†™æµ‹è¯•ENTRYPOINTçš„dockerfile</span></span><br><span class="line">[root@parak dockerfile]# vim dockerfile-entrypoint-test1</span><br><span class="line"><span class="meta">#</span><span class="bash"> å†…å®¹å°±æ˜¯ä¸€ä¸ªENTRYPOINTå‘½ä»¤</span></span><br><span class="line">[root@parak dockerfile]# cat dockerfile-entrypoint-test1 </span><br><span class="line">FROM centos</span><br><span class="line">ENTRYPOINT [&quot;ls&quot;, &quot;-a&quot;]</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ„å»ºé•œåƒ</span></span><br><span class="line">[root@parak dockerfile]# docker build -f dockerfile-entrypoint-test1 -t entrypointtest .</span><br><span class="line">Sending build context to Docker daemon  4.096kB</span><br><span class="line">Step 1/2 : FROM centos</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 0d120b6ccaa8</span></span><br><span class="line">Step 2/2 : ENTRYPOINT [&quot;ls&quot;, &quot;-a&quot;]</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 0aa9b4c97293</span></span><br><span class="line">Removing intermediate container 0aa9b4c97293</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 472d86e826d8</span></span><br><span class="line">Successfully built 472d86e826d8</span><br><span class="line">Successfully tagged entrypointtest:latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿è¡Œé•œåƒ</span></span><br><span class="line">[root@parak dockerfile]# docker run entrypointtest</span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">lost+found</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿½å‡»å‘½ä»¤-lï¼Œå³ls -al</span></span><br><span class="line">[root@parak dockerfile]# docker run entrypointtest -l</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x.   1 root root   6 Dec  7 12:27 .</span><br><span class="line">drwxr-xr-x.   1 root root   6 Dec  7 12:27 ..</span><br><span class="line">-rwxr-xr-x.   1 root root   0 Dec  7 12:27 .dockerenv</span><br><span class="line">lrwxrwxrwx.   1 root root   7 May 11  2019 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x.   5 root root 340 Dec  7 12:27 dev</span><br><span class="line">drwxr-xr-x.   1 root root  66 Dec  7 12:27 etc</span><br><span class="line">drwxr-xr-x.   2 root root   6 May 11  2019 home</span><br><span class="line">lrwxrwxrwx.   1 root root   7 May 11  2019 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx.   1 root root   9 May 11  2019 lib64 -&gt; usr/lib64</span><br><span class="line">drwx------.   2 root root   6 Aug  9 21:40 lost+found</span><br><span class="line">drwxr-xr-x.   2 root root   6 May 11  2019 media</span><br><span class="line">drwxr-xr-x.   2 root root   6 May 11  2019 mnt</span><br><span class="line">drwxr-xr-x.   2 root root   6 May 11  2019 opt</span><br><span class="line">dr-xr-xr-x. 259 root root   0 Dec  7 12:27 proc</span><br><span class="line">dr-xr-x---.   2 root root 162 Aug  9 21:40 root</span><br><span class="line">drwxr-xr-x.  11 root root 163 Aug  9 21:40 run</span><br><span class="line">lrwxrwxrwx.   1 root root   8 May 11  2019 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x.   2 root root   6 May 11  2019 srv</span><br><span class="line">dr-xr-xr-x.  13 root root   0 Dec  6 08:24 sys</span><br><span class="line">drwxrwxrwt.   7 root root 145 Aug  9 21:40 tmp</span><br><span class="line">drwxr-xr-x.  12 root root 144 Aug  9 21:40 usr</span><br><span class="line">drwxr-xr-x.  20 root root 262 Aug  9 21:40 var</span><br></pre></td></tr></table></figure>

<br>

<h2 id="ğŸ”é•œåƒ"><a href="#ğŸ”é•œåƒ" class="headerlink" title="ğŸ”é•œåƒ"></a>ğŸ”é•œåƒ</h2><blockquote>
<p>æ¦‚å¿µ</p>
</blockquote>
<p>é•œåƒæ˜¯ä¸€ç§è½»é‡çº§ã€å¯æ‰§è¡Œçš„ç‹¬ç«‹è½¯ä»¶åŒ…ï¼Œç”¨æ¥æ‰“åŒ…è½¯ä»¶è¿è¡Œç¯å¢ƒå’ŒåŸºäºè¿è¡Œç¯å¢ƒå¼€å‘çš„è½¯ä»¶ï¼Œå®ƒåŒ…å«è¿è¡ŒæŸä¸ªè½¯ä»¶æ‰€éœ€çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬ä»£ç ã€è¿è¡Œæ—¶ã€åº“ã€ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ã€‚</p>
<blockquote>
<p>UnionFS(è”åˆæ–‡ä»¶ç³»ç»Ÿ)</p>
</blockquote>
<p>UnionFS: è”åˆæ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ç§åˆ†å±‚ã€è½»é‡çº§å¹¶ä¸”é«˜æ€§èƒ½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæ”¯æŒå¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹ä½œä¸ºä¸€æ¬¡æäº¤æ¥ä¸€å±‚å±‚çš„å åŠ ï¼ŒåŒæ—¶å¯ä»¥å°†ä¸åŒç›®å½•æŒ‚è½½åˆ°åŒä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸‹(Unite several directions into a single virtual file system)ã€‚Unionæ–‡ä»¶ç³»ç»Ÿæ˜¯Dockeré•œåƒçš„åŸºç¡€ã€‚é•œåƒå¯ä»¥é€šè¿‡åˆ†å±‚æ¥è¿›è¡Œç»§æ‰¿ï¼ŒåŸºäºåŸºç¡€é•œåƒ(æ²¡æœ‰çˆ¶é•œåƒ)ï¼Œå¯ä»¥åˆ¶ä½œå„ç§å…·ä½“çš„åº”ç”¨é•œåƒã€‚</p>
<p>ç‰¹æ€§ï¼šä¸€æ¬¡åŒæ—¶åŠ è½½å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä½†ä»å¤–é¢çœ‹èµ·æ¥ï¼Œåªèƒ½çœ‹åˆ°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè”åˆåŠ è½½ä¼šæŠŠå„å±‚æ–‡ä»¶ç³»ç»Ÿå åŠ èµ·æ¥ï¼Œè¿™æ ·æœ€ç»ˆçš„æ–‡ä»¶ç³»ç»Ÿä¼šåŒ…å«æ‰€æœ‰åº•å±‚çš„æ–‡ä»¶å’Œç›®å½•ã€‚</p>
<blockquote>
<p>Dockeré•œåƒåŠ è½½åŸç†</p>
</blockquote>
<p>Dockerçš„é•œåƒå®é™…ä¸Šç”±ä¸€å±‚ä¸€å±‚çš„æ–‡ä»¶ç³»ç»Ÿç»„æˆï¼Œè¿™ç§å±‚çº§çš„æ–‡ä»¶ç³»ç»ŸUnionFSã€‚</p>
<p>bootfs(boot file system)ä¸»è¦åŒ…å«bootloaderå’Œkernelï¼Œbootloaderä¸»è¦æ˜¯å¼•å¯¼åŠ è½½kernelï¼ŒLinuxåˆšå¯åŠ¨æ—¶ä¼šåœ¨å®¶bootfsæ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨Dockeré•œåƒçš„æœ€åº•å±‚æ˜¯bootfsã€‚è¿™ä¸€å±‚ä¸æˆ‘ä»¬å…¸å‹çš„Linux/Unixç³»ç»Ÿæ˜¯ä¸€æ ·çš„ï¼ŒåŒ…å«bootåŠ è½½å™¨å’Œå†…æ ¸ã€‚å½“bootåŠ è½½å®Œæˆä¹‹åæ•´ä¸ªå†…æ ¸å°±éƒ½åœ¨å†…å­˜ä¸­äº†ï¼Œæ­¤æ—¶å†…å­˜å’Œä½¿ç”¨æƒå·²ç”±bootfsè½¬äº¤ç»™å†…æ ¸ï¼Œæ­¤æ—¶ç³»ç»Ÿä¹Ÿä¼šå¸è½½bootfsã€‚</p>
<p>rootfs(root file system)ï¼Œåœ¨bootfsä¹‹åã€‚åŒ…å«çš„å°±æ˜¯å…¸å‹Linuxç³»ç»Ÿ/devï¼Œ/procï¼Œ/binï¼Œ/etcç­‰æ ‡å‡†ç›®å½•å’Œæ–‡ä»¶ã€‚rootfså°±æ˜¯å„ç§ä¸åŒçš„æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆï¼Œæ¯”å¦‚Ubuntuã€CentOSç­‰ç­‰ã€‚</p>
<blockquote>
<p>commité•œåƒ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker commit -m=<span class="string">&quot;&lt;messahe&gt;&quot;</span> -a=<span class="string">&quot;&lt;author&gt;&quot;</span> &lt;Container ID/NAME&gt; &lt;Target&gt;:&lt;Tag&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚ï¼Œæ”¹è£…tomcat:9.0çš„é•œåƒæ‰“åŒ…æˆè‡ªå·±çš„é•œåƒk-tom:1.0</span></span><br><span class="line">[root@parak khighness]# docker commit -a=&quot;Khighness&quot; -m=&quot;Add web application&quot; tom1 k-tom:1.0</span><br><span class="line">sha256:fa4617c8771c81b890dc2a87c7be1d2b851c6ba92b053d0d1d8730b2006550c5</span><br><span class="line">[root@parak khighness]# docker images</span><br><span class="line">REPOSITORY            TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">k-tom                 1.0                 fa4617c8771c        26 seconds ago      654MB</span><br><span class="line">nginx                 latest              bc9a0695f571        11 days ago         133MB</span><br><span class="line">tomcat                9.0                 e0bd8b34b4ea        2 weeks ago         649MB</span><br><span class="line">redis                 latest              74d107221092        2 weeks ago         104MB</span><br><span class="line">portainer/portainer   latest              62771b0b9b09        4 months ago        79.1MB</span><br><span class="line">elasticsearch         7.6.2               f29a1ee41030        8 months ago        791MB</span><br><span class="line">hello-world           latest              bf756fb1ae65        11 months ago       13.3kB</span><br></pre></td></tr></table></figure>

<br>

<h2 id="ğŸŒ€å®¹å™¨æ•°æ®å·"><a href="#ğŸŒ€å®¹å™¨æ•°æ®å·" class="headerlink" title="ğŸŒ€å®¹å™¨æ•°æ®å·"></a>ğŸŒ€å®¹å™¨æ•°æ®å·</h2><blockquote>
<p>æ¦‚å¿µ</p>
</blockquote>
<p>ç›®å½•æŒ‚è½½ï¼Œå°†å®¹å™¨å†…çš„ç›®å½•æŒ‚è½½åœ¨CentOSä¸Š</p>
<ul>
<li>Dockerå®¹å™¨äº§ç”Ÿçš„æ•°æ®åŒæ­¥åˆ°å®¿ä¸»æœº</li>
<li>æ•°æ®å·å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«æˆ–é‡ç”¨æ•°æ®</li>
</ul>
<blockquote>
<p>å‘½ä»¤è¡ŒæŒ‚è½½</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -v -p &lt;ä¸»æœºç›®å½•&gt;:&lt;å®¹å™¨ç›®å½•&gt; </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚ï¼Œå°†dockerçš„centoså®¹å™¨ç›®å½•/home/<span class="built_in">test</span>ä¸å®¿ä¸»centosçš„/home/<span class="built_in">test</span>æŒ‚è½½èµ·æ¥</span></span><br><span class="line">[root@parak khighness]# docker run -it --name=cen -v /home/test:/home/test centos  /bin/bash</span><br><span class="line">Unable to find image &#x27;centos:latest&#x27; locally</span><br><span class="line">latest: Pulling from library/centos</span><br><span class="line">3c72a8ed6814: Pull complete </span><br><span class="line">Digest: sha256:76d24f3ba3317fa945743bb3746fbaf3a0b752f10b10376960de01da70685fbd</span><br><span class="line">Status: Downloaded newer image for centos:latest</span><br><span class="line">[root@4410a5c86528 /]# ls</span><br><span class="line">bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">[root@4410a5c86528 /]# cd home/</span><br><span class="line">[root@4410a5c86528 home]# ls</span><br><span class="line">test</span><br><span class="line">[khighness@parak ~]$ cd /home/</span><br><span class="line">[khighness@parak home]$ ls</span><br><span class="line">khighness  test</span><br><span class="line">[root@parak home]# docker inspect cen</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¦‚ä¸‹æ˜¯æŒ‚è½½ä¿¡æ¯</span></span><br><span class="line">        &quot;Mounts&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Type&quot;: &quot;bind&quot;,              # ç±»å‹ï¼šç»‘å®š</span><br><span class="line">                &quot;Source&quot;: &quot;/home/test&quot;,      # å®¹å™¨ç›®å½•</span><br><span class="line">                &quot;Destination&quot;: &quot;/home/test&quot;, # ä¸»æœºç›®å½•</span><br><span class="line">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class="line">                &quot;RW&quot;: true,</span><br><span class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨å®¹å™¨çš„æŒ‚è½½ç›®å½•ä¸‹æ–°å»ºK1.javaï¼Œåœ¨å®¿ä¸»æœºçš„æŒ‚è½½ç›®å½•ä¸­å¯ä»¥ç›´æ¥çœ‹åˆ°</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201206183841366.png" class="" title="image-20201206183841366">



<blockquote>
<p>å®‰è£…MySQL</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä¸‹è½½8.0.20ç‰ˆæœ¬çš„mysqlé•œåƒ</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker pull mysql:8.0.20</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨mysqlæœåŠ¡</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -d åå°è¿è¡Œ</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -v æŒ‚è½½é…ç½®å’Œæ•°æ®</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -e MYSQL_ROOT)PASSWORD è®¾ç½®å¯†ç </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run --name ksql -d -p 3306:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=KAG1823 mysql:8.0.20</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è§£å†³windowsçš„navicatæ— æ³•è¿æ¥çš„é—®é¢˜</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿›å…¥mysqlå®¢æˆ·ç«¯</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it ksql  bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç™»å½•mysql</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql -u root -pKAG1823</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é‡ç½®å¯†ç </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;KAG1823&#x27;</span>;</span></span><br></pre></td></tr></table></figure>

<br>

<h2 id="ğŸŒDockerç½‘ç»œ"><a href="#ğŸŒDockerç½‘ç»œ" class="headerlink" title="ğŸŒDockerç½‘ç»œ"></a>ğŸŒDockerç½‘ç»œ</h2><blockquote>
<p>å®ç°åŸç†</p>
</blockquote>
<p>Dockerä½¿ç”¨Linuxæ¡¥æ¥ï¼Œåœ¨å®¿ä¸»æœºè™šæ‹Ÿä¸€ä¸ªDockerå®¹å™¨ç½‘æ¡¥(Docker0)ï¼ŒDockerå¯åŠ¨ä¸€ä¸ªå®¹å™¨æ—¶ä¼šæ ¹æ®Dockerç½‘æ¡¥çš„ç½‘æ®µåˆ†é…ç»™å®¹å™¨ä¸€ä¸ªIPåœ°å€ï¼Œç§°ä¸ºContainer-IPï¼ŒåŒæ—¶Dockerç½‘æ¡¥æ˜¯æ¯ä¸ªå®¹å™¨çš„é»˜è®¤ç½‘å…³ã€‚å› ä¸ºåœ¨åŒä¸€å®¿ä¸»æœºå†…çš„å®¹å™¨éƒ½æ¥å…¥åŒä¸€ç½‘æ¡¥ã€‚è¿™æ ·å®¹å™¨ä¹‹é—´å°±èƒ½å¤Ÿé€šè¿‡å®¹å™¨çš„Contain-IPç›´æ¥é€šä¿¡ã€‚</p>
<p>Dockerç½‘æ¡¥æ˜¯å®¿ä¸»æœºè™šæ‹Ÿå‡ºæ¥çš„ï¼Œå¹¶ä¸æ˜¯çœŸå®å­˜åœ¨çš„ç½‘ç»œè®¾å¤‡ï¼Œå¤–éƒ¨è®¾å¤‡æ˜¯æ— æ³•å¯»å€åˆ°çš„ï¼Œè¿™ä¹Ÿæ„å‘³ç€å¤–éƒ¨è®¾å¤‡æ— æ³•é€šè¿‡ç›´æ¥Container-IPè®¿é—®åˆ°å®¹å™¨ã€‚å¦‚æœå®¹å™¨å¸Œæœ›å¤–éƒ¨è®¿é—®åˆ°ï¼Œå¯ä»¥é€šè¿‡æ˜ å°„å®¹å™¨ç«¯å£åˆ°å®¿ä¸»ä¸»æœºï¼ˆç«¯å£æ˜ å°„ï¼‰ï¼Œå³docker runåˆ›å»ºå®¹å™¨æ—¶å€™é€šè¿‡-pæˆ–è€…-På‚æ•°æ¥å¯åŠ¨ï¼Œè®¿é—®å®¹å™¨çš„æ—¶å€™å°±é€šè¿‡[å®¿ä¸»æœºIP]:[å®¹å™¨ç«¯å£]è®¿é—®å®¹å™¨ã€‚</p>
<blockquote>
<p>ç½‘ç»œæ¨¡å¼</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ¨¡å¼</th>
<th align="center">é…ç½®</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Bridgeæ¨¡å¼</td>
<td align="center">-net=bridge</td>
<td align="center">é»˜è®¤æ¨¡å¼</td>
</tr>
<tr>
<td align="center">Hostæ¨¡å¼</td>
<td align="center">-net=host</td>
<td align="center">å®¹å™¨å’Œå®¿ä¸»æœºå…±äº«Network NameSpace</td>
</tr>
<tr>
<td align="center">Containeræ¨¡å¼</td>
<td align="center">-net=container : NAME OR ID</td>
<td align="center">å®¹å™¨å’Œå¦å¤–ä¸€ä¸ªå®¹å™¨å…±äº«Network NameSpace</td>
</tr>
<tr>
<td align="center">Noneæ¨¡å¼</td>
<td align="center">-net=none</td>
<td align="center">å®¹å™¨æœ‰ç‹¬ç«‹çš„Network NameSpaceï¼Œä½†å¹¶æ²¡æœ‰å¯¹å…¶è¿›è¡Œä»»ä½•ç½‘ç»œè®¾ç½®ï¼Œå¦‚åˆ†é…veth pair å’Œç½‘æ¡¥è¿æ¥ï¼Œé…ç½®IPç­‰</td>
</tr>
</tbody></table>
<br>

<h3 id="1ï¸âƒ£hostæ¨¡å¼"><a href="#1ï¸âƒ£hostæ¨¡å¼" class="headerlink" title="1ï¸âƒ£hostæ¨¡å¼"></a>1ï¸âƒ£hostæ¨¡å¼</h3><p>å¦‚æœå¯åŠ¨å®¹å™¨çš„æ—¶å€™ä½¿ç”¨hostæ¨¡å¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¹å™¨å°†ä¸ä¼šè·å¾—ä¸€ä¸ªç‹¬ç«‹çš„Network NameSpaceï¼Œè€Œæ˜¯å’Œå®¿ä¸»æœºå…±ç”¨ä¸€ä¸ªNetwork NameSpaceã€‚å®¹å™¨å°†ä¸ä¼šè™šæ‹Ÿå‡ºè‡ªå·±çš„ç½‘å¡ï¼Œé…ç½®è‡ªå·±çš„IPç­‰ï¼Œè€Œæ˜¯ä½¿ç”¨å®¿ä¸»æœºçš„IPå’Œç«¯å£ã€‚ä½†æ˜¯ï¼Œå®¹å™¨çš„å…¶ä»–æ–¹é¢ï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹åˆ—è¡¨ç­‰è¿˜æ˜¯å’Œå®¿ä¸»æœºéš”ç¦»çš„ã€‚</p>
<p>ä½¿ç”¨hostæ¨¡å¼çš„å®¹å™¨å¯ä»¥ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„IPåœ°å€ä¸å¤–ç•Œé€šä¿¡ï¼Œå®¹å™¨å†…éƒ¨çš„æœåŠ¡ç«¯å£ä¹Ÿå¯ä»¥ä½¿ç”¨å®¿ä¸»æœºçš„ç«¯å£ï¼Œä¸éœ€è¦è¿›è¡ŒNATï¼Œhostæœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯ç½‘ç»œæ€§èƒ½æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯docker hostä¸Šå·²ç»ä½¿ç”¨çš„ç«¯å£å°±ä¸èƒ½å†ç”¨äº†ï¼Œç½‘ç»œçš„éš”ç¦»æ€§ä¸å¥½ã€‚</p>
<br>

<h3 id="2ï¸âƒ£containeræ¨¡å¼"><a href="#2ï¸âƒ£containeræ¨¡å¼" class="headerlink" title="2ï¸âƒ£containeræ¨¡å¼"></a>2ï¸âƒ£containeræ¨¡å¼</h3><p>è¿™ä¸ªæ¨¡å¼æŒ‡å®šæ–°åˆ›å»ºçš„å®¹å™¨å’Œå·²ç»å­˜åœ¨çš„ä¸€ä¸ªå®¹å™¨å…±äº«ä¸€ä¸ª Network NameSpaceï¼Œè€Œä¸æ˜¯å’Œå®¿ä¸»æœºå…±äº«ã€‚æ–°åˆ›å»ºçš„å®¹å™¨ä¸ä¼šåˆ›å»ºè‡ªå·±çš„ç½‘å¡ï¼Œé…ç½®è‡ªå·±çš„ IPï¼Œè€Œæ˜¯å’Œä¸€ä¸ªæŒ‡å®šçš„å®¹å™¨å…±äº« IPã€ç«¯å£èŒƒå›´ç­‰ã€‚åŒæ ·ï¼Œä¸¤ä¸ªå®¹å™¨é™¤äº†ç½‘ç»œæ–¹é¢ï¼Œå…¶ä»–çš„å¦‚æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹åˆ—è¡¨ç­‰è¿˜æ˜¯éš”ç¦»çš„ã€‚ä¸¤ä¸ªå®¹å™¨çš„è¿›ç¨‹å¯ä»¥é€šè¿‡ lo ç½‘å¡è®¾å¤‡é€šä¿¡ã€‚</p>
<br>

<h3 id="3ï¸âƒ£noneæ¨¡å¼"><a href="#3ï¸âƒ£noneæ¨¡å¼" class="headerlink" title="3ï¸âƒ£noneæ¨¡å¼"></a>3ï¸âƒ£noneæ¨¡å¼</h3><p>ä½¿ç”¨noneæ¨¡å¼ï¼ŒDockerå®¹å™¨æ‹¥æœ‰è‡ªå·±çš„Network NameSpaceï¼Œä½†æ˜¯ï¼Œå¹¶ä¸ä¸ºDockerå®¹å™¨è¿›è¡Œä»»ä½•ç½‘ç»œé…ç½®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªDockerå®¹å™¨æ²¡æœ‰ç½‘å¡ã€IPã€è·¯ç”±ç­‰ä¿¡æ¯ã€‚éœ€è¦æˆ‘ä»¬è‡ªå·±ä¸ºDockerå®¹å™¨æ·»åŠ ç½‘å¡ã€é…ç½®IPç­‰ã€‚</p>
<p>è¿™ç§ç½‘ç»œæ¨¡å¼ä¸‹å®¹å™¨åªæœ‰loå›ç¯ç½‘ç»œï¼Œæ²¡æœ‰å…¶ä»–ç½‘å¡ã€‚noneæ¨¡å¼å¯ä»¥åœ¨å®¹å™¨åˆ›å»ºæ—¶é€šè¿‡â€“network=noneæ¥æŒ‡å®šã€‚è¿™ç§ç±»å‹çš„ç½‘ç»œæ²¡æœ‰åŠæ³•è”ç½‘ï¼Œå°é—­çš„ç½‘ç»œèƒ½å¾ˆå¥½çš„ä¿è¯å®¹å™¨çš„å®‰å…¨æ€§ã€‚</p>
<br>

<h3 id="4ï¸âƒ£bridgeæ¨¡å¼"><a href="#4ï¸âƒ£bridgeæ¨¡å¼" class="headerlink" title="4ï¸âƒ£bridgeæ¨¡å¼"></a>4ï¸âƒ£bridgeæ¨¡å¼</h3><p>å½“Dockerè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šåœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªåä¸ºdocker0çš„è™šæ‹Ÿç½‘æ¡¥ï¼Œæ­¤ä¸»æœºä¸Šå¯åŠ¨çš„Dockerå®¹å™¨ä¼šè¿æ¥åˆ°è¿™ä¸ªè™šæ‹Ÿç½‘æ¡¥ä¸Šã€‚è™šæ‹Ÿç½‘æ¡¥çš„å·¥ä½œæ–¹å¼å’Œç‰©ç†äº¤æ¢æœºç±»ä¼¼ï¼Œè¿™æ ·ä¸»æœºä¸Šçš„æ‰€æœ‰å®¹å™¨å°±é€šè¿‡äº¤æ¢æœºè¿åœ¨äº†ä¸€ä¸ªäºŒå±‚ç½‘ç»œä¸­ã€‚</p>
<p>ä»docker0å­ç½‘ä¸­åˆ†é…ä¸€ä¸ªIPç»™å®¹å™¨ä½¿ç”¨ï¼Œå¹¶è®¾ç½®docker0çš„IPåœ°å€ä¸ºå®¹å™¨çš„é»˜è®¤ç½‘å…³ã€‚åœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€å¯¹è™šæ‹Ÿç½‘å¡veth pairè®¾å¤‡ï¼ŒDockerå°†veth pairè®¾å¤‡çš„ä¸€ç«¯æ”¾åœ¨æ–°åˆ›å»ºçš„å®¹å™¨ä¸­ï¼Œå¹¶å‘½åä¸ºeth0ï¼ˆå®¹å™¨çš„ç½‘å¡ï¼‰ï¼Œå¦ä¸€ç«¯æ”¾åœ¨ä¸»æœºä¸­ï¼Œä»¥vethxxxè¿™æ ·ç±»ä¼¼çš„åå­—å‘½åï¼Œå¹¶å°†è¿™ä¸ªç½‘ç»œè®¾å¤‡åŠ å…¥åˆ°docker0ç½‘æ¡¥ä¸­ã€‚å¯ä»¥é€šè¿‡brctl showå‘½ä»¤æŸ¥çœ‹ã€‚</p>
<p>bridgeæ¨¡å¼æ˜¯dockerçš„é»˜è®¤ç½‘ç»œæ¨¡å¼ï¼Œä¸å†™â€“netå‚æ•°ï¼Œå°±æ˜¯bridgeæ¨¡å¼ã€‚ä½¿ç”¨docker run -pæ—¶ï¼Œdockerå®é™…æ˜¯åœ¨iptablesåšäº†DNATè§„åˆ™ï¼Œå®ç°ç«¯å£è½¬å‘åŠŸèƒ½ã€‚å¯ä»¥ä½¿ç”¨iptables -t nat -vnLæŸ¥çœ‹ã€‚</p>
<blockquote>
<p>â€“linkæ¢ç©¶</p>
</blockquote>
<p>å®˜æ–¹å·²ç»ä¸æ¨èä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£ä¸€ä¸‹ã€‚</p>
<p>2ä¸ªå®¹å™¨ä¹‹é—´äº’ç›¸è®¿é—®é€šä¿¡ï¼š<code>docker run &lt;container1-id/name&gt; --link &lt;container2-id/name&gt; &lt;image&gt;</code></p>
<p>ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å¯åŠ¨å®¹å™¨2çš„æ—¶å€™ï¼Œå®¹å™¨ä¾¿å¯ä»¥pingé€šå®¹å™¨1ï¼Œä½†æ˜¯åå‘pingä¸é€šã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºå®¹å™¨tom1</span></span><br><span class="line">[root@parak khighness]# docker run -d -p 3356:8080 --name tom1 tomcat:9.0 </span><br><span class="line">dd615d6d2ccb9467aad8ba008ece995588680d849b9f61945b10de5c3475f671</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä½¿ç”¨--linkåˆ›å»ºå®¹å™¨2</span></span><br><span class="line">[root@parak khighness]# docker run -d -p 3357:8081 --name tom2 --link tom1  tomcat:9.0 </span><br><span class="line">b2c17969a2cb4407bb1a61a53703a38998a11db01ce516feb70e397b42af6ad3</span><br><span class="line"><span class="meta">#</span><span class="bash"> tom1ä¸èƒ½pingé€štom2</span></span><br><span class="line">[root@parak khighness]# docker exec -it tom1 ping tom2</span><br><span class="line">ping: tom2: Name or service not known</span><br><span class="line"><span class="meta">#</span><span class="bash"> tom2å¯ä»¥pingé€štom1</span></span><br><span class="line">[root@parak khighness]# docker exec -it tom2 ping tom1</span><br><span class="line">PING tom1 (172.17.0.4) 56(84) bytes of data.</span><br><span class="line">64 bytes from tom1 (172.17.0.4): icmp_seq=1 ttl=64 time=0.161 ms</span><br><span class="line">64 bytes from tom1 (172.17.0.4): icmp_seq=2 ttl=64 time=0.108 ms</span><br><span class="line">64 bytes from tom1 (172.17.0.4): icmp_seq=3 ttl=64 time=0.122 ms</span><br><span class="line">^C</span><br><span class="line">--- tom1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 4ms</span><br><span class="line">rtt min/avg/max/mdev = 0.108/0.130/0.161/0.024 ms</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹tom2å†…éƒ¨çš„hostsæ–‡ä»¶</span></span><br><span class="line">[root@parak khighness]# docker exec -it tom2 cat /etc/hosts</span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">::1	localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0	ip6-localnet</span><br><span class="line">ff00::0	ip6-mcastprefix</span><br><span class="line">ff02::1	ip6-allnodes</span><br><span class="line">ff02::2	ip6-allrouters</span><br><span class="line">172.17.0.4	tom1 dd615d6d2ccb # ==&gt; æ ¹æºï¼šæœ¬è´¨å°±æ˜¯tom2å°±æ˜¯åœ¨æœ¬åœ°é…ç½®äº†tom1çš„åŸŸåIPè§£æã€‚</span><br><span class="line">172.17.0.5	b2c17969a2cb</span><br></pre></td></tr></table></figure>



<blockquote>
<p>è‡ªå®šä¹‰ç½‘ç»œ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºç½‘ç»œ</span></span><br><span class="line">[root@parak khighness]# docker network create --driver bridge --subnet 192.168.0.0/16 --gateway 192.168.0.1 mynet</span><br><span class="line">abaebdc493149a140ee77965274885adea3882bf117c4f8e61e4034730c3b890</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹ç½‘ç»œ</span></span><br><span class="line">[root@parak khighness]# docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">4399361ba4a9        bridge              bridge              local</span><br><span class="line">65f0ec2bfb42        host                host                local</span><br><span class="line">abaebdc49314        mynet               bridge              local</span><br><span class="line">feab1dfce431        none                null                local</span><br><span class="line"><span class="meta">#</span><span class="bash"> è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">[root@parak khighness]# docker network inspect mynet </span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;mynet&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;abaebdc493149a140ee77965274885adea3882bf117c4f8e61e4034730c3b890&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2020-12-10T16:12:08.563828418+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;192.168.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;192.168.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨mynetä¸‹å¯åŠ¨tomcat1</span></span><br><span class="line">[root@parak khighness]# docker run -d -it -p 8080:3355 --net mynet --name mynet-tom1 tomcat:9.0 </span><br><span class="line">4d799757f01f560af7fd44d610b7fdabd1e0f66ef528bf1259f09242bddbb636</span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨mynetä¸‹å¯åŠ¨tomcat2</span></span><br><span class="line">[root@parak khighness]# docker run -d -it -p 8081:3356 --net mynet --name mynet-tom2 tomcat:9.0 </span><br><span class="line">15c045f96d5b7b2ee2e470cb69e5b1f86511929f7ed05ed8f20db26ef4b975af</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä½¿ç”¨mynet-tom2 ping mynet-tom1</span></span><br><span class="line">[root@parak khighness]# docker exec -it mynet-tom2 ping mynet-tom1</span><br><span class="line">PING mynet-tom1 (192.168.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.068 ms</span><br><span class="line">64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=2 ttl=64 time=0.042 ms</span><br><span class="line">64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=3 ttl=64 time=0.055 ms</span><br><span class="line">--- mynet-tom1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 4ms</span><br><span class="line">rtt min/avg/max/mdev = 0.042/0.055/0.068/0.010 ms</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä½¿ç”¨mynet-tom1 ping mynet-tom2</span></span><br><span class="line">[root@parak khighness]# docker exec -it mynet-tom1 ping mynet-tom2</span><br><span class="line">PING mynet-tom2 (192.168.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from mynet-tom2.mynet (192.168.0.3): icmp_seq=1 ttl=64 time=0.036 ms</span><br><span class="line">64 bytes from mynet-tom2.mynet (192.168.0.3): icmp_seq=2 ttl=64 time=0.048 ms</span><br><span class="line">64 bytes from mynet-tom2.mynet (192.168.0.3): icmp_seq=3 ttl=64 time=0.058 ms</span><br><span class="line">--- mynet-tom2 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2ms</span><br><span class="line">rtt min/avg/max/mdev = 0.036/0.047/0.058/0.010 ms</span><br></pre></td></tr></table></figure>

<p>è‡ªå®šä¹‰ç½‘ç»œè‡ªåŠ¨ç»´æŠ¤å¥½å®¹å™¨çš„ç½‘ç»œå…³ç³»ï¼</p>
<blockquote>
<p>ç½‘ç»œè¿é€š</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åœ¨Docker0ç½‘ç»œå¯åŠ¨tomcat</span></span><br><span class="line">[root@parak khighness]# docker run -d -it -p 8082:3357 --name tom1 tomcat:9.0 </span><br><span class="line">0344f04baab2eaeaac0118dac7a93d8b2d77946636c76ed3bde804cbeda836be</span><br><span class="line"><span class="meta">#</span><span class="bash"> æµ‹è¯•tom1 ping mynetâ€”tom1</span></span><br><span class="line">[root@parak khighness]# docker exec tom1 ping mynet-tom1</span><br><span class="line">ping: mynet-tom1: Name or service not known</span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿é€šmynet - tom1</span></span><br><span class="line">[root@parak khighness]# docker network connect mynet tom1 </span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹mynet1çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">[root@parak khighness]# docker inspect mynet</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;mynet&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;abaebdc493149a140ee77965274885adea3882bf117c4f8e61e4034730c3b890&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2020-12-10T16:12:08.563828418+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;192.168.0.0/16&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;192.168.0.1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123;</span><br><span class="line">        	# å‘ç°mynetå°†tom1æ”¾åˆ°äº†mynetç½‘ç»œä¸‹ï¼Œå³ä¸€ä¸ªå®¹å™¨ï¼Œä¸¤ä¸ªIP</span><br><span class="line">            &quot;0344f04baab2eaeaac0118dac7a93d8b2d77946636c76ed3bde804cbeda836be&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;tom1&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;8911ad05a9b0d7d0effbf50c82659f36b82d21e18f992359b09494073dddd969&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:04&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;192.168.0.4/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;15c045f96d5b7b2ee2e470cb69e5b1f86511929f7ed05ed8f20db26ef4b975af&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;mynet-tom2&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;907f16284e90be0d880a999b29210d1cd82adb2c79b4179eeb1d70d75130362a&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;192.168.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;4d799757f01f560af7fd44d610b7fdabd1e0f66ef528bf1259f09242bddbb636&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;mynet-tom1&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;6529ef4fc05dffe65fe875fdf15f2f4a61665c4d969767db94dd828baf88b323&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;192.168.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="meta">#</span><span class="bash"> å†æ¬¡æµ‹è¯•tom1 ping mynetâ€”tom1</span></span><br><span class="line">[root@parak khighness]# docker exec -it tom1 ping mynet-tom1</span><br><span class="line">PING mynet-tom1 (192.168.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.097 ms</span><br><span class="line">64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=2 ttl=64 time=0.052 ms</span><br><span class="line">64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=3 ttl=64 time=0.053 ms</span><br><span class="line">--- mynet-tom1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 3ms</span><br><span class="line">rtt min/avg/max/mdev = 0.052/0.067/0.097/0.022 ms</span><br></pre></td></tr></table></figure>

<br>

<h2 id="ğŸ’ Redisé›†ç¾¤éƒ¨ç½²"><a href="#ğŸ’ Redisé›†ç¾¤éƒ¨ç½²" class="headerlink" title="ğŸ’ Redisé›†ç¾¤éƒ¨ç½²"></a>ğŸ’ Redisé›†ç¾¤éƒ¨ç½²</h2><blockquote>
<p>shellè„šæœ¬</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºç½‘å¡</span></span><br><span class="line">docker network create redis --subnet 172.38.0.0/16</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é€šè¿‡è„šæœ¬åˆ›å»ºå…­ä¸ªredisé…ç½®</span></span><br><span class="line">for port in $(seq 1 6); \</span><br><span class="line">do \</span><br><span class="line">mkdir -p /mydata/redis/node-$&#123;port&#125;/conf</span><br><span class="line">touch /mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class="line">cat &lt;&lt; EOF &gt;&gt;/mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class="line">port 6379</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.38.0.1$&#123;port&#125;</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly yes</span><br><span class="line">EOF</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿è¡Œredis</span></span><br><span class="line">for port in $(seq 1 6); \</span><br><span class="line">do</span><br><span class="line">docker run -p 637$&#123;port&#125;:6379 -p 1637$&#123;port&#125;:16379 --name redis-$&#123;port&#125; \</span><br><span class="line">-v /mydata/redis/node-$&#123;port&#125;/data:/data \</span><br><span class="line">-v /mydata/redis/node-$&#123;port&#125;/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d --net redis --ip 172.38.0.1$&#123;port&#125; redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿›å…¥redis-1</span></span><br><span class="line">docker exec -it redis-1 /bin/sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ­å»ºé›†ç¾¤</span></span><br><span class="line">redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœæ­¢é›†ç¾¤</span></span><br><span class="line">for port in $(seq 1 6); \</span><br><span class="line">do</span><br><span class="line">docker stop redis-$&#123;port&#125; </span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨é›†ç¾¤</span></span><br><span class="line">for port in $(seq 1 6); \</span><br><span class="line">do </span><br><span class="line">docker start redis-$&#123;port&#125; </span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<br>

<h2 id="ğŸ’¨SpringBootæµ‹è¯•"><a href="#ğŸ’¨SpringBootæµ‹è¯•" class="headerlink" title="ğŸ’¨SpringBootæµ‹è¯•"></a>ğŸ’¨SpringBootæµ‹è¯•</h2><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<ul>
<li>æ„å»ºSpringBooté¡¹ç›®</li>
<li>æ‰“åŒ…webåº”ç”¨</li>
<li>ç¼–å†™dockerfile</li>
<li>æ„å»ºé•œåƒ</li>
<li>å‘å¸ƒè¿è¡Œ</li>
</ul>
<blockquote>
<p>ç¼–å†™Controller</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span> + name + <span class="string">&quot;\n\n&quot;</span> + <span class="string">&quot; -from KHighness&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é€šè¿‡mavençš„packageæ‰“åŒ…</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --------------------------&lt; top.parak:hello &gt;---------------------------</span><br><span class="line">[INFO] Building hello 1.0-SNAPSHOT</span><br><span class="line">[INFO] --------------------------------[ jar ]---------------------------------</span><br><span class="line">[INFO] --- maven-resources-plugin:3.1.0:resources (default-resources) @ hello ---</span><br><span class="line">[INFO] Using &#x27;UTF-8&#x27; encoding to copy filtered resources.</span><br><span class="line">[INFO] Copying 0 resource</span><br><span class="line">[INFO] Copying 0 resource</span><br><span class="line">[INFO] --- maven-compiler-plugin:3.8.1:compile (default-compile) @ hello ---</span><br><span class="line">[INFO] Changes detected - recompiling the module!</span><br><span class="line">[INFO] Compiling 2 source files to C:\Users\18236\Desktop\Recent\hello\target\classes</span><br><span class="line">[INFO] --- maven-resources-plugin:3.1.0:testResources (default-testResources) @ hello ---</span><br><span class="line">[INFO] Using &#x27;UTF-8&#x27; encoding to copy filtered resources.</span><br><span class="line">[INFO] skip non existing resourceDirectory C:\Users\18236\Desktop\Recent\hello\src\test\resources</span><br><span class="line">[INFO] --- maven-compiler-plugin:3.8.1:testCompile (default-testCompile) @ hello ---</span><br><span class="line">[INFO] No sources to compile</span><br><span class="line">[INFO] --- maven-surefire-plugin:2.22.2:test (default-test) @ hello ---</span><br><span class="line">[INFO] No tests to run.</span><br><span class="line">[INFO] --- maven-jar-plugin:3.1.2:jar (default-jar) @ hello ---</span><br><span class="line">[INFO] Building jar: C:\Users\18236\Desktop\Recent\hello\target\hello-1.0-SNAPSHOT.jar</span><br><span class="line">[INFO] --- spring-boot-maven-plugin:2.2.5.RELEASE:repackage (repackage) @ hello ---</span><br><span class="line">[INFO] Replacing main artifact with repackaged archive</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  5.534 s</span><br><span class="line">[INFO] Finished at: 2020-12-10T17:54:11+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç¼–å†™Dockerfile</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">FROM java:8</span><br><span class="line"></span><br><span class="line">COPY *.jar /app.jar</span><br><span class="line"></span><br><span class="line">CMD [&quot;--server.port=8080&quot;]</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;/app.jar&quot;]</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡Xftpå°†æ„å»ºå¥½çš„jaråŒ…å’ŒDockerFileå‘é€åˆ°è™šæ‹Ÿæœº</p>
<blockquote>
<p>æ„å»ºé•œåƒ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@parak hello]# docker build -t hello .</span><br><span class="line">Sending build context to Docker daemon   17.6MB</span><br><span class="line">Step 1/5 : FROM java:8</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> d23bdf5b1b1b</span></span><br><span class="line">Step 2/5 : COPY *.jar /app.jar</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 34774df7a107</span></span><br><span class="line">Step 3/5 : CMD [&quot;--server.port=8080&quot;]</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> [Warning] IPv4 forwarding is disabled. Networking will not work.</span></span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 11d95474e047</span></span><br><span class="line">Removing intermediate container 11d95474e047</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> e8b6fa21a3a0</span></span><br><span class="line">Step 4/5 : EXPOSE 8080</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> [Warning] IPv4 forwarding is disabled. Networking will not work.</span></span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 896cc7d50875</span></span><br><span class="line">Removing intermediate container 896cc7d50875</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> b139242b232d</span></span><br><span class="line">Step 5/5 : ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;/app.jar&quot;]</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> [Warning] IPv4 forwarding is disabled. Networking will not work.</span></span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 562f3bb605a0</span></span><br><span class="line">Removing intermediate container 562f3bb605a0</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 1d28463205d5</span></span><br><span class="line">Successfully built 1d28463205d5</span><br><span class="line">Successfully tagged hello:latest</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œé•œåƒ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@parak hello]# docker run -d -it -p 8001:8080 hello</span><br><span class="line">7e19b364789de18c736c51e5c84d611e7474d3a733f188220dfd7cc011e55729</span><br><span class="line">[root@parak hello]# curl http://192.168.117.155:8001/hello/KKK</span><br><span class="line">Hello, KKK</span><br><span class="line"></span><br><span class="line"> -from KHighness</span><br></pre></td></tr></table></figure>

<br>

<h2 id="â­•ç›¸å…³é—®é¢˜"><a href="#â­•ç›¸å…³é—®é¢˜" class="headerlink" title="â­•ç›¸å…³é—®é¢˜"></a>â­•ç›¸å…³é—®é¢˜</h2><blockquote>
<p>è§£å†³é—®é¢˜1: WARNING: IPv4 forwarding is disabled. Networking will not work.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;net.ipv4.ip_forward=1&quot;</span> &gt;&gt;/usr/lib/sysctl.d/00-system.conf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl restart network &amp;&amp; systemctl restart docker</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>è§£å†³é—®é¢˜2: ä½¿ç”¨é˜¿é‡Œäº‘æœåŠ¡å™¨è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œå¤–éƒ¨IPä¸èƒ½è®¿é—®</p>
</blockquote>
<p>éœ€è¦åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨é…ç½®é˜²ç«å¢™ç›¸å…³ç«¯å£å¯¹å¤–å¼€æ”¾ã€‚</p>
<p>æ¯”å¦‚è·‘ä¸€ä¸ªå¼€æ”¾ç«¯å£ä¸º3333çš„springbootåº”ç”¨éœ€è¦åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨æ§åˆ¶å°çš„é˜²ç«å¢™æ·»åŠ è§„åˆ™:</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201211233834182.png" class="" title="image-20201211233834182">



]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-7(å¹¶å‘å·¥å…·ä¹‹é”åŸç†)</title>
    <url>/posts/61205/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210502211334391.png" class="" title="image-20210502211334391"><br />



<h2 id="7-1-AbstractQueuedSynchronizer"><a href="#7-1-AbstractQueuedSynchronizer" class="headerlink" title="7.1 AbstractQueuedSynchronizer"></a>7.1 AbstractQueuedSynchronizer</h2><h3 id="7-1-1-AQSæ¦‚è¿°"><a href="#7-1-1-AQSæ¦‚è¿°" class="headerlink" title="7.1.1 AQSæ¦‚è¿°"></a>7.1.1 AQSæ¦‚è¿°</h3><p><code>AbstractQueuedSynchronizer</code>(æŠ½è±¡åŒæ­¥é˜Ÿåˆ—)ï¼Œæ˜¯é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶ã€‚</p>
<ul>
<li>ä½¿ç”¨<code>state</code>å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å–é”å’Œé‡Šæ”¾é”ã€‚<ul>
<li><code>getState</code>ï¼šè·å–stateçŠ¶æ€</li>
<li><code>setState</code>ï¼šè®¾ç½®stateçŠ¶æ€</li>
<li><code>compareAndSetState</code>ï¼šä¹è§‚é”æœºåˆ¶è®¾ç½®stateçŠ¶æ€</li>
<li>ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œè€Œå…±äº«æ¨¡å¼å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æº</li>
</ul>
</li>
<li>æä¾›äº†åŸºäºFIFOçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œåœ¨å…¶å†…éƒ¨é€šè¿‡èŠ‚ç‚¹<code>head</code>å’Œ<code>tail</code>è®°å½•å¯¹æ‰‹å’Œé˜Ÿå°¾å…ƒç´ ï¼Œé˜Ÿåˆ—çš„å…ƒç´ ç±»å‹ä¸º<code>Node</code>ã€‚<ul>
<li><code>SHARED</code>ï¼šç”¨æ¥æ ‡è®°è¯¥çº¿ç¨‹æ˜¯æ˜¯å¦æ˜¯è·å–å…±äº«èµ„æºæ—¶è¢«é˜»å¡æŒ‚èµ·åæ”¾å…¥AQSé˜Ÿåˆ—çš„</li>
<li><code>EXCLUSIVE</code>ï¼šç”¨æ¥æ ‡è®°çº¿ç¨‹æ˜¯è·å–ç‹¬å èµ„æºæ—¶è¢«æŒ‚èµ·åæ”¾å…¥AQSé˜Ÿåˆ—çš„</li>
<li><code>waitStatus</code>ï¼šè®°å½•å½“å‰çº¿ç¨‹ç­‰å¾…çŠ¶æ€<ul>
<li>1ï¼šCANCELLEDï¼Œçº¿ç¨‹ç»“ç‚¹å·²é‡Šæ”¾ï¼ˆè¶…æ—¶ã€ä¸­æ–­ï¼‰ï¼Œå·²å–æ¶ˆçš„èŠ‚ç‚¹ä¸ä¼šå†é˜»å¡</li>
<li>-1ï¼šSIGNALï¼Œè¯¥çº¿ç¨‹çš„åç»­çº¿ç¨‹éœ€è¦é˜»å¡ï¼Œå³åªè¦å‰é©±ç»“ç‚¹é‡Šæ”¾é”ï¼Œå°±ä¼šé€šçŸ¥æ ‡è¯†ä¸ºSIGNALçŠ¶æ€çš„åç»§ç»“ç‚¹çš„çº¿ç¨‹</li>
<li>-2ï¼šCONDITIONï¼Œè¯¥çº¿ç¨‹åœ¨conditioné˜Ÿåˆ—ä¸­é˜»å¡</li>
<li>-3ï¼šPROPAGATEï¼Œé‡Šæ”¾å…±äº«èµ„æºæ—¶éœ€è¦é€šçŸ¥å…¶ä»–èŠ‚ç‚¹</li>
</ul>
</li>
<li><code>prev</code>è®°å½•å½“å‰èŠ‚ç‚¹çš„å‰é©±ç»“ç‚¹ï¼Œ<code>next</code>è®°å½•å½“å‰é˜¶æ®µçš„åç»§ç»“ç‚¹</li>
</ul>
</li>
<li>å†…éƒ¨ç±»<code>ConditionObject</code>ï¼Œç”¨æ¥ç»“åˆé”å®ç°çº¿ç¨‹åŒæ­¥ï¼Œæ˜¯æ¡ä»¶å˜é‡ï¼Œæ¯ä¸ªæ¡ä»¶å˜é‡å¯¹åº”ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—ï¼ˆå•å‘é“¾è¡¨é˜Ÿåˆ—ï¼‰ï¼Œç”¨æ¥å­˜æ”¾è°ƒç”¨æ¡ä»¶å˜é‡çš„<code>await</code>æ–¹æ³•åè¢«é˜»å¡çš„çº¿ç¨‹ï¼Œé˜Ÿåˆ—çš„å¤´ã€å°¾å…ƒç´ åˆ†åˆ«æ˜¯<code>firstWaiter</code>å’Œ<code>lastWaiter</code>ã€‚</li>
</ul>
<h3 id="7-1-2-è·å–ä¸é‡Šæ”¾èµ„æº"><a href="#7-1-2-è·å–ä¸é‡Šæ”¾èµ„æº" class="headerlink" title="7.1.2 è·å–ä¸é‡Šæ”¾èµ„æº"></a>7.1.2 è·å–ä¸é‡Šæ”¾èµ„æº</h3><p>å¯¹äºAQSæ¥è¯´ï¼Œçº¿ç¨‹åŒæ­¥çš„å…³é”®æ˜¯å¯¹çŠ¶æ€å€¼<code>state</code>è¿›è¡Œæ“ä½œã€‚æ ¹æ®<code>state</code>æ˜¯å¦å±äºä¸€ä¸ªçº¿ç¨‹ï¼Œæ“ä½œ<code>state</code>çš„æ–¹å¼åˆ†ä¸ºç‹¬å æ–¹å¼å’Œå…±äº«æ–¹å¼ã€‚</p>
<ul>
<li>ç‹¬å æ–¹å¼ï¼š<code>void acquire(int arg)</code>  <code>void acquireInterruptibly(int arg)</code> <code>boolean release(int arg)</code></li>
<li>å…±äº«æ–¹å¼ï¼š<code>void acquireShared(int arg)</code>  <code>void acquireSharedInterruptibly(int arg)</code> <code>boolean releaseShared(int arg)</code></li>
</ul>
<p>ä½¿ç”¨ç‹¬å æ–¹å¼è·å–çš„èµ„æºæ˜¯ä¸å…·ä½“çº¿ç¨‹ç»‘å®šçš„ï¼Œå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªçº¿ç¨‹è·å–åˆ°äº†èµ„æºï¼Œå°±ä¼šæ ‡è®°åˆ°æ˜¯è¿™ä¸ªçº¿ç¨‹è·å–åˆ°äº†ï¼Œå…¶ä»–çº¿ç¨‹å†å°è¯•æ“ä½œ<code>state</code>è·å–èµ„æºæ—¶ä¼šå‘ç°å½“å‰è¯¥èµ„æºä¸æ˜¯è‡ªå·±æŒæœ‰çš„ï¼Œå°±ä¼šåœ¨è·å–å¤±è´¥åè¢«é˜»å¡ã€‚æ¯”å¦‚ç‹¬å é”<code>ReentrantLock</code>çš„å®ç°ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†<code>ReentrantLock</code>çš„é”åï¼Œåœ¨AQSå†…éƒ¨ä¼šé¦–å…ˆä½¿ç”¨CASæ“ä½œæŠŠ<code>state</code>çŠ¶æ€å€¼ä»0å˜ä¸º1ï¼Œç„¶åè®¾ç½®å½“å‰é”çš„æŒæœ‰è€…<code>exclusiveOwnerThread</code>ä¸ºå½“å‰çº¿ç¨‹ï¼Œå½“è¯¥çº¿ç¨‹å†æ¬¡è·å–é”æ—¶å‘ç°å®ƒå°±æ˜¯é”çš„æŒæœ‰è€…ï¼Œåˆ™ä¼šæŠŠçŠ¶æ€å€¼<code>state</code>ä»1å˜ä¸º2ï¼Œå³è®¾ç½®å¯é‡å…¥æ¬¡æ•°ï¼Œè€Œå½“å¦å¤–ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶å‘ç°è‡ªå·±å¹¶ä¸æ˜¯è¯¥é”çš„æŒæœ‰è€…å°±ä¼šè¢«æ”¾å…¥AQSé˜»å¡é˜Ÿåˆ—åæŒ‚èµ·ã€‚</p>
<p>å¯¹åº”å…±äº«æ–¹å¼çš„èµ„æºä¸å…·ä½“çº¿ç¨‹æ˜¯ä¸ç›¸å…³çš„ï¼Œå½“å¤šä¸ªçº¿ç¨‹å»è¯·æ±‚èµ„æºæ—¶é€šè¿‡CASæ–¹å¼ç«äº‰è·å–èµ„æºï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°äº†èµ„æºåï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹å†æ¬¡å»è·å–æ—¶å¦‚æœå½“å‰èµ„æºè¿˜èƒ½æ»¡è¶³å®ƒçš„éœ€è¦ï¼Œåˆ™å½“å‰çº¿ç¨‹åªéœ€è¦ä½¿ç”¨CASæ–¹å¼è¿›è¡Œè·å–å³å¯ã€‚æ¯”å¦‚<code>Semaphore</code>ä¿¡å·é‡ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹é€šè¿‡<code>acquire()</code>æ–¹æ³•è·å–ä¿¡å·é‡æ—¶ï¼Œä¼šé¦–å…ˆçœ‹å½“å‰ä¿¡å·é‡ä¸ªæ•°æ˜¯å¦æ»¡è¶³éœ€è¦ï¼Œä¸æ»¡è¶³åˆ™æŠŠå½“å‰çº¿ç¨‹æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¦‚æœæ»¡è¶³åˆ™é€šè¿‡è‡ªæ—‹CASè·å–ä¿¡å·é‡ã€‚</p>
<h4 id="7-1-2-1-ç‹¬å æ–¹å¼"><a href="#7-1-2-1-ç‹¬å æ–¹å¼" class="headerlink" title="7.1.2.1 ç‹¬å æ–¹å¼"></a>7.1.2.1 ç‹¬å æ–¹å¼</h4><p>ï¼ˆ1ï¼‰å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>acquire(int arg)</code>æ–¹æ³•è·å–ç‹¬å èµ„æºæ—¶ï¼Œä¼šé¦–å…ˆä½¿ç”¨<code>tryAcquire</code>æ–¹æ³•å°è¯•è·å–èµ„æºï¼Œå…·ä½“æ˜¯è®¾ç½®çŠ¶æ€å˜é‡<code>state</code>çš„å€¼ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼Œå¤±è´¥åˆ™å°†å½“å‰çº¿ç¨‹å°è£…ä¸ºç±»å‹ä¸º<code>Node.EXCLUSIVE</code>çš„<code>Node</code>èŠ‚ç‚¹åæ’å…¥åˆ°AQSé˜»å¡é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶è°ƒç”¨<code>LockSupport.park(this)</code>æ–¹æ³•æŒ‚èµ·è‡ªå·±ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>release(int arg)</code>æ–¹æ³•æ—¶ä¼šå°è¯•ä½¿ç”¨<code>tryRelease</code>æ“ä½œé‡Šæ”¾èµ„æºï¼Œè¿™é‡Œæ˜¯è®¾ç½®çŠ¶æ€å˜é‡<code>state</code>çš„å€¼ï¼Œç„¶åè°ƒç”¨<code>LockSupport.unpark(thread)</code>æ–¹æ³•æ¿€æ´»AQSé˜Ÿåˆ—é‡Œé¢è¢«é˜»å¡çš„ä¸€ä¸ªçº¿ç¨‹ï¼ˆthreadï¼‰ã€‚è¢«æ¿€æ´»çš„çº¿ç¨‹åˆ™ä½¿ç”¨<code>tryAcquire</code>å°è¯•ï¼Œçœ‹å½“å‰çŠ¶æ€å˜é‡<code>state</code>çš„å€¼æ˜¯å¦èƒ½æ»¡è¶³è‡ªå·±çš„éœ€è¦ï¼Œæ»¡è¶³åˆ™è¯¥çº¿ç¨‹è¢«æ¿€æ´»ï¼Œç„¶åç»§ç»­å‘ä¸‹è¿è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šè¢«æ”¾å…¥AQSé˜Ÿåˆ—å¹¶è¢«æŒ‚èµ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAQSç±»å¹¶æ²¡æœ‰æä¾›å¯ç”¨çš„<code>tryAcquire</code>å’Œ<code>tryRelease</code>æ–¹æ³•ï¼Œæ­£å¦‚AQSæ˜¯é”é˜»å¡å’ŒåŒæ­¥å™¨çš„åŸºç¡€æ¡†æ¶ä¸€æ ·ï¼Œ<code>tryAcquire</code>å’Œ<code>tryRelease</code>éœ€è¦ç”±å…·ä½“çš„å­ç±»æ¥å®ç°ã€‚å­ç±»åœ¨å®ç°<code>tryAcquire</code>å’Œ<code>tryRelease</code>æ—¶è¦æ ¹æ®å…·ä½“åœºæ™¯ä½¿ç”¨CASç®—æ³•å°è¯•ä¿®æ”¹<code>state</code>çŠ¶æ€å€¼ï¼ŒæˆåŠŸåˆ™è¿”å›<code>true</code>ï¼Œå¦åˆ™è¿”å›<code>false</code>ã€‚å­ç±»è¿˜éœ€è¦å®šä¹‰ï¼Œåœ¨è°ƒç”¨<code>acquire</code>å’Œ<code>release</code>æ–¹æ³•æ—¶<code>state</code>çŠ¶æ€å€¼çš„å¢å‡ä»£è¡¨ä»€ä¹ˆå«ä¹‰ã€‚</p>
<h4 id="7-1-2-2-å…±äº«æ–¹å¼"><a href="#7-1-2-2-å…±äº«æ–¹å¼" class="headerlink" title="7.1.2.2 å…±äº«æ–¹å¼"></a>7.1.2.2 å…±äº«æ–¹å¼</h4><p>ï¼ˆ1ï¼‰å½“çº¿ç¨‹è°ƒç”¨<code>acquireShared(int arg)</code>è·å–å…±äº«èµ„æºæ—¶ï¼Œä¼šé¦–å…ˆä½¿ç”¨<code>tryAcquireShared</code>å°è¯•è·å–èµ„æºï¼Œå…·ä½“æ˜¯è®¾ç½®çŠ¶æ€<code>state</code>çš„å€¼ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼Œå¤±è´¥åˆ™å°†å½“å‰çº¿ç¨‹å°è£…ä¸ºç±»å‹ä¸º<code>Node.SHARED</code>çš„<code>Node</code>èŠ‚ç‚¹åæ’å…¥åˆ°AQSé˜»å¡é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶ä½¿ç”¨<code>LockSupport.park(this)</code>æ–¹æ³•æŒ‚èµ·è‡ªå·±ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>releaseShared(int arg)</code>æ—¶ä¼šå°è¯•ä½¿ç”¨<code>tryReleaseShared</code>æ“ä½œé‡Šæ”¾èµ„æºï¼Œè¿™é‡Œæ˜¯è®¾ç½®çŠ¶æ€å˜é‡<code>state</code>çš„å€¼ï¼Œç„¶åä½¿ç”¨<code>LockSupport.unpark(thread)</code>æ¿€æ´»AQSé˜Ÿåˆ—é‡Œé¢è¢«é˜»å¡çš„ä¸€ä¸ªçº¿ç¨‹ï¼ˆthreadï¼‰ã€‚è¢«æ¿€æ´»çš„çº¿ç¨‹åˆ™ä½¿ç”¨<code>tryReleaseShared</code>æŸ¥çœ‹å½“å‰çŠ¶æ€å˜é‡<code>state</code>çš„å€¼æ˜¯å¦èƒ½æ»¡è¶³è‡ªå·±çš„éœ€è¦ï¼Œæ»¡è¶³åˆ™è¯¥çº¿ç¨‹è¢«æ¿€æ´»ï¼Œç„¶åç»§ç»­å‘ä¸‹è¿è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šè¢«æ”¾å…¥AQSé˜Ÿåˆ—å¹¶è¢«æŒ‚èµ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ ·éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAQSç±»å¹¶æ²¡æœ‰æä¾›å¯ç”¨çš„<code>tryAcquireShared</code>å’Œ<code>tryReleaseShared</code>æ–¹æ³•ï¼Œæ­£å¦‚AQSæ˜¯é”é˜»å¡å’ŒåŒæ­¥å™¨çš„åŸºç¡€æ¡†æ¶ä¸€æ ·ï¼Œ<code>tryAcquire</code>å’Œ<code>tryRelease</code>éœ€è¦ç”±å…·ä½“çš„å­ç±»æ¥å®ç°ã€‚å­ç±»åœ¨å®ç°<code>tryAcquireShared</code>å’Œ<code>tryReleaseShared</code>æ—¶è¦æ ¹æ®å…·ä½“åœºæ™¯ä½¿ç”¨CASç®—æ³•å°è¯•ä¿®æ”¹stateçŠ¶æ€å€¼ï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p>
<h4 id="7-1-2-3-å…¥é˜Ÿæ“ä½œ"><a href="#7-1-2-3-å…¥é˜Ÿæ“ä½œ" class="headerlink" title="7.1.2.3 å…¥é˜Ÿæ“ä½œ"></a>7.1.2.3 å…¥é˜Ÿæ“ä½œ</h4><p>å½“ä¸€ä¸ªçº¿ç¨‹è·å–é”å¤±è´¥åè¯¥çº¿ç¨‹ä¼šè¢«è½¬æ¢ä¸º<code>Node</code>èŠ‚ç‚¹ï¼Œç„¶åå°±ä¼šä½¿ç”¨<code>enq(final Node node)</code>æ–¹æ³•å°†è¯¥èŠ‚ç‚¹æ’å…¥åˆ°AQSçš„é˜»å¡é˜Ÿåˆ—ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node t = tail;                          <span class="comment">// (1)</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))  <span class="comment">// (2)</span></span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            node.prev = t;                      <span class="comment">// (3)</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;   <span class="comment">// (4)</span></span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210503145933217.png" class="" title="image-20210503145933217"><br />

<p>åœ¨ç¬¬ä¸€æ¬¡å¾ªç¯ä¸­ï¼Œåœ¨é˜Ÿåˆ—å°¾éƒ¨æ’å…¥å…ƒç´ æ—¶ï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆdefaultï¼‰æ‰€ç¤ºï¼Œé˜Ÿåˆ—å¤´å°¾èŠ‚ç‚¹éƒ½æŒ‡å‘nullï¼›</p>
<p>æ‰§è¡Œä»£ç ï¼ˆ1ï¼‰åèŠ‚ç‚¹tæŒ‡å‘äº†å°¾éƒ¨èŠ‚ç‚¹ï¼Œæ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆIï¼‰æ‰€ç¤ºï¼›</p>
<p>æ‰§è¡Œä»£ç ï¼ˆ2ï¼‰ï¼Œä½¿ç”¨CASè®¾ç½®ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹ä¸ºå¤´ç»“ç‚¹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™è®©å°¾éƒ¨èŠ‚ç‚¹ä¹ŸæŒ‡å‘å“¨å…µèŠ‚ç‚¹ï¼Œæ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆIIï¼‰æ‰€ç¤ºã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210503151528555.png" class="" title="image-20210503151528555"><br />

<p>ç¬¬ä¸€æ¬¡å¾ªç¯ä¹‹ååªæ’å…¥äº†ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œè¿˜éœ€è¦æ’å…¥nodeèŠ‚ç‚¹ã€‚</p>
<p>åœ¨ç¬¬äºŒæ¬¡å¾ªç¯ä¸­ï¼Œæ‰§è¡Œä»£ç ï¼ˆ1ï¼‰åèŠ‚ç‚¹tæŒ‡å‘äº†å“¨å…µèŠ‚ç‚¹ï¼Œæ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆIIIï¼‰æ‰€ç¤ºï¼›</p>
<p>æ‰§è¡Œä»£ç ï¼ˆ3ï¼‰ï¼Œè®¾ç½®nodeçš„å‰é©±ç»“ç‚¹ä¸ºå“¨å…µèŠ‚ç‚¹ï¼Œæ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆIVï¼‰æ‰€ç¤ºï¼›</p>
<p>æ‰§è¡Œä»£ç ï¼ˆ4ï¼‰ï¼Œé€šè¿‡CASè®¾ç½®nodeèŠ‚ç‚¹ä¸ºå°¾éƒ¨èŠ‚ç‚¹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆVï¼‰æ‰€ç¤ºï¼›</p>
<p>ç„¶åè®¾ç½®å“¨å…µèŠ‚ç‚¹çš„åç»§ç»“ç‚¹ä¸ºnodeç»“ç‚¹ï¼Œæ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆVIï¼‰æ‰€ç¤ºã€‚</p>
<h4 id="7-1-2-4-è¡¥å……"><a href="#7-1-2-4-è¡¥å……" class="headerlink" title="7.1.2.4 è¡¥å……"></a>7.1.2.4 è¡¥å……</h4><p>åŸºäºAQSå®ç°çš„é”é™¤äº†éœ€è¦é‡å†™ä¸Šé¢æ–¹æ³•ä»¥å¤–ï¼Œè¿˜éœ€è¦é‡å†™<code>isHeldExclusively</code>æ–¹æ³•ï¼Œæ¥åˆ¤æ–­æ˜¯è¢«å½“å‰çº¿ç¨‹ç‹¬å è¿˜æ˜¯è¢«å…±äº«ã€‚</p>
<p>æ­¤å¤–ï¼Œä¸<code>acquire</code>å’Œ<code>release</code>å¯¹åº”çš„éƒ½æœ‰ä¸€ä¸ªå¸¦æœ‰<code>Interruptibly</code>å…³é”®å­—çš„å‡½æ•°ã€‚</p>
<p>åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<p>ä¸å¸¦<code>interruptibly</code>å…³é”®å­—çš„æ–¹æ³•çš„æ„æ€æ˜¯ä¸å¯¹ä¸­æ–­è¿›è¡Œå“åº”ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹åœ¨è°ƒç”¨ä¸å¸¦<code>interruptibly</code>å…³é”®å­—çš„æ–¹æ³•è·å–èµ„æºæ—¶æˆ–è€…è·å–èµ„æºå¤±è´¥è¢«æŒ‚èµ·æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸­æ–­äº†è¯¥çº¿ç¨‹ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¸ä¼šå› ä¸ºè¢«ä¸­æ–­è€ŒæŠ›å‡ºå¼‚å¸¸ï¼Œå®ƒè¿˜æ˜¯ç»§ç»­è·å–èµ„æºæˆ–è€…è¢«æŒ‚èµ·ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸å¯¹ä¸­æ–­è¿›è¡Œå“åº”ï¼Œå¿½ç•¥ä¸­æ–­ã€‚</p>
<p>è€Œå¸¦<code>interruptibly</code>å…³é”®å­—çš„æ–¹æ³•è¦å¯¹ä¸­æ–­è¿›è¡Œå“åº”ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹åœ¨è°ƒç”¨å¸¦<code>interruptibly</code>å…³é”®å­—çš„æ–¹æ³•è·å–èµ„æºæ—¶æˆ–è€…è·å–èµ„æºå¤±è´¥è€Œè¢«æŒ‚èµ·æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸­æ–­äº†è¯¥çº¿ç¨‹ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šæŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸è€Œè¿”å›ã€‚</p>
<h2 id="7-2-ReentrantLock"><a href="#7-2-ReentrantLock" class="headerlink" title="7.2 ReentrantLock"></a>7.2 ReentrantLock</h2><h3 id="7-2-1-æ¦‚è¿°ä¸åº”ç”¨"><a href="#7-2-1-æ¦‚è¿°ä¸åº”ç”¨" class="headerlink" title="7.2.1 æ¦‚è¿°ä¸åº”ç”¨"></a>7.2.1 æ¦‚è¿°ä¸åº”ç”¨</h3><p><code>ReentrantLock</code>æ˜¯å¯é‡å…¥çš„ç‹¬å é”ï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–è¯¥é”ï¼Œå…¶ä»–è·å–è¯¥é”çš„çº¿ç¨‹ä¼šè¢«é˜»å¡è€Œè¢«æ”¾å…¥è¯¥é”çš„AQSé˜»å¡é˜Ÿåˆ—ä¸­ã€‚</p>
<p>ç¤ºä¾‹1ï¼šåŸºäºAQSå®ç°çš„ä¸å¯é‡å…¥çš„ç‹¬å é”</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.AbstractQueuedSynchronizer;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-02</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> ä¸å¯å†²å…¥ç‹¬å é”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParaKLock</span> <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7379874578553124018L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‹¬å é”åŒæ­¥å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ParaKSync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6278547169976524823L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span> <span class="comment">// æ˜¯å¦é”å·²ç»è¢«æŒæœ‰</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getState() == <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span> <span class="comment">// å¦‚æœstateä¸º0ï¼Œåˆ™å°è¯•è·å–é”</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (Thread.currentThread() == <span class="keyword">this</span>.getExclusiveOwnerThread())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException(<span class="string">&quot;ä¸æ”¯æŒé”é‡å…¥&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">// è®¾ç½®ç‹¬å è€…çº¿ç¨‹</span></span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span> <span class="comment">// å°é‡Šæ”¾é”ï¼Œè®¾ç½®state = 0</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">assert</span> arg == <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (getState() == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException(<span class="string">&quot;å½“å‰stateä¸ä¸º0&quot;</span>);</span><br><span class="line">            setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">            setState(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æä¾›æ¡ä»¶å˜é‡æ¥å£</span></span><br><span class="line">        <span class="function">Condition <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ConditionObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ParaKSync sync = <span class="keyword">new</span> ParaKSync();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// ä¸€ç›´å°è¯•ï¼Œå¤±è´¥è¿›å…¥AQSé˜Ÿåˆ—</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// å°è¯•ä¸€æ¬¡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// è¶…æ—¶å°è¯•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquireNanos(<span class="number">1</span>, unit.toNanos(time));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// è§£é”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦è¢«å æœ‰</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sync.isHeldExclusively();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// å¯è¢«æ‰“æ–­å¼åŠ é”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Condition <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sync.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹2ï¼šåŸºäºä¸Šé¢è‡ªå®šä¹‰ç‹¬å é”å®ç°ç”Ÿäº§-æ¶ˆè´¹æ¨¡å‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Queue;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.LinkedBlockingDeque;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> ç”Ÿäº§-æ¶ˆè´¹æ¨¡å‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;ProducerConsumerModel&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducerConsumerModel</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** ä¸å¯é‡å…¥ç‹¬å é” */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ParaKLock LOCK = <span class="keyword">new</span> ParaKLock();</span><br><span class="line">    <span class="comment">/** å·²æ»¡ï¼šç”Ÿäº§è€…æ¡ä»¶å˜é‡ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Condition FULL = LOCK.newCondition();</span><br><span class="line">    <span class="comment">/** å·²ç©ºï¼šæ¶ˆè´¹è€…è€…æ¡ä»¶å˜é‡ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Condition EMPTY = LOCK.newCondition();</span><br><span class="line">    <span class="comment">/** äº§å“é˜Ÿåˆ— */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Queue&lt;Character&gt; QUEUE = <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;();</span><br><span class="line">    <span class="comment">/** æœ€å¤§å®¹é‡ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> QUEUE_MAX_SIZE = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">/** éšæœºå˜é‡ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Random RANDOM = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆéšæœºæ•°å­—/å­—æ¯å­—ç¬¦</span></span><br><span class="line"><span class="comment">     * ascii  char</span></span><br><span class="line"><span class="comment">     * 48-57  0~9</span></span><br><span class="line"><span class="comment">     * 65-90  A~Z</span></span><br><span class="line"><span class="comment">     * 97-122 a~z</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> asciiç å­—ç¬¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Character <span class="title">randomChar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> choice = RANDOM.nextInt(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">if</span> (choice == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">char</span>) (RANDOM.nextInt(<span class="number">10</span>) + <span class="number">48</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">char</span>) (RANDOM.nextInt(<span class="number">26</span>) + <span class="number">65</span>);</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">char</span>) (RANDOM.nextInt(<span class="number">26</span>) + <span class="number">97</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿäº§è€…çº¿ç¨‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.setName(<span class="string">&quot;Producer&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// è·å–ç‹¬å é”</span></span><br><span class="line">                LOCK.lock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// (1) å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œç­‰å¾…</span></span><br><span class="line">                    <span class="keyword">while</span> (QUEUE.size() == QUEUE_MAX_SIZE) &#123;</span><br><span class="line">                        FULL.await();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// (2) ç”Ÿäº§ä¸€ä¸ªå…ƒç´ åˆ°é˜Ÿåˆ—</span></span><br><span class="line">                    Character character = randomChar();</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;ç”Ÿäº§ =&gt; [&#123;&#125;]&quot;</span>, character);</span><br><span class="line">                    QUEUE.add(character);</span><br><span class="line">                    <span class="comment">// (3) å”¤é†’æ¶ˆè´¹è€…çº¿ç¨‹</span></span><br><span class="line">                    EMPTY.signalAll();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// é‡Šæ”¾ç‹¬å é”</span></span><br><span class="line">                    LOCK.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¶ˆè´¹è€…çº¿ç¨‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.setName(<span class="string">&quot;Consumer&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// è·å–ç‹¬å é”</span></span><br><span class="line">                LOCK.lock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// (1) å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…</span></span><br><span class="line">                    <span class="keyword">while</span> (QUEUE.isEmpty()) &#123;</span><br><span class="line">                        EMPTY.await();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// (2) æ¶ˆè´¹ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">                    Character character = QUEUE.poll();</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;æ¶ˆè´¹ =&gt; [&#123;&#125;]&quot;</span>, character);</span><br><span class="line">                    <span class="comment">// (3) å”¤é†’ç”Ÿäº§è€…çº¿ç¨‹</span></span><br><span class="line">                    FULL.signalAll();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    LOCK.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Producer producer = <span class="keyword">new</span> Producer();</span><br><span class="line">        Consumer consumer = <span class="keyword">new</span> Consumer();</span><br><span class="line">        producer.start();</span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-2-2-éå…¬å¹³é”åŸç†"><a href="#7-2-2-éå…¬å¹³é”åŸç†" class="headerlink" title="7.2.2 éå…¬å¹³é”åŸç†"></a>7.2.2 éå…¬å¹³é”åŸç†</h3><p>å…ˆç»“åˆ<code>ReentrantLock</code>çš„å†…éƒ¨ç±»<code>Sync</code> ã€<code>NonfailSync</code>å’Œ<code>AbstractQueuedSynchronizer</code>ä¸­çš„æ–¹æ³•è¿›è¡Œåˆ†æã€‚</p>
<p>å¯¹äº<code>Sync</code>ä¸­çš„æŠ½è±¡æ–¹æ³•<code>lock</code>ï¼Œå…¬å¹³é”ä¸éå…¬å¹³é”åˆ†åˆ«æœ‰ä¸åŒçš„å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>éå…¬å¹³é”<code>NonfairSync</code>çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// (ä¸€)</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))        </span><br><span class="line">        <span class="comment">// ç›´æ¥CASï¼Œè€Œä¸å»é˜»å¡é˜Ÿåˆ—ä¸­æ£€æŸ¥ï¼Œä½“ç°éå…¬å¹³æ€§</span></span><br><span class="line">        <span class="comment">// æˆåŠŸåˆ™è®¾ç½®ç‹¬å çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹</span></span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>); <span class="comment">// è¿™ä¸ªæ–¹æ³•åœ¨AQSä¸­å·²ç»å®ç°å¥½äº†</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (ä¸‰)</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires); <span class="comment">// è¿™ä¸ªæ–¹æ³•åœ¨Syncä¸­å·²ç»å®ç°å¥½äº†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Sync</code>ä¸­çš„<code>nonfairTryAcquire</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// (å››)</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰è¿›å…¥æ–¹æ³•çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å–stateçŠ¶æ€å€¼</span></span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// å¦‚æœè¿˜æœªè·å¾—é”</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ä¸å»AQSé˜Ÿåˆ—æ£€æŸ¥ï¼Œç›´æ¥å°è¯•ç”¨CASè·å¾—é”ï¼Œä½“ç°äº†ä¸å…¬å¹³æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            <span class="comment">// æˆåŠŸè·å–åˆ°é”ï¼Œå®˜å®£ç‹¬å </span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»è·å¾—äº†é”å¹¶ä¸”å½“å‰çº¿ç¨‹æ˜¯ç‹¬å çº¿ç¨‹ï¼Œè¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">// state++</span></span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å¤±è´¥ï¼Œå›åˆ°è°ƒç”¨å¤„</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AbstractQueuedSynchronizer</code>ä¸­æ¶‰åŠåˆ°çš„ä¸»è¦æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// (äºŒ) </span></span><br><span class="line"><span class="comment">// ä»¥ç‹¬å æ¨¡å¼è·å–ï¼Œå¿½ç•¥ä¸­æ–­ã€‚é€šè¿‡è‡³å°‘è°ƒç”¨ä¸€æ¬¡tryAcquireè¿”å›æˆåŠŸã€‚</span></span><br><span class="line"><span class="comment">// å¦åˆ™çº¿ç¨‹ä¼šæ’é˜Ÿï¼Œå¯èƒ½ä¼šåå¤é˜»å¡å’Œè§£é™¤é˜»å¡ï¼Œè°ƒç”¨tryAcquireç›´åˆ°æˆåŠŸã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; </span><br><span class="line">        <span class="comment">// å°è¯•ç›´æ¥è·å–é”ï¼Œçœ‹åå­—å°±çŸ¥é“ï¼Œåªæ˜¯è¯•ä¸€è¯•</span></span><br><span class="line">        <span class="comment">// æœ‰å¯èƒ½ç›´æ¥æˆåŠŸäº†ï¼Œå°±ä¸éœ€è¦è¿›é˜Ÿåˆ—æ’é˜Ÿäº†</span></span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) </span><br><span class="line">        <span class="comment">// Javaç¼–è¯‘å™¨ä¼šä¼˜åŒ–ï¼Œ&amp;&amp;å‰é¢å·²ç»ä¸ºfalseï¼Œåé¢çš„æ¡ä»¶ä¸å†è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">        <span class="comment">// èµ°åˆ°è¿™ä¸€æ­¥è¯´æ˜ï¼Œè·å–é”å¤±è´¥ï¼Œç„¶åæ‰§è¡ŒaddWaiteræ–¹æ³•ï¼ŒèŠ‚ç‚¹è®¾ç½®ä¸ºç‹¬å æ¨¡å¼</span></span><br><span class="line">        <span class="comment">// èŠ‚ç‚¹æ·»åŠ å®Œæ¯•åï¼Œæ‰§è¡ŒacquireQueuedæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ‰æ˜¯æœ€ç»ˆçš„BOSS</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªæ–¹æ³•ä¸€ç›´å¾ªç¯åˆ°è¿”å›ç»“æœä¸ºtrueï¼Œè¿›å…¥ifå—å†…çš„ä»£ç æ‰§è¡Œ</span></span><br><span class="line">        selfInterrupt(); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (äº”)</span></span><br><span class="line"><span class="comment">// æ·»åŠ ç­‰å¾…èŠ‚ç‚¹è‡³é˜Ÿåˆ—æœ«å°¾</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°èŠ‚ç‚¹nodeï¼Œæ¨¡å¼ä¸ºEXCLUSIVE(ç‹¬å )</span></span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// è·å–å°¾éƒ¨èŠ‚ç‚¹</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="comment">// å°¾éƒ¨èŠ‚ç‚¹éç©º</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å…ˆå°†nodeçš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰å°¾éƒ¨èŠ‚ç‚¹</span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="comment">// é€šè¿‡CASæ“ä½œå°†nodeèŠ‚ç‚¹è®¾ç½®ä¸ºtailå°¾éƒ¨èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœCASæˆåŠŸï¼Œåˆ™å°†åŸtailèŠ‚ç‚¹çš„åç»§ç»“ç‚¹è®¾ç½®ä¸ºå½“å‰å°¾éƒ¨èŠ‚ç‚¹node</span></span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°¾éƒ¨èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜æ²¡æœ‰å“¨å…µèŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ–¹æ³•åœ¨7.1.2.3å·²ç»è¯¦è¿°è¿‡</span></span><br><span class="line">    <span class="comment">// éœ€è¦åˆ›å»ºæ–°çš„å“¨å…µèŠ‚ç‚¹ï¼Œç„¶åæ’å…¥å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">    enq(node); </span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (å…­)</span></span><br><span class="line"><span class="comment">// åœ¨é˜Ÿåˆ—ä¸­å¾ªç¯å°è¯•è·å–é”</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹è·å–é”çš„è¿‡ç¨‹ä¸­æ˜¯å¦äº§ç”Ÿäº†ä¸­æ–­</span></span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹ä¸ºheadå“¨å…µèŠ‚ç‚¹ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹ä¸ºç¬¬äºŒèŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">// æ‹¥æœ‰å°è¯•è·å–é”çš„èµ„æ ¼</span></span><br><span class="line">            <span class="comment">// è·å–é”æˆåŠŸåˆ™è¿›å…¥ifä»£ç å—ï¼Œå‰”é™¤å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼Œå±æ€§threadå’Œprevéƒ½è®¾ç½®ä¸ºnull</span></span><br><span class="line">                <span class="comment">// ç›´æ¥ä½¿ç”¨setHeadè€ŒécompareAndSetHeadï¼Œæ²¡æœ‰ä½¿ç”¨CAS</span></span><br><span class="line">                <span class="comment">// æ˜¯å› ä¸ºæ­¤æ—¶å·²ç»æˆåŠŸè·å–åˆ°ç‹¬å é”</span></span><br><span class="line">                setHead(node);</span><br><span class="line">       			<span class="comment">// è¾…åŠ©GC</span></span><br><span class="line">                p.next = <span class="keyword">null</span>; </span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œåªæœ‰ä¸¤ç§æƒ…å†µ</span></span><br><span class="line">            <span class="comment">// (1)ä¸ç¬¦åˆè·å–é”çš„å‰æï¼Œå³å½“å‰èŠ‚ç‚¹ä¸æ˜¯ç¬¬äºŒèŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">// (2)tryAcquireå¤±è´¥ï¼Œå³æ²¡æœ‰æŠ¢å åˆ°é”</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>; <span class="comment">// äº§ç”Ÿäº†ä¸­æ–­ï¼Œè®¾ç½®åæ°¸ä¹…ä¿ç•™</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å½“tryAcquireä¸ºæŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œfailedä¸ºtrue</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (ä¸ƒ)</span></span><br><span class="line"><span class="comment">// è·å–å¤±è´¥ååº”è¯¥æŒ‚èµ·</span></span><br><span class="line"><span class="comment">// å¯»æ‰¾nodeçš„æœ‰æ•ˆå‰é©±ï¼Œå¹¶ä¸”å°†æœ‰æ•ˆå‰é©±çŠ¶æ€è®¾ç½®ä¸ºSIGNALï¼Œè¿”å›trueä»£è¡¨é©¬ä¸Šå¯ä»¥é˜»å¡</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">    <span class="comment">// å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸ºSIGNALï¼ŒçŠ¶æ€æ­£å¸¸ï¼Œå½“å‰çº¿ç¨‹éœ€è¦æŒ‚èµ·ï¼Œè‡ªå·±çš„å”¤é†’ä¾èµ–äºå‰é©±èŠ‚ç‚¹ã€‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹å˜æˆäº†headï¼Œå¹¶ä¸”headçš„ä»£è¡¨çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œå°±ä¼šæ ¹æ®è¿™ä¸ªSIGNALå”¤é†’è‡ªå·±ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="comment">// è¿”å›trueï¼Œåˆ™è¿›å…¥parakAndCheckInterruptæŒ‚èµ·å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸ºCANCELLEDï¼Œè¯´æ˜å‰é©±èŠ‚ç‚¹å› ä¸ºè¶…æ—¶æˆ–è€…å“åº”äº†ä¸­æ–­è€Œå–æ¶ˆæ’é˜Ÿã€‚</span></span><br><span class="line">    <span class="comment">// å› æ­¤éœ€è¦è·¨è¶Šè¿™äº›CANCELLEDç»“ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªçŠ¶æ€&lt;0çš„èŠ‚ç‚¹åšè‡ªå·±çš„å‰é©±ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º0ï¼Œé€šè¿‡CASå°†å…¶çŠ¶æ€è®¾ç½®ä¸ºSIGNAL(-1)</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›falseåˆ™ä¸è¿›å…¥parakAndChecKInterruptç»§ç»­åœ¨acquireQueeudä¸­å¾ªç¯</span></span><br><span class="line">    <span class="comment">// å†æ¬¡è¿›å…¥è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œä¾¿ä¼šä»ç¬¬ä¸€ä¸ªifåˆ†æ”¯è¿”å›true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (å…«)</span></span><br><span class="line"><span class="comment">// æŒ‚èµ·å¹¶æ£€æŸ¥ä¸­æ–­çŠ¶æ€</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æŒ‚èµ·å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="comment">// å”¤é†’æ–¹å¼ï¼šunpark/interrupt/return</span></span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// è¿”å›ä¸­æ–­çŠ¶æ€ï¼Œå¹¶ä¸”æ¸…é™¤ä¸­æ–­æ ‡è®°</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (ä¹)</span></span><br><span class="line"><span class="comment">// è¡¥å……ä¸­æ–­æ ‡è®°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">selfInterrupt</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éå…¬å¹³æŠ¢é”è¿‡ç¨‹æ€»ç»“ï¼š</p>
<p>è°ƒç”¨<code>ReentrantLock</code>çš„<code>lock</code>æ–¹æ³•ï¼Œä¼šæ‰§è¡ŒAQSçš„<code>acquire</code>æ–¹æ³•ï¼Œå…ˆæ‰§è¡Œ<code>NonFairSync</code>çš„<code>tryAcquire</code>æ–¹æ³•å°è¯•è·å–é”ï¼Œå¤±è´¥åˆ™æ‰§è¡ŒAQSçš„<code>acquireQueued</code>æ–¹æ³•åœ¨é˜Ÿåˆ—ä¸­å¾ªç¯è·å–é”ã€‚</p>
<p><code>tryAcquire</code>ï¼šæ£€æŸ¥<code>state</code>çŠ¶æ€å€¼ï¼Œä¸º0è¯´æ˜è¿˜æœªæœ‰çº¿ç¨‹è·å–é”ï¼Œé‚£ä¹ˆè‡ªå·±å°±ç›´æ¥å°è¯•é€šè¿‡CASæ“ä½œå°†<code>state</code>è®¾ç½®ä¸º1ï¼ŒæˆåŠŸåˆ™å®˜å®£è‡ªå·±ç‹¬å ï¼›ä¸ä¸º0ä¸”å½“å‰çº¿ç¨‹æ˜¯ç‹¬å çº¿ç¨‹ï¼Œè¡¨ç¤ºé”å†²å…¥ï¼Œé‚£ä¹ˆ<code>state</code>+1ã€‚ä»¥ä¸Šä¸¤ç§æƒ…å†µæˆåŠŸéƒ½è¿”å›<code>true</code>ï¼Œä»è€Œç»“æŸæŠ¢é”è¿‡ç¨‹ï¼Œå…¶ä»–æƒ…å†µéƒ½ä»£è¡¨è·å–å¤±è´¥ï¼Œè¿”å›<code>false</code>ã€‚</p>
<p>è·å–å¤±è´¥åï¼Œå…ˆæ‰§è¡Œ<code>addWaiter</code>æ–¹æ³•å°†å½“å‰çº¿ç¨‹å°è£…ä¸ºèŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾ï¼Œç„¶åè¿›å…¥<code>acquireQueued</code>æ–¹æ³•ï¼Œå¾ªç¯è·å–ç›´åˆ°æˆåŠŸï¼Œæ‰§è¡Œ<code>selfInterrupt</code>æ–¹æ³•ã€‚</p>
<p><code>acquireQueued</code>ï¼šè®¾ç½®ä¸€ä¸ªæ ‡å¿—<code>interrupted = false</code>ï¼Œä»£è¡¨çº¿ç¨‹è·å–é”çš„è¿‡ç¨‹ä¸­æ˜¯å¦äº§ç”Ÿäº†ä¸­æ–­ï¼Œç¬¬ä¸€ä¸ªifåˆ†æ”¯ï¼Œåˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºå“¨å…µèŠ‚ç‚¹ï¼Œæ˜¯åˆ™æ‹¥æœ‰è·å–é”çš„èµ„æ ¼ï¼Œæ‰§è¡Œ<code>tryAcquire</code>å°è¯•è·å–é”ï¼ŒæˆåŠŸåˆ™å°†å‰é©±èŠ‚ç‚¹å‰”é™¤ï¼Œå¹¶ä¸”è¿”å›<code>interrupted</code>ï¼›å¾€ä¸‹æ‰§è¡Œï¼Œç¬¬äºŒä¸ªifåˆ†æ”¯ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯ç¬¬äºŒèŠ‚ç‚¹ï¼Œæ²¡æœ‰è·å–é”çš„èµ„æ ¼ï¼Œæˆ–è€…æ˜¯<code>tryAcquire</code>å¤±è´¥ï¼Œæ²¡æœ‰æŠ¢å åˆ°é”ï¼Œæ‰§è¡Œ<code>shouldParkAfterFailedAcquire</code>å’Œ<code>parkAndCheckInterrupt</code>ï¼Œæ‰§è¡ŒæˆåŠŸåå°†<code>interrupted</code>è®¾ç½®ä¸º<code>true</code>ã€‚è¿”å›<code>false</code>åˆ™ç›´æ¥é€€å‡º<code>acquireQueued</code>è¿‡ç¨‹ï¼Œè¿”å›<code>true</code>åˆ™è¯´æ˜è·å–é”çš„è¿‡ç¨‹ä¸­äº§ç”Ÿäº†ä¸­æ–­ï¼Œä½†æ˜¯è¿™ä¸ªä¸­æ–­æ ‡è®°åœ¨<code>parkAndCheckInterrupt</code>æ¸…é™¤äº†ï¼Œæ‰€ä»¥éœ€è¦å¡«è¡¥ä¸­æ–­æ ‡è®°ã€‚</p>
<p><code>shouldParkAfterFailedAcquire</code>ï¼šé¡¾åæ€ä¹‰ï¼Œè·å–å¤±è´¥ååº”è¯¥æŒ‚èµ·ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º<code>SIGNAL</code>ï¼Œé‚£ä¹ˆå‰é©±èŠ‚ç‚¹é‡Šæ”¾é”åä¼šé€šçŸ¥è‡ªå·±ï¼Œè‡ªå·±å°±å¯ä»¥å®‰å¿ƒé˜»å¡ï¼Œå¹¶è¿”å›<code>true</code>ï¼›å¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º<code>CANCELLED</code>å³å–æ¶ˆæ’é˜Ÿï¼Œé‚£ä¹ˆéœ€è¦å¯»æ‰¾å½“å‰èŠ‚ç‚¹çš„æœ‰æ•ˆå‰é©±ï¼Œå³è·³è¿‡çŠ¶æ€ä¸º<code>CANCELLED</code>çš„èŠ‚ç‚¹ï¼Œæ‰¾åˆ°ä¸€ä¸ªçŠ¶æ€ä¸º<code>SIGNAL</code>çš„èŠ‚ç‚¹ï¼›å¦åˆ™å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º0ï¼Œåˆ™é€šè¿‡CASæ“ä½œå°†å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º<code>SIGNAL</code>ï¼Œåä¸¤ç§éƒ½ä¼šè¿”å›<code>false</code>ï¼Œé‚£ä¹ˆä¼šåœ¨<code>acquireQueued</code>çš„forå¾ªç¯ä¸­è¿›è¡Œä¸‹ä¸€è½®ï¼Œç¬¬äºŒæ¬¡ä¼šæŒ‰ç…§ç¬¬ä¸€ç§æƒ…å†µè¿”å›<code>true</code>ã€‚è¿”å›<code>true</code>åï¼Œæ‰§è¡Œ<code>parkAndCheckInterrupt</code>ã€‚</p>
<p><code>parkAndCheckInterrupt</code>ï¼šå…ˆè°ƒç”¨<code>LockSupport.park</code>æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ˆæœ‰ä¸‰ç§å”¤é†’æ–¹å¼ï¼šâ‘ unpark â‘¡interrupt â‘¢returnï¼‰ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹ç­‰å¾…å”¤é†’ï¼ˆè¢«å”¤é†’çš„æ—¶å€™ä¼šè¿›å…¥<code>acquireQueued</code>çš„ç¬¬ä¸€ä¸ªifåˆ†æ”¯ï¼‰ï¼Œåè°ƒç”¨<code>Thread.interrupted</code>æ–¹æ³•è¿”å›å¹¶é‡ç½®ä¸­æ–­çŠ¶æ€ï¼Œ</p>
<blockquote>
<p>è¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦æ¸…é™¤ä¸­æ–­çŠ¶æ€å‘¢ï¼Ÿè¯·çœ‹çŸ¥ä¹å›ç­”ï¼š <a href="https://www.zhihu.com/question/399039232/answer/1260843911">https://www.zhihu.com/question/399039232/answer/1260843911</a></p>
<p>å¦‚æœä¸æ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¿”å›<code>Thread.currentThread.isInterrupt()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æŒ‚èµ·åä¾ç„¶æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œé‚£ä¹ˆä¸‹ä¸€è½®å¾ªç¯çš„æ—¶å€™<code>LockSupport.lock</code>æ–¹æ³•å°†ä¼šå¤±æ•ˆï¼Œä½¿å¾—å½“å‰çº¿ç¨‹æŒç»­è¿è¡Œï¼Œåœ¨<code>acquireQueued</code>çš„forå¾ªç¯ä¸­ç©ºè½¬ï¼Œå¯¼è‡´CPU100%ã€‚</p>
</blockquote>
<p>ä¸‹é¢å¼€å§‹å›¾ç¤ºè¯¦è§£ï¼š</p>
<p>æ²¡æœ‰ç«äº‰æ—¶</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210502211712585.png" class="" title="image-20210502211712585"><br />

<p>ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°æ—¶</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210502211848516.png" class="" title="image-20210502211848516"><br />

<p>Thread-1æ‰§è¡Œäº†</p>
<ol>
<li><code>CASC</code>å°è¯•å°†<code>state</code>ç”±<code>0</code>æ”¹ä¸º<code>1</code>ï¼Œç»“æœå¤±è´¥</li>
<li>è¿›å…¥<code>tryAcquire</code>é€»è¾‘ï¼Œè¿™æ—¶<code>state</code>å·²ç»æ˜¯<code>1</code>ï¼Œç»“æœä»ç„¶å¤±è´¥</li>
<li>æ¥ä¸‹æ¥è¿›å…¥<code>addWaiter</code>é€»è¾‘ï¼Œæ„é€ <code>Node</code>é˜Ÿåˆ—<ul>
<li>å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥<code>Node</code>çš„<code>waitStatus</code>çŠ¶æ€ï¼Œå…¶ä¸­0ä¸ºé»˜è®¤æ­£å¸¸çŠ¶æ€</li>
<li>Nodeçš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„</li>
<li>å…¶ä¸­ç¬¬ä¸€ä¸ª<code>Node</code>ç§°ä¸º<code>Dummy</code>ï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹</li>
</ul>
</li>
</ol>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210502213906982.png" class="" title="image-20210502213906982"><br />

<p>è¿›å…¥<code>acquireQueued</code>é€»è¾‘</p>
<ol>
<li><code>acquireQueued</code>ä¼šåœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥<code>park</code>é˜»å¡</li>
<li>å¦‚æœè‡ªå·±æ˜¯ç´§é‚»ç€<code>head</code>ï¼ˆæ’ç¬¬äºŒä½ï¼‰ï¼Œé‚£ä¹ˆå†æ¬¡<code>tryAcquire</code>å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶<code>state</code>ä»ä¸º<code>1</code>ï¼Œå¤±è´¥</li>
<li>è¿›å…¥<code>shouldParkAfterFailedAcquire</code>é€»è¾‘ï¼Œå°†å‰é©±<code>node</code>ï¼Œå³<code>head</code>çš„<code>waitStatus</code>æ”¹ä¸º<code>-1</code>ï¼Œè¿™æ¬¡è¿”å›<code>false</code></li>
</ol>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210502220340804.png" class="" title="image-20210502220340804"><br />

<ol start="4">
<li><p><code>shouldParkAfterFailedAcquire</code>æ‰§è¡Œå®Œæ¯•å›åˆ°<code>acquireQueued</code>ï¼Œå†æ¬¡<code>tryAcquire</code>å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶<code>state</code>ä»ç„¶ä¸º1ï¼Œå¤±è´¥</p>
</li>
<li><p>å½“å†æ¬¡è¿›å…¥<code>shouldParkAfterFailedAcquire</code>æ—¶ï¼Œè¿™æ—¶å› ä¸ºå…¶å‰é©±<code>node</code>çš„<code>waitStatus</code>å·²ç»æ˜¯<code>-1</code>ï¼Œè¿™æ¬¡è¿”å›<code>true</code></p>
</li>
<li><p>è¿›å…¥<code>parkAndCheckInterrupt</code>ï¼ŒThread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰</p>
</li>
</ol>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210502220921530.png" class="" title="image-20210502220921530"><br />

<p>å†æ¬¡æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ä¸Šè¿°è¿‡ç¨‹ç«äº‰å¤±è´¥ï¼Œå˜æˆè¿™ä¸ªæ ·å­</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210502221051585.png" class="" title="image-20210502221051585"><br />

<p>Thread-0é‡Šæ”¾é”</p>
<ul>
<li>è®¾ç½®<code>exclusiveOwnerThread</code>ä¸º<code>null</code></li>
<li><code>state</code> = 0</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210502221412738.png" class="" title="image-20210502221412738"><br />

<p>å½“å‰é˜Ÿåˆ—ä¸ä¸º<code>null</code>ï¼Œå¹¶ä¸”<code>head</code>çš„<code>waitStatus</code>ï¼Œè¿›å…¥<code>unparkSuccessor</code>æµç¨‹</p>
<p>æ‰¾åˆ°é˜Ÿåˆ—ä¸­ç¦»<code>head</code>æœ€è¿‘çš„ä¸€ä¸ª<code>node</code>ï¼ˆæ²¡å–æ¶ˆçš„ï¼‰ï¼Œ<code>unpark</code>æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸ºThread-1ã€‚</p>
<p>å›åˆ°Thread-1çš„<code>acquireQueued</code>æµç¨‹</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210502222848420.png" class="" title="image-20210502222848420"><br />

<p>å¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®</p>
<ul>
<li><code>exclusiveOwnerThread</code>ä¸ºThread-1ï¼Œ<code>state</code> = 1</li>
<li><code>head</code>æŒ‡å‘åˆšåˆšThread-1æ‰€åœ¨çš„<code>Node</code>ï¼Œè¯¥<code>node</code>æ¸…ç©ºThread</li>
<li>åŸæœ¬çš„<code>head</code>å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œè€Œå¯è¢«åƒåœ¾å›æ”¶</li>
</ul>
<p>å¦‚æœè¿™æ—¶å€™æœ‰å…¶ä»–çº¿ç¨‹æ¥ç«äº‰ï¼ˆéå…¬å¹³çš„ä½“ç°ï¼‰ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰Thrtead-4æ¥äº†</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210502224147622.png" class="" title="image-20210502224147622"><br />

<p>å¦‚æœä¸å·§åˆè¢«Thread-4å äº†å…ˆ</p>
<ul>
<li>Thread-4è¢«è®¾ç½®ä¸º<code>exclusiveOwnerThread</code>ï¼Œ<code>state</code> = 1</li>
<li>Thread-1å†æ¬¡è¿›å…¥<code>acquireQueued</code>æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥<code>park</code>é˜»å¡</li>
</ul>
<h3 id="7-2-3-å…¬å¹³é”åŸç†"><a href="#7-2-3-å…¬å¹³é”åŸç†" class="headerlink" title="7.2.3 å…¬å¹³é”åŸç†"></a>7.2.3 å…¬å¹³é”åŸç†</h3><p><code>ReentrantLock-Fair</code>çš„<code>Sync</code>è¦†ç›–æ–¹æ³•<code>tryAcquire</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å…ˆæ£€æŸ¥AQSé˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ‰å»ç«äº‰</span></span><br><span class="line">        <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">            compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AbstractQueuedSynchronizer</code>ä¸­æ¶‰åŠåˆ°çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŸ¥è¯¢æ˜¯å¦æœ‰çº¿ç¨‹ç­‰å¾…è·å–çš„æ—¶é—´è¶…è¿‡å½“å‰çº¿ç¨‹ï¼Œå³æŸ¥è¯¢ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasQueuedPredecessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node t = tail; <span class="comment">// å°¾èŠ‚ç‚¹è¦ä¹ˆä¸ºç©ºï¼Œè¦ä¹ˆä¸ºç­‰å¾…</span></span><br><span class="line">    Node h = head; <span class="comment">// å¤´èŠ‚ç‚¹è¦ä¹ˆä¸ºç©ºï¼Œè¦ä¹ˆä¸ºå“¨å…µèŠ‚ç‚¹</span></span><br><span class="line">    Node s;</span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp; <span class="comment">// å¤´å°¾èŠ‚ç‚¹ä¸åŒè¯´æ˜é˜Ÿåˆ—ä¸­æœ‰å…¶ä»–èŠ‚ç‚¹</span></span><br><span class="line">        ((s = h.next) == <span class="keyword">null</span> || <span class="comment">//è¡¨ç¤ºé˜Ÿåˆ—ä¸­æ²¡æœ‰ç¬¬äºŒèŠ‚ç‚¹</span></span><br><span class="line">         s.thread != Thread.currentThread()); <span class="comment">// æˆ–è€…é˜Ÿåˆ—ä¸­ç¬¬äºŒçº¿ç¨‹ä¸æ˜¯æ­¤çº¿ç¨‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-2-4-å¯é‡å…¥åŸç†"><a href="#7-2-4-å¯é‡å…¥åŸç†" class="headerlink" title="7.2.4 å¯é‡å…¥åŸç†"></a>7.2.4 å¯é‡å…¥åŸç†</h3><p><code>ReentrantLock</code>çš„å†…éƒ¨ç±»<code>Sync</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–é”</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å–stateçŠ¶æ€å€¼</span></span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// å¦‚æœæœªè·å¾—é”</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// CASæˆåŠŸåè®¾ç½®ç‹¬å çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹å³å¯</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»è·å¾—é”ï¼Œå½“å‰çº¿ç¨‹æ˜¯ç‹¬å çº¿ç¨‹ï¼Œè¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">// stateåœ¨å½“å‰åŸºç¡€ä¸ŠåŠ acquires</span></span><br><span class="line">        <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»è·å¾—é”ï¼Œå½“å‰çº¿ç¨‹éç‹¬å çº¿ç¨‹ï¼Œå› ä¸ºæ˜¯ç‹¬å é”ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½é˜»å¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹éç‹¬å çº¿ç¨‹åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// å½“stateå‡ä¸º0æ—¶é”æ‰é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="keyword">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-2-5-å¯æ‰“æ–­åŸç†"><a href="#7-2-5-å¯æ‰“æ–­åŸç†" class="headerlink" title="7.2.5 å¯æ‰“æ–­åŸç†"></a>7.2.5 å¯æ‰“æ–­åŸç†</h3><p>ä¸å¯æ‰“æ–­æ¨¡å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// çº¿ç¨‹æ— æ³•è·å¾—é”æ—¶ï¼Œè¿›å…¥è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// è¿˜æ˜¯éœ€è¦è·å¾—é”åï¼Œæ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯å› ä¸ºinterruptè¢«å”¤é†’ï¼Œè¿”å›æ‰“æ–­çŠ¶æ€ä¸ºtrue</span></span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯trueï¼Œåˆ™parkä¼šå¤±æ•ˆ</span></span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// interruptedä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">selfInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯æ‰“æ–­æ¨¡å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰è·å¾—åˆ°é”ï¼Œè¿›å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg))</span><br><span class="line">        doAcquireInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯æ‰“æ–­é”çš„è·å–æµç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireInterruptibly</span><span class="params">(<span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                <span class="comment">// åœ¨parkè¿‡ç¨‹ä¸­å¦‚æœè¢«interruptä¼šè¿›å…¥æ­¤</span></span><br><span class="line">                <span class="comment">// è¿™æ—¶å€™æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸ä¼šå†æ¬¡è¿›å…¥forå¾ªç¯</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-2-6-æ¡ä»¶å˜é‡å®ç°åŸç†"><a href="#7-2-6-æ¡ä»¶å˜é‡å®ç°åŸç†" class="headerlink" title="7.2.6 æ¡ä»¶å˜é‡å®ç°åŸç†"></a>7.2.6 æ¡ä»¶å˜é‡å®ç°åŸç†</h3><p>æ¯ä¸ªæ¡ä»¶å˜é‡å…¶å®å°±å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå…¶å®ç°ç±»æ˜¯<code>ConditionObject</code>ã€‚</p>
<p>å†…éƒ¨å±æ€§ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æˆå‘˜å˜é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter; <span class="comment">// é¦–èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;  <span class="comment">// å°¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">// å¸¸é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REINTERRUPT =  <span class="number">1</span>; <span class="comment">// ä»ç­‰å¾…çŠ¶æ€åˆ‡æ¢ä¸ºä¸­æ–­çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THROW_IE    = -<span class="number">1</span>; <span class="comment">// æŠ›å‡ºå¼‚å¸¸æ ‡è¯†</span></span><br></pre></td></tr></table></figure>



<p><strong>awaitæµç¨‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‘é˜Ÿåˆ—ä¸­æ·»åŠ èŠ‚ç‚¹å¹¶è¿”å›</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”</span></span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullyRelease</span><span class="params">(Node node)</span></span></span><br><span class="line"><span class="function"><span class="comment">// åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­</span></span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isOnSyncQueue</span><span class="params">(Node node)</span></span></span><br><span class="line"><span class="function"><span class="comment">// æ£€æŸ¥çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼Œå¦‚æœæ˜¯åˆ™ç»ˆæ­¢ConditionçŠ¶æ€å¹¶åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">checkInterruptWhileWaiting</span><span class="params">(Node node)</span></span></span><br><span class="line"><span class="function"><span class="comment">// æ“ä½œèŠ‚ç‚¹å»ç”³è¯·é”</span></span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span></span></span><br><span class="line"><span class="function"><span class="comment">// æ¸…ç†ç­‰å¾…é˜Ÿåˆ—ä¸­æ— æ•ˆèŠ‚ç‚¹</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unlinkCancelledWaiters</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// å¤„ç†çº¿ç¨‹ä¸­æ–­æƒ…å†µ</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reportInterruptAfterWait</span><span class="params">(<span class="keyword">int</span> interruptMode)</span></span></span><br></pre></td></tr></table></figure>

<p>å¼€å§‹Thread-0æŒæœ‰é”ï¼Œè°ƒç”¨<code>await</code>ï¼Œè¿›å…¥<code>ConditionObject</code>çš„<code>addConditionWaiter</code>æµç¨‹ã€‚</p>
<p>åˆ›å»ºæ–°çš„<code>Node</code>çŠ¶æ€ä¸º-2ï¼ˆ<code>Node.CONDITION</code>ï¼‰ï¼Œå…³è”Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210504184051341.png" class="" title="image-20210504184051341"><br />

<p>æ¥ä¸‹æ¥è¿›å…¥AQSçš„<code>fullRelease</code>æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210505112113307.png" class="" title="image-20210505112113307">

<p>unpark AQSé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç«äº‰é”ï¼Œå‡è®¾æ²¡æœ‰å…¶ä»–ç«äº‰çº¿ç¨‹ï¼Œé‚£ä¹ˆThread-1ç«äº‰æˆåŠŸ</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210505112236553.png" class="" title="image-20210505112236553"><br />

<p>parké˜»å¡Thread-0</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210505112338808.png" class="" title="image-20210505112338808"><br />



<p><strong>signalæµç¨‹</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å”¤é†’çº¿ç¨‹å…¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// åˆ¤å®šå½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰é”</span></span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="comment">// å”¤é†’firstèŠ‚ç‚¹</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span></span><br><span class="line"><span class="function"><span class="comment">// è½¬æ¢èŠ‚ç‚¹çŠ¶æ€</span></span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span></span><br></pre></td></tr></table></figure>

<p>å‡è®¾Thread-1è¦æ¥å”¤é†’Thread-0</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210505115153129.png" class="" title="image-20210505115153129"><br />

<p>è¿›å…¥<code>ConditionObject</code>çš„<code>doSignal</code>æµç¨‹ï¼Œå–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª<code>Node</code>ï¼ŒThread-0æ‰€åœ¨<code>Node</code></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210505120611070.png" class="" title="image-20210505120611070"><br />

<p>æ‰§è¡Œ<code>transferForSignal</code>æµç¨‹ï¼Œå°†è¯¥<code>Node</code>åŠ å…¥åˆ°AQSé˜Ÿåˆ—å°¾éƒ¨ï¼Œå°†Thread-0çš„<code>waitStatus</code>æ”¹ä¸º0ï¼ŒThread-3çš„<code>waitStatus</code>æ”¹ä¸º-1</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/61205/image-20210505121200958.png" class="" title="image-20210505121200958"><br />

<p>Thread-1é‡Šæ”¾é”ï¼Œè¿›å…¥<code>unlock</code>æµç¨‹ã€‚</p>
<h2 id="7-3-ReentrantReadWriteLock"><a href="#7-3-ReentrantReadWriteLock" class="headerlink" title="7. 3 ReentrantReadWriteLock"></a>7. 3 ReentrantReadWriteLock</h2><h3 id="7-3-1-æ¦‚è¿°ä¸åº”ç”¨"><a href="#7-3-1-æ¦‚è¿°ä¸åº”ç”¨" class="headerlink" title="7.3.1 æ¦‚è¿°ä¸åº”ç”¨"></a>7.3.1 æ¦‚è¿°ä¸åº”ç”¨</h3><p>å½“è¯»æ“ä½œè¿œè¿œé«˜äºå†™æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ä½¿ç”¨è¯»å†™é”è®©è¯»-è¯»å¯ä»¥å¹¶å‘ï¼Œæé«˜æ€§èƒ½ã€‚</p>
<ul>
<li>è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡</li>
<li>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒï¼šæŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ï¼Œä¼šå¯¼è‡´å†™é”æ°¸ä¹…ç­‰å¾…</li>
<li>é‡å…¥æ—¶é™çº§æ”¯æŒï¼šæŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”</li>
</ul>
<p>ç¤ºä¾‹1ï¼šæ•°æ®å®¹å™¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantReadWriteLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;DataContainer&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataContainer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Random RANDOM = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readLock = lock.readLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writeLock = lock.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Character <span class="title">randomChar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> choice = RANDOM.nextInt(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">if</span> (choice == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">char</span>) (RANDOM.nextInt(<span class="number">10</span>) + <span class="number">48</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">char</span>) (RANDOM.nextInt(<span class="number">26</span>) + <span class="number">65</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">char</span>) (RANDOM.nextInt(<span class="number">26</span>) + <span class="number">97</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–è¯»é”...&quot;</span>);</span><br><span class="line">        readLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;è¯»å–æ•°æ® =&gt; [&#123;&#125;]&quot;</span>, data);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;é‡Šæ”¾è¯»é”...&quot;</span>);</span><br><span class="line">            readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;è·å–å†™é”...&quot;</span>);</span><br><span class="line">        writeLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;å†™å…¥æ•°æ® =&gt; [&#123;&#125;]&quot;</span>, data = randomChar());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;é‡Šæ”¾å†™é”...&quot;</span>);</span><br><span class="line">            writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹2ï¼šæ–‡æ¡£ä¸­çš„åº”ç”¨ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantReadWriteLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CachedData</span> </span>&#123;</span><br><span class="line">    Object data;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœå¤±æ•ˆï¼Œéœ€è¦é‡æ–°è®¡ç®—data</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> cacheValid;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Random RANDOM = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">final</span> ReentrantReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">processCachedData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.readLock().lock();</span><br><span class="line">        <span class="keyword">if</span> (!cacheValid) &#123;</span><br><span class="line">            <span class="comment">// ä¸æ”¯æŒé”å‡çº§ï¼Œè·å–å†™é”é’±å¿…é¡»é‡Šæ”¾è¯»é”</span></span><br><span class="line">            lock.readLock().unlock();</span><br><span class="line">            lock.writeLock().lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åŒé‡æ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦å…¶ä»–çº¿ç¨‹å·²ç»è·å–äº†è¯»é”æ›´æ–°ç¼“å­˜ï¼Œé¿å…é‡å¤æ›´æ–°</span></span><br><span class="line">                <span class="keyword">if</span> (!cacheValid) &#123;</span><br><span class="line">                    data = write();</span><br><span class="line">                    cacheValid = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// é™ä¸ºè¯»é”ï¼Œé‡Šæ”¾å†™é”ï¼Œè®©å…¶ä»–çº¿ç¨‹è¯»å–ç¼“å­˜</span></span><br><span class="line">                lock.readLock().lock();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.writeLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ•°æ®ï¼Œé‡Šæ”¾è¯»é”</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            use(data);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹3ï¼šRedisçš„Javaç¼“å­˜</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantReadWriteLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;GenericRedisDemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericRedisDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        GenericCached cached = <span class="keyword">new</span> GenericCached();</span><br><span class="line">        cached.update(<span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">&quot;KHighness&quot;</span>, <span class="string">&quot;parakovo@gmail.com&quot;</span>));</span><br><span class="line">        cached.update(<span class="keyword">new</span> User(<span class="number">2</span>, <span class="string">&quot;RubbishK&quot;</span>, <span class="string">&quot;rubbish@gmail.com&quot;</span>));</span><br><span class="line">        cached.update(<span class="keyword">new</span> User(<span class="number">3</span>, <span class="string">&quot;FlowerK&quot;</span>, <span class="string">&quot;flower@gmail.com&quot;</span>));</span><br><span class="line">        log.debug(cached.query(User.class, <span class="number">1</span>).toString());</span><br><span class="line">        log.debug(cached.query(User.class, <span class="number">1</span>).toString());</span><br><span class="line">        log.debug(cached.query(User.class, <span class="number">2</span>).toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(Integer id, String name, String email)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.email = email;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Generic</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">update</span><span class="params">(Object obj)</span></span>;</span><br><span class="line">    <span class="function">Map&lt;String, String&gt; <span class="title">query</span><span class="params">(Class&lt;?&gt; clazz, Integer id)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericRedis</span> <span class="keyword">implements</span> <span class="title">Generic</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; clazz = obj.getClass();</span><br><span class="line">        Field[] declaredFields = clazz.getDeclaredFields();</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Integer id = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field idField = clazz.getDeclaredField(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">            idField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            id = (Integer) idField.get(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                map.put(field.getName(), field.get(obj).toString());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jedis.hmset(clazz.getSimpleName() + <span class="string">&quot;:&quot;</span> + id, map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">query</span><span class="params">(Class&lt;?&gt; clazz, Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jedis.hgetAll(clazz.getSimpleName() + <span class="string">&quot;:&quot;</span> + id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è£…é¥°å™¨æ¨¡å¼ï¼Œå¼ºåŒ–</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;GenericCached&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericCached</span> <span class="keyword">implements</span> <span class="title">Generic</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GenericRedis redis = <span class="keyword">new</span> GenericRedis();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Key, Map&lt;String, String&gt;&gt; cache = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Key</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; clazz;</span><br><span class="line">        Integer id;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Key</span><span class="params">(Class&lt;?&gt; clazz, Integer id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.clazz = clazz;</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            Key key = (Key) o;</span><br><span class="line">            <span class="keyword">return</span> Objects.equals(clazz, key.clazz) &amp;&amp; Objects.equals(id, key.id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hash(clazz, id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Key[&quot;</span> + <span class="string">&quot;clazz=&quot;</span> + clazz + <span class="string">&quot;, id=&quot;</span> + id + <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…ˆæ›´æ–°rediså†æ¸…é™¤ç¼“å­˜ï¼Œéœ€è¦åŠ å†™é”</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        String res = <span class="keyword">null</span>;</span><br><span class="line">        lock.writeLock().lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ›´æ–°redis</span></span><br><span class="line">            res = redis.update(obj);</span><br><span class="line">            <span class="comment">// æ¸…é™¤ç¼“å­˜</span></span><br><span class="line">            Field idField = obj.getClass().getDeclaredField(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">            idField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Key key = <span class="keyword">new</span> Key(obj.getClass(), (<span class="keyword">int</span>) idField.get(obj));</span><br><span class="line">            <span class="keyword">if</span> (cache.remove(key) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ¸…é™¤ç¼“å­˜: &#123;&#125;&quot;</span>, key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException | NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œéœ€è¦åŠ è¯»é”ï¼›</span></span><br><span class="line">    <span class="comment">// æ²¡æœ‰åˆ™æŸ¥è¯¢redisæ·»åŠ åˆ°ç¼“å­˜ï¼Œéœ€è¦åŠ å†™é”</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">query</span><span class="params">(Class&lt;?&gt; clazz, Integer id)</span> </span>&#123;</span><br><span class="line">        Key key = <span class="keyword">new</span> Key(clazz, id);</span><br><span class="line">        Map&lt;String, String&gt; res = <span class="keyword">null</span>;</span><br><span class="line">        lock.readLock().lock();</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cache.containsKey(key)) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ç¼“å­˜æŸ¥è¯¢: &#123;&#125;&quot;</span>, res = cache.get(key));</span><br><span class="line">                <span class="keyword">return</span> res;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        lock.writeLock().lock();</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢æ•°æ®åº“ï¼Œæ·»åŠ åˆ°ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åŒé‡æ£€æŸ¥</span></span><br><span class="line">            <span class="keyword">if</span> (cache.containsKey(key)) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ç¼“å­˜æŸ¥è¯¢: &#123;&#125;&quot;</span>, res = cache.get(key));</span><br><span class="line">                <span class="keyword">return</span> res;</span><br><span class="line">            &#125;</span><br><span class="line">            cache.put(key, res = redis.query(clazz, id));</span><br><span class="line">            log.debug(<span class="string">&quot;æ·»åŠ ç¼“å­˜: &#123;&#125;&quot;</span>, key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-3-2-å†…éƒ¨ç±»Syncæ¦‚è¿°"><a href="#7-3-2-å†…éƒ¨ç±»Syncæ¦‚è¿°" class="headerlink" title="7.3.2 å†…éƒ¨ç±»Syncæ¦‚è¿°"></a>7.3.2 å†…éƒ¨ç±»Syncæ¦‚è¿°</h3><p>è¯»å†™é”çš„å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª<code>ReadLock</code>å’Œä¸€ä¸ª<code>WriteLock</code>ï¼Œå®ƒä»¬ä¾èµ–<code>Sync</code>å®ç°å…·ä½“åŠŸèƒ½ï¼Œ<code>Sync</code>ç»§æ‰¿è‡ªAQSï¼Œå¹¶ä¸”ä¹Ÿæä¾›äº†å…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°ã€‚</p>
<p>AQSä¸­åªç»´æŠ¤äº†ä¸€ä¸ª<code>state</code>çŠ¶æ€ï¼Œé‚£ä¹ˆå¦‚ä½•è¡¨ç¤ºè¯»å’Œå†™ä¸¤ç§çŠ¶æ€å‘¢ï¼Ÿ</p>
<p><code>Sync</code>å·§å¦™åœ°ä½¿ç”¨<code>state</code>çš„é«˜16ä½è¡¨ç¤ºè¯»è·å–åˆ°è¯»é”çš„æ¬¡æ•°ï¼Œä½16ä½è¡¨ç¤ºè·å–åˆ°å†™é”çš„çº¿ç¨‹çš„å¯é‡å…¥æ¬¡æ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHARED_SHIFT   = <span class="number">16</span>;</span><br><span class="line"><span class="comment">// å…±äº«é”ï¼ˆè¯»é”ï¼‰çŠ¶æ€å•ä½å€¼65536</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHARED_UNIT    = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT);</span><br><span class="line"><span class="comment">// å…±äº«é”çº¿ç¨‹æœ€å¤§ä¸ªæ•°65535</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_COUNT      = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line"><span class="comment">// æ’å®ƒé”ï¼ˆå†™é”ï¼‰æ©ç </span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXCLUSIVE_MASK = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** è¿”å›è¯»é”çº¿ç¨‹æ•°  */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sharedCount</span><span class="params">(<span class="keyword">int</span> c)</span>    </span>&#123; <span class="keyword">return</span> c &gt;&gt;&gt; SHARED_SHIFT; &#125;</span><br><span class="line"><span class="comment">/** è¿”å›å†™é”å¯é‡å…¥ä¸ªæ•° */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">exclusiveCount</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123; <span class="keyword">return</span> c &amp; EXCLUSIVE_MASK; &#125;</span><br></pre></td></tr></table></figure>

<p><code>Sync</code>çš„æˆå‘˜ï¼š</p>
<ul>
<li><code>firstReader</code>ï¼šè®°å½•ç¬¬ä¸€ä¸ªè·å–åˆ°è¯»é”çš„çº¿ç¨‹</li>
<li><code>firstReaderHoldCount</code>ï¼šè®°å½•ç¬¬ä¸€ä¸ªè·å–åˆ°è¯»é”çš„çº¿ç¨‹è·å–è¯»é”çš„å¯é‡å…¥æ¬¡æ•°</li>
<li><code>cacheHoldCounter</code>ï¼šè®°å½•æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹è·å–è¯»é”çš„å¯é‡å…¥æ¬¡æ•°</li>
<li><code>readHolds</code>ï¼šå­˜æ”¾é™¤å»ç¬¬ä¸€ä¸ªè·å–é”çº¿ç¨‹å¤–çš„å…¶ä»–çº¿ç¨‹è·å–è¯»é”çš„å¯é‡å…¥æ¬¡æ•°</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HoldCounter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> tid = getThreadId(Thread.currentThread());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalHoldCounter</span> <span class="keyword">extends</span> <span class="title">ThreadLocal</span>&lt;<span class="title">HoldCounter</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> HoldCounter <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HoldCounter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-3-3-å†™é”çš„è·å–ä¸é‡Šæ”¾"><a href="#7-3-3-å†™é”çš„è·å–ä¸é‡Šæ”¾" class="headerlink" title="7.3.3 å†™é”çš„è·å–ä¸é‡Šæ”¾"></a>7.3.3 å†™é”çš„è·å–ä¸é‡Šæ”¾</h3><p>åœ¨<code>ReentrantReadWriteLock</code>ä¸­å†™é”ä½¿ç”¨<code>WriteLock</code>å®ç°ã€‚</p>
<p><strong>è·å–</strong></p>
<p>å†™é”æ˜¯ä¸ªç‹¬å é”ï¼ŒæŸæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–è¯¥é”ã€‚</p>
<p>å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹è·å–åˆ°è¯»é”å’Œå†™é”ï¼Œåˆ™å½“å‰çº¿ç¨‹å¯ä»¥è·å–åˆ°å†™é”ç„¶åè¿”å›ã€‚</p>
<p>å¦‚æœå½“å‰å·²ç»æœ‰çº¿ç¨‹è·å–åˆ°è¯»é”å’Œå†™é”ï¼Œåˆ™å½“å‰è¯·æ±‚å†™é”çš„çº¿ç¨‹ä¼šè¢«é˜»å¡æŒ‚èµ·ã€‚</p>
<p>å¦å¤–ï¼Œå†™é”æ˜¯å¯é‡å…¥é”ï¼Œå†æ¬¡è·å–åªæ˜¯ç®€å•åœ°æŠŠå¯é‡å…¥æ¬¡æ•°åŠ 1åç›´æ¥è¿”å›ã€‚</p>
<p>ï¼ˆ1ï¼‰<code>WriteLock</code>çš„<code>lock</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.acquire(<span class="number">1</span>);  <span class="comment">// ç»§æ‰¿è‡ªAQS</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰<code>AbstractQueuedSynchronizer</code>çš„<code>acquire</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; <span class="comment">// Syncé‡å†™</span></span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰<code>Sync</code>é‡å†™çš„<code>tryAcquire</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="keyword">int</span> w = exclusiveCount(c);</span><br><span class="line">    <span class="comment">// (1) c != 0è¯´æ˜è¯»é”æˆ–è€…å†™é”å·²ç»è¢«æŸçº¿ç¨‹è·å–</span></span><br><span class="line">    <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// (2) w = 0è¯´æ˜å·²ç»æœ‰çº¿ç¨‹è·å–äº†è¯»é”ï¼Œw != 0å¹¶ä¸”å½“å‰çº¿ç¨‹ä¸æ˜¯å†™é”æ‹¥æœ‰è€…ï¼Œåˆ™è¿”å›false</span></span><br><span class="line">        <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// (3) è¯´æ˜å½“å‰çº¿ç¨‹è·å–äº†å†™é”ï¼Œåˆ¤æ–­å¯é‡å…¥æ¬¡æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// ï¼ˆ4ï¼‰è®¾ç½®å¯é‡å…¥æ¬¡æ•°(+1)</span></span><br><span class="line">        setState(c + acquires);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// (5) c == 0è¯´æ˜ç¬¬ä¸€ä¸ªå†™çº¿ç¨‹è·å–å†™é”</span></span><br><span class="line">    <span class="keyword">if</span> (writerShouldBlock() ||</span><br><span class="line">        !compareAndSetState(c, c + acquires))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    setExclusiveOwnerThread(current);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ4ï¼‰<code>writerShouldBlock</code>æ–¹æ³•ï¼š</p>
<ul>
<li>å…¬å¹³é”<code>NonfairSync</code>å®ç°ï¼š<code>return false</code>ï¼Œå³æŠ¢å å¼æ‰§è¡ŒCASå°è¯•è·å–å†™é”ï¼Œè·å–æˆåŠŸåˆ™è®¾ç½®å½“å‰é”çš„æŒæœ‰è€…ä¸ºå½“å‰çº¿ç¨‹å¹¶è¿”å›trueã€‚</li>
<li>éå…¬å¹³é”<code>FairSync</code>çš„å®ç°ï¼š<code>return hashQueuedPredecessors()</code>ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹èŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±ç»“ç‚¹ï¼Œæœ‰åˆ™æ”¾å¼ƒè·å–å†™é”çš„æƒé™ï¼Œç›´æ¥è¿”å›falseã€‚</li>
</ul>
<p><strong>é‡Šæ”¾</strong></p>
<p>å¦‚æœå½“å‰çº¿ç¨‹æŒæœ‰è¯¥æ‰€ï¼Œ<code>unlock</code>ä¼šè®©è¯¥çº¿ç¨‹å¯¹è¯¥çº¿ç¨‹æŒæœ‰çš„AQSçŠ¶æ€å€¼å‡1ï¼Œå¦‚æœå‡1åå½“å‰çŠ¶æ€å€¼ä¸º0åˆ™å½“å‰çº¿ç¨‹ä¼šé‡Šæ”¾è¯¥é”ï¼Œå¦åˆ™ä»…ä»…å‡1è€Œå·²ã€‚</p>
<p>å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰æŒæœ‰è¯¥é”è€Œè°ƒç”¨<code>unlock</code>æŠ›å‡º<code>IllegalMonitorStateException</code>å¼‚å¸¸ã€‚</p>
<p>ï¼ˆ1ï¼‰<code>WriteLock</code>çš„<code>unlock</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.release(<span class="number">1</span>);  <span class="comment">// ç»§æ‰¿è‡ªAQS</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰<code>AbstractQueuedSynchronizer</code>çš„<code>release</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123; <span class="comment">// Syncé‡å†™</span></span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="comment">// æ¿€æ´»é˜»å¡é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰<code>Sync</code>é‡å†™çš„<code>tryRelease</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (1) æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºé”æ‹¥æœ‰è€…</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="comment">// (2) è·å–å¯é‡å…¥å€¼ï¼Œè¿™é‡Œæ²¡æœ‰è€ƒè™‘é«˜16ä½ï¼Œå› ä¸ºè·å–å†™é”æ—¶è¯»é”çŠ¶æ€å€¼è‚¯å®šä¸º0</span></span><br><span class="line">    <span class="keyword">int</span> nextc = getState() - releases;</span><br><span class="line">    <span class="keyword">boolean</span> free = exclusiveCount(nextc) == <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// (3) å¦‚æœå†™é”å¯é‡å…¥å€¼ä¸º0åˆ™é‡Šæ”¾é”ï¼Œå¦åˆ™åªæ˜¯ç®€å•æ›´æ–°çŠ¶æ€å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (free)</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    setState(nextc);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="7-3-4-è¯»é”çš„è·å–ä¸é‡Šæ”¾"><a href="#7-3-4-è¯»é”çš„è·å–ä¸é‡Šæ”¾" class="headerlink" title="7.3.4 è¯»é”çš„è·å–ä¸é‡Šæ”¾"></a>7.3.4 è¯»é”çš„è·å–ä¸é‡Šæ”¾</h3><p>åœ¨<code>ReentrantReadWriteLock</code>ä¸­è¯»é”ä½¿ç”¨<code>ReadLock</code>å®ç°ã€‚</p>
<p><strong>è·å–</strong></p>
<p>å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œåˆ™å½“å‰çº¿ç¨‹å¯ä»¥è·å–é”ï¼ŒAQSçš„çŠ¶æ€å€¼<code>state</code>çš„é«˜16ä½çš„å€¼ä¼šåŠ 1ï¼Œç„¶åæ–¹æ³•è¿”å›ã€‚</p>
<p>å¦‚æœå…¶ä»–ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šé˜»å¡ã€‚</p>
<p>ï¼ˆ1ï¼‰<code>Read</code>çš„<code>lock</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.acquireShared(<span class="number">1</span>); <span class="comment">// ç»§æ‰¿è‡ªAQS</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰<code>AbstractQueuedSynchronizer</code>çš„<code>acquireShared</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>) <span class="comment">// Syncé‡å†™</span></span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰<code>Sync</code>é‡å†™çš„<code>tryAcquireShared</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// (1) è·å–å½“å‰çº¿ç¨‹</span></span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">// (2) è·å–å½“å‰çŠ¶æ€å€¼</span></span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// (3) åˆ¤æ–­å½“å‰å†™é”æ˜¯å¦è¢«å ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp; getExclusiveOwnerThread() != current)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// (4) è·å–è¯»é”è®¡æ•°</span></span><br><span class="line">    <span class="keyword">int</span> r = sharedCount(c);</span><br><span class="line">    <span class="comment">// (5) å°è¯•è·å–é”ï¼Œå¤šä¸ªåº¦çº¿ç¨‹åªæœ‰ä¸€ä¸ªä¼šæˆåŠŸï¼Œå¤±è´¥çš„è¿›å…¥fullTryAcquireSharedè¿›è¡Œé‡è¯•</span></span><br><span class="line">    <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp;</span><br><span class="line">        r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">        compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">        <span class="comment">// (6) å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–é”çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">            firstReader = current;</span><br><span class="line">            firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// (7) å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">            firstReaderHoldCount++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// (8) è®°å½•æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹æˆ–è€…è®°å½•å…¶ä»–çº¿ç¨‹è¯»é”çš„å¯é‡å…¥ä¸ªæ•°</span></span><br><span class="line">            HoldCounter rh = cachedHoldCounter;</span><br><span class="line">            <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                readHolds.set(rh);</span><br><span class="line">            rh.count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// (9) è‡ªæ—‹è·å–</span></span><br><span class="line">    <span class="keyword">return</span> fullTryAcquireShared(current);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ4ï¼‰<code>readerShouldBlock</code>æ–¹æ³•ï¼š</p>
<ul>
<li><p>å…¬å¹³é”<code>NonfairStnc</code>å®ç°ï¼š<code>return apparentlyFirstQueuedIsExclusive()</code>ï¼Œå®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">apparentlyFirstQueuedIsExclusive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node h, s;</span><br><span class="line">    <span class="keyword">return</span> (h = head) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        (s = h.next)  != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        !s.isShared()         &amp;&amp;</span><br><span class="line">        s.thread != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£ç çš„ä½œç”¨æ˜¯ï¼Œå¦‚æœé˜Ÿåˆ—é‡Œé¢å­˜åœ¨ä¸€ä¸ªå…ƒç´ ï¼Œå’‹åˆ¤æ–­ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸æ˜¯æ­£åœ¨å°è¯•è·å–å†™é”ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å½“å‰çº¿ç¨‹åˆ¤æ–­å½“å‰è·å–è¯»é”çš„çº¿ç¨‹æ˜¯å¦åˆ°è¾¾äº†æœ€å¤§å€¼ï¼Œæœ€åæ‰§è¡ŒCASæ“ä½œå°†AQSçŠ¶æ€å€¼çš„é«˜16ä½å€¼åŠ 1ã€‚</p>
</li>
<li><p>éå…¬å¹³é”<code>FairSync</code>çš„å®ç°ï¼š<code>return hashQueuedPredecessors()</code>ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹èŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±ç»“ç‚¹ï¼Œæœ‰åˆ™æ”¾å¼ƒè·å–è¯»é”çš„æƒé™ã€‚</p>
</li>
</ul>
<p>ï¼ˆ5ï¼‰<code>Sync</code>çš„<code>fullTryAcquireShared</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullTryAcquireShared</span><span class="params">(Thread current)</span> </span>&#123;</span><br><span class="line">    HoldCounter rh = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (getExclusiveOwnerThread() != current)</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            <span class="comment">// else we hold the exclusive lock; blocking here</span></span><br><span class="line">            <span class="comment">// would cause deadlock.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readerShouldBlock()) &#123;</span><br><span class="line">            <span class="comment">// Make sure we&#x27;re not acquiring read lock reentrantly</span></span><br><span class="line">            <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                <span class="comment">// assert firstReaderHoldCount &gt; 0;</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    rh = cachedHoldCounter;</span><br><span class="line">                    <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current)) &#123;</span><br><span class="line">                        rh = readHolds.get();</span><br><span class="line">                        <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                            readHolds.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sharedCount(c) == MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sharedCount(c) == <span class="number">0</span>) &#123;</span><br><span class="line">                firstReader = current;</span><br><span class="line">                firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                firstReaderHoldCount++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="keyword">null</span>)</span><br><span class="line">                    rh = cachedHoldCounter;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                    rh = readHolds.get();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                    readHolds.set(rh);</span><br><span class="line">                rh.count++;</span><br><span class="line">                cachedHoldCounter = rh; <span class="comment">// cache for release</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>é‡Šæ”¾</strong></p>
<p>ï¼ˆ1ï¼‰<code>ReadLock</code>çš„<code>unlock</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>); <span class="comment">// ç»§æ‰¿è‡ªAQS</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰<code>AbstractQueuedSynchronizer</code>çš„<code>releaseShared</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰<code>Sync</code>çš„<code>tryReleaseShared</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">// (1) åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">        <span class="comment">// å¯ä¿è¯firstReaderHoldCount &gt; 0</span></span><br><span class="line">        <span class="comment">// å¯é‡å…¥æ¬¡æ•°ä¸º1ï¼Œæ¸…ç©ºè¯»é”ç¬¬ä¸€çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (firstReaderHoldCount == <span class="number">1</span>) </span><br><span class="line">            firstReader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// å¦åˆ™ï¼Œå¯é‡å…¥æ¬¡æ•°å‡ä¸€</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            firstReaderHoldCount--;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// (2) é‚£ä¹ˆç»´æŠ¤æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹çš„å¯é‡å…¥æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹çš„å¯é‡å…¥æ¬¡æ•°</span></span><br><span class="line">        HoldCounter rh = cachedHoldCounter;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ch</span></span><br><span class="line">        <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">            rh = readHolds.get();</span><br><span class="line">        <span class="keyword">int</span> count = rh.count;</span><br><span class="line">        <span class="comment">// å¦‚æœå¯é‡å…¥æ¬¡æ•°å°äºç­‰äº1ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ²¡æœ‰æŒæœ‰è¯»é”ï¼Œchæ˜¯get()æˆçš„</span></span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            readHolds.remove();</span><br><span class="line">            <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> unmatchedUnlockException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æŒæœ‰è¯»é”ä¸­ï¼Œå¯é‡å…¥æ¬¡æ•°å‡ä¸€</span></span><br><span class="line">        --rh.count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// (3) ä¿®æ”¹åŒæ­¥çŠ¶æ€ï¼Œå¾ªç¯ç›´åˆ°è‡ªå·±çš„è¯»è®¡æ•°-1ï¼ŒCASæ›´æ–°æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">int</span> nextc = c - SHARED_UNIT;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="comment">// çŠ¶æ€å€¼=0é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-4-StampedLock"><a href="#7-4-StampedLock" class="headerlink" title="7.4 StampedLock"></a>7.4 StampedLock</h2><p><code>StampedLock</code>æ˜¯JDK1.8æ–°å¢çš„ä¸€ä¸ªé”ï¼Œè¯¥é”æä¾›äº†ä¸‰ç§æ¨¡å¼çš„è¯»å†™æ§åˆ¶ï¼Œä½†æ˜¯ä¸æ”¯æŒæ¡ä»¶å˜é‡å’Œé”é‡å…¥ã€‚</p>
<p>å½“è°ƒç”¨è·å–é”çš„ç³»åˆ—å‡½æ•°æ—¶ï¼Œä¼šè¿”å›ä¸€ä¸ª<code>long</code>å‹çš„å˜é‡ï¼Œç§°ä¸ºæˆ³è®°(stamp)ï¼Œä»£è¡¨äº†é”çš„çŠ¶æ€ã€‚å…¶ä¸­tryç³»åˆ—è·å–é”çš„å‡½æ•°ï¼Œå½“è·å–å¤±è´¥åä¼šè¿”å›ä¸º0çš„stampå€¼ã€‚å½“è°ƒç”¨é‡Šæ”¾é”å’Œè½¬æ¢é”çš„æ–¹æ³•æ—¶éœ€è¦ä¼ å…¥è·å–é”æ—¶è¿”å›çš„stampå€¼ã€‚</p>
<p><code>StampedLock</code>æä¾›äº†ä¸‰ç§è¯»å†™æ¨¡å¼çš„é”ï¼š</p>
<ol>
<li><p>å†™é”<code>writeLock</code>ï¼šæ˜¯ä¸€ä¸ªç‹¬å é”ï¼Œä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–åˆ°è¯¥é”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–è¯¥é”åï¼Œå…¶ä»–è¯·æ±‚è¯»é”å’Œå†™é”çš„çº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œè¿™ç±»ä¼¼äº<code>ReentrantReadWriteLock</code>çš„å†™é”ï¼ˆä¸åŒçš„æ˜¯è¿™é‡Œçš„å†™é”æ˜¯ä¸å¯é‡å…¥é”ï¼‰ï¼›å½“ç›®å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰è¯»é”æˆ–è€…å†™é”æ—¶æ‰å¯ä»¥è·å–åˆ°è¯¥é”ã€‚è¯·æ±‚è¯¥é”æˆåŠŸåä¼šè¿”å›ä¸€ä¸ª<code>stamp</code>å˜é‡ç”¨æ¥è¡¨ç¤ºè¯¥é”çš„ç‰ˆæœ¬ï¼Œå½“è§£é‡Šè¯¥é”æ—¶éœ€è¦è°ƒç”¨<code>unlockWrite</code>æ–¹æ³•å¹¶ä¼ é€’è·å–é”æ—¶çš„<code>stamp</code>å‚æ•°ã€‚å¹¶ä¸”å®ƒæä¾›äº†éé˜»å¡çš„<code>tryWriteLock</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">long</span> stamp = lock.writeLock();</span><br><span class="line">lock.unlockWrite(stamp);</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ‚²è§‚è¯»é”<code>readLock</code>ï¼šæ˜¯ä¸€ä¸ªå…±äº«é”ï¼Œåœ¨æ²¡æœ‰çº¿ç¨‹è·å–ç‹¬å å†™é”çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è·å–è¯¥é”ã€‚å¦‚æœå·²ç»æœ‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œåˆ™å…¶ä»–çº¿ç¨‹è¯·æ±‚è·å–è¯¥é”ä¼šè¢«é˜»å¡ï¼Œè¿™ç±»ä¼¼äº<code>ReentrantReadWriteLock</code>çš„è¯»é”ï¼ˆä¸åŒçš„æ˜¯è¿™é‡Œçš„è¯»é”æ˜¯ä¸å¯é‡å…¥é”ï¼‰ã€‚è¿™é‡Œè¯´çš„æ‚²è§‚æ˜¯æŒ‡å…·ä½“æ“ä½œæ•°æ®å‰ä¼šæ‚²è§‚åœ°è®¤ä¸ºå…¶ä»–çº¿ç¨‹å¯ä»¥è¦å¯¹è‡ªå·±æ“ä½œçš„æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥éœ€è¦å…ˆå¯¹æ•°æ®åŠ é”ï¼Œè¿™æ˜¯åœ¨è¯»å°‘å†™å¤šçš„æƒ…å†µä¸‹çš„ä¸€ç§è€ƒè™‘ã€‚è¯·æ±‚è¯¥æ‰€æˆåŠŸåä¼šè¿”å›ä¸€ä¸ª<code>stamp</code>å˜é‡ç”¨æ¥è¡¨ç¤ºè¯¥é”çš„ç‰ˆæœ¬ï¼Œå½“é‡Šæ”¾è¯¥é”æ—¶éœ€è¦è°ƒç”¨<code>unlockRead</code>æ–¹æ³•å¹¶ä¼ é€’<code>stamp</code>å‚æ•°ã€‚å¹¶ä¸”å®ƒæä¾›äº†éé˜»å¡çš„<code>tryReadLock</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">long</span> stamp = lock.readLock();</span><br><span class="line">lock.unlockRead(stamp);</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¹è§‚è¯»é”<code>tryOptimisticRead</code>ï¼šå®ƒæ˜¯ç›¸å¯¹äºæ‚²è§‚é”æ¥è¯´çš„ï¼Œåœ¨æ“ä½œæ•°æ®å‰å¹¶æ²¡æœ‰é€šè¿‡CASè®¾ç½®é”çš„çŠ¶æ€ï¼Œä»…ä»…é€šè¿‡ä½è¿ç®—æµ‹è¯•ã€‚å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œåˆ™ç®€å•åœ°è¿”å›ä¸€ä¸ªé0çš„<code>stamp</code>å€¼ã€‚è·å–è¯¥<code>stamp</code>ååœ¨å…·ä½“æ“ä½œæ•°æ®å‰è¿˜éœ€è¦è°ƒç”¨<code>validate</code>æ–¹æ³•éªŒè¯è¯¥<code>stamp</code>æ˜¯å¦å·²ç»ä¸å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯çœ‹å½“è°ƒç”¨<code>tryOptimisticRead</code>è¿”å›<code>stamp</code>ååˆ°å½“å‰æ—¶é—´æœŸé—´æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰äº†å†™é”ï¼Œå¦‚æœæ˜¯åˆ™<code>validate</code>ä¼šè¿”å›0ï¼Œå¦åˆ™å°±å¯ä»¥ä½¿ç”¨è¯¥<code>stamp</code>ç‰ˆæœ¬çš„é”å¯¹æ•°æ®è¿›è¡Œæ“ä½œã€‚ç”±äº<code>tryOptimisticRead</code>å¹¶æ²¡æœ‰ä½¿ç”¨CASè®¾ç½®é”çŠ¶æ€ï¼Œæ‰€ä»¥ä¸éœ€è¦æ˜¾å¼åœ°é‡Šæ”¾è¯¥é”ã€‚è¯¥é”çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå› ä¸ºè·å–è¯»é”åªæ˜¯ä½¿ç”¨ä½æ“ä½œè¿›è¡Œæ£€éªŒï¼Œä¸æ¶‰åŠCASæ“ä½œï¼Œæ‰€ä»¥æ•ˆç‡ä¸Šä¼šé«˜å¾ˆå¤šï¼Œä½†æ˜¯åŒæ—¶ç”±äºæ²¡æœ‰ä½¿ç”¨çœŸæ­£çš„é”ï¼Œåœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§ä¸Šéœ€è¦å¤åˆ¶ä¸€ä»½è¦æ“ä½œçš„å˜é‡åˆ°æ–¹æ³•æ ˆï¼Œå¹¶ä¸”åœ¨æ“ä½œæ•°æ®æ—¶å¯èƒ½å…¶ä»–å†™çº¿ç¨‹å·²ç»ä¿®æ”¹äº†æ•°æ®ï¼Œè€Œæˆ‘ä»¬æ“ä½œçš„æ˜¯æ–¹æ³•æ ˆé‡Œé¢çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå¿«ç…§ï¼Œæ‰€ä»¥æœ€å¤šè¿”å›çš„ä¸æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œä½†æ˜¯ä¸€è‡´æ€§è¿˜æ˜¯å¾—åˆ°ä¿éšœçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">long</span> stamp = lock.tryOptimisticRead();</span><br><span class="line"><span class="keyword">if</span> (!lock.validate(stamp)) &#123;</span><br><span class="line">    <span class="comment">// é”å‡çº§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>ç¤ºä¾‹ï¼šç¬›å¡å°”äºŒç»´ç‚¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.StampedLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¨ªåæ ‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> x;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * çºµåæ ‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> y;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”å®ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StampedLock lock = <span class="keyword">new</span> StampedLock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§»åŠ¨ç‚¹åˆ°æ–°ä½ç½®</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ä½¿ç”¨æ’å®ƒé”-å†™é”&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> deltaX æ¨ªåæ ‡å˜åŒ–å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> deltaY çºµåæ ‡å˜åŒ–å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">move</span><span class="params">(<span class="keyword">double</span> deltaX, <span class="keyword">int</span> deltaY)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamp = lock.writeLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            x += deltaX;</span><br><span class="line">            y += deltaY;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¡ç®—å½“å‰ä½ç½®åˆ°åŸç‚¹çš„è·ç¦»</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ä½¿ç”¨ä¹è§‚é”è¯»&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è·ç¦»åŸç‚¹çš„è·ç¦»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">distanceFromOrigin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamp = lock.tryOptimisticRead();</span><br><span class="line">        <span class="keyword">double</span> currentX = x, currentY = y;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥è·å–stampåï¼Œé”æ˜¯å¦è¢«å…¶ä»–å†™çº¿ç¨‹æ’ä»–æ€§æŠ¢å </span></span><br><span class="line">        <span class="keyword">if</span> (!lock.validate(stamp)) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æŠ¢å åˆ™è¿›è¡Œé”å‡çº§ï¼Œè·å–æ‚²è§‚è¯»é”</span></span><br><span class="line">            stamp = lock.readLock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                currentX = x;</span><br><span class="line">                currentY = y;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlockRead(stamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Math.sqrt(currentX * currentX + currentY * currentY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¦‚æœå½“å‰ä½ç½®åœ¨åŸç‚¹åˆ™ç§»åŠ¨è‡³æ–°ä½ç½®</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ä½¿ç”¨æ‚²è§‚é”è·å–è¯»é”ï¼Œå¹¶å°è¯•è½¬æ¢ä¸ºå†™é”&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newX æ–°ä½ç½®çš„æ¨ªåæ ‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newY æ–°ä½ç½®çš„çºµåæ ‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">moveIfAtOrigin</span><span class="params">(<span class="keyword">double</span> newX, <span class="keyword">double</span> newY)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œå¯ä»¥ç”¨ä¹è§‚é”è¯»æ›¿æ¢</span></span><br><span class="line">        <span class="keyword">long</span> stamp = lock.readLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (x == <span class="number">0.0</span> &amp;&amp; y == <span class="number">0.0</span>) &#123;</span><br><span class="line">                <span class="comment">// å°è¯•å°†è¯»é”å‡çº§ä¸ºå†™é”</span></span><br><span class="line">                <span class="keyword">long</span> ws = lock.tryConvertToWriteLock(stamp);</span><br><span class="line">                <span class="comment">// å‡çº§æˆåŠŸï¼Œåˆ™æ›´æ¢æˆ³è®°ï¼Œæ›´æ–°åæ ‡ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (ws != <span class="number">0L</span>) &#123;</span><br><span class="line">                    stamp = ws;</span><br><span class="line">                    x = newX;</span><br><span class="line">                    y = newY;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; </span><br><span class="line">                <span class="comment">// å‡çº§å¤±è´¥ï¼Œåˆ™é‡Šæ”¾è¯»é”ï¼Œæ˜¾å¼è·å–å†™é”ï¼Œå¾ªç¯é‡è¯•</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    lock.unlockRead(stamp);</span><br><span class="line">                    stamp = lock.writeLock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>RAFT-NOTE</title>
    <url>/posts/13171/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="RAFTæ¦‚è¿°"><a href="#RAFTæ¦‚è¿°" class="headerlink" title="RAFTæ¦‚è¿°"></a>RAFTæ¦‚è¿°</h2><p>ç›¸æ¯”äºPaxosï¼ŒRaftä¸»è¦ä½¿ç”¨ä¸¤ç§æ–¹æ³•æ¥æé«˜å¯ç†è§£æ€§ã€‚</p>
<h3 id="é—®é¢˜åˆ†è§£"><a href="#é—®é¢˜åˆ†è§£" class="headerlink" title="é—®é¢˜åˆ†è§£"></a>é—®é¢˜åˆ†è§£</h3><p>å°½å¯èƒ½å°†é—®é¢˜åˆ†è§£ä¸ºè‹¥å¹²ä¸ªå¯è§£å†³çš„ã€æ›´å®¹æ˜“ç†è§£çš„å°é—®é¢˜â€”â€”è¿™æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ç®€åŒ–é—®é¢˜çš„æ–¹æ³•è®ºã€‚</p>
<p>Raftç®—æ³•æŠŠé—®é¢˜åˆ†è§£æˆäº†é¢†å¯¼äººé€‰ä¸¾ï¼ˆleader electionï¼‰ã€æ—¥å¿—å¤åˆ¶ï¼ˆlog replicationï¼‰ã€å®‰å…¨æ€§ï¼ˆsafetyï¼‰å’Œæˆå‘˜å…³ç³»å˜åŒ–ï¼ˆmembership changesï¼‰è¿™å‡ ä¸ªå­é—®é¢˜ã€‚</p>
<ul>
<li><strong>é¢†å¯¼äººé€‰ä¸¾</strong>ï¼šåœ¨ä¸€ä¸ªé¢†å¯¼äººç»“ç‚¹å‘ç”Ÿæ•…éšœä¹‹åå¿…é¡»é‡æ–°ç»™å‡ºä¸€ä¸ªæ–°çš„é¢†å¯¼äººèŠ‚ç‚¹ã€‚</li>
<li><strong>æ—¥å¿—å¤åˆ¶</strong>ï¼šé¢†å¯¼äººç»“ç‚¹ä»å®¢æˆ·ç«¯æ¥æ”¶æ“ä½œè¯·æ±‚ï¼Œç„¶åå°†æ“ä½œæ—¥å¿—å¤åˆ¶åˆ°é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œå¹¶ä¸”å¼ºåˆ¶è¦æ±‚å…¶ä»–æœåŠ¡å™¨çš„æ—¥å¿—å¿…é¡»å’Œè‡ªå·±çš„ä¿æŒä¸€è‡´ã€‚</li>
<li><strong>å®‰å…¨æ€§</strong>ï¼šRaftå…³é”®çš„å®‰å…¨ç‰¹æ€§æ˜¯çŠ¶æ€æœºå®‰å…¨åŸåˆ™ï¼ˆSafety Machine Safetyï¼‰â€”â€”å¦‚æœä¸€ä¸ªæœåŠ¡å™¨å·²ç»å°†ç»™å®šç´¢å¼•ä½ç½®çš„æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°çŠ¶æ€æœºä¸Šï¼Œåˆ™æ‰€æœ‰å…¶ä»–æœåŠ¡å™¨ä¸ä¼šå†è¯¥ç´¢å¼•ä½ç½®åº”ç”¨ä¸åŒçš„æ¡ç›®ã€‚</li>
<li><strong>æˆå‘˜å…³ç³»å˜åŒ–</strong>ï¼šé…ç½®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œé›†ç¾¤èƒ½å¤Ÿç»§ç»­å·¥ä½œã€‚</li>
</ul>
<h3 id="çŠ¶æ€ç®€åŒ–"><a href="#çŠ¶æ€ç®€åŒ–" class="headerlink" title="çŠ¶æ€ç®€åŒ–"></a>çŠ¶æ€ç®€åŒ–</h3><p>Raftç®—æ³•é€šè¿‡å‡å°‘éœ€è¦è€ƒè™‘çš„çŠ¶æ€æ•°é‡æ¥ç®€åŒ–çŠ¶æ€ç©ºé—´ã€‚è¿™å°†ä½¿å¾—æ•´ä¸ªç³»ç»Ÿæ›´åŠ ä¸€è‡´å¹¶ä¸”èƒ½å¤Ÿå°½å¯èƒ½åœ°æ¶ˆé™¤ä¸ç¡®å®šæ€§ã€‚éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œæ—¥å¿—æ¡ç›®ä¹‹é—´ä¸å…è®¸å‡ºç°ç©ºæ´ï¼Œå¹¶ä¸”è¿˜è¦é™åˆ¶æ—¥å¿—å‡ºç°ä¸ä¸€è‡´çš„å¯èƒ½æ€§ã€‚å°½ç®¡åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒRaftéƒ½åœ¨è¯•å›¾æ¶ˆé™¤ä¸ç¡®å®šæ€§ä»¥å‡å°‘çŠ¶æ€ç©ºé—´ã€‚ä½†åœ¨ä¸€ç§åœºæ™¯ä¸‹ï¼ˆé€‰ä¸¾ï¼‰ï¼ŒRaftä¼šç”¨éšæœºæ–¹æ³•æ¥ç®€åŒ–é€‰ä¸¾è¿‡ç¨‹ä¸­çš„çŠ¶æ€ç©ºé—´ã€‚</p>
<p>Raftç®—æ³•ä¸ç°æœ‰çš„ä¸€äº›Paxoså˜ç§ï¼ˆä¸»è¦æ˜¯Okiå’ŒLiskovçš„Viewstamped Replicationï¼‰å­˜åœ¨ä¸€äº›ç›¸ä¼¼çš„åœ°æ–¹ï¼Œä½†æ˜¯Raftè¿˜æœ‰å‡ ç‚¹é‡è¦çš„åˆ›æ–°ï¼š</p>
<ul>
<li><strong>å¼ºé¢†å¯¼äºº</strong>ï¼šRaftä½¿ç”¨ä¸€ç§æ¯”å…¶ä»–ç®—æ³•æ›´å¼ºçš„é¢†å¯¼å½¢å¼ã€‚ä¾‹å¦‚ï¼Œæ—¥å¿—æ¡ç›®åªä»é¢†å¯¼äººå‘å‘å…¶ä»–æœåŠ¡å™¨ã€‚è¿™æ ·å°±ç®€åŒ–äº†å¯¹æ—¥å¿—å¤åˆ¶çš„ç®¡ç†ï¼Œæé«˜äº†Raftçš„å¯ç†è§£æ€§ã€‚</li>
<li><strong>é¢†å¯¼äººé€‰ä¸¾</strong>ï¼šRaftä½¿ç”¨éšæœºå®šæ—¶å™¨æ¥é€‰ä¸¾é¢†å¯¼äººã€‚è¿™ç§æ–¹å¼ä»…ä»…æ˜¯åœ¨æ‰€æœ‰ç®—æ³•éƒ½éœ€è¦å®ç°çš„å¿ƒè·³æœºåˆ¶ä¸Šå¢åŠ äº†ä¸€ç‚¹å˜åŒ–ï¼Œå°±ä½¿å¾—å†²çªè§£å†³æ›´åŠ ç®€å•å’Œå¿«é€Ÿã€‚</li>
<li><strong>æˆå‘˜å˜åŒ–</strong>ï¼šRaftåœ¨è°ƒæ•´é›†ç¾¤æˆå‘˜å…³ç³»æ—¶ä½¿ç”¨äº†ä¸€ç§æ–°çš„ä¸€è‡´æ€§ï¼ˆjoint consensusï¼Œè”åˆä¸€è‡´æ€§ï¼‰æ–¹æ³•ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œä½¿å¾—é›†ç¾¤é…ç½®åœ¨å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé›†ç¾¤ä¾æ—§èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚</li>
</ul>
<h2 id="ç®—æ³•å®ç°"><a href="#ç®—æ³•å®ç°" class="headerlink" title="ç®—æ³•å®ç°"></a>ç®—æ³•å®ç°</h2><h3 id="èŠ‚ç‚¹è§’è‰²"><a href="#èŠ‚ç‚¹è§’è‰²" class="headerlink" title="èŠ‚ç‚¹è§’è‰²"></a>èŠ‚ç‚¹è§’è‰²</h3><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜åœ¨å¦‚ä¸‹ä¸¤ç§èŠ‚ç‚¹å…³ç³»æ¨¡å‹ï¼š</p>
<ul>
<li>å¯¹ç§°ï¼šæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æ˜¯å¹³ç­‰çš„ï¼Œä¸å­˜åœ¨ä¸»èŠ‚ç‚¹ã€‚å®¢æˆ·ç«¯å¯ä»¥ä¸ä»»æ„èŠ‚ç‚¹è¿›è¡Œäº¤äº’ã€‚</li>
<li>éå¯¹ç§°ï¼šåŸºäºé€‰ä¸»æ¨¡å‹ï¼Œåªæœ‰ä¸»èŠ‚ç‚¹æ‹¥æœ‰å†³ç­–æƒã€‚ä»»æ„æ—¶åˆ»æœ‰ä¸”åªæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯åªä¸ä¸»èŠ‚ç‚¹è¿›è¡Œäº¤äº’ã€‚</li>
</ul>
<p>åŸºäºç®€åŒ–æ“ä½œå’Œæ•ˆç‡ç­‰å› ç´ è€ƒè™‘ï¼ŒRaftç®—æ³•é‡‡ç”¨çš„æ˜¯éå¯¹ç§°èŠ‚ç‚¹å…³ç³»æ¨¡å‹ã€‚</p>
<p>åœ¨ä¸€ä¸ªç”±Raftåè®®ç»„ç»‡çš„é›†ç¾¤ä¸­ï¼Œä¸€å…±åŒ…å«äº†å¦‚ä¸‹3ç±»è§’è‰²ï¼š</p>
<ul>
<li>Leaderï¼ˆé¢†å¯¼äººï¼‰</li>
<li>Candidateï¼ˆå€™é€‰äººï¼‰</li>
<li>Followerï¼ˆç¾¤ä¼—ï¼‰</li>
</ul>
<h3 id="æ—¶é—´åŒæ­¥"><a href="#æ—¶é—´åŒæ­¥" class="headerlink" title="æ—¶é—´åŒæ­¥"></a>æ—¶é—´åŒæ­¥</h3><p>Raftç®—æ³•å°†æ—¶é—´åˆ’åˆ†ä¸ºä»»æ„ä¸åŒé•¿åº¦çš„ä»»æœŸï¼ˆTermï¼‰ï¼Œä»»æœŸæ˜¯å•è°ƒé€’å¢çš„ï¼Œç”¨è¿ç»­çš„æ•°ç»„ï¼ˆ1ï¼Œ2ï¼Œ3Â·Â·Â·Â·Â·Â·ï¼‰è¡¨ç¤ºã€‚åœ¨Raftçš„ä¸–ç•Œé‡Œï¼Œæ¯ä¸€ä¸ªä»»æœŸçš„å¼€å§‹éƒ½æ˜¯ä¸€æ¬¡é¢†å¯¼äººçš„é€‰ä¸¾ã€‚</p>
<p>å¦‚æœä¸€ä¸ªé¢†å¯¼äººèµ¢å¾—äº†é€‰ä¸¾ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šåœ¨è¯¥ä»»æœŸçš„å‰©ä½™æ—¶é—´å†…æ‹…ä»»é¢†å¯¼äººã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œé€‰ç¥¨ä¼šè¢«ç“œåˆ†ï¼Œå¯¼è‡´æ²¡æœ‰å“ªä½å€™é€‰äººèƒ½å¤Ÿå¾—åˆ°è¶…è¿‡åŠæ•°çš„é€‰ç¥¨ï¼Œè¿™æ ·æœ¬æ¬¡ä»»æœŸå°†ä»¥æ²¡æœ‰é¢†å¯¼äººè€Œç»“æŸã€‚é‚£ä¹ˆå¿™ï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€ä¸ªä»»æœŸï¼Œå¼€å§‹ä¸€æ¬¡æ–°çš„é€‰ä¸¾ã€‚Raftç®—æ³•ä¿è¯åœ¨ç»™å®šçš„ä¸€ä¸ªä»»æœŸå†…æœ€å¤šåªæœ‰ä¸€ä¸ªé¢†å¯¼äººã€‚æŸäº›Termä¼šç”±äºé€‰ä¸¾å¤±è´¥ï¼Œå­˜åœ¨æ²¡æœ‰é¢†å¯¼äººçš„æƒ…å†µã€‚</p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾1. Raftç®—æ³•ä»»æœŸç¤ºæ„å›¾</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/time-synchronization.png" class="" title="time-synchronization">

<br />

<p>ä»»æœŸåœ¨Raftä¸­èµ·ç€é€»è¾‘æ—¶é’Ÿçš„ä½œç”¨ï¼ŒåŒæ—¶ä¹Ÿå¯ç”¨äºåœ¨RaftèŠ‚ç‚¹ä¸­æ£€æµ‹è¿‡æœŸä¿¡æ¯â€”â€”æ¯”å¦‚è¿‡æœŸçš„é¢†å¯¼äººã€‚</p>
<p>æ¯ä¸ªRaftèŠ‚ç‚¹éƒ½åœ¨æœ¬åœ°ç»´æŠ¤ä¸€ä¸ªå½“å‰ä»»æœŸå€¼ï¼Œè§¦å‘è¿™ä¸ªæ•°å­—å˜åŒ–ï¼ˆå¢åŠ ï¼‰ä¸»è¦æœ‰ä¸¤ä¸ªåœºæ™¯ï¼š</p>
<ul>
<li>å¼€å§‹é€‰ä¸¾</li>
<li>ä¸å…¶ä»–èŠ‚ç‚¹äº¤æ¢ä¿¡æ¯</li>
</ul>
<p>å½“èŠ‚ç‚¹ä¹‹é—´å¼€å§‹é€šä¿¡æ—¶ï¼Œä¼šäº’ç›¸äº¤æ¢å½“å‰çš„ä»»æœŸå·ï¼š</p>
<ul>
<li><p>å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ï¼ˆåŒ…æ‹¬é¢†å¯¼äººï¼‰çš„å½“å‰ä»»æœŸå·æ¯”å…¶ä»–èŠ‚ç‚¹çš„ä»»æœŸå·å°ï¼Œåˆ™å°†è‡ªå·±æœ¬åœ°çš„ä»»æœŸå·è‡ªè§‰åœ°æ›´æ–°ä¸ºè¾ƒå¤§çš„ä»»æœŸå·ã€‚</p>
</li>
<li><p>å¦‚æœä¸€ä¸ªå€™é€‰äººæˆ–è€…é¢†å¯¼äººæ„è¯†åˆ°å®ƒçš„ä»»æœŸå·è¿‡æ—¶äº†ï¼ˆæ¯”åˆ«äººçš„å°ï¼‰ï¼Œé‚£ä¹ˆå®ƒä¼šç«‹åˆ»åˆ‡æ¢å›ç¾¤ä¼—çŠ¶æ€ã€‚</p>
</li>
<li><p>å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°çš„è¯·æ±‚æ‰€æºå¸¦çš„ä»»æœŸå·æ˜¯è¿‡æ—¶çš„ï¼Œé‚£ä¹ˆè¯¥èŠ‚ç‚¹å°±ä¼šæ‹’ç»å“åº”æœ¬æ¬¡è¯·æ±‚ã€‚</p>
</li>
</ul>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºåˆ†å¸ƒå¼ç³»ç»ŸèŠ‚ç‚¹ä¹‹é—´æ— æ³•åšåˆ°åœ¨ä»»æ„æ—¶åˆ»å®Œå…¨åŒæ­¥ï¼Œå› æ­¤ä¸åŒçš„RaftèŠ‚ç‚¹å¯èƒ½ä¼šåœ¨ä¸åŒçš„æ—¶åˆ»æ„ŸçŸ¥åˆ°ä»»æœŸçš„åˆ‡æ¢ã€‚ç”šè‡³åœ¨å‡ºç°ç½‘ç»œåˆ†åŒºæˆ–èŠ‚ç‚¹å¼‚å¸¸çš„æƒ…å†µä¸‹ï¼ŒæŸä¸ªèŠ‚ç‚¹å¯èƒ½ä¼šæ„ŸçŸ¥ä¸åˆ°ä¸€æ¬¡é€‰ä¸¾æˆ–è€…ä¸€ä¸ªå®Œæ•´çš„ä»»æœŸã€‚</p>
<h3 id="é¢†å¯¼äººé€‰ä¸¾"><a href="#é¢†å¯¼äººé€‰ä¸¾" class="headerlink" title="é¢†å¯¼äººé€‰ä¸¾"></a>é¢†å¯¼äººé€‰ä¸¾</h3><p>Rafté€šè¿‡é€‰ä¸¾ä¸€ä¸ªæƒåˆ©è‡³é«˜æ— ä¸Šçš„é¢†å¯¼äººï¼Œå¹¶é‡‡å–èµ‹äºˆä»–ç®¡ç†å¤åˆ¶æ—¥å¿—é‡ä»»çš„æ–¹å¼æ¥ç»´æŠ¤èŠ‚ç‚¹é—´å¤åˆ¶æ—¥å¿—çš„ä¸€è‡´æ€§ã€‚é¢†å¯¼äººä»å®¢æˆ·ç«¯æ¥æ”¶æ—¥å¿—æ¡ç›®ï¼Œå†æŠŠæ—¥å¿—æ¡ç›®å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œå¹¶ä¸”åœ¨ä¿è¯å®‰å…¨æ€§çš„å‰æä¸‹ï¼Œå‘Šè¯‰å…¶ä»–æœåŠ¡å™¨å°†æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°å®ƒä»¬çš„çŠ¶æ€æœºä¸­ã€‚å¼ºé¢†å¯¼äººçš„å­˜åœ¨å¤§å¤§ç®€åŒ–äº†å¤åˆ¶æ—¥å¿—çš„ç®¡ç†ã€‚</p>
<p>ä¾‹å¦‚ï¼Œé¢†å¯¼äººå¯ä»¥å†³å®šæ–°çš„æ—¥å¿—æ¡ç›®éœ€è¦æ”¾åœ¨æ—¥å¿—æ–‡ä»¶çš„ä»€ä¹ˆä½ç½®ï¼Œè€Œä¸éœ€è¦å’Œå…¶ä»–æœåŠ¡å™¨å•†è®®ï¼Œå¹¶ä¸”æ•°æ®éƒ½æ˜¯å•å‘åœ°ä»é¢†å¯¼äººæµå‘å…¶ä»–æœåŠ¡å™¨ã€‚å½“ç„¶ï¼Œåœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œé¢†å¯¼äººè‡ªèº«çš„æ—¥å¿—æ­£ç¡®æ€§æ˜¾å¾—å°¤ä¸ºé‡è¦ï¼Œä¸‹æ–‡ä¼šè¯æ˜æ—¥å¿—çš„æ­£ç¡®æ€§ã€‚</p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾2. Rafté›†ç¾¤ä¸‰ç±»è§’è‰²åˆ‡æ¢ç¤ºæ„å›¾</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/role-switch.png" class="" title="role-switch">

<br />

<p>åœ¨Raftçš„é€‰ä¸¾ä¸­ï¼Œæœ‰ä¸¤ä¸ªæ¦‚å¿µéå¸¸é‡è¦ï¼šå¿ƒè·³å’Œé€‰ä¸¾å®šæ—¶å™¨ã€‚æ¯ä¸ªRaftç»“ç‚¹éƒ½æœ‰ä¸€ä¸ªé€‰ä¸¾å®šæ—¶å™¨ï¼Œæ‰€æœ‰çš„RaftèŠ‚ç‚¹æœ€å¼€å§‹ä»¥Followerè§’è‰²è¿è¡Œæ—¶ï¼Œéƒ½ä¼šå¯åŠ¨è¿™ä¸ªé€‰ä¸¾å®šæ—¶å™¨ã€‚ä¸è¿‡ï¼Œæ¯ä¸ªç»“ç‚¹çš„é€‰ä¸¾å®šæ—¶å™¨å¸‚åœºå‡ä¸ç›¸ç­‰ã€‚</p>
<p>Leaderåœ¨ä»»æœŸå†…å¿…é¡»é¡¶èµ·å‘é›†ç¾¤å†…çš„å…¶ä»–èŠ‚ç‚¹å¹¿æ’­å¿ƒè·³åŒ…ï¼Œæ˜­å‘Šè‡ªå·±çš„å­˜åœ¨ã€‚Followeræ¯æ¬¡æ”¶åˆ°å¿ƒè·³åŒ…åå°±ä¼šä¸»åŠ¨å°†è‡ªå·±çš„é€‰ä¸¾å®šæ—¶å™¨æ¸…é›¶é‡ç½®ï¼ˆresetï¼‰ã€‚å› æ­¤å¦‚æœFolloweré€‰ä¸¾å®šæ—¶å™¨è¶…æ—¶ï¼Œåˆ™æ„å‘³ç€åœ¨Raftè§„å®šçš„ä¸€ä¸ªé€‰ä¸¾è¶…æ—¶æ—¶é—´å‘¨æœŸå†…ï¼ŒLeaderçš„å¿ƒè·³åŒ…å¹¶æ²¡æœ‰å‘ç»™Followerï¼ˆæˆ–è€…å·²ç»å‘é€äº†ä½†åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­å‘ç”Ÿäº†å»¶è¿Ÿæˆ–è¢«ä¸¢å¼ƒäº†ï¼‰ï¼Œäºæ˜¯Followerå°±å‡å®šLeaderå·²ç»ä¸å­˜åœ¨æˆ–è€…å‘ç”Ÿäº†æ•…éšœï¼Œäºæ˜¯ä¼šå‘ç”Ÿä¸€æ¬¡æ–°çš„é€‰ä¸¾ã€‚</p>
<p>å¯¹æ­¤ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å½¢è±¡åœ°ç†è§£ä¸ºæ¯ä¸ªRaftçš„Followeréƒ½æœ‰ä¸€é¢—ä¸å®‰åˆ†çš„â€œé‡å¿ƒâ€ï¼Œåªæ˜¯ç¢äºLeaderçš„å¿ƒè·³å¹¿æ’­â€œå·ä»¤â€ä¸æ•¢â€œé€ åâ€ã€‚è€ŒFollowerä»æœ€åä¸€æ¬¡æ¥æ”¶åˆ°Leaderçš„å¿ƒè·³åŒ…ç®—èµ·ï¼Œæœ€é•¿çš„â€œè›°ä¼â€æ—¶é—´å°±æ˜¯Raftåè®®ä¸ºæ¯ä¸ªèŠ‚ç‚¹è§„å®šçš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œå¤§å®¶å°±éƒ½â€œè ¢è ¢æ¬²åŠ¨â€äº†ã€‚</p>
<p>å› æ­¤ï¼Œè¦æ±‚Leaderå¹¿æ’­å¿ƒè·³çš„å‘¨æœŸå¿…é¡»è¦çŸ­äºé€‰ä¸¾å®šæ—¶å™¨çš„è¶…æ—¶æ—¶é—´ï¼Œå¦åˆ™ä¼šé¢‘ç¹åœ°å‘ç”Ÿé€‰ä¸¾ï¼Œåˆ‡æ¢Leaderã€‚</p>
<p>å¦‚æœä¸€ä¸ªFollowerå†³å®šå¼€å§‹å‚åŠ é€‰ä¸¾ï¼Œé‚£ä¹ˆå®ƒä¼šæ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>å°†è‡ªå·±æœ¬åœ°ç»´æŠ¤çš„å½“å‰ä»»æœŸå·ï¼ˆcurrent_term_idï¼‰åŠ 1ã€‚</li>
<li>å°†è‡ªå·±çš„çŠ¶æ€åˆ‡æ¢åˆ°å€™é€‰äººï¼ˆCandidateï¼‰ï¼Œå¹¶ä¸ºè‡ªå·±æŠ•ç¥¨ã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªå€™é€‰äººçš„ç¬¬ä¸€å¼ é€‰ç¥¨æ¥è‡ªäºä»–è‡ªå·±ã€‚</li>
<li>å‘å…¶æ‰€åœ¨é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘é€ RequestVote RPCï¼Œè¦æ±‚å®ƒä»¬æŠ•ç¥¨ç»™è‡ªå·±ã€‚</li>
</ol>
<p>ä¸€ä¸ªå€™é€‰äººæœ‰ä¸‰ç§çŠ¶æ€è¿ç§»çš„å¯èƒ½æ€§ï¼š</p>
<ol>
<li>å¾—åˆ°å¤§å¤šæ•°èŠ‚ç‚¹çš„é€‰ç¥¨ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰ï¼Œæˆä¸ºLeaderã€‚</li>
<li>å‘ç°å…¶ä»–èŠ‚ç‚¹èµ¢å¾—äº†é€‰ä¸¾ï¼Œä¸»åŠ¨åˆ‡æ¢å›Followerã€‚</li>
<li>è¿‡äº†ä¸€æ®µæ—¶é—´åï¼Œå‘ç°æ²¡æœ‰äººèµ¢å¾—é€‰ä¸¾ï¼Œé‡æ–°å‘èµ·ä¸€æ¬¡é€‰ä¸¾ã€‚</li>
</ol>
<p>ç¬¬ä¸€ç§åœºæ™¯ã€å…ˆåˆ°å…ˆå¾—ã€‘ï¼šä¸€ä¸ªå€™é€‰äººå¦‚æœåœ¨ä¸€ä¸ªä»»æœŸå†…æ”¶åˆ°äº†é›†ç¾¤ä¸­å¤§å¤šæ•°Followerçš„æŠ•ç¥¨ï¼Œå°±ç®—èµ¢å¾—äº†é€‰ä¸¾ã€‚åœ¨ä¸€ä¸ªä»»æœŸå†…ï¼Œä¸€ä¸ªRaftç»“ç‚¹æœ€å¤šåªèƒ½ä¸ºä¸€ä¸ªå€™é€‰äººæŠ•ç¥¨ï¼ŒæŒ‰ç…§å…ˆåˆ°å…ˆå¾—çš„åŸåˆ™ï¼ŒæŠ•ç»™æœ€æ—©æ¥æ‹‰é€‰ç¥¨çš„å€™é€‰äººã€‚é€‰ä¸¾å®‰å…¨æ€§åŸåˆ™ä½¿å¾—åœ¨ä¸€ä¸ªä»»æœŸå†…æœ€å¤šæœ‰ä¸€ä¸ªå€™é€‰äººèƒ½å¤Ÿèµ¢å¾—é€‰ä¸¾ã€‚ä¸€æ—¦æŸä¸ªå€™é€‰äººèµ¢å¾—äº†é€‰ä¸¾ï¼Œå®ƒå°±ä¼šå‘å…¶ä»–èŠ‚ç‚¹å‘é€å¿ƒè·³ä¿¡æ¯æ¥å»ºç«‹è‡ªå·±çš„é¢†å¯¼åœ°ä½ã€‚</p>
<p>ç¬¬äºŒç§åœºæ™¯ã€è‡ªåŠ¨æ”¾å¼ƒã€‘ï¼šå½“ä¸€ä¸ªå€™é€‰äººåœ¨ç­‰å¾…å…¶ä»–äººçš„é€‰ç¥¨æ—¶ï¼Œå®ƒæœ‰å¯èƒ½ä¼šæ”¶åˆ°æ¥è‡ªå…¶ä»–èŠ‚ç‚¹çš„ï¼Œå£°ç§°è‡ªå·±æ˜¯é¢†å¯¼äººçš„å¿ƒè·³åŒ…ã€‚æ­¤æ—¶ï¼Œè¿™ä¸ªå€™é€‰äººä¼šå°†ä¿¡å°†ç–‘åœ°æ£€æŸ¥åŒ…å«è¿™ä½é¢†å¯¼äººRPCä¸­çš„ä»»æœŸå·ï¼šå¦‚æœå¤§äºæˆ–ç­‰äºè‡ªå·±æœ¬åœ°ç»´æŠ¤çš„å½“å‰ä»»æœŸï¼Œåˆ™æ‰¿è®¤è¯¥é¢†å¯¼äººåˆæ³•ï¼Œå¹¶ä¸”ä¸»åŠ¨å°†è‡ªå·±çš„çŠ¶æ€åˆ‡æ¢å›Followerï¼›åä¹‹ï¼Œå€™é€‰äººåˆ™è®¤ä¸ºè¯¥é¢†å¯¼äººä¸åˆæ³•ï¼Œæ‹’ç»æ­¤æ¬¡RPCï¼Œå¹¶ä¸”è¿”å›å½“å‰è¾ƒæ–°çš„é‚£ä¸ªä»»æœŸå·ï¼Œä»¥ä¾¿è®©é¢†å¯¼äººæ„è¯†åˆ°è‡ªå·±çš„ä»»æœŸå·å·²ç»è¿‡æ—¶ï¼Œè¯¥èŠ‚ç‚¹ç»§ç»­ä¿æŒå€™é€‰äººçŠ¶æ€ä¸å˜ã€‚</p>
<p>ç¬¬ä¸‰ç§åœºæ™¯ã€é€‰ç¥¨ç“œåˆ†ã€‘ï¼šä¸€ä¸ªå€™é€‰äººæ—¢æ²¡æœ‰èµ¢å¾—é€‰ä¸¾ä¹Ÿæ²¡æœ‰è¾“æ‰é€‰ä¸¾ã€‚å¦‚æœå¤šä¸ªFolloweråœ¨åŒä¸€æ—¶åˆ»éƒ½æˆäº†å€™é€‰äººï¼Œé‚£ä¹ˆé€‰ç¥¨å¯èƒ½ä¼šè¢«å¤šä¸ªå€™é€‰äººå¹³åˆ†ï¼Œè¿™å°±ä½¿å¾—æ²¡æœ‰å“ªä¸ªå€™é€‰äººèƒ½å¤Ÿè·å¾—è¶…è¿‡åŠæ•°çš„é€‰ç¥¨ã€‚å½“è¿™ç§æƒ…å½¢å‘ç”Ÿæ—¶ï¼Œæ˜¾ç„¶ä¸èƒ½ä¸€ç›´è¿™æ ·â€œåƒµæŒä¸‹å»â€ï¼Œäºæ˜¯Raftçš„æ¯ä¸€ä¸ªå€™é€‰äººåˆéƒ½è®¾ç½®äº†è¶…æ—¶æ—¶é—´å†…ï¼ˆç±»ä¼¼äºé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ŒåŒºåˆ«æ˜¯é€‰ä¸¾è¶…æ—¶æ—¶é—´æ˜¯é’ˆå¯¹Followerçš„ï¼‰ï¼Œå‘ç”Ÿè¶…æ—¶åï¼Œæ¯ä¸ªå€™é€‰äººè‡ªå¢ä»»æœŸå·ï¼ˆTerm++ï¼‰å¹¶ä¸”å‘èµ·æ–°ä¸€è½®çš„æ‹‰é€‰ç¥¨æ´»åŠ¨ã€‚ç„¶åï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–æ‰‹æ®µæ¥åˆ†é…é€‰ç¥¨çš„è¯ï¼Œé€‰ç¥¨å‡åˆ†çš„æƒ…å†µå¯èƒ½ä¼šæ— é™å¾ªç¯ä¸‹å»ã€‚ä¸ºäº†é¿å…å‘ç”Ÿè¿™ç§é—®é¢˜ï¼ŒRafté‡‡ç”¨äº†ä¸€ç§éå¸¸ç®€å•çš„æ–¹æ³•â€”â€”éšæœºé‡è¯•ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®ä¸€ä¸ªåŒºé—´ï¼ˆ150~300msï¼‰ï¼Œè¶…æ—¶æ—¶é—´å°†ä»è¿™ä¸ªåŒºé—´å†…éšæœºé€‰æ‹©ã€‚é”™å¼€å‘èµ·ç«é€‰çš„æ—¶é—´çª—å£ï¼Œå¯ä»¥ä½¿å¾—åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¼šç‡å…ˆè¶…æ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¼šåœ¨å…¶ä»–èŠ‚ç‚¹è¶…æ—¶ä¹‹å‰èµ¢å¾—é€‰ä¸¾ï¼Œå¹¶ä¸”å‘å…¶ä»–èŠ‚ç‚¹å‘é€å¿ƒè·³ä¿¡æ¯ã€‚è¦çŸ¥é“ï¼Œåœ¨æ¯ä¸ªé€‰ç¥¨æ‰“å¹³æ—¶éƒ½ä¼šé‡‡ç”¨è¿™ç§éšæœºçš„æ–¹å¼ï¼Œå› æ­¤è¿ç»­å‘ç”Ÿé€‰ç¥¨è¢«å‡åŒ€çš„æ¦‚ç‡éå¸¸å°ã€‚</p>
<blockquote>
<p>æ®Raftç®—æ³•çš„ä½œè€…å›å¿†ï¼Œæœ€å¼€å§‹æ—¶ä»–ä»¬è®¡åˆ’ä½¿ç”¨ä¸€ç§æ’åç³»ç»Ÿï¼šä¸ºæ¯ä¸€ä¸ªå€™é€‰äººåˆ†é…ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„æ’åï¼Œç”¨äºåœ¨å€™é€‰äººç«äº‰æ—¶å€™æ ¹æ®æ’åçš„é«˜ä½é€‰æ‹©é¢†å¯¼äººã€‚å¦‚æœå‘ç°ä¸€ä¸ªå€™é€‰äººçš„æ’åæ¯”å¦ä¸€ä¸ªå€™é€‰äººçš„æ’åé«˜ï¼Œæ’åè¾ƒä½çš„å°±ä¼šåˆ‡æ¢å›Followerçš„çŠ¶æ€ï¼Œè¿™æ ·æ’åæçš„å€™é€‰äººå°±ä¼šè½»è€Œæ˜“ä¸¾åœ°èµ¢å¾—é€‰ä¸¾ã€‚</p>
<p>ä½†æ˜¯ä»–ä»¬é©¬ä¸Šå°±å‘ç°è¿™ç§æ–¹æ³•åœ¨å¯ç”¨æ€§æ–¹é¢å­˜åœ¨ä¸€äº›é—®é¢˜â€”â€”ä½æ’åçš„èŠ‚ç‚¹åœ¨é«˜æ’åçš„èŠ‚ç‚¹å‘ç”Ÿæ•…éšœåï¼Œéœ€è¦ç­‰å¾…è¶…æ—¶æ‰èƒ½å†æ¬¡æˆä¸ºå€™é€‰äººï¼Œä½†æ˜¯å¦‚æœè¿›è¡Œå¾—å¤ªå¿«ï¼Œå°±æœ‰å¯èƒ½ä¸­æ–­é¢†å¯¼äººé€‰ä¸¾çš„è¿‡ç¨‹ã€‚</p>
<p>åœ¨å¯¹ç®—æ³•è¿›è¡Œäº†å¤šæ¬¡è°ƒæ•´ä¹‹åï¼Œæœ€ç»ˆä»–ä»¬è®¤ä¸ºéšæœºé‡è¯•çš„æ–¹æ³•æ›´åŠ æ˜ç¡®ã€‚</p>
</blockquote>
<p>å€™é€‰äººâ€œæ‹‰ç¥¨â€è¿‡ç¨‹ä½¿ç”¨Raftç®—æ³•é¢„å®šä¹‰çš„RPCâ€”â€”RequestVote RPCå°±èƒ½æè¿°ã€‚RequestVote RPCçš„å‘èµ·/è°ƒç”¨æ–¹æ˜¯Candidateï¼Œæ¥æ”¶æ–¹æ˜¯é›†ç¾¤å†…æ‰€æœ‰çš„å…¶ä»–èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬Leaderã€Followerå’ŒCandidateï¼‰ã€‚</p>
<p>RequestVote RPCæœ‰4ä¸ªå‚æ•°ï¼Œ2ä¸ªè¿”å›å€¼ã€‚</p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>è¡¨1. RequestVote RPCå‚æ•°åˆ—è¡¨</font>
</center>

<table>
<thead>
<tr>
<th align="left">å‚æ•°</th>
<th align="left">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="left">term</td>
<td align="left">å€™é€‰äºº</td>
</tr>
<tr>
<td align="left">candidateId</td>
<td align="left">è¯·æ±‚æŠ•ç¥¨çš„å€™é€‰äººid</td>
</tr>
<tr>
<td align="left">lastLogIndex</td>
<td align="left">å€™é€‰äººæœ€æ–°æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼ï¼ˆæ§½ä½ï¼‰</td>
</tr>
<tr>
<td align="left">lastLogTerm</td>
<td align="left">å€™é€‰äººæœ€æ–°æ—¥å¿—æ¡ç›®å¯¹åº”çš„ä»»æœŸå·</td>
</tr>
</tbody></table>
<center>
    <font face="Old English Text MT" color="#555555" size=3>è¡¨2. RequestVote RPCè¿”å›å€¼åˆ—è¡¨</font>
</center>

<table>
<thead>
<tr>
<th align="left">è¿”å›å€¼</th>
<th align="left">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="left">term</td>
<td align="left">å½“å‰ä»»æœŸå·ï¼Œç”¨äºå€™é€‰äººæ›´æ–°è‡ªå·±æœ¬åœ°çš„termå€¼</td>
</tr>
<tr>
<td align="left">voteGranted</td>
<td align="left">å¦‚æœå€™é€‰äººå¾—åˆ°äº†è¿™å¼ é€‰ç¥¨ï¼Œåˆ™ä¸ºtrueï¼Œå¦åˆ™ä¸ºfalse</td>
</tr>
</tbody></table>
<p>RPCæ¥æ”¶æ–¹éœ€è¦å®ç°çš„é€»è¾‘å…·ä½“å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¦‚æœterm &lt; currentTermï¼Œå³RPCçš„ç¬¬ä¸€ä¸ªå‚æ•°termçš„å€¼å°äºæ¥æ”¶æ–¹æœ¬åœ°ç»´æŠ¤çš„termï¼ˆcurrentTermï¼‰å€¼ï¼Œåˆ™è¿”å› (currentTerm, false)ï¼Œä»¥æé†’è°ƒç”¨æ–¹å…¶termè¿‡æ—¶äº†ï¼Œå¹¶ä¸”æ˜ç¡®åœ°å‘Šè¯‰è¿™ä½å€™é€‰äººè¿™å¼ é€‰ç¥¨ä¸ä¼šæŠ•ç»™ä»–ï¼›å¦åˆ™æ‰§è¡Œæ­¥éª¤2ã€‚</li>
<li>å¦‚æœä¹‹å‰æ²¡æŠŠé€‰ç¥¨æŠ•ç»™ä»»ä½•äººï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰æˆ–è€…å·²ç»æŠŠé€‰ç¥¨æŠ•ç»™å½“å‰å€™é€‰äººäº†ï¼Œå¹¶ä¸”å€™é€‰äººçš„æ—¥å¿—å’Œè‡ªå·±çš„æ—¥å¿—ä¸€æ ·æ–°ï¼Œåˆ™è¿”å› (term, true)ï¼Œè¡¨ç¤ºåœ¨è¿™ä¸ªä»»æœŸï¼Œé€‰ç¥¨éƒ½æŠ•ç»™è¿™ä½å€™é€‰äººã€‚å¦‚æœä¹‹å‰å·²ç»æŠŠé€‰ç¥¨æŠ•ç»™å…¶ä»–äººï¼Œé‚£ä¹ˆå¾ˆé—æ†¾ï¼Œè¿™å¼ é€‰ç¥¨è¿˜æ˜¯ä¸èƒ½æŠ•ç»™ä»–ï¼Œè¿™æ—¶å°±ä¼šè¿”å› (term, false)ã€‚</li>
</ol>
<h3 id="æ—¥å¿—å¤åˆ¶"><a href="#æ—¥å¿—å¤åˆ¶" class="headerlink" title="æ—¥å¿—å¤åˆ¶"></a>æ—¥å¿—å¤åˆ¶</h3><p>ä¸€æ—¦æŸä¸ªé¢†å¯¼äººèµ¢å¾—äº†é€‰ä¸¾ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå¼€å§‹æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚æ¯ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚éƒ½å°†è¢«è§£ææˆä¸€æ¡éœ€è¦å¤åˆ¶çŠ¶æ€æœºæ‰§è¡Œçš„æŒ‡ä»¤ã€‚é¢†å¯¼äººæŠŠè¿™æ¡æŒ‡ä»¤ä½œä¸ºä¸€æ¡å¿ƒçš„æ—¥å¿—åŠ å…¥å®ƒçš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œç„¶åå¹¶è¡Œåœ°å‘å…¶ä»–RaftèŠ‚ç‚¹å‘èµ·AppendEntries RPCï¼Œè¦æ±‚å…¶ä»–èŠ‚ç‚¹å¤åˆ¶è¿™ä¸ªæ—¥å¿—æ¡ç›®ã€‚å½“è¿™ä¸ªæ—¥å¿—æ¡ç›®è¢«â€œå®‰å…¨â€åœ°å¤åˆ¶ä¹‹åï¼ŒLeaderä¼šå°†è¿™æ¡æ—¥å¿—åº”ç”¨åˆ°å®ƒçš„çŠ¶æ€æœºä¸­ï¼Œå¹¶ä¸”å‘å®¢æˆ·ç«¯è¿”å›æ‰§è¡Œç»“æœã€‚å¦‚æœFollowerå‘ç”Ÿé”™è¯¯ï¼Œè¿è¡Œç¼“æ…¢æ²¡æœ‰åŠæ—¶å“åº”AppendEntries RPCï¼Œæˆ–è€…å‘ç”Ÿäº†ç½‘ç»œä¸¢åŒ…çš„é—®é¢˜ï¼Œé‚£ä¹ˆé¢†å¯¼äººä¼šæ— é™åœ°é‡è¯•AppendEntries RPCï¼ˆç”šè‡³åœ¨å®ƒå“åº”äº†å®¢æˆ·ç«¯ä¹‹åï¼‰ï¼Œç›´åˆ°æ‰€æœ‰çš„Followeræœ€ç»ˆå­˜å‚¨äº†å’ŒLeaderä¸€æ ·çš„æ—¥å¿—æ¡ç›®ã€‚</p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾3. RAFTåè®®è¿½åŠ æ—¥å¿—ç¤ºæ„å›¾</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/log-composition.png" class="" title="log-composition">

<br />

<p>å¦‚å›¾3æ‰€ç¤ºï¼Œæ—¥å¿—ç”±æœ‰åºç¼–å·çš„æ—¥å¿—æ¡ç›®ç»„æˆã€‚æ¯ä¸€ä¸ªæ—¥å¿—æ¡ç›®ä¸€èˆ¬å‡åŒ…å«ä¸‰ä¸ªå±æ€§ï¼šæ•´æ•°ç´¢å¼•ï¼ˆlog indexï¼‰ã€ä»»æœŸå·ï¼ˆtermï¼‰å’ŒæŒ‡ä»¤ï¼ˆcommandï¼‰ã€‚æ¯ä¸ªæ¡ç›®æ‰€åŒ…å«çš„æ•´æ•°ç´¢å¼•å³è¯¥æ¡ç›®åœ¨æ—¥å¿—æ–‡ä»¶ä¸­çš„æ§½ä½ã€‚termæ˜¯æŒ‡å…¶è¢«é¢†å¯¼äººåˆ›å»ºæ—¶æ‰€åœ¨çš„ä»»æœŸå·ï¼Œå¯¹åº”åˆ°å›¾ä¸­å°±æ˜¯æ¯ä¸ªæ–¹å—çš„æ•°å­—ï¼Œç”¨äºæ£€æµ‹åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šæ—¥å¿—ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚æŒ‡ä»¤å³ç”¨äºè¢«çŠ¶æ€æœºæ‰§è¡Œçš„å¤–éƒ¨å‘½ä»¤ã€‚å¦‚æœæŸä¸ªæ—¥å¿—æ¡ç›®èƒ½å¤Ÿè¢«çŠ¶æ€æœºå®‰å…¨æ‰§è¡Œï¼Œå°±è®¤ä¸ºæ˜¯å¯ä»¥è¢«æäº¤ï¼ˆcommitedï¼‰äº†ã€‚</p>
<p>é¢†å¯¼äººå†³å®šä»€ä¹ˆæ—¶å€™å°†æ—¥å¿—æ¡ç›®åº”ç”¨åˆ°çŠ¶æ€æœºæ˜¯å®‰å…¨çš„ï¼Œå³å¯è¢«æäº¤çš„ã€‚Raftç®—æ³•ä¿è¯å¯è¢«æäº¤çš„æ—¥å¿—æ¡ç›®æ˜¯æŒä¹…åŒ–çš„ï¼Œå¹¶ä¸”æœ€ç»ˆæ˜¯ä¼šæ‰€æœ‰çŠ¶æ€æœºæ‰§è¡Œçš„ã€‚ä¸€æ—¦é¢†å¯¼äººåˆ›å»ºçš„æ¡ç›®å·²ç»è¢«å¤åˆ¶åˆ°åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹ä¸Šäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¡ç›®å°±ç§°ä¸ºå¯è¢«æäº¤çš„ã€‚ä¾‹å¦‚ï¼Œå›¾ä¸­çš„7å·æé˜¿å¶åœ¨å…¶ä¸­3ä¸ªç»“ç‚¹ä¸Šå‡æœ‰å¤åˆ¶ï¼Œæ‰€ä»¥7å·æ¡ç›®æ˜¯å¯è¢«æäº¤çš„ï¼›ä½†æ¡ç›®8åªåœ¨å…¶ä¸­2ä¸ªèŠ‚ç‚¹ä¸Šæœ‰å¤åˆ¶ï¼Œå› æ­¤8å·æ¡ç›®æ˜¯ä¸å¯è¢«æäº¤çš„ã€‚</p>
<p>é¢†å¯¼äººæ—¥å¿—ä¸­åªæœ‰commitIndexä¹‹å‰çš„æ—¥å¿—é¡¹ç›®å¯ä»¥è¢«æäº¤ï¼Œè¿™ç§æäº¤æ–¹å¼æ˜¯å®‰å…¨çš„ã€‚é¢†å¯¼äººè·Ÿè¸ªè®°å½•ä»–æ‰€çŸ¥é“çš„è¢«æäº¤æ—¥å¿—æ¡ç›®çš„æœ€å¤§ç´¢å¼•å€¼ï¼Œå¹¶ä¸”è¿™ä¸ªç´¢å¼•å€¼ä¼šåŒ…å«åœ¨ä»–å‘å…¶ä»–èŠ‚ç‚¹å‘é€çš„AppendEntries RPCä¸­ï¼Œç›®çš„å°±æ˜¯è®©å…¶ä»–èŠ‚ç‚¹çŸ¥é“è¯¥ç´¢å¼•å€¼å¯¹åº”çš„æ—¥å¿—æ¡ç›®å·²ç»è¢«æäº¤ã€‚ç”±äºé¢†å¯¼äººå¹¿æ’­çš„å¿ƒè·³åŒ…å°±æ˜¯ä¸€ä¸ªå†…å®¹ä¸ºç©ºçš„AppendEntries RPCï¼Œå› æ­¤å…¶ä»–èŠ‚ç‚¹ä¹Ÿèƒ½é€šè¿‡é¢†å¯¼äººçš„å¿ƒè·³åŒ…è·æ‚‰æŸä¸ªæ—¥å¿—æ¡ç›®çš„æäº¤æƒ…å†µã€‚ä¸€æ—¦Followerå¾—çŸ¥æŸä¸ªæ—¥å¿—æ¡ç›®å·²ç»è¢«æäº¤ï¼Œé‚£ä¹ˆå®ƒä¼šå°†è¯¥æ—¥å¿—åº”ç”¨åˆ°æœ¬åœ°çš„çŠ¶æ€æœºï¼ˆæŒ‰ç…§æ—¥å¿—é¡ºåºï¼‰ã€‚</p>
<p>Raftç®—æ³•è®¾è®¡äº†ä»¥ä¸‹æ—¥å¿—æœºåˆ¶æ¥ä¿è¯ä¸åŒèŠ‚ç‚¹ä¸Šæ—¥å¿—çš„ä¸€è‡´æ€§ï¼š</p>
<ol>
<li>å¦‚æœåœ¨ä¸åŒçš„æ—¥å¿—ä¸­ä¸¤ä¸ªæ¡ç›®æœ‰ç€ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå·ï¼Œåˆ™å®ƒä»¬æ‰€å­˜å‚¨çš„å‘½ä»¤æ˜¯ç›¸åŒçš„ã€‚</li>
<li>å¦‚æœåœ¨ä¸åŒçš„æ—¥å¿—ä¸­ä¸¤ä¸ªæ¡ç›®æœ‰ç€ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå·ï¼Œåˆ™å®ƒä»¬ä¹‹å‰çš„æ‰€æœ‰æ¡ç›®éƒ½æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚</li>
</ol>
<p>ç¬¬ä¸€æ¡ç‰¹æ€§çš„æ»¡è¶³æ¡ä»¶åœ¨äºï¼Œé¢†å¯¼äººåœ¨ä¸€ä¸ªä»»æœŸé‡Œåœ¨ç»™å®šçš„ä¸€ä¸ªæ—¥å¿—ç´¢å¼•ä½ç½®æœ€å¤šåˆ›å»ºä¸€æ¡æ—¥å¿—æ¡ç›®ï¼ŒåŒæ—¶è¯¥æ¡ç›®åœ¨æ—¥å¿—æ–‡ä»¶ä¸­çš„æ§½ä½æ°¸è¿œä¹Ÿä¸ä¼šæ”¹å˜ã€‚</p>
<p>ç¬¬äºŒæ¡ç‰¹æ€§çš„æ»¡è¶³æ¡ä»¶åœ¨äºï¼ŒAppendEntries RPCæœ‰ä¸€ä¸ªç®€å•çš„ä¸€è‡´æ€§æ£€æŸ¥ã€‚é¢†å¯¼äººåœ¨å‘é€ä¸€ä¸ªAppendEntries RPCæ¶ˆæ¯è¯•å›¾å‘å…¶ä»–èŠ‚ç‚¹è¿½åŠ æ–°çš„æ—¥å¿—æ¡ç›®æ—¶ï¼Œä¼šæŠŠè¿™äº›æ–°æ—¥å¿—æ¡ç›®ä¹‹å‰ä¸€ä¸ªæ§½ä½çš„æ—¥å¿—æ¡ç›®çš„ä»»æœŸå·å’Œç´¢å¼•ä½ç½®åŒ…å«åœ¨æ¶ˆæ¯ä½“ä¸­ã€‚å¦‚æœFolloweråœ¨å®ƒçš„æ—¥å¿—æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ç›¸åŒçš„ä»»æœŸå·å’Œç´¢å¼•çš„æ—¥å¿—ï¼Œå®ƒå°±ä¼šæ‹’ç»è¯¥AppendEntries RPCï¼Œå³æ‹’ç»åœ¨è‡ªå·±çš„çŠ¶æ€æœºä¸­è¿½åŠ æ–°æ—¥å¿—æ¡ç›®ã€‚</p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾4. æ–°Leaderäº§ç”Ÿæ—¶ä¸€ä¸ªé›†ç¾¤å¯èƒ½çš„ä¸€ä¸ªçŠ¶æ€å›¾</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/cluster-status.png" class="" title="cluster-status">

<br />

<p>å½“ä¸€ä¸ªæ–°çš„Leaderè¢«é€‰ä¸¾å‡ºæ¥æ—¶ï¼Œå®ƒçš„æ—¥å¿—ä¸å…¶ä»–çš„Followerå¯èƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚è¿™æ˜¯å°±éœ€è¦ä¸€ä¸ªæœºåˆ¶æ¥ä¿è¯æ—¥å¿—æ˜¯ä¸€è‡´çš„ã€‚äº§ç”Ÿä¸€ä¸ªæ–°Leaderæ—¶ï¼Œé›†ç¾¤çŠ¶æ€å¯èƒ½å¦‚ä¸Šã€‚</p>
<p>å¦‚å›¾4æ‰€ç¤ºçš„ä¾‹å­ä¸­ï¼Œä¸€ä¸ªæ ¼å­ä»£è¡¨ä¸€ä¸ªæ—¥å¿—æ¡ç›®ï¼Œæ ¼å­ä¸­çš„æ•°å­—æ˜¯å®ƒå¯¹åº”çš„ä»»æœŸå·ã€‚å‡è®¾æœ€ä¸Šé¢çš„é‚£ä¸ªæ˜¯é¢†å¯¼äººï¼Œa~fæ‰€ä»£è¡¨çš„åœºæ™¯åˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li>aå’Œbè¡¨ç¤ºFollowerä¸¢å¤±ä¸€äº›æ—¥å¿—æ¡ç›®çš„åœºæ™¯ã€‚</li>
<li>cå’Œdè¡¨ç¤ºFollowerå¯èƒ½å¤šå‡ºæ¥ä¸€äº›æœªæäº¤çš„æ¡ç›®çš„åœºæ™¯ã€‚</li>
<li>eå’Œfè¡¨ç¤ºä¸Šè¿°ä¸¤ç§æƒ…å†µéƒ½æœ‰çš„åœºæ™¯ã€‚</li>
</ul>
<p>ä¸¢å¤±çš„æˆ–è€…å¤šå‡ºæ¥çš„æ¡ç›®å¯èƒ½ä¼šæŒç»­å¤šä¸ªä»»æœŸã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœºæ™¯fä¼šåœ¨å¦‚ä¸‹æƒ…å†µä¸‹å‘ç”Ÿï¼šå¦‚æœä¸€å°æœåŠ¡å™¨åœ¨ä»»æœŸ2æ—¶æ˜¯é¢†å¯¼äººï¼Œå¹¶ä¸”å…¶å‘ä»–è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶ä¸­è¿½åŠ äº†ä¸€äº›æ—¥å¿—æ¡ç›®ï¼Œç„¶ååœ¨å°†è¿™äº›æ—¥å¿—æ¡ç›®æäº¤ä¹‹å‰ç³»ç»Ÿå‡ºç°äº†æ•…éšœã€‚ä½†æ˜¯ä»–å¾ˆå¿«åˆé‡å¯äº†ï¼Œé€‰ä¸¾æˆåŠŸç»§ç»­æˆåŠŸä»»æœŸ3çš„é¢†å¯¼äººï¼Œè€Œä¸”åˆå‘ä»–è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶ä¸­è¿½åŠ äº†ä¸€äº›æ—¥å¿—æ¡ç›®ã€‚ä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œåœ¨ä»»æœŸ2å’Œä»»æœŸ3ä¸­åˆ›å»ºçš„æ—¥å¿—æ¡ç›®åœ¨è¢«æäº¤ä¹‹å‰åˆå‡ºç°äº†æ•…éšœï¼Œå¹¶ä¸”åœ¨åé¢å‡ ä¸ªä»»æœŸå†…ä¹Ÿä¸€ç›´å¤„äºæ•…éšœçŠ¶æ€ã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒLeaderå’ŒFollowerçš„æ—¥å¿—éƒ½æ˜¯ä¿æŒä¸€è‡´çš„ï¼Œå› æ­¤AppendEntries RPCçš„ä¸€è‡´æ€§æ£€æŸ¥é€šå¸¸ä¸ä¼šå¤±è´¥ã€‚ç„¶åï¼Œå¦‚æœé¢†å¯¼äººèŠ‚ç‚¹åœ¨æ•…éšœä¹‹å‰æ²¡æœ‰å‘å…¶ä»–èŠ‚ç‚¹å®Œå…¨å¤åˆ¶æ—¥å¿—æ–‡ä»¶ä¸­çš„æ‰€æœ‰å¤åˆ¶æ¡ç›®ï¼Œåˆ™ä¼šå¯¼è‡´æ—¥å¿—ä¸ä¸€è‡´çš„é—®é¢˜ã€‚åœ¨Raftç®—æ³•ä¸­ï¼ŒLeaderé€šè¿‡å¼ºåˆ¶Followerå¤åˆ¶å®ƒçš„æ—¥å¿—ç±»å¤„ç†æ—¥å¿—ä¸ä¸€è‡´çš„é—®é¢˜ã€‚è¿™å°±æ„å‘³ç€ï¼ŒFollowerä¸Šä¸Leaderçš„å†²çªæ—¥å¿—ä¼šè¢«é¢†å¯¼è€…çš„æ—¥å¿—å¼ºåˆ¶è¦†å†™ã€‚</p>
<p>ä¸ºäº†è®©Followerçš„æ—¥å¿—åŒè‡ªå·±çš„ä¿æŒä¸€è‡´ï¼ŒLeaderéœ€è¦æ‰¾åˆ°ç¬¬ä¸€ä¸ªFollowerä¸å®ƒçš„æ—¥å¿—æ¡ç›®ä¸ä¸€è‡´çš„ä½ç½®ï¼Œç„¶åè®©Followerè¿ç»­åˆ é™¤è¯¥ä½ç½®ä¹‹åï¼ˆåŒ…æ‹¬è¯¥ä½ç½®ï¼‰æ‰€æœ‰çš„æ—¥å¿—æ¡ç›®ï¼Œå¹¶ä¸”å°†è‡ªå·±åœ¨è¯¥ä½ç½®ï¼ˆåŒ…æ‹¬è¯¥ä½ç½®ï¼‰ä¹‹åçš„æ—¥å¿—æ¡ç›®å‘é€ç»™Followerã€‚</p>
<p>é‚£ä¹ˆï¼ŒLeaderæ˜¯å¦‚ä½•ç²¾å‡†åœ°æ‰¾åˆ°æ¯ä¸ªFollowerä¸å…¶æ—¥å¿—æ¡ç›®ä¸ä¸€è‡´çš„é‚£ä¹ˆæ§½ä½çš„å‘¢ï¼Ÿè¿™äº›æ“ä½œéƒ½ä¼šåœ¨AppendEntries RPCè¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥æ—¶å®Œæˆã€‚Leaderä¸ºæ¯ä¸€ä¸ªFollowerç»´æŠ¤äº†ä¸€ä¸ªnextIndexï¼Œå®ƒè¡¨ç¤ºé¢†å¯¼äººå°†è¦å‘é€ç»™è¯¥ç¾¤ä¼—çš„ä¸‹ä¸€æ¡æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ã€‚å½“ä¸€ä¸ªLeaderèµ¢å¾—é€‰ä¸¾æ—¶ï¼Œå®ƒä¼šå‡è®¾æ¯ä¸ªFollowerä¸Šçš„æ—¥å¿—éƒ½ä¸è‡ªå·±çš„ä¿æŒä¸€è‡´ï¼Œäºæ˜¯å…ˆå°†nextIndexåˆå§‹åŒ–ä¸ºå®ƒæœ€æ–°çš„æ—¥å¿—æ¡ç›®ç´¢å¼•æ ‘+1ã€‚åœ¨å›¾4æ‰€ç¤ºçš„ä¾‹å­ä¸­ï¼Œç”±äºLeaderæœ€æ–°çš„æ—¥å¿—æ¡ç›®indexä¸º10ï¼Œæ‰€ä»¥nextIndexçš„åˆå§‹å€¼æ˜¯11ã€‚</p>
<p>å½“Leaderå‘Followerå‘é€AppendEntries RPCæ—¶ï¼Œå®ƒæºå¸¦äº† (term_id, nextIndex - 1) äºŒå…ƒç»„ä¿¡æ¯ï¼Œterm_idå³nextIndex - 1è¿™ä¸ªæ§½ä½çš„æ—¥å¿—æ¡ç›®çš„termã€‚Followeræ¥æ”¶åˆ°AppendEntries RPCæ¶ˆæ¯åï¼Œä¼šè¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥ï¼Œå³æœç´¢è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨è¿™æ ·çš„æ—¥å¿—æ¡ç›®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±å‘Leaderè¿”å›AppendEntries RPCå¤±è´¥ã€‚å¦‚æœè¿”å›å¤±è´¥ä¿¡æ¯ï¼Œå°±æ„å‘³ç€Followerå‘ç°è‡ªå·±çš„æ—¥å¿—ä¸é¢†å¯¼äººçš„ä¸ä¸€è‡´ã€‚åœ¨å¤±è´¥ä¹‹åï¼Œé¢†å¯¼äººä¼šå°†nextIndexé€’å‡ï¼ˆnextIndexâ€“ï¼‰ï¼Œç„¶åé‡è¯•AppendEntries RPCï¼Œç›´åˆ°AppendEntries RPCè¿”å›æˆåŠŸä¸ºæ­¢ã€‚è¿™æ‰è¡¨æ˜åœ¨nextIndexä½ç½®çš„æ—¥å¿—æ¡ç›®ä¸­é¢†å¯¼äººä¸ç¾¤ä¼—çš„ä¿æŒä¸€è‡´ã€‚è¿™æ—¶ï¼ŒFollowerä¸ŠnextIndexä½ç½®ä¹‹å‰çš„æ—¥å¿—æ¡ç›®å°†å…¨éƒ¨ä¿ç•™ï¼Œåœ¨æ­¤ä¹‹åï¼ˆä¸Leaderæœ‰å†²çªï¼‰çš„æ—¥å¿—æ¡ç›®å°†è¢«Followerå…¨éƒ¨åˆ é™¤ï¼Œå¹¶ä¸”ä»è¯¥ä½ç½®èµ·è¿½åŠ Leaderä¸Šåœ¨nextIndexä½ç½®ä¹‹åçš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ã€‚å› æ­¤ï¼Œä¸€æ—¦AppendEntries RPCè¿”å›æˆåŠŸï¼ŒLeaderå’ŒFollowerçš„æ—¥å¿—å°±å¯ä»¥ä¿æŒä¸€è‡´äº†ã€‚</p>
<p>ä»¥ä¸Šå³Raftæ—¥å¿—çš„ä¸€è‡´æ€§æ£€æŸ¥çš„å…¨è¿‡ç¨‹ï¼Œä¸‹é¢å°†ä»¥å›¾4çš„Leaderå’ŒbèŠ‚ç‚¹ï¼Œä¸¾ä¾‹è¯´æ˜æ—¥å¿—ä¸€è‡´æ€§æ£€æŸ¥Leaderå’ŒFollowerä¹‹é—´çš„äº¤äº’è¿‡ç¨‹ï¼š</p>
<ol>
<li>Leaderçš„nextIndexçš„åˆå§‹å€¼ä¸º11ï¼ŒLeaderå‘bå‘é€AppendEntries RPC(6, 10)ã€‚bæ£€æŸ¥è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶çš„10å·ä½ç½®æ²¡æœ‰æ‰¾åˆ°termä¸º6çš„æ—¥å¿—è®°å½•ï¼Œäºæ˜¯bå‘leaderè¿”å›äº†ä¸€ä¸ªæ‹’ç»æ¶ˆæ¯ã€‚</li>
<li>Leaderå°†nextIndexå‡1ï¼Œå˜æˆ10ï¼Œç»§ç»­å‘bå‘é€AppendEntries RPC(6, 9)ã€‚bæ£€æŸ¥è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶çš„9å·ä½ç½®æ²¡æœ‰æ‰¾åˆ°termä¸º6çš„æ—¥å¿—è®°å½•ï¼Œäºæ˜¯bå†æ¬¡å‘Leaderè¿”å›äº†ä¸€ä¸ªæ‹’ç»æ¶ˆæ¯ã€‚</li>
<li>Leaderå°†nextIndexå‡1ï¼Œå˜æˆ9ï¼Œç»§ç»­å‘bå‘é€AppendEntries RPC(6, 8)ã€‚bæ£€æŸ¥è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶çš„8å·ä½ç½®æ²¡æœ‰æ‰¾åˆ°termä¸º6çš„æ—¥å¿—è®°å½•ï¼Œäºæ˜¯bå†æ¬¡å‘Leaderè¿”å›äº†ä¸€ä¸ªæ‹’ç»æ¶ˆæ¯ã€‚</li>
<li>Leaderå°†nextIndexå‡1ï¼Œå˜æˆ8ï¼Œç»§ç»­å‘bå‘é€AppendEntries RPC(5, 7)ã€‚bæ£€æŸ¥è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶çš„7å·ä½ç½®æ²¡æœ‰æ‰¾åˆ°termä¸º5çš„æ—¥å¿—è®°å½•ï¼Œäºæ˜¯bå†æ¬¡å‘Leaderè¿”å›äº†ä¸€ä¸ªæ‹’ç»æ¶ˆæ¯ã€‚</li>
<li>Leaderå°†nextIndexå‡1ï¼Œå˜æˆ6ï¼Œç»§ç»­å‘bå‘é€AppendEntries RPC(5, 6)ã€‚bæ£€æŸ¥è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶çš„6å·ä½ç½®æ²¡æœ‰æ‰¾åˆ°termä¸º5çš„æ—¥å¿—è®°å½•ï¼Œäºæ˜¯bå†æ¬¡å‘Leaderè¿”å›äº†ä¸€ä¸ªæ‹’ç»æ¶ˆæ¯ã€‚</li>
<li>Leaderå°†nextIndexå‡1ï¼Œå˜æˆ5ï¼Œç»§ç»­å‘bå‘é€AppendEntries RPC(4, 5)ã€‚bæ£€æŸ¥è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶çš„5å·ä½ç½®æ²¡æœ‰æ‰¾åˆ°termä¸º4çš„æ—¥å¿—è®°å½•ï¼Œäºæ˜¯bå†æ¬¡å‘Leaderè¿”å›äº†ä¸€ä¸ªæ‹’ç»æ¶ˆæ¯ã€‚</li>
<li>Leaderå°†nextIndexå‡1ï¼Œå˜æˆ4ï¼Œç»§ç»­å‘bå‘é€AppendEntries RPC(4, 4)ã€‚bæ£€æŸ¥è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶çš„4å·ä½ç½®ï¼Œæ‰¾åˆ°äº†termä¸º4çš„æ—¥å¿—è®°å½•ï¼Œäºæ˜¯æ¥å—äº†Leaderçš„AppendEntries RPCè¯·æ±‚ï¼Œå¹¶æ¶æ„è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶ä¸­ä»5å·ä½ç½®å¼€å§‹çš„æ—¥å¿—è®°å½•å…¨éƒ¨åˆ é™¤ã€‚éšåï¼ŒLeaderå°±ä»5å·ä½ç½®å¼€å§‹æŠŠä½™ä¸‹çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¸€æ¬¡æ€§æ¨ç»™bï¼ˆ5~10ï¼‰ã€‚</li>
</ol>
<p>å¦‚æœéœ€è¦çš„è¯ï¼Œåœ¨ Raftç®—æ³•çš„å®ç°ä¸Šè¿˜å¯ä»¥ä¼˜åŒ–AppendEntries RPCå¤±è´¥çš„æ¬¡æ•°ã€‚ä¾‹å¦‚ï¼Œå½“Followeræ‹’ç»äº†ä¸€ä¸ªAppendEntries RPCæ—¶ï¼ŒFollowerå¯ä»¥åœ¨è‡ªå·±æœ¬åœ°çš„æ—¥å¿—æ–‡ä»¶ä¸­æ‰¾åˆ°è¯¥å†²çªæ—¥å¿—é¡¹å¯¹åº”çš„ä»»æœŸå·å†…æ‰€æœ‰æ—¥å¿—æ¡ç›®ç´¢å¼•ï¼ˆindexï¼‰å€¼æœ€å°çš„é‚£ä¸ªï¼Œç„¶ååé¦ˆç»™Leaderã€‚äºæ˜¯ï¼Œé¢†å¯¼äººå°±å¯ä»¥è·³è·ƒå¼é€’å‡nextIndexï¼Œè·¨è¿‡é‚£ä¸ªä»»æœŸå†…æ‰€æœ‰çš„å†²çªæ¡ç›®ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¸€ä¸ªå†²çªçš„ä»»æœŸåªéœ€è¦ä¸€æ¬¡AppendEntries RPCæ£€æŸ¥ï¼Œè€Œæ— é¡»ä¸ºæ¯ä¸ªå†²çªæ¡ç›®éƒ½åšä¸€æ¬¡AppendEntries RPCæ£€æŸ¥ã€‚</p>
<p>Raftç®—æ³•çš„æ—¥å¿—å¤åˆ¶æœºåˆ¶ï¼Œä½¿å¾—Leaderå’ŒFolloweråªéœ€è¦è°ƒç”¨å’Œå“åº”AppendEntries RPCå³å¯è®©é›†ç¾¤å†…èŠ‚ç‚¹çš„å„å¤åˆ¶çŠ¶æ€æœºçš„æ—¥å¿—é€æ¸åœ°è¶‹äºä¸€è‡´ï¼Œè€Œæ— é¡»å†é‡‡å–é¢å¤–çš„æªæ–½ã€‚ä¸€ä¸ªé¢†å¯¼äººä»æ¥ä¸ä¼šåˆ é™¤è‡ªå·±çš„æ—¥å¿—ï¼ˆåŒ…æ‹¬å‰ä»»é¢†å¯¼äººåˆ›å»ºçš„æ—¥å¿—ï¼‰ï¼Œä¹Ÿä¸ä¼šè¢«åˆ«äººè¦†ç›–æ—¥å¿—ã€‚</p>
<p>Raftç®—æ³•çš„æ—¥å¿—å¤åˆ¶æœºåˆ¶è¡¨æ˜ï¼šåªè¦é›†ç¾¤ä¸­çš„å¤§éƒ¨åˆ†èŠ‚ç‚¹æ˜¯æ­£å¸¸çš„ï¼Œé‚£ä¹ˆRaftç®—æ³•å°±èƒ½æ¥æ”¶å®¢æˆ·ç«¯å¤åˆ¶æ—¥å¿—çš„è¯·æ±‚ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°å„èŠ‚ç‚¹ä¸Šä¸”åº”ç”¨ï¼ˆApplyï¼‰å¸¦å„èŠ‚ç‚¹å¤åˆ¶çŠ¶æ€æœºä¸Šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€æ¬¡AppendEntries RPCå°±èƒ½å®Œæˆä¸€æ¡å¿ƒçš„æ—¥å¿—æ¡ç›®åœ¨é›†ç¾¤å†…çš„å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šçš„å¤åˆ¶ã€‚è€Œä¸”Raftåªè¦æ±‚æ—¥å¿—æ¡ç›®åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šå®Œæˆå¤åˆ¶å°±ç®—æäº¤æˆåŠŸï¼Œå› æ­¤é€Ÿåº¦è¾ƒæ…¢çš„Followerå¹¶ä¸ä¼šå½±å“æ•´ä½“çš„æ—¥å¿—å¤åˆ¶æ€§èƒ½ã€‚</p>
<p>ä¸€æ¬¡æ­£å¸¸çš„Raftæ—¥å¿—çš„å¤åˆ¶æµç¨‹ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯å‘Leaderå‘é€å†™è¯·æ±‚ã€‚</li>
<li>Leaderå°†å†™è¯·æ±‚è§£ææˆæ“ä½œæŒ‡ä»¤è¿½åŠ åˆ°å“¦æœ¬åœ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚</li>
<li>Leaderä¸ºæ¯ä¸ªFollowerå¹¿æ’­å“¦AppendEntries RPCã€‚</li>
<li>Followeré€šè¿‡ä¸€è‡´æ€§æ£€æŸ¥ï¼Œé€‰æ‹©ä»å“ªä¸ªä½ç½®å¼€å§‹è¿½åŠ Leaderçš„æ—¥å¿—æ¡ç›®ã€‚</li>
<li>ä¸€æ—¦æ—¥å¿—é¡¹æäº¤æˆåŠŸï¼ŒLeaderå°±å°†è¯¥æ—¥å¿—æ¡ç›®å¯¹åº”çš„æŒ‡ä»¤åº”ç”¨åˆ°æœ¬åœ°çŠ¶æ€æœºï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›æ“ä½œç»“æœã€‚</li>
<li>Leaderåç»­é€šè¿‡AppendEntries RPCå°†å·²ç»æˆåŠŸï¼ˆåœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼‰æäº¤çš„æ—¥å¿—é¡¹å‘ŠçŸ¥Followerã€‚</li>
<li>Followeræ”¶åˆ°æäº¤çš„æ—¥å¿—é¡¹ä¹‹åï¼Œå°†å…¶åº”ç”¨åˆ°æœ¬åœ°çŠ¶æ€æœºã€‚</li>
</ol>
<p>ä»ä¸Šé¢æµç¨‹å¯ä»¥çœ‹å‡ºï¼Œé’ˆå¯¹Raftæ—¥å¿—æ¡ç›®æœ‰ä¸¤ä¸ªæ“ä½œï¼Œæäº¤ï¼ˆcommitï¼‰å’Œåº”ç”¨ï¼ˆapplyï¼‰ï¼Œåº”ç”¨å¿…é¡»å‘ç”Ÿåœ¨æäº¤ä¹‹åï¼Œå³æŸä¸ªæ—¥å¿—æ¡ç›®è¢«æäº¤ä¹‹åæ‰èƒ½è¢«åº”ç”¨åˆ°æœ¬åœ°çŠ¶æ€æœºä¸Šã€‚</p>
<p>AppendEntries RPCçš„è°ƒç”¨æ–¹å¼Leaderï¼Œæ¥æ”¶æ–¹æ˜¯Followerã€‚AppendEntries RPCé™¤äº†ç”¨äºå¤åˆ¶æ–‡ä»¶ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¹¿æ’­Leaderçš„å¿ƒè·³åŒ…ã€‚</p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>è¡¨3. AppendEntries RPCå‚æ•°åˆ—è¡¨</font>
</center>

<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>term</td>
<td>é¢†å¯¼äººçš„ä»»æœŸå·</td>
</tr>
<tr>
<td>leaderId</td>
<td>é¢†å¯¼äººçš„IDï¼Œä¸ºäº†å…¶ä»–RaftèŠ‚ç‚¹èƒ½å¤Ÿé‡å®šå‘å®¢æˆ·ç«¯è¯·æ±‚</td>
</tr>
<tr>
<td>prevLogIndex</td>
<td>æœ¬æ¬¡AppendEntries RPCæ–°å¢æ—¥å¿—çš„å‰ä¸€ä¸ªä½ç½®æ—¥å¿—çš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td>prevLogTerm</td>
<td>æœ¬æ¬¡AppendEntries RPCæ–°å¢æ—¥å¿—çš„å‰ä¸€ä¸ªä½ç½®æ—¥å¿—çš„ä»»æœŸå·</td>
</tr>
<tr>
<td>entries[]</td>
<td>å°†è¦è¿½åŠ åˆ°Followerä¸Šçš„æ—¥å¿—æ¡ç›®ã€‚å‘ç”Ÿå¿ƒè·³åŒ…æ—¶ä¸ºç©ºï¼Œæœ‰æ—¶ä¼šä¸ºäº†æ•ˆç‡é«˜è€Œå‘å¤šä¸ªèŠ‚ç‚¹å¹¶å‘å‘é€</td>
</tr>
<tr>
<td>leaderCommit</td>
<td>é¢†å¯¼äººä¼šä¸ºæ¯ä¸ªFolloweréƒ½ç»´æŠ¤ä¸€ä¸ªleaderCommitï¼Œè¡¨ç¤ºé¢†å¯¼äººè®¤ä¸ºFollowerå·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼ã€‚</td>
</tr>
</tbody></table>
<center>
    <font face="Old English Text MT" color="#555555" size=3>è¡¨4. AppendEntries RPCè¿”å›å€¼åˆ—è¡¨</font>
</center>

<table>
<thead>
<tr>
<th>è¿”å›å€¼</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>term</td>
<td>å½“å‰çš„ä»»æœŸå·ï¼Œå³AppendEntries RPCå‚æ•°ä¸­termï¼ˆé¢†å¯¼äººçš„ï¼‰ä¸Followeræœ¬åœ°ç»´æŠ¤çš„å½“å‰ä»»æœŸå·çš„è¾ƒå¤§å€¼ã€‚ç”¨äºé¢†å¯¼äººæ›´æ–°è‡ªå·±çš„ä»»æœŸå·ã€‚ä¸€æ—¦é¢†å¯¼äººå‘ç°å½“å‰ä»»æœŸå·æ¯”è‡ªå·±çš„è¦å¤§ï¼Œå°±è¡¨æ˜è‡ªå·±æ˜¯ä¸€ä¸ªâ€œè¿‡æ—¶â€çš„é¢†å¯¼äººï¼Œä¾¿åœæ­¢å‘é€AppendEntries RPCï¼Œä¸»åŠ¨åˆ‡æ¢å›Followerã€‚</td>
</tr>
<tr>
<td>success</td>
<td>å¦‚æœå…¶ä»–æœåŠ¡å™¨åŒ…å«èƒ½å¤ŸåŒ¹é…prevLogIndexå’ŒprevLogTermçš„æ—¥å¿—ï¼Œåˆ™ä¸ºçœŸ</td>
</tr>
</tbody></table>
<p>RPC æ¥æ”¶è€…éœ€è¦å®ç°å¦‚ä¸‹æ“ä½œæ­¥éª¤ï¼š</p>
<ol>
<li>å¦‚æœterm &lt; currentTermï¼Œå³é¢†å¯¼äººçš„ä»»æœŸå·å°äºFolloweræœ¬åœ°ç»´æŠ¤çš„å½“å‰ä»»æœŸå·ï¼Œåˆ™è¿”å› (currentTerm, false)ï¼Œå¦åˆ™ç»§ç»­æ­¥éª¤2ã€‚</li>
<li>å¦‚æœFolloweråœ¨prevLogIndexä½ç½®çš„æ—¥å¿—çš„ä»»æœŸå·ä¸prevLogTermä¸åŒ¹é…ï¼Œåˆ™è¿”å› (term, false)ï¼Œå¦åˆ™ç»§ç»­æ­¥éª¤3ã€‚</li>
<li>Followerè¿›è¡Œæ—¥å¿—ä¸€è‡´æ€§æ£€æŸ¥ã€‚</li>
<li>æ·»åŠ ä»»ä½•åœ¨å·²æœ‰çš„æ—¥å¿—ä¸­ä¸å­˜åœ¨çš„æ¡ç›®ï¼Œåˆ é™¤å¤šä½™çš„æ¡ç›®ã€‚</li>
<li>å¦‚æœleaderCommit &gt; commiIndexï¼Œåˆ™å°†commitIndex ï¼ˆFollowerè‡ªå·±ç»´æŠ¤çš„æœ¬åœ°å·²æäº¤çš„æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼ï¼‰æ›´æ–°ä¸ºmin{leaderCommit, Followeræœ¬åœ°æœ€æ–°æ—¥å¿—æ¡ç›®ç´¢å¼•}ã€‚å³ä¿¡ä»»Leaderçš„æ•°æ®ï¼Œä¹è§‚åœ°å°†æœ¬åœ°å·²æäº¤æ—¥å¿—çš„ç´¢å¼•å€¼è·ƒè¿›é¢†å¯¼äººä¸ºè¯¥Followerè·Ÿè¸ªè®°å½•çš„é‚£ä¸ªå€¼ï¼ˆé™¤éleaderCommitæ¯”æœ¬åœ°æœ€æ–°çš„æ—¥å¿—æ¡ç›®ç´¢å¼•å€¼è¿˜è¦å¤§ï¼‰ã€‚è¿™ç§åœºæ™¯é€šå¸¸å‘ç”Ÿåœ¨Followeråˆšä»æ•…éšœä¸­æ¢å¤è¿‡æ¥çš„åœºæ™¯ã€‚</li>
</ol>
<h3 id="å®‰å…¨æ€§Q-amp-A"><a href="#å®‰å…¨æ€§Q-amp-A" class="headerlink" title="å®‰å…¨æ€§Q&amp;A"></a>å®‰å…¨æ€§Q&amp;A</h3><p>å‰é¢è®¨è®ºäº†Raftç®—æ³•çš„æ˜¯å¦‚ä½•è¿›è¡Œé¢†å¯¼äººé€‰ä¸¾å’Œæ—¥å¿—å¤åˆ¶çš„ã€‚ç„¶åï¼Œåˆ°ç›®å‰ä¸ºæ­¢è¿™ä¸ªæœºåˆ¶è¿˜ä¸èƒ½ä¿è¯æ¯ä¸€ä¸ªçŠ¶æ€æœºéƒ½èƒ½æŒ‰ç…§ç›¸åŒçš„é¡ºåºæ‰§è¡ŒåŒæ ·çš„æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼Œå½“é¢†å¯¼äººæ­£åœ¨å¤åˆ¶æ—¥å¿—æ¡ç›®æ—¶ä¸€ä¸ªFollowerå‘ç”Ÿäº†æ•…éšœï¼Œä¸”æ•…éšœå‘ç”Ÿä¹‹å‰æ²¡æœ‰å¤åˆ¶é¢†å¯¼äººçš„æ—¥å¿—ï¼Œä¹‹åè¯¥Followeré‡å¯å¹¶ä¸”å½“é€‰ä¸ºé¢†å¯¼äººï¼Œé‚£ä¹ˆå®ƒåœ¨äº§ç”Ÿäº†ä¸€äº›æ–°çš„æ—¥å¿—æ¡ç›®åï¼Œä¼šç”¨è‡ªå·±çš„æ—¥å¿—è¦†ç›–æ‰å…¶ä»–èŠ‚ç‚¹çš„æ—¥å¿—ï¼Œè¿™å°±å¯¼è‡´ä¸åŒçš„çŠ¶æ€æœºå¯èƒ½æ‰§è¡Œä¸åŒçš„æŒ‡ä»¤åºåˆ—ã€‚</p>
<p>ä¸‹é¢å°†ä»‹ç»å¦‚ä½•åœ¨é¢†å¯¼äººé€‰ä¸¾éƒ¨åˆ†åŠ å…¥ä¸€ä¸ªé™åˆ¶è§„åˆ™æ¥ä¿è¯â€”â€”ä»»ä½•çš„é¢†å¯¼äººéƒ½æ‹¥æœ‰ä¹‹å‰ä»»æœŸçš„å…¨éƒ¨æ—¥å¿—æ¡ç›®ã€‚æœ‰äº†è¿™ä¸€é™åˆ¶ï¼Œå°±ä¸ä¼šä¸Šè¿°ä¾‹å­æ‰€æè¿°çš„æƒ…å½¢äº†ã€‚</p>
<p>Q: æ€æ ·æ‰èƒ½å…·æœ‰ç§°ä¸ºé¢†å¯¼äººçš„èµ„æ ¼ï¼Ÿ</p>
<p>A: åœ¨æ‰€æœ‰ä»¥é¢†å¯¼äººé€‰ä¸¾ä¸ºåŸºç¡€çš„ä¸€è‡´æ€§ç®—æ³•ä¸­ï¼Œé¢†å¯¼äººæœ€ç»ˆå¿…é¡»è¦å­˜å‚¨å…¨éƒ¨å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚åœ¨ä¸€äº›ä¸€è‡´æ€§ç®—æ³•ä¸­ï¼Œä¾‹å¦‚ï¼ŒViewstamped Replicationä¸­ï¼Œå³æ—¶ä¸€å¼€å§‹æ²¡æœ‰åŒ…å«å…¨éƒ¨å·²æäº¤çš„æ¡ç›®ä¹Ÿå¯ä»¥å½“é€‰ä¸ºé¢†å¯¼äººã€‚è¿™äº›ç®—æ³•éƒ½åŒ…å«ä¸€äº›å¦å¤–çš„æœºåˆ¶æ¥ä¿è¯æ‰¾åˆ°ä¸¢å¤±çš„æ¡ç›®å¹¶å°†å®ƒä»¬ä¼ è¾“ç»™æ–°çš„é¢†å¯¼äººï¼Œè¿™ä¸ªè¿‡ç¨‹è¦ä¹ˆåœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­å®Œæˆï¼Œè¦ä¹ˆåœ¨é€‰ä¸¾ä¹‹åç«‹å³å¼€å§‹ã€‚æ¯«æ— ç–‘é—®çš„æ˜¯ï¼Œè¿™ç§æ–¹å¼æ˜¾è‘—å¢åŠ äº†ç®—æ³•çš„å¤æ‚æ€§ã€‚</p>
<p>Raftç®—æ³•ä½¿ç”¨çš„æ˜¯ä¸€ç§æ›´ç®€å•çš„æ–¹å¼æ¥ä¿è¯æ–°å½“é€‰çš„é¢†å¯¼äººï¼Œä¹‹å‰ä»»æœŸå·²æäº¤çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®éƒ½å·²ç»å‡ºç°åœ¨äº†ä¸Šé¢ï¼Œè€Œä¸éœ€è¦å°†è¿™äº›æ¡ç›®ä¼ é€ç»™æ–°é¢†å¯¼äººã€‚è¿™ç§æ–¹å¼éšå«äº†ä»¥ä¸‹ä¸¤ç‚¹å†…å®¹ï¼š</p>
<ul>
<li>æ²¡æœ‰åŒ…å«æ‰€æœ‰å·²æäº¤æ—¥å¿—æ¡ç›®çš„èŠ‚ç‚¹æˆä¸ºä¸äº†é¢†å¯¼äººã€‚</li>
<li>æ—¥å¿—æ¡ç›®åªæœ‰ä¸€ä¸ªæµå‘ï¼šä»Leaderæµå‘Followerã€‚é¢†å¯¼äººæ°¸è¿œä¸ä¼šè¦†ç›–å·²ç»å­˜åœ¨çš„æ—¥å¿—æ¡ç›®ã€‚</li>
</ul>
<p>Raftç®—æ³•ä½¿ç”¨æŠ•ç¥¨çš„æ–¹å¼æ¥é˜»æ­¢é‚£äº›æ²¡æœ‰åŒ…å«æ‰€æœ‰å·²æäº¤æ—¥å¿—æ¡ç›®çš„èŠ‚ç‚¹èµ¢å¾—é€‰ä¸¾ã€‚ä¸€ä¸ªå€™é€‰äººä¸ºäº†èµ¢å¾—é€‰ä¸¾å¿…é¡»è¦ä¸é›†ç¾¤ä¸­çš„å¤§å¤šæ•°èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ï¼Œè¿™å°±æ„å‘³ç€æ¯ä¸€æ¡å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®éƒ½ä¼šå‡ºç°åœ¨è‡³å°‘å…¶ä¸­ä¸€ä¸ªä¸ä¹‹é€šä¿¡çš„èŠ‚ç‚¹ä¸Šã€‚å¦‚æœå€™é€‰äººçš„æ—¥å¿—æ¯”é›†ç¾¤å†…çš„å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šçš„æ—¥å¿—æ›´åŠ æ–°ï¼ˆæˆ–è‡³å°‘ä¸€æ ·æ–°ï¼‰ï¼Œé‚£ä¹ˆå®ƒä¸€å®šåŒ…å«æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—æ¡ç›®ã€‚å› æ­¤ï¼ŒRequestVote RPCçš„æ¥æ”¶æ–¹æœ‰ä¸€ä¸ªæ£€æŸ¥ï¼šå¦‚æœä»–è‡ªå·±çš„æ—¥å¿—æ¯”RPCè°ƒç”¨æ–¹ï¼ˆå€™é€‰äººï¼‰çš„æ—¥å¿—æ›´åŠ æ–°ï¼Œå°±ä¼šæ‹’ç»å€™é€‰äººçš„æŠ•ç¥¨è¯·æ±‚ã€‚</p>
<p>é‚£ä¹ˆï¼Œå¦‚ä½•æ¯”è¾ƒä¸¤ä»½æ—¥å¿—å“ªä¸ªæ›´åŠ æ–°å‘¢ï¼Ÿæ¯”è¾ƒçš„ä¾æ®æ˜¯æ—¥å¿—æ–‡ä»¶ä¸­æœ€åä¸€ä¸ªæ¡ç›®çš„ç´¢å¼•å’Œä»»æœŸå·ï¼šå¦‚æœä¸¤ä¸ªæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·ä¸åŒï¼Œåˆ™ä»»æœŸå·å¤§çš„æ›´åŠ æ–°ï¼›å¦‚æœä»»æœŸå·ç›¸åŒï¼Œåˆ™ç´¢å¼•å€¼æ›´å¤§ï¼ˆå³æ—¥å¿—æ–‡ä»¶æ¡ç›®æ›´å¤šï¼‰çš„æ—¥å¿—æ›´åŠ æ–°ã€‚</p>
<p>Q: å¦‚ä½•åˆ¤æ–­æ—¥å¿—å·²ç»æäº¤ï¼Ÿ</p>
<p>A: é¢†å¯¼äººå½“å‰ä»»æœŸçš„æŸæ¡æ—¥å¿—æ¡ç›®åªè¦å­˜å‚¨åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œå°±è®¤ä¸ºè¯¥æ—¥å¿—è®°å½•å·²ç»è¢«æäº¤ï¼ˆcommitedï¼‰äº†ã€‚å¦‚æœé¢†å¯¼äººåœ¨æäº¤æŸä¸ªæ—¥å¿—æ¡ç›®ä¹‹å‰å´©æºƒäº†ï¼Œé‚£ä¹ˆæœªæ¥åç»§çš„é¢†å¯¼äººä¼šè®©å…¶ä»–èŠ‚ç‚¹ç»§ç»­å¤åˆ¶è¿™ä¸ªæ—¥å¿—æ¡ç›®ã€‚</p>
<p>ç„¶åï¼Œä¸€ä¸ªé¢†å¯¼äººä¸èƒ½å› ä¸ºç”±ä¹‹å‰é¢†å¯¼äººåˆ›å»ºï¼ˆå³ä¹‹å‰ä»»æœŸï¼‰çš„æŸæ¡æ—¥å¿—å­˜å‚¨åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šäº†ï¼Œå°±ç¬ƒå®šè¯¥æ—¥å¿—æ¡ç›®å·²ç»è¢«æäº¤äº†ã€‚å›¾4ä¸­çš„æ—¶åºa~då°±å±•ç¤ºäº†è¿™ç§æƒ…å†µï¼Œä¸€æ¡å·²ç»è¢«å­˜å‚¨åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šçš„æ—¥å¿—æ¡ç›®ï¼Œä¹Ÿä¾ç„¶æœ‰å¯èƒ½è¢«æœªæ¥çš„é¢†å¯¼äººè¦†ç›–æ‰ã€‚</p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾5. Raftç®—æ³•æŸä¸€æ—¶åˆ»æ—¥å¿—çŠ¶æ€å›¾</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/log-status.png" class="" title="log-status">

<br />

<p>æ—¶åˆ»aï¼ŒS1æ˜¯ä»»æœŸ2çš„é¢†å¯¼äººå¹¶ä¸”å‘éƒ¨åˆ†èŠ‚ç‚¹ï¼ˆS1å’ŒS2ï¼‰å¤åˆ¶äº†2å·ä½ç½®çš„æ—¥å¿—æ¡ç›®ï¼Œç„¶åå®•æœºã€‚</p>
<p>æ—¶åˆ»bï¼ŒS5è·å¾—äº†S3ã€S4ï¼ˆS5çš„æ—¥å¿—ä¸S3å’ŒS4çš„ä¸€æ ·æ–°ï¼Œæœ€æ–°çš„æ—¥å¿—çš„ä»»æœŸå·éƒ½æ˜¯1ï¼‰å’Œè‡ªå·±çš„é€‰ç¥¨èµ¢å¾—äº†é€‰ä¸¾ï¼Œæˆäº†3å·ä»»æœŸçš„é¢†å¯¼äººï¼Œå¹¶ä¸”åœ¨2å·ä½ç½®ä¸Šå†™å…¥äº†ä¸€æ¡ä»»æœŸå·ä¸º3æ—¥å¿—æ¡ç›®ã€‚åœ¨æ–°æ—¥å¿—å¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹ä¹‹å‰ï¼ŒS5å®•æœºäº†ã€‚</p>
<p>æ—¶åˆ»cï¼ŒS1é‡å¯ï¼Œå¹¶ä¸”é€šè¿‡S2ã€S3ã€S4å’Œè‡ªå·±çš„é€‰ç¥¨èµ¢å¾—äº†é€‰ä¸¾ï¼Œæˆäº†4å·ä»»æœŸçš„é¢†å¯¼äººï¼Œå¹¶ä¸”ç»§ç»­å‘S3å¤åˆ¶2å·ä½ç½®çš„æ—¥å¿—ã€‚æ­¤æ—¶ï¼Œä»»æœŸ2çš„æ—¥å¿—æ¡ç›®å·²ç»åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šå®Œæˆäº†å¤åˆ¶ã€‚</p>
<p>æ—¶åˆ»dï¼ŒS1å‘ç”Ÿæ•…éšœï¼ŒS5é€šè¿‡S2ã€S3ã€S4çš„é€‰ç¥¨å†æ¬¡æˆä¸ºé¢†å¯¼äººï¼ˆå› ä¸ºS5æœ€åä¸€æ¡æ—¥å¿—çš„ä»»æœŸå·æ˜¯3ï¼Œæ¯”S2ã€S3ã€è¯´ä¸­ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„æ—¥å¿—éƒ½æ›´åŠ æ–°ï¼‰ï¼Œä»»æœŸå·ä¸º5ã€‚ç„¶åS5ç”¨è‡ªå·±çš„æœ¬åœ°æ—¥å¿—è¦†å†™äº†å…¶ä»–èŠ‚ç‚¹ä¸Šçš„æ—¥å¿—ã€‚</p>
<p>è¿™ä¸ªä¾‹å­è¯´æ˜ï¼Œå³æ—¶æ—¥å¿—æ¡ç›®è¢«åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹å†™ç›˜ï¼ˆå¤åˆ¶ï¼‰äº†ï¼Œä¹Ÿå¹¶ä¸ä»£è¡¨å®ƒå·²ç»è¢«æäº¤ï¼ˆcommitedï¼‰åˆ°Rafté›†ç¾¤äº†â€”â€”å› ä¸ºä¸€æ—¦æŸæ¡æ—¥å¿—è¢«æäº¤ï¼Œé‚£ä¹ˆå®ƒå°†æ°¸è¿œæ²¡æ³•è¢«åˆ é™¤æˆ–ä¿®æ”¹ã€‚è¿™ä¸ªä¾‹å­åŒæ—¶ä¹Ÿè¯´æ˜äº†ï¼Œé¢†å¯¼äººæ— æ³•å•çº¯åœ°ä¾é ä¹‹å‰ä»»æœŸçš„æ—¥å¿—æ¡ç›®ä¿¡æ¯åˆ¤æ–­å®ƒçš„æäº¤çŠ¶æ€ã€‚</p>
<p>å› æ­¤ï¼Œé’ˆå¯¹ä»¥ä¸Šåœºæ™¯ï¼ŒRaftç®—æ³•å¯¹æ—¥å¿—æäº¤æ¡ä»¶å¢åŠ äº†ä¸€ä¸ªé¢å¤–çš„é™åˆ¶ï¼Œè¦æ±‚Leaderåœ¨å½“å‰ä»»æœŸè‡³å°‘æœ‰ä¸€æ¡æ—¥å¿—è¢«æäº¤ï¼Œå³è¢«è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹å†™ç›˜ã€‚</p>
<p>æ­£å¦‚å›¾5æ—¶åˆ»eæè¿°çš„é‚£æ ·ï¼ŒS1ä½œä¸ºLeaderï¼Œåœ¨å´©æºƒä¹‹å‰ï¼Œå°†3å·ä½ç½®çš„æ—¥å¿—ï¼ˆä»»æœŸå·ä¸º4ï¼‰åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šå¤åˆ¶äº†ä¸€æ¡æ—¥å¿—æ¡ç›®ï¼ˆæ¡ç›®3ï¼Œä»»æœŸ4ï¼‰ï¼Œé‚£ä¹ˆå³ä½¿è¿™æ—¶S1å®•æœºäº†ï¼ŒS5ä¹Ÿä¸å¯èƒ½èµ¢å¾—é€‰ä¸¾â€”â€”å› ä¸ºS2å’ŒS3çš„æœ€æ–°æ—¥å¿—æ¡ç›®çš„ä»»æœŸå·ä¸º4ï¼Œæ¯”S5çš„è¦å¤§ï¼ŒS5æ— æ³•è·å¾—è¶…è¿‡åŠæ•°çš„é€‰ç¥¨ï¼ŒS5æ— æ³•èµ¢å¾—é€‰ä¸¾ï¼Œè¿™å°±æ„å‘³ç€2å·ä½ç½®çš„æ—¥å¿—æ¡ç›®ä¸ä¼šè¢«è¦†å†™ã€‚</p>
<p>å°†ä¸Šé¢çš„æè¿°è¿›è¡Œå½’çº³ï¼Œå¯ä»¥æ€»ç»“ä¸ºä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>åªè¦ä¸€ä¸ªæ—¥å¿—æ¡ç›®è¢«å­˜åœ¨äº†å¤§å¤šæ•°çš„æœåŠ¡å™¨ä¸Šï¼Œé¢†å¯¼äººå°±çŸ¥é“å½“å‰ä»»æœŸå¯ä»¥æäº¤è¯¥æ¡ç›®äº†ã€‚</li>
<li>å¦‚æœé¢†å¯¼äººåœ¨æäº¤æ—¥å¿—ä¹‹å‰å°±å´©æºƒäº†ï¼Œä¹‹åçš„é¢†å¯¼äººä¼šè¯•ç€ç»§ç»­å®Œæˆå¯¹æ—¥å¿—çš„å¤åˆ¶ã€‚ä½†æ˜¯ï¼Œæ–°é¢†å¯¼äººæ— æ³•æ–­å®šå­˜å‚¨åœ¨å¤§å¤šæ•°æœåŠ¡å™¨ä¸Šçš„æ—¥å¿—æ¡ç›®ä¸€å®šåœ¨ä¹‹å‰çš„ä»»æœŸä¸­è¢«æäº¤äº†ï¼ˆå³æ—¶æ—¥å¿—ä¿å­˜åœ¨å¤§å¤šæ•°çš„æœåŠ¡å™¨ä¸Šï¼Œä¹Ÿæœ‰å¯èƒ½æ²¡æ¥å¾—åŠæäº¤ï¼‰ã€‚</li>
</ul>
<div class="note icon simple"><i class="note-icon fab fa-korvue"></i><p><strong>å…³äºçŠ¶æ€æœºå®‰å…¨æ€§çš„ä¸‰æ®µè®ºè¯æ˜</strong></p>
<p>å®šä¹‰ï¼šAä¸ºä¸Šä¸ªä»»æœŸæœ€åä¸€æ¡å·²æäº¤æ—¥å¿—ï¼ŒBä¸ºå½“å‰ä»»æœŸçš„Leader</p>
<ol>
<li><strong>å› ä¸º</strong> Aå¿…ç„¶åŒæ­¥åˆ°äº†é›†ç¾¤ä¸­çš„åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹</li>
<li><strong>åˆå› ä¸º</strong> Båªæœ‰è·å¾—é›†ç¾¤ä¸­åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹çš„é€‰ç¥¨æ‰èƒ½æˆä¸ºLeader</li>
<li><strong>æ‰€ä»¥</strong> Bçš„é€‰æ°‘ä¸­å¿…ç„¶å­˜åœ¨æ‹¥æœ‰Aæ—¥å¿—çš„èŠ‚ç‚¹</li>
<li><strong>åˆå› ä¸º</strong> é€‰ä¸¾é™åˆ¶ï¼ŒBæˆä¸ºLeaderçš„å‰ææ˜¯æ¯”ç»™å®ƒæŠ•ç¥¨çš„æ‰€æœ‰é€‰æ°‘éƒ½è¦æ–°</li>
<li><strong>æ‰€ä»¥</strong> Bçš„æ—¥å¿—ä¸­å¿…ç„¶è¦åŒ…å«A</li>
<li><strong>åˆå› ä¸º</strong> æ—¥å¿—å®Œå…¨åŒ¹é…è§„åˆ™ï¼Œå¦‚æœAè¢«BåŒ…å«ï¼Œé‚£ä¹ˆæ¯”Aå°çš„æ‰€ä»¥æ—¥å¿—éƒ½è¢«BåŒ…å«</li>
<li><strong>å› ä¸º</strong> lastApplied &lt;= commitIndex</li>
<li><strong>åˆå› ä¸º</strong> Raftä¿è¯å·²æäº¤æ—¥å¿—åœ¨æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹ä¸Šçš„é¡ºåºä¸€è‡´</li>
<li><strong>æ‰€ä»¥</strong> åº”ç”¨æ—¥å¿—å¿…ç„¶åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šé¡ºåºä¸€è‡´</li>
<li><strong>å› ä¸º</strong> çŠ¶æ€æœºåªèƒ½æŒ‰åºæ‰§è¡Œåº”ç”¨æ—¥å¿—éƒ¨åˆ†</li>
<li><strong>å¾—è¯</strong> çŠ¶æ€æœºåœ¨æ•´ä¸ªé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ä¸Šå¿…ç„¶æœ€ç»ˆä¸€è‡´</li>
</ol>
</div>



<h2 id="å¯ç”¨æ€§ä¸æ—¶åº"><a href="#å¯ç”¨æ€§ä¸æ—¶åº" class="headerlink" title="å¯ç”¨æ€§ä¸æ—¶åº"></a>å¯ç”¨æ€§ä¸æ—¶åº</h2><p>æˆ‘ä»¬å¯¹åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•çš„è¦æ±‚ä¹‹ä¸€å°±æ˜¯ä¸ä¾èµ–äºæ—¶åºï¼ˆtimingï¼‰â€”â€”ç³»ç»Ÿä¸èƒ½ä»…ä»…å› ä¸ºæŸäº›äº‹ä»¶å‘ç”Ÿå¾—æ¯”é¢„æƒ³çš„å¿«ä¸€äº›æˆ–æ…¢ä¸€äº›å°±äº§ç”Ÿé”™è¯¯ã€‚ç„¶è€Œï¼Œå¯ç”¨æ€§ï¼ˆç³»ç»ŸåŠå“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼‰ä¸å¯é¿å…åœ°è¦ä¾èµ–æ—¶åºã€‚ä»ä¸Šé¢çš„æè¿°ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ²¡æœ‰ä¸€ä¸ªç¨³å®šçš„é¢†å¯¼äººï¼ŒRaftç®—æ³•å°†æ— æ³•å·¥ä½œï¼ˆè‡³å°‘æ²¡æ³•æ¥å—å®¢æˆ·ç«¯çš„å†™è¯·æ±‚ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœæ¶ˆæ¯äº¤æ¢å‘ç”Ÿåœ¨æœåŠ¡å™¨å´©æºƒæ—¶ï¼Œåˆ™éœ€è¦èŠ±è´¹æ›´å¤šçš„æ—¶é—´ï¼Œè€Œå€™é€‰äººä¸ä¼šç­‰å¾…å¤ªé•¿çš„æ—¶é—´æ¥èµ¢å¾—é€‰ä¸¾ã€‚</p>
<p>é¢†å¯¼äººé€‰å–æ˜¯Raftç®—æ³•ä¸­å¯¹æ—¶åºè¦æ±‚æœ€å¤šçš„åœ°æ–¹ã€‚åªæœ‰å½“ç³»ç»Ÿç¯å¢ƒæ»¡è¶³ä»¥ä¸‹æ—¶åºè¦æ±‚æ—¶ï¼ŒRaftç®—æ³•æ‰èƒ½é€‰ä¸¾å¹¶ä¸”ä¿æŒä¸€ä¸ªç¨³å®šçš„é¢†å¯¼äººå­˜åœ¨ï¼š</p>
<center>
    <font face="Kristen ITC" color="#555555" size=3>broadcastTime << electionTimeout < MTBF</font><br>
</center>

<p>åœ¨ä»¥ä¸Šä¸ç­‰å¼ä¸­ï¼Œå„ä¸ªæ—¶é—´å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>broadcastTimeï¼š ä¸€ä¸ªèŠ‚ç‚¹å‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘é€RPCï¼Œå¹¶ä¸”æ”¶åˆ°å®ƒä»¬å“åº”çš„å¹³å‡æ—¶é—´ã€‚</li>
<li>electionTimeoutï¼šé€‰ä¸¾è¶…æ—¶æ—¶é—´ã€‚</li>
<li>MTBFï¼šå•ä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœçš„å¹³å‡æ—¶é—´é—´éš”ã€‚</li>
</ul>
<p>ä¸ºäº†ä½¿é¢†å¯¼äººèƒ½å¤ŸæŒç»­å‘é€å¿ƒè·³åŒ…æ¥é˜»æ­¢ä¸‹é¢çš„Followerå‘èµ·é€‰ä¸¾ï¼ŒbroadcastTimeåº”è¯¥æ¯”electionTimeoutå°ä¸€ä¸ªæ•°é‡çº§ã€‚æ ¹æ®å·²ç»ç»™å‡ºçš„éšæœºåŒ–é€‰ä¸¾è¶…æ—¶æ—¶é—´æ–¹æ³•ï¼Œè¿™ä¸ªä¸ç­‰å¼ä¹Ÿæ˜¾è‘—é™ä½äº†é€‰ç¥¨ç“œåˆ†çš„æ¦‚ç‡ã€‚ä¸ºäº†ä½¿å¾—ç³»ç»Ÿç¨³å®šè¿è¡Œï¼Œelectionä¹Ÿåº”è¯¥æ¯”MTBFå°å‡ ä¸ªæ•°é‡çº§ã€‚å½“é¢†å¯¼äººå‡ºç°æ•…éšœä¸”åœ¨æ–°çš„é¢†å¯¼äººé€‰ä¸¾å‡ºæ¥ä¹‹å‰ï¼Œç³»ç»Ÿå¯¹å¤–å°†ä¸å¯ç”¨ï¼Œè¿™ä¸ªæ—¶é•¿å¤§çº¦ä¸ºelectionTimeoutã€‚</p>
<p>broadcastTimeå’ŒMTBFä¸ç³»ç»Ÿç¯å¢ƒæ¯æ¯ç›¸å…³ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé…ç½®electionTimeoutçš„å€¼ã€‚ä¸€æ¬¡Raftç®—æ³•çš„RPCçš„å®Œæˆéœ€è¦æ¥æ”¶æ–¹å°†ä¿¡æ¯æŒä¹…åŒ–åˆ°å­˜å‚¨ä¸­å»ã€‚æ‰€ä»¥å¹¿æ’­æ—¶é—´æ˜¯ç½‘ç»œä¼ è¾“æ—¶å»¶ä¸å­˜å‚¨å†™å…¥æ—¶å»¶çš„æ€»å’Œï¼Œä¸€èˆ¬åœ¨å‡ æ¯«ç§’åˆ°å‡ åæ¯«ç§’ä¹‹é—´ã€‚å› æ­¤ï¼Œé€šå¸¸å°†electionTimeoutè®¾ç½®åœ¨10msåˆ°500msä¹‹é—´ã€‚å¤§å¤šæ•°çš„æœåŠ¡å™¨çš„MTBFéƒ½åœ¨å‡ ä¸ªæœˆç”šè‡³æ›´é•¿çš„æ—¶é—´é‡Œï¼Œå› æ­¤å¾ˆå®¹æ˜“æ»¡è¶³è¿™ä¸ªæ—¶åºè¦æ±‚ã€‚</p>
<h2 id="å¼‚å¸¸æƒ…å†µ"><a href="#å¼‚å¸¸æƒ…å†µ" class="headerlink" title="å¼‚å¸¸æƒ…å†µ"></a>å¼‚å¸¸æƒ…å†µ</h2><p>ä¸€ä¸ªRaftç³»ç»Ÿçš„å¼‚å¸¸æƒ…å†µé€šå¸¸å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šLeaderå¼‚å¸¸å’ŒFollowe/Candidateå¼‚å¸¸ã€‚</p>
<p>Follower/Candidateå¼‚å¸¸é—®é¢˜çš„è§£å†³æ–¹æ³•è¦æ¯”Leaderå¼‚å¸¸ç®€å•å¾—å¤šã€‚å¦‚æœä¸€ä¸ªFolloweræˆ–è€…Candidateå´©æºƒäº†ï¼Œé‚£ä¹ˆé¢†å¯¼äººåœ¨è¿™ä¹‹åå‘é€ç»™ä»–ä»¬çš„RequestVote RPCå’ŒAppendEntries RPCå°±ä¼šå¤±è´¥ã€‚Raftç®—æ³•é€šè¿‡Leaderæ— é™çš„é‡è¯•è¦åº”å¯¹è¿™äº›å¤±è´¥ï¼Œç›´åˆ°æ•…éšœçš„èŠ‚ç‚¹é‡å¯å¹¶å¤„ç†äº†è¿™äº›RPCä¸ºæ­¢ã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹åœ¨æ”¶åˆ°RPCä¹‹åä½†åœ¨å“åº”ä¹‹å‰å´©æºƒäº†ï¼Œé‚£ä¹ˆå®ƒä¼šåœ¨é‡å¯ä¹‹åå†æ¬¡æ”¶åˆ°åŒä¸€ä¸ªRPCã€‚å› ä¸ºRaftç®—æ³•ä¸­çš„RPCéƒ½æ˜¯å¹‚ç­‰çš„ï¼Œå› æ­¤ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªFolloweræ”¶åˆ°äº†å·²ç»åŒ…å«åœ¨å…¶æ—¥å¿—ä¸­çš„AppendEntries RPCï¼Œé‚£ä¹ˆå®ƒä¼šå¿½ç•¥æœ¬æ¬¡è¯·æ±‚ã€‚</p>
<p>ç”±äºRaftç®—æ³•æ˜¯å¼ºé¢†å¯¼äººç‰¹æ€§çš„ï¼Œå› æ­¤ä¿è¯é¢†å¯¼äººå³æ—¶å‡ºç°æ•…éšœä¹Ÿä¸å½±å“æ•°æ®ä¸€è‡´æ€§å°±æ˜¾å¾—æ ¼å¤–é‡è¦ã€‚</p>
<p>æ•°æ®æäº¤çš„å…¨è¿‡ç¨‹ï¼Œå¦‚å›¾6æ‰€ç¤ºã€‚</p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾6. Raftç®—æ³•æ•°æ®äº¤æ¢ç¤ºæ„å›¾</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/data-exchange.svg" class="" title="data-exchange"><br />

<p>å›¾6ä¸­ï¼Œæ•°æ®çš„æµå‘åªèƒ½ä»LeaderèŠ‚ç‚¹å‘FollowerèŠ‚ç‚¹è½¬ç§»ã€‚å½“Clientå‘é›†ç¾¤LeaderèŠ‚ç‚¹æäº¤æ•°æ®æ—¶ï¼ŒLeaderèŠ‚ç‚¹æ¥æ”¶åˆ°çš„æ•°æ®å¤„äºæœªæäº¤çŠ¶æ€ï¼ˆUncommittedï¼‰ï¼Œæ¥ç€LeaderèŠ‚ç‚¹ä¼šå¹¶å‘å‘æ‰€æœ‰FollowerèŠ‚ç‚¹å¤åˆ¶æ•°æ®å¹¶ç­‰å¾…å“åº”ï¼Œåœ¨ç¡®ä¿é›†ç¾¤ä¸­è‡³å°‘æœ‰è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹å·²ç»æ¥æ”¶åˆ°æ•°æ®ä¹‹åï¼Œå†å‘Clientç¡®è®¤æ•°æ®å·²æ¥æ”¶ã€‚ä¸€æ—¦LeaderèŠ‚ç‚¹å‘Clientå‘å‡ºæ•°æ®æ¥æ”¶ACKå“åº”ä¹‹åï¼Œå³è¡¨æ˜æ­¤æ—¶æ•°æ®çŠ¶æ€è¿›å…¥å·²æäº¤ï¼ˆCommittedï¼‰çŠ¶æ€ï¼ŒLeaderèŠ‚ç‚¹ä¼šå†æ¬¡å‘FollowerèŠ‚ç‚¹å‘é€é€šçŸ¥ï¼Œå‘ŠçŸ¥è¯¥æ•°æ®çŠ¶æ€å·²æäº¤ã€‚</p>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œé¢†å¯¼äººå¯èƒ½ä¼šåœ¨ä»»æ„é˜¶æ®µå´©æºƒï¼Œä¸‹é¢å°†æ³¨æ„å¸ˆèŒƒRaftç®—æ³•åœ¨å„ä¸ªåœºæ™¯ä¸‹æ˜¯å¦‚ä½•ä¿éšœæ•°æ®ä¸€è‡´æ€§çš„ã€‚</p>
<p><strong>ï¼ˆ1ï¼‰æ•°æ®åˆ°è¾¾Leaderå‰</strong></p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾7. æ•°æ®åˆ°è¾¾Leaderä¹‹å‰</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/raft-exception1.svg" class="" title="raft-exception1"><br />

<p>è¿™ä¸ªé˜¶æ®µé¢†å¯¼äººå‡ºç°æ•…éšœä¸ä¼šå½±å“æ•°æ®ä¸€è‡´æ€§ã€‚</p>
<p><strong>ï¼ˆ2ï¼‰æ•°æ®åˆ°è¾¾LeaderèŠ‚ç‚¹ï¼Œä½†æœªå¤åˆ¶åˆ°FollowerèŠ‚ç‚¹</strong></p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾8. æ•°æ®åˆ°è¾¾LeaderèŠ‚ç‚¹ï¼Œä½†æœªå¤åˆ¶åˆ°FollowerèŠ‚ç‚¹</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/raft-exception2.svg" class="" title="raft-exception2"><br />

<p>å¦‚æœåœ¨è¿™ä¸ªé˜¶æ®µLeaderå‡ºç°æ•…éšœï¼Œæ­¤æ—¶æ•°æ®å±äºæœªæäº¤çŠ¶æ€ï¼Œé‚£ä¹ˆClientä¸ä¼šæ”¶åˆ°ACKï¼Œè€Œæ˜¯ä¼šè®¤ä¸ºè¶…æ—¶å¤±è´¥å¯å®‰å…¨å‘èµ·é‡è¯•ã€‚FollowerèŠ‚ç‚¹ä¸Šæ²¡æœ‰è¯¥æ•°æ®ï¼Œé‡æ–°é€‰ä¸»åClienté‡è¯•é‡æ–°æäº¤å¯æˆåŠŸã€‚åŸæ¥çš„LeaderèŠ‚ç‚¹å›å¤ä¹‹åå°†ä½œä¸ºFolloweråŠ å…¥é›†ç¾¤ï¼Œé‡æ–°ä»å½“å‰ä»»æœŸçš„å¿ƒLeaderå¤„åŒæ­¥æ•°æ®ï¼Œä¸Leaderæ•°æ®å¼ºåˆ¶ä¿æŒä¸€è‡´ã€‚</p>
<p><strong>ï¼ˆ3ï¼‰æ•°æ®åˆ°è¾¾LeaderèŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ°Followerçš„éƒ¨åˆ†èŠ‚ç‚¹ä¸Šï¼Œä½†è¿˜æœªå‘Leaderå“åº”æ¥æ”¶</strong></p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾9. æ•°æ®åˆ°è¾¾LeaderèŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ°Followerçš„éƒ¨åˆ†èŠ‚ç‚¹ä¸Šï¼Œä½†è¿˜æœªå‘Leaderå“åº”æ¥æ”¶</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/raft-exception3.svg" class="" title="raft-exception3"><br />

<p>å¦‚æœåœ¨è¿™ä¸ªé˜¶æ®µLeaderå‡ºç°æ•…éšœï¼Œæ­¤æ—¶æ•°æ®åœ¨FollowerèŠ‚ç‚¹å¤„äºæœªæäº¤çŠ¶æ€ï¼ˆUncommittedï¼‰ä¸”ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆRaftåè®®è¦æ±‚æŠ•ç¥¨åªèƒ½æŠ•ç»™æ‹¥æœ‰æœ€æ–°æ•°æ®çš„èŠ‚ç‚¹ã€‚æ‰€ä»¥æ‹¥æœ‰æœ€æ–°æ•°æ®çš„èŠ‚ç‚¹ä¼šè¢«é€‰ä¸ºLeaderï¼Œå†å°†æ•°æ®å¼ºåˆ¶åŒæ­¥åˆ°Followerï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±å¹¶ä¸”èƒ½å¤Ÿä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<p><strong>ï¼ˆ4ï¼‰æ•°æ®åˆ°è¾¾LeaderèŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ°Followerçš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šï¼Œä½†è¿˜æœªå‘Leaderå“åº”æ¥æ”¶</strong></p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾10. æ•°æ®åˆ°è¾¾LeaderèŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ°Followerçš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šï¼Œä½†è¿˜æœªå‘Leaderå“åº”æ¥æ”¶</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/raft-exception4.svg" class="" title="raft-exception4"><br />

<p>å¦‚æœåœ¨è¿™ä¸ªé˜¶æ®µLeaderå‡ºç°æ•…éšœï¼Œè™½ç„¶æ­¤æ—¶æ•°æ®åœ¨FollowerèŠ‚ç‚¹å¤„äºæœªæäº¤çŠ¶æ€ï¼ˆUncommittedï¼‰ï¼Œä½†ä¹Ÿèƒ½ä¿æŒä¸€è‡´ï¼Œé‚£ä¹ˆé‡æ–°é€‰å‡ºLeaderåå³å¯å®Œæˆæ•°æ®æäº¤ï¼Œç”±äºæ­¤æ—¶å®¢æˆ·ç«¯ä¸çŸ¥é“åˆ°åº•æœ‰æ²¡æœ‰æäº¤æˆåŠŸï¼Œå› æ­¤å¯é‡è¯•æäº¤ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼ŒRaftè¦æ±‚RPCè¯·æ±‚å®ç°å¹‚ç­‰æ€§ï¼Œä¹Ÿå°±æ˜¯è¦å®ç°å†…éƒ¨å»é‡æœºåˆ¶ã€‚</p>
<p><strong>ï¼ˆ5ï¼‰æ•°æ®åˆ°è¾¾LeaderèŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ°Followerçš„æ‰€æœ‰æˆ–å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œæ•°æ®åœ¨Leaderä¸Šå¤„äºå·²æäº¤çŠ¶æ€ï¼Œä½†åœ¨Followerä¸Šå¤„äºæœªæäº¤çŠ¶æ€</strong></p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾11. æ•°æ®åˆ°è¾¾LeaderèŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ°Followerçš„æ‰€æœ‰æˆ–å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œæ•°æ®åœ¨Leaderä¸Šå¤„äºå·²æäº¤çŠ¶æ€ï¼Œä½†åœ¨Followerä¸Šå¤„äºæœªæäº¤çŠ¶æ€</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/raft-exception5.svg" class="" title="raft-exception5"><br />

<p>å¦‚æœåœ¨è¿™ä¸ªé˜¶æ®µLeaderå‡ºç°æ•…éšœï¼Œé‚£ä¹ˆé‡æ–°é€‰å‡ºæ–°Leaderåçš„å¤„ç†æµç¨‹ä¸ï¼ˆ3ï¼‰ä¸€æ ·ã€‚</p>
<p><strong>ï¼ˆ6ï¼‰æ•°æ®åˆ°è¾¾LeaderèŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ°Followerçš„æ‰€æœ‰æˆ–å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œæ•°æ®åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½å¤„äºå·²æäº¤çŠ¶æ€ï¼Œä½†è¿˜æœªå“åº”Client</strong></p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾12. æ•°æ®åˆ°è¾¾LeaderèŠ‚ç‚¹ï¼ŒæˆåŠŸå¤åˆ¶åˆ°Followerçš„æ‰€æœ‰æˆ–å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œæ•°æ®åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½å¤„äºå·²æäº¤çŠ¶æ€ï¼Œä½†è¿˜æœªå“åº”Client</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/raft-exception6.svg" class="" title="raft-exception6"><br />

<p>å¦‚æœåœ¨è¿™ä¸ªé˜¶æ®µLeaderå‡ºç°æ•…éšœï¼Œæ­¤æ—¶é›†ç¾¤å†…éƒ¨æ•°æ®å…¶å®æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆClienté‡å¤é‡è¯•åŸºäºå¹‚ç­‰ç­–ç•¥å¯¹ä¸€è‡´æ€§æ— å½±å“ã€‚</p>
<p><strong>ï¼ˆ7ï¼‰ç½‘ç»œåˆ†åŒºå¯¼è‡´çš„é›†ç¾¤è„‘è£‚æƒ…å†µï¼Œå‡ºç°åŒLeader</strong></p>
<p>ç½‘ç»œåˆ†åŒºå°†åŸå…ˆçš„LeaderèŠ‚ç‚¹å’ŒFollowerèŠ‚ç‚¹åˆ†éš”å¼€ï¼ŒFolloweræ”¶ä¸åˆ°Leaderçš„å¿ƒè·³å°†å‘èµ·é€‰ä¸¾äº§ç”Ÿæ–°çš„Leaderã€‚è¿™æ˜¯å°±äº§ç”Ÿäº†åŒLeaderï¼ŒåŸå…ˆçš„Leaderç‹¬è‡ªåœ¨ä¸€ä¸ªåŒºï¼Œå‘å®ƒæäº¤æ•°æ®ä¸å¯èƒ½å¤åˆ¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥æ°¸è¿œéƒ½æ˜¯æäº¤ä¸æˆåŠŸã€‚å‘æ–°çš„Leaderæäº¤æ•°æ®å¯ä»¥æäº¤æˆåŠŸï¼Œç½‘ç»œæ¢å¤åæ—§çš„Leaderå‘ç°é›†ç¾¤ä¸­æœ‰æ›´æ–°ä»»æœŸï¼ˆTermï¼‰çš„æ–°Leaderï¼Œåˆ™è‡ªåŠ¨é™çº§ä¸ºFollowerå¹¶ä»æ–°Leaderå¤„åŒæ­¥æ•°æ®è¾¾æˆé›†ç¾¤æ•°æ®ä¸€è‡´ã€‚å…·ä½“æƒ…å½¢å¦‚å›¾13æ‰€ç¤ºã€‚</p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>å›¾13. ç½‘ç»œåˆ†åŒºå¯¼è‡´çš„é›†ç¾¤è„‘è£‚æƒ…å†µï¼Œå‡ºç°åŒLeader</font>
</center>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/raft-exception7.svg" class="" title="raft-exception7"><br />



<p>ä»¥ä¸Šä¸ƒç§åœºæ™¯ç©·ä¸¾äº†ä¸€ä¸ªä¸‰èŠ‚ç‚¹çš„æœ€å°é›†ç¾¤é¢ä¸´çš„æ‰€æœ‰å¼‚å¸¸æƒ…å†µï¼Œå¯ä»¥çœ‹å‡ºRaftç®—æ³•åœ¨å„ç§å¼‚å¸¸åœºæ™¯ä¸‹å‡èƒ½ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p>
<h2 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h2><h3 id="æ—¥å¿—å‹ç¼©ä¸å¿«ç…§"><a href="#æ—¥å¿—å‹ç¼©ä¸å¿«ç…§" class="headerlink" title="æ—¥å¿—å‹ç¼©ä¸å¿«ç…§"></a>æ—¥å¿—å‹ç¼©ä¸å¿«ç…§</h3><p>åœ¨å®é™…çš„ç³»ç»Ÿä¸­ï¼ŒRaftç»“ç‚¹ä¸Šçš„æ—¥å¿—è®°å½•ä¸å¯èƒ½æ— é™åˆ¶åœ°å¢åŠ ä¸‹å»ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/13171/compress-snapshot.png" class="" title="compress-snapshot"><br />



<p>å®šæ—¶çš„å°†çŠ¶æ€æœºä¸­çš„çŠ¶æ€ç”Ÿæˆå¿«ç…§ï¼Œè€Œå°†ä¹‹å‰çš„æ—¥å¿—å…¨éƒ¨åˆ é™¤ï¼Œæ˜¯ä¸€ç§å¸¸è§çš„å‹ç¼©æ–¹å¼ã€‚</p>
<ol>
<li>å°†èŠ‚ç‚¹çš„çŠ¶æ€ä¿å­˜ä¸ºLSM Treeï¼Œç„¶åå­˜å‚¨æœ€ååº”ç”¨æ—¥å¿—çš„ç´¢å¼•ä¸ä»»æœŸï¼Œä»¥ä¿è¯æ—¥å¿—åŒ¹é…ç‰¹æ€§</li>
<li>æŒé›†ç¾¤çš„é…ç½®æ›´æ–°ï¼Œå¿«ç…§ä¸­ä¹Ÿè¦å°†æœ€ååº”ç”¨çš„é›†ç¾¤é…ç½®ä¹Ÿå½“åšçŠ¶æ€ä¿å­˜ä¸‹æ¥</li>
<li>è·Ÿéšè€…éœ€è¦çš„æ—¥å¿—å·²ç»åœ¨é¢†å¯¼è€…ä¸Šé¢è¢«åˆ é™¤æ—¶ï¼Œéœ€è¦å°†å¿«ç…§é€šè¿‡RPCå‘é€è¿‡</li>
</ol>
<p>æ³¨æ„ï¼šç”±é¢†å¯¼äººè°ƒç”¨ä»¥å°†å¿«ç…§çš„åˆ†å—å‘é€ç»™è·Ÿéšè€…ã€‚é¢†å¯¼è€…æ€»æ˜¯æŒ‰é¡ºåºå‘é€åˆ†å—ã€‚</p>
<center>
    <font face="Old English Text MT" color="#555555" size=3>è¡¨5. InstallSnapshot RPCè¿”å›å€¼åˆ—è¡¨</font>
</center>


<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td>term</td>
<td>é¢†å¯¼äººçš„ä»»æœŸå·</td>
</tr>
<tr>
<td>leaderId</td>
<td>é¢†å¯¼äººçš„Idï¼Œä»¥ä¾¿äºè·Ÿéšè€…é‡å®šå‘è¯·æ±‚</td>
</tr>
<tr>
<td>lastIncluedIndex</td>
<td>å¿«ç…§ä¸­åŒ…å«çš„æœ€åæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼</td>
</tr>
<tr>
<td>lastIncludedTerm</td>
<td>å¿«ç…§ä¸­åŒ…å«çš„æœ€åæ—¥å¿—æ¡ç›®çš„ä»»æœŸå·</td>
</tr>
<tr>
<td>offset</td>
<td>åˆ†å—åœ¨å¿«ç…§ä¸­çš„å­—èŠ‚åç§»é‡</td>
</tr>
<tr>
<td>data[]</td>
<td>ä»åç§»é‡å¼€å§‹çš„å¿«ç…§åˆ†å—çš„åŸå§‹å­—èŠ‚</td>
</tr>
<tr>
<td>done</td>
<td>å¦‚æœè¿™æ˜¯æœ€åä¸€ä¸ª</td>
</tr>
</tbody></table>
<center>
    <font face="Old English Text MT" color="#555555" size=3>è¡¨6. InstallSnapshot RPCè¿”å›å€¼åˆ—è¡¨</font>
</center>

<table>
<thead>
<tr>
<th>ç»“æœ</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td>term</td>
<td>å½“å‰ä»»æœŸå·ï¼ˆcurrentTermï¼‰ï¼Œä¾¿äºé¢†å¯¼äººæ›´æ–°è‡ªå·±çš„ä»»æœŸå·</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å¦‚æœterm &lt; currentTermå°±ç«‹å³æ‹’ç»</span><br><span class="line">å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªåˆ†å—ï¼ˆoffset &#x3D; 0ï¼‰å°±åˆ›å»ºä¸€ä¸ªæ–°çš„å¿«ç…§</span><br><span class="line">åœ¨æŒ‡å®šåç§»é‡å†™å…¥æ•°æ®</span><br><span class="line">å¦‚æœ done æ˜¯ falseï¼Œåˆ™ç»§ç»­ç­‰å¾…æ›´å¤šçš„æ•°æ® ack</span><br><span class="line">ä¿å­˜å¿«ç…§æ–‡ä»¶ï¼Œä¸¢å¼ƒå…·æœ‰è¾ƒå°ç´¢å¼•çš„ä»»ä½•ç°æœ‰æˆ–éƒ¨åˆ†å¿«ç…§</span><br><span class="line">å¦‚æœç°å­˜çš„æ—¥å¿—æ¡ç›®ä¸å¿«ç…§ä¸­æœ€ååŒ…å«çš„æ—¥å¿—æ¡ç›®å…·æœ‰ç›¸åŒçš„ç´¢å¼•å€¼å’Œä»»æœŸå·ï¼Œåˆ™ä¿ç•™</span><br><span class="line">å¦åˆ™ï¼Œä¸¢å¼ƒæ•´ä¸ªæ—¥å¿—</span><br><span class="line">ä½¿ç”¨å¿«ç…§é‡ç½®çŠ¶æ€æœºï¼Œå¹¶æ¶å­å•Šå¿«ç…§çš„é›†ç¾¤é…ç½®</span><br></pre></td></tr></table></figure>

<p>Q: å¿«ç…§ä½•æ—¶åˆ›å»ºï¼Ÿè¿‡äºé¢‘ç¹ä¼šæµªè´¹æ€§èƒ½ï¼Œè¿‡äºä½é¢‘åˆ™æ—¥å¿—å ç”¨ç£ç›˜çš„é‡æ›´å¤§ï¼Œé‡å»ºæ—¶é—´æ›´é•¿ã€‚</p>
<p>A: é™å®šæ—¥å¿—æ–‡ä»¶å¤§å°åˆ°è¾¾æŸä¸€ä¸ªé˜ˆå€¼åç«‹åˆ»ç”Ÿæˆå¿«ç…§ã€‚</p>
<p>Q: å†™å…¥å¿«ç…§èŠ±è´¹çš„æ—¶é—´æ˜‚è´µå¦‚ä½•å¤„ç†ï¼Ÿå¦‚ä½•ä¿è¯ä¸å½±å“èŠ‚ç‚¹çš„æ­£å¸¸å·¥ä½œï¼Ÿ</p>
<p>A: ä½¿ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼ŒçŠ¶æ€æœºçš„å‡½æ•°å¼é¡ºåºæ€§å¤©ç„¶æ”¯æŒã€‚</p>
<h3 id="è°ƒèŠ‚å‚æ•°"><a href="#è°ƒèŠ‚å‚æ•°" class="headerlink" title="è°ƒèŠ‚å‚æ•°"></a>è°ƒèŠ‚å‚æ•°</h3><ol>
<li>å¿ƒè·³çš„éšæœºæ—¶é—´ï¼Œè¿‡å¿«ä¼šå¢åŠ ç½‘ç»œè´Ÿè½½ï¼Œè¿‡æ…¢åˆ™å¯¼è‡´æ„ŸçŸ¥é¢†å¯¼è€…å´©æºƒçš„æ—¶é—´æ›´é•¿</li>
<li>é€‰ä¸¾çš„éšæœºæ—¶é—´ï¼Œå¦‚æœå¤§éƒ¨åˆ†è·Ÿéšè€…åŒæ—¶å˜ä¸ºå€™é€‰äººåˆ™ä¼šå¯¼è‡´é€‰ç¥¨è¢«ç“œåˆ†</li>
</ol>
<h3 id="æµæ‰¹ç»“åˆ"><a href="#æµæ‰¹ç»“åˆ" class="headerlink" title="æµæ‰¹ç»“åˆ"></a>æµæ‰¹ç»“åˆ</h3><p>é¦–å…ˆå¯ä»¥åšçš„å°±æ˜¯batchï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹é¢ï¼Œä½¿ç”¨batchèƒ½æ˜æ˜¾æé«˜æ€§èƒ½ï¼Œè­¬å¦‚å¯¹äºRocksDBçš„å†™å…¥æ¥è¯´ï¼Œæˆ‘ä»¬é€šè¿‡ä¸ä¼šæ¯æ¬¡å†™å…¥ä¸€ä¸ªå€¼ï¼Œè€Œæ˜¯ä¼šç”¨ä¸€ä¸ªWriteBatchç¼“å­˜ä¸€æ‰¹ä¿®æ”¹ï¼Œç„¶åå†æ•´ä¸ªå†™å…¥ã€‚å¯¹äºRaftæ¥è¯´ï¼ŒLeaderå¯ä»¥ä¸€æ¬¡æ‰‹æœºå¤šä¸ªrequestsï¼Œç„¶åä¸€æ‰¹å‘é€ç»™Followerã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦æœ‰ä¸€ä¸ªæœ€å¤§å‘é€sizeæ¥é™åˆ¶æ¯æ¬¡æœ€å¤šå¯ä»¥å‘é€å¤šå°‘æ•°æ®ã€‚</p>
<p>å¦‚æœåªæ˜¯ç”¨batchï¼ŒLeaderè¿˜æ˜¯éœ€è¦ç­‰å¾…Followerè¿”å›æ‰èƒ½ç»§ç»­åé¢çš„æµç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜å¯ä»¥ä½¿ç”¨Pipelineæ¥è¿›è¡ŒåŠ é€Ÿã€‚Leaderä¼šç»´æŠ¤ä¸€ä¸ªNextIndexçš„å˜é‡æ¥è¡¨ç¤ºä¸‹ä¸€ä¸ªç»™Followerå‘é€çš„logä½ç½®ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œåªè¦Leaderè·ŸFollowerå»ºç«‹èµ·äº†è¿æ¥ï¼Œæˆ‘ä»¬éƒ½ä¼šè®¤ä¸ºç½‘ç»œæ˜¯ç¨³å®šäº’é€šçš„ã€‚æ‰€ä»¥å½“Leaderç»™Followerå‘é€äº†ä¸€æ‰¹logä¹‹åï¼Œå®ƒå¯ä»¥ç›´æ¥æ›´æ–°NextIndexï¼Œå¹¶ä¸”ç«‹åˆ»å‘é€åé¢çš„logï¼Œä¸éœ€è¦ç­‰å¾…Followerçš„è¿”å›ã€‚å¦‚æœç½‘ç»œå‡ºç°äº†é”™è¯¯ï¼Œæˆ–è€…Followerè¿”å›ä¸€äº›é”™è¯¯ï¼ŒLeaderå°±éœ€è¦é‡æ–°è°ƒæ•´NextIndexï¼Œç„¶åé‡æ–°å‘é€logã€‚</p>
<h3 id="å¹¶è¡Œè¿½åŠ "><a href="#å¹¶è¡Œè¿½åŠ " class="headerlink" title="å¹¶è¡Œè¿½åŠ "></a>å¹¶è¡Œè¿½åŠ </h3><p>å¯¹äºä¸Šé¢æåˆ°çš„ä¸€æ¬¡requestç®€æ˜“Raftæµç¨‹æ¥è¯´ï¼ŒLeaderå¯ä»¥å…ˆå¹¶è¡Œçš„å°†logå‘é€ç»™Followersï¼Œç„¶åå†å°†log appendã€‚ä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆåšï¼Œä¸»è¦æ˜¯å› ä¸ºåœ¨Rafté‡Œé¢ï¼Œå¦‚æœä¸€ä¸ªlogè¢«å¤§å¤šæ•°çš„ç»“ç‚¹appendï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºè¿™ä¸ªlogæ˜¯è¢«committedäº†ï¼Œæ‰€ä»¥å³ä½¿Leaderå†ç»™Followerå‘é€logä¹‹åï¼Œè‡ªå·±append logå¤±è´¥panicäº†ï¼Œåªè¦<code>N / 2 + 1</code>ä¸ªFollowerèƒ½æ¥æ”¶åˆ°è¿™ä¸ªlogå¹¶æˆåŠŸappendï¼Œæˆ‘ä»¬ä»å¯ä»¥è®¤ä¸ºè¿™ä¸ªlogæ˜¯è¢«committedäº†ï¼Œè¢«committedäº†ï¼Œè¢«committedçš„logåç»­å°±ä¸€å®šèƒ½è¢«æˆåŠŸapplyã€‚</p>
<p>åŸå› ï¼šä¸»è¦æ˜¯å› ä¸ºappend logä¼šæ¶‰åŠåˆ°è½ç›˜ï¼Œæœ‰å¼€é”€ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨Leaderè½ç›˜çš„åŒæ—¶è®©Followerä¹Ÿå°½å¿«çš„æ”¶åˆ°logæ˜¯è¢«committedäº†ï¼Œè¿™æ ·ç³»ç»Ÿå°±æœ‰ä¸¢å¤±æ•°æ®çš„é£é™©äº†ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„ï¼Œè™½ç„¶ Leader èƒ½åœ¨ append log ä¹‹å‰ç»™ Follower å‘ logï¼Œä½†æ˜¯ Follower å´ä¸èƒ½åœ¨ append log ä¹‹å‰å‘Šè¯‰ Leader å·²ç»æˆåŠŸ append è¿™ä¸ª logã€‚å¦‚æœ Follower æå‰å‘Šè¯‰ Leader è¯´å·²ç»æˆåŠŸ appendï¼Œä½†å®é™…åé¢ append log çš„æ—¶å€™å¤±è´¥äº†ï¼ŒLeader ä»ç„¶ä¼šè®¤ä¸ºè¿™ä¸ª log æ˜¯è¢« committed äº†ï¼Œè¿™æ ·ç³»ç»Ÿå°±æœ‰ä¸¢å¤±æ•°æ®çš„é£é™©äº†ã€‚</p>
<h3 id="å¼‚æ­¥åº”ç”¨"><a href="#å¼‚æ­¥åº”ç”¨" class="headerlink" title="å¼‚æ­¥åº”ç”¨"></a>å¼‚æ­¥åº”ç”¨</h3><p>å½“ä¸€ä¸ªlogè¢«å¤§éƒ¨åˆ†èŠ‚ç‚¹appendä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºè¿™ä¸ªlogè¢«committedäº†ï¼Œè¢«committedçš„logåœ¨ä»€ä¹ˆæ—¶å€™applyéƒ½ä¸ä¼šå†å½±å“æ•°æ®çš„ä¸€è‡´æ€§ã€‚æ‰€ä»¥å½“ä¸€ä¸ªlogè¢«committedä¹‹åï¼Œæˆ‘ä¹ˆå¯ä»¥ç”¨å¦ä¸€ä¸ªçº¿ç¨‹å»å¼‚æ­¥çš„applyè¿™ä¸ªlogã€‚<br>æ‰€ä»¥æ•´ä¸ªRaftæµç¨‹å°±å¯ä»¥å˜æˆï¼š</p>
<ol>
<li>Leaderæ¥å—ä¸€ä¸ªclientå‘é€çš„requestã€‚</li>
<li>Leaderå°†å¯¹åº”çš„logå‘é€ç»™å…¶ä»–Followerå¹¶æœ¬åœ°appendã€‚</li>
<li>Leaderç»§ç»­æ¥å—å…¶ä»–clientçš„requestsï¼ŒæŒç»­è¿›è¡Œæ­¥éª¤2ã€‚</li>
<li>Leaderå‘ç°logå·²ç»è¢«committedï¼Œåœ¨å¦ä¸€ä¸ªçº¿ç¨‹applyã€‚</li>
<li>Leaderå¼‚æ­¥apply logä¹‹åï¼Œè¿”å›ç»“æœç»™å¯¹åº”çš„clientã€‚</li>
</ol>
<p>ä½¿ç”¨ asychronous applyçš„å¥½å¤„åœ¨äºæˆ‘ä»¬ç°åœ¨å¯ä»¥å®‰å…¨çš„å¹¶è¡Œå¤„ç†append logå’Œapply logï¼Œè™½ç„¶å¯¹äºä¸€ä¸ªclientæ¥è¯´ï¼Œå®ƒçš„ä¸€æ¬¡requestä»ç„¶è¦èµ°å®Œå®Œæ•´çš„Raftæµç¨‹ï¼Œä½†å¯¹äºå¤šä¸ªclientsæ¥è¯´ï¼Œæ•´ä½“çš„å¹¶å‘å’Œååé‡æ˜¯ä¸Šå»äº†ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p>[1] ğŸ““ <a href="https://book.douban.com/subject/30386518/">äº‘åŸç”Ÿåˆ†å¸ƒå¼å­˜å‚¨åŸºçŸ³</a></p>
<p>[2] ğŸ“‘ <a href="https://github.com/maemual/raft-zh_cn">RAFTè®ºæ–‡ä¸­æ–‡ç¿»è¯‘</a></p>
]]></content>
      <categories>
        <category>Paper</category>
      </categories>
      <tags>
        <tag>Distributed</tag>
      </tags>
  </entry>
  <entry>
    <title>çº¢é»‘æ ‘</title>
    <url>/posts/f89cb603/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ğŸ““-å®šä¹‰"><a href="#ğŸ““-å®šä¹‰" class="headerlink" title="ğŸ““ å®šä¹‰"></a>ğŸ““ å®šä¹‰</h2><p>çº¢é»‘æ ‘æ˜¯ä¸€ç§å«æœ‰çº¢é»‘èŠ‚ç‚¹å¹¶èƒ½è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘</p>
<blockquote>
<p>ğŸŒ²äºŒå‰æŸ¥æ‰¾æ ‘</p>
<p>æ»¡è¶³çº¦æŸï¼šå·¦ç»“ç‚¹çš„å€¼å°äºçˆ¶ç»“ç‚¹ï¼Œçˆ¶ç»“ç‚¹çš„å€¼å°äºå³ç»“ç‚¹çš„å€¼ã€‚</p>
<p>åœºæ™¯ç†è§£ï¼šå‡è®¾äºŒå‰æŸ¥æ‰¾æ ‘å»ºç«‹åœ¨x-yç¬›å¡å°”åæ ‡ç³»ä¸­ï¼Œåˆ™æ‰€æœ‰ç»“ç‚¹å‘xè½´æŠ•å½±ï¼Œå€¼æ­£å¥½æ²¿ç€xè½´é€’å¢ã€‚</p>
</blockquote>
<br />

<h2 id="ğŸ”°-æ€§è´¨"><a href="#ğŸ”°-æ€§è´¨" class="headerlink" title="ğŸ”° æ€§è´¨"></a>ğŸ”° æ€§è´¨</h2><ul>
<li>æ¯ä¸ªç»“ç‚¹è¦ä¹ˆæ˜¯é»‘è‰²ï¼Œè¦ä¹ˆæ˜¯çº¢è‰²</li>
<li>æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²</li>
<li>æ¯ä¸ªå¶å­ç»“ç‚¹(NIL)æ˜¯é»‘è‰²çš„(è™šç»“ç‚¹)</li>
<li>æ¯ä¸ªçº¢è‰²ç»“ç‚¹çš„ä¸¤ä¸ªå­ç»“ç‚¹ä¸€å®šéƒ½æ˜¯é»‘è‰²</li>
<li>ä»»æ„ä¸€ç»“ç‚¹åˆ°æ¯ä¸ªå¶å­ç»“ç‚¹çš„è·¯å¾„éƒ½åŒ…å«æ•°é‡ç›¸åŒçš„é»‘ç»“ç‚¹(é»‘è‰²å®Œç¾å¹³è¡¡)</li>
</ul>
<p>ä»¥ä¸Šä¸ºæœ€ç®€æ€§è´¨ï¼Œä»»ä½•ä¸€æ¡ä¸å¯ç¼ºå°‘ï¼Œä»»æ„å››æ¡ä¸èƒ½æ¨å‡ºå¦å¤–ä¸€æ¡ã€‚</p>
<br />

<h2 id="ğŸŒ—-å¹³è¡¡"><a href="#ğŸŒ—-å¹³è¡¡" class="headerlink" title="ğŸŒ— å¹³è¡¡"></a>ğŸŒ— å¹³è¡¡</h2><p>çº¢é»‘æ ‘æ˜¯éå®Œç¾å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¯å®Œç¾é»‘è‰²å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ã€‚</p>
<blockquote>
<p>â­•çº¢é»‘æ ‘è‡ªå¹³è¡¡çš„æœ€å°å•å…ƒ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f89cb603/image-20201106225159861.png" class="" title="image-20201106225159861"><br />

<p>çº¢é»‘æ ‘çš„è‡ªå¹³è¡¡</p>
<p>æ’å…¥åªè€ƒè™‘G-{P, U}-Cä¸‰ä»£ï¼Œåˆ é™¤åªè€ƒè™‘P-{C, B}-{CL, CR, BL, BR}ä¸‰ä»£</p>
<blockquote>
<p>ğŸ”±çº¢é»‘æ ‘è‡ªå¹³è¡¡çš„åŸå­æ“ä½œ</p>
</blockquote>
<p>åŒ…æ‹¬ï¼šå˜è‰²ã€å·¦æ—‹ã€å³æ—‹</p>
<p>æ—‹è½¬è¦æœ‰åœ†å¿ƒï¼Œæœ‰æ–¹å‘ã€‚</p>
<p>æ—‹è½¬ç»“ç‚¹æ˜¯çˆ¶ç»“ç‚¹å›´ç»•å­èŠ‚ç‚¹æ—‹è½¬(å­èŠ‚ç‚¹ä¸ºåœ†å¿ƒ)ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f89cb603/image-20201103220142748.png" class="" title="image-20201103220142748">

<center>
    <font face="Kristen ITC" color="#555555" font-size=100px>â˜¬ æ—‹è½¬ç»“ç‚¹ â˜¬</font><br>
</center>
<br />

<blockquote>
<p>ğŸŒå˜è‰²ï¼šP-Black=&gt;Red,CB-Red=&gt;Black</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f89cb603/image-20201103221816468.png" class="" title="image-20201103221816468">

<center>
    <font face="Kristen ITC" color="#555555" font-size=100px>â˜¬ å˜è‰²æ“ä½œ â˜¬</font><br>
</center>
<br />

<blockquote>
<p>ğŸŒ”å·¦æ—‹ï¼šæ—‹è½¬ç»“ç‚¹ç»•åœ†å¿ƒé€†æ—¶é’ˆæ–¹å‘æ—‹è½¬ã€‚åŸºäºæœ€çŸ­è·¯å¾„æ¥ç¡®å®šæ–¹å‘ã€‚</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f89cb603/image-20201103222025132.png" class="" title="image-20201103222025132">

<center>
    <font face="Kristen ITC" color="#555555" font-size=100px>â˜¬ å·¦æ—‹æ“ä½œ â˜¬</font><br>
</center>
<br />

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;å·¦æ—‹&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;è¿‡ç¨‹ï¼šçˆ¶äº²ä¸‹æ²‰ï¼Œå³å­ä¸Šå‡ï¼Œå³å­çš„å·¦å­å˜ä¸ºåŸçˆ¶çš„å³å­&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å·¦æ—‹Xç»“ç‚¹</span></span><br><span class="line"><span class="comment"> *             P                                P</span></span><br><span class="line"><span class="comment"> *            /                                /</span></span><br><span class="line"><span class="comment"> *           X                                Y</span></span><br><span class="line"><span class="comment"> *         /  \        --(å·¦æ—‹)--&gt;           / \</span></span><br><span class="line"><span class="comment"> *       lX    Y                           X  rY</span></span><br><span class="line"><span class="comment"> *            / \                        /  \</span></span><br><span class="line"><span class="comment"> *          lY   rY                     lX  lY</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">leftRotate</span><span class="params">(RBTNode&lt;T, D&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* å³å­ç»“ç‚¹ */</span></span><br><span class="line">    RBTNode&lt;T, D&gt; y = x.getRight();</span><br><span class="line">    <span class="comment">/* çˆ¶äº²ç»“ç‚¹ */</span></span><br><span class="line">    RBTNode&lt;T, D&gt; p = x.getParent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Yçš„å·¦å­ å˜æˆ Xçš„å³å­</span></span><br><span class="line"><span class="comment">    * è‹¥Xä¸Yçš„å·¦å­ä¸ä¸ºç©º</span></span><br><span class="line"><span class="comment">    * åˆ™è®¾ç½®Yçš„å·¦å­çš„çˆ¶äº²ä¸ºX */</span></span><br><span class="line">    x.setRight(y.getLeft());</span><br><span class="line">    <span class="keyword">if</span> (y.getLeft() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        y.getLeft().setParent(x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¾ç½®Yçš„çˆ¶äº²ä¸ºP</span></span><br><span class="line"><span class="comment">    * 1. Pä¸ºç©ºï¼Œåˆ™æ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">    * 2. Xä¸ºPçš„å·¦å­ï¼Œ åˆ™Pçš„å·¦å­è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">    * 3. Xä¸ºPçš„å³å­ï¼Œåˆ™Pçš„å³å­è®¾ç½®ä¸ºY */</span></span><br><span class="line">    y.setParent(p);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.root = y;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (p.getLeft() == x) &#123;</span><br><span class="line">            p.setLeft(y);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            p.setRight(y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å°†Xçš„çˆ¶äº²è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">    * å°†Yçš„å·¦å­è®¾ç½®ä¸ºX */</span></span><br><span class="line">    x.setParent(y);</span><br><span class="line">    y.setLeft(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ğŸŒ–å³æ—‹ï¼šæ—‹è½¬ç»“ç‚¹ç»•åœ†å¿ƒé¡ºæ—¶é’ˆæ–¹å‘æ—‹è½¬ã€‚åŸºäºæœ€çŸ­è·¯å¾„ç¡®å®šæ–¹å‘ã€‚</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/f89cb603/image-20201103223223997.png" class="" title="image-20201103223223997">

<center>
    <font face="Kristen ITC" color="#555555" font-size=100px>â˜¬ å³æ—‹æ“ä½œ â˜¬</font><br>
</center>
<br />

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;å³æ—‹&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;è¿‡ç¨‹ï¼šçˆ¶äº²ä¸‹æ²‰ï¼Œå·¦å­ä¸Šå‡ï¼Œå·¦å­çš„å³å­å˜æˆåŸçˆ¶çš„å·¦å­&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å³æ—‹Xç»“ç‚¹</span></span><br><span class="line"><span class="comment"> *             P                                P</span></span><br><span class="line"><span class="comment"> *            /                                /</span></span><br><span class="line"><span class="comment"> *           X                                Y</span></span><br><span class="line"><span class="comment"> *         /  \        --(å³æ—‹)--&gt;           /  \</span></span><br><span class="line"><span class="comment"> *        Y   rX                           lY   X</span></span><br><span class="line"><span class="comment"> *       / \                                   / \</span></span><br><span class="line"><span class="comment"> *     lY  rY                                rY  rX</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rightRotate</span><span class="params">(RBTNode&lt;T, D&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* å·¦å­ç»“ç‚¹ */</span></span><br><span class="line">    RBTNode&lt;T, D&gt; y = x.getLeft();</span><br><span class="line">    <span class="comment">/* çˆ¶äº²ç»“ç‚¹ */</span></span><br><span class="line">    RBTNode&lt;T, D&gt; p = x.getParent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Yçš„å³å­ å˜æˆ Xçš„å·¦å­</span></span><br><span class="line"><span class="comment">    * è‹¥Yçš„å³å­ä¸ä¸ºç©º</span></span><br><span class="line"><span class="comment">    * åˆ™è®¾ç½®Yçš„å³å­çš„çˆ¶äº²ä¸ºX */</span></span><br><span class="line">    x.setLeft(y.getRight());</span><br><span class="line">    <span class="keyword">if</span> (y.getRight() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        y.getRight().setParent(x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¾ç½®Yçš„çˆ¶äº²ä¸ºP</span></span><br><span class="line"><span class="comment">     * 1. Pä¸ºç©ºï¼Œåˆ™æ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">     * 2. Xä¸ºPçš„å·¦å­ï¼Œ åˆ™Pçš„å·¦å­è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">     * 3. Xä¸ºPçš„å³å­ï¼Œåˆ™Pçš„å³å­è®¾ç½®ä¸ºY */</span></span><br><span class="line">    y.setParent(p);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.root = y;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (p.getLeft() == x) &#123;</span><br><span class="line">            p.setLeft(y);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            p.setRight(y);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å°†Xçš„çˆ¶äº²è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">    * å°†Yçš„å³å­è®¾ç½®ä¸ºX */</span></span><br><span class="line">    x.setParent(y);</span><br><span class="line">    y.setRight(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br />

<h2 id="ğŸŒ€-å¢åˆ "><a href="#ğŸŒ€-å¢åˆ " class="headerlink" title="ğŸŒ€ å¢åˆ "></a>ğŸŒ€ å¢åˆ </h2><blockquote>
<p>â•æ’å…¥ç»“ç‚¹</p>
</blockquote>
<p>æ–°å¢ç»“ç‚¹é»˜è®¤ä¸ºçº¢è‰²ï¼Œé¿å…ç ´åé»‘è‰²å®Œç¾å¹³è¡¡ã€‚</p>
<p>é¦–å…ˆå¯»æ‰¾æ–°ç»“ç‚¹çš„æ’å…¥ä½ç½®ï¼Œå³æ‰¾åˆ°æ–°ç»“ç‚¹çš„çˆ¶äº²ï¼Œç„¶åå†³å®šå°†æ–°ç»“ç‚¹æ’å…¥åˆ°çˆ¶äº²çš„å·¦è¾¹è¿˜æ˜¯å³è¾¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æ’å…¥ç»“ç‚¹&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertNode</span><span class="params">(T key, D data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cmp;</span><br><span class="line">    RBTNode&lt;T, D&gt; x = <span class="keyword">this</span>.root;</span><br><span class="line">    RBTNode&lt;T, D&gt; y = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¯»æ‰¾æ–°ç»“ç‚¹çš„æ’å…¥ä½ç½® */</span></span><br><span class="line">    <span class="keyword">while</span> (x != <span class="keyword">null</span>) &#123;</span><br><span class="line">        y = x;</span><br><span class="line">        cmp = key.compareTo(x.getKey());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cmp == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* keyå·²å­˜åœ¨ï¼Œç›´æ¥æ›´æ–° */</span></span><br><span class="line">            System.out.println(getCurrentTime() + <span class="string">&quot; [WARN] keyå·²å­˜åœ¨&quot;</span>);</span><br><span class="line">            System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] æ›´æ–°value: &quot;</span> + get(key) + <span class="string">&quot; =&gt; &quot;</span> + data);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">/* keyè¾ƒå¤§ï¼Œç»§ç»­å‘å³æŸ¥è¯¢ */</span></span><br><span class="line">            x = x.getRight();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* keyè¾ƒå°ï¼Œç»§ç»­å‘å·¦æŸ¥è¯¢ */</span></span><br><span class="line">            x = x.getLeft();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ç”Ÿæˆä¸€ä¸ªæ–°çš„ç»“ç‚¹ */</span></span><br><span class="line">    RBTNode&lt;T, D&gt; node = <span class="keyword">new</span> RBTNode&lt;&gt;(RBTColor.red, key, data, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] æ–°å¢ç»“ç‚¹ (&quot;</span> + key + <span class="string">&quot;, &quot;</span> + data + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">    <span class="comment">/* æ€»ç»“ç‚¹æ•°é‡+1 */</span></span><br><span class="line">    <span class="keyword">this</span>.count.incrementAndGet();</span><br><span class="line">    <span class="comment">/* è®¾ç½®æ–°ç»“ç‚¹çš„çˆ¶äº²ä¸ºY */</span></span><br><span class="line">    node.setParent(y);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å†æ¬¡æ¯”è¾ƒå†³å®šæ–°ç»“ç‚¹æ˜¯yçš„å·¦å­è¿˜æ˜¯å³å­*/</span></span><br><span class="line">    <span class="keyword">if</span> (y == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.root = node;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cmp = key.compareTo(y.getKey());</span><br><span class="line">        <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            y.setRight(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            y.setLeft(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æœ€åè¿›è¡Œè‡ªå¹³è¡¡ */</span></span><br><span class="line">    balanceInsertion(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br />

<blockquote>
<p>ğŸ’‰æ’å…¥ä¿®å¤</p>
</blockquote>
<p>æ’å…¥ç»“ç‚¹ä¸ºçº¢è‰²ï¼Œå› æ­¤åªæœ‰å½“çˆ¶äº²ç»“ç‚¹ä¸ºçº¢è‰²æ—¶æ‰éœ€è¦ä¿®å¤ã€‚</p>
<p>G-ç¥–çˆ¶ã€P-çˆ¶äº²ã€U-å”å”ã€C-æ’å…¥ã€‚</p>
<p>æˆ‘æ€»ç»“äº†äº”ç§æƒ…å†µä»¥åŠè§£å†³å£è¯€:</p>
<p>ï¼ˆ1ï¼‰å”å”ä¸ºçº¢</p>
<p>CASE 1</p>
<p>Description: å”å”ä¸ºçº¢</p>
<p>Solution: GPUå˜è‰²ï¼Œè‹¥ä¸æ»¡è¶³çº¢é»‘æ ‘çº¦æŸåˆ™é€’å½’å˜è‰²</p>
<br />

<p>ï¼ˆ2ï¼‰å”å”ä¸ºé»‘</p>
<p>CASE 2</p>
<p>Description: çˆ¶ä¸ºå·¦å­ï¼ŒGPCä¸‰ç‚¹ä¸€çº¿</p>
<p>Solution: å³æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  (<span class="number">1</span>) å³æ—‹ç¥–çˆ¶ç»“ç‚¹</span><br><span class="line">    é»‘ç¥–                        çº¢çˆ¶</span><br><span class="line">    / \                         / \</span><br><span class="line"> çº¢çˆ¶  é»‘å”    --(å³æ—‹)--&gt;    çº¢æ’  é»‘ç¥–</span><br><span class="line">  /                                 \</span><br><span class="line">çº¢æ’                                é»‘å”</span><br><span class="line">  (<span class="number">2</span>) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²</span><br><span class="line">    çº¢çˆ¶                        é»‘çˆ¶</span><br><span class="line">    / \                         / \</span><br><span class="line"> çº¢æ’  é»‘ç¥–    --(å˜è‰²)--&gt;    çº¢æ’  çº¢ç¥–</span><br><span class="line">       \                            \</span><br><span class="line">       é»‘å”                         é»‘å”</span><br></pre></td></tr></table></figure>

<br />

<p>CASE 3: </p>
<p>Description: çˆ¶ä¸ºå·¦å­ï¼ŒGPCä¸‰è§’å…³ç³»</p>
<p>Solution: å·¦æ—‹çˆ¶äº²ï¼Œäº¤æ¢PCï¼Œå³æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   (<span class="number">1</span>) å·¦æ—‹çˆ¶äº²ç»“ç‚¹ï¼Œå¹¶ä¸”äº¤æ¢çˆ¶å­èº«ä»½ï¼Œæ­¤æ—¶GPCä¸‰ç‚¹ä¸€çº¿</span><br><span class="line">    é»‘ç¥–                        é»‘ç¥–                        é»‘ç¥–</span><br><span class="line">    / \                         / \                        / \</span><br><span class="line"> çº¢çˆ¶  é»‘å”    --(å·¦æ—‹)--&gt;    çº¢æ’  é»‘å”    --(äº¤æ¢)--&gt;    çº¢çˆ¶  é»‘å”</span><br><span class="line">  \                          /                           /</span><br><span class="line">  çº¢æ’                     çº¢çˆ¶                         çº¢æ’</span><br><span class="line">  (<span class="number">2</span>) å³æ—‹ç¥–çˆ¶ç»“ç‚¹</span><br><span class="line">    é»‘ç¥–                        çº¢çˆ¶</span><br><span class="line">    / \                         / \</span><br><span class="line"> çº¢çˆ¶  é»‘å”    --(å³æ—‹)--&gt;    çº¢æ’  é»‘ç¥–</span><br><span class="line">  /                                 \</span><br><span class="line">çº¢æ’                                é»‘å”</span><br><span class="line">  (<span class="number">3</span>) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²</span><br><span class="line">    çº¢çˆ¶                        é»‘çˆ¶</span><br><span class="line">    / \                         / \</span><br><span class="line"> çº¢æ’  é»‘ç¥–    --(å˜è‰²)--&gt;    çº¢æ’  çº¢ç»„</span><br><span class="line">        \                           \</span><br><span class="line">        é»‘å”                        é»‘å”</span><br></pre></td></tr></table></figure>

<br />

<p>CASE 4</p>
<p>Description: çˆ¶ä¸ºå³å­ï¼ŒGPCä¸‰ç‚¹ä¸€çº¿</p>
<p>Solution: å·¦æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  (<span class="number">1</span>) å·¦æ—‹ç¥–çˆ¶ç»“ç‚¹</span><br><span class="line">    é»‘ç¥–                        çº¢çˆ¶</span><br><span class="line">    / \                         / \</span><br><span class="line"> é»‘å”  çº¢çˆ¶    --(å³æ—‹)--&gt;    é»‘ç¥–  çº¢æ’</span><br><span class="line">        \                     /</span><br><span class="line">        çº¢æ’                é»‘å”</span><br><span class="line">  (<span class="number">2</span>) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²</span><br><span class="line">    çº¢çˆ¶                        é»‘çˆ¶</span><br><span class="line">    / \                         / \</span><br><span class="line"> é»‘ç¥–  çº¢æ’    --(å˜è‰²)--&gt;    çº¢ç¥–  çº¢æ’</span><br><span class="line">  /                           /</span><br><span class="line">é»‘å”                        é»‘å”</span><br></pre></td></tr></table></figure>

<br />

<p>CASE 5</p>
<p>Description: çˆ¶ä¸ºå³å­ï¼ŒGPCä¸‰è§’å…³ç³»</p>
<p>Solution: å³æ—‹çˆ¶äº²ï¼Œäº¤æ¢PCï¼Œå·¦æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   (<span class="number">1</span>) å³æ—‹çˆ¶äº²ç»“ç‚¹ï¼Œå¹¶ä¸”äº¤æ¢çˆ¶å­èº«ä»½ï¼Œæ­¤æ—¶GPCä¸‰ç‚¹ä¸€çº¿</span><br><span class="line">    é»‘ç¥–                        é»‘ç¥–                        é»‘ç¥–</span><br><span class="line">    / \                         / \                        / \</span><br><span class="line"> é»‘å”  çº¢çˆ¶    --(å³æ—‹)--&gt;    é»‘ç¥–  çº¢æ’    --(äº¤æ¢)--&gt;    é»‘ç¥–  çº¢çˆ¶</span><br><span class="line">       /                            \                          \</span><br><span class="line">     çº¢æ’                           çº¢çˆ¶                        çº¢æ’</span><br><span class="line">   (<span class="number">2</span>) å·¦æ—‹ç¥–çˆ¶</span><br><span class="line">    é»‘ç¥–                        çº¢çˆ¶</span><br><span class="line">    / \                         / \</span><br><span class="line"> é»‘å”  çº¢çˆ¶    --(å·¦æ—‹)--&gt;    é»‘ç¥–  çº¢æ’</span><br><span class="line">        \                    /</span><br><span class="line">        çº¢æ’               é»‘å”</span><br><span class="line">   (<span class="number">3</span>) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²</span><br><span class="line">    çº¢çˆ¶                        é»‘çˆ¶</span><br><span class="line">    / \                         / \</span><br><span class="line"> é»‘å”  çº¢æ’    --(å˜è‰²)--&gt;    çº¢ç¥–  çº¢æ’</span><br><span class="line">  /                         /</span><br><span class="line">é»‘å”                      é»‘å”</span><br></pre></td></tr></table></figure>

<br />

<blockquote>
<p>â–åˆ é™¤ç»“ç‚¹</p>
</blockquote>
<p>ä¸‰ç§æƒ…å†µï¼Œè§£å†³æ–¹æ¡ˆä¸»è¦ä¸ºå¯»æ‰¾åè£”é¡¶æ›¿è‡ªå·±</p>
<p>CASE 1</p>
<p>Description: å¾…åˆ ç»“ç‚¹å·¦å­å’Œå³å­éƒ½å­˜åœ¨:</p>
<p>Solution: æ›¿ä»£ç»“ç‚¹ä¸ºå³å­æ ‘çš„æœ€å·¦å­©å­ï¼Œç„¶åè°ƒæ•´å…³ç³»</p>
<p>CASE 2:</p>
<p>Description: å¾…åˆ ç»“ç‚¹æ²¡æœ‰å·¦å­å’Œå³å­:</p>
<p>Solution: ç›´æ¥åˆ é™¤ï¼Œç„¶åè°ƒæ•´å…³ç³»</p>
<p>CASE 3:</p>
<p>Description: å¾…åˆ ç»“ç‚¹åªæœ‰å·¦å­æˆ–è€…å³å­:</p>
<p>Solution: æ›¿ä»£ç»“ç‚¹ä¸ºå­˜åœ¨çš„å­©å­ï¼Œç„¶åè°ƒæ•´å…³ç³»</p>
<br />

<blockquote>
<p>ğŸ’‰åˆ é™¤ä¿®å¤</p>
</blockquote>
<p>ä»…åˆ é™¤é»‘è‰²ç»“ç‚¹éœ€è¦ä¿®å¤ï¼Œåˆ é™¤çº¢è‰²ä¸éœ€è¦ã€‚</p>
<p>P-çˆ¶äº²ã€D-åˆ é™¤ã€B-å…„å¼Ÿã€BR-å…„å¼Ÿå³å­ã€BL-å…„å¼Ÿå·¦å­ã€‚</p>
<ul>
<li>Dä¸ºå·¦å­<ul>
<li>Bä¸ºçº¢è‰²ï¼šå·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue</li>
<li>Bä¸ºé»‘è‰²<ul>
<li>BLä¸ºé»‘è‰²ä¸”BRé»‘è‰²ï¼šå…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯</li>
<li>BLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå³æ—‹å…„å¼Ÿï¼Œå…„å¼ŸæŸ“çº¢ï¼ŒBLæŸ“é»‘</li>
<li>BRä¸ºçº¢è‰²ï¼šå·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBRé»‘åŒ–ï¼Œç„¶åbreak</li>
</ul>
</li>
</ul>
</li>
<li>Dä¸ºå³å­<ul>
<li>Bä¸ºçº¢è‰²ï¼šå³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue</li>
<li>Bä¸ºé»‘è‰²ï¼š<ul>
<li>BLä¸ºé»‘è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯</li>
<li>BLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå·¦æ—‹å…„å¼Ÿï¼Œçˆ¶äº²æŸ“çº¢ï¼ŒBRæŸ“é»‘</li>
<li>BLä¸ºçº¢è‰²ï¼šå³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBLé»‘åŒ–ï¼Œç„¶åbreak</li>
</ul>
</li>
</ul>
</li>
</ul>
<br />

<h2 id="ğŸ“‘-æºç "><a href="#ğŸ“‘-æºç " class="headerlink" title="ğŸ“‘ æºç "></a>ğŸ“‘ æºç </h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.DataStructures.RBTree;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020-11-05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** çº¢é»‘é¢œè‰² */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">RBTColor</span> </span>&#123;</span><br><span class="line">    red,</span><br><span class="line">    black</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** çº¢é»‘ç»“ç‚¹ */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RBTNode</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">T</span>&gt;, <span class="title">D</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ç»“ç‚¹é¢œè‰² */</span></span><br><span class="line">    <span class="keyword">private</span> RBTColor color;</span><br><span class="line">    <span class="comment">/* ç»“ç‚¹é”®å€¼ */</span></span><br><span class="line">    <span class="keyword">private</span> T key;</span><br><span class="line">    <span class="comment">/* ç»“ç‚¹æ•°æ® */</span></span><br><span class="line">    <span class="keyword">private</span> D data;</span><br><span class="line">    <span class="comment">/* çˆ¶äº²ç»“ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> RBTNode&lt;T, D&gt; parent;</span><br><span class="line">    <span class="comment">/* å·¦å­ç»“ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> RBTNode left;</span><br><span class="line">    <span class="comment">/* å³å­ç»“ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> RBTNode right;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RBTNode</span><span class="params">(RBTColor color, T key, D data, RBTNode&lt;T, D&gt; parent, RBTNode left, RBTNode right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.color = color;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        <span class="keyword">this</span>.parent = parent;</span><br><span class="line">        <span class="keyword">this</span>.left = left;</span><br><span class="line">        <span class="keyword">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RBTColor <span class="title">getColor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> color;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setColor</span><span class="params">(RBTColor color)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.color = color;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateColor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.color == RBTColor.red) &#123;</span><br><span class="line">            <span class="keyword">this</span>.color = RBTColor.black;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.color = RBTColor.red;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> key;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKey</span><span class="params">(T key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> D <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setData</span><span class="params">(D data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RBTNode&lt;T, D&gt; <span class="title">getParent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParent</span><span class="params">(RBTNode&lt;T, D&gt; parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.parent = parent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RBTNode <span class="title">getLeft</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLeft</span><span class="params">(RBTNode left)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.left = left;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RBTNode <span class="title">getRight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRight</span><span class="params">(RBTNode right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;RBTNode[&quot;</span> +</span><br><span class="line">                <span class="string">&quot;color=&quot;</span> + color +</span><br><span class="line">                <span class="string">&quot;, key=&quot;</span> + key +</span><br><span class="line">                <span class="string">&quot;, data=&quot;</span> + data +</span><br><span class="line">                <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* çº¢é»‘æ ‘ */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedBlackTree</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">T</span>&gt;, <span class="title">D</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ—¶é—´æ ¼å¼ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleDateFormat SDF = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ ¹èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">private</span> RBTNode&lt;T, D&gt; root;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ ‘ç»“ç‚¹æ•°é‡ */</span></span><br><span class="line">    <span class="keyword">private</span> AtomicLong count = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;è·å–æ—¶é—´&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getCurrentTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SDF.format(<span class="keyword">new</span> Date());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;å¤§å°&lt;p/&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æŸ¥è¯¢&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> D <span class="title">get</span><span class="params">(T key)</span> </span>&#123;</span><br><span class="line">        RBTNode&lt;T, D&gt; node = search(key, <span class="keyword">this</span>.root);</span><br><span class="line">        <span class="keyword">return</span> node == <span class="keyword">null</span> ? <span class="keyword">null</span> : node.getData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æ’å…¥&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(T key, D data)</span> </span>&#123;</span><br><span class="line">        insertNode(key, data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;åˆ é™¤&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(T key)</span> </span>&#123;</span><br><span class="line">        RBTNode&lt;T, D&gt; node = search(key, <span class="keyword">this</span>.root);</span><br><span class="line">        <span class="keyword">if</span> (node != <span class="keyword">null</span>) &#123;</span><br><span class="line">            deleteNode(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(getCurrentTime() + <span class="string">&quot; [ERROR] &quot;</span> + <span class="string">&quot;keyä¸º&quot;</span> + key + <span class="string">&quot;çš„ç»“ç‚¹ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;root-getter&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RBTNode&lt;T, D&gt; <span class="title">getRoot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;åˆ¤æ–­ç»“ç‚¹æ˜¯å¦ä¸ºçº¢è‰²&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">isRed</span><span class="params">(RBTNode&lt;T, D&gt; node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (node != <span class="keyword">null</span> &amp;&amp; node.getColor() == RBTColor.red) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;åˆ¤æ–­ç»“ç‚¹æ˜¯å¦ä¸ºé»‘è‰²&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">isBlack</span><span class="params">(RBTNode&lt;T, D&gt; node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (node == <span class="keyword">null</span> || node.getColor() == RBTColor.black) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æŸ¥è¯¢keyå€¼çš„ç»“ç‚¹&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;é€’å½’æŸ¥è¯¢: æ¯”è¾ƒkeyï¼Œç›¸ç­‰ç›´æ¥è¿”å›ï¼Œè¿‡å¤§åˆ™ç»§ç»­å‘å³ï¼Œè¿‡å°åˆ™ç»§ç»­å‘å·¦&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RBTNode&lt;T, D&gt; <span class="title">search</span><span class="params">(T key, RBTNode&lt;T, D&gt; node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (node != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> cmp = key.compareTo(node.getKey());</span><br><span class="line">            <span class="keyword">if</span> (cmp == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> search(key, node.getRight());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> search(key, node.getLeft());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;å·¦æ—‹&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;è¿‡ç¨‹ï¼šçˆ¶äº²ä¸‹æ²‰ï¼Œå³å­ä¸Šå‡ï¼Œå³å­çš„å·¦å­å˜ä¸ºåŸçˆ¶çš„å³å­&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     *     å·¦æ—‹Xç»“ç‚¹</span></span><br><span class="line"><span class="comment">     *             P                                P</span></span><br><span class="line"><span class="comment">     *            /                                /</span></span><br><span class="line"><span class="comment">     *           X                                Y</span></span><br><span class="line"><span class="comment">     *         /  \        --(å·¦æ—‹)--&gt;           / \</span></span><br><span class="line"><span class="comment">     *       lX    Y                           X  rY</span></span><br><span class="line"><span class="comment">     *            / \                        /  \</span></span><br><span class="line"><span class="comment">     *          lY   rY                     lX  lY</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">leftRotate</span><span class="params">(RBTNode&lt;T, D&gt; x)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* å³å­ç»“ç‚¹ */</span></span><br><span class="line">        RBTNode&lt;T, D&gt; y = x.getRight();</span><br><span class="line">        <span class="comment">/* çˆ¶äº²ç»“ç‚¹ */</span></span><br><span class="line">        RBTNode&lt;T, D&gt; p = x.getParent();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Yçš„å·¦å­ å˜æˆ Xçš„å³å­</span></span><br><span class="line"><span class="comment">        * è‹¥Xä¸Yçš„å·¦å­ä¸ä¸ºç©º</span></span><br><span class="line"><span class="comment">        * åˆ™è®¾ç½®Yçš„å·¦å­çš„çˆ¶äº²ä¸ºX */</span></span><br><span class="line">        x.setRight(y.getLeft());</span><br><span class="line">        <span class="keyword">if</span> (y.getLeft() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            y.getLeft().setParent(x);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* è®¾ç½®Yçš„çˆ¶äº²ä¸ºP</span></span><br><span class="line"><span class="comment">        * 1. Pä¸ºç©ºï¼Œåˆ™æ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">        * 2. Xä¸ºPçš„å·¦å­ï¼Œ åˆ™Pçš„å·¦å­è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">        * 3. Xä¸ºPçš„å³å­ï¼Œåˆ™Pçš„å³å­è®¾ç½®ä¸ºY */</span></span><br><span class="line">        y.setParent(p);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.root = y;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (p.getLeft() == x) &#123;</span><br><span class="line">                p.setLeft(y);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                p.setRight(y);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å°†Xçš„çˆ¶äº²è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">        * å°†Yçš„å·¦å­è®¾ç½®ä¸ºX */</span></span><br><span class="line">        x.setParent(y);</span><br><span class="line">        y.setLeft(x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;å³æ—‹&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;è¿‡ç¨‹ï¼šçˆ¶äº²ä¸‹æ²‰ï¼Œå·¦å­ä¸Šå‡ï¼Œå·¦å­çš„å³å­å˜æˆåŸçˆ¶çš„å·¦å­&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     *     å³æ—‹Xç»“ç‚¹</span></span><br><span class="line"><span class="comment">     *             P                                P</span></span><br><span class="line"><span class="comment">     *            /                                /</span></span><br><span class="line"><span class="comment">     *           X                                Y</span></span><br><span class="line"><span class="comment">     *         /  \        --(å³æ—‹)--&gt;           /  \</span></span><br><span class="line"><span class="comment">     *        Y   rX                           lY   X</span></span><br><span class="line"><span class="comment">     *       / \                                   / \</span></span><br><span class="line"><span class="comment">     *     lY  rY                                rY  rX</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rightRotate</span><span class="params">(RBTNode&lt;T, D&gt; x)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* å·¦å­ç»“ç‚¹ */</span></span><br><span class="line">        RBTNode&lt;T, D&gt; y = x.getLeft();</span><br><span class="line">        <span class="comment">/* çˆ¶äº²ç»“ç‚¹ */</span></span><br><span class="line">        RBTNode&lt;T, D&gt; p = x.getParent();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Yçš„å³å­ å˜æˆ Xçš„å·¦å­</span></span><br><span class="line"><span class="comment">        * è‹¥Yçš„å³å­ä¸ä¸ºç©º</span></span><br><span class="line"><span class="comment">        * åˆ™è®¾ç½®Yçš„å³å­çš„çˆ¶äº²ä¸ºX */</span></span><br><span class="line">        x.setLeft(y.getRight());</span><br><span class="line">        <span class="keyword">if</span> (y.getRight() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            y.getRight().setParent(x);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* è®¾ç½®Yçš„çˆ¶äº²ä¸ºP</span></span><br><span class="line"><span class="comment">         * 1. Pä¸ºç©ºï¼Œåˆ™æ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">         * 2. Xä¸ºPçš„å·¦å­ï¼Œ åˆ™Pçš„å·¦å­è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">         * 3. Xä¸ºPçš„å³å­ï¼Œåˆ™Pçš„å³å­è®¾ç½®ä¸ºY */</span></span><br><span class="line">        y.setParent(p);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.root = y;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (p.getLeft() == x) &#123;</span><br><span class="line">                p.setLeft(y);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                p.setRight(y);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å°†Xçš„çˆ¶äº²è®¾ç½®ä¸ºY</span></span><br><span class="line"><span class="comment">        * å°†Yçš„å³å­è®¾ç½®ä¸ºX */</span></span><br><span class="line">        x.setParent(y);</span><br><span class="line">        y.setRight(x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æ’å…¥ç»“ç‚¹&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertNode</span><span class="params">(T key, D data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> cmp;</span><br><span class="line">        RBTNode&lt;T, D&gt; x = <span class="keyword">this</span>.root;</span><br><span class="line">        RBTNode&lt;T, D&gt; y = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å¯»æ‰¾æ–°ç»“ç‚¹çš„æ’å…¥ä½ç½® */</span></span><br><span class="line">        <span class="keyword">while</span> (x != <span class="keyword">null</span>) &#123;</span><br><span class="line">            y = x;</span><br><span class="line">            cmp = key.compareTo(x.getKey());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cmp == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">/* keyå·²å­˜åœ¨ï¼Œç›´æ¥æ›´æ–° */</span></span><br><span class="line">                System.out.println(getCurrentTime() + <span class="string">&quot; [WARN] keyå·²å­˜åœ¨&quot;</span>);</span><br><span class="line">                System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] æ›´æ–°value: &quot;</span> + get(key) + <span class="string">&quot; =&gt; &quot;</span> + data);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="comment">/* keyè¾ƒå¤§ï¼Œç»§ç»­å‘å³æŸ¥è¯¢ */</span></span><br><span class="line">                x = x.getRight();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">/* keyè¾ƒå°ï¼Œç»§ç»­å‘å·¦æŸ¥è¯¢ */</span></span><br><span class="line">                x = x.getLeft();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ç”Ÿæˆä¸€ä¸ªæ–°çš„ç»“ç‚¹ */</span></span><br><span class="line">        RBTNode&lt;T, D&gt; node = <span class="keyword">new</span> RBTNode&lt;&gt;(RBTColor.red, key, data, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] æ–°å¢ç»“ç‚¹ (&quot;</span> + key + <span class="string">&quot;, &quot;</span> + data + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        <span class="comment">/* æ€»ç»“ç‚¹æ•°é‡+1 */</span></span><br><span class="line">        <span class="keyword">this</span>.count.incrementAndGet();</span><br><span class="line">        <span class="comment">/* è®¾ç½®æ–°ç»“ç‚¹çš„çˆ¶äº²ä¸ºY */</span></span><br><span class="line">        node.setParent(y);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å†æ¬¡æ¯”è¾ƒå†³å®šæ–°ç»“ç‚¹æ˜¯yçš„å·¦å­è¿˜æ˜¯å³å­*/</span></span><br><span class="line">        <span class="keyword">if</span> (y == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.root = node;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cmp = key.compareTo(y.getKey());</span><br><span class="line">            <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                y.setRight(node);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                y.setLeft(node);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* æœ€åè¿›è¡Œè‡ªå¹³è¡¡ */</span></span><br><span class="line">        balanceInsertion(node);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;æ’å…¥ç»“ç‚¹çš„è‡ªå¹³è¡¡æ“ä½œ&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ç”±äºæ’å…¥èŠ‚ç‚¹é»˜è®¤é¢œè‰²ä¸ºçº¢è‰²ï¼Œæ‰€ä»¥åªæœ‰çˆ¶ç»“ç‚¹ä¸ºçº¢è‰²æ—¶å€™æ‰éœ€è¦ä¿®å¤</span></span><br><span class="line"><span class="comment">     *   åˆ†ä¸‰ç§æƒ…å†µè®¨è®º&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;case1. å”å”ç»“ç‚¹ä¹Ÿä¸ºçº¢è‰²&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;case2. å”å”ç»“ç‚¹ä¸ºç©ºï¼Œä¸”ç¥–çˆ¶å­ä¸‰ç‚¹ä¸€çº¿&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;case3. å”å”ç»“ç‚¹ä¸ºç©ºï¼Œä¸”ç¥–çˆ¶å­ä¸‰è§’å…³ç³»&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;G-ç¥–çˆ¶ã€P-çˆ¶äº²ã€U-å”å”ã€C-æ’å…¥&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">balanceInsertion</span><span class="params">(RBTNode&lt;T, D&gt; node)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* çˆ¶äº² Â· ç¥–çˆ¶ */</span></span><br><span class="line">        RBTNode&lt;T, D&gt; paren, grand;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å½“çˆ¶äº²èŠ‚ç‚¹ä¸ºé»‘è‰²æ—¶ï¼Œç»“æŸä¿®å¤ */</span></span><br><span class="line">        <span class="keyword">while</span> (((paren = node.getParent()) != <span class="keyword">null</span>) &amp;&amp; isRed(paren)) &#123;</span><br><span class="line">            grand = paren.getParent();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* ç¡®å®šçˆ¶äº²å’Œå”å”çš„å·¦å³å…³ç³» */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* CASE: çˆ¶å·¦å”å³ */</span></span><br><span class="line">            <span class="keyword">if</span> (grand.getLeft() == paren) &#123;</span><br><span class="line">                RBTNode&lt;T, D&gt; uncle = grand.getRight();</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * case1: PUåŒçº¢</span></span><br><span class="line"><span class="comment">                 * solution1: GPUå˜è‰²</span></span><br><span class="line"><span class="comment">                 * å¦‚æœæ­¤æ—¶æ•´æ£µæ ‘ä¸æ»¡è¶³çº¦æŸï¼Œåˆ™é€’å½’è¿›è¡ŒGPUå˜è‰²</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (isRed(uncle)) &#123;</span><br><span class="line">                    grand.setColor(RBTColor.red);</span><br><span class="line">                    paren.setColor(RBTColor.black);</span><br><span class="line">                    uncle.setColor(RBTColor.black);</span><br><span class="line">                    node = grand;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * case2: Pçº¢Ué»‘ï¼Œçˆ¶ä¸ºå·¦å­ï¼ŒGPCä¸‰ç‚¹ä¸€çº¿</span></span><br><span class="line"><span class="comment">                 * solution2: å³æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</span></span><br><span class="line"><span class="comment">                 *         (1) å³æ—‹ç¥–çˆ¶ç»“ç‚¹</span></span><br><span class="line"><span class="comment">                 *           é»‘ç¥–                        çº¢çˆ¶</span></span><br><span class="line"><span class="comment">                 *           / \                         / \</span></span><br><span class="line"><span class="comment">                 *        çº¢çˆ¶  é»‘å”    --(å³æ—‹)--&gt;    çº¢æ’  é»‘ç¥–</span></span><br><span class="line"><span class="comment">                 *         /                                 \</span></span><br><span class="line"><span class="comment">                 *       çº¢æ’                                é»‘å”</span></span><br><span class="line"><span class="comment">                 *         (2) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²</span></span><br><span class="line"><span class="comment">                 *           çº¢çˆ¶                        é»‘çˆ¶</span></span><br><span class="line"><span class="comment">                 *           / \                         / \</span></span><br><span class="line"><span class="comment">                 *        çº¢æ’  é»‘ç¥–    --(å˜è‰²)--&gt;    çº¢æ’  çº¢ç¥–</span></span><br><span class="line"><span class="comment">                 *              \                            \</span></span><br><span class="line"><span class="comment">                 *              é»‘å”                         é»‘å”</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                * case3: Pçº¢Ué»‘ï¼Œçˆ¶ä¸ºå·¦å­ï¼ŒGPCä¸‰è§’å…³ç³»</span></span><br><span class="line"><span class="comment">                * solution3: å·¦æ—‹çˆ¶äº²ï¼Œäº¤æ¢PCï¼Œå³æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</span></span><br><span class="line"><span class="comment">                *         (1) å·¦æ—‹çˆ¶äº²ç»“ç‚¹ï¼Œå¹¶ä¸”äº¤æ¢çˆ¶å­èº«ä»½ï¼Œæ­¤æ—¶GPCä¸‰ç‚¹ä¸€çº¿</span></span><br><span class="line"><span class="comment">                *          é»‘ç¥–                        é»‘ç¥–                        é»‘ç¥–</span></span><br><span class="line"><span class="comment">                *          / \                         / \                        / \</span></span><br><span class="line"><span class="comment">                *       çº¢çˆ¶  é»‘å”    --(å·¦æ—‹)--&gt;    çº¢æ’  é»‘å”    --(äº¤æ¢)--&gt;    çº¢çˆ¶  é»‘å”</span></span><br><span class="line"><span class="comment">                *        \                          /                           /</span></span><br><span class="line"><span class="comment">                *        çº¢æ’                     çº¢çˆ¶                         çº¢æ’</span></span><br><span class="line"><span class="comment">                *        (2) å³æ—‹ç¥–çˆ¶ç»“ç‚¹</span></span><br><span class="line"><span class="comment">                *          é»‘ç¥–                        çº¢çˆ¶</span></span><br><span class="line"><span class="comment">                *          / \                         / \</span></span><br><span class="line"><span class="comment">                *       çº¢çˆ¶  é»‘å”    --(å³æ—‹)--&gt;    çº¢æ’  é»‘ç¥–y</span></span><br><span class="line"><span class="comment">                *        /                                 \</span></span><br><span class="line"><span class="comment">                *      çº¢æ’                                é»‘å”</span></span><br><span class="line"><span class="comment">                *        (3) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²</span></span><br><span class="line"><span class="comment">                *          çº¢çˆ¶                        é»‘</span></span><br><span class="line"><span class="comment">                *          / \                         / \</span></span><br><span class="line"><span class="comment">                *       çº¢æ’  é»‘ç¥–    --(å˜è‰²)--&gt;    çº¢æ’  çº¢ç»„</span></span><br><span class="line"><span class="comment">                *              \                           \</span></span><br><span class="line"><span class="comment">                *              é»‘å”                        é»‘å”</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * attention:</span></span><br><span class="line"><span class="comment">                 * ä¸‰è§’å…³ç³»ç»è¿‡ä¸€æ­¥æ—‹è½¬å³å¯è½¬æ¢æˆä¸‰ç‚¹ä¸€çº¿</span></span><br><span class="line"><span class="comment">                 * å› æ­¤case3å…ˆç»è¿‡ä¸€æ­¥å¤„ç†åˆ°case2ï¼Œå†è¿›è¡Œcase2çš„å¤„ç†</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (paren.getRight() == node) &#123; <span class="comment">// case3</span></span><br><span class="line">                        leftRotate(paren);</span><br><span class="line">                        RBTNode&lt;T, D&gt; temp = node;</span><br><span class="line">                        node = paren;</span><br><span class="line">                        paren = temp;</span><br><span class="line">                    &#125; <span class="comment">// case2</span></span><br><span class="line">                    rightRotate(grand);</span><br><span class="line">                    grand.updateColor();</span><br><span class="line">                    paren.updateColor();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* CASE: çˆ¶å³å”å·¦ */</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                RBTNode&lt;T, D&gt; uncle = grand.getLeft();</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * case1: PUåŒçº¢(çˆ¶äº²å’Œå”å”éƒ½ä¸ºçº¢è‰²)</span></span><br><span class="line"><span class="comment">                 * solution1: GPUå˜è‰²(ç¥–çˆ¶å˜ä¸ºçº¢è‰²ï¼Œçˆ¶äº²å’Œå”å”éƒ½å˜ä¸ºé»‘è‰²)</span></span><br><span class="line"><span class="comment">                 * å¦‚æœæ­¤æ—¶æ•´æ£µæ ‘ä¸æ»¡è¶³çº¦æŸï¼Œåˆ™é€’å½’è¿›è¡ŒGPUå˜è‰²</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (isRed(uncle)) &#123;</span><br><span class="line">                    grand.setColor(RBTColor.red);</span><br><span class="line">                    paren.setColor(RBTColor.black);</span><br><span class="line">                    uncle.setColor(RBTColor.black);</span><br><span class="line">                    node = grand;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * case4: Pçº¢Ué»‘ï¼Œçˆ¶ä¸ºå·¦å­ï¼ŒGPCä¸‰ç‚¹ä¸€çº¿</span></span><br><span class="line"><span class="comment">                 * solution4: å·¦æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</span></span><br><span class="line"><span class="comment">                 *         (1) å·¦æ—‹ç¥–çˆ¶ç»“ç‚¹</span></span><br><span class="line"><span class="comment">                 *           é»‘ç¥–                        çº¢çˆ¶</span></span><br><span class="line"><span class="comment">                 *           / \                         / \</span></span><br><span class="line"><span class="comment">                 *        é»‘å”  çº¢çˆ¶    --(å³æ—‹)--&gt;    é»‘ç¥–  çº¢æ’</span></span><br><span class="line"><span class="comment">                 *               \                     /</span></span><br><span class="line"><span class="comment">                 *               çº¢æ’                é»‘å”</span></span><br><span class="line"><span class="comment">                 *          (2) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²</span></span><br><span class="line"><span class="comment">                 *           çº¢çˆ¶                        é»‘çˆ¶</span></span><br><span class="line"><span class="comment">                 *           / \                         / \</span></span><br><span class="line"><span class="comment">                 *        é»‘ç¥–  çº¢æ’    --(å˜è‰²)--&gt;    çº¢ç¥–  çº¢æ’</span></span><br><span class="line"><span class="comment">                 *         /                           /</span></span><br><span class="line"><span class="comment">                 *       é»‘å”                        é»‘å”</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * case5: Pçº¢Ué»‘ï¼Œçˆ¶ä¸ºå³å­ï¼ŒGPCä¸‰è§’å…³ç³»</span></span><br><span class="line"><span class="comment">                 * solution5: å³æ—‹çˆ¶äº²ï¼Œäº¤æ¢PCï¼Œå·¦æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</span></span><br><span class="line"><span class="comment">                 *          (1) å³æ—‹çˆ¶äº²ç»“ç‚¹ï¼Œå¹¶ä¸”äº¤æ¢çˆ¶å­èº«ä»½ï¼Œæ­¤æ—¶GPCä¸‰ç‚¹ä¸€çº¿</span></span><br><span class="line"><span class="comment">                 *           é»‘ç¥–                        é»‘ç¥–                        é»‘ç¥–</span></span><br><span class="line"><span class="comment">                 *           / \                         / \                        / \</span></span><br><span class="line"><span class="comment">                 *        é»‘å”  çº¢çˆ¶    --(å³æ—‹)--&gt;    é»‘ç¥–  çº¢æ’    --(äº¤æ¢)--&gt;    é»‘ç¥–  çº¢çˆ¶</span></span><br><span class="line"><span class="comment">                 *              /                            \                          \</span></span><br><span class="line"><span class="comment">                 *            çº¢æ’                           çº¢çˆ¶                        çº¢æ’</span></span><br><span class="line"><span class="comment">                 *          (2) å·¦æ—‹ç¥–çˆ¶</span></span><br><span class="line"><span class="comment">                 *           é»‘ç¥–                        çº¢çˆ¶</span></span><br><span class="line"><span class="comment">                 *           / \                         / \</span></span><br><span class="line"><span class="comment">                 *        é»‘å”  çº¢çˆ¶    --(å·¦æ—‹)--&gt;    é»‘ç¥–  çº¢æ’</span></span><br><span class="line"><span class="comment">                 *               \                    /</span></span><br><span class="line"><span class="comment">                 *               çº¢æ’               é»‘å”</span></span><br><span class="line"><span class="comment">                 *          (3) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²</span></span><br><span class="line"><span class="comment">                 *           çº¢çˆ¶                        é»‘çˆ¶</span></span><br><span class="line"><span class="comment">                 *           / \                         / \</span></span><br><span class="line"><span class="comment">                 *        é»‘å”  çº¢æ’    --(å˜è‰²)--&gt;    çº¢ç¥–  çº¢æ’</span></span><br><span class="line"><span class="comment">                 *         /                         /</span></span><br><span class="line"><span class="comment">                 *       é»‘å”                      é»‘å”</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 * attention:</span></span><br><span class="line"><span class="comment">                 * ä¸‰è§’å…³ç³»ç»è¿‡ä¸€æ­¥æ—‹è½¬å³å¯è½¬æ¢æˆä¸‰ç‚¹ä¸€çº¿</span></span><br><span class="line"><span class="comment">                 * å› æ­¤case3å…ˆç»è¿‡ä¸€æ­¥å¤„ç†åˆ°case2ï¼Œå†è¿›è¡Œcase2çš„å¤„ç†</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (paren.getLeft() == node) &#123; <span class="comment">// case3</span></span><br><span class="line">                        rightRotate(paren);</span><br><span class="line">                        RBTNode&lt;T, D&gt; temp = node;</span><br><span class="line">                        node = paren;</span><br><span class="line">                        paren = temp;</span><br><span class="line">                    &#125; <span class="comment">// case2</span></span><br><span class="line">                    leftRotate(grand);</span><br><span class="line">                    grand.updateColor();</span><br><span class="line">                    paren.updateColor();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ä¿è¯æ ¹èŠ‚ç‚¹ä¸ºé»‘è‰² */</span></span><br><span class="line">        <span class="keyword">if</span> (root == node) &#123;</span><br><span class="line">            node.setColor(RBTColor.black);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;åˆ é™¤ç»“ç‚¹&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;ä¸‰ç§æƒ…å†µ&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;case1. å¾…åˆ ç»“ç‚¹å·¦å­å’Œå³å­éƒ½å­˜åœ¨&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;case2. å¾…åˆ ç»“ç‚¹æ²¡æœ‰å·¦å­å’Œå³å­&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;li&gt;case3. å¾…åˆ ç»“ç‚¹åªæœ‰å·¦å­æˆ–è€…å³å­&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deleteNode</span><span class="params">(RBTNode&lt;T, D&gt; node)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* çˆ¶äº² Â· å„¿å­ Â· ç»§æ‰¿è€… */</span></span><br><span class="line">        RBTNode&lt;T, D&gt; paren, child, replace;</span><br><span class="line">        RBTColor color;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * case1: å¾…åˆ ç»“ç‚¹å·¦å­å’Œå³å­éƒ½å­˜åœ¨</span></span><br><span class="line"><span class="comment">         * solution1:</span></span><br><span class="line"><span class="comment">         * - æ‰¾åˆ°è¯¥ç»“ç‚¹çš„å³å­æ ‘ä¸­çš„æœ€å·¦å­ç»“ç‚¹</span></span><br><span class="line"><span class="comment">         * - æŠŠå®ƒçš„å€¼å’Œè¦åˆ é™¤çš„ç»“ç‚¹çš„å€¼è¿›è¡Œäº¤æ¢</span></span><br><span class="line"><span class="comment">         * - ç„¶ååˆ é™¤è¿™ä¸ªç»“ç‚¹å³ç›¸å½“äºåˆ é™¤æ‰€éœ€åˆ é™¤ç»“ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> ((node.getLeft() != <span class="keyword">null</span>) &amp;&amp; (node.getRight() != <span class="keyword">null</span>))  &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*  è·å–å…¶åç»§ç»“ç‚¹: å³å­æ ‘ä¸­çš„æœ€å·¦å­ç»“ç‚¹ */</span></span><br><span class="line">            replace = descendants(node);</span><br><span class="line">            paren = replace.getParent();</span><br><span class="line">            child = replace.getRight();</span><br><span class="line">            color = replace.getColor();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (node == replace.getParent()) &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * case:</span></span><br><span class="line"><span class="comment">                 *    node              replace</span></span><br><span class="line"><span class="comment">                 *      \                  \</span></span><br><span class="line"><span class="comment">                 *      replace    --&gt;    child</span></span><br><span class="line"><span class="comment">                 *         \</span></span><br><span class="line"><span class="comment">                 *         child</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                paren = replace;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * case:</span></span><br><span class="line"><span class="comment">                 *     node                replace</span></span><br><span class="line"><span class="comment">                 *       \                   \</span></span><br><span class="line"><span class="comment">                 *        X                   X</span></span><br><span class="line"><span class="comment">                 *       / \                 / \</span></span><br><span class="line"><span class="comment">                 *  paren   X    --&gt;    paren   X</span></span><br><span class="line"><span class="comment">                 *     /                  /</span></span><br><span class="line"><span class="comment">                 *  replace            child</span></span><br><span class="line"><span class="comment">                 *     \</span></span><br><span class="line"><span class="comment">                 *     child</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="comment">/* å»ºç«‹æ›¿ä»£ç»“ç‚¹çš„çˆ¶äº²ä¸æ›¿æ¢ç»“ç‚¹çš„å³å­çš„çˆ¶å­å…³ç³»ï¼Œå³çˆ·å­™å¤‰çˆ¶å­ */</span></span><br><span class="line">                <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    child.setParent(replace.getParent());</span><br><span class="line">                &#125;</span><br><span class="line">                replace.getParent().setLeft(child);</span><br><span class="line">                <span class="comment">/* å»ºç«‹æ›¿ä»£èŠ‚ç‚¹ä¸å¾…åˆ èŠ‚ç‚¹çš„å³å­çš„çˆ¶å­å…³ç³» */</span></span><br><span class="line">                replace.setRight(node.getRight());</span><br><span class="line">                node.getRight().setParent(replace);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* å¾…åˆ èŠ‚ç‚¹çš„çˆ¶äº²è®¾ç½®ä¸ºæ›¿ä»£ç»“ç‚¹çš„çˆ¶äº² */</span></span><br><span class="line">            replace.setParent(node.getParent());</span><br><span class="line">            <span class="comment">/* å»ºç«‹æ›¿æ¢ç»“ç‚¹ä¸å¾…åˆ èŠ‚ç‚¹å·¦å­çš„çˆ¶å­å…³ç³» */</span></span><br><span class="line">            replace.setLeft(node.getLeft());</span><br><span class="line">            node.getLeft().setParent(replace);</span><br><span class="line">            <span class="comment">/* æ›¿ä»£ç»“ç‚¹æ²¿ç”¨å¾…åˆ èŠ‚ç‚¹çš„é¢œè‰² */</span></span><br><span class="line">            replace.setColor(node.getColor());</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* å¾…åˆ ç»“ç‚¹çš„çˆ¶äº²ä¸ä¸ºç©ºï¼Œåˆ™è°ƒæ•´å·¦å³å­ */</span></span><br><span class="line">            <span class="keyword">if</span> (node.getParent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node.getParent().getLeft() == node) &#123;</span><br><span class="line">                    node.getParent().setLeft(replace);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    node.getParent().setRight(replace);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* å¾…åˆ ç»“ç‚¹çš„çˆ¶äº²ä¸ºç©ºï¼Œåˆ™è®¾ç½®æ ¹ç»“ç‚¹ */</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.root = replace;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* åˆ é™¤é»‘è‰²ç»“ç‚¹éœ€è¦è°ƒæ•´å¹³è¡¡ï¼Œçº¢è‰²ä¸éœ€è¦ */</span></span><br><span class="line">            <span class="keyword">if</span> (color == RBTColor.black) &#123;</span><br><span class="line">                balanceDeletion(child, paren);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * case2: å¾…åˆ ç»“ç‚¹æ²¡æœ‰å·¦å­å’Œå³å­</span></span><br><span class="line"><span class="comment">         * solution2: ç›´æ¥åˆ é™¤ç»“ç‚¹</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>((node.getLeft() == <span class="keyword">null</span>) &amp;&amp; (node.getRight() == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            paren = node.getParent();</span><br><span class="line">            <span class="keyword">if</span> (node == paren.getLeft()) &#123;</span><br><span class="line">                paren.setLeft(node.getLeft());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                paren.setRight(node.getRight());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * case3: å¾…åˆ ç»“ç‚¹åªæœ‰å·¦å­æˆ–è€…å³å­</span></span><br><span class="line"><span class="comment">         * solution3: å¾…åˆ èŠ‚ç‚¹çš„çˆ¶äº²æŒ‡å‘å­˜åœ¨çš„å­å—£</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* ç¡®å®šæ›¿ä»£ç»“ç‚¹ */</span></span><br><span class="line">            <span class="keyword">if</span> (node.getLeft() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                replace = node.getLeft();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                replace = node.getRight();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* å¾…åˆ ç»“ç‚¹çš„çˆ¶äº² */</span></span><br><span class="line">            paren = node.getParent();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* å¾…åˆ ç»“ç‚¹çš„çˆ¶äº²æ˜¯å¦ä¸ºç©º */</span></span><br><span class="line">            <span class="keyword">if</span> (paren != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (paren.getLeft() == node) &#123;</span><br><span class="line">                    paren.setLeft(replace);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    paren.setRight(replace);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.root = replace;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* å¾…åˆ èŠ‚ç‚¹çš„çˆ¶äº²æŒ‡å‘æ›¿ä»£ç»“ç‚¹ */</span></span><br><span class="line">            replace.setParent(paren);</span><br><span class="line"></span><br><span class="line">            color = node.getColor();</span><br><span class="line">            child = replace;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* åˆ é™¤é»‘è‰²ç»“ç‚¹éœ€è¦è°ƒæ•´å¹³è¡¡ï¼Œçº¢è‰²ä¸éœ€è¦ */</span></span><br><span class="line">            <span class="keyword">if</span> (color == RBTColor.black) &#123;</span><br><span class="line">                balanceDeletion(child, paren);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ç»“ç‚¹æ•°é‡-1 */</span></span><br><span class="line">        count.decrementAndGet();</span><br><span class="line">        System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] keyä¸º&quot;</span> + node.getKey() + <span class="string">&quot;çš„ç»“ç‚¹åˆ é™¤æˆåŠŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;å¯»æ‰¾ç»§æ‰¿çš„åè£”&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RBTNode&lt;T, D&gt; <span class="title">descendants</span><span class="params">(RBTNode&lt;T, D&gt; node)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* æŸ¥è¯¢å¤§äºè¯¥èŠ‚ç‚¹çš„æœ€å°ç»“ç‚¹ï¼Œå³å³å­æ ‘çš„æœ€å·¦ç»“ç‚¹ */</span></span><br><span class="line">        <span class="keyword">if</span> (node.getRight() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            RBTNode&lt;T, D&gt; right = node.getRight();</span><br><span class="line">            <span class="keyword">if</span> (right.getLeft() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> right;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (right.getLeft() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                right = right.getLeft();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> right;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* @deprecated */</span></span><br><span class="line">        RBTNode&lt;T, D&gt; paren = node.getParent();</span><br><span class="line">        <span class="keyword">while</span> ((paren != <span class="keyword">null</span>) &amp;&amp; (paren.getRight() == node)) &#123;</span><br><span class="line">            node = paren;</span><br><span class="line">            paren = paren.getParent();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> paren;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;åˆ é™¤ç»“ç‚¹çš„è‡ªå¹³è¡¡æ“ä½œ&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * P-çˆ¶äº²ã€D-åˆ é™¤ã€B-å…„å¼Ÿã€BR-å…„å¼Ÿå³å­ã€BL-å…„å¼Ÿå·¦å­ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * - Dä¸ºå·¦å­</span></span><br><span class="line"><span class="comment">     *   - Bä¸ºçº¢è‰²ï¼šå·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue</span></span><br><span class="line"><span class="comment">     *   - Bä¸ºé»‘è‰²</span></span><br><span class="line"><span class="comment">     *     - BLä¸ºé»‘è‰²ä¸”BRé»‘è‰²ï¼šå…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯</span></span><br><span class="line"><span class="comment">     *     - BLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå³æ—‹å…„å¼Ÿï¼Œå…„å¼ŸæŸ“çº¢ï¼ŒBLæŸ“é»‘</span></span><br><span class="line"><span class="comment">     *     - BRä¸ºçº¢è‰²ï¼šå·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBRé»‘åŒ–ï¼Œç„¶åbreak</span></span><br><span class="line"><span class="comment">     * - Dä¸ºå³å­</span></span><br><span class="line"><span class="comment">     *   - Bä¸ºçº¢è‰²ï¼šå³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue</span></span><br><span class="line"><span class="comment">     *   - Bä¸ºé»‘è‰²ï¼š</span></span><br><span class="line"><span class="comment">     *     - BLä¸ºé»‘è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯</span></span><br><span class="line"><span class="comment">     *     - BLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå·¦æ—‹å…„å¼Ÿï¼Œçˆ¶äº²æŸ“çº¢ï¼ŒBRæŸ“é»‘</span></span><br><span class="line"><span class="comment">     *     - BLä¸ºçº¢è‰²ï¼šå³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBLé»‘åŒ–ï¼Œç„¶åbreak</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paren</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     *     å…¥å‚æƒ…å†µ:</span></span><br><span class="line"><span class="comment">     *     1. node=æ›¿æ¢èŠ‚ç‚¹ paren=æ›¿æ¢èŠ‚ç‚¹çš„çˆ¶äº²èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     *     2. node=æ›¿æ¢èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹ paren=æ›¿æ¢èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     *     3. node=æ›¿æ¢èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹ parent=æ›¿æ¢èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">balanceDeletion</span><span class="params">(RBTNode&lt;T, D&gt; node, RBTNode&lt;T, D&gt; paren)</span> </span>&#123;</span><br><span class="line">        RBTNode&lt;T, D&gt; broth;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (isBlack(node) &amp;&amp; node != <span class="keyword">this</span>.root) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (paren.getLeft() == node) &#123;</span><br><span class="line">                broth = paren.getRight();</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * case1: Dä¸ºå·¦å­ã€‚Bä¸ºçº¢è‰²</span></span><br><span class="line"><span class="comment">                 * solution1: å·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (isRed(broth)) &#123;</span><br><span class="line">                    leftRotate(paren);</span><br><span class="line">                    paren.setColor(RBTColor.red);</span><br><span class="line">                    broth.setColor(RBTColor.black);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * case2: Dä¸ºå·¦å­ã€‚Bä¸ºé»‘è‰²ï¼ŒBLä¸ºé»‘è‰²ä¸”BRä¸ºé»‘è‰²</span></span><br><span class="line"><span class="comment">                     * solution2: å…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> (isBlack(broth.getLeft()) &amp;&amp; isBlack(broth.getRight())) &#123;</span><br><span class="line">                        broth.setColor(RBTColor.red);</span><br><span class="line">                        node = paren;</span><br><span class="line">                        paren = paren.getParent();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * case3: Dä¸ºå·¦å­ã€‚Bä¸ºé»‘è‰²ï¼ŒBLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²</span></span><br><span class="line"><span class="comment">                     * solution3: å³æ—‹å…„å¼Ÿï¼Œå…„å¼ŸæŸ“çº¢ï¼ŒBLæŸ“é»‘</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (isRed(broth.getLeft()) &amp;&amp; isBlack(broth.getRight())) &#123;</span><br><span class="line">                        rightRotate(broth);</span><br><span class="line">                        broth.setColor(RBTColor.red);</span><br><span class="line">                        broth.getLeft().setColor(RBTColor.black);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * case4: Dä¸ºå·¦å­ï¼ŒBä¸ºé»‘è‰²ï¼ŒBRä¸ºçº¢è‰²</span></span><br><span class="line"><span class="comment">                     * solution4: å·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBRé»‘åŒ–ï¼Œç„¶åbreak</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (isRed(broth.getRight())) &#123;</span><br><span class="line">                        leftRotate(paren);</span><br><span class="line">                        broth.setColor(paren.getColor());</span><br><span class="line">                        paren.setColor(RBTColor.black);</span><br><span class="line">                        broth.getRight().setColor(RBTColor.black);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                broth = paren.getLeft();</span><br><span class="line"></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * case5: Dä¸ºå³å­ã€‚Bä¸ºçº¢è‰²</span></span><br><span class="line"><span class="comment">                 * solution5: å³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">if</span> (isRed(broth)) &#123;</span><br><span class="line">                    rightRotate(paren);</span><br><span class="line">                    paren.setColor(RBTColor.red);</span><br><span class="line">                    broth.setColor(RBTColor.black);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * case6: Dä¸ºå³å­ã€‚Bä¸ºé»‘è‰²ï¼ŒBLä¸ºé»‘è‰²ä¸”BRä¸ºé»‘è‰²</span></span><br><span class="line"><span class="comment">                     * solution6: å…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> (isBlack(broth.getLeft()) &amp;&amp; isBlack(broth.getRight())) &#123;</span><br><span class="line">                        broth.setColor(RBTColor.red);</span><br><span class="line">                        node = paren;</span><br><span class="line">                        paren = paren.getParent();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * case7: Dä¸ºå³å­ã€‚Bä¸ºé»‘è‰²ï¼ŒBLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²</span></span><br><span class="line"><span class="comment">                     * solution7: å·¦æ—‹å…„å¼Ÿï¼Œçˆ¶äº²æŸ“çº¢ï¼ŒBRæŸ“é»‘</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (isRed(broth.getLeft()) &amp;&amp; isBlack(broth.getRight())) &#123;</span><br><span class="line">                        leftRotate(broth);</span><br><span class="line">                        paren.setColor(RBTColor.red);</span><br><span class="line">                        broth.getRight().setColor(RBTColor.black);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * case8: Dä¸ºå³å­ï¼ŒBä¸ºé»‘è‰²ï¼ŒBRä¸ºçº¢è‰²</span></span><br><span class="line"><span class="comment">                     * solution8: å³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBLé»‘åŒ–ï¼Œç„¶åbreak</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (isRed(broth.getRight())) &#123;</span><br><span class="line">                        rightRotate(paren);</span><br><span class="line">                        broth.setColor(paren.getColor());</span><br><span class="line">                        paren.setColor(RBTColor.black);</span><br><span class="line">                        broth.getRight().setColor(RBTColor.black);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* nodeæŸ“æˆè¢«åˆ ç»“ç‚¹çš„é¢œè‰² */</span></span><br><span class="line">        node.setColor(RBTColor.black);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;å±‚æ¬¡éå†&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">levelOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;List&lt;RBTNode&lt;T, D&gt;&gt;&gt; levelList = levelOrder(<span class="keyword">this</span>.root);</span><br><span class="line">        <span class="keyword">for</span> (List&lt;RBTNode&lt;T, D&gt;&gt; list:levelList) &#123;</span><br><span class="line">            <span class="keyword">for</span> (RBTNode node : list) &#123;</span><br><span class="line">                System.out.print(node.getKey() + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;å±‚æ¬¡éå†&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;List&lt;RBTNode&lt;T, D&gt;&gt;&gt; levelOrder(RBTNode&lt;T, D&gt; node) &#123;</span><br><span class="line">        List&lt;List&lt;RBTNode&lt;T, D&gt;&gt;&gt; res = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        Queue&lt;RBTNode&lt;T, D&gt;&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        queue.add(node);</span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">int</span> count = queue.size();</span><br><span class="line">            List&lt;RBTNode&lt;T, D&gt;&gt; cur = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (count != <span class="number">0</span>) &#123;</span><br><span class="line">                RBTNode&lt;T, D&gt; temp = queue.poll();</span><br><span class="line">                cur.add(temp);</span><br><span class="line">                <span class="keyword">if</span> (temp.getLeft() != <span class="keyword">null</span>) queue.add(temp.getLeft());</span><br><span class="line">                <span class="keyword">if</span> (temp.getRight() != <span class="keyword">null</span>) queue.add(temp.getRight());</span><br><span class="line">                count--;</span><br><span class="line">            &#125;</span><br><span class="line">            res.add(cur);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;è¾“å‡ºçº¢é»‘æ ‘çš„å±‚çº§ç»“æ„&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printRBTreeLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] å¼€å§‹æ‰“å°çº¢é»‘æ ‘çš„å±‚çº§ç»“æ„&quot;</span>);</span><br><span class="line">        ConcurrentHashMap&lt;Integer, List&lt;RBTNode&gt;&gt; map = showTree();</span><br><span class="line">        <span class="keyword">int</span> size = map.size();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; map.size(); i++) &#123;</span><br><span class="line">            System.out.println();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; map.get(i).size(); j++) &#123;</span><br><span class="line">                System.out.print( makeSpace(size, i) +</span><br><span class="line">                        (map.get(i).get(j).getKey() == <span class="keyword">null</span> ? <span class="string">&quot; &quot;</span> : (map.get(i).get(j).getKey()) + (map.get(i).get(j).getColor() == RBTColor.black ? <span class="string">&quot;(é»‘)&quot;</span> : <span class="string">&quot;(çº¢)&quot;</span>)) + makeSpace(size, i));</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] çº¢é»‘æ ‘çš„å±‚çº§ç»“æ„æ‰“å°å®Œæ¯•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;è¾“å‡ºæ•´æ£µæ ‘çš„Graphvizç»“æ„&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printGraphviz</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] å¼€å§‹æ‰“å°æ ‘çš„Graphvizç»“æ„&quot;</span>);</span><br><span class="line">        ConcurrentHashMap&lt;Integer, List&lt;RBTNode&gt;&gt; map = showTree();</span><br><span class="line">        <span class="keyword">int</span> size = map.size();</span><br><span class="line">        System.out.println(<span class="string">&quot;digraph &#123;&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; map.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; map.get(i).size(); j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(map.get(i).get(j).getKey() != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    System.out.println(map.get(i).get(j).getKey() + <span class="string">&quot; [color=&quot;</span>  + (map.get(i).get(j).getColor()) + <span class="string">&quot;] &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; map.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; map.get(i).size(); j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(map.get(i).get(j).getKey() != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(map.get(i).get(j).getLeft() != <span class="keyword">null</span>)&#123;</span><br><span class="line">                        System.out.println(map.get(i).get(j).getKey() + <span class="string">&quot;-&gt;&quot;</span> + map.get(i).get(j).getLeft().getKey() + <span class="string">&quot;[label=left]&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(map.get(i).get(j).getRight() != <span class="keyword">null</span>)&#123;</span><br><span class="line">                        System.out.println(map.get(i).get(j).getKey() + <span class="string">&quot;-&gt;&quot;</span> + map.get(i).get(j).getRight().getKey() + <span class="string">&quot;[label=right]&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] æ ‘çš„Graphvizç»“æ„æ‰“å°å®Œæ¯•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">makeSpace</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> index)</span></span>&#123;</span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1</span> &lt;&lt; (size - index); i++) &#123;</span><br><span class="line">            builder.append(<span class="string">&quot;  &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConcurrentHashMap&lt;Integer, List&lt;RBTNode&gt;&gt; showTree()&#123;</span><br><span class="line">        ConcurrentHashMap&lt;Integer, List&lt;RBTNode&gt;&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">        showTree(root, <span class="number">0</span>, map);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showTree</span><span class="params">(RBTNode root, <span class="keyword">int</span> count, ConcurrentHashMap&lt;Integer, List&lt;RBTNode&gt;&gt; map)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (map.get(count) == <span class="keyword">null</span>)&#123;</span><br><span class="line">            map.put(count, <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        map.get(count).add(root);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (root.getLeft() != <span class="keyword">null</span>)&#123;</span><br><span class="line">            showTree(root.getLeft(), count+<span class="number">1</span> , map);</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(map.get(count+<span class="number">1</span>) == <span class="keyword">null</span>)&#123;</span><br><span class="line">                map.put(count+<span class="number">1</span>, <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">            map.get(count+<span class="number">1</span>).add(<span class="keyword">new</span> RBTNode(RBTColor.red, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root.getRight() != <span class="keyword">null</span>)&#123;</span><br><span class="line">            showTree(root.getRight(), count+<span class="number">1</span> , map);</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(map.get(count+<span class="number">1</span>) == <span class="keyword">null</span>)&#123;</span><br><span class="line">                map.put(count+<span class="number">1</span>, <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">            map.get(count+<span class="number">1</span>).add(<span class="keyword">new</span> RBTNode(RBTColor.red, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;èœå•&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RBT</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedBlackTree KTree = <span class="keyword">new</span> RedBlackTree();</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            System.out.println((<span class="string">&quot;â”â”â”â”â”â”â”â”â”â” â–¶ â–¶ â–¶ â–¶ â–¶ RED â¤ BLACK â—€ â—€ â—€ â—€ â—€ â”â”â”â”â”â”â”â”â”â”â”“&quot;</span>));</span><br><span class="line">            System.out.println((<span class="string">&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 1. æ’å…¥èŠ‚ç‚¹ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;</span>));</span><br><span class="line">            System.out.println((<span class="string">&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 2. æŸ¥è¯¢èŠ‚ç‚¹ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;</span>));</span><br><span class="line">            System.out.println((<span class="string">&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 3. åˆ é™¤ç»“ç‚¹ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;</span>));</span><br><span class="line">            System.out.println((<span class="string">&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 4. æŸ¥è¯¢æ•°é‡ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;</span>));</span><br><span class="line">            System.out.println((<span class="string">&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 5. å±‚æ¬¡ç»“æ„ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;</span>));</span><br><span class="line">            System.out.println((<span class="string">&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 6. Graphviz â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;</span>));</span><br><span class="line">            System.out.println((<span class="string">&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 7. é€€å‡ºç³»ç»Ÿ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;</span>));</span><br><span class="line">            System.out.println((<span class="string">&quot;â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›&quot;</span>));</span><br><span class="line"></span><br><span class="line">            System.out.print(getCurrentTime() + <span class="string">&quot; [input] è¾“å…¥é€‰æ‹©ï¼š&quot;</span>);</span><br><span class="line">            <span class="keyword">int</span> choice = scanner.nextInt();</span><br><span class="line">            <span class="keyword">int</span> key;</span><br><span class="line">            String value;</span><br><span class="line">            <span class="keyword">switch</span> (choice) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    System.out.print(getCurrentTime() + <span class="string">&quot; [INPUT] è¾“å…¥é”®å€¼ï¼š&quot;</span>);</span><br><span class="line">                    key = scanner.nextInt();</span><br><span class="line">                    System.out.print(getCurrentTime() + <span class="string">&quot; [INPUT] è¾“å…¥æ•°æ®ï¼š&quot;</span>);</span><br><span class="line">                    value = scanner.next();</span><br><span class="line">                    KTree.add(key, value);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    System.out.print(getCurrentTime() + <span class="string">&quot; [INPUT] è¾“å…¥é”®å€¼ï¼š&quot;</span>);</span><br><span class="line">                    key = scanner.nextInt();</span><br><span class="line">                    System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] æŸ¥è¯¢ç»“æœ value = &quot;</span> + KTree.get(key));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    System.out.print(getCurrentTime() + <span class="string">&quot; [INPUT] è¾“å…¥é”®å€¼ï¼š&quot;</span>);</span><br><span class="line">                    key = scanner.nextInt();</span><br><span class="line">                    KTree.del(key);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                    System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] æŸ¥è¯¢ç»“æœ size = &quot;</span> + KTree.size());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                    KTree.printRBTreeLevel();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                    KTree.printGraphviz();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                    System.out.println(getCurrentTime() + <span class="string">&quot; [INFO] é€€å‡ºæˆåŠŸ&quot;</span>);</span><br><span class="line">                    System.exit(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    System.out.println(getCurrentTime() + <span class="string">&quot; [ERROR] è¾“å…¥é”™è¯¯&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RedBlackTree redBlackTree = <span class="keyword">new</span> RedBlackTree();</span><br><span class="line">        redBlackTree.RBT();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
      <tags>
        <tag>RedBlackTree</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL</title>
    <url>/posts/c24675b4/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="MySQLæ¦‚è¿°"><a href="#MySQLæ¦‚è¿°" class="headerlink" title="MySQLæ¦‚è¿°"></a>MySQLæ¦‚è¿°</h2><h3 id="CentOS7å®‰è£…"><a href="#CentOS7å®‰è£…" class="headerlink" title="CentOS7å®‰è£…"></a>CentOS7å®‰è£…</h3><blockquote>
<p>ä¸‹è½½RPMå®‰è£…åŒ…</p>
</blockquote>
<p>ä¸‹è½½: <a href="https://downloads.mysql.com/archives/community/">mysql download</a></p>
<p>å°†å››ä¸ªåŒ…ä¸‹è½½åç§»åŠ¨åˆ°optæ–‡ä»¶å¤¹ä¸‹</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314104200636.png" class="" title="s"><br />






<blockquote>
<p>æ£€æŸ¥æ˜¯å¦å·²å®‰è£…MySQL</p>
</blockquote>
<p>å¦‚æœæ²¡æœ‰ä¿¡æ¯æ˜¾ç¤ºåˆ™è¡¨ç¤ºæœªå®‰è£…MySQL</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rpm -qa | grep -i mysql</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>å®‰è£…MySQL</p>
</blockquote>
<p><code>-i</code>ï¼šæ˜¾ç¤ºå¥—ä»¶çš„æ–‡ä»¶åˆ—è¡¨</p>
<p><code>-v</code>ï¼šæ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹</p>
<p><code>-h</code>ï¼šå¥—ä»¶å®‰è£…æ—¶åˆ—å‡ºæ ‡è®°</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> rpm -ivh &lt;åŒ…å&gt;</span></span><br></pre></td></tr></table></figure>

<p>å®‰è£…é¡ºåºï¼š</p>
<ol>
<li>common</li>
<li>libs</li>
<li>client</li>
<li>server</li>
</ol>
<p>ä¾èµ–å†²çªï¼š</p>
<p>ç›´æ¥å¸è½½mariadb</p>
<p>è¯¦æƒ…å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@parak opt]# rpm -ivh mysql-community-common-8.0.20-1.el7.x86_64.rpm </span><br><span class="line">è­¦å‘Šï¼šmysql-community-common-8.0.20-1.el7.x86_64.rpm: å¤´V3 DSA/SHA1 Signature, å¯†é’¥ ID 5072e1f5: NOKEY</span><br><span class="line">å‡†å¤‡ä¸­...                          ################################# [100%]</span><br><span class="line">æ­£åœ¨å‡çº§/å®‰è£…...</span><br><span class="line">   1:mysql-community-common-8.0.20-1.e################################# [100%]</span><br><span class="line">[root@parak opt]# rpm -ivh mysql-community-libs-8.0.20-1.el7.x86_64.rpm </span><br><span class="line">è­¦å‘Šï¼šmysql-community-libs-8.0.20-1.el7.x86_64.rpm: å¤´V3 DSA/SHA1 Signature, å¯†é’¥ ID 5072e1f5: NOKEY</span><br><span class="line">é”™è¯¯ï¼šä¾èµ–æ£€æµ‹å¤±è´¥ï¼š</span><br><span class="line">	mariadb-libs è¢« mysql-community-libs-8.0.20-1.el7.x86_64 å–ä»£</span><br><span class="line">[root@parak opt]# rpm -qa | grep mariadb</span><br><span class="line">mariadb-libs-5.5.68-1.el7.x86_64</span><br><span class="line">[root@parak opt]# rpm -e mariadb-libs-5.5.68-1.el7.x86_64</span><br><span class="line">é”™è¯¯ï¼šä¾èµ–æ£€æµ‹å¤±è´¥ï¼š</span><br><span class="line">	libmysqlclient.so.18()(64bit) è¢« (å·²å®‰è£) postfix-2:2.10.1-9.el7.x86_64 éœ€è¦</span><br><span class="line">	libmysqlclient.so.18(libmysqlclient_18)(64bit) è¢« (å·²å®‰è£) postfix-2:2.10.1-9.el7.x86_64 éœ€è¦</span><br><span class="line">[root@parak opt]# rpm -e --nodeps mariadb-libs-5.5.68-1.el7.x86_64</span><br><span class="line">[root@parak opt]# rpm -ivh mysql-community-libs-8.0.20-1.el7.x86_64.rpm </span><br><span class="line">è­¦å‘Šï¼šmysql-community-libs-8.0.20-1.el7.x86_64.rpm: å¤´V3 DSA/SHA1 Signature, å¯†é’¥ ID 5072e1f5: NOKEY</span><br><span class="line">å‡†å¤‡ä¸­...                          ################################# [100%]</span><br><span class="line">æ­£åœ¨å‡çº§/å®‰è£…...</span><br><span class="line">   1:mysql-community-libs-8.0.20-1.el7################################# [100%]</span><br><span class="line">[root@parak opt]# rpm -ivh mysql-community-client-8.0.20-1.el7.x86_64.rpm </span><br><span class="line">è­¦å‘Šï¼šmysql-community-client-8.0.20-1.el7.x86_64.rpm: å¤´V3 DSA/SHA1 Signature, å¯†é’¥ ID 5072e1f5: NOKEY</span><br><span class="line">å‡†å¤‡ä¸­...                          ################################# [100%]</span><br><span class="line">æ­£åœ¨å‡çº§/å®‰è£…...</span><br><span class="line">   1:mysql-community-client-8.0.20-1.e################################# [100%]</span><br><span class="line">[root@parak opt]# rpm -ivh mysql-community-server-8.0.20-1.el7.x86_64.rpm </span><br><span class="line">è­¦å‘Šï¼šmysql-community-server-8.0.20-1.el7.x86_64.rpm: å¤´V3 DSA/SHA1 Signature, å¯†é’¥ ID 5072e1f5: NOKEY</span><br><span class="line">å‡†å¤‡ä¸­...                          ################################# [100%]</span><br><span class="line">æ­£åœ¨å‡çº§/å®‰è£…...</span><br><span class="line">   1:mysql-community-server-8.0.20-1.e################################# [100%]</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ</p>
</blockquote>
<ul>
<li>æ–¹å¼ä¸€ï¼šæŸ¥çœ‹mysqlç‰ˆæœ¬å·<code>mysqladmin --version</code></li>
<li>æ–¹å¼äºŒï¼šæŸ¥çœ‹æ˜¯å¦åˆ›å»ºäº†mysqlç”¨æˆ·(ç»„)<code>cat /etc/passwd | grep mysql</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@parak opt]# mysqladmin --version</span><br><span class="line">mysqladmin  Ver 8.0.20 for Linux on x86_64 (MySQL Community Server - GPL)</span><br><span class="line">[root@parak opt]# cat /etc/passwd | grep mysql</span><br><span class="line">mysql:x:27:27:MySQL Server:/var/lib/mysql:/bin/false</span><br></pre></td></tr></table></figure>



<blockquote>
<p>å¯åŠ¨MySQLæœåŠ¡</p>
</blockquote>
<ul>
<li>å¯åŠ¨MySQLï¼š<code>systemctl start mysqld</code></li>
<li>åœæ­¢MySQLï¼š<code>systemctl stop mysqld</code></li>
</ul>
<blockquote>
<p>ç™»å½•MySQL</p>
</blockquote>
<p>ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>æ–¹å¼ä¸€ï¼šæŸ¥çœ‹MySQLåˆå§‹å¯†ç <code> cat /var/log/mysqld.log | grep password</code></li>
<li>æ–¹å¼äºŒï¼šä¿®æ”¹<code>my.cnf</code>é…ç½®æ–‡ä»¶ç”¨äºè·³è¿‡å¯†ç ï¼Œåœ¨<code>[mysqld]</code>ä¸‹æ·»åŠ <code> skip-grant-tables</code></li>
</ul>
<p>æ¨èä½¿ç”¨ç¬¬ä¸€ç§ï¼Œå› ä¸ºåœ¨MySQL8åœ¨è·³è¿‡ç™»å½•çš„çŠ¶æ€ä¸‹æ˜¯ä¸å…è®¸ä¿®æ”¹ç™»å½•å¯†ç çš„ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ç™»å½•mysql</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql -uroot -p</span></span><br><span class="line">Enter password:</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¿®æ”¹æ ¡éªŒå¯†ç ç­–ç•¥ç­‰çº§</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql&gt; <span class="built_in">set</span> global validate_password.policy=LOW;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è®¾ç½®å¯†ç æœ€å°é•¿åº¦</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql&gt; <span class="built_in">set</span> global validate_password.length=1;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æœ€åè®¾ç½®å¯†ç </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY &lt;password&gt;;</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>Navicatè¿æ¥äº§ç”Ÿé—®é¢˜</p>
</blockquote>
<p>ï¼ˆ1ï¼‰HOST <IP> is not allowed to connect to this mysql server</p>
<p>è§£å†³ï¼šå…³é—­é˜²ç«å¢™ï¼Œæ›´æ–°å¯è¿æ¥IP</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl status firewalld.service</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å…³é—­é˜²ç«å¢™</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl stop firewalld.service</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¦æ­¢è‡ªå¯åŠ¨</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> systemctl <span class="built_in">disable</span> firewalld.service</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è®©æ‰€æœ‰IPéƒ½å¯ä»¥è¿æ¥MySQL</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql&gt; update user <span class="built_in">set</span> host=<span class="string">&#x27;%&#x27;</span> <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ·æ–°æƒé™</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql&gt; flush privileges;</span></span><br></pre></td></tr></table></figure>



<p>ï¼ˆ2ï¼‰Client does not support authentication protocol requested by server</p>
<p>è§£å†³ï¼šæ›´æ”¹åŠ å¯†è§„åˆ™ï¼Œæ›´æ–°ç”¨æˆ·å¯†ç </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="comment">#æ›´æ”¹åŠ å¯†æ–¹å¼</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql&gt; ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;password&#x27;</span> PASSWORD EXPIRE NEVER; </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ›´æ–°ç”¨æˆ·å¯†ç </span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql&gt; ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;&lt;password&gt;&#x27;</span>;</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>è®¾ç½®å¼€æœºè‡ªå¯åŠ¨</p>
</blockquote>
<p>æŒ‰ç…§ä»¥ä¸Šå®‰è£…æ–¹å¼mysqlæœåŠ¡æ˜¯é»˜è®¤å¼€æœºè‡ªå¯åŠ¨çš„ï¼Œå¯ä»¥é€šè¿‡<code>systemctl list-unit-files </code>æŸ¥çœ‹å¼€æœºå¯åŠ¨é¡¹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@parak mysql]# systemctl list-unit-files | grep mysql</span><br><span class="line">mysqld.service                                enabled </span><br><span class="line">mysqld@.service                               disabled</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸æ˜¯å¼€æœºè‡ªå¯åŠ¨ï¼Œå¯ä»¥é€šè¿‡<code>ntsysv</code>å¯ç”¨æœåŠ¡ï¼Œ<code>[]</code>ä¸­è®¾ç½®<code>*</code>å³å¯ä½¿å…¶å¼€æœºè‡ªå¯åŠ¨ï¼š</p>
<ul>
<li>ä¸Šä¸‹é”®ï¼šå¯ä»¥åœ¨ä¸­é—´çš„æ–¹æ¡†å½“ä¸­ï¼Œåœ¨å„ä¸ªæœåŠ¡ä¹‹é—´ç§»åŠ¨</li>
<li>ç©ºæ ¼é”®ï¼šå¯ä»¥ç”¨æ¥é€‰æ‹©ä½ æ‰€éœ€è¦çš„æœåŠ¡ï¼Œ[*]è¡¨ç¤ºå¼€èµ·å¯åŠ¨</li>
<li>tabé”®ï¼šå¯ä»¥åœ¨æ–¹æ¡†ã€OKã€Cancelä¹‹é—´ç§»åŠ¨</li>
<li>F1é”®ï¼šå¯ä»¥æ˜¾ç¤ºè¯¥æœåŠ¡çš„è¯´æ˜</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314131906998.png" class="" title="image-20210314131906998"><br />



<h3 id="Dockerå®‰è£…"><a href="#Dockerå®‰è£…" class="headerlink" title="Dockerå®‰è£…"></a>Dockerå®‰è£…</h3><blockquote>
<p>æ‹‰å–é•œåƒ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull mysql:8.0.20</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>åˆ›å»ºæŒ‚è½½çš„æ•°æ®å’Œé…ç½®æ–‡ä»¶å¤¹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p /home/mysql/data /home/mysql/conf</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>å…ˆå¯åŠ¨MySQLå®¹å™¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run --name mysql -d -p 3306:3306 \</span></span><br><span class="line">-e MYSQL_ROOT_PASSWORD=&lt;password&gt; mysql:8.0.20</span><br></pre></td></tr></table></figure>



<blockquote>
<p>è¿›å…¥å®¹å™¨æŸ¥çœ‹é…ç½®æ–‡ä»¶ä½ç½®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it mysql bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mysql --<span class="built_in">help</span> | grep my.cnf</span></span><br><span class="line">                      order of preference, my.cnf, $MYSQL_TCP_PORT,</span><br><span class="line">/etc/my.cnf /etc/mysql/my.cnf ~/.my.cnf </span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">exit</span></span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>å°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°æŒ‚è½½é…ç½®æ–‡ä»¶å¤¹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker cp mysql:/etc/mysql/my.cnf /home/mysql/conf</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ </p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è¡¨åç§°å¤§å°å†™ä¸æ•æ„Ÿ</span></span><br><span class="line">lower_case_table_names=1</span><br></pre></td></tr></table></figure>



<blockquote>
<p>å…ˆåœæ­¢å¹¶åˆ é™¤å®¹å™¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker stop mysql &amp;&amp; docker rm mysql</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>é‡æ–°è¿è¡ŒMySQLå®¹å™¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run --name mysql \</span></span><br><span class="line">-d -p 3306:3306  \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=&lt;password&gt; \</span><br><span class="line">--mount type=bind,src=/home/mysql/conf/my.cnf,dst=/etc/mysql/my.cnf \</span><br><span class="line">--mount type=bind,src=/home/mysql/data,dst=/var/lib/mysql \</span><br><span class="line">--restart=on-failure:3 \</span><br><span class="line"> mysql:8.0.20</span><br></pre></td></tr></table></figure>



<blockquote>
<p>Navicatæ— æ³•è¿æ¥</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it mysql bash</span><br><span class="line">$ mysql -u root -p&lt;password&gt;</span><br><span class="line">$ ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;&lt;password&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><blockquote>
<p>å®‰è£…ç›®å½•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">è·¯å¾„</th>
<th align="center">è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td align="center">/var/lib/mysql/</td>
<td align="center">æ•°æ®åº“æ–‡ä»¶çš„å­˜æ”¾ä½ç½®</td>
</tr>
<tr>
<td align="center">/usr/share/mysql-8.0/</td>
<td align="center">é…ç½®æ–‡ä»¶ç›®å½•</td>
</tr>
<tr>
<td align="center">/usr/bin/</td>
<td align="center">ç›¸å…³å‘½ä»¤ç›®å½•</td>
</tr>
</tbody></table>
<blockquote>
<p>æŸ¥çœ‹ç¼–ç </p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">&#x27;character%&#x27;</span>;</span></span><br><span class="line">+--------------------------+--------------------------------+</span><br><span class="line">| Variable_name            | Value                          |</span><br><span class="line">+--------------------------+--------------------------------+</span><br><span class="line">| character_set_client     | utf8mb4                        |</span><br><span class="line">| character_set_connection | utf8mb4                        |</span><br><span class="line">| character_set_database   | utf8mb4                        |</span><br><span class="line">| character_set_filesystem | binary                         |</span><br><span class="line">| character_set_results    | utf8mb4                        |</span><br><span class="line">| character_set_server     | utf8mb4                        |</span><br><span class="line">| character_set_system     | utf8                           |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql-8.0/charsets/ |</span><br><span class="line">+--------------------------+--------------------------------+</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼ŒMySQL 8çš„é»˜è®¤ç¼–ç æ ¼å¼é™¤äº†æ–‡ä»¶ç³»ç»Ÿæ˜¯äºŒè¿›åˆ¶ç¼–ç ä»¥å¤–ï¼Œå·²ç»å…¨éƒ¨æ”¹ä¸ºutf8å’Œutf8mb4(æ‹¥æœ‰æ¯”utf8æ›´å¥½çš„å…¼å®¹æ€§)ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦å†ä¿®æ”¹ã€‚</p>
<p>æ³¨æ„ï¼šä½¿ç”¨Navicatè¿æ¥MySQLæ—¶ç¼–ç åº”è®¾ç½®ä¸ºè‡ªåŠ¨ï¼Œåˆ‡å‹¿è®¾ç½®ä¸ºutf8ï¼Œå¦åˆ™ä¼šä¸­æ–‡ä¹±ç ã€‚</p>
<h3 id="é€»è¾‘æ¶æ„"><a href="#é€»è¾‘æ¶æ„" class="headerlink" title="é€»è¾‘æ¶æ„"></a>é€»è¾‘æ¶æ„</h3><blockquote>
<p>ä¼˜åŠ¿</p>
</blockquote>
<p>å’Œå…¶ä»–æ•°æ®åº“ç›¸æ¯”ï¼ŒMySQLæœ‰ç‚¹ä¸ä¼—ä¸åŒï¼Œå®ƒçš„æ¶æ„å¯ä»¥åœ¨å¤šç§ä¸åŒåœºæ™¯ä¸­åº”ç”¨å¹¶å‘æŒ¥è‰¯å¥½ä½œç”¨å’Œã€‚ä¸»è¦ä½“ç°åœ¨å­˜å‚¨å¼•æ“çš„æ¶æ„ä¸Šï¼Œæ’ä»¶å¼çš„å­˜å‚¨å¼•æ“æ¶æ„å°†æŸ¥è¯¢å¤„ç†å’Œå…¶ä»–çš„ç³»ç»Ÿä»»åŠ¡ä»¥åŠæ•°æ®çš„å­˜å‚¨æå–ç›¸åˆ†ç¦»ã€‚è¿™ç§æ¶æ„å¯ä»¥æ ¹æ®ä¸šåŠ¡çš„éœ€æ±‚å’Œå®é™…éœ€è¦é€‰æ‹©åˆé€‚çš„å­˜å‚¨å¼•æ“ã€‚</p>
<blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210324110838854.png" class="" title="image-20210324110838854"><br />



<blockquote>
<p>è¯¦è§£</p>
</blockquote>
<ul>
<li>è¿æ¥å±‚ï¼šæœ€ä¸Šå±‚æ˜¯ä¸€äº›å®¢æˆ·ç«¯å’Œè¿æ¥æœåŠ¡ï¼ŒåŒ…å«æœ¬åœ°socké€šä¿¡å’Œå¤§å¤šæ•°åŸºäºå®¢æˆ·ç«¯/æœåŠ¡ç«¯å·¥å…·å®ç°çš„ç±»ä¼¼äºTCP/IPé€šä¿¡ã€‚ä¸»è¦å®Œæˆä¸€äº›ç±»ä¼¼äºè¿æ¥å¤„ç†ã€æˆæƒè®¤è¯åŠç›¸å…³çš„å®‰å…¨æ–¹æ¡ˆã€‚åœ¨è¯¥å±‚ä¸Šå¼•å…¥äº†çº¿ç¨‹æ± çš„æ¦‚å¿µï¼Œæœªé€šè¿‡è®¤è¯å®‰å…¨æ¥å…¥çš„å®¢æˆ·ç«¯æä¾›çº¿ç¨‹ã€‚åŒæ ·åœ¨è¯¥å±‚ä¸Šå¯ä»¥å®ç°åŸºäºSSLçš„å®‰å…¨è¿æ¥ã€‚æœåŠ¡å™¨ä¹Ÿä¼šä¸ºå®‰å…¨æ¥å…¥çš„æ¯ä¸ªå®¢æˆ·ç«¯éªŒè¯å®ƒæ‰€å…·æœ‰çš„æ“ä½œæƒé™ã€‚</li>
<li>æœåŠ¡å±‚ï¼šç¬¬äºŒå±‚æ¶æ„ä¸»è¦å®Œæˆå¤§å¤šæ•°çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå¦‚SQLæ¥å£ï¼Œå¹¶å®Œæˆç¼“å­˜çš„æŸ¥è¯¢ï¼ŒSQLçš„åˆ†æå’Œä¼˜åŒ–åŠéƒ¨åˆ†å†…ç½®å‡½æ•°çš„æ‰§è¡Œã€‚æ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½ä¹Ÿåœ¨è¿™ä¸€å±‚å®ç°ï¼Œå¦‚è¿‡ç¨‹ã€å‡½æ•°ç­‰ã€‚åœ¨è¯¥å±‚ï¼ŒæœåŠ¡å™¨ä¼šè§£ææŸ¥è¯¢å¹¶åˆ›å»ºç›¸åº”çš„å†…éƒ¨è§£ææ ‘ï¼Œå¹¶å¯¹å…¶å®Œæˆç›¸åº”çš„ä¼˜åŒ–å¦‚ç¡®å®šæŸ¥è¯¢è¡¨çš„é¡ºåºï¼Œæ˜¯å¦åˆ©ç”¨ç´¢å¼•ç­‰ï¼Œæœ€åç”Ÿæˆç›¸åº”çš„æ‰§è¡Œæ“ä½œã€‚å¦‚æœæ˜¯selectè¯­å¥ï¼ŒæœåŠ¡å™¨è¿˜ä¼šæŸ¥è¯¢å†…éƒ¨çš„ç¼“å­˜ã€‚å¦‚æœç¼“å­˜ç©ºé—´è¶³å¤Ÿå¤§ï¼Œè¿™æ ·åœ¨è§£å†³å¤§é‡è¯»æ“ä½œçš„ç¯å¢ƒä¸­èƒ½å¤Ÿå¾ˆå¥½çš„æå‡ç³»ç»Ÿçš„æ€§èƒ½ã€‚</li>
<li>å¼•æ“å±‚ï¼šå­˜å‚¨å¼•æ“å±‚ï¼Œå­˜å‚¨å¼•æ“çœŸæ­£çš„è´Ÿè´£äº†MySQLä¸­æ•°æ®çš„å­˜å‚¨å’Œæå–ï¼ŒæœåŠ¡å™¨é€šè¿‡APIä¸å­˜å‚¨å¼•æ“è¿›è¡Œé€šä¿¡ã€‚ä¸åŒçš„å­˜å‚¨å¼•æ“å…·æœ‰çš„åŠŸèƒ½ä¸åŒï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€è¦è¿›è¡Œé€‰å–ã€‚</li>
<li>å­˜å‚¨å±‚ï¼šæ•°æ®å­˜å‚¨å±‚ï¼Œä¸»è¦æ˜¯å°†æ•°æ®å­˜å‚¨åœ¨è¿è¡Œäºè£¸è®¾å¤‡çš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼Œå¹¶å®Œæˆä¸å­˜å‚¨å¼•æ“çš„äº¤äº’ã€‚</li>
</ul>
<h3 id="å­˜å‚¨å¼•æ“"><a href="#å­˜å‚¨å¼•æ“" class="headerlink" title="å­˜å‚¨å¼•æ“"></a>å­˜å‚¨å¼•æ“</h3><blockquote>
<p>æŸ¥çœ‹å­˜å‚¨å¼•æ“</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mysql&gt;show engines;</span></span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314164337734.png" class="" title="image-20210314164337734"><br />



<blockquote>
<p>MyISAMå’ŒInnoDB</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å¯¹æ¯”é¡¹</th>
<th align="center">MyISAM</th>
<th align="center">InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ä¸»å¤–é”®</td>
<td align="center">ä¸æ”¯æŒ</td>
<td align="center">æ”¯æŒ</td>
</tr>
<tr>
<td align="center">äº‹åŠ¡</td>
<td align="center">ä¸æ”¯æŒ</td>
<td align="center">æ”¯æŒ</td>
</tr>
<tr>
<td align="center">è¡Œè¡¨é”</td>
<td align="center">è¡¨é”ï¼Œå³ä½¿æ“ä½œä¸€æ¡è®°å½•ä¹Ÿä¼šé”ä½æ•´ä¸ªè¡¨ï¼Œä¸åˆé€‚é«˜å¹¶å‘çš„æ“ä½œ</td>
<td align="center">è¡Œé”ï¼Œæ“ä½œæ—¶åªé”ä½æŸä¸€è¡Œï¼Œä¸å¯¹å…¶ä»–è¡Œæœ‰å½±å“ï¼Œé€‚åˆé«˜å¹¶å‘çš„æ“ä½œ</td>
</tr>
<tr>
<td align="center">ç¼“å­˜</td>
<td align="center">åªç¼“å­˜ç´¢å¼•ï¼Œä¸ç¼“å­˜çœŸå®æ•°æ®</td>
<td align="center">ä¸ä»…ç¼“å­˜ç´¢å¼•è¿˜è¦ç¼“å­˜çœŸå®æ•°æ®ï¼Œå¯¹å†…å­˜è¦æ±‚è¾ƒé«˜ï¼Œè€Œä¸”å†…å­˜å¤§å°å¯¹æ€§èƒ½æœ‰å†³å®šæ€§çš„å½±å“ã€‚</td>
</tr>
<tr>
<td align="center">è¡¨ç©ºé—´</td>
<td align="center">å°</td>
<td align="center">å¤§</td>
</tr>
<tr>
<td align="center">å…³æ³¨ç‚¹</td>
<td align="center">æ€§èƒ½</td>
<td align="center">äº‹åŠ¡</td>
</tr>
<tr>
<td align="center">é»˜è®¤å®‰è£…</td>
<td align="center">Y</td>
<td align="center">Y</td>
</tr>
</tbody></table>
<blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>MySQL 8.0ï¼šä¸å†æ”¯æŒæŸ¥è¯¢ç¼“å­˜ã€‚</p>
<p>MySQLå›¢é˜Ÿåšå®¢ï¼š<a href="https://mysqlserverteam.com/mysql-8-0-retiring-support-for-the-query-cache/">https://mysqlserverteam.com/mysql-8-0-retiring-support-for-the-query-cache/</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å°½ç®¡MySQL Query Cacheæ—¨åœ¨æé«˜æ€§èƒ½ï¼Œä½†å®ƒå­˜åœ¨ä¸¥é‡çš„å¯ä¼¸ç¼©æ€§é—®é¢˜ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“æˆä¸ºä¸¥é‡çš„ç“¶é¢ˆã€‚</span><br><span class="line"></span><br><span class="line">è‡ªMySQL 5.6ï¼ˆ2013ï¼‰ä»¥æ¥ï¼Œé»˜è®¤æƒ…å†µä¸‹å·²ç¦ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Œå› ä¸ºä¼—æ‰€å‘¨çŸ¥ï¼Œå®ƒä¸èƒ½ä¸å¤šæ ¸è®¡ç®—æœºä¸Šåœ¨é«˜ååé‡å·¥ä½œè´Ÿè½½æƒ…å†µä¸‹è¿›è¡Œæ‰©å±•ã€‚</span><br><span class="line"></span><br><span class="line">æˆ‘ä»¬è€ƒè™‘äº†å¯ä»¥å¯¹æŸ¥è¯¢ç¼“å­˜è¿›è¡Œå“ªäº›æ”¹è¿›ï¼Œä»¥åŠæˆ‘ä»¬å¯ä»¥è¿›è¡Œçš„ä¼˜åŒ–ï¼Œè¿™äº›ä¼˜åŒ–å¯ä»¥æ”¹å–„æ‰€æœ‰å·¥ä½œè´Ÿè½½ã€‚</span><br><span class="line"></span><br><span class="line">è™½ç„¶è¿™äº›é€‰æ‹©æœ¬èº«æ˜¯æ­£äº¤çš„ï¼Œä½†å·¥ç¨‹èµ„æºæ˜¯æœ‰é™çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æ­£åœ¨è½¬å˜æˆ˜ç•¥ï¼ŒæŠ•èµ„äºæ›´æ™®éé€‚ç”¨äºæ‰€æœ‰å·¥ä½œè´Ÿè½½çš„æ”¹è¿›ã€‚</span><br><span class="line"></span><br><span class="line">å»ºè®®æŠŠç¼“å­˜æ”¾åˆ°å®¢æˆ·ç«¯ã€‚</span><br></pre></td></tr></table></figure>



<blockquote>
<p>Alibabaé€‰æ‹©</p>
</blockquote>
<ul>
<li>Perconaä¸ºMySQLæ•°æ®åº“æœåŠ¡è¿›è¡Œäº†æ”¹è¿›ï¼Œåœ¨åŠŸèƒ½å’Œæ€§èƒ½ä¸Šè¾ƒMySQLæœ‰ç€å¾ˆæ˜¾è‘—çš„æå‡ã€‚è¯¥ç‰ˆæœ¬æå‡äº†åœ¨é«˜è´Ÿè½½æƒ…å†µä¸‹çš„InnoDBçš„æ€§èƒ½ã€ä¸ºDBAæä¾›äº†ä¸€äº›éå¸¸æœ‰ç”¨çš„æ€§èƒ½è¯Šæ–­å·¥å…·ï¼›å¦å¤–æœ‰æ›´å¤šçš„å‚æ•°å’Œå‘½ä»¤æ¥æ§åˆ¶æœåŠ¡å™¨è¡Œä¸ºã€‚</li>
<li>é˜¿é‡Œå·´å·´å¤§éƒ¨åˆ†MySQLæ•°æ®åº“å…¶å®ä½¿ç”¨çš„æ—¶perconaçš„åŸå‹åŠ ä»¥ä¿®æ”¹ã€‚é˜¿é‡Œæ–°å»ºäº†ä¸€æ¬¾å­˜å‚¨å¼•æ“å«xtradbå®Œå…¨å¯ä»¥æ›¿ä»£innodbï¼Œå¹¶ä¸”åœ¨æ€§èƒ½å’Œå¹¶å‘ä¸Šåšå¾—æ›´å¥½ã€‚</li>
</ul>
<h2 id="ç´¢å¼•ä¼˜åŒ–"><a href="#ç´¢å¼•ä¼˜åŒ–" class="headerlink" title="ç´¢å¼•ä¼˜åŒ–"></a>ç´¢å¼•ä¼˜åŒ–</h2><h3 id="ç´¢å¼•ç®€ä»‹"><a href="#ç´¢å¼•ç®€ä»‹" class="headerlink" title="ç´¢å¼•ç®€ä»‹"></a>ç´¢å¼•ç®€ä»‹</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>MySQLå®˜æ–¹å¯¹ç´¢å¼•çš„å®šä¹‰ä¸ºï¼šç´¢å¼•æ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„ã€‚</p>
<p>å¯ä»¥å¾—åˆ°ç´¢å¼•çš„æœ¬è´¨ï¼šç´¢å¼•æ˜¯æ•°æ®ç»“æ„ã€‚</p>
<p>ç®€å•ç†è§£ï¼šæ’å¥½åºçš„å¿«é€ŸæŸ¥æ‰¾æ•°æ®ç»“æ„ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ç´¢å¼•æœ¬èº«ä¹Ÿå¾ˆå¤§ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚</p>
<p>æˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«æŒ‡æ˜ï¼Œéƒ½æ˜¯æŒ‡Bæ ‘ï¼ˆå¤šè·¯æœç´¢æ ‘ï¼Œä¸ä¸€å®šæ˜¯äºŒå‰æ ‘ï¼‰ç»“æ„çš„ç´¢å¼•ã€‚</p>
<p>å…¶ä¸­èšé›†ç´¢å¼•ï¼Œæ¬¡è¦ç´¢å¼•ï¼Œå¤åˆç´¢å¼•ï¼Œå‰ç¼€ç´¢å¼•ï¼Œå”¯ä¸€ç´¢å¼•é»˜è®¤éƒ½æ˜¯ä½¿ç”¨B+æ ‘ç´¢å¼•ï¼Œç»Ÿç§°ç´¢å¼•ã€‚é™¤äº†B+æ ‘è¿™ç§ç±»å‹çš„ç´¢å¼•ä¹‹å¤–ï¼Œè¿˜æœ‰å“ˆå¸Œç´¢å¼•ç­‰ã€‚</p>
<blockquote>
<p>ä¼˜åŠ¿</p>
</blockquote>
<p>ç±»ä¼¼äºå¤§å­¦å›¾ä¹¦é¦†å»ºæ•°ç›®ç´¢å¼•ï¼Œæé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½æ•°æ®åº“çš„IOæˆæœ¬ã€‚</p>
<p>é€šè¿‡ç´¢å¼•åˆ—é˜Ÿæ•°æ®è¿›è¡Œæ’åºï¼Œé™ä½æ•°æ®æ’åºçš„æˆæœ¬ï¼Œé™ä½äº†CPUçš„æ¶ˆè€—ã€‚</p>
<blockquote>
<p>åŠ£åŠ¿</p>
</blockquote>
<p>è™½ç„¶ç´¢å¼•å¤§å¤§æé«˜äº†æŸ¥è¯¢é€Ÿåº¦ï¼ŒåŒæ—¶ä¼šé™ä½è¡¨çš„æ›´æ–°é€Ÿåº¦ï¼Œå¦‚å¯¹è¡¨è¿›è¡ŒINSERTã€UPDATEå’ŒDELETEã€‚å› ä¸ºæ›´æ–°è¡¨æ—¶ï¼ŒMySQLä¸ä»…è¦ä¿å­˜æ•°æ®ï¼Œè¿˜è¦ä¿å­˜ä¸€ä¸‹ç´¢å¼•æ–‡ä»¶æ¯æ¬¡æ›´æ–°æ·»åŠ äº†ç´¢å¼•åˆ—çš„å­—æ®µï¼Œéƒ½ä¼šè°ƒæ•´å› ä¸ºæ›´æ–°æ‰€å¸¦æ¥çš„é”®å€¼å˜åŒ–åçš„ç´¢å¼•ä¿¡æ¯ã€‚</p>
<p>ç´¢å¼•åªæ˜¯æé«˜æ•ˆç‡çš„ä¸€ä¸ªå› ç´ ï¼Œå¦‚æœä½ çš„MySQLæœ‰å¤§æ•°æ®é‡çš„è¡¨ï¼Œå°±éœ€è¦èŠ±æ—¶é—´ç ”ç©¶å»ºç«‹æœ€ä¼˜ç§€çš„ç´¢å¼•ï¼Œæˆ–ä¼˜åŒ–æŸ¥è¯¢ã€‚</p>
<h3 id="ç´¢å¼•åˆ†ç±»"><a href="#ç´¢å¼•åˆ†ç±»" class="headerlink" title="ç´¢å¼•åˆ†ç±»"></a>ç´¢å¼•åˆ†ç±»</h3><blockquote>
<p>å•å€¼ç´¢å¼•</p>
</blockquote>
<p>ä¸€ä¸ªç´¢å¼•åˆ—åªåŒ…å«å•ä¸ªåˆ—ï¼Œä¸€ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ªç´¢å¼•ã€‚</p>
<blockquote>
<p>å”¯ä¸€ç´¢å¼•</p>
</blockquote>
<p>ç´¢å¼•åˆ—çš„å€¼å¿…é¡»å”¯ä¸€ï¼Œä½†å…è®¸æœ‰ç©ºå€¼ã€‚</p>
<blockquote>
<p>å¤åˆç´¢å¼•</p>
</blockquote>
<p>ä¸€ä¸ªç´¢å¼•åŒ…å«å¤šä¸ªåˆ—ã€‚</p>
<blockquote>
<p>è¦†ç›–ç´¢å¼•</p>
</blockquote>
<p>SQLåªéœ€è¦é€šè¿‡ç´¢å¼•å°±å¯ä»¥è¿”å›æŸ¥è¯¢æ‰€éœ€è¦çš„æ•°æ®ï¼Œè€Œä¸å¿…é€šè¿‡äºŒçº§ç´¢å¼•æŸ¥åˆ°ä¸»é”®ä¹‹åå†å»æŸ¥è¯¢æ•°æ®ï¼Œå³æŸ¥è¯¢å­—æ®µä¸ºç´¢å¼•å­—æ®µã€‚</p>
<blockquote>
<p>åŸºæœ¬è¯­æ³•</p>
</blockquote>
<ul>
<li>åˆ›å»º</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE [UNIQUE] INDEX &lt;index_name&gt; ON &lt;table_name&gt;(&lt;column_name&gt;(length));</span><br><span class="line">ALTER &lt;table_name&gt; ADD [UNIQUE] INDEX &lt;index_name&gt; ON (&lt;column_name&gt;(length));</span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ é™¤</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP INDEX &lt;index_name&gt; ON &lt;table_name&gt;;</span><br></pre></td></tr></table></figure>

<ul>
<li>æŸ¥çœ‹</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">INDEX</span> <span class="keyword">FROM</span> &lt;table_name&gt;;</span><br></pre></td></tr></table></figure>

<ul>
<li>ALTER</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- æ·»åŠ ä¸»é”®ï¼Œå³å”¯ä¸€ç´¢å¼•</span><br><span class="line">ALTER TABLE &lt;table_name&gt; PRIMARY KEY (column_list);</span><br><span class="line">-- åˆ›å»ºå”¯ä¸€ç´¢å¼•</span><br><span class="line">ALTER TABLE &lt;table_name&gt; UNIQUE &lt;index_name&gt;(column_list);</span><br><span class="line">-- æ·»åŠ æ™®é€šç´¢å¼•</span><br><span class="line">ALTER TABLE &lt;table_name&gt; INDEX &lt;index_name&gt;(column_list);</span><br><span class="line">-- æŒ‡å®šå…¨æ–‡ç´¢å¼•</span><br><span class="line">ALTER TABLE &lt;table_name&gt; FULLTEXT index_name&gt;(column_list);</span><br></pre></td></tr></table></figure>



<h3 id="ç´¢å¼•ç»“æ„"><a href="#ç´¢å¼•ç»“æ„" class="headerlink" title="ç´¢å¼•ç»“æ„"></a>ç´¢å¼•ç»“æ„</h3><blockquote>
<p>ç´¢å¼•</p>
</blockquote>
<ul>
<li>BTREE </li>
<li>HASH</li>
<li>FULL-TEXT</li>
<li>R-TREE</li>
</ul>
<blockquote>
<p>éœ€è¦å»ºç«‹ç´¢å¼•çš„æƒ…å†µ</p>
</blockquote>
<ul>
<li>ä¸»é”®è‡ªåŠ¨å»ºç«‹å”¯ä¸€ç´¢å¼•</li>
<li>é¢‘ç¹ä½œä¸ºæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µåº”è¯¥åˆ›å»ºç´¢å¼•</li>
<li>æŸ¥è¯¢ä¸­ä¸å…¶å®ƒè¡¨å…³è”çš„å­—æ®µï¼Œå¤–é”®å…³ç³»å»ºç«‹ç´¢å¼•</li>
<li>é¢‘ç¹æ›´æ–°çš„å­—æ®µä¸é€‚åˆåˆ›å»ºç´¢å¼•</li>
<li>Whereæ¡ä»¶é‡Œç”¨ä¸åˆ°çš„å­—æ®µä¸åˆ›å»ºç´¢å¼•</li>
<li>å•å€¼/ç»„åˆç´¢å¼•çš„é€‰æ‹©ï¼Œåœ¨é«˜å¹¶å‘ä¸‹å€¾å‘åˆ›å»ºç»„åˆç´¢å¼•</li>
<li>æŸ¥è¯¢ä¸­æ’åºçš„å­—æ®µï¼Œæ’åºå­—æ®µè‹¥é€šè¿‡ç´¢å¼•å»è®¿é—®å°†å¤§å¤§æé«˜æ’åºé€Ÿåº¦</li>
<li>æŸ¥è¯¢ä¸­ç»Ÿè®¡æˆ–è€…åˆ†ç»„å­—æ®µ</li>
</ul>
<blockquote>
<p>ä¸éœ€è¦å»ºç«‹ç´¢å¼•çš„æƒ…å†µ</p>
</blockquote>
<ul>
<li>è¡¨è®°å½•å¤ªå°‘  [åŸå› ï¼šä½äºç™¾ä¸‡æ•°çš„è¡¨MySQLè¿˜æ˜¯æ‰›å¾—ä½çš„ã€‚]</li>
<li>ç»å¸¸å¢åˆ æ”¹çš„è¡¨  [åŸå› ï¼šæé«˜äº†æŸ¥è¯¢é€Ÿåº¦ï¼ŒåŒæ—¶å´ä¼šé™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦ï¼Œå¦‚å¯¹è¡¨è¿›è¡ŒINSERTã€UPDATEå’ŒDELETEã€‚å› ä¸ºæ›´æ–°è¡¨æ—¶ï¼ŒMySQLä¸ä»…è¦ä¿å­˜æ•°æ®ï¼Œè¿˜è¦ä¿å­˜ä¸€ä¸‹ç´¢å¼•æ–‡ä»¶ã€‚]</li>
<li>æ•°æ®é‡å¤ä¸”åˆ†å¸ƒå‡åŒ€çš„è¡¨å­—æ®µï¼Œå› æ­¤åº”è¯¥åªä¸ºæœ€ç»å¸¸æŸ¥è¯¢å’Œæœ€ç»å¸¸æ’åºçš„æ•°æ®åˆ—å»ºç«‹ç´¢å¼•ã€‚æ³¨æ„ï¼Œå¦‚æœæŸä¸ªæ•°æ®åˆ—åŒ…å«è®¸å¤šé‡å¤çš„å†…å®¹ï¼Œä¸ºå®ƒå»ºç«‹ç´¢å¼•å°±æ²¡æœ‰å¤ªå¤§çš„å®é™…æ•ˆæœ  [ä¾‹å¦‚ï¼šæ€§åˆ«ç­‰å­—æ®µã€‚]</li>
</ul>
<h3 id="JoinæŸ¥è¯¢"><a href="#JoinæŸ¥è¯¢" class="headerlink" title="JoinæŸ¥è¯¢"></a>JoinæŸ¥è¯¢</h3><blockquote>
<p>joinè¯´æ˜</p>
</blockquote>
<ul>
<li>LEFT JOINï¼šè¿”å›å·¦è¡¨ä¸­çš„æ‰€æœ‰è®°å½•å’Œå³è¡¨ä¸­è”ç»“å­—æ®µç›¸ç­‰çš„è®°å½•ã€‚<ul>
<li>æ ¼å¼ï¼š<code>SELECT ... table1 LEFT JOIN table2 ON ...</code></li>
<li>è¯´æ˜ï¼šä¼šå–å¾—table1å…¨éƒ¨è®°å½•ï¼Œå³ä½¿table2æ²¡æœ‰åŒ¹é…è®°å½•</li>
</ul>
</li>
<li>RIGHT JOINï¼šè¿”å›å³è¡¨ä¸­çš„æ‰€æœ‰è®°å½•å’Œå·¦è¡¨ä¸­è”ç»“å­—æ®µç›¸ç­‰çš„è®°å½•ã€‚<ul>
<li>æ ¼å¼ï¼š<code>SELECT ... table1 RIGHT JOIN table2 ON ...</code></li>
<li>è¯´æ˜ï¼šä¼šå–å¾—table2å…¨éƒ¨è®°å½•ï¼Œå³ä½¿table1æ²¡æœ‰åŒ¹é…è®°å½•</li>
</ul>
</li>
<li>INNER JOINï¼šåªè¿”å›ä¸¤ä¸ªè¡¨ä¸­è”ç»“å­—æ®µç›¸ç­‰çš„è®°å½•ã€‚<ul>
<li>æ ¼å¼ï¼š<code>SELECT ... table1 INNER JOIN table2 ON ...</code></li>
<li>è¯´æ˜ï¼šä¼šå–å¾—table1table2è”ç»“å­—æ®µç›¸ç­‰çš„è®°å½•</li>
</ul>
</li>
</ul>
<blockquote>
<p>joinå›¾ç¤º</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;select_list&gt; from table_a a LEFT JOIN table_b b ON a.key &#x3D; b.key</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314221223407.png" class="" title="image-20210314221223407"><br />

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;select_list&gt; from table_a a LEFT JOIN table_b ON a.key &#x3D;&#x3D; b.key WHERE b.key is NULL</span><br></pre></td></tr></table></figure>



<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314222433261.png" class="" title="image-20210314222433261"><br />

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;select_list&gt; from table_a a INNER JOIN table_b b ON a.key &#x3D; b.key</span><br></pre></td></tr></table></figure>



<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314221536479.png" class="" title="image-20210314221536479"><br />

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;select_list&gt; from table_a a RIGHT JOIN table_b b ON a.key &#x3D; b.key</span><br></pre></td></tr></table></figure>



<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314221440655.png" class="" title="image-20210314221440655"><br />

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT &lt;select_list&gt; from table_a a RIGHT JOIN table_b ON a.key &#x3D; b.key WHERE a.key is NULL</span><br></pre></td></tr></table></figure>


<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314222235183.png" class="" title="image-20210314222235183"><br />

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Oracleæ”¯æŒ FULL OUTER JOINï¼Œä½†æ˜¯MySQLä¸æ”¯æŒ</span><br><span class="line"># Oracle</span><br><span class="line">SELECT &lt;select_list&gt; FROM table_a a FULL OUTER JOIN table_b b ON a.key &#x3D; b.key</span><br><span class="line"># MySQL</span><br><span class="line">SELECT &lt;select_list&gt; from table_a a LEFT JOIN table_b b ON a.key &#x3D; b.key</span><br><span class="line">union</span><br><span class="line">SELECT &lt;select_list&gt; from table_a a RIGHT JOIN table_b b ON a.key &#x3D; b.key</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314222826674.png" class="" title="image-20210314222826674"><br />

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Oracle</span><br><span class="line">SELECT &lt;select_list&gt; FROM table_a a FULL OUTER JOIN table_b b ON a.key &#x3D; b.key WHERE a.key is NULL or b.key is NULL</span><br><span class="line"># MySQL</span><br><span class="line">SELECT &lt;select_list&gt; from table_a a LEFT JOIN table_b b ON a.key &#x3D; b.key where b.id is null</span><br><span class="line">union</span><br><span class="line">SELECT &lt;select_list&gt; from table_a a RIGHT JOIN table_b b ON a.key &#x3D; b.key where a.id is null</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314222858303.png" class="" title="image-20210314222858303"><br />





<blockquote>
<p>SQLæ‰§è¡Œé¡ºåº</p>
</blockquote>
<ul>
<li>æ‰‹å†™</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span></span><br><span class="line">	&lt;select_list&gt;</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	&lt;left_table&gt; &lt;join_table&gt;</span><br><span class="line"><span class="keyword">JOIN</span> &lt;right_table&gt; <span class="keyword">ON</span> &lt;join_condetion&gt;</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	&lt;where_condition&gt;</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	&lt;group_by_list&gt;</span><br><span class="line"><span class="keyword">HAVING</span></span><br><span class="line">	&lt;having_condition&gt;</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">	&lt;order_by_condition&gt;</span><br><span class="line"><span class="keyword">LIMIT</span> &lt;limit_number&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>æœºè¯»</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314215216629.png" class="" title="image-20210314215216629"><br />





<h3 id="æ€§èƒ½åˆ†æ"><a href="#æ€§èƒ½åˆ†æ" class="headerlink" title="æ€§èƒ½åˆ†æ"></a>æ€§èƒ½åˆ†æ</h3><blockquote>
<p>MySQL Query Optimizer</p>
</blockquote>
<p>MySQLä¸­æœ‰ä¸“é—¨è´Ÿè´£ä¼˜åŒ–SELECTè¯­å¥çš„ä¼˜åŒ–å™¨æ¨¡å—ï¼Œä¸»è¦åŠŸèƒ½ï¼šé€šè¿‡è®¡ç®—åˆ†æç³»ç»Ÿä¸­æ”¶é›†åˆ°çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä¸ºå®¢æˆ·ç«¯è¯·æ±‚çš„Queryæä¾›ä»–è®¤ä¸ºæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’(å®ƒè®¤ä¸ºæœ€ä¼˜çš„æ•°æ®æ£€ç´¢æ–¹å¼ï¼Œä½†ä¸è§å¾—æ˜¯DBAè®¤ä¸ºæ˜¯æœ€ä¼˜çš„ï¼Œè¿™éƒ¨åˆ†æœ€è€—è´¹æ—¶é—´)<br>å½“å®¢æˆ·ç«¯å‘MySQLè¯·æ±‚ä¸€æ¡Queryï¼Œå‘½ä»¤è§£æå™¨æ¨¡å—å®Œæˆè¯·æ±‚åˆ†ç±»ï¼ŒåŒºåˆ«å‡ºæ˜¯SELECTå¹¶è½¬å‘ç»™MySQL Query Optimizeræ—¶ï¼ŒMySQL Query Optimizer é¦–å…ˆä¼šå¯¹æ•´æ¡Queryè¿›è¡Œä¼˜åŒ–ï¼Œå¤„ç†æ‰ä¸€äº›å¸¸é‡è¡¨è¾¾å¼çš„é¢„ç®—ï¼Œç›´æ¥æ¢ç®—æˆå¸¸é‡å€¼ã€‚å¹¶å¯¹Query ä¸­çš„æŸ¥è¯¢æ¡ä»¶è¿›è¡Œç®€åŒ–å’Œè½¬æ¢ï¼Œå¦‚å»æ‰ä¸€äº›æ— ç”¨æˆ–æ˜¾è€Œæ˜“è§çš„æ¡ä»¶ã€ç»“æ„è°ƒæ•´ç­‰ã€‚ç„¶ååˆ†æQuery ä¸­çš„Hint ä¿¡æ¯(å¦‚æœæœ‰)ï¼Œçœ‹æ˜¾ç¤ºHintä¿¡æ¯æ˜¯å¦å¯ä»¥å®Œå…¨ç¡®å®šè¯¥Queryçš„æ‰§è¡Œè®¡åˆ’ã€‚å¦‚æœæ²¡æœ‰Hintæˆ–Hintä¿¡æ¯è¿˜ä¸è¶³ä»¥å®Œå…¨ç¡®å®šæ‰§è¡Œè®¡åˆ’ï¼Œåˆ™ä¼šè¯»å–æ‰€æ¶‰åŠå¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæ ¹æ®Queryè¿›è¡Œå†™ç›¸åº”çš„è®¡ç®—åˆ†æï¼Œç„¶åå†å¾—å‡ºæœ€åçš„æ‰§è¡Œè®¡åˆ’ã€‚</p>
<blockquote>
<p>MySQLæ€§èƒ½ç“¶é¢ˆ</p>
</blockquote>
<p>CPU: CPUåœ¨é¥±å’Œçš„æ—¶å€™ä¸€èˆ¬å‘ç”Ÿåœ¨æ•°æ®è£…å…¥å†…å­˜æˆ–ä»ç£ç›˜ä¸Šè¯»å–æ•°æ®çš„æ—¶å€™</p>
<p>IO: ç£ç›˜I/Oç“¶é¢ˆå‘ç”Ÿåœ¨è£…å…¥æ•°æ®è¿œå¤§äºå†…å­˜å®¹é‡çš„æ—¶å€™</p>
<p>æœåŠ¡å™¨ç¡¬ä»¶çš„æ€§èƒ½ç“¶é¢ˆï¼š<code>top</code>ã€<code>free</code>ã€<code>iostat</code>ã€<code>vmstat</code>æ¥æŸ¥çœ‹ç³»ç»Ÿçš„æ€§èƒ½çŠ¶æ€</p>
<blockquote>
<p>Explain</p>
</blockquote>
<p>å®˜ç½‘ä»‹ç»ï¼š<a href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html">https://dev.mysql.com/doc/refman/8.0/en/explain-output.html</a></p>
<p>ä½¿ç”¨ç›®çš„ï¼š</p>
<ul>
<li>è¡¨çš„è¯»å–é¡ºåº</li>
<li>æ•°æ®è¯»å–æ“ä½œçš„æ“ä½œç±»å‹</li>
<li>å¯ä»¥ä½¿ç”¨çš„ç´¢å¼•</li>
<li>å®é™…ä½¿ç”¨çš„ç´¢å¼•</li>
<li>è¡¨ä¹‹é—´çš„å¼•ç”¨</li>
<li>æ¯å¼ è¡¨è¢«ä¼˜åŒ–å™¨æŸ¥è¯¢çš„è¡Œæ•°</li>
</ul>
<p>ä½¿ç”¨æ–¹æ³•ï¼š<code>explain + sqlè¯­å¥</code></p>
<blockquote>
<p>å­—æ®µè§£é‡Š</p>
</blockquote>
<p>ï¼ˆ1ï¼‰id</p>
<p>è§£é‡Šï¼š</p>
<p>selectæŸ¥è¯¢çš„åºåˆ—å·ï¼ŒåŒ…å«ä¸€ç»„æ•°å­—ï¼Œè¡¨ç¤ºæŸ¥è¯¢ä¸­æ‰§è¡Œçš„selectå­å¥æˆ–æ“ä½œè¡¨çš„é¡ºåºã€‚</p>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>idç›¸åŒï¼Œæ‰§è¡Œé¡ºåºç”±ä¸Šè‡³ä¸‹ï¼›</li>
<li>idä¸åŒï¼Œå¦‚æœæ˜¯å­æŸ¥è¯¢ï¼Œidé€’å¢ï¼Œidå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆè¢«æ‰§è¡Œï¼›</li>
<li>idç›¸åŒä¸åŒï¼ŒåŒæ—¶å­˜åœ¨ï¼Œidå¦‚æœç›¸åŒï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç»„ï¼Œä»ä¸Šå¾€ä¸‹é¡ºåºæ‰§è¡Œï¼Œåœ¨æ‰€æœ‰ç»„ä¸­ï¼Œidå€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰select_type</p>
<p>è§£é‡Šï¼š</p>
<p>æŸ¥è¯¢çš„ç±»å‹ï¼šSIMPLEã€PRIMARYã€SUBQUERYã€DERIVEDã€UNIONã€UNION RESULTã€‚æŸ¥è¯¢çš„ç±»å‹ï¼Œä¸»è¦æ˜¯ç”¨äºåŒºåˆ«æ™®é€šæŸ¥è¯¢ã€è”åˆæŸ¥è¯¢ã€å­æŸ¥è¯¢ç­‰çš„å¤æ‚æŸ¥è¯¢ã€‚</p>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>SIMPLEï¼šç®€å•çš„selectæŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸­ä¸åŒ…å«å­æŸ¥è¯¢æˆ–è€…UNIONï¼›</li>
<li>PRIMARYï¼šæŸ¥è¯¢ä¸­è‹¥åŒ…å«ä»»ä½•å¤æ‚çš„å­éƒ¨åˆ†ï¼Œæœ€å¤–å±‚æŸ¥è¯¢è´£åˆ™è¢«æ ‡è®°ä¸ºPRIMARYï¼›</li>
<li>SUBQUERYï¼šåœ¨SELECTæˆ–WHEREåˆ—è¡¨ä¸­åŒ…å«äº†å­æŸ¥è¯¢ï¼›</li>
<li>DERIVEDï¼šåœ¨FROMåˆ—è¡¨ä¸­åŒ…å«çš„å­æŸ¥è¯¢è¢«æ ‡è®°ä¸ºDERIVED(è¡ç”Ÿ)ï¼ŒMySQLä¼šé€’å½’æ‰§è¡Œè¿™äº›å­æŸ¥è¯¢ï¼ŒæŠŠç»“æœæ”¾åœ¨ä¸´æ—¶è¡¨é‡Œï¼›</li>
<li>UNIONï¼šè‹¥ç¬¬äºŒä¸ªSELECTå‡ºç°åœ¨UNIONä¹‹åï¼Œåˆ™è¢«æ ‡è®°ä¸ºUNIONï¼›è‹¥UNIONåŒ…å«åœ¨FROMå­å¥çš„å­æŸ¥è¯¢ä¸­ï¼Œå¤–å±‚SELECTå°†è¢«è¢«æ ‡è®°ä¸ºï¼šDERIVEDï¼›</li>
<li>UNION RESULTï¼šä»UNIONè¡¨è·å–ç»“æœçš„SELECTã€‚</li>
</ul>
<p>ï¼ˆ3ï¼‰table</p>
<p>è§£é‡Šï¼šæ˜¾ç¤ºè¿™ä¸€è¡Œæ•°æ®æ˜¯å…³äºå“ªä¸€å¼ è¡¨çš„ã€‚</p>
<p>ï¼ˆ4ï¼‰type</p>
<p>è§£é‡Šï¼šæ˜¾ç¤ºæŸ¥è¯¢äº†ä½•ç§ç±»å‹ã€‚</p>
<p>è¯´æ˜ï¼š</p>
<p>ä»æœ€å¥½åˆ°æœ€å·®ä¾æ¬¡æ˜¯ï¼š<code>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</code>ã€‚</p>
<p>å¸¸è§çš„æ˜¯ï¼š<code>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</code>ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå¾—ä¿è¯æŸ¥è¯¢è‡³å°‘è¾¾åˆ°rangeçº§åˆ«ï¼Œæœ€å¥½èƒ½åˆ°refã€‚</p>
<ul>
<li>systemï¼šè¡¨åªæœ‰ä¸€è¡Œè®°å½•ï¼ˆç­‰äºç³»ç»Ÿè¡¨ï¼‰ï¼Œè¿™æ˜¯constç±»å‹çš„ç‰¹ä¾‹ï¼Œå¹³æ—¶ä¸ä¼šå‡ºç°ï¼Œè¿™ä¸ªä¹Ÿå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</li>
<li>constï¼šè¡¨ç¤ºé€šè¿‡ç´¢å¼•ä¸€æ¬¡å°±æ‰¾åˆ°äº†ï¼Œconstç”¨äºæ¯”è¾ƒprimary keyæˆ–è€…uniqueç´¢å¼•ã€‚å› ä¸ºåªåŒ¹é…ä¸€è¡Œæ•°æ®ï¼Œæ‰€ä»¥å¾ˆå¿«ã€‚å¦‚å°†ä¸»é”®ç½®äºwhereåˆ—è¡¨ä¸­ï¼ŒMySQLå°±èƒ½å°†è¯¥æŸ¥è¯¢è½¬æ¢ä¸ºä¸€ä¸ªå¸¸é‡ã€‚</li>
<li>eq_refï¼šå”¯ä¸€æ€§ç´¢å¼•æ‰«æï¼Œå¯¹äºæ¯ä¸ªç´¢å¼•é”®ï¼Œè¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•ä¸ä¹‹åŒ¹é…ã€‚å¸¸è§äºä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æ‰«æã€‚</li>
<li>refï¼šéå”¯ä¸€æ€§ç´¢å¼•æ‰«æï¼Œè¿”å›åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„æ‰€æœ‰è¡Œã€‚æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§ç´¢å¼•è®¿é—®ï¼Œå®ƒè¿”å›æ‰€æœ‰åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„è¡Œï¼Œç„¶è€Œï¼Œå®ƒå¯èƒ½ä¼šæ‰¾åˆ°å¤šä¸ªç¬¦åˆæ¡ä»¶çš„è¡Œï¼Œæ‰€ä»¥ä»–åº”è¯¥å±äºæŸ¥æ‰¾å’Œæ‰«æçš„æ··åˆä½“ã€‚</li>
<li>rangeï¼šåªæ£€ç´¢ç»™å®šèŒƒå›´çš„è¡Œï¼Œä½¿ç”¨ä¸€ä¸ªç´¢å¼•æ¥é€‰æ‹©è¡Œã€‚keyåˆ—æ˜¾ç¤ºä½¿ç”¨äº†å“ªä¸ªç´¢å¼•ï¼Œä¸€èˆ¬å°±æ˜¯åœ¨ä½ çš„whereè¯­å¥ä¸­å‡ºç°äº†betweenã€&lt;ã€&gt;ã€inç­‰çš„æŸ¥è¯¢è¿™ç§èŒƒå›´æ‰«æç´¢å¼•ä¼šæ¯”å…¨è¡¨æ‰«æè¦å¥½ï¼Œå› ä¸ºå®ƒåªéœ€è¦å¼€å§‹äºç´¢å¼•çš„æŸä¸€ç‚¹ï¼Œè€Œç»“æŸäºå¦ä¸€ç‚¹ï¼Œä¸ç”¨æ‰«æå…¨éƒ¨ç´¢å¼•ã€‚</li>
<li>indexï¼šFull Index Scanï¼Œindexä¸ALLåŒºåˆ«ä¸ºindexç±»å‹åªéå†ç´¢å¼•æ ‘ã€‚è¿™é€šå¸¸æ¯”ALLå¿«ï¼Œå› ä¸ºç´¢å¼•æ–‡ä»¶é€šå¸¸æ¯”æ•°æ®æ–‡ä»¶å°ã€‚ï¼ˆä¹Ÿå°±æ˜¯è¯´è™½ç„¶ALLå’Œindexéƒ½æ˜¯å…¨è¡¨ï¼Œä½†indexæ˜¯ä»ç´¢å¼•å‡ºå‘çš„ï¼Œè€ŒALLæ˜¯ä»ç¡¬ç›˜è¯»å–çš„ã€‚ï¼‰</li>
<li>ALLï¼šFull Table Scanï¼Œå°†æ‰«æå…¨è¡¨ä»¥æ‰¾åˆ°åŒ¹é…çš„è¡Œã€‚</li>
</ul>
<p>ï¼ˆ5ï¼‰possible_keys</p>
<p>è§£é‡Šï¼š</p>
<p>æ˜¾ç¤ºå¯èƒ½åº”ç”¨åœ¨è¿™å¼ è¡¨ä¸­çš„ç´¢å¼•ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªã€‚</p>
<p>æŸ¥è¯¢æ¶‰åŠåˆ°çš„å­—æ®µä¸Šè‹¥å­˜åœ¨ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å°†è¢«åˆ—å‡ºï¼Œä½†ä¸ä¸€å®šè¢«æŸ¥è¯¢å®é™…ä½¿ç”¨ã€‚</p>
<p>ï¼ˆ6ï¼‰key</p>
<p>è§£é‡Šï¼šå®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚å¦‚æœä¸ºNULLï¼Œåˆ™æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚æŸ¥è¯¢ä¸­è‹¥ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•ä»…å‡ºç°åœ¨keyåˆ—è¡¨ä¸­ã€‚</p>
<p>ï¼ˆ7ï¼‰key_len</p>
<p>è§£é‡Šï¼šè¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå¯é€šè¿‡è¯¥åˆ—è®¡ç®—æŸ¥è¯¢ä¸­ä½¿ç”¨çš„ç´¢å¼•çš„é•¿åº¦ã€‚åœ¨ä¸æŸå¤±ç²¾ç¡®æ€§çš„æƒ…å†µä¸‹ï¼Œé•¿åº¦è¶ŠçŸ­è¶Šå¥½ã€‚key_lenæ˜¾ç¤ºçš„å€¼ä¸ºç´¢å¼•å­—æ®µçš„æœ€å¤§å¯èƒ½é•¿åº¦ï¼Œå¹¶éå®é™…ä½¿ç”¨é•¿åº¦ï¼Œå³key_lenæ—¶æ ¹æ®è¡¨å®šä¹‰è®¡ç®—è€Œå¾—ï¼Œä¸æ˜¯é€šè¿‡è¡¨å†…æ£€ç´¢å‡ºçš„ã€‚</p>
<p>è®¡ç®—ï¼š</p>
<ul>
<li>å­—ç¬¦ä¸² <ul>
<li>char(n)ï¼šnå­—èŠ‚é•¿åº¦</li>
<li>varchar(n)ï¼š2å­—èŠ‚å­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦ï¼Œå¦‚æœæ˜¯utf-8ï¼Œåˆ™é•¿åº¦ 3n + 2</li>
</ul>
</li>
<li>æ•°å€¼ç±»å‹ <ul>
<li>tinyintï¼š1å­—èŠ‚</li>
<li>smallintï¼š2å­—èŠ‚</li>
<li>intï¼š4å­—èŠ‚</li>
<li>bigintï¼š8å­—èŠ‚ã€€ã€€</li>
</ul>
</li>
<li>æ—¶é—´ç±»å‹ã€€ <ul>
<li>dateï¼š3å­—èŠ‚</li>
<li>timestampï¼š4å­—èŠ‚</li>
<li>datetimeï¼š8å­—èŠ‚</li>
</ul>
</li>
<li>å¦‚æœå­—æ®µå…è®¸ä¸º NULLï¼Œéœ€è¦1å­—èŠ‚è®°å½•æ˜¯å¦ä¸º NULL</li>
</ul>
<p>ç´¢å¼•æœ€å¤§é•¿åº¦æ˜¯768å­—èŠ‚ï¼Œå½“å­—ç¬¦ä¸²è¿‡é•¿æ—¶ï¼Œmysqlä¼šåšä¸€ä¸ªç±»ä¼¼å·¦å‰ç¼€ç´¢å¼•çš„å¤„ç†ï¼Œå°†å‰åŠéƒ¨åˆ†çš„å­—ç¬¦æå–å‡ºæ¥åšç´¢å¼•ã€‚</p>
<p>ï¼ˆ8ï¼‰ref</p>
<p>è§£é‡Šï¼š</p>
<p>æ˜¾ç¤ºç´¢å¼•çš„å“ªä¸€åˆ—è¢«ä½¿ç”¨äº†ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œæ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚å“ªäº›åˆ—æˆ–å¸¸é‡è¢«ç”¨äºæŸ¥æ‰¾ç´¢å¼•åˆ—ä¸Šçš„å€¼ã€‚</p>
<p>ï¼ˆ9ï¼‰rows</p>
<p>è§£é‡Šï¼š</p>
<p>è¿™ä¸€åˆ—æ˜¯mysqlä¼°è®¡è¦è¯»å–å¹¶æ£€æµ‹çš„è¡Œæ•°ï¼Œæ³¨æ„è¿™ä¸ªä¸æ˜¯ç»“æœé›†é‡Œçš„è¡Œæ•°ã€‚</p>
<p>ï¼ˆ10ï¼‰extra</p>
<p>è§£é‡Šï¼š</p>
<p>åŒ…å«ä¸é€‚åˆåœ¨å…¶ä»–åˆ—ä¸­æ˜¾ç¤ºä½†ååˆ†é‡è¦çš„é¢å¤–ä¿¡æ¯ã€‚</p>
<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>using index</code>ï¼šè¿™å‘ç”Ÿåœ¨å¯¹è¡¨çš„è¯·æ±‚åˆ—éƒ½æ˜¯åŒä¸€ç´¢å¼•çš„éƒ¨åˆ†çš„æ—¶å€™ï¼Œè¿”å›çš„åˆ—æ•°æ®åªä½¿ç”¨äº†ç´¢å¼•ä¸­çš„ä¿¡æ¯ï¼Œè€Œæ²¡æœ‰å†å»è®¿é—®è¡¨ä¸­çš„è¡Œè®°å½•ï¼Œæ˜¯æ€§èƒ½é«˜çš„è¡¨ç°ã€‚å¦‚æœåŒæ—¶å‡ºç°using whereï¼Œè¡¨æ˜ç´¢å¼•è¢«ç”¨æ¥æ‰§è¡Œç´¢å¼•é”®å€¼çš„æŸ¥æ‰¾ï¼›å¦‚æœæ²¡æœ‰åŒæ—¶å‡ºç°using whereï¼Œè¡¨æ˜ç´¢å¼•ç”¨æ¥è¯»å–æ•°æ®è€Œéæ‰§è¡ŒæŸ¥æ‰¾åŠ¨ä½œã€‚</li>
<li><code>using filesort</code>ï¼šMySQLä¼šå¯¹ç»“æœä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨ç´¢å¼•æ’åºï¼Œè€Œä¸æ˜¯æŒ‰ç´¢å¼•æ¬¡åºä»è¡¨é‡Œè¯»å–è¡Œã€‚æ­¤æ—¶MySQLä¼šæ ¹æ®è”æ¥ç±»å‹æµè§ˆæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå¹¶ä¿å­˜æ’åºå…³é”®å­—å’Œè¡ŒæŒ‡é’ˆï¼Œç„¶åæ’åºå…³é”®å­—å¹¶æŒ‰é¡ºåºæ£€ç´¢è¡Œä¿¡æ¯ã€‚è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯å¾ˆå±é™©çš„ï¼Œä¹æ­»ä¸€ç”Ÿã€‚</li>
<li><code>using temporary</code>ï¼šMySQLéœ€è¦åˆ›å»ºä¸€å¼ ä¸´æ—¶è¡¨æ¥å¤„ç†æŸ¥è¯¢ï¼Œå¯¹äºæŸ¥è¯¢ç»“æœæ’åºæ—¶ä½¿ç”¨ä¸´æ—¶è¡¨ï¼Œå¸¸è§äºæ’åºorder byå’Œåˆ†ç»„æŸ¥è¯¢group byã€‚å¸¸è§äºè¿™ç§æƒ…å†µå°±æ›´åŠ å±é™©äº†ï¼Œåæ­»æ— ç”Ÿã€‚</li>
<li><code>using where</code>ï¼šä½¿ç”¨whereè¿‡æ»¤ã€‚</li>
<li><code>using join buffer</code>ï¼šä½¿ç”¨è¿æ¥ç¼“å­˜ã€‚</li>
<li><code>impossible where</code>ï¼šwhereå­å¥æ€»æ˜¯falseï¼Œä¸èƒ½ç”¨æ¥è·å–ä»»ä½•å…ƒç»„ã€‚</li>
<li><code>select tables optimized away</code>ï¼šåœ¨æ²¡æœ‰GROUP BYå­å¥çš„æƒ…å†µä¸‹ï¼ŒåŸºäºç´¢å¼•ä¼˜åŒ–MIN/MAXæˆ–è€…å¯¹äºMyISAMå­˜å‚¨å¼•æ“ä¼˜åŒ–COUNT(*)æ“ä½œï¼Œä¸å¿…ç­‰åˆ°æ‰§è¡Œé˜¶æ®µå†è¿›è¡Œè®¡ç®—ï¼ŒæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ç”Ÿæˆçš„é˜¶æ®µå³å®Œæˆä¼˜åŒ–ã€‚</li>
<li><code>distinct</code>ï¼šä¸€æ—¦MySQLæ‰¾åˆ°äº†ä¸è¡Œç›¸è”åˆåŒ¹é…çš„è¡Œï¼Œå°±åœæ­¢æœç´¢ã€‚</li>
</ul>
<h3 id="SQLä¼˜åŒ–"><a href="#SQLä¼˜åŒ–" class="headerlink" title="SQLä¼˜åŒ–"></a>SQLä¼˜åŒ–</h3><blockquote>
<p>æ¡ˆä¾‹1</p>
</blockquote>
<p>å»ºè¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;tb2_article&#96; (</span><br><span class="line">  &#96;id&#96; int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;author_id&#96; int NOT NULL,</span><br><span class="line">  &#96;category_id&#96; int NOT NULL,</span><br><span class="line">  &#96;views&#96; int NOT NULL,</span><br><span class="line">  &#96;comments&#96; int NOT NULL,</span><br><span class="line">  &#96;title&#96; varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,</span><br><span class="line">  &#96;content&#96; text NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;4 DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line">INSERT INTO &#96;tb2_article&#96; VALUES (1, 1, 1, 1, 1, &#39;1&#39;, &#39;1&#39;);</span><br><span class="line">INSERT INTO &#96;tb2_article&#96; VALUES (2, 2, 2, 2, 2, &#39;2&#39;, &#39;2&#39;);</span><br><span class="line">INSERT INTO &#96;tb2_article&#96; VALUES (3, 3, 3, 3, 3, &#39;3&#39;, &#39;3&#39;);</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¬¡explainï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPLAIN SELECT id, author_id FROM tb2_article WHERE category_id &#x3D; 1 AND comments &gt; 1 order by views desc limit 1;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</span><br><span class="line">| id | select_type | table       | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                       |</span><br><span class="line">+----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</span><br><span class="line">|  1 | SIMPLE      | tb2_article | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    2 |    50.00 | Using where; Using filesort |</span><br><span class="line">+----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</span><br></pre></td></tr></table></figure>

<p>å»ºç«‹ç´¢å¼•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE INDEX idx_article_ccv on tb2_article(category_id,comments, views);</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ¬¡explainï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPLAIN SELECT id, author_id FROM tb2_article WHERE category_id &#x3D; 1 AND comments &gt; 1 order by views desc limit 1;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+</span><br><span class="line">| id | select_type | table       | partitions | type  | possible_keys   | key             | key_len | ref  | rows | filtered | Extra                                 |</span><br><span class="line">+----+-------------+-------------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | tb2_article | NULL       | range | idx_article_ccv | idx_article_ccv | 8       | NULL |    1 |   100.00 | Using index condition; Using filesort |</span><br><span class="line">+----+-------------+-------------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å‘ç°keyä¸­å·²ç»æ˜¾ç¤ºäº†åˆšåˆšå»ºç«‹çš„ç´¢å¼•ï¼Œä½†æ˜¯ä¾ç„¶ä½¿ç”¨äº†æ–‡ä»¶æ’åºã€‚</p>
<p>ç¬¬ä¸‰æ¬¡explainï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPLAIN SELECT id, author_id FROM tb2_article WHERE category_id &#x3D; 1 AND comments &#x3D; 1 order by views desc limit 1;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------------+------------+------+-----------------+-----------------+---------+-------------+------+----------+---------------------+</span><br><span class="line">| id | select_type | table       | partitions | type | possible_keys   | key             | key_len | ref         | rows | filtered | Extra               |</span><br><span class="line">+----+-------------+-------------+------------+------+-----------------+-----------------+---------+-------------+------+----------+---------------------+</span><br><span class="line">|  1 | SIMPLE      | tb2_article | NULL       | ref  | idx_article_ccv | idx_article_ccv | 8       | const,const |    1 |   100.00 | Backward index scan |</span><br><span class="line">+----+-------------+-------------+------------+------+-----------------+-----------------+---------+-------------+------+----------+---------------------+</span><br></pre></td></tr></table></figure>

<p>å½“æŠŠæŸ¥è¯¢æ¡ä»¶ä¿®æ”¹ä¸ºç­‰äºæ—¶ï¼Œå‘ç°refä¸­å‡ºç°ä¸¤ä¸ªå¸¸é‡ï¼Œå³ä¸¤ä¸ªæŸ¥è¯¢å¸¸é‡ï¼Œå¹¶ä¸”æ²¡æœ‰ä½¿ç”¨æ–‡ä»¶æ’åºã€‚è¯´æ˜å½“æŸ¥è¯¢æ¡ä»¶ä¸ºå¤§äºå·æ—¶ï¼Œç´¢å¼•å¤±æ•ˆã€‚</p>
<p>æµ…æç¬¬äºŒæ¬¡åŠ äº†ç´¢å¼•ä¹‹åexplainä¾ç„¶ä½¿ç”¨<code>filesort</code>ï¼š</p>
<p>æŒ‰ç…§BTreeçš„å·¥ä½œåŸç†ï¼Œå…ˆæ’åº<code>category_id</code>ï¼Œå¦‚æœé‡åˆ°ç›¸åŒçš„<code>category_id</code>åˆ™å†æ’åº<code>comments</code>ï¼Œå¦‚æœé‡åˆ°ç›¸åŒçš„<code>commnents</code>åˆ™å†æ’åº<code>views</code>ã€‚å½“<code>comments</code>å­—æ®µåœ¨è”åˆç´¢å¼•é‡Œå¤„äºä¸­é—´ä½ç½®æ—¶ï¼Œå› <code>comments &gt; 1</code>æ¡ä»¶æ˜¯ä¸€ä¸ªèŒƒå›´å€¼(range)ï¼ŒMySQLæ— æ³•åˆ©ç”¨ç´¢å¼•å†å¯¹åé¢çš„viewséƒ¨åˆ†è¿›è¡Œæ£€ç´¢ï¼Œå³rangeç±»å‹æŸ¥è¯¢å­—æ®µåé¢çš„ç´¢å¼•æ— æ•ˆã€‚</p>
<p>åˆ é™¤ç´¢å¼•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP INDEX idx_article_ccv ON tb2_article;</span><br></pre></td></tr></table></figure>

<p>æ–°å»ºç´¢å¼•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE INDEX idx_article_cv ON  tb2_article(category_id, views);</span><br></pre></td></tr></table></figure>

<p>å†æ¬¡explainï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPLAIN SELECT id, author_id FROM tb2_article WHERE category_id &#x3D; 1 AND comments &gt; 1 order by views desc limit 1;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+-------------+-------------+------------+------+----------------+----------------+---------+-------+------+----------+----------------------------------+</span><br><span class="line">| id | select_type | table       | partitions | type | possible_keys  | key            | key_len | ref   | rows | filtered | Extra                            |</span><br><span class="line">+----+-------------+-------------+------------+------+----------------+----------------+---------+-------+------+----------+----------------------------------+</span><br><span class="line">|  1 | SIMPLE      | tb2_article | NULL       | ref  | idx_article_cv | idx_article_cv | 4       | const |    1 |    50.00 | Using where; Backward index scan |</span><br><span class="line">+----+-------------+-------------+------------+------+----------------+----------------+---------+-------+------+----------+----------------------------------+</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°typeå˜æˆäº†<code>ref</code>ï¼ŒExtraä¸­çš„<code>using filesort</code>ä¹Ÿæ¶ˆå¤±äº†ï¼Œç»“æœéå¸¸ç†æƒ³ã€‚</p>
<p>ç»“è®ºï¼šå»ºç«‹å¤åˆç´¢å¼•çš„æ—¶å€™æœ€å¥½ä¸è¦å¸¦ä¸Šå«æœ‰èŒƒå›´æŸ¥è¯¢çš„å­—æ®µã€‚</p>
<blockquote>
<p>æ¡ˆä¾‹2</p>
</blockquote>
<p>ç»§ç»­å»ºè¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;tb2_class&#96; (</span><br><span class="line">  &#96;id&#96; int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;card&#96; int NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;2 DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;tb2_book&#96; (</span><br><span class="line">  &#96;bookid&#96; int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;card&#96; int NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;bookid&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line">INSERT INTO tb2_class(card) VALUES(FLOOR(1 + RAND() * 20));</span><br><span class="line">INSERT INTO tb2_book(card) VALUES(FLOOR(1 + RAND() * 20));</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¬¡explainï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book on tb2_class.card &#x3D; tb2_book.card;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</span><br><span class="line">| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                      |</span><br><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | tb2_class | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    9 |   100.00 | NULL                                       |</span><br><span class="line">|  1 | SIMPLE      | tb2_book  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    9 |   100.00 | Using where; Using join buffer (hash join) |</span><br><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°typeéƒ½ä¸ºALLã€‚</p>
<p>å»ºç«‹å³è¡¨tb2_bookç´¢å¼•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE tb2_book ADD INDEX(card);</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ¬¡explainï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book on tb2_class.card &#x3D; tb2_book.card;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+</span><br><span class="line">| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref                        | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | tb2_class | NULL       | ALL  | NULL          | NULL | NULL    | NULL                       |    9 |   100.00 | NULL        |</span><br><span class="line">|  1 | SIMPLE      | tb2_book  | NULL       | ref  | card          | card | 4       | mysql_learn.tb2_class.card |    1 |   100.00 | Using index |</span><br><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°tb2_classçš„typeä¾ç„¶æ˜¯ALLï¼Œtb2_bookçš„typeä¼˜åŒ–ä¸ºrefã€‚</p>
<p>åˆ é™¤tb2_bookçš„ç´¢å¼•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP INDEX card ON tb2_book;</span><br></pre></td></tr></table></figure>

<p>å»ºç«‹å·¦è¡¨tb2_classç´¢å¼•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE tb2_class ADD INDEX(card);</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸‰æ¬¡explainï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book on tb2_class.card &#x3D; tb2_book.card;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------------+</span><br><span class="line">| id | select_type | table     | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                      |</span><br><span class="line">+----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | tb2_class | NULL       | index | NULL          | card | 4       | NULL |    9 |   100.00 | Using index                                |</span><br><span class="line">|  1 | SIMPLE      | tb2_book  | NULL       | ALL   | NULL          | NULL | NULL    | NULL |    9 |   100.00 | Using where; Using join buffer (hash join) |</span><br><span class="line">+----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°tb2_classçš„typeä¸ºindexï¼Œtb2_bookçš„typeä¸‹é™ä¸ºALLã€‚</p>
<p>æœ€åå†æ¬¡å»ºç«‹tb2_bookçš„ç´¢å¼•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE tb2_book ADD INDEX(card);</span><br></pre></td></tr></table></figure>

<p>ç¬¬å››æ¬¡explainï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book on tb2_class.card &#x3D; tb2_book.card;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+-------------+-----------+------------+-------+---------------+------+---------+----------------------------+------+----------+-------------+</span><br><span class="line">| id | select_type | table     | partitions | type  | possible_keys | key  | key_len | ref                        | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+-----------+------------+-------+---------------+------+---------+----------------------------+------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | tb2_class | NULL       | index | NULL          | card | 4       | NULL                       |    9 |   100.00 | Using index |</span><br><span class="line">|  1 | SIMPLE      | tb2_book  | NULL       | ref   | card          | card | 4       | mysql_learn.tb2_class.card |    1 |   100.00 | Using index |</span><br><span class="line">+----+-------------+-----------+------------+-------+---------------+------+---------+----------------------------+------+----------+-------------+</span><br></pre></td></tr></table></figure>

<p>å‘ç°typeéƒ½æå‡äº†ï¼Œindexå’Œrefï¼Œç»“æœå¾ˆç†æƒ³ã€‚</p>
<p>ç»“è®ºï¼šå¯¹äºJOINè¿æ¥æŸ¥è¯¢çš„ä¸¤å¼ è¡¨æœ€å¥½éƒ½åœ¨è”ç»“å­—æ®µå»ºç«‹å•å€¼ç´¢å¼•ã€‚</p>
<blockquote>
<p>æ¡ˆä¾‹3</p>
</blockquote>
<p>ç»§ç»­å»ºè¡¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;tb2_phone&#96; (</span><br><span class="line">  &#96;phoneid&#96; int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;card&#96; int DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;phoneid&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line">INSERT INTO tb2_phone(card) VALUES(FLOOR(1 + (RAND()*20)));</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¬¡explainï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book ON tb2_class.card &#x3D; tb2_book.card LEFT JOIN tb2_phone ON tb2_book.card &#x3D; tb2_phone.card ;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</span><br><span class="line">| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                      |</span><br><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</span><br><span class="line">|  1 | SIMPLE      | tb2_class | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    9 |   100.00 | NULL                                       |</span><br><span class="line">|  1 | SIMPLE      | tb2_book  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    9 |   100.00 | Using where; Using join buffer (hash join) |</span><br><span class="line">|  1 | SIMPLE      | tb2_phone | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    9 |   100.00 | Using where; Using join buffer (hash join) |</span><br><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>å‘ç°ä¸‰å¼ è¡¨çš„typeéƒ½æ˜¯ALLã€‚</p>
<p>å»ºç«‹tb2_phoneå’Œtb2_bookçš„ç´¢å¼•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE tb2_phone INDEX(card);</span><br><span class="line">ALTER TABLE tb2_book ADD INDEX(card);</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ¬¡explainï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book ON tb2_class.card &#x3D; tb2_book.card LEFT JOIN tb2_phone ON tb2_book.card &#x3D; tb2_phone.card ;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+</span><br><span class="line">| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref                        | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | tb2_class | NULL       | ALL  | NULL          | NULL | NULL    | NULL                       |    9 |   100.00 | NULL        |</span><br><span class="line">|  1 | SIMPLE      | tb2_book  | NULL       | ref  | card          | card | 4       | mysql_learn.tb2_class.card |    1 |   100.00 | Using index |</span><br><span class="line">|  1 | SIMPLE      | tb2_phone | NULL       | ref  | card          | card | 5       | mysql_learn.tb2_book.card  |    1 |   100.00 | Using index |</span><br><span class="line">+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+</span><br></pre></td></tr></table></figure>

<p>å‘ç°tb2_phoneå’Œtb2_bookçš„typeè¢«ä¼˜åŒ–ä¸ºrefï¼Œå¹¶ä¸”rowsä¹Ÿä¼˜åŒ–çš„å¾ˆå¥½ã€‚</p>
<p>ç»“è®ºï¼š</p>
<ul>
<li><strong>æ°¸è¿œç”¨å°ç»“æœé›†é©±åŠ¨å¤§ç»“æœé›†</strong></li>
<li>å°½å¯èƒ½å‡å°‘Joinè¯­å¥ä¸­çš„NestedLoopçš„å¾ªç¯æ€»æ¬¡æ•°</li>
<li>ä¼˜å…ˆä¼˜åŒ–NestedLoopçš„å†…å­˜å¾ªç¯</li>
<li>ä¿è¯Joinè¯­å¥ä¸­è¢«é©±åŠ¨è¡¨ä¸ŠJoinæ¡ä»¶å­—æ®µå·²ç»è¢«ç´¢å¼•</li>
<li>å½“æ— æ³•ä¿è¯è¢«é©±åŠ¨è¡¨çš„Joinæ¡ä»¶å­—æ®µè¢«ç´¢å¼•ä¸”å†…å­˜èµ„æºå……è¶³çš„å‰æä¸‹ï¼Œä¸è¦å¤ªåå•¬JoinBufferçš„è®¾ç½®</li>
</ul>
<h3 id="ç´¢å¼•å¤±æ•ˆ"><a href="#ç´¢å¼•å¤±æ•ˆ" class="headerlink" title="ç´¢å¼•å¤±æ•ˆ"></a>ç´¢å¼•å¤±æ•ˆ</h3><blockquote>
<p>SQLè„šæœ¬</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;tb3_staff&#96; (</span><br><span class="line">  &#96;id&#96; int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;name&#96; varchar(20) DEFAULT NULL,</span><br><span class="line">  &#96;age&#96; int DEFAULT NULL,</span><br><span class="line">  &#96;pos&#96; varchar(20) DEFAULT NULL,</span><br><span class="line">  &#96;add_time&#96; timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;5 DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line">INSERT INTO tb3_staff(name, age, pos, add_time) VALUES ( &#39;KHighness&#39;, 19, &#39;manager&#39;, NOW());</span><br><span class="line">INSERT INTO tb3_staff(name, age, pos, add_time) VALUES ( &#39;FlowerK&#39;, 18, &#39;dev&#39;, NOW());</span><br><span class="line">INSERT INTO tb3_staff(name, age, pos, add_time) VALUES ( &#39;UnknownK&#39;, 17, &#39;dev&#39;, NOW());</span><br><span class="line"></span><br><span class="line">ALTER TABLE tb3_staff ADD INDEX id_staff_nameagepos(name, age, pos);</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ç”Ÿæ•ˆåœºæ™¯</p>
</blockquote>
<ul>
<li><code>EXPLAIN SELECT * FROM tb3_staff WHERE name = &#39;KHighness&#39;;</code></li>
<li><code>EXPLAIN SELECT * FROM tb3_staff WHERE name = &#39;KHighness&#39; and age = 19;</code></li>
<li><code>EXPLAIN SELECT * FROM tb3_staff WHERE name = &#39;KHighness&#39; and age = 19 and pos = &quot;dev&quot;;</code></li>
</ul>
<blockquote>
<p>å¤±æ•ˆåœºæ™¯</p>
</blockquote>
<ul>
<li><code>EXPLAIN SELECT * FROM tb3_staff WHERE age = 19 and pos = &quot;dev&quot;;</code></li>
<li> <code>EXPLAIN SELECT * FROM tb3_staff WHERE  pos = &quot;dev&quot;;</code></li>
</ul>
<blockquote>
<p>éƒ¨åˆ†å¤±æ•ˆ</p>
</blockquote>
<ul>
<li><code>EXPLAIN SELECT * FROM tb3_staff WHERE name = &#39;KHighness&#39; and pos = &quot;dev&quot;;</code></li>
</ul>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<p>1ã€æœ€ç†æƒ³çš„æƒ…å†µå°±æ˜¯æŸ¥è¯¢å­—æ®µä¸ç´¢å¼•å­—æ®µç›¸åŒ</p>
<p>2ã€æœ€ä½³å·¦å‰ç¼€æ³•åˆ™</p>
<p>3ã€ä¸åœ¨ç´¢å¼•åˆ—ä¸Šåšä»»ä½•æ“ä½œï¼ˆè®¡ç®—ã€å‡½æ•°ã€ï¼ˆè‡ªåŠ¨oræ‰‹åŠ¨ï¼‰ç±»å‹è½¬æ¢ï¼‰ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆè€Œè½¬å‘å…¨è¡¨æ‰«æ</p>
<p>4ã€å­˜å‚¨å¼•æ“ä¸èƒ½ä½¿ç”¨ç´¢å¼•ä¸­èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—</p>
<p>5ã€å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆåªè®¿é—®ç´¢å¼•çš„æŸ¥è¯¢ï¼ˆç´¢å¼•åˆ—å’ŒæŸ¥è¯¢åˆ—ä¸€è‡´ï¼‰ï¼‰ï¼Œå‡å°‘select *</p>
<p>6ã€ä½¿ç”¨ä¸ç­‰äº(!= æˆ–è€… &lt;&gt;)çš„æ—¶å€™ç´¢å¼•å¤±æ•ˆä¼šå¯¼è‡´rangeï¼ˆMySQL5ä¸­æ˜¯ALLï¼‰</p>
<p>7ã€ä½¿ç”¨is nullæˆ–è€…is not nullçš„æ—¶å€™ç´¢å¼•å¤±æ•ˆä¼šå¯¼è‡´rangeï¼ˆMySQL5ä¸­æ˜¯ALLï¼‰</p>
<p>8ã€likeä»¥é€šé…ç¬¦å¼€å¤´ç´¢å¼•å¤±æ•ˆä¼šå¯¼è‡´ALLï¼Œå»ºç«‹è¦†ç›–ç´¢å¼•å¯ä»¥é˜²æ­¢</p>
<p>9ã€MySQL5ä¸­å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ç´¢å¼•å¤±æ•ˆä¼šå¯¼è‡´ALLï¼ŒMySQL8ä¸­ç›´æ¥æŠ¥é”™</p>
<p>10ã€ä½¿ç”¨orè¿æ¥ç´¢å¼•å¤±æ•ˆä¼šå¯¼è‡´ALL</p>
<h3 id="ç´¢å¼•é¢è¯•"><a href="#ç´¢å¼•é¢è¯•" class="headerlink" title="ç´¢å¼•é¢è¯•"></a>ç´¢å¼•é¢è¯•</h3><blockquote>
<p>SQLè¯­å¥</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;tb4_test&#96; (</span><br><span class="line">  &#96;id&#96; int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;c1&#96; char(10) DEFAULT NULL,</span><br><span class="line">  &#96;c2&#96; char(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,</span><br><span class="line">  &#96;c3&#96; char(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,</span><br><span class="line">  &#96;c4&#96; char(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,</span><br><span class="line">  &#96;c5&#96; char(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line">CREATE INDEX idx_tb4_test_c1234 ON tb4_test(c1, c2, c3, c4);</span><br><span class="line"></span><br><span class="line">INSERT INTO &#96;mysql_learn&#96;.&#96;tb4_test&#96;(&#96;id&#96;, &#96;c1&#96;, &#96;c2&#96;, &#96;c3&#96;, &#96;c4&#96;, &#96;c5&#96;) VALUES (1, &#39;a1&#39;, &#39;a2&#39;, &#39;a3&#39;, &#39;a4&#39;, &#39;a5&#39;);</span><br><span class="line">INSERT INTO &#96;mysql_learn&#96;.&#96;tb4_test&#96;(&#96;id&#96;, &#96;c1&#96;, &#96;c2&#96;, &#96;c3&#96;, &#96;c4&#96;, &#96;c5&#96;) VALUES (2, &#39;b1&#39;, &#39;b2&#39;, &#39;b3&#39;, &#39;b4&#39;, &#39;b5&#39;);</span><br><span class="line">INSERT INTO &#96;mysql_learn&#96;.&#96;tb4_test&#96;(&#96;id&#96;, &#96;c1&#96;, &#96;c2&#96;, &#96;c3&#96;, &#96;c4&#96;, &#96;c5&#96;) VALUES (3, &#39;c1&#39;, &#39;c2&#39;, &#39;c3&#39;, &#39;c4&#39;, &#39;c5&#39;);</span><br><span class="line">INSERT INTO &#96;mysql_learn&#96;.&#96;tb4_test&#96;(&#96;id&#96;, &#96;c1&#96;, &#96;c2&#96;, &#96;c3&#96;, &#96;c4&#96;, &#96;c5&#96;) VALUES (4, &#39;d1&#39;, &#39;d2&#39;, &#39;d3&#39;, &#39;d4&#39;, &#39;d5&#39;);</span><br><span class="line">INSERT INTO &#96;mysql_learn&#96;.&#96;tb4_test&#96;(&#96;id&#96;, &#96;c1&#96;, &#96;c2&#96;, &#96;c3&#96;, &#96;c4&#96;, &#96;c5&#96;) VALUES (5, &#39;e1&#39;, &#39;e2&#39;, &#39;e3&#39;, &#39;e4&#39;, &#39;e5&#39;);</span><br></pre></td></tr></table></figure>



<blockquote>
<p>EXPLAINæµ‹è¯•</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- æœ€å¥½ç´¢å¼•å¦‚ä½•åˆ›å»ºå°±å¦‚ä½•ä½¿ç”¨ï¼Œé¿å…è®©MySQLè‡ªå·±å†ç¿»è¯‘ä¼˜åŒ– --</span><br><span class="line"></span><br><span class="line">-- 1. ç”¨åˆ°ç´¢å¼•c1 c2 c3 c4å…¨å­—æ®µï¼Œå…¨å€¼åŒ¹é…</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c2 &#x3D; &#39;a2&#39; AND c3 &#x3D; &#39;a3&#39; AND c4 &#x3D; &#39;a4&#39;;</span><br><span class="line"></span><br><span class="line">-- 2. ç”¨åˆ°ç´¢å¼•c1 c2 c3 c4å…¨å­—æ®µï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä¼˜åŒ–SQLè¯­å¥çš„æ‰§è¡Œé¡ºåº</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c4 &#x3D; &#39;a4&#39; AND c3 &#x3D; &#39;a3&#39; AND c2 &#x3D; &#39;a2&#39; AND c1 &#x3D; &#39;a1&#39;;</span><br><span class="line"></span><br><span class="line">-- 3. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc4å­—æ®µå¤±æ•ˆï¼ŒèŒƒå›´ä¹‹åå…¨å¤±æ•ˆ</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c2 &#x3D; &#39;a2&#39; AND c3 &gt; &#39;a3&#39; AND c4 &#x3D; &#39;a4&#39;;</span><br><span class="line"></span><br><span class="line">-- 4. ç”¨åˆ°ç´¢å¼•c1 c2 c3 c4å…¨å­—æ®µï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä¼˜åŒ–SQLè¯­å¥çš„æ‰§è¡Œé¡ºåº</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c2 &#x3D; &#39;a2&#39; AND c4 &gt; &#39;a4&#39; AND c3 &#x3D; &#39;a3&#39;;</span><br><span class="line"></span><br><span class="line">-- order byæ’åºä¸€å®šè¦æ³¨æ„é¡ºåºï¼Œè¿™ä¸ªé¡ºåºMySQLä¸ä¼šè‡ªåŠ¨ä¼˜åŒ– --</span><br><span class="line"></span><br><span class="line">-- 5. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc1 c2ç”¨äºæŸ¥æ‰¾ï¼Œc3ç”¨äºæ’åºï¼Œä½†æ˜¯æ²¡æœ‰ç»Ÿè®¡åˆ°key_lenä¸­ï¼Œc4å­—æ®µå¤±æ•ˆ</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c2 &#x3D; &#39;a2&#39; AND c4 &gt; &#39;a4&#39; ORDER BY c3;</span><br><span class="line"></span><br><span class="line">-- 6. ç”¨åˆ°ç´¢å¼•c1 c2å­—æ®µï¼Œc1 c2ç”¨äºæŸ¥æ‰¾ï¼Œc4æ’åºäº§ç”Ÿäº†Using filesortè¯´æ˜c4å¤±æ•ˆ</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c2 &#x3D; &#39;a2&#39; ORDER BY c4;</span><br><span class="line"></span><br><span class="line">-- 7. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc1ç”¨äºæŸ¥æ‰¾ï¼Œc2 c3ç”¨äºæ’åº</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c5 &#x3D; &#39;a5&#39; ORDER BY c2, c3;</span><br><span class="line"></span><br><span class="line">-- 8. ç”¨åˆ°ç´¢å¼•c1å­—æ®µï¼Œc1ç”¨äºæŸ¥æ‰¾ï¼Œc3 c2å¤±æ•ˆï¼Œäº§ç”Ÿäº†Using filesort</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c5 &#x3D; &#39;a5&#39; ORDER BY c3, c2;</span><br><span class="line"></span><br><span class="line">-- 9. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc1 c2ç”¨äºæŸ¥æ‰¾ï¼Œc2 c3ç”¨äºæ’åº</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c2 &#x3D; &#39;a2&#39; AND c5 &#x3D; &#39;a5&#39; ORDER BY c2, c3;</span><br><span class="line"></span><br><span class="line">-- 10. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc1 c2ç”¨äºæŸ¥æ‰¾ï¼Œc3æ‰ç”¨äºæ’åº</span><br><span class="line">--     æ²¡æœ‰äº§ç”ŸUsing filesortï¼Œå› ä¸ºc2æŸ¥æ‰¾æ—¶å·²ç»ç¡®å®šäº†ï¼Œæ’åºæ—¶c2å·²ç»ä¸ç”¨æ’åºäº†</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c2 &#x3D; &#39;a2&#39; AND c5 &#x3D; &#39;a5&#39; ORDER BY c3, c2;</span><br><span class="line"></span><br><span class="line">-- group byè™½ç„¶æ˜¯åˆ†ç»„ï¼Œä½†æ˜¯åˆ†ç»„ä¹‹å‰å¿…ç„¶æ’åº --</span><br><span class="line"></span><br><span class="line">-- 11. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc1ç”¨äºæŸ¥æ‰¾ï¼Œc2 c3ç”¨äºæ’åºï¼Œc4å¤±æ•ˆ</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c4 &#x3D; &#39;a4&#39; GROUP BY c2, c3;</span><br><span class="line"></span><br><span class="line">-- 12. ç”¨åˆ°ç´¢å¼•c1å­—æ®µï¼Œc1ç”¨äºæŸ¥æ‰¾ï¼Œc2 c3å¤±æ•ˆï¼Œäº§ç”Ÿäº†Using temporary</span><br><span class="line">EXPLAIN SELECT * FROM tb4_test WHERE c1 &#x3D; &#39;a1&#39; AND c4 &#x3D; &#39;a4&#39; GROUP BY c3, c2;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<ul>
<li>å®šå€¼ã€èŒƒå›´è¿˜æ˜¯æ’åºï¼Œä¸€èˆ¬order byæ˜¯ç»™ä¸ªèŒƒå›´ã€‚</li>
<li>group byåŸºæœ¬ä¸Šéƒ½éœ€è¦è¿›è¡Œæ’åºï¼Œä¼šæœ‰ä¸´æ—¶è¡¨äº§ç”Ÿã€‚</li>
<li>likeåŒ¹é…%åœ¨å­—ç¬¦ä¸²æœ€å³è¾¹ä¼šä½¿ç”¨ä½¿ç”¨ï¼Œ%åœ¨å­—ç¬¦ä¸²æœ€å·¦è¾¹ä¸ä¼šä½¿ç”¨ã€‚</li>
</ul>
<blockquote>
<p>ä¸€èˆ¬æ€§å»ºè®®</p>
</blockquote>
<ul>
<li><p>å¯¹äºå•é”®ç´¢å¼•ï¼Œå°½é‡é€‰æ‹©é’ˆå¯¹å½“å‰queryè¿‡æ»¤æ€§æ›´å¥½çš„ç´¢å¼•ã€‚</p>
</li>
<li><p>åœ¨é€‰æ‹©ç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå½“å‰queryä¸­è¿‡æ»¤æ€§æœ€å¥½çš„å­—æ®µåœ¨ç´¢å¼•å­—æ®µé¡ºåºä¸­ï¼Œä½ç½®è¶Šé å‰è¶Šå¥½ã€‚</p>
</li>
<li><p>åœ¨é€‰æ‹©ç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå°½é‡é€‰æ‹©å¯ä»¥èƒ½å¤ŸåŒ…å«å½“å‰queryä¸­çš„whereå­å¥ä¸­æ›´å¤šå­—æ®µçš„ç´¢å¼•ã€‚</p>
</li>
<li><p>å°½å¯èƒ½é€šè¿‡åˆ†æç»Ÿè®¡ä¿¡æ¯å’Œè°ƒæ•´queryçš„å†™æ³•æ¥è¾¾åˆ°é€‰æ‹©åˆé€‚ç´¢å¼•çš„ç›®çš„ã€‚</p>
</li>
</ul>
<blockquote>
<p>ä¼˜åŒ–å£è¯€</p>
</blockquote>
<p>å¸¦å¤´å¤§å“¥ä¸èƒ½æ­»ï¼Œä¸­é—´å…„å¼Ÿä¸èƒ½æ–­ï¼›</p>
<p>è¦†ç›–ç´¢å¼•ä¸å†™æ˜Ÿï¼Œç´¢å¼•åˆ—ä¸Šå°‘è®¡ç®—ï¼›</p>
<p>ä¸ç­‰æœ‰æ—¶ä¼šå¤±æ•ˆï¼ŒèŒƒå›´ä¹‹åå…¨å¤±æ•ˆï¼›</p>
<p>LIKEç™¾åˆ†å†™æœ€å³ï¼Œä¸€èˆ¬SQLå°‘ç”¨ORã€‚</p>
<h2 id="æŸ¥è¯¢æˆªå–"><a href="#æŸ¥è¯¢æˆªå–" class="headerlink" title="æŸ¥è¯¢æˆªå–"></a>æŸ¥è¯¢æˆªå–</h2><h3 id="æŸ¥è¯¢ä¼˜åŒ–-1"><a href="#æŸ¥è¯¢ä¼˜åŒ–-1" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–-1"></a>æŸ¥è¯¢ä¼˜åŒ–-1</h3><blockquote>
<p>ä¼˜åŒ–ç­–ç•¥</p>
</blockquote>
<p>æ°¸è¿œå°è¡¨é©±åŠ¨å¤§è¡¨ã€‚</p>
<blockquote>
<p>IN</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM A WHERE id IN (SELECT id FROM B)</span><br></pre></td></tr></table></figure>

<p>ç­‰ä»·äºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for select id from B</span><br><span class="line">	for select * from A where A.id &#x3D; B.id</span><br></pre></td></tr></table></figure>

<p>å½“Aè¡¨çš„æ•°æ®é›†å¤§äºBè¡¨çš„æ•°æ®é›†æ—¶ï¼Œç”¨inä¼˜å…ˆexistsã€‚</p>
<blockquote>
<p>EXISTS</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM A WHERE EXISTS (SELECT 1 FROM B WHERE B.id &#x3D; A.id)</span><br></pre></td></tr></table></figure>

<p>ç­‰ä»·äº</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">for select id from A</span><br><span class="line">	for select * from B &#x3D; B.id &#x3D; A.id</span><br></pre></td></tr></table></figure>

<p>å½“Aè¡¨çš„æ•°æ®é›†å°äºBè¡¨çš„æ•°æ®é›†æ—¶ï¼Œç”¨existsä¼˜å…ˆinã€‚</p>
<h3 id="æŸ¥è¯¢ä¼˜åŒ–-2"><a href="#æŸ¥è¯¢ä¼˜åŒ–-2" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–-2"></a>æŸ¥è¯¢ä¼˜åŒ–-2</h3><blockquote>
<p>ä¼˜åŒ–ç­–ç•¥</p>
</blockquote>
<p>Order Byå…³é”®å­—ä¼˜åŒ–ï¼š</p>
<p>Order Byå­å¥ï¼Œå°½é‡ä½¿ç”¨Indexæ–¹å¼æ’åºï¼Œé¿å…ä½¿ç”¨FileSortæ–¹å¼æ’åºã€‚</p>
<p>å°½å¯èƒ½åœ¨ç´¢å¼•åˆ—ä¸Šå®Œæˆæ’åºæ“ä½œï¼Œéµç…§ç´¢å¼•å»ºçš„æœ€ä½³å·¦å‰ç¼€ã€‚</p>
<p>å¦‚æœä¸åœ¨ç´¢å¼•åˆ—ä¸Šï¼ŒFileSortæœ‰ä¸¤ç§ç®—æ³•ï¼šMySQLå°±è¦å¯åŠ¨åŒè·¯æ’åºå’Œå•è·¯æ’åºã€‚</p>
<blockquote>
<p>æ¡ˆä¾‹</p>
</blockquote>
<p>SQLè„šæœ¬ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;tb5_a&#96; (</span><br><span class="line">  &#96;age&#96; int NOT NULL,</span><br><span class="line">  &#96;birth&#96; timestamp NOT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line">INSERT INTO tb5_a(age, birth) VALUES(17, NOW());</span><br><span class="line">INSERT INTO tb5_a(age, birth) VALUES(18, NOW());</span><br><span class="line">INSERT INTO tb5_a(age, birth) VALUES(19, NOW());</span><br><span class="line"></span><br><span class="line">CREATE INDEX idx_a_agebirth ON tb5_a(age, birth);</span><br></pre></td></tr></table></figure>

<p>å…«ä¸ªcaseï¼š</p>
<ul>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE age &gt; 20 ORDER BY age;</code> =&gt; æ­£å¸¸</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE age &gt; 20 ORDER BY birth;</code> =&gt; using filesort</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE age &gt; 20 ORDER BY age, birth;</code> =&gt; æ­£å¸¸</li>
<li><code> EXPLAIN SELECT * FROM tb5_a WHERE age &gt; 20 ORDER BY birthï¼Œage;</code> =&gt; using filesprt</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE birth &gt; &#39;2020-3:23 00:00:00&#39; ORDER BY age;</code> =&gt; æ­£å¸¸</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE birth &gt; &#39;2020-3:23 00:00:00&#39; ORDER BY birth;</code> =&gt; using filesort</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE birth &gt; &#39;2020-3:23 00:00:00&#39; ORDER BY age,birth;</code> =&gt; æ­£å¸¸</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE birth &gt; &#39;2020-3:23 00:00:00&#39; ORDER BY birth,age;</code> =&gt; using filesort</li>
<li><code>EXPLAIN SELECT * FROM tb5_a ORDER BY age ASC,birth ASC;</code> =&gt; æ­£å¸¸</li>
<li><code>EXPLAIN SELECT * FROM tb5_a ORDER BY age DESC,birth DESC;</code> =&gt; æ­£å¸¸</li>
<li><code>EXPLAIN SELECT * FROM tb5_a ORDER BY age ASC,birth DESC;</code> =&gt; using filesort</li>
<li><code>EXPLAIN SELECT * FROM tb5_a ORDER BY age DESC,birth ASC;</code> =&gt; using filesort</li>
</ul>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<p>æ€»ç»“ï¼šOrder Byæ»¡è¶³ä¸¤ç§æƒ…å†µï¼Œä¼šä½¿ç”¨Indexæ–¹å¼æ’åºï¼š</p>
<ul>
<li>Order Byè¯­å¥ä½¿ç”¨ç´¢å¼•æœ€å·¦å‰åˆ—</li>
<li>ä½¿ç”¨Whereå­å¥ä¸Order Byå­å¥æ¡ä»¶åˆ—ç»„åˆæ»¡è¶³ç´¢å¼•æœ€å·¦å‰åˆ—</li>
</ul>
<p>æ³¨æ„ï¼šå¦‚æœä¸åœ¨ç´¢å¼•åˆ—ä¸Šï¼Œfilesortæœ‰ä¸¤ç§ç®—æ³•ï¼š</p>
<ul>
<li>åŒè·¯æ’åºï¼šä¸¤æ¬¡æ‰«æç£ç›˜è·å–æ•°æ®ï¼Œè¯»å–è¡ŒæŒ‡é’ˆå’Œorder byåˆ—ï¼Œå¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼Œç„¶åæ‰«æå·²ç»æ’åºå·çš„åˆ—è¡¨ï¼ŒæŒ‰ç…§åˆ—è¡¨ä¸­çš„å€¼é‡æ–°ä»åˆ—è¡¨ä¸­è¯»å–å¯¹åº”çš„æ•°æ®è¾“å‡ºã€‚</li>
<li>å•è·¯æ’åºï¼šä»ç£ç›˜è¯»å–æŸ¥è¯¢éœ€è¦çš„æ‰€æœ‰åˆ—ï¼ŒæŒ‰ç…§order byåˆ—åœ¨bufferå¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼Œç„¶åæ‰«ææ’åºåçš„åˆ—è¡¨è¿›è¡Œè¾“å‡ºï¼Œå®ƒçš„æ•ˆç‡æ›´å¿«ä¸€äº›ï¼Œé¿å…äº†ç¬¬äºŒæ¬¡è¯»å–æ•°æ®ã€‚å¹¶ä¸”æŠŠéšæœºIOå˜æˆäº†é¡ºåºIOï¼Œä½†æ˜¯å®ƒä¼šä½¿ç”¨æ›´å¤šçš„ç©ºé—´ï¼Œå› ä¸ºå®ƒæŠŠæ¯ä¸€è¡Œéƒ½ä¿å­˜åœ¨å†…å­˜ä¸­äº†ã€‚</li>
<li>å•è·¯é—®é¢˜ï¼šåœ¨å•è·¯æ’åºä¸­ï¼Œè¦å ç”¨å¾ˆå¤šç©ºé—´ï¼Œå› ä¸ºéœ€è¦æŠŠæ‰€æœ‰å­—æ®µéƒ½å–å‡ºï¼Œæ‰€ä»¥æœ‰å¯èƒ½å–å‡ºçš„æ•°æ®çš„æ€»å¤§å°è¶…å‡ºäº†sort_bufferçš„å®¹é‡ï¼Œå¯¼è‡´æ¯æ¬¡åªèƒ½å–sort_bufferå®¹é‡å¤§å°çš„æ•°æ®ï¼Œè¿›è¡Œæ’åºï¼ˆåˆ›å»ºtmpæ–‡ä»¶ï¼Œå¤šè·¯åˆå¹¶ï¼‰ï¼Œæ’å®Œå†å–sort_bufferå®¹é‡å¤§å°ï¼Œå†æ’ï¼Œä»è€Œå¯¼è‡´å¤šæ¬¡I/Oã€‚</li>
<li>ä¼˜åŒ–ç­–ç•¥ï¼šSQLæœåŠ¡å™¨å‚æ•°è°ƒä¼˜ï¼Œå¢å¤§sort_buffer_sizeå‚æ•°çš„è®¾ç½®ï¼Œå¢å¤§max_length_for_sort_dataå‚æ•°çš„è®¾ç½®ã€‚</li>
</ul>
<p>æé«˜Order Byçš„é€Ÿåº¦ï¼š</p>
<p>ï¼ˆ1ï¼‰Order Byæ—¶select *æ˜¯ä¸€ä¸ªå¤§å¿Œï¼ŒåªæŸ¥è¯¢éœ€è¦å­—æ®µï¼Œè¿™ç‚¹éå¸¸é‡è¦ã€‚</p>
<p>ï¼ˆ2ï¼‰å°è¯•æé«˜sort_buffer_sizeã€‚</p>
<p>ï¼ˆ3ï¼‰å°è¯•æé«˜max_length_for_sort_dataã€‚</p>
<blockquote>
<p>æ’åºæ¡ˆä¾‹</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">index a_b_c(a, b, c);</span><br><span class="line"></span><br><span class="line">-- ä½¿ç”¨ç´¢å¼•æœ€å·¦å‰ç¼€</span><br><span class="line">ORDER BY a</span><br><span class="line">ORDER BY a, b</span><br><span class="line">ORDER BY a, b, c</span><br><span class="line">ORDER BY a DESC, b DESC, c DESC</span><br><span class="line"></span><br><span class="line">-- WHEREä½¿ç”¨ç´¢å¼•çš„æœ€å·¦å‰ç¼€å®šä¹‰ä¸ºå¸¸é‡</span><br><span class="line">WHERE a &#x3D; const ORDER BY b, c</span><br><span class="line">WHERE a &#x3D; const AND b &#x3D; const ORDER BY c</span><br><span class="line">WHERE a &#x3D; const ORDER BY b, c</span><br><span class="line">WHERE a &#x3D; count AND b &gt; const ORDER BY b, c</span><br><span class="line"></span><br><span class="line">-- ä¸èƒ½ä½¿ç”¨æˆ·ç´¢å¼•è¿›è¡Œæ’åº</span><br><span class="line">ORDER BY a ASC, b DESC, c DESC  -- æ’åºä¸ä¸€è‡´</span><br><span class="line">WHERE g &#x3D; const ORDER BY b, c   -- ä¸¢å¤±aç´¢å¼•</span><br><span class="line">WHERE a &#x3D; const ORDER BY  c     -- ä¸¢å¤±bç´¢å¼•</span><br><span class="line">WHERE a &#x3D; const ORDER BY a, d   -- dä¸æ˜¯ç´¢å¼•çš„ä¸€éƒ¨åˆ†</span><br><span class="line">WHERE a IN (...) ORDER BY b, c  -- å¯¹äºæ’åºæ¥è¯´ï¼Œå¤šä¸ªç›¸ç­‰æ¡ä»¶ä¹Ÿæ˜¯èŒƒå›´æŸ¥è¯¢</span><br></pre></td></tr></table></figure>



<h3 id="æŸ¥è¯¢ä¼˜åŒ–-3"><a href="#æŸ¥è¯¢ä¼˜åŒ–-3" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–-3"></a>æŸ¥è¯¢ä¼˜åŒ–-3</h3><blockquote>
<p>ä¼˜åŒ–ç­–ç•¥</p>
</blockquote>
<p>Group Byå…³é”®å­—ä¼˜åŒ–ï¼š</p>
<p>ä¼˜åŒ–ç­–ç•¥ä¸Order Byç›¸ä¼¼ã€‚</p>
<p>Group Byå®è´¨æ˜¯å…ˆæ’åºåè¿›è¡Œåˆ†ç»„ï¼Œéµç…§ç´¢å¼•å»ºçš„æœ€ä½³å·¦å‰ç¼€ã€‚</p>
<p>å½“æ— æ³•ä½¿ç”¨ç´¢å¼•åˆ—ï¼Œå¢å¤§max_length_for_sort_dataå‚æ•°è®¾ç½®ï¼Œå¢å¤§sort_buffer_sizeå‚æ•°çš„è®¾ç½®ã€‚</p>
<p>whereé«˜äºhavingï¼Œèƒ½å¸è½½whereé™å®šçš„æ¡ä»¶å°±ä¸è¦å»havingé™å®šäº†ã€‚</p>
<h3 id="æ…¢æŸ¥è¯¢æ—¥å¿—"><a href="#æ…¢æŸ¥è¯¢æ—¥å¿—" class="headerlink" title="æ…¢æŸ¥è¯¢æ—¥å¿—"></a>æ…¢æŸ¥è¯¢æ—¥å¿—</h3><blockquote>
<p>ç®€ä»‹</p>
</blockquote>
<ul>
<li><p>MySQLçš„æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯MySQLæä¾›çš„ä¸€ç§æ—¥å¿—è®°å½•ï¼Œå®ƒç”¨æ¥è®°å½•åœ¨MySQLä¸­å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼çš„è¯­å¥ï¼Œå…·ä½“æŒ‡è¿è¡Œæ—¶é—´è¶…è¿‡long_query_timeå€¼çš„SQLï¼Œåˆ™ä¼šè¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ã€‚</p>
</li>
<li><p>å…·ä½“æŒ‡è¿è¡Œæ—¶é—´è¶…è¿‡long_query_timeå€¼çš„SQLï¼Œåˆ™ä¼šè¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ã€‚long_query_timeçš„é»˜è®¤å€¼ä¸º10ï¼Œæ„æ€æ˜¯è¿è¡Œ10ç§’ä»¥ä¸Šçš„è¯­å¥ã€‚</p>
</li>
<li><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQLæ•°æ®åº“æ²¡æœ‰å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ¥è®¾ç½®è¿™ä¸ªå‚æ•°ã€‚</p>
</li>
<li><p>å½“ç„¶ï¼Œå¦‚æœä¸æ˜¯è°ƒä¼˜éœ€è¦çš„è¯ï¼Œä¸€èˆ¬ä¸å»ºè®®å¯åŠ¨è¯¥å‚æ•°ï¼Œå› ä¸ºå¼€å¯æ¼«é•¿å“ˆè®¯æ—¥å¿—ä¼šæˆ–å¤šæˆ–å°‘å¸¦æ¥ä¸€å®šçš„æ€§èƒ½å½±å“ã€‚æ…¢æŸ¥è¯¢æ—¥å¿—æ”¯æŒå°†æ—¥å¿—è®°å½•å†™å…¥æ–‡ä»¶ã€‚</p>
</li>
</ul>
<blockquote>
<p>é…ç½®</p>
</blockquote>
<p>æŸ¥çœ‹æ˜¯å¦å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å’Œæ–‡ä»¶ä½ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &#39;%SLOW_QUERY_LOG%&#39;;</span><br><span class="line">+---------------------+-------------------------------+</span><br><span class="line">| Variable_name       | Value                         |</span><br><span class="line">+---------------------+-------------------------------+</span><br><span class="line">| slow_query_log      | OFF                           |</span><br><span class="line">| slow_query_log_file | &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;parak-slow.log |</span><br><span class="line">+---------------------+-------------------------------+</span><br></pre></td></tr></table></figure>

<p>å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆåªå¯¹æœ¬æ¬¡ç”Ÿæ•ˆï¼Œé‡å¯åå¤±æ•ˆï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET global slow_query_log &#x3D; 1;</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º10sï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &#39;long_query_time%&#39;;</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| Variable_name   | Value     |</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| long_query_time | 10.000000 |</span><br><span class="line">+-----------------+-----------+</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆ3sï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET global long_query_time &#x3D; 3;</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹æ…¢æŸ¥è¯¢è®°å½•æ•°é‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW global STATUS LIKE &#39;%SLOW_QUERIES%&#39;;</span><br></pre></td></tr></table></figure>

<p>æ°¸ä¹…ç”Ÿæ•ˆéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/my.cnfï¼Œéœ€è¦åœ¨[mysqld]ä¸‹å¢åŠ æˆ–ä¿®æ”¹å‚æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">slow_query_log &#x3D; 1</span><br><span class="line">slow_query_log_file &#x3D; &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;&lt;hostname&gt;-slow.log</span><br><span class="line">long_query_time  &#x3D; &lt;time&gt;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>mysqldumpslow</p>
</blockquote>
<p>å‚æ•°ï¼š</p>
<ul>
<li>sï¼šè¡¨ç¤ºæŒ‰ç…§ä½•ç§æ–¹å¼æ’åº</li>
<li>cï¼šè®¿é—®æ¬¡æ•°</li>
<li>lï¼šé”å®šæ—¶é—´</li>
<li>rï¼šè¿”å›è®°å½•</li>
<li>tï¼šæŸ¥è¯¢æ—¶é—´</li>
<li>alï¼šå¹³å‡é”å®šæ—¶é—´</li>
<li>arï¼šå¹³å‡è¿”å›è®°å½•æ•°é‡</li>
<li>atï¼šå¹³å‡æŸ¥è¯¢æ—¶é—´</li>
<li>tï¼šè¿”å›æ•°æ®æ•°é‡</li>
<li>gï¼šæ­£åˆ™åŒ¹é…ï¼Œå¤§å°å†™ä¸æ•æ„Ÿ</li>
</ul>
<p>å¾—åˆ°è¿”å›è®°å½•æœ€å¤šçš„10ä¸ªSQLï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldumpslow -s r -t 10 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;parak-slow.log</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°è®¿é—®æ¬¡æ•°æœ€å¤šçš„10ä¸ªSQLï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldumpslow -s c -t 10 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;parak-slow.log</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°æŒ‰ç…§æ—¶é—´æ’åºçš„å‰10æ¡é‡Œé¢å«æœ‰å·¦è¿æ¥çš„æŸ¥è¯¢è¯­å¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldumpslow -s t -t 10 -g &quot;left join&quot; &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;parak-slow.log</span><br></pre></td></tr></table></figure>

<p>å»ºè®®åœ¨ä½¿ç”¨è¿™äº›å‘½ä»¤æ—¶ç»“åˆ | å’Œ moreä½¿ç”¨ï¼Œé˜²æ­¢çˆ†å±ã€‚</p>
<h3 id="æ‰¹é‡æ•°æ®è„šæœ¬"><a href="#æ‰¹é‡æ•°æ®è„šæœ¬" class="headerlink" title="æ‰¹é‡æ•°æ®è„šæœ¬"></a>æ‰¹é‡æ•°æ®è„šæœ¬</h3><blockquote>
<p>é…ç½®</p>
</blockquote>
<p>å˜é‡<code>log_bin_trust_function_creators</code>ï¼šæ§åˆ¶æ˜¯å¦å¯ä»¥ä¿¡ä»»å­˜å‚¨å‡½æ•°åˆ›å»ºè€…ï¼Œä¸ä¼šåˆ›å»ºå†™å…¥äºŒè¿›åˆ¶æ—¥å¿—å¼•èµ·ä¸å®‰å…¨äº‹ä»¶çš„å­˜å‚¨å‡½æ•°ã€‚</p>
<p>æŸ¥çœ‹æ˜¯å¦å¼€å¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &#39;log_bin_trust_function_creators&#39;;</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+---------------------------------+-------+</span><br><span class="line">| log_bin_trust_function_creators | OFF   |</span><br><span class="line">+---------------------------------+-------+</span><br></pre></td></tr></table></figure>

<p>å¼€å¯ï¼ˆæš‚æ—¶æ€§å¼€å¯ï¼Œæ°¸ä¹…æ€§ä¾ç„¶æ˜¯ä¿®æ”¹my.cnfï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET global log_bin_trust_function_creators &#x3D; 1;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æ•°æ®å‡†å¤‡</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;tb6_dept&#96; (</span><br><span class="line">  &#96;id&#96; int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;deptno&#96; mediumint NOT NULL DEFAULT &#39;0&#39;,</span><br><span class="line">  &#96;dname&#96; varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,</span><br><span class="line">  &#96;loc&#96; varchar(13) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;tb6_emp&#96; (</span><br><span class="line">  &#96;id&#96; int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;empno&#96; mediumint NOT NULL DEFAULT &#39;0&#39;,</span><br><span class="line">  &#96;ename&#96; varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,</span><br><span class="line">  &#96;job&#96; varchar(9) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,</span><br><span class="line">  &#96;mgr&#96; mediumint NOT NULL DEFAULT &#39;0&#39;,</span><br><span class="line">  &#96;hiredate&#96; date NOT NULL,</span><br><span class="line">  &#96;sal&#96; decimal(7,2) NOT NULL,</span><br><span class="line">  &#96;comm&#96; decimal(7,2) DEFAULT NULL,</span><br><span class="line">  &#96;deptno&#96; mediumint NOT NULL DEFAULT &#39;0&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4 COLLATE&#x3D;utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>åˆ›å»ºå‡½æ•°</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># éšæœºäº§ç”Ÿå­—ç¬¦ä¸²</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE FUNCTION rand_string(n INT) RETURNS VARCHAR(255)</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE chars_str VARCHAR(100) DEFAULT &#39;abcdefghijklmnopqrstuvwsyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;;</span><br><span class="line">    DECLARE return_str VARCHAR(255) DEFAULT &#39;&#39;;</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    WHILE i &lt; n DO</span><br><span class="line">    SET return_str &#x3D; CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));</span><br><span class="line">    SET i &#x3D; i + 1;</span><br><span class="line">    END WHILE;</span><br><span class="line">    RETURN return_str;</span><br><span class="line">END $$</span><br><span class="line"></span><br><span class="line"># éšæœºäº§ç”Ÿéƒ¨é—¨ç¼–å·</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE FUNCTION rand_num() RETURNS INT(5)</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET i &#x3D; FLOOR(100 + RAND() * 10);</span><br><span class="line">    RETURN i;</span><br><span class="line">END $$</span><br></pre></td></tr></table></figure>



<blockquote>
<p>åˆ›å»ºå­˜å‚¨è¿‡ç¨‹</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># å‘tb6_deptè¡¨æ‰¹é‡æ’å…¥</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE insert_dept(IN START INT(10),IN max_num INT(10))</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET autocommit &#x3D; 0;</span><br><span class="line">    REPEAT</span><br><span class="line">    SET i &#x3D; i + 1;</span><br><span class="line">    INSERT INTO dept(deptno,dname,loc) VALUES((START + i),rand_string(10),rand_string(8));</span><br><span class="line">    UNTIL i &#x3D; max_num</span><br><span class="line">    END REPEAT;</span><br><span class="line">    COMMIT;</span><br><span class="line">END $$</span><br><span class="line"></span><br><span class="line"># å‘tb6_empè¡¨æ‰¹é‡æ’å…¥</span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE PROCEDURE insert_emp(IN START INT(10),IN max_num INT(10))</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET autocommit &#x3D; 0;</span><br><span class="line">    REPEAT</span><br><span class="line">    SET i &#x3D; i + 1;</span><br><span class="line">    INSERT INTO emp(empno,ename,job,mgr,hiredata,sal,comm,deptno) VALUES((START + i),rand_string(6),&#39;SALESMAN&#39;,0001,CURDATE(),2000,400,rand_num());</span><br><span class="line">    UNTIL i &#x3D; max_num</span><br><span class="line">    END REPEAT;</span><br><span class="line">    COMMIT;</span><br><span class="line">END $$</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æ‰¹é‡æ’å…¥æ•°æ®</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># å‘tb6_deptä¸­æ’å…¥10æ¡æ•°æ®</span><br><span class="line">DELIMITER ;</span><br><span class="line">CALL insert_dept(100, 10);</span><br><span class="line"></span><br><span class="line"># å‘tb6_empä¸­æ’å…¥50ä¸‡æ¡æ•°æ®</span><br><span class="line">DELIMITER ;</span><br><span class="line">CALL insert_emp(100001, 500000);</span><br></pre></td></tr></table></figure>



<h3 id="Show-Profile"><a href="#Show-Profile" class="headerlink" title="Show Profile"></a>Show Profile</h3><blockquote>
<p>æ¦‚è¿°</p>
</blockquote>
<p>MySQLæä¾›çš„å¯ä»¥ç”¨æ¥åˆ†æå½“å‰ä¼šè¯ä¸­è¯­å¥æ‰§è¡Œçš„èµ„æºæ¶ˆè€—æƒ…å†µï¼Œå¯ä»¥ç”¨äºSQLè°ƒä¼˜çš„æµ‹é‡ã€‚</p>
<p>å®˜ç½‘ï¼š<a href="https://dev.mysql.com/doc/refman/8.0/en/show-profile.html">https://dev.mysql.com/doc/refman/8.0/en/show-profile.html</a></p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå‚æ•°å¤„äºå…³é—­çŠ¶æ€ï¼Œå¹¶ä¿å­˜æœ€è¿‘15æ¬¡çš„è¿è¡Œç»“æœã€‚</p>
<blockquote>
<p>é…ç½®</p>
</blockquote>
<p>æŸ¥çœ‹å¼€å¯çŠ¶æ€ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &#39;profiling&#39;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| profiling     | OFF   |</span><br><span class="line">+---------------+-------+</span><br></pre></td></tr></table></figure>

<p>å¼€å¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET global profiling &#x3D; 1;</span><br></pre></td></tr></table></figure>

<p>MySQL8éœ€è¦å…³é—­ä¾èµ–æ£€æµ‹ï¼Œå³ä»sql_modeä¸­ç§»é™¤<code>ONLY_FULL_GROUP_BY</code>ï¼š</p>
<p>æŸ¥çœ‹sql_modeï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT @@global.sql_mode;</span><br><span class="line">+-----------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| @@global.sql_mode                                                                                                     |</span><br><span class="line">+-----------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+-----------------------------------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>ç§»é™¤<code>ONLY_FULL_GROUP_BY</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET global @@sql_mode &#x3D; &#96;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION&#96;;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ç›¸å…³å‘½ä»¤</p>
</blockquote>
<p>æŸ¥çœ‹SQLï¼š<code>SHOW PROFILES</code></p>
<p>è¯Šæ–­SQLï¼š<code>SHOW PROFILE &lt;type ...&gt; FOR QUERY &lt;Query_ID&gt;</code></p>
<p>å¯é€‰å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">| ALL                -- æ˜¾ç¤ºæ‰€æœ‰çš„å¼€é”€ä¿¡æ¯</span><br><span class="line">| BLOCK IO           -- æ˜¾ç¤ºå—IOç›¸å…³å¼€é”€</span><br><span class="line">| CONTEXT SWITCHES   -- ä¸Šä¸‹æ–‡åˆ‡æ¢ç›¸å…³å¼€é”€</span><br><span class="line">| CPU                -- æ˜¾ç¤ºCPUç›¸å…³å¼€é”€ä¿¡æ¯</span><br><span class="line">| IPC                -- æ˜¾ç¤ºå†…å­˜ç›¸å…³å¼€é”€ä¿¡æ¯</span><br><span class="line">| MEMORY             -- æ˜¾ç¤ºå†…å­˜ç›¸å…³å¼€é”€ä¿¡æ¯</span><br><span class="line">| PAGE FAULTS        -- æ˜¾ç¤ºé¡µé¢é”™è¯¯ç›¸å…³å¼€é”€ä¿¡æ¯</span><br><span class="line">| SOURCE             -- æ˜¾ç¤ºå’ŒSource_function, Source_file, Source_lineç›¸å…³çš„å¼€é”€ä¿¡æ¯</span><br><span class="line">| SWAPS              -- æ˜¾ç¤ºäº¤æ¢æ¬¡æ•°ç›¸å…³å¼€é”€çš„ä¿¡æ¯</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æ—¥å¸¸å¼€å‘éœ€è¦æ³¨æ„</p>
</blockquote>
<ul>
<li>converting HEAP to MyISAM æŸ¥è¯¢ç»“æœå¤ªå¤§ï¼Œå†…å­˜éƒ½ä¸å¤Ÿç”¨äº†ç‹ç£ç›˜ä¸Šæ¬äº†</li>
<li>Creating tmp table æ‹·è´æ•°æ®åˆ°ä¸´æ—¶è¡¨ï¼Œç”¨å®Œå†åˆ é™¤</li>
<li>Copying to tmp table on disk å§å†…å­˜ä¸­ä¸´æ—¶è¡¨å¤åˆ¶åˆ°ç£ç›˜ï¼Œå±é™©</li>
<li>locked æ­»é”</li>
</ul>
<h3 id="å…¨å±€æŸ¥è¯¢æ—¥å¿—"><a href="#å…¨å±€æŸ¥è¯¢æ—¥å¿—" class="headerlink" title="å…¨å±€æŸ¥è¯¢æ—¥å¿—"></a>å…¨å±€æŸ¥è¯¢æ—¥å¿—</h3><blockquote>
<p>æ°¸ä¹…å¯ç”¨</p>
</blockquote>
<p>ä¿®æ”¹my.cnfï¼Œè®¾ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># å¼€å¯</span><br><span class="line">general_log &#x3D; 1</span><br><span class="line"># è®°å½•æ—¥å¿—æ–‡ä»¶çš„è·¯å¾„</span><br><span class="line">general_log_file &#x3D; &#x2F;&lt;path&gt;&#x2F;&lt;name&gt;</span><br><span class="line"># è¾“å‡ºæ ¼å¼</span><br><span class="line">log_output &#x3D; &lt;.extension&gt;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ä¸´æ—¶å¯ç”¨</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set global general_log &#x3D; 1;</span><br><span class="line">set global log_output &#x3D; &#39;TABLE&#39;;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æ³¨æ„</p>
</blockquote>
<p>æ°¸è¿œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒå¼€å¯è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<h2 id="é”æœºåˆ¶"><a href="#é”æœºåˆ¶" class="headerlink" title="é”æœºåˆ¶"></a>é”æœºåˆ¶</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><blockquote>
<p>å‰è¨€</p>
</blockquote>
<p>é”æ˜¯è®¡ç®—æœºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¹¶å‘è®¿é—®æŸä¸€èµ„æºçš„æœºåˆ¶ã€‚</p>
<p>åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤ä¼ ç»Ÿçš„è®¡ç®—èµ„æºï¼ˆå¦‚CPUã€RAMã€I/Oç­‰ï¼‰çš„äº‰ç”¨ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¸€ç§ä¾›è®¸å¤šç”¨æˆ·å…±äº«çš„èµ„æºã€‚å¦‚ä½•ä¿è¯æ•°æ®å¹¶å‘è®¿é—®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§æ˜¯æ‰€æœ‰æ•°æ®åº“å¿…é¡»è§£å†³çš„ä¸€ä¸ªé—®é¢˜ï¼Œé”å†²çªä¹Ÿæ˜¯å½±å“æ•°æ®åº“å¹¶å‘è®¿é—®æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œé”å¯¹æ•°æ®åº“è€Œè¨€æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚</p>
<blockquote>
<p>åˆ†ç±»</p>
</blockquote>
<p>ä»å¯¹æ•°æ®æ“ä½œçš„ç±»å‹åˆ†ï¼š</p>
<ul>
<li>è¯»é”ï¼ˆå…±äº«é”ï¼‰ï¼šé’ˆå¯¹åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªè¯»æ“ä½œå¯ä»¥åŒæ—¶è¿›è¡Œè€Œä¸ä¼šç›¸äº’å½±å“ã€‚</li>
<li>å†™é”ï¼ˆæ’ä»–é”ï¼‰ï¼šå½“å‰å†™æ“ä½œæ²¡æœ‰å®Œæˆä¹‹å‰ï¼Œå®ƒä¼šé˜»æ–­å…¶ä»–å†™é”å’Œè¯»é”ã€‚</li>
</ul>
<p>ä»å¯¹æ•°æ®æ“ä½œçš„ç²’åº¦åˆ†ï¼š</p>
<ul>
<li>è¡Œçº§é”ï¼šå¯¹å½“å‰æ“ä½œçš„è¡ŒåŠ é”ã€‚ï¼ˆå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦æœ€é«˜ï¼‰</li>
<li>è¡¨çº§é”ï¼šå¯¹å½“å‰æ“ä½œçš„è¡¨åŠ é”ã€‚ï¼ˆå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘å‡ºé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ï¼‰</li>
<li>é¡µçº§é”ï¼šä»‹äºè¡Œçº§é”å’Œè¡¨çº§é”ä¸­é—´çš„ä¸€ç§é”ã€‚ï¼ˆå¼€é”€å’ŒåŠ é”æ—¶é—´ä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œä¼šå‡ºç°æ­»é”ï¼›å¹¶å‘åº¦ä¸€èˆ¬ï¼‰</li>
</ul>
<h3 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h3><blockquote>
<p>æ¦‚è¿°</p>
</blockquote>
<p>äº‹åŠ¡æ˜¯ç”±ä¸€ç»„SQLè¯­å¥ç»„æˆçš„é€»è¾‘å¤„ç†å•å…ƒï¼Œäº‹åŠ¡å…·æœ‰ä»¥ä¸‹4ä¸ªå±æ€§ï¼Œé€šå¸¸ç®€ç§°ä¸ºäº‹åŠ¡çš„ACIDå±æ€§ã€‚</p>
<ul>
<li><p>A(atomicity/åŸå­æ€§)ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œå•å…ƒï¼Œå…¶å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œè¦ä¹ˆå…¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚</p>
</li>
<li><p>C(consistency/ä¸€è‡´æ€§)ï¼šåœ¨äº‹åŠ¡å¼€å§‹å’Œå®Œæˆæ—¶ï¼Œæ•°æ®éƒ½å¿…é¡»ä¿æŒä¸€è‡´çŠ¶æ€ã€‚è¿™æ„å‘³ç€æ‰€æœ‰ç›¸å…³çš„æ•°æ®è§„åˆ™éƒ½å¿…é¡»åº”ç”¨äºäº‹åŠ¡çš„ä¿®æ”¹ï¼Œä»¥ä¿æŒæ•°æ®çš„å®Œæ•´æ€§ï¼›äº‹åŠ¡ç»“æŸæ—¶ï¼Œæ‰€æœ‰çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼ˆå¦‚Bæ ‘ç´¢å¼•æˆ–åŒå‘é“¾è¡¨ï¼‰ä¹Ÿéƒ½å¿…é¡»æ˜¯æ­£ç¡®çš„ã€‚</p>
</li>
<li><p>I(isolation/éš”ç¦»æ€§)ï¼šæ•°æ®åº“ç³»ç»Ÿæä¾›ä¸€å®šçš„éš”ç¦»æœºåˆ¶ï¼Œä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„â€œç‹¬ç«‹â€ç¯å¢ƒæ‰§è¡Œã€‚è¿™æ„å‘³ç€äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€å¯¹å¤–éƒ¨æ˜¯ä¸å¯è§çš„ï¼Œåä¹‹äº¦ç„¶ã€‚</p>
</li>
<li><p>D(durability/æŒä¹…æ€§)ï¼šäº‹åŠ¡å®Œæˆä¹‹åï¼Œå®ƒå¯¹äºæ•°æ®çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³æ—¶å‡ºç°ç³»ç»Ÿæ•…éšœä¹Ÿèƒ½å¤Ÿä¿æŒã€‚</p>
</li>
</ul>
<blockquote>
<p>å¹¶å‘äº‹åŠ¡å¤„ç†å¸¦æ¥çš„é—®é¢˜</p>
</blockquote>
<p><strong>æ›´æ–°ä¸¢å¤±ï¼ˆLost Updateï¼‰</strong></p>
<p>å½“ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡é€‰æ‹©åŒä¸€è¡Œï¼Œç„¶ååŸºäºæœ€åˆé€‰å®šçš„å€¼æ›´æ–°è¯¥è¡Œæ—¶ï¼Œç”±äºæ¯ä¸ªäº‹åŠ¡éƒ½ä¸çŸ¥é“å…¶ä»–äº‹åŠ¡çš„å­˜åœ¨ï¼Œå°±ä¼šå‘ç”Ÿä¸¢å¤±æ›´æ–°é—®é¢˜â€”â€”æœ€åçš„æ›´æ–°è¦†ç›–äº†ç”±å…¶ä»–äº‹åŠ¡æ‰€åšçš„æ›´æ–°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸¤ä¸ªç¨‹åºå‘˜ä¿®æ”¹åŒä¸€Javaæ–‡ä»¶ã€‚æ¯ç¨‹åºå‘˜ç‹¬ç«‹åœ°æ›´æ”¹å…¶å‰¯æœ¬ï¼Œç„¶åä¿å­˜æ›´æ”¹çš„å‰¯æœ¬åï¼Œè¿™æ ·å°±è¦†ç›–äº†åŸå§‹æ–‡æ¡£ã€‚æœ€åä¿å­˜å…¶æ›´æ”¹å‰¯æœ¬çš„ç¼–è¾‘äººå‘˜è¦†ç›–å‰ä¸€ä¸ªç¨‹åºå‘˜æ‰€åšçš„æ›´æ”¹ã€‚</p>
<p>å¦‚æœä¸€ä¸ªåœ¨ä¸€ä¸ªç¨‹åºå‘˜å®Œæˆå¹¶æäº¤äº‹åŠ¡ä¹‹å‰ï¼Œå¦ä¸€ä¸ªç¨‹åºå‘˜ä¸èƒ½è®¿é—®åŒä¸€æ–‡ä»¶ï¼Œåˆ™å¯é¿å…æ­¤é—®é¢˜ã€‚</p>
<p><strong>è„è¯»ï¼ˆDirty Readsï¼‰</strong></p>
<p>ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å¯¹ä¸€æ¡è®°å½•åšä¿®æ”¹ï¼Œåœ¨è¿™ä¸ªäº‹åŠ¡å®Œæˆå¹¶æäº¤å‰ï¼Œè¿™æ¡è®°å½•çš„æ•°æ®å°±å¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼›è¿™æ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿæ¥è¯»å–åŒä¸€æ¡è®°å½•ï¼Œå¦‚æœä¸åŠ æ§åˆ¶ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡è¯»å–äº†è¿™äº›â€œè„â€æ•°æ®ï¼Œå¹¶æ®æ­¤åšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œå°±ä¼šäº§ç”Ÿæœªæäº¤çš„æ•°æ®ä¾èµ–å…³ç³»ã€‚è¿™ç§ç°è±¡è¢«å½¢è±¡åœ°å«åšâ€œè„è¯»â€ã€‚</p>
<p>äº‹åŠ¡Aè¯»å–åˆ°äº‹åŠ¡Bå·²ä¿®æ”¹ä½†æœªæäº¤çš„æ•°æ®ï¼Œè¿˜åœ¨è¿™ä¸ªæ•°æ®åŸºç¡€ä¸Šåšäº†æ“ä½œã€‚æ­¤æ—¶ï¼Œå¦‚æœBäº‹åŠ¡å›æ»šï¼ŒAè¯»å–çš„æ•°æ®æ— æ•ˆï¼Œä¸ç¬¦åˆä¸€è‡´æ€§è¦æ±‚ã€‚</p>
<p><strong>ä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readsï¼‰</strong></p>
<p>ä¸€ä¸ªäº‹åŠ¡åœ¨æœåŠ¡æŸäº›æ•°æ®åçš„æŸä¸ªæ—¶é—´ï¼Œå†æ¬¡è¯»å–ä»¥å‰è¯»è¿‡çš„æ•°æ®ï¼Œå´å‘ç°å…¶è¯»å‡ºçš„æ•°æ®å·²ç»å‘ç”Ÿäº†æ”¹å˜ã€æˆ–æŸäº›è®°å½•å·²ç»è¢«åˆ é™¤ï¼Œè¿™ç§ç°è±¡å°±å«åšä¸å¯é‡å¤è¯»ã€‚</p>
<p>äº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bå·²ç»æäº¤çš„ä¿®æ”¹æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ã€‚</p>
<p><strong>å¹»è¯»ï¼ˆPhantom Readsï¼‰</strong></p>
<p>ä¸€ä¸ªäº‹åŠ¡æŒ‰ç›¸åŒçš„æŸ¥è¯¢æ¡ä»¶é‡æ–°è¯»å–ä»¥å‰æ£€ç´¢è¿‡çš„æ•°æ®ï¼Œå´å‘ç°å…¶ä»–äº‹åŠ¡æ’å…¥äº†æ»¡è¶³å…¶æŸ¥è¯¢æ¡ä»¶çš„æ–°æ•°æ®ï¼Œè¿™ç§ç°è±¡å°±ç§°ä¸ºâ€œå¹»è¯»â€ã€‚</p>
<p>äº‹åŠ¡Aè¯»å–åˆ°äº‹åŠ¡Bæäº¤çš„æ–°å¢æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ã€‚</p>
<blockquote>
<p>äº‹åŠ¡éš”ç¦»çº§åˆ«</p>
</blockquote>
<p>â€œè„è¯»â€ã€â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€ï¼Œå…¶å®éƒ½æ˜¯æ•°æ®åº“è¯»ä¸€è‡´æ€§é—®é¢˜ï¼Œå¿…é¡»ç”±æ•°æ®åº“æä¾›ä¸€å®šçš„ä¹¦å±‹éš”ç¦»çº§åˆ«æ¥è§£å†³ã€‚</p>
<p>æ•°æ®åº“å®ç°äº‹åŠ¡éš”ç¦»çš„æ–¹å¼ï¼ŒåŸºæœ¬ä¸Šå¯åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š</p>
<ul>
<li>ä¸€ç§æ˜¯åœ¨è¯»å–æ•°æ®å‰ï¼Œå¯¹å…¶åŠ é”ï¼Œé˜»æ­¢å…¶ä»–äº‹ç‰©å¯¹æ•°æ®ä¿®æ”¹ã€‚</li>
<li>å¦ä¸€ç§æ˜¯ä¸ç”¨åŠ ä»»ä½•é”ï¼Œé€šè¿‡ä¸€å®šæœºåˆ¶ç”Ÿæˆä¸€ä¸ªæ•°æ®è¯·æ±‚æ—¶é—´ç‚¹çš„ä¸€è‡´æ€§æ•°æ®å¿«ç…§ï¼ˆSnapshotï¼‰ï¼Œå¹¶ç”¨è¿™ä¸ªå¿«ç…§æ¥æä¾›ä¸€å®šçº§åˆ«ï¼ˆè¯­å¥çº§æˆ–äº‹åŠ¡çº§ï¼‰çš„ä¸€è‡´æ€§è¯»å–ã€‚åŒç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œå¥½åƒæ˜¯æ•°æ®åº“å¯ä»¥æä¾›ç»Ÿä¸€æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œå› æ­¤ï¼Œè¿™ç§æŠ€æœ¯å«æ•°æ®å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMultiVersion Concurrency Controlï¼Œç®€ç§°MVCCæˆ–MCCï¼‰ï¼Œä¹Ÿç»å¸¸ç§°ä¸ºå¤šç‰ˆæœ¬æ•°æ®åº“ã€‚</li>
</ul>
<p>ä¸ºäº†è§£å†³â€œéš”ç¦»â€ä¸â€œå¹¶å‘â€çš„çŸ›ç›¾ï¼ŒISO/ANSI SQL92å®šä¹‰äº†4ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œæ¯ä¸ªçº§åˆ«çš„éš”ç¦»ç¨‹åº¦ä¸åŒï¼Œå…è®¸å‡ºç°çš„å‰¯ä½œç”¨ä¹Ÿä¸åŒï¼Œå…è®¸å‡ºç°çš„å‰¯ä½œç”¨ä¹Ÿä¸åŒï¼Œåº”ç”¨å¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘éœ€æ±‚ï¼Œé€šè¿‡é€‰æ‹©ä¸åŒçš„éš”ç¦»çº§åˆ«æ¥å¹³è¡¡â€œéš”ç¦»â€ä¸â€œå¹¶å‘â€çš„çŸ›ç›¾ã€‚</p>
<table>
<thead>
<tr>
<th>è¯»æ•°æ®ä¸€è‡´æ€§åŠå…è®¸çš„å¹¶å‘å‰¯ä½œç”¨éš”ç¦»çº§åˆ«</th>
<th>è¯»æ•°æ®ä¸€è‡´æ€§</th>
<th>è„è¯»</th>
<th>ä¸å¯é‡å¤è¯»</th>
<th>å¹»è¯»</th>
</tr>
</thead>
<tbody><tr>
<td>æœªæäº¤è¯»ï¼ˆRead uncommittedï¼‰</td>
<td>æœ€ä½çº§åˆ«ï¼Œåªèƒ½ä¿è¯ä¸è¯»å–ç‰©ç†ä¸ŠæŸåçš„æ•°æ®</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>å·²æäº¤è¯»ï¼ˆRead committedï¼‰</td>
<td>è¯­å¥çº§</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰</td>
<td>äº‹åŠ¡çº§</td>
<td>å¦</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>å¯åºåˆ—åŒ–ï¼ˆSerializableï¼‰</td>
<td>æœ€é«˜çº§åˆ«ï¼Œäº‹åŠ¡çº§</td>
<td>å¦</td>
<td>å¦</td>
<td>å¦</td>
</tr>
</tbody></table>
<p>æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»è¶Šä¸¥æ ¼ï¼Œå¹¶å‘å‰¯ä½œç”¨è¶Šå°ï¼Œä½†ä»˜å‡ºçš„ä»£ä»·ä¹Ÿç–è¶Šå¤§ï¼Œå› ä¸ºäº‹åŠ¡éš”ç¦»å®è´¨ä¸Šå°±æ˜¯ä½¿äº‹åŠ¡åœ¨ä¸€å®šç¨‹åº¦ä¸Šâ€œä¸²è¡ŒåŒ–â€è¿›è¡Œï¼Œè¿™æ˜¾ç„¶ä¸â€œå¹¶å‘â€æ˜¯çŸ›ç›¾çš„ã€‚åŒæ—¶ï¼Œä¸åŒçš„åº”ç”¨å¯¹è¯»ä¸€è‡´æ€§å’Œäº‹åŠ¡éš”ç¦»ç¨‹åº¦çš„è¦æ±‚ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚è®¸å¤šåº”ç”¨å¯¹â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€å¹¶ä¸æ•æ„Ÿï¼Œå¯èƒ½æ›´å…³å¿ƒæ•°æ®å¹¶å‘è®¿é—®çš„èƒ½åŠ›ã€‚</p>
<blockquote>
<p>é…ç½®</p>
</blockquote>
<p>æŸ¥çœ‹çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆé»˜è®¤ä¸ºå¯é‡å¤è¯»ï¼‰ï¼š<code>SELECT @@transaction_isolation;</code>  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SELECT @@transaction_isolation;</span><br><span class="line">+-------------------------+</span><br><span class="line">| @@transaction_isolation |</span><br><span class="line">+-------------------------+</span><br><span class="line">| REPEATABLE-READ         |</span><br><span class="line">+-------------------------+</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®è¯»æœªæäº¤: <code>SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</code></p>
<p>è®¾ç½®è¯»å·²æäº¤ï¼š<code>SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></p>
<p>è®¾ç½®å¯é‡å¤è¯»ï¼š<code>SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;</code></p>
<p>è®¾ç½®å¯åºåˆ—åŒ–ï¼š<code> SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;</code></p>
<blockquote>
<p>SQLå‘½ä»¤</p>
</blockquote>
<p>äº‹åŠ¡å¼€å§‹ï¼š<code>BEGIN</code> æˆ–è€… <code>START TRANSACTION</code></p>
<p>äº‹åŠ¡ç»“æŸï¼š<code>COMMIT</code>æˆ–è€…<code>COMMIT WORK</code></p>
<p>äº‹åŠ¡å›æ»šï¼š<code>ROLLBACK</code>æˆ–è€…<code>ROLLBACK WORK</code></p>
<h3 id="è¡¨é”"><a href="#è¡¨é”" class="headerlink" title="è¡¨é”"></a>è¡¨é”</h3><blockquote>
<p>ç‰¹ç‚¹</p>
</blockquote>
<p>è¡¨é”ï¼ˆåè¯»ï¼‰ï¼šåå‘MyISAMå­˜å‚¨å¼•æ“ï¼Œå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›æ— æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚</p>
<blockquote>
<p>æ“ä½œ</p>
</blockquote>
<p>æ‰‹åŠ¨å¢åŠ è¡¨é”ï¼š<code>LOCK TABLE &lt;tablename_1&gt; read(write),&lt;tablename_1&gt; read(write) ... </code></p>
<p>æŸ¥çœ‹è¡¨ä¸Šçš„é”ï¼š<code>SHOW OPEN TABLES;</code></p>
<p>è§£é”ï¼š<code>UNLOCK TABLES;</code></p>
<blockquote>
<p>åˆ†æ</p>
</blockquote>
<p>åˆ†æè¡¨é”å®šï¼š<code>SHOW STATUS LIKE &#39;table%&#39;;</code></p>
<p>æœ‰ä¸¤ä¸ªçŠ¶æ€å˜é‡è®°å½•MySQLå†…éƒ¨è¡¨çº§é”å®šçš„æƒ…å†µï¼Œä¸¤ä¸ªå˜é‡è¯´ä¸‹ï¼š</p>
<p><code>Table_locs_immediate</code>ï¼šäº§ç”Ÿè¡¨çº§é”å®šçš„æ¬¡æ•°ï¼Œè¡¨ç¤ºå¯ä»¥ç«‹å³è·å–é”çš„æŸ¥è¯¢æ¬¡æ•°ï¼Œæ¯ç«‹å³è·å–é”å€¼+1;</p>
<p><code>Table_locks_waited</code>ï¼šå‡ºç°è¡¨çº§é”å®šäº‰ç”¨è€Œå‘ç”Ÿç­‰å¾…çš„æ¬¡æ•°ï¼ˆä¸èƒ½ç«‹å³è·å–é”çš„æ¬¡æ•°ï¼Œæ¯ç­‰å¾…ä¸€æ¬¡é”å€¼+1ï¼‰ï¼Œæ­¤å€¼é«˜åˆ™è¯´æ˜å­˜åœ¨ç€æ¯”è¾ƒä¸¥é‡çš„è¡¨çº§é”äº‰ç”¨æƒ…å†µã€‚</p>
<p>æ­¤å¤–ï¼ŒMyISAMçš„è¯»å†™é”è°ƒåº¦æ˜¯å†™ä¼˜å…ˆï¼Œè¿™ä¹Ÿæ˜¯MyISAMä¸é€‚åˆåšå†™ä¸ºä¸»è¡¨çš„å¼•æ“ï¼Œå› ä¸ºå†™é”åï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½åšä»»ä½•æ“ä½œï¼Œå¤§é‡çš„æ›´æ–°ä¼šä½¿æŸ¥è¯¢å¾ˆéš¾å¾—åˆ°é”ï¼Œä»è€Œé€ æˆæ°¸è¿œé˜»å¡ã€‚</p>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<p>å½“å‰çº¿ç¨‹ç»™ä¸€ä¸ªè¡¨åŠ ä¸Šè¯»é”æ—¶ï¼Œå½“å‰çº¿ç¨‹å’Œå…¶ä»–çº¿ç¨‹éƒ½å¯ä»¥è¯»è¿™ä¸ªè¡¨ï¼Œä½†æ˜¯å½“å‰çº¿ç¨‹çº¿ç¨‹è¯»å…¶ä»–è¡¨æ—¶ä¼šæŠ¥é”™ï¼Œå½“å‰çº¿ç¨‹å†™è¯¥è¡¨æ—¶ä¼šæŠ¥é”™ï¼Œå…¶ä»–çº¿ç¨‹å†™è¯¥è¡¨æ—¶ä¼šé˜»å¡ã€‚</p>
<p>å½“å‰çº¿ç¨‹ç»™ä¸€ä¸ªè¡¨åŠ ä¸Šå†™é”æ—¶ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å¯¹è¯¥è¡¨è¿›è¡Œè¯»å’Œå†™æ“ä½œï¼Œä½†æ˜¯å½“å‰çº¿ç¨‹å¯¹å…¶ä»–è¡¨è¿›è¡Œè¯»å’Œå†™æ“ä½œæ—¶ä¼šæŠ¥é”™ï¼Œå…¶ä»–çº¿ç¨‹å¯¹è¯¥è¡¨è¿›è¡Œè¯»å’Œå†™æ—¶ä¼šé˜»å¡ã€‚</p>
<p>è¯»é”é˜»å¡å†™ï¼Œå†™é”éƒ½é˜»å¡ã€‚</p>
<h3 id="è¡Œé”"><a href="#è¡Œé”" class="headerlink" title="è¡Œé”"></a>è¡Œé”</h3><blockquote>
<p>ç‰¹ç‚¹</p>
</blockquote>
<p>è¡Œé”ï¼ˆåå†™ï¼‰ï¼šåå‘InnoDBå­˜å‚¨å¼•æ“ï¼Œå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦ä¹Ÿæœ€é«˜ã€‚</p>
<p>InnoDBä¸MyISAMçš„æœ€å¤§ä¸åŒæœ‰ä¸¤ç‚¹ï¼šä¸€æ˜¯æ”¯æŒäº‹åŠ¡ï¼›äºŒæ˜¯é‡‡ç”¨äº†è¡Œçº§é”ã€‚</p>
<blockquote>
<p>InnoDBè¡Œé”å®ç°æ–¹å¼</p>
</blockquote>
<p>InnoDBè¡Œé”æ˜¯é€šè¿‡ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹åŠ é”æ¥å®ç°çš„ï¼Œè¿™ä¸€ç‚¹MySQLä¸Oracleä¸åŒï¼Œåè€…æ˜¯é€šè¿‡åœ¨æ•°æ®å—ä¸­å¯¹ç›¸åº”æ•°æ®è¡ŒåŠ é”æ¥å®ç°çš„ã€‚InnoDBè¿™ç§è¡Œé”å®ç°ç‰¹ç‚¹æ„å‘³ç€ï¼šåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ¥æ£€ç´¢æ•°æ®ï¼ŒInnoDBæ‰ä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™InnoDBå°†ä½¿ç”¨è¡¨é”ã€‚</p>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<p>å½“å‰çº¿ç¨‹<code>begin</code>ä»¥åå¯¹ä¸€å¼ è¡¨è¿›è¡Œå†™æ“ä½œï¼Œå…¶ä»–çº¿ç¨‹å¯¹è¯¥è¡¨è¿›è¡Œå†™æ“ä½œæ—¶ä¼šé˜»å¡ã€‚å½“å‰çº¿ç¨‹å†™æ“ä½œå®Œæ¯•åä»…å½“å‰çº¿ç¨‹å¯è§ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½è¯»æ›´æ–°ä¹‹å‰çš„æ•°æ®ï¼Œåªæœ‰å½“å‰çº¿ç¨‹<code>commit;</code>ä¹‹åå…¶ä»–çº¿ç¨‹æ‰å¯è¯»æ›´æ–°æ•°æ®ã€‚</p>
<blockquote>
<p>é—´éš™é”</p>
</blockquote>
<p>å½“æˆ‘ä»¬ç”¨èŒƒå›´æ¡ä»¶è€Œä¸æ˜¯ç›¸ç­‰æ¡ä»¶æ£€ç´¢æ•°æ®ï¼Œå¹¶è¯·æ±‚å…±äº«æˆ–æ’ä»–é”æ—¶ï¼ŒInnoDBä¼šç»™ç¬¦åˆæ¡ä»¶çš„å·²æœ‰æ•°æ®è®°å½•çš„ç´¢å¼•é¡¹åŠ é”ï¼›å¯¹äºé”®å€¼åœ¨æ¡ä»¶èŒƒå›´å†…ä½†å¹¶ä¸å­˜åœ¨çš„è®°å½•ï¼Œå«åšé—´éš™ã€‚</p>
<p>InnoDBä¹Ÿä¼šå¯¹è¿™ä¸ªé—´éš™åŠ é”ï¼Œè¿™ç§é”æœºåˆ¶å°±æ˜¯æ‰€è°“çš„é—´éš™é”ã€‚</p>
<p>å±å®³ï¼šå› ä¸ºQueryæ‰§è¡Œè¿‡ç¨‹ä¸­é€šè¿‡èŒƒå›´æŸ¥æ‰¾çš„è¯ï¼Œå®ƒä¼šé”å®šæ•´ä¸ªèŒƒå›´å†…çš„æ‰€æœ‰ç´¢å¼•é”®å€¼ï¼Œå³ä½¿è¿™ä¸ªé”®å€¼å¹¶ä¸å­˜åœ¨ã€‚é—´éš™æ‰€æœ‰ä¸€ä¸ªæ¯”è¾ƒè‡´å‘½çš„å¼±ç‚¹ï¼Œå°±æ˜¯å½“é”å®šä¸€ä¸ªèŒƒå›´é”®å€¼ä¹‹åï¼Œå³æ—¶æŸäº›ä¸å­˜åœ¨çš„é”®å€¼ä¹Ÿä¼šè¢«æ— è¾œçš„é”å®šï¼Œè€Œé€ æˆåœ¨é”å®šçš„æ—¶å€™æ— æ³•æ’å…¥é”å®šé”®å€¼èŒƒå›´å†…çš„ä»»ä½•æ•°æ®ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹è¿™å¯èƒ½ä¼šå¯¹æ€§èƒ½é€ æˆå¾ˆå¤§çš„å±å®³ã€‚</p>
<blockquote>
<p>å¦‚ä½•é”å®šä¸€è¡Œ</p>
</blockquote>
<p><code>SELECT .....FOR UPDATE</code>åœ¨é”å®šæŸä¸€è¡Œåï¼Œå…¶ä»–å†™æ“ä½œä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é”å®šçš„è¡Œè¢«<code>COMMIT</code>ã€‚</p>
<p>ç»“è®ºï¼š</p>
<p>InnoDBå­˜å‚¨å¼•æ“ç”±äºå®ç°äº†è¡Œçº§é”å®šï¼Œè™½ç„¶åœ¨é”å®šæœºåˆ¶çš„å®ç°æ–¹é¢æ‰€å¸¦æ¥çš„æ€§èƒ½æŸè€—å¯èƒ½æ¯”è¡¨çº§é”å®šä¼šè¦æ›´é«˜ä¸€äº›ï¼Œä½†æ˜¯åœ¨æ•´ä½“å¹¶å‘å¤„ç†èƒ½åŠ›æ–¹é¢è¦è¿œè¿œä¼˜äºMyISAMçš„è¡¨çº§é”å®šçš„ã€‚å½“ç³»ç»Ÿå¹¶å‘é‡è¾ƒé«˜çš„æ—¶å€™ï¼ŒInnoDBçš„æ•´ä½“æ€§èƒ½å’ŒMyISAMç›¸æ¯”å°±ä¼šæœ‰æ¯”è¾ƒæ˜æ˜¾çš„ä¼˜åŠ¿äº†ã€‚</p>
<p>ä½†æ˜¯ï¼ŒInnoDBçš„è¡Œçº§é”å®šåŒæ ·æœ‰å…¶è„†å¼±çš„ä¸€é¢ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ä¸å½“çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šè®©InnoDBçš„æ•´ä½“æ€§èƒ½è¡¨ç°ä¸ä»…ä¸èƒ½æ¯”MyISAMé«˜ï¼Œç”šè‡³å¯èƒ½æ›´å·®ã€‚</p>
<blockquote>
<p>åˆ†æè¡Œé”å®š</p>
</blockquote>
<p>é€šè¿‡æ£€æŸ¥InnoDB_row_lockçŠ¶æ€å˜é‡æ¥åˆ†æç³»ç»Ÿä¸Šçš„è¡Œé”çš„äº‰å¤ºæƒ…å†µï¼š<code>SHOW STATUS LIKE &#39;innodb_row_lock;&#39;</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW STATUS LIKE &#39;innodb_row_lock%&#39;;</span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">| Variable_name                 | Value |</span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">| Innodb_row_lock_current_waits | 0     |</span><br><span class="line">| Innodb_row_lock_time          | 38921 |</span><br><span class="line">| Innodb_row_lock_time_avg      | 9730  |</span><br><span class="line">| Innodb_row_lock_time_max      | 14962 |</span><br><span class="line">| Innodb_row_lock_waits         | 4     |</span><br><span class="line">+-------------------------------+-------+</span><br></pre></td></tr></table></figure>

<p>å¯¹å„ä¸ªçŠ¶æ€é‡çš„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>Innodb_row_lock_current_waits</code>ï¼šå½“å‰æ­£åœ¨ç­‰å¾…é”å®šçš„æ•°é‡</li>
<li><code>Innodb_row_lock_time</code>ï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨é”å®šæ€»æ—¶é—´é•¿åº¦</li>
<li><code>Innodb_row_lock_time_avg</code>ï¼šæ¯æ¬¡ç­‰å¾…æ‰€èŠ±å¹³å‡æ—¶é—´</li>
<li><code>Innodb_row_lock_time_max</code>ï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨ç­‰å¾…æœ€é•¿çš„ä¸€æ¬¡æ‰€èŠ±çš„æ—¶é—´</li>
<li><code>Innodb_row_lock_waits</code>ï¼šç³»ç»Ÿå¯åŠ¨ååˆ°ç°åœ¨æ€»å…±ç­‰å¾…çš„æ¬¡æ•°</li>
</ul>
<p>æ³¨æ„waitsé‡‘é¢time_avgæ¯”è¾ƒé«˜çš„ï¼Œå°±è¦åˆ†æç³»ç»Ÿå¹¶åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆã€‚</p>
<blockquote>
<p>ä¼˜åŒ–å»ºè®®</p>
</blockquote>
<ul>
<li>å°½å¯èƒ½è®©æ‰€æœ‰æ•°æ®æ£€ç´¢éƒ½é€šè¿‡ç´¢å¼•æ¥å®Œæˆï¼Œé¿å…æ— ç´¢å¼•è¡Œé”å‡çº§ä¸ºè¡¨é”</li>
<li>åˆç†è®¾è®¡ç´¢å¼•ï¼Œå°½é‡ç¼©å°é”çš„èŒƒå›´</li>
<li>å°½å¯èƒ½å‡å°‘æ£€ç´¢æ¡ä»¶ï¼Œé¿å…é—´éš™é”</li>
<li>å°½é‡æ§åˆ¶äº‹åŠ¡å¤§å°ï¼Œå‡å°‘é”å®šèµ„æºé‡å’Œæ—¶é—´é•¿åº¦</li>
<li>å°½å¯èƒ½ä½çº§åˆ«äº‹åŠ¡éš”ç¦»</li>
</ul>
<h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>MVCCï¼ˆMultiversion concurrency control ï¼‰æ˜¯ä¸€ç§å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æœºåˆ¶ã€‚</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<ul>
<li>æ’å…¥ï¼šæ·»åŠ éšè—ä¸¤åˆ—ï¼Œåˆ›å»ºç‰ˆæœ¬å·(å½“å‰äº‹åŠ¡id)å’Œåˆ é™¤ç‰ˆæœ¬å·(null)</li>
<li>æŸ¥è¯¢ï¼šéœ€è¦æ»¡è¶³æ¡ä»¶ï¼Œåˆ›å»ºç‰ˆæœ¬å· &lt; å½“å‰äº‹åŠ¡id &lt; åˆ é™¤ç‰ˆæœ¬å·</li>
<li>åˆ é™¤ï¼šæ›´æ–°æ•°æ®çš„åˆ é™¤ç‰ˆæœ¬å·ä¸ºå½“å‰äº‹åŠ¡id</li>
<li>æ›´æ–°ï¼šå¤åˆ¶ä¸€ä»½æ•°æ®ï¼Œå…ˆæ‰§è¡Œåˆ é™¤ï¼Œå†æ‰§è¡Œæ’å…¥ï¼Œå°±æ—§æ•°æ®çš„åˆ é™¤ç‰ˆæœ¬å·å’Œæ–°æ•°æ®çš„åˆ›å»ºç‰ˆæœ¬å·éƒ½è®¾ç½®ä¸ºå½“å‰äº‹åŠ¡id</li>
</ul>
<h2 id="ä¸»ä»å¤åˆ¶"><a href="#ä¸»ä»å¤åˆ¶" class="headerlink" title="ä¸»ä»å¤åˆ¶"></a>ä¸»ä»å¤åˆ¶</h2><h3 id="å¤åˆ¶çš„åŸºæœ¬åŸåˆ™"><a href="#å¤åˆ¶çš„åŸºæœ¬åŸåˆ™" class="headerlink" title="å¤åˆ¶çš„åŸºæœ¬åŸåˆ™"></a>å¤åˆ¶çš„åŸºæœ¬åŸåˆ™</h3><p>MySQLå¤åˆ¶è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ul>
<li>Masterå°†æ”¹å˜è®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—(Binary Log)ã€‚è¿™äº›è®°å½•è¿‡ç¨‹å«åšäºŒè¿›åˆ¶æ—¥å¿—äº‹ä»¶ï¼Œ<code>Binary Log Events</code>ï¼›</li>
<li>Slaveå°†Masterçš„<code>Binary Log Events</code>æ‹·è´åˆ°å®ƒçš„ä¸­ç»§æ—¥å¿—(Replay Log);</li>
<li>Slaveé‡åšä¸­ç»§æ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†æ”¹å˜åº”ç”¨åˆ°è‡ªå·±çš„æ•°æ®åº“ä¸­ã€‚MySQLå¤åˆ¶æ˜¯å¼‚æ­¥ä¸”ä¸²è¡ŒåŒ–çš„ã€‚</li>
</ul>
<h3 id="å¤åˆ¶çš„æœ€å¤§é—®é¢˜"><a href="#å¤åˆ¶çš„æœ€å¤§é—®é¢˜" class="headerlink" title="å¤åˆ¶çš„æœ€å¤§é—®é¢˜"></a>å¤åˆ¶çš„æœ€å¤§é—®é¢˜</h3><ul>
<li>æ¯ä¸ªSlaveåªæœ‰ä¸€ä¸ªMasterã€‚</li>
<li>æ¯ä¸ªSlaveåªèƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æœåŠ¡å™¨IDã€‚</li>
<li>æ¯ä¸ªMasterå¯ä»¥æœ‰å¤šä¸ªSalveã€‚</li>
</ul>
<h3 id="ä¸€ä¸»ä¸€ä»é…ç½®"><a href="#ä¸€ä¸»ä¸€ä»é…ç½®" class="headerlink" title="ä¸€ä¸»ä¸€ä»é…ç½®"></a>ä¸€ä¸»ä¸€ä»é…ç½®</h3><blockquote>
<p>åŸºæœ¬å‡†å¤‡</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@parak home]# mkdir -p mysql-3307/conf mysql-3307/data mysql-3308/conf mysql-3308/data</span><br><span class="line">[root@parak home]# touch mysql-3307/conf/my.cnf mysql-3308/conf/my.cnf</span><br><span class="line"><span class="meta">#</span><span class="bash"> Masteré…ç½®æ–‡ä»¶</span></span><br><span class="line">[root@parak home]# vi mysql-3307/conf/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /var/lib/mysql</span><br><span class="line">server-id = 1</span><br><span class="line">log-bin = mysql-bin</span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION</span><br><span class="line"><span class="meta">#</span><span class="bash"> Slaveé…ç½®æ–‡ä»¶</span></span><br><span class="line">[root@parak home]# vi mysql-3308/conf/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /var/lib/mysql</span><br><span class="line">server-id = 2</span><br><span class="line">log-bin = mysql-bin</span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION</span><br></pre></td></tr></table></figure>



<blockquote>
<p>Dockerå¯åŠ¨</p>
</blockquote>
<p>mysql-3307ç”¨ä½œMaster</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-v /home/mysql-3307/conf/my.cnf:/etc/my.cnf \</span><br><span class="line">-v /home/mysql-3307/data:/var/lib/mysql \</span><br><span class="line">-p 3307:3306 \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=KAG1823 \</span><br><span class="line">--restart=always \</span><br><span class="line">--name mysql-3307 \</span><br><span class="line">mysql:8.0.20</span><br></pre></td></tr></table></figure>

<p>mysql-3308ç”¨ä½œSlave</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-v /home/mysql-3308/conf/my.cnf:/etc/my.cnf \</span><br><span class="line">-v /home/mysql-3308/data:/var/lib/mysql \</span><br><span class="line">-p 3308:3306 \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=KAG1823 \</span><br><span class="line">--restart=always \</span><br><span class="line">--name mysql-3308 \</span><br><span class="line">mysql:8.0.20</span><br></pre></td></tr></table></figure>



<blockquote>
<p>æŸ¥çœ‹ç½‘ç»œ</p>
</blockquote>
<p>æŸ¥çœ‹bridgeç½‘ç»œçš„æ‰€æœ‰å®¹å™¨ï¼š<code>docker inspect bridgr</code></p>
<p>æ ¹æ®å®¹å™¨IDæˆ–è€…å®¹å™¨åç§°æŸ¥è¯¢ï¼š<code>docker inspect --format=&#39;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#39; å®¹å™¨åç§° | å®¹å™¨id</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@parak ~]# docker inspect --format=&#x27;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#x27; mysql-3307</span><br><span class="line">172.17.0.5</span><br><span class="line">[root@parak ~]# docker inspect --format=&#x27;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#x27; mysql-3308</span><br><span class="line">172.17.0.6</span><br></pre></td></tr></table></figure>

<p>mysql-3307çš„IPä¸ºï¼š<code>172.17.0.5</code></p>
<p>mysql-3308çš„IPä¸ºï¼š<code>172.17.0.6</code></p>
<blockquote>
<p>Masteré…ç½®</p>
</blockquote>
<p>è¿›å…¥Masterå†…éƒ¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># åˆ›å»ºç”¨æˆ·ï¼Œç”¨äºSlaveè®¿é—®Master</span><br><span class="line">mysql&gt; CREATE USER &#39;Khighness&#39;@&#39;%&#39; IDENTIFIED WITH mysql_native_password BY &#39;KAG1823&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO &#39;Khighness&#39;@&#39;%&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"># è®°å½•Fileå’ŒPosition</span><br><span class="line">mysql&gt; SHOW MASTER STATUS\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             File: mysql-bin.000003</span><br><span class="line">         Position: 4440</span><br><span class="line">     Binlog_Do_DB:</span><br><span class="line"> Binlog_Ignore_DB:</span><br><span class="line">Executed_Gtid_Set:</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>

<p>ç”¨æˆ·åï¼š<code>slave</code></p>
<p>Fileï¼š<code>mysql-bin.000003</code></p>
<p>Positionï¼š<code>4440</code></p>
<blockquote>
<p>Slaveé…ç½®</p>
</blockquote>
<p>è¿›å…¥Slaveå†…éƒ¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; CHANGE MASTER TO</span><br><span class="line">    -&gt; MASTER_HOST&#x3D;&#39;172.17.0.5&#39;,</span><br><span class="line">    -&gt; MASTER_PORT&#x3D;3307,</span><br><span class="line">    -&gt; MASTER_USER&#x3D;&#39;Khighness&#39;,</span><br><span class="line">    -&gt; MASTER_PASSWORD&#x3D;&#39;KAG1823&#39;,</span><br><span class="line">    -&gt; MASTER_LOG_FILE&#x3D;&#39;mysql-bin.000003&#39;,</span><br><span class="line">    -&gt; MASTER_LOG_POS&#x3D;4440;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START SLAVE;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼</title>
    <url>/posts/41682/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>å¯æ‰©å±•æ€§çš„æœ¬è´¨æ˜¯æ‰¾åˆ°ç³»ç»Ÿçš„å˜åŒ–ç‚¹ï¼Œå¹¶éš”ç¦»å˜åŒ–ç‚¹ã€‚ </p>
<p>ä¸–é—´ä¼—å¤šè®¾è®¡æ¨¡å¼å…¶å®å°±æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼å³éš”ç¦»å˜åŒ–ç‚¹çš„æ¨¡å¼ã€‚</p>
<p>æè‡´æ‰©å±•æ€§çš„æ ‡å¿—ï¼Œå°±æ˜¯éœ€æ±‚çš„æ–°å¢ï¼Œä¸ä¼šåœ¨åŸæœ‰ä»£ç äº¤ä»˜ç‰©ä¸Šè¿›è¡Œä»»ä½•å½¢å¼çš„ä¿®æ”¹ã€‚</p>
<p>â€”â€”ã€Šé˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œã€‹</p>
<br>

<h2 id="1-è®¾è®¡åŸåˆ™"><a href="#1-è®¾è®¡åŸåˆ™" class="headerlink" title="1. è®¾è®¡åŸåˆ™"></a>1. è®¾è®¡åŸåˆ™</h2><br>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/41682/image-20210413121732627.png" class="" title="DesignPrinciple"><br />



<a id="more"></a>

<br>

<h3 id="1-1-å¼€é—­åŸåˆ™"><a href="#1-1-å¼€é—­åŸåˆ™" class="headerlink" title="1.1 å¼€é—­åŸåˆ™"></a>1.1 å¼€é—­åŸåˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>è½¯ä»¶å®ä½“åº”å½“å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<p>å¯ä»¥é€šè¿‡â€œæŠ½è±¡çº¦æŸã€å°è£…å˜åŒ–â€æ¥å®ç°å¼€é—­åŸåˆ™ï¼Œå³é€šè¿‡æ¥å£æˆ–è€…æŠ½è±¡ç±»ä¸ºè½¯ä»¶å®ä½“å®šä¹‰ä¸€ä¸ªç›¸å¯¹ç¨³å®šçš„æŠ½è±¡å±‚ï¼Œè€Œå°†ç›¸åŒçš„å¯å˜å› ç´ å°è£…åœ¨ç›¸åŒçš„å…·ä½“å®ç°ç±»ä¸­ã€‚</p>
<p>å› ä¸ºæŠ½è±¡çµæ´»æ€§å¥½ï¼Œé€‚åº”æ€§å¹¿ï¼Œåªè¦æŠ½è±¡çš„åˆç†ï¼Œå¯ä»¥åŸºæœ¬ä¿æŒè½¯ä»¶æ¶æ„çš„ç¨³å®šã€‚è€Œè½¯ä»¶ä¸­æ˜“å˜çš„ç»†èŠ‚å¯ä»¥ä»æŠ½è±¡æ´¾ç”Ÿæ¥çš„å®ç°ç±»æ¥è¿›è¡Œæ‰©å±•ï¼Œå½“è½¯ä»¶éœ€è¦å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªéœ€è¦æ ¹æ®éœ€æ±‚é‡æ–°æ´¾ç”Ÿä¸€ä¸ªå®ç°ç±»æ¥æ‰©å±•å°±å¯ä»¥äº†ã€‚</p>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>å¼€é—­åŸåˆ™æ˜¯é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡çš„ç»ˆæç›®æ ‡ï¼Œå®ƒä½¿è½¯ä»¶å®ä½“æ‹¥æœ‰ä¸€å®šçš„é€‚åº”æ€§å’Œçµæ´»æ€§çš„åŒæ—¶å…·å¤‡ç¨³å®šæ€§å’Œå»¶ç»­æ€§ã€‚å…·ä½“æ¥è¯´ï¼Œå…¶ä½œç”¨å¦‚ä¸‹ã€‚</p>
<ol>
<li>å¯¹è½¯ä»¶æµ‹è¯•çš„å½±å“</li>
</ol>
<p>è½¯ä»¶éµå®ˆå¼€é—­åŸåˆ™çš„è¯ï¼Œè½¯ä»¶æµ‹è¯•æ—¶åªéœ€è¦å¯¹æ‰©å±•çš„ä»£ç è¿›è¡Œæµ‹è¯•å°±å¯ä»¥äº†ï¼Œå› ä¸ºåŸæœ‰çš„æµ‹è¯•ä»£ç ä»ç„¶èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚</p>
<ol start="2">
<li>å¯ä»¥æé«˜ä»£ç çš„å¯å¤ç”¨æ€§</li>
</ol>
<p>ç²’åº¦è¶Šå°ï¼Œè¢«å¤ç”¨çš„å¯èƒ½æ€§å°±è¶Šå¤§ï¼›åœ¨é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡ä¸­ï¼Œæ ¹æ®åŸå­å’ŒæŠ½è±¡ç¼–ç¨‹å¯ä»¥æé«˜ä»£ç çš„å¯å¤ç”¨æ€§ã€‚</p>
<ol start="3">
<li>å¯ä»¥æé«˜è½¯ä»¶çš„å¯ç»´æŠ¤æ€§</li>
</ol>
<p>éµå®ˆå¼€é—­åŸåˆ™çš„è½¯ä»¶ï¼Œå…¶ç¨³å®šæ€§é«˜å’Œå»¶ç»­æ€§å¼ºï¼Œä»è€Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤ã€‚</p>
<br>

<h3 id="1-2-é‡Œå¼æ›¿æ¢åŸåˆ™"><a href="#1-2-é‡Œå¼æ›¿æ¢åŸåˆ™" class="headerlink" title="1.2 é‡Œå¼æ›¿æ¢åŸåˆ™"></a>1.2 é‡Œå¼æ›¿æ¢åŸåˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ç»§æ‰¿å¿…é¡»ç¡®ä¿è¶…ç±»æ‰€æ‹¥æœ‰çš„æ€§è´¨åœ¨å­ç±»ä¸­ä»ç„¶æˆç«‹</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<p>å­ç±»å¯ä»¥æ‰©å±•çˆ¶ç±»çš„åŠŸèƒ½ï¼Œä½†ä¸èƒ½æ”¹å˜çˆ¶ç±»åŸæœ‰çš„åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šå­ç±»ç»§æ‰¿çˆ¶ç±»æ—¶ï¼Œé™¤æ·»åŠ æ–°çš„æ–¹æ³•å®Œæˆæ–°å¢åŠŸèƒ½å¤–ï¼Œå°½é‡ä¸è¦é‡å†™çˆ¶ç±»çš„æ–¹æ³•ã€‚</p>
<p>æ ¹æ®ä¸Šè¿°ç†è§£ï¼Œå¯¹é‡Œæ°æ›¿æ¢åŸåˆ™çš„å®šä¹‰å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>å­ç±»å¯ä»¥å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œä½†ä¸èƒ½è¦†ç›–çˆ¶ç±»çš„éæŠ½è±¡æ–¹æ³•</li>
<li>å­ç±»ä¸­å¯ä»¥å¢åŠ è‡ªå·±ç‰¹æœ‰çš„æ–¹æ³•</li>
<li>å½“å­ç±»çš„æ–¹æ³•é‡è½½çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„å‰ç½®æ¡ä»¶ï¼ˆå³æ–¹æ³•çš„è¾“å…¥å‚æ•°ï¼‰è¦æ¯”çˆ¶ç±»çš„æ–¹æ³•æ›´å®½æ¾</li>
<li>å½“å­ç±»çš„æ–¹æ³•å®ç°çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼ˆé‡å†™/é‡è½½æˆ–å®ç°æŠ½è±¡æ–¹æ³•ï¼‰ï¼Œæ–¹æ³•çš„åç½®æ¡ä»¶ï¼ˆå³æ–¹æ³•çš„çš„è¾“å‡º/è¿”å›å€¼ï¼‰è¦æ¯”çˆ¶ç±»çš„æ–¹æ³•æ›´ä¸¥æ ¼æˆ–ç›¸ç­‰</li>
</ul>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<ul>
<li><p>é‡Œæ°æ›¿æ¢åŸåˆ™æ˜¯å®ç°å¼€é—­åŸåˆ™çš„é‡è¦æ–¹å¼ä¹‹ä¸€ã€‚</p>
</li>
<li><p>å®ƒå…‹æœäº†ç»§æ‰¿ä¸­é‡å†™çˆ¶ç±»é€ æˆçš„å¯å¤ç”¨æ€§å˜å·®çš„ç¼ºç‚¹ã€‚</p>
</li>
<li><p>å®ƒæ˜¯åŠ¨ä½œæ­£ç¡®æ€§çš„ä¿è¯ã€‚å³ç±»çš„æ‰©å±•ä¸ä¼šç»™å·²æœ‰çš„ç³»ç»Ÿå¼•å…¥æ–°çš„é”™è¯¯ï¼Œé™ä½äº†ä»£ç å‡ºé”™çš„å¯èƒ½æ€§ã€‚</p>
</li>
<li><p>åŠ å¼ºç¨‹åºçš„å¥å£®æ€§ï¼ŒåŒæ—¶å˜æ›´æ—¶å¯ä»¥åšåˆ°éå¸¸å¥½çš„å…¼å®¹æ€§ï¼Œæé«˜ç¨‹åºçš„ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§ï¼Œé™ä½éœ€æ±‚å˜æ›´æ—¶å¼•å…¥çš„é£é™©ã€‚</p>
</li>
</ul>
<br>

<h3 id="1-3-ä¾èµ–å€’ç½®åŸåˆ™"><a href="#1-3-ä¾èµ–å€’ç½®åŸåˆ™" class="headerlink" title="1.3 ä¾èµ–å€’ç½®åŸåˆ™"></a>1.3 ä¾èµ–å€’ç½®åŸåˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–å…¶æŠ½è±¡ï¼›æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚ï¼Œç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡ã€‚</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<ul>
<li><p>æ¯ä¸ªç±»å°½é‡æä¾›æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œæˆ–è€…ä¸¤è€…éƒ½å…·å¤‡ã€‚</p>
</li>
<li><p>å˜é‡çš„å£°æ˜ç±»å‹å°½é‡æ˜¯æ¥å£æˆ–è€…æ˜¯æŠ½è±¡ç±»ã€‚</p>
</li>
<li><p>ä»»ä½•ç±»éƒ½ä¸åº”è¯¥ä»å…·ä½“ç±»æ´¾ç”Ÿã€‚</p>
</li>
<li><p>ä½¿ç”¨ç»§æ‰¿æ—¶å°½é‡éµå¾ªé‡Œæ°æ›¿æ¢åŸåˆ™ã€‚</p>
</li>
</ul>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<ul>
<li>ä¾èµ–å€’ç½®åŸåˆ™å¯ä»¥é™ä½ç±»é—´çš„è€¦åˆæ€§ã€‚</li>
<li>ä¾èµ–å€’ç½®åŸåˆ™å¯ä»¥æé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚</li>
<li>ä¾èµ–å€’ç½®åŸåˆ™å¯ä»¥å‡å°‘å¹¶è¡Œå¼€å‘å¼•èµ·çš„é£é™©ã€‚</li>
<li>ä¾èµ–å€’ç½®åŸåˆ™å¯ä»¥æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</li>
</ul>
<br>

<h3 id="1-4-å•ä¸€èŒè´£åŸåˆ™"><a href="#1-4-å•ä¸€èŒè´£åŸåˆ™" class="headerlink" title="1.4 å•ä¸€èŒè´£åŸåˆ™"></a>1.4 å•ä¸€èŒè´£åŸåˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ä¸€ä¸ªç±»åº”è¯¥æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¼•èµ·å®ƒå˜åŒ–çš„åŸå› ï¼Œå¦åˆ™ç±»åº”è¯¥è¢«æ‹†åˆ†</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<p>å•ä¸€èŒè´£åŸåˆ™æ˜¯æœ€ç®€å•ä½†åˆæœ€éš¾è¿ç”¨çš„åŸåˆ™ï¼Œéœ€è¦è®¾è®¡äººå‘˜å‘ç°ç±»çš„ä¸åŒèŒè´£å¹¶å°†å…¶åˆ†ç¦»ï¼Œå†å°è£…åˆ°ä¸åŒçš„ç±»æˆ–æ¨¡å—ä¸­ã€‚</p>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>å•ä¸€èŒè´£åŸåˆ™çš„æ ¸å¿ƒå°±æ˜¯æ§åˆ¶ç±»çš„ç²’åº¦å¤§å°ã€å°†å¯¹è±¡è§£è€¦ã€æé«˜å…¶å†…èšæ€§ã€‚</p>
<ul>
<li>é™ä½ç±»çš„å¤æ‚åº¦ã€‚ä¸€ä¸ªç±»åªè´Ÿè´£ä¸€é¡¹èŒè´£ï¼Œå…¶é€»è¾‘è‚¯å®šè¦æ¯”è´Ÿè´£å¤šé¡¹èŒè´£ç®€å•å¾—å¤šã€‚</li>
<li>æé«˜ç±»çš„å¯è¯»æ€§ã€‚å¤æ‚æ€§é™ä½ï¼Œè‡ªç„¶å…¶å¯è¯»æ€§ä¼šæé«˜ã€‚</li>
<li>æé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€‚å¯è¯»æ€§æé«˜ï¼Œé‚£è‡ªç„¶æ›´å®¹æ˜“ç»´æŠ¤äº†ã€‚</li>
<li>å˜æ›´å¼•èµ·çš„é£é™©é™ä½ã€‚å˜æ›´æ˜¯å¿…ç„¶çš„ï¼Œå¦‚æœå•ä¸€èŒè´£åŸåˆ™éµå®ˆå¾—å¥½ï¼Œå½“ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½æ—¶ï¼Œå¯ä»¥æ˜¾è‘—é™ä½å¯¹å…¶ä»–åŠŸèƒ½çš„å½±å“ã€‚</li>
</ul>
<br>

<h3 id="1-5-æ¥å£éš”ç¦»åŸåˆ™"><a href="#1-5-æ¥å£éš”ç¦»åŸåˆ™" class="headerlink" title="1.5 æ¥å£éš”ç¦»åŸåˆ™"></a>1.5 æ¥å£éš”ç¦»åŸåˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>è¦ä¸ºå„ä¸ªç±»å»ºç«‹å®ƒä»¬éœ€è¦çš„ä¸“ç”¨æ¥å£ï¼Œè€Œä¸è¦è¯•å›¾å»å»ºç«‹ä¸€ä¸ªå¾ˆåºå¤§çš„æ¥å£ä¾›æ‰€æœ‰ä¾èµ–å®ƒçš„ç±»å»è°ƒç”¨ã€‚</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<p>åœ¨å…·ä½“åº”ç”¨æ¥å£éš”ç¦»åŸåˆ™æ—¶ï¼Œåº”è¯¥æ ¹æ®ä»¥ä¸‹å‡ ä¸ªè§„åˆ™æ¥è¡¡é‡ã€‚</p>
<ul>
<li>æ¥å£å°½é‡å°ï¼Œä½†æ˜¯è¦æœ‰é™åº¦ã€‚ä¸€ä¸ªæ¥å£åªæœåŠ¡äºä¸€ä¸ªå­æ¨¡å—æˆ–ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>ä¸ºä¾èµ–æ¥å£çš„ç±»å®šåˆ¶æœåŠ¡ã€‚åªæä¾›è°ƒç”¨è€…éœ€è¦çš„æ–¹æ³•ï¼Œå±è”½ä¸éœ€è¦çš„æ–¹æ³•ã€‚</li>
<li>äº†è§£ç¯å¢ƒï¼Œæ‹’ç»ç›²ä»ã€‚æ¯ä¸ªé¡¹ç›®æˆ–äº§å“éƒ½æœ‰é€‰å®šçš„ç¯å¢ƒå› ç´ ï¼Œç¯å¢ƒä¸åŒï¼Œæ¥å£æ‹†åˆ†çš„æ ‡å‡†å°±ä¸åŒæ·±å…¥äº†è§£ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>æé«˜å†…èšï¼Œå‡å°‘å¯¹å¤–äº¤äº’ã€‚ä½¿æ¥å£ç”¨æœ€å°‘çš„æ–¹æ³•å»å®Œæˆæœ€å¤šçš„äº‹æƒ…ã€‚</li>
</ul>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>æ¥å£éš”ç¦»åŸåˆ™æ˜¯ä¸ºäº†çº¦æŸæ¥å£ã€é™ä½ç±»å¯¹æ¥å£çš„ä¾èµ–æ€§ï¼Œéµå¾ªæ¥å£éš”ç¦»åŸåˆ™æœ‰ä»¥ä¸‹ 5 ä¸ªä¼˜ç‚¹ã€‚</p>
<ul>
<li><p>å°†è‡ƒè‚¿åºå¤§çš„æ¥å£åˆ†è§£ä¸ºå¤šä¸ªç²’åº¦å°çš„æ¥å£ï¼Œå¯ä»¥é¢„é˜²å¤–æ¥å˜æ›´çš„æ‰©æ•£ï¼Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
</li>
<li><p>æ¥å£éš”ç¦»æé«˜äº†ç³»ç»Ÿçš„å†…èšæ€§ï¼Œå‡å°‘äº†å¯¹å¤–äº¤äº’ï¼Œé™ä½äº†ç³»ç»Ÿçš„è€¦åˆæ€§ã€‚</p>
</li>
<li><p>å¦‚æœæ¥å£çš„ç²’åº¦å¤§å°å®šä¹‰åˆç†ï¼Œèƒ½å¤Ÿä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼›ä½†æ˜¯ï¼Œå¦‚æœå®šä¹‰è¿‡å°ï¼Œåˆ™ä¼šé€ æˆæ¥å£æ•°é‡è¿‡å¤šï¼Œä½¿è®¾è®¡å¤æ‚åŒ–ï¼›å¦‚æœå®šä¹‰å¤ªå¤§ï¼Œçµæ´»æ€§é™ä½ï¼Œæ— æ³•æä¾›å®šåˆ¶æœåŠ¡ï¼Œç»™æ•´ä½“é¡¹ç›®å¸¦æ¥æ— æ³•é¢„æ–™çš„é£é™©ã€‚</p>
</li>
<li><p>ä½¿ç”¨å¤šä¸ªä¸“é—¨çš„æ¥å£è¿˜èƒ½å¤Ÿä½“ç°å¯¹è±¡çš„å±‚æ¬¡ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡æ¥å£çš„ç»§æ‰¿ï¼Œå®ç°å¯¹æ€»æ¥å£çš„å®šä¹‰ã€‚</p>
</li>
<li><p>èƒ½å‡å°‘é¡¹ç›®å·¥ç¨‹ä¸­çš„ä»£ç å†—ä½™ã€‚è¿‡å¤§çš„å¤§æ¥å£é‡Œé¢é€šå¸¸æ”¾ç½®è®¸å¤šä¸ç”¨çš„æ–¹æ³•ï¼Œå½“å®ç°è¿™ä¸ªæ¥å£çš„æ—¶å€™ï¼Œè¢«è¿«è®¾è®¡å†—ä½™çš„ä»£ç ã€‚</p>
</li>
</ul>
<br>

<h3 id="1-6-è¿ªç±³ç‰¹æ³•åˆ™"><a href="#1-6-è¿ªç±³ç‰¹æ³•åˆ™" class="headerlink" title="1.6 è¿ªç±³ç‰¹æ³•åˆ™"></a>1.6 è¿ªç±³ç‰¹æ³•åˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å¦‚æœä¸¤ä¸ªè½¯ä»¶å®ä½“æ— é¡»ç›´æ¥é€šä¿¡ï¼Œé‚£ä¹ˆå°±ä¸åº”å½“å‘ç”Ÿç›´æ¥çš„ç›¸äº’è°ƒç”¨ï¼Œå¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹è½¬å‘è¯¥è°ƒç”¨ã€‚</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<ul>
<li><p>ä»ä¾èµ–è€…çš„è§’åº¦æ¥è¯´ï¼Œåªä¾èµ–åº”è¯¥ä¾èµ–çš„å¯¹è±¡ã€‚</p>
</li>
<li><p>ä»è¢«ä¾èµ–è€…çš„è§’åº¦è¯´ï¼Œåªæš´éœ²åº”è¯¥æš´éœ²çš„æ–¹æ³•ã€‚</p>
</li>
</ul>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>è¿ªç±³ç‰¹æ³•åˆ™è¦æ±‚é™åˆ¶è½¯ä»¶å®ä½“ä¹‹é—´é€šä¿¡çš„å®½åº¦å’Œæ·±åº¦ï¼Œæ­£ç¡®ä½¿ç”¨è¿ªç±³ç‰¹æ³•åˆ™å°†æœ‰ä»¥ä¸‹ä¸¤ä¸ªä¼˜ç‚¹ã€‚</p>
<ul>
<li><p>é™ä½äº†ç±»ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæé«˜äº†æ¨¡å—çš„ç›¸å¯¹ç‹¬ç«‹æ€§ã€‚</p>
</li>
<li><p>ç”±äºäº²åˆåº¦é™ä½ï¼Œä»è€Œæé«˜äº†ç±»çš„å¯å¤ç”¨ç‡å’Œç³»ç»Ÿçš„æ‰©å±•æ€§ã€‚</p>
</li>
</ul>
<br>

<h2 id="2-è®¾è®¡æ¨¡å¼"><a href="#2-è®¾è®¡æ¨¡å¼" class="headerlink" title="2. è®¾è®¡æ¨¡å¼"></a>2. è®¾è®¡æ¨¡å¼</h2><br>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/41682/image-20210413121858931.png" class="" title="DesignPrinciple"><br />



<h3 id="2-1-å•ä¾‹æ¨¡å¼-Singleton"><a href="#2-1-å•ä¾‹æ¨¡å¼-Singleton" class="headerlink" title="2.1 å•ä¾‹æ¨¡å¼-Singleton"></a>2.1 å•ä¾‹æ¨¡å¼-Singleton</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä¸”è¯¥ç±»èƒ½è‡ªè¡Œåˆ›å»ºè¿™ä¸ªå®ä¾‹</p>
<blockquote>
<p>ç‰¹ç‚¹</p>
</blockquote>
<ol>
<li>å•ä¾‹ç±»åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚</li>
<li>è¯¥å•ä¾‹å¯¹è±¡å¿…é¡»ç”±å•ä¾‹ç±»è‡ªè¡Œåˆ›å»ºã€‚</li>
<li>å•ä¾‹ç±»å¯¹å¤–æä¾›ä¸€ä¸ªè®¿é—®è¯¥å•ä¾‹çš„å…¨å±€è®¿é—®ç‚¹ã€‚</li>
</ol>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å•ä¾‹æ¨¡å¼å¯ä»¥ä¿è¯å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜çš„å¼€é”€ã€‚</li>
<li>å¯ä»¥é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ã€‚</li>
<li>å•ä¾‹æ¨¡å¼è®¾ç½®å…¨å±€è®¿é—®ç‚¹ï¼Œå¯ä»¥ä¼˜åŒ–å’Œå…±äº«èµ„æºçš„è®¿é—®ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å•ä¾‹æ¨¡å¼ä¸€èˆ¬æ²¡æœ‰æ¥å£ï¼Œæ‰©å±•å›°éš¾ï¼Œå¦‚æœè¦æ‰©å±•ï¼Œåˆ™é™¤äº†ä¿®æ”¹åŸæ¥çš„ä»£ç ï¼Œæ²¡æœ‰ç¬¬äºŒç§é€”å¾„ï¼Œè¿èƒŒå¼€é—­åŸåˆ™ã€‚</li>
<li>åœ¨å¹¶å‘æµ‹è¯•ä¸­ï¼Œå•ä¾‹æ¨¡å¼ä¸åˆ©äºä»£ç è°ƒè¯•ã€‚åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå•ä¾‹ä¸­çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¸èƒ½æ¨¡æ‹Ÿç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</li>
<li>å•ä¾‹æ¨¡å¼çš„åŠŸèƒ½ä»£ç é€šå¸¸å†™åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œå¦‚æœåŠŸèƒ½è®¾è®¡ä¸åˆç†ï¼Œåˆ™å¾ˆå®¹æ˜“è¿èƒŒå•ä¸€èŒè´£åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>å•ä¾‹ç±»</li>
<li>è®¿é—®ç±»</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<ul>
<li>æ‡’æ±‰å¼å•ä¾‹</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.singleton.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.singeleton.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: LazySingleton &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: æ‡’æ±‰å¼å•ä¾‹ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; ç‰¹ç‚¹ï¼š</span></span><br><span class="line"><span class="comment"> * ç±»åŠ è½½æ—¶æ²¡æœ‰ç”Ÿæˆå•ä¾‹ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨getInstanceæ–¹æ³•æ—¶æ‰ä¼šåˆ›å»ºè¿™ä¸ªå•ä¾‹</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazySingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* volatile: å…·æœ‰å¯è§æ€§ã€æœ‰åºæ€§ï¼Œä¸å…·å¤‡åŸå­æ€§</span></span><br><span class="line"><span class="comment">    volatileå£°æ˜å˜é‡çš„å€¼å¯èƒ½éšæ—¶ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œ</span></span><br><span class="line"><span class="comment">    ä½¿ç”¨volatileä¿®é¥°çš„å˜é‡ä¼šå¼ºåˆ¶å°†ä¿®æ”¹çš„å€¼ç«‹å³å†™å…¥ä¸»å­˜ï¼Œ</span></span><br><span class="line"><span class="comment">    ä¸»å­˜ä¸­å€¼çš„æ›´æ–°ä¼šä½¿ç¼“å­˜ä¸­çš„å€¼å¤±æ•ˆã€‚</span></span><br><span class="line"><span class="comment">    volatileä¸ä¼šè®©çº¿ç¨‹é˜»å¡ï¼Œå“åº”é€Ÿåº¦æ¯”synchronizedå¿« */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// volatileä¿è¯instanceåœ¨æ‰€æœ‰çº¿ç¨‹ä¸­åŒæ­¥å¯è§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> LazySingleton instance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// privateé¿å…ç±»åœ¨å¤–éƒ¨è¢«å®ä¾‹åŒ–</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LazySingleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ é”åŒæ­¥ï¼Œä¿è¯getInstance()åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> LazySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> LazySingleton();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>é¥¿æ±‰å¼å•ä¾‹</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.singleton.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.singeleton.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: HungrySingleton &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: é¥¿æ±‰å¼å•ä¾‹ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; ç‰¹ç‚¹ï¼š</span></span><br><span class="line"><span class="comment"> * ç±»ä¸€æ—¦åŠ è½½å°±åˆ›å»ºä¸€ä¸ªå•ä¾‹ï¼Œä¿è¯åœ¨è°ƒç”¨getInstance()ä¹‹å‰å•ä¾‹å°±å·²ç»å­˜åœ¨</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HungrySingleton</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åœ¨ç±»åŠ è½½æ—¶å°±åˆ›å»ºä¸€ä¸ªé™æ€å¯¹è±¡ä¾›ç³»ç»Ÿä½¿ç”¨ï¼Œä»¥åä¸å†æ”¹å˜ï¼Œ</span></span><br><span class="line"><span class="comment">    æ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥ç›´æ¥ç”¨äºå¤šçº¿ç¨‹è€Œä¸ä¼šå‡ºç°é—®é¢˜ */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HungrySingleton instance = <span class="keyword">new</span> HungrySingleton();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HungrySingleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HungrySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-2-åŸå‹æ¨¡å¼-Prototype"><a href="#2-2-åŸå‹æ¨¡å¼-Prototype" class="headerlink" title="2.2 åŸå‹æ¨¡å¼-Prototype"></a>2.2 åŸå‹æ¨¡å¼-Prototype</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ç”¨ä¸€ä¸ªå·²ç»åˆ›å»ºçš„å®ä¾‹ï¼Œé€šè¿‡å¤åˆ¶è¯¥åŸå‹å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªå’ŒåŸå‹ç›¸åŒæˆ–è€…ç›¸ä¼¼çš„æ–°å¯¹è±¡</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>Javaè‡ªå¸¦çš„åŸå‹æ¨¡å¼åŸºäºå†…å­˜äºŒè¿›åˆ¶æµçš„å¤åˆ¶ï¼Œåœ¨æ€§èƒ½ä¸Šæ¯”ç›´æ¥newä¸€ä¸ªå¯¹è±¡æ›´åŠ ä¼˜è‰¯ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨æ·±å…‹éš†æ–¹å¼ä¿å­˜å¯¹è±¡çš„çŠ¶æ€ï¼Œä½¿ç”¨åŸå‹æ¨¡å¼å°†å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œå¹¶å°†å…¶çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œç®€åŒ–äº†åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ï¼Œä»¥ä¾¿åœ¨éœ€è¦çš„æ—¶å€™ä½¿ç”¨ï¼ˆä¾‹å¦‚æ¢å¤åˆ°å†å²æŸä¸€çŠ¶æ€ï¼‰ï¼Œå¯å¤åˆ¶å®ç°æ’¤é”€æ“ä½œã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>éœ€è¦ä¸ºæ¯ä¸€ä¸ªç±»éƒ½é…ç½®ä¸€ä¸ªcloneæ–¹æ³•ã€‚</li>
<li>cloneæ–¹æ³•ä½äºç±»çš„å†…éƒ¨ï¼Œå½“å¯¹äºå·²æœ‰ç±»è¿›è¡Œæ”¹é€ çš„æ—¶å€™ï¼Œéœ€è¦ä¿®æ”¹ä»£ç ï¼Œè¿èƒŒäº†å¼€é—­åŸåˆ™ã€‚</li>
<li>å½“å®ç°æ·±å…‹éš†æ—¶ï¼Œéœ€è¦ç¼–å†™è¾ƒä¸ºå¤æ‚çš„ä»£ç ï¼Œè€Œä¸”å½“å¯¹è±¡ä¹‹é—´å­˜åœ¨å¤šé‡åµŒå¥—å¼•ç”¨æ—¶ï¼Œä¸ºäº†å®ç°æ·±å…‹éš†ï¼Œæ¯ä¸€å±‚å¯¹è±¡å¯¹åº”çš„ç±»éƒ½å¿…é¡»æ”¯æŒæ·±å…‹éš†ï¼Œå®ç°èµ·æ¥ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤ï¼Œæµ…å…‹éš†å’Œæ·±å…‹éš†éœ€è¦éœ€è¦è¿ç”¨å¾—å½“ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡åŸå‹ç±»ï¼šè§„å®šäº†å…·ä½“åŸå‹å¯¹è±¡å¿…é¡»å®ç°çš„æ¥å£ã€‚</li>
<li>å…·ä½“åŸå‹ç±»ï¼šå®ç°æŠ½è±¡åŸå‹ç±»çš„clone()æ–¹æ³•ï¼Œå®ƒæ˜¯å¯è¢«å¤åˆ¶çš„å¯¹è±¡ã€‚</li>
<li>è®¿é—®ç±»ï¼šä½¿ç”¨å…·ä½“åŸå‹ç±»ä¸­çš„clone()æ–¹æ³•ç±»å¤åˆ¶æ–°çš„å¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.prototype.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.prototype.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Prototype &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: åŸå‹æ¨¡å¼æµ…å…‹éš† &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/16</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; ç‰¹ç‚¹ï¼š</span></span><br><span class="line"><span class="comment"> * æµ…å…‹éš†ï¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ–°å¯¹è±¡çš„å±æ€§å’ŒåŸæ¥å¯¹è±¡å®Œå…¨ç›¸åŒï¼Œå¯¹äºéåŸºæœ¬ç±»å‹å±æ€§ï¼Œæ‰”æŒ‡å‘åŸæœ‰å±æ€§æ‰€æŒ‡å‘çš„å¯¹è±¡çš„å†…å­˜åœ°å€</span></span><br><span class="line"><span class="comment"> * æ·±å…‹éš†ï¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå±æ€§ä¸­å¼•ç”¨çš„å¯¹è±¡ä¹Ÿä¼šè¢«å…‹éš†ï¼Œä¸å†æŒ‡å‘åŸæœ‰å¯¹è±¡åœ°å€</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Prototype</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = Logger.getLogger(Prototype.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        RealizeType realizeType1 = <span class="keyword">new</span> RealizeType();</span><br><span class="line">        RealizeType realizeType2 = (RealizeType) realizeType1.clone();</span><br><span class="line">        log.info(<span class="string">&quot;realizeType1 == realizeType2 ? &quot;</span> + (realizeType1 == realizeType2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealizeType</span> <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(RealizeType.class);</span><br><span class="line"></span><br><span class="line">    RealizeType() &#123;</span><br><span class="line">        log.info(<span class="string">&quot;åŸå‹åˆ›å»º&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;åŸå‹å¤åˆ¶&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.clone();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-3-ç®€å•å·¥å‚æ¨¡å¼-Simple-Factory"><a href="#2-3-ç®€å•å·¥å‚æ¨¡å¼-Simple-Factory" class="headerlink" title="2.3 ç®€å•å·¥å‚æ¨¡å¼-Simple Factory"></a>2.3 <del>ç®€å•å·¥å‚æ¨¡å¼-Simple Factory</del></h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å®šä¹‰ä¸€ä¸ªåˆ›å»ºäº§å“å¯¹è±¡çš„å·¥å‚æ¥å£ï¼Œå°†äº§å“å¯¹è±¡çš„å®é™…åˆ›å»ºå·¥ä½œæ¨è¿Ÿåˆ°å…·ä½“å­å·¥å‚ç±»å½“ä¸­ã€‚</p>
<blockquote>
<p>æŒ‰ç…§ä¸šåŠ¡åœºæ™¯åˆ’åˆ†ï¼Œå·¥å‚æ¨¡å¼æœ‰3ç§å®ç°æ–¹å¼</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/41682/image-20201111164349538.png" class="" title="image-20201111164349538"><br />

<center>
    <font face="Kristen ITC" color="#555555" font-size=100px>ä¸‰ç§å®ç°æ–¹å¼</font><br>
</center>



<blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>ç®€å•å·¥å‚æ¨¡å¼æœ‰ä¸€ä¸ªå…·ä½“çš„å·¥å‚ç±»ï¼Œå¯ä»¥ç”Ÿäº§å¤šä¸ªä¸åŒçš„äº§å“ï¼Œå±äºåˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œä½†æ˜¯ç®€å•å·¥å‚æ¨¡å¼ä¸åœ¨GOF23ä¸­è®¾è®¡æ¨¡å¼ä¹‹åˆ—ã€‚</p>
<p>åœ¨ç®€å•å·¥å‚æ¨¡å¼ä¸­åˆ›å»ºå®ä¾‹çš„æ–¹æ³•é€šå¸¸ä¸ºé™æ€(static)æ–¹æ³•ï¼Œå› æ­¤ç®€å•å·¥å‚æ¨¡å¼(Simple Factory Pattern)åˆå«åšé™æ€å·¥å‚æ–¹æ³•æ¨¡å¼(Static Factory Method Pattern)ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å·¥å‚ç±»åŒ…å«å¿…è¦çš„é€»è¾‘åˆ¤æ–­ï¼Œå¯ä»¥å†³å®šåœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºå“ªä¸€ä¸ªäº§å“çš„å®ä¾‹ã€‚å®¢æˆ·ç«¯å¯ä»¥å…é™¤ç›´æ¥åˆ›å»ºäº§å“å¯¹è±¡çš„èŒè´£ï¼Œå¾ˆæ–¹ä¾¿çš„åˆ›å»ºå“åº”çš„äº§å“ã€‚å·¥å‚å’Œäº§å“çš„èŒè´£åŒºåˆ†æ˜ç¡®ã€‚</li>
<li>å®¢æˆ·ç«¯æ— éœ€çŸ¥é“æ‰€åˆ›å»ºå…·ä½“äº§å“çš„ç±»åï¼Œåªéœ€çŸ¥é“å‚æ•°å³å¯ã€‚</li>
<li>ä¹Ÿå¯ä»¥å¼•å…¥é…ç½®æ–‡ä»¶ï¼Œåœ¨ä¸ä¿®æ”¹å®¢æˆ·ç«¯çš„ä»£ç çš„æƒ…å†µä¸‹æ›´æ¢å’Œæ·»åŠ æ–°çš„å…·ä½“äº§å“ç±»ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ç®€å•å·¥å‚æ¨¡å¼çš„å·¥å‚ç±»å•ä¸€ï¼Œè´Ÿè´£æ‰€æœ‰äº§å“çš„åˆ›å»ºï¼ŒèŒè´£è¿‡é‡ï¼Œä¸€æ—¦å¼‚å¸¸ï¼Œæ•´ä¸ªç³»ç»Ÿå°†å—åˆ°å½±å“ã€‚ä¸”å·¥å‚ç±»ä»£ç ä¼šéå¸¸è‡ƒè‚¿ï¼Œè¿èƒŒé«˜èšåˆåŸåˆ™ã€‚</li>
<li>ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼ä¼šå¢åŠ ç³»ç»Ÿä¸­ç±»çš„ä¸ªæ•°(å¼•å…¥æ–°çš„å·¥å‚ç±»)ï¼Œå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦å’Œç†è§£éš¾åº¦ã€‚</li>
<li>ç³»ç»Ÿæ‹“å±•å›°éš¾ï¼Œä¸€æ—¦å¢åŠ æ–°äº§å“ä¸å¾—ä¸ä¿®æ”¹å·¥å‚é€»è¾‘ï¼Œåœ¨äº§å“ç±»å‹è¾ƒå¤šæ—¶ï¼Œå¯èƒ½é€ æˆé€»è¾‘è¿‡äºå¤æ‚ã€‚</li>
</ul>
<blockquote>
<p>åº”ç”¨åœºæ™¯</p>
</blockquote>
<p>å¯¹äºäº§å“ç§ç±»ç›¸å¯¹è¾ƒå°‘çš„æƒ…å†µï¼Œè€ƒè™‘ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼ã€‚ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼çš„å®¢æˆ·ç«¯åªéœ€è¦ä¼ å…¥å·¥å‚ç±»çš„å‚æ•°ï¼Œä¸éœ€è¦å…³å¿ƒå¦‚ä½•åˆ›å»ºå¯¹è±¡çš„é€»è¾‘ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°åˆ›å»ºæ‰€éœ€äº§å“ã€‚</p>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>ç®€å•å·¥å‚(Simple Factory)ï¼šæ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„æ ¸å¿ƒï¼Œè´Ÿè´£å®ç°åˆ›å»ºæ‰€æœ‰å®ä¾‹çš„å†…éƒ¨é€»è¾‘ã€‚å·¥å‚ç±»åˆ›å»ºäº§å“ç±»çš„æ–¹æ³•å¯ä»¥è¢«å¤–ç•Œç›´æ¥è°ƒç”¨ï¼Œåˆ›å»ºæ‰€éœ€çš„äº§å“å¯¹è±¡ã€‚</li>
<li>æŠ½è±¡äº§å“(Abstract Product)ï¼šæ˜¯ç®€å•å·¥å‚åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡çš„çˆ¶äº²ï¼Œè´Ÿè´£æè¿°æ‰€æœ‰å®ä¾‹å…±æœ‰çš„å…¬å…±æ¥å£ã€‚</li>
<li>å…·ä½“äº§å“(Concrete Product)ï¼šæ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„åˆ›å»ºç›®æ ‡ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.simpleFactory.pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.simpleactory.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Client &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: ç®€å•å·¥å‚æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleFactoryDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = Logger.getLogger(SimpleFactoryDemo.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            System.out.print(<span class="string">&quot;è¾“å…¥äº§å“å‹å·ï¼š&quot;</span>);</span><br><span class="line">            <span class="keyword">int</span> choice = scanner.nextInt();</span><br><span class="line">            <span class="keyword">switch</span> (choice) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>: log.info(<span class="string">&quot;æˆåŠŸé€€å‡º&quot;</span>); <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>: SimpleFactory.makeProduct(Constant.PRODUCT_1).show(); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>: SimpleFactory.makeProduct(Constant.PRODUCT_2).show(); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>: SimpleFactory.makeProduct(Constant.PRODUCT_3).show(); <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>: log.info(<span class="string">&quot;è¯¥äº§å“ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥ï¼&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡äº§å“</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">product</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æšä¸¾æ‰€æœ‰äº§å“</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Constant</span> </span>&#123;</span><br><span class="line">    PRODUCT_1,</span><br><span class="line">    PRODUCT_2,</span><br><span class="line">    PRODUCT_3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“äº§å“1</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteProduct1</span> <span class="keyword">implements</span> <span class="title">product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteProduct1.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“äº§å“1æ˜¾ç¤º...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“äº§å“2</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteProduct2</span> <span class="keyword">implements</span> <span class="title">product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteProduct2.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“äº§å“2æ˜¾ç¤º...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“äº§å“3</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteProduct3</span> <span class="keyword">implements</span> <span class="title">product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteProduct3.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“äº§å“3æ˜¾ç¤º...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ç®€å•å·¥å‚</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> product <span class="title">makeProduct</span><span class="params">(Constant c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">            <span class="keyword">case</span> PRODUCT_1:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ConcreteProduct1();</span><br><span class="line">            <span class="keyword">case</span> PRODUCT_2:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ConcreteProduct2();</span><br><span class="line">            <span class="keyword">case</span> PRODUCT_3:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ConcreteProduct3();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-4-å·¥å‚æ–¹æ³•æ¨¡å¼-Factory-Method"><a href="#2-4-å·¥å‚æ–¹æ³•æ¨¡å¼-Factory-Method" class="headerlink" title="2.4 å·¥å‚æ–¹æ³•æ¨¡å¼-Factory Method"></a>2.4 å·¥å‚æ–¹æ³•æ¨¡å¼-Factory Method</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼æ˜¯å¯¹ç®€å•å·¥å‚æ¨¡å¼çš„è¿›ä¸€æ­¥æŠ½è±¡åŒ–ï¼Œå…¶å¥½å¤„æ˜¯å¯ä»¥ä½¿ç³»ç»Ÿåœ¨ä¸ä¿®æ”¹åŸæ¥ä»£ç çš„æƒ…å†µä¸‹å¼•è¿›æ–°çš„äº§å“ï¼Œå³æ»¡è¶³å¼€é—­åŸåˆ™ã€‚</p>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼è€ƒè™‘çš„æ˜¯ä¸€ç§å·¥å‚è´Ÿè´£ä¸€ç±»äº§å“çš„ç”Ÿäº§ï¼Œç•œç‰§åœºåªå…»åŠ¨ç‰©ã€ç”µè§†æœºå‚åªç”Ÿäº§ç”µè§†æœºã€è®¡ç®—æœºè½¯ä»¶å­¦é™¢åªåŸ¹å…»è®¡ç®—æœºè½¯ä»¶ä¸“ä¸šçš„å­¦ç”Ÿç­‰ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>ç”¨æˆ·åªéœ€è¦å…·ä½“å·¥å‚çš„åç§°å°±å¯å¾—åˆ°æ‰€è¦çš„äº§å“ï¼Œæ— éœ€çŸ¥é“äº§å“çš„å…·ä½“åˆ›å»ºè¿‡ç¨‹ã€‚</li>
<li>çµæ´»æ€§å¢å¼ºï¼Œå¯¹äºæ–°äº§å“çš„åˆ›å»ºï¼Œåªéœ€å¤šå†™ä¸€ä¸ªç›¸åº”çš„å·¥å‚ç±»ã€‚</li>
<li>å…¸å‹çš„è§£è€¦æ¡†æ¶ã€‚é«˜å±‚æ¨¡å—åªéœ€è¦çŸ¥é“äº§å“çš„æŠ½è±¡ç±»ï¼Œæ— éœ€å…³ç³»å…¶ä»–å®ç°ç±»ï¼Œæ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™ã€ä¾èµ–å€’ç½®åŸåˆ™å’Œé‡Œå¼æ›¿æ¢åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ç±»çš„ä¸ªæ•°å®¹æ˜“è¿‡å¤šï¼Œå¢åŠ å¤æ‚åº¦ã€‚</li>
<li>å¢åŠ äº†ç³»ç»Ÿçš„æŠ½è±¡æ€§å’Œç†è§£éš¾åº¦ã€‚</li>
<li>ä¸€ä¸ªå·¥å‚åªèƒ½ç”Ÿäº§ä¸€ç§äº§å“ï¼Œæ­¤å¼Šç«¯å¯ä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼è§£å†³ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡å·¥å‚(Abstract Factory)ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ¥å£ï¼Œè°ƒç”¨è€…é€šè¿‡å®ƒè®¿é—®å…·ä½“å·¥å‚çš„å·¥å‚æ–¹æ³•ç±»åˆ›å»ºäº§å“ã€‚</li>
<li>å…·ä½“å·¥å‚(Concrete Factory)ï¼šä¸»è¦æ˜¯å®ç°æŠ½è±¡å·¥å‚ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆå…·ä½“äº§å“çš„åˆ›å»ºã€‚</li>
<li>æŠ½è±¡äº§å“(Abstract Product)ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚</li>
<li>å…·ä½“äº§å“(Concrete Product)ï¼šå®ç°äº†æŠ½è±¡äº§å“è§’è‰²å®šä¹‰çš„æ¥å£ï¼Œç”±å…·ä½“å·¥å‚æ¥åˆ›å»ºï¼Œå®ƒåŒå…·ä½“å·¥å‚ä¹‹é—´ä¸€ä¸€å¯¹åº”ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.factoryMethod.pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.ParserConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.factoryMethod.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: FactoryMethod &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: å·¥å‚æ–¹æ³•æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FactoryMethodDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = Logger.getLogger(FactoryMethodDemo.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * è¯»å–XMLé…ç½®æ–‡ä»¶ï¼Œæå–å…·ä½“ç±»åï¼Œè¿”å›å®ä¾‹å¯¹è±¡é›†åˆ</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> List&lt;Object&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SAXException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ParserConfigurationException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ClassNotFoundException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalAccessException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InstantiationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Object&gt; <span class="title">getObjects</span><span class="params">(String filePath)</span> <span class="keyword">throws</span> IOException, SAXException, ParserConfigurationException,  ClassNotFoundException, IllegalAccessException, InstantiationException </span>&#123;</span><br><span class="line">        DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">        DocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();</span><br><span class="line">        Document document = documentBuilder.parse(<span class="keyword">new</span> File(filePath));</span><br><span class="line">        NodeList nodeList = document.getElementsByTagName(<span class="string">&quot;className&quot;</span>);</span><br><span class="line">        List&lt;Object&gt; objects = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodeList.getLength(); i++) &#123;</span><br><span class="line">            String packageName = FactoryMethodDemo.class.getPackage().getName();</span><br><span class="line">            String className = nodeList.item(i).getTextContent();</span><br><span class="line">            Class&lt;?&gt; c = Class.forName(packageName + <span class="string">&quot;.&quot;</span> + className);</span><br><span class="line">            objects.add(c.newInstance());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> objects;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;Object&gt; objects = getObjects(<span class="string">&quot;src/main/java/top/parak/factoryMethod/pattern/config.xml&quot;</span>);</span><br><span class="line">            objects.stream().forEach( o -&gt; &#123;</span><br><span class="line">                AbstractFactory factory = (AbstractFactory) o;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    factory.produce().show();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    log.error(e.getMessage());</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;P&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡äº§å“</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">product</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“äº§å“1</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteProduct1</span> <span class="keyword">implements</span> <span class="title">product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteProduct1.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“äº§å“1å±•ç¤º...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“äº§å“2</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteProduct2</span> <span class="keyword">implements</span> <span class="title">product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteProduct2.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“äº§å“2å±•ç¤º...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“äº§å“3</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteProduct3</span> <span class="keyword">implements</span> <span class="title">product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteProduct3.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“äº§å“3å±•ç¤º...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡å·¥å‚</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AbstractFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> product <span class="title">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“å·¥å‚1</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteFactory1</span> <span class="keyword">implements</span> <span class="title">AbstractFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteFactory1.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> product <span class="title">produce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“å·¥å‚1ç”Ÿäº§ä¸­...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;===&gt;äº§å“1ç”Ÿäº§å®Œæˆ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcreteProduct1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“å·¥å‚2</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteFactory2</span> <span class="keyword">implements</span> <span class="title">AbstractFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteFactory2.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> product <span class="title">produce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“å·¥å‚2ç”Ÿäº§ä¸­...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;===&gt;äº§å“2ç”Ÿäº§å®Œæˆ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcreteProduct2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“å·¥å‚3</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteFactory3</span> <span class="keyword">implements</span> <span class="title">AbstractFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteFactory3.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> product <span class="title">produce</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“å·¥å‚3ç”Ÿäº§ä¸­...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;===&gt;äº§å“3ç”Ÿäº§å®Œæˆ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConcreteProduct3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>config.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">config</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">className</span>&gt;</span>ConcreteFactory1<span class="tag">&lt;/<span class="name">className</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">className</span>&gt;</span>ConcreteFactory2<span class="tag">&lt;/<span class="name">className</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">className</span>&gt;</span>ConcreteFactory3<span class="tag">&lt;/<span class="name">className</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">2020-10-17 11:25:34 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory1] [thread: main] [FactoryMethod.java: 143] - å…·ä½“å·¥å‚1ç”Ÿäº§ä¸­...</span><br><span class="line">2020-10-17 11:25:35 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory1] [thread: main] [FactoryMethod.java: 149] - ===&gt;äº§å“1ç”Ÿäº§å®Œæˆ</span><br><span class="line">2020-10-17 11:25:35 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteProduct1] [thread: main] [FactoryMethod.java: 98] - å…·ä½“äº§å“1å±•ç¤º...</span><br><span class="line">2020-10-17 11:25:35 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory2] [thread: main] [FactoryMethod.java: 162] - å…·ä½“å·¥å‚2ç”Ÿäº§ä¸­...</span><br><span class="line">2020-10-17 11:25:36 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory2] [thread: main] [FactoryMethod.java: 168] - ===&gt;äº§å“2ç”Ÿäº§å®Œæˆ</span><br><span class="line">2020-10-17 11:25:36 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteProduct2] [thread: main] [FactoryMethod.java: 110] - å…·ä½“äº§å“2å±•ç¤º...</span><br><span class="line">2020-10-17 11:25:36 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory3] [thread: main] [FactoryMethod.java: 181] - å…·ä½“å·¥å‚3ç”Ÿäº§ä¸­...</span><br><span class="line">2020-10-17 11:25:37 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory3] [thread: main] [FactoryMethod.java: 187] - ===&gt;äº§å“3ç”Ÿäº§å®Œæˆ</span><br><span class="line">2020-10-17 11:25:37 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteProduct3] [thread: main] [FactoryMethod.java: 122] - å…·ä½“äº§å“3å±•ç¤º...</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-5-æŠ½è±¡å·¥å‚æ¨¡å¼-Abstract-Factory"><a href="#2-5-æŠ½è±¡å·¥å‚æ¨¡å¼-Abstract-Factory" class="headerlink" title="2.5 æŠ½è±¡å·¥å‚æ¨¡å¼-Abstract Factory"></a>2.5 æŠ½è±¡å·¥å‚æ¨¡å¼-Abstract Factory</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼ï¼šä¸€ä¸ªå·¥å‚åªè´Ÿè´£ä¸€ç±»äº§å“çš„ç”Ÿäº§ï¼Œåƒå°ä½œåŠï¼Œç”µå™¨å‚åªç”Ÿäº§ç”µé£æ‰‡ã€‚<br>æŠ½è±¡å·¥å‚æ¨¡å¼ï¼šä¸€ä¸ªå·¥å‚è´Ÿè´£å¤šç§ç›¸å…³äº§å“çš„ç”Ÿäº§ï¼Œåƒç»¼åˆå‹å·¥å‚ï¼Œç”µå™¨å‚ç”Ÿäº§ç”µè§†æœºã€ç©ºè°ƒå’Œå†°ç®±ç­‰ã€‚</p>
<p>æŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯å·¥å‚æ–¹æ³•æ¨¡å¼çš„å‡çº§ç‰ˆæœ¬ï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼åªç”Ÿäº§ä¸€ä¸ªç­‰çº§çš„äº§å“ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼å¯ç”Ÿäº§å¤šä¸ªç­‰çº§çš„äº§å“ã€‚</p>
<blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ä¸€ç§ä¸ºè®¿é—®ç±»æä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç»„ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£ï¼Œä¸”è®¿é—®ç±»æ— é¡»æŒ‡å®šæ‰€è¦äº§å“çš„å…·ä½“ç±»å°±èƒ½å¾—åˆ°åŒæ—çš„ä¸åŒç­‰çº§çš„äº§å“çš„æ¨¡å¼ç»“æ„ã€‚</p>
<blockquote>
<p>ä½¿ç”¨æ¡ä»¶</p>
</blockquote>
<ul>
<li>ç³»ç»Ÿä¸­æœ‰å¤šä¸ªäº§å“æ—ï¼Œæ¯ä¸ªå…·ä½“å·¥å‚åˆ›å»ºåŒä¸€æ—ä½†å±äºä¸åŒç­‰çº§ç»“æ„çš„äº§å“ã€‚</li>
<li>ç³»ç»Ÿä¸€æ¬¡åªå¯èƒ½æ¶ˆè´¹å…¶ä¸­æŸä¸€æ—äº§å“ï¼Œå³åŒæ—çš„äº§å“ä¸€èµ·ä½¿ç”¨ã€‚</li>
</ul>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<p>é™¤äº†åŒ…å«å·¥å‚æ–¹æ³•æ¨¡å¼çš„ä¼˜ç‚¹ï¼Œè¿˜æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¯ä»¥åœ¨ç±»çš„å†…éƒ¨å¯¹äº§å“æ—ä¸­ç›¸å…³è”çš„å¤šç­‰çº§äº§å“å…±åŒç®¡ç†ï¼Œè€Œä¸å¿…ä¸“é—¨å¼•å…¥å¤šä¸ªæ–°çš„ç±»æ¥è¿›è¡Œç®¡ç†ã€‚</li>
<li>å½“éœ€è¦äº§å“æ—æ—¶ï¼ŒæŠ½è±¡å·¥å‚å¯ä»¥ä¿è¯å®¢æˆ·ç«¯å§‹ç»ˆåªä½¿ç”¨åŒä¸€ä¸ªäº§å“çš„äº§å“æ—ã€‚</li>
<li>æŠ½è±¡å·¥å‚å¢å¼ºäº†ç¨‹åºçš„å¯æ‰©å±•æ€§ï¼Œå½“å¢åŠ ä¸€ä¸ªæ–°çš„äº§å“æ—æ—¶ï¼Œä¸éœ€è¦ä¿®æ”¹åŸä»£ç ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<p>å½“äº§å“æ—ä¸­éœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„äº§å“æ—¶ï¼Œæ‰€æœ‰çš„å·¥å‚ç±»éƒ½éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚å¢åŠ äº†ç³»ç»Ÿçš„æŠ½è±¡æ€§å’Œç†è§£éš¾åº¦ã€‚</p>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡å·¥å‚(Abstract Factory)ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ¥å£ï¼Œå®ƒåŒ…å«å¤šä¸ªåˆ›å»ºäº§å“çš„æ–¹æ³•ï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªä¸åŒç­‰çº§çš„äº§å“ã€‚</li>
<li>å…·ä½“å·¥å‚(Concrete Factory)ï¼šä¸»è¦æ˜¯å®ç°æŠ½è±¡å·¥å‚ä¸­çš„å¤šä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆå…·ä½“äº§å“çš„åˆ›å»ºã€‚</li>
<li>æŠ½è±¡äº§å“(Abstract Product)ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼æœ‰å¤šä¸ªæŠ½è±¡äº§å“ã€‚</li>
<li>å…·ä½“äº§å“(Concrete Product)ï¼šå®ç°äº†æŠ½è±¡äº§å“è§’è‰²æ‰€å®šä¹‰çš„æ¥å£ï¼Œç”±å…·ä½“å·¥å‚æ¥åˆ›å»ºï¼Œå®ƒåŒå…·ä½“å·¥å‚ä¹‹é—´æ˜¯å¤šå¯¹ä¸€çš„å…³ç³»ã€‚</li>
</ul>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.abstractFactory.example;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.abstractFactory.example &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Farm &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: æŠ½è±¡å·¥å‚æ¨¡å¼æ¨¡æ‹Ÿå†œåœº &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> javax.swing.border.TitledBorder;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.event.ActionEvent;</span><br><span class="line"><span class="keyword">import</span> java.awt.event.ActionListener;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å†œåœºæµ‹è¯•ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FarmDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> JFrame frame = <span class="keyword">new</span> JFrame(<span class="string">&quot;FarmDemo&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> JDesktopPane desktopPane = <span class="keyword">new</span> JDesktopPane();</span><br><span class="line">    <span class="keyword">private</span> JPanel contentPane = (JPanel) frame.getContentPane();</span><br><span class="line">    <span class="keyword">private</span> JPanel leftPanel = <span class="keyword">new</span> JPanel();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ImageIcon backIcon = <span class="keyword">new</span> ImageIcon(<span class="string">&quot;img/Farm.jpg&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JLabel rightLabel = <span class="keyword">new</span> JLabel(backIcon);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JLabel tipLabel = <span class="keyword">new</span> JLabel(<span class="string">&quot;é€‰æ‹©äº§å“&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JButton produceButton = <span class="keyword">new</span> JButton(<span class="string">&quot;å¼€å§‹ç”Ÿäº§&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Font font = <span class="keyword">new</span> Font(<span class="string">&quot;å¾®è½¯é›…é»‘&quot;</span>, Font.PLAIN, <span class="number">20</span>);</span><br><span class="line">    <span class="keyword">private</span> JComboBox&lt;String&gt; productComboBox = <span class="keyword">new</span> JComboBox&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> JTextArea textArea = <span class="keyword">new</span> JTextArea();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AbstractFarm baoXingFarm = <span class="keyword">new</span> BaoXingFarm();</span><br><span class="line">    <span class="keyword">private</span> AbstractFarm zhouQiaoFarm = <span class="keyword">new</span> ZhouQiaoFarm();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FarmDemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        contentPane.setOpaque(<span class="keyword">false</span>);</span><br><span class="line">        contentPane.setLayout(<span class="keyword">null</span>);</span><br><span class="line">        rightLabel.setBounds(<span class="number">300</span>, <span class="number">0</span>, backIcon.getIconWidth(), backIcon.getIconHeight());</span><br><span class="line">        desktopPane.setLayout(<span class="keyword">null</span>);</span><br><span class="line">        desktopPane.add(rightLabel, <span class="keyword">new</span> Integer(Integer.MIN_VALUE));</span><br><span class="line">        leftPanel.setBackground(Color.CYAN);</span><br><span class="line">        leftPanel.setBounds(<span class="number">0</span>, <span class="number">0</span>, <span class="number">300</span>, <span class="number">420</span>);</span><br><span class="line">        desktopPane.add(leftPanel);</span><br><span class="line"></span><br><span class="line">        leftPanel.setLayout(<span class="keyword">null</span>);</span><br><span class="line">        tipLabel.setFont(font);</span><br><span class="line">        tipLabel.setBounds(<span class="number">5</span>, <span class="number">10</span>, <span class="number">90</span>, <span class="number">30</span>);</span><br><span class="line">        leftPanel.add(tipLabel);</span><br><span class="line">        String[] products = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;é©¬&quot;</span>, <span class="string">&quot;ç‰›&quot;</span>, <span class="string">&quot;é’èœ&quot;</span>, <span class="string">&quot;ç™½èœ&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (String product : products) &#123;</span><br><span class="line">            productComboBox.addItem(product);</span><br><span class="line">        &#125;</span><br><span class="line">        productComboBox.setFont(font);</span><br><span class="line">        produceButton.setFont(font);</span><br><span class="line">        productComboBox.setBounds(<span class="number">90</span>, <span class="number">10</span>, <span class="number">80</span>, <span class="number">30</span>);</span><br><span class="line">        leftPanel.add(productComboBox);</span><br><span class="line">        produceButton.setBounds(<span class="number">180</span>, <span class="number">10</span>, <span class="number">115</span>, <span class="number">30</span>);</span><br><span class="line">        leftPanel.add(produceButton);</span><br><span class="line">        produceButton.addActionListener(<span class="keyword">new</span> ProductAction());</span><br><span class="line"></span><br><span class="line">        textArea.setFont(<span class="keyword">new</span> Font(<span class="string">&quot;å¾®è½¯é›…é»‘&quot;</span>, Font.PLAIN, <span class="number">14</span>));</span><br><span class="line">        JScrollPane scrollPane = <span class="keyword">new</span> JScrollPane(textArea);</span><br><span class="line">        scrollPane.setBounds(<span class="number">10</span>, <span class="number">50</span>, <span class="number">280</span>, <span class="number">360</span>);</span><br><span class="line">        scrollPane.setBorder(<span class="keyword">new</span> TitledBorder(<span class="string">&quot;ç”Ÿäº§æ—¥å¿—&quot;</span>));</span><br><span class="line">        scrollPane.getViewport().setOpaque(<span class="keyword">false</span>);</span><br><span class="line">        leftPanel.add(scrollPane);</span><br><span class="line"></span><br><span class="line">        frame.setContentPane(desktopPane);</span><br><span class="line">        frame.setBounds(<span class="number">300</span>,<span class="number">300</span>,<span class="number">1500</span>,<span class="number">500</span>);</span><br><span class="line">        frame.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ProductAction</span> <span class="keyword">implements</span> <span class="title">ActionListener</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">            JInternalFrame internalFrame = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">switch</span> (productComboBox.getSelectedItem().toString()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;é©¬&quot;</span>:</span><br><span class="line">                    internalFrame = zhouQiaoFarm.produceAnimalProduct().showImage();</span><br><span class="line">                    textArea.append(getTime() + <span class="string">&quot; å‘¨æ¡¥å†œåœºï¼šæ–°é©¬å‡ºç”Ÿ\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;ç‰›&quot;</span>:</span><br><span class="line">                    internalFrame = baoXingFarm.produceAnimalProduct().showImage();</span><br><span class="line">                    textArea.append(getTime() + <span class="string">&quot; å®å…´å†œåœºï¼šæ–°ç‰›å‡ºç”Ÿ\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;é’èœ&quot;</span>:</span><br><span class="line">                    internalFrame = baoXingFarm.producePlantProduct().showImage();</span><br><span class="line">                    textArea.append(getTime() + <span class="string">&quot; å®å…´å†œåœºï¼šé’èœå‡ºç”Ÿ\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;ç™½èœ&quot;</span>:</span><br><span class="line">                    internalFrame = zhouQiaoFarm.producePlantProduct().showImage();</span><br><span class="line">                    textArea.append(getTime() + <span class="string">&quot; å‘¨æ¡¥å†œåœºï¼šç™½èœå‡ºç”Ÿ\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            internalFrame.setBounds(index + <span class="number">300</span>, <span class="number">100</span>, <span class="number">300</span>, <span class="number">350</span>);</span><br><span class="line">            desktopPane.add(internalFrame);</span><br><span class="line">            index = (index + <span class="number">300</span>) % <span class="number">1200</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> String <span class="title">getTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(<span class="keyword">new</span> Date());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> FarmDemo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡äº§å“ï¼šåŠ¨ç‰©ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AnimalProduct</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JInternalFrame <span class="title">showImage</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡äº§å“ï¼šæ¤ç‰©ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">PlantProduct</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JInternalFrame <span class="title">showImage</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     åŠ¨ç‰©äº§å“å±•ç¤ºçª—å£</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimalFrame</span> <span class="keyword">extends</span> <span class="title">JInternalFrame</span> <span class="keyword">implements</span> <span class="title">AnimalProduct</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnimalFrame</span><span class="params">(String animalName, String imagePath)</span> </span>&#123;</span><br><span class="line">        Container contentPane = getContentPane();</span><br><span class="line">        JPanel panel = <span class="keyword">new</span> JPanel();</span><br><span class="line">        panel.setLayout(<span class="keyword">new</span> GridLayout(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">        panel.setBorder(BorderFactory.createTitledBorder(<span class="string">&quot;åŠ¨ç‰©ï¼š&quot;</span> + animalName));</span><br><span class="line">        JScrollPane scrollPane = <span class="keyword">new</span> JScrollPane(panel);</span><br><span class="line">        contentPane.add(scrollPane, BorderLayout.CENTER);</span><br><span class="line">        JLabel label = <span class="keyword">new</span> JLabel(<span class="keyword">new</span> ImageIcon(imagePath));</span><br><span class="line">        panel.add(label);</span><br><span class="line">        pack();</span><br><span class="line">        setTitle(animalName);</span><br><span class="line">        setVisible(<span class="keyword">false</span>);</span><br><span class="line">        setClosable(<span class="keyword">true</span>);</span><br><span class="line">        setIconifiable(<span class="keyword">true</span>);</span><br><span class="line">        setResizable(<span class="keyword">false</span>);</span><br><span class="line">        setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JInternalFrame <span class="title">showImage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æ¤ç‰©äº§å“å±•ç¤ºçª—å£</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlantFrame</span> <span class="keyword">extends</span> <span class="title">JInternalFrame</span> <span class="keyword">implements</span> <span class="title">PlantProduct</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PlantFrame</span><span class="params">(String plantName, String imagePath)</span> </span>&#123;</span><br><span class="line">        Container contentPane = getContentPane();</span><br><span class="line">        JPanel panel = <span class="keyword">new</span> JPanel();</span><br><span class="line">        panel.setLayout(<span class="keyword">new</span> GridLayout(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">        panel.setBorder(BorderFactory.createTitledBorder(<span class="string">&quot;æ¤ç‰©ï¼š&quot;</span> + plantName));</span><br><span class="line">        JScrollPane scrollPane = <span class="keyword">new</span> JScrollPane(panel);</span><br><span class="line">        contentPane.add(scrollPane, BorderLayout.CENTER);</span><br><span class="line">        JLabel label = <span class="keyword">new</span> JLabel(<span class="keyword">new</span> ImageIcon(imagePath));</span><br><span class="line">        panel.add(label);</span><br><span class="line">        pack();</span><br><span class="line">        setTitle(plantName);</span><br><span class="line">        setVisible(<span class="keyword">false</span>);</span><br><span class="line">        setClosable(<span class="keyword">true</span>);</span><br><span class="line">        setIconifiable(<span class="keyword">true</span>);</span><br><span class="line">        setResizable(<span class="keyword">false</span>);</span><br><span class="line">        setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JInternalFrame <span class="title">showImage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“åŠ¨ç‰©äº§å“ï¼šé©¬ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Horse</span> <span class="keyword">extends</span> <span class="title">AnimalFrame</span>  </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Horse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">&quot;é©¬-ğŸ´&quot;</span>, <span class="string">&quot;img/Horse.jpg&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“åŠ¨ç‰©äº§å“ï¼šç‰›ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cattle</span> <span class="keyword">extends</span> <span class="title">AnimalFrame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cattle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">&quot;ç‰›-ğŸ®&quot;</span>, <span class="string">&quot;img/Cattle.jpg&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“æ¤ç‰©äº§å“ï¼šé’èœ</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vegetable</span> <span class="keyword">extends</span> <span class="title">PlantFrame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Vegetable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">&quot;é’èœ&quot;</span>, <span class="string">&quot;img/Vegetable.jpg&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“æ¤ç‰©äº§å“ï¼šç™½èœ</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cabbage</span> <span class="keyword">extends</span> <span class="title">PlantFrame</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cabbage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">&quot;ç™½èœ&quot;</span>, <span class="string">&quot;img/Cabbage.jpg&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡å·¥å‚ï¼šå†œåœºç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AbstractFarm</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> AnimalProduct <span class="title">produceAnimalProduct</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlantProduct <span class="title">producePlantProduct</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“å·¥å‚ï¼šå®å…´å†œåœº</span></span><br><span class="line"><span class="comment"> *     ç”Ÿäº§äº§å“ï¼šç‰›ã€é’èœ</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaoXingFarm</span> <span class="keyword">implements</span> <span class="title">AbstractFarm</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(BaoXingFarm.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AnimalProduct <span class="title">produceAnimalProduct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å®å…´å†œåœº===&gt;æ–°ç‰›å‡ºç”Ÿ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Cattle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlantProduct <span class="title">producePlantProduct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å®å…´å†œåœº===&gt;é’èœé•¿æˆ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Vegetable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“å†œåœºï¼šå‘¨æ¡¥å†œåœº</span></span><br><span class="line"><span class="comment"> *     ç”Ÿäº§äº§å“ï¼šé©¬ã€ç™½èœ</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZhouQiaoFarm</span> <span class="keyword">implements</span> <span class="title">AbstractFarm</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ZhouQiaoFarm.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AnimalProduct <span class="title">produceAnimalProduct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å‘¨æ¡¥å†œåœº===&gt;æ–°é©¬å‡ºç”Ÿ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Horse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlantProduct <span class="title">producePlantProduct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å‘¨æ¡¥å†œåœº===&gt;ç™½èœé•¿æˆ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Cabbage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/41682/image-20201017185342528.png" class="" title="image-20201017185342528"><br />

<br>

<h3 id="2-6-å»ºé€ è€…æ¨¡å¼-Builder"><a href="#2-6-å»ºé€ è€…æ¨¡å¼-Builder" class="headerlink" title="2.6 å»ºé€ è€…æ¨¡å¼-Builder"></a>2.6 å»ºé€ è€…æ¨¡å¼-Builder</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„é€ ä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿åŒæ ·çš„æ„é€ è¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å°è£…æ€§å¥½ï¼Œæ„å»ºå’Œè¡¨ç¤ºåˆ†ç¦»ã€‚</li>
<li>æ‰©å±•æ€§å¥½ï¼Œå„ä¸ªå…·ä½“çš„å»ºé€ è€…ç›¸äº’ç‹¬ç«‹ï¼Œæœ‰åˆ©äºç³»ç»Ÿçš„è§£è€¦ã€‚</li>
<li>å®¢æˆ·ç«¯ä¸å¿…çŸ¥é“äº§å“å†…éƒ¨ç»„æˆçš„ç»†èŠ‚ï¼Œå»ºé€ è€…å¯ä»¥å¯¹åˆ›å»ºè¿‡ç¨‹é€æ­¥ç»†åŒ–ï¼Œè€Œä¸å¯¹å…¶ä»–æ¨¡å—äº§ç”Ÿä»»ä½•å½±å“ï¼Œä¾¿äºæ§åˆ¶ç»†èŠ‚é£é™©ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>äº§å“çš„ç»„æˆéƒ¨åˆ†å¿…é¡»ç›¸åŒï¼Œè¿™é™åˆ¶äº†å…¶ä½¿ç”¨èŒƒå›´ã€‚</li>
<li>å¦‚æœäº§å“çš„å†…éƒ¨å˜åŒ–å¤æ‚ï¼Œå¦‚æœäº§å“å†…éƒ¨å‘ç”Ÿå˜åŒ–ï¼Œåˆ™å»ºé€ è€…ä¹Ÿè¦åŒæ­¥ä¿®æ”¹ï¼ŒåæœŸç»´æŠ¤æˆæœ¬è¾ƒå¤§ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li><p>äº§å“è§’è‰²(Product)ï¼šåŒ…å«å¤šä¸ªç»„ä»¶çš„å¤æ‚å¯¹è±¡ï¼Œç”±å…·ä½“å»ºé€ è€…æ¥åˆ›å»ºå…¶å„ä¸ªé›¶éƒ¨ä»¶ã€‚</p>
</li>
<li><p>æŠ½è±¡å»ºé€ è€…(Abstract Builder)ï¼šåŒ…å«åˆ›å»ºäº§å“å„ä¸ªå­éƒ¨ä»¶çš„æŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œé€šå¸¸è¿˜åŒ…å«ä¸€ä¸ªè¿”å›å¤æ‚äº§å“çš„æ–¹æ³•getResult()ã€‚</p>
</li>
<li><p>å…·ä½“å»ºé€ è€…(Concrete Builder)ï¼šå®ç°æŠ½è±¡å»ºé€ è€…çš„æ¥å£ï¼Œå®Œæˆå¤æ‚äº§å“çš„å„ä¸ªéƒ¨ä»¶çš„å…·ä½“åˆ›å»ºæ–¹æ³•ã€‚</p>
</li>
<li><p>æŒ‡æŒ¥è€…(Director)ï¼šå®ƒè°ƒç”¨å»ºé€ è€…å¯¹è±¡ä¸­çš„éƒ¨ä»¶æ„é€ ä¸è£…é…æ–¹æ³•å®Œæˆå¤æ‚å¯¹è±¡çš„åˆ›å»ºï¼Œåœ¨æŒ‡æŒ¥è€…ä¸­ä¸æ¶‰åŠå…·ä½“äº§å“çš„ä¿¡æ¯ã€‚</p>
</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.builder.pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.builder.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Builder &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: å»ºé€ è€…æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuilderDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = Logger.getLogger(BuilderDemo.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Builder builder = <span class="keyword">new</span> ConcreteBuilder();</span><br><span class="line">        Director director = <span class="keyword">new</span> Director(builder);</span><br><span class="line">        Product product = director.construct();</span><br><span class="line">        log.info(product.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡äº§å“ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String componentA;</span><br><span class="line">    <span class="keyword">private</span> String componentB;</span><br><span class="line">    <span class="keyword">private</span> String componentC;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡å»ºé€ è€…</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Product product = <span class="keyword">new</span> Product();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildComponentA</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildComponentB</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildComponentC</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">getProduct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“å»ºé€ è€…</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteBuilder</span> <span class="keyword">extends</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildComponentA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        product.setComponentA(<span class="string">&quot;å»ºé€ é›¶ä»¶A&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildComponentB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        product.setComponentB(<span class="string">&quot;å»ºé€ é›¶ä»¶B&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildComponentC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        product.setComponentC(<span class="string">&quot;å»ºé€ é›¶ä»¶C&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;P&gt;</span></span><br><span class="line"><span class="comment"> *     æŒ‡æŒ¥è€…</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Director</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Builder builder;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Director</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.builder = builder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        builder.buildComponentA();</span><br><span class="line">        builder.buildComponentB();</span><br><span class="line">        builder.buildComponentC();</span><br><span class="line">        <span class="keyword">return</span> builder.getProduct();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-7-ä»£ç†æ¨¡å¼-Proxy"><a href="#2-7-ä»£ç†æ¨¡å¼-Proxy" class="headerlink" title="2.7 ä»£ç†æ¨¡å¼-Proxy"></a>2.7 ä»£ç†æ¨¡å¼-Proxy</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ç”±äºæŸäº›åŸå› éœ€è¦ç»™æŸå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹è¯¥å¯¹è±¡çš„è®¿é—®ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>ä»£ç†æ¨¡å¼åœ¨å®¢æˆ·ç«¯å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸€ä¸ªä¸­ä»‹ä½œç”¨å’Œä¿æŠ¤ç›®æ ‡å¯¹è±¡çš„ä½œç”¨ã€‚</li>
<li>ä»£ç†å¯¹è±¡å¯ä»¥æ‰©å±•å¯¹è±¡çš„åŠŸèƒ½ã€‚</li>
<li>ä»£ç†æ¨¡å¼èƒ½å°†å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡åˆ†ç¦»ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½ç³»ç»Ÿçš„è€¦åˆåº¦ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ä»£ç†æ¨¡å¼ä¼šé€ æˆç³»ç»Ÿè®¾è®¡ä¸­ç±»çš„æ•°é‡å¢åŠ ã€‚</li>
<li>ä»£ç†æ¨¡å¼èƒ½å°†å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡ä¹‹é—´å¢åŠ ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä¼šé€ æˆè¯·æ±‚å¤„ç†é€Ÿåº¦å˜æ…¢ã€‚</li>
<li>å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡ä¸»é¢˜(Subject)ï¼šé€šè¿‡æ¥å£æˆ–æŠ½è±¡ç±»å£°æ˜çœŸå®ä¸»é¢˜å’Œä»£ç†å¯¹è±¡å®ç°çš„ä¸šåŠ¡æ–¹æ³•ã€‚</li>
<li>çœŸå®ä¸»é¢˜(Real Subject)ï¼šå®ç°äº†æŠ½è±¡ä¸»é¢˜ä¸­çš„å…·ä½“ä¸šåŠ¡ï¼Œæ˜¯ä»£ç†å¯¹è±¡é”ä»£è¡¨çš„çœŸå®å¯¹è±¡ï¼Œæ˜¯æœ€ç»ˆè¦å¼•ç”¨çš„å¯¹è±¡ã€‚</li>
<li>ä»£ç†(Proxy)ï¼šæä¾›äº†ä¸çœŸå®ä¸»é¢˜ç›¸åŒçš„æ¥å£ï¼Œå…¶å†…éƒ¨å«æœ‰å¯¹çœŸå®ä¸»é¢˜çš„å¼•ç”¨ï¼Œå®ƒå¯ä»¥è®¿é—®ã€æ§åˆ¶æˆ–æ‰©å±•çœŸå®ä¸»é¢˜çš„åŠŸèƒ½ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.proxy.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.proxy.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Proxy &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: ä»£ç†æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Proxy proxy = <span class="keyword">new</span> Proxy();</span><br><span class="line">        proxy.request();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡ä¸»é¢˜</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     çœŸå®ä¸»é¢˜</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(RealSubject.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;è®¿é—®çœŸå®ä¸»é¢˜...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ä»£ç†</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(Proxy.class);</span><br><span class="line">    <span class="keyword">private</span> RealSubject realSubject;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (realSubject == <span class="keyword">null</span>) &#123;</span><br><span class="line">            realSubject = <span class="keyword">new</span> RealSubject();</span><br><span class="line">            preHandler();</span><br><span class="line">            realSubject.request();</span><br><span class="line">            postHandler();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;è®¿é—®çœŸå®ä¸»é¢˜ä¹‹å‰çš„é¢„å¤„ç†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;è®¿é—®çœŸå®ä¸»é¢˜ä¹‹åçš„åç»­å¤„ç†&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-8-é€‚é…å™¨æ¨¡å¼-Adapter"><a href="#2-8-é€‚é…å™¨æ¨¡å¼-Adapter" class="headerlink" title="2.8 é€‚é…å™¨æ¨¡å¼-Adapter"></a>2.8 é€‚é…å™¨æ¨¡å¼-Adapter</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ï¼Œä½¿å¾—åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»èƒ½ä¸€èµ·å·¥ä½œ</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å®¢æˆ·ç«¯é€šè¿‡é€‚é…å™¨å¯ä»¥é€æ˜åœ°è°ƒç”¨ç›®æ ‡æ¥å£ã€‚</li>
<li>å¤ç”¨äº†ç°å­˜çš„ç±»ï¼Œç¨‹åºå‘˜ä¸éœ€è¦ä¿®æ”¹åŸæœ‰ä»£ç è€Œå¤ç”¨ç°æœ‰çš„é€‚é…è€…ç±»ã€‚</li>
<li>å°†ç›®æ ‡ç±»ä¸é€‚é…è€…ç±»è§£è€¦ï¼Œè§£å†³äº†ç›®æ ‡ç±»å’Œé€‚é…è€…ç±»æ¥å£ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</li>
<li>åœ¨å¾ˆå¤šä¸šåŠ¡åœºæ™¯ä¸­ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>é€‚é…å™¨ç¼–å†™è¿‡ç¨‹éœ€è¦ç»“åˆä¸šåŠ¡åœºæ™¯å…¨é¢è€ƒè™‘ï¼Œå¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚</li>
<li>å¢åŠ ä»£ç é˜…è¯»éš¾åº¦ï¼Œè¿‡å¤šä½¿ç”¨é€‚é…å™¨ä¼šä½¿ç³»ç»Ÿä»£ç å˜å¾—å‡Œä¹±ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>ç›®æ ‡æ¥å£(Target)ï¼šå½“å‰ç³»ç»Ÿä¸šåŠ¡æ‰€æœŸå¾…çš„æ¥å£ï¼Œå¯ä»¥æ˜¯æŠ½è±¡ç±»æˆ–è€…æ¥å£ã€‚</li>
<li>é€‚é…è€…ç±»(Adaptee)ï¼šè¢«è®¿é—®å’Œé€‚é…çš„ç°å­˜ç»„ä»¶åº“ä¸­çš„ç»„ä»¶æ¥å£ã€‚</li>
<li>é€‚é…å™¨ç±»(Adapter)ï¼šè½¬æ¢å™¨ï¼Œé€šè¿‡ç»§æ‰¿æˆ–å¼•ç”¨é€‚é…è€…çš„å¯¹è±¡ï¼ŒæŠŠé€‚é…è€…æ¥å£è½¬æ¢ç›®æ ‡æ¥å£ï¼Œè®©å®¢æˆ·ç«¯ç›®æ ‡æ¥å£çš„æ ¼å¼è®¿é—®é€‚é…è€…ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.adapter.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.adapter.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Adapter &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: é€‚é…å™¨æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;P&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdapterDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Target target = <span class="keyword">new</span> Adapter();</span><br><span class="line">        target.request();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ç›®æ ‡æ¥å£</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Target</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     é€‚é…è€…æ¥å£</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Adaptee</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(Adaptee.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">specificRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;é€‚é…è€…ä¸­çš„ä¸šåŠ¡ä»£ç è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     é€‚é…å™¨ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">extends</span> <span class="title">Adaptee</span> <span class="keyword">implements</span> <span class="title">Target</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        specificRequest();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-9-æ¡¥æ¥æ¨¡å¼-Bridge"><a href="#2-9-æ¡¥æ¥æ¨¡å¼-Bridge" class="headerlink" title="2.9 æ¡¥æ¥æ¨¡å¼-Bridge"></a>2.9 æ¡¥æ¥æ¨¡å¼-Bridge</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å°†æŠ½è±¡ä¸å®ç°åˆ†ç¦»ï¼Œä½¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹å˜åŒ–ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>æŠ½è±¡ä¸å®ç°åˆ†ç¦»ï¼Œæ‰©å±•èƒ½åŠ›å¼ºã€‚</li>
<li>ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li>
<li>ç¬¦åˆåˆæˆå¤ç”¨åŸåˆ™ã€‚</li>
<li>å…¶å®ç°ç»†èŠ‚å¯¹å®¢æˆ·é€æ˜ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ç”±äºèšåˆå…³ç³»å»ºç«‹åœ¨æŠ½è±¡å±‚ï¼Œè¦æ±‚å¼€å‘è€…å¯¹æŠ½è±¡åŒ–è¿›è¡Œè®¾è®¡ä¸ç¼–ç¨‹ï¼Œèƒ½æ­£ç¡®çš„è¯†åˆ«å‡ºç³»ç»Ÿä¸­ä¸¤ä¸ªç‹¬ç«‹å˜åŒ–çš„ç»´åº¦ï¼Œè¿™å¢åŠ äº†ç³»ç»Ÿçš„ç†è§£ä¸è®¾è®¡éš¾åº¦ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡åŒ–è§’è‰²(Abstraction)ï¼šå®šä¹‰æŠ½è±¡ç±»ï¼Œå¹¶åŒ…å«ä¸€ä¸ªå¯¹å®ç°åŒ–å¯¹è±¡çš„å¼•ç”¨ã€‚</li>
<li>æ‰©å±•æŠ½è±¡åŒ–è§’è‰²(Refined Abstraction)ï¼šæ˜¯æŠ½è±¡åŒ–è§’è‰²çš„å­ç±»ï¼Œå®ç°çˆ¶ç±»ä¸­çš„ä¸šåŠ¡æ–¹æ³•ï¼Œå¹¶é€šè¿‡ç»„åˆå…³ç³»è°ƒç”¨å®ç°åŒ–è§’è‰²ä¸­çš„ä¸šåŠ¡æ–¹æ³•ã€‚</li>
<li>å®ç°åŒ–è§’è‰²(Implementor)ï¼šå®šä¹‰å®ç°åŒ–è§’è‰²çš„æ¥å£ï¼Œä¾›æ‰©å±•æŠ½è±¡åŒ–è§’è‰²è°ƒç”¨ã€‚</li>
<li>å…·ä½“å®ç°åŒ–è§’è‰²(Concrete Implementor)ï¼šç»™å‡ºå®ç°åŒ–è§’è‰²æ¥å£çš„å…·ä½“å®ç°ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.bridge.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.bridge.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Bridge &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: æ¡¥æ¥æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BridgeDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Implementor implementor = <span class="keyword">new</span> ConcreteImplementorA();</span><br><span class="line">        Abstraction abstraction = <span class="keyword">new</span> RefinedAbstraction(implementor);</span><br><span class="line">        abstraction.operation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å®ç°åŒ–è§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Implementor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationImpl</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“å®ç°åŒ–è§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteImplementorA</span> <span class="keyword">implements</span> <span class="title">Implementor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteImplementorA.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“å®ç°åŒ–è§’è‰²(Concrete Implementor)è¢«è®¿é—®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡åŒ–è§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Abstraction</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> Implementor implementor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Abstraction</span><span class="params">(Implementor implementor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.implementor = implementor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æ‰©å±•æŠ½è±¡åŒ–è§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RefinedAbstraction</span> <span class="keyword">extends</span> <span class="title">Abstraction</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(RefinedAbstraction.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">RefinedAbstraction</span><span class="params">(Implementor implementor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(implementor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ‰©å±•æŠ½è±¡åŒ–è§’è‰²(Refined Abstraction)è¢«è®¿é—®&quot;</span>);</span><br><span class="line">        implementor.operationImpl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-10-è£…é¥°æ¨¡å¼-Decorator"><a href="#2-10-è£…é¥°æ¨¡å¼-Decorator" class="headerlink" title="2.10 è£…é¥°æ¨¡å¼-Decorator"></a>2.10 è£…é¥°æ¨¡å¼-Decorator</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>åœ¨ä¸æ”¹å˜ç°æœ‰å¯¹è±¡ç»“æ„çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°ç»™è¯¥å¯¹è±¡å¢åŠ ä¸€äº›èŒè´£çš„æ¨¡å¼ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>è£…é¥°å™¨æ˜¯ç»§æ‰¿çš„æœ‰åŠ›è¡¥å……ï¼Œæ¯”ç»§æ‰¿çµæ´»ï¼Œåœ¨ä¸æ”¹å˜åŸæœ‰å¯¹è±¡çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€çš„ç»™ä¸€ä¸ªå¯¹è±¡æ‰©å±•åŠŸèƒ½ï¼Œå³æ’å³ç”¨ã€‚</li>
<li>é€šè¿‡ä½¿ç”¨ä¸ç”¨è£…é¥°ç±»åŠè¿™äº›è£…é¥°ç±»çš„æ’åˆ—ç»„åˆï¼Œå¯ä»¥å®ç°ä¸åŒæ•ˆæœã€‚</li>
<li>è£…é¥°æ¨¡å¼å®Œå…¨éµå®ˆå¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>è£…é¥°æ¨¡å¼ä¼šå¢åŠ è®¸å¤šå­ç±»ï¼Œè¿‡åº¦ä½¿ç”¨ä¼šå¢åŠ ç¨‹åºçš„å¤æ‚æ€§ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡æ„å»ºè§’è‰²(Component)ï¼šå®šä¹‰ä¸€ä¸ªæŠ½è±¡æ¥å£ä»¥è§„èŒƒå‡†å¤‡æ¥é™„åŠ è´£ä»»çš„å¯¹è±¡ã€‚</li>
<li>å…·ä½“æ„å»ºè§’è‰²(Concrete Component)ï¼šå®ç°æŠ½è±¡æ„ä»¶ï¼Œé€šè¿‡è£…é¥°è§’è‰²ä¸ºå…¶æ·»åŠ ä¸€äº›èŒè´£ã€‚</li>
<li>æŠ½è±¡è£…é¥°è§’è‰²(Decorator)ï¼šç»§æ‰¿æŠ½è±¡æ„ä»¶ï¼Œå¹¶åŒ…å«å…·ä½“æ„ä»¶çš„å®ä¾‹ï¼Œå¯ä»¥é€šè¿‡å…¶å­ç±»æ‰©å±•å…·ä½“æ„ä»¶çš„åŠŸèƒ½ã€‚</li>
<li>å…·ä½“è£…é¥°è§’è‰²(Concrete Decorator)ï¼šå®ç°æŠ½è±¡è£…é¥°çš„ç›¸å…³æ–¹æ³•ï¼Œå¹¶ç»™å…·ä½“æ„ä»¶å¯¹è±¡æ·»åŠ é™„åŠ çš„è´£ä»»ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.decorator.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.decorator.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Decorator &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: è£…é¥°æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DecoratorDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Component component1 = <span class="keyword">new</span> ConcreteComponent();</span><br><span class="line">        component1.operation();</span><br><span class="line">        Component component2 = <span class="keyword">new</span> ConcreteDecorator(component1);</span><br><span class="line">        component2.operation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡æ„ä»¶è§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“æ„ä»¶è§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteComponent</span> <span class="keyword">implements</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteComponent.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteComponent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;åˆ›å»ºå…·ä½“æ„ä»¶è§’è‰²&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;è°ƒç”¨å…·ä½“æ„ä»¶è§’è‰²çš„æ–¹æ³•operation()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡è£…é¥°è§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Decorator</span> <span class="keyword">implements</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Component component;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Decorator</span><span class="params">(Component component)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.component = component;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“è£…é¥°è§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteDecorator</span> <span class="keyword">extends</span> <span class="title">Decorator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteComponent.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteDecorator</span><span class="params">(Component component)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.operation();</span><br><span class="line">        addFunction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFunction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ä¸ºå…·ä½“æ„ä»¶è§’è‰²å¢åŠ é¢å¤–çš„åŠŸèƒ½function()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-11-å¤–è§‚æ¨¡å¼-Facade"><a href="#2-11-å¤–è§‚æ¨¡å¼-Facade" class="headerlink" title="2.11 å¤–è§‚æ¨¡å¼-Facade"></a>2.11 å¤–è§‚æ¨¡å¼-Facade</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>é€šè¿‡ä¸ºå¤šä¸ªå¤æ‚çš„å­ç³»ç»Ÿæä¾›ä¸€ä¸ªä¸€è‡´çš„æ¥å£ï¼Œè€Œä½¿è¿™äº›å­ç³»ç»Ÿæ›´åŠ å®¹æ˜“è¢«è®¿é—®ã€‚å¤–è§‚æ¨¡å¼å¯¹å¤–æœ‰ä¸€ä¸ªç»Ÿä¸€æ¥å£ï¼Œå¤–éƒ¨åº”ç”¨ç¨‹åºä¸ç”¨å…³å¿ƒå†…éƒ¨å­ç³»ç»Ÿçš„å…·ä½“ç»†èŠ‚ï¼Œè¿™æ ·ä¼šå¤§å¤§é™ä½åº”ç”¨ç¨‹åºçš„å¤æ‚åº¦ï¼Œæé«˜äº†ç¨‹åºçš„å¯ç»´æŠ¤æ€§ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>é™ä½äº†å­ç³»ç»Ÿä¸å®¢æˆ·ç«¯ä¹‹é—´çš„è€¦åˆåº¦ï¼Œä½¿å¾—å­ç³»ç»Ÿé«˜çš„å˜åŒ–ä¸ä¼šå½±å“è°ƒç”¨å®ƒçš„å®¢æˆ·ç±»ã€‚</li>
<li>å¯¹å®¢æˆ·å±è”½äº†å­ç³»ç»Ÿç»„ä»¶ï¼Œå‡å°‘äº†å®¢æˆ·å¤„ç†çš„å¯¹è±¡æ•°ç›®ï¼Œå¹¶ä½¿å¾—å­ç³»ç»Ÿä½¿ç”¨èµ·æ¥æ›´åŠ å®¹æ˜“ã€‚</li>
<li>é™ä½äº†å¤§å‹è½¯ä»¶ç³»ç»Ÿä¸­çš„ç¼–è¯‘ä¾èµ–æ€§ï¼Œç®€åŒ–äº†ç³»ç»Ÿåœ¨ä¸åŒå¹³å°ä¹‹é—´çš„ç§»æ¤è¿‡ç¨‹ï¼Œå› ä¸ºç¼–è¯‘ä¸€ä¸ªå­ç³»ç»Ÿä¸ä¼šå½±å“å…¶ä»–çš„å­ç³»ç»Ÿï¼Œä¹Ÿä¸ä¼šå½±å“å¤–è§‚å¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ä¸èƒ½å¾ˆå¥½åœ°é™åˆ¶å®¢æˆ·ä½¿ç”¨å­ç³»ç»Ÿç±»ï¼Œå¾ˆå®¹æ˜“å¸¦æ¥æœªçŸ¥é£é™©ã€‚</li>
<li>å¢åŠ æ–°çš„å­ç³»ç»Ÿå¯èƒ½éœ€è¦ä¿®æ”¹å¤–è§‚ç±»æˆ–å®¢æˆ·ç«¯çš„æºä»£ç ï¼Œè¿èƒŒäº†å¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>å¤–è§‚è§’è‰²(Facade)ï¼šä¸ºå¤šä¸ªå­ç³»ç»Ÿå¯¹å¤–æä¾›ä¸€ä¸ªå…±åŒçš„æ¥å£ã€‚</li>
<li>å­ç³»ç»Ÿè§’è‰²(Sub System)ï¼šå®ç°ç³»ç»Ÿçš„éƒ¨åˆ†åŠŸèƒ½ï¼Œå®¢æˆ·å¯ä»¥é€šè¿‡å¤–è§‚è§’è‰²è®¿é—®å®ƒã€‚</li>
<li>å®¢æˆ·è§’è‰²(Client)ï¼šé€šè¿‡ä¸€ä¸ªå¤–è§‚è§’è‰²è®¿é—®å„ä¸ªå­ç³»ç»Ÿçš„åŠŸèƒ½ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.facade.pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/P&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.facade.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Facade &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: å¤–è§‚æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FacadeDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Facade facade = <span class="keyword">new</span> Facade();</span><br><span class="line">        facade.method();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Facade</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SubSys1 subSys1 = <span class="keyword">new</span> SubSys1();</span><br><span class="line">    <span class="keyword">private</span> SubSys2 subSys2 = <span class="keyword">new</span> SubSys2();</span><br><span class="line">    <span class="keyword">private</span> SubSys3 subSys3 = <span class="keyword">new</span> SubSys3();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        subSys1.method1();</span><br><span class="line">        subSys2.method2();</span><br><span class="line">        subSys3.method3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubSys1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(SubSys1.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å­ç³»ç»Ÿ1çš„method1è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubSys2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(SubSys2.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å­ç³»ç»Ÿ2çš„method2è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubSys3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(SubSys3.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å­ç³»ç»Ÿ3çš„method3è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-12-äº«å…ƒæ¨¡å¼-Flyweight"><a href="#2-12-äº«å…ƒæ¨¡å¼-Flyweight" class="headerlink" title="2.12 äº«å…ƒæ¨¡å¼-Flyweight"></a>2.12 äº«å…ƒæ¨¡å¼-Flyweight</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>è¿ç”¨å…±äº«æŠ€æœ¯æ¥æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦å¯¹è±¡çš„å¤ç”¨ã€‚</p>
<blockquote>
<p>ä¼˜åŠ¿</p>
</blockquote>
<p>ç›¸åŒå¯¹è±¡åªä¿å­˜ä¸€ä»½ï¼Œè¿™é™ä½äº†ç³»ç»Ÿä¸­å¯¹è±¡çš„æ•°é‡ï¼Œä»è€Œé™ä½äº†ç³»ç»Ÿä¸­ç»†ç²’åº¦å¯¹è±¡ç»™å†…å­˜å¸¦æ¥çš„å‹åŠ›ã€‚</p>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ä¸ºäº†ä½¿å¯¹è±¡å¯ä»¥å…±äº«ï¼Œéœ€è¦å°†ä¸€äº›ä¸èƒ½å…±äº«çš„çŠ¶æ€å¤–éƒ¨åŒ–ï¼Œè¿™å°†å¢åŠ ç¨‹åºçš„å¤æ‚æ€§ã€‚</li>
<li>è¯»å–äº«å…ƒæ¨¡å¼çš„å¤–éƒ¨çŠ¶æ€ä¼šä½¿å¾—è¿è¡Œæ—¶é—´ç¨å¾®å˜é•¿ã€‚</li>
</ul>
<blockquote>
<p>çŠ¶æ€</p>
</blockquote>
<ul>
<li>å†…éƒ¨çŠ¶æ€ï¼šä¸ä¼šéšç€ç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜çš„å¯å…±äº«éƒ¨åˆ†ã€‚</li>
<li>å¤–éƒ¨çŠ¶æ€ï¼šéšç€ç¯å¢ƒæ”¹å˜è€Œæ”¹å˜çš„ä¸å¯ä»¥å…±äº«çš„éƒ¨åˆ†ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡äº«å…ƒè§’è‰²(Flyweight)ï¼šæ‰€æœ‰çš„å…·ä½“äº«å…ƒç±»çš„åŸºç±»ï¼Œä¸ºå…·ä½“äº«å…ƒè§„èŒƒéœ€è¦å®ç°çš„å…¬å…±æ¥å£ï¼Œéäº«å…ƒçš„å¤–éƒ¨çŠ¶æ€ä»¥å‚æ•°çš„å½¢å¼é€šè¿‡æ–¹æ³•ä¼ å…¥ã€‚</li>
<li>å…·ä½“äº«å…ƒè§’è‰²(Concrete Flyweight)ï¼šå®ç°æŠ½è±¡äº«å…ƒè§’è‰²ä¸­æ‰€è§„å®šçš„æ¥å£ã€‚</li>
<li>éäº«å…ƒè§’è‰²(Unsharable Flyweight)ï¼šæ˜¯ä¸å¯ä»¥å…±äº«çš„å¤–éƒ¨çŠ¶æ€ï¼Œå®ƒä»¥å‚æ•°çš„å½¢å¼æ³¨å…¥å…·ä½“äº«å…ƒçš„ç›¸å…³æ–¹æ³•ä¸­ã€‚</li>
<li>äº«å…ƒå·¥å‚è§’è‰²(Flyweight Factory)ï¼šè´Ÿè´£åˆ›å»ºå’Œç®¡ç†äº«å…ƒè§’è‰²ã€‚å½“å®¢æˆ·å¯¹è±¡è¯·æ±‚çš„æ—¶å€™ï¼Œäº«å…ƒå·¥å‚æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨ç¬¦åˆè¦æ±‚çš„äº«å…ƒå¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨åˆ™æä¾›ç»™å®¢æˆ·ï¼›å¦‚æœä¸å­˜åœ¨çš„è¯ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº«å…ƒå¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.flyweight.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.flyweight.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Flyweight &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: äº«å…ƒæ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Getter;</span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;P&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlyweightDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FlyweightFactory factory = <span class="keyword">new</span> FlyweightFactory();</span><br><span class="line">        Flyweight f1 = factory.getFlyweight(<span class="string">&quot;K&quot;</span>);</span><br><span class="line">        Flyweight f2 = factory.getFlyweight(<span class="string">&quot;H&quot;</span>);</span><br><span class="line">        Flyweight f3 = factory.getFlyweight(<span class="string">&quot;I&quot;</span>);</span><br><span class="line">        Flyweight f4 = factory.getFlyweight(<span class="string">&quot;G&quot;</span>);</span><br><span class="line">        Flyweight f5 = factory.getFlyweight(<span class="string">&quot;H&quot;</span>);</span><br><span class="line">        f1.operation(<span class="keyword">new</span> UnsharedConcreteFlyweight(<span class="string">&quot;ç¬¬ä¸€æ¬¡è°ƒç”¨K&quot;</span>));</span><br><span class="line">        f2.operation(<span class="keyword">new</span> UnsharedConcreteFlyweight(<span class="string">&quot;ç¬¬ä¸€æ¬¡è°ƒç”¨H&quot;</span>));</span><br><span class="line">        f3.operation(<span class="keyword">new</span> UnsharedConcreteFlyweight(<span class="string">&quot;ç¬¬ä¸€æ¬¡è°ƒç”¨I&quot;</span>));</span><br><span class="line">        f4.operation(<span class="keyword">new</span> UnsharedConcreteFlyweight(<span class="string">&quot;ç¬¬ä¸€æ¬¡è°ƒç”¨G&quot;</span>));</span><br><span class="line">        f5.operation(<span class="keyword">new</span> UnsharedConcreteFlyweight(<span class="string">&quot;ç¬¬äºŒæ¬¡è°ƒç”¨H&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     éäº«å…ƒè§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsharedConcreteFlyweight</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡äº«å…ƒè§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Flyweight</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(UnsharedConcreteFlyweight concreteFlyweight)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“äº«å…ƒè§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteFlyweight</span> <span class="keyword">implements</span> <span class="title">Flyweight</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteFlyweight.class);</span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteFlyweight</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“äº«å…ƒ&quot;</span> + key + <span class="string">&quot;è¢«åˆ›å»º&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(UnsharedConcreteFlyweight concreteFlyweight)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“äº«å…ƒ&quot;</span> + key + <span class="string">&quot;è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;éäº«å…ƒä¿¡æ¯æ˜¯ï¼š&quot;</span> + concreteFlyweight.getInfo());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     äº«å…ƒå·¥å‚è§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlyweightFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(FlyweightFactory.class);</span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, Flyweight&gt; flyweightMap = <span class="keyword">new</span> HashMap&lt;String, Flyweight&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flyweight <span class="title">getFlyweight</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Flyweight flyweight = (Flyweight) flyweightMap.get(key);</span><br><span class="line">        <span class="keyword">if</span> (flyweight != <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;å…·ä½“äº«å…ƒ&quot;</span> + key + <span class="string">&quot;å·²ç»å­˜åœ¨ï¼Œè¢«æˆåŠŸè·å–ï¼&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            flyweight = <span class="keyword">new</span> ConcreteFlyweight(key);</span><br><span class="line">            flyweightMap.put(key, flyweight);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> flyweight;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-13-ç»„åˆæ¨¡å¼-Composite"><a href="#2-13-ç»„åˆæ¨¡å¼-Composite" class="headerlink" title="2.13 ç»„åˆæ¨¡å¼-Composite"></a>2.13 ç»„åˆæ¨¡å¼-Composite</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>æœ‰æ—¶åˆå«åšéƒ¨åˆ†-æ•´ä½“æ¨¡å¼ï¼Œå®ƒæ˜¯ä¸€ç§å°†å¯¹è±¡ç»„åˆæˆæ ‘çŠ¶çš„å±‚æ¬¡ç»“æ„çš„æ¨¡å¼ï¼Œç”¨æ¥è¡¨ç¤ºâ€éƒ¨åˆ†-æ•´ä½“â€çš„å…³ç³»ï¼Œä½¿ç”¨æˆ·å¯¹å•ä¸ªç»„åˆå¯¹è±¡å…·æœ‰ä¸€è‡´çš„è®¿é—®æ€§ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>ç»„åˆæ¨¡å¼ä½¿å¾—å®¢æˆ·ç«¯ä»£ç å¯ä»¥ä¸€è‡´åœ°å¤„ç†å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡ï¼Œæ— é¡»å…³å¿ƒè‡ªå·±å¤„ç†çš„æ˜¯å•ä¸ªå¯¹è±¡ï¼Œè¿˜æ˜¯ç»„åˆå¯¹è±¡ï¼Œè¿™ç®€åŒ–äº†å®¢æˆ·ç«¯ä»£ç ã€‚</li>
<li>æ›´å®¹æ˜“åœ¨ç»„åˆä½“å†…åŠ å…¥äº†æ–°çš„å¯¹è±¡ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå› ä¸ºåŠ å…¥äº†æ–°çš„å¯¹è±¡è€Œæ›´æ”¹æºä»£ç ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>è®¾è®¡è¾ƒå¤æ‚ï¼Œå®¢æˆ·ç«¯éœ€è¦èŠ±æ›´å¤šæ—¶é—´ç†æ¸…ç±»ä¹‹é—´çš„å±‚æ¬¡å…³ç³»ã€‚</li>
<li>ä¸å®¹æ˜“é™åˆ¶å®¹å™¨ä¸­çš„æ„ä»¶ã€‚</li>
<li>ä¸å®¹æ˜“ç”¨ç»§æ‰¿çš„æ–¹æ³•æ¥å¢åŠ æ„ä»¶çš„æ–°åŠŸèƒ½ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡æ„ä»¶è§’è‰²(Component)ï¼šå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºæ ‘å¶æ„ä»¶å’Œæ ‘ææ„ä»¶å£°æ˜å…¬å…±æ¥å£ï¼Œå¹¶å®ç°å®ƒä»¬çš„é»˜è®¤è¡Œä¸ºï¼Œåœ¨é€æ˜å¼çš„ç»„åˆæ¨¡å¼ä¸­æŠ½è±¡æ’ä»¶è¿˜å£°æ˜è®¿é—®å’Œç®¡ç†å­ç±»çš„æ¥å£ï¼›åœ¨å®‰å…¨å¼çš„ç»„åˆæ¨¡å¼ä¸­ä¸å£°æ˜è®¿é—®å’Œç®¡ç†å­ç±»çš„æ¥å£ï¼Œç®¡ç†å·¥ä½œç”±æ ‘ææ„ä»¶å®Œæˆã€‚</li>
<li>æ ‘å¶æ„ä»¶è§’è‰²(Leaf)ï¼šæ˜¯ç»„åˆæ¨¡å¼ä¸­çš„å¶å­ç»“ç‚¹ï¼Œæ²¡æœ‰å­ç»“ç‚¹ï¼Œç”¨äºå®ç°æŠ½è±¡æ„ä»¶è§’è‰²ä¸­å£°æ˜çš„å…¬å…±æ¥å£ã€‚</li>
<li>æ ‘ææ„ä»¶è§’è‰²(Composite)ï¼šæ˜¯ç»„åˆæ¨¡å¼ä¸­çš„åˆ†æ”¯ç»“ç‚¹å¯¹è±¡ï¼Œæœ‰å­ç»“ç‚¹ï¼Œå®ƒå®ç°äº†æŠ½è±¡æ„ä»¶è§’è‰²ä¸­å£°æ˜çš„æ¥å£ï¼Œä¸»è¦ä½œç”¨æ˜¯å­˜å‚¨å’Œç®¡ç†å­éƒ¨ä»¶ï¼Œé€šå¸¸åŒ…å«add()ã€remove()ã€getChild()ç­‰æ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.composite.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.composite.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Composite &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: ç»„åˆæ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Component component0 = <span class="keyword">new</span> Composite();</span><br><span class="line">        Component component1 = <span class="keyword">new</span> Composite();</span><br><span class="line">        Component component2 = <span class="keyword">new</span> Leaf(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        Component component3 = <span class="keyword">new</span> Leaf(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        Component component4 = <span class="keyword">new</span> Leaf(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        component0.add(component2);</span><br><span class="line">        component0.add(component1);</span><br><span class="line">        component1.add(component3);</span><br><span class="line">        component1.add(component4);</span><br><span class="line">        component0.operation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡æ„ä»¶</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Component c)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Component c)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Component <span class="title">getChild</span><span class="params">(<span class="keyword">int</span> i)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æ ‘å¶æ„ä»¶</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Leaf</span> <span class="keyword">implements</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(Leaf.class);</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Leaf</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Component c)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Component c)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Component <span class="title">getChild</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ ‘å¶&quot;</span> + name + <span class="string">&quot;è¢«è®¿é—®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">	 **</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> *     æ ‘ææ„ä»¶</span><br><span class="line"> * &lt;/p&gt;</span><br><span class="line"> */</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Composite</span> <span class="keyword">implements</span> <span class="title">Component</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Component&gt; children = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Component c)</span> </span>&#123;</span><br><span class="line">        children.add(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Component c)</span> </span>&#123;</span><br><span class="line">        children.remove(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Component <span class="title">getChild</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> children.get(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Object obj : children) &#123;</span><br><span class="line">            ((Component) obj).operation();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-14-æ¨¡æ¿æ–¹æ³•æ¨¡å¼-Template-Method"><a href="#2-14-æ¨¡æ¿æ–¹æ³•æ¨¡å¼-Template-Method" class="headerlink" title="2.14 æ¨¡æ¿æ–¹æ³•æ¨¡å¼-Template Method"></a>2.14 æ¨¡æ¿æ–¹æ³•æ¨¡å¼-Template Method</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•éª¨æ¶ï¼Œè€Œå°†ç®—æ³•ä¸­çš„ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ï¼Œä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å°è£…äº†ä¸å˜éƒ¨åˆ†ï¼Œæ‰©å±•å¯å˜éƒ¨åˆ†ã€‚å®ƒæŠŠè®¤ä¸ºæ˜¯ä¸å˜éƒ¨åˆ†çš„ç®—æ³•å°è£…åˆ°çˆ¶ç±»å®ç°ä¸­ï¼Œè€ŒæŠŠå¯å˜éƒ¨åˆ†ç®—æ³•ç”±å­ç±»ç»§æ‰¿å®ç°ï¼Œä¾¿äºå­ç±»ç»§ç»­æ‰©å±•ã€‚</li>
<li>å®ƒåœ¨çˆ¶ç±»ä¸­æå–äº†å…¬å…±çš„éƒ¨åˆ†ä»£ç ï¼Œä¾¿äºä»£ç å¤ç”¨ã€‚</li>
<li>éƒ¨åˆ†æ–¹æ³•æ˜¯å­ç±»å®ç°çš„ï¼Œå› æ­¤å­ç±»å¯ä»¥é€šè¿‡æ‰©å±•æ–¹å¼å¢åŠ ç›¸åº”çš„åŠŸèƒ½ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å¯¹æ¯ä¸ªä¸åŒçš„å®ç°éƒ½éœ€è¦å®šä¹‰ä¸€ä¸ªå­ç±»ï¼Œè¿™ä¼šå¯¼è‡´ç±»çš„ä¸ªæ•°å¢åŠ ï¼Œç³»ç»Ÿæ›´åŠ åºå¤§ï¼Œè®¾è®¡ä¹Ÿæ›´åŠ æŠ½è±¡ã€‚</li>
<li>çˆ¶ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•ç”±å­ç±»å®ç°ï¼Œå­ç±»æ‰§è¡Œçš„ç»“æœä¼šå½±å“çˆ¶ç±»çš„ç»“æœï¼Œè¿™å¯¼è‡´ä¸€ç§åå‘çš„æ§åˆ¶ç»“æ„ï¼Œå®ƒæé«˜äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡ç±»(Abstract class)ï¼šè´Ÿè´£ç»™å‡ºä¸€ä¸ªç®—æ³•çš„è½®å»“å’Œéª¨æ¶ã€‚å®ƒç”±ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•å’Œè‹¥å¹²ä¸ªåŸºæœ¬æ–¹æ³•æ„æˆ<ul>
<li>æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰äº†ç®—æ³•çš„éª¨æ¶ï¼ŒæŒ‰æŸç§é¡ºåºè°ƒç”¨å…¶åŒ…å«çš„åŸºæœ¬æ–¹æ³•</li>
<li>åŸºæœ¬æ–¹æ³•ï¼š<ul>
<li>æŠ½è±¡æ–¹æ³•ï¼šåœ¨æŠ½è±¡ç±»ä¸­ç”³æ˜ï¼Œç”±å…·ä½“å­ç±»ä¸­å¯ä»¥ç»§æ‰¿æˆ–é‡å†™å®ƒã€‚</li>
<li>å…·ä½“æ–¹æ³•ï¼šåœ¨æŠ½è±¡ç±»ä¸­å·²ç»å®ç°ï¼Œåœ¨å…·ä½“å­ç±»ä¸­å¯ä»¥ç»§æ‰¿æˆ–é‡å†™å®ƒã€‚</li>
<li>é’©å­æ–¹æ³•ï¼šåœ¨æŠ½è±¡ç±»ä¸­å·²ç»å®ç°ï¼ŒåŒ…æ‹¬ç”¨äºåˆ¤æ–­çš„é€»è¾‘æ–¹æ³•å’Œéœ€è¦å­ç±»é‡å†™çš„å­”æ–¹æ³•ä¸¤ç§ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>å…·ä½“å­ç±»(Concrete Class)ï¼šå®ç°æŠ½è±¡ç±»ä¸­æ‰€å®šä¹‰çš„æŠ½è±¡æ–¹æ³•å’Œé’©å­æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯ä¸€ä¸ªé¡¶çº§é€»è¾‘çš„ä¸€ä¸ªç»„æˆæ­¥éª¤ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.templateMethod.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.templateMethod.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: TemplateMethodDemo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemplateMethodDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AbstractClass abstractClass = <span class="keyword">new</span> ConcreteClass();</span><br><span class="line">        abstractClass.templateMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;P&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(AbstractClass.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ¨¡æ¿æ–¹æ³• */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">templateMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        specificMethod();</span><br><span class="line">        abstractMethod1();</span><br><span class="line">        abstractMethod2();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å…·ä½“æ–¹æ³• */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">specificMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“æ–¹æ³•è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æŠ½è±¡æ–¹æ³•1 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">abstractMethod1</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/* æŠ½è±¡æ–¹æ³•2 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">abstractMethod2</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteClass</span> <span class="keyword">extends</span> <span class="title">AbstractClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteClass.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">abstractMethod1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æŠ½è±¡æ–¹æ³•1çš„å®ç°è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">abstractMethod2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æŠ½è±¡æ–¹æ³•2çš„å®ç°è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-15-ç­–ç•¥æ¨¡å¼-Strategy"><a href="#2-15-ç­–ç•¥æ¨¡å¼-Strategy" class="headerlink" title="2.15 ç­–ç•¥æ¨¡å¼-Strategy"></a>2.15 ç­–ç•¥æ¨¡å¼-Strategy</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>è¯¥æ¨¡å¼å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’ä¾èµ–ï¼Œä¸”ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“åˆ°ä½¿ç”¨ç®—æ³•çš„ç”¨æˆ·ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å¤šé‡æ¡ä»¶è¯­å¥ä¸æ˜“ç»´æŠ¤ï¼Œè€Œä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯ä»¥é¿å…ä½¿ç”¨å¤šé‡æ¡ä»¶è¯­å¥ã€‚</li>
<li>ç­–ç•¥æ¨¡å¼æä¾›äº†ä¸€ç³»åˆ—çš„å¯ä¾›é‡ç”¨çš„ç®—æ³•æ—ï¼Œæ°å½“ä½¿ç”¨ç»§æ‰¿å¯ä»¥æŠŠç®—æ³•æ—çš„å…¬å…±ä»£ç è½¬ç§»åˆ°çˆ¶ç±»é‡Œé¢ï¼Œä»è€Œé¿å…é‡å¤çš„ä»£ç ã€‚</li>
<li>ç­–ç•¥æ¨¡å¼å¯ä»¥æä¾›ç›¸åŒè¡Œä¸ºçš„ä¸åŒå®ç°ï¼Œå®¢æˆ·å¯ä»¥æ ¹æ®ä¸åŒæ—¶é—´æˆ–ç©ºé—´è¦æ±‚é€‰æ‹©ä¸åŒçš„ã€‚</li>
<li>ç­–ç•¥æ¨¡å¼æä¾›äº†å¯¹å¼€é—­åŸåˆ™çš„å®Œç¾æ”¯æŒï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹åŸä»£ç çš„æƒ…å†µä¸‹ï¼Œçµæ´»å¢åŠ æ–°ç®—æ³•ã€‚</li>
<li>ç­–ç•¥æ¨¡å¼æŠŠç®—æ³•çš„ä½¿ç”¨æ”¾åˆ°ç¯å¢ƒç±»ä¸­ï¼Œè€Œç®—æ³•çš„å®ç°ç§»åˆ°å…·ä½“ç­–ç•¥ç±»ä¸­ï¼Œå®ç°äº†äºŒè€…çš„åˆ†ç¦»ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å®¢æˆ·ç«¯å¿…é¡»ç†è§£æ‰€æœ‰ç­–ç•¥ç®—æ³•çš„åŒºåˆ«ï¼Œä»¥ä¾¿é€‚æ—¶é€‰æ‹©æ°å½“çš„ç®—æ³•ç±»ã€‚</li>
<li>ç­–ç•¥æ¨¡å¼é€ æˆå¾ˆå¤šçš„ç­–ç•¥ç±»ã€‚</li>
</ul>
<blockquote>
<p> ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡ç­–ç•¥ç±»(Strategy)ï¼šå®šä¹‰äº†ä¸€ä¸ªå…¬å…±æ¥å£ï¼Œå„ç§ä¸åŒçš„ç®—æ³•ä»¥ä¸åŒçš„æ–¹å¼å®ç°è¿™ä¸ªæ¥å£ï¼Œç¯å¢ƒè§’è‰²ä½¿ç”¨è¿™ä¸ªæ¥å£è°ƒç”¨ä¸åŒçš„ç®—æ³•ï¼Œä¸€èˆ¬ä½¿ç”¨æ¥å£æˆ–æŠ½è±¡ç±»å®ç°ã€‚</li>
<li>å…·ä½“ç­–ç•¥ç±»(Concrete Strategy)ï¼šå®ç°äº†æŠ½è±¡äº†ç­–ç•¥å®šä¹‰çš„æ¥å£ï¼Œç¯å¢ƒè§’è‰²ä½¿ç”¨è¿™ä¸ªæ¥å£è°ƒç”¨ä¸åŒçš„ç®—æ³•ï¼Œä¸€èˆ¬ä½¿ç”¨æ¥å£æˆ–æŠ½è±¡ç±»å®ç°ã€‚</li>
<li>ç¯å¢ƒç±»(Context)ï¼šæŒæœ‰ä¸€ä¸ªç­–ç•¥ç±»çš„å¼•ç”¨ï¼Œæœ€ç»ˆç»™å®¢æˆ·ç«¯è°ƒç”¨ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.strategy.pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.strategy.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: StrategyDemo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: ç­–ç•¥æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StrategyDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Context context = <span class="keyword">new</span> Context();</span><br><span class="line">        Strategy strategy1 = <span class="keyword">new</span> ConcreteStrategyA();</span><br><span class="line">        Strategy strategy2 = <span class="keyword">new</span> ConcreteStrategyB();</span><br><span class="line">        context.setStrategy(strategy1);</span><br><span class="line">        context.strategyMethod();</span><br><span class="line">        context.setStrategy(strategy2);</span><br><span class="line">        context.strategyMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡ç­–ç•¥ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">strategyMethod</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“ç­–ç•¥ç±»A</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteStrategyA</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteStrategyA.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“ç­–ç•¥Açš„ç­–ç•¥æ–¹æ³•è¢«è®¿é—®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“ç­–ç•¥ç±»B</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteStrategyB</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteStrategyB.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“ç­–ç•¥Bçš„ç­–ç•¥æ–¹æ³•è¢«è®¿é—®&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ç¯å¢ƒç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Strategy strategy;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Strategy <span class="title">getStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> strategy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStrategy</span><span class="params">(Strategy strategy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.strategy = strategy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        strategy.strategyMethod();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-16-å‘½ä»¤æ¨¡å¼-Command"><a href="#2-16-å‘½ä»¤æ¨¡å¼-Command" class="headerlink" title="2.16 å‘½ä»¤æ¨¡å¼-Command"></a>2.16 å‘½ä»¤æ¨¡å¼-Command</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å°†è¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä½¿å‘å‡ºè¯·æ±‚çš„è´£ä»»å’Œæ‰§è¡Œè¯·æ±‚çš„è´£ä»»åˆ†å‰²å¼€ã€‚è¿™æ ·ä¸¤è€…ä¹‹é—´é€šè¿‡å‘½ä»¤å¯¹è±¡è¿›è¡Œæ²Ÿé€šï¼Œè¿™æ ·æ–¹ä¾¿å°†å‘½ä»¤å¯¹è±¡è¿›è¡Œå‚¨å­˜ã€ä¼ é€’ã€è°ƒç”¨ã€å¢åŠ ä¸ç®¡ç†ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>é™ä½ç³»ç»Ÿçš„è€¦åˆåº¦ã€‚å‘½ä»¤æ¨¡å¼èƒ½å°†è°ƒç”¨æ“ä½œçš„å¯¹è±¡ä¸å®ç°è¯¥æ“ä½œçš„å¯¹è±¡è§£è€¦ã€‚</li>
<li>å¢åŠ æˆ–åˆ é™¤å‘½ä»¤éå¸¸æ–¹ä¾¿ã€‚é‡‡ç”¨å‘½ä»¤æ¨¡å¼å¢åŠ ä¸åˆ é™¤å‘½ä»¤ä¸ä¼šå½±å“å…¶ä»–ç±»ï¼Œå®ƒæ»¡è¶³å¼€é—­åŸåˆ™ï¼Œå¯¹æ‹“å±•æ¯”è¾ƒçµæ´»ã€‚</li>
<li>å¯ä»¥å®ç°å®å‘½ä»¤ã€‚å‘½ä»¤æ¨¡å¼å¯ä»¥ä¸ç»„åˆæ¨¡å¼ç»“åˆï¼Œå°†å¤šä¸ªå‘½ä»¤è£…é…æˆä¸€ä¸ªç»„åˆå‘½ä»¤ï¼Œå³å®å‘½ä»¤ã€‚</li>
<li>æ–¹ä¾¿å®ç°Undoå’ŒRedoæ“ä½œã€‚å‘½ä»¤æ¨¡å¼å¯ä»¥ä¸å¤‡å¿˜å½•æ¨¡å¼ç»“åˆï¼Œå®ç°å‘½ä»¤çš„æ’¤é”€ä¸æ¢å¤ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<p>å¯èƒ½äº§ç”Ÿå¤§é‡å…·ä½“å‘½ä»¤ç±»ã€‚å› ä¸ºå¯¹æ¯ä¸€ä¸ªå…·ä½“æ“ä½œéƒ½éœ€è¦è®¾è®¡ä¸€ä¸ªå…·ä½“å‘½ä»¤ç±»ï¼Œè¿™å°†å¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚</p>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡å‘½ä»¤ç±»(Command)ï¼šå£°æ˜æ‰§è¡Œå‘½ä»¤çš„æ¥å£ï¼Œæ‹¥æœ‰æ‰§è¡Œå‘½ä»¤çš„æŠ½è±¡æ–¹æ³•execute()ã€‚</li>
<li>å…·ä½“å‘½ä»¤è§’è‰²(Concrete Command)ï¼šæ˜¯æŠ½è±¡å‘½ä»¤ç±»çš„å…·ä½“å®ç°ç±»ï¼Œå®ƒæ‹¥æœ‰æ¥æ”¶è€…å¯¹è±¡ï¼Œå¹¶é€šè¿‡è°ƒç”¨æ¥æ”¶è€…çš„åŠŸèƒ½æ¥å®Œæˆå‘½ä»¤è¦æ‰§è¡Œçš„æ“ä½œã€‚</li>
<li>æ¥æ”¶è€…(Receiver)ï¼šæ‰§è¡Œå‘½ä»¤åŠŸèƒ½çš„ç›¸å…³æ“ä½œï¼Œæ˜¯å…·ä½“å‘½ä»¤å¯¹è±¡ä¸šåŠ¡çš„çœŸæ­£å®ç°è€…ã€‚</li>
<li>è¯·æ±‚è€…(Invoker)ï¼šè¯·æ±‚çš„å‘é€è€…ï¼Œå®ƒé€šå¸¸æ‹¥æœ‰å¾ˆå¤šçš„å‘½ä»¤å¯¹è±¡ï¼Œå¹¶é€šè¿‡è®¿é—®å‘½ä»¤å¯¹è±¡ç±»æ‰§è¡Œç›¸å…³è¯·æ±‚ï¼Œå®ƒä¸å¼ å­æ°è®¿é—®æ¥æ”¶è€…ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.command.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.command.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: CommandDemo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: å‘½ä»¤æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = Logger.getLogger(CommandDemo.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Command command = <span class="keyword">new</span> ConcreteCommand();</span><br><span class="line">        Invoker invoker = <span class="keyword">new</span> Invoker(command);</span><br><span class="line">        log.info(<span class="string">&quot;å®¢æˆ·è®¿é—®è°ƒç”¨è€…çš„callæ–¹æ³•&quot;</span>);</span><br><span class="line">        invoker.call();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     è°ƒç”¨è€…</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Invoker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(Invoker.class);</span><br><span class="line">    <span class="keyword">private</span> Command command;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Invoker</span><span class="params">(Command command)</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.command = command;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCommand</span><span class="params">(Command command)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.command = command;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;è°ƒç”¨è€…æ‰§è¡Œå‘½ä»¤command&quot;</span>);</span><br><span class="line">        command.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡å‘½ä»¤</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;å…·ä½“å‘½ä»¤&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteCommand</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Receiver receiver;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteCommand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.receiver = <span class="keyword">new</span> Receiver();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        receiver.action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æ¥æ”¶è€…&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(Receiver.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ¥æ”¶è€…çš„actionæ–¹æ³•è¢«è°ƒç”¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-17-è´£ä»»é“¾æ¨¡å¼-Chain-of-Responsibility"><a href="#2-17-è´£ä»»é“¾æ¨¡å¼-Chain-of-Responsibility" class="headerlink" title="2.17 è´£ä»»é“¾æ¨¡å¼-Chain of Responsibility"></a>2.17 è´£ä»»é“¾æ¨¡å¼-Chain of Responsibility</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ä¸ºäº†é¿å…è¯·æ±‚å‘é€è€…ä¸å¤šä¸ªè¯·æ±‚å¤„ç†è€…è€¦åˆåœ¨ä¸€èµ·ï¼Œå°†æ‰€æœ‰è¯·æ±‚çš„å¤„ç†è€…é€šè¿‡å‰ä¸€å¯¹è±¡è®°ä½å…¶ä¸‹ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è€Œè¿æˆä¸€æ¡é“¾ï¼›å½“æœ‰è¯·æ±‚å‘ç”Ÿæ—¶ï¼Œå¯ä»¥å°†è¯·æ±‚æ²¿ç€è¿™æ¡é“¾ä¼ é€’ï¼Œç›´åˆ°æœ‰å¯¹è±¡å¤„ç†å®ƒä¸ºæ­¢ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>é™ä½äº†å¯¹è±¡ä¹‹é—´çš„è€¦åˆåº¦ã€‚è¯¥æ¨¡å¼ä½¿å¾—ä¸€ä¸ªå¯¹è±¡æ— é¡»çŸ¥é“åˆ°åº•æ˜¯å“ªä¸€ä¸ªå¯¹è±¡å¤„ç†å…¶è¯·æ±‚ä»¥åŠé“¾çš„ç»“æ„ï¼Œå‘é€è€…å’Œæ¥æ”¶è€…ä¹Ÿæ— é¡»æ‹¥æœ‰å¯¹æ–¹çš„æ˜ç¡®ä¿¡æ¯ã€‚</li>
<li>å¢å¼ºäº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚å¯ä»¥æ ¹æ®éœ€è¦å¢åŠ æ–°çš„è¯·æ±‚å¤„ç†ç±»ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™ã€‚</li>
<li>å¢å¼ºäº†ç»™å¯¹è±¡æŒ‡æ´¾èŒè´£çš„çµæ´»æ€§ã€‚å½“å·¥ä½œæµç¨‹å‘ç”Ÿå˜åŒ–ï¼Œå¯ä»¥åŠ¨æ€åœ°æ”¹å˜é“¾å†…çš„æˆå‘˜æˆ–è€…è°ƒåŠ¨å®ƒä»¬çš„æ¬¡åºï¼Œä¹Ÿå¯åŠ¨æ€åœ°æ–°å¢æˆ–è€…åˆ é™¤è´£ä»»ã€‚</li>
<li>è´£ä»»é“¾ç®€åŒ–äº†å¯¹è±¡ä¹‹é—´çš„è¿æ¥ã€‚æ¯ä¸ªå¯¹è±¡åªéœ€ä¿æŒä¸€ä¸ªæŒ‡å‘å…¶åç»§è€…çš„å¼•ç”¨ï¼Œä¸éœ€ä¿æŒå…¶ä»–æ‰€æœ‰å¤„ç†è€…çš„å¼•ç”¨ï¼Œè¿™é¿å…äº†ä½¿ç”¨ä¼—å¤šçš„if-elseè¯­å¥ã€‚</li>
<li>è´£ä»»åˆ†æ‹…ã€‚æ¯ä¸ªç±»åªéœ€è¦å¤„ç†è‡ªå·±è¯¥å¤„ç†çš„å·¥ä½œï¼Œä¸è¯¥å¤„ç†çš„ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¯¹è±¡å®Œæˆï¼Œæ˜ç¡®å„ç±»çš„è´£ä»»èŒƒå›´ï¼Œç¬¦åˆç±»çš„å•ä¸€èŒè´£åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ä¸èƒ½ä¿è¯æ¯ä¸ªè¯·æ±‚ä¸€å®šè¢«å¤„ç†ã€‚ç”±äºä¸€ä¸ªè¯·æ±‚æ²¡æœ‰æ˜ç¡®çš„æ¥æ”¶è€…ï¼Œæ‰€ä»¥ä¸èƒ½ä¿è¯å®ƒä¸€å®šä¼šè¢«å¤„ç†ï¼Œè¯¥è¯·æ±‚å¯èƒ½ä¸€ç›´ä¼ åˆ°é“¾çš„æœ«ç«¯éƒ½å¾—ä¸åˆ°å¤„ç†ã€‚</li>
<li>å¯¹æ¯”è¾ƒé•¿çš„è´£ä»»é“¾ï¼Œè¯·æ±‚çš„å¤„ç†å¯èƒ½æ¶‰åŠå¤šä¸ªå¤„ç†å¯¹è±¡ï¼Œç³»ç»Ÿæ€§èƒ½å°†å—åˆ°ä¸€ä¸ªå½±å“ã€‚</li>
<li>èŒè´£é“¾çš„å»ºç«‹çš„åˆç†æ€§è¦é å®¢æˆ·ç«¯æ¥ä¿è¯ï¼Œå¢åŠ äº†å®¢æˆ·ç«¯çš„å¤æ‚æ€§ï¼Œå¯èƒ½ä¼šç”±äºè´£ä»»é“¾çš„é”™è¯¯è®¾ç½®è€Œå¯¼è‡´ç³»ç»Ÿå‡ºé”™ï¼Œå¦‚å¯èƒ½è¿˜ä¼šé€ æˆå¾ªç¯è°ƒç”¨ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li><p>æŠ½è±¡å¤„ç†è€…(Handler)ï¼šå®šä¹‰ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„æ¥å£ï¼ŒåŒ…å«æŠ½è±¡å¤„ç†æ–¹æ³•å’Œä¸€ä¸ªåç»§è¿æ¥ã€‚</p>
</li>
<li><p>å…·ä½“å¤„ç†è€…(Concrete Handler)ï¼šå®ç°æŠ½è±¡å¤„ç†è€…çš„å¤„ç†æ–¹æ³•ï¼Œåˆ¤æ–­èƒ½å¦æœ¬æ¬¡è¯·æ±‚ï¼Œå¦‚æœå¯ä»¥å¤„ç†è¯·æ±‚åˆ™å¤„ç†ï¼Œå¦åˆ™å°†ç»™è¯·æ±‚è½¬ç»™å®ƒçš„åç»§è€…ã€‚</p>
</li>
<li><p>å®¢æˆ·ç±»(Client)ï¼šåˆ›å»ºå¤„ç†é“¾ï¼Œå¹¶å‘é“¾å¤´çš„å…·ä½“å¤„ç†è€…å¯¹è±¡æäº¤è¯·æ±‚ï¼Œå®ƒä¸å…³å¿ƒå¤„ç†ç»†èŠ‚å’Œè¯·æ±‚çš„ä¼ é€’è¿‡ç¨‹ã€‚</p>
</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.chainofResposibility.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.chainofResposibility.example &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: Main &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: è´£ä»»é“¾Demo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æµ‹è¯•ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Support RubbishK = <span class="keyword">new</span> NoSupport(<span class="string">&quot;RubbishK&quot;</span>);</span><br><span class="line">        Support FlowerK = <span class="keyword">new</span> LimitSupport(<span class="string">&quot;FlowerK&quot;</span>, <span class="number">100</span>);</span><br><span class="line">        Support EyedropK = <span class="keyword">new</span> LimitSupport(<span class="string">&quot;EyedropK&quot;</span>, <span class="number">200</span>);</span><br><span class="line">        Support UnknownK = <span class="keyword">new</span> SpecialSupport(<span class="string">&quot;UnknownK&quot;</span>, <span class="number">300</span>);</span><br><span class="line">        Support KHighness = <span class="keyword">new</span> SpecialSupport(<span class="string">&quot;KHighness&quot;</span>, <span class="number">330</span>);</span><br><span class="line">        Support BrotherK = <span class="keyword">new</span> OddSupport(<span class="string">&quot;BrotherK&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ¶é€ è´£ä»»é“¾</span></span><br><span class="line">        RubbishK.setNext(FlowerK).setNext(EyedropK).setNext(UnknownK).setNext(KHighness).setNext(BrotherK);</span><br><span class="line">        <span class="comment">// åˆ¶é€ é—®é¢˜</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">500</span>; i += <span class="number">30</span>) &#123;</span><br><span class="line">            RubbishK.support(<span class="keyword">new</span> Trouble(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å‘ç”Ÿçš„é—®é¢˜çš„ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Trouble</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Trouble</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[Trouble &quot;</span> +</span><br><span class="line">                <span class="string">&quot;number=&quot;</span> + number +</span><br><span class="line">                <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ç”¨æ¥è§£å†³é—®çš„æŠ½è±¡ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Support</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(Support.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Support next;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Support</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Support <span class="title">setNext</span><span class="params">(Support next)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[&quot;</span> + name + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">support</span><span class="params">(Trouble trouble)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (resolve(trouble)) &#123;</span><br><span class="line">            done(trouble);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next != <span class="keyword">null</span>) &#123;</span><br><span class="line">            next.support(trouble);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fail(trouble);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">resolve</span><span class="params">(Trouble trouble)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">(Trouble trouble)</span> </span>&#123;</span><br><span class="line">        log.info(trouble + <span class="string">&quot; is resolved by &quot;</span> + <span class="keyword">this</span> + <span class="string">&quot;.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">fail</span><span class="params">(Trouble trouble)</span> </span>&#123;</span><br><span class="line">        log.info(trouble + <span class="string">&quot; cannot be resolved.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     è§£å†³é—®é¢˜å…·ä½“ç±»ï¼šä¸èƒ½è§£å†³é—®é¢˜</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoSupport</span> <span class="keyword">extends</span> <span class="title">Support</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NoSupport</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">resolve</span><span class="params">(Trouble trouble)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     è§£å†³é—®é¢˜å…·ä½“ç±»ï¼šè§£å†³é—®é¢˜ç¼–å·å°äºlimitå€¼å¾—ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LimitSupport</span> <span class="keyword">extends</span> <span class="title">Support</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> limit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LimitSupport</span><span class="params">(String name, <span class="keyword">int</span> limit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">        <span class="keyword">this</span>.limit = limit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">resolve</span><span class="params">(Trouble trouble)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (trouble.getNumber() &lt; limit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     è§£å†³é—®é¢˜å…·ä½“ç±»ï¼šè§£å†³å¥‡æ•°ç¼–å·å¾—é—®é¢˜</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OddSupport</span> <span class="keyword">extends</span> <span class="title">Support</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OddSupport</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">resolve</span><span class="params">(Trouble trouble)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (trouble.getNumber() % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     è§£å†³é—®é¢˜å…·ä½“ç±»ï¼šåªè§£å†³æŒ‡å®šç¼–å·å¾—é—®é¢˜</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpecialSupport</span> <span class="keyword">extends</span> <span class="title">Support</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> number;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpecialSupport</span><span class="params">(String name, <span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">resolve</span><span class="params">(Trouble trouble)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (trouble.getNumber() == <span class="keyword">this</span>.number) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-18-çŠ¶æ€æ¨¡å¼-State"><a href="#2-18-çŠ¶æ€æ¨¡å¼-State" class="headerlink" title="2.18 çŠ¶æ€æ¨¡å¼-State"></a>2.18 çŠ¶æ€æ¨¡å¼-State</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å¯¹æœ‰çŠ¶æ€çš„å¯¹è±¡ï¼ŒæŠŠå¤æ‚çš„â€œåˆ¤æ–­é€»è¾‘â€æå–åˆ°ä¸åŒçš„çŠ¶æ€å¯¹è±¡ä¸­ï¼Œå…è®¸çŠ¶æ€å¯¹è±¡åœ¨å…¶å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶æ”¹å˜å…¶è¡Œä¸ºã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>çŠ¶æ€æ¨¡å¼ä¸ç‰¹å®šçŠ¶æ€ç›¸å…³çš„è¡Œä¸ºå±€éƒ¨åŒ–åˆ°ä¸€ä¸ªçŠ¶æ€ä¸­ï¼Œå¹¶ä¸”å°†ä¸åŒçŠ¶æ€çš„è¡Œä¸ºåˆ†å‰²å¼€æ¥ï¼Œæ»¡è¶³å•ä¸€èŒè´£åŸåˆ™ã€‚</li>
<li>å‡å°‘å¯¹è±¡é—´çš„ç›¸äº’ä¾èµ–ã€‚å°†ä¸åŒçš„çŠ¶æ€å¼•å…¥ç‹¬ç«‹çš„å¯¹è±¡ä¸­ä¼šä½¿å¾—çŠ¶æ€å˜å¾—æ›´åŠ æ˜ç¡®ï¼Œåˆ‡å‡å°‘å¯¹è±¡é—´çš„ç›¸äº’ä¾èµ–ã€‚</li>
<li>æœ‰åˆ©äºç¨‹åºçš„æ‹“å±•ã€‚é€šè¿‡å®šä¹‰æ–°çš„å­ç±»å¾ˆå®¹æ˜“å¾·å¢åŠ æ–°çš„çŠ¶æ€å’Œè½¬æ¢ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>çŠ¶æ€æ¨¡å¼çš„ä½¿ç”¨å¿…ç„¶ä¼šå¢åŠ ç³»ç»Ÿçš„ç±»ä¸å¯¹è±¡çš„ä¸ªæ•°ã€‚</li>
<li>çŠ¶æ€æ¨¡å¼çš„ç»“æ„å’Œå®ç°éƒ½è¾ƒä¸ºå¤æ‚ï¼Œå¦‚æœä½¿ç”¨ä¸å½“ä¼šå¯¼è‡´ç¨‹åºç»“æ„å’Œä»£ç çš„æ··ä¹±ã€‚ </li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>ç¯å¢ƒç±»(Context)ï¼šä¹Ÿç§°ä¸ºä¸Šä¸‹æ–‡ï¼Œå®ƒå®šä¹‰äº†å®¢æˆ·æ„Ÿå…´è¶£çš„æ¥å£ï¼Œç»´æŠ¤ä¸€ä¸ªå½“å‰çŠ¶æ€ï¼Œå¹¶å°†ä¸çŠ¶æ€ç›¸å…³çš„æ“ä½œéƒ½å§”æ‰˜ç»™å½“å‰çŠ¶æ€å¯¹è±¡ç±»å¤„ç†ã€‚</li>
<li>æŠ½è±¡çŠ¶æ€ç±»(State)ï¼šå®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç”¨ä»¥å°è£…ç¯å¢ƒå¯¹è±¡ä¸­ç‰¹å®šçŠ¶æ€æ‰€å¯¹åº”çš„è¡Œä¸ºã€‚</li>
<li>å…·ä½“çŠ¶æ€ç±»(Concrete State)ï¼šå®ç°æŠ½è±¡çŠ¶æ€æ‰€å¯¹åº”çš„è¡Œä¸ºã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.state.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.state.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: StateDemo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: çŠ¶æ€æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StateDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Context context = <span class="keyword">new</span> Context();</span><br><span class="line">        context.handle();</span><br><span class="line">        context.handle();</span><br><span class="line">        context.handle();</span><br><span class="line">        context.handle();</span><br><span class="line">        context.handle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ç¯å¢ƒç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> State state;</span><br><span class="line">    <span class="comment">/* åˆå§‹çŠ¶æ€ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Context</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = <span class="keyword">new</span> ConcreteStateA();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è¯»å–çŠ¶æ€ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> State <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è®¾ç½®çŠ¶æ€ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¤„ç†è¯·æ±‚ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        state.handle(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡çŠ¶æ€ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Context context)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“çŠ¶æ€Aç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteStateA</span> <span class="keyword">extends</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteStateA.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å½“å‰çŠ¶æ€ï¼šA&quot;</span>);</span><br><span class="line">        context.setState(<span class="keyword">new</span> ConcreteStateB());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“çŠ¶æ€Bç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteStateB</span> <span class="keyword">extends</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteStateB.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å½“å‰çŠ¶æ€ï¼šB&quot;</span>);</span><br><span class="line">        context.setState(<span class="keyword">new</span> ConcreteStateA());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-19-è§‚å¯Ÿè€…æ¨¡å¼-Observer"><a href="#2-19-è§‚å¯Ÿè€…æ¨¡å¼-Observer" class="headerlink" title="2.19 è§‚å¯Ÿè€…æ¨¡å¼-Observer"></a>2.19 è§‚å¯Ÿè€…æ¨¡å¼-Observer</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å¤šä¸ªå¯¹è±¡ä¹‹é—´å­˜åœ¨ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ï¼Œåˆå«åšå‘å¸ƒ-è®¢é˜…æ¨¡å¼ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li><p>é™ä½äº†ç›®æ ‡ä¸è§‚å¯Ÿè€…ä¹‹é—´çš„è€¦åˆå…³ç³»ï¼Œä¸¤è€…ä¹‹é—´æ˜¯æŠ½è±¡è€¦åˆå…³ç³»ã€‚</p>
</li>
<li><p>ç›®æ ‡ä¸è§‚å¯Ÿè€…ä¹‹é—´å»ºç«‹äº†ä¸€å¥—è§¦å‘æœºåˆ¶ã€‚</p>
</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ç›®æ ‡ä¸è§‚å¯Ÿè€…ä¹‹é—´çš„ä¾èµ–å…³ç³»å¹¶æ²¡æœ‰å®Œå…¨è§£é™¤ï¼Œè€Œä¸”æœ‰å¯èƒ½å‡ºç°å¾ªç¯å¼•ç”¨ã€‚</li>
<li>å½“è§‚å¯Ÿè€…å¯¹è±¡å¾ˆå¤šæ—¶ï¼Œé€šçŸ¥çš„å‘å¸ƒä¼šèŠ±è´¹å¾ˆå¤šæ—¶é—´ï¼Œå½±å“ç¨‹åºçš„æ•ˆç‡ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡ä¸»é¢˜(Subject)ï¼šæä¾›äº†ä¸€ä¸ªç”¨äºä¿å­˜è§‚å¯Ÿè€…å¯¹è±¡çš„èšé›†ç±»å’Œå¢åŠ ã€å¢åŠ è§‚å¯Ÿè€…å¯¹è±¡çš„æ–¹æ³•ï¼Œä»¥åŠé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…çš„æŠ½è±¡æ–¹æ³•ã€‚</li>
<li>å…·ä½“ä¸»é¢˜(Concrete Subject)ï¼šå®ç°æŠ½è±¡ç›®æ ‡ä¸­çš„é€šçŸ¥æ–¹æ³•ï¼Œå½“å…·ä½“ä¸»é¢˜çš„å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œé€šçŸ¥æ‰€æœ‰æ³¨å†Œè¿‡çš„è§‚å¯Ÿè€…å¯¹è±¡ã€‚</li>
<li>æŠ½è±¡è§‚å¯Ÿè€…(Observer)ï¼šä¸€ä¸ªæŠ½è±¡ç±»æˆ–è€…æ¥å£ï¼ŒåŒ…å«äº†ä¸€ä¸ªæ›´æ–°è‡ªå·±çš„æŠ½è±¡æ–¹æ³•ï¼Œå½“æ¥åˆ°å…·ä½“ä¸»é¢˜çš„æ›´æ”¹é€šçŸ¥æ—¶è¢«è°ƒç”¨ã€‚</li>
<li>å…·ä½“è§‚å¯Ÿè€…(Concrete Observer)ï¼šå®ç°æŠ½è±¡è§‚å¯Ÿè€…ä¸­å®šä¹‰çš„æŠ½è±¡æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨å¾—åˆ°ç›®æ ‡çš„æ›´æ”¹é€šçŸ¥æ—¶æ›´æ–°è‡ªèº«çš„çŠ¶æ€ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.observer.pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.observer.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: ObserverDemo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: è§‚å¯Ÿè€…æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subject subject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line">        Observer[] observers = <span class="keyword">new</span> Observer[<span class="number">20</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">                observers[i] = <span class="keyword">new</span> ConcreteObserver1();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                observers[i] = <span class="keyword">new</span> ConcreteObserver2();</span><br><span class="line">            &#125;</span><br><span class="line">            subject.add(observers[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        subject.notifyObserver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡ç›®æ ‡</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> List&lt;Observer&gt; observers = <span class="keyword">new</span> ArrayList&lt;Observer&gt;();</span><br><span class="line">    <span class="comment">/* å¢åŠ è§‚å¯Ÿè€… */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Observer observer)</span> </span>&#123;</span><br><span class="line">        observers.add(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* åˆ é™¤è§‚å¯Ÿè€… */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(Observer observer)</span> </span>&#123;</span><br><span class="line">        observers.remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* é€šçŸ¥è§‚å¯Ÿè€… */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">notifyObserver</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“ç›®æ ‡</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">extends</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObserver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å…·ä½“ç›®æ ‡å‘ç”Ÿæ”¹å˜&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Observer observer : observers) &#123;</span><br><span class="line">            observer.response();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡è§‚å¯Ÿè€…</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* ä½œå‡ºååº” */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">response</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“è§‚å¯Ÿè€…1</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteObserver1</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteObserver1.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">response</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“è§‚å¯Ÿè€…1ä½œå‡ºååº”&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;P&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“è§‚å¯Ÿè€…2</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteObserver2</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteObserver2.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">response</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“è§‚å¯Ÿè€…2ä½œå‡ºååº”&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-20-ä¸­ä»‹è€…æ¨¡å¼-Mediator"><a href="#2-20-ä¸­ä»‹è€…æ¨¡å¼-Mediator" class="headerlink" title="2.20 ä¸­ä»‹è€…æ¨¡å¼-Mediator"></a>2.20 ä¸­ä»‹è€…æ¨¡å¼-Mediator</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å®šä¹‰ä¸€ä¸ªä¸­ä»‹å¯¹è±¡æ¥å°è£…ä¸€ç³»åˆ—å¯¹è±¡ä¹‹é—´çš„äº¤äº’ï¼Œä½¿åŸæœ‰å¯¹è±¡ç›´æ¥çš„è€¦åˆæ¾æ•£ï¼Œä¸”å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚ä¸­ä»‹è€…æ¨¡å¼åˆå«è°ƒåœæ¨¡å¼ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>é™ä½äº†å¯¹è±¡ä¹‹é—´çš„è€¦åˆæ€§ï¼Œä½¿å¾—å¯¹è±¡æ˜“äºç‹¬ç«‹åœ°è¢«å¤ç”¨ã€‚</li>
<li>å°†å¯¹è±¡ä¹‹é—´çš„ä¸€å¯¹å¤šå…³è”è½¬ä¸ºä¸€å¯¹ä¸€çš„å…³è”ï¼Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§ï¼Œä½¿å¾—ç³»ç»Ÿæ˜“äºç»´æŠ¤å’Œæ‹“å±•ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å½“åŒäº‹ç±»å¤ªå¤šæ—¶ï¼Œä¸­ä»‹è€…çš„èŒè´£èŒè´£å°†å¾ˆå¤§ï¼Œå®ƒä¼šå˜å¾—å¤æ‚è€Œåºå¤§ï¼Œä»¥è‡³äºç³»ç»Ÿéš¾ä»¥ç»´æŠ¤ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡ä¸­ä»‹è€…(Mediator)ï¼šå®ƒæ˜¯ä¸­ä»‹è€…çš„æ¥å£ï¼Œæä¾›äº†åŒäº‹å¯¹è±¡æ³¨å†Œä¸è½¬å‘åŒäº‹å¯¹è±¡ä¿¡æ¯çš„æŠ½è±¡æ–¹æ³•ã€‚</li>
<li>å…·ä½“ä¸­ä»‹è€…(Concrete Mediator)ï¼šå®ç°ä¸­ä»‹è€…æ¥å£ï¼Œå®šä¹‰ä¸€ä¸ªListæ¥ç®¡ç†åŒäº‹å¯¹è±¡ï¼Œåè°ƒå„ä¸ªåŒäº‹è§’è‰²ä¹‹é—´çš„äº¤äº’å…³ç³»ï¼Œå› æ­¤å®ƒä¾èµ–äºåŒäº‹è§’è‰²ã€‚</li>
<li>æŠ½è±¡åŒäº‹ç±»(Colleague)ï¼šå®šä¹‰åŒäº‹ç±»çš„æ¥å£ï¼Œä¿å­˜ä¸­ä»‹è€…å¯¹è±¡ï¼Œæä¾›åŒäº‹å¯¹è±¡äº¤äº’çš„æŠ½è±¡æ–¹æ³•ï¼Œå®ç°æ‰€æœ‰ç›¸äº’å½±å“çš„åŒäº‹ç±»çš„å…¬å…±åŠŸèƒ½ã€‚</li>
<li>å…·ä½“åŒäº‹ç±»(Concrete Colleague)ï¼šæ˜¯æŠ½è±¡åŒäº‹ç±»çš„å®ç°è€…ï¼Œå½“éœ€è¦ä¸å…¶ä»–åŒäº‹å¯¹è±¡äº¤äº’æ—¶ï¼Œç”±ä¸­ä»‹è€…å¯¹è±¡è´Ÿè´£åç»­çš„äº¤äº’ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.mediator.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.mediator.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: MediatorDemo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ä¸­ä»‹è€…</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediatorDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Mediator mediator = <span class="keyword">new</span> ConcreteMediator();</span><br><span class="line">        Colleague colleague1, colleague2;</span><br><span class="line">        colleague1 = <span class="keyword">new</span> ConcreteColleague1();</span><br><span class="line">        colleague2 = <span class="keyword">new</span> ConcreteColleague2();</span><br><span class="line">        mediator.register(colleague1);</span><br><span class="line">        mediator.register(colleague2);</span><br><span class="line">        colleague1.send();</span><br><span class="line">        colleague2.send();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ä¸­ä»‹è€…</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Mediator</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* æ³¨å†Œ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Colleague colleague)</span></span>;</span><br><span class="line">    <span class="comment">/* è½¬å‘ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">relay</span><span class="params">(Colleague colleague)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“ä¸­ä»‹è€…</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteMediator</span> <span class="keyword">extends</span> <span class="title">Mediator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Colleague&gt; colleagues = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Colleague colleague)</span> </span>&#123;</span><br><span class="line">        colleagues.add(colleague);</span><br><span class="line">        colleague.setMediator(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">relay</span><span class="params">(Colleague colleague)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Colleague colleague1 : colleagues) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!colleague1.equals(colleague)) &#123;</span><br><span class="line">                colleague1.receive();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡åŒäº‹ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Colleague</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(Colleague.class);</span><br><span class="line">    <span class="keyword">protected</span> Mediator mediator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMediator</span><span class="params">(Mediator mediator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mediator = mediator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“åŒäº‹ç±»1</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteColleague1</span> <span class="keyword">extends</span> <span class="title">Colleague</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteColleague1.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“åŒäº‹ç±»1æ”¶åˆ°è¯·æ±‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“åŒäº‹1å‘å‡ºè¯·æ±‚&quot;</span>);</span><br><span class="line">        mediator.relay(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“åŒäº‹ç±»2</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteColleague2</span> <span class="keyword">extends</span> <span class="title">Colleague</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteColleague2.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“åŒäº‹ç±»2æ”¶åˆ°è¯·æ±‚&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“åŒäº‹2å‘å‡ºè¯·æ±‚&quot;</span>);</span><br><span class="line">        mediator.relay(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-21è¿­ä»£å™¨æ¨¡å¼-Iterator"><a href="#2-21è¿­ä»£å™¨æ¨¡å¼-Iterator" class="headerlink" title="2.21è¿­ä»£å™¨æ¨¡å¼-Iterator"></a>2.21è¿­ä»£å™¨æ¨¡å¼-Iterator</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>æä¾›ä¸€ä¸ªå¯¹è±¡æ¥é¡ºåºè®¿é—®èšåˆå¯¹è±¡ä¸­çš„ä¸€ç³»åˆ—æ•°æ®ï¼Œè€Œä¸æš´éœ²èšåˆå¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>è®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡çš„å†…å®¹è€Œæ— é¡»æš´éœ²å®ƒçš„å†…éƒ¨è¡¨ç¤ºã€‚</li>
<li>éå†ä»»åŠ¡äº¤ç”±è¿­ä»£å™¨å®Œæˆï¼Œè¿™ç®€åŒ–äº†èšåˆç±»ã€‚</li>
<li>å®ƒæ”¯æŒä»¥ä¸åŒæ–¹å¼éå†ä¸€ä¸ªèšåˆï¼Œç”šè‡³å¯ä»¥è‡ªå®šä¹‰è¿­ä»£å™¨çš„å­ç±»ä»¥æ”¯æŒæ–°çš„éå†ã€‚</li>
<li>å¢åŠ æ–°çš„èšåˆç±»å’Œè¿­ä»£å™¨éƒ½å¾ˆæ–¹ä¾¿ï¼Œæ— é¡»ä¿®æ”¹åŸæœ‰ä»£ç ã€‚</li>
<li>å°è£…æ€§è‰¯å¥½ï¼Œä¸ºéå†ä¸åŒçš„èšåˆç»“æ„æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å¢åŠ äº†ç±»çš„ä¸ªæ•°ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡èšåˆè§’è‰²(Aggregate)ï¼šå®šä¹‰å­˜å‚¨ã€æ·»åŠ ã€åˆ é™¤èšåˆå¯¹è±¡ä»¥åŠåˆ›å»ºè¿­ä»£å™¨å¯¹è±¡çš„æ¥å£ã€‚</li>
<li>å…·ä½“èšåˆè‰²(Concrete Aggregate)ï¼šå®ç°æŠ½è±¡èšåˆç±»ï¼Œè¿”å›ä¸€ä¸ªå…·ä½“è¿­ä»£å™¨çš„å®ä¾‹ã€‚</li>
<li>æŠ½è±¡è¿­ä»£å™¨è§’è‰²(Iterator)ï¼šå®šä¹‰è®¿é—®å’Œéå†èšåˆå…ƒç´ çš„æ¥å£ï¼Œé€šå¸¸åŒ…å«hasNext()ã€first()ã€next()ç­‰æ–¹æ³•ã€‚</li>
<li>å…·ä½“è¿­ä»£å™¨è§’è‰²(Concrete Iterator)ï¼šå®ç°æŠ½è±¡è¿­ä»£å™¨æ¥å£ä¸­æ‰€å®šä¹‰çš„æ–¹æ³•ï¼Œå®Œæˆå¯¹èšåˆå¯¹è±¡çš„éå†ï¼Œè®°å½•éå†çš„å½“å‰ä½ç½®ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.iterator.pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.iterator.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: IteratorDemo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: è¿­ä»£å™¨æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IteratorDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = Logger.getLogger(IteratorDemo.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Aggregate aggregate = <span class="keyword">new</span> ConcreteAggregate();</span><br><span class="line">        aggregate.add(<span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">        aggregate.add(<span class="string">&quot;ParaK&quot;</span>);</span><br><span class="line">        aggregate.add(<span class="string">&quot;FlowerK&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;èšåˆçš„å†…å®¹&quot;</span>);</span><br><span class="line">        Iterator iterator = aggregate.getIterator();</span><br><span class="line">        log.info(iterator.first().toString());</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            log.info(iterator.next().toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡èšåˆ</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Aggregate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Object o)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(Object o)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">getIterator</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“èšåˆ</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteAggregate</span> <span class="keyword">implements</span> <span class="title">Aggregate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        list.add(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        list.remove(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator <span class="title">getIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">new</span> ConcreteIterator(list));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡è¿­ä»£å™¨</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">first</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Object <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“è¿­ä»£å™¨</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; list = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteIterator</span><span class="params">(List&lt;Object&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">first</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">        Object object = list.get(index);</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object object = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.hasNext()) &#123;</span><br><span class="line">            object = list.get(++index);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; list.size() - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-22-è®¿é—®è€…æ¨¡å¼-Visitor"><a href="#2-22-è®¿é—®è€…æ¨¡å¼-Visitor" class="headerlink" title="2.22 è®¿é—®è€…æ¨¡å¼-Visitor"></a>2.22 è®¿é—®è€…æ¨¡å¼-Visitor</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å°†ä½œç”¨äºæŸç§æ•°æ®ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œåˆ†ç¦»å‡ºæ¥å°è£…æˆç‹¬ç«‹çš„ç±»ï¼Œä½¿å…¶åœ¨ä¸æ”¹å˜æ•°æ®ç»“æ„çš„å‰æä¸‹å¯ä»¥æ·»åŠ ä½œç”¨äºè¿™äº›å…ƒç´ çš„æ–°çš„æ“ä½œã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>æ‰©å±•æ€§å¥½</li>
<li>å¤ç”¨æ€§å¥½</li>
<li>çµæ´»æ€§å¥½</li>
<li>ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å¢åŠ æ–°çš„å…ƒç´ å¾ˆå›°éš¾</li>
<li>ç ´åå°è£…</li>
<li>è¿åäº†ä¾èµ–å€’ç½®åŸåˆ™</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡è®¿é—®è€…(Visitor)ï¼šå®šä¹‰ä¸€ä¸ªè®¿é—®å…·ä½“å…ƒç´ çš„æ¥å£ï¼Œä¸ºæ¯ä¸ªå…·ä½“å…ƒç´ ç±»å¯¹åº”ä¸€ä¸ªè®¿é—®æ“ä½œvisit()ï¼Œè¯¥æ“ä½œä¸­çš„å‚æ•°ç±»å‹æ ‡è¯†äº†è¢«è®¿é—®çš„å…·ä½“å…ƒç´ ã€‚</li>
<li>å…·ä½“è®¿é—®è€…(Concrete Visitor)ï¼šå®ç°æŠ½è±¡è®¿é—®è€…è§’è‰²å£°æ˜çš„å„ä¸ªè®¿é—®æ“ä½œï¼Œç¡®å®šè®¿é—®è€…è®¿é—®ä¸€ä¸ªå…ƒç´ æ—¶è¯¥åšä»€ä¹ˆã€‚</li>
<li>æŠ½è±¡å…ƒç´ (Element)ï¼šå£°æ˜ä¸€ä¸ªåŒ…å«æ¥å—æ“ä½œaccept()çš„æ¥å£ï¼Œè¢«æ¥å—çš„è®¿é—®è€…å¯¹è±¡ä½œä¸ºaccept()çš„å‚æ•°ã€‚</li>
<li>å…·ä½“å…ƒç´ (Concrete Element)ï¼šå®ç°æŠ½è±¡å…ƒç´ è§’è‰²æä¾›çš„accept()æ“ä½œã€‚</li>
<li>å¯¹è±¡ç»“æ„(Object Structure)ï¼šåŒ…å«å…ƒç´ è§’è‰²çš„å®¹å™¨ï¼Œæä¾›è®©è®¿é—®è€…å¯¹è±¡éå†å®¹å™¨ä¸­çš„æ‰€æœ‰å…ƒç´ çš„æ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.visitor.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.visitor.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: VisitorDemo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: è®¿é—®è€…æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VisitorDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ObjectStructure structure = <span class="keyword">new</span> ObjectStructure();</span><br><span class="line">        structure.add(<span class="keyword">new</span> ConcreteElementA());</span><br><span class="line">        structure.add(<span class="keyword">new</span> ConcreteElementB());</span><br><span class="line">        structure.add(<span class="keyword">new</span> ConcreteElementC());</span><br><span class="line"></span><br><span class="line">        Visitor visitorA = <span class="keyword">new</span> ConcreteVisitorA();</span><br><span class="line">        Visitor visitorB = <span class="keyword">new</span> ConcreteVisitorB();</span><br><span class="line">        structure.accept(visitorA);</span><br><span class="line">        structure.accept(visitorB);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡è®¿é—®è€…</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Visitor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">visit</span><span class="params">(ConcreteElementA elementA)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">visit</span><span class="params">(ConcreteElementB elementB)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">visit</span><span class="params">(ConcreteElementC elementC)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“è®¿é—®è€…A</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteVisitorA</span> <span class="keyword">implements</span> <span class="title">Visitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteVisitorA.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ConcreteElementA elementA)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“è®¿é—®è€…Aè®¿é—®=&gt;å…·ä½“å…ƒç´ A&quot;</span>);</span><br><span class="line">        elementA.operaA();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ConcreteElementB elementB)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“è®¿é—®è€…Aè®¿é—®=&gt;å…·ä½“å…ƒç´ B&quot;</span>);</span><br><span class="line">        elementB.operaB();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ConcreteElementC elementC)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“è®¿é—®è€…Aè®¿é—®=&gt;å…·ä½“å…ƒç´ C&quot;</span>);</span><br><span class="line">        elementC.operaC();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“è®¿é—®è€…B</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteVisitorB</span> <span class="keyword">implements</span> <span class="title">Visitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteVisitorB.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ConcreteElementA elementA)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“è®¿é—®è€…Bè®¿é—®=&gt;å…·ä½“å…ƒç´ A&quot;</span>);</span><br><span class="line">        elementA.operaA();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ConcreteElementB elementB)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“è®¿é—®è€…Bè®¿é—®=&gt;å…·ä½“å…ƒç´ B&quot;</span>);</span><br><span class="line">        elementB.operaB();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ConcreteElementC elementC)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“è®¿é—®è€…Bè®¿é—®=&gt;å…·ä½“å…ƒç´ C&quot;</span>);</span><br><span class="line">        elementC.operaC();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡å…ƒç´ ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Element</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor visitor)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“å…ƒç´ A</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteElementA</span> <span class="keyword">implements</span> <span class="title">Element</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteElementA.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor visitor)</span> </span>&#123;</span><br><span class="line">        visitor.visit(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operaA</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“å…ƒç´ Aæ“ä½œ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“å…ƒç´ B</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteElementB</span> <span class="keyword">implements</span> <span class="title">Element</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteElementB.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor visitor)</span> </span>&#123;</span><br><span class="line">        visitor.visit(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operaB</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“å…ƒç´ Bæ“ä½œ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å…·ä½“å…ƒç´ C</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteElementC</span> <span class="keyword">implements</span> <span class="title">Element</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(ConcreteElementC.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor visitor)</span> </span>&#123;</span><br><span class="line">        visitor.visit(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operaC</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;å…·ä½“å…ƒç´ Cæ“ä½œ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å¯¹è±¡ç»“æ„è§’è‰²</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectStructure</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Element&gt; list = <span class="keyword">new</span> ArrayList&lt;Element&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor visitor)</span> </span>&#123;</span><br><span class="line">        Iterator&lt;Element&gt; iterator = list.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            iterator.next().accept(visitor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">        list.add(element);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Element element)</span> </span>&#123;</span><br><span class="line">        list.remove(element);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-23-å¤‡å¿˜å½•æ¨¡å¼-Memento"><a href="#2-23-å¤‡å¿˜å½•æ¨¡å¼-Memento" class="headerlink" title="2.23 å¤‡å¿˜å½•æ¨¡å¼-Memento"></a>2.23 å¤‡å¿˜å½•æ¨¡å¼-Memento</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>åœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ï¼Œä»¥ä¾¿ä»¥åå½“éœ€è¦æ—¶èƒ½å°†è¯¥å¯¹è±¡æ¢å¤åˆ°åŸå…ˆä¿å­˜çš„çŠ¶æ€ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>æä¾›äº†ä¸€ä¸ªå¯ä»¥æ¢å¤çŠ¶æ€çš„æœºåˆ¶</li>
<li>å®ç°å†…éƒ¨çŠ¶æ€çš„å°è£…</li>
<li>ç®€åŒ–äº†å‘èµ·äºº</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>èµ„æºæ¶ˆè€—å¤§</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>å‘èµ·äºº(Originator)ï¼šè®°å½•å½“å‰æ—¶åˆ»çš„å†…éƒ¨çŠ¶æ€ä¿¡æ¯ï¼Œæä¾›åˆ›å»ºå¤‡å¿˜å½•å’Œæ¢å¤å¤‡å¿˜å½•æ•°æ®çš„åŠŸèƒ½ï¼Œå®ç°å…¶ä»–ä¸šåŠ¡åŠŸèƒ½ï¼Œå®ƒå¯ä»¥è®¿é—®å¤‡å¿˜å½•é‡Œçš„æ‰€æœ‰ä¿¡æ¯ã€‚</li>
<li>å¤‡å¿˜å½•(Memento)ï¼šè´Ÿè´£å­˜å‚¨å‘èµ·äººçš„å†…éƒ¨çŠ¶æ€ï¼Œåœ¨éœ€è¦çš„æ—¶å€™æä¾›è¿™äº›å†…éƒ¨çŠ¶æ€ç»™å‘èµ·äººã€‚</li>
<li>ç®¡ç†è€…(Caretaker)ï¼šå¯¹å¤‡å¿˜å½•è¿›è¡Œç®¡ç†ï¼Œæä¾›ä¿å­˜ä¸è·å–å¤‡å¿˜å½•çš„åŠŸèƒ½ï¼Œä½†ä¸èƒ½å¯¹å¤‡å¿˜å½•è¿›è¡Œè®¿é—®ä¸ä¿®æ”¹ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.memento.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.memento.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: MementoDemo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: å¤‡å¿˜å½•æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MementoDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = Logger.getLogger(MementoDemo.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Originator originator = <span class="keyword">new</span> Originator();</span><br><span class="line">        Caretaker caretaker = <span class="keyword">new</span> Caretaker();</span><br><span class="line">        originator.setState(<span class="string">&quot;State1&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;åˆå§‹çŠ¶æ€ï¼š&quot;</span> + originator.getState());</span><br><span class="line">        <span class="comment">// ä¿å­˜çŠ¶æ€</span></span><br><span class="line">        caretaker.setMemento(originator.createMemento());</span><br><span class="line">        originator.setState(<span class="string">&quot;State2&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;æ–°çš„çŠ¶æ€ï¼š&quot;</span> + originator.getState());</span><br><span class="line">        <span class="comment">// æ¢å¤çŠ¶æ€</span></span><br><span class="line">        originator.restoreMemento(caretaker.getMemento());</span><br><span class="line">        log.info(<span class="string">&quot;æ¢å¤çŠ¶æ€ï¼š&quot;</span> + originator.getState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å¤‡å¿˜å½•</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memento</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Memento</span><span class="params">(String state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(String state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     å‘èµ·äºº</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Originator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setState</span><span class="params">(String state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Memento <span class="title">createMemento</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Memento(state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restoreMemento</span><span class="params">(Memento memento)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(memento.getState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ç®¡ç†è€…</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Caretaker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Memento memento;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Memento <span class="title">getMemento</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memento;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMemento</span><span class="params">(Memento memento)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.memento = memento;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2-24-è§£é‡Šå™¨æ¨¡å¼-Interpreter"><a href="#2-24-è§£é‡Šå™¨æ¨¡å¼-Interpreter" class="headerlink" title="2.24 è§£é‡Šå™¨æ¨¡å¼-Interpreter"></a>2.24 è§£é‡Šå™¨æ¨¡å¼-Interpreter</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ç»™åˆ†æå¯¹è±¡å®šä¹‰ä¸€ä¸ªè¯­è¨€ï¼Œå¹¶å®šä¹‰è¯¥è¯­è¨€çš„æ–‡æ³•è¡¨ç¤ºï¼Œå†è®¾è®¡ä¸€ä¸ªè§£æå™¨æ¥è§£é‡Šå…¶ä¸­çš„å¥å­ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>æ‰©å±•æ€§å¥½</li>
<li>å®¹æ˜“å®ç°</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>æ‰§è¡Œæ•ˆç‡è¾ƒä½</li>
<li>ä¼šå¼•èµ·ç±»è†¨èƒ€</li>
<li>å¯åº”ç”¨çš„åœºæ™¯æ¯”è¾ƒå°‘</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡è¡¨è¾¾å¼(Abstract Expression)ï¼šå®šä¹‰è§£é‡Šå™¨çš„æ¥å£ï¼Œçº¦å®šè§£é‡Šå™¨çš„è§£é‡Šæ“ä½œï¼Œä¸»è¦åŒ…å«è§£é‡Šæ–¹æ³•interpret()ã€‚</li>
<li>ç»ˆç»“ç¬¦è¡¨è¾¾å¼(Terminal Expression)ï¼šæŠ½è±¡è¡¨è¾¾å¼çš„å­ç±»ï¼Œç”¨æ¥å®ç°æ–‡æ³•ä¸­ä¸ç»ˆç»“ç¬¦ç›¸å…³çš„æ“ä½œï¼Œæ–‡æ³•ä¸­çš„æ¯æ¡ä¸€ä¸ªç»ˆç»“ç¬¦éƒ½å¯¹åº”äºä¸€ä¸ªéç»ˆç»“ç¬¦è¡¨è¾¾å¼ã€‚</li>
<li>éç»ˆç»“ç¬¦è¡¨è¾¾å¼(Terminal Expression)ï¼šæŠ½è±¡è¡¨è¾¾å¼çš„å­ç±»ï¼Œç”¨æ¥å®ç°æ–‡æ³•ä¸­ä¸éç»ˆç»“ç¬¦ç›¸å…³çš„æ“ä½œï¼Œæ–‡æ³•ä¸­çš„æ¯æ¡è§„åˆ™éƒ½å¯¹åº”äºä¸€ä¸ªéç»ˆç»“ç¬¦è¡¨è¾¾å¼ã€‚</li>
<li>ç¯å¢ƒ(Context)ï¼šé€šå¸¸åŒ…å«å„ä¸ªè§£é‡Šå™¨éœ€è¦çš„æ•°æ®æˆ–æ˜¯å…¬å…±çš„åŠŸèƒ½ï¼Œä¸€èˆ¬ç”¨æ¥ä¼ é€’è¢«æ‰€æœ‰è§£é‡Šå™¨å…±äº«çš„æ•°æ®ï¼Œåå¼€ä½ çš„è§£é‡Šå™¨å¯ä»¥ä»è¿™é‡Œè·å–è¿™äº›å€¼ã€‚</li>
<li>å®¢æˆ·ç«¯(Client)ï¼šä¸»è¦ä»»åŠ¡æ˜¯å°†éœ€è¦åˆ†æçš„å¥å­æˆ–è¡¨è¾¾å¼è½¬æ¢æˆä½¿ç”¨è§£é‡Šå™¨å¯¹è±¡æè¿°çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œç„¶åè°ƒç”¨è§£é‡Šå™¨çš„è§£é‡Šæ–¹æ³•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒè§’è‰²é—´æ¥è®¿é—®è§£é‡Šå™¨çš„è§£é‡Šæ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.interpreter.pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Project: DesignPattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Package: top.parak.interpreter.pattern &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; FileName: InterpreterDemo &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Description: è§£é‡Šå™¨æ¨¡å¼ &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/11/8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æµ‹è¯•ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterpreterDemo</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     æŠ½è±¡è¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AbstractExpression</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">interpret</span><span class="params">(String info)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ç»ˆç»“ç¬¦è¡¨è¾¾å¼ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TerminalExpression</span> <span class="keyword">implements</span> <span class="title">AbstractExpression</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interpret</span><span class="params">(String info)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* å¯¹ç»ˆç»“ç¬¦è¡¨è¾¾å¼çš„å¤„ç† */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     éç»ˆç»“ç¬¦è¡¨è¾¾å¼ç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NonTerminalExpression</span> <span class="keyword">implements</span> <span class="title">AbstractExpression</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interpret</span><span class="params">(String info)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* å¯¹éç»ˆç»“ç¬¦è¡¨è¾¾å¼çš„å¤„ç† */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> *     ç¯å¢ƒç±»</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AbstractExpression abstractExpression;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Context</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* æ•°æ®åˆå§‹åŒ– */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(String info)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* è°ƒç”¨ç›¸å…³è¡¨è¾¾å¼çš„è§£é‡Šæ–¹æ³• */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Software Engineering</category>
      </categories>
      <tags>
        <tag>Design Pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-2(å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹)</title>
    <url>/posts/62531/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="2-1-ç¬¬ä¸€éƒ¨åˆ†-çº¿ç¨‹å®‰å…¨"><a href="#2-1-ç¬¬ä¸€éƒ¨åˆ†-çº¿ç¨‹å®‰å…¨" class="headerlink" title="2.1 ç¬¬ä¸€éƒ¨åˆ†-çº¿ç¨‹å®‰å…¨"></a>2.1 ç¬¬ä¸€éƒ¨åˆ†-çº¿ç¨‹å®‰å…¨</h2><h3 id="2-1-1-çº¿ç¨‹å®‰å…¨é—®é¢˜"><a href="#2-1-1-çº¿ç¨‹å®‰å…¨é—®é¢˜" class="headerlink" title="2.1.1 çº¿ç¨‹å®‰å…¨é—®é¢˜"></a>2.1.1 çº¿ç¨‹å®‰å…¨é—®é¢˜</h3><p>æ¡ˆä¾‹ï¼šä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º0çš„é™æ€å˜é‡ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œç»“æœæ˜¯0å—ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;AddSub&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddSubDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                counter++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                counter--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.debug(<span class="string">&quot;counter = &#123;&#125;&quot;</span>, counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœæ˜¯å˜åŒ–çš„ã€‚</p>
<p>å¯¹äºé™æ€å˜é‡iï¼Œè‡ªå¢å’Œè‡ªå‡çš„å­—èŠ‚ç æŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"># i++</span><br><span class="line">getstatic i <span class="comment">// è·å–é™æ€å˜é‡içš„å€¼</span></span><br><span class="line">iconst_1    <span class="comment">// å‡†å¤‡å¸¸é‡1</span></span><br><span class="line">iadd        <span class="comment">// è‡ªå¢</span></span><br><span class="line">putstatic i <span class="comment">// å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i</span></span><br><span class="line"># i--</span><br><span class="line">getstatic i <span class="comment">// è·å–é™æ€å˜é‡içš„å€¼</span></span><br><span class="line">iconst_1    <span class="comment">// å‡†å¤‡å¸¸é‡1</span></span><br><span class="line">isub        <span class="comment">// è‡ªå‡</span></span><br><span class="line">putstatic i <span class="comment">// å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i</span></span><br></pre></td></tr></table></figure>

<p>Javaçš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢å’Œè‡ªå‡ï¼Œéœ€è¦åœ¨ä¸»å­˜å’Œå·¥ä½œå†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210407174859979.png" class="" title="image-20210407174859979"><br />

<p>å¦‚æœæ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œä»¥ä¸Š8è¡Œå­—èŠ‚ç æŒ‡ä»¤ï¼Œä¸ä¼šå‡ºç°é—®é¢˜ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210407175158573.png" class="" title="image-20210407175158573"><br />

<p>ä½†æ˜¯åœ¨åŒçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¼šäº§ç”ŸæŒ‡ä»¤é‡æ’åºï¼Œå¯¼è‡´å„ç§é—®é¢˜ï¼Œæ¯”å¦‚è„è¯»ï¼ˆè¯»å–æ›´æ–°æœªä¿å­˜çš„æ•°æ®ï¼‰ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210407175406638.png" class="" title="image-20210407175406638"><br />



<p><strong>æ‹“å±•</strong></p>
<p><code>i++</code>ã€<code>i--</code>ã€<code>++i</code>ã€<code>--i</code>ç­‰æ“ä½œéƒ½æ˜¯éåŸå­æ€§çš„ï¼Œå› ä¸ºJVMæŒ‡ä»¤å¯å¹¶éä¸€æ¡ã€‚å¯ä»¥åˆ†æä¸€ä¸‹å­—èŠ‚ç æŒ‡ä»¤ï¼ˆ<code>javap -v</code>ï¼‰ã€‚</p>
<p><code>i++</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">System.out.println(i++);</span><br></pre></td></tr></table></figure>

<p>å­—èŠ‚ç æŒ‡ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0 iconst_0                                         # å°†å¸¸é‡0åŠ è½½åˆ°æ ˆé¡¶</span><br><span class="line">1 istore_1                                         # å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå¹¶èµ‹å€¼ç»™å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„ä½ç½®</span><br><span class="line">2 getstatic #2 &lt;java&#x2F;lang&#x2F;System.out&gt;              # è·å–ç³»ç»Ÿç±»çš„é™æ€å±æ€§</span><br><span class="line">5 iload_1                                          # å°†å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„å…ƒç´ åŠ è½½åˆ°æ ˆé¡¶</span><br><span class="line">6 iinc 1 by 1                                      # ç›´æ¥æŠŠå±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„å…ƒç´ å€¼+1</span><br><span class="line">9 invokevirtual #3 &lt;java&#x2F;io&#x2F;PrintStream.println&gt;   # è°ƒç”¨æµçš„æ‰“å°æ–¹æ³•</span><br></pre></td></tr></table></figure>

<p>é¡ºåºï¼šå…ˆå°†å…ƒç´ åŠ è½½åˆ°æ ˆé¡¶ï¼Œç„¶åæ›´æ–°å±€éƒ¨å˜é‡è¡¨çš„å…ƒç´ çš„å€¼ã€‚</p>
<p><code>++i</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">System.out.println(++i);</span><br></pre></td></tr></table></figure>

<p>å­—èŠ‚ç æŒ‡ä»¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0 iconst_0                                         # å°†å¸¸é‡0åŠ è½½åˆ°æ ˆé¡¶</span><br><span class="line">1 istore_1                                         # å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå¹¶èµ‹å€¼ç»™å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„ä½ç½®</span><br><span class="line">2 getstatic #2 &lt;java&#x2F;lang&#x2F;System.out&gt;              # è·å–ç³»ç»Ÿç±»çš„é™æ€å±æ€§</span><br><span class="line">5 iinc 1 by 1                                      # ç›´æ¥æŠŠå±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„å…ƒç´ å€¼+1</span><br><span class="line">8 iload_1                                          # å°†å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„å…ƒç´ åŠ è½½åˆ°æ ˆé¡¶</span><br><span class="line">9 invokevirtual #3 &lt;java&#x2F;io&#x2F;PrintStream.println&gt;   # è°ƒç”¨æµçš„æ‰“å°æ–¹æ³•</span><br></pre></td></tr></table></figure>

<p>é¡ºåºï¼šå…ˆæ›´æ–°å±€éƒ¨å˜é‡è¡¨çš„å…ƒç´ çš„å€¼ï¼Œå†å°†å…ƒç´ åŠ è½½åˆ°æ ˆé¡¶ã€‚</p>
<h3 id="2-1-2-synchronizedè§£å†³æ–¹æ¡ˆ"><a href="#2-1-2-synchronizedè§£å†³æ–¹æ¡ˆ" class="headerlink" title="2.1.2 synchronizedè§£å†³æ–¹æ¡ˆ"></a>2.1.2 synchronizedè§£å†³æ–¹æ¡ˆ</h3><p>ä¸´ç•ŒåŒºï¼šä¸€æ®µä»£ç å—å†…å¦‚æœå†…å­˜å †å…±äº«èµ„æºçš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸ºä¸´ç•ŒåŒºã€‚</p>
<p>ç«æ€æ¡ä»¶ï¼šå¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„æ‰§è¡Œåºåˆ—ä¸åŒè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†ç«æ€æ¡ä»¶ã€‚</p>
<p>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ï¼š</p>
<ul>
<li>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼š<code>synchoronized</code>ï¼Œ<code>Lock</code></li>
<li>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡<code>AtomicInteger</code>ã€<code>AtomicLong</code></li>
</ul>
<p><strong>synchronized</strong></p>
<p>è¯­æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (å¯¹è±¡) &#123;</span><br><span class="line">    ä¸´ç•ŒåŒº</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£å†³ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;AddSub&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafeAddSubDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Integer counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                    counter++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                    counter--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.debug(<span class="string">&quot;counter = &#123;&#125;&quot;</span>, counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±èƒ½ä¿è¯è¾“å‡ºç»“æœä¸º0äº†ã€‚</p>
<p><strong>æ€è€ƒ</strong></p>
<p><code>synchronized</code>å®é™…æ˜¯ç”¨å¯¹è±¡é”ä¿è¯äº†ä¸´ç•ŒåŒºä»£ç çš„åŸå­æ€§ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­ã€‚</p>
<p>æ€è€ƒå¦‚ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li><p>å¦‚æœæŠŠ<code>synchronized(obj)</code>æ”¾åœ¨forå¾ªç¯çš„å¤–é¢ï¼Œå¦‚ä½•ç†è§£ï¼Ÿ</p>
<p>forå¾ªç¯ä¹Ÿæ˜¯ä¸€ä¸ªåŸå­æ“ä½œ, è¡¨ç°å‡ºåŸå­æ€§ã€‚</p>
</li>
<li><p>å¦‚æœt1<code>synchronized(obj1)</code> è€Œ t2<code>synchronized(obj2)</code>ä¼šæ€ä¹ˆè¿è¡Œ?<br>å› ä¸ºt1,ã€t2æ‹¿åˆ°ä¸æ˜¯åŒä¸€æŠŠå¯¹è±¡é”ï¼Œæ‰€ä»¥ä»–ä»¬ä»ç„¶ä¼šå‘ç°å®‰å…¨é—®é¢˜ï¼Œ å¿…é¡»è¦æ˜¯åŒä¸€æŠŠå¯¹è±¡é”ã€‚</p>
</li>
<li><p>å¦‚æœt1<code>synchronized(obj)</code>è€Œt2æ²¡æœ‰åŠ ä¼šæ€ä¹ˆæ · ?<br>å› ä¸ºt2æ²¡æœ‰åŠ é”ï¼Œæ‰€ä»¥t2ä¸éœ€è¦è·å–t1çš„é”ï¼Œ ç›´æ¥å°±å¯ä»¥æ‰§è¡Œä¸‹é¢çš„ä»£ç , ä»ç„¶ä¼šå‡ºç°å®‰å…¨é—®é¢˜ã€‚</p>
</li>
</ul>
<p><strong>é¢å‘å¯¹è±¡æ”¹è¿›</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;BetterAddAndSub&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BetterAddSubDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Room room = <span class="keyword">new</span> Room();</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                room.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                room.decrement();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.debug(<span class="string">&quot;counter = &#123;&#125;&quot;</span>, room.getCounter());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            counter++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            counter--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCounter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> counter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-1-3-å…«é”ç°è±¡"><a href="#2-1-3-å…«é”ç°è±¡" class="headerlink" title="2.1.3 å…«é”ç°è±¡"></a>2.1.3 å…«é”ç°è±¡</h3><p><strong>æ–¹æ³•ä¸Šçš„synchronized</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    	<span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰ä»·äºï¼ˆé”ä½çš„æ˜¯å®ä¾‹å¯¹è±¡ï¼‰</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">    	<span class="comment">// do something</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰ä»·äºï¼ˆé”ä½çš„æ˜¯ç±»å¯¹è±¡ï¼‰</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(Test.class) &#123;</span><br><span class="line">            <span class="comment">// do something</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>å…«é”ç°è±¡</strong></p>
<p>ï¼ˆ1ï¼‰æƒ…å†µä¸€ï¼š<code>synchronized</code>æ–¹æ³•é”ä½çš„æ˜¯å®ä¾‹å¯¹è±¡ï¼Œä¸¤ä¸ªæ–¹æ³•ä½¿ç”¨åŒä¸€ä¸ªé”ï¼Œè°å…ˆè·å–é”è°å…ˆæ‰§è¡Œã€‚</p>
<p>ç»“æœï¼š<u>AB</u></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LockTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockDemo1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Lock lock = <span class="keyword">new</span> Lock();</span><br><span class="line">        <span class="keyword">new</span> Thread(lock::printA, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(lock::printB, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Lock&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printA</span><span class="params">()</span> </span>&#123; log.debug(<span class="string">&quot;A =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime()); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123; log.debug(<span class="string">&quot;B =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime()); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰æƒ…å†µäºŒï¼š<code>synchronized</code>æ–¹æ³•é”ä½çš„æ˜¯å®ä¾‹å¯¹è±¡ï¼Œä¸¤ä¸ªæ–¹æ³•ä½¿ç”¨åŒä¸€ä¸ªé”ï¼Œè°å…ˆè·å–é”è°å…ˆæ‰§è¡Œã€‚</p>
<p>ç»“æœï¼š<u>AB</u></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LockTest1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockDemo2</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Lock2 lock = <span class="keyword">new</span> Lock2();</span><br><span class="line">        <span class="keyword">new</span> Thread(lock::printA, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(lock::printB, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Lock&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lock2</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;A =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;B =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ3ï¼‰æƒ…å†µä¸‰ï¼šæœªåŠ <code>synchronized</code>çš„æ–¹æ³•ä¸éœ€è¦ç­‰å¾…é”ã€‚</p>
<p>ç»“æœï¼š<u>CAB</u></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LockTest3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockDemo3</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Lock3 lock = <span class="keyword">new</span> Lock3();</span><br><span class="line">        <span class="keyword">new</span> Thread(lock::printA, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(lock::printB, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(lock::printC, <span class="string">&quot;C&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Lock3&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lock3</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>); <span class="comment">// ä¼šè®©å‡ºCPUæ‰§è¡Œæƒ</span></span><br><span class="line">        log.debug(<span class="string">&quot;A =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;B =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;C =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ4ï¼‰æƒ…å†µå››ï¼šä¸¤ä¸ªçº¿ç¨‹çš„æ–¹æ³•é”ä½æ˜¯å„è‡ªçš„å®ä¾‹å¯¹è±¡ï¼Œä¸å­˜åœ¨äº’æ–¥ï¼Œå¹¶ä¸”ç¡çœ ä¼šè®©å‡ºCPUæ‰§è¡Œæƒã€‚</p>
<p>ç»“æœï¼š<u>BA</u></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LockTest4&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockDemo4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Lock4 lock1 = <span class="keyword">new</span> Lock4();</span><br><span class="line">        Lock4 lock2 = <span class="keyword">new</span> Lock4();</span><br><span class="line">        <span class="keyword">new</span> Thread(lock1::printA, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(lock2::printB, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Lock4&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lock4</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>); </span><br><span class="line">        log.debug(<span class="string">&quot;A =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;B =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ5ï¼‰æƒ…å†µ5ï¼š<code>static synchronized</code>æ–¹æ³•é”ä½çš„æ˜¯ç±»å¯¹è±¡ï¼Œ<code>synchronized</code>æ–¹æ³•é”ä½çš„æ˜¯å®ä¾‹å¯¹è±¡ã€‚ä¸¤çº¿ç¨‹é”ä½çš„å¯¹è±¡ä¸åŒï¼Œä¸å­˜åœ¨äº’æ–¥ã€‚</p>
<p>ç»“æœï¼š<u>BA</u></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LockTest5&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockDemo5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Lock5 lock5 = <span class="keyword">new</span> Lock5();</span><br><span class="line">        <span class="keyword">new</span> Thread(Lock5::printA, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(lock5::printB, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Lock5&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lock5</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;A =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;B =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ6ï¼‰æƒ…å†µå…­ï¼š<code>synchronized</code>æ–¹æ³•é”ä½çš„æ˜¯ç±»å¯¹è±¡ï¼Œä¸¤çº¿ç¨‹ä½¿ç”¨åŒä¸€ä¸ªé”ï¼Œè°å…ˆè·å–è°å…ˆæ‰§è¡Œã€‚</p>
<p>ç»“æœï¼š<u>AB</u></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LockTest6&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockDemo6</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(Lock6::printA, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(Lock6::printB, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Lock6&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lock6</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;A =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;B =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ7ï¼‰æƒ…å†µä¸ƒï¼šä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨çš„ä¸€ä¸ªæ˜¯ç±»å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯å®ä¾‹å¯¹è±¡ï¼Œä¸å­˜åœ¨äº’æ–¥ã€‚</p>
<p>ç»“æœï¼š<u>BA</u></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LockTest7&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockDemo7</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Lock7 lock7 = <span class="keyword">new</span> Lock7();</span><br><span class="line">        <span class="keyword">new</span> Thread(Lock7::printA, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(lock7::printB, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Lock7&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lock7</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;A =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;B =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ8ï¼‰æƒ…å†µå…«ï¼šä¸¤ä¸ªçº¿ç¨‹çš„æ–¹æ³•é”ä½çš„éƒ½æ˜¯ç±»å¯¹è±¡ï¼Œè°å…ˆè·å–è°å…ˆæ‰§è¡Œã€‚</p>
<p>ç»“æœï¼š<u>AB</u></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LockTest8&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockDemo8</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(Lock8::printA, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(Lock8::printB, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Lock8&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lock8</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;A =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">printB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;B =&gt; [&#123;&#125;]&quot;</span>, System.nanoTime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-1-4-å˜é‡çš„çº¿ç¨‹å®‰å…¨"><a href="#2-1-4-å˜é‡çš„çº¿ç¨‹å®‰å…¨" class="headerlink" title="2.1.4  å˜é‡çš„çº¿ç¨‹å®‰å…¨"></a>2.1.4  å˜é‡çš„çº¿ç¨‹å®‰å…¨</h3><p>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡ï¼š</p>
<ul>
<li>å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li>
<li>å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼š<ul>
<li>å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li>
<li>å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li>
</ul>
</li>
</ul>
<p>å±€éƒ¨å˜é‡ï¼š</p>
<ul>
<li>å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li>å±€éƒ¨å˜é‡çš„å¼•ç”¨æœªå¿…æ˜¯çº¿ç¨‹å®‰å…¨çš„<ul>
<li>å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li>å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»äº†æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li>
</ul>
</li>
</ul>
<p><strong>æˆå‘˜å˜é‡æ¡ˆä¾‹åˆ†æ</strong></p>
<p>æœ‰å¦‚ä¸‹ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsafeOperation</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">(<span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            <span class="comment">// &#123; ä¸´ç•ŒåŒºï¼Œä¼šäº§ç”Ÿç«æ€æ¡ä»¶</span></span><br><span class="line">                method2();</span><br><span class="line">                method3();</span><br><span class="line">            <span class="comment">// &#125; ä¸´ç•ŒåŒº</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123; list.add(<span class="string">&quot;1&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123; list.remove(<span class="number">0</span>); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå¦‚ä¸‹ä»£ç åˆ™ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;UnsafeArrayList&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeArrayListDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THREAD_NUMBER = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOOP_NUMBER = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        UnsafeOperation operation = <span class="keyword">new</span> UnsafeOperation();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THREAD_NUMBER; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; operation.method1(LOOP_NUMBER), <span class="string">&quot;Thread&quot;</span> + (i + <span class="number">1</span>)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ†æï¼š</p>
<ul>
<li>ä¸¤ä¸ªçº¿ç¨‹ä¸­çš„<code>method2</code>å¼•ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ä¸­çš„listæˆå‘˜å˜é‡ã€‚</li>
<li><code>method3</code>å’Œ<code>method2</code>åˆ†æç›¸åŒã€‚</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210407220707659.png" class="" title="image-20210407220707659"><br />

<p>å°†åŸç±»ä¸­çš„æˆå‘˜å˜é‡ä¿®æ”¹ä¸ºå±€éƒ¨å˜é‡åˆ™ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SafeOperation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">(<span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            method2(list);</span><br><span class="line">            method3(list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123; list.add(<span class="string">&quot;1&quot;</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123; list.remove(<span class="number">0</span>); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ†æï¼š</p>
<ul>
<li><code>list</code>æ˜¯å±€éƒ¨å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨æ—¶ä¼šåˆ›å»ºå…¶ä¸åŒå®ä¾‹ï¼Œæ²¡æœ‰å…±äº«ã€‚</li>
<li><code>method2</code>çš„å‚æ•°æ˜¯ä»<code>method1</code>ä¸­ä¼ é€’è¿‡æ¥çš„ï¼Œä¸<code>method1</code>ä¸­å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡ã€‚</li>
<li><code>method3</code>çš„å‚æ•°åˆ†æä¸<code>method2</code>ç›¸åŒã€‚</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210407221447318.png" class="" title="image-20210407221447318"><br />



<p><strong>privateæˆ–finalçš„é‡è¦æ€§</strong></p>
<p>åœ¨ä¸Šè¿°çš„<code>SafeOperation</code>ä¸­ï¼Œå¦‚æœæŠŠ<code>method2</code>å’Œ<code>method3</code>çš„æ–¹æ³•ä¿®æ”¹ä¸º<code>public</code>ä¼šä¸ä¼šå¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</p>
<p>æƒ…å†µä¸€ï¼šæœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨<code>method2</code>å’Œ<code>method3</code>ã€‚</p>
<p>ç»“æœï¼šä¸ä¼šå¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>method1</code>ä¸­çš„å±€éƒ¨å˜é‡<code>list</code>ä¸å…¶ä»–çº¿ç¨‹ä¼ ç»™<code>method2</code>å’Œ<code>method3</code>çš„å‚æ•°ä¸åŒã€‚</p>
<p>æƒ…å†µäºŒï¼šä¸º<code>SafeOperation</code>æ·»åŠ å­ç±»ï¼Œå­ç±»è¦†ç›–<code>method3</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubSafeOperation</span> <span class="keyword">extends</span> <span class="title">SafeOperation</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; list.remove(<span class="number">0</span>)).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼šç”±äº<code>method3</code>çš„è®¿é—®æƒé™ä¸º<code>public</code>ï¼Œæ­¤æ—¶å­ç±»é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œå­ç±»å’Œçˆ¶ç±»å…±äº«<code>list</code>å¯¹è±¡ï¼Œåœ¨å­ç±»ä¸­æ–°å¼€çº¿ç¨‹æ¥æ“ä½œ<code>list</code>å¯¹è±¡ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<p>æ‰€ä»¥ä¸æƒ³å­ç±»é‡å†™çˆ¶ç±»çš„æ–¹æ³•çš„ï¼Œéœ€è¦å°†çˆ¶ç±»ä¸­çš„æ–¹æ³•è®¾ç½®ä¸º<code>private</code>æˆ–è€…<code>final</code>ï¼Œè¿™ä¾¿æ˜¯å¼€é—­åŸåˆ™ä¸­çš„ã€é—­ã€‘ã€‚</p>
<h3 id="2-1-5-ä¹ é¢˜"><a href="#2-1-5-ä¹ é¢˜" class="headerlink" title="2.1.5 ä¹ é¢˜"></a>2.1.5 ä¹ é¢˜</h3><p>ï¼ˆ1ï¼‰å–ç¥¨é—®é¢˜</p>
<p>å”®ç¥¨çª—å£æœ‰1000å¼ ç¥¨ï¼Œæ¨¡æ‹Ÿ1000ä¸ªäººä¹°ç¥¨ï¼ŒæŸ¥çœ‹æœ€åå‰©ä½™ç¥¨æ•°å’Œå”®å‡ºç¥¨æ•°ä¹‹å’Œæ˜¯å¦ä¸º1000ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ExerciseSell&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExerciseSellDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Randomä¸ºçº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšæœºæ•°1~5</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">randomAmount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> random.nextInt(<span class="number">5</span>) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// å”®ç¥¨çª—å£ï¼Œæ€»å…±1000å¼ ç¥¨</span></span><br><span class="line">        TicketWindow window = <span class="keyword">new</span> TicketWindow(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// çº¿ç¨‹é›†åˆï¼Œæ¨¡æ‹Ÿå¤šäººä¹°ç¥¨</span></span><br><span class="line">        List&lt;Thread&gt; threadList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// å–å‡ºçš„ç¥¨æ•°ç»Ÿè®¡ï¼ŒVectorçº¿ç¨‹å®‰å…¨</span></span><br><span class="line">        List&lt;Integer&gt; amountList = <span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿ1000ä¸ªäººä¹°ç¥¨</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// ä¹°ç¥¨</span></span><br><span class="line">                <span class="keyword">int</span> amount = window.sell(randomAmount());</span><br><span class="line">                <span class="comment">// ç¡çœ </span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(randomAmount());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ç»Ÿè®¡ä¹°ç¥¨æ•°</span></span><br><span class="line">                amountList.add(amount);</span><br><span class="line">            &#125;);</span><br><span class="line">            threadList.add(thread);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threadList) &#123;</span><br><span class="line">            thread.join();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŸ¥çœ‹ä½™ç¥¨æ•°é‡å’Œå”®ç¥¨æ•°é‡ä¹‹å’Œæ˜¯å¦ä¸º1000</span></span><br><span class="line">        log.debug(<span class="string">&quot;ä½™ç¥¨ =&gt; [&#123;&#125;]&quot;</span>, window.getCount());</span><br><span class="line">        log.debug(<span class="string">&quot;å”®ç¥¨ =&gt; [&#123;&#125;]&quot;</span>, amountList.stream().mapToInt(i -&gt; i).sum());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å”®ç¥¨çª—å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TicketWindow</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç¥¨æ€»æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TicketWindow</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.count = count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ä½™ç¥¨æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å”®ç¥¨</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sell</span><span class="params">(<span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.count &gt;= amount) &#123;</span><br><span class="line">            <span class="keyword">this</span>.count -= amount;</span><br><span class="line">            <span class="keyword">return</span> amount;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æµ‹å‡ºå¼‚å¸¸ç»“æœï¼Œä½¿ç”¨windowsæµ‹è¯•è„šæœ¬ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> /L %n <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">10</span>) <span class="keyword">do</span> java <span class="literal">-cp</span> <span class="string">&quot;.;C:\Java\maven\localRepository\org\projectlombok\lombok\1.18.12\lombok-1.18.12.jar;C:\Java\maven\localRepository\ch\qos\logback\logback-classic\1.1.2\logback-classic-1.1.2.jar;C:\Java\maven\localRepository\ch\qos\logback\logback-core\1.1.2\logback-core-1.1.2.jar;C:\Java\maven\localRepository\org\slf4j\slf4j-api\1.7.6\slf4j-api-1.7.6.jar&quot;</span> top.parak.safe.ExerciseSellDemo</span><br></pre></td></tr></table></figure>

<p>å¤šæ¬¡æµ‹è¯•ï¼Œç»ˆäºå‘ç°é”™è¯¯ç»“æœï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210408140200022.png" class="" title="image-20210408140200022"><br />

<p>åˆ†æåŸå› ï¼Œå°±åœ¨äºä¸´ç•ŒåŒº<code>TicketWindow</code>çš„<code>sell()</code>æ–¹æ³•ï¼Œå¤šä¸ªçº¿ç¨‹å¯¹ç±»çš„æˆå‘˜å˜é‡<code>count</code>è¿›è¡Œå†™æ“ä½œï¼Œè€Œè¿™ä¸ªæ–¹æ³•å¹¶æœªå—åˆ°ä¿æŠ¤ï¼Œäºæ˜¯å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚åªéœ€è¦åœ¨æ–¹æ³•å¤´ä¸Šæ ‡è¯†<code>synchronized</code>å³å¯ï¼Œé”ä½å®ä¾‹å¯¹è±¡ï¼Œåˆ™çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>ï¼ˆ2ï¼‰è½¬è´¦é—®é¢˜</p>
<p>ä¸¤ä¸ªè´¦æˆ·ä½™é¢éƒ½ä¸º1000ï¼Œäº’ç›¸è½¬è´¦1000æ¬¡ï¼ŒæŸ¥çœ‹æœ€åä¸¤ä¸ªè´¦æˆ·ä½™é¢ä¹‹å’Œæ˜¯å¦ä¸º2000ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ExerciseTransfer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExerciseTransferDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Randomä¸ºçº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éšæœºæ•°1~100</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">randomAmount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> random.nextInt(<span class="number">100</span>) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿä¸¤ä¸ªè´¦æˆ·</span></span><br><span class="line">        Account k1 = <span class="keyword">new</span> Account(<span class="number">1000</span>);</span><br><span class="line">        Account k2 = <span class="keyword">new</span> Account(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// äº’ç›¸è½¬è´¦1000æ¬¡</span></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">               k1.transfer(k2, randomAmount());</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                k2.transfer(k1, randomAmount());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        <span class="comment">// æŸ¥çœ‹è½¬è´¦2000æ¬¡åçš„ä½™é¢</span></span><br><span class="line">        log.debug(<span class="string">&quot;k1 =&gt; [&#123;&#125;]&quot;</span>, k1.getMoney());</span><br><span class="line">        log.debug(<span class="string">&quot;k2 =&gt; [&#123;&#125;]&quot;</span>, k2.getMoney());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è´¦æˆ·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> money;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(<span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMoney</span><span class="params">(<span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.money &gt;= amount) &#123;</span><br><span class="line">            <span class="keyword">this</span>.setMoney(<span class="keyword">this</span>.getMoney() - amount);</span><br><span class="line">            target.setMoney(target.getMoney() + amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-08 14:47:33.703 [main] DEBUG ExerciseTransfer - k1 &#x3D;&gt; [1]</span><br><span class="line">2021-04-08 14:47:33.706 [main] DEBUG ExerciseTransfer - k2 &#x3D;&gt; [145]</span><br></pre></td></tr></table></figure>

<p>å‘ç°<code>k1</code>å’Œ<code>k2</code>çš„ä½™é¢ä¹‹å’Œä¸ä¸º2000ï¼Œæ‰€ä»¥<code>Account</code>æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</p>
<p>ç”±äºè½¬è´¦éœ€è¦æ“ä½œè‡ªå·±å’Œå¯¹æ–¹çš„<code>money</code>ï¼Œæ‰€ä»¥éœ€è¦ç›´æ¥é”ä½ä¸¤ä¸ªç±»çš„<code>money</code>ï¼Œå³é”ä½<code>Account</code>ç±»ã€‚</p>
<p>æ”¹è¿›å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (Account.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.money &gt;= amount) &#123;</span><br><span class="line">            <span class="keyword">this</span>.setMoney(<span class="keyword">this</span>.getMoney() - amount);</span><br><span class="line">            target.setMoney(target.getMoney() + amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="2-2-ç¬¬äºŒéƒ¨åˆ†-Monitor"><a href="#2-2-ç¬¬äºŒéƒ¨åˆ†-Monitor" class="headerlink" title="2.2 ç¬¬äºŒéƒ¨åˆ†-Monitor"></a>2.2 ç¬¬äºŒéƒ¨åˆ†-Monitor</h2><h3 id="2-2-1-Monitor"><a href="#2-2-1-Monitor" class="headerlink" title="2.2.1 Monitor"></a>2.2.1 Monitor</h3><p><strong>Javaå¯¹è±¡å¤´</strong></p>
<p>æ™®é€šå¯¹è±¡</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210408123514132.png" class="" title="image-20210408123514132"><br />

<p>æ•°ç»„å¯¹è±¡</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210408123633123.png" class="" title="image-20210408123633123"><br />

<p>å…¶ä¸­Mark Wordç»“æ„ä¸ºï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210408123818981.png" class="" title="image-20210408123818981"><br />

<ul>
<li><code>Normal</code>ï¼šä¸€èˆ¬çŠ¶æ€ï¼Œæ²¡æœ‰åŠ ä»»ä½•é”ï¼ŒMark Wordå‰é¢30ä½ä¿å­˜çš„æ˜¯å¯¹è±¡çš„ä¿¡æ¯ï¼Œæœ€å2ä½ä¸ºçŠ¶æ€ï¼ˆ01ï¼‰ï¼Œå€’æ•°ç¬¬ä¸‰ä½è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨åå‘é”ï¼ˆæœªä½¿ç”¨ï¼š0ï¼‰</li>
<li><code>Biased</code>ï¼šåå‘çŠ¶æ€ï¼Œä½¿ç”¨åå‘é”ï¼ŒMark Wordå‰é¢30ä½ä¿å­˜å½“å‰çº¿ç¨‹çš„IDï¼Œæœ€å2ä½ä¸ºçŠ¶æ€ï¼ˆ01ï¼‰ï¼Œå€’æ•°ç¬¬ä¸‰ä½è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨åå‘é”ï¼ˆä½¿ç”¨ï¼š1ï¼‰</li>
<li><code>Lightweight</code>ï¼šä½¿ç”¨è½»é‡çº§é”ï¼ŒMark Wordå‰30ä½ä¿å­˜çš„æ˜¯é”è®°å½•çš„æŒ‡é’ˆï¼Œæœ€å2ä½ä¸ºçŠ¶æ€ï¼ˆ00ï¼‰</li>
<li><code>Heavyweight</code>ï¼šä½¿ç”¨é‡é‡çº§é”ï¼ŒMark Wordå‰30ä½ä¿å­˜çš„æ˜¯Monitorçš„åœ°å€æŒ‡é’ˆï¼Œæœ€å2ä½çŠ¶æ€ï¼ˆ10ï¼‰</li>
</ul>
<p><strong>Monitor</strong></p>
<p>Monitorè¢«ç¿»è¯‘ä¸ºç›‘è§†å™¨æˆ–ç®¡ç¨‹ã€‚</p>
<p>æ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ªMonitorå¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨<code>synchronized</code>ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„Mark Wordä¸­å°±è¢«è®¾ç½®æŒ‡å‘Monitorå¯¹è±¡çš„æŒ‡é’ˆã€‚</p>
<p>Monitorç»“æ„å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210408204555166.png" class="" title="image-20210408204555166"><br />

<ul>
<li>åˆšå¼€å§‹<code>Monitor</code>ä¸­<code>Owner</code>ä¸ºnullã€‚</li>
<li>å½“<code>Thread-2</code>æ‰§è¡Œ<code>synchronized(obj)</code>å°±ä¼šå°†<code>Monitor</code>çš„æ‰€æœ‰è€…<code>Owner</code>ç½®ä¸º<code>Thread-2</code>ï¼Œ<code>Monitor</code>ä¸­åªèƒ½æœ‰ä¸€ä¸ª<code>Owner</code>ã€‚</li>
<li>å½“<code>Thread-2</code>ä¸Šé”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ<code>Thread-3</code>ã€<code>Thread-4</code>ã€<code>Thread-5</code>ä¹Ÿæ¥æ‰§è¡Œ<code>synchronized(obj)</code>ï¼Œå°±ä¼šè¿›å…¥<code>EntryList BLOCKED</code>ã€‚</li>
<li><code>Thread-2</code>æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œç„¶åå”¤é†’<code>EntryList</code>ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰çš„æ˜¯éå…¬å¹³çš„ã€‚</li>
<li>å›¾ä¸­çš„<code>WaitSet</code>ä¸­çš„<code>Thread-0</code>ã€<code>Thread-1</code>æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥<code>WAITING</code>çŠ¶æ€çš„çº¿ç¨‹ã€‚</li>
</ul>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>synchronizedå¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„Monitoræ‰æœ‰ä¸Šè¿°çš„æ•ˆæœã€‚</li>
<li>ä¸åŠ synchronizedçš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™ã€‚</li>
</ul>
<h3 id="2-2-2-synchronizedåŸç†"><a href="#2-2-2-synchronizedåŸç†" class="headerlink" title="2.2.2 synchronizedåŸç†"></a>2.2.2 synchronizedåŸç†</h3><p>Demoï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">        counter++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­—èŠ‚ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">   descriptor: ([Ljava/lang/String;)V</span><br><span class="line">   flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">   Code:</span><br><span class="line">     stack=<span class="number">2</span>, locals=<span class="number">3</span>, args_size=<span class="number">1</span></span><br><span class="line">        0: getstatic     #2         // ä»ç±»ä¸­è·å–é™æ€å˜é‡lock (synchronizedå¼€å§‹)</span><br><span class="line">        <span class="number">3</span>: dup                      <span class="comment">// å¤åˆ¶æ“ä½œæ•°æ ˆçš„æ ˆé¡¶æ•°å€¼</span></span><br><span class="line">        <span class="number">4</span>: astore_1                 <span class="comment">// å°†å¤åˆ¶çš„å¼•ç”¨æ’å…¥åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®</span></span><br><span class="line">        <span class="number">5</span>: monitorenter             <span class="comment">// è¿›å…¥lockå¯¹è±¡çš„MarkWordçš„monitor</span></span><br><span class="line">        6: getstatic     #3         // ä»ç±»ä¸­è·å–é™æ€å˜é‡i</span><br><span class="line">        <span class="number">9</span>: iconst_1                 <span class="comment">// å°†iæ”¾å…¥å¸¸é‡æ± </span></span><br><span class="line">       <span class="number">10</span>: iadd                     <span class="comment">// è®©iè‡ªå¢</span></span><br><span class="line">       11: putstatic     #3         // å°†ç±»ä¸­çš„é™æ€å˜é‡iå€¼è®¾ç½®ä¸ºæ–°å€¼</span><br><span class="line">       <span class="number">14</span>: aload_1                  <span class="comment">// å¯¼å‡ºå±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„ä½ç½®çš„å¯¹è±¡ï¼Œå³lockå¼•ç”¨</span></span><br><span class="line">       <span class="number">15</span>: monitorexit              <span class="comment">// é€€å‡ºlockå¯¹è±¡çš„MarkWordçš„monitorï¼Œå”¤é†’EntryList</span></span><br><span class="line">       <span class="number">16</span>: goto          <span class="number">24</span>         <span class="comment">// ç›´æ¥goto24çš„return </span></span><br><span class="line">       <span class="number">19</span>: astore_2                 <span class="comment">// å°†å¼‚å¸¸å¯¹è±¡æ’å…¥åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½®</span></span><br><span class="line">       <span class="number">20</span>: aload_1                  <span class="comment">// åŠ è½½å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„ä½ç½®çš„å¯¹è±¡ï¼Œå³lockå¼•ç”¨</span></span><br><span class="line">       <span class="number">21</span>: monitorexit              <span class="comment">// é€€å‡ºlockå¯¹è±¡çš„MarkWordçš„monitorï¼Œå”¤é†’EntryList</span></span><br><span class="line">       <span class="number">22</span>: aload_2                  <span class="comment">// åŠ è½½å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º2çš„ä½ç½®çš„å¯¹è±¡ï¼Œå³å¼‚å¸¸</span></span><br><span class="line">       <span class="number">23</span>: athrow                   <span class="comment">// throw Exception</span></span><br><span class="line">       <span class="number">24</span>: <span class="keyword">return</span></span><br><span class="line">     Exception table:</span><br><span class="line">        from    to  target type</span><br><span class="line">            <span class="number">6</span>    <span class="number">16</span>    <span class="number">19</span>   any     <span class="comment">// åŒæ­¥ä»£ç å—6-16ï¼Œå…±äº«ä¸€ä¸ªå¼‚å¸¸</span></span><br><span class="line">           <span class="number">19</span>    <span class="number">22</span>    <span class="number">19</span>   any     <span class="comment">// åŒæ­¥ä»£ç å—19-22ï¼Œå…±äº«ä¸€ä¸ªå¼‚å¸¸</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨<code>synchronized</code>æ—¶JVMä¼šæ ¹æ®ç¯å¢ƒæ‰¾åˆ°å¯¹è±¡çš„<code>monitor</code>ï¼Œæ ¹æ®<code>monitor</code>çš„çŠ¶æ€è¿›è¡ŒåŠ è§£é”çš„åˆ¤æ–­ã€‚å¦‚æœæˆåŠŸåŠ é”å°±æˆä¸ºè¯¥<code>monitor</code>çš„å”¯ä¸€æŒæœ‰è€…ï¼Œmonitoråœ¨è¢«é‡Šæ”¾å‰ä¸èƒ½å†è¢«å…¶ä»–çº¿ç¨‹è·å–ã€‚</p>
<p>åŒæ­¥ä»£ç å—ä½¿ç”¨<code>monitorenter</code>å’Œ<code>monitorexit</code>è¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤è·å–å’Œé‡Šæ”¾<code>monitor</code>ã€‚è¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤éƒ½éœ€è¦ä¸€ä¸ªå¼•ç”¨ç±»å‹çš„å‚æ•°æŒ‡æ˜è¦é”å®šå’Œè§£é”çš„å¯¹è±¡ï¼Œå¯¹äºæ™®é€šæ–¹æ³•ï¼Œé”æ—¶å½“å‰å®ä¾‹å¯¹è±¡ï¼›å¯¹äºé™æ€æ–¹æ³•ï¼Œæ‰€æ˜¯å½“å‰ç±»çš„Classå¯¹è±¡ï¼›å¯¹äºåŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯<code>synchronized</code>æ‹¬å·ä¸­çš„å¯¹è±¡ã€‚</p>
<p>ä¸å…¬å¹³çš„åŸå› ï¼š</p>
<p>æ‰€æœ‰æ”¶åˆ°é”è¯·æ±‚çš„çº¿ç¨‹é¦–å…ˆè‡ªæ—‹ï¼Œå¦‚æœé€šè¿‡è‡ªæ—‹ä¹Ÿæ²¡æœ‰è·å–é”å°†è¢«æ”¾å…¥WaitSetï¼Œè¯¥åšæ³•å·²ç»å¯¹äºè¿›å…¥é˜Ÿåˆ—çš„çº¿ç¨‹ä¸å…¬å¹³ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢WaitSetå°¾éƒ¨çš„å…ƒç´ è¢«å¤§é‡çº¿ç¨‹è¿›è¡ŒCASè®¿é—®å½±å“æ€§èƒ½ï¼ŒOwnerçº¿ç¨‹ä¼šåœ¨é‡Šæ”¾é”æ—¶å°†WaitSetçš„éƒ¨åˆ†çº¿ç¨‹ç§»åŠ¨åˆ°EntryListå¹¶ä¸”æŒ‡å®šæŸä¸ªçº¿ç¨‹ä¸ºOnDeckçº¿ç¨‹ï¼Œè¯¥è¡Œä¸ºå«åšç«äº‰åˆ‡æ¢ï¼Œç‰ºç‰²äº†å…¬å¹³æ€§ä½†æé«˜äº†æ€§èƒ½ã€‚</p>
<h3 id="2-2-3-è½»é‡çº§é”"><a href="#2-2-3-è½»é‡çº§é”" class="headerlink" title="2.2.3 è½»é‡çº§é”"></a>2.2.3 è½»é‡çº§é”</h3><p>ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è®¿é—®ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚</p>
<p>è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯<code>synchronized</code>ã€‚</p>
<p>å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> vod <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å—A</span></span><br><span class="line">        method2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å—B</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŠ é”æµç¨‹ï¼š</p>
<ul>
<li><p>æ ˆå¸§ä¸­åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰å¯¹è±¡ï¼šæ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„Mark Word</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210409150238190.png" class="" title="image-20210409150238190"><br />
</li>
<li><p>è®©é”è®°å½•ä¸­Object referenceæŒ‡å‘é”å¯¹è±¡ï¼Œå¹¶å°è¯•ç”¨CASæ›¿æ¢Objectçš„Mark Wordï¼Œå°†Mark Wordçš„å€¼å­˜å…¥é”è®°å½•</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210409150651052.png" class="" title="image-20210409150651052"><br />
</li>
<li><p>å¦‚æœCASæ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº†é”è®°å½•åœ°å€å’ŒçŠ¶æ€ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”ï¼Œè¿™æ—¶å›¾ç¤ºå¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210409155409161.png" class="" title="image-20210409155409161"><br />
</li>
<li><p>å¦‚æœCASæ›¿æ¢å¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœæ˜¯å…¶ä»–çº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥Objectçš„è½»é‡çº§é”ï¼Œè¿™æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€è¿‡ç¨‹</li>
<li>å¦‚æœæ˜¯è‡ªå·±æ‰§è¡Œäº†synchronizedé”é‡å…¥ï¼Œé‚£ä¹ˆå†æ·»åŠ ä¸€æ¡Lock Recordä½œä¸ºé‡å…¥çš„è®¡æ•°ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210409155939040.png" class="" title="image-20210409155939040"><br />
</li>
<li><p>å½“é€€å‡ºsynchronizedä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰å¦‚æœæœ‰å–å€¼ä½nullçš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ˜¯é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°å‡ä¸€</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210409160448791.png" class="" title="image-20210409160448791"><br />
</li>
<li><p>å½“é€€å‡ºsynchronizedä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰é”è®°å½•çš„å€¼ä¸ä¸ºnullï¼Œè¿™æ—¶ä½¿ç”¨CASå°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ã€‚</p>
<ul>
<li>æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ</li>
<li>å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä½é‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹</li>
</ul>
</li>
</ul>
<h3 id="2-2-4-é‡é‡çº§é”"><a href="#2-2-4-é‡é‡çº§é”" class="headerlink" title="2.2.4 é‡é‡çº§é”"></a>2.2.4 é‡é‡çº§é”</h3><p>å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCASæ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶ä»–çº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ˜¯éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å—</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>å½“Thread-1è¿›è¡Œè½»é‡çº§åŠ é”æ—¶ï¼ŒThread-0å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210409161426089.png" class="" title="image-20210409161426089"><br />
</li>
<li><p>è¿™æ—¶Thread-1åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹ï¼ˆå› ä¸ºThread-1çº¿ç¨‹åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè½»é‡çº§é”æ²¡æœ‰é˜»å¡é˜Ÿåˆ—çš„æ¦‚å¿µï¼Œæ‰€ä»¥æ­¤æ—¶å°±è¦ä¸ºå¯¹è±¡ç”³è¯·Monitoré”ï¼ˆé‡é‡çº§é”ï¼‰ï¼Œè®©ObjectæŒ‡å‘é‡é‡çº§é”ï¼Œç„¶åThread-1è‡ªå·±è¿›å…¥äº†Monitorçš„EntryListå˜æˆBLOCKEDçŠ¶æ€ã€‚ï¼‰</p>
<ul>
<li>å³ä¸ºObjectå¯¹è±¡ç”³è¯·Monitoré”ï¼Œè®©ObjectæŒ‡å‘é‡é‡çº§é”åœ°å€</li>
<li>ç„¶åè‡ªå·±è¿›å…¥Monitorçš„EntryList BLOCKED</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210409163035688.png" class="" title="image-20210409163035688"><br />
</li>
<li><p>å½“Thread-0é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨CASå°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œè‚¯å®šæ¢å¤å¤±è´¥ï¼Œå› ä¸ºå¯¹è±¡çš„å¯¹è±¡å¤´ä¸­å­˜å‚¨çš„æ˜¯é‡é‡çº§é”çš„åœ°å€ã€‚è¿™æ—¶ä¼šè¿›å…¥é‡é‡çº§è§£é”æµç¨‹ï¼Œå³æŒ‰ç…§Monitoråœ°å€æ‰¾åˆ°Monitorå¯¹è±¡ï¼Œè®¾ç½®Ownerä¸ºnullï¼Œå”¤é†’EntryListä¸­BLOCKEDçº¿ç¨‹Thread-1ã€‚</p>
</li>
</ul>
<p><strong>è‡ªæ—‹é”ä¼˜åŒ–</strong></p>
<p>é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚</p>
<p>åŒæ­¥å¯¹æ€§èƒ½æœ€å¤§çš„å½±å“æ˜¯é˜»å¡ï¼ŒæŒ‚èµ·å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œéƒ½éœ€è¦è½¬å…¥å†…æ ¸æ€å®Œæˆã€‚éœ€è¦åº”ç”¨ä¸Šå…±äº«æ•°æ®çš„é”å®šåªä¼šæŒç»­å¾ˆçŸ­çš„æ—¶é—´ï¼Œä¸ºäº†è¿™æ®µæ—¶é—´å»æŒ‚èµ·å’Œæ¢å¤çº¿ç¨‹å¹¶ä¸å€¼å¾—ã€‚å¦‚æœæœºå™¨æœ‰å¤šä¸ªå¤„ç†å™¨æ ¸å¿ƒï¼Œæˆ‘ä»¬å¯ä»¥è®©åé¢è¯·æ±‚é”çš„çº¿ç¨‹ç¨ç­‰ä¸€ä¼šï¼Œä½†ä¸æ”¾å¼ƒå¤„ç†å™¨çš„æ‰§è¡Œæ—¶é—´ï¼Œçœ‹çœ‹æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦å¾ˆå¿«é‡Šæ”¾é”ã€‚ä¸ºäº†è®©çº¿ç¨‹ç­‰å¾…åªéœ€è®©çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªå¿™å¾ªç¯ï¼Œè¿™é¡¹æŠ€æœ¯å°±æ˜¯è‡ªæ—‹é”ã€‚</p>
<p>è‡ªæ—‹ä¸èƒ½æ›¿ä»£é˜»å¡ï¼Œè™½ç„¶é¿å…äº†çº¿ç¨‹åˆ‡æ¢å¼€é”€ï¼Œä½†è¦å ç”¨å¤„ç†å™¨æ—¶é—´ï¼Œå¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆçŸ­ï¼Œè‡ªæ—‹çš„æ•ˆæœå°±ä¼šéå¸¸å¥½ï¼Œç¹æ®–åªä¼šç™½ç™½æ¶ˆè€—å¤„ç†å™¨èµ„æºã€‚å¦‚æœè‡ªæ—‹è¶…è¿‡äº†é™å®šçš„æ¬¡æ•°ä»ç„¶æ²¡æœ‰æˆåŠŸè·å¾—é”ï¼Œå°±åº”æŒ‚èµ·çº¿ç¨‹ï¼Œè‡ªæ—‹é»˜è®¤é™å®šæ¬¡æ•°æ˜¯10ã€‚</p>
<p>è‡ªæ—‹é”åœ¨JDK1.4ä¸­å¼•å…¥ï¼Œé»˜è®¤å…³é—­ï¼›åœ¨JDK1.6ä¸­æ”¹ä¸ºé»˜è®¤å¼€å¯ã€‚</p>
<p>JDK1.6å¯¹è‡ªæ—‹é”è¿›è¡Œäº†ä¼˜åŒ–ï¼Œè‡ªæ—‹æ—¶é—´ä¸å†å›ºå®šï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡çš„è‡ªæ—‹æ—¶é—´åŠé”æ‹¥æœ‰è€…çš„çŠ¶æ€å†³å®šã€‚å¦‚æœåœ¨åŒä¸€ä¸ªé”ä¸Šï¼Œè‡ªæ—‹åˆšåˆšæˆåŠŸè·å¾—è¿‡é”ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œè™šæ‹Ÿæœºä¼šè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹ä¹Ÿå¾ˆæœ‰å¯èƒ½æˆåŠŸï¼Œè¿›è€Œå…è®¸è‡ªæ—‹æŒç»­æ›´ä¹…ã€‚å¦‚æœè‡ªæ—‹å¾ˆå°‘æˆåŠŸï¼Œä»¥åè·å–é”æ—¶å°†å¯èƒ½ç›´æ¥çœç•¥æ‰è‡ªæ—‹ï¼Œé¿å…æµªè´¹å¤„ç†å™¨èµ„æºã€‚</p>
<p>æœ‰äº†è‡ªé€‚åº”è‡ªæ—‹ï¼Œéšç€ç¨‹åºè¿è¡Œæ—¶é—´çš„å¢é•¿ï¼Œè™šæ‹Ÿæœºçš„ç¨‹åºé”çš„çŠ¶å†µé¢„æµ‹å°±ä¼šè¶Šæ¥è¶Šç²¾å‡†ã€‚</p>
<p>JDK1.7ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½ã€‚</p>
<h3 id="2-2-5-åå‘é”"><a href="#2-2-5-åå‘é”" class="headerlink" title="2.2.5 åå‘é”"></a>2.2.5 åå‘é”</h3><p>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡ŒCASæ“ä½œã€‚</p>
<p>Java 6ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨CASå°†çº¿ç¨‹IDè®¾ç½®åˆ°å¯¹è±¡çš„Mark Wordå¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹IDæ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–°CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å—A</span></span><br><span class="line">        m2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å—B</span></span><br><span class="line">        m3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å—C</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210409171350303.png" class="" title="image-20210409171350303"><br />



<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210409171429240.png" class="" title="image-20210409171429240"><br />



<p>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š</p>
<ul>
<li><p>å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼ŒMark Wordå€¼ä¸º0x05å³æœ€åä¸‰ä½ä¸º101ï¼Œè¿™æ—¶å®ƒçš„thread_idã€epochã€ageéƒ½ä¸º0ã€‚</p>
</li>
<li><p>åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ VMå‚æ•°</p>
<p><code>-XX:BiasedLockingStartupDelay=0</code>æ¥ç¦ç”¨å»¶è¿Ÿã€‚</p>
</li>
<li><p>å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼ŒMark Wordå€¼ä¸º0x01å³æœ€å3ä½ä¸º001ï¼Œè¿™æ—¶å®ƒçš„hashcodeã€ageéƒ½ä¸º0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ°hashcodeæ—¶æ‰ä¼šèµ‹å€¼ã€‚</p>
</li>
<li><p>JVMç¦ç”¨åå‘é”ï¼š<code>-XX:-UseBiasedLocking</code></p>
</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;Biased&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BiasedDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Biased biased = <span class="keyword">new</span> Biased();</span><br><span class="line">        log.debug(<span class="string">&quot;Before Biased Lock&quot;</span>);</span><br><span class="line">        log.debug(ClassLayout.parseInstance(biased.toPrintable());</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;After Biased Lock&quot;</span>);</span><br><span class="line">        log.debug(ClassLayout.parseInstance(biased).toPrintable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Biased</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-09 19:14:30.487 [main] DEBUG Biased - Before Biased Lock</span><br><span class="line">2021-04-09 19:14:32.083 [main] DEBUG Biased - top.parak.safe.Biased object internals:</span><br><span class="line"> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           70 b8 01 f8 (01110000 10111000 00000001 11111000) (-134104976)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external &#x3D; 4 bytes total</span><br><span class="line"></span><br><span class="line">2021-04-09 19:14:35.096 [main] DEBUG Biased - After Biased Lock</span><br><span class="line">2021-04-09 19:14:35.097 [main] DEBUG Biased - top.parak.safe.Biased object internals:</span><br><span class="line"> OFFSET  SIZE   TYPE DESCRIPTION                               VALUE</span><br><span class="line">      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)</span><br><span class="line">      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)</span><br><span class="line">      8     4        (object header)                           70 b8 01 f8 (01110000 10111000 00000001 11111000) (-134104976)</span><br><span class="line">     12     4        (loss due to the next object alignment)</span><br><span class="line">Instance size: 16 bytes</span><br><span class="line">Space losses: 0 bytes internal + 4 bytes external &#x3D; 4 bytes total</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºåå‘é”æœ‰å»¶è¿Ÿï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒæ¬¡åˆ›å»ºå¯¹è±¡å‰å»¶æ—¶5Sã€‚</p>
<p>ç¬¬ä¸€æ¬¡åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¯¹è±¡å¤´çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>00000001</code>ï¼Œå³æ²¡æœ‰åŠ é”ï¼Œ</p>
<p>ç¬¬äºŒæ¬¡åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¯¹è±¡å¤´çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>00000101</code>ï¼Œå³åŠ åå‘é”ã€‚</p>
<p>ä¸‹é¢ä½¿ç”¨å·¥å…·ç±»å°†ç¹ççš„<code>ClassLayout.parseInstance(obj).toPrintable()</code>çš„è¯¦ç»†ä¿¡æ¯è¾“å‡ºåšä¸€æ­¥ç®€åŒ–ï¼Œåªè¾“å‡ºå…³äºMark Wordé”é‚£ä¸€è¡Œçš„éƒ¨åˆ†ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-04-09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLayoutUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> FIRST_LINE_START = <span class="number">185</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LINE_LENGTH = <span class="number">53</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">printSimple</span><span class="params">(ClassLayout instance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance.toPrintable().substring(FIRST_LINE_START, FIRST_LINE_START + LINE_LENGTH);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ï¼ˆ1ï¼‰æ’¤é”€åå‘é”hashcodeæ–¹æ³•</p>
<p>ä½¿ç”¨åå‘é”åˆ™è¿›å…¥BiasedçŠ¶æ€ï¼Œä½¿ç”¨<code>hashcode()</code>æ–¹æ³•åˆ™è¿›å…¥NormalçŠ¶æ€ã€‚</p>
<p>NormalçŠ¶æ€ä¸‹ï¼šMark Word(32) = hashcode(25) + age(4) + biased(1) + 01(2)</p>
<p>BiasedçŠ¶æ€ä¸‹ï¼šMark Word(32) = thread_id(23) + epoch(2) + biased(1) + 01(2) </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;HashcodeBiased&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashcodeBiasedDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * -XX:BiasedLockingStartupDelay=0  ç¦ç”¨åå‘é”å»¶è¿Ÿ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        HashcodeBiased biased = <span class="keyword">new</span> HashcodeBiased();</span><br><span class="line">        log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased))); <span class="comment">// åå‘é”</span></span><br><span class="line">        log.debug(String.valueOf(biased.hashCode()));</span><br><span class="line">        log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased))); <span class="comment">// æ— é”</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HashcodeBiased</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-09 23:03:39.378 [main] DEBUG HashcodeBiased - 00 00 00 (00000101 00000000 00000000 00000000) (5)</span><br><span class="line">2021-04-09 23:03:39.380 [main] DEBUG HashcodeBiased - 1268650975</span><br><span class="line">2021-04-09 23:03:39.381 [main] DEBUG HashcodeBiased - df 13 9e (00000001 11011111 00010011 10011110) (-1642</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€è¡Œä¸º<code>101</code>ï¼Œç¬¬ä¸‰è¡Œä¸º<code>001</code>ï¼Œè¯´æ˜å¯¹è±¡çš„åå‘é”è¢«æ’¤é”€ã€‚</p>
<p>ï¼ˆ2ï¼‰æ’¤é”€åå‘é”-å…¶ä»–çº¿ç¨‹ä½¿ç”¨å¯¹è±¡</p>
<p>å½“æœ‰å…¶ä»–çº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;OtherThreadBiased&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OtherThreadBiasedDemo</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * -XX:BiasedLockingStartupDelay=0  ç¦ç”¨åå‘é”å»¶è¿Ÿ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        OtherThreadBiased biased = <span class="keyword">new</span> OtherThreadBiased();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased)));     <span class="comment">//  åå‘é”</span></span><br><span class="line">            <span class="keyword">synchronized</span> (biased) &#123;</span><br><span class="line">                log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased))); <span class="comment">// åå‘é”</span></span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased)));     <span class="comment">// åå‘é”</span></span><br><span class="line">            <span class="keyword">synchronized</span> (OtherThreadBiased.class) &#123;</span><br><span class="line">                OtherThreadBiased.class.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (OtherThreadBiased.class) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    OtherThreadBiased.class.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased)));      <span class="comment">// åå‘é”</span></span><br><span class="line">            <span class="keyword">synchronized</span> (biased) &#123;</span><br><span class="line">                log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased)));  <span class="comment">// åå‘é”</span></span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased)));      <span class="comment">// æ— é”</span></span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherThreadBiased</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-09 23:20:08.722 [t1] DEBUG OtherThreadBiased - 05 00 00 00 (00000101 00000000 00000000 00000000) (5)</span><br><span class="line">2021-04-09 23:20:08.724 [t1] DEBUG OtherThreadBiased - 05 80 71 20 (00000101 10000000 01110001 00100000) (54</span><br><span class="line">2021-04-09 23:20:08.725 [t1] DEBUG OtherThreadBiased - 05 80 71 20 (00000101 10000000 01110001 00100000) (54</span><br><span class="line">2021-04-09 23:20:08.726 [t2] DEBUG OtherThreadBiased - 05 80 71 20 (00000101 10000000 01110001 00100000) (54</span><br><span class="line">2021-04-09 23:20:08.727 [t2] DEBUG OtherThreadBiased - a0 f2 c0 20 (10100000 11110010 11000000 00100000) (54</span><br><span class="line">2021-04-09 23:20:08.728 [t2] DEBUG OtherThreadBiased - 01 00 00 00 (00000001 00000000 00000000 00000000) (1)</span><br></pre></td></tr></table></figure>



<p>ï¼ˆ3ï¼‰æ’¤é”€åå‘é”-è°ƒç”¨wait/notify</p>
<p>å› ä¸ºwait/notifyåªæœ‰é‡é‡çº§é”æ‰æœ‰ã€‚</p>
<p>ï¼ˆ4ï¼‰æ‰¹é‡é‡å®šå‘</p>
<p>å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹T1çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„Thread IDã€‚</p>
<p>å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡20æ¬¡åï¼ŒJVMä¼šè¿™æ ·è§‰å¾—ï¼Œæˆ‘æ˜¯ä¸æ˜¯åå‘é”™äº†å‘¢ï¼Œäºæ˜¯ä¼šå†ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹ã€‚</p>
<p>ï¼ˆ5ï¼‰æ‰¹é‡æ’¤é”€</p>
<p>å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡40æ¬¡åï¼ŒJVMä¼šè¿™æ ·è§‰å¾—ï¼Œè‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ï¼Œäºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„ã€‚</p>
<p>ï¼ˆ6ï¼‰é”æ¶ˆé™¤</p>
<ul>
<li>çº¿ç¨‹åŒæ­¥çš„ä»£ä»·æ˜¯ç›¸å½“é«˜çš„ï¼ŒåŒæ­¥çš„åæœæ˜¯é™ä½å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚</li>
<li>åœ¨åŠ¨æ€ç¼–è¯‘åŒæ­¥å—çš„æ—¶å€™ï¼ŒJITç¼–è¯‘å™¨å¯ä»¥å€ŸåŠ©é€ƒé€¸åˆ†ææ¥åˆ¤æ–­åŒæ­¥å—æ‰€ä½¿ç”¨çš„é”å¯¹è±¡æ˜¯å¦åªèƒ½å¤Ÿè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®è€Œæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶ä»–çº¿ç¨‹ã€‚</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆJITç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿™ä¸ªåŒæ­¥å—çš„æ—¶å€™å°±ä¼šå–æ¶ˆå¯¹è¿™éƒ¨åˆ†ä»£ç çš„åŒæ­¥ã€‚</li>
</ul>
<h3 id="2-2-6-synchronizedæ€»ç»“"><a href="#2-2-6-synchronizedæ€»ç»“" class="headerlink" title="2.2.6 synchronizedæ€»ç»“"></a>2.2.6 synchronizedæ€»ç»“</h3><p>JDK1.6å¯¹synchronizedåšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œå¼•å…¥äº†è‡ªé€‚åº”è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”å’Œè½»é‡çº§é”ç­‰æé«˜é”çš„æ•ˆç‡ï¼Œé”ä¸€å…±æœ‰å››ä¸ªçŠ¶æ€ï¼Œçº§åˆ«ä»ä½åˆ°é«˜ä¾æ¬¡æ˜¯ï¼šæ— é”ã€åå‘é”ã€è½»é‡çº§é”å’Œé‡é‡çº§é”ï¼ŒçŠ¶æ€ä¼šéšç«äº‰æƒ…å†µå‡çº§ã€‚é”å¯ä»¥å‡çº§ä½†ä¸èƒ½é™çº§ï¼Œè¿™ç§åªèƒ½å‡çº§ä¸èƒ½é™çº§çš„é”ç­–ç•¥æ˜¯ä¸ºäº†æé«˜é”è·å¾—å’Œé‡Šæ”¾çš„æ•ˆç‡ã€‚</p>
<p>å¯¹æ¯”å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>é”çŠ¶æ€</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>åå‘é”(01)</td>
<td>åŠ é”å’Œè§£é”ä¸éœ€è¦é¢å¤–çš„æ¶ˆè€—ï¼Œå’Œæ‰§è¡ŒéåŒæ­¥æ–¹æ³•æ¯”ä»…å­˜åœ¨çº³ç§’çº§çš„å·®è·ã€‚</td>
<td>å¦‚æœçº¿ç¨‹é—´å­˜åœ¨é”ç«äº‰ï¼Œä¼šå¸¦æ¥é¢å¤–çš„æ‰€æ’¤é”€çš„æ¶ˆè€—ã€‚</td>
<td>é€‚ç”¨äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®åŒæ­¥å—åœºæ™¯ã€‚</td>
</tr>
<tr>
<td>è½»é‡çº§é”(00)</td>
<td>ç«äº‰çš„çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œæé«˜äº†ç¨‹åºçš„å“åº”é€Ÿåº¦ã€‚</td>
<td>å¦‚æœå§‹ç»ˆå¾—ä¸åˆ°é”ç«äº‰çš„çº¿ç¨‹ä½¿ç”¨è‡ªæ—‹ä¼šæ¶ˆè€—CPUã€‚</td>
<td>è¿½æ±‚å“åº”æ—¶é—´ã€‚åŒæ­¥å—æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ã€‚</td>
</tr>
<tr>
<td>é‡é‡çº§é”(10)</td>
<td>çº¿ç¨‹ç«äº‰ä¸ä½¿ç”¨è‡ªæ—‹ï¼Œä¸ä¼šæ¶ˆè€—CPUã€‚</td>
<td>çº¿ç¨‹é˜»å¡ï¼Œå“åº”æ—¶é—´ç¼“æ…¢ã€‚</td>
<td>è¿½æ±‚ååé‡ã€‚åŒæ­¥å—æ‰§è¡Œé€Ÿåº¦è¾ƒé•¿ã€‚</td>
</tr>
</tbody></table>
<p><strong>è‡ªæ—‹é”</strong></p>
<p>åŒæ­¥å¯¹æ€§èƒ½æœ€å¤§çš„å½±å“æ˜¯é˜»å¡ï¼ŒæŒ‚èµ·å’Œæ¢å¤çº¿ç¨‹çš„æ“ä½œéƒ½éœ€è¦è½¬å…¥å†…æ ¸æ€å®Œæˆã€‚è®¸å¤šåº”ç”¨ä¸Šå…±äº«æ•°æ®çš„é”å®šåªä¼šæŒç»­å¾ˆçŸ­çš„æ—¶é—´ï¼Œä¸ºäº†è¿™æ®µæ—¶é—´å»æŒ‚èµ·å’Œæ¢å¤çº¿ç¨‹å¹¶ä¸å€¼å¾—ã€‚å¦‚æœæœºå™¨æœ‰å¤šä¸ªå¤„ç†æ ¸å¿ƒï¼Œæˆ‘ä»¬å¯ä»¥è®©åé¢è¯·æ±‚é”çš„çº¿ç¨‹ç¨ç­‰ä¸€ä¼šï¼Œä½†ä¸æ”¾å¼ƒå¤„ç†å™¨çš„æ‰§è¡Œæ—¶é—´ï¼Œçœ‹çœ‹æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦å¾ˆå¿«ä¼šé‡Šæ”¾é”ã€‚ä¸ºäº†è®©çº¿ç¨‹ç­‰å¾…åªéœ€è®©çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªå¿™å¾ªç¯ã€‚</p>
<p>è‡ªæ—‹é”åœ¨JDK1.4ä¸­å¼•å…¥ï¼Œé»˜è®¤å…³é—­ï¼Œåœ¨JDK1.6ä¸­é»˜è®¤å¼€å¯ã€‚è‡ªæ—‹ä¸èƒ½æ›¿ä»£é˜»å¡ï¼Œè™½ç„¶é¿å…äº†çº¿ç¨‹åˆ‡æ¢å¼€é”€ï¼Œä½†è¦å ç”¨å¤„ç†å™¨æ—¶é—´ï¼Œå¦‚æœé”è¢«å ç”¨çš„æ—¶é—´å¾ˆçŸ­ï¼Œè‡ªæ—‹çš„æ•ˆæœå°±ä¼šéå¸¸å¥½ï¼Œåä¹‹åªä¼šç™½ç™½æ¶ˆè€—å¤„ç†å™¨èµ„æºã€‚å¦‚æœè‡ªæ—‹è¶…è¿‡é™å®šæ¬¡æ•°ä»ç„¶æ²¡æœ‰è·å–åˆ°é”ï¼Œé‚£ä¹ˆå°±åº”è¯¥æŒ‚èµ·çº¿ç¨‹ï¼Œè‡ªæ—‹é»˜è®¤æ¬¡æ•°æ˜¯10ã€‚</p>
<p><strong>è‡ªé€‚åº”è‡ªæ—‹</strong></p>
<p>JDK1.6å¯¹è‡ªé€‰è‹å†›å“¦è¿›è¡Œäº†ä¼˜åŒ–ï¼Œè‡ªæ—‹æ—¶é—´ä¸å†å›ºå®šï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡çš„è‡ªæ—‹æ—¶é—´åŠé”æ‹¥æœ‰è€…çš„çŠ¶æ€å†³å®šã€‚</p>
<p>å¦‚æœåœ¨åŒä¸€ä¸ªé”ä¸Šï¼Œè‡ªæ—‹åˆšåˆšæˆåŠŸè·å¾—è¿‡é”ä¸”æŒæœ‰é”çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œè™šæ‹Ÿæœºä¼šè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹ä¹Ÿå¾ˆæœ‰å¯èƒ½æˆåŠŸï¼Œè¿›è€Œå…è®¸è‡ªæ—‹æŒç»­æ›´ä¹…ã€‚å¦‚æœè‡ªæ—‹å¾ˆå°‘æˆåŠŸï¼Œä»¥åè·å–é”æ—¶å¯èƒ½ç›´æ¥çœç•¥æ‰è‡ªæ—‹ï¼Œé¿å…æµªè´¹å¤„ç†å™¨èµ„æºã€‚</p>
<p>æœ‰äº†è‡ªé€‚åº”è‡ªæ—‹ï¼Œéšç€ç¨‹åºè¿è¡Œæ—¶é—´çš„å¢é•¿ï¼Œè™šæ‹Ÿæœºå¯¹ç¨‹åºé”çš„çŠ¶å†µé¢„æµ‹å°±ä¼šè¶Šæ¥è¶Šç²¾å‡†ã€‚</p>
<p><strong>é”æ¶ˆé™¤</strong></p>
<p>å³æ—¶ç¼–è¯‘å™¨å¯¹æ£€æµ‹ä¸å¯èƒ½å­˜åœ¨å…±äº«æ•°æ®ç«äº‰çš„é”è¿›è¡Œæ¶ˆé™¤ã€‚</p>
<p>ä¸»è¦åˆ¤å®šä¾æ®æ¥æºäºé€ƒé€¸åˆ†æï¼Œå¦‚æœåˆ¤æ–­ä¸€æ®µä»£ç ä¸­å †ä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½åªè¢«ä¸€ä¸ªçº¿ç¨‹ï¼Œå°±å¯ä»¥å½“ä½œæ ˆä¸Šçš„æ•°æ®å¯¹å¾…ï¼Œè®¤ä¸ºå®ƒä»¬æ˜¯çº¿ç¨‹ç§æœ‰çš„è€Œæ— é¡»åŒæ­¥ã€‚</p>
<p><strong>é”ç²—åŒ–</strong></p>
<p>åŸåˆ™éœ€è¦å°†åŒæ­¥å—çš„ä½œç”¨èŒƒå›´é™åˆ¶å¾—å°½é‡å°ï¼Œåªåœ¨å…±äº«æ•°æ®çš„å®é™…ä½œç”¨åŸŸä¸­è¿›è¡ŒåŒæ­¥ï¼Œè¿™æ˜¯ä¸ºäº†ä½¿ç­‰å¾…é”çš„çº¿ç¨‹å°½å¿«æ‹¿åˆ°é”ã€‚</p>
<p>ä½†å¦‚æœä¸€ç³»åˆ—çš„è¿ç»­æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åå¤åŠ é”å’Œè§£é”ï¼Œç”šè‡³åŠ é”æ“ä½œæ˜¯å‡ºç°åœ¨å¾ªç¯ä½“ä¹‹å¤–çš„ï¼Œå³ä½¿æ²¡æœ‰çº¿ç¨‹ç«äº‰ä¹Ÿä¼šå¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æ¶ˆè€—ã€‚å› æ­¤å¦‚æœè™šæ‹Ÿæœºæ¢æµ‹åˆ°æœ‰ä¸€ä¸²é›¶ç¢çš„æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†ä¼šæŠŠåŒæ­¥çš„èŒƒå›´æ‰©å±•åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨ã€‚</p>
<p><strong>åå‘é”</strong></p>
<p>åå‘é”æ˜¯ä¸ºäº†åœ¨æ²¡æœ‰ç«äº‰çš„æƒ…å†µä¸‹å‡å°‘é”å¼€é”€ï¼Œé”ä¼šåå‘äºç¬¬ä¸€ä¸ªè·å¾—å®ƒçš„çº¿ç¨‹ï¼Œå¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é”ä¸€ç›´æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼Œåˆ™æŒæœ‰åå‘é”çš„çº¿ç¨‹å°†ä¸éœ€è¦è¿›è¡ŒåŒæ­¥ã€‚</p>
<p>å½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å–æ—¶ï¼Œè™šæ‹Ÿæœºä¼šå°†å¯¹è±¡å¤´MarkWordä¸­çš„åå‘æ¨¡å¼è®¾ç½®ä¸º1ï¼ŒåŒæ—¶ä½¿ç”¨CASæŠŠè·å–åˆ°é”çš„çº¿ç¨‹IDè®°å½•åœ¨å¯¹è±¡çš„MarkWordä¸­ã€‚å¦‚æœCASæˆåŠŸï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹ä»¥åæ¯æ¬¡è¿›å…¥é”ç›¸å…³çš„åŒæ­¥å—éƒ½ä¸å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œã€‚</p>
<p>ä¸€æ—¦æœ‰å…¶ä»–çº¿ç¨‹å°è¯•è·å–é”ï¼Œåå‘æ¨¡å¼ç«‹å³ç»“æŸï¼Œæ ¹æ®é”å¯¹è±¡æ˜¯å¦å¤„äºé”å®šçŠ¶æ€å†³å®šæ˜¯å¦æ’¤é”€é”åå‘ï¼Œåç»­åŒæ­¥æŒ‰ç…§è½»é‡çº§é”é‚£æ ·æ‰§è¡Œã€‚</p>
<p><strong>è½»é‡çº§é”</strong></p>
<p>è½»é‡çº§é”æ—¶ä¸ºäº†æ²¡æœ‰åœ¨ç«äº‰çš„å‰æä¸‹å‡å°‘é‡é‡çº§é”ä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡äº§ç”Ÿçš„æ€§èƒ½æ¶ˆè€—ã€‚</p>
<p>åœ¨ä»£ç å³å°†è¿›å…¥åŒæ­¥å—æ—¶ï¼Œå¦‚æœåŒæ­¥å¯¹è±¡æ²¡æœ‰è¢«é”å®šï¼Œè™šæ‹Ÿæœºå°†åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªé”è®°å½•iç©ºé—´ï¼Œå­˜å‚¨é”å¯¹è±¡ç›®å‰MarkWordçš„æ‹·è´ã€‚ç„¶åè™šæ‹Ÿæœºä½¿ç”¨CASå°è¯•æŠŠå¯¹è±¡çš„MarkWordæ›´æ–°ä¸ºæŒ‡å‘é”è®°å½•çš„æŒ‡é’ˆï¼Œå¦‚æœæ›´æ–°æˆåŠŸå³ä»£è¡¨è¯¥çº¿ç¨‹æ‹¥æœ‰äº†é”ï¼Œé”æ ‡å¿—ä½å°†è½¬å˜ä¸º00ï¼Œæ ‡è¯†å¤„äºè½»é‡çº§é”çŠ¶æ€ã€‚</p>
<p>å¦‚æœæ›´æ–°å¤±è´¥å°±æ„å‘³ç€è‡³å°‘å­˜åœ¨ä¸€æ¡çº¿ç¨‹ä¸å½“å‰çº¿ç¨‹ç«äº‰ã€‚è™šæ‹Ÿæœºæ£€æŸ¥å¯¹è±¡çš„MarkWordæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯åˆ™è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†é”ï¼Œç›´æ¥è¿›å…¥åŒæ­¥å—ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™è¯´æ˜é”å¯¹è±¡å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŠ¢å ã€‚å¦‚æœå‡ºç°ä¸¤æ¡ä»¥ä¸Šçº¿ç¨‹äº‰ç”¨åŒä¸€ä¸ªé”ï¼Œè½»é‡çº§é”å°†è¿›è¡Œé”è†¨èƒ€ï¼Œæˆä¸ºé‡é‡çº§é”ï¼Œé”æ ‡å¿—çŠ¶æ€æ ‡ä¸º10ï¼Œæ­¤æ—¶MarkWordå­˜å‚¨çš„å°±æ˜¯æŒ‡å‘é‡é‡çº§é”çš„æŒ‡é’ˆï¼Œåé¢ç­‰å¾…é”çš„çº¿ç¨‹ä¹Ÿå¿…é¡»é˜»å¡ã€‚</p>
<p>è§£é”åŒæ ·é€šè¿‡CASè¿›è¡Œï¼Œå¦‚æœå¯¹è±¡MarkWordä»ç„¶æŒ‡å‘çº¿ç¨‹çš„é”è®°å½•ï¼Œå°±ç”¨CASæŠŠå¯¹è±¡çš„å½“å‰MarkWordå’Œçº¿ç¨‹å¤åˆ¶çš„MarkWordæ›¿æ¢å›æ¥ã€‚åŠ å…¥æ›¿æ¢æˆåŠŸåŒæ­¥è¿‡ç¨‹å°±é¡ºåˆ©å®Œæˆäº†ï¼Œå¦‚æœå¤±è´¥åˆ™è¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å°è¯•è¿‡è·å–è¯¥é”ï¼Œå°±è¦åœ¨é‡Šæ”¾é”çš„åŒäº‹å”¤é†’è¢«æŒ‚èµ·çš„çº¿ç¨‹ã€‚</p>
<h2 id="2-3-ç¬¬ä¸‰éƒ¨åˆ†-æ¨¡å¼"><a href="#2-3-ç¬¬ä¸‰éƒ¨åˆ†-æ¨¡å¼" class="headerlink" title="2.3 ç¬¬ä¸‰éƒ¨åˆ†-æ¨¡å¼"></a>2.3 ç¬¬ä¸‰éƒ¨åˆ†-æ¨¡å¼</h2><h3 id="2-3-1-wait-notify"><a href="#2-3-1-wait-notify" class="headerlink" title="2.3.1 wait notify"></a>2.3.1 wait notify</h3><p><strong>wait/notifyåŸç†</strong></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210410164622176.png" class="" title="image-20210410164622176"><br />

<ul>
<li><p>Ownerï¼šè·å¾—é”çš„çº¿ç¨‹ã€‚åˆå§‹åŒ–ä¸ºnullï¼Œå½“æœ‰çº¿ç¨‹å æœ‰è¯¥monitorçš„æ—¶å€™ï¼ŒOwneræ ‡è®°ä¸ºè¯¥çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ï¼Œå½“çº¿ç¨‹é‡Šæ”¾monitorçš„æ—¶å€™ï¼ŒOwneråˆæ¢å¤ä¸ºnullã€‚</p>
</li>
<li><p>EntryListï¼šæœ‰èµ„æ ¼è·å–èµ„æºçš„çº¿ç¨‹ä¼šè¢«ç§»åŠ¨åˆ°è¯¥é˜Ÿåˆ—ä¸­ã€‚</p>
</li>
<li><p>WaitSetï¼šå¦‚æœOwnerçº¿ç¨‹è¢«waitæ–¹æ³•é˜»å¡ï¼Œåˆ™è½¬ç§»è‡³WaitSeté˜Ÿåˆ—ã€‚</p>
</li>
</ul>
<ul>
<li><code>Owner</code>çº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨<code>wait</code>æ–¹æ³•ï¼Œå³å¯è¿›å…¥<code>WaitSet</code>å˜æˆ<code>WAITING</code>çŠ¶æ€</li>
<li><code>BLOCKED</code>å’Œ<code>WAITING</code>çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨CPUæ—¶é—´ç‰‡</li>
<li><code>BLOCKED</code>çº¿ç¨‹ä¼šåœ¨<code>Owner</code>çº¿ç¨‹åŠ é”æ—¶å”¤é†’</li>
<li><code>WAITING</code>çº¿ç¨‹ä¼šåœ¨<code>Owner</code>çº¿ç¨‹è°ƒç”¨<code>notify</code>æˆ–<code>notifyAll</code>æ—¶å”¤é†’ï¼Œä½†å”¤é†’åå¹¶ä¸æ„å‘³ç€ç«‹åˆ»è·å¾—é”ï¼Œä»éœ€è¿›å…¥<code>EntryList</code>é‡æ–°ç«äº‰ã€‚</li>
</ul>
<p><strong>APIä»‹ç»</strong></p>
<ul>
<li><code>obj.wait()</code> è®©è¿›å…¥objectç›‘è§†å™¨çš„çº¿ç¨‹åˆ°<code>WaitSet</code>ç­‰å¾…</li>
<li><code>obj.notify()</code> åœ¨objectä¸Šæ­£åœ¨<code>WaitSet</code>ç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’</li>
<li><code>obj.notifyAll()</code> è®©objectä¸Šæ­£åœ¨<code>WaitSet</code>ç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’</li>
</ul>
<p>å®ƒä»¬éƒ½æ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œåä½œçš„æ‰‹æ®µï¼Œéƒ½å±äºobjectå¯¹è±¡çš„æ–¹æ³•ï¼Œå¿…é¡»è·å¾—æ­¤å¯¹è±¡çš„é”ï¼Œæ‰èƒ½è°ƒç”¨è¿™å‡ ä¸ªæ–¹æ³•ã€‚</p>
<p>æ¡ˆä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;WaitNotify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitNotifyDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Object obj = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ‰§è¡Œ...&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    obj.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å…¶å®ƒä»£ç ...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ‰§è¡Œ...&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    obj.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å…¶å®ƒä»£ç ...&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;å”¤é†’objä¸Šå…¶ä»–çº¿ç¨‹&quot;</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (obj) &#123;</span><br><span class="line">            obj.notify();     <span class="comment">// (1)</span></span><br><span class="line">            obj.notifyAll();  <span class="comment">// (2)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ³¨é‡Šï¼ˆ2ï¼‰ï¼Œå³è°ƒç”¨<code>obj.notify()</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-10 19:53:10.709 [t1] DEBUG WaitNotify - æ‰§è¡Œ...</span><br><span class="line">2021-04-10 19:53:10.711 [t2] DEBUG WaitNotify - æ‰§è¡Œ...</span><br><span class="line">2021-04-10 19:53:11.717 [main] DEBUG WaitNotify - å”¤é†’objä¸Šå…¶ä»–çº¿ç¨‹</span><br><span class="line">2021-04-10 19:53:11.717 [t1] DEBUG WaitNotify - å…¶å®ƒä»£ç ...</span><br></pre></td></tr></table></figure>

<p>æ³¨é‡Šï¼ˆ1ï¼‰ï¼Œå³è°ƒç”¨<code>obj.notifyAll()</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-10 19:54:13.288 [t1] DEBUG WaitNotify - æ‰§è¡Œ...</span><br><span class="line">2021-04-10 19:54:13.289 [t2] DEBUG WaitNotify - æ‰§è¡Œ...</span><br><span class="line">2021-04-10 19:54:14.296 [main] DEBUG WaitNotify - å”¤é†’objä¸Šå…¶ä»–çº¿ç¨‹</span><br><span class="line">2021-04-10 19:54:14.296 [t2] DEBUG WaitNotify - å…¶å®ƒä»£ç ...</span><br><span class="line">2021-04-10 19:54:14.296 [t1] DEBUG WaitNotify - å…¶å®ƒä»£ç ...</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>notify</code>åªèƒ½å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œ<code>notifyAll</code>å”¤é†’äº†æ‰€æœ‰çº¿ç¨‹ã€‚</p>
<p><strong>sleepä¸wait</strong></p>
<p><code>Thread#sleep()</code>ä¸<code>Object#wait()</code></p>
<p>ç›¸åŒç‚¹ï¼š</p>
<ul>
<li>çº¿ç¨‹è¿›å…¥äº†<code>sleep</code>å’Œ<code>wait</code>éƒ½è¿›å…¥<code>TIMED_WAITING</code>çŠ¶æ€ã€‚</li>
</ul>
<p>ä¸åŒç‚¹ï¼š</p>
<ul>
<li><code>sleep</code>ä¸éœ€è¦å¼ºåˆ¶å’Œ<code>synchronized</code>é…åˆä½¿ç”¨ï¼Œä½†æ˜¯<code>wait</code>ä¸€å®šè¦å’Œ<code>synchronized</code>é…åˆä½¿ç”¨</li>
<li><code>sleep</code>åœ¨ç¡çœ çš„åŒæ—¶ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œä½†æ˜¯<code>wait</code>åœ¨ç­‰å¾…æ—¶ä¼šé‡Šæ”¾å¯¹è±¡é”ã€‚</li>
</ul>
<p>æ¡ˆä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;SleepAndWait&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SleepAndWaitDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;è·å¾—é”&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">20_000</span>);  <span class="comment">// (1)</span></span><br><span class="line">                    lock.wait(<span class="number">20_000</span>);   <span class="comment">// (2)</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;è·å¾—é”&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨é‡Šï¼ˆ2ï¼‰ï¼Œå³è°ƒç”¨<code>Thread.sleep()</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-10 20:23:40.382 [t1] DEBUG SleepAndWait - è·å¾—é”</span><br><span class="line">2021-04-10 20:24:00.386 [main] DEBUG SleepAndWait - è·å¾—é”</span><br></pre></td></tr></table></figure>

<p>æ³¨é‡Šï¼ˆ1ï¼‰ï¼Œå³è°ƒç”¨<code>obj.wait()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">40.335</span> [t1] DEBUG SleepAndWait - è·å¾—é”</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">10</span> <span class="number">20</span>:<span class="number">26</span>:<span class="number">41.335</span> [main] DEBUG SleepAndWait - è·å¾—é”</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°sleepæƒ…å†µä¸‹ä¸»çº¿ç¨‹20Såæ‰æ‹¿åˆ°é”ï¼Œè€Œwaitæƒ…å†µä¸‹ä¸»çº¿ç¨‹ç«‹å³å¯ä»¥æ‹¿åˆ°é”ã€‚</p>
<p><strong>wait/notifyæ­£ç¡®å§¿åŠ¿</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">    <span class="keyword">while</span> (condition) &#123; <span class="comment">// é˜²æ­¢è™šå‡å”¤é†’</span></span><br><span class="line">    	lock.wait();</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">	lock.notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-2-åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ"><a href="#2-3-2-åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ" class="headerlink" title="2.3.2 åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ"></a>2.3.2 åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</h3><p>Guarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœã€‚</p>
<ul>
<li>æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©ä»–ä»¬å…³è”åˆ°ä¸€ä¸ªGuarded Object</li>
<li>å¦‚æœæœ‰ç»“æœä¸æ–­ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰</li>
<li>JDKä¸­ï¼Œjoinçš„å®ç°ã€futureçš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼</li>
<li>å› ä¸ºè¦ç­‰å¾…å¦ä¸€æ–¹çš„ç»“æœï¼Œå› æ­¤å½’ç±»åˆ°åŒæ­¥æ¨¡å¼</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210411112747728.png" class="" title="image-20210411112747728"><br />



<p>ç¤ºä¾‹ï¼šä¸€ä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ä¸‹è½½ç»“æœï¼Œå¹¶ä¸”è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;GuardedObject&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GuardedObjectDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        GuardedObject guardedObject = <span class="keyword">new</span> GuardedObject();</span><br><span class="line">        <span class="comment">// è·å–ç»“æœçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;ç­‰å¾…ç»“æœ&quot;</span>);</span><br><span class="line">            List&lt;String&gt; response = (List&lt;String&gt;) guardedObject.getResponse(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ç»“æœå¤§å°ï¼š&#123;&#125;&quot;</span>, response.size());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ä¸‹è½½å¤±è´¥&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;receive&quot;</span>).start();</span><br><span class="line">        <span class="comment">// ä¸‹è½½å†…å®¹çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ‰§è¡Œä¸‹è½½&quot;</span>);</span><br><span class="line">            List&lt;String&gt; download = ParaKDownloader.download(<span class="string">&quot;https://www.parak.top&quot;</span>);</span><br><span class="line">            guardedObject.setResponse(download);</span><br><span class="line">        &#125;, <span class="string">&quot;download&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GuardedObject</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç»“æœ</span></span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ç»“æœ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getResponse</span><span class="params">(<span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// å¼€å§‹æ—¶é—´</span></span><br><span class="line">            <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">            <span class="comment">// ç»å†æ—¶é—´</span></span><br><span class="line">            <span class="keyword">long</span> pass = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰ç»“æœ</span></span><br><span class="line">            <span class="keyword">while</span> (response == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ­¤è½®å¾ªç¯åº”è¯¥ç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line">                <span class="keyword">long</span> wait = timeout - pass;</span><br><span class="line">                <span class="keyword">if</span> (wait &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wait(wait);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                pass = System.currentTimeMillis() - start;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº§ç”Ÿç»“æœ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResponse</span><span class="params">(Object response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.response = response;</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParaKDownloader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">download</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">        List&lt;String&gt; res = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        String line = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = (HttpURLConnection) <span class="keyword">new</span> URL(url).openConnection();</span><br><span class="line">            BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(connection.getInputStream(), StandardCharsets.UTF_8));</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                res.add(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>joinåŸç†</strong></p>
<p>çœ‹ä¸€çœ‹<code>Thread#join()</code>çš„æºä»£ç ï¼Œå³æ˜¯åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœçš„åº”ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">(<span class="keyword">long</span> millis)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> base = System.currentTimeMillis();  <span class="comment">// å¼€å§‹æ—¶é—´</span></span><br><span class="line">    <span class="keyword">long</span> now = <span class="number">0</span>;                            <span class="comment">// å½“å‰æ—¶é—´</span></span><br><span class="line">    <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123; <span class="comment">// å‚æ•°æ ¡éªŒ</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;timeout value is negative&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (millis == <span class="number">0</span>) &#123; <span class="comment">// ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°çº¿ç¨‹ç»“æŸ</span></span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            wait(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">            <span class="keyword">long</span> delay = millis - now; <span class="comment">// è¿™è½®éœ€è¦ç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line">            <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            wait(delay);               <span class="comment">// ç­‰å¾…</span></span><br><span class="line">            now = System.currentTimeMillis() - base; <span class="comment">// ç»è¿‡æ—¶é—´</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>æ‰©å±•</strong></p>
<p>å¦‚æœéœ€è¦åœ¨å¤šä¸ªç±»ä¸­é—´ä½¿ç”¨<code>GuardedObject</code>å¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œå› æ­¤è®¾è®¡ä¸€ä¸ªç”¨æ¥è§£è€¦çš„ä¸­é—´ç±»ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210411231829154.png" class="" title="image-20210411231829154"><br />

<p>æ¯”å¦‚ä¸€ä¸ªå°åŒºæœ‰ä¸€ä¸ªä¿¡ç®±ï¼Œæ¯ä¸ªå±…æ°‘åªéœ€è¦åœ¨ä¿¡ç®±é‡Œæ ¹æ®IDå–åˆ°è‡ªå·±çš„ä¿¡ä»¶ï¼Œè€Œæ¯ä¸€å°ä¿¡ä»¶éƒ½ç”±ä¸åŒçš„é‚®é€’å‘˜é€è¾¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailBoxesDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> People().start();</span><br><span class="line">        &#125;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (Integer id : MailBoxes.getIds()) &#123;</span><br><span class="line">            <span class="keyword">new</span> Postman(id, <span class="string">&quot;å†…å®¹&quot;</span> + id).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å±…æ°‘</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;People&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">People</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Mail mail = MailBoxes.createMail();</span><br><span class="line">        log.debug(<span class="string">&quot;å¼€å§‹æ”¶ä¿¡: &#123;&#125;&quot;</span>, mail.getId());</span><br><span class="line">        String content = (String) mail.getContent(<span class="number">5000</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;æ”¶åˆ°ä¿¡ä»¶: &#123;&#125;&quot;</span>,  content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‚®é€’å‘˜</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Postman&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Postman</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Postman</span><span class="params">(<span class="keyword">int</span> id, String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Mail mail = MailBoxes.getMail(id);</span><br><span class="line">        log.debug(<span class="string">&quot;é€ä¿¡ [id=&#123;&#125;, content=&#123;&#125;]&quot;</span>, id, content);</span><br><span class="line">        mail.setContent(content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿¡ç®±</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailBoxes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer, Mail&gt; boxes = <span class="keyword">new</span> Hashtable&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">generateId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Mail <span class="title">getMail</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> boxes.remove(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Mail <span class="title">createMail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = generateId();</span><br><span class="line">        Mail mail = <span class="keyword">new</span> Mail(id);</span><br><span class="line">        boxes.put(id, mail);</span><br><span class="line">        <span class="keyword">return</span> mail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Integer&gt; <span class="title">getIds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> boxes.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿¡ä»¶</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mail</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¿¡ä»¶ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Mail</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿¡ä»¶å†…å®¹</span></span><br><span class="line">    <span class="keyword">private</span> Object content;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å†…å®¹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getContent</span><span class="params">(<span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// å¼€å§‹æ—¶é—´</span></span><br><span class="line">            <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">            <span class="comment">// ç»å†æ—¶é—´</span></span><br><span class="line">            <span class="keyword">long</span> pass = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰ç»“æœ</span></span><br><span class="line">            <span class="keyword">while</span> (content == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ­¤è½®å¾ªç¯åº”è¯¥ç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line">                <span class="keyword">long</span> wait = timeout - pass;</span><br><span class="line">                <span class="keyword">if</span> (wait &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.wait(wait);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                pass = System.currentTimeMillis() - start;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> content;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å†…å®¹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(Object content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.content = content;</span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-3-å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…-æ¶ˆè´¹è€…"><a href="#2-3-3-å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…-æ¶ˆè´¹è€…" class="headerlink" title="2.3.3 å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…"></a>2.3.3 å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…</h3><p>æ¨¡å‹æè¿°å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„èµ„æº</li>
<li>ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸å…³å¿ƒæ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡é™åˆ¶çš„ï¼Œæ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®</li>
<li>JDKä¸­å„ç§é˜»å¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210411232117401.png" class="" title="image-20210411232117401"><br />



<p>å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageQueueDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MessageQueue queue = <span class="keyword">new</span> MessageQueue(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 3ä¸ªç”Ÿäº§è€…</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> id = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                queue.put(<span class="keyword">new</span> Message(id, <span class="string">&quot;å€¼&quot;</span> + id));</span><br><span class="line">            &#125;, <span class="string">&quot;ç”Ÿäº§è€…&quot;</span> + id).start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1ä¸ªæ¶ˆè´¹è€…</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 1Sæ¶ˆè´¹ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                queue.get();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;æ¶ˆè´¹è€…&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—ç±»</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;MessageDemo&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageQueue</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> LinkedList&lt;Message&gt; list;</span><br><span class="line">    <span class="comment">// æ¶ˆæ¯é˜Ÿåˆ—å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">        <span class="keyword">this</span>.list = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ¶ˆæ¯</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Message <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="keyword">while</span> (list.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…&quot;</span>);</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä»é˜Ÿåˆ—å¤´éƒ¨è·å–æ¶ˆæ¯å¹¶è¿”å›</span></span><br><span class="line">            Message message = list.removeFirst();</span><br><span class="line">            log.debug(<span class="string">&quot;æ¶ˆè´¹æ¶ˆæ¯ &lt;= &#123;&#125;&quot;</span>, message.toString());</span><br><span class="line">            list.notifyAll();</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜å…¥æ¶ˆæ¯</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="comment">// æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å·²æ»¡</span></span><br><span class="line">            <span class="keyword">while</span> (list.size() == capacity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;é˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…&quot;</span>);</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">            list.addLast(message);</span><br><span class="line">            log.debug(<span class="string">&quot;ç”Ÿäº§æ¶ˆæ¯ =&gt; &#123;&#125;&quot;</span>, message.toString());</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆæ¯</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> Object value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">(<span class="keyword">int</span> id, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Message[&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, value=&quot;</span> + value +</span><br><span class="line">                <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-3-4-park-unprak"><a href="#2-3-4-park-unprak" class="headerlink" title="2.3.4 park unprak"></a>2.3.4 park unprak</h3><p><code>park</code>/<code>unpark</code>æ˜¯<code>LockSupport</code>ç±»ä¸­çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æš‚åœå½“å‰çº¿ç¨‹</span></span><br><span class="line">LockSupport.park();</span><br><span class="line"><span class="comment">// æ¢å¤çº¿ç¨‹è¿è¡Œ</span></span><br><span class="line">LockSupport.unpark(Thread thread);</span><br></pre></td></tr></table></figure>



<p><code>park &amp; unpark</code> ä¸<code>wait &amp; notify</code>åŒºåˆ«ï¼š</p>
<ul>
<li><code>wai</code>tã€<code>notify</code>å’Œ<code>notifyAll</code>å¿…é¡»é…åˆObject Monitorä¸€èµ·ä½¿ç”¨ï¼Œè€Œ<code>park</code>å’Œ<code>unpark</code>ä¸å¿…ã€‚</li>
<li><code>park/unpark</code>æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½ç±»ã€é˜»å¡ã€‘å’Œã€å”¤é†’ã€‘çº¿ç¨‹ï¼Œè€Œ<code>notify</code>åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼Œ<code>notifyAll</code>æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°±ä¸é‚£ä¹ˆã€ç²¾ç¡®ã€‘ã€‚</li>
<li><code>park &amp; unpark</code>å¯ä»¥å…ˆ<code>unpark</code>ï¼Œè€Œ<code>wait &amp; notify</code>ä¸èƒ½å…ˆ<code>notify</code>ã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ParkUnpark&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParkUnparkDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner sc = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        String str  = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> (!(str = sc.nextLine()).equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            String[] s = str.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            <span class="keyword">int</span> time1 = Integer.parseInt(s[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">int</span> time2 = Integer.parseInt(s[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// park</span></span><br><span class="line">            Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;start...&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(time1);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">                LockSupport.park();</span><br><span class="line">                log.debug(<span class="string">&quot;continue...&quot;</span>);</span><br><span class="line">            &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">            t1.start();</span><br><span class="line">            <span class="comment">// unpark</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(time2);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// unparkæ—¢å¯ä»¥åœ¨parkä¹‹å‰è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨parkä¹‹åè°ƒç”¨</span></span><br><span class="line">            log.debug(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">            LockSupport.unpark(t1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> <span class="number">2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-18</span> <span class="number">20</span>:<span class="number">20</span>:<span class="number">53.213</span> [<span class="type">t1</span>] DEBUG ParkUnpark - <span class="built_in">start</span>...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-18</span> <span class="number">20</span>:<span class="number">20</span>:<span class="number">54.217</span> [<span class="type">t1</span>] DEBUG ParkUnpark - park...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-18</span> <span class="number">20</span>:<span class="number">20</span>:<span class="number">55.226</span> [<span class="type">main</span>] DEBUG ParkUnpark - unpark...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-18</span> <span class="number">20</span>:<span class="number">20</span>:<span class="number">55.226</span> [<span class="type">t1</span>] DEBUG ParkUnpark - <span class="keyword">continue</span>...</span><br><span class="line"><span class="number">2</span> <span class="number">1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-18</span> <span class="number">20</span>:<span class="number">20</span>:<span class="number">57.756</span> [<span class="type">t1</span>] DEBUG ParkUnpark - <span class="built_in">start</span>...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-18</span> <span class="number">20</span>:<span class="number">20</span>:<span class="number">58.771</span> [<span class="type">main</span>] DEBUG ParkUnpark - unpark...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-18</span> <span class="number">20</span>:<span class="number">20</span>:<span class="number">59.762</span> [<span class="type">t1</span>] DEBUG ParkUnpark - park...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-18</span> <span class="number">20</span>:<span class="number">20</span>:<span class="number">59.762</span> [<span class="type">t1</span>] DEBUG ParkUnpark - <span class="keyword">continue</span>...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¬¡è¾“å…¥ï¼Œ<code>time1</code> = 1ï¼Œ <code>time2</code> = 2ï¼Œäºæ˜¯å…ˆæ‰§è¡Œ<code>park</code>ï¼Œåæ‰§è¡Œ<code>unpark</code>ï¼Œæœ€ç»ˆæ‰§è¡Œäº†<code>continue</code>ï¼›</p>
<p>ç¬¬ä¸€æ¬¡è¾“å…¥ï¼Œ<code>time1</code> = 2ï¼Œ <code>time2</code> = 1ï¼Œäºæ˜¯å…ˆæ‰§è¡Œ<code>unpark</code>ï¼Œåæ‰§è¡Œ<code>park</code>ï¼Œæœ€ç»ˆä¹Ÿæ‰§è¡Œäº†<code>continue</code>ã€‚</p>
<p>è¯æ˜<code>unpark</code>çš„æ‰§è¡Œæ¯”è¾ƒéšæ„ã€‚</p>
<p><strong>park/unparkåŸç†</strong></p>
<p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„Parkerå¯¹è±¡ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š<code>_countrer</code>ã€<code>_cond</code>å’Œ<code> _mutex</code>æ‰“ä¸ªæ¯”å–»ã€‚</p>
<ul>
<li>çº¿ç¨‹å°±åƒä¸€ä¸ªæ—…äººï¼ŒParkerå°±åƒä¸ºä»–éšèº«æºå¸¦çš„èƒŒåŒ…ï¼Œ<code>_cond</code>å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¸ç¯·ï¼Œ<code>_counter</code></li>
</ul>
<p>å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¤‡ç”¨å¹²ç²®ï¼ˆ0ä¸ºè€—å°½ï¼Œ1ä¸ºå……è¶³ï¼‰</p>
<ul>
<li>è°ƒç”¨<code>park</code>å°±æ˜¯è¦çœ‹éœ€ä¸éœ€è¦åœä¸‹æ¥æ­‡æ¯<ul>
<li>å¦‚æœå¤‡ç”¨å¹²ç²®è€—å°½ï¼ˆ<code>_counter</code> = 0ï¼‰ï¼Œé‚£ä¹ˆé’»è¿›å¸ç¯·æ­‡æ¯ã€‚</li>
<li>å¦‚æœå¤‡ç”¨å¹²ç²®å……è¶³ï¼ˆ<code>_counter</code> = 1ï¼‰ï¼Œé‚£ä¹ˆå°±ä¸éœ€åœç•™ï¼Œç»§ç»­å‰è¿›ã€‚</li>
</ul>
</li>
<li>è°ƒç”¨<code>unpark</code>ï¼Œå°±å¥½æ¯”å‘èƒŒåŒ…ä¸­è¡¥å……å¹²ç²®<ul>
<li>å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨æ•ç¯·ï¼Œå°±å”¤é†’è®©ä»–ç»§ç»­å‰è¿›ã€‚</li>
<li>å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆä¸‹æ¬¡ä»–è°ƒç”¨<code>park</code>æ—¶ï¼Œä»…æ˜¯æ¶ˆè€—æ‰å¤‡ç”¨å¹²ç²®ï¼Œä¸éœ€åœç•™ç»§ç»­å‰è¿›ã€‚<ul>
<li>å› ä¸ºèƒŒåŒ…ç©ºé—´æœ‰é™ï¼Œå¤šæ¬¡è°ƒç”¨<code>unpark</code>ä»…ä¼šè¡¥å……ä¸€ä»½å¤‡ç”¨å¹²ç²®ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å›¾ç¤ºå¦‚ä¸‹ï¼š</p>
<p>ï¼ˆ1ï¼‰å…ˆè°ƒç”¨<code>park</code>å†è°ƒç”¨<code>unpark</code></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210418212139187.png" class="" title="image-20210418212139187"><br />

<ol>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>Unsafe.park()</code>æ–¹æ³•</li>
<li>æ£€æŸ¥<code>_counter</code>ï¼Œæœ¬æƒ…å†µä¸º0ï¼Œè¿™æ—¶ï¼Œè·å¾—<code>_mutex</code>äº’æ–¥é”</li>
<li>çº¿ç¨‹è¿›å…¥<code>_cond</code>æ¡ä»¶å˜é‡é˜»å¡</li>
<li>è®¾ç½®<code>_counter = 0</code></li>
</ol>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210419110033795.png" class="" title="image-20210419110033795"><br />

<ol>
<li>è°ƒç”¨<code>Unsafe.unpark(Thread_0)</code>æ–¹æ³•ï¼Œè®¾ç½®<code>_counter</code>ä¸º1</li>
<li>å”¤é†’<code>_cond</code>æ¡ä»¶å˜é‡ä¸­çš„<code>Thread_0</code></li>
<li><code>Thread_0</code>æ¢å¤è¿è¡Œ</li>
<li>è®¾ç½®<code>_counter</code>ä¸º0</li>
</ol>
<p>ï¼ˆ2ï¼‰å…ˆè°ƒç”¨<code>unpark</code>å†è°ƒç”¨<code>park</code></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210419214214099.png" class="" title="image-20210419214214099"><br />

<ol>
<li>è°ƒç”¨<code>Unsafe.unpark(Thread)0</code>æ–¹æ³•ï¼Œè®¾ç½®<code>_counter</code>ä¸º1</li>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>Unsafe.park()</code>æ–¹æ³•</li>
<li>æ£€æŸ¥<code>_counter</code>ï¼Œæœ¬æƒ…å†µä¸º1ï¼Œè¿™æ—¶çº¿ç¨‹æ— éœ€é˜»å¡ï¼Œç»§ç»­è¿è¡Œ</li>
<li>è®¾ç½®<code>_counter</code>ä¸º0</li>
</ol>
<h3 id="2-3-5-çº¿ç¨‹çŠ¶æ€è½¬æ¢"><a href="#2-3-5-çº¿ç¨‹çŠ¶æ€è½¬æ¢" class="headerlink" title="2.3.5 çº¿ç¨‹çŠ¶æ€è½¬æ¢"></a>2.3.5 çº¿ç¨‹çŠ¶æ€è½¬æ¢</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210419222926434.png" class="" title="image-20210419222926434"><br />

<p>å‡è®¾æœ‰çº¿ç¨‹t:</p>
<p>ï¼ˆ1ï¼‰æƒ…å†µ1ï¼š<code>NEW</code> ==&gt; <code>RUNNABLE</code></p>
<p>å½“è°ƒç”¨<code>t.start()</code>æ–¹æ³•æ—¶ï¼Œç”±<code>NEW</code> =&gt; <code>RUNNABLE</code></p>
<p>ï¼ˆ2ï¼‰æƒ…å†µ2ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>WAITING</code></p>
<p><code>t</code>çº¿ç¨‹ç”¨<code>synchronized(obj)</code>è·å–äº†å¯¹è±¡é”å</p>
<ul>
<li><p>è°ƒç”¨<code>obj.wait()</code>æ–¹æ³•æ—¶ï¼Œtçº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>WAITING</code></p>
</li>
<li><p>è°ƒç”¨<code>obj.notify()</code>ã€<code>obj.notifyAll()</code>ã€<code>t.interrupt()</code>æ—¶</p>
<ul>
<li>ç«äº‰é”æˆåŠŸï¼Œtçº¿ç¨‹ä»<code>WAITING</code> ==&gt; <code>RUNNABLE</code></li>
<li>ç«äº‰é”å¤±è´¥ï¼Œtçº¿ç¨‹ä»<code>WAITING</code> ==&gt; <code>BLOCKED</code></li>
</ul>
</li>
</ul>
<p>ï¼ˆ3ï¼‰æƒ…å†µ3ï¼š<code>RUNNABLE</code> &lt;==&gt; <code> WAITING</code></p>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>t.join()</code>æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>WAITING</code><ul>
<li>æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨<code>t</code>çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾… </li>
</ul>
</li>
<li><code>t</code>çº¿ç¨‹è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt()</code>æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>WAITING</code> ==&gt; <code>RUNNABLE</code></li>
</ul>
<p>ï¼ˆ4ï¼‰æƒ…å†µ4ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>WAITING</code></p>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>LockSupport.park()</code>æ–¹æ³•ä¼šè®©å½“å‰çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>WAITING</code></li>
<li>è°ƒç”¨<code>LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)</code>æˆ–è€…è°ƒç”¨äº†çº¿ç¨‹çš„<code>interrupt()</code>ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä»<code>WAITING</code> ==&gt; <code>RUNNABLE</code></li>
</ul>
<p>ï¼ˆ5ï¼‰æƒ…å†µ5ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>WAITING</code></p>
<p><code>t</code>çº¿ç¨‹ç”¨<code>synchronized(obj)</code>è·å–äº†å¯¹è±¡é”å</p>
<ul>
<li>è°ƒç”¨<code>obj.wait(long n)</code>æ–¹æ³•æ—¶ï¼Œ<code>t</code>çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>TIMED_WAITING</code></li>
<li><code>t</code>çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº†næ¯«ç§’ï¼Œæˆ–è°ƒç”¨<code>obj.notify()</code>ï¼Œ<code>obj.notifyAll()</code>ï¼Œ<code>t.interrupt()</code>æ—¶<ul>
<li>ç«äº‰æ—¶æˆåŠŸï¼Œ<code>t</code>çº¿ç¨‹ä»<code>TIMED_WAITING</code> ==&gt; <code>RUNNABLE</code></li>
<li>ç«äº‰é”å¤±è´¥ï¼Œ<code>t</code>çº¿ç¨‹ä»<code>TIMED_WAITING</code> ==&gt; <code>BLOCKED</code></li>
</ul>
</li>
</ul>
<p>ï¼ˆ6ï¼‰æƒ…å†µ6ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>TIMED_WAITING</code></p>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>t.join(long n)</code>æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>TIMED_WAITING</code><ul>
<li>æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨<code>t</code>çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</li>
</ul>
</li>
<li>å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº†næ¯«ç§’ï¼Œæˆ–è€…<code>t</code>çº¿ç¨‹è¿è¡Œç»“æŸï¼Œæˆ–è€…è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt()</code>æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>TIMED_WAITING</code> ==&gt; <code>RUNNABLE</code></li>
</ul>
<p>ï¼ˆ7ï¼‰æƒ…å†µ7ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>TIMED_WAITING</code></p>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>Thread.sleep(long n)</code>ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>TIMED_WAITING</code></li>
<li>å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº†næ¯«ç§’ï¼Œå½“å‰çº¿ç¨‹ä»<code>TIMED_WAITING</code> ==&gt; <code>RUNNABLE</code></li>
</ul>
<p>ï¼ˆ8ï¼‰æƒ…å†µ8ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>TIMED_WAITING</code></p>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>LockSupport.parkNanos(long nanos)</code>æˆ–<code>LockSupport.parkUntil(long millons)</code>ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>TIMED_WAITING</code></li>
<li>è°ƒç”¨<code>LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)</code>æˆ–è€…è°ƒç”¨äº†çº¿ç¨‹çš„<code>interrupt()</code>ï¼Œæˆ–æ—¶ç­‰å¾…è¶…æ—¶ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä»<code>TIMED_WAITING</code> ==&gt; <code>RUNNABLE</code></li>
</ul>
<p>ï¼ˆ9ï¼‰æƒ…å†µ9ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>BLOCKED</code></p>
<ul>
<li><code>t</code>çº¿ç¨‹ç”¨<code>synchronized(obj)</code>è·å–äº†å¯¹è±¡é”æ—¶å¦‚æœç«äº‰å¤±è´¥ï¼Œä»<code>RUNNABLE</code> ==&gt; <code>BLOCKED</code></li>
<li>æŒ<code>obj</code>é”çº¿ç¨‹çš„åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œä¼šå”¤é†’è¯¥å¯¹è±¡ä¸Šæ‰€æœ‰<code>BLOCKED</code>çš„çº¿ç¨‹é‡æ–°ç«äº‰ï¼Œå¦‚æœå…¶ä¸­<code>t</code>çº¿ç¨‹ç«äº‰æˆåŠŸï¼Œä»<code>BLOCKED</code> ==&gt; <code>RUNNABLE</code>ï¼Œå…¶ä»–å¤±è´¥çš„çº¿ç¨‹ä»ç„¶<code>BLOCKED</code></li>
</ul>
<p>ï¼ˆ10ï¼‰æƒ…å†µ10ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>TERMINATED</code></p>
<p>å½“å…ˆçº¿ç¨‹æ‰€æœ‰ä»£ç è¿è¡Œå®Œæ¯•ï¼Œè¿›å…¥<code>TERMINATED</code></p>
<h2 id="2-4-ç¬¬å››éƒ¨åˆ†-é”"><a href="#2-4-ç¬¬å››éƒ¨åˆ†-é”" class="headerlink" title="2.4 ç¬¬å››éƒ¨åˆ†-é”"></a>2.4 ç¬¬å››éƒ¨åˆ†-é”</h2><h3 id="2-4-1-å¤šæŠŠé”"><a href="#2-4-1-å¤šæŠŠé”" class="headerlink" title="2.4.1 å¤šæŠŠé”"></a>2.4.1 å¤šæŠŠé”</h3><p><strong>å¤šæŠŠä¸ç›¸å¹²çš„é”</strong></p>
<p>ä¸€ä»¶å¤§å±‹å­æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼šç¡è§‰ã€å­¦ä¹ ï¼Œäº’ä¸ç›¸å¹²ã€‚</p>
<p>ç°åœ¨å°å—è¦å­¦ä¹ ï¼Œå°å¥³è¦ç¡è§‰ï¼Œä½†å¦‚æœåªç”¨ä¸€é—´å±‹å­ï¼ˆä¸€ä¸ªå¯¹è±¡é”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiLockDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BigRoom bigRoom = <span class="keyword">new</span> BigRoom();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bigRoom.study();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bigRoom.sleep();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å¥³&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;BigRoom&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BigRoom</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;sleep2ä¸ªå°æ—¶&quot;</span>);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">study</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;sleep1ä¸ªå°æ—¶&quot;</span>);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£å†³æ–¹æ³•æ˜¯å‡†å¤‡å¤šä¸ªæˆ¿é—´ï¼ˆå¤šä¸ªå¯¹è±¡é”ï¼‰ï¼Œè®©å°å—å’Œå°å¥³è·å¾—ä¸åŒçš„é”ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;BigRoom&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BigRoom</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* ä¹¦æˆ¿ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object studyRoom = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="comment">/* å§å®¤ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object sleepRoom = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sleepRoom) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;sleep2ä¸ªå°æ—¶&quot;</span>);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">study</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (studyRoom) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;sleep1ä¸ªå°æ—¶&quot;</span>);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é”çš„ç²’åº¦ç»†åˆ†ï¼š</p>
<ul>
<li>å¥½å¤„ï¼šå¢å¼ºç¨‹åºçš„å¹¶å‘æ€§ã€‚</li>
<li>åå¤„ï¼šå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”ã€‚</li>
</ul>
<h3 id="2-4-2-æ´»è·ƒæ€§"><a href="#2-4-2-æ´»è·ƒæ€§" class="headerlink" title="2.4.2 æ´»è·ƒæ€§"></a>2.4.2 æ´»è·ƒæ€§</h3><ul>
<li><p>å› ä¸ºæŸç§åŸå› ï¼Œä½¿å¾—ä»£ç ä¸€ç›´æ— æ³•æ‰§è¡Œå®Œæ¯•ï¼Œè¿™æ ·çš„ç°è±¡å«åšæ´»è·ƒæ€§ã€‚</p>
</li>
<li><p>æ´»è·ƒæ€§ç›¸å…³çš„ä¸€ç³»åˆ—é—®é¢˜éƒ½å¯ä»¥ç”¨<code>ReentrantLock</code>è¿›è¡Œè§£å†³ã€‚</p>
</li>
</ul>
<h4 id="2-4-2-1-æ­»é”"><a href="#2-4-2-1-æ­»é”" class="headerlink" title="2.4.2.1 æ­»é”"></a>2.4.2.1 æ­»é”</h4><p>ä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”ã€‚</p>
<p>å¦‚ï¼šçº¿ç¨‹1è·å–Aå¯¹è±¡é”ï¼Œçº¿ç¨‹2è·å–Bå¯¹è±¡é”ï¼Œæ­¤æ—¶çº¿ç¨‹1åˆæƒ³è·å–Bå¯¹è±¡é”ï¼Œçº¿ç¨‹2åˆæƒ³è·å–Aå¯¹è±¡é”ï¼Œå®ƒä»¬éƒ½ç­‰ç€å¯¹è±¡é‡Šæ”¾é”ï¼Œæ­¤æ—¶å°±ç§°ä¸ºæ­»é”ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;DeadLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLockDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Object A = <span class="keyword">new</span> Object();</span><br><span class="line">        <span class="keyword">final</span> Object B = <span class="keyword">new</span> Object();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (A) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;lock A&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (B) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;lock B&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (B) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;lock B&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (A) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;lock A&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">48</span>:<span class="number">27.708</span> [t2] DEBUG DeadLock - lock B</span><br><span class="line"><span class="number">2021</span>-<span class="number">04</span>-<span class="number">22</span> <span class="number">22</span>:<span class="number">48</span>:<span class="number">27.708</span> [t1] DEBUG DeadLock - lock A</span><br></pre></td></tr></table></figure>



<p><strong>å‘ç”Ÿæ­»é”çš„å¿…è¦æ¡ä»¶</strong></p>
<ul>
<li>äº’æ–¥æ¡ä»¶ï¼šåœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œä¸€ç§èµ„æºåªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹æ‰€ä½¿ç”¨ã€‚</li>
<li>è¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼šè¿›ç¨‹å·²ç»æ‹¥æœ‰äº†è‡³å°‘ä¸€ç§èµ„æºï¼ŒåŒæ—¶åˆå»ç”³è¯·å…¶ä»–èµ„æºã€‚å› ä¸ºå…¶ä»–èµ„æºè¢«åˆ«çš„è¿›ç¨‹æ‰€ä½¿ç”¨ï¼Œè¯¥è¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå¹¶ä¸”ä¸é‡Šæ”¾è‡ªå·±å·²æœ‰çš„èµ„æºã€‚</li>
<li>ä¸å¯å‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å¯¹å·²è·å¾—çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œæˆå‰ä¸èƒ½è¢«å¼ºå ï¼Œåªèƒ½åœ¨è¿›ç¨‹ä½¿ç”¨å®Œåè‡ªå·±é‡Šæ”¾ã€‚</li>
<li>å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šå‘ç”Ÿæ­»é”æ—¶ï¼Œå¿…ç„¶å­˜åœ¨ä¸€ä¸ªè¿›ç¨‹â€”â€”èµ„æºçš„å¾ªç¯é“¾ã€‚</li>
</ul>
<p><strong>å®šä½æ­»é”çš„æ–¹æ³•</strong></p>
<p>å…ˆè¿è¡Œä¸Šè¿°æ­»é”ç¤ºä¾‹ï¼Œä¿è¯ç³»ç»Ÿä¸­å­˜åœ¨æ­»é”è¿›ç¨‹ã€‚</p>
<ol>
<li>jpsè¿›ç¨‹id + jstackå®šä½æ­»é”</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">PS</span> &gt; jps</span><br><span class="line"><span class="number">13616</span> Jps</span><br><span class="line"><span class="number">14432</span> Launcher </span><br><span class="line"><span class="number">13796</span> DeadLockDemo      // æ­»é”è¿›ç¨‹</span><br><span class="line"><span class="number">16676</span></span><br><span class="line"><span class="number">26428</span> RemoteMavenServer36</span><br><span class="line"><span class="built_in">PS</span> &gt; jstack <span class="number">13796</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">43</span></span><br><span class="line">Full thread dump Java HotSpot(TM) <span class="number">64</span><span class="literal">-Bit</span> Server VM (<span class="number">25.221</span><span class="literal">-b11</span> mixed mode):</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">Found one Java<span class="literal">-level</span> deadlock: // å‘ç°ä¸€ä¸ªJavaçº§åˆ«çš„æ­»é”</span><br><span class="line">=============================</span><br><span class="line">// æ­»é”çš„å¼•ç”¨æƒ…å†µ</span><br><span class="line"><span class="string">&quot;t2&quot;</span>:</span><br><span class="line">  waiting to lock monitor <span class="number">0</span>x000000001d390b08 (object <span class="number">0</span>x000000076cfd4e58, a java.lang.Object),</span><br><span class="line">  which is held by <span class="string">&quot;t1&quot;</span></span><br><span class="line"><span class="string">&quot;t1&quot;</span>:</span><br><span class="line">  waiting to lock monitor <span class="number">0</span>x000000001d393028 (object <span class="number">0</span>x000000076cfd4e68, a java.lang.Object),</span><br><span class="line">  which is held by <span class="string">&quot;t2&quot;</span></span><br><span class="line"></span><br><span class="line">Java stack information <span class="keyword">for</span> the threads listed above:</span><br><span class="line">===================================================</span><br><span class="line"><span class="string">&quot;t2&quot;</span>:</span><br><span class="line">        at top.parak.share.DeadLockDemo.lambda<span class="variable">$main</span><span class="variable">$1</span>(DeadLockDemo.java:<span class="number">39</span>) // å‘ç”Ÿæ­»é”çš„ä½ç½®</span><br><span class="line">        - waiting to lock &lt;<span class="number">0</span>x000000076cfd4e58&gt; (a java.lang.Object)</span><br><span class="line">        - locked &lt;<span class="number">0</span>x000000076cfd4e68&gt; (a java.lang.Object)</span><br><span class="line">        at top.parak.share.DeadLockDemo<span class="variable">$</span><span class="variable">$Lambda</span><span class="variable">$2</span>/<span class="number">885951223</span>.run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"><span class="string">&quot;t1&quot;</span>:</span><br><span class="line">        at top.parak.share.DeadLockDemo.lambda<span class="variable">$main</span><span class="variable">$0</span>(DeadLockDemo.java:<span class="number">26</span>) // å‘ç”Ÿæ­»é”çš„ä½ç½®</span><br><span class="line">        - waiting to lock &lt;<span class="number">0</span>x000000076cfd4e68&gt; (a java.lang.Object)</span><br><span class="line">        - locked &lt;<span class="number">0</span>x000000076cfd4e58&gt; (a java.lang.Object)</span><br><span class="line">        at top.parak.share.DeadLockDemo<span class="variable">$</span><span class="variable">$Lambda</span><span class="variable">$1</span>/<span class="number">1854778591</span>.run(Unknown Source)</span><br><span class="line">        at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"></span><br><span class="line">Found <span class="number">1</span> deadlock.</span><br></pre></td></tr></table></figure>



<ol start="2">
<li>jconsoleå·¥å…·æ£€æµ‹æ­»é”</li>
</ol>
<p>powershellè¾“å…¥<code>jconsole</code>ï¼Œè¿æ¥æœ¬åœ°è¿›ç¨‹ï¼Œé€‰æ‹©çº¿ç¨‹ç•Œé¢</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210422112258636.png" class="" title="image-20210422112258636"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210422112653368.png" class="" title="image-20210422112653368"><br />



<p><strong>æ­»é”ä¸¾ä¾‹ï¼šå“²å­¦å®¶å°±é¤é—®é¢˜</strong></p>
<p>æœ‰äº”ä½å“²å­¦å®¶ï¼Œå›´ååœ¨åœ†æ¡Œæ—ï¼š</p>
<ul>
<li>ä»–ä»¬åªåšä¸¤ä»¶äº‹ï¼Œæ€è€ƒå’Œåƒé¥­ï¼Œæ€è€ƒä¸€ä¼šåƒå£é¥­ï¼Œåƒå®Œé¥­æ¥ç€æ€è€ƒã€‚</li>
<li>åƒé¥­æ—¶è¦ç”¨ä¸¤æ ¹ç­·å­åƒï¼Œæ¡Œå­ä¸Šå…±æœ‰äº”æ ¹ç­·å­ï¼Œæ¯ä½å“²å­¦å®¶å·¦å³æ‰‹è¾¹å„æœ‰ä¸€æ ¹ç­·å­ã€‚</li>
<li>å¦‚æœç­·å­è¢«èº«è¾¹çš„äººæ‹¿ç€ï¼Œè‡ªå·±å°±å¾—ç­‰å¾…ã€‚</li>
</ul>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210422110000353.png" class="" title="image-20210422110000353"><br />

<p>å½“æ¯ä½å“²å­¦å®¶å³çº¿ç¨‹æŒæœ‰ä¸€æ ¹ç­·å­æ—¶ï¼Œä»–ä»¬éƒ½åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾é”ï¼Œå› æ­¤é€ æˆäº†æ­»é”ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhilosophersEatingDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> NUM = <span class="number">5</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Chopstick[] c = <span class="keyword">new</span> Chopstick[NUM];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM; i++) &#123;</span><br><span class="line">            c[i] = <span class="keyword">new</span> Chopstick(String.valueOf(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> Philosopher(<span class="string">&quot;è‹æ ¼æ‹‰åº•&quot;</span>, c[<span class="number">0</span>], c[<span class="number">1</span>]).start();</span><br><span class="line">        <span class="keyword">new</span> Philosopher(<span class="string">&quot;æŸæ‹‰å›¾&quot;</span>, c[<span class="number">1</span>], c[<span class="number">2</span>]).start();</span><br><span class="line">        <span class="keyword">new</span> Philosopher(<span class="string">&quot;äºšé‡Œå£«å¤šå¾·&quot;</span>, c[<span class="number">2</span>], c[<span class="number">3</span>]).start();</span><br><span class="line">        <span class="keyword">new</span> Philosopher(<span class="string">&quot;éƒæ‹‰å…‹åˆ©ç‰¹&quot;</span>, c[<span class="number">3</span>], c[<span class="number">4</span>]).start();</span><br><span class="line">        <span class="keyword">new</span> Philosopher(<span class="string">&quot;é˜¿åŸºç±³å¾·&quot;</span>, c[<span class="number">4</span>], c[<span class="number">0</span>]).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å“²å­¦å®¶</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Philosopher&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Chopstick left;  <span class="comment">// å·¦æ‰‹ç­·å­</span></span><br><span class="line">    <span class="keyword">final</span> Chopstick right; <span class="comment">// å³æ‰‹ç­·å­</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(String name, Chopstick left, Chopstick right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">        <span class="keyword">this</span>.left = left;</span><br><span class="line">        <span class="keyword">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// å°è¯•è·å¾—å·¦æ‰‹ç­·å­</span></span><br><span class="line">            <span class="keyword">synchronized</span> (left) &#123;</span><br><span class="line">                <span class="comment">// å°è¯•è·å¾—å³æ‰‹ç­·å­</span></span><br><span class="line">                <span class="keyword">synchronized</span> (right) &#123;</span><br><span class="line">                    eat();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åƒé¥­</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;eating...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­·å­</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chopstick</span> </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Chopstick</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ç­·å­[&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-22</span> <span class="number">14</span>:<span class="number">15</span>:<span class="number">57.623</span> [äºšé‡Œå£«å¤šå¾·] DEBUG Philosopher - eating...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-22</span> <span class="number">14</span>:<span class="number">15</span>:<span class="number">57.623</span> [è‹æ ¼æ‹‰åº•] DEBUG Philosopher - eating...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-22</span> <span class="number">14</span>:<span class="number">15</span>:<span class="number">58.632</span> [äºšé‡Œå£«å¤šå¾·] DEBUG Philosopher - eating...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-22</span> <span class="number">14</span>:<span class="number">15</span>:<span class="number">58.632</span> [è‹æ ¼æ‹‰åº•] DEBUG Philosopher - eating...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-22</span> <span class="number">14</span>:<span class="number">15</span>:<span class="number">59.643</span> [æŸæ‹‰å›¾] DEBUG Philosopher - eating...</span><br><span class="line"><span class="number">2021</span><span class="literal">-04</span><span class="literal">-22</span> <span class="number">14</span>:<span class="number">16</span>:<span class="number">00.647</span> [æŸæ‹‰å›¾] DEBUG Philosopher - eating...</span><br></pre></td></tr></table></figure>

<p>jconsoleæ£€æµ‹æ­»é”ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---------------------------------------------------------------------</span><br><span class="line">åç§°: è‹æ ¼æ‹‰åº•</span><br><span class="line">çŠ¶æ€: top.parak.share.Chopstick@798c4fadã€ç­·å­1ã€‘ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: æŸæ‹‰å›¾</span><br><span class="line">æ€»é˜»æ­¢æ•°: 8, æ€»ç­‰å¾…æ•°: 6</span><br><span class="line"></span><br><span class="line">å †æ ˆè·Ÿè¸ª: </span><br><span class="line">top.parak.share.Philosopher.run(PhilosophersEatingDemo.java:45)</span><br><span class="line">   - å·²é”å®š top.parak.share.Chopstick@6ea242baã€ç­·å­0ã€‘</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">åç§°: æŸæ‹‰å›¾</span><br><span class="line">çŠ¶æ€: top.parak.share.Chopstick@6057af47ã€ç­·å­2ã€‘ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: äºšé‡Œå£«å¤šå¾·</span><br><span class="line">æ€»é˜»æ­¢æ•°: 3, æ€»ç­‰å¾…æ•°: 2</span><br><span class="line"></span><br><span class="line">å †æ ˆè·Ÿè¸ª: </span><br><span class="line">top.parak.share.Philosopher.run(PhilosophersEatingDemo.java:45)</span><br><span class="line">   - å·²é”å®š top.parak.share.Chopstick@798c4fadã€ç­·å­1ã€‘</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">åç§°: äºšé‡Œå£«å¤šå¾·</span><br><span class="line">çŠ¶æ€: top.parak.share.Chopstick@6796caf6ã€ç­·å­3ã€‘ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: éƒæ‹‰å…‹åˆ©ç‰¹</span><br><span class="line">æ€»é˜»æ­¢æ•°: 8, æ€»ç­‰å¾…æ•°: 2</span><br><span class="line"></span><br><span class="line">å †æ ˆè·Ÿè¸ª: </span><br><span class="line">top.parak.share.Philosopher.run(PhilosophersEatingDemo.java:45)</span><br><span class="line">   - å·²é”å®š top.parak.share.Chopstick@6057af47ã€ç­·å­2ã€‘</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">åç§°: éƒæ‹‰å…‹åˆ©ç‰¹</span><br><span class="line">çŠ¶æ€: top.parak.share.Chopstick@16b56e05ã€ç­·å­4ã€‘ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: é˜¿åŸºç±³å¾·</span><br><span class="line">æ€»é˜»æ­¢æ•°: 2, æ€»ç­‰å¾…æ•°: 0</span><br><span class="line"></span><br><span class="line">å †æ ˆè·Ÿè¸ª: </span><br><span class="line">top.parak.share.Philosopher.run(PhilosophersEatingDemo.java:45)</span><br><span class="line">   - å·²é”å®š top.parak.share.Chopstick@6796caf6ã€ç­·å­3ã€‘</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">åç§°: é˜¿åŸºç±³å¾·</span><br><span class="line">çŠ¶æ€: top.parak.share.Chopstick@6ea242baã€ç­·å­0ã€‘ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: è‹æ ¼æ‹‰åº•</span><br><span class="line">æ€»é˜»æ­¢æ•°: 1, æ€»ç­‰å¾…æ•°: 0</span><br><span class="line"></span><br><span class="line">å †æ ˆè·Ÿè¸ª: </span><br><span class="line">top.parak.share.Philosopher.run(PhilosophersEatingDemo.java:45)</span><br><span class="line">   - å·²é”å®š top.parak.share.Chopstick@16b56e05ã€ç­·å­4ã€‘</span><br></pre></td></tr></table></figure>

<p>å¤§å®¶éƒ½æ‹¿ç€ä¸€æ ¹ç­·å­ï¼Œç­‰ç€å¦ä¸€æ ¹ç­·å­ï¼Œé€ æˆæ­»é”ï¼Œè§£å†³å¾—çœ‹åé¢çš„<code>ReentrantLock</code>ã€‚</p>
<h4 id="2-4-2-2-æ´»é”"><a href="#2-4-2-2-æ´»é”" class="headerlink" title="2.4.2.2 æ´»é”"></a>2.4.2.2 æ´»é”</h4><p>æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LiveLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiveLockDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æœŸæœ›å‡åˆ°0ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                count--;</span><br><span class="line">                log.debug(<span class="string">&quot;count: &#123;&#125;&quot;</span>, count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æœŸæœ›è¶…è¿‡20é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">while</span> (count &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                count++;</span><br><span class="line">                log.debug(<span class="string">&quot;count: &#123;&#125;&quot;</span>, count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£å†³ï¼šåœ¨çº¿ç¨‹æ‰§è¡Œæ—¶ï¼Œä¸­é€”ç»™äºˆä¸åŒçš„é—´éš”æ—¶é—´ï¼Œè®©æŸä¸ªçº¿ç¨‹å…ˆç»“æŸå³å¯ã€‚</p>
<p>æ­»é”ä¸æ´»é”çš„åŒºåˆ«ï¼š</p>
<ul>
<li>æ­»é”æ˜¯å› ä¸ºçº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹è±¡æƒ³è¦çš„é”ï¼Œå¹¶ä¸”éƒ½ä¸é‡Šæ”¾ï¼Œæœ€ååˆ°æ—¶çº¿ç¨‹é˜»å¡ï¼Œåœæ­¢è¿è¡Œçš„ç°è±¡ã€‚</li>
<li>æ´»é”æ˜¯å› ä¸ºçº¿ç¨‹é—´ä¿®æ”¹äº†å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œä»è€Œå¯¼è‡´ä»£ç ä¸€ç›´åœ¨è¿è¡Œï¼Œå´ä¸€ç›´è¿è¡Œä¸å®Œçš„ç°è±¡ã€‚</li>
</ul>
<h4 id="2-4-2-3-é¥¥é¥¿"><a href="#2-4-2-3-é¥¥é¥¿" class="headerlink" title="2.4.2.3 é¥¥é¥¿"></a>2.4.2.3 é¥¥é¥¿</h4><p>æŸäº›çº¿ç¨‹å› ä¸ºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ°CPUè°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸã€‚</p>
<p>åœ¨ä½¿ç”¨é¡ºåºåŠ é”æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°é¥¥é¥¿ç°è±¡ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210422165813526.png" class="" title="image-20210422165813526"><br />

<p>é¡ºåºåŠ é”çš„è§£å†³æ–¹æ¡ˆï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/62531/image-20210422205258032.png" class="" title="image-20210422205258032"><br />



<h3 id="2-4-3-ReentrantLock"><a href="#2-4-3-ReentrantLock" class="headerlink" title="2.4.3 ReentrantLock"></a>2.4.3 ReentrantLock</h3><p>ç‰¹ç‚¹ï¼ˆsynchronizedä¸å…·å¤‡çš„ï¼‰ï¼š</p>
<ul>
<li>å¯ä¸­æ–­</li>
<li>å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´</li>
<li>å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”</li>
<li>æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</li>
</ul>
<p>ä¸<code>synchronized</code>ä¸€æ ·ï¼Œéƒ½æ”¯æŒå¯é‡å…¥ã€‚</p>
<p>ä¸¤è€…æ¯”è¾ƒå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>Lock</th>
<th>synchronized</th>
</tr>
</thead>
<tbody><tr>
<td>å±‚æ¬¡æ–¹é¢</td>
<td>ï¼ˆ1ï¼‰<code>Lock</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ˜¯åœ¨ç±»çº§åˆ«ä¸Šçš„å®ç°ï¼›<br />ï¼ˆ2ï¼‰JDKå±‚æ¬¡çš„å®ç°ã€‚</td>
<td>ï¼ˆ1ï¼‰<code>synchronized</code>æ˜¯Javaå…³é”®å­—ï¼›<br />ï¼ˆ2ï¼‰JVMå±‚æ¬¡å®šä¹‰çš„ã€‚</td>
</tr>
<tr>
<td>çµæ´»æ€§æ–¹é¢</td>
<td><code>Lock</code>æ¥å£æä¾›çš„<code>lock()</code>å’Œ<code>unlock()</code>æ–¹æ³•ï¼Œå¯ä»¥éšæ—¶è·å¾—é”ã€é‡Šæ”¾é”ï¼Œéå¸¸çµæ´»ã€‚</td>
<td>é‡Šæ”¾é”ã€è·å¾—é”æ˜¯è¢«åŠ¨çš„ã€‚é‡Šæ”¾é”åªæœ‰ä¸¤ç§æƒ…å†µï¼š<br />ï¼ˆ1ï¼‰åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•<br />ï¼ˆ2ï¼‰æŠ›å‡ºå¼‚å¸¸ï¼ŒåŒæ­¥å™¨æ‰§è¡Œ<code>monitor.exit()</code>é‡Šæ”¾é”ã€‚</td>
</tr>
<tr>
<td>é”çš„çŠ¶æ€æ–¹é¢</td>
<td>ï¼ˆ1ï¼‰<code>Lock</code>å¯ä»¥åˆ¤æ–­é”çš„çŠ¶æ€ï¼Œå®ƒä¼šæä¾›<code>tryLock()</code>æ–¹æ³•æ¥å‘Šè¯‰æˆ‘ä»¬æ˜¯å¦è·å¾—é”æˆåŠŸã€‚<br />ï¼ˆ2ï¼‰<code>tryLock()</code>æœ‰è¿”å›å€¼ï¼Œç”¨æ¥å°è¯•è·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™è¿”å›falseï¼›è·å–å¤±è´¥ï¼Œè¿”å›falseï¼Œè¿™ä¸ªæ–¹æ³•æ— è®ºå¦‚ä½•éƒ½ä¼šç«‹å³è¿”å›ã€‚åœ¨æ‹¿ä¸åˆ°é”æ—¶ä¸ä¼šä¸€ç›´åœ¨é‚£ç­‰å¾…ã€‚</td>
<td>ï¼ˆ1ï¼‰åœ¨é”çš„çŠ¶æ€æ–¹é¢ï¼Œ<code>synchronized</code>å®Œå…¨æ˜¯è¢«åŠ¨çš„ï¼Œæ²¡æ³•åˆ¤æ–­é”çš„çŠ¶æ€ã€‚<br />ï¼ˆ2ï¼‰<code>synchronized</code>åœ¨æ‹¿ä¸åˆ°é”æ—¶ï¼Œåˆ™ä¼šé˜»å¡åœ¨é‚£é‡Œï¼Œä¸€ç›´ç­‰å¾…ã€‚</td>
</tr>
<tr>
<td>é”çš„ç±»å‹æ–¹é¢</td>
<td>åŸºäº<code>Lock</code>æ¥å£ï¼Œæœ‰å¤šç§é”çš„å®ç°ï¼Œå¦‚ï¼š<br />ï¼ˆ1ï¼‰å¯é‡å…¥é”ï¼š<code>ReentrantLock</code>ï¼›<br />ï¼ˆ2ï¼‰å¯é‡å…¥è¯»å†™é”ï¼š<code>ReentrantReadWriteLock</code>ç­‰ã€‚é’ˆå¯¹å¯é‡å…¥é”ï¼Œè¿˜æœ‰å…¬å¹³é”å’Œéå…¬å¹³é”ä¹‹åˆ†ã€‚</td>
<td>å¯¹äº<code>synchronized</code>æ¥è¯´ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªJVMå±‚æ¬¡çš„å…³é”®å­—ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ²¡æœ‰å…·ä½“å®ç°ã€‚</td>
</tr>
</tbody></table>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–é”</span></span><br><span class="line">reentrantLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    reentrantLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-4-3-1-å¯é‡å…¥"><a href="#2-4-3-1-å¯é‡å…¥" class="headerlink" title="2.4.3.1 å¯é‡å…¥"></a>2.4.3.1 å¯é‡å…¥</h4><p>å¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå› ä¸ºå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé”ã€‚å¦‚æœæ˜¯ä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;ReentrantLock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLockDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;enter main&quot;</span>);</span><br><span class="line">            m1();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;enter m1&quot;</span>);</span><br><span class="line">            m2();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;enter m2&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-22 22:49:46.320 [main] DEBUG ReentrantLock - enter main</span><br><span class="line">2021-04-22 22:49:46.322 [main] DEBUG ReentrantLock - enter m1</span><br><span class="line">2021-04-22 22:49:46.322 [main] DEBUG ReentrantLock - enter m2</span><br></pre></td></tr></table></figure>





<h4 id="2-4-3-2-å¯æ‰“æ–­"><a href="#2-4-3-2-å¯æ‰“æ–­" class="headerlink" title="2.4.3.2 å¯æ‰“æ–­"></a>2.4.3.2 å¯æ‰“æ–­</h4><p><code>synchoronized</code>å’Œ<code>reentrantLock.lock()</code>çš„é”ï¼Œæ˜¯ä¸å¯è¢«æ‰“æ–­çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åˆ«çš„çº¿ç¨‹å·²ç»è·å¾—äº†é”ï¼Œæˆ‘çš„çº¿ç¨‹å°±éœ€è¦ä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œä¸èƒ½ä¸­æ–­ã€‚</p>
<p>å¯è¢«ä¸­æ–­çš„é”ï¼Œé€šè¿‡<code>reentrantLock.lockInterruptibly()</code>è·å–çš„é”å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨é˜»å¡çº¿ç¨‹çš„<code>interrupt()</code>æ–¹æ³•ã€‚</p>
<p>å¦‚æœæŸä¸ªçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œå¯ä»¥è°ƒç”¨å…¶<code>interrupt()</code>æ–¹æ³•è®©å…¶åœæ­¢é˜»å¡ï¼Œè·å¾—é”å¤±è´¥ã€‚å¤„äºé˜»å¡çŠ¶æ€çš„çº¿ç¨‹ï¼Œè¢«æ‰“æ–­äº†å°±ä¸ç”¨é˜»å¡äº†ï¼Œç›´æ¥åœæ­¢å°±è¡Œã€‚</p>
<p>å¯ä¸­æ–­çš„é”ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥è¢«åŠ¨çš„å‡å°‘æ­»é”çš„æ¦‚ç‡ï¼Œä¹‹æ‰€ä»¥è¢«åŠ¨ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è°ƒç”¨é˜»å¡çº¿ç¨‹çš„<code>interrupt()</code>æ–¹æ³•ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;LockInterruptibly&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockInterruptiblyDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ²¡æœ‰ç«äº‰é‚£ä¹ˆæ­¤æ–¹æ³•å°±ä¼šè·å–lockå¯¹è±¡é”</span></span><br><span class="line">                <span class="comment">// å¦‚æœæœ‰ç«äº‰å°±è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ç”¨interruptæ–¹æ³•æ‰“æ–­</span></span><br><span class="line">                log.debug(<span class="string">&quot;å°è¯•è·å¾—é”&quot;</span>);</span><br><span class="line">                lock.lockInterruptibly();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                log.debug(<span class="string">&quot;æœªè·å–é”&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;è·å–åˆ°é”&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        lock.lock();</span><br><span class="line">        t1.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;æ‰“æ–­t1çº¿ç¨‹&quot;</span>);</span><br><span class="line">        t1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-22 22:57:01.129 [t1] DEBUG LockInterruptibly - å°è¯•è·å¾—é”</span><br><span class="line">2021-04-22 22:57:02.148 [main] DEBUG LockInterruptibly - æ‰“æ–­t1çº¿ç¨‹</span><br><span class="line">2021-04-22 22:57:02.149 [t1] DEBUG LockInterruptibly - æœªè·å–é”</span><br><span class="line">java.lang.InterruptedException</span><br></pre></td></tr></table></figure>



<h4 id="2-4-3-3-é”è¶…æ—¶"><a href="#2-4-3-3-é”è¶…æ—¶" class="headerlink" title="2.4.3.3 é”è¶…æ—¶"></a>2.4.3.3 é”è¶…æ—¶</h4><p>é˜²æ­¢æ— é™åˆ¶ç­‰å¾…ï¼Œå‡å°‘æ­»é”ã€‚</p>
<ul>
<li><code>reentrantLock.tryLock()</code>ä¼šè¿”å›é”æ˜¯å¦æˆåŠŸã€‚å¦‚æœæˆåŠŸåˆ™è¿”å›trueï¼Œåä¹‹åˆ™è¿”å›falseã€‚</li>
<li><code>tryLock(long timeoutï¼Œ TimeUnit unit)</code>å¯ä»¥è®¾ç½®æŒ‡å®šç­‰å¾…æ—¶é—´ï¼Œå…¶ä¸­timeoutä¸ºæœ€é•¿ç­‰å¾…æ—¶é—´ï¼Œunitä¸ºæ—¶é—´å•ä½ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Slf4j(topic &#x3D; &quot;TryLock&quot;)</span><br><span class="line">public class TryLockDemo &#123;</span><br><span class="line">    private static final ReentrantLock lock &#x3D; new ReentrantLock();</span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        Thread t1 &#x3D; new Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(&quot;å°è¯•è·å–é”&quot;);</span><br><span class="line">            try &#123;</span><br><span class="line">                if (!lock.tryLock(2, TimeUnit.SECONDS)) &#123; &#x2F;&#x2F; å°è¯•ç­‰å¾…2Sï¼Œè·å–é”</span><br><span class="line">                    log.debug(&quot;è·å–ä¸åˆ°é”&quot;);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                log.debug(&quot;è·å–ä¸åˆ°é”&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                log.debug(&quot;è·å–åˆ°é”&quot;);</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, &quot;t1&quot;);</span><br><span class="line">        lock.lock();</span><br><span class="line">        log.debug(&quot;è·å–åˆ°é”&quot;);</span><br><span class="line">        t1.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(1);</span><br><span class="line">        lock.unlock();</span><br><span class="line">        log.debug(&quot;é‡Šæ”¾äº†é”&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-04-23 00:46:54.944 [main] DEBUG TryLock - è·å–åˆ°é”</span><br><span class="line">2021-04-23 00:46:54.946 [t1] DEBUG TryLock - å°è¯•è·å–é”</span><br><span class="line">2021-04-23 00:46:55.949 [main] DEBUG TryLock - é‡Šæ”¾äº†é”</span><br><span class="line">2021-04-23 00:46:55.949 [t1] DEBUG TryLock - è·å–åˆ°é”</span><br></pre></td></tr></table></figure>



<p><strong>è§£å†³å“²å­¦å®¶å°±é¤çš„é—®é¢˜</strong></p>
<p>å°è¯•è·å–ç­·å­ï¼Œè·å–ä¸åˆ°å°±æ”¾ä¸‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhilosophersEatingDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> NUM = <span class="number">5</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Chopstick[] c = <span class="keyword">new</span> Chopstick[NUM];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NUM; i++) &#123;</span><br><span class="line">            c[i] = <span class="keyword">new</span> Chopstick(String.valueOf(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> Philosopher(<span class="string">&quot;è‹æ ¼æ‹‰åº•&quot;</span>, c[<span class="number">0</span>], c[<span class="number">1</span>]).start();</span><br><span class="line">        <span class="keyword">new</span> Philosopher(<span class="string">&quot;æŸæ‹‰å›¾&quot;</span>, c[<span class="number">1</span>], c[<span class="number">2</span>]).start();</span><br><span class="line">        <span class="keyword">new</span> Philosopher(<span class="string">&quot;äºšé‡Œå£«å¤šå¾·&quot;</span>, c[<span class="number">2</span>], c[<span class="number">3</span>]).start();</span><br><span class="line">        <span class="keyword">new</span> Philosopher(<span class="string">&quot;éƒæ‹‰å…‹åˆ©ç‰¹&quot;</span>, c[<span class="number">3</span>], c[<span class="number">4</span>]).start();</span><br><span class="line">        <span class="keyword">new</span> Philosopher(<span class="string">&quot;é˜¿åŸºç±³å¾·&quot;</span>, c[<span class="number">4</span>], c[<span class="number">0</span>]).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å“²å­¦å®¶</span></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;Philosopher&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Chopstick left;  <span class="comment">// å·¦æ‰‹ç­·å­</span></span><br><span class="line">    <span class="keyword">final</span> Chopstick right; <span class="comment">// å³æ‰‹ç­·å­</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(String name, Chopstick left, Chopstick right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">        <span class="keyword">this</span>.left = left;</span><br><span class="line">        <span class="keyword">this</span>.right = right;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (left.tryLock()) &#123; <span class="comment">// å°è¯•è·å¾—å·¦æ‰‹ç­·å­</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (right.tryLock()) &#123; <span class="comment">// å°è¯•è·å¾—å³æ‰‹ç­·å­</span></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            eat();</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            right.unlock(); <span class="comment">// é‡Šæ”¾å³æ‰‹ç­·å­</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    left.unlock();  <span class="comment">// é‡Šæ”¾å·¦æ‰‹ç­·å­</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åƒé¥­</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;eating...&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­·å­</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chopstick</span> <span class="keyword">extends</span> <span class="title">ReentrantLock</span>  </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Chopstick</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ç­·å­[&quot;</span> + <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;]&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-4-3-4-å…¬å¹³é”"><a href="#2-4-3-4-å…¬å¹³é”" class="headerlink" title="2.4.3.4 å…¬å¹³é”"></a>2.4.3.4 å…¬å¹³é”</h4><ul>
<li>å¯ä»¥æŠŠç«äº‰çš„çº¿ç¨‹æ”¾åœ¨ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜»å¡é˜Ÿåˆ—ä¸Š</li>
<li>åªè¦æŒæœ‰é”çš„çº¿ç¨‹æ‰§è¡Œå®Œäº†ï¼Œå”¤é†’é˜»å¡é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªçº¿ç¨‹è·å–é”å³å¯</li>
<li>å…ˆè¿›å…¥é˜Ÿåˆ—çš„çº¿ç¨‹å…ˆè·å–åˆ°é”</li>
</ul>
<p>synchronizedæ˜¯ä¸å…¬å¹³é”ã€‚ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œå…¶ä»–çº¿ç¨‹è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼›å½“è¿™ä¸ªçº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œé‚£ä¹ˆé˜»å¡é˜Ÿåˆ—çš„çº¿ç¨‹å°±ä¼šä¸€èµ·å»äº‰æŠ¢ï¼Œè€Œä¸æ˜¯æŒ‰ç…§å…ˆæ¥å…ˆå¾—çš„é¡ºåºã€‚</p>
<p>ReentrantLocké»˜è®¤æ˜¯ä¸å…¬å¹³çš„ï¼Œä½†æ˜¯å¯ä»¥åˆ‡æ¢ä¸ºå…¬å¹³é”ï¼Œçœ‹ä¸€çœ¼å¸¦å‚æ„é€ æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ„é€ ä¸€ä¸ªå…¬å¹³é”<code>new ReentrantLock(true)</code>ï¼Œå…¬å¹³é”æ²¡æœ‰å¿…è¦ï¼Œä¼šé™ä½å¹¶å‘åº¦ã€‚</p>
<h4 id="2-4-3-5-æ¡ä»¶å˜é‡"><a href="#2-4-3-5-æ¡ä»¶å˜é‡" class="headerlink" title="2.4.3.5 æ¡ä»¶å˜é‡"></a>2.4.3.5 æ¡ä»¶å˜é‡</h4><p>synchronizedä¸­ä¹Ÿæœ‰æ¡ä»¶å˜é‡ï¼Œå°±æ˜¯<code>waitSet</code>ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥<code>waitSet</code>ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥<code>waitSet</code>ç­‰å¾…ã€‚<code>ReentrantLock</code>çš„æ¡ä»¶å˜é‡æ¯”<code>synchronized</code>å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡çš„ã€‚</p>
<ul>
<li><code>synchronized</code>è®©é‚£äº›ä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹éƒ½åœ¨ä¸€é—´ä¼‘æ¯å®¤ç­‰æ¶ˆæ¯</li>
<li><code>ReentrantLock</code>æ”¯æŒå¤šé—´ä¼‘æ¯å®¤ï¼Œæœ‰ä¸“é—¨ç­‰çš„ä¼‘æ¯å®¤ã€ä¸“é—¨ç­‰æ—©é¤çš„ä¼‘æ¯å®¤ã€å”¤é†’æ—¶ä¹Ÿæ˜¯æŒ‰ä¼‘æ¯å®¤æ¥å”¤é†’</li>
</ul>
<p>ä½¿ç”¨æµç¨‹ï¼š</p>
<ul>
<li><code>await</code>å‰éœ€è¦è·å¾—é”</li>
<li><code>await</code>æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥<code>conditionObject</code>ç­‰å¾…</li>
<li><code>await</code>çš„çº¿ç¨‹è¢«å”¤é†’ï¼ˆæˆ–æ‰“æ–­ã€æˆ–è¶…æ—¶ï¼‰é‡æ–°ç«äº‰locké”</li>
<li>ç«äº‰locké”æˆåŠŸåï¼Œä»awaitåç»§ç»­æ‰§è¡Œ</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;CorrectPostureStep4&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorrectPostureStep4Demo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> hasCigarette = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> hasTakeAway = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">static</span> ReentrantLock ROOM = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="comment">// ç­‰çƒŸçš„ä¼‘æ¯å®¤</span></span><br><span class="line">    <span class="keyword">static</span> Condition waitCigaretteSet = ROOM.newCondition();</span><br><span class="line">    <span class="comment">// ç­‰å¤–å–çš„ä¼‘æ¯å®¤</span></span><br><span class="line">    <span class="keyword">static</span> Condition waitTakeAwaySet = ROOM.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            ROOM.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String name = Thread.currentThread().getName();</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸå— ? [&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">while</span> (!hasCigarette) &#123; <span class="comment">// é˜²æ­¢è™šå‡å”¤é†’</span></span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡æœ‰çƒŸ =&gt; [&#123;&#125;]å…ˆæ­‡ä¼š...&quot;</span>, name);</span><br><span class="line">                    waitCigaretteSet.await();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å†çœ‹çœ‹æœ‰çƒŸå— ? [&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æœ‰çƒŸäº† =&gt; [&#123;&#125;]å¼€å§‹å¹²æ´»ing&quot;</span>, name);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;ä¾ç„¶æ²¡æœ‰çƒŸ =&gt; [&#123;&#125;]ä¸å¹²æ´»äº†&quot;</span>, name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ROOM.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;FlowerK&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            ROOM.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String name = Thread.currentThread().getName();</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–æ˜¯å¦é€åˆ° ? [&#123;&#125;]&quot;</span>, hasTakeAway);</span><br><span class="line">                <span class="keyword">if</span> (!hasTakeAway) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¤–å–è¿˜æœªé€åˆ° =&gt; [&#123;&#125;]å…ˆæ­‡ä¼š...&quot;</span>, name);</span><br><span class="line">                    waitTakeAwaySet.await();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å†çœ‹çœ‹å¤–å–æ˜¯å¦é€åˆ° ? [&#123;&#125;]&quot;</span>, hasTakeAway);</span><br><span class="line">                <span class="keyword">if</span> (hasTakeAway) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¤–å–å·²ç»é€åˆ° =&gt; [&#123;&#125;]å¼€å§‹å¹²æ´»ing&quot;</span>, name);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¤–å–ä»ç„¶æœªåˆ° =&gt; [&#123;&#125;]ä¸å¹²æ´»äº†&quot;</span>, hasTakeAway);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ROOM.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;RubbishK&quot;</span>).start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            ROOM.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hasTakeAway = <span class="keyword">true</span>;</span><br><span class="line">                waitTakeAwaySet.signal();</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–å·²é€åˆ°&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ROOM.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;ç¾å›¢å¤–å–&quot;</span>).start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            ROOM.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hasCigarette = <span class="keyword">true</span>;</span><br><span class="line">                waitCigaretteSet.signal();</span><br><span class="line">                log.debug(<span class="string">&quot;çƒŸå·²é€åˆ°&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ROOM.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;é¥¿äº†ä¹ˆ&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-4-4-åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶"><a href="#2-4-4-åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶" class="headerlink" title="2.4.4 åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶"></a>2.4.4 åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</h3><h4 id="2-4-4-1-å›ºå®šè¾“å‡º"><a href="#2-4-4-1-å›ºå®šè¾“å‡º" class="headerlink" title="2.4.4.1 å›ºå®šè¾“å‡º"></a>2.4.4.1 å›ºå®šè¾“å‡º</h4><p>æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹Aæ‰“å°1ï¼Œçº¿ç¨‹Bæ‰“å°2ã€‚</p>
<p>è¦æ±‚ï¼šç¨‹åºå¿…é¡»å…ˆæ‰“å°2å†æ‰“å°1ã€‚</p>
<p>wait/notifyç‰ˆæœ¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;OrderWaitNotify&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderWaitNotifyDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> bRunned = <span class="keyword">false</span>; <span class="comment">// è¡¨ç¤ºt2æ˜¯å¦è¿è¡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread a = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">while</span> (!bRunned) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;A&quot;</span>);</span><br><span class="line">        Thread b = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock)  &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">                bRunned = <span class="keyword">true</span>;</span><br><span class="line">                lock.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;B&quot;</span>);</span><br><span class="line">        a.start();</span><br><span class="line">        b.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>await/signalç‰ˆæœ¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;OrderReentrant&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderReentrantDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Condition condition = lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> bRunned = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread a = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!bRunned) &#123;</span><br><span class="line">                    condition.await();</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;A&quot;</span>);</span><br><span class="line">        Thread b = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">                bRunned = <span class="keyword">true</span>;</span><br><span class="line">                condition.signal();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;B&quot;</span>);</span><br><span class="line">        a.start();</span><br><span class="line">        b.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>park/unparkç‰ˆæœ¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;OrderParkUnpark&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderParkUnparkDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread a = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.debug(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        &#125;, <span class="string">&quot;A&quot;</span>);</span><br><span class="line">        Thread b = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">            LockSupport.unpark(a);</span><br><span class="line">        &#125;, <span class="string">&quot;B&quot;</span>);</span><br><span class="line">        a.start();</span><br><span class="line">        b.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-4-4-2-äº¤æ›¿è¾“å‡º"><a href="#2-4-4-2-äº¤æ›¿è¾“å‡º" class="headerlink" title="2.4.4.2 äº¤æ›¿è¾“å‡º"></a>2.4.4.2 äº¤æ›¿è¾“å‡º</h4><p>çº¿ç¨‹Aè¾“å‡ºaäº”æ¬¡ï¼Œçº¿ç¨‹Bè¾“å‡ºbäº”æ¬¡ï¼Œçº¿ç¨‹Cè¾“å‡ºcäº”æ¬¡ã€‚</p>
<p>è¦æ±‚ï¼šç¨‹åºäº¤æ›¿è¾“å‡º5æ¬¡<code>abc</code>ã€‚</p>
<p>wait/notifyç‰ˆæœ¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlternateWaitNotifyDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AlternateWaitNotify alternateWaitNotify = <span class="keyword">new</span> AlternateWaitNotify(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; alternateWaitNotify.print(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>, <span class="number">2</span>), <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; alternateWaitNotify.print(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>, <span class="number">3</span>), <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; alternateWaitNotify.print(<span class="string">&quot;c&quot;</span>, <span class="number">3</span>, <span class="number">1</span>), <span class="string">&quot;C&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;AlternateWaitNotify&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlternateWaitNotify</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰æ ‡è®°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> flag;</span><br><span class="line">    <span class="comment">// å¾ªç¯æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> loopNumber;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AlternateWaitNotify</span><span class="params">(<span class="keyword">int</span> flag, <span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.flag = flag;</span><br><span class="line">        <span class="keyword">this</span>.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *   è¾“å‡ºå†…å®¹   ç­‰å¾…æ ‡è®°   ä¸‹ä¸ªæ ‡è®°</span></span><br><span class="line"><span class="comment">     *      a         1         2</span></span><br><span class="line"><span class="comment">     *      b         2         3</span></span><br><span class="line"><span class="comment">     *      c         3         1</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str       è¾“å‡ºå†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waitFlag  ç­‰å¾…æ ‡è®°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nextFlag  ä¸‹ä¸ªæ ‡è®°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String str, <span class="keyword">int</span> waitFlag, <span class="keyword">int</span> nextFlag)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">while</span> (waitFlag != <span class="keyword">this</span>.flag) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(str);</span><br><span class="line">                <span class="keyword">this</span>.flag = nextFlag;</span><br><span class="line">                <span class="keyword">this</span>.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>await/signalç‰ˆæœ¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlternateAwaitSignalDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AlternateAwaitSignal alternateWaitNotify = <span class="keyword">new</span> AlternateAwaitSignal(<span class="number">5</span>);</span><br><span class="line">        Condition aCondition = alternateWaitNotify.newCondition();</span><br><span class="line">        Condition bCondition = alternateWaitNotify.newCondition();</span><br><span class="line">        Condition cCondition = alternateWaitNotify.newCondition();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; alternateWaitNotify.print(<span class="string">&quot;a&quot;</span>, aCondition, bCondition), <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; alternateWaitNotify.print(<span class="string">&quot;b&quot;</span>, bCondition, cCondition), <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; alternateWaitNotify.print(<span class="string">&quot;c&quot;</span>, cCondition, aCondition), <span class="string">&quot;C&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;AlternateAwaitSignal&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlternateAwaitSignal</span> <span class="keyword">extends</span> <span class="title">ReentrantLock</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> loopNumber;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AlternateAwaitSignal</span><span class="params">(<span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str   æ‰“å°å†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> curr  å½“å‰ä¼‘æ¯å®¤</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> next  ä¸‹ä¸ªä¼‘æ¯å®¤</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String str, Condition curr, Condition next)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                curr.await();</span><br><span class="line">                log.debug(str);</span><br><span class="line">                next.signal();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>park/unparkç‰ˆæœ¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlternateParkUnparkDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Thread t1;</span><br><span class="line">    <span class="keyword">static</span> Thread t2;</span><br><span class="line">    <span class="keyword">static</span> Thread t3;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AlternateParkUnpark alternateParkUnpark = <span class="keyword">new</span> AlternateParkUnpark(<span class="number">5</span>);</span><br><span class="line">        t1 = <span class="keyword">new</span> Thread(() -&gt; alternateParkUnpark.print(<span class="string">&quot;a&quot;</span>, t2), <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        t2 = <span class="keyword">new</span> Thread(() -&gt; alternateParkUnpark.print(<span class="string">&quot;b&quot;</span>, t3), <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t3 = <span class="keyword">new</span> Thread(() -&gt; alternateParkUnpark.print(<span class="string">&quot;c&quot;</span>, t1), <span class="string">&quot;t3&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;AlternateParkUnpark&quot;)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlternateParkUnpark</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> loopNumber;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AlternateParkUnpark</span><span class="params">(<span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String str, Thread next)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.debug(str);</span><br><span class="line">            LockSupport.unpark(next);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringSecurity</title>
    <url>/posts/52913/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ğŸš€Githubä¼ é€é—¨ï¼š<a href="https://github.com/Khighness/spring-security">https://github.com/Khighness/spring-security</a></p>
<h2 id="1-Start-With-Maven"><a href="#1-Start-With-Maven" class="headerlink" title="1. Start With Maven"></a>1. Start With Maven</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.20<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jwt.version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">jwt.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR1<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis.spring.boot.starter.version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">mybatis.spring.boot.starter.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis-plus.boot.starter.version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">mybatis-plus.boot.starter.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- MySQL --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- JWT --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jwt.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Druid--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Druid Starter --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Mybatis Starter --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis.spring.boot.starter.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Mybatis-Plus Starter --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.boot.starter.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringBoot--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- SpringCloud --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="2-Spring-Security-Guide"><a href="#2-Spring-Security-Guide" class="headerlink" title="2. Spring Security Guide"></a>2. Spring Security Guide</h2><p>ğŸ“–æ¦‚è¿°</p>
<p>Spring Securityæ˜¯ä¸€æ¬¾åŸºäºSpringçš„å®‰å…¨æ¡†æ¶ï¼Œä¸»è¦åŒ…å«è®¤è¯å’Œæˆæƒä¸¤å¤§å®‰å…¨æ¨¡å—ï¼Œå’Œå¦å¤–ä¸€æ¬¾æµè¡Œçš„å®‰å…¨æ¡†æ¶ç›¸æ¯”ï¼Œå®ƒæ‹¥æœ‰æ›´åŠ å¼ºå¤§çš„åŠŸèƒ½ã€‚Spring Securityä¹Ÿå¯ä»¥è½»æ¾çš„è‡ªå®šä¹‰æ‰©å±•ä»¥æ»¡è¶³å„ç§éœ€æ±‚ï¼Œå¹¶ä¸”å¯¹å¸¸è§çš„webå®‰å…¨æ”»å‡»æä¾›äº†é˜²æŠ¤æ”¯æŒã€‚</p>
<h3 id="2-1-å¿«é€Ÿå¼€å§‹"><a href="#2-1-å¿«é€Ÿå¼€å§‹" class="headerlink" title="2.1 å¿«é€Ÿå¼€å§‹"></a>2.1 å¿«é€Ÿå¼€å§‹</h3><p>åˆ›å»ºé¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ªRESTæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(<span class="meta">@PathVariable(value = &quot;name&quot;)</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name + <span class="string">&quot;!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®<a href="http://localhost:8080/KHighness">http://localhost:8080/KHighness</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221180532272.png" class="" title="image-20201221180532272">

<p>é»˜è®¤ç”¨æˆ·åä¸ºuserï¼Œé»˜è®¤å¯†ç ä¼šåœ¨IDEçš„æ§åˆ¶å°æ‰“å°ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Using</span> default security password: af1489e7-58ea-4e12-a5b3-b2e0aae5b2f9</span><br></pre></td></tr></table></figure>

<p>è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç å³å¯è®¿é—®æ¥å£ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221180435109.png" class="" title="image-20201221180435109">

<p>å¼•å…¥Spring Securityä¾èµ–çš„æ—¶å€™ï¼Œé¡¹ç›®ä¼šé»˜è®¤å¼€å¯è®¤è¯ï¼š</p>
<ul>
<li><p>1.Xï¼šé»˜è®¤Http basicè®¤è¯</p>
</li>
<li><p>2.Xï¼šé»˜è®¤è¡¨å•ç™»å½•è®¤è¯</p>
</li>
<li><p>é»˜è®¤ç”¨æˆ·ï¼šuser</p>
</li>
<li><p>é»˜è®¤å¯†ç ï¼šéšæœºç”Ÿæˆ</p>
</li>
<li><p>é»˜è®¤æ‹¦æˆªï¼šæ‰€æœ‰è®¿é—®è·¯å¾„</p>
</li>
</ul>
<h3 id="2-2-ä¸¤ç§è®¤è¯"><a href="#2-2-ä¸¤ç§è®¤è¯" class="headerlink" title="2.2 ä¸¤ç§è®¤è¯"></a>2.2 ä¸¤ç§è®¤è¯</h3><p>SpringSecurity2.xé»˜è®¤éªŒè¯ä¸ºè¡¨å•éªŒè¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®å°†è¡¨å•è®¤è¯ä¿®æ”¹ä¸º<code>Http basic</code>è®¤è¯ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ªé…ç½®ç±»<code>BrowserSecurityConfig</code>ç»§æ‰¿<code>org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</code>å¹¶ä¸”é‡å†™<code>configure</code>æ–¹æ³•ã€‚<code>WebSecurityConfigurerAdapter</code>æ˜¯æœ‰Spring Securityæä¾›çš„Webåº”ç”¨å®‰å…¨é…ç½®çš„é€‚é…å™¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class BrowserSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(HttpSecurity httpSecurity) throws Exception &#123;</span><br><span class="line">        httpSecurity.httpBasic()       &#x2F;&#x2F; http basicè®¤è¯</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()  &#x2F;&#x2F; æˆæƒæ–¹å¼</span><br><span class="line">                .anyRequest()         &#x2F;&#x2F; æ‰€æœ‰è¯·æ±‚</span><br><span class="line">                .authenticated();     &#x2F;&#x2F; éƒ½éœ€è®¤è¯</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>HttpSecurity</code>æä¾›äº†è¿™ç§é“¾å¼çš„æ–¹æ³•è°ƒç”¨ã€‚ä»¥ä¸Šé…ç½®è®¤è¯æ–¹å¼ä¸ºHTTP basicè®¤è¯ï¼Œå¹¶ä¸”æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è¿›è¡Œè®¤è¯ã€‚</p>
<p>é‡å¯é¡¹ç›®ï¼Œå†æ¬¡è®¿é—®<a href="http://localhost:8080/KHighness%EF%BC%9A">http://localhost:8080/KHighnessï¼š</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221191139442.png" class="" title="image-20201221191139442">



<h3 id="2-3-åŸºæœ¬åŸç†"><a href="#2-3-åŸºæœ¬åŸç†" class="headerlink" title="2.3 åŸºæœ¬åŸç†"></a>2.3 åŸºæœ¬åŸç†</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221191555911.png" class="" title="image-20201221191555911">

<p>Spring SecurityåŒ…å«ä¼—å¤šçš„è¿‡æ»¤å™¨ï¼Œè¿™äº›è¿‡æ»¤å™¨å½¢æˆäº†ä¸€æ¡å®‰å…¨è¿‡æ»¤é“¾ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å¿…é¡»é€šè¿‡è¿™äº›è¿‡æ»¤å™¨åæ‰èƒ½æˆåŠŸè®¿é—®åˆ°èµ„æºã€‚å…¶ä¸­<code>UsernamePasswordAuthenticationFilter</code>è¿‡æ»¤å™¨ç”¨äºå¤„ç†åŸºäºè¡¨å•æ–¹å¼çš„ç™»å½•è®¤è¯ï¼Œè€Œ<code>BasicAuthenticationFilter</code>ç”¨äºå¤„ç†åŸºäº<code>HTTP Basic</code>æ–¹å¼çš„ç™»å½•éªŒè¯ï¼Œåé¢è¿˜å¯èƒ½åŒ…å«ä¸€ç³»åˆ—åˆ«çš„è¿‡æ»¤å™¨ï¼ˆå¯ä»¥é€šè¿‡ç›¸åº”é…ç½®å¼€å¯ï¼‰ã€‚åœ¨è¿‡æ»¤å™¨é“¾çš„æœ«å°¾æ˜¯ä¸€ä¸ªåä¸º<code>FilterSecurityInterceptor</code>çš„æ‹¦æˆªå™¨ï¼Œç”¨äºåˆ¤æ–­å½“å‰è¯·æ±‚èº«ä»½è®¤è¯æ˜¯å¦æˆåŠŸï¼Œæ˜¯å¦æœ‰ç›¸åº”çš„æƒé™ã€‚å½“èº«ä»½è®¤è¯å¤±è´¥æˆ–è€…æƒé™ä¸è¶³çš„æ—¶å€™ä¾¿ä¼šæŠ›å‡ºç›¸åº”çš„å¼‚å¸¸ã€‚</p>
<p><code>ExceptionTranslateFilter</code>æ•è·å¹¶å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨<code>ExceptionTranslateFilter</code>è¿‡æ»¤å™¨ç”¨äºå¤„ç†äº†<code>FilterSecurityInterceptor</code>æŠ›å‡ºçš„å¼‚å¸¸å¹¶è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚éœ€è¦èº«ä»½è®¤è¯æ—¶å°†è¯·æ±‚é‡å®šå‘åˆ°ç›¸åº”çš„è®¤è¯é¡µé¢ï¼Œå½“è®¤è¯å¤±è´¥æˆ–è€…æƒé™ä¸è¶³æ—¶è¿”å›ç›¸åº”çš„æç¤ºä¿¡æ¯ã€‚</p>
<p>å°†è®¤è¯æ–¹å¼æ”¹ä¸ºè¡¨å•è®¤è¯ï¼ŒDebugè¯æ˜è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>åœ¨<code>HelloController</code>ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221200542448.png" class="" title="image-20201221200542448">

<p>åœ¨<code>FilterSecurityInterceptor</code>ä¸Šçš„<code>invoke</code>æ–¹æ³•çš„<code>super.beforeInvocation(fi)</code>ä¸Šæ‰“ä¸ªæ–­ç‚¹</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221200713187.png" class="" title="image-20201221200713187">

<p>å½“è¿™è¡Œä»£ç æ‰§è¡Œé€šè¿‡åï¼Œä¾¿å¯ä»¥è°ƒç”¨ä¸‹ä¸€è¡Œçš„<code>doFilter</code>æ–¹æ³•æ¥çœŸæ­£è°ƒç”¨<code>/hello</code>æœåŠ¡ï¼Œå¦åˆ™å°†æŠ›å‡ºç›¸åº”çš„å¼‚å¸¸ã€‚</p>
<p>å½“<code>FilterSecurityInterceptor</code>æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸å°†ç”±<code>ExceptionTranslationFilter</code>æ•è·å¹¶å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨<code>ExceptionTranslationFilter</code>çš„<code>doFilter</code>æ–¹æ³•<code>catch</code>ä»£ç å—ç¬¬ä¸€è¡Œæ‰“ä¸ªæ–­ç‚¹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221201059087.png" class="" title="image-20201221201059087">

<p> ç­‰ä¼šæ¨¡æ‹Ÿæœªç™»å½•ç›´æ¥è®¿é—®/{name}ï¼Œæ‰€ä»¥åº”è¯¥æŠ›å‡ºç”¨æˆ·æœªç™»å½•çš„å¼‚å¸¸ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥åº”è¯¥è·³è½¬åˆ°<code>UsernamePasswordAuthenticationFilter</code>å¤„ç†è¡¨å•æ–¹å¼çš„ç”¨æˆ·è®¤è¯ï¼Œåœ¨<code>UsernamePasswordAuthenticationFilter</code>çš„<code>attemptAuthentication</code>æ–¹æ³•ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221201407487.png" class="" title="image-20201221201407487">



<p>å‡†å¤‡å®Œæ¯•ï¼Œè®¿é—®<a href="http://localhost:8080/KHighness%E3%80%82">http://localhost:8080/KHighnessã€‚</a></p>
<p>ä»£ç ç¬¬ä¸€æ­¥è·³è½¬åˆ°<code>FilterSecurityInterceptor</code>çš„<code>beforeInvocation</code>æ–­ç‚¹ä¸Šï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221202149865.png" class="" title="image-20201221202149865">

<p>å¾€ä¸‹æ‰§è¡Œï¼Œå› ä¸ºå½“å‰è¯·æ±‚æ²¡æœ‰ç»è¿‡èº«ä»½è®¤è¯ï¼Œæ‰€ä»¥æŠ›å‡ºå¼‚å¸¸å¹¶è¢«<code>ExceptionTranslationFilter</code>æ•è·ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221202314078.png" class="" title="image-20201221202314078">

<p>æ•è·å¼‚å¸¸åé‡å®šå‘åˆ°ç™»å½•è¡¨å•é¡µé¢ï¼Œå½“æˆ‘ä»¬åœ¨è¡¨å•ç™»é™†é¡µé¢è¾“å…¥ä¿¡æ¯å¹¶ç‚¹å‡»Sign inåï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221202956446.png" class="" title="image-20201221202956446">

<p>ä»£ç è·³è½¬åˆ°<code>UsernamePasswordAuthenticationFilter</code>çš„<code>attemptAuthentication</code>æ–­ç‚¹ä¸Šï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221202818305.png" class="" title="image-20201221202818305">

<p>åˆ¤æ–­ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®ä¹‹åï¼Œä»£ç åˆè·³å›åˆ°<code>FilterSecurityInterceptor</code>çš„<code>beforeInvocation</code>æ–­ç‚¹ä¸Šï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221203145555.png" class="" title="image-20201221203145555">

<p>å½“è®¤è¯é€šè¿‡æ—¶ï¼Œ<code>FilterSecurityInterceptor</code>ä»£ç å¾€ä¸‹æ‰§è¡Œ<code>invoke</code>ï¼Œç„¶åä»£ç æœ€ç»ˆè·³è½¬åˆ°ä¸Š<code>HelloController</code>ä¸Šï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201221203423267.png" class="" title="image-20201221203423267">

<p>æœ€åæµè§ˆå™¨å°†æ˜¾ç¤º<code>Hello KHighness!</code>ä¿¡æ¯ã€‚</p>
<h2 id="3-Spring-Security-Authentication"><a href="#3-Spring-Security-Authentication" class="headerlink" title="3. Spring Security Authentication"></a>3. Spring Security Authentication</h2><p>ğŸ“–æ¦‚è¿°</p>
<p>Spring Securityæ”¯æŒè‡ªå®šä¹‰è®¤è¯è¿‡ç¨‹ï¼Œå¦‚å¤„ç†ç”¨æˆ·ä¿¡æ¯è·å–é€»è¾‘ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ç™»å½•é¡µé¢æ›¿æ¢Spring Securityé»˜è®¤çš„ç™»å½•é¡µåŠè‡ªå®šä¹‰ç™»å½•æˆåŠŸæˆ–å¤±è´¥åçš„å¤„ç†é€»è¾‘ç­‰ã€‚</p>
<h3 id="3-1-æ›¿æ¢é»˜è®¤ç™»å½•é¡µ"><a href="#3-1-æ›¿æ¢é»˜è®¤ç™»å½•é¡µ" class="headerlink" title="3.1 æ›¿æ¢é»˜è®¤ç™»å½•é¡µ"></a>3.1 æ›¿æ¢é»˜è®¤ç™»å½•é¡µ</h3><p>åˆ›å»ºé¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é¡¹ç›®åŸºæœ¬é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">tomcat:</span></span><br><span class="line">    <span class="attr">uri-encoding:</span> <span class="string">UTF-8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">CustomAuthenticationApplication</span></span><br><span class="line">  <span class="attr">thymeleaf:</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">prefix:</span> <span class="string">classpath:/templates/</span></span><br><span class="line">    <span class="attr">suffix:</span> <span class="string">.html</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">HTML5</span></span><br><span class="line">    <span class="attr">encoding:</span> <span class="string">UTF-8</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">druid:</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/web?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowMultiQueries=true</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">KAG1823</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:/mapper/**/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">top.parak.entity</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">banner:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>åœ¨resourcesç›®å½•ä¸‹æ–°å»ºtemplatesç›®å½•ï¼Œåœ¨templatesç›®å½•åˆ›å»ºç™»å½•é¡µé¢<code>login.html</code>ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span></span></span><br><span class="line"><span class="tag">          <span class="attr">content</span>=<span class="string">&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Login Page<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span></span><br><span class="line">        body&#123;</span><br><span class="line">            margin: 0;</span><br><span class="line">            padding: 0;</span><br><span class="line">            height: 100vh;</span><br><span class="line"><span class="css">            <span class="selector-tag">background</span>: <span class="selector-id">#2F323A</span>;</span></span><br><span class="line">            background-size: cover;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span>&#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background</span>: <span class="selector-id">#000</span>;</span></span><br><span class="line">            z-index: 1;</span><br><span class="line">            font-family: &quot;Candara&quot;, sans-serif;</span><br><span class="line">            position: absolute;</span><br><span class="line">            top: 50%;</span><br><span class="line">            left: 50%;</span><br><span class="line">            transform: translate(-50%, -50%);</span><br><span class="line">            width: 300px;</span><br><span class="line">            padding: 0 45px 30px 45px;</span><br><span class="line">            text-align: center;</span><br><span class="line">            border-radius: 10px;</span><br><span class="line"><span class="css">            <span class="selector-tag">opacity</span>: 0<span class="selector-class">.9</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span> <span class="selector-tag">h2</span>&#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line">            font-size: 28px;</span><br><span class="line">            font-weight: 500;</span><br><span class="line">            text-align: center;</span><br><span class="line">            text-transform: uppercase;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span> <span class="selector-class">.icons</span> <span class="selector-tag">i</span>&#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line">            font-size: 25px;</span><br><span class="line">            margin: 0 30px 30px 30px;</span><br><span class="line"><span class="css">            <span class="selector-tag">transition</span>: 0<span class="selector-class">.8s</span>;</span></span><br><span class="line">            transition-property: color, transform;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span> <span class="selector-class">.icons</span> <span class="selector-tag">i</span><span class="selector-pseudo">:hover</span>&#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#06C5CF</span>;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">transform</span>: <span class="selector-tag">scale</span>(1<span class="selector-class">.3</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span> <span class="selector-tag">input</span>&#123;</span></span><br><span class="line">            outline: 0;</span><br><span class="line">            background: none;</span><br><span class="line">            font-size: 15px;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line">            text-align: center;</span><br><span class="line">            width: 265px;</span><br><span class="line">            margin-bottom: 30px;</span><br><span class="line">            padding: 15px;</span><br><span class="line">            box-sizing: border-box;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 2<span class="selector-class">.5px</span> <span class="selector-tag">solid</span> <span class="selector-id">#2E86DE</span>;</span></span><br><span class="line">            border-radius: 25px;</span><br><span class="line"><span class="css">            <span class="selector-tag">transition</span>: 0<span class="selector-class">.5s</span>;</span></span><br><span class="line">            transition-property: width;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span> <span class="selector-tag">input</span><span class="selector-pseudo">:hover</span>&#123;</span></span><br><span class="line">            width: 300px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span> <span class="selector-tag">input</span><span class="selector-pseudo">:focus</span>&#123;</span></span><br><span class="line">            width: 300px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span> <span class="selector-tag">button</span>&#123;</span></span><br><span class="line">            outline: 0;</span><br><span class="line">            background: none;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line">            font-size: 14px;</span><br><span class="line">            text-transform: uppercase;</span><br><span class="line">            width: 150px;</span><br><span class="line">            padding: 15px;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 2<span class="selector-class">.5px</span> <span class="selector-tag">solid</span> <span class="selector-id">#10AC84</span>;</span></span><br><span class="line">            border-radius: 25px;</span><br><span class="line">            cursor: pointer;</span><br><span class="line"><span class="css">            <span class="selector-tag">transition</span>: 0<span class="selector-class">.5s</span>;</span></span><br><span class="line">            transition-property: background, transform;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span> <span class="selector-tag">button</span><span class="selector-pseudo">:hover</span>, <span class="selector-class">.form</span> <span class="selector-tag">button</span><span class="selector-pseudo">:active</span>, <span class="selector-class">.form</span> <span class="selector-tag">button</span><span class="selector-pseudo">:focus</span>&#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background</span>: <span class="selector-id">#10AC84</span>;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">transform</span>: <span class="selector-tag">scale</span>(1<span class="selector-class">.1</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span> <span class="selector-class">.options</span>&#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#bbb</span>;</span></span><br><span class="line">            font-size: 14px;</span><br><span class="line">            margin: 20px 0 0;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.form</span> <span class="selector-class">.options</span> <span class="selector-tag">a</span>&#123;</span></span><br><span class="line">            text-decoration: none;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#06C5CF</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;login-form&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Spring Security<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Username&quot;</span> <span class="attr">required</span>=<span class="string">&quot;required&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>  <span class="attr">placeholder</span>=<span class="string">&quot;Password&quot;</span> <span class="attr">required</span>=<span class="string">&quot;required&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;button&quot;</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;options&quot;</span>&gt;</span>Not Registered? <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>Create an Account<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºè®¤è¯é…ç½®ç±»<code>BrowserSecurityConfig</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        httpSecurity</span><br><span class="line">            <span class="comment">// è®¤è¯é…ç½®</span></span><br><span class="line">            .formLogin()                                  <span class="comment">// è®¾ç½®è¡¨å•ç™»å½•</span></span><br><span class="line">            .loginPage(<span class="string">&quot;/authentication&quot;</span>)                 <span class="comment">// è®¾ç½®ç™»å½•é¡µé¢</span></span><br><span class="line">            .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)                 <span class="comment">// å¤„ç†è¡¨å•ç™»å½•</span></span><br><span class="line">            .usernameParameter(<span class="string">&quot;username&quot;</span>)                <span class="comment">// ç”¨æˆ·åè¾“å…¥æ¡†çš„name</span></span><br><span class="line">            .passwordParameter(<span class="string">&quot;password&quot;</span>)                <span class="comment">// å¯†ç è¾“å…¥æ¡†çš„name</span></span><br><span class="line">            .and()</span><br><span class="line">             <span class="comment">// æˆæƒé…ç½®</span></span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            .antMatchers(<span class="string">&quot;/authentication&quot;</span>).permitAll() <span class="comment">// ä¸éœ€è¦è®¤è¯å³å¯è®¿é—®</span></span><br><span class="line">            .anyRequest().authenticated()               <span class="comment">// æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è®¤è¯</span></span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">// å®‰å…¨é…ç½®</span></span><br><span class="line">            .csrf().disable();                           <span class="comment">// ç¦æ­¢è·¨ç«™CSRFæ”»å‡»</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ªRestæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/authentication&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">authenticationLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello Khighness&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•è®¿é—®<a href="http://localhost:8080/hello%EF%BC%8C%E8%B7%B3%E8%BD%AC%E5%88%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%EF%BC%9A">http://localhost:8080/helloï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢ï¼š</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201222134139487.png" class="" title="image-20201222134139487">

<p>è¾“å…¥ç”¨æˆ·åï¼ˆuserï¼‰å’Œå¯†ç ï¼ˆæ§åˆ¶å°æ‰“å°ï¼‰å³å¯çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20201222133437066.png" class="" title="image-20201222133437066">



<h3 id="3-2-è‡ªå®šä¹‰è®¤è¯è¿‡ç¨‹"><a href="#3-2-è‡ªå®šä¹‰è®¤è¯è¿‡ç¨‹" class="headerlink" title="3.2 è‡ªå®šä¹‰è®¤è¯è¿‡ç¨‹"></a>3.2 è‡ªå®šä¹‰è®¤è¯è¿‡ç¨‹</h3><p>è‡ªå®šä¹‰è®¤è¯çš„è¿‡ç¨‹éœ€è¦Spring Securityæä¾›çš„<code>UserDetailService</code>æ¥å£ï¼Œè¯¥æ¥å£åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="function">UserDetails <span class="title">loadUserByUsername</span><span class="params">(String var1)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>loadUserByUsername</code>æ–¹æ³•è¿”å›ä¸€ä¸ª<code>UserDetails</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒåŒ…å«ä¸€äº›ç”¨äºæè¿°ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•ï¼Œç”¨äºä¸ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œå¯¹æ¯”è®¤è¯ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™äº›æ–¹æ³•çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">getAuthorities</td>
<td align="center">è·å–ç”¨æˆ·åŒ…å«çš„æƒé™ï¼Œè¿”å›æƒé™é›†åˆ</td>
</tr>
<tr>
<td align="center">getPassword</td>
<td align="center">è·å–å¯†ç ï¼Œè¿”å›Stringç±»å‹</td>
</tr>
<tr>
<td align="center">getUsername</td>
<td align="center">è·å–ç”¨æˆ·åï¼Œè¿”å›Stringç±»å‹</td>
</tr>
<tr>
<td align="center">isAccountNonExpired</td>
<td align="center">ç”¨äºåˆ¤æ–­è´¦æˆ·æ˜¯å¦æœªè¿‡æœŸï¼Œæœªè¿‡æœŸè¿”å›trueåæ­£è¿”å›false</td>
</tr>
<tr>
<td align="center">isAccountNonLocked</td>
<td align="center">ç”¨äºåˆ¤æ–­è´¦æˆ·æ˜¯å¦æœªé”å®šï¼Œæœªé”å®šè¿”å›trueåæ­£è¿”å›false</td>
</tr>
<tr>
<td align="center">isCredentialsNonExpired</td>
<td align="center">ç”¨äºåˆ¤æ–­è´¦æˆ·å‡­è¯(å³å¯†ç )æ˜¯å¦æœªè¿‡æœŸï¼Œæœªè¿‡æœŸè¿”å›trueåæ­£è¿”å›false</td>
</tr>
<tr>
<td align="center">isEnabled</td>
<td align="center">ç”¨äºåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ç”¨ï¼Œå¯ç”¨è¿”å›trueåæ­£è¿”å›false</td>
</tr>
</tbody></table>
<p>åˆ›å»ºæ•°æ®åº“ï¼š</p>
<table>
<thead>
<tr>
<th align="center">ç”¨æˆ·å</th>
<th align="center">å¯†ç </th>
<th align="center">è§’è‰²</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Khighness</td>
<td align="center">KAG1823</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">FlowerK</td>
<td align="center">KAG1823</td>
<td align="center">manager</td>
</tr>
<tr>
<td align="center">RubbishK</td>
<td align="center">KAG1823</td>
<td align="center">normal</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">80</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">tinyint</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;Khighness&#x27;</span>, <span class="string">&#x27;$2a$10$lACRBH58EGnTGHGrt2kya.OaF5vzpqkYR3Hx604FkWw0Lr6tu0goO&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;FlowerK&#x27;</span>, <span class="string">&#x27;$2a$10$lACRBH58EGnTGHGrt2kya.OaF5vzpqkYR3Hx604FkWw0Lr6tu0goO&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user`</span> <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;RubbishK&#x27;</span>, <span class="string">&#x27;$2a$10$lACRBH58EGnTGHGrt2kya.OaF5vzpqkYR3Hx604FkWw0Lr6tu0goO&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`role`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`role_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">4</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`role`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;admin&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`role`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;manager&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`role`</span> <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;normal&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_role`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`role_id`</span> <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`user_id`</span> (<span class="string">`user_id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`role_id`</span> (<span class="string">`role_id`</span>),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> <span class="string">`role_id`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`role_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`role`</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> <span class="string">`user_id`</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (<span class="string">`user_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`user`</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_bin;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_role`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_role`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_role`</span> <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä¸‰ä¸ªåˆ›å»ºå®ä½“ç±»ã€‚</p>
<p>å®šä¹‰ç”¨æˆ·<code>MyUser</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUser</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1753000091845565507L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;username&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;password&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> accountNonExpired = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> accountNonLocked= <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> credentialsNonExpired= <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> enabled= <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰è§’è‰²<code>MyRole</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(&quot;role&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRole</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7565000980394639717L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;role_name&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰ç”¨æˆ·è§’è‰²å…³ç³»<code>UserToRole</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(&quot;user_role&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserToRole</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">252063821059124209L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;user_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(value = &quot;role_id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> roleId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ä»¥ä¸Šä¸‰ä¸ªå®ä½“ç±»çš„æŒä¹…å±‚æ¥å£å…¨éƒ¨ç»§æ‰¿<code>Mybatis-plus</code>çš„<code>BaseMapper</code>ã€‚</p>
<p>ç„¶ååœ¨<code>BrowserSecurityConfig</code>ä¸­æ·»åŠ <code>Bean</code>ï¼Œä»¥å®ç°BCRåŠ å¯†ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹æ¥äº†ï¼Œè‡ªå®šä¹‰è®¤è¯ï¼Œåˆ›å»º<code>CustomUserDetailService</code>å®ç°<code>UserDetailsService</code>æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserDetailService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RoleMapper roleMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserToRoleMapper userToRoleMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (username != <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;ç™»å½•ç”¨æˆ·å =&gt; [&#123;&#125;]&quot;</span>, username);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ç”¨æˆ·å¯†ç </span></span><br><span class="line">        QueryWrapper&lt;MyUser&gt; userQueryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        userQueryWrapper.eq(<span class="string">&quot;username&quot;</span>, username);</span><br><span class="line">        MyUser user = userMapper.selectOne(userQueryWrapper);</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢è§’è‰²ID</span></span><br><span class="line">        QueryWrapper&lt;UserToRole&gt; userToRoleQueryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        userToRoleQueryWrapper.eq(<span class="string">&quot;user_id&quot;</span>, user.getId());</span><br><span class="line">        UserToRole userToRole = userToRoleMapper.selectOne(userToRoleQueryWrapper);</span><br><span class="line">        <span class="keyword">int</span> roleId = userToRole.getRoleId();</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ç”¨æˆ·è§’è‰²</span></span><br><span class="line">        QueryWrapper&lt;MyRole&gt; roleQueryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        roleQueryWrapper.eq(<span class="string">&quot;id&quot;</span>, roleId);</span><br><span class="line">        MyRole role = roleMapper.selectOne(roleQueryWrapper);</span><br><span class="line">        <span class="comment">// è¿”å›è®¤è¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username, user.getPassword(), user.isEnabled(),</span><br><span class="line">                user.isAccountNonExpired(), user.isCredentialsNonExpired(),</span><br><span class="line">                user.isAccountNonLocked(), AuthorityUtils.commaSeparatedStringToAuthorityList(role.getRoleName()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•è®¿é—®<a href="http://localhost:8080/hello%EF%BC%8C%E8%BE%93%E5%85%A5%E7%94%A8%E6%88%B7%E5%90%8D(Khighness)%E5%92%8C%E5%AF%86%E7%A0%81(KAG1823)%E5%8D%B3%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%88%90%E5%8A%9F%E3%80%82">http://localhost:8080/helloï¼Œè¾“å…¥ç”¨æˆ·å(Khighness)å’Œå¯†ç (KAG1823)å³å¯è®¿é—®æˆåŠŸã€‚</a></p>
<h3 id="3-3-å¤„ç†æˆåŠŸå’Œå¤±è´¥"><a href="#3-3-å¤„ç†æˆåŠŸå’Œå¤±è´¥" class="headerlink" title="3.3 å¤„ç†æˆåŠŸå’Œå¤±è´¥"></a>3.3 å¤„ç†æˆåŠŸå’Œå¤±è´¥</h3><p>Spring Securityæœ‰ä¸€å¥—é»˜è®¤çš„å¤„ç†ç™»å½•æˆåŠŸå’Œå¤±è´¥çš„æ–¹æ³•ï¼šå½“ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶ï¼Œé¡µé¢ä¼šè·³è½¬ä¼šå¼•å‘ç™»å½•çš„è¯·æ±‚ï¼Œæ¯”å¦‚åœ¨æœªç™»å½•çš„æƒ…å†µä¸‹è®¿é—®<a href="http://localhost:8080/hello%EF%BC%8C%E9%A1%B5%E9%9D%A2%E4%BC%9A%E8%B7%B3%E8%BD%AC%E5%88%B0%E7%99%BB%E5%BD%95%E9%A1%B5%EF%BC%8C%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%E5%90%8E%E5%86%8D%E8%B7%B3%E8%BD%AC%E5%9B%9E%E6%9D%A5%EF%BC%9B%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5%E6%97%B6%E5%88%99%E6%98%AF%E8%B7%B3%E8%BD%AC%E5%88%B0Spring">http://localhost:8080/helloï¼Œé¡µé¢ä¼šè·³è½¬åˆ°ç™»å½•é¡µï¼Œç™»å½•æˆåŠŸåå†è·³è½¬å›æ¥ï¼›ç™»å½•å¤±è´¥æ—¶åˆ™æ˜¯è·³è½¬åˆ°Spring</a> Securityé»˜è®¤çš„é”™è¯¯æç¤ºé¡µé¢ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€äº›è‡ªå®šä¹‰é…ç½®æ¥æ›¿æ¢è¿™å¥—é»˜è®¤çš„å¤„ç†æœºåˆ¶ã€‚</p>
<p>ï¼ˆ1ï¼‰<strong>è‡ªå®šä¹‰ç™»å½•æˆåŠŸé€»è¾‘</strong></p>
<p>è¦æ”¹å˜é»˜è®¤çš„å¤„ç†æˆåŠŸé€»è¾‘å¾ˆç®€å•ï¼Œåªéœ€è¦å®ç°<code>org.springframework.security.web.authentication.AuthenticationSuccessHandler</code>æ¥å£çš„<code>onAuthenticationSuccess</code>æ–¹æ³•å³å¯ã€‚</p>
<p>ç™»å½•æˆåŠŸè¿”å›è®¤è¯ä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticationSucessHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> RedirectStrategy redirectStrategy = <span class="keyword">new</span> DefaultRedirectStrategy();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        redirectStrategy.sendRedirect(request, response, <span class="string">&quot;/success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨Restæ¥å£ä¸­æ·»åŠ <code>/success</code>æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/success&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">success</span><span class="params">(Authentication authentication)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> authentication;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰<strong>è‡ªå®šä¹‰ç™»å½•å¤±è´¥é€»è¾‘</strong></p>
<p>ç™»å½•å¤±è´¥è¿”å›é”™è¯¯ä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticationFailureHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationFailureHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        AuthenticationException exception)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        response.getWriter().write(mapper.writeValueAsString(exception.getMessage()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åä¿®æ”¹<code>BrowserSecurityConfig</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSucessHandler authenticationSucessHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler authenticationFailureHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        httpSecurity</span><br><span class="line">            <span class="comment">// è®¤è¯é…ç½®</span></span><br><span class="line">            .formLogin()                                  <span class="comment">// è®¾ç½®è¡¨å•ç™»å½•</span></span><br><span class="line">            .loginPage(<span class="string">&quot;/authentication&quot;</span>)                 <span class="comment">// è®¾ç½®ç™»å½•é¡µé¢</span></span><br><span class="line">            .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>)                 <span class="comment">// å¤„ç†è¡¨å•ç™»å½•</span></span><br><span class="line">            .usernameParameter(<span class="string">&quot;username&quot;</span>)                <span class="comment">// ç”¨æˆ·åè¾“å…¥æ¡†çš„name</span></span><br><span class="line">            .passwordParameter(<span class="string">&quot;password&quot;</span>)                <span class="comment">// å¯†ç è¾“å…¥æ¡†çš„name</span></span><br><span class="line">            <span class="comment">// ç»“æœå¤„ç†</span></span><br><span class="line">            .successHandler(authenticationSucessHandler)  <span class="comment">// ç™»å½•æˆåŠŸå¤„ç†</span></span><br><span class="line">            .failureHandler(authenticationFailureHandler) <span class="comment">// ç™»å½•å¤±è´¥å¤„ç†</span></span><br><span class="line">            .and()</span><br><span class="line">             <span class="comment">// æˆæƒé…ç½®</span></span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            .antMatchers(<span class="string">&quot;/authentication&quot;</span>).permitAll()   <span class="comment">// ä¸éœ€è¦è®¤è¯å³å¯è®¿é—®</span></span><br><span class="line">            .anyRequest().authenticated()                 <span class="comment">// æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è®¤è¯</span></span><br><span class="line">            .and()</span><br><span class="line">            <span class="comment">// å…³é—­CSRFä¿æŠ¤</span></span><br><span class="line">            .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨é¡¹ç›®ï¼Œæµ‹è¯•è®¿é—®ï¼š<a href="http://localhost:8080/hello">http://localhost:8080/hello</a></p>
<p>ç™»å½•æˆåŠŸåè¿”å›å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 20201222153225</span></span><br><span class="line"><span class="comment">// http://localhost:8080/success</span></span><br><span class="line">â€‹</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;authorities&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;authority&quot;</span>: <span class="string">&quot;admin&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;details&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;remoteAddress&quot;</span>: <span class="string">&quot;0:0:0:0:0:0:0:1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sessionId&quot;</span>: <span class="literal">null</span></span><br><span class="line">  &#125;,Â·</span><br><span class="line">  &quot;authenticated&quot;: true,</span><br><span class="line">  &quot;principal&quot;: &#123;</span><br><span class="line">    &quot;password&quot;: null,</span><br><span class="line">    &quot;username&quot;: &quot;Khighness&quot;,</span><br><span class="line">    &quot;authorities&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;authority&quot;</span>: <span class="string">&quot;admin&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;accountNonExpired&quot;: true,</span><br><span class="line">    &quot;accountNonLocked&quot;: true,</span><br><span class="line">    &quot;credentialsNonExpired&quot;: true,</span><br><span class="line">    &quot;enabled&quot;: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;credentials&quot;: null,</span><br><span class="line">  &quot;name&quot;: &quot;Khighness&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åƒ<code>password</code>ï¼Œ<code>credentials</code>è¿™äº›æ•æ„Ÿä¿¡æ¯ï¼ŒSpring Securityå·²ç»å°†å…¶å±è”½ã€‚</p>
<h2 id="4-Spring-Security-RememberMe"><a href="#4-Spring-Security-RememberMe" class="headerlink" title="4. Spring Security RememberMe"></a>4. Spring Security RememberMe</h2><p>ğŸ’ è¯´æ˜</p>
<p>è¿™ä¸€èŠ‚çš„ä»£ç åœ¨ä¸Šä¸€èŠ‚çš„åŸºç¡€ä¸Šä¿®æ”¹ã€‚</p>
<p>ğŸ“–æ¦‚è¿°</p>
<p>SpringSecurityè®°ä½æˆ‘åŠŸèƒ½çš„å®ç°è¿‡ç¨‹ï¼šç”¨æˆ·å‹¾é€‰äº†è®°ä½æˆ‘é€‰é¡¹å¹¶ç™»å½•æˆåŠŸåï¼ŒSpringSecurityä¼šç”Ÿæˆä¸€ä¸ªtokenï¼Œå¹¶æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œå¹¶ä¸”ç”Ÿæˆä¸€ä¸ªä¸è¯¥tokenç›¸å¯¹åº”çš„cookieè¿”å›ç»™æµè§ˆå™¨ã€‚å½“ç”¨æˆ·è¿‡æ®µæ—¶é—´å†æ¬¡è®¿é—®ç³»ç»Ÿæ—¶ï¼Œå¦‚æœè¯¥cookieæ²¡æœ‰è¿‡æœŸï¼ŒSpringSecurityä¾¿ä¼šæ ¹æ®cookieåŒ…å«çš„ä¿¡æ¯ä»æ•°æ®åº“è·å–ç›¸åº”çš„tokenä¿¡æ¯ï¼Œç„¶åå¸®ç”¨æˆ·è‡ªåŠ¨å®Œæˆç™»å½•æ“ä½œã€‚</p>
<h3 id="4-1-ç™»å½•ä¿®æ”¹"><a href="#4-1-ç™»å½•ä¿®æ”¹" class="headerlink" title="4.1 ç™»å½•ä¿®æ”¹"></a>4.1 ç™»å½•ä¿®æ”¹</h3><p>åœ¨ç™»å½•é¡µé¢ä¸­æ·»åŠ è®°ä½æˆ‘å¤é€‰æ¡†ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;remember-me&quot;</span>/&gt;</span>remember me<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼Œ<code>name</code>å¿…é¡»ä¸º<code>remember-me</code>ã€‚</p>
<h3 id="4-2-æ•°æ®åº“è¡¨"><a href="#4-2-æ•°æ®åº“è¡¨" class="headerlink" title="4.2 æ•°æ®åº“è¡¨"></a>4.2 æ•°æ®åº“è¡¨</h3><p>åœ¨æ•°æ®åº“ä¸­æ–°å»ºè¡¨ï¼Œå­˜å‚¨tokenï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> persistent_logins (</span><br><span class="line">    username <span class="built_in">VARCHAR</span> (<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    series <span class="built_in">VARCHAR</span> (<span class="number">64</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    token <span class="built_in">VARCHAR</span> (<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    last_used <span class="built_in">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="4-3-åç«¯é€»è¾‘"><a href="#4-3-åç«¯é€»è¾‘" class="headerlink" title="4.3 åç«¯é€»è¾‘"></a>4.3 åç«¯é€»è¾‘</h3><p>åœ¨é…ç½®ç±»ä¸­é…ç½®tokenæŒä¹…åŒ–å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Qualifier(&quot;customUserDetailService&quot;)</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PersistentTokenRepository <span class="title">persistentTokenRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JdbcTokenRepositoryImpl jdbcTokenRepository = <span class="keyword">new</span> JdbcTokenRepositoryImpl();</span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        jdbcTokenRepository.setCreateTableOnStartup(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> jdbcTokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ååœ¨Spring Securityçš„è®¤è¯æµç¨‹ä¸­å¯ç”¨è®°ä½æˆ‘çš„åŠŸèƒ½ï¼Œå³åœ¨é…ç½®ç±»çš„<code>configure</code>æ–¹æ³•ä¸­å¼€å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    httpSecurity</span><br><span class="line">        ...</span><br><span class="line">        .and()</span><br><span class="line">        <span class="comment">// è®°ä½æˆ‘è®¾ç½®</span></span><br><span class="line">        .rememberMe()</span><br><span class="line">        .tokenValiditySeconds(<span class="number">3600</span>)                    <span class="comment">// è¿‡æœŸæ—¶é—´ï¼Œå•ä½ç§’</span></span><br><span class="line">        .tokenRepository(persistentTokenRepository())  <span class="comment">// tokenæŒä¹…åŒ–ä»“åº“</span></span><br><span class="line">        .userDetailsService(userDetailsService)        <span class="comment">// å¤„ç†è‡ªåŠ¨ç™»å½•é€»è¾‘</span></span><br><span class="line">        ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-é‡æ–°æµ‹è¯•"><a href="#4-4-é‡æ–°æµ‹è¯•" class="headerlink" title="4.4 é‡æ–°æµ‹è¯•"></a>4.4 é‡æ–°æµ‹è¯•</h3><p>é‡å¯é¡¹ç›®ï¼Œç™»å½•é¡µé¢å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601202452243.png" class="" title="image-20210601202452243">

<p>æ¯”è¾ƒéš¾çœ‹ï¼Œæ— ä¼¤å¤§é›…ã€‚å‹¾é€‰å¹¶ç™»å½•ï¼Œå¯ä»¥çœ‹åˆ°ç½‘é¡µå¤šäº†remember-meçš„cookieï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601202753546.png" class="" title="image-20210601202753546">

<p>æŸ¥çœ‹æ•°æ®åº“è¡¨<code>peristent_logins</code>ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601202821584.png" class="" title="image-20210601202821584">

<p>å¯ä»¥çœ‹åˆ°tokenä¿¡æ¯å·²ç»æˆåŠŸæŒä¹…åŒ–äº†ã€‚åœ¨cookieå¤±æ•ˆä¹‹å‰ï¼Œæ— è®ºæ˜¯é‡å¼€æµè§ˆå™¨è¿˜æ˜¯é‡å¯é¡¹ç›®ï¼Œç”¨æˆ·éƒ½æ— éœ€å†æ¬¡ç™»å½•å°±å¯ä»¥è®¿é—®ã€‚</p>
<h2 id="5-Spring-Security-Authorization"><a href="#5-Spring-Security-Authorization" class="headerlink" title="5. Spring Security Authorization"></a>5. Spring Security Authorization</h2><p>ğŸ’ è¯´æ˜</p>
<p>è¿™ä¸€èŠ‚çš„codeä¾ç„¶æ‰¿æ¥ä¸Šä¸€èŠ‚ã€‚</p>
<h3 id="5-1-å®‰å…¨æ³¨è§£"><a href="#5-1-å®‰å…¨æ³¨è§£" class="headerlink" title="5.1 å®‰å…¨æ³¨è§£"></a>5.1 å®‰å…¨æ³¨è§£</h3><p>é…åˆæˆæƒæ³¨è§£ä½¿ç”¨ï¼ŒSpring Securityæä¾›äº†ä¸‰ç§ä¸åŒçš„å®‰å…¨æ³¨è§£ï¼š</p>
<ol>
<li>Spring Securityè‡ªå¸¦çš„<code>@Secured</code></li>
<li>JSR-250çš„<code>@RolesAllowed</code></li>
<li>è¡¨è¾¾å¼é©±åŠ¨æ³¨è§£ï¼š<code>@PreAuthrize</code>ã€<code>@PostAuthorize</code>ã€<code>@PreFilter</code>å’Œ<code>@PostFilter</code>ã€‚</li>
</ol>
<h3 id="5-2-ç›¸å…³é…ç½®"><a href="#5-2-ç›¸å…³é…ç½®" class="headerlink" title="5.2 ç›¸å…³é…ç½®"></a>5.2 ç›¸å…³é…ç½®</h3><p>è¦å¼€å¯è¿™äº›æ³¨è§£ï¼Œåªéœ€è¦åœ¨Spring Securityé…ç½®ç±»ä¸­æ·»åŠ å¦‚ä¸‹æ³¨è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrowserSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡ªå®šä¹‰ä¸€ä¸ªå¤„ç†å™¨ï¼Œå¤„ç†æƒé™ä¸è¶³çš„æƒ…å†µï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticationAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title">AccessDeniedHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;å¾ˆæŠ±æ­‰ï¼Œæ‚¨æ²¡æœ‰è®¿é—®æƒé™ã€‚&quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¹¶å°†è¿™ä¸ªå¤„ç†å™¨æ·»åŠ åˆ°é…ç½®é“¾ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MyAuthenticationAccessDeniedHandler authenticationAccessDeniedHandler;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    httpSecurity</span><br><span class="line">        ...</span><br><span class="line">        .and()</span><br><span class="line">        <span class="comment">// æƒé™é…ç½®</span></span><br><span class="line">        .exceptionHandling()</span><br><span class="line">        .accessDeniedHandler(authenticationAccessDeniedHandler) <span class="comment">// æƒé™ä¸è¶³å¤„ç†</span></span><br><span class="line">        ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-3-æƒé™æµ‹è¯•"><a href="#5-3-æƒé™æµ‹è¯•" class="headerlink" title="5.3 æƒé™æµ‹è¯•"></a>5.3 æƒé™æµ‹è¯•</h3><p>ç¼–å†™ä¸¤ä¸ªæ¥å£ï¼Œä¸€ä¸ªæ¥å£åªå…è®¸adminå’Œmanagerè®¿é—®ï¼Œå¦ä¸€ä¸ªæ¥å£åªå…è®¸normalè®¿é—®ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/auth/manage&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAnyAuthority(&#x27;admin&#x27;, &#x27;manager&#x27;)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">manage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æ‚¨æ˜¯Adminæˆ–è€…managerï¼Œå¯ä»¥è®¿é—®&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/auth/normal&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;normal&#x27;)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">normal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æ‚¨æ˜¯æ™®é€šè§’è‰²ï¼Œå¯ä»¥è®¿é—®&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®<a href="http://localhost:8080/authentication">http://localhost:8080/authentication</a></p>
<p>ç™»å½•adminè´¦å·ï¼ˆKhighnessï¼ŒKAG1823ï¼‰</p>
<p>æµ‹è¯•è®¿é—®ï¼š<a href="http://localhost:8080/auth/manage">http://localhost:8080/auth/manage</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601210419188.png" class="" title="image-20210601210419188">

<p>æµ‹è¯•è®¿é—®ï¼š<a href="http://localhost:8080/auth/normal">http://localhost:8080/auth/normal</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601210448946.png" class="" title="image-20210601210448946">



<h2 id="6-Spring-Security-OAuth2-Guide"><a href="#6-Spring-Security-OAuth2-Guide" class="headerlink" title="6. Spring Security OAuth2 Guide"></a>6. Spring Security OAuth2 Guide</h2><p>ğŸŒå‚è€ƒ</p>
<ul>
<li><p><a href="http://www.rfcreader.com/#rfc6749">rfc6749</a></p>
</li>
<li><p><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">é˜®ä¸€å³°</a></p>
</li>
</ul>
<p>ğŸ“–æ¦‚è¿° </p>
<p>OAuthæ˜¯ä¸€ç§ç”¨æ¥è§„èŒƒä»¤ç‰Œï¼ˆTokenï¼‰å‘æ”¾çš„æˆæƒæœºåˆ¶ï¼Œä¸»è¦åŒ…å«äº†å››ç§æˆæƒæ¨¡å¼ï¼š</p>
<ul>
<li><p>æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰</p>
</li>
<li><p>ç®€åŒ–æ¨¡å¼ï¼ˆimplicitï¼‰</p>
</li>
<li><p>å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰</p>
</li>
<li><p>å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰</p>
</li>
</ul>
<p>Spring Security OAuth2å¯¹è¿™å››ç§æˆæƒæ¨¡å¼è¿›è¡Œäº†å®ç°ã€‚</p>
<h3 id="6-1-åè¯å­¦ä¹ "><a href="#6-1-åè¯å­¦ä¹ " class="headerlink" title="6.1 åè¯å­¦ä¹ "></a>6.1 åè¯å­¦ä¹ </h3><p>åœ¨äº†è§£è¿™å››ç§æˆæƒæ¨¡å¼ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå­¦ä¹ ä¸€äº›å’ŒOAuthç›¸å…³çš„åè¯ã€‚</p>
<p>ä¸¾ä¸ªç¤¾äº¤ç™»å½•çš„ä¾‹å­ï¼Œæ¯”å¦‚æˆ‘åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨QQè´¦å·ç™»å½•è™ç‰™ç›´æ’­ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥æå–å‡ºä»¥ä¸‹å‡ ä¸ªåè¯ï¼š</p>
<ol>
<li><code>Third-party application</code> ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åº =&gt; è™ç‰™ç›´æ’­</li>
<li><code>HTTP service</code> HTTPæœåŠ¡æä¾›å•† =&gt; QQ</li>
<li><code>Resource Owner</code> èµ„æºæ‰€æœ‰è€… =&gt; ç”¨æˆ·ï¼Œæˆ‘</li>
<li><code>User Agent</code> ç”¨æˆ·ä»£ç† =&gt; æµè§ˆå™¨</li>
<li><code>Authorization server</code> è®¤è¯æœåŠ¡å™¨ =&gt; QQæä¾›çš„ç¬¬ä¸‰æ–¹ç™»å½•æœåŠ¡</li>
<li><code>Resource server</code> èµ„æºæœåŠ¡å™¨ =&gt; è™ç‰™ç›´æ’­æä¾›çš„æœåŠ¡ï¼Œé«˜æ¸…ç›´æ’­ã€å¼¹å¹•å‘é€</li>
</ol>
<p>è®¤è¯æœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨å¯ä»¥åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Œæ¯”å¦‚å‰åç«¯åˆ†ç¦»çš„æœåŠ¡åå°ï¼Œå®ƒæä¾›è®¤è¯æœåŠ¡ï¼ˆæä¾›ä»¤ç‰Œï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡ä»¤ç‰Œæ¥ä»èµ„æºæœåŠ¡å™¨è·å–æœåŠ¡ï¼›å®ƒä»¬ä¹Ÿå¯ä»¥ä¸åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œæ¯”å¦‚ç¬¬ä¸‰æ–¹ç™»å½•çš„æ¡ˆä¾‹ã€‚</p>
<h3 id="6-2-è¿è¡Œæµç¨‹"><a href="#6-2-è¿è¡Œæµç¨‹" class="headerlink" title="6.2 è¿è¡Œæµç¨‹"></a>6.2 è¿è¡Œæµç¨‹</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601220314015.png" class="" title="image-20210601220314015">

<p>ï¼ˆAï¼‰ç”¨æˆ·æ‰“å¼€å®¢æˆ·ç«¯ä»¥åï¼Œå®¢æˆ·ç«¯è¦æ±‚ç”¨æˆ·ç»™äºˆæˆæƒ</p>
<p>ï¼ˆBï¼‰ç”¨æˆ·åŒæ„ç»™äºˆå®¢æˆ·ç«¯æˆæƒ</p>
<p>ï¼ˆCï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä¸Šä¸€æ­¥è·å¾—çš„æˆæƒï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œ</p>
<p>ï¼ˆDï¼‰è®¤è¯æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯åï¼Œç¡®è®¤æ— è¯¯ï¼Œç»Ÿä¸€å‘æ”¾ä»¤ç‰Œ</p>
<p>ï¼ˆEï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä»¤ç‰Œï¼Œå‘èµ„æºæœåŠ¡å™¨ç”³è¯·è·å–èµ„æº</p>
<p>ï¼ˆFï¼‰èµ„æºæœåŠ¡å™¨ç¡®è®¤ä»¤ç‰Œæ— è¯¯ï¼ŒåŒæ„å‘å®¢æˆ·ç«¯å¼€æ”¾èµ„æº</p>
<h3 id="6-3-å››ç§æ¨¡å¼"><a href="#6-3-å››ç§æ¨¡å¼" class="headerlink" title="6.3 å››ç§æ¨¡å¼"></a>6.3 å››ç§æ¨¡å¼</h3><p>ï¼ˆ1ï¼‰<strong>æˆæƒç æ¨¡å¼</strong></p>
<p>æˆæƒç æ¨¡å¼æ˜¯åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†çš„æˆæƒæ¨¡å¼ã€‚</p>
<p>å®ƒçš„ç‰¹ç‚¹æ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„åå°æœåŠ¡å™¨ï¼Œä¸æœåŠ¡æä¾›å•†çš„è®¤è¯æœåŠ¡å™¨è¿›è¡Œäº’åŠ¨ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601220838542.png" class="" title="image-20210601220838542">

<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆAï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨</p>
<p>ï¼ˆBï¼‰ç”¨æˆ·å†³å®šæ˜¯å¦ç»™å®¢æˆ·ç«¯æˆæƒ</p>
<p>ï¼ˆCï¼‰åŒæ„æˆæƒåï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æä¾›çš„URLï¼Œå¹¶é™„ä¸Šæˆæƒç </p>
<p>ï¼ˆDï¼‰å®¢æˆ·ç«¯é€šè¿‡é‡å®šå‘URLå’Œæˆæƒç åˆ°è®¤è¯æœåŠ¡å™¨æ¢å–ä»¤ç‰Œ</p>
<p>ï¼ˆEï¼‰æ ¡éªŒæ— è¯¯åå‘æ”¾ä»¤ç‰Œ</p>
<p>åœ¨Aæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯ç”³è¯·è®¤è¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><code>response_type</code>ï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º<code>code</code>ï¼Œæ ‡è¯†æˆæƒç æ¨¡å¼</li>
<li><code>client_id</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯IDï¼Œå¿…é€‰é¡¹</li>
<li><code>redirect_uri</code>ï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¯é€‰é¡¹</li>
<li><code>scope</code>ï¼šè¡¨ç¤ºç”³è¯·çš„æƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹</li>
<li><code>state</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼</li>
</ol>
<p>åœ¨Cæ­¥éª¤ä¸­ï¼ŒæœåŠ¡å™¨å›åº”å®¢æˆ·ç«¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>code</code>ï¼šè¡¨ç¤ºæˆæƒç ï¼Œå¿…é€‰é¡¹ã€‚è¯¥ç çš„æœ‰æ•ˆæœŸåº”è¯¥å¾ˆçŸ­ï¼Œé€šå¸¸è®¾ä¸º10åˆ†é’Ÿï¼Œå®¢æˆ·ç«¯åªèƒ½ä½¿ç”¨è¯¥ç ä¸€æ¬¡ï¼Œå¦åˆ™ä¼šè¢«æˆæƒæœåŠ¡å™¨æ‹’ç»ã€‚è¯¥ç ä¸å®¢æˆ·ç«¯IDå’Œé‡å®šå‘URIï¼Œæ˜¯ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚</p>
</li>
<li><p><code>state</code>ï¼šå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªå‚æ•°ï¼Œè®¤è¯æœåŠ¡å™¨çš„å›åº”ä¹Ÿå¿…é¡»ä¸€æ¨¡ä¸€æ ·åŒ…å«è¿™ä¸ªå‚æ•°ã€‚</p>
</li>
</ol>
<p>åœ¨Dæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><code>grant_type</code>ï¼šè¡¨ç¤ºä½¿ç”¨çš„æˆæƒæ¨¡å¼ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º<code>authorization_code</code></li>
<li><code>code</code>ï¼šè¡¨ç¤ºä¸Šä¸€æ­¥è·å¾—çš„æˆæƒç ï¼Œå¿…é€‰é¡¹</li>
<li><code>redirect_uri</code>ï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¿…é€‰é¡¹ï¼Œä¸”å¿…é¡»ä¸Aæ­¥éª¤ä¸­çš„è¯¥å‚æ•°å€¼ä¿æŒä¸€è‡´</li>
<li><code>client_id</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯IDï¼Œå¿…é€‰é¡¹</li>
</ol>
<p>åœ¨Eæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å‘é€çš„HTTPå›å¤ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>access_token</code>ï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚</p>
</li>
<li><p><code>token_type</code>ï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹ï¼Œå¯ä»¥æ˜¯bearerç±»å‹æˆ–macç±»å‹ã€‚</p>
</li>
<li><p><code>expires_in</code>ï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</p>
</li>
<li><p><code>refresh_token</code>ï¼šè¡¨ç¤ºæ›´æ–°ä»¤ç‰Œï¼Œç”¨æ¥è·å–ä¸‹ä¸€æ¬¡çš„è®¿é—®ä»¤ç‰Œï¼Œå¯é€‰é¡¹ã€‚</p>
</li>
<li><p><code>scope</code>ï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚</p>
</li>
</ol>
<p>ï¼ˆ2ï¼‰<strong>ç®€åŒ–æ¨¡å¼</strong></p>
<p>ç®€åŒ–æ¨¡å¼ä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè·³è¿‡äº†â€œæˆæƒç â€è¿™ä¸ªæ­¥éª¤ã€‚</p>
<p>å®ƒçš„ç‰¹ç‚¹æ˜¯æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯å¯è§çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è®¤è¯ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601221616906.png" class="" title="image-20210601221616906">

<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆAï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚</p>
<p>ï¼ˆBï¼‰ç”¨æˆ·å†³å®šæ˜¯å¦ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚</p>
<p>ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„â€é‡å®šå‘URIâ€ï¼Œå¹¶åœ¨URIçš„Hashéƒ¨åˆ†åŒ…å«äº†è®¿é—®ä»¤ç‰Œã€‚</p>
<p>ï¼ˆDï¼‰æµè§ˆå™¨å‘èµ„æºæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ä¸Šä¸€æ­¥æ”¶åˆ°çš„Hashå€¼ã€‚</p>
<p>ï¼ˆEï¼‰èµ„æºæœåŠ¡å™¨è¿”å›ä¸€ä¸ªç½‘é¡µï¼Œå…¶ä¸­åŒ…å«çš„ä»£ç å¯ä»¥è·å–Hashå€¼ä¸­çš„ä»¤ç‰Œã€‚</p>
<p>ï¼ˆFï¼‰æµè§ˆå™¨æ‰§è¡Œä¸Šä¸€æ­¥è·å¾—çš„è„šæœ¬ï¼Œæå–å‡ºä»¤ç‰Œã€‚</p>
<p>ï¼ˆGï¼‰æµè§ˆå™¨å°†ä»¤ç‰Œå‘ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>åœ¨Aæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>response_type</code>ï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º<code>token</code>ï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>client_id</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„IDï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>redirect_uri</code>ï¼šè¡¨ç¤ºé‡å®šå‘çš„URIï¼Œå¯é€‰é¡¹</p>
</li>
<li><p><code>scope</code>ï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹</p>
</li>
<li><p><code>state</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼</p>
</li>
</ol>
<p>åœ¨Cæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å›åº”å®¢æˆ·ç«¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>access_token</code>ï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>token_type</code>ï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>expires_in</code>ï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´</p>
</li>
<li><p><code>scope</code>ï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥</p>
</li>
<li><p><code>state</code>ï¼šå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªå‚æ•°ï¼Œè®¤è¯æœåŠ¡å™¨çš„å›åº”ä¹Ÿå¿…é¡»ä¸€æ¨¡ä¸€æ ·åŒ…å«è¿™ä¸ªå‚æ•°</p>
</li>
</ol>
<p>ï¼ˆ3ï¼‰<strong>å¯†ç æ¨¡å¼</strong></p>
<p>å¯†ç æ¨¡å¼ä¸­ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œå‘è®¤è¯æœåŠ¡å™¨ç´¢è¦æˆæƒã€‚</p>
<p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å­˜å‚¨å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç”±ä¸€ä¸ªè‘—åå…¬å¸å‡ºå“ã€‚è€Œè®¤è¯æœåŠ¡å™¨åªæœ‰åœ¨å…¶ä»–æˆæƒæ¨¡å¼æ— æ³•æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601221808782.png" class="" title="image-20210601221808782">

<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆAï¼‰ç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›ç”¨æˆ·åå’Œå¯†ç </p>
<p>ï¼ˆBï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·åå’Œå¯†ç å‘ç»™è®¤è¯æœåŠ¡å™¨ï¼Œå‘åè€…è¯·æ±‚ä»¤ç‰Œ</p>
<p>ï¼ˆCï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œ</p>
<p>åœ¨Bæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>grant_type</code>ï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸ºâ€passwordâ€ï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>username</code>ï¼šè¡¨ç¤ºç”¨æˆ·åï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>password</code>ï¼šè¡¨ç¤ºç”¨æˆ·çš„å¯†ç ï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>scope</code>ï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹</p>
</li>
</ol>
<p>ï¼ˆ4ï¼‰<strong>å®¢æˆ·ç«¯æ¨¡å¼</strong></p>
<p>å®¢æˆ·ç«¯æ¨¡å¼æŒ‡å®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰ï¼Œè€Œä¸æ˜¯ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œå‘æœåŠ¡æä¾›å•†è¿›è¡Œè®¤è¯ã€‚</p>
<p>ä¸¥æ ¼åœ°è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸å±äºOAuthæ¡†æ¶æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·ç›´æ¥å‘å®¢æˆ·ç«¯æ³¨å†Œï¼Œå®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰è¦æ±‚â€æœåŠ¡æä¾›å•†â€æä¾›æœåŠ¡ï¼Œå…¶å®ä¸å­˜åœ¨æˆæƒé—®é¢˜ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601222435410.png" class="" title="image-20210601222435410">

<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆAï¼‰å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œ</p>
<p>ï¼ˆBï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œ</p>
<p>åœ¨Aæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>grant_type</code>ï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º<code>clientcredentials</code>ï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>scope</code>ï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹</p>
</li>
</ol>
<h3 id="6-4-Spring-Security-OAuth2"><a href="#6-4-Spring-Security-OAuth2" class="headerlink" title="6.4 Spring Security OAuth2"></a>6.4 Spring Security OAuth2</h3><p>Springæ¡†æ¶å¯¹OAuth2åè®®è¿›è¡Œäº†å®ç°ï¼Œä¸‹é¢å­¦ä¹ æˆæƒç æ¨¡å¼å’Œå¯†ç æ¨¡å¼åœ¨Spring Security OAuth2ç›¸å…³æ¡†æ¶çš„ä½¿ç”¨ã€‚</p>
<p>Spring Security OAuth2ä¸»è¦åŒ…å«è®¤è¯æœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨è¿™ä¸¤å¤§å—çš„å®ç°ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210601231533673.png" class="" title="image-20210601231533673">

<p>è®¤è¯æœåŠ¡å™¨ä¸»è¦åŒ…å«äº†å››ç§æˆæƒæ¨¡å¼çš„å®ç°å’ŒTokençš„ç”Ÿæˆä¸å­˜å‚¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è®¤è¯æœåŠ¡å™¨ä¸­è‡ªå®šä¹‰è·å–Tokençš„æ–¹å¼ï¼›èµ„æºæœåŠ¡å™¨ä¸»è¦æ˜¯åœ¨Spring Securityçš„è¿‡æ»¤é“¾ä¸ŠåŠ äº†OAuth2AuthenticationProcessFilterè¿‡æ»¤å™¨ï¼Œå³ä½¿ç”¨OAuth2åè®®å‘æ”¾ä»¤ç‰Œè®¤è¯çš„æ–¹å¼æ¥ä¿è¯æˆ‘ä»¬çš„èµ„æºã€‚</p>
<p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å…ˆå®šä¹‰ä¸€ä¸ª<code>MyUser</code>å¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUser</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3088964382959687717L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> accountNonExpired = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> accountNonLocked= <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> credentialsNonExpired= <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> enabled= <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€å®šä¹‰<code>CustomUserDetailService</code>å®ç°<code>UserDetailService</code>æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserDetailService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        MyUser user = <span class="keyword">new</span> MyUser();</span><br><span class="line">        user.setUserName(username);</span><br><span class="line">        user.setPassword(<span class="keyword">this</span>.passwordEncoder.encode(<span class="string">&quot;KAG1823&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username, user.getPassword(), user.isEnabled(),</span><br><span class="line">                user.isAccountNonExpired(), user.isCredentialsNonExpired(),</span><br><span class="line">                user.isAccountNonLocked(), AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„é€»è¾‘æ˜¯ç™»å½•è´¦å·çš„ç”¨æˆ·åæ— æ‰€è°“ï¼Œå¯†ç å¿…é¡»æ˜¯<code>KAG1823</code>ï¼Œå¹¶ä¸”æ‹¥æœ‰adminæƒé™ã€‚</p>
<p>æ¥ä¸‹æ¥åˆ›å»ºè®¤è¯æœåŠ¡å™¨ï¼Œå¹¶ä¸”åœ¨é‡Œé¢å®šä¹‰<code>UserDetailService</code>éœ€è¦ç”¨åˆ°çš„<code>PasswordEncoder</code>ã€‚</p>
<p>åˆ›å»ºè®¤è¯æœåŠ¡å™¨ï¼Œåªéœ€è¦åœ¨Spring Securityçš„é…ç½®ç±»ä¸Šä½¿ç”¨<code>@EnableAuthorizationServer</code>æ³¨è§£æ ‡æ³¨å³å¯ã€‚</p>
<p>åˆ›å»º<code>AuthorizationServerConfig</code>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨é¡¹ç›®ï¼Œä¼šå‘ç°æ§åˆ¶å°æ‰“å°äº†éšæœºåˆ†é…çš„<code>client-id</code>å’Œ<code>client-secret</code>ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">security.oauth2.client.client<span class="literal">-id</span> = <span class="number">0</span>b560e22<span class="literal">-4148</span><span class="literal">-4bed</span><span class="literal">-8c0d</span><span class="literal">-e0f94813692b</span></span><br><span class="line">security.oauth2.client.client<span class="literal">-secret</span> = <span class="number">468</span>daba6<span class="literal">-e1e5</span><span class="literal">-4c94</span><span class="literal">-8a19</span><span class="literal">-f092a81d7af5</span></span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æŒ‡å®šè¿™ä¸¤ä¸ªå€¼ã€‚</p>
<p>åœ¨é…ç½®æ–‡ä»¶<code>application.yml</code>ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">oauth2:</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="string">k</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">parak</span></span><br></pre></td></tr></table></figure>

<p>é‡å¯é¡¹ç›®ï¼Œå‘ç°æ§åˆ¶å°è¾“å‡ºï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">security.oauth2.client.client<span class="literal">-id</span> = k</span><br><span class="line">security.oauth2.client.client<span class="literal">-secret</span> = ****</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜æ›¿æ¢æˆåŠŸã€‚</p>
<p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®ï¼š<a href="http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=k&amp;redirect_uri=http://parak.top&amp;scope=all&amp;state=hello">http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=k&amp;redirect_uri=http://parak.top&amp;scope=all&amp;state=hello</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602134107689.png" class="" title="image-20210602134107689">

<p>è¾“å…¥éšæ„ç”¨æˆ·åï¼Œå¯†ç KAG1823ï¼Œç™»å½•è®¤è¯åï¼Œé¡µé¢å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602134454758.png" class="" title="image-20210602134454758">

<p>åŸå› æ˜¯ä¸Šé¢æŒ‡å®šçš„redirect_uriå¿…é¡»åŒæ—¶åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼Œæˆ‘ä»¬å¾€application.ymlæ·»åŠ é…ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">security:</span><br><span class="line">  oauth2:</span><br><span class="line">    client:</span><br><span class="line">      client-id: k</span><br><span class="line">      client-secret: parak</span><br><span class="line">      registered-redirect-uri: http:<span class="comment">//parak.top</span></span><br></pre></td></tr></table></figure>

<p>é‡å¯é¡¹ç›®ï¼Œé‡æ–°æ‰§è¡Œä»¥ä¸Šæ­¥éª¤ï¼Œç™»å½•æˆåŠŸåè·³è½¬åˆ°æˆæƒé¡µé¢ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602134705789.png" class="" title="image-20210602134705789">

<p>é€‰æ‹©åŒæ„Approveï¼Œç„¶åç‚¹å‡»AuthorizeæˆæƒæŒ‰é’®ï¼Œé¡µé¢è·³è½¬åˆ°äº†æˆ‘ä»¬æŒ‡å®šçš„redirect_uriï¼Œå¹¶ä¸”å¸¦ä¸Šäº†æˆæƒç ä¿¡æ¯ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602134926178.png" class="" title="image-20210602134926178">

<p>å¯ä»¥çœ‹åˆ°æˆæƒç ä¸ºï¼šFtlxyfï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªæˆæƒç ä»è®¤è¯æœåŠ¡å™¨è·å–ä»¤ç‰ŒTokenäº†ã€‚</p>
<p>ä½¿ç”¨postmanå‘é€è¯·æ±‚ï¼š<a href="http://localhost:8080/oauth/token">http://localhost:8080/oauth/token</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602135802880.png" class="" title="image-20210602135802880">

<p>å…¶ä¸­äº”ä¸ªå‚æ•°å³ä¸ºç”³è¯·ä»¤ç‰Œçš„å‚æ•°ï¼Œ<code>grant_type</code>ä¸ºæˆæƒç±»å‹ï¼Œæ­¤å¤„å›ºå®šä¸º<code>authorization_code</code>ï¼Œ<code>code</code>ä¸ºä¸Šä¸€æ­¥è·å¾—çš„æˆæƒç ï¼Œ<code>client_id</code>ä¸ºå®¢æˆ·ç«¯idï¼Œ<code>redirect_uri</code>ä¸ºé‡å®šå‘URIï¼Œ<code>scope</code>ä¸ºç”³è¯·æƒé™èŒƒå›´ã€‚</p>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­å¡«å†™å¦‚ä¸‹å†…å®¹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602135843099.png" class="" title="image-20210602135843099">

<p>å…¶ä¸­ï¼Œkeyä¸º<code>Authorization</code>ï¼Œvalueä¸º<code>Basic Base64(client_id:client-secret)</code></p>
<p>Base64å·¥å…·ï¼š<a href="http://tool.chinaz.com/Tools/Base64.aspx">http://tool.chinaz.com/Tools/Base64.aspx</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602135958115.png" class="" title="image-20210602135958115">

<p>å‚æ•°å¡«å†™æ— è¯¯åï¼Œå‘é€è¯·æ±‚è¾¹è·å–åˆ°ä»¤ç‰Œï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span>: <span class="string">&quot;ef19f338-651b-43ae-9cea-66ec6e208d0c&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;token_type&quot;</span>: <span class="string">&quot;bearer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;refresh_token&quot;</span>: <span class="string">&quot;6761af90-c79e-4023-b23a-3a9c4210e1d4&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;expires_in&quot;</span>: <span class="number">43199</span>,</span><br><span class="line">    <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;all&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªæˆæƒç åªèƒ½è·å–ä¸€æ¬¡ä»¤ç‰Œï¼Œå¦‚æœå†æ¬¡è·å–ï¼Œå°†è¿”å›ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;error&quot;</span>: <span class="string">&quot;invalid_grant&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;error_description&quot;</span>: <span class="string">&quot;Invalid authorization code: Ftlxyf&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆè¦é…ç½®èµ„æºæœåŠ¡å™¨å‘¢ï¼Ÿå…ˆæµ‹è¯•ä¸€ä¸‹åœ¨æ²¡æœ‰å®šä¹‰èµ„æºæœåŠ¡å™¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨Tokenå»è·å–èµ„æºä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
<p>å®šä¹‰ä¸€ä¸ªRestæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">index</span><span class="params">(Authentication authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> authentication;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨å¯†ç æ¨¡å¼è·å–ä»¤ç‰Œï¼Œå‚æ•°åœ¨ä¸Šè¿°å››å¤§æ¨¡å¼ä¸­å·²ç»æåˆ°ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602143039788.png" class="" title="image-20210602143039788">

<p>ç„¶åä½¿ç”¨è¯¥ä»¤ç‰Œè®¿é—®<code>/index</code>ï¼Œvalueä¸º<code>token_type access_token</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602143155492.png" class="" title="image-20210602143155492">

<p>è™½ç„¶ä»¤ç‰Œæ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å¹¶æ— æ³•è®¿é—®<code>/index</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»é…ç½®èµ„æºæœåŠ¡å™¨ï¼Œè®©å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡åˆæ³•çš„ä»¤ç‰Œæ¥è·å–èµ„æºã€‚</p>
<p>èµ„æºæœåŠ¡å™¨çš„é…ç½®ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨é…ç½®ç±»ä¸Šä½¿ç”¨<code>@EnableResourceServer</code>æ³¨è§£å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡å¯æœåŠ¡ï¼Œé‡å¤ä¸Šé¢æ­¥éª¤ï¼Œå†æ¬¡è®¿é—®<code>/index</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;authorities&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;authority&quot;</span>: <span class="string">&quot;admin&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;details&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;remoteAddress&quot;</span>: <span class="string">&quot;0:0:0:0:0:0:0:1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;sessionId&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;tokenValue&quot;</span>: <span class="string">&quot;5a5b41c7-80d1-4496-9b6b-a8151db23160&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tokenType&quot;</span>: <span class="string">&quot;bearer&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;decodedDetails&quot;</span>: <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;authenticated&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;userAuthentication&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;authorities&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;authority&quot;</span>: <span class="string">&quot;admin&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;details&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;grant_type&quot;</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;Khighness&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;all&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;authenticated&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;principal&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;password&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;Khighness&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;authorities&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;authority&quot;</span>: <span class="string">&quot;admin&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;accountNonExpired&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;accountNonLocked&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;credentialsNonExpired&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">&quot;enabled&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;credentials&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Khighness&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;oauth2Request&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;clientId&quot;</span>: <span class="string">&quot;k&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;scope&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;all&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;requestParameters&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;grant_type&quot;</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;Khighness&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;all&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;resourceIds&quot;</span>: [],</span><br><span class="line">        <span class="attr">&quot;authorities&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;authority&quot;</span>: <span class="string">&quot;ROLE_USER&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;approved&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;refresh&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;redirectUri&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;responseTypes&quot;</span>: [],</span><br><span class="line">        <span class="attr">&quot;extensions&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="attr">&quot;grantType&quot;</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;refreshTokenRequest&quot;</span>: <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;clientOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;credentials&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;principal&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;password&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;Khighness&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;authorities&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;authority&quot;</span>: <span class="string">&quot;admin&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;accountNonExpired&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;accountNonLocked&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;credentialsNonExpired&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Khighness&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨åŒæ—¶å®šä¹‰äº†è®¤è¯æœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨åï¼Œå†å»ä½¿ç”¨æˆæƒç æ¨¡å¼è·å–ä»¤ç‰Œå¯èƒ½ä¼šé‡åˆ°<code>Full authentication is required to access this resource </code>çš„é—®é¢˜ï¼Œè¿™æ—¶å€™åªè¦ç¡®ä¿è®¤è¯æœåŠ¡å™¨å…ˆäºèµ„æºæœåŠ¡å™¨é…ç½®å³å¯ï¼Œæ¯”å¦‚åœ¨è®¤è¯æœåŠ¡å™¨çš„é…èµ„ç±»ä¸Šä½¿ç”¨<code>@Order(1)</code>æ ‡æ³¨ï¼Œåœ¨èµ„æºæœåŠ¡å™¨çš„é…ç½®ç±»ä¸Šä½¿ç”¨<code>@Order(2)</code>æ ‡æ³¨ã€‚</p>
</blockquote>
<h2 id="7-Spring-Security-OAuth2-Custom"><a href="#7-Spring-Security-OAuth2-Custom" class="headerlink" title="7. Spring Security OAuth2 Custom"></a>7. Spring Security OAuth2 Custom</h2><p>ğŸ“–æ¦‚è¿°</p>
<p>è¿™ä¸€èŠ‚ä¸»è¦å®ç°é€šè¿‡è‡ªå®šä¹‰çš„ç”¨æˆ·åå¯†ç å’Œé‚®ç®±çŸ­ä¿¡éªŒè¯ç çš„æ–¹å¼æ¥è·å–ä»¤ç‰Œã€‚</p>
<h3 id="7-1-ç”¨æˆ·åå¯†ç "><a href="#7-1-ç”¨æˆ·åå¯†ç " class="headerlink" title="7.1 ç”¨æˆ·åå¯†ç "></a>7.1 ç”¨æˆ·åå¯†ç </h3><p>ç»§æ‰¿ä¸Šä¸€èŠ‚çš„é¡¹ç›®ï¼Œèµ„æºæœåŠ¡å™¨ä¸ŠåŠ å…¥ä¸€äº›åŸºæœ¬é…ç½®ï¼Œå°†è¡¨å•ç™»å½•çš„URLè®¾ç½®ä¸º<code>/login</code>ï¼ŒåŒæ—¶åŠ å…¥å¤„ç†ç™»å½•æˆåŠŸå’Œå¤±è´¥çš„é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSuccessHandler authenticationSuccessHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler authenticationFailureHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.formLogin()                  <span class="comment">// è¡¨å•ç™»å½•</span></span><br><span class="line">            .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// å¤„ç†è¡¨å•ç™»å½•URL</span></span><br><span class="line">            .successHandler(authenticationSuccessHandler) <span class="comment">// å¤„ç†ç™»å½•æˆåŠŸ</span></span><br><span class="line">            .failureHandler(authenticationFailureHandler) <span class="comment">// å¤„ç†ç™»å½•å¤±è´¥</span></span><br><span class="line">        .and()</span><br><span class="line">            .authorizeRequests() <span class="comment">// æˆæƒé…ç½®</span></span><br><span class="line">            .anyRequest()        <span class="comment">// æ‰€æœ‰è¯·æ±‚</span></span><br><span class="line">            .authenticated()     <span class="comment">// éƒ½éœ€è®¤è¯</span></span><br><span class="line">        .and()</span><br><span class="line">            .csrf().disable()    <span class="comment">// ç¦ç”¨CSRFä¿æŠ¤</span></span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤„ç†ç™»å½•å¤±è´¥çš„é€»è¾‘å¾ˆç®€å•ï¼Œç›´æ¥è¿”å›é”™è¯¯æç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticationFailureHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationFailureHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        response.getWriter().write(objectMapper.writeValueAsString(e.getMessage()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤„ç†ç™»å½•æˆåŠŸçš„é€»è¾‘æ˜¯å…³é”®ï¼ŒSpring Security OAuth2çš„ä»¤ç‰Œäº§ç”Ÿæµç¨‹å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602163830912.png" class="" title="image-20210602163830912">

<p>å‚è€ƒè¿™ä¸ªæµç¨‹ï¼Œæ¥å®ç°åœ¨ç™»å½•æˆåŠŸå¤„ç†å™¨<code>MyAuthenticationSuccessHandler</code>é‡Œç”Ÿæˆä»¤ç‰Œå¹¶è¿”å›ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticationSuccessHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ClientDetailsService clientDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Qualifier(&quot;defaultAuthorizationServerTokenServices&quot;)</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthorizationServerTokenServices authorizationServerTokenServices;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. ä»è¯·æ±‚å¤´è·å–clientId</span></span><br><span class="line">        String header = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (header == <span class="keyword">null</span> || !header.startsWith(<span class="string">&quot;Basic &quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnapprovedClientAuthenticationException(<span class="string">&quot;No client information was found in the request header&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String[] tokens = <span class="keyword">this</span>.extractAndDecodeHeader(header);</span><br><span class="line">        String clientId = tokens[<span class="number">0</span>], clientSecret = tokens[<span class="number">1</span>];</span><br><span class="line">        TokenRequest tokenRequest = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 2. é€šè¿‡ClientDetailServiceè·å–ClientDetails</span></span><br><span class="line">        ClientDetails clientDetails = clientDetailsService.loadClientByClientId(clientId);</span><br><span class="line">        <span class="comment">// 3. æ ¡éªŒClientIdå’ŒClientSecretçš„æ­£ç¡®æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (clientDetails == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnapprovedClientAuthenticationException(<span class="string">&quot;No client details was found for clientId &quot;</span> + clientId);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!StringUtils.equals(clientDetails.getClientSecret(), clientSecret)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnapprovedClientAuthenticationException(<span class="string">&quot;The client secret is invalid&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 4. é€šè¿‡TokenRequestæ„é€ å™¨ç”ŸæˆTokenRequest</span></span><br><span class="line">            tokenRequest = <span class="keyword">new</span> TokenRequest(<span class="keyword">new</span> HashMap&lt;&gt;(), clientId, clientDetails.getScope(), <span class="string">&quot;custom&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 5. é€šè¿‡TokenRequestçš„createOAuth2Requestæ–¹æ³•è·å–OAuth2Request</span></span><br><span class="line">        OAuth2Request auth2Request = tokenRequest.createOAuth2Request(clientDetails);</span><br><span class="line">        <span class="comment">// 6. é€šè¿‡Authenticationå’ŒOAuth2Requestæ„é€ å‡ºOAuth2Authentication</span></span><br><span class="line">        OAuth2Authentication auth2Authentication = <span class="keyword">new</span> OAuth2Authentication(auth2Request, authentication);</span><br><span class="line">        <span class="comment">// 7. é€šè¿‡AuthenticationSServerTokenServiceç”ŸæˆOAuth2AccessToken</span></span><br><span class="line">        OAuth2AccessToken token = authorizationServerTokenServices.createAccessToken(auth2Authentication);</span><br><span class="line">        <span class="comment">// 8. è¿”å›token</span></span><br><span class="line">        log.info(<span class="string">&quot;[&#123;&#125;]ç™»å½•æˆåŠŸ&quot;</span>, authentication.getName());</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        response.getWriter().write(objectMapper.writeValueAsString(token));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»headerä¸­è·å–client-idå’Œclient-secret</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String[] extractAndDecodeHeader(String header) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] base64Token = header.substring(<span class="number">6</span>).getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">byte</span>[] decoded;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            decoded = Base64.getDecoder().decode(base64Token);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">&quot;Failed to decode basic authentication token&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String token = <span class="keyword">new</span> String(decoded, StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">int</span> index = token.indexOf(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (index == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">&quot;The basic authentication token is invalid&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;token.substring(<span class="number">0</span>, index), token.substring(index + <span class="number">1</span>)&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨postmanå‘é€ç™»å½•è¯·æ±‚ï¼š<a href="http://localhost:8080/login?username=Khighness&amp;password=KAG1823">http://localhost:8080/login?username=Khighness&amp;password=KAG1823</a></p>
<p>åŒæ—¶åœ¨è¯·æ±‚å¤´ä¸­å¸¦ä¸ŠAuthorizationï¼š<code>Basic azpwYXJhaw==</code></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602163259549.png" class="" title="image-20210602163259549">

<p>æˆåŠŸè·å–åˆ°ä»¤ç‰Œåï¼Œå†è®¿é—®<code>/index</code>æ¥å£ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602163437616.png" class="" title="image-20210602163437616">



<h3 id="7-2-é‚®ä»¶éªŒè¯ç "><a href="#7-2-é‚®ä»¶éªŒè¯ç " class="headerlink" title="7.2 é‚®ä»¶éªŒè¯ç "></a>7.2 é‚®ä»¶éªŒè¯ç </h3><p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é…ç½®securityï¼Œrediså’Œmailï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">oauth2:</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="string">k</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">parak</span></span><br><span class="line">      <span class="attr">registered-redirect-uri:</span> <span class="string">http://parak.top</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">KAG1823</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment"># é‚®ç®±è¿™æ ·é…ç½®ä¸€èˆ¬ä¸ä¼šå‡ºç°é—®é¢˜</span></span><br><span class="line">  <span class="attr">mail:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">&lt;é‚®ç®±&gt;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&lt;é‚®ç®±æˆæƒç &gt;</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&lt;é‚®ä»¶STMPæœåŠ¡å™¨&gt;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">465</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">mail:</span></span><br><span class="line">        <span class="attr">ssl:</span></span><br><span class="line">          <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">smtp:</span></span><br><span class="line">          <span class="attr">auth:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">starttls:</span></span><br><span class="line">            <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">            <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">socketFactory:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">465</span></span><br><span class="line">            <span class="attr">class:</span> <span class="string">javax.net.ssl.SSLSocketFactory</span></span><br><span class="line">            <span class="attr">fallback:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>åœ¨Spring Securityä¸­ï¼Œä½¿ç”¨ç”¨æˆ·åå¯†ç è®¤è¯çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹å›¾å·¦æµç¨‹æ‰€ç¤ºã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210602181133567.svg" class="" title="image-20210602181133567">

<p>Spring Securityä½¿ç”¨<code>UsernamePasswordAuthenticationFilter</code>è¿‡æ»¤å™¨æ¥æ‹¦æˆªç”¨æˆ·åå¯†ç è®¤è¯è¯·æ±‚ï¼Œå°†ç”¨æˆ·åå’Œå¯†ç å°è£…æˆä¸€ä¸ª<code>UsernamePasswordAuthenticationToken</code>å¯¹è±¡äº¤ç»™<code>AuthenticationManager</code>å¤„ç†ã€‚<code>AuthenticationManager</code>å°†æŠ›å‡ºä¸€ä¸ªæ”¯æŒè¯¥ç±»å‹Tokençš„<code>AuthenticationProvider</code>æ¥è¿›è¡Œè®¤è¯ï¼Œè®¤è¯è¿‡ç¨‹ä¸­<code>DaoAuthenticationProvider</code>å°†è°ƒç”¨<code>UserDetailService</code>çš„<code>loadUserByUsername</code>æ¥è·å–<code>UserDetails</code>å¯¹è±¡ï¼Œå¦‚æœ<code>UserDetails</code>ä¸ä¸ºç©ºå¹¶ä¸”å¯†ç å’Œç”¨æˆ·è¾“å…¥çš„å¯†ç åŒ¹é…ä¸€è‡´çš„è¯ï¼Œåˆ™å°†è®¤è¯ä¿¡æ¯ä¿å­˜åˆ°sessionä¸­ï¼Œè®¤è¯åæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡<code>Authentication</code>å¯¹è±¡è·å–åˆ°è®¤è¯çš„ä¿¡æ¯ã€‚</p>
<p>ç”±äºSpring Securityå¹¶æ²¡æœ‰æä¾›éªŒè¯ç è®¤è¯çš„æµç¨‹ï¼Œæ‰€ä»¥æˆ‘éœ€è¦ä»¿ç…§ä¸Šå›¾å·¦è¾¹çš„æµç¨‹å®ç°ï¼Œå¦‚å³å›¾æ‰€ç¤ºã€‚</p>
<p>åœ¨è¿™ä¸ªæµç¨‹ä¸­ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªåä¸º<code>CodeAuthenticationFilter</code>çš„è¿‡æ»¤å™¨æ¥æ‹¦æˆªé‚®ä»¶éªŒè¯ç ç™»å½•è¯·æ±‚ï¼Œå¹¶å°†é‚®ç®±å°è£…åˆ°ä¸€ä¸ª<code>EmailCodeAuthenticationToken</code>å¯¹è±¡ä¸­ã€‚åœ¨Spring Securityä¸­ï¼Œè®¤è¯å¤„ç†éƒ½éœ€è¦é€šè¿‡<code>AuthenticationManager</code>æ¥ä»£ç†ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¾æ—§å°†<code>EmailCodeAuthenticationToken</code>äº¤ç”±<code>AuthenticationManager</code>å¤„ç†ã€‚æ¥ç€æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå¤„ç†<code>EmailCodeAuthenticationToken</code>å¯¹è±¡çš„<code>CodeAuthenticationProvider</code>ï¼Œ<code>EmailAuthenticationProvider</code>è°ƒç”¨<code>UserDetailService</code>çš„<code>loadUserByUsername</code>æ–¹æ³•æ¥å¤„ç†è®¤è¯ã€‚ä¸ç”¨æˆ·åå¯†ç è®¤è¯ä¸ä¸€æ ·çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯é€šè¿‡<code>EmailCodeAuthenticationToken</code>ä¸­çš„é‚®ç®±å»æ•°æ®åº“ä¸­æŸ¥è¯¢æ˜¯å¦æœ‰ä¸ä¹‹å¯¹åº”çš„ç”¨æˆ·ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°†è¯¥ç”¨æˆ·ä¿¡æ¯å°è£…åˆ°<code>UserDetails</code>å¯¹è±¡ä¸­è¿”å›å¹¶å°†è®¤è¯åçš„ä¿¡æ¯ä¿å­˜åˆ°<code>Authentication</code>å¯¹è±¡ä¸­ã€‚</p>
<p>ä¸ºäº†å®ç°è¿™ä¸ªæµç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å®ç°<code>EmailCodeAuthenticationToken</code>ã€<code>EmailCodeAuthenticationFilter</code>å’Œ<code>EmailCodeAuthenticationProvider</code>ï¼Œå¹¶å°†è¿™äº›ç»„åˆèµ·æ¥æ·»åŠ åˆ°Spring Securityä¸­ã€‚</p>
<p>æ•´ä¸ªé¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">top</span><br><span class="line">â””â”€â”€ parak</span><br><span class="line"> 	â”œâ”€â”€ SpringSecurityOAuth2EmailApplication     é¡¹ç›®å¯åŠ¨ç±»</span><br><span class="line"> 	â”œâ”€â”€ config</span><br><span class="line"> 	â”‚	â”œâ”€â”€ AuthorizationServerConfig            æˆæƒæœåŠ¡å™¨</span><br><span class="line"> 	â”‚	â””â”€â”€ ResourceServerConfig                 èµ„æºæœåŠ¡å™¨</span><br><span class="line"> 	â”œâ”€â”€ controller</span><br><span class="line"> 	â”‚	â”œâ”€â”€ IndexController                      èµ„æºæ¥å£</span><br><span class="line"> 	â”‚	â””â”€â”€ ValidateController                   éªŒè¯ç æ¥å£</span><br><span class="line"> 	â”œâ”€â”€ entity</span><br><span class="line"> 	â”‚	â””â”€â”€ MyUser                               è‡ªå®šä¹‰ç”¨æˆ·</span><br><span class="line"> 	â”œâ”€â”€ handler</span><br><span class="line"> 	â”‚	â”œâ”€â”€ MyAuthenticationFailureHandler       å¤„ç†ç™»å½•æˆåŠŸ</span><br><span class="line"> 	â”‚	â””â”€â”€ MyAuthenticationSuccessHandler       å¤„ç†ç™»å½•å¤±è´¥</span><br><span class="line"> 	â”œâ”€â”€ service</span><br><span class="line"> 	â”‚	â”œâ”€â”€ EmailCodeService                     å‘é€é‚®ä»¶æœåŠ¡</span><br><span class="line"> 	â”‚	â”œâ”€â”€ EmailUserDetailService               è‡ªå®šä¹‰é‚®ç®±è®¤è¯</span><br><span class="line"> 	â”‚	â””â”€â”€ RedisCodeService.java                éªŒè¯ç ç¼“å­˜æ“ä½œ</span><br><span class="line"> 	â””â”€â”€ validate</span><br><span class="line"> 	 	â””â”€â”€ emailcode</span><br><span class="line"> 	 	 	â”œâ”€â”€ EmailCode                        é‚®ä»¶éªŒè¯ç </span><br><span class="line"> 	 	 	â”œâ”€â”€ EmailCodeAuthenticationConfig    é‚®ä»¶éªŒè¯ç é…ç½®</span><br><span class="line"> 	 	 	â”œâ”€â”€ EmailCodeAuthenticationFilter    ç™»å½•è¯·æ±‚è¿‡æ»¤å™¨</span><br><span class="line"> 	 	 	â”œâ”€â”€ EmailCodeAuthenticationProvider  ç”¨æˆ·é‚®ç®±æ ¡éªŒ</span><br><span class="line"> 	 	 	â”œâ”€â”€ EmailCodeAuthenticationToken     é‚®ä»¶éªŒè¯ç ä»¤ç‰Œ</span><br><span class="line"> 	 	 	â””â”€â”€ EmailCodeFilter                  é‚®ä»¶éªŒè¯ç æ ¡éªŒ</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­è‡ªå®šä¹‰ç”¨æˆ·ã€æˆæƒæœåŠ¡å™¨ã€ç™»å½•æˆåŠŸå’Œå¤±è´¥çš„å¤„ç†å™¨ä»¥åŠé¦–é¡µæ¥å£å»¶ç”¨ä¸Šæ¬¡åˆ›å»ºçš„é¡¹ç›®å³å¯ã€‚</p>
<p>æˆ‘ä»¬å…ˆå®ç°é‚®ä»¶å‘é€åŠŸèƒ½ã€‚</p>
<p>å®šä¹‰<code>EmailCode</code>å°è£…é‚®ä»¶éªŒè¯ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailCode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰<code>EmailUserDetailService</code>å®ç°é‚®ç®±è®¤è¯é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailUserDetailService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String email)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢é€»è¾‘ï¼›æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·</span></span><br><span class="line">        MyUser user = <span class="keyword">new</span> MyUser();</span><br><span class="line">        user.setUserName(email);</span><br><span class="line">        user.setPassword(passwordEncoder.encode(<span class="string">&quot;KAG1823&quot;</span>));</span><br><span class="line">        List&lt;GrantedAuthority&gt; authorityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// åªæœ‰é‚®ç®±ä¸ºparakovo@gmailçš„ç”¨æˆ·æ‰ä¸ºç®¡ç†å‘˜adminï¼Œå…¶ä»–ç”¨æˆ·éƒ½ä¸ºè®¿å®¢guest</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(<span class="string">&quot;parakovo@gmail&quot;</span>, email)) &#123;</span><br><span class="line">            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(email, user.getPassword(), user.isEnabled(),</span><br><span class="line">                user.isAccountNonExpired(), user.isCredentialsNonExpired(),</span><br><span class="line">                user.isAccountNonLocked(), authorityList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰<code>RedisCodeService</code>å®ç°ç¼“å­˜å¯¹äºéªŒè¯ç çš„æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCodeService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** é‚®ç®±éªŒè¯ç keyçš„å‰ç¼€ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EMAIL_CODE_PREFIX = <span class="string">&quot;EMAIL_CODE:&quot;</span>;</span><br><span class="line">    <span class="comment">/** é‚®ç®±éªŒè¯ç è¿‡æœŸæ—¶é—´S */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Integer EMAIL_CODE_TIMEOUT = <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜éªŒè¯ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(EmailCode emailCode, ServletWebRequest request, String email)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(key(request, email), emailCode.getCode(), EMAIL_CODE_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–éªŒè¯ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(ServletWebRequest request, String email)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String key = key(request, email);</span><br><span class="line">        Long expire = redisTemplate.opsForValue().getOperations().getExpire(key);</span><br><span class="line">        <span class="keyword">if</span> (expire == -<span class="number">2</span>) <span class="comment">// è¿‡æœŸ</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;The verification code has expired&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§»é™¤éªŒè¯ç </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(ServletWebRequest request, String email)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        redisTemplate.delete(key(request, email));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">key</span><span class="params">(ServletWebRequest request, String email)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String deviceId = request.getHeader(<span class="string">&quot;deviceId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(deviceId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;No device id was found in request header&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> EMAIL_CODE_PREFIX + deviceId + <span class="string">&quot;:&quot;</span> + email;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰<code>EmailCodeService</code>å®ç°é‚®ä»¶éªŒè¯ç çš„å‘é€ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailCodeService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.mail.username&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String fromMail;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MailSender mailSender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisCodeService redisCodeService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€éªŒè¯ç åˆ°æŒ‡å®šé‚®ç®±</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request è¯·æ±‚</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code    éªŒè¯ç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> toMail  ç›®æ ‡é‚®ç®±</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(ServletWebRequest request, String code, String toMail)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SimpleMailMessage message = <span class="keyword">new</span> SimpleMailMessage();</span><br><span class="line">        message.setFrom(fromMail);</span><br><span class="line">        message.setTo(toMail);</span><br><span class="line">        message.setSubject(<span class="string">&quot;SpringSecurityéªŒè¯ç &quot;</span>);</span><br><span class="line">        message.setText(<span class="string">&quot;æ‚¨æ­£åœ¨ç™»å½•Spring-Security-OAuth2, éªŒè¯ç ä¸ºï¼š&quot;</span> + code);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mailSender.send(message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            redisCodeService.remove(request, toMail);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬ç¼–å†™RESTæ¥å£ï¼Œå‘é€é‚®ä»¶éªŒè¯ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisCodeService redisCodeService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailCodeService emailCodeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/code/email&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendEmailCode</span><span class="params">(HttpServletRequest request, String email)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String code = RandomStringUtils.randomNumeric(<span class="number">6</span>);</span><br><span class="line">        EmailCode emailCode = <span class="keyword">new</span> EmailCode(code);</span><br><span class="line">        ServletWebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request);</span><br><span class="line">        emailCodeService.send(webRequest, code, email);</span><br><span class="line">        redisCodeService.save(emailCode, webRequest, email);</span><br><span class="line">        log.info(<span class="string">&quot;ç”¨æˆ·ä½¿ç”¨é‚®ç®±[&#123;&#125;]ç™»å½•ï¼ŒéªŒè¯ç ä¸ºï¼š[&#123;&#125;]&quot;</span>, email, code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå®ç°é‚®ä»¶éªŒè¯ç çš„è®¤è¯æµç¨‹ã€‚</p>
<p>æŸ¥çœ‹<code>UsernamePasswordAuthenticationToken</code>çš„æºç ï¼Œå°†å…¶å¤åˆ¶å‡ºæ¥é‡å‘½åä¸º<code>EmailCodeAuthenticationToken</code>ï¼Œå¹¶ç¨ä½œä¿®æ”¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailCodeAuthenticationToken</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationToken</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8522249673088578015L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object principal;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EmailCodeAuthenticationToken</span><span class="params">(String email)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.principal = email;</span><br><span class="line">        setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EmailCodeAuthenticationToken</span><span class="params">(Object principal, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(authorities);</span><br><span class="line">        <span class="keyword">this</span>.principal = principal;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.principal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isAuthenticated) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">&quot;Cannot set this token trusted - use constructor which takes a GrantedAuthority list instead&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eraseCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.eraseCredentials();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EmailCodeAuthenticationToken</code>åŒ…å«ä¸€ä¸ª<code>principal</code>å±æ€§ï¼Œä»å®ƒçš„ä¸¤ä¸ªæ„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œåœ¨è®¤è¯ä¹‹å‰<code>principal</code>å­˜çš„æ˜¯æ‰‹æœºå·ï¼Œè®¤è¯ä¹‹åå­˜çš„æ˜¯ç”¨æˆ·ä¿¡æ¯ã€‚<code>UsernamePasswordAuthenticationToken</code>åŸæ¥è¿˜åŒ…å«ä¸€ä¸ª<code>credentials</code>å±æ€§ç”¨äºå­˜æ”¾å¯†ç ï¼Œè¿™é‡Œä¸éœ€è¦å°±å»æ‰äº†ã€‚</p>
<p>æ¥ç€å®šä¹‰ç”¨äºå¤„ç†çŸ­ä¿¡éªŒè¯ç ç™»å½•è¯·æ±‚çš„è¿‡æ»¤å™¨<code>EmailCodeAuthenticationFilter</code>ï¼ŒåŒæ ·çš„å¤åˆ¶<code>UsernamePasswordAuthenticationFilter</code>æºç å¹¶ç¨ä½œä¿®æ”¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailCodeAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationProcessingFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EMAIL_KEY = <span class="string">&quot;email&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> String emailParameter = EMAIL_KEY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> postOnly = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">EmailCodeAuthenticationFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> AntPathRequestMatcher(<span class="string">&quot;/login/email&quot;</span>, <span class="string">&quot;POST&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmailParameter</span><span class="params">(String emailParameter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.emailParameter = emailParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPostOnly</span><span class="params">(<span class="keyword">boolean</span> postOnly)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.postOnly = postOnly;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">getEmailParameter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> emailParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException, IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (postOnly &amp;&amp; !request.getMethod().equals(<span class="string">&quot;POST&quot;</span>))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationServiceException(<span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">        String email = request.getParameter(emailParameter);</span><br><span class="line">        <span class="keyword">if</span> (email == <span class="keyword">null</span>) email = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        email = email.trim();</span><br><span class="line">        EmailCodeAuthenticationToken token = <span class="keyword">new</span> EmailCodeAuthenticationToken(email);</span><br><span class="line">        token.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(token);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ„é€ å‡½æ•°ä¸­æŒ‡å®šäº†å½“è¯·æ±‚è·¯å¾„ä¸º<code>login.email</code>ï¼Œè¯·æ±‚æ–¹æ³•ä¸ºPOSTçš„æ—¶å€™è¯¥è¿‡æ»¤å™¨ç”Ÿæ•ˆã€‚<code>emailParameter</code>å±æ€§å€¼ä¸º<code>email</code>ï¼Œå¯¹åº”ç™»å½•é¡µé¢é‚®ä»¶è¾“å…¥æ¡†çš„<code>name</code>å±æ€§ï¼Œå¹¶è°ƒç”¨<code>EmailCodeAuthenticationToken</code>çš„æ„é€ æ–¹æ³•<code>EmailCodeAuthenticationToken(String email)</code>åˆ›å»ºäº†ä¸€ä¸ª<code>EmailCodeAuthenticationToken</code>ã€‚ä¸‹ä¸€æ­¥å°±å¦‚æµç¨‹å›¾ä¸­æ‰€ç¤ºçš„é‚£æ ·ï¼Œ<code>EmailCodeAuthenticationFilter</code>å°†<code>EmailCodeAuthenticationToken</code>äº¤ç»™<code>AuthenticationManager</code>å¤„ç†ã€‚</p>
<p>ç„¶åæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ”¯æŒå¤„ç†<code>EmailCodeAuthenticationToken</code>çš„ç±»ï¼Œå³<code>EmailCodeAuthenticationProvider</code>ï¼Œè¯¥ç±»éœ€è¦å®ç°<code>AuthenticationProvider</code>çš„ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œä¸»è¦å®ç°ç™»å½•çš„é‚®ç®±å­˜åœ¨æ€§æ ¡éªŒï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailCodeAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">getUserDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserDetailsService</span><span class="params">(UserDetailsService userDetailsService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        EmailCodeAuthenticationToken authenticationToken = (EmailCodeAuthenticationToken) authentication;</span><br><span class="line">        UserDetails userDetails = userDetailsService.loadUserByUsername((String) authenticationToken.getPrincipal());</span><br><span class="line">        <span class="keyword">if</span> (userDetails == <span class="keyword">null</span>) <span class="comment">// æœªæ‰¾åˆ°ä¸è¯¥é‚®ç®±åŒ¹é…çš„ç”¨æˆ·</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalAuthenticationServiceException(<span class="string">&quot;The user corresponding to the email was not found&quot;</span>);</span><br><span class="line">        EmailCodeAuthenticationToken authenticationResult = <span class="keyword">new</span> EmailCodeAuthenticationToken(userDetails, userDetails.getAuthorities());</span><br><span class="line">        authenticationResult.setDetails(authenticationToken.getDetails());</span><br><span class="line">        <span class="keyword">return</span> authenticationResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; aClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EmailCodeAuthenticationToken.class.isAssignableFrom(aClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>supports</code>æ–¹æ³•æŒ‡å®šäº†æ”¯æŒå¤„ç†çš„Tokenç±»å‹ä¸º<code>EmailCodeAuthenticationToken</code>ï¼Œ<code>authenticate</code>æ–¹æ³•ç”¨äºç¼–å†™å…·ä½“çš„èº«ä»½è®¤è¯é€»è¾‘ï¼Œä»<code>EmailCodeAuthenticationToken</code>ä¸­å–å‡ºé‚®ç®±ä¿¡æ¯ï¼Œå¹¶è°ƒç”¨<code>UserDeatilService</code>æ–¹æ³•çš„<code>loadUserByUsername</code>æ–¹æ³•ï¼Œé€šè¿‡é‚®ç®±æŸ¥è¯¢ç”¨æˆ·ï¼Œå¦‚æœå­˜åœ¨è¯¥ç”¨æˆ·åˆ™è®¤è¯æˆåŠŸï¼Œé€šè¿‡åæ¥ç€è°ƒç”¨<code>EmailCodeAuthenticationToken</code>çš„æ„é€ æ–¹æ³•<code>EmailCodeAuthenticationToken(Object principal, Collection&lt;? extends GrantedAuthority&gt; authorities)</code>æ„é€ ä¸€ä¸ªè®¤è¯é€šè¿‡çš„Tokenï¼ŒåŒ…å«äº†ç”¨æˆ·ä¿¡æ¯å’Œç”¨æˆ·æƒé™ã€‚</p>
<p>å®Œæˆé‚®ç®±å­˜åœ¨æ€§æ ¡éªŒä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ ¡éªŒéªŒè¯ç çš„æ­£ç¡®æ€§ï¼Œå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨<code>EmailCodeFilter</code>ï¼Œç»§æ‰¿ä¸€æ¬¡æ€§è¿‡æ»¤å™¨<code>OncePerRequestFilter</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailCodeFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisCodeService redisCodeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(<span class="string">&quot;/login/email&quot;</span>, request.getRequestURI()) &amp;&amp; StringUtils.equalsIgnoreCase(<span class="string">&quot;post&quot;</span>, request.getMethod())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                validateCode(<span class="keyword">new</span> ServletWebRequest(request));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                authenticationFailureHandler.onAuthenticationFailure(request, response, <span class="keyword">new</span> AuthenticationServiceException(e.getMessage()));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateCode</span><span class="params">(ServletWebRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(), <span class="string">&quot;code&quot;</span>);</span><br><span class="line">        String emailInRequest = ServletRequestUtils.getRequiredStringParameter(request.getRequest(), <span class="string">&quot;email&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(codeInRequest))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;The verification code cannot be null&quot;</span>);</span><br><span class="line">        String codeInRedis = redisCodeService.get(request, emailInRequest);</span><br><span class="line">        <span class="keyword">if</span> (codeInRedis == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;No verification code was found for email &quot;</span> + emailInRequest);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.equals(codeInRequest, codeInRedis))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;The verification code is wrong&quot;</span>);</span><br><span class="line">        redisCodeService.remove(request, emailInRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æ–¹æ³•ä¸º<code>doFilterInternal</code>ï¼Œæˆ‘ä»¬åˆ¤æ–­äº†è¯·æ±‚è·¯å¾„æ˜¯å¦ä¸º<code>/login/email</code>ä»¥åŠè¯·æ±‚æ–¹æ³•æ˜¯å¦ä¸º<code>POST</code>ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡ŒéªŒè¯ç æ ¡éªŒé€»è¾‘ï¼Œå¦åˆ™ç›´æ¥æ‰§è¡Œ<code>filterChain.doFilter</code>è®©ä»£ç å‘ä¸‹æ‰§è¡Œã€‚åœ¨æ ¡éªŒéªŒè¯ç çš„<code>validateCode</code>æ–¹æ³•ï¼Œå°†è¯·æ±‚å‚æ•°ä¸­çš„éªŒè¯ç ä¸Redisä¸­çš„éªŒè¯ç è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæ•è·åˆ°å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨Spring Securityçš„æ ¡éªŒå¤±è´¥å¤„ç†å™¨<code>AuthenticationFailureHandler</code>è¿›è¡Œå¤„ç†ã€‚</p>
<p>åœ¨å®šä¹‰å®Œæ‰€æœ‰çš„ç»„ä»¶åï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€äº›é…ç½®ï¼Œå°†è¿™äº›ç»„ä»¶ç»„åˆèµ·æ¥å½¢æˆå’Œä¸Šé¢æµç¨‹å›¾å¯¹åº”çš„æµç¨‹ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ªé…ç½®ç±»<code>EmailCodeAuthenticationConfig</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailCodeAuthenticationConfig</span> <span class="keyword">extends</span> <span class="title">SecurityConfigurerAdapter</span>&lt;<span class="title">DefaultSecurityFilterChain</span>, <span class="title">HttpSecurity</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationSuccessHandler authenticationSuccessHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;</span><br><span class="line">    <span class="meta">@Qualifier(&quot;emailUserDetailService&quot;)</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        EmailCodeAuthenticationFilter emailCodeAuthenticationFilter = <span class="keyword">new</span> EmailCodeAuthenticationFilter();</span><br><span class="line">        emailCodeAuthenticationFilter.setAuthenticationManager(httpSecurity.getSharedObject(AuthenticationManager.class));</span><br><span class="line">        emailCodeAuthenticationFilter.setAuthenticationSuccessHandler(authenticationSuccessHandler);</span><br><span class="line">        emailCodeAuthenticationFilter.setAuthenticationFailureHandler(authenticationFailureHandler);</span><br><span class="line"></span><br><span class="line">        EmailCodeAuthenticationProvider emailCodeAuthenticationProvider = <span class="keyword">new</span> EmailCodeAuthenticationProvider();</span><br><span class="line">        emailCodeAuthenticationProvider.setUserDetailsService(userDetailsService);</span><br><span class="line"></span><br><span class="line">        httpSecurity.authenticationProvider(emailCodeAuthenticationProvider)</span><br><span class="line">                .addFilterAfter(emailCodeAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ­¥éœ€è¦é…ç½®<code>EmailCodeAuthenticationFilter</code>ï¼Œåˆ†åˆ«è®¾ç½®<code>AuthenticationManager</code>ã€<code>AuthenticationSuccessHandler</code>å’Œ<code>AuthenticationFailureHandler</code>è¿™ä¸‰ä¸ªå±æ€§ï¼Œéƒ½æ˜¯æ¥è‡ªå®ƒæ‰€ç»§æ‰¿çš„<code>AbstractAuthenticationProcessingFilter</code>ç±»ä¸­ã€‚ç¬¬äºŒæ­¥é…ç½®<code>EmailCodeAuthenticationProvider</code>ï¼Œè¿™ä¸€æ­¥åªéœ€è¦æŠŠè‡ªå®šä¹‰çš„<code>EmailUserDetailService</code>æ³¨å…¥è¿›æ¥å³å¯ã€‚ç¬¬ä¸‰æ­¥è°ƒç”¨<code>HttpSecurity</code>çš„<code>authenticationProvider</code>æ–¹æ³•æŒ‡å®š<code>AuthenticationProvider</code>ä¸º<code>EmailCodeAuthenticationProvider</code>ï¼Œå¹¶å°†<code>EmailCodeAuthenticationFilter</code>è¿‡æ»¤å™¨æ·»åŠ åˆ°<code>UsernamePasswordAuthenticationFilter</code>åé¢ã€‚</p>
<p>è‡³æ­¤æˆ‘ä»¬å·²ç»å°†é‚®ä»¶éªŒè¯ç çš„å„ä¸ªç»„ä»¶ç»„åˆèµ·æ¥äº†ï¼Œæœ€ä¼šä¸€æ­¥éœ€è¦åšçš„å°±æ˜¯é…ç½®é‚®ä»¶éªŒè¯ç è¿‡æ»¤å™¨ï¼Œå¹¶ä¸”å°†é‚®ä»¶éªŒè¯ç è®¤è¯æµç¨‹åŠ å…¥åˆ°Spring Securityä¸­ï¼Œåœ¨èµ„æºæœåŠ¡å™¨çš„<code>configure</code>æ–¹æ³•ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSuccessHandler authenticationSuccessHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler authenticationFailureHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailCodeFilter emailCodeFilter;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailCodeAuthenticationConfig emailCodeAuthenticationConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.addFilterBefore(emailCodeFilter, UsernamePasswordAuthenticationFilter.class) <span class="comment">// æ·»åŠ é‚®ä»¶éªŒè¯ç è¿‡æ»¤å™¨</span></span><br><span class="line">                .formLogin()                  <span class="comment">// è¡¨å•ç™»å½•</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// å¤„ç†è¡¨å•ç™»å½•URL</span></span><br><span class="line">                .successHandler(authenticationSuccessHandler) <span class="comment">// å¤„ç†ç™»å½•æˆåŠŸ</span></span><br><span class="line">                .failureHandler(authenticationFailureHandler) <span class="comment">// å¤„ç†ç™»å½•å¤±è´¥</span></span><br><span class="line">        .and()</span><br><span class="line">                .authorizeRequests()                    <span class="comment">// æˆæƒé…ç½®</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/code/email&quot;</span>).permitAll() <span class="comment">// éªŒè¯ç æ¥å£æ— éœ€è®¤è¯</span></span><br><span class="line">                .anyRequest().authenticated()           <span class="comment">// æ‰€æœ‰æ¥å£éƒ½éœ€è¦è®¤è¯</span></span><br><span class="line">        .and()</span><br><span class="line">                .csrf().disable() <span class="comment">// å…³é—­CSRFä¿æŠ¤</span></span><br><span class="line">        .apply(emailCodeAuthenticationConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œcodingç»“æŸã€‚</p>
<p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®éªŒè¯ç æ¥å£ï¼š<a href="http://localhost:8080/code/email?email=parakovo@gmail.com">http://localhost:8080/code/email?email=parakovo@gmail.com</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603004716986.png" class="" title="image-20210603004716986">

<p>æ§åˆ¶å°æ—¥å¿—æ‰“å°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span>-<span class="number">06</span>-<span class="number">03</span> <span class="number">00</span>:<span class="number">46</span>:<span class="number">09.955</span>  INFO <span class="number">9756</span> --- [nio-<span class="number">8080</span>-exec-<span class="number">3</span>] top.parak.controller.ValidateController  : ç”¨æˆ·ä½¿ç”¨é‚®ç®±[parakovo<span class="meta">@gmail</span>.com]ç™»å½•ï¼ŒéªŒè¯ç ä¸ºï¼š[<span class="number">196267</span>]</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¯·æ±‚æˆæƒç æ¥å£ï¼š<a href="http://localhost:8080/login/email?email=parakovo@gmail.com&amp;code=196267">http://localhost:8080/login/email?email=parakovo@gmail.com&amp;code=196267</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603005013617.png" class="" title="image-20210603005013617">

<p>æœ€åæµ‹è¯•è®¿é—®èµ„æºï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603005142695.png" class="" title="image-20210603005142695">



<h2 id="8-Spring-Security-OAuth2-Config"><a href="#8-Spring-Security-OAuth2-Config" class="headerlink" title="8. Spring Security OAuth2 Config"></a>8. Spring Security OAuth2 Config</h2><p>ğŸ“–æ¦‚è¿°</p>
<p>Spring Securityå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰ä»¤ç‰Œé…ç½®ï¼Œæ¯”å¦‚ä¸åŒçš„client_idå¯¹åº”ä¸åŒçš„ä»¤ç‰Œï¼Œä»¤ç‰Œçš„æœ‰æ•ˆæ—¶é—´ã€ä»¤ç‰Œçš„å­˜å‚¨ç­–ç•¥ç­‰ï¼›æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨JWTæ¥æ›¿æ¢é»˜è®¤çš„ä»¤ç‰Œã€‚</p>
<h3 id="8-1-è‡ªå®šä¹‰ä»¤ç‰Œé…ç½®"><a href="#8-1-è‡ªå®šä¹‰ä»¤ç‰Œé…ç½®" class="headerlink" title="8.1 è‡ªå®šä¹‰ä»¤ç‰Œé…ç½®"></a>8.1 è‡ªå®šä¹‰ä»¤ç‰Œé…ç½®</h3><p>æ–°å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºé…ç½®ç±»<code>SecurityConfig</code>ï¼Œç”¨äºæ³¨å†Œå¸¸ç”¨çš„beanï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean(name = BeanIds.AUTHENTICATION_MANAGER)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰<code>NameUserDetailService</code>å®ç°<code>UserDetailsService</code>ï¼Œå®ç°è‡ªå·±çš„ç”¨æˆ·åå¯†ç è®¤è¯é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NameUserDetailService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢é€»è¾‘ï¼›æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·</span></span><br><span class="line">        String password = passwordEncoder.encode(<span class="string">&quot;KAG1823&quot;</span>);</span><br><span class="line">        List&lt;GrantedAuthority&gt; authorityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// Khighnessä¸ºç®¡ç†å‘˜ï¼Œå…¶ä»–éƒ½ä¸ºè®¿å®¢</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(<span class="string">&quot;Khighness&quot;</span>, username)) &#123;</span><br><span class="line">            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username, password, authorityList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆ›å»ºæˆæƒæœåŠ¡å™¨<code>AuthorizationServerConfig</code>ï¼Œæ³¨æ„åœ¨æ–°ç‰ˆæœ¬çš„spring-cloud-starter-oauth2ä¸­ï¼ŒæŒ‡å®šclient_secretéœ€è¦è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œè¿™é‡Œä¾ç„¶ä½¿ç”¨BCRåŠ å¯†ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="meta">@Qualifier(&quot;nameUserDetailService&quot;)</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        endpoints.authenticationManager(authenticationManager)</span><br><span class="line">                .userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.inMemory()</span><br><span class="line">                .withClient(<span class="string">&quot;k&quot;</span>)</span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">&quot;parak&quot;</span>))</span><br><span class="line">                .accessTokenValiditySeconds(<span class="number">3600</span>)   <span class="comment">// 1h</span></span><br><span class="line">                .refreshTokenValiditySeconds(<span class="number">86400</span>) <span class="comment">// 1d</span></span><br><span class="line">                .scopes(<span class="string">&quot;all&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>)</span><br><span class="line">            .and()</span><br><span class="line">                .withClient(<span class="string">&quot;z&quot;</span>)</span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">&quot;paraz&quot;</span>))</span><br><span class="line">                .accessTokenValiditySeconds(<span class="number">7200</span>)   <span class="comment">// 2h</span></span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨é‡å†™çš„<code>configure(AuthorizationServerEndpointsConfigurer endpoints)</code>æ–¹æ³•ä¸­ï¼ŒæŒ‡å®š<code>AuthenticationManager</code>å’Œ<code>UserDetailsService</code>ã€‚</p>
<p>åœ¨é‡å†™çš„<code>configure(ClientDetailsServiceConfigurer clients)</code>æ–¹æ³•ä¸­ï¼Œä¸»è¦é…ç½®ï¼š</p>
<ol>
<li>å®šä¹‰ä¸¤ä¸ªclient_idï¼Œkä¸zï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ä¸åŒçš„client_idæ¥è·å–ä¸åŒçš„ä»¤ç‰Œï¼›</li>
<li>kçš„ä»¤ç‰Œæœ‰æ•ˆæ—¶é—´ä¸º3600ç§’ï¼ˆ1å°æ—¶ï¼‰ï¼Œzçš„ä»¤ç‰Œæœ‰æ•ˆæ—¶é—´ä¸º7200ç§’ï¼ˆ2å°æ—¶ï¼‰ï¼›</li>
<li>kçš„refresh_tokençš„æœ‰æ•ˆæ—¶é—´ä¸º86400ç§’ï¼ˆ1å¤©ï¼‰ï¼Œå³10å¤©å†…éƒ½å¯ä»¥é€šè¿‡refresh_tokenæ¢å–æ–°çš„ä»¤ç‰Œï¼›</li>
<li>åœ¨è·å–kçš„ä»¤ç‰Œæ—¶ï¼Œscopeåªèƒ½ä¸ºallã€aã€bã€cä¸­çš„æŸä¸ªå€¼ï¼Œå¦åˆ™å°†è·å–å¤±è´¥ï¼›</li>
<li>åœ¨è·å–kçš„ä»¤ç‰Œæ—¶ï¼Œåªèƒ½é€šè¿‡å¯†ç æ¨¡å¼ï¼ˆpasswordï¼‰å’Œåˆ·æ–°æ–¹å¼ï¼ˆrefresh_tokenï¼‰æ¥è·å–ä»¤ç‰Œã€‚</li>
</ol>
<p>æ³¨æ„ï¼Œè¿˜éœ€è¦ä¿®æ”¹ç™»å½•æˆåŠŸçš„å¤„ç†å™¨ï¼Œç”±äºclient_serectåŠ å¯†äº†ï¼Œæ‰€æœ‰åˆ¤æ–­é€»è¾‘ä¹Ÿéœ€è¦è°ƒæ•´ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticationSuccessHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 3. æ ¡éªŒClientIdå’ŒClientSecretçš„æ­£ç¡®æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (clientDetails == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnapprovedClientAuthenticationException(<span class="string">&quot;No client details was found for clientId &quot;</span> + clientId);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!passwordEncoder.matches(clientSecret, clientDetails.getClientSecret())) &#123; <span class="comment">// è¿™é‡Œè¿›è¡ŒåŠ å¯†åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnapprovedClientAuthenticationException(<span class="string">&quot;The client secret is invalid&quot;</span>);</span><br><span class="line">        &#125; </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œåˆ›å»ºèµ„æºæœåŠ¡å™¨<code>ResourceServerConfig</code>ï¼Œå¤„ç†ç™»å½•å¤±è´¥çš„é€»è¾‘ä¸å˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationSuccessHandler authenticationSuccessHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAuthenticationFailureHandler authenticationFailureHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.formLogin()                      <span class="comment">// è¡¨å•ç™»å½•</span></span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// å¤„ç†è¡¨å•ç™»å½•URL</span></span><br><span class="line">                .successHandler(authenticationSuccessHandler) <span class="comment">// å¤„ç†ç™»å½•æˆåŠŸ</span></span><br><span class="line">                .failureHandler(authenticationFailureHandler) <span class="comment">// å¤„ç†ç™»å½•å¤±è´¥</span></span><br><span class="line">        .and()</span><br><span class="line">                .authorizeRequests()                                <span class="comment">// æˆæƒé…ç½®</span></span><br><span class="line">                .anyRequest().authenticated()                       <span class="comment">// æ‰€æœ‰æ¥å£éƒ½éœ€è¦è®¤è¯</span></span><br><span class="line">        .and()</span><br><span class="line">                .csrf().disable() <span class="comment">// å…³é—­CSRFä¿æŠ¤</span></span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨å¯†ç æ¨¡å¼è·å–ä»¤ç‰Œï¼Œæ³¨æ„è¯·æ±‚å¤´ä¸­æ·»åŠ <code>Basic Base54(k:parak)</code>ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603162437693.png" class="" title="image-20210603162437693">

<p>å¯ä»¥çœ‹åˆ°<code>expires_in</code>æ˜¯æˆ‘ä»¬å®šä¹‰çš„3600ç§’ã€‚</p>
<p>æµ‹è¯•ä¸€ä¸‹å°†scopeæŒ‡å®šä¸ºkä¼šæœ‰ä»€ä¹ˆç»“æœï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603162742562.png" class="" title="image-20210603162742562">



<h3 id="8-2-è‡ªå®šä¹‰å­˜å‚¨redis"><a href="#8-2-è‡ªå®šä¹‰å­˜å‚¨redis" class="headerlink" title="8.2 è‡ªå®šä¹‰å­˜å‚¨redis"></a>8.2 è‡ªå®šä¹‰å­˜å‚¨redis</h3><p>é»˜è®¤ä»¤ç‰Œæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä¿å­˜åˆ°ç¬¬ä¸‰æ–¹å­˜å‚¨ä¸­ï¼Œæ¯”å¦‚redisã€‚</p>
<p>é¦–å…ˆåˆ›å»º<code>TokenStoreConfig</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisConnectionFactory redisConnectionFactory;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">redisTokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisTokenStore(redisConnectionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨è®¤è¯æœåŠ¡å™¨ä¸­è¿™ä¸ªæŒ‡å®šè¯¥å­˜å‚¨ç­–ç•¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Qualifier(&quot;redisTokenStore&quot;)</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TokenStore redisTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    endpoints.authenticationManager(authenticationManager)</span><br><span class="line">        .userDetailsService(userDetailsService)</span><br><span class="line">        .tokenStore(redisTokenStore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡å¯é¡¹ç›®è·å–ä»¤ç‰Œï¼ŒæŸ¥çœ‹redisä¸­æ˜¯å¦å­˜å‚¨äº†ä»¤ç‰Œç›¸å…³ä¿¡æ¯ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603164059407.png" class="" title="image-20210603164059407">

<p>å¯ä»¥çœ‹åˆ°ï¼Œä»¤ç‰Œä¿¡æ¯å·²ç»å­˜å‚¨åœ¨redisä¸­äº†ã€‚</p>
<h3 id="8-2-è‡ªå®šä¹‰ä»¤ç‰Œjwt"><a href="#8-2-è‡ªå®šä¹‰ä»¤ç‰Œjwt" class="headerlink" title="8.2 è‡ªå®šä¹‰ä»¤ç‰Œjwt"></a>8.2 è‡ªå®šä¹‰ä»¤ç‰Œjwt</h3><p>é»˜è®¤ä»¤ç‰Œåº”è¯¥å¾ˆå®¹æ˜“çœ‹å¾—å‡ºæ¥ï¼Œä½¿ç”¨UUIDç”Ÿäº§ï¼ŒJWTæ›¿æ¢é»˜è®¤ä»¤ç‰Œåªéœ€è¦æŒ‡å®š<code>TokenStore</code>ä¸º<code>JwtTokenStore</code>å³å¯ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ª<code>JWTokenConfig</code>é…ç½®ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTokenConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">jwtTokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter accessTokenConverter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        accessTokenConverter.setSigningKey(<span class="string">&quot;parak.top&quot;</span>); <span class="comment">// ç­¾åå¯†é’¥</span></span><br><span class="line">        <span class="keyword">return</span> accessTokenConverter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è®¤è¯æœåŠ¡å™¨ä¸­æŒ‡å®šï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Qualifier(&quot;jwtTokenStore&quot;)</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TokenStore jwtTokenStore;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    endpoints.authenticationManager(authenticationManager)</span><br><span class="line">        .userDetailsService(userDetailsService)</span><br><span class="line">        .tokenStore(jwtTokenStore)</span><br><span class="line">        .accessTokenConverter(jwtAccessTokenConverter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ååˆ›å»ºä¸€ä¸ªRESTæ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">index</span><span class="params">(<span class="meta">@AuthenticationPrincipal</span> Authentication authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> authentication;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡å¯æœåŠ¡å™¨ï¼Œè·å–ä»¤ç‰Œï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MjI3MTQyNTcsInVzZXJfbmFtZSI6IktoaWdobmVzcyIsImF1dGhvcml0aWVzIjpbImd1ZXN0Il0sImp0aSI6IjU1MWE2OGRkLTczMmItNDMxNi04ZjE5LTNhNTQ5NTk3NmQ0NCIsImNsaWVudF9pZCI6ImsiLCJzY29wZSI6WyJhbGwiXX0.WUstg6FB2SO3dzuRgI2igpGfP4oZqLPUnXFwuc8BU8E&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;token_type&quot;</span>: <span class="string">&quot;bearer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;refresh_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJLaGlnaG5lc3MiLCJzY29wZSI6WyJhbGwiXSwiYXRpIjoiNTUxYTY4ZGQtNzMyYi00MzE2LThmMTktM2E1NDk1OTc2ZDQ0IiwiZXhwIjoxNjIyNzk3MDU3LCJhdXRob3JpdGllcyI6WyJndWVzdCJdLCJqdGkiOiJlMDM4ZjJjMi1hYjk2LTRmODgtYWVlMy05ZmQyNjAwNGE0ZWUiLCJjbGllbnRfaWQiOiJrIn0.3ox9jwGs8jQzwItcPDJ5gv4G6pusYLTca8GHJJUjP5w&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;expires_in&quot;</span>: <span class="number">3599</span>,</span><br><span class="line">    <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;all&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;551a68dd-732b-4316-8f19-3a5495976d44&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†<code>access_token</code>ä¸­çš„å†…å®¹å¤åˆ¶åˆ°<a href="https://jwt.io/">jwtå®˜ç½‘</a>è¿›è¡Œè§£æï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603173223840.png" class="" title="image-20210603173223840">

<p>ç„¶åæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ª<code>access_token</code>è¯·æ±‚èµ„æºï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603173337645.png" class="" title="image-20210603173337645">

<p>æ­¤å¤–æˆ‘ä»¬è¿˜å¯ä»¥åœ¨jwtçš„åŸºç¡€ä¸Šè¿›è¡Œæ‹“å±•ï¼Œæ¯”å¦‚å¢åŠ ä¸€äº›è´Ÿè½½ï¼ˆåŒ…å«ä¸æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å®šä¹‰<code>JWTOkenEnhancer</code>å®ç°<code>TokenEnhancer</code>ï¼ˆTokenå¢å¼ºå™¨ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTokenEnhancer</span> <span class="keyword">implements</span> <span class="title">TokenEnhancer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">enhance</span><span class="params">(OAuth2AccessToken oAuth2AccessToken, OAuth2Authentication oAuth2Authentication)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; info = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        info.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Hello Khighness&quot;</span>);</span><br><span class="line">        ((DefaultOAuth2AccessToken) oAuth2AccessToken).setAdditionalInformation(info);</span><br><span class="line">        <span class="keyword">return</span> oAuth2AccessToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨Tokenä¸­æ·»åŠ äº†ä¿¡æ¯<code>message: Hello Khighness</code>ï¼Œç„¶ååœ¨<code>JWTokenConfig</code>ä¸­æ³¨å†Œè¯¥beanï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TokenEnhancer <span class="title">tokenEnhancer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JWTokenEnhancer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ååœ¨è®¤è¯æœåŠ¡å™¨ä¸­é…ç½®Tokenå¢å¼ºå™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Qualifier(&quot;jwtTokenStore&quot;)</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TokenStore jwtTokenStore;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class="line"><span class="meta">@Qualifier(&quot;jwTokenEnhancer&quot;)</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TokenEnhancer tokenEnhancer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    TokenEnhancerChain tokenEnhancerChain = <span class="keyword">new</span> TokenEnhancerChain();</span><br><span class="line">    List&lt;TokenEnhancer&gt; enhancerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    enhancerList.add(tokenEnhancer);</span><br><span class="line">    enhancerList.add(jwtAccessTokenConverter);</span><br><span class="line">    tokenEnhancerChain.setTokenEnhancers(enhancerList);</span><br><span class="line">    endpoints.authenticationManager(authenticationManager)</span><br><span class="line">        .userDetailsService(userDetailsService)</span><br><span class="line">        .tokenEnhancer(tokenEnhancerChain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡å¯é¡¹ç›®ï¼Œå†æ¬¡è·å–ä»¤ç‰Œï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;access_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJLaGlnaG5lc3MiLCJzY29wZSI6WyJhbGwiXSwiZXhwIjoxNjIyNzE3OTQ2LCJtZXNzYWdlIjoiSGVsbG8gS2hpZ2huZXNzIiwiYXV0aG9yaXRpZXMiOlsiYWRtaW4iXSwianRpIjoiYzQxYzI3ODItNDg5OS00ZDNjLTlmM2YtYjQ3YzNlNjNjYzU3IiwiY2xpZW50X2lkIjoiayJ9.TCrZOLP7cUFW1EjLgmk9xl75uv48bU3EUaNCn87ts1s&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;token_type&quot;</span>: <span class="string">&quot;bearer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;refresh_token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJLaGlnaG5lc3MiLCJzY29wZSI6WyJhbGwiXSwiYXRpIjoiYzQxYzI3ODItNDg5OS00ZDNjLTlmM2YtYjQ3YzNlNjNjYzU3IiwiZXhwIjoxNjIyODAwNzQ2LCJtZXNzYWdlIjoiSGVsbG8gS2hpZ2huZXNzIiwiYXV0aG9yaXRpZXMiOlsiYWRtaW4iXSwianRpIjoiOTU3MTc1MDgtZGRkYS00MzNhLWEzNjktMzc0MjAwYzQxNjQxIiwiY2xpZW50X2lkIjoiayJ9.2dSVNonOZRXtyc0YhQ-xk1QwYnrj16JzDBzhASiOD9E&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;expires_in&quot;</span>: <span class="number">3599</span>,</span><br><span class="line">    <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;all&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Hello Khighness&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;c41c2782-4899-4d3c-9f3f-b47c3e63cc57&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿”å›çš„jsonä¸­åŒ…å«äº†æˆ‘ä»¬æ·»åŠ çš„messageã€‚</p>
<p>ç„¶åæˆ‘ä»¬ä¿®æ”¹RESTæ¥å£ï¼Œå°†è¿”å›ç»“æœæ”¹ä¸ºJWTè§£æç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">index</span><span class="params">(<span class="meta">@AuthenticationPrincipal</span> Authentication authentication, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    String authorization = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">    String token = StringUtils.substringAfter(authorization, <span class="string">&quot;bearer&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Jwts.parser().setSigningKey(<span class="string">&quot;parak.top&quot;</span>.getBytes(StandardCharsets.UTF_8)).parseClaimsJws(token).getBody();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>signkey</code>éœ€è¦å’Œ<code>JwtAccessTokenConverter</code>ä¸­æŒ‡å®šçš„ç­¾åå¯†é’¥ä¸€ç›´ã€‚</p>
<p>é‡å¯é¡¹ç›®ï¼Œè·å–ä»¤ç‰Œè®¿é—®<code>/index</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;user_name&quot;</span>: <span class="string">&quot;Khighness&quot;</span>,</span><br><span class="line">    <span class="string">&quot;scope&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;all&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;exp&quot;</span>: <span class="number">1622718508</span>,</span><br><span class="line">    <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello Khighness&quot;</span>,</span><br><span class="line">    <span class="string">&quot;authorities&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;admin&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;jti&quot;</span>: <span class="string">&quot;a0653a55-5b63-4b8e-a95c-c9b81f3a575c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;client_id&quot;</span>: <span class="string">&quot;k&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-4-ä»¤ç‰Œåˆ·æ–°refresh-token"><a href="#8-4-ä»¤ç‰Œåˆ·æ–°refresh-token" class="headerlink" title="8.4 ä»¤ç‰Œåˆ·æ–°refresh_token"></a>8.4 ä»¤ç‰Œåˆ·æ–°refresh_token</h3><p><code>refresh_token</code>ï¼Œæ˜¯å››ç§æ ‡å‡†çš„OAuth2äº†ä»¤ç‰Œè·å–æ–¹å¼ä¹‹å¤–ï¼ŒSpring Security OAuth2å†…éƒ¨å®ç°çš„ä¸€ä¸­æ‹“å±•çš„è·å–ä»¤ç‰Œçš„æ–¹å¼ã€‚</p>
<p>å‡è®¾ç°åœ¨<code>access_token</code>è¿‡æœŸäº†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>refresh_token</code>å»æ¢å–æ–°çš„ä»¤ç‰Œï¼š</p>
<p>ä½¿ç”¨postmanå‘é€è¯·æ±‚ï¼Œéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œä»¤ç‰Œè·å–æ–¹å¼<code>grant_type</code>æŒ‡å®šä¸º<code>refresh_token</code>ï¼Œæ›´æ–°ä»¤ç‰Œ<code>refresh_token</code>è®¾ç½®ä¸ºä¸Šä¸€æ¬¡æœåŠ¡å™¨è¿”å›çš„<code>refresh_token</code>ã€‚å¦å¤–è¯·æ±‚å¤´ä¾ç„¶å¸¦ä¸Š<code>Basic BASE64(client_id:client_secret)</code>ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603182046137.png" class="" title="image-20210603182046137">



<h2 id="9-Spring-Security-OAuth2-SSO"><a href="#9-Spring-Security-OAuth2-SSO" class="headerlink" title="9. Spring Security OAuth2 SSO"></a>9. Spring Security OAuth2 SSO</h2><p>ğŸ“–æ¦‚è¿°</p>
<p>SSO(Single Sign On)ï¼Œå³å•ç‚¹ç™»å½•ï¼Œæ•ˆæœæ˜¯å¤šä¸ªç³»ç»Ÿé—´ï¼Œåªè¦ç™»å½•äº†å…¶ä¸­ä¸€ä¸ªç³»ç»Ÿï¼Œå…¶ä»–ç³»ç»Ÿä¹Ÿè‡ªåŠ¨ç™»å½•ã€‚</p>
<h3 id="9-1-æ¡†æ¶æ­å»º"><a href="#9-1-æ¡†æ¶æ­å»º" class="headerlink" title="9.1 æ¡†æ¶æ­å»º"></a>9.1 æ¡†æ¶æ­å»º</h3><p>æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªmavenå¤šæ¨¡å—é¡¹ç›®ï¼ŒåŒ…å«è®¤è¯æœåŠ¡å™¨å’Œä¸¤ä¸ªå®¢æˆ·ç«¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sso</span><br><span class="line">â”œâ”€â”€ sso-server   è®¤è¯æœåŠ¡å™¨</span><br><span class="line">â”œâ”€â”€ sso-app-one  å®¢æˆ·ç«¯1</span><br><span class="line">â””â”€â”€ sso-app-two  å®¢æˆ·ç«¯2</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆ›å»ºä¸‰ä¸ªmoduleï¼š</p>
<ul>
<li><code>sso-server</code>ï¼ˆ8080ï¼‰</li>
<li><code>sso-app-one</code>ï¼ˆ8081ï¼‰</li>
<li><code>sso-app-two</code>ï¼ˆ8082ï¼‰</li>
</ul>
<h3 id="9-2-è®¤è¯æœåŠ¡å™¨"><a href="#9-2-è®¤è¯æœåŠ¡å™¨" class="headerlink" title="9.2 è®¤è¯æœåŠ¡å™¨"></a>9.2 è®¤è¯æœåŠ¡å™¨</h3><p>è®¤è¯æœåŠ¡å™¨çš„ä½œç”¨å°±æ˜¯ä½œä¸ºç»Ÿä¸€ä»¤ç‰Œå‘æ”¾å¹¶æ ¡éªŒã€‚</p>
<p>é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/server</span></span><br></pre></td></tr></table></figure>

<p>æ–°å»ºä¸€ä¸ªSpring Securityé…ç½®ç±»<code>WebSecurityConfig</code>ï¼Œç»§æ‰¿<code>WebSecurityConfigurerAdpter</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.formLogin() <span class="comment">// è¡¨å•ç™»å½•</span></span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests().anyRequest().authenticated(); <span class="comment">// æ‰€æœ‰è¯·æ±‚éƒ½éœ€è®¤è¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€å®šä¹‰<code>UserDetailService</code>å®ç°è‡ªå®šä¹‰ç”¨æˆ·ç™»å½•é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        String password = passwordEncoder.encode(<span class="string">&quot;KAG1823&quot;</span>);</span><br><span class="line">        List&lt;GrantedAuthority&gt; authorityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(<span class="string">&quot;Khighness&quot;</span>, username)) &#123;</span><br><span class="line">            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username, password, authorityList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€ååˆ›å»º<code>SsoAuthorizationServerConfig</code>é…ç½®è®¤è¯æœåŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SsoAuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailService userDetailService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">jwtTokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter accessTokenConverter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        accessTokenConverter.setSigningKey(<span class="string">&quot;sso.parak.top&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> accessTokenConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.inMemory()</span><br><span class="line">                .withClient(<span class="string">&quot;app-one&quot;</span>)</span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">&quot;app-one-parak&quot;</span>))</span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>)</span><br><span class="line">                .accessTokenValiditySeconds(<span class="number">3600</span>)</span><br><span class="line">                .refreshTokenValiditySeconds(<span class="number">864000</span>)</span><br><span class="line">                .scopes(<span class="string">&quot;all&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>)</span><br><span class="line">                .redirectUris(<span class="string">&quot;http://127.0.0.1:8081/app-one/login&quot;</span>)</span><br><span class="line">            .and()</span><br><span class="line">                .withClient(<span class="string">&quot;app-two&quot;</span>)</span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">&quot;app-two-parak&quot;</span>))</span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>)</span><br><span class="line">                .accessTokenValiditySeconds(<span class="number">3600</span>)</span><br><span class="line">                .refreshTokenValiditySeconds(<span class="number">864000</span>)</span><br><span class="line">                .scopes(<span class="string">&quot;all&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;f&quot;</span>)</span><br><span class="line">                .redirectUris(<span class="string">&quot;http://127.0.0.1:8082/app-two/login&quot;</span>)</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        endpoints.userDetailsService(userDetailService)</span><br><span class="line">                .tokenStore(jwtTokenStore())</span><br><span class="line">                .accessTokenConverter(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        security.tokenKeyAccess(<span class="string">&quot;isAuthenticated()&quot;</span>); <span class="comment">// è·å–å¯†é’¥éœ€è¦è®¤è¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é…ç½®äº†ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œéƒ½å¯ä»¥ä½¿ç”¨æˆæƒç æ¨¡å¼æˆ–è€…ä»¤ç‰Œæ›´æ–°è·å–ä»¤ç‰Œã€‚</p>
<h3 id="9-3-å®¢æˆ·ç«¯é…ç½®"><a href="#9-3-å®¢æˆ·ç«¯é…ç½®" class="headerlink" title="9.3 å®¢æˆ·ç«¯é…ç½®"></a>9.3 å®¢æˆ·ç«¯é…ç½®</h3><p>ä¸¤ä¸ªå®¢æˆ·ç«¯çš„ä»£ç ä¸€è‡´ï¼Œæ‰€ä»¥åªä»‹ç»ä¸€ä¸ªï¼Œ<code>sso-app-one</code>ã€‚</p>
<p>å®¢æˆ·ç«¯çš„SpringBootå¯åŠ¨ç±»ä¸Šæ·»åŠ <code>@EnableOAuth2Sso</code>æ³¨è§£ï¼Œå¼€å¯SSOçš„æ”¯æŒï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@EnableOAuth2Sso</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SsoOneApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SsoOneApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹åœ¨äºé…ç½®ï¼Œä¸¤ä¸ªå®¢æˆ·ç«¯çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sso-app-one</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/app-one</span></span><br><span class="line"></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">oauth2:</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="string">app-one</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">app-one-parak</span></span><br><span class="line">      <span class="attr">user-authorization-uri:</span> <span class="string">http://127.0.0.1:8080/server/oauth/authorize</span></span><br><span class="line">      <span class="attr">access-token-uri:</span> <span class="string">http://127.0.0.1:8080/server/oauth/token</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">jwt:</span></span><br><span class="line">        <span class="attr">key-uri:</span> <span class="string">http://127.0.0.1:8080/server/oauth/token_key</span></span><br><span class="line"></span><br><span class="line"><span class="string">sso-app-two</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/app-two</span></span><br><span class="line"></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">oauth2:</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="string">app-two</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="string">app-two-parak</span></span><br><span class="line">      <span class="attr">user-authorization-uri:</span> <span class="string">http://127.0.0.1:8080/server/oauth/authorize</span></span><br><span class="line">      <span class="attr">access-token-uri:</span> <span class="string">http://127.0.0.1:8080/server/oauth/token</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">jwt:</span></span><br><span class="line">        <span class="attr">key-uri:</span> <span class="string">http://127.0.0.1:8080/server/oauth/token_key</span></span><br></pre></td></tr></table></figure>

<p><code>security.oauth2.client.client-id</code>å’Œ<code>security.oauth2.client.client-secret</code>æŒ‡å®šäº†å®¢æˆ·ç«¯idå’Œå¯†ç ï¼Œ<code>user-authorization-uri</code>æŒ‡å®šäº†è®¤è¯æœåŠ¡å™¨çš„<code>/oauth/authorize</code>æˆæƒåœ°å€ï¼Œ<code>access-token-uri</code>æŒ‡å®šäº†è®¤è¯æœåŠ¡å™¨çš„<code>/oauth/token</code>ä»¤ç‰Œå‘æ”¾åœ°å€ï¼Œ<code>jwt.key-uri</code>æŒ‡å®šäº†è®¤è¯æœåŠ¡å™¨çš„<code>/oauth/token_key</code>åœ°å€ã€‚</p>
<p>æ¥ç€åœ¨<code>resources/static</code>ä¸‹æ–°å¢ä¸€ä¸ªindex.htmlé¡µé¢ï¼Œç”¨äºè·³è½¬åˆ°å¦ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¸‹é¢æ˜¯<code>sso-app-one</code>çš„é¡µé¢ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>app-1<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>app-1<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://127.0.0.1:8082/app-two/index.html&quot;</span>&gt;</span>go to app-2<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æœ€åå†™ä¸€ä¸ªRESTæ¥å£<code>UserController</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/principal&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Principal <span class="title">principal</span><span class="params">(Principal principal)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> principal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="9-4-æµ‹è¯•æ•ˆæœ"><a href="#9-4-æµ‹è¯•æ•ˆæœ" class="headerlink" title="9.4 æµ‹è¯•æ•ˆæœ"></a>9.4 æµ‹è¯•æ•ˆæœ</h3><p>é¦–å…ˆå¯åŠ¨<code>sso-server</code>ï¼Œç„¶åå¯åŠ¨<code>sso-app-one</code>ï¼Œæœ€åå¯åŠ¨<code>sso-app-two</code>ã€‚</p>
<p>è®¿é—®ï¼š<a href="http://127.0.0.1:8081/app-one/index.html">http://127.0.0.1:8081/app-one/index.html</a></p>
<p>è·³è½¬åˆ°å¦‚ä¸‹ç•Œé¢ï¼Œè¾“å…¥ä»»æ„ç”¨æˆ·åå’Œå¯†ç KAG1823ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603205325874.png" class="" title="image-20210603205325874">

<p>ç‚¹å‡»Sign in/Enterï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603205359505.png" class="" title="image-20210603205359505">

<p>ç‚¹å‡»Authorizeï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603205445140.png" class="" title="image-20210603205445140">

<p>è¿™æ—¶å€™app-oneç™»å½•æˆåŠŸï¼Œç‚¹å‡»go to app-2ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603205511526.png" class="" title="image-20210603205511526">

<p>ç‚¹å‡»Authorizeï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603205554118.png" class="" title="image-20210603205554118">

<p>å¯ä»¥çœ‹åˆ°app-twoä¹Ÿç™»å½•æˆåŠŸã€‚</p>
<p>æµ‹è¯•ä¸€ä¸‹èµ„æºï¼Œè®¿é—®ï¼š<a href="http://127.0.0.1:8082/app-two/principle">http://127.0.0.1:8082/app-two/principle</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603215049751.png" class="" title="image-20210603215049751">

<p>æˆåŠŸè·å–åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡éƒ½éœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»Authorizeæˆæƒï¼Œä½“éªŒä¸æ˜¯å¾ˆå¥½ã€‚ä¿®æ”¹è®¤è¯æœåŠ¡å™¨clienté…ç½®ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">clients.inMemory()</span><br><span class="line">    .withClient(<span class="string">&quot;app-one&quot;</span>)</span><br><span class="line">    ...</span><br><span class="line">    .autoApprove(<span class="keyword">true</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p><code>autoApprove(true)</code>å®ç°è‡ªåŠ¨æˆæƒã€‚</p>
<h3 id="9-5-æƒé™æ ¡éªŒ"><a href="#9-5-æƒé™æ ¡éªŒ" class="headerlink" title="9.5 æƒé™æ ¡éªŒ"></a>9.5 æƒé™æ ¡éªŒ</h3><p>åœ¨å•ç‚¹ç™»å½•æ¨¡å¼ä¸‹è¿›è¡Œæƒé™æ ¡éªŒï¼Œåªéœ€è¦ä¿®æ”¹å®¢æˆ·ç«¯ã€‚</p>
<p>åœ¨å®¢æˆ·ç«¯æ–°å¢Spring Securityé…ç½®ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å®¢æˆ·ç«¯çš„RESTæ¥å£ä¸­æ·»åŠ æ¥å£ç”¨äºæµ‹è¯•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/write&quot;)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;admin&#x27;)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;æ‚¨æ‹¥æœ‰writeæƒé™ï¼&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/read&quot;)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;guest&#x27;)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;æ‚¨æ‹¥æœ‰readæƒé™ï¼&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®¡ç†å‘˜åªæ‹¥æœ‰å†™æƒé™ï¼Œè®¿å®¢åªæœ‰è¯»æƒé™ã€‚</p>
<p>é‡å¯é¡¹ç›®ï¼Œä½¿ç”¨Khighnessï¼ˆadminï¼‰ç™»å½•app-one</p>
<p>æµ‹è¯•è®¿é—®å†™æ¥å£ï¼š<a href="http://127.0.0.1:8081/app-one/write">http://127.0.0.1:8081/app-one/write</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603221146634.png" class="" title="image-20210603221146634">

<p>æµ‹è¯•è®¿é—®è¯»æ¥å£ï¼š<a href="http://127.0.0.1:8081/app-one/read">http://127.0.0.1:8081/app-one/read</a></p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/52913/image-20210603221207266.png" class="" title="image-20210603221207266">

<p>è¿”å›403ï¼Œæ— æƒé™ï¼Œè¯´æ˜æ³¨è§£ç”Ÿæ•ˆã€‚</p>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>spring-security-oauth2</tag>
      </tags>
  </entry>
  <entry>
    <title>Netty</title>
    <url>/posts/1c6ba3e2/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-IO"><a href="#1-IO" class="headerlink" title="1 IO"></a>1 IO</h2><h3 id="1-1-BIO"><a href="#1-1-BIO" class="headerlink" title="1.1 BIO"></a>1.1 BIO</h3><h4 id="1-1-1-ä»‹ç»"><a href="#1-1-1-ä»‹ç»" class="headerlink" title="1.1.1 ä»‹ç»"></a>1.1.1 ä»‹ç»</h4><ul>
<li>Java BIOå°±æ˜¯ä¼ ç»Ÿçš„Java IOç¼–ç¨‹ï¼Œç›¸å…³APIéƒ½åœ¨<code>java.io</code></li>
<li>BIO (<strong>blocking I/O</strong>)ï¼š<strong>åŒæ­¥å¹¶é˜»å¡</strong>ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå³æœ‰è¿æ¥è¯·æ±‚æ—¶æœåŠ¡å™¨å°±éœ€è¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¦‚æœè¿™ä¸ªè¿æ¥ä¸åšä»»ä½•äº‹æƒ…ä¼šé€ æˆä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€</li>
<li>BIOæ–¹å¼é€‚ç”¨äºè¿æ¥æ•°ç›®è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œè¿™ç§æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼ŒJDK1.4ä»¥å‰çš„å”¯ä¸€é€‰æ‹©</li>
</ul>
<h4 id="1-1-2-å®ä¾‹"><a href="#1-1-2-å®ä¾‹" class="headerlink" title="1.1.2 å®ä¾‹"></a>1.1.2 å®ä¾‹</h4><blockquote>
<p>BIOæœåŠ¡å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>  KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/9/13 11:07</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> : BIOæœåŠ¡å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BIOServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = Logger.getLogger(BIOServer.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * çº¿ç¨‹æ± æœºåˆ¶</span></span><br><span class="line"><span class="comment">         * æ€è·¯</span></span><br><span class="line"><span class="comment">         * 1ã€åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± </span></span><br><span class="line"><span class="comment">         * 2ã€å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ± è”æœºå‘ƒï¼Œå°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ä¹‹é€šè®¯</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        ExecutorService newCachedThreadPool = Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">// åˆ›å»ºServerSocket</span></span><br><span class="line">        ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">3333</span>);</span><br><span class="line">        log.info(<span class="string">&quot;NIOæœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ï¼š3333&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// ç›‘å¬ï¼Œç­‰å¾…å®¢æˆ·ç«¯æ¥å—</span></span><br><span class="line">            <span class="keyword">final</span> Socket socket = serverSocket.accept();</span><br><span class="line">            log.info(<span class="string">&quot;æ–°å¢å®¢æˆ·ç«¯è¿æ¥ï¼š&quot;</span> + socket.getInetAddress());</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ä¹‹é€šè®¯</span></span><br><span class="line">            newCachedThreadPool.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    handler(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * handlerï¼Œå’Œå®¢æˆ·ç«¯é€šè®¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handler</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="comment">// é€šè¿‡socketè·å–è¾“å…¥æµ</span></span><br><span class="line">            InputStream inputStream = socket.getInputStream();</span><br><span class="line">            <span class="comment">// å¾ªç¯è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// è¾“å‡ºçº¿ç¨‹ä¿¡æ¯</span></span><br><span class="line">                log.info(<span class="string">&quot;çº¿ç¨‹ä¿¡æ¯ï¼šã€PID = &quot;</span> + Thread.currentThread().getId() + <span class="string">&quot;, Name = &quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;ã€&quot;</span>);</span><br><span class="line">                <span class="keyword">int</span> read = inputStream.read(bytes);</span><br><span class="line">                <span class="keyword">if</span> (read != -<span class="number">1</span>) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;å®¢æˆ·ç«¯&quot;</span> + socket.getRemoteSocketAddress() + <span class="string">&quot;ï¼š&quot;</span> + <span class="keyword">new</span> String(bytes, <span class="number">0</span>, read));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;å…³é—­ä¸å®¢æˆ·ç«¯çš„è¿æ¥&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> BIOServer().start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-1-3-è¿è¡Œ"><a href="#1-1-3-è¿è¡Œ" class="headerlink" title="1.1.3 è¿è¡Œ"></a>1.1.3 è¿è¡Œ</h4><p>Windowsé…ç½®ï¼šæ§åˆ¶é¢æ¿ -&gt; ç¨‹åº -&gt; å¯ç”¨æˆ–è€…å…³é—­WindowsåŠŸèƒ½ï¼Œå‹¾é€‰Telnet Clientã€‚</p>
<p>å¯åŠ¨æœåŠ¡å™¨ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-06</span><span class="literal">-05</span> <span class="number">17</span>:<span class="number">14</span>:<span class="number">56.456</span> KAG INFO  [<span class="type">com.kag.bio.BIOServer</span>] - NIOæœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ï¼š<span class="number">3333</span></span><br></pre></td></tr></table></figure>

<p>å¼€å¯cmdï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">telnet 127.0.0.1 6666</span><br></pre></td></tr></table></figure>

<p>åŒæ—¶æŒ‰ä¸‹<code>ctrl</code> + <code>]</code>ï¼Œå‘é€æ¶ˆæ¯ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200913120406689.png" class="" title="image-20200913120406689">

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200913122028056.png" class="" title="image-20200913122028056">



<h4 id="1-1-4-ä¸è¶³"><a href="#1-1-4-ä¸è¶³" class="headerlink" title="1.1.4 ä¸è¶³"></a>1.1.4 ä¸è¶³</h4><p>1ï¼‰æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦åˆ›å»ºç‹¬ç«‹çš„çº¿ç¨‹ï¼Œä¸å¯¹åº”çš„å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®Readï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ®Write</p>
<p>2ï¼‰å½“å¹¶å‘æ•°è¾ƒå¤§æ—¶ï¼Œéœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹æ¥å¤„ç†è¿æ¥ï¼Œç³»ç»Ÿèµ„æºå ç”¨è¾ƒå¤§</p>
<p>3ï¼‰è¿æ¥å»ºç«‹åï¼Œå¦‚æœå½“å½“å‰çº¿ç¨‹æš‚å­˜æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™çº¿ç¨‹å°±é˜»å¡åœ¨Readä¸Šï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹</p>
<h3 id="1-2-NIO"><a href="#1-2-NIO" class="headerlink" title="1.2 NIO"></a>1.2 NIO</h3><h4 id="1-2-1-ä»‹ç»"><a href="#1-2-1-ä»‹ç»" class="headerlink" title="1.2.1 ä»‹ç»"></a>1.2.1 ä»‹ç»</h4><ul>
<li>Java NIO å…¨ç§° <strong>java non-blocking IO</strong>ï¼Œæ˜¯æŒ‡JDKæä¾›çš„æ ¸å¿ƒAPIï¼Œæ˜¯<strong>åŒæ­¥éé˜»å¡</strong>çš„ã€‚</li>
<li>NIO ç›¸å…³ç±»éƒ½è¢«æ”¾åœ¨ java.nioåŒ…åŠå­åŒ…ä¸‹ï¼Œå¹¶ä¸”å¯¹åŸ java.ioåŒ…ä¸­çš„å¾ˆå¤šç±»è¿›è¡Œæ”¹å†™</li>
<li>NIO ä¸‰å¤§æ ¸å¿ƒéƒ¨åˆ†ï¼š<u>Channel</u>(é€šé“)ã€<u>Buffer</u>(ç¼“å†²åŒº)ã€<u>Selector</u>(é€‰æ‹©å™¨)</li>
<li>NIO æ˜¯é¢å‘ç¼“å†²åŒºæˆ–è€…é¢å‘å—ç¼–ç¨‹çš„ã€‚æ•°æ®è¯»å–åˆ°ä¸€ä¸ªå®ƒç¨åå¤„ç†çš„ç¼“å†²åŒºï¼Œéœ€è¦æ—¶å¯åœ¨ç¼“å†²åŒºå‰åç§»åŠ¨ï¼Œè¿™å°±å¢åŠ å¤„ç†è¿‡ç¨‹ä¸­çš„çµæ´»æ€§ï¼Œä½¿ç”¨å®ƒå¯ä»¥æä¾›éé˜»å¡çš„é«˜ä¼¸ç¼©æ€§ç½‘ç»œ</li>
</ul>
<h4 id="1-2-2-æ¯”è¾ƒ"><a href="#1-2-2-æ¯”è¾ƒ" class="headerlink" title="1.2.2 æ¯”è¾ƒ"></a>1.2.2 æ¯”è¾ƒ</h4><blockquote>
<p><code>BIO</code> VS <code>NIO</code></p>
</blockquote>
<ul>
<li><p>BIOä»¥æµçš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œè€ŒNIOä»¥å—çš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œå—I/Oçš„æ•ˆç‡æ¯”æµI/Oé«˜å¾ˆå¤š</p>
</li>
<li><p>BIOæ˜¯é˜»å¡çš„ï¼ŒNIOåˆ™æ˜¯éé˜»å¡çš„</p>
</li>
<li><p>BIOåŸºäºå­—èŠ‚æµå’Œå­—ç¬¦æµè¿›è¡Œæ“ä½œï¼Œè€ŒNIOåŸºäº<code>Channel</code>(é€šé“)å’Œ<code>Buffer</code>(ç¼“å†²åŒº)è¿›è¡Œæ“ä½œï¼Œæ•°æ®æ€»æ˜¯ä»é€šé“è¯»å–åˆ°ç¼“å†²åŒºä¸­ï¼Œæˆ–è€…ä»ç¼“å†²åŒºå†™å…¥åˆ°é€šé“ä¸­ã€‚<code>Selectors</code>(é€‰æ‹©å™¨)ç”¨äºç›‘å¬å¤šä¸ªé€šé“çš„äº‹ä»¶ï¼ˆæ¯”å¦‚ï¼šè¿æ¥è¯·æ±‚ã€æ•°æ®åˆ°è¾¾ç­‰ï¼‰ï¼Œå› æ­¤ä½¿ç”¨å•ä¸ªçº¿ç¨‹å°±å¯ä»¥ç›‘å¬å¤šä¸ªå®¢æˆ·ç«¯é€šé“</p>
</li>
</ul>
<h4 id="1-2-3-ç»„ä»¶"><a href="#1-2-3-ç»„ä»¶" class="headerlink" title="1.2.3 ç»„ä»¶"></a>1.2.3 ç»„ä»¶</h4><p>ä¸‰å¤§ç»„ä»¶ï¼š<code>Selector</code>ã€<code>Channel</code>å’Œ<code>Buffer</code></p>
<blockquote>
<p>å…³ç³»å›¾</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/NIO.png" class="" title="NIO">

<br>

<blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li>æ¯ä¸ª<code>channel</code>éƒ½ä¼šå¯¹åº”ä¸€ä¸ª<code>Buffer</code></li>
<li><code>Selector</code>å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”å¤šä¸ª<code>channel</code></li>
<li>è¯¥å›¾ååº”æœ‰ä¸‰ä¸ª<code>channel</code>æ³¨å†Œåˆ°äº†è¯¥<code>Selector</code>ç¨‹åº</li>
<li>ç¨‹åºåˆ‡æ¢åˆ°å“ªä¸ª<code>channel</code>æ˜¯æœ‰äº‹ä»¶å†³å®šçš„ï¼Œ<code>Event</code>å°±æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µ</li>
<li><code>Selector</code>ä¼šæ ¹æ®ä¸åŒçš„äº‹ä»¶ï¼Œåœ¨å„ä¸ªé€šé“ä¸Šåˆ‡æ¢</li>
<li><code>Buffer</code>å°±æ˜¯ä¸€ä¸ªå†…å­˜å—ï¼Œåº•å±‚æ˜¯æœ‰ä¸€ä¸ªæ•°ç»„</li>
<li>æ•°æ®çš„è¯»å–å†™å…¥éƒ½é€šè¿‡<code>Buffer</code>ï¼Œè¿™ä¸ªå’ŒBIOä¸åŒã€‚BIOè¦ä¹ˆæ˜¯è¾“å…¥æµï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºæµï¼Œä¸èƒ½åŒå‘ï¼Œä½†æ˜¯NIOçš„<code>buffer</code>æ˜¯å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ï¼Œéœ€è¦<code>flip</code>æ–¹æ³•åˆ‡æ¢</li>
<li><code>channel</code>æ˜¯åŒå‘çš„ï¼Œå¯ä»¥è¿”å›åº•å±‚æ“ä½œç³»ç»Ÿçš„æƒ…å†µï¼Œæ¯”å¦‚<code>Linux</code>ï¼Œåº•å±‚çš„æ“ä½œç³»ç»Ÿé€šé“å°±æ˜¯åŒå‘çš„</li>
</ul>
<h5 id="1-2-3-1-Buffer"><a href="#1-2-3-1-Buffer" class="headerlink" title="1.2.3.1 Buffer"></a>1.2.3.1 Buffer</h5><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>ç¼“å†²åŒºï¼šç¼“å†²åŒºæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯ä»¥è¯»å†™æ•°æ®çš„å†…å­˜å—</p>
<blockquote>
<p>å¸¸ç”¨Bufferå­ç±»ï¼š</p>
</blockquote>
<ul>
<li>ByteBuffer</li>
<li>ShortBuffer</li>
<li>CharBuffer</li>
<li>IntBuffer</li>
<li>LongBuffer</li>
<li>DoubleBuffer</li>
<li>FloatBuffer</li>
</ul>
<blockquote>
<p>Bufferç±»å®šä¹‰äº†æ‰€æœ‰çš„ç¼“å†²åŒºéƒ½å…·æœ‰çš„å››ä¸ªå±æ€§æ¥æä¾›å…³äºå…¶æ‰€åŒ…å«çš„æ•°æ®å…ƒç´ </p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å±æ€§</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Capacity</td>
<td align="center">å®¹é‡ï¼Œçº§å¯ä»¥å®¹çº³çš„æœ€å¤§æ•°æ®é‡ï¼›åœ¨ç¼“å†²åŒºåˆ›å»ºæ—¶è¢«è®¾å®šä¸”ä¸èƒ½æ”¹å˜</td>
</tr>
<tr>
<td align="center">Limit</td>
<td align="center">è¡¨ç¤ºç¼“å†²åŒºçš„å½“å‰é‡ç‚¹ï¼Œä¸èƒ½å¯¹ç¼“å†²åŒºè¶…è¿‡æé™çš„ä½ç½®è¿›è¡Œè¯»å†™æ“ä½œï¼Œä¸”æé™æ˜¯å¯ä»¥ä¿®æ”¹çš„</td>
</tr>
<tr>
<td align="center">Position</td>
<td align="center">ä½ç½®ï¼Œä¸‹ä¸€ä¸ªè¦è¢«è¯»æˆ–å†™çš„å…ƒç´ çš„ç´¢å¼•ï¼Œæ¯æ¬¡è¯»å†™ç¼“å†²åŒºæ•°æ®æ—¶éƒ½ä¼šæ”¹å˜çš„å€¼ï¼Œä¸ºä¸‹æ¬¡è¯»å†™ä½œå‡†å¤‡</td>
</tr>
<tr>
<td align="center">Mark</td>
<td align="center">æ ‡è®°</td>
</tr>
</tbody></table>
<blockquote>
<p>mark &lt;= position &lt;= limit &lt;= capacity</p>
</blockquote>
<h5 id="1-2-3-2-Channel"><a href="#1-2-3-2-Channel" class="headerlink" title="1.2.3.2 Channel"></a>1.2.3.2 Channel</h5><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>é€šé“ï¼šNIOçš„é€šé“ç±»ä¼¼äºæµï¼Œä½†æœ‰äº›åŒºåˆ«</p>
<ul>
<li>é€šé“å¯ä»¥åŒæ—¶è¿›è¡Œè¯»å†™ï¼Œè€Œæµåªèƒ½è¯»æˆ–è€…åªèƒ½å†™</li>
<li>é€šé“å¯ä»¥å®ç°å¼‚æ­¥è¯»å†™æ•°æ®</li>
<li>é€šé“å¯ä»¥ä»ç¼“å†²è¯»æ•°æ®ï¼Œä¹Ÿå¯ä»¥å†™æ•°æ®åˆ°ç¼“å†²</li>
</ul>
<blockquote>
<p> å¸¸ç”¨çš„Channelç±»ï¼š</p>
</blockquote>
<ul>
<li>FileChannel                      â”â”â”â”â”â–¶          æ–‡ä»¶çš„æ•°æ®è¯»å†™</li>
<li>DatagramChannel            â”â”â”â”â”â–¶          UDPçš„æ•°æ®è¯»å†™</li>
<li>ServerSocketChannel      â”â”â”â”â”â–¶          TCPçš„æ•°æ®è¯»å†™</li>
<li>SocketChannel                 â”â”â”â”â”â–¶          TCPçš„æ•°æ®è¯»å†™</li>
</ul>
<blockquote>
<p>FileChannelçš„ä¸»è¦IOæ“ä½œ</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public int read(ByteBuffer dst)</td>
<td align="center">ä»é€šé“è¯»å–æ•°æ®å¹¶æ”¾åˆ°ç¼“å†²åŒºä¸­</td>
</tr>
<tr>
<td align="center">public int write(ByteBuffer src)</td>
<td align="center">æŠŠç¼“å†²åŒºçš„æ•°æ®å†™åˆ°é€šé“ä¸­</td>
</tr>
<tr>
<td align="center">public long transferFrom(ReadableByteChannel src, long position, long count)</td>
<td align="center">ä»ç›®æ ‡é€šé“ä¸­å¤åˆ¶æ•°æ®åˆ°å½“å‰é€šé“</td>
</tr>
<tr>
<td align="center">public long transferTo(long position, long count, WritableByteChannel target)</td>
<td align="center">æŠŠæ•°æ®ä»å½“å‰é€šé“å¤åˆ¶ç»™ç›®æ ‡é€šé“</td>
</tr>
</tbody></table>
<h5 id="1-2-3-3-Selector"><a href="#1-2-3-3-Selector" class="headerlink" title="1.2.3.3 Selector"></a>1.2.3.3 Selector</h5><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>é€‰æ‹©å™¨ï¼š</p>
<ul>
<li>Javaçš„NIOï¼Œç”¨éé˜»å¡çš„IOæ–¹å¼ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤„ç†å¤šä¸ªçš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå°±ä¼šä½¿ç”¨åˆ°<code>Selector</code></li>
<li><code>Selector</code>èƒ½å¤Ÿæ£€æµ‹å¤šä¸ªæ³¨å†Œçš„é€šé“ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼ˆå¤šä¸ª<code>Channel</code>ä»¥äº‹ä»¶çš„æ–¹å¼å¯ä»¥æ³¨å†Œåˆ°åŒä¸€ä¸ª<code>Selector</code>ï¼‰ï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œä¾¿è·å–äº‹ä»¶ç„¶åé’ˆå¯¹æ¯ä¸ªäº‹ä»¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¿™æ ·å°±å¯ä»¥åªç”¨ä¸€ä¸ªå•çº¿ç¨‹å»ç®¡ç†å¤šä¸ªé€šé“ï¼Œä¹Ÿå°±æ˜¯ç®¡ç†å¤šä¸ªè¿æ¥å’Œè¯·æ±‚</li>
<li>åªæœ‰åœ¨è¿æ¥çœŸæ­£æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰ä¼šè¿›è¡Œè¯»å†™ï¼Œå°±å¤§å¤§åœ°å‡å°‘äº†ç³»ç»Ÿå¼€é”€ï¼Œå¹¶ä¸”ä¸å¿…ä¸ºæ¯ä¸ªè¿æ¥éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹</li>
<li>é¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´çš„å¼€é”€</li>
</ul>
<blockquote>
<p>ç±»åŠç›¸å…³æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Class | Method</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public abstract class Selector implements Closeable</td>
<td align="center">æŠ½è±¡ç±»</td>
</tr>
<tr>
<td align="center">public static Selector open()</td>
<td align="center">å¾—åˆ°ä¸€ä¸ªé€‰æ‹©å™¨å¯¹è±¡</td>
</tr>
<tr>
<td align="center">public int select(long timeout)</td>
<td align="center">ç›‘æ§æ‰€æœ‰æ³¨å†Œçš„é€šé“ï¼Œå‚æ•°ç”¨æ¥è®¾ç½®è¶…æ—¶æ—¶é—´</td>
</tr>
<tr>
<td align="center">public Set<SelectionKey> selectedKeys()</td>
<td align="center">ä»å†…éƒ¨é›†åˆä¸­å¾—åˆ°æ‰€æœ‰çš„SelectionKeâ€™y</td>
</tr>
</tbody></table>
<blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li>å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œä¼šé€šè¿‡<code>ServerSocketChannel</code>å¾—åˆ°<code>SocketChannel</code></li>
<li>å°†<code>SocketChannel</code>æ³¨å†Œåˆ°<code>Selector</code>ä¸Šï¼Œæ³¨å†Œåè¿”å›ä¸€ä¸ª<code>SelectionKey</code></li>
<li><code>Selector</code>è¿›è¡Œç›‘å¬<code>select</code>æ–¹æ³•ï¼Œè¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„é€šé“çš„ä¸ªæ•°</li>
<li>è¿›ä¸€æ­¥å¾—åˆ°å„ä¸ª<code>SelectionKey</code></li>
<li>åœ¨é€šé“<code>SelectionKey</code>åå‘è·å–<code>SocketChannel</code>ï¼Œæ–¹æ³•<code>channel()</code></li>
<li>å¯ä»¥å¾—åˆ°æ‰€æœ‰çš„<code>channel</code>ï¼Œå®Œæˆä¸šåŠ¡å¤„ç†</li>
</ul>
<h4 id="1-2-3-ç¼–ç¨‹"><a href="#1-2-3-ç¼–ç¨‹" class="headerlink" title="1.2.3 ç¼–ç¨‹"></a>1.2.3 ç¼–ç¨‹</h4><blockquote>
<p>å°†æ•°æ®å†™å…¥åˆ°æœ¬åœ°æ–‡ä»¶</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºè¾“å‡ºæµ â€”â€”&gt; channel</span></span><br><span class="line">    FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;D:\\Java\\Test\\K1.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡ fileOutputStream è·å– å¯¹åº”çš„ FileChannel</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ª fileChannel çœŸå®ç±»å‹æ˜¯  FileChannelImpl</span></span><br><span class="line">    FileChannel fileChannel = fileOutputStream.getChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªç¼“å†²åŒº ByteBuffer</span></span><br><span class="line">    ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† s æ”¾å…¥ byteBuffer</span></span><br><span class="line">    byteBuffer.put(s.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹ byteBuffer è¿›è¡Œflip</span></span><br><span class="line">    byteBuffer.flip();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† byteBuffer æ•°æ®å†™å…¥åˆ° fileChannel</span></span><br><span class="line">    fileChannel.write(byteBuffer);</span><br><span class="line">    fileOutputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä»æœ¬åœ°æ–‡ä»¶è¯»å–æ•°æ®</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(String path)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–‡ä»¶çš„è¾“å…¥æµ</span></span><br><span class="line">    File file = <span class="keyword">new</span> File(path);</span><br><span class="line">    FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡ fileInputStream è·å–å¯¹åº”çš„ FileChannel â€”â€”&gt;  å®é™…ç±»å‹ FileChannelImpl</span></span><br><span class="line">    FileChannel fileChannel = fileInputStream.getChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºByteBuffer</span></span><br><span class="line">    ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† é€šé“çš„æ•°æ® è¯»å…¥åˆ° Buffer</span></span><br><span class="line">    fileChannel.read(byteBuffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†byteBufferçš„å­—èŠ‚æ•°æ®è½¬æˆå­—ç¬¦ä¸²</span></span><br><span class="line">    System.out.println(<span class="keyword">new</span> String(byteBuffer.array()));</span><br><span class="line">    fileInputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ‹·è´æ–‡ä»¶</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(String source, String destination)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(source);</span><br><span class="line">    FileChannel fileChannel1 = fileInputStream.getChannel();</span><br><span class="line"></span><br><span class="line">    FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(destination);</span><br><span class="line">    FileChannel fileChannel2 = fileOutputStream.getChannel();</span><br><span class="line"></span><br><span class="line">    ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="comment">// å¤ä½ï¼Œé‡ç½®æ ‡å¿—ä½</span></span><br><span class="line">        byteBuffer.clear();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> read = fileChannel1.read(byteBuffer);</span><br><span class="line">        <span class="keyword">if</span> (read == -<span class="number">1</span>) &#123;<span class="comment">// è¡¨ç¤ºè¯»å®Œ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°†bufferä¸­çš„æ•°æ®å†™å…¥åˆ°fileChannel02 -- K2.txt</span></span><br><span class="line">        byteBuffer.flip();</span><br><span class="line">        fileChannel2.write(byteBuffer);</span><br><span class="line">    &#125;</span><br><span class="line">    fileOutputStream.close();</span><br><span class="line">    fileInputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä½¿ç”¨transferFromå®Œæˆæ‹·è´</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyImage</span><span class="params">(String fromPath, String toPath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç›¸å…³æµ</span></span><br><span class="line">    FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(fromPath);</span><br><span class="line">    FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(toPath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–Channel</span></span><br><span class="line">    FileChannel sourceChannel = fileInputStream.getChannel();</span><br><span class="line">    FileChannel destinChannel = fileOutputStream.getChannel();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨transferFromå®Œæˆæ‹·è´</span></span><br><span class="line">    destinChannel.transferFrom(sourceChannel, <span class="number">0</span>, sourceChannel.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­ç›¸å…³æµ</span></span><br><span class="line">    sourceChannel.close();</span><br><span class="line">    destinChannel.close();</span><br><span class="line">    fileInputStream.close();</span><br><span class="line">    fileOutputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>bufferæ•°ç»„å®Œæˆè¯»å†™æ“ä½œ</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Scattering: å°†æ•°æ®å†™å…¥åˆ°bufferæ—¶ï¼Œå¯ä»¥é‡‡ç”¨bufferæ•°ç»„ï¼Œä¾æ¬¡å†™å…¥[åˆ†æ•£]</span></span><br><span class="line"><span class="comment">// Gathering: ä»bufferè¯»å–æ•°æ®æ—¶ï¼Œå¯ä»¥é‡‡ç”¨bufferæ•°ç»„ï¼Œä¾æ¬¡è¯»å–[èšé›†]</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">demo</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ServerSocketChannel å’Œ SocketChannel ç½‘ç»œ</span></span><br><span class="line">    ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line">    InetSocketAddress inetSocketAddress = <span class="keyword">new</span> InetSocketAddress(<span class="number">7000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‘å®šç«¯å£åˆ°Socketï¼Œå¹¶å¯åŠ¨</span></span><br><span class="line">    serverSocketChannel.socket().bind(inetSocketAddress);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºbufferæ•°ç»„</span></span><br><span class="line">    ByteBuffer[] byteBuffers = <span class="keyword">new</span> ByteBuffer[<span class="number">2</span>];</span><br><span class="line">    byteBuffers[<span class="number">0</span>] = ByteBuffer.allocate(<span class="number">5</span>);</span><br><span class="line">    byteBuffers[<span class="number">1</span>] = ByteBuffer.allocate(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">    SocketChannel socketChannel = serverSocketChannel.accept();</span><br><span class="line">    <span class="keyword">int</span> messageLength = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯çš„è¯»å–</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> byteRead = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (byteRead &lt; messageLength) &#123;</span><br><span class="line">            <span class="keyword">long</span> l = socketChannel.read(byteBuffers);</span><br><span class="line">            byteRead  += l;</span><br><span class="line">            System.out.println(<span class="string">&quot;byteRead = &quot;</span> + byteRead);</span><br><span class="line">            Arrays.asList(byteBuffers)</span><br><span class="line">                .stream()</span><br><span class="line">                .map(buffer -&gt; <span class="string">&quot;position = &quot;</span></span><br><span class="line">                     + buffer.position()</span><br><span class="line">                     + <span class="string">&quot;, limit = &quot;</span></span><br><span class="line">                     + buffer.limit())</span><br><span class="line">                .forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å°†æ‰€æœ‰çš„bufferåè½¬</span></span><br><span class="line">            Arrays.asList(byteBuffers).forEach(buffer -&gt; buffer.flip());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å°†æ•°æ®è¯»å‡ºæ˜¾ç¤ºåˆ°å®¢æˆ·ç«¯</span></span><br><span class="line">            <span class="keyword">long</span> byteWrite = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (byteWrite &lt; messageLength) &#123;</span><br><span class="line">                socketChannel.write(byteBuffers);</span><br><span class="line">                byteWrite += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å°†æ‰€æ¬²çš„bufferè¿›è¡Œclear</span></span><br><span class="line">            Arrays.asList(byteBuffers).forEach(buffer -&gt; &#123;</span><br><span class="line">                buffer.clear();</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            System.out.println(</span><br><span class="line">                <span class="string">&quot;byteRead = &quot;</span> + byteRead</span><br><span class="line">                + <span class="string">&quot;, byteWrite = &quot;</span> + byteWrite</span><br><span class="line">                + <span class="string">&quot;, messageLength = &quot;</span> + messageLength);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-2-4-å®ä¾‹"><a href="#1-2-4-å®ä¾‹" class="headerlink" title="1.2.4 å®ä¾‹"></a>1.2.4 å®ä¾‹</h4><p><strong>ç¾¤èŠç³»ç»ŸDemo</strong></p>
<p>ç¼–ç æ­¥éª¤ï¼š</p>
<ol>
<li>å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œä¼šé€šè¿‡<code>ServerSocketChannel</code> å¾—åˆ° SocketChannel</li>
<li>Selector è¿›è¡Œç›‘å¬ select æ–¹æ³•, è¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„é€šé“çš„ä¸ªæ•°.</li>
<li>å°†socketChannelæ³¨å†Œåˆ°Selectorä¸Š, register(Selector sel, int ops), ä¸€ä¸ªselectorä¸Šå¯ä»¥æ³¨å†Œå¤šä¸ªSocketChannel</li>
<li>æ³¨å†Œåè¿”å›ä¸€ä¸ª SelectionKey, ä¼šå’Œè¯¥Selector å…³è”(é›†åˆ)</li>
<li>è¿›ä¸€æ­¥å¾—åˆ°å„ä¸ª SelectionKey (æœ‰äº‹ä»¶å‘ç”Ÿ)</li>
<li>åœ¨é€šè¿‡ SelectionKey åå‘è·å– SocketChannel , æ–¹æ³• channel()</li>
<li>åˆ¤æ–­è¯¥Channelçš„äº‹ä»¶ç±»å‹ï¼Œå¯¹ä¸åŒäº‹ä»¶è¿›è¡Œä¸åŒçš„ä¸šåŠ¡å¤„ç†</li>
</ol>
<blockquote>
<p>NIOServer</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.nio.groupchat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/9/19 22:59</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apinote</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupChatServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(GroupChatServer.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServerSocketChannel listenChannel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">3333</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GroupChatServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1ã€è·å–é€‰æ‹©å™¨</span></span><br><span class="line">            selector = Selector.open();</span><br><span class="line">            <span class="comment">// 2ã€è·å–é€šé“</span></span><br><span class="line">            listenChannel = ServerSocketChannel.open();</span><br><span class="line">            <span class="comment">// 3ã€ç»‘å®šç«¯å£</span></span><br><span class="line">            listenChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(PORT));</span><br><span class="line">            <span class="comment">// 4ã€è®¾ç½®éé˜»å¡</span></span><br><span class="line">            listenChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 5ã€å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ï¼Œæ³¨å†Œæ“ä½œï¼šâ€œæ¥æ”¶â€</span></span><br><span class="line">            listenChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.info(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›‘å¬</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 6ã€é‡‡ç”¨è½®è¯¢çš„æ–¹å¼ï¼ŒæŸ¥è¯¢è·å–â€œå‡†å¤‡å°±ç»ªâ€çš„æ³¨å†Œè¿‡çš„æ“ä½œ</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> count = selector.select();</span><br><span class="line">                <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 7ã€è·å–å½“å‰é€‰æ‹©å™¨ä¸­æ‰€æœ‰æ³¨å†Œçš„é€‰æ‹©é”®</span></span><br><span class="line">                    Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">                    <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                        <span class="comment">// 8ã€è·å–â€œå‡†å¤‡å°±ç»ªâ€çš„æ—¶é—´</span></span><br><span class="line">                        SelectionKey selectionKey = iterator.next();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 9ã€åˆ¤æ–­selectionKeyæ˜¯å…·ä½“çš„ä»€ä¹ˆäº‹ä»¶</span></span><br><span class="line">                        <span class="comment">// ç›‘å¬åˆ°acceptäº‹ä»¶</span></span><br><span class="line">                        <span class="keyword">if</span> (selectionKey.isAcceptable()) &#123;</span><br><span class="line">                            <span class="comment">// 10ã€è‹¥æ¥å—çš„äº‹ä»¶æ˜¯â€œæ¥æ”¶å°±ç»ªâ€æ“ä½œï¼Œå°±è·å–å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">                            SocketChannel socketChannel = listenChannel.accept();</span><br><span class="line">                            <span class="comment">// 11ã€åˆ‡æ¢ä¸ºéé˜»å¡æ¨¡å¼</span></span><br><span class="line">                            socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                            <span class="comment">// å°†è¯¥é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š</span></span><br><span class="line">                            socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                            log.info(<span class="string">&quot;[&quot;</span> + socketChannel.getRemoteAddress().toString().substring(<span class="number">1</span>) + <span class="string">&quot;]ä¸Šçº¿&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// ç›‘å¬åˆ°readäº‹ä»¶</span></span><br><span class="line">                        <span class="keyword">if</span> (selectionKey.isReadable()) &#123;</span><br><span class="line">                            <span class="comment">// å¤„ç†è¯» (ä¸“é—¨æ–¹æ³•)</span></span><br><span class="line">                            readMessage(selectionKey);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// endï¼šç§»é™¤é€‰æ‹©é”®ï¼Œé˜²æ­¢é‡å¤æ“ä½œ</span></span><br><span class="line">                        iterator.remove();</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;ç­‰å¾…Â·Â·Â·Â·&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–å®¢æˆ·ç«¯æ¶ˆæ¯</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readMessage</span><span class="params">(SelectionKey selectionKey)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰ä¸€ä¸ª SocketChannel</span></span><br><span class="line">        SocketChannel socketChannel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 13ã€è·å–è¯¥é€‰æ‹©å™¨ä¸Šçš„â€œè¯»å°±ç»ªâ€çŠ¶æ€çš„é€šé“</span></span><br><span class="line">            socketChannel = (SocketChannel) selectionKey.channel();</span><br><span class="line">            <span class="comment">// 14ã€è¯»å–æ•°æ®</span></span><br><span class="line">            ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> count = socketChannel.read(buffer);</span><br><span class="line">            <span class="comment">// æ ¹æ®countçš„hå€¼åšå¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// æŠŠç¼“å­˜åŒºçš„æ•°æ®è½¬æˆå­—ç¬¦ä¸²</span></span><br><span class="line">                String msg = <span class="keyword">new</span> String(buffer.array());</span><br><span class="line">                <span class="comment">// è¾“å‡ºè¯¥æ¶ˆæ¯</span></span><br><span class="line">                log.info(<span class="string">&quot;å®¢æˆ·ç«¯-&quot;</span> + msg);</span><br><span class="line">                <span class="comment">// å‘å…¶ä»–å®¢æˆ·ç«¯è½¬å‘æ¶ˆæ¯(æ’é™¤è‡ªå·±)ï¼Œä¸“é—¨å†™ä¸€ä¸ªæ–¹æ³•æ¥å¤„ç†</span></span><br><span class="line">                sendMessageToOtherClients(msg, socketChannel);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">&quot;[&quot;</span> + socketChannel.getRemoteAddress().toString().substring(<span class="number">1</span>) + <span class="string">&quot;]ç¦»çº¿&quot;</span>);</span><br><span class="line">                <span class="comment">// å–æ¶ˆæ³¨å†Œ</span></span><br><span class="line">                selectionKey.cancel();</span><br><span class="line">                <span class="comment">// å…³é—­é€šé“</span></span><br><span class="line">                socketChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ioException) &#123;</span><br><span class="line">                log.error(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬å‘æ¶ˆæ¯ç»™å…¶ä»–å®¢æˆ·</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessageToOtherClients</span><span class="params">(String msg, SocketChannel self)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æœåŠ¡å™¨è½¬å‘æ¶ˆæ¯&quot;</span>);</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰æ³¨å†Œåˆ° selector ä¸Šçš„SocketChannelï¼Œå¹¶æ’é™¤self</span></span><br><span class="line">        <span class="keyword">for</span> (SelectionKey key : selector.keys()) &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡ key å–å‡º å¯¹åº”çš„ SocketChannel</span></span><br><span class="line">            Channel targetChannel = key.channel();</span><br><span class="line">            <span class="comment">// æ’é™¤è‡ªå·±</span></span><br><span class="line">            <span class="keyword">if</span> (targetChannel <span class="keyword">instanceof</span> SocketChannel &amp;&amp; targetChannel != self) &#123;</span><br><span class="line">                <span class="comment">// è½¬å‹</span></span><br><span class="line">                SocketChannel dest = (SocketChannel) targetChannel;</span><br><span class="line">                <span class="comment">// å°†msgå­˜å‚¨åˆ°buffer</span></span><br><span class="line">                ByteBuffer byteBuffer = ByteBuffer.wrap(msg.getBytes());</span><br><span class="line">                <span class="comment">// å°†bufferçš„æ•°æ®å†™å…¥é€šé“</span></span><br><span class="line">                dest.write(byteBuffer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæœåŠ¡å™¨å¯¹è±¡</span></span><br><span class="line">        GroupChatServer groupChatServer = <span class="keyword">new</span> GroupChatServer();</span><br><span class="line">        groupChatServer.listen();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NIOClient</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.nio.groupchat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/9/20 0:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupChatClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(GroupChatClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String HOST = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>    PORT = <span class="number">3333</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Selector selector;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SocketChannel socketChannel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ å™¨</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GroupChatClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        selector = Selector.open();</span><br><span class="line">        <span class="comment">// è¿æ¥æœåŠ¡å™¨</span></span><br><span class="line">        socketChannel = socketChannel.open(<span class="keyword">new</span> InetSocketAddress(HOST, PORT));</span><br><span class="line">        <span class="comment">// è®¾ç½®éé˜»å¡</span></span><br><span class="line">        socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// å°†socketChannelæ³¨å†Œåˆ°selector</span></span><br><span class="line">        socketChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">        <span class="comment">// å¾—åˆ°username</span></span><br><span class="line">        username = socketChannel.getLocalAddress().toString().substring(<span class="number">1</span>);</span><br><span class="line">        log.info(<span class="string">&quot;[&quot;</span> + username + <span class="string">&quot;]å·²å°±ç»ªÂ·Â·Â·&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        msg = username + <span class="string">&quot;: &quot;</span> + msg;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socketChannel.write(ByteBuffer.wrap(msg.getBytes()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»æœåŠ¡å™¨å›å¤çš„æ¶ˆæ¯</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> readChannels = selector.select();</span><br><span class="line">            <span class="keyword">if</span> (readChannels &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    SelectionKey key = iterator.next();</span><br><span class="line">                    <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                        <span class="comment">// å¾—åˆ°ç›¸å…³çš„é€šé“</span></span><br><span class="line">                        SocketChannel socketChannel = (SocketChannel) key.channel();</span><br><span class="line">                        <span class="comment">// å¾—åˆ°ä¸€ä¸ªbuffer</span></span><br><span class="line">                        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                        <span class="comment">// è¯»å–</span></span><br><span class="line">                        socketChannel.read(buffer);</span><br><span class="line">                        <span class="comment">// æŠŠè¯»åˆ°çš„ç¼“å†²åŒºçš„æ•°æ®è½¬æˆå­—ç¬¦ä¸²</span></span><br><span class="line">                        String msg = <span class="keyword">new</span> String(buffer.array());</span><br><span class="line">                        log.info(msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// åˆ é™¤å½“å‰ SelectionKey</span></span><br><span class="line">                iterator.remove();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//log.error(&quot;æ— å¯ç”¨çš„é€šé“Â·Â·Â·&quot;);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">// å¯åŠ¨å®¢æˆ·ç«¯</span></span><br><span class="line">        GroupChatClient chatClient = <span class="keyword">new</span> GroupChatClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯éš”3ç§’ï¼Œè¯»å–ä»æœåŠ¡å™¨</span></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    chatClient.readMessage();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.currentThread().sleep(<span class="number">3000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        System.err.println(e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é€æ•°æ®ç»™æœåŠ¡å™¨</span></span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNextLine()) &#123;</span><br><span class="line">            String s = scanner.nextLine();</span><br><span class="line">            chatClient.sendMessage(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-2-5-é›¶æ‹·è´"><a href="#1-2-5-é›¶æ‹·è´" class="headerlink" title="1.2.5 é›¶æ‹·è´"></a>1.2.5 é›¶æ‹·è´</h4><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><p>é›¶æ‹·è´ï¼Œæ˜¯ä»OS(æ“ä½œç³»ç»Ÿ)çš„è§’åº¦æ¥è¯´çš„ã€‚å› ä¸ºå†…æ ¸ç¼“å†²åŒºä¹‹é—´ï¼Œæ²¡æœ‰æ•°æ®æ˜¯é‡å¤çš„</p>
</li>
<li><p>é›¶æ‹·è´ä¸ä»…ä»…å¸¦æ¥æ›´å°‘çš„æ•°æ®å¤åˆ¶ï¼Œè¿˜èƒ½å¸¦æ¥å…¶ä»–çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œæ›´å°‘çš„CPUç¼“å­˜ä¼ªå…±äº«ä»¥åŠæ— CPUæ ¡éªŒå’Œè®¡ç®—</p>
</li>
</ul>
<blockquote>
<p>mmap</p>
</blockquote>
<ul>
<li>mmapé€šè¿‡å†…å­˜æ˜ å°„ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°å†…æ ¸ç¼“å†²åŒºï¼ŒåŒæ—¶ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥å…±äº«å†…æ ¸ç©ºé—´çš„æ•°æ®ã€‚è¿™æ ·ï¼Œåœ¨è¿›è¡Œç½‘ç»œä¼ è¾“æ—¶ï¼Œå°±å¯ä»¥å‡å°‘å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„æ‹·è´æ¬¡æ•°</li>
</ul>
<blockquote>
<p>mmapå’ŒsendFileçš„åŒºåˆ«</p>
</blockquote>
<ul>
<li>mmpé€‚åˆå°æ•°æ®é‡è¯»å†™ï¼ŒsendFileé€‚åˆå¤§æ–‡ä»¶ä¼ è¾“</li>
<li>mmapéœ€è¦4æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ3æ¬¡æ•°æ®æ‹·è´ï¼›sendFileéœ€è¦3æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæœ€å°‘2æ¬¡æ•°æ®æ‹·è´</li>
<li>sendFileå¯ä»¥åˆ©ç”¨DMA(direct memory access: ç›´æ¥å†…å­˜æ‹·è´)æ–¹å¼ï¼Œå‡å°‘CPUæ‹·è´ï¼Œmmapåˆ™ä¸èƒ½(å¿…é¡»ä»å†…æ ¸æ‹·è´åˆ°Socketç¼“å†²åŒº)</li>
</ul>
<h2 id="2-æ¦‚è¿°"><a href="#2-æ¦‚è¿°" class="headerlink" title="2 æ¦‚è¿°"></a>2 æ¦‚è¿°</h2><blockquote>
<p> ğŸŒå®˜ç½‘: <a href="https://netty.io/">Netty.io</a></p>
</blockquote>
<h3 id="2-1-ä»‹ç»"><a href="#2-1-ä»‹ç»" class="headerlink" title="2.1 ä»‹ç»"></a>2.1 ä»‹ç»</h3><p>Nettyæ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤çš„é«˜æ€§èƒ½åè®®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚</p>
<h3 id="2-2-è®¾è®¡"><a href="#2-2-è®¾è®¡" class="headerlink" title="2.2 è®¾è®¡"></a>2.2 è®¾è®¡</h3><ul>
<li>é€‚ç”¨äºå„ç§ä¼ è¾“ç±»å‹çš„ç»Ÿä¸€API-é˜»å¡å’Œéé˜»å¡å¥—æ¥å­—</li>
<li>åŸºäºçµæ´»ä¸”å¯æ‰©å±•çš„äº‹ä»¶æ¨¡å‹ï¼Œå¯å°†å…³æ³¨ç‚¹æ˜ç¡®åˆ†ç¦»</li>
<li>é«˜åº¦å¯å®šåˆ¶çš„çº¿ç¨‹æ¨¡å‹-å•çº¿ç¨‹ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ± ï¼Œä¾‹å¦‚SEDA</li>
<li>çœŸæ­£çš„æ— è¿æ¥æ•°æ®æŠ¥å¥—æ¥å­—æ”¯æŒï¼ˆä»3.1å¼€å§‹ï¼‰</li>
</ul>
<h3 id="2-3-æ€§èƒ½"><a href="#2-3-æ€§èƒ½" class="headerlink" title="2.3 æ€§èƒ½"></a>2.3 æ€§èƒ½</h3><ul>
<li>æ›´é«˜çš„ååé‡ï¼Œæ›´ä½çš„å»¶è¿Ÿ</li>
<li>å‡å°‘èµ„æºæ¶ˆè€—</li>
<li>å‡å°‘ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶</li>
</ul>
<h3 id="2-4-æ¶æ„"><a href="#2-4-æ¶æ„" class="headerlink" title="2.4 æ¶æ„"></a>2.4 æ¶æ„</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200921092848809.png" class="" title="image-20200921092848809">



<h2 id="3-Reactor"><a href="#3-Reactor" class="headerlink" title="3 Reactor"></a>3 Reactor</h2><h3 id="3-1-ä»‹ç»"><a href="#3-1-ä»‹ç»" class="headerlink" title="3.1 ä»‹ç»"></a>3.1 ä»‹ç»</h3><blockquote>
<p>ååº”å™¨æ¨¡å¼  |  åˆ†å‘è€…æ¨¡å¼  |  é€šçŸ¥è€…æ¨¡å¼</p>
</blockquote>
<ul>
<li>åŸºäºI/Oå¤ç”¨æ¨¡å‹: å¤šä¸ªè¿æ¥å…±ç”¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦å†ä¸€ä¸ªé˜»å¡å¯¹è±¡ç­‰å¾…ï¼Œæ— éœ€é˜»å¡ç­‰å¾…æ‰€æœ‰è¿æ¥ã€‚å½“æŸä¸ªè¿æ¥æœ‰æ–°çš„æ•°æ®å¯ä»¥å¤„ç†æ—¶ï¼Œæ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œçº¿ç¨‹ä»é˜»å¡çŠ¶æ€è¿”å›ï¼Œå¼€å§‹è¿›è¡Œä¸šåŠ¡å¤„ç†</li>
<li>åŸºäºçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹èµ„æº: ä¸å¿…å†ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºçº¿ç¨‹ï¼Œé”®è¿æ¥å®Œæˆåçš„ä¸šåŠ¡å¤„ç†çƒ­èˆåˆ†é…ç»™çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡</li>
</ul>
<h3 id="3-2-ç»„æˆ"><a href="#3-2-ç»„æˆ" class="headerlink" title="3.2 ç»„æˆ"></a>3.2 ç»„æˆ</h3><ul>
<li>Reactor: Reactoråœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å¯¹IOäº‹ä»¶åšå‡ºååº”ã€‚</li>
<li>Handlers: å¤„ç†ç¨‹åºæ‰§è¡ŒI/Oäº‹ä»¶è¦å®Œæˆçš„å®é™…äº‹ä»¶ã€‚Reactoré€šè¿‡è°ƒåº¦é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å“åº”I/Oäº‹ä»¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œéé˜»å¡æ“ä½œã€‚</li>
</ul>
<h3 id="3-3-åˆ†ç±»"><a href="#3-3-åˆ†ç±»" class="headerlink" title="3.3 åˆ†ç±»"></a>3.3 åˆ†ç±»</h3><ul>
<li>å•Reactorå•çº¿ç¨‹        â”â”â”â”â”â–¶    å‰å°æ¥å¾…å‘˜å’ŒæœåŠ¡å‘˜æ˜¯åŒä¸€ä¸ªäººï¼Œå…¨ç¨‹ä¸ºé¡¾å®¢æœåŠ¡</li>
<li>å•Reactorå¤šçº¿ç¨‹        â”â”â”â”â”â–¶    1ä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡å‘˜ï¼Œæ¥å¾…å‘˜åªè´Ÿè´£æ¥å¾…</li>
<li>ä¸»ä»Reactorå¤šçº¿ç¨‹    â”â”â”â”â”â–¶    å¤šä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡ç”Ÿ</li>
</ul>
<h4 id="3-2-1-å•Reactorå•çº¿ç¨‹"><a href="#3-2-1-å•Reactorå•çº¿ç¨‹" class="headerlink" title="3.2.1 å•Reactorå•çº¿ç¨‹"></a>3.2.1 å•Reactorå•çº¿ç¨‹</h4><blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200921181936951.png" class="" title="image-20200921181936951">

<br>

<blockquote>
<p>åˆ†æ</p>
</blockquote>
<ol>
<li>ä¼˜ç‚¹ï¼šæ¨¡å‹ç®€å•ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ã€è¿›ç¨‹é€šä¿¡ã€ç«äº‰çš„é—®é¢˜ï¼Œå…¨éƒ¨éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆ</li>
<li>ç¼ºç‚¹ï¼šæ€§èƒ½é—®é¢˜ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•å‘æŒ¥å¤šæ ¸CPUçš„æ€§èƒ½ã€‚<code>Handler</code>åœ¨å¤„ç†æŸä¸ªè¿æ¥ä¸Šçš„ä¸šåŠ¡æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–è¿æ¥äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ</li>
<li>ç¼ºç‚¹ï¼šå¯é æ€§é—®é¢˜ï¼Œçº¿ç¨‹æ„å¤–ç»ˆæ­¢ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœ</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šå®¢æˆ·ç«¯çš„æ•°é‡æœ‰é™ï¼Œä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿ</li>
</ol>
<h4 id="3-2-2-å•Reactorå¤šçº¿ç¨‹"><a href="#3-2-2-å•Reactorå¤šçº¿ç¨‹" class="headerlink" title="3.2.2 å•Reactorå¤šçº¿ç¨‹"></a>3.2.2 å•Reactorå¤šçº¿ç¨‹</h4><blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200921182914960.png" class="" title="image-20200921182914960">

<br>

<blockquote>
<p>æ–¹æ¡ˆè¯´æ˜</p>
</blockquote>
<ol>
<li><code>Reactor</code>å¯¹è±¡é€šè¿‡<code>select</code>ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡<code>dispatch</code>è¿›è¡Œåˆ†å‘</li>
<li>å¦‚æœå»ºç«‹è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”±<code>Acceptor</code>é€šè¿‡<code>accept</code>å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶åä»é»„å¥ä¸€ä¸ªHandlerå¯¹è±¡å¤„ç†å®Œæˆè¿æ¥åçš„å„ç§äº‹ä»¶</li>
<li>å¦‚æœä¸æ˜¯è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”±<code>Reactor</code>åˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„<code>handler</code>è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„<code>Worker</code>çº¿ç¨‹æ± çš„æŸä¸ªçº¿ç¨‹å¤„ç†ä¸šåŠ¡</li>
<li><code>Handler</code>åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“çš„ä¸šåŠ¡å¤„ç†ï¼Œé€šè¿‡<code>read</code>è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„<code>worker</code>çº¿ç¨‹æ± çš„æŸä¸ªçº¿ç¨‹å¤„ç†ä¸šåŠ¡</li>
<li><code>Worker</code>çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™<code>Handler</code></li>
<li><code>Handler</code>æ”¶åˆ°å“åº”åï¼Œé€šè¿‡<code>send</code>å°†ç»“æœè¿”å›ç»™<code>Client</code></li>
</ol>
<blockquote>
<p>åˆ†æ</p>
</blockquote>
<ol>
<li>ä¼˜ç‚¹ï¼šå¯ä»¥å……åˆ†çš„åˆ©ç”¨å¤šæ ¸<code>CPU</code>çš„å¤„ç†èƒ½åŠ›</li>
<li>ç¼ºç‚¹ï¼šå¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚ï¼Œ<code>Reactor</code>å¤„ç†æ‰€æœ‰çš„äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåœ¨å•çº¿ç¨‹è¿è¡Œï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯å®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆ</li>
</ol>
<h4 id="3-2-3-ä¸»ä»Reactorå¤šçº¿ç¨‹"><a href="#3-2-3-ä¸»ä»Reactorå¤šçº¿ç¨‹" class="headerlink" title="3.2.3 ä¸»ä»Reactorå¤šçº¿ç¨‹"></a>3.2.3 ä¸»ä»Reactorå¤šçº¿ç¨‹</h4><blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200921191731035.png" class="" title="image-20200921191731035">

<br>

<blockquote>
<p>æ–¹æ¡ˆè¯´æ˜</p>
</blockquote>
<ol>
<li><code>Reactor</code>ä¸»çº¿ç¨‹<code>MainReactor</code>å¯¹è±¡é€šè¿‡<code>select</code>ç›‘å¬è¿æ¥äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡<code>Acceptor</code>å¤„ç†è¿æ¥äº‹ä»¶</li>
<li>å½“<code>Acceptor</code>å¤„ç†è¿æ¥äº‹ä»¶åï¼Œ<code>MainReactor</code>å°†è¿æ¥åˆ†é…ç»™<code>SubReactor</code></li>
<li><code>SubReactor</code>å°†è¿æ¥åŠ å…¥åˆ°è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ›å»º<code>Handler</code>è¿›è¡Œå„ç§äº‹ä»¶å¤„ç†</li>
<li>å½“æœ‰æ–°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ<code>SubReactor</code>å°±ä¼šè°ƒç”¨å¯¹åº”çš„Handlerå¤„ç†</li>
<li><code>Worker</code>çº¿ç¨‹æ± åˆ†é…ç‹¬ç«‹çš„<code>Worker</code>çº¿ç¨‹è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¹¶è¿”å›ç»“æœ</li>
<li><code>Handler</code>æ”¶åˆ°å“åº”çš„ç»“æœåï¼Œå†é€šè¿‡<code>send</code>å°†ç»“æœè¿”å›ç»™<code>Client</code></li>
<li><code>Reactor</code>ä¸»çº¿ç¨‹å¯ä»¥å¯¹äºå¤šä¸ª<code>Reactor</code>å­çº¿ç¨‹ï¼Œå³<code>MainReactor</code>ï¼Œå¯ä»¥å…³è”å¤šä¸ª<code>SubReactor</code></li>
</ol>
<blockquote>
<p>åˆ†æ</p>
</blockquote>
<ol>
<li><p>ä¼˜ç‚¹ï¼šçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„èŒè´£æ˜ç¡®ï¼Œçˆ¶çº¿ç¨‹åªéœ€è¦æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†</p>
</li>
<li><p>ä¼˜ç‚¹ï¼šçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•ï¼Œ<code>Reactor</code>ä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— éœ€è¿”å›æ•°æ®</p>
</li>
<li><p>ç¼ºç‚¹ï¼šç¼–ç¨‹å¤æ‚åº¦è¾ƒé«˜</p>
</li>
</ol>
<h3 id="3-4-ä¼˜ç‚¹"><a href="#3-4-ä¼˜ç‚¹" class="headerlink" title="3.4 ä¼˜ç‚¹"></a>3.4 ä¼˜ç‚¹</h3><ul>
<li>å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥æ—¶é—´æ‰€é˜»å¡ï¼Œè™½ç„¶<code>Reactor</code>æœ¬èº«ä¾ç„¶æ˜¯åŒæ­¥çš„</li>
<li>å¯ä»¥æœ€å¤§ç¨‹åº¦çš„æ¯”æ›¼å¤æ‚çš„å¤šçº¿ç¨‹åŠåŒæ­¥é—®é¢˜ï¼Œå¹¶ä¸”é¿å…äº†å¤šçº¿ç¨‹/è¿›ç¨‹çš„åˆ‡æ¢å¼€é”€</li>
<li>æ‰©å±•æ€§å¥½ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡å¢åŠ <code>Reactor</code>å®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©ç”¨CPUèµ„æº</li>
<li>å¤ç”¨æ€§å¥½ï¼Œ<code>Reactor</code>æ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘æ— å…³ï¼Œå…·æœ‰å¾ˆé«˜çš„å¤ç”¨æ€§</li>
</ul>
<h2 id="4-æ¶æ„"><a href="#4-æ¶æ„" class="headerlink" title="4 æ¶æ„"></a>4 æ¶æ„</h2><h3 id="4-1-å›¾ç¤º"><a href="#4-1-å›¾ç¤º" class="headerlink" title="4.1 å›¾ç¤º"></a>4.1 å›¾ç¤º</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/Netty.png" class="" title="Netty">



<h3 id="4-2-è¯´æ˜"><a href="#4-2-è¯´æ˜" class="headerlink" title="4.2 è¯´æ˜"></a>4.2 è¯´æ˜</h3><ol>
<li><code>Netty</code>æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ± <code>BossGroup</code>ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œ<code>WorkerGroup</code>ä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™</li>
<li><code>BossGroup</code>å’Œ<code>WorkerGroup</code>ç±»å‹çš„æœ¬è´¨éƒ½æ˜¯<code>NioEventLoopGroup</code></li>
<li><code>NioEventLoopGroup</code>ç›¸å½“äºä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„ï¼Œè¿™ä¸ªç»„ä¸­å«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯æ˜¯<code>NioEventLoop</code></li>
<li><code>NioEventLoop</code>è¡¨ç¤ºä¸€ä¸ªä¸æ–­å¾ªç¯çš„æ‰§è¡Œå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ¯ä¸ª<code>NioEventLoop</code>éƒ½æœ‰ä¸€ä¸ª<code>selector</code>ï¼Œç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„socketçš„ç½‘ç»œé€šè®¯</li>
<li><code>NioEventLoopGroup</code>å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå³å¯ä»¥å«æœ‰å¤šä¸ª<code>NioEventLoop</code></li>
<li>æ¯ä¸ª<code>Boss NioEventLoop</code>å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤æœ‰ä¸‰æ­¥:<ol>
<li>è½®è¯¢<code>accept</code>äº‹ä»¶</li>
<li>å¤„ç†<code>accept</code>äº‹ä»¶ï¼Œä¸<code>client</code>å»ºç«‹è¿æ¥ï¼Œç”Ÿæˆ<code>NioSocketChannel</code>ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°æŸä¸ª<code>Worker NioEventLoop</code>ä¸Šçš„<code>selector</code></li>
<li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³<code>runAllTasks</code></li>
</ol>
</li>
<li>æ¯ä¸ª<code>Worker NIOEventLoop</code>å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤<ol>
<li>è½®è¯¢<code>read</code>ã€<code>write</code>äº‹ä»¶</li>
<li>å¤„ç†i/oäº‹ä»¶ï¼Œå³<code>read</code>ã€<code>write</code>äº‹ä»¶ï¼Œåœ¨å¯¹åº”<code>NioSocketChannel</code>å¤„ç†</li>
<li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³<code>runAllTasks</code></li>
</ol>
</li>
</ol>
<h3 id="4-3-å¿«é€Ÿå¼€å§‹"><a href="#4-3-å¿«é€Ÿå¼€å§‹" class="headerlink" title="4.3 å¿«é€Ÿå¼€å§‹"></a>4.3 å¿«é€Ÿå¼€å§‹</h3><blockquote>
<p>å¼•å…¥ä¾èµ–(pom)</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.12<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">netty.version</span>&gt;</span>4.1.2.Final<span class="tag">&lt;/<span class="name">netty.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">grpc.version</span>&gt;</span>1.6.1<span class="tag">&lt;/<span class="name">grpc.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">protobuf.version</span>&gt;</span>3.9.0<span class="tag">&lt;/<span class="name">protobuf.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- lombok --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;lombok.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- log4j --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- netty-all --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- protobuf-java --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;protobuf.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- grpc --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf-lite<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;grpc.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extension</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- ç¼–è¯‘protoæ–‡ä»¶ç›®å½• --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">protoSourceRoot</span>&gt;</span>$&#123;project.basedir&#125;/src/main/java/com/kag/codec/proto<span class="tag">&lt;/<span class="name">protoSourceRoot</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- è¾“å‡ºjavaæ–‡ä»¶ç›®å½•--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$&#123;project.basedir&#125;/src/main/java/com/kag/codec/generated<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span>com.google.protobuf:protoc:3.1.0:exe:$&#123;os.detected.classifier&#125;<span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>æ—¥å¿—é…ç½®(log4j)</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">log4j.rootLogger</span> = <span class="string">INFO,KAG,CONSOLE</span></span><br><span class="line"><span class="comment">#æ—¥å¿—æœ€ä½çš„è¾“å‡ºçº§åˆ«</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.Threshold</span>=<span class="string">INFO</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.encoding</span>=<span class="string">UTF-8</span></span><br><span class="line"><span class="comment">#æ¯å¤©äº§ç”Ÿä¸€ä¸ªæ–‡ä»¶DailyRollingFileAppender</span></span><br><span class="line"><span class="meta">log4j.appender.KAG</span> = <span class="string">org.apache.log4j.DailyRollingFileAppender</span></span><br><span class="line"><span class="comment">#æ—¥å¿—æ–‡ä»¶çš„ä¿å­˜ä½ç½®åŠæ–‡ä»¶å</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.File</span>=<span class="string">log/NettyPro.log</span></span><br><span class="line"><span class="comment">#æœ‰æ—¥å¿—æ—¶ç«‹å³è¾“å‡ºï¼Œé»˜è®¤æ˜¯true</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.ImmediateFlush</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.DatePattern</span>=<span class="string">&#x27;_&#x27;yyyy-MM-dd</span></span><br><span class="line"><span class="comment">#æ—¥å¿—å¸ƒå±€æ–¹å¼</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="comment">#æ—¥å¿—æ–‡ä»¶ä¸­æ—¥å¿—çš„æ ¼å¼</span></span><br><span class="line"><span class="meta">log4j.appender.KAG.layout.ConversionPattern</span>=<span class="string">%-d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; KAG %-5p [%c] - %m%n</span></span><br><span class="line"><span class="comment">#ä½¿ç”¨org.apache.log4j.ConsoleAppenderæŒ‡å®šè¦æŠŠæ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE</span>=<span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="meta">log4j.appender.Threshold</span>=<span class="string">INFO</span></span><br><span class="line"><span class="comment">#è¾“å‡ºç›®æ ‡ï¼šæ§åˆ¶å°</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE.Target</span>=<span class="string">System.out</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE.layout</span>=<span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.CONSOLE.layout.ConversionPattern</span>=<span class="string">%-d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; KAG %-5p [%c] - %m%n</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>æœåŠ¡å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/9/21 21:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> NettyæœåŠ¡å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * åˆ›å»ºBossGroup å’Œ WorkerGroup</span></span><br><span class="line"><span class="comment">         * è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">         * 1ã€åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„ï¼šbossGroup å’Œ workerGroup</span></span><br><span class="line"><span class="comment">         * 2ã€bossGroupå¤„ç†è¿æ¥è¯·æ±‚</span></span><br><span class="line"><span class="comment">         * 3ã€workerGroupå¤„ç†å’Œå®¢æˆ·ç«¯çš„ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">         * 4ã€ä¸¤ä¸ªéƒ½æ˜¯æ— é™å¾ªç¯</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        NioEventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºæœåŠ¡å™¨ç«¯çš„å¯åŠ¨å¯¹è±¡ï¼Œé…ç½®å‚æ•°</span></span><br><span class="line">            ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            <span class="comment">// ä½¿ç”¨é“¾å¼ç¼–ç¨‹æ¥è¿›è¡Œè®¾ç½®</span></span><br><span class="line">            bootstrap.group(bossGroup, workerGroup)                         <span class="comment">// è®¾ç½®ä¸¤ä¸ªçº¿ç¨‹ç»„</span></span><br><span class="line">                    .channel(NioServerSocketChannel.class)                  <span class="comment">// ä½¿ç”¨NioSocketChannelä½œä¸ºæœåŠ¡å™¨çš„é€šé“å®ç°</span></span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)                  <span class="comment">// è®¾ç½®çº¿ç¨‹é˜Ÿåˆ—å¾—åˆ°è¿æ¥ä¸ªæ•°</span></span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>)          <span class="comment">// è®¾ç½®ä¿æŒæ´»åŠ¨è¿æ¥çŠ¶æ€</span></span><br><span class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123; <span class="comment">// åˆ›å»ºä¸€ä¸ªé€šé“æµ‹è¯•å¯¹è±¡</span></span><br><span class="line">                        <span class="comment">// ç»™Pipelineè®¾ç½®å¤„ç†å™¨</span></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            socketChannel.pipeline().addLast(<span class="keyword">new</span> NettyServerHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);  <span class="comment">// ç»™workerGroupçš„EventLoopå¯¹åº”çš„ç®¡é“è®¾ç½®å¤„ç†å™¨</span></span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;æœåŠ¡å™¨å·²å°±ç»ªÂ·Â·Â·&quot;</span>);</span><br><span class="line">            <span class="comment">// ç»‘å®šä¸€ä¸ªç«¯å£å¹¶ä¸”åŒæ­¥</span></span><br><span class="line">            <span class="comment">// ç»‘å®šç«¯å£å¹¶å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">            ChannelFuture channelFuture = bootstrap.bind(<span class="number">3333</span>).sync();</span><br><span class="line">            <span class="comment">// å¯¹å…³é—­é€šé“è¿›è¡Œç›‘å¬</span></span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœåŠ¡å™¨ä¸šåŠ¡å¤„ç†å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/9/21 22:20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> æœåŠ¡å™¨ä¸šåŠ¡å¤„ç†å™¨</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰ä¸€ä¸ªHandleréœ€è¦ç»§æ‰¿Nettyè§„å®šå¥½çš„æŸä¸ªHandlerAdapter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»å–æ•°æ®äº‹ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå«æœ‰ç®¡é“pipline[å¤„ç†æ•°æ®]ï¼Œé€šé“channel[ä¼ è¾“æ•°æ®]ï¼Œåœ°å€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;server ctx = &quot;</span> + ctx);</span><br><span class="line">        <span class="comment">// å°†msgè½¬æˆByteBuffer</span></span><br><span class="line">        ByteBuf byteBuf = (ByteBuf) msg;</span><br><span class="line">        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š&quot;</span> + byteBuf.toString(CharsetUtil.UTF_8));</span><br><span class="line">        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯åœ°å€ï¼š&quot;</span> + ctx.channel().remoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ•°æ®è¯»å–å®Œæ¯•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// å°†æ•°æ®å†™å…¥åˆ°ç¼“å­˜ï¼Œå¹¶åˆ·æ–°</span></span><br><span class="line">        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="string">&quot;Hello, å®¢æˆ·ç«¯~&quot;</span>, CharsetUtil.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(cause.getMessage());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/9/21 22:20</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Nettyå®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰ä¸€ä¸ªHandleréœ€è¦ç»§æ‰¿Nettyè§„å®šå¥½çš„æŸä¸ªHandlerAdapter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»å–æ•°æ®äº‹ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå«æœ‰ç®¡é“pipline[å¤„ç†æ•°æ®]ï¼Œé€šé“channel[ä¼ è¾“æ•°æ®]ï¼Œåœ°å€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg å®¢æˆ·ç«¯å‘é€çš„æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;server ctx = &quot;</span> + ctx);</span><br><span class="line">        <span class="comment">// å°†msgè½¬æˆByteBuffer</span></span><br><span class="line">        ByteBuf byteBuf = (ByteBuf) msg;</span><br><span class="line">        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š&quot;</span> + byteBuf.toString(CharsetUtil.UTF_8));</span><br><span class="line">        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯åœ°å€ï¼š&quot;</span> + ctx.channel().remoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ•°æ®è¯»å–å®Œæ¯•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// å°†æ•°æ®å†™å…¥åˆ°ç¼“å­˜ï¼Œå¹¶åˆ·æ–°</span></span><br><span class="line">        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="string">&quot;Hello, å®¢æˆ·ç«¯~&quot;</span>, CharsetUtil.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(cause.getMessage());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®¢æˆ·ç«¯ä¸šåŠ¡å¤„ç†</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.ByteBuf;</span><br><span class="line"><span class="keyword">import</span> io.netty.buffer.Unpooled;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.CharsetUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/9/22 19:09</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> å®¢æˆ·ç«¯ä¸šåŠ¡å¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€šé“å°±ç»ª-&gt;è§¦å‘</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;client &quot;</span> +  ctx);</span><br><span class="line">        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="string">&quot;Hello, server~å–µ&quot;</span>, CharsetUtil.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœ‰è¯»å–äº‹ä»¶æ—¶-&gt;è§¦å‘</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ByteBuf byteBuf = (ByteBuf) msg;</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨å›å¤æ¶ˆæ¯ï¼š&quot;</span> + byteBuf.toString(CharsetUtil.UTF_8));</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨çš„åœ°å€ï¼š&quot;</span> + ctx.channel().remoteAddress());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(cause.getMessage());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-ä»»åŠ¡é˜Ÿåˆ—"><a href="#4-4-ä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="4.4 ä»»åŠ¡é˜Ÿåˆ—"></a>4.4 ä»»åŠ¡é˜Ÿåˆ—</h3><p>ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„<code>Task</code>æœ‰ä¸‰ç§å…¸å‹ä½¿ç”¨åœºæ™¯</p>
<ul>
<li>ç”¨æˆ·ç¨‹åºè‡ªå®šä¹‰çš„æ™®é€šä»»åŠ¡</li>
<li>ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡</li>
<li>éå½“å‰<code>Reactor</code>çº¿ç¨‹è°ƒç”¨<code>Channel</code>çš„å„ç§æ–¹æ³•</li>
</ul>
<h3 id="4-5-å¼‚æ­¥æ¨¡å‹"><a href="#4-5-å¼‚æ­¥æ¨¡å‹" class="headerlink" title="4.5 å¼‚æ­¥æ¨¡å‹"></a>4.5 å¼‚æ­¥æ¨¡å‹</h3><h4 id="4-5-1-åŸºæœ¬ä»‹ç»"><a href="#4-5-1-åŸºæœ¬ä»‹ç»" class="headerlink" title="4.5.1 åŸºæœ¬ä»‹ç»"></a>4.5.1 åŸºæœ¬ä»‹ç»</h4><ol>
<li>å¼‚æ­¥çš„æ¦‚å¿µå’ŒåŒæ­¥ç›¸å¯¹ã€‚å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœã€‚å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„ç»„ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…</li>
<li><code>Netty</code>ä¸­çš„I/Oæ“ä½œæ˜¯å¼‚æ­¥çš„ï¼ŒåŒ…æ‹¬<code>Bind</code>ã€<code>Write</code>ã€<code>Connect</code>ç­‰æ“ä½œä¼šç®€å•çš„è¿”å›ä¸€ä¸ª<code>ChannelFuture</code></li>
<li>è°ƒç”¨è€…å¹¶ä¸èƒ½ç†ç§‘è·å¾—ç»“æœï¼Œè€Œæ˜¯é€šè¿‡Future-Listeneræœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿çš„ä¸»åŠ¨è·å–æˆ–è€…é€šè¿‡é€šçŸ¥æœºåˆ¶è·å¾—IOæ“ä½œç»“æœ</li>
<li><code>Netty</code>çš„å¼‚æ­¥æ¨¡å‹æ˜¯å»ºç«‹åœ¨<code>future</code>å’Œ<code>callback</code>ä¹‹ä¸Šçš„ã€‚<code>callback</code>å°±æ˜¯å›è°ƒã€‚é‡ç‚¹æ˜¯<code>future</code>ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šç»“ç¤¾ä¸€ä¸ªæ–¹æ³•<code>fun</code>ï¼Œè®¡ç®—è¿‡ç¨‹å¯èƒ½éå¸¸è€—æ—¶ï¼Œç­‰å¾…<code>fun</code>è¿”å›æ˜¾ç„¶ä¸åˆé€‚ã€‚é‚£ä¹ˆå¯ä»¥åœ¨è°ƒç”¨<code>fun</code>çš„æ—¶å€™ç«‹é©¬è¿”å›ä¸€ä¸ª<code>future</code>ï¼Œåç»­å¯ä»¥é€šè¿‡<code>future</code>å»ç›‘æ§æ–¹æ³•<code>fun</code>çš„å¤„ç†è¿‡ç¨‹</li>
</ol>
<h4 id="4-5-2-Futureè¯´æ˜"><a href="#4-5-2-Futureè¯´æ˜" class="headerlink" title="4.5.2 Futureè¯´æ˜"></a>4.5.2 Futureè¯´æ˜</h4><ol>
<li><p>è¡¨ç¤ºå¼‚æ­¥çš„æ‰§è¡Œç»“æœï¼Œå¯ä»¥é€šè¿‡å®ƒæä¾›çš„æ–¹æ³•æ¥æ£€æµ‹æ‰§è¡Œæ˜¯å¦å®Œæˆ</p>
</li>
<li><p><code>ChannelFuture</code>æ˜¯ä¸€ä¸ªæ¥å£: public interface ChannelFuture extends Future<Void></p>
<p>æˆ‘ä»¬å¯ä»¥æ·»åŠ ç›‘å¬å™¨ï¼Œå½“ç›‘å¬çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šé€šçŸ¥åˆ°ç›‘å¬å™¨</p>
</li>
</ol>
<h4 id="4-5-3-Future-Listeneræœºåˆ¶"><a href="#4-5-3-Future-Listeneræœºåˆ¶" class="headerlink" title="4.5.3 Future-Listeneræœºåˆ¶"></a>4.5.3 Future-Listeneræœºåˆ¶</h4><ol>
<li><p>å½“<code>future</code>å¯¹è±¡åˆšåˆšåˆ›å»ºæ—¶ï¼Œå¤„äºéå®ŒæˆçŠ¶æ€ï¼Œè°ƒç”¨è€…å¯ä»¥é€šè¿‡è¿”å›çš„<code>ChannelFuture</code>æ¥è·å–æ“ä½œæ‰§è¡Œçš„çŠ¶æ€ï¼Œæ³¨å†Œç›‘å¬å‡½æ•°æ¥æ‰§è¡Œå®Œæˆåçš„æ“ä½œ</p>
</li>
<li><p>å¸¸è§æ“ä½œï¼š</p>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">isDone()</td>
<td align="center">åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦å®Œæˆ</td>
</tr>
<tr>
<td align="center">isSuccess()</td>
<td align="center">åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦æˆåŠŸ</td>
</tr>
<tr>
<td align="center">getCause()</td>
<td align="center">è·å–å·²å®Œæˆçš„å½“å‰æ“ä½œå¤±è´¥çš„åŸå› </td>
</tr>
<tr>
<td align="center">isCancelled()</td>
<td align="center">åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦è¢«å–æ¶ˆ</td>
</tr>
<tr>
<td align="center">addListener()</td>
<td align="center">æ³¨å†Œç›‘å¬å™¨ï¼Œå½“æ“ä½œå·²å®Œæˆ(isDoneè¿”å›å®Œæˆ)ï¼Œå°†ä¼šé€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨ï¼›å¦‚æœFutureå¯¹è±¡å·²å®Œæˆï¼Œåˆ™é€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨</td>
</tr>
</tbody></table>
</li>
</ol>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç»‘å®šä¸€ä¸ªç«¯å£å¹¶ä¸”åŒæ­¥</span></span><br><span class="line"><span class="comment">// ç»‘å®šç«¯å£å¹¶å¯åŠ¨æœåŠ¡å™¨</span></span><br><span class="line">ChannelFuture CF = bootstrap.bind(<span class="number">3333</span>).sync();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»™CFæ³¨å†Œç›‘å¬å™¨</span></span><br><span class="line">CF.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture channelFuture)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (CF.isSuccess()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æœåŠ¡å™¨ç›‘å¬ç«¯å£[3333]æˆåŠŸ&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æœåŠ¡å™¨ç›‘å¬ç«¯å£[3333]å¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h3 id="4-6-HttpæœåŠ¡"><a href="#4-6-HttpæœåŠ¡" class="headerlink" title="4.6 HttpæœåŠ¡"></a>4.6 HttpæœåŠ¡</h3><blockquote>
<p>æœåŠ¡å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.EventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/9/26 10:34</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Netty-HTTPæœåŠ¡å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            serverBootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> TestServerInitializer());</span><br><span class="line">            ChannelFuture CF = serverBootstrap.bind(<span class="number">3333</span>).sync();</span><br><span class="line">            CF.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœåŠ¡å™¨åˆå§‹åŒ–</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpServerCodec;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/9/26 10:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> æœåŠ¡å™¨åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServerInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// å¾—åˆ°ç®¡é“</span></span><br><span class="line">        ChannelPipeline pipeline = socketChannel.pipeline();</span><br><span class="line">		<span class="comment">// æ·»åŠ å¤„ç†å™¨</span></span><br><span class="line">        <span class="comment">// åŠ å…¥ä¸€ä¸ªNettyæä¾›çš„HttpServerCodeC codec =&gt; [coder - decoder]</span></span><br><span class="line">        <span class="comment">// 1ã€HttpServerCodeC: å¤„ç†httpçš„ç¼–&amp;è§£ç å™¨</span></span><br><span class="line">        pipeline.addLast(<span class="string">&quot;MyHttpServerCodec&quot;</span>, <span class="keyword">new</span> HttpServerCodec());</span><br><span class="line">        <span class="comment">// 2ã€å¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰handler</span></span><br><span class="line">        pipeline.addLast(<span class="string">&quot;MyTestServerHandler&quot;</span>, <span class="keyword">new</span> TestHttpServerHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœåŠ¡å™¨ä¸šåŠ¡å¤„ç†å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpServerCodec;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/9/26 10:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> æœåŠ¡å™¨ä¸šåŠ¡å¤„ç†å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServerInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// å‘ç®¡é“åŠ å…¥å¤„ç†å™¨</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾—åˆ°ç®¡é“</span></span><br><span class="line">        ChannelPipeline pipeline = socketChannel.pipeline();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ å…¥ä¸€ä¸ªNettyæä¾›çš„HttpServerCodeC codec =&gt; [coder - decoder]</span></span><br><span class="line">        <span class="comment">// 1ã€HttpServerCodeC: å¤„ç†httpçš„ç¼–&amp;è§£ç å™¨</span></span><br><span class="line">        pipeline.addLast(<span class="string">&quot;MyHttpServerCodec&quot;</span>, <span class="keyword">new</span> HttpServerCodec());</span><br><span class="line">        <span class="comment">// 2ã€å¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰handler</span></span><br><span class="line">        pipeline.addLast(<span class="string">&quot;MyTestServerHandler&quot;</span>, <span class="keyword">new</span> TestHttpServerHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-æ ¸å¿ƒ"><a href="#5-æ ¸å¿ƒ" class="headerlink" title="5 æ ¸å¿ƒ"></a>5 æ ¸å¿ƒ</h2><h3 id="5-1-BootStrapã€ServerBootStrap"><a href="#5-1-BootStrapã€ServerBootStrap" class="headerlink" title="5.1 BootStrapã€ServerBootStrap"></a>5.1 BootStrapã€ServerBootStrap</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p><code>BootStrap</code>æ„æ€æ˜¯å¼•å¯¼ç¨‹åºï¼Œä¸€ä¸ª<code>Netty</code>åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª<code>BootStrap</code>å¼€å§‹ï¼Œä¸»è¦ä½œç”¨æ˜¯é…ç½®æ•´ä¸ª<code>Netty</code>ç¨‹åºï¼Œä¸²è”å„ä¸ªç»„ä»¶ï¼Œ<code>Netty</code>ä¸­<code>BootStrap</code>ç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»ï¼Œ<code>ServerBootStrap</code>æ˜¯æœåŠ¡å™¨ç«¯å¯åŠ¨å¼•å¯¼ç±»ã€‚</p>
<blockquote>
<p>å¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public ServerBootStrap group(EventLoopGroup parentGroup, EventLoopGroup childGroup)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œç”¨æ¥è®¾ç½®ä¸¤ä¸ªEventLoop</td>
</tr>
<tr>
<td align="center">public B group(EventLoopGroup group)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨äºå®¢æˆ·ç«¯ï¼Œç”¨æ¥è®¾ç½®ä¸€ä¸ªEventLoop</td>
</tr>
<tr>
<td align="center">public B channel(Class&lt;? extends C&gt; channelClass)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨ç«¯çš„é€šé“å®ç°</td>
</tr>
<tr>
<td align="center">public <T> B option(ChannelOption<T> option, T value)</td>
<td align="center">ç”¨æ¥ç»™ServerChannelæ·»åŠ é…ç½®</td>
</tr>
<tr>
<td align="center">public  ServerBootstrap childOption(ChannelOption childOption, T value)</td>
<td align="center">ç”¨æ¥ç»™æ¥æ”¶åˆ°çš„é€šé“æ·»åŠ é…ç½®</td>
</tr>
<tr>
<td align="center">public ServerBootstrap childHandler(ChannelHandler childHandler)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®ä¸šåŠ¡å¤„ç†ç±»(è‡ªå®šä¹‰çš„handler)</td>
</tr>
<tr>
<td align="center">public ChannelFuture bind(int inetPort)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œç”¨æ¥è®¾ç½®å ç”¨çš„ç«¯å£å·</td>
</tr>
<tr>
<td align="center">public ChannelFuture connect(String inetHost, int inetPort)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨äºå®¢æˆ·ç«¯ï¼Œç”¨æ¥è¿æ¥æœåŠ¡å™¨</td>
</tr>
</tbody></table>
<h3 id="5-2-Futureã€ChannelFuture"><a href="#5-2-Futureã€ChannelFuture" class="headerlink" title="5.2 Futureã€ChannelFuture"></a>5.2 Futureã€ChannelFuture</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p><code>Netty</code>ä¸­æ‰€æœ‰çš„IOæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ã€‚ä½†æ˜¯å¯ä»¥è¿‡ä¸€ä¼šç­‰å®ƒæ‰§è¡Œå®Œæˆ–è€…ç›´æ¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå…·ä½“çš„å®ç°å°±æ˜¯é€šè¿‡<code>Future</code>å’Œ<code>ChannelFuture</code>ï¼Œå®ƒä»¬å¯ä»¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶ç›‘å¬ä¼šè‡ªåŠ¨è§¦å‘æ³¨å†Œçš„ç›‘å¬äº‹ä»¶ã€‚ </p>
<blockquote>
<p>å¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Channel channel()</td>
<td align="center">è¿”å›å½“å‰æ­£åœ¨è¿›è¡ŒIOæ“ä½œçš„é€šé“</td>
</tr>
<tr>
<td align="center">ChannelFuture sync()</td>
<td align="center">ç­‰å¾…å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œæ¯•ï¼Œç›¸å½“äºå°†é˜»å¡åœ¨å½“å‰</td>
</tr>
</tbody></table>
<h3 id="5-3-Channel"><a href="#5-3-Channel" class="headerlink" title="5.3 Channel"></a>5.3 Channel</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><code>Netty</code>ç½‘ç»œé€šä¿¡çš„ç»„ä»¶ï¼Œèƒ½å¤Ÿç”¨äºæ‰§è¡Œç½‘ç»œI/Oæ“ä½œ</li>
<li>é€šè¿‡<code>Channel</code>å¯è·å¾—å½“å‰ç½‘ç»œè¿æ¥çš„é€šé“çš„çŠ¶æ€</li>
<li>é€šè¿‡<code>Channel</code>å¯è·å¾—ç½‘ç»œè¿æ¥çš„é…ç½®å‚æ•°</li>
<li><code>Channel</code>é€šè¿‡å¼‚æ­¥çš„ç½‘ç»œI/Oæ“ä½œ(æ¯”å¦‚ï¼šå»ºç«‹è¿æ¥ã€è¯»å†™å’Œç»‘å®šç«¯å£)ï¼Œå¼‚æ­¥è°ƒç”¨æ„å‘³ç€ä»»ä½•I/Oè°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ï¼Œå¹¶ä¸”ä¸ä¿è¯åœ¨è°ƒç”¨ç»“æŸæ—¶æ‰€è¯·æ±‚çš„I/Oæ“ä½œå·²å®Œæˆ</li>
<li>è°ƒç”¨ç«‹å³è¿”å›ä¸€ä¸ª<code>ChannelFuture</code>å®ä¾‹ï¼Œé€šè¿‡æ³¨å†Œå™¨åˆ°<code>ChannelFuture</code>ä¸Šï¼Œå¯ä»¥åœ¨I/Oæ“ä½œæˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆæ—¶å›è°ƒé€šçŸ¥è°ƒç”¨æ–¹ </li>
<li>æ”¯æŒå…³è”I/Oæ“ä½œä¸å¯¹åº”çš„å¤„ç†ç¨‹åº</li>
<li>ä¸åŒåè®®ã€ä¸åŒçš„é˜»å¡ç±»å‹çš„è¿æ¥éƒ½æœ‰ä¸åŒçš„<code>Channel</code>ç±»å‹ä¸ä¹‹å¯¹åº”</li>
</ul>
<blockquote>
<p>å¸¸è§Channelç±»å‹</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">åç§°</th>
<th align="center">ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">NioSocketChannel</td>
<td align="center">å¼‚æ­¥çš„å®¢æˆ·ç«¯TCP Socketè¿æ¥</td>
</tr>
<tr>
<td align="center">NioServerSocketChannel</td>
<td align="center">å¼‚æ­¥çš„æœåŠ¡å™¨ç«¯TCP Socketè¿æ¥</td>
</tr>
<tr>
<td align="center">NioDatagramChannel</td>
<td align="center">å¼‚æ­¥çš„UDPè¿æ¥</td>
</tr>
<tr>
<td align="center">NioSctpChannel</td>
<td align="center">å¼‚æ­¥çš„å®¢æˆ·ç«¯Sctpè¿æ¥</td>
</tr>
<tr>
<td align="center">NioSctpServerChannel</td>
<td align="center">å¼‚æ­¥çš„SctpæœåŠ¡å™¨ç«¯è¿æ¥ï¼Œè¿™äº›é€šé“æ¶µç›–äº†UDPå’ŒTCPç½‘ç»œI/Oä»¥åŠæ–‡ä»¶I/O</td>
</tr>
</tbody></table>
<h3 id="5-4-Selector"><a href="#5-4-Selector" class="headerlink" title="5.4 Selector"></a>5.4 Selector</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><code>Netty</code>åŸºäº<code>Selector</code>å¯¹è±¡å®ç°I/Oå¤šè·¯å¤ç”¨ï¼Œé€šè¿‡<code>Selector</code>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å¤šä¸ªè¿æ¥çš„<code>Channel</code>äº‹ä»¶</li>
<li>å½“å‘ä¸€ä¸ª<code>Selector</code>ä¸­æ³¨å†Œ<code>Channel</code>åï¼Œ<code>Selector</code>å†…éƒ¨çš„æœºåˆ¶å°±å¯ä»¥è‡ªåŠ¨ä¸æ–­åœ°æŸ¥è¯¢(<code>Select</code>)è¿™äº›æ³¨å†Œçš„<code>Channel</code>æ˜¯å¦æœ‰å·²å°±ç»ªçš„I/Oäº‹ä»¶(æ¯”å¦‚ï¼šå¯è¯»ã€å¯å†™ã€ç½‘ç»œè¿æ¥å®Œæˆç­‰)ï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥å¾ˆç®€å•åœ°ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ª<code>Channel</code></li>
<li>åŒæ—¶ï¼Œ<code>Netty</code>ä¸­å¯¹<code>Selector</code>ä¸­çš„<code>selectedKey</code>é›†åˆè¿›è¡Œäº†æ›¿æ¢ï¼Œå®ƒæ›¿æ¢æˆäº†ä¸€ä¸ªå®ƒè‡ªå·±å®ç°çš„ä¸€ä¸ª<code>set</code>é›†åˆï¼Œè¿™æ ·æ•ˆç‡æ›´é«˜</li>
</ul>
<h3 id="5-5-ChannelHandleråŠå…¶å®ç°ç±»"><a href="#5-5-ChannelHandleråŠå…¶å®ç°ç±»" class="headerlink" title="5.5 ChannelHandleråŠå…¶å®ç°ç±»"></a>5.5 ChannelHandleråŠå…¶å®ç°ç±»</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><p><code>ChannelHandler</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¤„ç†I/Oäº‹ä»¶æˆ–æ‹¦æˆªI/Oæ“ä½œï¼Œå¹¶å°†å…¶è½¬å‘åˆ°<code>ChannelPipeline</code>(ä¸šåŠ¡å¤„ç†é“¾)ä¸­çš„ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åº</p>
</li>
<li><p><code>ChannelHandler</code>æœ¬èº«å¹¶æ²¡æœ‰æä¾›å¾ˆå¤šæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ¥å£æœ‰è®¸å¤šçš„æ–¹æ³•éœ€è¦å®ç°ï¼Œæ–¹ä¾¿ä½¿ç”¨æœŸé—´ï¼Œå¯ä»¥ç»§æ‰¿å®ƒçš„å­ç±»</p>
</li>
<li><p>æˆ‘ä»¬ç»å¸¸éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ª<code>Handler</code>ç±»å–ç»§æ‰¿<code>ChannelInboundHandlerAdapter</code>ï¼Œç„¶åé€šè¿‡é‡å†™ç›¸åº”æ–¹æ³•å®ç°ä¸šåŠ¡é€»è¾‘</p>
<p>ä¸€èˆ¬éœ€è¦é‡å†™çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChannelInboundHandlerAdapter</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">ChannelInboundHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šé“æ³¨å†Œäº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Skip</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRegistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.fireChannelRegistered();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šé“å–æ¶ˆæ³¨å†Œäº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Skip</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelUnregistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.fireChannelUnregistered();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šé“å°±ç»ªäº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Skip</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.fireChannelActive();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šé“æ–­è”äº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Skip</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.fireChannelInactive();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šé“è¯»å–æ•°æ®äº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Skip</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.fireChannelRead(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šé“æ•°æ®è¯»å–å®Œæ¯•äº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Skip</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.fireChannelReadComplete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”¨æ³•äº‹ä»¶è§¦å‘</span></span><br><span class="line">    <span class="meta">@Skip</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.fireUserEventTriggered(evt);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šé“å¯å†™æ€§æ›´æ”¹äº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Skip</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelWritabilityChanged</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.fireChannelWritabilityChanged();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šé“å‘ç”Ÿå¼‚å¸¸äº‹ä»¶</span></span><br><span class="line">    <span class="meta">@Skip</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.fireExceptionCaught(cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ChannelInboundHandler</code>  ç”¨äºå¤„ç†å…¥ç«™I/Oäº‹ä»¶</li>
<li><code>ChannelOutboundHandler</code>  ç”¨äºå¤„ç†å‡ºæˆ˜I/Oäº‹ä»¶</li>
</ul>
</li>
</ul>
<blockquote>
<p>é€‚é…å™¨</p>
</blockquote>
<ul>
<li><code>ChannelInboundHandlerAdapter</code> ç”¨äºå¤„ç†å…¥ç«™ I/O äº‹ä»¶</li>
<li><code>ChannelOutboundHandlerAdapter</code> ç”¨äºå¤„ç†å‡ºç«™ I/O æ“ä½œ</li>
<li><code>ChannelDuplexHandler</code> ç”¨äºå¤„ç†å…¥ç«™å’Œå‡ºç«™äº‹ä»¶</li>
</ul>
<h3 id="5-6-Pipelineã€Channel"><a href="#5-6-Pipelineã€Channel" class="headerlink" title="5.6 Pipelineã€Channel"></a>5.6 Pipelineã€Channel</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><p><code>ChannelPipeline</code>æ˜¯ä¸€ä¸ªHandlerçš„é›†åˆï¼Œå®ƒè´Ÿè´£å¤„ç†å’Œæ‹¦æˆª<code>inbound</code>å’Œ<code>outbound</code>çš„äº‹ä»¶å’Œæ“ä½œï¼Œç›¸å½“äºä¸€ä¸ªè´¯ç©¿<code>Netty</code>çš„é“¾ï¼ˆé€šä¿—çš„è®²ï¼š<code>ChannelPipeline</code>æ˜¯ä¿å­˜<code>ChannelHandler</code>çš„<code>list</code>ï¼Œç”¨äºå¤„ç†æˆ–æ‹¦æˆª<code>Channel</code>çš„å…¥ç«™äº‹ä»¶å’Œå‡ºæˆ˜æ“ä½œï¼‰</p>
</li>
<li><p><code>ChanenelPipline</code>å®ç°äº†ä¸€ç§é«˜çº§å½¢å¼çš„æ‹¦æˆªè¿‡æ»¤å™¨æ¨¡å¼ï¼Œä½¿ç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶äº‹ä»¶çš„å¤„ç†æ–¹å¼ï¼Œä»¥åŠ<code>Channel</code>ä¸­å„ä¸ªçš„<code>ChannelHandler</code>å¦‚ä½•ç›¸äº’äº¤äº’</p>
</li>
<li><p>åœ¨<code>Netty</code>ä¸­æ¯ä¸ª<code>Channel</code>éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª<code>ChannelPipeline</code>ä¸ä¹‹å¯¹åº”ï¼Œä»–ä»¬çš„ç»„æˆå…³ç³»å¦‚ä¸‹</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20201002192427279.png" class="" title="image-20201002192427279">
</li>
<li><p>ä¸€ä¸ª<code>Channel</code>åŒ…å«ä¸€ä¸ª<code>ChannelPipeline</code>ï¼Œè€Œ<code>ChannelPipeline</code>ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”±<code>ChannelHandlerContext</code>ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ª<code>ChannelHandlerContext</code>ä¸­åˆå…³è”ç€ä¸€ä¸ª<code>ChannelHandler</code></p>
</li>
<li><p>å…¥ç«™äº‹ä»¶å’Œå‡ºæˆ˜äº‹ä»¶åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œå…¥ç«™äº‹ä»¶ä¼šä»é“¾è¡¨<code>head</code>å¾€åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥ç«™çš„handlerï¼Œå‡ºç«™äº‹ä»¶ä¼šä»é“¾è¡¨<code>tail</code>å¾€å‰ä¼ é€’åˆ°æœ€å‰ä¸€ä¸ªå‡ºç«™çš„<code>handler</code>ï¼Œä¸¤ç§ç±»å‹çš„<code>handler</code>äº’ä¸å¹²æ‰°</p>
</li>
</ul>
<blockquote>
<p>å¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ChannelPipeline addFirst(ChannelHandlerâ€¦ handlers)</td>
<td align="center">æŠŠä¸€ä¸ªä¸šåŠ¡å¤„ç†ç±»ï¼ˆhandlerï¼‰æ·»åŠ åˆ°é“¾ä¸­çš„ç¬¬ä¸€ä¸ªä½ç½®</td>
</tr>
<tr>
<td align="center">ChannelPipeline addLast(ChannelHandlerâ€¦ handlers)</td>
<td align="center">æŠŠä¸€ä¸ªä¸šåŠ¡å¤„ç†ç±»ï¼ˆhandlerï¼‰æ·»åŠ åˆ°é“¾ä¸­çš„æœ€åä¸€ä¸ªä½ç½®</td>
</tr>
</tbody></table>
<h3 id="5-7-ChannelHandlerContext"><a href="#5-7-ChannelHandlerContext" class="headerlink" title="5.7 ChannelHandlerContext"></a>5.7 ChannelHandlerContext</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li>ä¿å­˜<code>Channel</code>ç›¸å…³çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒæ—¶å…³è”ä¸€ä¸ªChannelHandlerå¯¹è±¡</li>
<li>å³<code>ChannelHandlerContext</code>ä¸­åŒ…å«ä¸€ä¸ªå…·ä½“çš„äº‹ä»¶å¤„ç†å™¨<code>ChannelHandler</code>ï¼ŒåŒæ—¶<code>ChannelHandlerContext</code>ä¸­ä¹Ÿç»‘å®šäº†å¯¹åº”çš„<code>Pipeline</code>å’Œ<code>Channel</code>çš„ä¿¡æ¯ï¼Œæ–¹ä¾¿å¯¹<code>ChannelHandler</code>è¿›è¡Œè°ƒç”¨</li>
</ul>
<blockquote>
<p>å¸¸è§æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ChannelFuture close()</td>
<td align="center">å…³é—­é€šé“</td>
</tr>
<tr>
<td align="center">ChannelOutboundInvoker flush()</td>
<td align="center">åˆ·æ–°</td>
</tr>
<tr>
<td align="center">ChannelFuture writeAndFlush(Object msg)</td>
<td align="center">å°†æ•°æ®å†™åˆ°ChannelPipelineä¸­å½“å‰ChannelHandlerçš„ä¸‹ä¸€ä¸ªChannelHandlerå¼€å§‹å¤„ç†</td>
</tr>
</tbody></table>
<h3 id="5-8-ChannelOption"><a href="#5-8-ChannelOption" class="headerlink" title="5.8 ChannelOption"></a>5.8 ChannelOption</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p><code>Netty</code>åœ¨åˆ›å»º<code>Channel</code>å®ä¾‹åï¼Œä¸€èˆ¬éƒ½éœ€è¦è®¾ç½®<code>ChannelOption</code>å‚æ•°</p>
<blockquote>
<p>å‚æ•°å¦‚ä¸‹ï¼š</p>
</blockquote>
<ul>
<li>ChannelOption.SO_BACKLOG:<ul>
<li>å¯¹åº”TCP/IPåè®®listenå‡½æ•°ä¸­çš„backlogå‚æ•°ï¼Œç”¨æ¥åˆå§‹åŒ–æœåŠ¡å™¨å¯è¿æ¥é˜Ÿåˆ—å¤§å°</li>
<li>æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ˜¯é¡ºåºå¤„ç†çš„ï¼Œæ‰€ä»¥åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚å¤šä¸ªå®¢æˆ·ç«¯æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯å°†ä¸èƒ½å¤„ç†çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ”¾åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†ï¼Œbacklogå‚æ•°æŒ‡å®šäº†é˜Ÿåˆ—çš„å¤§å°</li>
</ul>
</li>
<li>ChannelOption.SO_KEEPALIVE:<ul>
<li>ä¸€ç›´ä¿æŒè¿æ¥æ´»åŠ¨çŠ¶æ€</li>
</ul>
</li>
</ul>
<h3 id="5-9-EventLoopGroupå’Œå…¶å®ç°ç±»NioEventLoopGroup"><a href="#5-9-EventLoopGroupå’Œå…¶å®ç°ç±»NioEventLoopGroup" class="headerlink" title="5.9 EventLoopGroupå’Œå…¶å®ç°ç±»NioEventLoopGroup"></a>5.9 EventLoopGroupå’Œå…¶å®ç°ç±»NioEventLoopGroup</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><code>EventLoopGroup</code>æ˜¯ä¸€ç»„<code>EventLoop</code>çš„æŠ½è±¡ï¼Œ<code>Netty</code>ä¸ºäº†æ›´å¥½çš„åˆ©ç”¨å¤šæ ¸CPUèµ„æºï¼Œä¸€èˆ¬ä¼šæœ‰å¤šä¸ª<code>EventLoop</code>åŒæ—¶å·¥ä½œï¼Œæ¯ä¸ª<code>EventLoop</code>ç»´æŠ¤è€…ä¸€ä¸ªSelectorå®ä¾‹ã€‚</li>
<li><code>EventLoopGroup</code>æä¾›nextæ¥å£ï¼Œå¯ä»¥ä»ç»„é‡Œé¢æŒ‰ç…§ä¸€å®šè§„åˆ™è·å–å…¶ä¸­ä¸€ä¸ª<code>EventLoop</code>æ¥å¤„ç†ä»»åŠ¡ã€‚åœ¨NettyæœåŠ¡å™¨ç«¯ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½éœ€è¦æä¾›ä¸¤ä¸ª<code>EventLoopGroup</code>ï¼Œ<code>BossGroup</code>å’Œ<code>WorkerGroup</code></li>
<li>é€šå¸¸ä¸€ä¸ªæœåŠ¡ç«¯å£å³ä¸€ä¸ª<code>ServerSocketChannel</code>å¯¹åº”ä¸€ä¸ª<code>Selector</code>å’Œä¸€ä¸ª<code>EventLoop</code>çº¿ç¨‹ã€‚<code>BossEventLoop</code>è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥å¹¶å°†<code>SocketChannel</code>äº¤ç»™<code>WorkerEventLoopGroup</code>æ¥è¿›è¡ŒIOå¤„ç†</li>
<li><code>BossEventLoopGroup</code>é€šå¸¸æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„<code>EventLoop</code>ï¼Œ<code>EventLoop</code>ç»´æŠ¤ç€ä¸€ä¸ªæ³¨å†Œäº†<code>ServerSocketChannel</code>çš„<code>Selector</code>å®ä¾‹<code>BossEventLoop</code>ä¸æ–­è½®è¯¢<code>Selector</code>å°†è¿æ¥äº‹ä»¶åˆ†ç¦»å‡ºæ¥</li>
<li>é€šå¸¸æ˜¯OP_ACCEPTäº‹ä»¶ï¼Œç„¶åå°†æ¥æ”¶åˆ°çš„<code>SocketChannel</code>äº¤ç»™<code>WorkerEventLoopGroup</code></li>
<li><code>WorkerEventLoopGroup</code>ä¼šç”±<code>next</code>é€‰æ‹©å…¶ä¸­ä¸€ä¸ª<code>EventLoop</code>æ¥å°†è¿™ä¸ª<code>SocketChannel</code>æ³¨å†Œåˆ°å…¶ç»´æŠ¤çš„<code>Selector</code>å¹¶å¯¹å…¶åç»­çš„IOäº‹ä»¶è¿›è¡Œå¤„ç†</li>
</ul>
<blockquote>
<p>å¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public NioEventLoopGroup()</td>
<td align="center">æ„é€ æ–¹æ³•</td>
</tr>
<tr>
<td align="center">public Future&lt;?&gt; shutdownGracefully()</td>
<td align="center">æ–­å¼€è¿æ¥ï¼Œå…³é—­çº¿ç¨‹</td>
</tr>
</tbody></table>
<h3 id="5-10-Unpooled"><a href="#5-10-Unpooled" class="headerlink" title="5.10 Unpooled"></a>5.10 Unpooled</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p><code>Netty</code>æä¾›ä¸€ä¸ªä¸“é—¨ç”¨æ¥æ“ä½œç¼“å†²åŒºï¼ˆå³<code>Netty</code>çš„æ•°æ®å®¹å™¨ï¼‰çš„å·¥å…·ç±»</p>
<blockquote>
<p>å¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public static ByteBuf copiedBuffer(CharSequence string, Charset charset)</td>
<td align="center">é€šè¿‡ç»™å®šçš„æ•°æ®å’Œå­—ç¬¦ç¼–ç è¿”å›ä¸€ä¸ª ByteBuf å¯¹è±¡ï¼ˆç±»ä¼¼äº NIO ä¸­çš„ ByteBuffer ä½†æœ‰åŒºåˆ«ï¼‰</td>
</tr>
</tbody></table>
<h3 id="5-11-ç¾¤èŠç³»ç»Ÿ"><a href="#5-11-ç¾¤èŠç³»ç»Ÿ" class="headerlink" title="5.11 ç¾¤èŠç³»ç»Ÿ"></a>5.11 ç¾¤èŠç³»ç»Ÿ</h3><blockquote>
<p>è¦æ±‚</p>
</blockquote>
<ul>
<li>ç¼–å†™ä¸€ä¸ª Netty ç¾¤èŠç³»ç»Ÿï¼Œå®ç°æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ç®€å•é€šè®¯ï¼ˆéé˜»å¡ï¼‰</li>
<li>å®ç°å¤šäººç¾¤èŠ</li>
<li>æœåŠ¡å™¨ï¼šå¯ä»¥ç›‘æµ‹ç”¨æˆ·ä¸Šçº¿ï¼Œç¦»çº¿ï¼Œå¹¶å®ç°æ¶ˆæ¯è½¬å‘åŠŸèƒ½</li>
<li>å®¢æˆ·ç«¯ï¼šé€šè¿‡channel å¯ä»¥æ— é˜»å¡å‘é€æ¶ˆæ¯ç»™å…¶å®ƒæ‰€æœ‰ç”¨æˆ·ï¼ŒåŒæ—¶å¯ä»¥æ¥å—å…¶å®ƒç”¨æˆ·å‘é€çš„æ¶ˆæ¯(ç”±æœåŠ¡å™¨è½¬å‘å¾—åˆ°)</li>
</ul>
<blockquote>
<p>ç¾¤èŠæœåŠ¡å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.groupChat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kag.nio.groupchat.GroupChatClient;</span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/10/2 8:19</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupChatServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GroupChatServer</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„</span></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"></span><br><span class="line">        serverBootstrap.group(workerGroup, workerGroup)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>)</span><br><span class="line">                .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="comment">// è·å–pipeline</span></span><br><span class="line">                        ChannelPipeline pipeline = channel.pipeline();;</span><br><span class="line">                        <span class="comment">// å‘pipelineåŠ å…¥è§£ç å™¨</span></span><br><span class="line">                        pipeline.addLast(<span class="string">&quot;decoder&quot;</span>, <span class="keyword">new</span> StringDecoder());</span><br><span class="line">                        <span class="comment">// å‘pipelineåŠ å…¥ç¼–ç å™¨</span></span><br><span class="line">                        pipeline.addLast(<span class="string">&quot;encoder&quot;</span>, <span class="keyword">new</span> StringEncoder());</span><br><span class="line">                        <span class="comment">// åŠ å…¥è‡ªå·±çš„ä¸šåŠ¡å¤„ç†handler</span></span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> GroupChatServerHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;â–¶-----NettyæœåŠ¡å™¨å¯åŠ¨-----â—€&quot;</span>);</span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(port).sync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç›‘å¬å…³é—­</span></span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> GroupChatServer(<span class="number">3333</span>).run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœåŠ¡å™¨ä¸šåŠ¡å¤„ç†å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.groupChat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.group.ChannelGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.group.DefaultChannelGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.concurrent.EventExecutor;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.concurrent.GlobalEventExecutor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/10/2 8:33</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupChatServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ªchannelç»„ï¼Œç®¡ç†æ‰€æœ‰çš„channel</span></span><br><span class="line">    <span class="comment">// GlobalEventExecutor.INSTANCE æ˜¯å…¨å±€çš„æ—¶é—´æ‰§è¡Œå™¨ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹</span></span><br><span class="line">    EventExecutor executor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ChannelGroup channelGroup = <span class="keyword">new</span> DefaultChannelGroup(GlobalEventExecutor.INSTANCE);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">now</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleDateFormat.format(<span class="keyword">new</span> Date());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HandlerAdded</span></span><br><span class="line"><span class="comment">     * è¡¨ç¤ºè¿æ¥å»ºç«‹ï¼Œä¸€æ—¦è¿æ¥ï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Channel channel = ctx.channel();</span><br><span class="line">        <span class="comment">// å°†è¯¥å®¢æˆ·åŠ å…¥èŠå¤©çš„ä¿¡æ¯æ¨é€ç»™å…¶ä»–åœ¨çº¿çš„å®¢æˆ·</span></span><br><span class="line">        <span class="comment">// è¯¥æ–¹æ³•ä¼šå°†channelGroupä¸­çš„æ‰€æœ‰channeléå†ï¼Œå¹¶å‘é€æ¶ˆæ¯</span></span><br><span class="line">        channelGroup.writeAndFlush(now() + <span class="string">&quot; [å®¢æˆ·ç«¯]&quot;</span> + channel.remoteAddress() + <span class="string">&quot;åŠ å…¥èŠå¤©\n&quot;</span>);</span><br><span class="line">        channelGroup.add(channel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HandlerRemoved</span></span><br><span class="line"><span class="comment">     * è¡¨ç¤ºæ–­å¼€è¿æ¥ï¼Œå°†XXå®¢æˆ·ç¦»çº¿ä¿¡æ¯æ¨é€ç»™å½“å‰åœ¨çº¿å®¢æˆ·</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Channel channel = ctx.channel();</span><br><span class="line">        channelGroup.writeAndFlush(now() + <span class="string">&quot; [å®¢æˆ·ç«¯]&quot;</span> + channel.remoteAddress() + <span class="string">&quot;ç¦»å¼€èŠå¤©\n&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Channel Group Size = &quot;</span> + channelGroup.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * channelActive</span></span><br><span class="line"><span class="comment">     * è¡¨ç¤ºchannelå¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæç¤ºXXä¸Šçº¿</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(now() + <span class="string">&quot; &quot;</span> + ctx.channel().remoteAddress() + <span class="string">&quot;ä¸Šçº¿&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * channelInactive</span></span><br><span class="line"><span class="comment">     * è¡¨ç¤ºchannelå¤„äºéæ´»åŠ¨çŠ¶æ€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(now() + <span class="string">&quot; &quot;</span> + ctx.channel().remoteAddress() + <span class="string">&quot;ç¦»çº¿&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ChannelRead0</span></span><br><span class="line"><span class="comment">     * è½¬å‘æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channelHandlerContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext channelHandlerContext, String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Channel channel = channelHandlerContext.channel();</span><br><span class="line">        <span class="comment">// éå†ChannelGroup</span></span><br><span class="line">        channelGroup.forEach(ch -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (channel != ch) <span class="comment">// ä¸æ˜¯å½“å‰channelï¼Œç›´æ¥è½¬å‘</span></span><br><span class="line">                ch.writeAndFlush(now() + <span class="string">&quot; [å®¢æˆ·]&quot;</span> + channel.remoteAddress() + <span class="string">&quot;ï¼š&quot;</span> + s + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="comment">// å½“å‰channelæ˜¯è‡ªå·±</span></span><br><span class="line">                ch.writeAndFlush(now() + <span class="string">&quot; [è‡ªå·±]: &quot;</span> + s + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼‚å¸¸å¤„ç†</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.exceptionCaught(ctx, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç¾¤èŠå®¢æˆ·ç«¯</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.groupChat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringDecoder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.string.StringEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.SocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/10/2 9:22</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupChatClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GroupChatClient</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap()</span><br><span class="line">                .group(group)</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="comment">// å¾—åˆ°pipeline</span></span><br><span class="line">                        ChannelPipeline pipeline = channel.pipeline();</span><br><span class="line">                        <span class="comment">// åŠ å…¥ç›¸å…³handler</span></span><br><span class="line">                        pipeline.addLast(<span class="string">&quot;decoder&quot;</span>, <span class="keyword">new</span> StringDecoder());</span><br><span class="line">                        pipeline.addLast(<span class="string">&quot;encoder&quot;</span>, <span class="keyword">new</span> StringEncoder());</span><br><span class="line">                        <span class="comment">// åŠ å…¥è‡ªå®šä¹‰çš„handler</span></span><br><span class="line">                        pipeline.addLast(<span class="keyword">new</span> GroupChatClientHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture channelFuture = bootstrap.connect(host, port).sync();</span><br><span class="line">            Channel channel = channelFuture.channel();</span><br><span class="line">            System.out.println(<span class="string">&quot;â–¶-----&quot;</span> + channel.localAddress().toString().substring(<span class="number">1</span>) + <span class="string">&quot;-----â—€&quot;</span>);</span><br><span class="line">            <span class="comment">// è¾“å…¥ä¿¡æ¯</span></span><br><span class="line">            Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">            <span class="keyword">while</span> (scanner.hasNextLine()) &#123;</span><br><span class="line">                String msg = scanner.nextLine();</span><br><span class="line">                <span class="comment">// é€šè¿‡channelå‘é€åˆ°æœåŠ¡å™¨ç«¯</span></span><br><span class="line">                channel.writeAndFlush(msg + <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> GroupChatClient(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">3333</span>).run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®¢æˆ·ç«¯ä¸šåŠ¡å¤„ç†å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.groupChat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/10/2 10:06</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupChatClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext channelHandlerContext, String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(s.trim());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-12-å¿ƒè·³æ£€æµ‹"><a href="#5-12-å¿ƒè·³æ£€æµ‹" class="headerlink" title="5.12 å¿ƒè·³æ£€æµ‹"></a>5.12 å¿ƒè·³æ£€æµ‹</h3><blockquote>
<p>è¦æ±‚</p>
</blockquote>
<ul>
<li>å½“æœåŠ¡å™¨è¶…è¿‡3ç§’æ²¡æœ‰è¯»æ“ä½œæ—¶ï¼Œå°±æç¤ºè¯»ç©ºé—²</li>
<li>å½“æœåŠ¡å™¨è¶…è¿‡5ç§’æ²¡æœ‰å†™æ“ä½œæ—¶ï¼Œå°±æç¤ºå†™ç©ºé—²</li>
<li>å½“æœåŠ¡å™¨è¶…è¿‡7ç§’æ²¡æœ‰è¯»æˆ–å†™æ—¶ï¼Œå°±æç¤ºè¯»å†™ç©ºé—²</li>
</ul>
<blockquote>
<p>æœåŠ¡å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.heartbeat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LogLevel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LoggingHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.timeout.IdleStateHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/10/2 10:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> æœåŠ¡å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        NioEventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        NioEventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            serverBootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> LoggingHandler(LogLevel.INFO))  <span class="comment">//ä¸ºBossGroupä¸­çš„è¯·æ±‚æ·»åŠ æ—¥å¿—å¤„ç†Handler</span></span><br><span class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line">                            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                             * åŠ å…¥ä¸€ä¸ª netty æä¾›çš„ IdleStateHandler</span></span><br><span class="line"><span class="comment">                             * è¯´æ˜</span></span><br><span class="line"><span class="comment">                             * 1ã€IdleStateHandler æ˜¯ netty æä¾›çš„æ£€æµ‹ç©ºé—²çŠ¶æ€çš„å¤„ç†å™¨</span></span><br><span class="line"><span class="comment">                             * 2ã€long readerIdleTimeï¼šè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»ï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">                             * 3ã€long writerIdleTimeï¼šè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰å†™ï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">                             * 4ã€long allIdleTimeï¼šè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»å†™ï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">                             * 5ã€å½“ IdleStateEvent è§¦å‘åï¼Œå°±ä¼šä¼ é€’ç»™ç®¡é“çš„ä¸‹ä¸€ä¸ª Handlerï¼Œé€šè¿‡è°ƒç”¨ï¼ˆè§¦å‘ï¼‰ä¸‹ä¸€ä¸ªHandlerçš„ userEventTriggeredï¼Œåœ¨è¯¥æ–¹æ³•åŒºå¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> IdleStateHandler(<span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, TimeUnit.SECONDS));</span><br><span class="line">                            <span class="comment">//åŠ å…¥ä¸€ä¸ªå¯¹ç©ºé—²æ£€æµ‹è¿›ä¸€æ­¥å¤„ç†çš„Handlerï¼ˆè‡ªå®šä¹‰ï¼‰</span></span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> MyServerHandler ());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">//å¯åŠ¨æœåŠ¡å™¨ï¼Œè®¾ç½®ä¸ºåŒæ­¥æ¨¡å¼</span></span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(<span class="number">3333</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœåŠ¡å™¨ä¸šåŠ¡å¤„ç†å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.netty.heartbeat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.timeout.IdleStateEvent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/10/2 10:48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> æœåŠ¡å™¨ä¸šåŠ¡å¤„ç†å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> evt äº‹ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> IdleStateEvent) &#123;</span><br><span class="line">            <span class="comment">// å°†evtå‘ä¸‹è½¬å‹</span></span><br><span class="line">            IdleStateEvent event = (IdleStateEvent) evt;</span><br><span class="line">            String eventType = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">switch</span> (event.state()) &#123;</span><br><span class="line">                <span class="keyword">case</span> READER_IDLE:</span><br><span class="line">                    eventType = <span class="string">&quot;è¯»ç©ºé—²&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WRITER_IDLE:</span><br><span class="line">                    eventType = <span class="string">&quot;å†™ç©ºé—²&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ALL_IDLE:</span><br><span class="line">                    eventType = <span class="string">&quot;è¯»å†™ç©ºé—²&quot;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(ctx.channel().remoteAddress() + <span class="string">&quot;â€”â€”&gt;è¶…æ—¶ï¼š&quot;</span> + eventType);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœå‘ç”Ÿç©ºé—²ï¼Œç›´æ¥å…³é—­é€šé“</span></span><br><span class="line"><span class="comment">//            ctx.channel().close();</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;æœåŠ¡å™¨å…³é—­é€šé“Â·Â·Â·&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-13-ç®€å•æ€»ç»“"><a href="#5-13-ç®€å•æ€»ç»“" class="headerlink" title="5.13 ç®€å•æ€»ç»“"></a>5.13 ç®€å•æ€»ç»“</h3><blockquote>
<p>æœåŠ¡å™¨</p>
</blockquote>
<ol>
<li>åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„ï¼Œ<code>bossGroup</code>å’Œ<code>workerGroup</code></li>
<li>åˆ›å»ºæœåŠ¡å™¨å¯åŠ¨å¯¹è±¡<code>ServerBootStrap</code></li>
<li>é“¾å¼ç¼–ç¨‹é…ç½®<code>ServerBootStrap</code>çš„å‚æ•°<ol>
<li><code>group</code>ï¼šè®¾ç½®çº¿ç¨‹ç»„<code>bossGroup</code>å’Œ<code>workerGroup</code></li>
<li><code>channel</code>ï¼šè®¾ç½®é€šé“å®ç°ï¼Œä¸€èˆ¬é€‰æ‹©<code>NioServerSocketChannel</code></li>
<li><code>option</code>ï¼šè®¾ç½®å¯è¿æ¥çº¿ç¨‹é˜Ÿåˆ—ä»¥åŠå¤§å°ï¼Œä¸€èˆ¬é€‰æ‹©<code>SO_BACKLOG</code></li>
<li><code>childOption</code>ï¼šè®¾ç½®ä¿æŒæ´»åŠ¨è¿æ¥çŠ¶æ€ï¼Œé€‰æ‹©<code>SO_KEEPALIVE</code></li>
<li><code>handler</code>ï¼šç»™<code>bossGroup</code>è®¾ç½®<code>Handler</code></li>
<li><code>childHandler</code>ï¼šç»™<code>workerGroup</code>è®¾ç½®<code>Hadnler</code></li>
</ol>
</li>
<li><code>ServerBootStrap</code>ç»‘å®šç«¯å£ï¼Œè®¾ç½®åŒæ­¥ï¼Œå¹¶ä¸”ç›‘å¬é€šé“å…³é—­äº‹ä»¶</li>
</ol>
<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<ol>
<li>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç»„<code>group</code></li>
<li>åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¯¹è±¡<code>BootStrap</code></li>
<li>é“¾å¼ç¼–ç¨‹é…ç½®<code>BootStrap</code>çš„å‚æ•°<ol>
<li><code>group</code>ï¼šè®¾ç½®çº¿ç¨‹ç»„<code>group</code></li>
<li><code>channel</code>ï¼šè®¾ç½®é€šé“å®ç°ï¼Œä¸€èˆ¬é€‰æ‹©<code>NioSocketChannel</code></li>
<li><code>handler</code>ï¼šè®¾ç½®<code>Handler</code></li>
</ol>
</li>
<li><code>BootStrap</code>ç»‘å®šç«¯å£ï¼Œè®¾ç½®åŒæ­¥ï¼Œå¹¶ä¸”ç›‘å¬é€šé“å…³é—­äº‹ä»¶</li>
</ol>
<blockquote>
<p>å¸¸è§Handler</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Handler</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SimpleChannelInboundHandler</td>
<td align="center">å¤„ç†é€šä¿¡(æœåŠ¡å™¨æœ€å¸¸ç”¨)</td>
</tr>
<tr>
<td align="center">IdleStateHandler</td>
<td align="center">æ£€æµ‹ç©ºé—²çŠ¶æ€(å¿ƒè·³æ£€æµ‹)</td>
</tr>
<tr>
<td align="center">WebSocketServerProtocolHandler</td>
<td align="center">å°†httpåè®®å‡çº§wsåè®®ï¼Œä¿æŒé•¿è¿æ¥</td>
</tr>
</tbody></table>
<blockquote>
<p>Handlerå¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Method</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">handlerAdded(ChannelHandlerContext ctx)</td>
<td align="center">è¿æ¥å»ºç«‹ï¼Œä¸€æ—¦å»ºç«‹è¿æ¥ï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„æ–¹æ³•</td>
</tr>
<tr>
<td align="center">handlerRemoved(ChannelHandlerContext ctx)</td>
<td align="center">è¿æ¥æ–­å¼€ï¼Œå°†XXå®¢æˆ·ç¦»çº¿ä¿¡æ¯æ¨é€ç»™å½“å‰åœ¨çº¿å®¢æˆ·</td>
</tr>
<tr>
<td align="center">channelActive(ChannelHandlerContext ctx)</td>
<td align="center">è¡¨ç¤ºchannelå¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæç¤ºXXä¸Šçº¿</td>
</tr>
<tr>
<td align="center">channelInactive(ChannelHandlerContext ctx)</td>
<td align="center">è¡¨ç¤ºchannelå¤„äºéæ´»åŠ¨çŠ¶æ€ï¼Œæç¤ºXXç¦»çº¿</td>
</tr>
<tr>
<td align="center">channelRead0(ChannelHandlerContext channelHandlerContext, String s)</td>
<td align="center">è¯»å–æ•°æ®ï¼Œå¹¶è¿›è¡Œæ¶ˆæ¯è½¬å‘</td>
</tr>
<tr>
<td align="center">exceptionCaught(ChannelHandlerContext ctx, Throwable cause)</td>
<td align="center">å¼‚å¸¸å¤„ç†</td>
</tr>
<tr>
<td align="center">userEventTriggered(ChannelHandlerContext ctx, Object evt)</td>
<td align="center">äº‹ä»¶è§¦å‘å™¨ã€‚åœ¨<code>IdleStateHandler</code>åé¢åŠ ä¸Šä¸€ä¸ªè§¦å‘å™¨ï¼Œå¯ä»¥æ£€æµ‹å¿ƒè·³ã€‚</td>
</tr>
</tbody></table>
<hr>
<p>æ—¶éš”7ä¸ªæœˆï¼Œå’•å˜çš„protobufå¬å”¤æˆ‘ç»­æ›´äº†ã€‚</p>
<h2 id="6-ProtoBuf"><a href="#6-ProtoBuf" class="headerlink" title="6 ProtoBuf"></a>6 ProtoBuf</h2><h3 id="6-1-ç¼–ç è§£ç "><a href="#6-1-ç¼–ç è§£ç " class="headerlink" title="6.1 ç¼–ç è§£ç "></a>6.1 ç¼–ç è§£ç </h3><blockquote>
<p>åŸºæœ¬ä»‹ç»</p>
</blockquote>
<ul>
<li>ç¼–å†™ç½‘ç»œåº”ç”¨ç¨‹åºæ—¶ï¼Œå› ä¸ºæ•°æ®åœ¨ç½‘ç»œä¸­ä¼ è¾“çš„éƒ½æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç æ•°æ®ï¼Œåœ¨å‘é€æ•°æ®æ—¶å°±éœ€è¦ç¼–ç ï¼Œæ¥æ”¶æ•°æ®æ—¶å°±éœ€è¦è§£ç ã€‚</li>
<li>codec(ç¼–è§£ç å™¨)çš„ç»„æˆéƒ¨åˆ†æœ‰ä¸¤ä¸ªï¼šdecoder(è§£ç å™¨)å’Œencoder(ç¼–ç å™¨)ã€‚encoderè´Ÿè´£æŠŠä¸šåŠ¡æ•°æ®è½¬æ¢æˆå­—èŠ‚ç æ•°æ®ï¼Œdecoderè´Ÿè´£æŠŠå­—èŠ‚ç æ•°æ®è½¬æ¢æˆä¸šåŠ¡æ•°æ®ã€‚</li>
</ul>
<blockquote>
<p>Nettyæœ¬èº«çš„ç¼–ç è§£ç çš„æœºåˆ¶å’Œé—®é¢˜åˆ†æ</p>
</blockquote>
<p>Nettyæä¾›äº†ä¸€äº›ç¼–è§£ç å™¨ï¼ŒStringEncoder(å­—ç¬¦ä¸²æ•°æ®ç¼–ç å™¨)ã€StringDecoder(å­—ç¬¦ä¸²æ•°æ®è§£ç å™¨)ã€ObjectEncoder(Javaå¯¹è±¡ç¼–ç å™¨)ã€ObjectDecoder(Javaå¯¹è±¡è§£ç å™¨)ã€‚ä½†æ˜¯åº•å±‚ä½¿ç”¨çš„ä»ç„¶æ˜¯Javaåºåˆ—åŒ–æŠ€æœ¯ï¼Œå­˜åœ¨å¦‚ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>æ— æ³•è·¨è¯­è¨€(æ¯”å¦‚æœåŠ¡å™¨æ˜¯Javaå†™çš„ï¼Œå°±è¦æ±‚å®¢æˆ·ç«¯ä¹Ÿå¿…é¡»æ˜¯Javaå†™çš„)</li>
<li>åºåˆ—åŒ–åçš„ä½“ç§¯å¤ªå¤§ï¼Œæ˜¯äºŒè¿›åˆ¶ç¼–ç çš„5å€å¤š</li>
<li>åºåˆ—åŒ–æ€§èƒ½å¤ªä½</li>
</ul>
<h3 id="6-2-Protobuf"><a href="#6-2-Protobuf" class="headerlink" title="6.2 Protobuf"></a>6.2 Protobuf</h3><blockquote>
<p>ğŸ““å®˜æ–¹æ–‡æ¡£(VPN)ï¼š<a href="https://developers.google.com/protocol-buffers/docs/proto">protocol-buffers</a></p>
</blockquote>
<blockquote>
<p>åŸºæœ¬ä»‹ç»</p>
</blockquote>
<ol>
<li>ProtoBufæ˜¯Googleå‘å¸ƒçš„å¼€æºé¡¹ç›®ï¼Œå…¨ç§°Google Protocol Buffersï¼Œæ˜¯ä¸€ç§è½»ä¾¿æç¬‘çš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œå¯ä»¥ç”¨äºç»“æ„åŒ–æ•°æ®ä¸²è¡ŒåŒ–ï¼Œæˆ–è€…è¯´åºåˆ—åŒ–ã€‚å®ƒå¾ˆé€‚åˆåšæ•°æ®å­˜å‚¨æˆ–è€…RPC(è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ remote procedure call)æ•°æ®äº¤æ¢æ ¼å¼ã€‚</li>
<li>ProtoBufæ˜¯ä»¥messageçš„æ–¹å¼æ¥ç®¡ç†æ•°æ®çš„ï¼Œæ”¯æŒè·¨å¹³å°ã€è·¨è¯­è¨€ã€‚</li>
<li>ç›®å‰å¾ˆå¤šå…¬å¸ï¼šhttp + json =&gt; tcp + protobuf</li>
</ol>
<blockquote>
<p>ç®€å•demo</p>
</blockquote>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>; <span class="comment">// ç‰ˆæœ¬</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;StudentPOJO&quot;</span>; <span class="comment">// ç”Ÿæˆå¤–éƒ¨ç±»ååŒæ—¶ä¹Ÿæ˜¯æ–‡ä»¶å</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// protobufä½¿ç”¨messageç®¡ç†æ•°æ®</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä¼šåœ¨StudentPOJOå¤–éƒ¨ç±»ç”Ÿæˆä¸€ä¸ªå†…éƒ¨ç±»Studentï¼Œä»–æ˜¯çœŸæ­£å‘é€çš„POJOå¯¹è±¡</span></span><br><span class="line">  <span class="built_in">int32</span> id = <span class="number">1</span>; <span class="comment">// Studentç±»ä¸­æœ‰ä¸€ä¸ªå±æ€§åå­—ä¸ºidï¼Œç±»å‹ä¸ºint32(protobufæ•´æ•°)ï¼Œ1è¡¨ç¤ºå±æ€§åºå·</span></span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœåŠ¡å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.codec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kag.codec.generated.StudentPOJO;</span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.protobuf.ProtobufDecoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            StudentPOJO.Student student = (StudentPOJO.Student) msg;</span><br><span class="line">            System.out.printf(<span class="string">&quot;student[id = %d, name = %s]\n&quot;</span>, student.getId(), student.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            serverBootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class).option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            ChannelPipeline pipeline = socketChannel.pipeline();</span><br><span class="line">                            pipeline.addLast(<span class="string">&quot;decoder&quot;</span>, <span class="keyword">new</span> ProtobufDecoder(StudentPOJO.Student.getDefaultInstance()));</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> NettyServerHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(<span class="number">3333</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.codec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kag.codec.generated.StudentPOJO;</span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.protobuf.ProtobufEncoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            ctx.writeAndFlush(StudentPOJO.Student.newBuilder().setId(<span class="number">1</span>).setName(<span class="string">&quot;KHighness&quot;</span>).build());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Bootstrap clietBootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            clietBootstrap.group(group)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            ChannelPipeline pipeline = socketChannel.pipeline();</span><br><span class="line">                            pipeline.addLast(<span class="string">&quot;encoder&quot;</span>, <span class="keyword">new</span> ProtobufEncoder());</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> NettyClientHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            ChannelFuture channelFuture = clietBootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">3333</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-3-å¤šç§ç±»å‹"><a href="#6-3-å¤šç§ç±»å‹" class="headerlink" title="6.3 å¤šç§ç±»å‹"></a>6.3 å¤šç§ç±»å‹</h3><p>åœ¨protoæ–‡ä»¶ä¸­ä½¿ç”¨dataTypeæ ‡è¯†ç±»å‹</p>
<blockquote>
<p>MyDataInfo</p>
</blockquote>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> optimize_for = SPEED; <span class="comment">// åŠ é€Ÿè§£æ</span></span><br><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">&quot;MyDataInfo&quot;</span>; <span class="comment">// æŒ‡å®šå¤–éƒ¨ç±»å</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">MyMessage</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">DataType</span> </span>&#123;</span><br><span class="line">    StudentType = <span class="number">0</span>;</span><br><span class="line">    WorkerType = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ‡è¯†ä¼ é€’çš„æ˜¯å“ªä¸ªæšä¸¾ç±»å‹</span></span><br><span class="line">  DataType data_type = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ‡è¯†æ¯æ¬¡æšä¸¾ç±»å‹æœ€å¤šåªèƒ½å‡ºç°å…¶ä¸­ä¸€ä¸ªï¼ŒèŠ‚çœç©ºé—´</span></span><br><span class="line">  <span class="keyword">oneof</span> dataBody &#123;</span><br><span class="line">    Student student = <span class="number">2</span>;</span><br><span class="line">    Worker worker = <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">  <span class="built_in">int32</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Worker</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> age = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœåŠ¡å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.codec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kag.codec.generated.MyDataInfo;</span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.protobuf.ProtobufDecoder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">MyDataInfo</span>.<span class="title">MyMessage</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext channelHandlerContext, MyDataInfo.MyMessage myMessage)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®DataTypeæ˜¾ç¤º</span></span><br><span class="line">            MyDataInfo.MyMessage.DataType dataType = myMessage.getDataType();</span><br><span class="line">            <span class="keyword">if</span> (dataType == MyDataInfo.MyMessage.DataType.StudentType) &#123;</span><br><span class="line">                MyDataInfo.Student student = myMessage.getStudent();</span><br><span class="line">                System.out.printf(<span class="string">&quot;Student[id = %d, name = %s]\n&quot;</span>, student.getId(), student.getName());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataType == MyDataInfo.MyMessage.DataType.WorkerType) &#123;</span><br><span class="line">                MyDataInfo.Worker worker = myMessage.getWorker();</span><br><span class="line">                System.out.printf(<span class="string">&quot;Worker[name = %s, age = %d]\n&quot;</span>, worker.getName(), worker.getAge());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;ä¼ è¾“ç±»å‹ä¸å¯¹&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            serverBootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class).option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)</span><br><span class="line">                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            ChannelPipeline pipeline = socketChannel.pipeline();</span><br><span class="line">                            pipeline.addLast(<span class="string">&quot;decoder&quot;</span>, <span class="keyword">new</span> ProtobufDecoder(MyDataInfo.MyMessage.getDefaultInstance()));</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> NettyServerHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            ChannelFuture channelFuture = serverBootstrap.bind(<span class="number">3333</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kag.codec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kag.codec.generated.MyDataInfo;</span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.protobuf.ProtobufEncoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-05-31</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line">            <span class="keyword">int</span> randomValue = random.nextInt(<span class="number">2</span>);</span><br><span class="line">            MyDataInfo.MyMessage myMessage = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (randomValue == <span class="number">0</span>) &#123; <span class="comment">// å‘é€Studentå¯¹è±¡</span></span><br><span class="line">                myMessage = MyDataInfo.MyMessage.newBuilder().setDataType(MyDataInfo.MyMessage.DataType.StudentType)</span><br><span class="line">                        .setStudent(MyDataInfo.Student.newBuilder().setId(<span class="number">2</span>).setName(<span class="string">&quot;FlowerK&quot;</span>).build()).build();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// å‘é€Workerå¯¹è±¡</span></span><br><span class="line">                myMessage = MyDataInfo.MyMessage.newBuilder().setDataType(MyDataInfo.MyMessage.DataType.WorkerType)</span><br><span class="line">                        .setWorker(MyDataInfo.Worker.newBuilder().setName(<span class="string">&quot;RubbishK&quot;</span>).setAge(<span class="number">19</span>).build()).build();</span><br><span class="line">            &#125;</span><br><span class="line">            ctx.writeAndFlush(myMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Bootstrap clietBootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            clietBootstrap.group(group)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            ChannelPipeline pipeline = socketChannel.pipeline();</span><br><span class="line">                            pipeline.addLast(<span class="string">&quot;encoder&quot;</span>, <span class="keyword">new</span> ProtobufEncoder());</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> NettyClientHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            ChannelFuture channelFuture = clietBootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">3333</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-Handler"><a href="#7-Handler" class="headerlink" title="7. Handler"></a>7. Handler</h2><h3 id="7-1-ä»‹ç»"><a href="#7-1-ä»‹ç»" class="headerlink" title="7.1 ä»‹ç»"></a>7.1 ä»‹ç»</h3><blockquote>
<p>æ¦‚è¿°</p>
</blockquote>
<p>å†å›é¡¾<code>ChannelHandler</code>å’Œ<code>ChannelPipeline</code>çš„å…³ç³»ï¼Œå¯ä»¥å°†<code>ChannelPipeline</code>ç†è§£ä¸ºä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œ<code>ChannelHandlerContext</code>çœ‹åšé“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ<code>ChannelHandler</code>åˆ™ä¸ºæ¯ä¸ªèŠ‚ç‚¹ä¸­ä¿å­˜çš„ä¸€ä¸ªå±æ€§å¯¹è±¡ã€‚</p>
<ul>
<li><p><code>ChannelHandler</code>å……å½“äº†å¤„ç†å…¥ç«™å’Œå‡ºç«™æ•°æ®çš„åº”ç”¨ç¨‹åºé€»è¾‘çš„å®¹å™¨ã€‚å®ç°<code>ChannelInboundHandler</code>æ¥å£å¤„ç†å…¥ç«™ä¸šåŠ¡ï¼Œå®ç°<code>ChannelOutboundHandler</code>æ¥å£å¤„ç†å‡ºç«™ä¸šåŠ¡ã€‚ </p>
</li>
<li><p><code>ChannelPipeline</code>æä¾›äº†<code>ChannelHandler</code>é“¾çš„å®¹å™¨ã€‚ä»¥å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¸ºä¾‹ï¼Œå¦‚æœäº‹ä»¶çš„è¿åŠ¨æ–¹å‘æ˜¯ä»å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„ï¼Œé‚£æˆ‘ä»¬ç§°è¿™äº›äº‹ä»¶ä¸ºå‡ºç«™çš„ï¼Œå³å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡ç«¯çš„æ•°æ®ä¼šé€šè¿‡<code>Pipeline</code>ä¸­ä¸€ç³»åˆ—<code>ChannelOutboundHandler</code>ï¼Œå¹¶è¢«è¿™äº›<code>Handler</code>å¤„ç†ï¼Œåä¹‹åˆ™ç§°ä¸ºå…¥ç«™ã€‚ä»¥æœåŠ¡ç«¯ä¸ºä¾‹ï¼Œæ¥æ”¶æ•°æ®çš„è¿‡ç¨‹å°±æ˜¯å…¥ç«™ï¼Œå‘é€æ•°æ®çš„è¿‡ç¨‹å°±æ˜¯å‡ºç«™ã€‚ </p>
</li>
</ul>
<blockquote>
<p>ç±»å›¾</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20210601112523991.png" class="" title="image-20210601112523991">

<p><code>InboundHandler</code>å¤„ç†å…¥ç«™ï¼Œ<code>OutboundHandler</code>å¤„ç†å‡ºç«™ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨æˆ‘ä»¬æ¥æ”¶æ•°æ®æ—¶å°†æ•°æ®è§£ç åï¼Œå°±è¿›è¡Œä¸šåŠ¡çš„ç›¸å…³å¤„ç†ï¼Œæ‰€ä»¥ä¸Šå›¾çš„å…¥ç«™çš„å¸¸ç”¨ç±»æ›´å¤šã€‚åœ¨æ•°æ®å‡ºç«™æ—¶ï¼Œä¸€èˆ¬æˆ‘ä»¬åªéœ€è¦å°†æ•°æ®ç¼–ç åç›´æ¥å‘å‡ºã€‚</p>
<p>ç”±äºä¸å¯èƒ½çŸ¥é“è¿œç¨‹èŠ‚ç‚¹æ˜¯å¦ä¼šä¸€æ¬¡æ€§å‘é€ä¸€ä¸ªå®Œæ•´çš„ä¿¡æ¯ï¼Œtcpæœ‰å¯èƒ½å‡ºç°ç²˜åŒ…æ‹†åŒ…çš„é—®é¢˜ï¼Œ<code>ByteToMessageDecoder</code>ä¼šå¯¹å…¥ç«™æ•°æ®è¿›è¡Œç¼“å†²ï¼Œç›´åˆ°å®ƒå‡†å¤‡å¥½è¢«å¤„ç†ã€‚</p>
<h3 id="7-2-ç†è§£"><a href="#7-2-ç†è§£" class="headerlink" title="7.2 ç†è§£"></a>7.2 ç†è§£</h3><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ©™è‰²è¡¨ç¤ºå‡ºç«™ï¼Œç»¿è‰²è¡¨ç¤ºå…¥ç«™ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20210604162054951.png" class="" title="image-20210604162054951">

<p>å½“æˆ‘ä»¬çš„NettyæœåŠ¡å™¨åˆå§‹åŒ–æ—¶ï¼Œåœ¨<code>ChannelInitializer</code>ç±»ä¸­è¿™æ ·å®ç°<code>initChannel</code>ï¼Œå°±ä¼šè·å¾—ä¸Šå›¾çš„Handleré“¾è¡¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ChannelPipeline pipeline = socketChannel.pipeline();</span><br><span class="line">    pipeline.addLast(<span class="keyword">new</span> LongToByteEncoder());  <span class="comment">// out</span></span><br><span class="line">    pipeline.addLast(<span class="keyword">new</span> ByteToLongDecoder());  <span class="comment">// in</span></span><br><span class="line">    pipeline.addLast(<span class="keyword">new</span> OutBoundHandler());    <span class="comment">// out</span></span><br><span class="line">    pipeline.addLast(<span class="keyword">new</span> InBoundHandler());     <span class="comment">// in</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ä¸€ä¸ªè¯·æ±‚æ¥äº†çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå°†è¯·æ±‚å‘ç»™<code>pipeline</code>ä¸­ä½äºé“¾è¡¨å¤´éƒ¨çš„<code>Handler</code>ã€‚</p>
<p>é¦–å…ˆ<code>LongToByteEncoder</code>æ¥æ”¶åˆ°å…¥ç«™è¯·æ±‚ï¼Œä½†æ˜¯å®ƒå±äº<code>OutBound</code>ï¼Œæ‰€ä»¥æ”¶åˆ°å…¥ç«™è¯·æ±‚æ—¶ä¸ä½œå¤„ç†ï¼Œç›´æ¥è½¬å‘ç»™å®ƒçš„ä¸‹ä¸€ä¸ª<code>ByteToLongDecoder</code>ï¼Œå› ä¸ºå®ƒå±äº<code>InBound</code>ï¼Œæ‰€ä»¥éœ€è¦å°†è¯·æ±‚çš„æ•°æ®è¿›è¡Œå¤„ç†ï¼Œç„¶åè½¬å‘ç»™ä¸‹ä¸€ä¸ªã€‚ä¹‹ååˆæ˜¯<code>OutBoundHandler</code>ï¼Œä¸ä½œå¤„ç†ï¼Œæœ€ååˆ°äº†<code>InBoundHandler</code>ï¼Œè¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚</p>
<p>å¦‚æœéœ€è¦è¿”å›æ•°æ®ï¼Œæˆ‘ä»¬å°±è°ƒç”¨<code>writeAndFlush()</code>æ–¹æ³•ã€‚å½“ä»–ä¸€è°ƒç”¨ï¼Œå°±ä¼šè§¦å‘å‡ºç«™çš„è¯·æ±‚ï¼Œç„¶åå°±ç”±å½“å‰æ‰€åœ¨çš„<code>Handler</code>å¾€å›è°ƒç”¨ã€‚å¾€å›è°ƒç”¨çš„å›¾ä¸­ï¼Œå¦‚æœé‡åˆ°<code>InBound</code>å°±ç›´æ¥è·³è¿‡ï¼Œè½¬å‘ç»™ä¸‹ä¸€ä¸ª<code>Handler</code>ï¼Œç›´åˆ°æœ€åæ¶ˆæ¯è¿”å›ã€‚</p>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<ul>
<li><code>InBoundHandler</code>çš„è°ƒç”¨é¡ºåºå’Œ<code>pipeline</code>çš„æ·»åŠ é¡ºåºç›¸åŒ</li>
<li><code>OutBoundHandler</code>çš„è°ƒç”¨é¡ºåºå’Œ<code>pipeline</code>çš„æ·»åŠ é¡ºåºç›¸å</li>
<li><code>InBoundHandler</code>ä¸€æ—¦è¿›è¡Œ<code>writeAndFlush</code>ï¼Œåªæœ‰è¿™ä¸ª<code>InBoundHandler</code>ä¹‹å‰æ·»åŠ çš„<code>OutBoundHandler</code>èƒ½å¤Ÿå¤„ç†ä»–</li>
<li><code>pipeline</code>çš„æœ«å°¾ä¸èƒ½æœ‰<code>OutBoundHandler</code>ï¼Œå› ä¸ºå‰åçš„<code>InBoundHandler</code>å¤„ç†å®Œæ•°æ®è¿”å›æ¶ˆæ¯è°ƒç”¨<code>writeAndFlush</code>æ—¶ï¼Œæœ€åä¸€ä¸ª<code>OutBoundHandler</code>æ— æ³•è¢«è°ƒç”¨ã€‚æ‰€ä»¥å¹³å¸¸æˆ‘ä»¬å°†<code>OutBoundHandler</code>å†™åœ¨å‰é¢ï¼Œ<code>InBoundHandler</code>å†™åœ¨åé¢ã€‚</li>
</ul>
<h3 id="7-3-å¸¸ç”¨"><a href="#7-3-å¸¸ç”¨" class="headerlink" title="7.3 å¸¸ç”¨"></a>7.3 å¸¸ç”¨</h3><blockquote>
<p>æ¦‚è¿°</p>
</blockquote>
<p>å…¥ç«™è§£ç ï¼Œå‡ºæ ˆç¼–ç ï¼ŒNettyæä¾›äº†å¾ˆå¤šç¼–è§£ç å™¨ã€‚</p>
<p>ï¼ˆ1ï¼‰è§£ç å™¨<code>ByteToMessageDecoder</code></p>
<p>ç”±äºä¸å¯èƒ½çŸ¥é“è¿œç¨‹èŠ‚ç‚¹æ˜¯å¦ä¼šä¸€æ¬¡æ€§å‘é€ä¸€ä¸ªå®Œæ•´çš„ä¿¡æ¯ï¼ŒTCPæœ‰å¯èƒ½å‡ºç°ç²˜åŒ…æ‹†åŒ…çš„é—®é¢˜ï¼Œè¿™ä¸ªç±»ä¼šå¯¹å…¥ç«™æ•°æ®è¿›è¡Œç¼“å†²ï¼Œç›´åˆ°å®ƒå‡†å¤‡å¥½è¢«å¤„ç†ã€‚</p>
<p>ï¼ˆ2ï¼‰è§£ç å™¨<code>ReplayingDecoder</code></p>
<p><code>ReplayingDecoder</code>æ‰©å±•äº†<code>ByteToMessageDecoder</code>ï¼Œä½¿ç”¨è¿™ä¸ªleukemiaï¼Œæˆ‘ä»¬ä¸å¿…è°ƒç”¨<code>readableBytes()</code>æ–¹æ³•ã€‚æ³›å‹å‚æ•°æŒ‡å®šäº†ç”¨æˆ·çŠ¶æ€ç®¡ç†çš„ç±»å‹ï¼Œå…¶ä¸­<code>Void</code>ä»£è¡¨ä¸éœ€è¦çŠ¶æ€ç®¡ç†ã€‚</p>
<p>ä½¿ç”¨æ–¹ä¾¿ï¼Œä½†æ˜¯ä¹Ÿæœ‰å±€é™æ€§ï¼š</p>
<ul>
<li>å¹¶ä¸æ˜¯æ‰€æœ‰çš„<code>ByteBuf</code>æ“ä½œéƒ½è¢«æ”¯æŒï¼Œå¦‚æœè°ƒç”¨äº†ä¸€ä¸ªä¸è¢«æ”¯æŒçš„æ–¹æ³•ï¼Œå°†ä¼šæŠ›å‡ºä¸€ä¸ª<code>UnsupportedOperationException</code>ã€‚</li>
<li><code>ReplayingDecoder</code>åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ç¨æ…¢äº<code>ByteToMessageDecoder</code>ï¼Œä¾‹å¦‚ç½‘ç»œç¼“æ…¢å¹¶æ¶ˆæ¯æ ¼å¼å¤æ‚æ—¶ï¼Œæ¶ˆæ¯ä¼šè¢«æ‹†æˆå¤šä¸ªç¢ç‰‡ã€‚</li>
</ul>
<p>ï¼ˆ3ï¼‰å…¶ä»–è§£ç å™¨</p>
<ul>
<li><code>LineBasedFrameDecoder</code>ï¼šä½¿ç”¨è¡Œå°¾æ§åˆ¶ç¬¦ï¼ˆ\nï¼‰ä½œä¸ºåˆ†éš”ç¬¦ç±»è§£ææ•°æ®ã€‚</li>
<li><code>DelimiterBasedFrameDecoder</code>ï¼šä½¿ç”¨è‡ªå®šä¹‰çš„ç‰¹æ®Šå­—ç¬¦ä½œä¸ºæ¶ˆæ¯çš„åˆ†éš”ç¬¦ã€‚</li>
<li><code>HttpObjectDecoder</code>ï¼šHTTPæ•°æ®è§£ç å™¨ã€‚</li>
<li><code>LengthFieldBasedFrameDecoder</code>ï¼šé€šè¿‡åˆ¶å®šé•¿åº¦æ¥è¡¨ç¤ºæ•´åŒ…ä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨çš„å¤„ç†é»åŒ…çš„åŠåŒ…æ¶ˆæ¯ã€‚</li>
</ul>
<blockquote>
<p>æ³¨æ„</p>
</blockquote>
<ul>
<li>ä¸è®ºæ˜¯è§£ç å™¨è¿˜æ˜¯ç¼–ç å™¨ï¼Œæ¥æ”¶çš„æ¶ˆæ¯ç±»å‹å¿…é¡»ä¸å¾…å¤„ç†çš„æ¶ˆæ¯ç±»å‹ä¸€è‡´ï¼Œå¦åˆ™è¯¥Handlerä¸ä¼šè¢«æ‰§è¡Œã€‚</li>
<li>åœ¨è§£ç å™¨è¿›è¡Œæ•°æ®è§£ç æ—¶ï¼Œéœ€è¦åˆ¤æ–­ç¼“å­˜åŒº<code>ByteBuf</code>çš„æ•°æ®æ˜¯å¦è¶³å¤Ÿï¼Œå¦åˆ™æ¥æ”¶åˆ°çš„ç»“æœå¯èƒ½ä¼šä¸æœŸæœ›ç»“æœä¸ä¸€è‡´ã€‚</li>
</ul>
<h3 id="7-3-å®ä¾‹"><a href="#7-3-å®ä¾‹" class="headerlink" title="7.3 å®ä¾‹"></a>7.3 å®ä¾‹</h3><blockquote>
<p>è¦æ±‚</p>
</blockquote>
<ul>
<li>ä½¿ç”¨è‡ªå®šä¹‰çš„ç¼–ç å™¨å’Œè§£ç å™¨æ¥è¯´æ˜Netty Handlerè°ƒç”¨æœºåˆ¶</li>
<li>å®¢æˆ·ç«¯å‘é€Longç±»å‹æ•°æ®åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å‘é€Longç±»å‹æ•°æ®åˆ°å®¢æˆ·ç«¯</li>
</ul>
<blockquote>
<p>ç¼–è§£ç å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Long=&gt;Byteç¼–ç å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LongToByteEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = Logger.getLogger(LongToByteEncoder.class);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx  ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg  å‡ºç«™æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out  ç¼–ç åçš„æ•°æ®ï¼Œä¼ ç»™ä¸‹ä¸€ä¸ªhandler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Long msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;LongToByteEncoder =&gt; ç¼–ç &quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;msg: &quot;</span> + msg);</span><br><span class="line">        out.writeLong(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Byte=&gt;Longè§£ç å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteToLongDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = Logger.getLogger(ByteToLongDecoder.class);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx  ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in   å…¥ç«™æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out  è§£ç åçš„æ•°æ®ï¼Œä¼ ç»™ä¸‹ä¸€ä¸ªhandler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ByteToLongDecoder =&gt; è§£ç &quot;</span>);</span><br><span class="line">        <span class="comment">// Longå…«ä¸ªå­—èŠ‚</span></span><br><span class="line">        <span class="keyword">if</span> (in.readableBytes() &gt;= <span class="number">8</span>) &#123;</span><br><span class="line">            out.add(in.readLong());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœåŠ¡å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Server</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NioEventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        NioEventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">            serverBootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> ServerInitializer());</span><br><span class="line">            ChannelFuture future = serverBootstrap.bind(<span class="number">3333</span>).sync();</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Serveråˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ChannelPipeline pipeline = socketChannel.pipeline();</span><br><span class="line">        <span class="comment">// åŠ å…¥å‡ºç«™Handlerï¼Œæ•°æ®ç¼–ç </span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> LongToByteEncoder());</span><br><span class="line">        <span class="comment">// åŠ å…¥å…¥ç«™Handlerï¼Œæ•°æ®è§£ç </span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> ByteToLongDecoder());</span><br><span class="line">        <span class="comment">// åŠ å…¥è‡ªå®šä¹‰Handlerï¼Œå¤„ç†ä¸šåŠ¡</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> ServerHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Serverä¸šåŠ¡å¤„ç†Handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = Logger.getLogger(ServerHandler.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, Long msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ”¶åˆ°å®¢æˆ·ç«¯æ•°æ®ï¼š&quot;</span> + msg);</span><br><span class="line">        log.info(<span class="string">&quot;å‘é€åˆå§‹åŒ–æ•°æ®ï¼š&quot;</span> + <span class="number">98765L</span>);</span><br><span class="line">        ctx.writeAndFlush(<span class="number">98765L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.error(cause.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Client</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NioEventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            bootstrap.group(group)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> ClientInitializer());</span><br><span class="line">            ChannelFuture channelFuture = bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">3333</span>).sync();</span><br><span class="line">            channelFuture.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Clientåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientInitializer</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ChannelPipeline pipeline = socketChannel.pipeline();</span><br><span class="line">        <span class="comment">// åŠ å…¥å‡ºç«™Handlerï¼Œæ•°æ®ç¼–ç </span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> LongToByteEncoder());</span><br><span class="line">        <span class="comment">// åŠ å…¥å…¥ç«™Handlerï¼Œæ•°æ®ç¼–ç </span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> ByteToLongDecoder());</span><br><span class="line">        <span class="comment">// åŠ å…¥è‡ªå®šä¹‰Handlerï¼Œå¤„ç†ä¸šåŠ¡</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> ClientHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Clientä¸šåŠ¡å¤„ç†Handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = Logger.getLogger(ClientHandler.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext channelHandlerContext, Long msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;å‘é€åˆå§‹åŒ–æ•°æ®ï¼š&quot;</span> + <span class="number">12345L</span>);</span><br><span class="line">        ctx.writeAndFlush(<span class="number">12345L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="8-TCP"><a href="#8-TCP" class="headerlink" title="8. TCP"></a>8. TCP</h2><h3 id="8-1-é—®é¢˜ä»‹ç»"><a href="#8-1-é—®é¢˜ä»‹ç»" class="headerlink" title="8.1 é—®é¢˜ä»‹ç»"></a>8.1 é—®é¢˜ä»‹ç»</h3><blockquote>
<p>TCPæ‹†åŒ…å’Œç²˜åŒ…</p>
</blockquote>
<ul>
<li>TCPæ˜¯é¢å‘è¿æ¥ã€é¢å‘å­—èŠ‚æµçš„ï¼Œæä¾›é«˜å¯é æ€§æœåŠ¡ã€‚æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½è¦æœ‰æˆå¯¹çš„socketï¼Œå› æ­¤ï¼Œå‘é€ç«¯ä¸ºäº†å°†å¤šä¸ªå‘ç»™æ¥æ”¶ç«¯çš„åŒ…ï¼Œæ›´æœ‰æ•ˆçš„å‘ç»™å¯¹æ–¹ï¼Œä½¿ç”¨äº†ä¼˜åŒ–æ–¹æ³•ï¼ˆMagleç®—æ³•ï¼‰ï¼Œå°†å¤šæ¬¡é—´éš”è¾ƒå°ä¸”æ•°æ®é‡å°çš„æ•°æ®ï¼Œåˆå¹¶æˆä¸€ä¸ªå¤§çš„æ•°æ®å—ï¼Œç„¶åè¿›è¡Œå°åŒ…ã€‚è¿™æ ·åšè™½ç„¶æé«˜äº†æ•ˆç‡ï¼Œä½†æ˜¯æ¥æ”¶ç«¯å°±éš¾äºåˆ†è¾¨å‡ºå®Œæ•´çš„æ•°æ®åŒ…ï¼Œå› ä¸ºé¢å‘æµçš„é€šä¿¡æ˜¯æ— æ¶ˆæ¯ä¿è¯è¾¹ç•Œçš„ã€‚</li>
<li>ç”±äºTCPæ— æ¶ˆæ¯ä¿æŠ¤è¾¹ç•Œï¼Œéœ€è¦åœ¨æ¥æ”¶ç«¯å¤„ç†æ¶ˆæ¯è¾¹ç•Œé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æ‹†åŒ…å’Œç²˜åŒ…é—®é¢˜ã€‚</li>
</ul>
<blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/TCP.png" class="" title="TCP">



<h3 id="8-2-å‡ºç°åœºæ™¯"><a href="#8-2-å‡ºç°åœºæ™¯" class="headerlink" title="8.2 å‡ºç°åœºæ™¯"></a>8.2 å‡ºç°åœºæ™¯</h3><p>ä½¿ç”¨ä»£ç æ¨¡æ‹Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡å™¨Handler</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">ByteBuf</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ByteBuf msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[msg.readableBytes()];</span><br><span class="line">        msg.readBytes(buffer);</span><br><span class="line">        String message = <span class="keyword">new</span> String(buffer);</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span> + message);</span><br><span class="line">        System.out.println(<span class="string">&quot;æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š&quot;</span> + ++count);</span><br><span class="line">        <span class="comment">// è¿”å›UUID</span></span><br><span class="line">        ctx.writeAndFlush(Unpooled.copiedBuffer(UUID.randomUUID().toString(), StandardCharsets.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¢æˆ·ç«¯Handler</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">ByteBuf</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ByteBuf msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[msg.readableBytes()];</span><br><span class="line">        msg.readBytes(buffer);</span><br><span class="line">        String message = <span class="keyword">new</span> String(buffer);</span><br><span class="line">        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span> + message);</span><br><span class="line">        System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š&quot;</span> + ++count);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="string">&quot;Hello, Khighness-&quot;</span> + i, StandardCharsets.UTF_8));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨çš„æ—¶å€™ï¼Œä¼šå‘æœåŠ¡å™¨å‘é€5æ¬¡<code>Hello, Khighness-i</code>ï¼ŒæœåŠ¡å™¨æ¯æ”¶åˆ°ä¸€ä¸ªæ¶ˆæ¯ä¼šè¿”å›ä¸€ä¸ª<code>UUID</code>ã€‚</p>
<p>è¿è¡ŒæœåŠ¡å™¨ï¼Œå¼€å¯ä¸‰ä¸ªå®¢æˆ·ç«¯ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Server</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šHello, Khighness<span class="literal">-0</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">1</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šHello, Khighness<span class="literal">-0</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">1</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šHello, Khighness<span class="literal">-1Hello</span>, Khighness<span class="literal">-2</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">2</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šHello, Khighness<span class="literal">-3Hello</span>, Khighness<span class="literal">-4</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">3</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šHello, Khighness<span class="literal">-0</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">1</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šHello, Khighness<span class="literal">-1</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">2</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šHello, Khighness<span class="literal">-2Hello</span>, Khighness<span class="literal">-3Hello</span>, Khighness<span class="literal">-4</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">3</span></span><br><span class="line"><span class="comment"># Client-1</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šf507ecd7<span class="literal">-fa87</span><span class="literal">-49d6</span><span class="literal">-a702</span><span class="literal">-7c25a999c729</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">1</span></span><br><span class="line"><span class="comment"># Client-2</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š<span class="number">6</span>cc98a92<span class="literal">-8f7e</span><span class="literal">-426e</span><span class="literal">-8d97</span><span class="literal">-59e46d06489b93775b56</span><span class="literal">-f04b</span><span class="literal">-4cde</span><span class="literal">-99b2</span><span class="literal">-2c46f1db70afb3d2d5a0</span><span class="literal">-e977</span><span class="literal">-4b43</span><span class="literal">-9796</span><span class="literal">-433d8a230ec2</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">1</span></span><br><span class="line"><span class="comment"># Client-3</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š<span class="number">18</span>da0b29<span class="literal">-8b10</span><span class="literal">-4bc1</span><span class="literal">-a390</span><span class="literal">-e72b3ecaa597443044ae</span><span class="literal">-8634</span><span class="literal">-4acb</span><span class="literal">-b8fd</span><span class="literal">-0c7409ce8baab50889ed</span><span class="literal">-2988</span><span class="literal">-484d</span><span class="literal">-a55f</span><span class="literal">-e91e15752e80</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">1</span></span><br></pre></td></tr></table></figure>



<h3 id="8-3-è§£å†³æ–¹æ¡ˆ"><a href="#8-3-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="8.3 è§£å†³æ–¹æ¡ˆ"></a>8.3 è§£å†³æ–¹æ¡ˆ</h3><p>å‘é€ç«¯æ¯å‘é€ä¸€æ¬¡æ¶ˆæ¯ï¼Œå°±éœ€è¦åœ¨æ¶ˆæ¯çš„å†…å®¹ä¹‹å‰æºå¸¦æ¶ˆæ¯çš„é•¿åº¦ï¼Œè¿™æ ·ï¼Œæ¥æ”¶ç«¯æ¯æ¬¡å…ˆæ¥æ”¶æ¶ˆæ¯çš„é•¿åº¦ï¼Œå†æ ¹æ®é•¿åº¦å»è¯»å–è¯¥æ¶ˆæ¯å‰©ä½™çš„å†…å®¹ã€‚å¦‚æœsocketä¸­è¿˜æœ‰æ²¡æœ‰è¯»å–çš„å†…å®¹ï¼Œä¹Ÿåªèƒ½æ”¾åœ¨ä¸‹ä¸€æ¬¡è¯»å–äº‹ä»¶ä¸­è¿›è¡Œã€‚</p>
<p>1ï¼‰ä½¿ç”¨è‡ªå®šä¹‰åè®®+ç¼–è§£ç å™¨æ¥è§£å†³</p>
<p>2ï¼‰å…³é”®å°±æ˜¯è¦è§£å†³æœåŠ¡å™¨ç«¯æ¯æ¬¡è¯»å–æ•°æ®é•¿åº¦çš„é—®é¢˜</p>
<blockquote>
<p>è‡ªå®šä¹‰åè®®åŒ…</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-06-06</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> åè®®åŒ…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProtocol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLen</span><span class="params">(<span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.len = len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getContent() &#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(<span class="keyword">byte</span>[] content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageProtocol</span><span class="params">(<span class="keyword">int</span> len, <span class="keyword">byte</span>[] content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.len = len;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è‡ªå®šä¹‰ç¼–ç å™¨</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @author KHighness</span><br><span class="line"> * @since 2021-06-06</span><br><span class="line"> * @apiNote è‡ªå®šä¹‰ç¼–ç å™¨</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class MessageEncoder extends MessageToByteEncoder&lt;MessageProtocol&gt; &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void encode(ChannelHandlerContext ctx, MessageProtocol msg, ByteBuf out) throws Exception &#123;</span><br><span class="line">        out.writeInt(msg.getLen());</span><br><span class="line">        out.writeBytes(msg.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è‡ªå®šä¹‰è§£ç å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-06-06</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> è‡ªå®šä¹‰è§£ç å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageDecoder</span> <span class="keyword">extends</span> <span class="title">ReplayingDecoder</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®é•¿åº¦è¯»å–</span></span><br><span class="line">        <span class="keyword">int</span> len = in.readInt();</span><br><span class="line">        <span class="keyword">byte</span>[] content = <span class="keyword">new</span> <span class="keyword">byte</span>[len];</span><br><span class="line">        in.readBytes(content);</span><br><span class="line">        <span class="comment">// å°è£…MessageProtocol</span></span><br><span class="line">        MessageProtocol messageProtocol = <span class="keyword">new</span> MessageProtocol(len, content);</span><br><span class="line">        out.add(messageProtocol);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æœåŠ¡å™¨</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-06-06</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Server</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">MessageProtocol</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, MessageProtocol msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            String message = <span class="keyword">new</span> String(msg.getContent(), StandardCharsets.UTF_8);</span><br><span class="line">            System.out.println(<span class="string">&quot;æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span> + message);</span><br><span class="line">            System.out.println(<span class="string">&quot;æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š&quot;</span> + ++count);</span><br><span class="line">            <span class="comment">// è¿”å›UUID</span></span><br><span class="line">            <span class="keyword">byte</span>[] content = UUID.randomUUID().toString().getBytes(StandardCharsets.UTF_8);</span><br><span class="line">            MessageProtocol messageProtocol = <span class="keyword">new</span> MessageProtocol(content.length, content);</span><br><span class="line">            ctx.writeAndFlush(messageProtocol);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NioEventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>);</span><br><span class="line">        NioEventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerBootstrap serverBootstrap = <span class="keyword">new</span> ServerBootstrap()</span><br><span class="line">                    .channel(NioServerSocketChannel.class).group(bossGroup, workerGroup)</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            socketChannel.pipeline()</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> MessageEncoder()).addLast(<span class="keyword">new</span> MessageDecoder()).addLast(<span class="keyword">new</span> ServerHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            serverBootstrap.bind(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">3333</span>).sync().channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021-06-06</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span> Client</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">MessageProtocol</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, MessageProtocol msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            String message = <span class="keyword">new</span> String(msg.getContent(), StandardCharsets.UTF_8);</span><br><span class="line">            System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š&quot;</span> + message);</span><br><span class="line">            System.out.println(<span class="string">&quot;å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š&quot;</span> + ++count);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                String msg = <span class="string">&quot;ä½ å¥½ï¼Œç‚’èœKæ®¿ä¸‹&quot;</span>;</span><br><span class="line">                <span class="keyword">byte</span>[] buffer = msg.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">                MessageProtocol messageProtocol = <span class="keyword">new</span> MessageProtocol(buffer.length, buffer);</span><br><span class="line">                ctx.writeAndFlush(messageProtocol);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NioEventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap()</span><br><span class="line">                    .group(group).channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            socketChannel.pipeline()</span><br><span class="line">                                    .addLast(<span class="keyword">new</span> MessageEncoder()).addLast(<span class="keyword">new</span> MessageDecoder()).addLast(<span class="keyword">new</span> ClientHandler());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            bootstrap.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">3333</span>).sync().channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æµ‹è¯•ç»“æœ</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Server</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ï¼Œç‚’èœKæ®¿ä¸‹</span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">1</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ï¼Œç‚’èœKæ®¿ä¸‹</span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">2</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ï¼Œç‚’èœKæ®¿ä¸‹</span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">3</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ï¼Œç‚’èœKæ®¿ä¸‹</span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">4</span></span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ï¼Œç‚’èœKæ®¿ä¸‹</span><br><span class="line">æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">5</span></span><br><span class="line"><span class="comment"># Client</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š<span class="number">3</span>e4a9945<span class="literal">-4a6b</span><span class="literal">-4867</span><span class="literal">-b144</span><span class="literal">-80d0d8b8e73a</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">1</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š<span class="number">39</span>d2cb2d<span class="literal">-99df</span><span class="literal">-417f</span><span class="literal">-9d0e</span><span class="literal">-9d52ced8fcf9</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">2</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š<span class="number">2</span>aa72ca6<span class="literal">-e47c</span><span class="literal">-4afa</span><span class="literal">-80b5</span><span class="literal">-5534861f4a5f</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">3</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š<span class="number">3</span>eecf174<span class="literal">-a724</span><span class="literal">-468b</span><span class="literal">-814d</span><span class="literal">-b252f2ada736</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">4</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š<span class="number">578</span>d7a67<span class="literal">-b46a</span><span class="literal">-48ab</span><span class="literal">-8793</span><span class="literal">-46e7064169dd</span></span><br><span class="line">å®¢æˆ·ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯æ•°ï¼š<span class="number">5</span></span><br></pre></td></tr></table></figure>



<h2 id="9-æºç "><a href="#9-æºç " class="headerlink" title="9. æºç "></a>9. æºç </h2><blockquote>
<p>ğŸš€ä¸‹è½½ï¼š<a href="https://repo1.maven.org/maven2/io/netty/netty-all">https://repo1.maven.org/maven2/io/netty/netty-all</a></p>
</blockquote>
<p>æœ‰æ—¶é—´å†çœ‹ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Netty</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ</title>
    <url>/posts/33708/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°"><a href="#1-æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°" class="headerlink" title="1. æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°"></a>1. æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°</h2><h3 id="1-1-å®šä¹‰"><a href="#1-1-å®šä¹‰" class="headerlink" title="1.1 å®šä¹‰"></a>1.1 å®šä¹‰</h3><p>MQ(Message Queue)ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œé€šè¿‡å…¸å‹çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹ï¼Œç”Ÿäº§è€…ä¸æ–­å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä¸æ–­çš„ä»é˜Ÿåˆ—ä¸­ è·å–æ¶ˆæ¯ï¼Œå› ä¸ºæ¶ˆæ¯çš„ç”Ÿäº§å’Œæ¶ˆè´¹éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œè€Œä¸”åªå…³å¿ƒæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶ï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘çš„ä¾µå…¥ï¼Œè½»æ¾çš„å®ç°ç³»ç»Ÿé—´è§£è€¦ï¼Œåˆ«åä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ã€‚é€šè¿‡åˆ©ç”¨é«˜æ•ˆå¯é çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶è¿›è¡Œå¹³å°æ— å…³çš„æ•°æ®äº¤æµï¼Œå¹¶åŸºäºæ•°æ®é€šä¿¡æ¥è¿›è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„é›†æˆã€‚</p>
<h3 id="1-2-åº”ç”¨åœºæ™¯"><a href="#1-2-åº”ç”¨åœºæ™¯" class="headerlink" title="1.2 åº”ç”¨åœºæ™¯"></a>1.2 åº”ç”¨åœºæ™¯</h3><ul>
<li>è·¨ç³»ç»Ÿæ•°æ®ä¼ é€’</li>
<li>é«˜å¹¶å‘æµé‡å‰Šå³°</li>
<li>æ•°æ®åˆ†å‘å’Œå¼‚æ­¥å¤„ç†</li>
<li>å¤§æ•°æ®åˆ†æä¼ é€’</li>
<li>åˆ†å¸ƒå¼äº‹åŠ¡</li>
</ul>
<h3 id="1-3-ä¸»æµä½¿ç”¨"><a href="#1-3-ä¸»æµä½¿ç”¨" class="headerlink" title="1.3 ä¸»æµä½¿ç”¨"></a>1.3 ä¸»æµä½¿ç”¨</h3><ol>
<li>ActiveMQ</li>
</ol>
<p>ActiveMQæ˜¯Apacheå‡ºå“ï¼Œèƒ½åŠ›å¼ºåŠ²çš„å¼€æºæ¶ˆæ¯ç³»ç»Ÿï¼Œå®ƒæ˜¯ä¸€ä¸ªå®Œå…¨æ”¯æŒJMSè§„èŒƒçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¸°å¯Œçš„APIï¼Œå¤šç§é›†ç¾¤æ¶æ„æ¨¡å¼è®©ActiveMQåœ¨ä¸šç•Œæˆä¸ºè€ç‰Œçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œåœ¨ä¸­å°å‹ä¼ä¸šé¢‡å—æ¬¢è¿ã€‚</p>
<ol start="2">
<li>Kafka</li>
</ol>
<p>Kafkaæ˜¯LinkedInå¼€æºçš„åˆ†å¸ƒå¼å‘å¸ƒ-è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼Œç›®å‰å½’å±äºApacheé¡¶çº§é¡¹ç›®ã€‚Kafkaä¸»è¦ç‰¹ç‚¹æ˜¯åŸºäºPullçš„æ¨¡å¼æ¥å¤„ç†æ¶ˆæ¯æ¶ˆè´¹ï¼Œè¿½æ±‚é«˜ååé‡ï¼Œä¸€å¼€å§‹çš„ç›®çš„å°±æ˜¯ç”¨äºæ—¥å¿—æ”¶é›†å’Œä¼ è¾“ã€‚0.8ç‰ˆæœ¬å¼€å§‹æ”¯æŒå¤åˆ¶ï¼Œä¸æ”¯æŒäº‹åŠ¡ï¼Œå¯¹æ¶ˆæ¯çš„é‡å¤ã€ä¸¢å¤±ã€é”™è¯¯æ²¡æœ‰ä¸¥æ ¼è¦æ±‚ï¼Œé€‚åˆäº§ç”Ÿå¤§é‡æ•°æ®çš„äº’è”ç½‘æœåŠ¡çš„æ•°æ®æ”¶é›†ä¸šåŠ¡ã€‚</p>
<ol start="3">
<li>RocketMQ</li>
</ol>
<p>RocketMQæ˜¯é˜¿é‡Œå¼€æºçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ƒæ˜¯çº¯Javaå¼€å‘ï¼Œå…·æœ‰é«˜ååé‡ã€é«˜å¯ç”¨æ€§ã€é€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿåº”ç”¨çš„ç‰¹ç‚¹ã€‚RocketMQæ€è·¯èµ·æºäºKafkaï¼Œä½†å¹¶ä¸æ˜¯Kafkaçš„ä¸€ä¸ªCopyï¼Œå®ƒå¯¹æ¶ˆæ¯å’Œå¯é ä¼ è¾“åŠäº‹åŠ¡æ€§åšäº†ä¼˜åŒ–ï¼Œç›®å‰åœ¨é˜¿é‡Œé›†å›¢å¹¿æ³›åº”ç”¨äºäº¤æ˜“ã€å……å€¼ã€æµè®¡ç®—ã€æ¶ˆæ¯æ¨é€ã€æ—¥å¿—æµå¼å¤„ç†ã€binglogåˆ†å‘ç­‰åœºæ™¯ã€‚</p>
<ol start="4">
<li>RabbitMQ</li>
</ol>
<p>RabbitMQæ˜¯ä½¿ç”¨Erlangè¯­è¨€å¼€å‘çš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ŒåŸºäºAMQPåè®®æ¥å®ç°ã€‚AMQPçš„ä¸»è¦ç‰¹å¾æ˜¯é¢å‘æ¶ˆæ¯ã€é˜Ÿåˆ—ã€è·¯ç”±ï¼ˆåŒ…æ‹¬ç‚¹å¯¹ç‚¹å’Œå‘å¸ƒ/è®¢é˜…ï¼‰ã€å¯é æ€§ã€å®‰å…¨ã€AMQPåè®®æ›´å¤šç”¨åœ¨ä¼ä¸šç³»ç»Ÿå†…å¯¹æ•°æ®ä¸€è‡´æ€§ã€ç¨³å®šæ€§å’Œå¯é æ€§è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ï¼Œå¯¹æ€§èƒ½å’Œååé‡çš„è¦æ±‚è¿˜åœ¨å…¶æ¬¡ã€‚</p>
<h2 id="2-æ¶ˆæ¯é˜Ÿåˆ—åè®®"><a href="#2-æ¶ˆæ¯é˜Ÿåˆ—åè®®" class="headerlink" title="2. æ¶ˆæ¯é˜Ÿåˆ—åè®®"></a>2. æ¶ˆæ¯é˜Ÿåˆ—åè®®</h2><h3 id="2-1-AMQPåè®®"><a href="#2-1-AMQPåè®®" class="headerlink" title="2.1 AMQPåè®®"></a>2.1 AMQPåè®®</h3><p>AMQP(Advanced Message Queuing Protocol)æ˜¯é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œç”±æ‘©æ ¹å¤§é€šé›†å›¢è¿æ¥å…¶ä»–å…¬å¸å…±åŒè®¾è®¡ï¼Œæ˜¯ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯å’Œæ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ã€ä¸åŒçš„å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚</p>
<h3 id="2-2-MQTTåè®®"><a href="#2-2-MQTTåè®®" class="headerlink" title="2.2 MQTTåè®®"></a>2.2 MQTTåè®®</h3><p>MQTT(Meesgae Queuing Telemetry Transport)æ¶ˆæ¯é˜Ÿåˆ—æ˜¯IBMå¼€æ”¾çš„ä¸€ä¸ªå³æ—¶é€šè®¯åè®®ï¼Œç‰©è”ç½‘ç³»ç»Ÿæ¶æ„ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</p>
<h3 id="2-3-OpenMeesageåè®®"><a href="#2-3-OpenMeesageåè®®" class="headerlink" title="2.3 OpenMeesageåè®®"></a>2.3 OpenMeesageåè®®</h3><p>è¿‘å‡ å¹´ç”±é˜¿é‡Œå·´å·´ã€é›…è™å’Œæ»´æ»´å‡ºè¡Œã€Stremalioç­‰å…¬å¸å…±åŒå‚ä¸åˆ›ç«‹çš„åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶ã€æµå¤„ç†ç­‰é¢†åŸŸçš„åº”ç”¨å¼€å‘æ ‡å‡†ã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨httpåè®®ï¼Ÿ</p>
</blockquote>
<p>ï¼ˆ1ï¼‰å› ä¸ºhttpè¯·æ±‚æŠ¥æ–‡å¤´å’Œå“åº”æŠ¥æ–‡å¤´æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼ŒåŒ…å«äº†cookieã€æ•°æ®çš„åŠ å¯†è§£å¯†ã€çŠ¶æ€ç ç­‰é™„åŠ åŠŸèƒ½ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªæ¶ˆæ¯è€Œè¨€ï¼Œå¹¶ä¸éœ€è¦è¿™ä¹ˆå¤æ‚ï¼Œåªéœ€è¦æ•°æ®ä¼ é€’ã€å­˜å‚¨å’Œåˆ†å‘å°±è¡Œï¼Œè¿½æ±‚çš„æ˜¯é«˜æ€§èƒ½ï¼Œå°½é‡ç®€æ´å’Œå¿«é€Ÿã€‚</p>
<p>ï¼ˆ2ï¼‰å¤§éƒ¨åˆ†æƒ…å†µä¸‹httpæ˜¯çŸ­è¿æ¥ï¼Œåœ¨å®é™…çš„äº¤äº’è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚åˆ°å“åº”å¾ˆæœ‰å¯èƒ½ä¼šä¸­æ–­ï¼Œä¸­æ–­ä»¥åå°±ä¸ä¼šè¿›è¡ŒæŒä¹…åŒ–ï¼Œå°±ä¼šé€ æˆè¯·æ±‚çš„ä¸¢å¤±ã€‚è¿™æ ·å°±ä¸åˆ©äºæ¶ˆæ¯ä¸­é—´ä»¶çš„ä¸šåŠ¡åœºæ™¯ï¼Œå› ä¸ºæ¶ˆæ¯ä¸­é—´ä»¶å¯èƒ½æ˜¯ä¸€ä¸ªé•¿æœŸçš„è·å–æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œå‡ºç°é—®é¢˜å’Œæ•…éšœè¦å¯¹æ•°æ®æˆ–æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–ç­‰ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ¶ˆæ¯å’Œæ•°æ®çš„é«˜å¯é å’Œç¨³å¥çš„è¿è¡Œã€‚</p>
<h2 id="3-RabbitMQä»‹ç»"><a href="#3-RabbitMQä»‹ç»" class="headerlink" title="3. RabbitMQä»‹ç»"></a>3. RabbitMQä»‹ç»</h2><h3 id="3-1-æ¶æ„è®¾è®¡"><a href="#3-1-æ¶æ„è®¾è®¡" class="headerlink" title="3.1 æ¶æ„è®¾è®¡"></a>3.1 æ¶æ„è®¾è®¡</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/RabbitMQ.svg" class="" title="design"><br />

<ul>
<li>Brokerï¼šæœåŠ¡èŠ‚ç‚¹ï¼Œæ¥æ”¶å’Œåˆ†å‘æ¶ˆæ¯çš„åº”ç”¨ã€‚</li>
<li>Exchangeï¼šäº¤æ¢æœºï¼Œç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°äº¤æ¢æœºï¼Œç”±äº¤æ¢æœºå°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—ä¸­ã€‚å¦‚æœè·¯ç”±ä¸åˆ°ï¼Œæˆ–è¿”å›ç»™ç”Ÿäº§è€…ï¼Œæˆ–ç›´æ¥ä¸¢å¼ƒï¼Œæˆ–åšå…¶ä»–å¤„ç†ã€‚</li>
<li>Queueï¼šé˜Ÿåˆ—ï¼Œæ˜¯RabbitMQçš„å†…éƒ¨å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨æ¶ˆæ¯ã€‚ç”Ÿäº§è€…æŠ•é€’æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯å¹¶æ¶ˆè´¹ã€‚</li>
<li>RoutingKeyï¼šè·¯ç”±keyï¼ŒExchangeå°†æ¶ˆæ¯å‘é€åˆ°Queueçš„è·¯ç”±åŒ¹é…è§„åˆ™ã€‚</li>
</ul>
<h3 id="3-2-å…¶ä»–æ¦‚å¿µ"><a href="#3-2-å…¶ä»–æ¦‚å¿µ" class="headerlink" title="3.2 å…¶ä»–æ¦‚å¿µ"></a>3.2 å…¶ä»–æ¦‚å¿µ</h3><ul>
<li>Vistual Hostï¼šè™šæ‹Ÿä¸»æœºï¼Œç”¨äºå¤šç”¨æˆ·å’Œåº”ç”¨éš”ç¦»ã€‚</li>
<li>Connectionï¼špublisher/consumerå’Œbrokerä¹‹é—´çš„TCPè¿æ¥ã€‚</li>
<li>Channelï¼šå¦‚æœæ¯ä¸€æ¬¡è®¿é—®RabbitMQéƒ½å»ºç«‹Connectionï¼Œåœ¨æ¶ˆæ¯é‡å¤§çš„æ—¶å€™å»ºç«‹TCP Connectionçš„å¼€é”€å°†æ˜¯å·¨å¤§çš„ï¼Œæ•ˆç‡ä¹Ÿè¾ƒä½ã€‚Channelæ˜¯åœ¨Connectionå†…éƒ¨å»ºç«‹çš„é€»è¾‘è¿æ¥ï¼Œå¦‚æœåº”ç”¨ç¨‹åºæ”¯æŒå¤šçº¿ç¨‹ï¼Œé€šå¸¸æ¯ä¸ªthreadåˆ›å»ºå•ç‹¬çš„Channelè¿›è¡Œé€šè®¯ã€‚AMQP methodåŒ…å«äº†channel idå¸®åŠ©å®¢æˆ·ç«¯å’Œmessage brokerå’Œåˆ«channelï¼Œæ‰€ä»¥channelä¹‹é—´æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚Channelä½œä¸ºè½»é‡çº§çš„Connectionæå¤§åœ°å‡å°‘äº†æ“ä½œç³»ç»Ÿå»ºç«‹TCP Conntectionçš„å¼€é”€ã€‚</li>
</ul>
<h3 id="3-3-äº¤æ¢æœºç±»å‹"><a href="#3-3-äº¤æ¢æœºç±»å‹" class="headerlink" title="3.3 äº¤æ¢æœºç±»å‹"></a>3.3 äº¤æ¢æœºç±»å‹</h3><p>RabbitMQæä¾›äº†ä¸‰ç§äº¤æ¢æœºç±»å‹ï¼š</p>
<ol>
<li>Direct Exchangeï¼šç›´è¿äº¤æ¢æœºï¼Œæ ¹æ®RoutingKeyç²¾ç¡®åŒ¹é…ï¼Œæ¶ˆæ¯ä¼šè¢«æŠ•é€’åˆ°ç›¸åº”é˜Ÿåˆ—ã€‚</li>
<li>Fanout Exchangeï¼šå¹¿æ’­äº¤æ¢æœºï¼Œå‘é€æ¶ˆæ¯æ—¶ä¸éœ€è¦å£°æ˜RoutingKeyï¼Œæ¶ˆæ¯ä¼šè¢«æŠ•é€’åˆ°ä¸äº¤æ¢æœºç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ã€‚</li>
<li>Topic Exchangeï¼šä¸»é¢˜äº¤æ¢æœºï¼Œæ ¹æ®RoutingKeyæ¨¡ç³ŠåŒ¹é…ï¼Œæ¶ˆæ¯ä¼šè¢«æŠ•é€’åˆ°ç›¸åº”é˜Ÿåˆ—ã€‚</li>
</ol>
<h2 id="4-RabbitMQå®‰è£…"><a href="#4-RabbitMQå®‰è£…" class="headerlink" title="4. RabbitMQå®‰è£…"></a>4. RabbitMQå®‰è£…</h2><div class="note icon simple"><i class="note-icon fab fa-kaggle"></i><p>å®‰è£…åŸç”Ÿçš„RabbitMQéœ€è¦erlangç¯å¢ƒï¼Œæ‡’å¾—è£…äº†ã€‚</p>
</div>



<h3 id="4-1-dockerå®‰è£…"><a href="#4-1-dockerå®‰è£…" class="headerlink" title="4.1 dockerå®‰è£…"></a>4.1 dockerå®‰è£…</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŒ‚è½½ç›®å½•</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p /home/rabbitmq/data</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨å®¹å™¨</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker run -d --name rabbitmq \</span></span><br><span class="line">-p 5672:5672 -p 15672:15672 \</span><br><span class="line">-v /home/rabbitmq/data:/var/lib/rabbitmq \</span><br><span class="line">-e RABBITMQ_DEFAULT_USER=Khighness \</span><br><span class="line">-e RABBITMQ_DEFAULT_PASS=KAG1823 \</span><br><span class="line">rabbitmq</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹æ’ä»¶</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rabbitmq-plugins list</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯ç”¨|ç¦ç”¨æ’ä»¶</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rabbitmq-plugins <span class="built_in">enable</span> | <span class="built_in">disable</span> &lt;plugin&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="4-2-webç®¡ç†"><a href="#4-2-webç®¡ç†" class="headerlink" title="4.2 webç®¡ç†"></a>4.2 webç®¡ç†</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it rabbitmq bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span></span><br></pre></td></tr></table></figure>

<p>ç™»å½•ç”¨æˆ·åå’Œå¯†ç å³ä¸º<code>RABBITMQ_DEFAULT_USER</code>å’Œ<code>RABBITMQ_DEFAULT_PASS</code>ã€‚</p>
<h2 id="5-RabbitMQæ¶ˆæ¯æ¨¡å‹"><a href="#5-RabbitMQæ¶ˆæ¯æ¨¡å‹" class="headerlink" title="5. RabbitMQæ¶ˆæ¯æ¨¡å‹"></a>5. RabbitMQæ¶ˆæ¯æ¨¡å‹</h2><blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
</blockquote>
<p>MQå‡†å¤‡ï¼š</p>
<p>åˆ›å»ºç”¨æˆ·ï¼ˆUsernameï¼‰<code>parak</code>ï¼Œå¯†ç ï¼ˆPasswordï¼‰<code>123456</code>ï¼Œåˆ›å»ºè™šæ‹Ÿä¸»æœºï¼ˆvistual hostsï¼‰<code>/learn</code>ã€‚</p>
<p>å¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ—¥å¿—é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_HOME&quot;</span> <span class="attr">value</span>=<span class="string">&quot;log/&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;LOG_HOME&#125;/rabbitmq.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">MaxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">triggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">MaxFileSize</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">triggeringPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="5-1-Hello-Worldæ¨¡å‹"><a href="#5-1-Hello-Worldæ¨¡å‹" class="headerlink" title="5.1 Hello Worldæ¨¡å‹"></a>5.1 Hello Worldæ¨¡å‹</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/one.png" class="" title="one">

<br />

<p>åœ¨ä¸Šå›¾çš„æ¨¡å‹ä¸­ï¼Œæœ‰ä»¥ä¸‹æ¦‚å¿µï¼š</p>
<ul>
<li>Pï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€æ¶ˆæ¯çš„ç¨‹åº</li>
<li>Cï¼šæ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯çš„æ¥å—è€…ï¼Œä¼šä¸€ç›´ç­‰å¾…æ¶ˆæ¯åˆ°æ¥</li>
<li>queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå›¾ä¸­çº¢è‰²éƒ¨åˆ†ï¼Œç”Ÿäº§è€…å‘å…¶ä¸­æŠ•å…¥æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åœ¨å…¶ä¸­è·å–æ¶ˆæ¯ã€‚</li>
</ul>
<p>æ„å»ºè¿æ¥å·¥å‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºMQè¿æ¥å·¥å‚</span></span><br><span class="line">    connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">    <span class="comment">// è®¾ç½®æœåŠ¡å™¨IP:PORT</span></span><br><span class="line">    connectionFactory.setHost(<span class="string">&quot;192.168.117.155&quot;</span>);</span><br><span class="line">    connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®è¿æ¥è™šæ‹Ÿä¸»æœº</span></span><br><span class="line">    connectionFactory.setVirtualHost(<span class="string">&quot;/learn&quot;</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®ç”¨æˆ·å¯†ç </span></span><br><span class="line">    connectionFactory.setUsername(<span class="string">&quot;parak&quot;</span>);</span><br><span class="line">    connectionFactory.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”Ÿäº§æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testSendMessage</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–è¿æ¥å¯¹è±¡</span></span><br><span class="line">    Connection connection = connectionFactory.newConnection();</span><br><span class="line">    <span class="comment">// è·å–è¿æ¥é€šé“</span></span><br><span class="line">    Channel channel = connection.createChannel();</span><br><span class="line">    <span class="comment">// é€šé“ç»‘å®šæ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">// å‚æ•°1ï¼šé˜Ÿåˆ—åç§°ï¼Œå¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">    <span class="comment">// å‚æ•°2ï¼šç”¨æ¥å®šä¹‰é˜Ÿåˆ—ç‰¹æ€§æ˜¯å¦è¦æŒä¹…åŒ–</span></span><br><span class="line">    <span class="comment">// å‚æ•°3ï¼šæ˜¯å¦ç‹¬å é˜Ÿåˆ—ï¼Œåªå…è®¸å½“å‰è¿æ¥å¯ç”¨</span></span><br><span class="line">    <span class="comment">// å‚æ•°4ï¼šæ˜¯å¦åœ¨æ¶ˆè´¹å®Œæˆåè‡ªåŠ¨åˆ é™¤é˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">// å‚æ•°5ï¼šé™„åŠ å‚æ•°</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;hello&quot;</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// å‘å¸ƒæ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">// å‚æ•°1ï¼šäº¤æ¢æœºåç§°</span></span><br><span class="line">    <span class="comment">// å‚æ•°2ï¼šé˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="comment">// å‚æ•°3ï¼šä¼ é€’çš„é¢å¤–è®¾ç½®</span></span><br><span class="line">    <span class="comment">// å‚æ•°4ï¼šæ¶ˆæ¯çš„å…·ä½“å†…å®¹</span></span><br><span class="line">    channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;hello&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;hello, highness&quot;</span>.getBytes());</span><br><span class="line">    <span class="comment">// å…³é—­é€šé“</span></span><br><span class="line">    channel.close();</span><br><span class="line">    <span class="comment">// å…³é—­è¿æ¥</span></span><br><span class="line">    connection.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¶ˆè´¹æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testConsumeMessage</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºè¿æ¥å¯¹è±¡</span></span><br><span class="line">    Connection connection = connectionFactory.newConnection();</span><br><span class="line">    <span class="comment">// åˆ›å»ºè¿æ¥é€šé“</span></span><br><span class="line">    Channel channel = connection.createChannel();</span><br><span class="line">    <span class="comment">// é€šé“ç»‘å®šé˜Ÿåˆ—</span></span><br><span class="line">    channel.queueDeclare(<span class="string">&quot;hello&quot;</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// æ¶ˆè´¹æ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">// å‚æ•°1ï¼šæ¶ˆè´¹çš„é˜Ÿåˆ—åç§°</span></span><br><span class="line">    <span class="comment">// å‚æ•°2ï¼šå¼€å§‹æ¶ˆæ¯çš„è‡ªåŠ¨ç¡®è®¤æœºåˆ¶</span></span><br><span class="line">    <span class="comment">// å‚æ•°3ï¼šæ¶ˆè´¹æ—¶çš„å›è°ƒæ¥å£</span></span><br><span class="line">    channel.basicConsume(<span class="string">&quot;hello&quot;</span>, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">        <span class="comment">// å‚æ•°1ï¼šæ ‡ç­¾</span></span><br><span class="line">        <span class="comment">// å‚æ•°2ï¼šä¿¡å°</span></span><br><span class="line">        <span class="comment">// å‚æ•°3ï¼šå±æ€§</span></span><br><span class="line">        <span class="comment">// å‚æ•°4ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºçš„æ¶ˆæ¯</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;æ¶ˆè´¹æ¶ˆæ¯ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// éœ€è¦ä¸æ–­æ¥æ”¶é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥ä¸å…³é—­é€šé“å’Œè¿æ¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>è®©é˜Ÿåˆ—å’Œæ¶ˆæ¯éƒ½æŒä¹…åŒ–</p>
</blockquote>
<p><code>queueDeclare</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°éœ€è¦è®¾ç½®ä¸º<code>true</code>ï¼›</p>
<p><code>basicPublish</code>æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°éœ€è¦è®¾ç½®ä¸ºå¸¦<code>MessageProperties</code>çš„<code>PERSISTENT</code>çš„å±æ€§ï¼š</p>
<ul>
<li>MINIMAL_PERSISTENT_BASIC</li>
<li>PERSISTENT_BASIC</li>
<li>PERSISTENT_TEXT_PLAIN</li>
</ul>
<h3 id="5-2-Work-Queuesæ¨¡å‹"><a href="#5-2-Work-Queuesæ¨¡å‹" class="headerlink" title="5.2 Work Queuesæ¨¡å‹"></a>5.2 Work Queuesæ¨¡å‹</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/two.png" class="" title="two">

<br />

<p>Work Queuesï¼Œä»»åŠ¡æ¨¡å‹ã€‚å½“æ¶ˆæ¯å¤„ç†æ¯”è¾ƒè€—æ—¶çš„æ—¶å€™ï¼Œå¯èƒ½ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦ä¼šè¿œè¿œå¤§äºæ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦ã€‚é•¿æ­¤ä»¥å¾€ï¼Œæ¶ˆæ¯å°±ä¼šå †ç§¯è¶Šæ¥è¶Šå¤šï¼Œæ— æ³•åŠæ—¶å¤„ç†ã€‚æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨Work Queuesï¼šè®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸€æ—¦æ¶ˆè´¹ï¼Œå°±ä¼šæ¶ˆå¤±ï¼Œå› æ­¤ä»»åŠ¡æ˜¯ä¸ä¼šè¢«é‡å¤æ‰§è¡Œçš„ã€‚</p>
<p>MQå‡†å¤‡ï¼š</p>
<ul>
<li>åˆ›å»ºè™šæ‹Ÿä¸»æœºï¼ˆvistual hostï¼‰<code>/work</code></li>
</ul>
<p>MQå·¥å‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> ConnectionFactory connectionFactory = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST = <span class="string">&quot;192.168.117.155&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">5672</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String VIRTUAL_HOST = <span class="string">&quot;/learn&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String USERNAME = <span class="string">&quot;parak&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PASSWORD = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (connectionFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (RabbitMQUtil.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (connectionFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">                    connectionFactory.setHost(HOST);</span><br><span class="line">                    connectionFactory.setPort(PORT);</span><br><span class="line">                    connectionFactory.setVirtualHost(VIRTUAL_HOST);</span><br><span class="line">                    connectionFactory.setUsername(USERNAME);</span><br><span class="line">                    connectionFactory.setPassword(PASSWORD);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> connectionFactory.newConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeConnectionAndChannel</span><span class="params">(Channel channel, Connection connection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>)</span><br><span class="line">                channel.close();</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>)</span><br><span class="line">                connection.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¨¡å‹æ¼”ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿäº§è€…</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;work&quot;</span>, MessageProperties.PERSISTENT_TEXT_PLAIN, <span class="keyword">new</span> String(<span class="string">&quot;message&quot;</span> + (i + <span class="number">1</span>) + <span class="string">&quot; =&gt; hello, khighness&quot;</span>).getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        RabbitMQUtil.closeConnectionAndChannel(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Consumer1.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work&quot;</span>, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ¶ˆè´¹è€…-1ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Consumer2.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work&quot;</span>, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè¿è¡Œæ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2ï¼Œæœ€åè¿è¡Œç”Ÿäº§è€…ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¶ˆè´¹è€…1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.218</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG  top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…<span class="literal">-1</span>ï¼šmessage1 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">53.225</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG  top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…<span class="literal">-1</span>ï¼šmessage3 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">54.226</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG  top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…<span class="literal">-1</span>ï¼šmessage5 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">55.229</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG  top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…<span class="literal">-1</span>ï¼šmessage7 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">56.231</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">5</span>] DEBUG  top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…<span class="literal">-1</span>ï¼šmessage9 =&gt; hello, khighness</span><br><span class="line"><span class="comment"># æ¶ˆè´¹è€…2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.219</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage2 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.221</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage4 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.221</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage6 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.221</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage8 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">19</span>:<span class="number">32</span>:<span class="number">52.222</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">5</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage10 =&gt; hello, khighness</span><br></pre></td></tr></table></figure>

<p>æ€»ç»“ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitMQæŒ‰é¡ºåºå°†æ¯ä¸ªæ¶ˆæ¯å‘é€ç»™ä¸‹ä¸€ä¸ªä½¿ç”¨è€…ã€‚å¹³å‡è€Œè¨€ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šæ”¶åˆ°ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ï¼Œè¿™ç§åˆ†å‘æ¶ˆæ¯çš„æ–¹å¼æˆä¸ºå¾ªç¯ã€‚</p>
<p>ä¸Šé¢çš„æ¶ˆæ¯æ¶ˆè´¹æ—¶æ˜¯å¹³å‡åˆ†é…ï¼Œé‚£ä¹ˆå¦‚æœéœ€è¦ä¿®æ”¹çš„è¯ï¼Œå°±è¦å…³é—­æ¶ˆæ¯è‡ªåŠ¨ç¡®è®¤æœºåˆ¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Consumer1.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// ä¸€æ¬¡åªèƒ½æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯</span></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// ç¬¬äºŒä¸ªå‚æ•°ï¼Œå…³é—­æ¶ˆæ¯è‡ªåŠ¨ç¡®è®¤</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work&quot;</span>, <span class="keyword">false</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ¶ˆè´¹è€…-1ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Consumer2.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="keyword">final</span> Channel channel = connection.createChannel();</span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work&quot;</span>, <span class="keyword">false</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">                channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡æ–°è¿è¡Œï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># consumer1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">34.534</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…<span class="literal">-1</span>ï¼šmessage1 =&gt; hello, khighness</span><br><span class="line"></span><br><span class="line"><span class="comment"># consumer2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.531</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage2 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.535</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">5</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage3 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.536</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">6</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage4 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.537</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">7</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage5 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.538</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">8</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage6 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.538</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">9</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage7 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.539</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">10</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage8 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.540</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">11</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage9 =&gt; hello, khighness</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">33.541</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">12</span>] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šmessage10 =&gt; hello, khighness</span><br></pre></td></tr></table></figure>



<h3 id="5-3-Publish-Subscribeæ¨¡å‹"><a href="#5-3-Publish-Subscribeæ¨¡å‹" class="headerlink" title="5.3 Publish/Subscribeæ¨¡å‹"></a>5.3 Publish/Subscribeæ¨¡å‹</h3><img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/three.png" class="" title="three">

<br />

<p>Publish/Subscribeæ¨¡å‹ï¼Œä¹Ÿç§°ä¸ºFanoutæ¨¡å‹ï¼Œå³å‘å¸ƒ-è®¢é˜…æ¨¡å‹æˆ–è€…å¹¿æ’­æ¨¡å‹ã€‚</p>
<p>æµç¨‹ï¼š</p>
<ul>
<li>æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰è‡ªå·±çš„é˜Ÿåˆ—</li>
<li>æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šäº¤æ¢æœº</li>
<li>ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œåªèƒ½å‘é€åˆ°äº¤æ¢æœºï¼Œäº¤æ¢æœºæ¥å†³å®šè¦å‘ç»™å“ªä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…æ— æ³•å†³å®š</li>
<li>äº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€åˆ°ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ—</li>
<li>é˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ‹¿åˆ°æ¶ˆæ¯ï¼Œå®ç°ä¸€æ¡æ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</li>
</ul>
<p>æ¨¡å‹æ¼”ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿäº§è€…</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// æŒ‡å®šäº¤æ¢æœº</span></span><br><span class="line">        <span class="comment">// å‚æ•°1ï¼šäº¤æ¢æœºåç§°ï¼Œä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">        <span class="comment">// å‚æ•°2ï¼šäº¤æ¢æœºç±»å‹</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;khighness&#x27;s message&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQUtil.closeConnectionAndChannel(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…-1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Consumer1.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// æŒ‡å®šäº¤æ¢æœº</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¸´æ—¶é˜Ÿåˆ—</span></span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// ç»‘å®šäº¤æ¢æœºå’Œé˜Ÿåˆ—</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// æ¶ˆè´¹æ¶ˆæ¯</span></span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                log.info(<span class="string">&quot;æ¶ˆè´¹è€…-1ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…-2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Consumer2.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// æŒ‡å®šäº¤æ¢æœº</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¸´æ—¶é˜Ÿåˆ—</span></span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// ç»‘å®šäº¤æ¢æœºå’Œé˜Ÿåˆ—</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;pubsub&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// æ¶ˆè´¹æ¶ˆæ¯</span></span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                log.info(<span class="string">&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè¿è¡Œæ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2ï¼Œæœ€åè¿è¡Œç”Ÿäº§è€…ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¶ˆè´¹è€…1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">21</span>:<span class="number">40</span>:<span class="number">58.365</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] INFO  top.parak.pubsub.Consumer1 - æ¶ˆè´¹è€…<span class="literal">-1</span>ï¼škhighness<span class="string">&#x27;s message</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># æ¶ˆè´¹è€…2</span></span><br><span class="line"><span class="string">2021-05-24 21:40:58.365 [pool-1-thread-4] INFO  top.parak.pubsub.Consumer2 - æ¶ˆè´¹è€…-2ï¼škhighness&#x27;</span>s message</span><br></pre></td></tr></table></figure>



<h3 id="5-4-Routingæ¨¡å‹"><a href="#5-4-Routingæ¨¡å‹" class="headerlink" title="5.4 Routingæ¨¡å‹"></a>5.4 Routingæ¨¡å‹</h3><p>åœ¨Fanoutæ¨¡å‹ä¸­ï¼Œä¸€æ¡æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰è®¢é˜…çš„é˜Ÿåˆ—éƒ½æ¶ˆè´¹ï¼Œä½†æ˜¯ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸åŒçš„æ¶ˆæ¯è¢«ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ï¼Œè¿™æ—¶å°±è¦ç”¨Routingçš„Directç±»å‹çš„äº¤æ¢æœºã€‚</p>
<p>åœ¨Directæ¨¡å‹ä¸­ï¼š</p>
<ul>
<li>é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ªRoutingKeyã€‚</li>
<li>æ¶ˆæ¯çš„å‘é€æ–¹åœ¨å‘Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„RoutingKeyã€‚</li>
<li>Exchangeä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„RoutingKeyè¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—çš„RoutingKeyä¸æ¶ˆæ¯çš„RoutingKeyå®Œå…¨ä¸€è‡´ï¼Œæ‰ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚</li>
</ul>
<p>å›¾è§£ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/four.png" class="" title="four">

<br />

<ul>
<li>Pï¼šç”Ÿäº§è€…ï¼Œå‘Exchangeå‘é€æ¶ˆæ¯ï¼Œå‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šæŒ‡å®šä¸€ä¸ªrouting key</li>
<li>Xï¼šäº¤æ¢æœºï¼Œæ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œç„¶åæŠŠæ¶ˆæ¯é€’äº¤ç»™ä¸routing keyå®Œå…¨åŒ¹é…çš„é˜Ÿåˆ—</li>
<li>C1ï¼šæ¶ˆè´¹è€…ï¼Œå…¶æ‰€åœ¨é˜Ÿåˆ—æŒ‡å®šäº†éœ€è¦routing keyä¸ºerrorçš„æ¶ˆæ¯</li>
<li>C2ï¼šæ¶ˆè´¹è€…ï¼Œå…¶æ‰€åœ¨é˜Ÿåˆ—æŒ‡å®šäº†éœ€è¦routing keyä¸ºinfoã€errorã€warningçš„æ¶ˆæ¯</li>
</ul>
<p>æ¨¡å‹æ¼”ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿäº§è€…</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// æŒ‡å®šäº¤æ¢æœº</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;info&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;direct =&gt; info&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;debug&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;direct =&gt; debug&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;warn&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;direct =&gt; warn&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;error&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;direct =&gt; error&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQUtil.closeConnectionAndChannel(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Consumer1.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// æŒ‡å®šäº¤æ¢æœº</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¸´æ—¶é˜Ÿåˆ—</span></span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// åŸºäºroute keyç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–æ¶ˆè´¹çš„æ¶ˆæ¯</span></span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ¶ˆè´¹è€…-1ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Consumer2.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">// æŒ‡å®šäº¤æ¢æœº</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;routing&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="comment">// ä¸´æ—¶é˜Ÿåˆ—</span></span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// åŸºäºroute keyç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;debug&quot;</span>);</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;warn&quot;</span>);</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–æ¶ˆè´¹çš„æ¶ˆæ¯</span></span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè¿è¡Œæ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2ï¼Œæœ€åè¿è¡Œç”Ÿäº§è€…ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¶ˆè´¹è€…1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">26.753</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.direct.Consumer1 - æ¶ˆè´¹è€…<span class="literal">-1</span>ï¼šdirect =&gt; info</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¶ˆè´¹è€…2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">26.753</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.direct.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šdirect =&gt; debug</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">26.756</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.direct.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šdirect =&gt; warn</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">22</span>:<span class="number">47</span>:<span class="number">26.756</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.direct.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼šdirect =&gt; error</span><br></pre></td></tr></table></figure>



<h3 id="5-5-Topicsæ¨¡å‹"><a href="#5-5-Topicsæ¨¡å‹" class="headerlink" title="5.5 Topicsæ¨¡å‹"></a>5.5 Topicsæ¨¡å‹</h3><p>Topicsæ¨¡å‹ä¸Directæ¨¡å‹ç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®RoutingKeyæŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ï¼Œåªä¸è¿‡Topicç±»å‹Exchangeå¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®šRoutingKeyçš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/five.png" class="" title="five">

<br />

<p>Topicsæ¨¡å‹çš„RoutingKeyæ˜¯ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªå•è¯ç»„æˆï¼Œå¤šä¸ªå•è¯ä¹‹é—´ä»¥<code>.</code>åˆ†éš”ï¼Œæœ‰ä¸¤ç§é€šé…ç¬¦ï¼š</p>
<ul>
<li><code>*</code>ï¼šåŒ¹é…ä¸€ä¸ªå•è¯</li>
<li><code>#</code>ï¼šåŒ¹é…å¤šä¸ªå•è¯</li>
</ul>
<p>æ¨¡å‹æ¼”ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿäº§è€…</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;topics&quot;</span>, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;topics&quot;</span>, <span class="string">&quot;k.a&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;topics =&gt; k.a&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;topics&quot;</span>, <span class="string">&quot;k.a.g&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;topics =&gt; k.a.g&quot;</span>.getBytes());</span><br><span class="line">        RabbitMQUtil.closeConnectionAndChannel(channel, connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…1</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger(Consumer2.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;topics&quot;</span>, <span class="string">&quot;topic&quot;</span>);</span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;topics&quot;</span>, <span class="string">&quot;k.#&quot;</span>);</span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    	<span class="comment">// ä¸´æ—¶é˜Ÿåˆ—</span></span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        <span class="comment">// åŸºäºroute keyç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº</span></span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;debug&quot;</span>);</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;warn&quot;</span>);</span><br><span class="line">        channel.queueBind(queue, <span class="string">&quot;routing&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">        <span class="comment">// è·å–æ¶ˆè´¹çš„æ¶ˆæ¯</span></span><br><span class="line">        channel.basicConsume(queue, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;</span>, <span class="keyword">new</span> String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆè¿è¡Œæ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2ï¼Œæœ€åè¿è¡Œç”Ÿäº§è€…ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¶ˆè´¹è€…1</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">23</span>:<span class="number">14</span>:<span class="number">53.574</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.topics.Consumer1 - æ¶ˆè´¹è€…<span class="literal">-1</span>ï¼štopics =&gt; k.a</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¶ˆè´¹è€…2</span></span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">23</span>:<span class="number">14</span>:<span class="number">53.573</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.topics.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼štopics =&gt; k.a</span><br><span class="line"><span class="number">2021</span><span class="literal">-05</span><span class="literal">-24</span> <span class="number">23</span>:<span class="number">14</span>:<span class="number">53.578</span> [<span class="type">pool</span>-<span class="number">1</span>-<span class="type">thread</span>-<span class="number">4</span>] DEBUG top.parak.topics.Consumer2 - æ¶ˆè´¹è€…<span class="literal">-2</span>ï¼štopics =&gt; k.a.g</span><br></pre></td></tr></table></figure>



<h2 id="6-RabbitMQæ•´åˆSpringBoot"><a href="#6-RabbitMQæ•´åˆSpringBoot" class="headerlink" title="6. RabbitMQæ•´åˆSpringBoot"></a>6. RabbitMQæ•´åˆSpringBoot</h2><div class="note icon simple"><i class="note-icon fab fa-korvue"></i><p>åœ¨ä½¿ç”¨SpringBootçš„AMQP APIä¹‹å‰ï¼Œä¸€å®šè¦ç†è§£æ¶ˆæ¯çš„å¤„ç†é¡ºåºï¼š</p>
<p>ç”Ÿäº§çš„æ¶ˆæ¯å…ˆåˆ°è¾¾äº¤æ¢æœºï¼Œç„¶åç»è¿‡routingKeyåŒ¹é…ï¼Œåˆ°è¾¾ç»‘å®šçš„é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ¶ˆè´¹ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨SpringBootæ•´åˆRabbitMQçš„è¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬é¡ºåºå¦‚ä¸‹ï¼š</p>
<ol>
<li>åœ¨é…ç½®ç±»ä¸­æ³¨å†Œç›¸åº”çš„äº¤æ¢æœºã€é˜Ÿåˆ—ï¼ŒåŒæ—¶é€šè¿‡è·¯ç”±è¿›è¡Œç»‘å®šï¼›</li>
<li>ç¼–å†™æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶éœ€è¦å¡«å…¥å‚æ•°ï¼šäº¤æ¢æœºã€è·¯ç”±å’Œæ¶ˆæ¯ï¼›</li>
<li>ç¼–å†™æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…éœ€è¦ç›‘å¬ç›¸åº”çš„é˜Ÿåˆ—ã€‚</li>
</ol>
</div>



<p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>2.2.2.RELEASE<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>é¡¹ç›®é…ç½®<code>application.properties</code>ï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">3333</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">springboot-rabbitmq</span></span><br><span class="line"><span class="meta">spring.rabbitmq.host</span>=<span class="string">192.168.117.155</span></span><br><span class="line"><span class="meta">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="meta">spring.rabbitmq.virtual-host</span>=<span class="string">/learn</span></span><br><span class="line"><span class="meta">spring.rabbitmq.username</span>=<span class="string">parak</span></span><br><span class="line"><span class="meta">spring.rabbitmq.password</span>=<span class="string">KAG1823</span></span><br></pre></td></tr></table></figure>



<h3 id="6-1-é…ç½®ç±»"><a href="#6-1-é…ç½®ç±»" class="headerlink" title="6.1 é…ç½®ç±»"></a>6.1 é…ç½®ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DIRECT_EXCHANGE = <span class="string">&quot;parak.exchange.direct&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FANOUT_EXCHANGE = <span class="string">&quot;parak.exchange.fanout&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_EXCHANGE = <span class="string">&quot;parak.exchange.topic&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_EXCHANGE = <span class="string">&quot;parak.exchange.header&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HELLO_QUEUE = <span class="string">&quot;parak.queue.hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WORK_QUEUE = <span class="string">&quot;parak.queue.work1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DIRECT_QUEUE1 = <span class="string">&quot;parak.queue.direct1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DIRECT_QUEUE2 = <span class="string">&quot;parak.queue.direct2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FANOUT_QUEUE1 = <span class="string">&quot;parak.queue.fanout1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FANOUT_QUEUE2 = <span class="string">&quot;parak.queue.fanout2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_QUEUE1 = <span class="string">&quot;parak.queue.topic1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_QUEUE2 = <span class="string">&quot;parak.queue.topic2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_QUEUE = <span class="string">&quot;parak.queue.header&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_ROUTING_KEY = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HELLO_ROUTING_KEY = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WORK_ROUTING_KEY = <span class="string">&quot;work&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DIRECT_ROUTING_KEY1 = <span class="string">&quot;k&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DIRECT_ROUTING_KEY2 = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_ROUTING_KEY1 = <span class="string">&quot;k.a.*&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_ROUTING_KEY2 = <span class="string">&quot;k.a.#&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. Direct Exchangeï¼šç›´è¿äº¤æ¢æœºï¼Œç²¾ç¡®åŒ¹é…è·¯ç”±ï¼Œæ¨é€åˆ°ç›¸åº”é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;directExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">directExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(DIRECT_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;helloQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">helloQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(HELLO_QUEUE, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;workQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">workQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(WORK_QUEUE, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;directQueue1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">directQueue1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(DIRECT_QUEUE1, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;directQueue2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">directQueue2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(DIRECT_QUEUE2, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">directBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;helloQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;directExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(HELLO_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">directBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;workQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;directExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(WORK_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">directBinding3</span><span class="params">(<span class="meta">@Qualifier(&quot;directQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;directExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DIRECT_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">directBinding4</span><span class="params">(<span class="meta">@Qualifier(&quot;directQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;directExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DIRECT_ROUTING_KEY2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2. Fanout Exchange: å¹¿æ’­äº¤æ¢æœºï¼Œä¸éœ€è¦è·¯ç”±ï¼Œå‘é€åˆ°æ‰€æœ‰ç»‘å®šè¿‡çš„é˜Ÿåˆ—é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;fanoutExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FanoutExchange <span class="title">fanoutExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FanoutExchange(FANOUT_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;fanoutQueue1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">fanoutQueue1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(FANOUT_QUEUE1, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;fanoutQueue2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">fanoutQueue2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(FANOUT_QUEUE2, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">fanoutBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;fanoutQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;fanoutExchange&quot;)</span> FanoutExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">fanoutBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;fanoutQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;fanoutExchange&quot;)</span> FanoutExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3. Topic Exchangeï¼šä¸»é¢˜äº¤æ¢æœºï¼Œæ¨¡ç³ŠåŒ¹é…è·¯ç”±ï¼Œæ¨é€åˆ°ç›¸åº”é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;topicExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TopicExchange <span class="title">topicExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TopicExchange(TOPIC_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;topicQueue1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">topicQueue1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(TOPIC_QUEUE1, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;topicQueue2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">topicQueue2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(TOPIC_QUEUE2, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">topicBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;topicQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;topicExchange&quot;)</span> TopicExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(topicExchange()).with(TOPIC_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">topicBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;topicQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;topicExchange&quot;)</span> TopicExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(topicQueue2()).to(topicExchange()).with(TOPIC_ROUTING_KEY2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4. Header Exchange: å¤´éƒ¨äº¤æ¢æœºï¼Œæ ¹æ®headeråŒ¹é…ï¼Œæ¨é€åˆ°ç›¸åº”é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;headersExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HeadersExchange <span class="title">headersExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HeadersExchange(HEADER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;headerQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">headerQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(HEADER_QUEUE, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">headerBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;headerQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;headersExchange&quot;)</span> HeadersExchange exchange)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;signature&quot;</span>, <span class="string">&quot;Khighness&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).whereAny(map).match();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="6-2-ç”Ÿäº§è€…"><a href="#6-2-ç”Ÿäº§è€…" class="headerlink" title="6.2 ç”Ÿäº§è€…"></a>6.2 ç”Ÿäº§è€…</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.AmqpTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessageProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AmqpTemplate amqpTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒç«¯æ¨¡å‹, ä½¿ç”¨routingåç§°åŒ¹é…queueåç§°ï¼Œé»˜è®¤ç›¸ç­‰åŒ¹é…</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/hello?msg=Khighness&quot;&gt;hello&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">     <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendHello</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> </span>&#123;</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.DIRECT_EXCHANGE, RabbitMQConfig.HELLO_ROUTING_KEY, message);</span><br><span class="line">        log.info(<span class="string">&quot;ã€Helloã€ send message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å·¥ä½œæ¨¡å‹ï¼Œå¤šæ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…è½®è¯¢æ¶ˆè´¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/work?msg=Khighness&quot;&gt;work&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/work&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendWork</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> </span>&#123;</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.DIRECT_EXCHANGE, RabbitMQConfig.WORK_ROUTING_KEY, message);</span><br><span class="line">        log.info(<span class="string">&quot;ã€Workã€ send message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·¯ç”±æ¨¡å‹ï¼Œæ ¹æ®routingKeyç²¾ç¡®åŒ¹é…ï¼ŒroutingKeyæœªåŒ¹é…çš„æ¶ˆæ¯ä¼šä¸¢å¤±</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/direct?key=k&amp;msg=Khighness&quot;&gt;k&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/direct?key=a&amp;msg=Khighness&quot;&gt;a&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/direct&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendDirect</span><span class="params">(<span class="meta">@RequestParam(&quot;key&quot;)</span> String routingKey, <span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> </span>&#123;</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.DIRECT_EXCHANGE, routingKey, message);</span><br><span class="line">        log.info(<span class="string">&quot;ã€Directã€ send message: [&#123;&#125;], with key: [&#123;&#125;]&quot;</span>, message, routingKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¹¿æ’­æ¨¡å‹ï¼Œä¸éœ€è¦routingKeyï¼Œæ¶ˆæ¯æ¨é€åˆ°äº¤æ¢æœºç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/fanout?msg=Khighness&quot;&gt;fanout&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/fanout&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendFanout</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> </span>&#123;</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.FANOUT_EXCHANGE, RabbitMQConfig.DEFAULT_ROUTING_KEY, message);</span><br><span class="line">        log.info(<span class="string">&quot;ã€Fanoutã€ send message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸»é¢˜æ¨¡å‹ï¼Œæ ¹æ®routingKeyæ¨¡ç³ŠåŒ¹é…ï¼Œæ¨é€åˆ°ç›¸åº”é˜Ÿåˆ—ï¼ŒroutingKeyæœªåŒ¹é…çš„æ¶ˆæ¯ä¼šä¸¢å¤±</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/topic?key=k.a.g&amp;msg=Khighness&quot;&gt;k.a.g&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/topic?key=k.a.g.c&amp;msg=Khighness&quot;&gt;k.a.g.c&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/topic&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendTopic</span><span class="params">(<span class="meta">@RequestParam(&quot;key&quot;)</span> String routingKey, <span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> </span>&#123;</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.TOPIC_EXCHANGE, routingKey, message);</span><br><span class="line">        log.info(<span class="string">&quot;ã€Topicã€ send message: [&#123;&#125;], with key: [&#123;&#125;]&quot;</span>, message, routingKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤´éƒ¨æ¨¡å‹ï¼Œä¸éœ€è¦routingKeyï¼Œæ ¹æ®headerå­—æ®µåŒ¹é…ï¼ŒæœªåŒ¹é…çš„æ¶ˆæ¯ä¼šä¸¢å¤±</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/header?sign=Khighness&amp;msg=Khighness&quot;&gt;Khighness&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:3333/rabbitmq/send/header?sign=follwerK&amp;msg=Khighness&quot;&gt;flowerK&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/header&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendHeader</span><span class="params">(<span class="meta">@RequestParam(&quot;sign&quot;)</span> String signature, <span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> </span>&#123;</span><br><span class="line">        MessageProperties properties = <span class="keyword">new</span> MessageProperties();</span><br><span class="line">        properties.setHeader(<span class="string">&quot;signature&quot;</span>, signature);</span><br><span class="line">        Message obj = <span class="keyword">new</span> Message(message.getBytes(), properties);</span><br><span class="line">        amqpTemplate.convertAndSend(RabbitMQConfig.HEADER_EXCHANGE, RabbitMQConfig.DEFAULT_ROUTING_KEY, obj);</span><br><span class="line">        log.info(<span class="string">&quot;ã€Headerã€ send message: [&#123;&#125;], with sign: [&#123;&#125;]&quot;</span>, message, signature);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="6-3-æ¶ˆè´¹è€…"><a href="#6-3-æ¶ˆè´¹è€…" class="headerlink" title="6.3 æ¶ˆè´¹è€…"></a>6.3 æ¶ˆè´¹è€…</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.HELLO_QUEUE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveHello</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€Helloã€ receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.WORK_QUEUE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveWork1</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€Work-1ã€ receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.WORK_QUEUE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveWork2</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€Work-2ã€ receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.DIRECT_QUEUE1)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveDirect1</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€Direct-1ã€ receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.DIRECT_QUEUE1)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveDirect2</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€Direct-2ã€ receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.FANOUT_QUEUE1)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveFanout1</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€Fanout-1ã€ receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.FANOUT_QUEUE2)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveFanout2</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€Fanout-2ã€ receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.TOPIC_QUEUE1)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveTopic1</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€Topic-1ã€ receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.TOPIC_QUEUE2)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveTopic2</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€Topic-2ã€ receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.HEADER_QUEUE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveHeader</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€Headerã€ receive message: [&#123;&#125;]&quot;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-4-å¯åŠ¨ç±»"><a href="#6-4-å¯åŠ¨ç±»" class="headerlink" title="6.4 å¯åŠ¨ç±»"></a>6.4 å¯åŠ¨ç±»</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RabbitMQApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="7-RabbitMQæ­»ä¿¡é˜Ÿåˆ—"><a href="#7-RabbitMQæ­»ä¿¡é˜Ÿåˆ—" class="headerlink" title="7. RabbitMQæ­»ä¿¡é˜Ÿåˆ—"></a>7. RabbitMQæ­»ä¿¡é˜Ÿåˆ—</h2><h3 id="7-1-æ­»ä¿¡é˜Ÿåˆ—"><a href="#7-1-æ­»ä¿¡é˜Ÿåˆ—" class="headerlink" title="7.1 æ­»ä¿¡é˜Ÿåˆ—"></a>7.1 æ­»ä¿¡é˜Ÿåˆ—</h3><p>æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œå¦‚æœå‡ºç°ä»¥ä¸‹æƒ…å†µï¼Œï¼š</p>
<ol>
<li>æ¶ˆæ¯è¢«å¦å®šç¡®è®¤ï¼Œä½¿ç”¨<code>channel.basicNack</code>æˆ–è€…<code>channel.basicReject</code>ï¼Œå¹¶ä¸”æ­¤æ—¶<code>requeue</code>è¢«è®¾ç½®ä¸º<code>false</code>ã€‚</li>
<li>æ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„å­˜æ´»æ—¶é—´è¶…è¿‡è®¾ç½®çš„TTLæ—¶é—´ã€‚</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°é‡å·²ç»è¶…è¿‡æœ€å¤§é˜Ÿåˆ—é•¿åº¦ã€‚</li>
</ol>
<p>é‚£ä¹ˆæ¶ˆæ¯è¢«ç§°ä¸ºæ­»ä¿¡ï¼ˆDead Letterï¼‰ã€‚</p>
<h3 id="7-2-å®ç°åŸç†"><a href="#7-2-å®ç°åŸç†" class="headerlink" title="7.2 å®ç°åŸç†"></a>7.2 å®ç°åŸç†</h3><p>æ­¥éª¤ï¼š</p>
<ol>
<li>å£°æ˜ä¸šåŠ¡äº¤æ¢æœºï¼Œé…ç½®ä¸šåŠ¡è·¯ç”±ï¼Œç»‘å®šä¸šåŠ¡é˜Ÿåˆ—ï¼›</li>
<li>å£°æ˜æ­»ä¿¡äº¤æ¢æœºï¼Œé…ç½®æ­»ä¿¡è·¯ç”±ï¼Œç»‘å®šæ­»ä¿¡é˜Ÿåˆ—ï¼›</li>
<li>ä¸ºä¸šåŠ¡é˜Ÿåˆ—ç»‘å®šæ­»ä¿¡è·¯ç”±å’Œæ­»ä¿¡äº¤æ¢æœºã€‚</li>
</ol>
<p>ä¸€ä¸ªé¡¹ç›®å£°æ˜ä¸€ä¸ªæ­»ä¿¡äº¤æ¢æœºå³å¯ï¼Œå¯ä»¥ä¸ºä»»æ„ç±»å‹ã€Directã€Fanoutã€Topicã€‘ç»‘å®šå¤šä¸ªä¸šåŠ¡é˜Ÿåˆ—ï¼Œä¸ºæ¯ä¸ªä¸šåŠ¡é˜Ÿåˆ—åˆ†é…ä¸€ä¸ªå•ç‹¬çš„è·¯ç”±keyã€‚</p>
<h3 id="7-3-å…·ä½“ç¼–ç "><a href="#7-3-å…·ä½“ç¼–ç " class="headerlink" title="7.3 å…·ä½“ç¼–ç "></a>7.3 å…·ä½“ç¼–ç </h3><p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ã€‚</p>
<p>é¡¹ç›®é…ç½®<code>application.properties</code>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">server.port=5555</span></span><br><span class="line"><span class="string">spring.application.name=springboot-deadletter</span></span><br><span class="line"><span class="string">spring.rabbitmq.host=192.168.117.155</span></span><br><span class="line"><span class="string">spring.rabbitmq.port=5672</span></span><br><span class="line"><span class="string">spring.rabbitmq.virtual-host=/learn</span></span><br><span class="line"><span class="string">spring.rabbitmq.username=parak</span></span><br><span class="line"><span class="string">spring.rabbitmq.password=KAG1823</span></span><br><span class="line"><span class="string">spring.rabbitmq.listener.simple.default-requeue-rejected=false</span></span><br><span class="line"><span class="string">spring.rabbitmq.listener.simple.acknowledge-mode=manual</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºé…ç½®ç±»<code>DeadLetterConfig</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLetterConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_EXCHANGE = <span class="string">&quot;parak.dead.letter.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_QUEUE1 = <span class="string">&quot;parak.dead.letter.business.queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_QUEUE2 = <span class="string">&quot;parak.dead.letter.business.queue2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_EXCHANGE = <span class="string">&quot;parak.dead.letter.death.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_QUEUE1 = <span class="string">&quot;parak.dead.letter.death.queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_QUEUE2 = <span class="string">&quot;parak.dead.letter.death.queue2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_ROUTING_KEY1 = <span class="string">&quot;parak.dead.letter.death.key1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_ROUTING_KEY2 = <span class="string">&quot;parak.dead.letter.death.key2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å£°æ˜ä¸šåŠ¡äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;businessExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FanoutExchange <span class="title">businessExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FanoutExchange(BUSINESS_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">businessQueue1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// x-dead-letter-exchange å£°æ˜å½“å‰é˜Ÿåˆ—ç»‘å®šçš„æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">// x-dead-letter-routing-key å£°æ˜å½“å‰é˜Ÿåˆ—çš„æ­»ä¿¡è·¯ç”±key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY1);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE1).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">businessQueue2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// x-dead-letter-exchange å£°æ˜å½“å‰é˜Ÿåˆ—ç»‘å®šçš„æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">// x-dead-letter-routing-key å£°æ˜å½“å‰é˜Ÿåˆ—çš„æ­»ä¿¡è·¯ç”±key</span></span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY2);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE2).withArguments(args).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">businessBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> FanoutExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">businessBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> FanoutExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å£°æ˜æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">deadLetterExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(DEAD_LETTER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterQueue1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">deadLetterQueue1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(DEAD_LETTER_QUEUE1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterQueue2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">deadLetterQueue2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(DEAD_LETTER_QUEUE2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">deadLetterBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;deadLetterQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;deadLetterExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">deadLetterBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;deadLetterQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;deadLetterExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ç±»ä¸­é…ç½®äº†ä¸¤ä¸ªäº¤æ¢æœºï¼š</p>
<ul>
<li>ä¸šåŠ¡äº¤æ¢æœº</li>
<li>æ­»ä¿¡äº¤æ¢æœº</li>
</ul>
<p>å¹¶ä¸”åˆ†åˆ«ä¸ºä¸¤ä¸ªäº¤æ¢æœºç»‘å®šäº†ä¸¤ä¸ªé˜Ÿåˆ—ã€‚</p>
<p>åˆ›å»ºä¸šåŠ¡æ¶ˆæ¯çš„æ¶ˆè´¹è€…<code>BusinessMessageReceiver</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessMessageReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DeadLetterConfig.BUSINESS_QUEUE1)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveBusiness1</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">        log.info(<span class="string">&quot;ã€business-1ã€ receive message: [&#123;&#125;]&quot;</span>, msg);</span><br><span class="line">        <span class="keyword">boolean</span> ack = <span class="keyword">true</span>;</span><br><span class="line">        Exception exception = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg.contains(<span class="string">&quot;dead-letter&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Dead Letter&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ack = <span class="keyword">false</span>;</span><br><span class="line">            exception = e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!ack) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;consume message occur exception: [&#123;&#125;]&quot;</span>, exception.getMessage(), exception);</span><br><span class="line">            channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DeadLetterConfig.BUSINESS_QUEUE2)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reveiveBusiness2</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€business-2ã€ receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ­»ä¿¡æ¶ˆæ¯çš„æ¶ˆè´¹è€…<code>DeadLetterMessageReceiver</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLetterMessageReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DeadLetterConfig.DEAD_LETTER_QUEUE1)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveDeadLetter1</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€dead letter-1ã€ receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DeadLetterConfig.DEAD_LETTER_QUEUE2)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveDeadLetter2</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€dead letter-2ã€ receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å°è£…ä¸šåŠ¡æ¶ˆæ¯å‘é€è€…<code>BusinessMessageSender</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> top.parak.rabbitmq.RabbitMQConfig;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessMessageSender</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(DeadLetterConfig.BUSINESS_EXCHANGE, RabbitMQConfig.DEFAULT_ROUTING_KEY, msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ¥å£ç”¨äºç”Ÿäº§æ¶ˆæ¯<code>MessageController</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BusinessMessageSender businessMessageSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€å»¶æ—¶æ¶ˆæ¯ï¼ŒæŒ‰ç…§ç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=1&quot;&gt;delay 3s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=2&quot;&gt;delay 10s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/delay&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message, <span class="meta">@RequestParam(&quot;type&quot;)</span> Integer type)</span> </span>&#123;</span><br><span class="line">        DelayType delayType = DelayType.getDelayType(type);</span><br><span class="line">        <span class="keyword">if</span> (delayType == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;type is in [1, 2]&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;now: [&#123;&#125;], receive message: [&#123;&#125;], type: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> Date(), message, delayType);</span><br><span class="line">        delayMessageSender.sendMsg(message, delayType);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–å†™å¯åŠ¨ç±»å¹¶è¿è¡Œï¼Œè®¿é—®æµè§ˆå™¨è¿›è¡Œæµ‹è¯•ï¼š</p>
<p>ï¼ˆ1ï¼‰è®¿é—®ï¼š<a href="http://localhost:5555/rabbitmq/send/dead?msg=khighness">http://localhost:5555/rabbitmq/send/dead?msg=khighness</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-19</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">58.857</span>  INFO <span class="number">10120</span> --- [<span class="type">ntContainer</span><span class="comment">#9-1] top.parak.death.BusinessMessageReceiver  : ã€business-2ã€ receive message: [khighness]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">19</span> <span class="number">20</span>:<span class="number">58</span>:<span class="number">58.858</span>  <span class="type">INFO</span> <span class="number">10120</span> --- [<span class="type">tContainer</span><span class="comment">#10-1] top.parak.death.BusinessMessageReceiver  : ã€business-1ã€ receive message: [khighness]</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰è®¿é—®ï¼š<a href="http://localhost:5555/rabbitmq/send/dead?msg=dead-letter-kkk">http://localhost:5555/rabbitmq/send/dead?msg=dead-letter-kkk</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-19</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">23.462</span>  INFO <span class="number">10120</span> --- [<span class="type">ntContainer</span><span class="comment">#9-1] top.parak.death.BusinessMessageReceiver  : ã€business-2ã€ receive message: [dead-letter]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">23.462</span>  <span class="type">INFO</span> <span class="number">10120</span> --- [<span class="type">tContainer</span><span class="comment">#10-1] top.parak.death.BusinessMessageReceiver  : ã€business-1ã€ receive message: [dead-letter]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">23.462</span> <span class="type">ERROR</span> <span class="number">10120</span> --- [<span class="type">tContainer</span><span class="comment">#10-1] top.parak.death.BusinessMessageReceiver  : consumer message occur exception: [Dead Letter]</span></span><br><span class="line"></span><br><span class="line"><span class="type">java.lang.RuntimeException</span>: <span class="type">Dead</span> <span class="type">Letter</span></span><br><span class="line"><span class="type">...</span></span><br><span class="line"></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">23.465</span>  <span class="type">INFO</span> <span class="number">10120</span> --- [<span class="type">tContainer</span><span class="comment">#12-1] t.parak.death.DeadLetterMessageReceiver  : ã€dead letter-1ã€ receive message: [dead-letter]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">19</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">23.465</span>  <span class="type">INFO</span> <span class="number">10120</span> --- [<span class="type">tContainer</span><span class="comment">#11-1] t.parak.death.DeadLetterMessageReceiver  : ã€dead letter-2ã€ receive message: [dead-letter]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="7-4-æ¶ˆæ¯å˜åŒ–"><a href="#7-4-æ¶ˆæ¯å˜åŒ–" class="headerlink" title="7.4 æ¶ˆæ¯å˜åŒ–"></a>7.4 æ¶ˆæ¯å˜åŒ–</h3><p>æ­»ä¿¡æ¶ˆæ¯è¢«ä¸¢åˆ°æ­»ä¿¡é˜Ÿåˆ—ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–å‘¢ï¼Ÿ</p>
<p>å¦‚æœé˜Ÿåˆ—é…ç½®äº†å‚æ•°<code>x-dead-letter-routing-key</code>çš„è¯ï¼Œæ­»ä¿¡çš„è·¯ç”±keyå°†ä¼šè¢«æ›¿æ¢æˆè¯¥å‚æ•°å¯¹åº”çš„å€¼ã€‚å¦‚æœæ²¡æœ‰é…ç½®ï¼Œåˆ™ä¿ç•™è¯¥æ¶ˆæ¯åŸæœ‰çš„è·¯ç”±keyã€‚</p>
<p>ä¸¾ä¸ªğŸŒ°ï¼š</p>
<p>å¦‚æœåŸæœ‰æ¶ˆæ¯çš„è·¯ç”±keyæ˜¯<code>K</code>ï¼Œè¢«å‘é€åˆ°ä¸šåŠ¡äº¤æ¢æœºä¸­ï¼Œç„¶åè¢«æŠ•é€’åˆ°ä¸šåŠ¡é˜Ÿåˆ—<code>Queue1</code>ä¸­ï¼Œå¦‚æœè¯¥é˜Ÿåˆ—æ²¡æœ‰é…ç½®å‚æ•°<code>x-dead-letter-routing-key</code>ï¼Œåˆ™è¯¥æ¶ˆæ¯æˆä¸ºæ­»ä¿¡åï¼Œå°†ä¿ç•™åŸæœ‰çš„è·¯ç”±key<code>K</code>ï¼Œå¦‚æœé…ç½®äº†è¯¥å‚æ•°ï¼Œå¹¶ä¸”å€¼è®¾ç½®ä¸º<code>A</code>ï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯æˆä¸ºæ­»ä¿¡åï¼Œè·¯ç”±keyä¼šè¢«æ›¿æ¢ä¸º<code>A</code>ï¼Œç„¶åè¢«æŠ›åˆ°æ­»ä¿¡äº¤æ¢æœºä¸­ã€‚</p>
<p>å¦å¤–ï¼Œç”±äºè¢«æŠ›åˆ°äº†æ­»ä¿¡äº¤æ¢æœºï¼Œæ‰€ä»¥æ¶ˆæ¯çš„äº¤æ¢æœºåç§°ä¹Ÿä¼šè¢«æ›¿æ¢ä¸ºæ­»ä¿¡äº¤æ¢æœºçš„åç§°ã€‚</p>
<p>è€Œæ¶ˆæ¯çš„Headerä¸­ï¼Œä¹Ÿä¼šæ·»åŠ å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„å­—æ®µï¼Œä¿®æ”¹æ­»ä¿¡é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ä»£ç ï¼Œæ·»åŠ ä¸€è¡Œæ—¥å¿—è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">log.info(&quot;dead letter properties: [&#123;&#125;]&quot;, message.getMessageProperties());</span><br></pre></td></tr></table></figure>

<p>å†æ¬¡æµ‹è¯•ï¼Œå¯ä»¥å¾—åˆ°æ­»ä¿¡æ¶ˆæ¯Headerä¸­è¢«æ·»åŠ çš„ä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-09-19 21:53:41.172  INFO 5628 --- [tContainer#12-1] t.parak.death.DeadLetterMessageReceiver  : dead letter properties: [MessageProperties [headers&#x3D;&#123;x-first-death-exchange&#x3D;parak.dead.letter.business.exchange, x-death&#x3D;[&#123;reason&#x3D;rejected, count&#x3D;1, exchange&#x3D;parak.dead.letter.business.exchange, time&#x3D;Sun Sep 19 21:09:38 CST 2021, routing-keys&#x3D;[], queue&#x3D;parak.dead.letter.business.queue1&#125;], x-first-death-reason&#x3D;rejected, x-first-death-queue&#x3D;parak.dead.letter.business.queue1&#125;, contentType&#x3D;text&#x2F;plain, contentEncoding&#x3D;UTF-8, contentLength&#x3D;0, receivedDeliveryMode&#x3D;PERSISTENT, priority&#x3D;0, redelivered&#x3D;false, receivedExchange&#x3D;parak.dead.letter.death.exchange, receivedRoutingKey&#x3D;parak.dead.letter.death.key1, deliveryTag&#x3D;1, consumerTag&#x3D;amq.ctag-DmBuSjljWVkbuaFJvspHyw, consumerQueue&#x3D;parak.dead.letter.death.queue1]]</span><br></pre></td></tr></table></figure>

<p>ç®€è¦è¯´æ˜ä¸€ä¸‹Headerä¸­çš„å€¼ï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>x-first-death-exchange</td>
<td>ç¬¬ä¸€æ¬¡è¢«æŠ›å…¥çš„æ­»ä¿¡äº¤æ¢æœºçš„åç§°</td>
</tr>
<tr>
<td>x-first-death-reason</td>
<td>ç¬¬ä¸€æ¬¡æˆä¸ºæ­»ä¿¡çš„åŸå› ï¼š<br />(1)<code>rejected</code>ï¼šæ¶ˆæ¯åœ¨é‡æ–°è¿›å…¥é˜Ÿåˆ—æ—¶è¢«é˜Ÿåˆ—æ‹’ç»ï¼Œç”±äº<code>default-requeue-rejected</code>å‚æ•°è¢«è®¾ç½®ä¸º<code>false</code><br />(2)<code>expired</code>ï¼šæ¶ˆæ¯è¿‡æœŸ<br />(3)<code>maxlen</code>ï¼šé˜Ÿåˆ—å†…æ¶ˆæ¯æ•°é‡è¶…è¿‡é˜Ÿåˆ—æœ€å¤§å®¹é‡</td>
</tr>
<tr>
<td>x-first-death-queue</td>
<td>ç¬¬ä¸€æ¬¡ç§°ä¸ºæ­»ä¿¡å‰æ‰€åœ¨é˜Ÿåˆ—åç§°</td>
</tr>
<tr>
<td>x-death</td>
<td>å†æ¬¡è¢«æŠ•å…¥æ­»ä¿¡äº¤æ¢æœºçš„ä¿¡æ¯åˆ—è¡¨ï¼ŒåŒä¸€ä¸ªæ¶ˆæ¯æ¯æ¬¡è¿›å…¥ä¸€ä¸ªæ­»ä¿¡äº¤æ¢æœºï¼Œè¿™ä¸ªæ•°ç»„çš„ä¿¡æ¯å°±ä¼šè¢«æ›´æ–°ã€‚</td>
</tr>
</tbody></table>
<h3 id="7-5-åº”ç”¨åœºæ™¯"><a href="#7-5-åº”ç”¨åœºæ™¯" class="headerlink" title="7.5 åº”ç”¨åœºæ™¯"></a>7.5 åº”ç”¨åœºæ™¯</h3><p>ä¸€èˆ¬ç”¨åœ¨è¾ƒä¸ºé‡è¦çš„ä¸šåŠ¡é˜Ÿåˆ—ä¸­ï¼Œç¡®ä¿æœªè¢«æ­£ç¡®æ¶ˆè´¹çš„æ¶ˆæ¯ä¸è¢«ä¸¢å¼ƒï¼Œä¸€èˆ¬å‘ç”Ÿæ¶ˆè´¹å¼‚å¸¸å¯èƒ½åŸå› ä¸»è¦æœ‰ç”±äºæ¶ˆæ¯ä¿¡æ¯æœ¬èº«å­˜åœ¨æ¶ˆæ¯é”™è¯¯å¯¼è‡´å¤„ç†å¼‚å¸¸ã€å¤„ç†è¿‡ç¨‹ä¸­å‚æ•°æ ¡éªŒå¼‚å¸¸æˆ–è€…å› ç½‘ç»œæ³¢åŠ¨å¯¼è‡´çš„æŸ¥è¯¢å¼‚å¸¸ç­‰ç­‰ã€‚å½“å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå½“ç„¶ä¸èƒ½æ¯æ¬¡é€šè¿‡æ—¥å¿—æ¥è·å–åŸæ¶ˆæ¯ï¼Œç„¶åè®©è¿ç»´å¸®å¿™é‡æ–°æŠ•é€’æ¶ˆæ¯ã€‚</p>
<p>é€šè¿‡é…ç½®æ­»ä¿¡é˜Ÿåˆ—ï¼Œå¯ä»¥è®©æœªæ­£ç¡®å¤„ç†çš„æ¶ˆæ¯æš‚å­˜åˆ°å¦ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¾…åç»­æ’æŸ¥æ¸…é™¤é—®é¢˜åï¼Œç¼–å†™ç›¸åº”çš„å¤„ç†ä»£ç æ¥å¤„ç†æ­»ä¿¡æ¶ˆæ¯ï¼Œè¿™æ ·æ¯”æ‰‹å·¥æ¢å¤æ•°æ®å¥½å¤ªå¤šäº†ã€‚</p>
<h3 id="7-6-ç”Ÿå‘½å‘¨æœŸ"><a href="#7-6-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="7.6 ç”Ÿå‘½å‘¨æœŸ"></a>7.6 ç”Ÿå‘½å‘¨æœŸ</h3><p>æ€»ç»“ä¸€ä¸‹æ­»ä¿¡æ¶ˆæ¯çš„ç”Ÿå‘½å‘¨æœŸï¼š</p>
<ol>
<li>ä¸šåŠ¡æ¶ˆæ¯è¢«æŠ•å…¥ä¸šåŠ¡é˜Ÿåˆ—ï¼›</li>
<li>æ¶ˆè´¹è€…æ¶ˆè´¹ä¸šåŠ¡é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œç”±äºå¤„ç†è¿‡ç¨‹ä¸­äº§ç”Ÿäº†å¼‚å¸¸ï¼Œäºæ˜¯è¿›è¡Œnackæˆ–è€…rejectæ“ä½œï¼›</li>
<li>è¢«nackæˆ–rejectçš„æ¶ˆæ¯ç”±RabbitMQæŠ•é€’åˆ°æ­»ä¿¡äº¤æ¢æœºä¸­ï¼›</li>
<li>æ­»ä¿¡äº¤æ¢æœºå°†æ¶ˆæ¯æŠ•é€’åˆ°ç›¸åº”çš„æ­»ä¿¡é˜Ÿåˆ—ä¸­ï¼›</li>
<li>æ­»ä¿¡é˜Ÿåˆ—çš„æ¶ˆè´¹è€…æ¶ˆè´¹æ­»ä¿¡æ¶ˆæ¯ã€‚</li>
</ol>
<p>æ­»ä¿¡é˜Ÿåˆ—å¹¶æ²¡æœ‰ç‰¹æ®Šçš„åœ°æ–¹ï¼Œä¸è¿‡æ˜¯ç»‘å®šåœ¨æ­»ä¿¡äº¤æ¢æœºä¸Šçš„æ™®é€šé˜Ÿåˆ—ï¼Œè€Œæ­»ä¿¡äº¤æ¢æœºä¹Ÿåªæ˜¯ä¸€ä¸ªæ™®é€šçš„äº¤æ¢æœºï¼Œåªä¸è¿‡ä¸“é—¨ç”¨äºå¤„ç†æ­»ä¿¡ã€‚</p>
<h2 id="8-RabbitMQå»¶æ—¶é˜Ÿåˆ—"><a href="#8-RabbitMQå»¶æ—¶é˜Ÿåˆ—" class="headerlink" title="8. RabbitMQå»¶æ—¶é˜Ÿåˆ—"></a>8. RabbitMQå»¶æ—¶é˜Ÿåˆ—</h2><h3 id="8-1-å»¶æ—¶é˜Ÿåˆ—"><a href="#8-1-å»¶æ—¶é˜Ÿåˆ—" class="headerlink" title="8.1 å»¶æ—¶é˜Ÿåˆ—"></a>8.1 å»¶æ—¶é˜Ÿåˆ—</h3><p>å»¶æ—¶é˜Ÿåˆ—ï¼šé˜Ÿåˆ—å†…éƒ¨å…ƒç´ æœ‰åºï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ å¸¦æ—¶é—´å±æ€§ã€‚</p>
<p>å…ƒç´ éœ€è¦åœ¨æŒ‡å®šæ—¶é—´è¢«å–å‡ºå’Œå¤„ç†ï¼Œé€šå¸¸æ¥è¯´æ˜¯æ¶ˆæ¯æˆ–ä»»åŠ¡ã€‚</p>
<h3 id="8-2-ä½¿ç”¨åœºæ™¯"><a href="#8-2-ä½¿ç”¨åœºæ™¯" class="headerlink" title="8.2 ä½¿ç”¨åœºæ™¯"></a>8.2 ä½¿ç”¨åœºæ™¯</h3><p>è€ƒè™‘ä»¥ä¸‹åœºæ™¯ï¼š</p>
<ul>
<li>ç”¨æˆ·ä¸‹å•åï¼Œè®¢å•ååˆ†é’Ÿå†…æœªæ”¯ä»˜åˆ™è‡ªåŠ¨å–æ¶ˆï¼›</li>
<li>ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œä¸‰å¤©æœªç™»å½•åˆ™è¿›è¡ŒçŸ­ä¿¡æé†’ï¼›</li>
<li>é¢„å®šä¼šè®®åï¼Œé¢„çº¦æ—¶é—´å‰ååˆ†é’Ÿé€šçŸ¥äººå‘˜å‚ä¼šã€‚</li>
</ul>
<p>è¿™äº›åœºæ™¯éƒ½æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œéœ€è¦åœ¨æŸä¸ªäº‹ä»¶å‘ç”Ÿä¹‹åæˆ–è€…ä¹‹å‰çš„æŒ‡å®šæ—¶é—´ç‚¹å†…å®ŒæˆæŸä¸€é¡¹ä»»åŠ¡ï¼Œå¦‚ï¼šå‘ç”Ÿè®¢å•ç”Ÿæˆäº‹ä»¶ï¼Œåœ¨ååˆ†é’Ÿä¹‹åæ£€æŸ¥è¯¥è®¢å•æ”¯ä»˜çŠ¶æ€ï¼Œç„¶åå°†æœªæ”¯ä»˜çš„è®¢å•è¿›è¡Œå…³é—­ï¼›å‘ç”Ÿç”¨æˆ·æ³¨å†Œæ—¶é—´ï¼Œä¸‰å¤©åæ£€æŸ¥æ–°æ³¨å†Œç”¨æˆ·çš„æ´»åŠ¨æ•°æ®ï¼Œç„¶åé€šçŸ¥æ²¡æœ‰ä»»ä½•æ´»åŠ¨è®°å½•çš„ç”¨æˆ·ã€‚</p>
<p>ä»¥ä¸Šåœºæ™¯å¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨å®šæ—¶ä»»åŠ¡+è½®è¯¢è§£å†³ï¼Œä¸€ç›´è½®è¯¢æ•°æ®ï¼Œæ¯ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼Œå–å‡ºå¾äºšè¢«å¤„ç†çš„æ•°æ®ã€‚æ¯å¤©æ™šä¸Šè·‘ä¸ªå®šæ—¶ä»»åŠ¡æ£€æŸ¥æ‰€æœ‰æœªæ”¯ä»˜çš„è®¢å•ï¼Œåœ¨æ•°æ®é‡æ¯”è¾ƒå°‘çš„æƒ…å†µè¿™ä¹ˆåšæ²¡æœ‰å¤ªå¤§çš„æ¯›ç—…ã€‚ä½†æ˜¯å¯¹äºæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œå¹¶ä¸”æ—¶æ•ˆæ€§è¾ƒå¼ºçš„åœºæ™¯ï¼Œæ¯”å¦‚ï¼šç§’æ€åœºæ™¯ä¸‹è®¢å•ååˆ†é’Ÿæœªæ”¯ä»˜åˆ™å…³é—­ï¼Œåœ¨æ´»åŠ¨æœŸé—´çš„è®¢å•æ•°æ®é‡åºå¤§çš„æƒ…å†µä¸‹è¿›è¡Œå»è½®è¯¢æ•°æ®åº“ï¼Œå¾ˆå¯èƒ½åœ¨ä¸€ç§’å†…æ— æ³•å®Œæˆæ‰€æœ‰è®¢å•çš„æ£€æŸ¥ï¼ŒåŒæ—¶ä¼šç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å‹åŠ›ï¼Œæ— æ³•æ»¡è¶³ä¸šåŠ¡è¦æ±‚å¹¶ä¸”æ€§èƒ½ä½ä¸‹ã€‚</p>
<p>è€Œå°†å»¶æ—¶é˜Ÿåˆ—åº”ç”¨åˆ°ä¸Šè¿°åœºæ™¯ï¼Œä¿è¯æ€§èƒ½çš„åŒæ—¶è¿˜èƒ½ä¿æŒä¼˜é›…ã€‚</p>
<h3 id="8-3-RabbitMQ-TTL"><a href="#8-3-RabbitMQ-TTL" class="headerlink" title="8.3 RabbitMQ-TTL"></a>8.3 RabbitMQ-TTL</h3><p>è¿™é‡Œéœ€è¦ä»‹ç»ä¸€ä¸‹RabbitMQçš„é«˜çº§ç‰¹æ€§ï¼š<code>TTL</code>(Time to Live)ã€‚</p>
<p>TTLæ˜¯RabbitMQä¸­ä¸€ä¸ªæ¶ˆæ¯æˆ–è€…é˜Ÿåˆ—çš„å±æ€§ï¼Œè¡¨æ˜ä¸€æ¡æ¶ˆæ¯æˆ–è€…è¯¥é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯çš„æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœä¸€æ¡æ¶ˆæ¯è®¾ç½®äº†TTLå±æ€§æˆ–è€…è¿›å…¥äº†è®¾ç½®TTLå±æ€§çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯å¦‚æœåœ¨TTLè®¾ç½®çš„æ—¶é—´å†…æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œåˆ™ä¼šæˆä¸ºâ€œæ­»ä¿¡â€ã€‚å¦‚æœåŒæ—¶é…ç½®äº†é˜Ÿåˆ—çš„TTLå’Œæ¶ˆæ¯çš„TTLï¼Œé‚£ä¹ˆè¾ƒå°çš„é‚£ä¸ªå€¼å°†ä¼šè¢«ä½¿ç”¨ã€‚</p>
<p>è®¾ç½®TTLå±æ€§æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<p>ï¼ˆ1ï¼‰åˆ›å»ºé˜Ÿåˆ—çš„æ—¶å€™è®¾ç½®é˜Ÿåˆ—çš„<code>x-message-ttl</code>å±æ€§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String, Object&gt; args = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">6000</span>);</span><br><span class="line">channel.queueDeclare(queueName, durable, exclusive, autoDelete, args);</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æ‰€æœ‰è¢«æŠ•é€’åˆ°è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯éƒ½æœ€å¤šä¸ä¼šå­˜æ´»è¶…è¿‡6sã€‚</p>
<p>ï¼ˆ2ï¼‰é’ˆå¯¹æ¯æ¡æ¶ˆæ¯è®¾ç½®TTLæœ€å¤§å­˜æ´»æ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AMQP.BasicProperties.Builder builder = <span class="keyword">new</span> AMQP.BasicProperties.Builder();</span><br><span class="line">builder.expiration(<span class="string">&quot;6000&quot;</span>);</span><br><span class="line">AMQP.BasicProperties properties = builder.build();</span><br><span class="line">channel.basicPublish(exchangeName, routingKey, mandatory, properties, message.getBytes());</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™ä¸¤ç§æ–¹å¼è¿˜æ˜¯åŒºåˆ«çš„ï¼Œå¦‚æœè®¾ç½®äº†é˜Ÿåˆ—çš„TTLå±æ€§ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¸€æ—¦è¿‡æœŸï¼Œå°±ä¼šè¢«é˜Ÿåˆ—ä¸¢å¼ƒï¼Œè€Œç¬¬äºŒç§æ–¹å¼ï¼Œæ¶ˆæ¯å³ä½¿è¿‡æœŸï¼Œä¹Ÿä¸ä¸€å®šä¼šè¢«é©¬ä¸Šä¸¢å¼ƒï¼Œå› ä¸ºæ¶ˆæ¯æ˜¯å¦è¿‡æœŸæ˜¯åœ¨å³å°†æŠ•é€’åˆ°æ¶ˆè´¹è€…ä¹‹å‰åˆ¤å®šçš„ï¼Œå¦‚æœå½“å‰é˜Ÿåˆ—æœ‰ä¸¥é‡çš„æ¶ˆæ¯ç§¯å‹æƒ…å†µï¼Œåˆ™å·²è¿‡æœŸçš„æ¶ˆæ¯ä¹Ÿè®¸è¿˜èƒ½å­˜æ´»è¾ƒé•¿æ—¶é—´ã€‚</p>
<p>å¦å¤–ï¼Œè¿˜éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li>å¦‚æœä¸è®¾ç½®TTLï¼Œè¡¨ç¤ºæ¶ˆæ¯æ°¸è¿œä¸ä¼šè¿‡æœŸã€‚</li>
<li>å¦‚æœè®¾ç½®TTL=0ï¼Œåˆ™è¡¨ç¤ºé™¤éæ­¤æ—¶å¯ä»¥ç›´æ¥æŠ•é€’è¯¥æ¶ˆæ¯åˆ°æ¶ˆè´¹è€…ï¼Œå¦åˆ™è¯¥æ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒã€‚</li>
</ul>
<h3 id="8-4-å®ç°åŸç†"><a href="#8-4-å®ç°åŸç†" class="headerlink" title="8.4 å®ç°åŸç†"></a>8.4 å®ç°åŸç†</h3><p>å»¶æ—¶é˜Ÿåˆ—ï¼Œå³å°†æ¶ˆæ¯å»¶è¿Ÿä¸€å®šæ—¶é—´è¿›è¡Œå¤„ç†ï¼ŒTTLåˆšå¥½èƒ½è®©æ¶ˆæ¯åœ¨å»¶è¿Ÿä¸€å®šæ—¶é—´æˆä¸ºæ­»ä¿¡ï¼Œå¦ä¸€æ–¹é¢ï¼Œæˆä¸ºæ­»ä¿¡çš„æ¶ˆæ¯éƒ½ä¼šè¢«æŠ•é€’åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ï¼Œè¿™æ ·åªéœ€è¦æ¶ˆè´¹è€…ä¸€ç›´æ¶ˆè´¹æ­»ä¿¡é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å³å¯ã€‚</p>
<p>æ¶ˆæ¯æµå‘å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/delay.png" class="" title="delay"><br />

<p>ç”Ÿäº§è€…ç”Ÿäº§ä¸€æ¡å»¶æ—¶æ¶ˆæ¯ï¼Œæ ¹æ®éœ€è¦å»¶æ—¶æ—¶é—´çš„ä¸åŒï¼Œåˆ©ç”¨ä¸åŒçš„routingKeyå°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„å»¶æ—¶é˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—éƒ½è®¾ç½®äº†ä¸åŒçš„TTLå±æ€§ï¼Œå¹¶ç»‘å®šåœ¨åŒä¸€ä¸ªæ­»ä¿¡äº¤æ¢æœºä¸­ï¼Œæ¶ˆæ¯è¿‡æœŸåï¼Œæ ¹æ®routingKeyçš„ä¸åŒï¼Œåˆä¼šè¢«è·¯ç”±åˆ°ä¸åŒçš„æ­»ä¿¡é˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…åªéœ€è¦ç›‘å¬å¯¹åº”çš„æ­»ä¿¡é˜Ÿåˆ—è¿›è¡Œå¤„ç†å³å¯ã€‚</p>
<h3 id="8-5-å…·ä½“ç¼–ç "><a href="#8-5-å…·ä½“ç¼–ç " class="headerlink" title="8.5 å…·ä½“ç¼–ç "></a>8.5 å…·ä½“ç¼–ç </h3><p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ã€‚</p>
<p>é¡¹ç›®é…ç½®<code>application.properties</code>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">server.port=6666</span></span><br><span class="line"><span class="string">spring.application.name=springboot-delayqueue</span></span><br><span class="line"><span class="string">spring.rabbitmq.host=192.168.117.155</span></span><br><span class="line"><span class="string">spring.rabbitmq.port=5672</span></span><br><span class="line"><span class="string">spring.rabbitmq.virtual-host=/learn</span></span><br><span class="line"><span class="string">spring.rabbitmq.username=parak</span></span><br><span class="line"><span class="string">spring.rabbitmq.password=KAG1823</span></span><br><span class="line"><span class="string">spring.rabbitmq.listener.simple.default-requeue-rejected=false</span></span><br><span class="line"><span class="string">spring.rabbitmq.listener.simple.acknowledge-mode=manual</span></span><br></pre></td></tr></table></figure>

<p>ç¼–å†™é…ç½®ç±»<code>DelayQueueConfig</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayQueueConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAY_EXCHANGE = <span class="string">&quot;parak.delay.queue.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAY_QUEUE1 = <span class="string">&quot;parak.delay.queue.business.queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAY_QUEUE2 = <span class="string">&quot;parak.delay.queue.business.queue2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAY_QUEUE_ROUTING_KEY1 = <span class="string">&quot;parak.delay.queue.business.key1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAY_QUEUE_ROUTING_KEY2 = <span class="string">&quot;parak.delay.queue.business.key2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_EXCHANGE = <span class="string">&quot;parak.delay.queue.deadletter.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_QUEUE1 = <span class="string">&quot;parak.delay.queue.deadletter.queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_QUEUE2 = <span class="string">&quot;parak.delay.queue.deadletter.queue2&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_ROUTING_KEY1 = <span class="string">&quot;parak.delay.queue.deadletter.key1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_ROUTING_KEY2 = <span class="string">&quot;parak.delay.queue.deadletter.key2&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å£°æ˜å»¶æ—¶äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;delayExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">delayExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(DELAY_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;delayQueue1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">delayQueue1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE);</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY1);</span><br><span class="line">        map.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">3000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(DELAY_QUEUE1).withArguments(map).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;delayQueue2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">delayQueue2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE);</span><br><span class="line">        map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY2);</span><br><span class="line">        map.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(DELAY_QUEUE2).withArguments(map).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">delayBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;delayQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;delayExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DELAY_QUEUE_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">delayBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;delayQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;delayExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DELAY_QUEUE_ROUTING_KEY2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å£°æ˜æ­»ä¿¡äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">deadLetterExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(DEAD_LETTER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterQueue1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">deadLetterQueue1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(DEAD_LETTER_QUEUE1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;deadLetterQueue2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">deadLetterQueue2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(DEAD_LETTER_QUEUE2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">deadLetterBinding1</span><span class="params">(<span class="meta">@Qualifier(&quot;deadLetterQueue1&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;deadLetterExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">deadLetterBinding2</span><span class="params">(<span class="meta">@Qualifier(&quot;deadLetterQueue2&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;deadLetterExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨é…ç½®ç±»ä¸­æ³¨å†Œäº†ä¸¤ä¸ªå»¶è¿Ÿé˜Ÿåˆ—å’Œä¸¤ä¸ªæ­»ä¿¡é˜Ÿåˆ—ã€‚</p>
<p>åˆ›å»ºæ­»ä¿¡æ¶ˆæ¯æ¶ˆè´¹è€…<code>DeadLetterMessageReceiver</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLetterMessageReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DelayQueueConfig.DEAD_LETTER_QUEUE1)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveDeadLetter1</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;now: [&#123;&#125;], ã€dead letter-1ã€ receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> Date(), <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DelayQueueConfig.DEAD_LETTER_QUEUE2)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveDeadLetter2</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;now: [&#123;&#125;], ã€dead letter-2ã€ receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> Date(), <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå»¶æ—¶ç±»å‹<code>DelayType</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">DelayType</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    DELAY_3_SECONDS(<span class="number">1</span>, <span class="number">3000</span>),</span><br><span class="line">    DELAY_10_SECONDS(<span class="number">2</span>, <span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> delayTime;</span><br><span class="line"></span><br><span class="line">    DelayType(<span class="keyword">int</span> type, <span class="keyword">int</span> delayTime) &#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.delayTime = delayTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDelayTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delayTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DelayType <span class="title">getDelayType</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (DelayType delayType : DelayType.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == delayType.getType()) &#123;</span><br><span class="line">                <span class="keyword">return</span> delayType;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ¶ˆæ¯å‘é€è€…<code>DelayMessageSender</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayMessageSender</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String msg, DelayType type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> DELAY_3_SECONDS:</span><br><span class="line">                rabbitTemplate.convertAndSend(DelayQueueConfig.DELAY_EXCHANGE, DelayQueueConfig.DELAY_QUEUE_ROUTING_KEY1, msg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DELAY_10_SECONDS:</span><br><span class="line">                rabbitTemplate.convertAndSend(DelayQueueConfig.DELAY_EXCHANGE, DelayQueueConfig.DELAY_QUEUE_ROUTING_KEY2, msg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ¥å£ç”¨äºç”Ÿäº§æ¶ˆæ¯<code>MessageController</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DelayMessageSender delayMessageSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€å»¶æ—¶æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=1&quot;&gt;delay 3s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=2&quot;&gt;delay 10s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/delay&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message, <span class="meta">@RequestParam(&quot;type&quot;)</span> Integer type)</span> </span>&#123;</span><br><span class="line">        DelayType delayType = DelayType.getDelayType(type);</span><br><span class="line">        <span class="keyword">if</span> (delayType == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;type is in [1, 2]&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;now: [&#123;&#125;], receive message: [&#123;&#125;], type: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> Date(), message, delayType);</span><br><span class="line">        delayMessageSender.sendMsg(message, delayType);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–å†™å¯åŠ¨ç±»å¹¶è¿è¡Œï¼Œè®¿é—®æµè§ˆå™¨è¿›è¡Œæµ‹è¯•ï¼š</p>
<p>ï¼ˆ1ï¼‰è®¿é—®ï¼š<a href="http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=1">http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=1</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">18.662</span>  INFO <span class="number">14652</span> --- [<span class="type">nio</span>-<span class="number">7777</span>-<span class="type">exec</span>-<span class="number">2</span>] top.parak.delay.MessageController        : now: [<span class="type">Tue</span> <span class="type">Sep</span> <span class="number">21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">18</span> <span class="type">CST</span> <span class="number">2021</span>], receive message: [<span class="type">Khighness</span>], <span class="built_in">type</span>: [<span class="type">DELAY_3_SECONDS</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">21.666</span>  INFO <span class="number">14652</span> --- [<span class="type">ntContainer</span><span class="comment">#0-1] t.parak.delay.DeadLetterMessageReceiver  : now: [Tue Sep 21 10:15:21 CST 2021], ã€dead letter-1ã€ receive message: [Khighness]</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰è®¿é—®ï¼š<a href="http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=2">http://localhost:7777/rabbitmq/send/delay?msg=khighness&amp;type=2</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">26.273</span>  INFO <span class="number">14652</span> --- [<span class="type">nio</span>-<span class="number">7777</span>-<span class="type">exec</span>-<span class="number">3</span>] top.parak.delay.MessageController        : now: [<span class="type">Tue</span> <span class="type">Sep</span> <span class="number">21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">26</span> <span class="type">CST</span> <span class="number">2021</span>], receive message: [<span class="type">Khighness</span>], <span class="built_in">type</span>: [<span class="type">DELAY_10_SECONDS</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">10</span>:<span class="number">15</span>:<span class="number">36.276</span>  INFO <span class="number">14652</span> --- [<span class="type">ntContainer</span><span class="comment">#1-1] t.parak.delay.DeadLetterMessageReceiver  : now: [Tue Sep 21 10:15:36 CST 2021], ã€dead letter-2ã€ receive message: [Khighness]</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¡æ¶ˆæ¯åœ¨3Såå˜æˆæ­»ä¿¡æ¶ˆæ¯ï¼Œç„¶åè¢«æ¶ˆè´¹è€…æ¶ˆè´¹æ‰ï¼Œç¬¬äºŒæ¡æ¶ˆæ¯åœ¨10Sä¹‹åå˜æˆæ­»ä¿¡æ¶ˆæ¯ã€‚</p>
<p>å¦‚æœè¿™æ ·ä½¿ç”¨çš„è¯ï¼Œæ¯å¢åŠ ä¸€ä¸ªæ–°çš„æ—¶é—´éœ€æ±‚ï¼Œå°±è¦æ–°å¢ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆå¯¹äºé¢„å®šä¼šè®®å®¤ç„¶åæå‰é€šçŸ¥è¿™æ ·çš„åœºæ™¯ï¼Œå²‚ä¸æ˜¯è¦å¢åŠ æ— æ•°ä¸ªé˜Ÿåˆ—æ‰èƒ½æ»¡è¶³éœ€æ±‚ï¼Ÿ</p>
<h3 id="8-6-é˜Ÿåˆ—ä¼˜åŒ–"><a href="#8-6-é˜Ÿåˆ—ä¼˜åŒ–" class="headerlink" title="8.6 é˜Ÿåˆ—ä¼˜åŒ–"></a>8.6 é˜Ÿåˆ—ä¼˜åŒ–</h3><p>ä¸ºäº†å®ç°ä¸€ç§æ›´é€šç”¨çš„æ–¹æ¡ˆï¼Œé‚£ä¹ˆè€Œåªèƒ½å°†æ¶ˆæ¯è®¾ç½®åœ¨æ¶ˆæ¯å±æ€§é‡Œäº†ã€‚</p>
<p>åœ¨<code>DelayQueueConfig</code>ä¸­å¢åŠ ä¸€ä¸ªå»¶æ—¶é˜Ÿåˆ—ï¼Œä¸è®¾ç½®TTLï¼Œç”¨äºæ¥æ”¶ä»»æ„å»¶æ—¶å¸‚åœºçš„æ¶ˆæ¯ï¼Œå¢åŠ ä¸€ä¸ªç›¸åº”çš„æ­»ä¿¡é˜Ÿåˆ—å’Œè·¯ç”±Keyã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAY_QUEUE3 = <span class="string">&quot;parak.delay.queue.business.queue3&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAY_QUEUE_ROUTING_KEY3 = <span class="string">&quot;parak.delay.queue.business.key3&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_QUEUE3 = <span class="string">&quot;parak.delay.queue.deadletter.queue3&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_ROUTING_KEY3 = <span class="string">&quot;parak.delay.queue.deadletter.key3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸è®¾ç½®TTL</span></span><br><span class="line"><span class="meta">@Bean(&quot;delayQueue3&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Queue <span class="title">delayQueue3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, DEAD_LETTER_EXCHANGE);</span><br><span class="line">    map.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>, DEAD_LETTER_ROUTING_KEY3);</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder.durable(DELAY_QUEUE3).withArguments(map).build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Binding <span class="title">delayBinding3</span><span class="params">(<span class="meta">@Qualifier(&quot;delayQueue3&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;delayExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DELAY_QUEUE_ROUTING_KEY3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(&quot;deadLetterQueue3&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Queue <span class="title">deadLetterQueue3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Queue(DEAD_LETTER_QUEUE3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Binding <span class="title">deadLetterBinding3</span><span class="params">(<span class="meta">@Qualifier(&quot;deadLetterQueue3&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;deadLetterExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DEAD_LETTER_ROUTING_KEY3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>DeadLetterMessageReceiver</code>ä¸­å¢åŠ ä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = DelayQueueConfig.DEAD_LETTER_QUEUE3)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveDeadLetter3</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;now: [&#123;&#125;], ã€dead letter-3ã€ receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> Date(), <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>DelayMessageSender</code>ä¸­å°è£…ä¸€ä¸ªæ–¹æ³•å‘é€æŒ‡å®šå»¶æ—¶æ—¶é—´çš„æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String msg, <span class="keyword">long</span> delayTime)</span> </span>&#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(DelayQueueConfig.DELAY_EXCHANGE, DelayQueueConfig.DELAY_QUEUE_ROUTING_KEY3, msg, m -&gt; &#123;</span><br><span class="line">        m.getMessageProperties().setExpiration(Long.toString(delayTime));</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>MessageController</code>ä¸­å¢åŠ ä¸€ä¸ªæ¥å£ç”¨äºå‘é€å»¶æ—¶æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å‘é€å»¶æ—¶æ¶ˆæ¯ï¼ŒæŒ‰ç…§æ—¶é—´</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=1000&quot;&gt;delay 3s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=5000&quot;&gt;delay 5s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/time&quot;)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message, <span class="meta">@RequestParam(&quot;time&quot;)</span> Long time)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;now: [&#123;&#125;], receive message: [&#123;&#125;], time: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> Date(), message, time);</span><br><span class="line">    delayMessageSender.sendMsg(message, time);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡æ–°è¿è¡Œå¯åŠ¨ç±»ï¼Œè®¿é—®æµè§ˆå™¨è¿›è¡Œæµ‹è¯•ï¼š<br>ï¼ˆ1ï¼‰è®¿é—®ï¼š<a href="http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=1000">http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=1000</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">56.532</span>  INFO <span class="number">13876</span> --- [<span class="type">nio</span>-<span class="number">7777</span>-<span class="type">exec</span>-<span class="number">6</span>] top.parak.delay.MessageController        : now: [<span class="type">Tue</span> <span class="type">Sep</span> <span class="number">21</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">56</span> <span class="type">CST</span> <span class="number">2021</span>], receive message: [<span class="type">khighness</span>], time: [<span class="number">1000</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">12</span>:<span class="number">35</span>:<span class="number">57.539</span>  INFO <span class="number">13876</span> --- [<span class="type">ntContainer</span><span class="comment">#0-1] t.parak.delay.DeadLetterMessageReceiver  : now: [Tue Sep 21 12:35:57 CST 2021], ã€dead letter-3ã€ receive message: [khighness]</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰è®¿é—®ï¼š<a href="http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=5000">http://localhost:7777/rabbitmq/send/time?msg=khighness&amp;time=5000</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">12</span>:<span class="number">36</span>:<span class="number">00.917</span>  INFO <span class="number">13876</span> --- [<span class="type">nio</span>-<span class="number">7777</span>-<span class="type">exec</span>-<span class="number">7</span>] top.parak.delay.MessageController        : now: [<span class="type">Tue</span> <span class="type">Sep</span> <span class="number">21</span> <span class="number">12</span>:<span class="number">36</span>:<span class="number">00</span> <span class="type">CST</span> <span class="number">2021</span>], receive message: [<span class="type">khighness</span>], time: [<span class="number">5000</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">12</span>:<span class="number">36</span>:<span class="number">05.921</span>  INFO <span class="number">13876</span> --- [<span class="type">ntContainer</span><span class="comment">#0-1] t.parak.delay.DeadLetterMessageReceiver  : now: [Tue Sep 21 12:36:05 CST 2021], ã€dead letter-3ã€ receive message: [khighness]</span></span><br></pre></td></tr></table></figure>



<h3 id="8-7-æ’ä»¶å®ç°"><a href="#8-7-æ’ä»¶å®ç°" class="headerlink" title="8.7 æ’ä»¶å®ç°"></a>8.7 æ’ä»¶å®ç°</h3><p>å¦‚æœä¸èƒ½å®ç°åœ¨æ¶ˆæ¯ç²’åº¦ä¸Šæ·»åŠ TTLï¼Œå¹¶ä½¿å…¶åœ¨è®¾ç½®çš„TTLæ—¶é—´å†…å³æ—¶å³æ—¶æ­»äº¡ï¼Œå°±æ— æ³•è®¾è®¡ä¸€ä¸ªé€šç”¨çš„å»¶æ—¶é˜Ÿåˆ—ã€‚</p>
<p>è¿™æ—¶ä½¿ç”¨RabbitMQçš„æ’ä»¶å³å¯è§£å†³ï¼š<a href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a> </p>
<p>å»¶æ—¶æ’ä»¶å®‰è£…</p>
<ol>
<li><p>ä¸‹è½½æ’ä»¶ï¼š<a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases</a></p>
</li>
<li><p>å¤åˆ¶åˆ°å®¹å™¨ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker cp rabbitmq_delayed_message_exchange-3.8.9-0199d11c.ez rabbitmq:/plugins</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¿€æ´»æ’ä»¶ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it rabbitmq bash</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_delayed_message_exchange</span></span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>æ‰“å¼€Webæ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°æœ‰æ–°çš„äº¤æ¢æœºç±»å‹ï¼š<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/x-delayed-message.png" class="" title="x-delayed-message"><br /></p>
<p>åœ¨<code>DelayQueueConfig</code>ä¸­åˆ›å»ºæ–°çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAYED_MESSAGE_EXCHANGE = <span class="string">&quot;parak.delay.queue.delayed.message.exchange&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAYED_MESSAGE_QUEUE = <span class="string">&quot;parak.delay.queue.delayed.message.queue&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAYED_MESSAGE_ROUTING_KEY = <span class="string">&quot;parak.delay.queue.delayed.message.key&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">         * å£°æ˜è‡ªå®šä¹‰äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="meta">@Bean(&quot;delayedMessageExchange&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CustomExchange <span class="title">delayedMessageExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; args = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    args.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CustomExchange(DELAYED_MESSAGE_EXCHANGE, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean(&quot;delayedMessageQueue&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Queue <span class="title">delayedMessageQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Queue(DELAYED_MESSAGE_QUEUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Binding <span class="title">delayedMessageBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;delayedMessageQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;delayedMessageExchange&quot;)</span> CustomExchange exchange)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(DELAYED_MESSAGE_ROUTING_KEY).noargs();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå»¶è¿Ÿé˜Ÿåˆ—çš„æ¶ˆæ¯æ¶ˆè´¹è€…<code>DelayedMessageReceiver</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayedMessageReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DelayQueueConfig.DELAYED_MESSAGE_QUEUE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveDeadLetter1</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;now: [&#123;&#125;], ã€delayed messageã€ receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> Date(), <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨<code>DelayMessageSender</code>ä¸­å°è£…æ–°çš„æ–¹æ³•ç”¨äºå‘å»¶æ—¶äº¤æ¢æœºä¸­å‘é€æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsgToDelayedExchange</span><span class="params">(String msg, <span class="keyword">long</span> delayTime)</span> </span>&#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(DelayQueueConfig.DELAYED_MESSAGE_EXCHANGE, DelayQueueConfig.DELAYED_MESSAGE_ROUTING_KEY, msg, m -&gt; &#123;</span><br><span class="line">        m.getMessageProperties().setExpiration(Long.toString(delayTime));</span><br><span class="line">        <span class="keyword">return</span> m;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>MessageController</code>ä¸­æ·»åŠ æ–°çš„æ¥å£ç”¨äºå‘é€å»¶æ—¶æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å‘é€å»¶æ—¶æ¶ˆæ¯ï¼ŒæŒ‰ç…§æ—¶é—´</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delayed?msg=khighness&amp;time=1000&quot;&gt;delay 3s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:7777/rabbitmq/send/delayed?msg=khighness&amp;time=5000&quot;&gt;delay 5s&lt;/a&gt;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/delayed&quot;)</span></span><br><span class="line"><span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sendMsgToDelayedExchange</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String message, <span class="meta">@RequestParam(&quot;time&quot;)</span> Long time)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;now: [&#123;&#125;], receive message: [&#123;&#125;], time: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> Date(), message, time);</span><br><span class="line">    delayMessageSender.sendMsgToDelayedExchange(message, time);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="8-8-ä¸€ä¸ªå°ç»“"><a href="#8-8-ä¸€ä¸ªå°ç»“" class="headerlink" title="8.8 ä¸€ä¸ªå°ç»“"></a>8.8 ä¸€ä¸ªå°ç»“</h3><p>å»¶æ—¶é˜Ÿåˆ—åœ¨éœ€è¦å»¶æ—¶å¤„ç†çš„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ï¼Œä½¿ç”¨RabbitMQæ¥å®ç°å»¶æ—¶é˜Ÿåˆ—å¯ä»¥å¾ˆå¥½çš„åˆ©ç”¨ã€RabbitMQçš„ç‰¹æ€§ï¼Œå¦‚ï¼šæ¶ˆæ¯å¯é æ€§å‘é€ã€æ¶ˆæ¯å¯é æ€§æŠ•é€’ä»¥åŠæ­»ä¿¡é˜Ÿåˆ—æ¥ä¿éšœæ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡ä»¥åŠæœªè¢«æ­£ç¡®å¤„ç†çš„æ¶ˆæ¯ä¸ä¼šè¢«ä¸¢å¼ƒã€‚</p>
<p>å½“ç„¶ï¼Œé‚£æ˜¯é˜Ÿåˆ—è¿˜æœ‰å¾ˆå¤šå…¶å®ƒé€‰æ‹©ï¼Œæ¯”å¦‚åˆ©ç”¨Javaçš„<code>DelayQueue</code>ï¼Œåˆ©ç”¨Redisçš„<code>ZSet</code>ï¼Œåˆ©ç”¨<code>Quartz</code>æˆ–è€…Kafkaçš„æ—¶é—´è½®ï¼Œè¿™äº›æ–¹å¼å„æœ‰ç‰¹ç‚¹ã€‚äº†è§£çš„è¶Šå¤šï¼Œé‡åˆ°é—®é¢˜ä¾¿èƒ½æ¸¸åˆƒæœ‰ä½™ã€‚</p>
<h2 id="9-RabbitMQå¯é æŠ•é€’"><a href="#9-RabbitMQå¯é æŠ•é€’" class="headerlink" title="9. RabbitMQå¯é æŠ•é€’"></a>9. RabbitMQå¯é æŠ•é€’</h2><h3 id="9-1-å¯é æŠ•é€’"><a href="#9-1-å¯é æŠ•é€’" class="headerlink" title="9.1 å¯é æŠ•é€’"></a>9.1 å¯é æŠ•é€’</h3><p>åœ¨RabbitMQä¸­ï¼Œä¸€ä¸ªæ¶ˆæ¯ä»ç”Ÿäº§è€…å‘é€åˆ°RabbitMQçš„æœåŠ¡å™¨ï¼Œéœ€è¦ç»å†ä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>ç”Ÿäº§è€…å‡†å¤‡å¥½éœ€è¦æŠ•é€’çš„æ¶ˆæ¯ï¼›</li>
<li>ç”Ÿäº§è€…ä¸RabbitMQæœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼›</li>
<li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼›</li>
<li>RabbitMQæœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¹¶å°†å…¶è·¯ç”±åˆ°æŒ‡å®šé˜Ÿåˆ—ï¼›</li>
<li>RabbitMQæœåŠ¡å™¨å‘èµ·å›è°ƒï¼Œå‘ŠçŸ¥ç”Ÿäº§è€…æ¶ˆæ¯å‘é€æˆåŠŸã€‚</li>
</ol>
<p>æ‰€è°“å¯é æŠ•é€’ï¼Œå°±æ˜¯ç¡®ä¿æ¶ˆæ¯èƒ½å¤Ÿä¿è¯ä»ç”Ÿäº§è€…å‘é€åˆ°æœåŠ¡å™¨ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/Confirm.svg" class="" title="Confirm">

<p>è¯´æ˜ï¼šå¦‚æœæ²¡æœ‰è®¾ç½®<code>Mandatory</code>ï¼Œæ˜¯ä¸éœ€è¦å…ˆè·¯ç”±æ¶ˆæ¯æ‰å‘èµ·å›è°ƒçš„ï¼ŒæœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯åå°±ä¼šè¿›è¡Œå›è°ƒç¡®è®¤ã€‚</p>
<p>2ã€3ã€5æ­¥éƒ½æ˜¯é€šè¿‡TCPè¿æ¥è¿›è¡ŒåŠå“¦å•Šèƒ¡ï¼Œæœ‰ç½‘ç»œè°ƒç”¨çš„åœ°æ–¹å°±ä¼šæœ‰äº‹æ•…ï¼Œç½‘ç»œæ³¢åŠ¨éšæ—¶éƒ½æœ‰å¯èƒ½å‘ç”Ÿï¼Œä¸ç®¡æ˜¯å†…éƒ¨æœºæˆ¿åœç”µï¼Œè¿˜æ˜¯å¤–éƒ¨å…‰ç¼†è¢«åˆ‡ï¼Œç½‘ç»œäº‹æ•…æ— æ³•é¢„æµ‹ï¼Œè™½ç„¶è¿™äº›éƒ½æ˜¯å°æ¦‚ç‡äº‹ä»¶ï¼Œä½†æ˜¯å¯¹äºæ•æ„Ÿæ•°æ®æ¥è¯´ï¼Œè¿™äº›æƒ…å†µä¸‹å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±éƒ½æ˜¯ä¸å¯æ¥å—çš„ã€‚</p>
<h3 id="9-2-å®ç°åŸç†"><a href="#9-2-å®ç°åŸç†" class="headerlink" title="9.2 å®ç°åŸç†"></a>9.2 å®ç°åŸç†</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘é€æ¶ˆæ¯çš„æ“ä½œæ˜¯ä¸ä¼šåæ‚”ä»»ä½•æ¶ˆæ¯ç»™ç”Ÿäº§è€…çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤æƒ…å†µä¸‹ç”Ÿäº§è€…æ˜¯ä¸çŸ¥é“æ¶ˆæ¯æœ‰æ²¡æœ‰æ­£ç¡®åœ°åˆ°è¾¾æœåŠ¡å™¨ã€‚</p>
<p>å¯¹æ­¤ï¼ŒRabbitMQä¸­æœ‰ä¸€äº›ç›¸å…³çš„è§£å†³æ–¹æ¡ˆï¼š</p>
<ol>
<li>ä½¿ç”¨äº‹åŠ¡æœºåˆ¶æ¥è®©ç”Ÿäº§è€…æ„ŸçŸ¥æ¶ˆæ¯è¢«æˆåŠŸæŠ•é€’åˆ°æœåŠ¡å™¨ï¼›</li>
<li>é€šè¿‡ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶å®ç°ã€‚</li>
</ol>
<p>åœ¨RabbitMQä¸­ï¼Œæ‰€æœ‰ç¡®ä¿æ¶ˆæ¯å¯é æŠ•é€’éƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šå½±å“ï¼Œå¦‚æœä½¿ç”¨ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¹ååé‡é€ æˆé‡å¤§å½±å“ï¼Œåªæœ‰é€šè¿‡æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œæ‰èƒ½åœ¨ç¡®å®šæ€§èƒ½ä¸å¯é æŠ•é€’ä¹‹é—´çš„å¹³è¡¡ã€‚</p>
<h3 id="9-3-äº‹åŠ¡æœºåˆ¶"><a href="#9-3-äº‹åŠ¡æœºåˆ¶" class="headerlink" title="9.3 äº‹åŠ¡æœºåˆ¶"></a>9.3 äº‹åŠ¡æœºåˆ¶</h3><p>RabbitMQæ˜¯æ”¯æŒäº‹åŠ¡æœºåˆ¶çš„ï¼Œåœ¨ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ä¹‹å‰ï¼Œäº‹åŠ¡æ˜¯ç¡®ä¿æ¶ˆæ¯è¢«æˆåŠŸæŠ•é€’çš„å”¯ä¸€åŠæ³•ã€‚</p>
<p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ã€‚</p>
<p>é¡¹ç›®é…ç½®<code>application.properties</code>ï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8888</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">springboot-reliable-transaction</span></span><br><span class="line"><span class="meta">spring.rabbitmq.host</span>=<span class="string">192.168.117.155</span></span><br><span class="line"><span class="meta">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="meta">spring.rabbitmq.virtual-host</span>=<span class="string">/learn</span></span><br><span class="line"><span class="meta">spring.rabbitmq.username</span>=<span class="string">parak</span></span><br><span class="line"><span class="meta">spring.rabbitmq.password</span>=<span class="string">KAG1823</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.type</span>=<span class="string">simple</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.default-requeue-rejected</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.acknowledge-mode</span>=<span class="string">manual</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºé…ç½®ç±»<code>RabbitMQConfig</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.transaction.RabbitTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_EXCHANGE = <span class="string">&quot;parak.reliable.transaction.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_QUEUE = <span class="string">&quot;parak.reliable.transaction.business.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_ROUTING_KEY = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å£°æ˜ä¸šåŠ¡äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;businessExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FanoutExchange <span class="title">businessExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FanoutExchange(BUSINESS_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">businessQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">businessBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> FanoutExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯ç”¨RabbitMQäº‹åŠ¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RabbitTransactionManager <span class="title">rabbitTransactionManager</span><span class="params">(CachingConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RabbitTransactionManager(connectionFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸šåŠ¡æ¶ˆæ¯æ¶ˆè´¹è€…<code>BusinessMessageReceiver</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessMessageReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.BUSINESS_QUEUE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€businessã€ receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸šåŠ¡æ¶ˆæ¯å‘é€è€…<code>BusinessMessageSender</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessMessageSender</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        rabbitTemplate.setChannelTransacted(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.BUSINESS_EXCHANGE, RabbitMQConfig.DEFAULT_ROUTING_KEY, msg);</span><br><span class="line">        log.info(<span class="string">&quot;message: [&#123;&#125;]&quot;</span>, msg);</span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span> || msg.equals(<span class="string">&quot;&quot;</span>) || msg.contains(<span class="string">&quot;exception&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;message sent successfully: [&#123;&#125;]&quot;</span>, msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ¥å£ç”¨äºç”Ÿäº§æ¶ˆæ¯<code>MessageController</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BusinessMessageSender businessMessageSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a hred=&quot;http://localhost:8888/rabbitmq/send/tx?msg=Khighness&quot;&gt;succeed&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a hred=&quot;http://localhost:8888/rabbitmq/send/tx?msg=Kexception&quot;&gt;exception&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/tx&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;msg&quot;)</span> String msg)</span> </span>&#123;</span><br><span class="line">        businessMessageSender.sendMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–å†™å¯åŠ¨ç±»å¹¶è¿è¡Œï¼Œè®¿é—®æµè§ˆå™¨è¿›è¡Œæµ‹è¯•ï¼š</p>
<p>ï¼ˆ1ï¼‰è®¿é—®ï¼š<a href="http://localhost:8888/rabbitmq/send/tx?msg=Khighness">http://localhost:8888/rabbitmq/send/tx?msg=Khighness</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">55.913</span>  INFO <span class="number">18096</span> --- [<span class="type">nio</span>-<span class="number">8888</span>-<span class="type">exec</span>-<span class="number">5</span>] t.p.transaction.BusinessMessageSender    : message: [<span class="type">Khighness</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">55.913</span>  INFO <span class="number">18096</span> --- [<span class="type">nio</span>-<span class="number">8888</span>-<span class="type">exec</span>-<span class="number">5</span>] t.p.transaction.BusinessMessageSender    : message sent successfully: [<span class="type">Khighness</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">55.915</span>  INFO <span class="number">18096</span> --- [<span class="type">ntContainer</span><span class="comment">#0-1] t.p.transaction.BusinessMessageReceiver  : ã€businessã€ receive message: [Khighness]</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰è®¿é—®ï¼š<a href="http://localhost:8888/rabbitmq/send/tx?msg=Kexception">http://localhost:8888/rabbitmq/send/tx?msg=Kexception</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">59.444</span>  INFO <span class="number">18096</span> --- [<span class="type">nio</span>-<span class="number">8888</span>-<span class="type">exec</span>-<span class="number">6</span>] t.p.transaction.BusinessMessageSender    : message: [<span class="type">Kexception</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">59.445</span> ERROR <span class="number">18096</span> --- [<span class="type">nio</span>-<span class="number">8888</span>-<span class="type">exec</span>-<span class="number">6</span>] o.a.c.c.C.[<span class="type">.</span>[<span class="type">.</span>[/]<span class="type">.</span>[<span class="type">dispatcherServlet</span>]    : <span class="type">Servlet.service</span>() <span class="type">for</span> <span class="type">servlet</span> [<span class="type">dispatcherServlet</span>] <span class="type">in</span> <span class="type">context</span> <span class="type">with</span> <span class="type">path</span> [] <span class="type">threw</span> <span class="type">exception</span> [<span class="type">Request</span> <span class="type">processing</span> <span class="type">failed</span>; <span class="type">nested</span> <span class="type">exception</span> <span class="type">is</span> <span class="type">java.lang.RuntimeException</span>: <span class="type">error</span>] <span class="type">with</span> <span class="type">root</span> <span class="type">cause</span></span><br><span class="line"></span><br><span class="line"><span class="type">java.lang.RuntimeException</span>: <span class="type">error</span></span><br></pre></td></tr></table></figure>

<p>ç¼–ç è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p>
<ol>
<li>åœ¨åˆå§‹åŒ–æ¶ˆæ¯å‘é€è€…çš„æ—¶å€™ï¼Œéœ€è¦åœ¨åˆå§‹åŒ–ä¸­ä½¿ç”¨<code>rabbitTemplate.setChannelTrsansacted(true)</code>æ¥å¼€å¯äº‹åŠ¡ï¼›</li>
<li>åœ¨å‘é€æ¶ˆæ¯çš„æ–¹æ³•ä¸ŠåŠ ä¸Š<code>@Transactional</code>æ³¨è§£ï¼Œè¿™æ ·åœ¨è¯¥æ–¹æ³•å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ¶ˆæ¯å°†ä¸ä¼šå‘é€ã€‚</li>
</ol>
<p>RabbitMQä¸­çš„äº‹åŠ¡ä½¿ç”¨èµ·æ¥è™½ç„¶ç®€å•ï¼Œä½†æ˜¯å¯¹æ€§èƒ½çš„å½¢è±¡æ˜¯ä¸å¯å¿½è§†çš„ï¼Œå› ä¸ºæ¯æ¬¡äº‹åŠ¡çš„æäº¤éƒ½æ˜¯é˜»å¡å¼çš„ç­‰å¾…æœåŠ¡å™¨è¿”å›ç»“æœï¼Œè€Œé»˜è®¤æ¨¡å¼ä¸‹ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸éœ€è¦ç­‰å¾…çš„ï¼Œç›´æ¥å‘é€å°±å®Œäº‹äº†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œäº‹åŠ¡æ¶ˆæ¯éœ€è¦æ¯”æ™®é€šæ¶ˆæ¯å¤š4æ¬¡ä¸æœåŠ¡å™¨çš„äº¤äº’ï¼Œè¿™å°±æ„å‘³ç€ä¼šå ç”¨ç€æ›´å¤šçš„å¤„ç†æ—¶é—´ï¼Œæ‰€ä»¥å¦‚æœå¯¹æ¶ˆæ¯å¤„ç†é€Ÿåº¦æœ‰è¾ƒé«˜è¦æ±‚æ—¶ï¼Œå°½é‡ä¸è¦é‡‡ç”¨äº‹åŠ¡æœºåˆ¶ã€‚</p>
<h3 id="9-4-ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶"><a href="#9-4-ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶" class="headerlink" title="9.4 ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶"></a>9.4 ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶</h3><p>RabbitMQä¸­çš„ç”Ÿäº§è€…ç¡®è®¤åŠŸèƒ½æ˜¯AMQPè§„èŒƒçš„å¢å¼ºåŠŸèƒ½ï¼Œå½“ç”Ÿäº§è€…å‘å¸ƒç»™æ‰€æœ‰é˜Ÿåˆ—çš„å·²è·¯ç”±æ¶ˆæ¯è¢«æ¶ˆè´¹è€…åº”ç”¨ç¨‹åºç›´æ¥æ¶ˆè´¹æ—¶ï¼Œæˆ–è€…æ¶ˆæ¯è¢«æ”¾å…¥é˜Ÿåˆ—å¹¶æ ¹æ®éœ€è¦è¿›è¡ŒæŒä¹…åŒ–æ—¶ï¼Œä¸€ä¸ªBasic Ackè¯·æ±‚ä¼šè¢«å‘é€åˆ°ç”Ÿäº§è€…ï¼Œå¦‚æœæ¶ˆæ¯æ— æ³•è·¯ç”±ï¼Œä»£ç†æœåŠ¡å™¨å°†å‘é€ä¸€ä¸ªBasic Nack RPCè¯·æ±‚ç”¨äºè¡¨ç¤ºå¤±è´¥ã€‚ç„¶åç”±ç”Ÿäº§è€…å†³å®šè¯¥å¦‚ä½•å¤„ç†è¯¥æ¶ˆæ¯ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œé€šè¿‡ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼Œç”Ÿäº§è€…å¯ä»¥åœ¨æ¶ˆæ¯è¢«ä»£ç†æœåŠ¡å™¨æˆåŠŸæ¥æ”¶æ—¶å¾—åˆ°åé¦ˆï¼Œå¹¶æœ‰æœºä¼šå¤„ç†æœªè¢«æˆåŠŸæ¥æ”¶çš„æ¶ˆæ¯ã€‚</p>
<p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ã€‚</p>
<p>é¡¹ç›®é…ç½®åœ¨ä¸Šè¿°é…ç½®ä¸Šéœ€è¦åŠ ä¸€è¡Œå¼€å¯ç”Ÿäº§è€…ç¡®è®¤ï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">spring.rabbitmq.publisher-confirms</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºé…ç½®ç±»<code>RabbitMQConfig</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.transaction.RabbitTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_EXCHANGE = <span class="string">&quot;parak.reliable.confirm.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_QUEUE = <span class="string">&quot;parak.reliable.confirm.business.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_KEY = <span class="string">&quot;parak.reliable.confirm.business.key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">businessExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(BUSINESS_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">businessQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">businessBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(BUSINESS_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ¶ˆæ¯å‘é€è€…<code>BusinessMessageSender</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessMessageSender</span> <span class="keyword">implements</span> <span class="title">RabbitTemplate</span>.<span class="title">ConfirmCallback</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        CorrelationData correlationData = <span class="keyword">new</span> CorrelationData(UUID.randomUUID().toString());</span><br><span class="line">        log.info(<span class="string">&quot;id: [&#123;&#125;], message: [&#123;&#125;]&quot;</span>, correlationData.getId(), msg);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ¶ˆæ¯IDï¼Œç”¨äºå›è°ƒæ—¶çš„åˆ¤æ–­</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.BUSINESS_EXCHANGE, RabbitMQConfig.DEFAULT_ROUTING_KEY, msg, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> b, String s)</span> </span>&#123;</span><br><span class="line">        String id = correlationData != <span class="keyword">null</span> ? correlationData.getId() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (b) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm succeed, id: [&#123;&#125;]&quot;</span>, id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm failed, id: [&#123;&#125;], cause: [&#123;&#125;]&quot;</span>, id, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦ä¸ºæ¶ˆæ¯è®¾ç½®æ¶ˆæ¯IDï¼Œä»¥ä¾¿åœ¨å›è°ƒæ—¶é€šè¿‡è¯¥IDæ¥åˆ¤æ–­æ˜¯å¯¹å“ªä¸ªæ¶ˆæ¯çš„å›è°ƒï¼Œå› ä¸ºåœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•ç›´æ¥è·å–åˆ°æ¶ˆæ¯å†…å®¹çš„ï¼Œæ‰€ä»¥éœ€è¦å°†æ¶ˆæ¯å…ˆæš‚å­˜èµ·æ¥ï¼Œæ ¹æ®æ¶ˆæ¯çš„é‡è¦ç¨‹åº¦ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œæˆ–è€…å­˜å…¥Redisä¸­ï¼Œæˆ–è€…MySQLä¸­ï¼Œç„¶ååœ¨å›è°ƒæ—¶æ›´æ–°å…¶çŠ¶æ€æˆ–è€…ä»ç¼“å­˜ä¸­ç§»é™¤ï¼Œæœ€åä½¿ç”¨å®šæ—¶ä»»åŠ¡å¯¹ä¸€æ®µæ—¶é—´å†…æœªå‘é€çš„æ¶ˆæ¯è¿›è¡Œé‡æ–°æŠ•é€’ã€‚</p>
<h3 id="9-6-å¯é æŠ•é€’åˆ°é˜Ÿåˆ—"><a href="#9-6-å¯é æŠ•é€’åˆ°é˜Ÿåˆ—" class="headerlink" title="9.6 å¯é æŠ•é€’åˆ°é˜Ÿåˆ—"></a>9.6 å¯é æŠ•é€’åˆ°é˜Ÿåˆ—</h3><p>ä¸Šé¢ä½¿ç”¨äº†ä¸¤ç§æ–¹å¼å®ç°äº†æ¶ˆæ¯è¢«å¯é åœ°æŠ•é€’åˆ°RabbitMQçš„äº¤æ¢æœºä¸­ï¼Œä½†æ˜¯å¦‚æœå¦‚æœBrokeræ— æ³•å°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—ï¼Œè¿˜æ˜¯ä¼šè¢«ä¸¢å¼ƒã€‚</p>
<p>RabbitMQæœ‰ä¸¤ä¸ªæœºåˆ¶å¯ä»¥å®ç°å¯é æŠ•é€’åˆ°é˜Ÿåˆ—ï¼š</p>
<ol>
<li>mandatoryå‚æ•°ï¼šå°†ä¸å¯è·¯ç”±æ¶ˆæ¯é€€å›ç»™ç”Ÿäº§è€…ï¼›</li>
<li>å¤‡ä»½äº¤æ¢æœºï¼šå°†ä¸å¯è·¯ç”±æ¶ˆæ¯è½¬å‘ç»™å¤‡ä»½äº¤æ¢æœºã€‚</li>
</ol>
<p>ç¬¬ä¸€ç§æ–¹å¼åªéœ€è¦åœ¨åˆå§‹åŒ–<code>rabbitTemplate</code>çš„æ—¶å€™æ·»åŠ ä¸€è¡Œä»£ç å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">rabbitTemplate.setMandatory(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<p>å…ˆæ¼”ç¤ºæ¶ˆæ¯ä¸¢å¼ƒæƒ…å†µï¼Œåˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ã€‚</p>
<p>é¡¹ç›®é…ç½®<code>application.properties</code>ï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">11111</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">springboot-reliable-queue</span></span><br><span class="line"><span class="meta">spring.rabbitmq.host</span>=<span class="string">192.168.117.155</span></span><br><span class="line"><span class="meta">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="meta">spring.rabbitmq.virtual-host</span>=<span class="string">/learn</span></span><br><span class="line"><span class="meta">spring.rabbitmq.username</span>=<span class="string">parak</span></span><br><span class="line"><span class="meta">spring.rabbitmq.password</span>=<span class="string">KAG1823</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.type</span>=<span class="string">simple</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.default-requeue-rejected</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">spring.rabbitmq.listener.simple.acknowledge-mode</span>=<span class="string">manual</span></span><br><span class="line"><span class="meta">spring.rabbitmq.publisher-confirms</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºé…ç½®ç±»<code>RabbitMQConfig</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_EXCHANGE = <span class="string">&quot;parak.reliable.queue.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_QUEUE = <span class="string">&quot;parak.reliable.queue.business.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_KEY = <span class="string">&quot;key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å£°æ˜ä¸šåŠ¡äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;businessExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">businessExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(BUSINESS_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">businessQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">businessBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(BUSINESS_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ¶ˆæ¯æ¶ˆè´¹è€…<code>BusinessMessageReceiver</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessMessageReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.BUSINESS_QUEUE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€businessã€ receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ¶ˆæ¯å‘é€è€…<code>BusinessMessageSender</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessMessageSender</span> <span class="keyword">implements</span> <span class="title">RabbitTemplate</span>.<span class="title">ConfirmCallback</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">this</span>);</span><br><span class="line">        rabbitTemplate.setMandatory(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String routingKey, String message)</span> </span>&#123;</span><br><span class="line">        CorrelationData correlationData = <span class="keyword">new</span> CorrelationData(UUID.randomUUID().toString());</span><br><span class="line">        log.info(<span class="string">&quot;id: [&#123;&#125;], message: [&#123;&#125;]&quot;</span>, correlationData.getId(), message);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ¶ˆæ¯IDï¼Œç”¨äºå›è°ƒæ—¶çš„åˆ¤æ–­</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.BUSINESS_EXCHANGE, routingKey, message, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> b, String s)</span> </span>&#123;</span><br><span class="line">        String id = correlationData != <span class="keyword">null</span> ? correlationData.getId() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (b) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm succeed, id: [&#123;&#125;]&quot;</span>, id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm failed, id: [&#123;&#125;], cause: [&#123;&#125;]&quot;</span>, id, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ¥å£å‘é€æ¶ˆæ¯<code>MessageController</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BusinessMessageSender businessMessageSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a hred=&quot;http://localhost:11111/rabbitmq/send/confirm?msg=Khighness&quot;&gt;succeed&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a hred=&quot;http://localhost:11111/rabbitmq/send/confirm?msg=Kexception&quot;&gt;exception&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/confirm&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;key&quot;)</span> String routingKey, <span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> </span>&#123;</span><br><span class="line">        businessMessageSender.sendMsg(routingKey, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–å†™å¯åŠ¨ç±»å¹¶è¿è¡Œï¼Œè®¿é—®æµè§ˆé‡è¿›è¡Œæµ‹è¯•ï¼š</p>
<p>ï¼ˆ1ï¼‰è®¿é—®ï¼š<a href="http://localhost:11111/rabbitmq/send/queue?key=key&amp;msg=Khighness">http://localhost:11111/rabbitmq/send/queue?key=key&amp;msg=Khighness</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">33.392</span>  INFO <span class="number">21368</span> --- [<span class="type">io</span>-<span class="number">11111</span>-<span class="type">exec</span>-<span class="number">5</span>] top.parak.queue.BusinessMessageSender    : id: [<span class="number">81</span><span class="type">ff86f3</span>-<span class="number">0000</span>-<span class="number">4</span><span class="type">edb</span>-<span class="type">b6a5</span>-<span class="number">92494</span><span class="type">f27be3c</span>], message: [<span class="type">Khighness</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">33.394</span>  INFO <span class="number">21368</span> --- [<span class="type">ntContainer</span><span class="comment">#0-1] top.parak.queue.BusinessMessageReceiver  : ã€businessã€ receive message: [Khighness]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">33.394</span>  <span class="type">INFO</span> <span class="number">21368</span> --- [<span class="type">nectionFactory2</span>] <span class="type">top.parak.queue.BusinessMessageSender</span>    : <span class="type">message</span> <span class="type">confirm</span> <span class="type">succeed</span>, <span class="type">id</span>: [<span class="number">81</span><span class="type">ff86f3</span>-<span class="number">0000</span>-<span class="number">4</span><span class="type">edb</span>-<span class="type">b6a5</span>-<span class="number">92494</span><span class="type">f27be3c</span>]</span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰è®¿é—®ï¼š<a href="http://localhost:11111/rabbitmq/send/queue?key=kkk&amp;msg=FlowerK">http://localhost:11111/rabbitmq/send/queue?key=kkk&amp;msg=FlowerK</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">34.867</span>  INFO <span class="number">21368</span> --- [<span class="type">io</span>-<span class="number">11111</span>-<span class="type">exec</span>-<span class="number">9</span>] top.parak.queue.BusinessMessageSender    : id: [<span class="number">373</span><span class="type">c027e</span>-<span class="number">8</span><span class="type">e8e</span>-<span class="number">4</span><span class="type">f2a</span>-<span class="type">b59c</span>-<span class="number">53</span><span class="type">a8b7553767</span>], message: [<span class="type">FlowerK</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">34.868</span>  INFO <span class="number">21368</span> --- [<span class="type">nectionFactory1</span>] top.parak.queue.BusinessMessageSender    : message confirm succeed, id: [<span class="number">373</span><span class="type">c027e</span>-<span class="number">8</span><span class="type">e8e</span>-<span class="number">4</span><span class="type">f2a</span>-<span class="type">b59c</span>-<span class="number">53</span><span class="type">a8b7553767</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">22</span>:<span class="number">58</span>:<span class="number">34.868</span>  WARN <span class="number">21368</span> --- [<span class="type">nectionFactory2</span>] o.s.amqp.rabbit.core.RabbitTemplate      : Returned message but no callback available</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªæ¶ˆæ¯å‘é€åçš„æç¤º<code>Returned message but no callback available</code>ã€‚</p>
<p>è®¾ç½®<code>mandatory</code>å‚æ•°åï¼Œå¦‚æœæ¶ˆæ¯æ— æ³•è¢«è·¯ç”±ï¼Œåˆ™ä¼šè¿”å›ç»™ç”Ÿäº§è€…ï¼Œæ˜¯é€šè¿‡å›è°ƒçš„æ–¹å¼è¿›è¡Œçš„ï¼Œæ‰€ä»¥ï¼Œç”Ÿäº§è€…éœ€è¦è®¾ç½®ç›¸åº”çš„å›è°ƒå‡½æ•°æ‰èƒ½æ¥å—æ¶ˆæ¯ã€‚</p>
<p>ä¸ºäº†è¿›è¡Œå›è°ƒï¼Œæ¶ˆæ¯å‘é€è€…éœ€è¦å®ç°å›è°ƒæ¥å£<code>RabbitTemplate.ReturnCallback</code>ï¼Œå®ç°<code>returnedMessage</code>æ–¹æ³•ï¼ŒåŒæ—¶åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®å›è°ƒæ¥å£ä¸ºè‡ªå·±ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    rabbitTemplate.setConfirmCallback(<span class="keyword">this</span>);</span><br><span class="line">    rabbitTemplate.setMandatory(<span class="keyword">true</span>);</span><br><span class="line">    rabbitTemplate.setReturnCallback(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnedMessage</span><span class="params">(Message message, <span class="keyword">int</span> relayCode, String replyText, String exchange, String routingKey)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;message is returned. msg: [&#123;&#125;], replayCode: [&#123;&#125;], replyText: [&#123;&#125;]exchange: [&#123;&#125;], routingKey: [&#123;&#125;]&quot;</span>,</span><br><span class="line">             <span class="keyword">new</span> String(message.getBody()), relayCode, replyText, exchange, routingKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡æ–°è¿è¡Œå¯åŠ¨ç±»ï¼Œè®¿é—®æµè§ˆå™¨åæ—¥å¿—å¦‚ä¸‹ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">23</span>:<span class="number">17</span>:<span class="number">55.245</span>  INFO <span class="number">24700</span> --- [<span class="type">io</span>-<span class="number">11111</span>-<span class="type">exec</span>-<span class="number">1</span>] top.parak.queue.BusinessMessageSender    : id: [<span class="type">ad8a28ed</span>-<span class="type">b21c</span>-<span class="number">497</span><span class="type">d</span>-<span class="number">87</span><span class="type">c4</span>-<span class="type">ff3c447204db</span>], message: [<span class="type">FlowerK</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">23</span>:<span class="number">17</span>:<span class="number">55.253</span>  INFO <span class="number">24700</span> --- [<span class="type">nectionFactory1</span>] top.parak.queue.BusinessMessageSender    : message is returned. msg: [<span class="type">FlowerK</span>], replayCode: [<span class="number">312</span>], replyText: [<span class="type">NO_ROUTE</span>], exchange: [<span class="type">parak.reliable.queue.business.exchange</span>], routingKey: [<span class="type">kkk</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-21</span> <span class="number">23</span>:<span class="number">17</span>:<span class="number">55.254</span>  INFO <span class="number">24700</span> --- [<span class="type">nectionFactory1</span>] top.parak.queue.BusinessMessageSender    : message confirm succeed, id: [<span class="type">ad8a28ed</span>-<span class="type">b21c</span>-<span class="number">497</span><span class="type">d</span>-<span class="number">87</span><span class="type">c4</span>-<span class="type">ff3c447204db</span>]</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ¥æ”¶åˆ°äº†è¢«é€€å›çš„æ¶ˆæ¯ï¼Œå¹¶å¸¦ä¸Šäº†åŸå› ã€‚ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>mandatory</code>å‚æ•°ä»…ä»…æ˜¯åœ¨å½“æ¶ˆæ¯æ— æ³•åŒ—è·¯ç”±çš„æ—¶å€™ï¼Œè®©æ¶ˆæ¯ç”Ÿäº§è€…æ„ŸçŸ¥åˆ°è¿™ä¸€ç‚¹ï¼Œåªè¦å¼€å¯äº†ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼Œæ— è®ºè®¾ç½®äº†<code>mandatory</code>å‚æ•°ï¼Œéƒ½ä¼šåœ¨äº¤æ¢æœºæ¥æ”¶åˆ°æ¶ˆæ¯æ—¶è¿›è¡Œæ¶ˆæ¯ç¡®è®¤å›è°ƒï¼Œè€Œä¸”é€šå¸¸æ¶ˆæ¯çš„é€€å›ä¼šåœ¨æ¶ˆæ¯çš„ç¡®è®¤å›è°ƒä¹‹å‰ã€‚</p>
<p>é€šè¿‡<code>mandatory</code>å‚æ•°æˆ‘ä»¬è·å¾—äº†å¯¹æ— æ³•æŠ•é€’æ¶ˆæ¯çš„æ„ŸçŸ¥èƒ½åŠ›ï¼Œæœ‰æœºä¼šåœ¨ç”Ÿäº§è€…çš„æ¶ˆæ¯æ— æ³•è¢«æŠ•é€’æ—¶å‘ç°å¹¶å¤„ç†ã€‚ä½†æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“è¯¥å¦‚ä½•å¤„ç†è¿™äº›æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ï¼Œæœ€å¤šæ‰“å°ä¸ªæ—¥å¿—ï¼Œç„¶åè§¦å‘æŠ¥è­¦ï¼Œå†æ¥æ‰‹åŠ¨å¤„ç†ã€‚è€Œé€šè¿‡æ—¥å¿—æ¥å¤„ç†è¿™äº›æ— æ³•è·¯ç”±çš„æ¶ˆæ¯æ˜¯å¾ˆä¸ä¼˜é›…çš„åšæ³•ï¼Œç‰¹åˆ«æ˜¯å½“ç”Ÿäº§è€…æ‰€åœ¨çš„æœåŠ¡å™¨æœ‰å¤šå°æœºå™¨çš„æ—¶å€™ï¼Œæ‰‹åŠ¨å¤åˆ¶ä¼šæ›´åŠ éº»çƒ¦è€Œä¸”å®¹æ˜“å‡ºé”™ã€‚</p>
<p>è€Œä¸”è®¾ç½®<code>mandatory</code>å‚æ•°ä¼šå¢åŠ ç”Ÿäº§è€…çš„å¤æ‚æ€§ï¼Œéœ€è¦æ·»åŠ å¤„ç†è¿™äº›è¢«é€€å›çš„æ¶ˆæ¯çš„é€»è¾‘ã€‚å¦‚æœæ—¢ä¸æƒ³ä¸¢å¤±æ¶ˆæ¯ï¼Œåˆä¸æƒ³å¢åŠ ç”Ÿäº§è€…çš„å¤æ‚æ€§ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p>
<p>RabbitMQæœ‰ä¸€ç§å¤‡ä»½äº¤æ¢æœºçš„æœºåˆ¶å­˜åœ¨ï¼Œå¯ä»¥å¾ˆå¥½çš„åº”å¯¹è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>å¤‡ä»½äº¤æ¢æœºå¯ä»¥ç†è§£ä¸ºRabbitMQä¸­çš„äº¤æ¢æœºçš„å¤‡èƒï¼Œå½“æˆ‘ä»¬ä¸ºæŸä¸€ä¸ªäº¤æ¢æœºå£°æ˜ä¸€ä¸ªå¯¹åº”çš„å¤‡ä»½äº¤æ¢æœºæ—¶ï¼Œå°±æ˜¯ä¸ºå®ƒåˆ›å»ºä¸€ä¸ªå¤‡èƒï¼Œå½“äº¤æ¢æœºæ¥æ”¶åˆ°ä¸€æ¡ä¸å¯è·¯ç”±æ¶ˆæ¯æ—¶ï¼Œå°†ä¼šå°†è¿™æ¡æ¶ˆæ¯è½¬å‘åˆ°å¤‡ä»½äº¤æ¢æœºä¸­ï¼Œç”±å¤‡ä»½äº¤æ¢æœºæ¥è¿›è¡Œé’»å‘å’Œå¤„ç†ï¼Œé€šå¸¸å¤‡ä»½äº¤æ¢æœºçš„ç±»å‹ä¸º<code>Fanout</code>ï¼Œè¿™æ ·å°±èƒ½æŠŠæ‰€æœ‰æ¶ˆæ¯éƒ½æŠ•é€’åˆ°ä¸å…¶ç»‘å®šçš„é˜Ÿåˆ—ä¸­ï¼Œç„¶åæˆ‘ä»¬åœ¨å¤‡ä»½äº¤æ¢æœºä¸‹ç»‘å®šä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¿™æ ·æ‰€æœ‰é‚£äº›åŸäº¤æ¢æœºæ— æ³•è¢«è·¯ç”±çš„æ¶ˆæ¯ï¼Œå°±ä¼šè¿›å…¥è¿™ä¸ªé˜Ÿåˆ—äº†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å»ºç«‹ä¸€ä¸ªæŠ¥è­¦é˜Ÿåˆ—ï¼Œç”¨ç‹¬ç«‹çš„æ¶ˆè´¹è€…æ¥è¿›è¡Œç›‘æµ‹å’ŒæŠ¥è­¦ã€‚</p>
<p>è‰å›¾å¦‚ä¸‹ï¼š</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/33708/Copy.svg" class="" title="Copy"><br />

<p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">server.port=<span class="number">12222</span></span><br><span class="line">spring.application.name=springboot-exchange-backup</span><br><span class="line">spring.rabbitmq.host=<span class="number">192.168</span>.<span class="number">117.155</span></span><br><span class="line">spring.rabbitmq.port=<span class="number">5672</span></span><br><span class="line">spring.rabbitmq.virtual-host=/learn</span><br><span class="line">spring.rabbitmq.username=parak</span><br><span class="line">spring.rabbitmq.password=KAG1823</span><br><span class="line">spring.rabbitmq.listener.type=simple</span><br><span class="line">spring.rabbitmq.listener.simple.<span class="keyword">default</span>-requeue-rejected=<span class="keyword">false</span></span><br><span class="line">spring.rabbitmq.listener.simple.acknowledge-mode=manual</span><br><span class="line">spring.rabbitmq.publisher-confirms=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºé…ç½®ç±»<code>RabbitMQConfig</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_EXCHANGE = <span class="string">&quot;parak.exchange.backup.business.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_QUEUE = <span class="string">&quot;parak.exchange.backup.business.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_KEY = <span class="string">&quot;key&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_BACKUP_EXCHANGE = <span class="string">&quot;parak.exchange.backup.backup.exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_BACKUP_QUEUE = <span class="string">&quot;parak.exchange.backup.backup.queue&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BUSINESS_BACKUP_WARNING_QUEUE = <span class="string">&quot;parak.exchange.backup.backup.warning.queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å£°æ˜ä¸šåŠ¡äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;businessExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">businessExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ExchangeBuilder exchangeBuilder = ExchangeBuilder.directExchange(BUSINESS_EXCHANGE)</span><br><span class="line">                .durable(<span class="keyword">true</span>)</span><br><span class="line">                <span class="comment">// è®¾ç½®å¤‡ä»½äº¤æ¢æœº</span></span><br><span class="line">                .withArgument(<span class="string">&quot;alternate-exchange&quot;</span>, BUSINESS_BACKUP_EXCHANGE);</span><br><span class="line">        <span class="keyword">return</span> (DirectExchange) exchangeBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;businessQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">businessQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">businessBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;businessQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;businessExchange&quot;)</span> DirectExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(BUSINESS_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å£°æ˜å¤‡ä»½äº¤æ¢æœº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;backupExchange&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FanoutExchange <span class="title">backupExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ExchangeBuilder exchangeBuilder = ExchangeBuilder.fanoutExchange(BUSINESS_BACKUP_EXCHANGE)</span><br><span class="line">                .durable(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> exchangeBuilder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;backupQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">backupQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_BACKUP_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;warningQueue&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">warningQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(BUSINESS_BACKUP_WARNING_QUEUE).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">backupBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;backupQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;backupExchange&quot;)</span> FanoutExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">warningBinding</span><span class="params">(<span class="meta">@Qualifier(&quot;warningQueue&quot;)</span> Queue queue, <span class="meta">@Qualifier(&quot;backupExchange&quot;)</span> FanoutExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸šåŠ¡æ¶ˆæ¯æ¶ˆè´¹è€…<code>BusinessMessageReceiver</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessMessageReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.BUSINESS_QUEUE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;ã€businessã€ receive message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæŠ¥è­¦æ¶ˆæ¯æ¶ˆè´¹è€…<code>BusinessWarningMessageReceiver</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessWarningMessageReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.BUSINESS_BACKUP_WARNING_QUEUE)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.error(<span class="string">&quot;ã€warningã€ receive unroutable message: [&#123;&#125;]&quot;</span>, <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ¶ˆæ¯å‘é€è€…<code>BusinessMessageSender</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessMessageSender</span>/* <span class="keyword">implements</span> <span class="title">RabbitTemplate</span>.<span class="title">ConfirmCallback</span>, <span class="title">RabbitTemplate</span>.<span class="title">ReturnCallback</span> */ </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String routingKey, String message)</span> </span>&#123;</span><br><span class="line">        CorrelationData correlationData = <span class="keyword">new</span> CorrelationData(UUID.randomUUID().toString());</span><br><span class="line">        log.info(<span class="string">&quot;id: [&#123;&#125;], message: [&#123;&#125;]&quot;</span>, correlationData.getId(), message);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ¶ˆæ¯IDï¼Œç”¨äºå›è°ƒæ—¶çš„åˆ¤æ–­</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.BUSINESS_EXCHANGE, routingKey, message, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºæ¥å£ç”¨äºå‘é€æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/rabbitmq/send&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BusinessMessageSender businessMessageSender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:12222/rabbitmq/send/backup?key=key&amp;msg=Khighness&quot;&gt;succeed&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &lt;a href=&quot;http://localhost:12222/rabbitmq/send/backup?key=kkk&amp;msg=FlowerK&quot;&gt;fail&lt;/a&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/backup&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.OK)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sendMsg</span><span class="params">(<span class="meta">@RequestParam(&quot;key&quot;)</span> String routingKey, <span class="meta">@RequestParam(&quot;msg&quot;)</span> String message)</span> </span>&#123;</span><br><span class="line">        businessMessageSender.sendMsg(routingKey, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–å†™å¯åŠ¨ç±»å¹¶è¿è¡Œï¼Œè®¿é—®æµè§ˆå™¨è¿›è¡Œæµ‹è¯•ï¼š</p>
<p>ï¼ˆ1ï¼‰è®¿é—®ï¼š<a href="http://localhost:12222/rabbitmq/send/backup?key=key&amp;msg=Khighness">http://localhost:12222/rabbitmq/send/backup?key=key&amp;msg=Khighness</a></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-22</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">58.976</span>  INFO <span class="number">16192</span> --- [<span class="type">io</span>-<span class="number">12222</span>-<span class="type">exec</span>-<span class="number">1</span>] top.parak.backup.BusinessMessageSender   : id: [<span class="type">f8896978</span>-<span class="type">db6c</span>-<span class="number">47</span><span class="type">bb</span>-<span class="number">9</span><span class="type">af7</span>-<span class="number">0</span><span class="type">f0c15fb81f3</span>], message: [<span class="type">Khighness</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-22</span> <span class="number">11</span>:<span class="number">41</span>:<span class="number">58.988</span>  INFO <span class="number">16192</span> --- [<span class="type">ntContainer</span><span class="comment">#0-1] t.parak.backup.BusinessMessageReceiver   : ã€businessã€ receive message: [Khighness]</span></span><br></pre></td></tr></table></figure>

<p>ï¼ˆ2ï¼‰è®¿é—®ï¼š<a href="http://localhost:12222/rabbitmq/send/backup?key=kkk&amp;msg=FlowerK">http://localhost:12222/rabbitmq/send/backup?key=kkk&amp;msg=FlowerK</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2021-09-22 11:42:02.200  INFO 16192 --- [io-12222-exec-3] top.parak.backup.BusinessMessageSender   : id: [c56b5191-7810-4936-8c34-ef88ac16ccd2], message: [FlowerK]</span><br><span class="line">2021-09-22 11:42:02.202 ERROR 16192 --- [ntContainer#1-1] t.p.b.BusinessWarningMessageReceiver     : ã€warningã€ receive unroutable message: [FlowerK]</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆï¼Œå¦‚æœ<code>mandatory</code>å‚æ•°ä¸å¤‡ä»½äº¤æ¢æœºä¸€èµ·ä½¿ç”¨ï¼Œæ¶ˆæ¯ä¼šè¢«é€€å›åˆ°ç”Ÿäº§è€…è¿˜æ˜¯è¢«è½¬å‘ç»™äº¤æ¢æœºå‘¢ï¼Ÿ</p>
<p>ä¿®æ”¹æ¶ˆæ¯å‘é€è€…<code>BusinessMessageSender</code>çš„ä»£ç ï¼Œæµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.backup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BusinessMessageSender</span> <span class="keyword">implements</span> <span class="title">RabbitTemplate</span>.<span class="title">ConfirmCallback</span>, <span class="title">RabbitTemplate</span>.<span class="title">ReturnCallback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">this</span>);</span><br><span class="line">        rabbitTemplate.setMandatory(<span class="keyword">true</span>);</span><br><span class="line">        rabbitTemplate.setReturnCallback(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String routingKey, String message)</span> </span>&#123;</span><br><span class="line">        CorrelationData correlationData = <span class="keyword">new</span> CorrelationData(UUID.randomUUID().toString());</span><br><span class="line">        log.info(<span class="string">&quot;id: [&#123;&#125;], message: [&#123;&#125;]&quot;</span>, correlationData.getId(), message);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ¶ˆæ¯IDï¼Œç”¨äºå›è°ƒæ—¶çš„åˆ¤æ–­</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.BUSINESS_EXCHANGE, routingKey, message, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> b, String s)</span> </span>&#123;</span><br><span class="line">        String id = correlationData != <span class="keyword">null</span> ? correlationData.getId() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (b) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm succeed, id: [&#123;&#125;]&quot;</span>, id);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;message confirm failed, id: [&#123;&#125;], cause: [&#123;&#125;]&quot;</span>, id, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnedMessage</span><span class="params">(Message message, <span class="keyword">int</span> relayCode, String replyText, String exchange, String routingKey)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;message is returned. msg: [&#123;&#125;], replayCode: [&#123;&#125;], replyText: [&#123;&#125;], exchange: [&#123;&#125;], routingKey: [&#123;&#125;]&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> String(message.getBody()), relayCode, replyText, exchange, routingKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡æ–°è¿è¡Œå¯åŠ¨ç±»ï¼Œé‡æ–°è®¿é—®æµè§ˆå™¨ï¼š</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-22</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">30.713</span>  INFO <span class="number">2688</span> --- [<span class="type">nectionFactory1</span>] top.parak.backup.BusinessMessageSender   : message confirm succeed, id: [<span class="type">ab911258</span>-<span class="number">3966</span>-<span class="number">4</span><span class="type">e3e</span>-<span class="number">9</span><span class="type">cfb</span>-<span class="number">0</span><span class="type">b920bc97807</span>]</span><br><span class="line"><span class="number">2021</span><span class="literal">-09</span><span class="literal">-22</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">30.715</span>  INFO <span class="number">2688</span> --- [<span class="type">ntContainer</span><span class="comment">#0-1] t.parak.backup.BusinessMessageReceiver   : ã€businessã€ receive message: [Khighness]</span></span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">37.117</span>  <span class="type">INFO</span> <span class="number">2688</span> --- [<span class="type">io</span>-<span class="number">12222</span>-<span class="type">exec</span>-<span class="number">2</span>] <span class="type">top.parak.backup.BusinessMessageSender</span>   : <span class="type">id</span>: [<span class="type">ebaa3643</span>-<span class="number">731</span><span class="type">d</span>-<span class="number">430</span><span class="type">d</span>-<span class="type">ac92</span>-<span class="number">73</span><span class="type">e39439a262</span>], <span class="type">message</span>: [<span class="type">FlowerK</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">37.120</span>  <span class="type">INFO</span> <span class="number">2688</span> --- [<span class="type">nectionFactory1</span>] <span class="type">top.parak.backup.BusinessMessageSender</span>   : <span class="type">message</span> <span class="type">confirm</span> <span class="type">succeed</span>, <span class="type">id</span>: [<span class="type">ebaa3643</span>-<span class="number">731</span><span class="type">d</span>-<span class="number">430</span><span class="type">d</span>-<span class="type">ac92</span>-<span class="number">73</span><span class="type">e39439a262</span>]</span><br><span class="line"><span class="number">2021</span>-<span class="number">09</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">54</span>:<span class="number">37.120</span> <span class="type">ERROR</span> <span class="number">2688</span> --- [<span class="type">ntContainer</span><span class="comment">#1-1] t.p.b.BusinessWarningMessageReceiver     : ã€warningã€ receive unroutable message: [FlowerK]</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸¤æ¡æ¶ˆæ¯éƒ½å¯ä»¥æ”¶åˆ°æˆåŠŸå›è°ƒï¼Œä½†æ˜¯ä¸å¯è·¯ç”±æ¶ˆæ¯ä¸ä¼šå›é€€ç»™ç”Ÿäº§è€…ï¼Œè€Œæ˜¯ç›´æ¥è½¬å‘åˆ°å¤‡ä»½äº¤æ¢æœºï¼Œå¯è§å¤‡ä»½äº¤æ¢æœºçš„å¤„ç†ä¼˜å…ˆçº§æ›´é«˜ã€‚</p>
<h3 id="9-5-ä¸€ä¸ªå°ç»“"><a href="#9-5-ä¸€ä¸ªå°ç»“" class="headerlink" title="9.5 ä¸€ä¸ªå°ç»“"></a>9.5 ä¸€ä¸ªå°ç»“</h3><p>äº‹åŠ¡æœºåˆ¶å’Œç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ä¿è¯æ¶ˆæ¯æˆåŠŸå‘é€åˆ°RabbitMQçš„Brokerï¼Œç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶è·Ÿäº‹åŠ¡æ˜¯ä¸èƒ½ä¸€èµ·å·¥ä½œçš„ï¼Œå®ƒæ˜¯äº‹åŠ¡çš„è½»é‡çº§æ›¿ä»£æ–¹æ¡ˆã€‚å› ä¸ºäº‹åŠ¡å’Œå‘å¸ƒè€…ç¡®è®¤æ¨¡å¼éƒ½æ˜¯éœ€è¦å…ˆè·ŸæœåŠ¡å™¨åå•†ï¼Œå¯¹ä¿¡é“å¯ç”¨çš„ä¸€ç§æ¨¡å¼ï¼Œä¸èƒ½å¯¹åŒä¸€ä¸ªä¿¡é“åŒæ—¶ä½¿ç”¨ä¸¤ç§æ¨¡å¼ã€‚åœ¨ç”Ÿäº§è€…ç¡®è®¤æ¨¡å¼ä¸­ï¼Œæ¶ˆæ¯çš„ç¡®è®¤å¯ä»¥æ˜¯å¼‚æ­¥å’Œæ‰¹é‡çš„ï¼Œæ‰€ä»¥ç›¸æ¯”ä½¿ç”¨äº‹åŠ¡ï¼Œæ€§èƒ½ä¼šæ›´å¥½ã€‚</p>
<p>æƒ³è¦ä¿è¯æ¶ˆæ¯æˆåŠŸè¢«exchangeè·¯ç”±åˆ°é˜Ÿåˆ—ï¼Œå¯ä»¥é‡‡ç”¨<code>mandatory</code>å‚æ•°å’Œå¤‡ä»½äº¤æ¢æœºä¸¤ç§æ–¹å¼ï¼Œä¸¤è€…å¯ä»¥åŒæ—¶å¯ç”¨ï¼Œå¤‡ä»½äº¤æ¢æœºçš„å¤„ç†ä¼˜å…ˆçº§ä¼šæ›´é«˜ã€‚</p>
]]></content>
      <categories>
        <category>MiddleWare</category>
      </categories>
      <tags>
        <tag>MQ</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis</title>
    <url>/posts/bae4ff13/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-ğŸ“©NoSQLæ¦‚è¿°"><a href="#1-ğŸ“©NoSQLæ¦‚è¿°" class="headerlink" title="1. ğŸ“©NoSQLæ¦‚è¿°"></a>1. ğŸ“©NoSQLæ¦‚è¿°</h2><h3 id="1-1-ğŸ“ƒç®€ä»‹"><a href="#1-1-ğŸ“ƒç®€ä»‹" class="headerlink" title="1.1 ğŸ“ƒç®€ä»‹"></a>1.1 ğŸ“ƒç®€ä»‹</h3><blockquote>
<p>âš¡ NoSQL</p>
</blockquote>
<p>NoSQL != éSQL </p>
<p>NoSQL == Not Only SQL</p>
<p>ä¸ä»…ä»…æ˜¯SQLï¼</p>
<p>æ³›æŒ‡éå…³ç³»å‹çš„æ•°æ®åº“ã€‚å…‹æœå¤§å¹¶å‘ã€‚</p>
<p>å¾ˆå¤šçš„æ•°æ®ç±»å‹ï¼Œç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ã€ç¤¾äº¤ç½‘ç»œå’Œåœ°ç†ä½ç½®ï¼Œè¿™äº›æ•°æ®ç±»å‹çš„å­˜å‚¨ä¸éœ€è¦ä¸€ä¸ªå›ºå®šçš„æ ¼å¼ï¼Œä¸éœ€è¦å¤šå…ƒçš„æ“ä½œå°±å¯ä»¥æ¨ªå‘æ‰©å±•ã€‚</p>
<a id="more"></a>



<h3 id="1-2-ğŸŒ€ç‰¹ç‚¹"><a href="#1-2-ğŸŒ€ç‰¹ç‚¹" class="headerlink" title="1.2 ğŸŒ€ç‰¹ç‚¹"></a>1.2 ğŸŒ€ç‰¹ç‚¹</h3><ul>
<li><p>æ–¹ä¾¿æ‰©å±•ï¼ˆæ•°æ®ä¹‹é—´æ²¡æœ‰å…³ç³»ï¼Œå¾ˆå¥½æ‰©å±•ï¼‰</p>
</li>
<li><p>å¤§æ•°æ®é‡é«˜æ€§èƒ½ï¼ˆç»†ç²’åº¦ç¼“å­˜ï¼Œæ€§èƒ½é«˜ï¼‰</p>
</li>
<li><p>æ•°æ®ç±»å‹å¤šæ ·ï¼ˆä¸éœ€è¦è®¾è®¡æ•°æ®åº“ï¼Œéšå–éšç”¨ï¼‰</p>
</li>
<li><p>RDBMSå’ŒNoSQLçš„åŒºåˆ«: </p>
<ul>
<li>RDBMS<ul>
<li>ç»“æ„åŒ–ç»„ç»‡</li>
<li>SQL</li>
<li>æ•°æ®å’Œå…³ç³»éƒ½å­˜åœ¨å•ç‹¬çš„è¡¨ä¸­</li>
<li>ä¸¥æ ¼çš„ä¸€è‡´æ€§</li>
<li>åŸºç¡€çš„äº‹åŠ¡</li>
<li>Â·Â·Â·</li>
</ul>
</li>
<li>NoSQL<ul>
<li>ä¸ä»…ä»…æ˜¯æ•°æ®</li>
<li>æ²¡æœ‰å›ºå®šçš„æŸ¥è¯¢è¯­è¨€</li>
<li>é”®å€¼å¯¹å­˜å‚¨ï¼Œåˆ—å­˜å‚¨ï¼Œæ–‡æ¡£å­˜å‚¨ï¼Œå›¾å½¢å­˜å‚¨</li>
<li>æœ€ç»ˆä¸€è‡´æ€§</li>
<li>CAPå’ŒBASE</li>
<li>ä¸‰é«˜ï¼šé«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€é«˜å¯æ‰©å±•</li>
<li>Â·Â·Â·</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="1-3-ğŸš€3V-3H"><a href="#1-3-ğŸš€3V-3H" class="headerlink" title="1.3 ğŸš€3V+3H"></a>1.3 ğŸš€3V+3H</h3><ul>
<li>å¤§æ•°æ®æ—¶ä»£çš„3V<ul>
<li>æµ·é‡ Volume</li>
<li>å¤šæ · Variety</li>
<li>å®æ—¶ Velocity</li>
</ul>
</li>
<li>äº’è”ç½‘éœ€æ±‚çš„3H<ul>
<li>é«˜å¹¶å‘ High concurrency</li>
<li>é«˜å¯æ‹“ High scalable</li>
<li>é«˜æ€§èƒ½ High performance</li>
</ul>
</li>
</ul>
<h3 id="1-4-ğŸ“šåˆ†ç±»"><a href="#1-4-ğŸ“šåˆ†ç±»" class="headerlink" title="1.4 ğŸ“šåˆ†ç±»"></a>1.4 ğŸ“šåˆ†ç±»</h3><blockquote>
<p>ğŸ˜­å‘œå‘œå‘œï¼Œæˆ‘å¥½èœï¼Œæˆ‘å•¥éƒ½ä¸ä¼šğŸ¼</p>
</blockquote>
<table>
<thead>
<tr>
<th>åˆ†ç±»</th>
<th>ä¸¾ä¾‹</th>
<th>å…¸å‹åº”ç”¨åœºæ™¯</th>
<th>æ•°æ®æ¨¡å‹</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>é”®å€¼å¯¹</td>
<td>Tokyo Cabinet/Tyrantï¼ŒRedisï¼ŒVoldemortï¼ŒOracle BDB</td>
<td>å†…å®¹UANï¼Œä¸»è¦ç”¨äºå¤„ç†å¤§é‡æ•°æ®çš„é«˜è®¿é—®è´Ÿè½½ï¼Œä¹Ÿç”¨äºä¸€äº›æ—¥å¿—ç³»ç»Ÿç­‰ç­‰</td>
<td>KeyæŒ‡å‘valueçš„é”®å€¼å¯¹ï¼Œé€šå¸¸ç”¨hash tableæ¥å®ç°</td>
<td>æŸ¥æ‰¾é€Ÿåº¦å¿«</td>
<td>æ•°æ®æ— ç»“æ„åŒ–ï¼Œé€šå¸¸åªè¢«å½“åšå­—ç¬¦ä¸²æˆ–è€…äºŒè¿›åˆ¶æ•°æ®</td>
</tr>
<tr>
<td>åˆ—å­˜å‚¨æ•°æ®åº“</td>
<td>Cassandraï¼ŒHBaseï¼ŒRiak</td>
<td>åˆ†å¸ƒå¼çš„æ–‡ä»¶ç³»ç»Ÿ</td>
<td>ä»¥åˆ—ç°‡å¼å­˜å‚¨ï¼Œå°†åŒä¸€åˆ—æ•°æ®å­˜åœ¨ä¸€èµ·</td>
<td>æŸ¥æ‰¾é€Ÿåº¦å¿«ï¼Œå¯æ‰©å±•æ€§å¼ºï¼Œæ›´å®¹æ˜“è¿›è¡Œåˆ†å¸ƒå¼æ‰©å±•</td>
<td>åŠŸèƒ½ç›¸å¯¹å±€é™</td>
</tr>
<tr>
<td>æ–‡æ¡£å‹æ•°æ®åº“</td>
<td>CouchDBï¼ŒMongoDB</td>
<td>Webåº”ç”¨</td>
<td>Key-Valueå¯¹åº”çš„é”®å€¼å¯¹ï¼ŒValueä¸ºç»“æ„åŒ–æ•°æ®</td>
<td>æ•°æ®ç»“æ„è¦æ±‚ä¸ä¸¥æ ¼ï¼Œè¡¨ç»“æ„å¯å˜ï¼Œä¸éœ€è¦åƒå…³ç³»å‹æ•°æ®åº“ä¸€æ ·éœ€è¦é¢„å…ˆå®šä¹‰è¡¨ç»“æ„</td>
<td>æŸ¥è¯¢æ€§èƒ½ä¸é«˜ï¼Œè€Œä¸”ç¼ºä¹ç»Ÿä¸€çš„æŸ¥è¯¢è¯­è¨€</td>
</tr>
<tr>
<td>å›¾å½¢æ•°æ®åº“</td>
<td>Neo4Jï¼ŒInfoGridï¼ŒInfinite Graph</td>
<td>ç¤¾äº¤ç½‘ç»œã€æ¨èç³»ç»Ÿç­‰ç­‰ï¼Œä¸“æ³¨äºæ„å»ºå…³ç³»å›¾è°±</td>
<td>å›¾ç»“æ„</td>
<td>åˆ©ç”¨å›¾ç»“æ„ç›¸å…³ç®—æ³•ã€‚æ¯”å¦‚æœ€çŸ­è·¯å¾„å¯»å€ï¼ŒNåº¦å…³ç³»æŸ¥æ‰¾ç­‰</td>
<td>å¾ˆå¤šæ—¶å€™éœ€è¦å¯¹æ•´ä¸ªå›¾åšè®¡ç®—æ‰èƒ½å¾—å‡ºéœ€è¦çš„ä¿¡æ¯ï¼Œè€Œä¸”è¿™ç§ç»“æ„ä¸å¤ªå¥½åšåˆ†å¸ƒå¼çš„é›†ç¾¤æ–¹æ¡ˆ</td>
</tr>
</tbody></table>
<h3 id="1-5-ğŸ“ˆé˜¿é‡Œå·´æŠ€æœ¯æ¼”è¿›"><a href="#1-5-ğŸ“ˆé˜¿é‡Œå·´æŠ€æœ¯æ¼”è¿›" class="headerlink" title="1.5 ğŸ“ˆé˜¿é‡Œå·´æŠ€æœ¯æ¼”è¿›"></a>1.5 ğŸ“ˆé˜¿é‡Œå·´æŠ€æœ¯æ¼”è¿›</h3><blockquote>
<p>âœ¡æŠ€æœ¯å¹¶æ— é«˜ä½ä¹‹åˆ†ï¼Œå°±çœ‹ä½ å¦‚ä½•ä½¿ç”¨</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009144812661.png" class="" title="image-20201009144812661.png"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009145619674.png" class="" title="image-20201009145619674.png"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009153115683.png" class="" title="image-20201009153115683.png"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009153346176.png" class="" title="image-20201009153346176.png"><br />





<h2 id="2-ğŸ“©Rediså…¥é—¨"><a href="#2-ğŸ“©Rediså…¥é—¨" class="headerlink" title="2. ğŸ“©Rediså…¥é—¨"></a>2. ğŸ“©Rediså…¥é—¨</h2><blockquote>
<p> ğŸŒ official website</p>
</blockquote>
<ul>
<li><p>è‹±æ–‡å®˜ç½‘ï¼š<a href="https://www.redis.io/">redis</a></p>
</li>
<li><p>ä¸­æ–‡å®˜ç½‘ï¼š<del><a href="https://www.redis.cn/">redis</a></del></p>
</li>
<li><p>ä¸­æ–‡å®˜ç½‘ï¼š<a href="https://www.redis.net.cn/">redis</a></p>
</li>
</ul>
<h3 id="2-1-ğŸ“‘ç®€ä»‹"><a href="#2-1-ğŸ“‘ç®€ä»‹" class="headerlink" title="2.1 ğŸ“‘ç®€ä»‹"></a>2.1 ğŸ“‘ç®€ä»‹</h3><blockquote>
<p>ğŸ’¡ Redis = Remote Dictionary Server</p>
</blockquote>
<p>Redis æ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSDè®¸å¯ï¼‰çš„ï¼Œå†…å­˜ä¸­çš„æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒå¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ã€‚ å®ƒæ”¯æŒå¤šç§ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå¦‚ <a href="http://redis.cn/topics/data-types-intro.html#strings">å­—ç¬¦ä¸²ï¼ˆstringsï¼‰</a>ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#hashes">æ•£åˆ—ï¼ˆhashesï¼‰</a>ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#lists">åˆ—è¡¨ï¼ˆlistsï¼‰</a>ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#sets">é›†åˆï¼ˆsetsï¼‰</a>ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#sorted-sets">æœ‰åºé›†åˆï¼ˆsorted setsï¼‰</a> ä¸èŒƒå›´æŸ¥è¯¢ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#bitmaps">bitmaps</a>ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#hyperloglogs">hyperloglogs</a> å’Œ <a href="http://redis.cn/commands/geoadd.html">åœ°ç†ç©ºé—´ï¼ˆgeospatialï¼‰</a> ç´¢å¼•åŠå¾„æŸ¥è¯¢ã€‚ Redis å†…ç½®äº† <a href="http://redis.cn/topics/replication.html">å¤åˆ¶ï¼ˆreplicationï¼‰</a>ï¼Œ<a href="http://redis.cn/commands/eval.html">LUAè„šæœ¬ï¼ˆLua scriptingï¼‰</a>ï¼Œ <a href="http://redis.cn/topics/lru-cache.html">LRUé©±åŠ¨äº‹ä»¶ï¼ˆLRU evictionï¼‰</a>ï¼Œ<a href="http://redis.cn/topics/transactions.html">äº‹åŠ¡ï¼ˆtransactionsï¼‰</a> å’Œä¸åŒçº§åˆ«çš„ <a href="http://redis.cn/topics/persistence.html">ç£ç›˜æŒä¹…åŒ–ï¼ˆpersistenceï¼‰</a>ï¼Œ å¹¶é€šè¿‡ <a href="http://redis.cn/topics/sentinel.html">Rediså“¨å…µï¼ˆSentinelï¼‰</a>å’Œè‡ªåŠ¨ <a href="http://redis.cn/topics/cluster-tutorial.html">åˆ†åŒºï¼ˆClusterï¼‰</a>æä¾›é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰^(æ¥è‡ªå®˜æ–¹æ–‡æ¡£)^ã€‚</p>
<h3 id="2-2-ğŸŒ ç‰¹æ€§"><a href="#2-2-ğŸŒ ç‰¹æ€§" class="headerlink" title="2.2 ğŸŒ ç‰¹æ€§"></a>2.2 ğŸŒ ç‰¹æ€§</h3><ul>
<li><input checked="" disabled="" type="checkbox"> æ€§èƒ½ä¼˜ç§€ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œæ”¯æŒ10wå¹¶å‘QPS</li>
<li><input checked="" disabled="" type="checkbox"> å•è¿›ç¨‹å•çº¿ç¨‹ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé‡‡ç”¨IOå¤šè·¯å¤ç”¨æœºåˆ¶</li>
<li><input checked="" disabled="" type="checkbox"> ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼Œæ”¯æŒStringã€Hashã€Listã€Setã€Sorted Set</li>
<li><input checked="" disabled="" type="checkbox"> æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­æ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œé‡å¯æ—¶åŠ è½½</li>
<li><input checked="" disabled="" type="checkbox"> ä¸»ä»å¤åˆ¶ï¼Œå“¨å…µæ¨¡å¼ï¼Œé«˜å¯ç”¨</li>
<li><input checked="" disabled="" type="checkbox"> å¯ä»¥ç”¨ä½œåˆ†å¸ƒå¼é”</li>
<li><input checked="" disabled="" type="checkbox"> å¯ä»¥è¿›è¡Œåœ°å›¾ä¿¡æ¯åˆ†æ</li>
<li><input checked="" disabled="" type="checkbox"> å¯ä»¥ä½œä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ä½¿ç”¨ï¼Œæ”¯æŒå‘å¸ƒè®¢é˜…</li>
<li><input checked="" disabled="" type="checkbox"> å¯ä»¥ä½œä¸ºè®¡æ•°å™¨ä½¿ç”¨ï¼Œè®°å½•ç½‘é¡µæˆ–è€…å°ç¨‹åºç­‰çš„æµè§ˆé‡</li>
<li><input checked="" disabled="" type="checkbox"> Â·Â·Â·Â·Â·Â·</li>
</ul>
<h3 id="2-3-ğŸ”°æ‹“å±•"><a href="#2-3-ğŸ”°æ‹“å±•" class="headerlink" title="2.3 ğŸ”°æ‹“å±•"></a>2.3 ğŸ”°æ‹“å±•</h3><blockquote>
<p>Redis ğŸ†š Memcache</p>
</blockquote>
<ol>
<li>å­˜å‚¨æ–¹å¼ä¸Šï¼šmemcacheä¼šæŠŠæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ï¼Œæ–­ç”µåä¼šæŒ‚æ‰ï¼Œæ•°æ®ä¸èƒ½è¶…è¿‡å†…å­˜å¤§å°ã€‚redisæœ‰éƒ¨åˆ†æ•°æ®å­˜åœ¨ç¡¬ç›˜ä¸Šï¼Œè¿™æ ·èƒ½ä¿è¯æ•°æ®çš„æŒä¹…æ€§</li>
<li>æ•°æ®æ”¯æŒç±»å‹ä¸Šï¼šmemcacheå¯¹æ•°æ®ç±»å‹çš„æ”¯æŒç®€å•ï¼Œåªæ”¯æŒç®€å•çš„key-valueï¼Œè€Œredisæ”¯æŒäº”å¤§æ•°æ®ç±»å‹å’Œä¸‰å¤§ç‰¹æ®Šæ•°æ®ç±»å‹</li>
<li>åº•å±‚æ¨¡å‹ä¸Šï¼šå®ƒä»¬ä¹‹é—´åº•å±‚å®ç°æ–¹å¼ä»¥åŠä¸å®¢æˆ·ç«¯ä¹‹é—´çš„åº”ç”¨åè®®ä¸ä¸€æ ·ã€‚redisç›´æ¥æ„å»ºäº†VMæœºåˆ¶ï¼Œå› ä¸ºä¸€èˆ¬çš„ç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„è¯ï¼Œä¼šæµªè´¹ä¸€å®šçš„æ—¶é—´å»ç§»åŠ¨å’Œè¯·æ±‚</li>
<li>valueçš„å¤§å°ï¼šrediså¯ä»¥è¾¾åˆ°1GBï¼Œè€Œmemcacheåªæœ‰1MB</li>
</ol>
<h2 id="3-ğŸ“©Rediså®‰è£…"><a href="#3-ğŸ“©Rediså®‰è£…" class="headerlink" title="3. ğŸ“©Rediså®‰è£…"></a>3. ğŸ“©Rediså®‰è£…</h2><blockquote>
<p>âš ï¸ notice</p>
</blockquote>
<ul>
<li><p>Githubä¸Šredisçš„windowsç‰ˆæœ¬å·²ç»å¾ˆä¹…ä¸å†æ›´æ–°ï¼Œå¯¹äºæœ€æ–°çš„3.2.100ç‰ˆæœ¬ï¼Œä¸ªäººä½¿ç”¨è¿‡ï¼Œredis-cli.exeä½¿ç”¨èµ·æ¥å¶å°”ä¼šå‡ºé—®é¢˜ï¼Œå‘½ä»¤å†™å‡ºæ¥é‚£ä¸€è¡Œä¼šå˜æˆé»‘è‰²ï¼Œå…¼å®¹æ€§ä¸å¤ªå¥½ï¼Œç”±äº3.0ä¸æ”¯æŒGEOç­‰æ“ä½œï¼Œæˆ‘è¿˜æ˜¯é€‰æ‹©ä½¿ç”¨3.2.100ç‰ˆæœ¬ã€‚</p>
</li>
<li><p>Redisè¿™ç§é«˜æ€§èƒ½æœåŠ¡å™¨æœ¬èº«ä¸CentOSçš„ä½“è´¨å°±å¾ˆèˆ¬é…ï¼Œä¸ªäººæ¨èåœ¨Linuxä¸Šå®‰è£…ï¼Œå°¤å…¶æ˜¯åæœŸæ­å»ºredisé›†ç¾¤ç¯å¢ƒã€‚CentOS7æœ¬èº«è‡ªå¸¦çš„yumé•œåƒä¸­å¸¦çš„gccå®‰è£…åŒ…åªæœ‰4.8.5ç‰ˆæœ¬ï¼Œä¸æ”¯æŒé«˜ç‰ˆæœ¬redisçš„ç¼–è¯‘ï¼Œæ‰€ä»¥æ¨èä¸‹è½½5.0.8ç‰ˆæœ¬ã€‚</p>
</li>
<li><p>ä»¥ä¸Šï¼Œä¸ç®¡æ˜¯Windowsè¿˜æ˜¯Linuxï¼Œéƒ½æ¨èä½¿ç”¨Xshellå¼€å¯RedisæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ”½Xshell</p>
</blockquote>
<ul>
<li>ç½‘ç›˜é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1qWtPzJgF3N24yIlUfTtq9w">https://pan.baidu.com/s/1qWtPzJgF3N24yIlUfTtq9w</a></li>
<li>æå–ç ï¼škkkk</li>
</ul>
<h3 id="3-1-ğŸ’»Windows10-å®‰è£…"><a href="#3-1-ğŸ’»Windows10-å®‰è£…" class="headerlink" title="3.1 ğŸ’»Windows10 å®‰è£…"></a>3.1 ğŸ’»Windows10 å®‰è£…</h3><blockquote>
<p>ä¸‹è½½: <a href="https://github.com/MSOpenTech/redis/releases">redis</a></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008213905860.png" class="" title="image-20201008213905860"><br />

<blockquote>
<p>è§£å‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008214011620.png" class="" title="image-20201008214011620"><br />

<blockquote>
<p>å¯åŠ¨</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008214053586.png" class="" title="image-20201008214053586"><br />



<h3 id="3-2-ğŸ’»CentOS7-å®‰è£…"><a href="#3-2-ğŸ’»CentOS7-å®‰è£…" class="headerlink" title="3.2 ğŸ’»CentOS7 å®‰è£…"></a>3.2 ğŸ’»CentOS7 å®‰è£…</h3><blockquote>
<p>å®‰è£…gcc: <code>yum install gcc-c++ tcl</code></p>
<p>æ³¨æ„å®‰è£… version&gt;6 çš„rediséœ€è¦ version&gt;5 çš„gcc: </p>
<p><code>sudo yum install centos-release-scl</code><br><code>sudo yum install devtoolset-7-gcc*</code><br><code>scl enable devtoolset-7 bash</code></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008224757570.png" class="" title="image-20201008224757570"><br />

<blockquote>
<p>ä¸‹è½½å‹ç¼©åŒ…: <code>wget http://download.redis.io/releases/redis-5.0.8.tar.gz</code></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008223909191.png" class="" title="image-20201008223909191"><br />

<blockquote>
<p>è§£å‹å‹ç¼©åŒ…: <code>tar xzf redis-5.0.8.tar.gz</code></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008224102401.png" class="" title="image-20201008224102401"><br />

<blockquote>
<p>è·³è½¬ç›®å½•: <code>cd redis-5.0.8</code>    </p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008215145306.png" class="" title="image-20201008215145306"><br />

<blockquote>
<p>ç¼–è¯‘å®‰è£…: <code>make</code></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008215335902.png" class="" title="image-20201008215335902"><br />

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008224230979.png" class="" title="image-20201008224230979"><br />

<blockquote>
<p>å†æ¬¡ç¼–è¯‘: <code>make</code></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008224450296.png" class="" title="image-20201008224450296"><br />

<blockquote>
<p>æœ€åå®‰è£…: </p>
<p><code>cd src/</code></p>
<p><code>make install</code></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008230537427.png" class="" title="image-20201008230537427"><br />

<blockquote>
<p>æŸ¥çœ‹ç»“æœ: <code>ll /usr/local/bin/</code></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008230723447.png" class="" title="image-20201008230723447"><br />

<blockquote>
<p>æ›´æ”¹é…ç½®:</p>
<p>æ–°å»ºé…ç½®æ–‡ä»¶ç›®å½•: <code>mkdir kconfig</code>   </p>
<p>å°†åŸç”ŸRedisé…ç½®æ–‡ä»¶å¤åˆ¶è¿›æ¥: <code>cp /home/parak/Redis/redis-5.0.8/redis.conf </code></p>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶: <code>gedit redis.conf</code> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">daemonize yes</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>æµ‹è¯•å¯åŠ¨: <code>redis-server kconfig/redis.conf</code></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009105138976.png" class="" title="image-20201009105138976"><br />

<blockquote>
<p>æŸ¥çœ‹redisè¿›ç¨‹: <code>ps -ef | grep redis</code></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009105424943.png" class="" title="image-20201009105424943"><br />

<blockquote>
<p>å…³é—­redisæœåŠ¡: <code>shutdown</code></p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009105552015.png" class="" title="image-20201009105552015"><br />



<h2 id="4-ğŸ“©Redisé…ç½®"><a href="#4-ğŸ“©Redisé…ç½®" class="headerlink" title="4. ğŸ“©Redisé…ç½®"></a>4. ğŸ“©Redisé…ç½®</h2><h3 id="4-1-ğŸš©å‘½ä»¤"><a href="#4-1-ğŸš©å‘½ä»¤" class="headerlink" title="4.1 ğŸš©å‘½ä»¤"></a>4.1 ğŸš©å‘½ä»¤</h3><blockquote>
<p>ğŸ‘€æŸ¥çœ‹æ‰€æœ‰é…ç½®é¡¹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">config get *</span><br></pre></td></tr></table></figure>

<blockquote>
<p>âœå‘½ä»¤è¡Œç¼–è¾‘é…ç½®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">config set &lt;option&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-ğŸ“redis-conf-é…ç½®é¡¹è¯´æ˜"><a href="#4-2-ğŸ“redis-conf-é…ç½®é¡¹è¯´æ˜" class="headerlink" title="4.2 ğŸ“redis.conf é…ç½®é¡¹è¯´æ˜"></a>4.2 ğŸ“redis.conf é…ç½®é¡¹è¯´æ˜</h3><table>
<thead>
<tr>
<th align="left">åºå·</th>
<th align="left">é…ç½®é¡¹</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left"><code>daemonize no</code></td>
<td align="left">Redis é»˜è®¤ä¸æ˜¯ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥é€šè¿‡è¯¥é…ç½®é¡¹ä¿®æ”¹ï¼Œä½¿ç”¨ yes å¯ç”¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆWindows ä¸æ”¯æŒå®ˆæŠ¤çº¿ç¨‹çš„é…ç½®ä¸º no ï¼‰</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left"><code>pidfile /var/run/redis.pid</code></td>
<td align="left">å½“ Redis ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œæ—¶ï¼ŒRedis é»˜è®¤ä¼šæŠŠ pid å†™å…¥ /var/run/redis.pid æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ pidfile æŒ‡å®š</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left"><code>port 6379</code></td>
<td align="left">æŒ‡å®š Redis ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ç«¯å£ä¸º 6379</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left"><code>bind 127.0.0.1</code></td>
<td align="left">ç»‘å®šçš„ä¸»æœºåœ°å€</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left"><code>timeout 300</code></td>
<td align="left">å½“å®¢æˆ·ç«¯é—²ç½®å¤šé•¿ç§’åå…³é—­è¿æ¥ï¼Œå¦‚æœæŒ‡å®šä¸º 0 ï¼Œè¡¨ç¤ºå…³é—­è¯¥åŠŸèƒ½</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left"><code>loglevel notice</code></td>
<td align="left">æŒ‡å®šæ—¥å¿—è®°å½•çº§åˆ«ï¼ŒRedis æ€»å…±æ”¯æŒå››ä¸ªçº§åˆ«ï¼šdebugã€verboseã€noticeã€warningï¼Œé»˜è®¤ä¸º notice</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left"><code>logfile stdout</code></td>
<td align="left">æ—¥å¿—è®°å½•æ–¹å¼ï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å‡ºï¼Œå¦‚æœé…ç½® Redis ä¸ºå®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œï¼Œè€Œè¿™é‡Œåˆé…ç½®ä¸ºæ—¥å¿—è®°å½•æ–¹å¼ä¸ºæ ‡å‡†è¾“å‡ºï¼Œåˆ™æ—¥å¿—å°†ä¼šå‘é€ç»™ /dev/null</td>
</tr>
<tr>
<td align="left">8</td>
<td align="left"><code>databases 16</code></td>
<td align="left">è®¾ç½®æ•°æ®åº“çš„æ•°é‡ï¼Œé»˜è®¤æ•°æ®åº“ä¸º0ï¼Œå¯ä»¥ä½¿ç”¨SELECT å‘½ä»¤åœ¨è¿æ¥ä¸ŠæŒ‡å®šæ•°æ®åº“id</td>
</tr>
<tr>
<td align="left">9</td>
<td align="left"><code>save  </code>Redis é»˜è®¤é…ç½®æ–‡ä»¶ä¸­æä¾›äº†ä¸‰ä¸ªæ¡ä»¶ï¼š<strong>save 900 1</strong>ã€<strong>save 300 10</strong> ã€<strong>save 60 10000</strong>åˆ†åˆ«è¡¨ç¤º 900 ç§’ï¼ˆ15 åˆ†é’Ÿï¼‰å†…æœ‰ 1 ä¸ªæ›´æ”¹ï¼Œ300 ç§’ï¼ˆ5 åˆ†é’Ÿï¼‰å†…æœ‰ 10 ä¸ªæ›´æ”¹ä»¥åŠ 60 ç§’å†…æœ‰ 10000 ä¸ªæ›´æ”¹ã€‚</td>
<td align="left">æŒ‡å®šåœ¨å¤šé•¿æ—¶é—´å†…ï¼Œæœ‰å¤šå°‘æ¬¡æ›´æ–°æ“ä½œï¼Œå°±å°†æ•°æ®åŒæ­¥åˆ°æ•°æ®æ–‡ä»¶ï¼Œå¯ä»¥å¤šä¸ªæ¡ä»¶é…åˆ</td>
</tr>
<tr>
<td align="left">10</td>
<td align="left"><code>rdbcompression yes</code></td>
<td align="left">æŒ‡å®šå­˜å‚¨è‡³æœ¬åœ°æ•°æ®åº“æ—¶æ˜¯å¦å‹ç¼©æ•°æ®ï¼Œé»˜è®¤ä¸º yesï¼ŒRedis é‡‡ç”¨ LZF å‹ç¼©ï¼Œå¦‚æœä¸ºäº†èŠ‚çœ CPU æ—¶é—´ï¼Œå¯ä»¥å…³é—­è¯¥é€‰é¡¹ï¼Œä½†ä¼šå¯¼è‡´æ•°æ®åº“æ–‡ä»¶å˜çš„å·¨å¤§</td>
</tr>
<tr>
<td align="left">11</td>
<td align="left"><code>dbfilename dump.rdb</code></td>
<td align="left">æŒ‡å®šæœ¬åœ°æ•°æ®åº“æ–‡ä»¶åï¼Œé»˜è®¤å€¼ä¸º dump.rdb</td>
</tr>
<tr>
<td align="left">12</td>
<td align="left"><code>dir ./</code></td>
<td align="left">æŒ‡å®šæœ¬åœ°æ•°æ®åº“å­˜æ”¾ç›®å½•</td>
</tr>
<tr>
<td align="left">13</td>
<td align="left"><code>slaveof  </code></td>
<td align="left">è®¾ç½®å½“æœ¬æœºä¸º slave æœåŠ¡æ—¶ï¼Œè®¾ç½® master æœåŠ¡çš„ IP åœ°å€åŠç«¯å£ï¼Œåœ¨ Redis å¯åŠ¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä» master è¿›è¡Œæ•°æ®åŒæ­¥</td>
</tr>
<tr>
<td align="left">14</td>
<td align="left"><code>masterauth </code></td>
<td align="left">å½“ master æœåŠ¡è®¾ç½®äº†å¯†ç ä¿æŠ¤æ—¶ï¼Œslav æœåŠ¡è¿æ¥ master çš„å¯†ç </td>
</tr>
<tr>
<td align="left">15</td>
<td align="left"><code>requirepass foobared</code></td>
<td align="left">è®¾ç½® Redis è¿æ¥å¯†ç ï¼Œå¦‚æœé…ç½®äº†è¿æ¥å¯†ç ï¼Œå®¢æˆ·ç«¯åœ¨è¿æ¥ Redis æ—¶éœ€è¦é€šè¿‡ AUTH <password> å‘½ä»¤æä¾›å¯†ç ï¼Œé»˜è®¤å…³é—­</td>
</tr>
<tr>
<td align="left">16</td>
<td align="left"><code> maxclients 128</code></td>
<td align="left">è®¾ç½®åŒä¸€æ—¶é—´æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ï¼Œé»˜è®¤æ— é™åˆ¶ï¼ŒRedis å¯ä»¥åŒæ—¶æ‰“å¼€çš„å®¢æˆ·ç«¯è¿æ¥æ•°ä¸º Redis è¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ï¼Œå¦‚æœè®¾ç½® maxclients 0ï¼Œè¡¨ç¤ºä¸ä½œé™åˆ¶ã€‚å½“å®¢æˆ·ç«¯è¿æ¥æ•°åˆ°è¾¾é™åˆ¶æ—¶ï¼ŒRedis ä¼šå…³é—­æ–°çš„è¿æ¥å¹¶å‘å®¢æˆ·ç«¯è¿”å› max number of clients reached é”™è¯¯ä¿¡æ¯</td>
</tr>
<tr>
<td align="left">17</td>
<td align="left"><code>maxmemory </code></td>
<td align="left">æŒ‡å®š Redis æœ€å¤§å†…å­˜é™åˆ¶ï¼ŒRedis åœ¨å¯åŠ¨æ—¶ä¼šæŠŠæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¾¾åˆ°æœ€å¤§å†…å­˜åï¼ŒRedis ä¼šå…ˆå°è¯•æ¸…é™¤å·²åˆ°æœŸæˆ–å³å°†åˆ°æœŸçš„ Keyï¼Œå½“æ­¤æ–¹æ³•å¤„ç† åï¼Œä»ç„¶åˆ°è¾¾æœ€å¤§å†…å­˜è®¾ç½®ï¼Œå°†æ— æ³•å†è¿›è¡Œå†™å…¥æ“ä½œï¼Œä½†ä»ç„¶å¯ä»¥è¿›è¡Œè¯»å–æ“ä½œã€‚Redis æ–°çš„ vm æœºåˆ¶ï¼Œä¼šæŠŠ Key å­˜æ”¾å†…å­˜ï¼ŒValue ä¼šå­˜æ”¾åœ¨ swap åŒº</td>
</tr>
<tr>
<td align="left">18</td>
<td align="left"><code>appendonly no</code></td>
<td align="left">æŒ‡å®šæ˜¯å¦åœ¨æ¯æ¬¡æ›´æ–°æ“ä½œåè¿›è¡Œæ—¥å¿—è®°å½•ï¼ŒRedis åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯å¼‚æ­¥çš„æŠŠæ•°æ®å†™å…¥ç£ç›˜ï¼Œå¦‚æœä¸å¼€å¯ï¼Œå¯èƒ½ä¼šåœ¨æ–­ç”µæ—¶å¯¼è‡´ä¸€æ®µæ—¶é—´å†…çš„æ•°æ®ä¸¢å¤±ã€‚å› ä¸º redis æœ¬èº«åŒæ­¥æ•°æ®æ–‡ä»¶æ˜¯æŒ‰ä¸Šé¢ save æ¡ä»¶æ¥åŒæ­¥çš„ï¼Œæ‰€ä»¥æœ‰çš„æ•°æ®ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…åªå­˜åœ¨äºå†…å­˜ä¸­ã€‚é»˜è®¤ä¸º no</td>
</tr>
<tr>
<td align="left">19</td>
<td align="left"><code>appendfilename appendonly.aof</code></td>
<td align="left">æŒ‡å®šæ›´æ–°æ—¥å¿—æ–‡ä»¶åï¼Œé»˜è®¤ä¸º appendonly.aof</td>
</tr>
<tr>
<td align="left">20</td>
<td align="left"><code>appendfsync everysec</code></td>
<td align="left">æŒ‡å®šæ›´æ–°æ—¥å¿—æ¡ä»¶ï¼Œå…±æœ‰ 3 ä¸ªå¯é€‰å€¼ï¼š<strong>no</strong>ï¼šè¡¨ç¤ºç­‰æ“ä½œç³»ç»Ÿè¿›è¡Œæ•°æ®ç¼“å­˜åŒæ­¥åˆ°ç£ç›˜ï¼ˆå¿«ï¼‰<strong>always</strong>ï¼šè¡¨ç¤ºæ¯æ¬¡æ›´æ–°æ“ä½œåæ‰‹åŠ¨è°ƒç”¨ fsync() å°†æ•°æ®å†™åˆ°ç£ç›˜ï¼ˆæ…¢ï¼Œå®‰å…¨ï¼‰<strong>everysec</strong>ï¼šè¡¨ç¤ºæ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼ˆæŠ˜ä¸­ï¼Œé»˜è®¤å€¼ï¼‰</td>
</tr>
<tr>
<td align="left">21</td>
<td align="left"><code>vm-enabled no</code></td>
<td align="left">æŒ‡å®šæ˜¯å¦å¯ç”¨è™šæ‹Ÿå†…å­˜æœºåˆ¶ï¼Œé»˜è®¤å€¼ä¸º noï¼Œç®€å•çš„ä»‹ç»ä¸€ä¸‹ï¼ŒVM æœºåˆ¶å°†æ•°æ®åˆ†é¡µå­˜æ”¾ï¼Œç”± Redis å°†è®¿é—®é‡è¾ƒå°‘çš„é¡µå³å†·æ•°æ® swap åˆ°ç£ç›˜ä¸Šï¼Œè®¿é—®å¤šçš„é¡µé¢ç”±ç£ç›˜è‡ªåŠ¨æ¢å‡ºåˆ°å†…å­˜ä¸­ï¼ˆåœ¨åé¢çš„æ–‡ç« æˆ‘ä¼šä»”ç»†åˆ†æ Redis çš„ VM æœºåˆ¶ï¼‰</td>
</tr>
<tr>
<td align="left">22</td>
<td align="left"><code>vm-swap-file /tmp/redis.swap</code></td>
<td align="left">è™šæ‹Ÿå†…å­˜æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤å€¼ä¸º /tmp/redis.swapï¼Œä¸å¯å¤šä¸ª Redis å®ä¾‹å…±äº«</td>
</tr>
<tr>
<td align="left">23</td>
<td align="left"><code>vm-max-memory 0</code></td>
<td align="left">å°†æ‰€æœ‰å¤§äº vm-max-memory çš„æ•°æ®å­˜å…¥è™šæ‹Ÿå†…å­˜ï¼Œæ— è®º vm-max-memory è®¾ç½®å¤šå°ï¼Œæ‰€æœ‰ç´¢å¼•æ•°æ®éƒ½æ˜¯å†…å­˜å­˜å‚¨çš„(Redis çš„ç´¢å¼•æ•°æ® å°±æ˜¯ keys)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ vm-max-memory è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œå…¶å®æ˜¯æ‰€æœ‰ value éƒ½å­˜åœ¨äºç£ç›˜ã€‚é»˜è®¤å€¼ä¸º 0</td>
</tr>
<tr>
<td align="left">24</td>
<td align="left"><code>vm-page-size 32</code></td>
<td align="left">Redis swap æ–‡ä»¶åˆ†æˆäº†å¾ˆå¤šçš„ pageï¼Œä¸€ä¸ªå¯¹è±¡å¯ä»¥ä¿å­˜åœ¨å¤šä¸ª page ä¸Šé¢ï¼Œä½†ä¸€ä¸ª page ä¸Šä¸èƒ½è¢«å¤šä¸ªå¯¹è±¡å…±äº«ï¼Œvm-page-size æ˜¯è¦æ ¹æ®å­˜å‚¨çš„ æ•°æ®å¤§å°æ¥è®¾å®šçš„ï¼Œä½œè€…å»ºè®®å¦‚æœå­˜å‚¨å¾ˆå¤šå°å¯¹è±¡ï¼Œpage å¤§å°æœ€å¥½è®¾ç½®ä¸º 32 æˆ–è€… 64bytesï¼›å¦‚æœå­˜å‚¨å¾ˆå¤§å¤§å¯¹è±¡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ›´å¤§çš„ pageï¼Œå¦‚æœä¸ç¡®å®šï¼Œå°±ä½¿ç”¨é»˜è®¤å€¼</td>
</tr>
<tr>
<td align="left">25</td>
<td align="left"><code>vm-pages 134217728</code></td>
<td align="left">è®¾ç½® swap æ–‡ä»¶ä¸­çš„ page æ•°é‡ï¼Œç”±äºé¡µè¡¨ï¼ˆä¸€ç§è¡¨ç¤ºé¡µé¢ç©ºé—²æˆ–ä½¿ç”¨çš„ bitmapï¼‰æ˜¯åœ¨æ”¾åœ¨å†…å­˜ä¸­çš„ï¼Œï¼Œåœ¨ç£ç›˜ä¸Šæ¯ 8 ä¸ª pages å°†æ¶ˆè€— 1byte çš„å†…å­˜ã€‚</td>
</tr>
<tr>
<td align="left">26</td>
<td align="left"><code>vm-max-threads 4</code></td>
<td align="left">è®¾ç½®è®¿é—®swapæ–‡ä»¶çš„çº¿ç¨‹æ•°,æœ€å¥½ä¸è¦è¶…è¿‡æœºå™¨çš„æ ¸æ•°,å¦‚æœè®¾ç½®ä¸º0,é‚£ä¹ˆæ‰€æœ‰å¯¹swapæ–‡ä»¶çš„æ“ä½œéƒ½æ˜¯ä¸²è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆæ¯”è¾ƒé•¿æ—¶é—´çš„å»¶è¿Ÿã€‚é»˜è®¤å€¼ä¸º4</td>
</tr>
<tr>
<td align="left">27</td>
<td align="left"><code>glueoutputbuf yes</code></td>
<td align="left">è®¾ç½®åœ¨å‘å®¢æˆ·ç«¯åº”ç­”æ—¶ï¼Œæ˜¯å¦æŠŠè¾ƒå°çš„åŒ…åˆå¹¶ä¸ºä¸€ä¸ªåŒ…å‘é€ï¼Œé»˜è®¤ä¸ºå¼€å¯</td>
</tr>
<tr>
<td align="left">28</td>
<td align="left"><code>hash-max-zipmap-entries 64 hash-max-zipmap-value 512</code></td>
<td align="left">æŒ‡å®šåœ¨è¶…è¿‡ä¸€å®šçš„æ•°é‡æˆ–è€…æœ€å¤§çš„å…ƒç´ è¶…è¿‡æŸä¸€ä¸´ç•Œå€¼æ—¶ï¼Œé‡‡ç”¨ä¸€ç§ç‰¹æ®Šçš„å“ˆå¸Œç®—æ³•</td>
</tr>
<tr>
<td align="left">29</td>
<td align="left"><code>activerehashing yes</code></td>
<td align="left">æŒ‡å®šæ˜¯å¦æ¿€æ´»é‡ç½®å“ˆå¸Œï¼Œé»˜è®¤ä¸ºå¼€å¯ï¼ˆåé¢åœ¨ä»‹ç» Redis çš„å“ˆå¸Œç®—æ³•æ—¶å…·ä½“ä»‹ç»ï¼‰</td>
</tr>
<tr>
<td align="left">30</td>
<td align="left"><code>include /path/to/local.conf</code></td>
<td align="left">æŒ‡å®šåŒ…å«å…¶å®ƒçš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨åŒä¸€ä¸»æœºä¸Šå¤šä¸ªRediså®ä¾‹ä¹‹é—´ä½¿ç”¨åŒä¸€ä»½é…ç½®æ–‡ä»¶ï¼Œè€ŒåŒæ—¶å„ä¸ªå®ä¾‹åˆæ‹¥æœ‰è‡ªå·±çš„ç‰¹å®šé…ç½®æ–‡ä»¶</td>
</tr>
</tbody></table>
<h3 id="4-3-ğŸ”-é‡ç‚¹è¯¦è§£"><a href="#4-3-ğŸ”-é‡ç‚¹è¯¦è§£" class="headerlink" title="4.3 ğŸ” é‡ç‚¹è¯¦è§£"></a>4.3 ğŸ” é‡ç‚¹è¯¦è§£</h3><ol>
<li><p>UNIT: rediså¯¹å¤§å°å†™ä¸æ•æ„Ÿ</p>
</li>
<li><p>INCLUEDS[æ¨¡å—]: å¯ä»¥åŒ…å«å¤šä¸ªé…ç½®æ–‡ä»¶</p>
</li>
<li><p>MOUDLES[æ¨¡å—]: å¯åŠ¨æ—¶åŠ è½½æ¨¡å—</p>
</li>
<li><p>NETWORK[ç½‘ç»œ]: </p>
<ul>
<li>bind: ç»‘å®šIP</li>
<li>protected-mode: ä¿æŠ¤æ¨¡å¼</li>
<li>post: ç«¯å£è®¾ç½®</li>
</ul>
</li>
<li><p>GENERAL[é€šç”¨]: </p>
<ul>
<li>daemonize: æ˜¯å¦ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œ[^1]</li>
<li>pidfile /var/run/redis_6379.pid: å¦‚æœä»¥åå°çš„æ–¹å¼è¿è¡Œï¼Œå°±éœ€è¦æŒ‡å®šä¸€ä¸ªpidçš„é…ç½®æ–‡ä»¶</li>
<li>loglevel: æ—¥å¿—çº§åˆ«</li>
<li>logfile: æ—¥å¿—çš„æ–‡ä»¶ä½ç½®</li>
<li>database: æ•°æ®åº“çš„æ•°é‡</li>
<li>always-show-logo: æ˜¯å¦å¼€å¯æœåŠ¡çš„æ—¶å€™æ˜¾ç¤ºlogo</li>
</ul>
</li>
<li><p>SNAPSHOTTING[å¿«ç…§]:</p>
<ul>
<li>save 900 1: å¦‚æœåœ¨900så†…ï¼Œè‡³å°‘æœ‰1ä¸ªkeyè¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</li>
<li>save 300 10: å¦‚æœåœ¨300så†…ï¼Œè‡³å°‘æœ‰10ä¸ªkeyè¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</li>
<li>save 60 10000: å¦‚æœåœ¨60så†…ï¼Œè‡³å°‘æœ‰10000ä¸ªkeyè¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</li>
<li>stop-writes-on-bgsave-error: æŒä¹…åŒ–å‡ºç°é”™è¯¯ï¼Œæ˜¯å¦è®©redisç»§ç»­å·¥ä½œ</li>
<li>rdbcompression: æ˜¯å¦å‹ç¼©rdbæ–‡ä»¶ï¼Œéœ€è¦æ¶ˆè€—ä¸€äº›CPUèµ„æº</li>
<li>rdbchecksum: ä¿å­˜rdbçš„æ–‡ä»¶çš„æ—¶å€™ï¼Œæ˜¯å¦è¿›è¡Œé”™è¯¯æ ¡éªŒ</li>
<li>dir: æ–‡ä»¶ä¿å­˜çš„ç›®å½•</li>
</ul>
</li>
<li><p>REPLICATION[å¤åˆ¶]:</p>
<ul>
<li>è§ä¸»ä»å¤åˆ¶</li>
</ul>
</li>
<li><p>SECURITY[å®‰å…¨]:</p>
<ul>
<li><p>requirepass: è®¾ç½®å¯†ç </p>
</li>
<li><pre><code class="shell"># è®¾ç½®å¯†ç 
&gt; config set requirepass &lt;password&gt;
# ç™»å½•è¾“å…¥
&gt; auth &lt;password&gt;
# è·å–å¯†ç 
&gt; config get requirepass
# å–æ¶ˆè®¾ç½®
&gt; config set requirepass &#39;&#39;
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">9. CLIENTS[å®¢æˆ·ç«¯]:</span><br><span class="line"></span><br><span class="line">   - maxclients: è®¾ç½®å¯è¿æ¥redisçš„æœ€å¤§å®¢æˆ·ç«¯æ•°é‡</span><br><span class="line">   - maxmemory: é…ç½®redisçš„æœ€å¤§å†…å­˜å®¹é‡</span><br><span class="line">   - maxmemory-policy: å†…å­˜åˆ°è¾¾ä¸Šé™çš„å¤„ç†ç­–ç•¥</span><br><span class="line">     - volatile-lruï¼šåªå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyè¿›è¡ŒLRUï¼ˆé»˜è®¤å€¼ï¼‰ </span><br><span class="line">     - allkeys-lru ï¼š åˆ é™¤lruç®—æ³•çš„key  </span><br><span class="line">     - volatile-randomï¼šéšæœºåˆ é™¤å³å°†è¿‡æœŸkey  </span><br><span class="line">     - allkeys-randomï¼šéšæœºåˆ é™¤  </span><br><span class="line">     - volatile-ttl ï¼š åˆ é™¤å³å°†è¿‡æœŸçš„  </span><br><span class="line">     - noeviction ï¼š æ°¸ä¸è¿‡æœŸï¼Œè¿”å›é”™è¯¯</span><br><span class="line"></span><br><span class="line">10. APPEND ONLY MODE[AOF]:</span><br><span class="line"></span><br><span class="line">    - appendonly: é»˜è®¤ä¸å¼€å¯AOFæ¨¡å¼</span><br><span class="line">    - appendfilename: AOFæŒä¹…åŒ–çš„æ–‡ä»¶åç§°</span><br><span class="line">    - appendfsync always: æ¯æ¬¡ä¿®æ”¹éƒ½ä¼šåŒæ­¥ï¼Œæ¶ˆè€—æ€§èƒ½</span><br><span class="line">    - appendfsync everysec: æ¯ç§’æ‰§è¡Œä¸€æ¬¡åŒæ­¥ï¼Œå¯èƒ½ä¼šä¸¢å¤±è¿™1sçš„æ•°æ®</span><br><span class="line">    - appendfsync no: ä¸æ‰§è¡ŒåŒæ­¥ï¼Œæ“ä½œç³»ç»Ÿè‡ªå·±åŒæ­¥æ•°æ®ï¼Œé€Ÿåº¦æœ€å¿«</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[^1]: å®ˆæŠ¤è¿›ç¨‹ï¼Œåå°è¿è¡Œçš„ç‰¹æ®Šè¿›ç¨‹ï¼Œä¼´éšç€ä¸»è¿›ç¨‹çš„ç»“æŸè€Œæ¶ˆäº¡ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 5. ğŸ“©Redisæµ‹è¯•</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 5.1ğŸ”¬æµ‹è¯•æ–¹æ³•</span><br><span class="line"></span><br><span class="line">&gt; redisçš„æ€§èƒ½æµ‹è¯•å‘½ä»¤</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;shell</span><br><span class="line">redis-benchmark [option] [option value]</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
</li>
</ol>
<p>ğŸ””<strong>æ³¨æ„: è¿™ä¸ªå‘½ä»¤æ˜¯åœ¨redisç›®å½•ä¸‹æ‰§è¡Œï¼Œè€Œérediså®¢æˆ·ç«¯çš„å†…éƒ¨å‘½ä»¤</strong></p>
<h3 id="5-2-ğŸ“redisæ€§èƒ½æµ‹è¯•å·¥å…·å¯é€‰å‚æ•°"><a href="#5-2-ğŸ“redisæ€§èƒ½æµ‹è¯•å·¥å…·å¯é€‰å‚æ•°" class="headerlink" title="5.2 ğŸ“redisæ€§èƒ½æµ‹è¯•å·¥å…·å¯é€‰å‚æ•°"></a>5.2 ğŸ“redisæ€§èƒ½æµ‹è¯•å·¥å…·å¯é€‰å‚æ•°</h3><table>
<thead>
<tr>
<th align="left">åºå·</th>
<th align="left">é€‰é¡¹</th>
<th align="left">æè¿°</th>
<th align="left">é»˜è®¤å€¼</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left"><strong>-h</strong></td>
<td align="left">æŒ‡å®šæœåŠ¡å™¨ä¸»æœºå</td>
<td align="left">127.0.0.1</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left"><strong>-p</strong></td>
<td align="left">æŒ‡å®šæœåŠ¡å™¨ç«¯å£</td>
<td align="left">6379</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left"><strong>-s</strong></td>
<td align="left">æŒ‡å®šæœåŠ¡å™¨ socket</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">4</td>
<td align="left"><strong>-c</strong></td>
<td align="left">æŒ‡å®šå¹¶å‘è¿æ¥æ•°</td>
<td align="left">50</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left"><strong>-n</strong></td>
<td align="left">æŒ‡å®šè¯·æ±‚æ•°</td>
<td align="left">10000</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left"><strong>-d</strong></td>
<td align="left">ä»¥å­—èŠ‚çš„å½¢å¼æŒ‡å®š SET/GET å€¼çš„æ•°æ®å¤§å°</td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left"><strong>-k</strong></td>
<td align="left">1=keep alive 0=reconnect</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">8</td>
<td align="left"><strong>-r</strong></td>
<td align="left">SET/GET/INCR ä½¿ç”¨éšæœº key, SADD ä½¿ç”¨éšæœºå€¼</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">9</td>
<td align="left"><strong>-P</strong></td>
<td align="left">é€šè¿‡ç®¡é“ä¼ è¾“ <numreq> è¯·æ±‚</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">10</td>
<td align="left"><strong>-q</strong></td>
<td align="left">å¼ºåˆ¶é€€å‡º redisã€‚ä»…æ˜¾ç¤º query/sec å€¼</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">11</td>
<td align="left"><strong>â€“csv</strong></td>
<td align="left">ä»¥ CSV æ ¼å¼è¾“å‡º</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">12</td>
<td align="left"><strong>-l</strong></td>
<td align="left">ç”Ÿæˆå¾ªç¯ï¼Œæ°¸ä¹…æ‰§è¡Œæµ‹è¯•</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">13</td>
<td align="left"><strong>-t</strong></td>
<td align="left">ä»…è¿è¡Œä»¥é€—å·åˆ†éš”çš„æµ‹è¯•å‘½ä»¤åˆ—è¡¨ã€‚</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">14</td>
<td align="left"><strong>-I</strong></td>
<td align="left">Idle æ¨¡å¼ã€‚ä»…æ‰“å¼€ N ä¸ª idle è¿æ¥å¹¶ç­‰å¾…ã€‚</td>
<td align="left"></td>
</tr>
</tbody></table>
<h3 id="5-3-ğŸ“Šæµ‹è¯•ç»“æœåˆ†æ"><a href="#5-3-ğŸ“Šæµ‹è¯•ç»“æœåˆ†æ" class="headerlink" title="5.3 ğŸ“Šæµ‹è¯•ç»“æœåˆ†æ"></a>5.3 ğŸ“Šæµ‹è¯•ç»“æœåˆ†æ</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-benchmark -h 127.0.0.1 -p 6379 -c 100 -n 100000 </span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009193727448.png" class="" title="image-20201009193727448"><br />

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-benchmark -h 127.0.0.1 -p 6379 -c 1 -n 100000 -q</span><br></pre></td></tr></table></figure>

<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009194004617.png" class="" title="image-20201009194004617"><br />

<p>è¿™ä¸ªæ˜¯å¯¹æ‰€æœ‰æ“ä½œæµ‹è¯•æ€§èƒ½ï¼Œæ¯ç§’å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚</p>
<h2 id="6-ğŸ“©RedisåŸºç¡€"><a href="#6-ğŸ“©RedisåŸºç¡€" class="headerlink" title="6. ğŸ“©RedisåŸºç¡€"></a>6. ğŸ“©RedisåŸºç¡€</h2><h3 id="6-1-ğŸ’ Redisæ•°æ®åº“"><a href="#6-1-ğŸ’ Redisæ•°æ®åº“" class="headerlink" title="6.1 ğŸ’ Redisæ•°æ®åº“"></a>6.1 ğŸ’ Redisæ•°æ®åº“</h3><p><strong>redisæœ‰16ä¸ªæ•°æ®åº“ï¼Œé»˜è®¤ä½¿ç”¨ç¬¬0ä¸ª</strong></p>
<blockquote>
<p>æµ‹è¯•è¿æ¥</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ping</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å…³é—­è¿æ¥</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">quit</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿”å›æ¶ˆæ¯</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo &lt;str&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ‡æ¢æ•°æ®åº“</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">select &lt;num of database&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–å½“å‰æ•°æ®åº“çš„å¤§å°</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">dbsize</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ¸…ç©ºå½“å‰æ•°æ®åº“</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">flushdb</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ¸…ç©ºæ‰€æœ‰æ•°æ®åº“</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">flushall</span><br></pre></td></tr></table></figure>

<blockquote>
<p>äº¤æ¢æ•°æ®åº“</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">swap &lt;n1&gt; &lt;n2&gt;</span><br></pre></td></tr></table></figure>



<h3 id="6-2-ğŸŒ6379çš„æ•…äº‹"><a href="#6-2-ğŸŒ6379çš„æ•…äº‹" class="headerlink" title="6.2 ğŸŒ6379çš„æ•…äº‹"></a>6.2 ğŸŒ6379çš„æ•…äº‹</h3><p><strong>redisé»˜è®¤ç«¯å£å·ä¸º6379</strong></p>
<blockquote>
<p>ä½œè€…åœ¨è‡ªå·±çš„ä¸€ç¯‡åšæ–‡ä¸­è§£é‡Šäº†ä¸ºä»€ä¹ˆé€‰ç”¨ 6379 ä½œä¸ºé»˜è®¤ç«¯å£ï¼Œå› ä¸º 6379 åœ¨æ‰‹æœºæŒ‰é”®ä¸Š MERZ å¯¹åº”çš„å·ç ï¼Œè€Œ MERZ å–è‡ªæ„å¤§åˆ©æ­Œå¥³ Alessia Merz çš„åå­—ã€‚MERZé•¿æœŸä»¥æ¥è¢«Redisä½œè€…antirezåŠå…¶æœ‹å‹å½“ä½œæ„šè ¢çš„ä»£åè¯ï¼Œåæ¥ä½œè€…åœ¨å¼€å‘Rediså°±é€‰ç”¨äº†è¿™ä¸ªç«¯å£ã€‚</p>
</blockquote>
<h3 id="6-3-âš¡Redisèœœæ±é€Ÿåº¦"><a href="#6-3-âš¡Redisèœœæ±é€Ÿåº¦" class="headerlink" title="6.3 âš¡Redisèœœæ±é€Ÿåº¦"></a>6.3 âš¡Redisèœœæ±é€Ÿåº¦</h3><p><strong>redisæ˜¯å•çº¿ç¨‹çš„ã€‚</strong></p>
<p>redisåŸºäºå†…å­˜æ“ä½œï¼ŒCPUä¸æ˜¯redisçš„æ€§èƒ½ç“¶é¢ˆï¼ŒRedisçš„ç“¶é¢ˆå¾ˆå¯èƒ½æ˜¯æœºå™¨å†…å­˜æˆ–è€…ç½‘è·¯å¸¦å®½ã€‚</p>
<p>æ—¢ç„¶å•çº¿ç¨‹å®¹æ˜“å®ç°ï¼Œè€Œä¸”CPUä¸ä¼šæˆä¸ºç“¶é¢ˆï¼Œé‚£å°±é¡ºç†æˆç« çš„é‡‡ç”¨å•çº¿ç¨‹å®ç°ã€‚</p>
<blockquote>
<p>ğŸ’‰ç†è§£Redisèœœæ±é€Ÿåº¦éœ€è¦è·¨è¿‡ä¸¤ä¸ªè¯¯åŒº</p>
</blockquote>
<ul>
<li><p>è¯¯åŒº1ï¼šé«˜æ€§èƒ½çš„æœåŠ¡å™¨ä¸€å®šæ˜¯å¤šçº¿ç¨‹çš„ï¼Ÿ</p>
</li>
<li><p>è¯¯åŒº2ï¼šå¤šçº¿ç¨‹çš„æ•ˆç‡ä¸€å®šæ¯”å•çº¿ç¨‹é«˜ï¼Ÿ</p>
</li>
</ul>
<blockquote>
<p>ğŸ’ŠRedisé‡‡ç”¨å•çº¿ç¨‹ä¾ç„¶å¿«çš„åŸå› </p>
</blockquote>
<ol>
<li>Rediså®Œå…¨åŸºäºå†…å­˜ï¼Œè¯»å†™å…¨éƒ¨åœ¨ä¸€ä¸ªCPUä¸Šï¼Œç»å¤§éƒ¨åˆ†è¯·æ±‚æ˜¯çº¯ç²¹çš„å†…å­˜æ“ä½œï¼Œéå¸¸è¿…é€Ÿï¼Œæ•°æ®å­˜åœ¨äºå†…å­˜ä¸­ï¼Œç±»ä¼¼äºHashMapï¼ŒHashMapçš„ä¼˜åŠ¿å°±æ˜¯æŸ¥è¯¢å’Œæ“ä½œçš„æ—¶é—´å¤æ‚åº¦æ—¶O(1)</li>
<li>æ•°æ®ç»“æ„ç®€å•ï¼Œå¯¹æ•°æ®æ“ä½œä¹Ÿç®€å•</li>
<li>é‡‡ç”¨å•çº¿ç¨‹ï¼Œé¿å…äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰æ¡ä»¶ï¼Œä¸å­˜åœ¨å¤šçº¿ç¨‹å¯¼è‡´çš„CPUåˆ‡æ¢ï¼Œä¸ç”¨å–è€ƒè™‘å„ç§é”çš„é—®é¢˜ï¼Œä¸å­˜åœ¨åŠ é”æ”¾é”æ“ä½œï¼Œæ²¡æœ‰æ­»é”é—®é¢˜å¯¼è‡´çš„æ€§èƒ½æ¶ˆè€—</li>
<li>ä½¿ç”¨å¤šè·¯å¤ç”¨IOæ¨¡å‹ï¼Œéé˜»å¡IO</li>
</ol>
<h2 id="7-ğŸ“©Redisæ•°æ®ç±»å‹"><a href="#7-ğŸ“©Redisæ•°æ®ç±»å‹" class="headerlink" title="7. ğŸ“©Redisæ•°æ®ç±»å‹"></a>7. ğŸ“©Redisæ•°æ®ç±»å‹</h2><blockquote>
<p>ğŸŒè¯´æ˜</p>
</blockquote>
<p>æ‰€æœ‰å‘½ä»¤å¯æŸ¥çœ‹ä¸­æ–‡å®˜æ–¹æ–‡æ¡£: <a href="http://redis.cn/commands.html#">http://redis.cn/commands.html#</a></p>
<h3 id="7-1-ğŸ†äº”å¤§æ•°æ®ç±»å‹"><a href="#7-1-ğŸ†äº”å¤§æ•°æ®ç±»å‹" class="headerlink" title="7.1 ğŸ†äº”å¤§æ•°æ®ç±»å‹"></a>7.1 ğŸ†äº”å¤§æ•°æ®ç±»å‹</h3><table>
<thead>
<tr>
<th align="center">ç±»å‹</th>
<th align="center">ç®€ä»‹</th>
<th align="center">ç‰¹æ€§</th>
<th align="center">åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td align="center">String(å­—ç¬¦ä¸²)</td>
<td align="center">äºŒè¿›åˆ¶å®‰å…¨</td>
<td align="center">å¯ä»¥åŒ…å«ä»»ä½•æ•°æ®ï¼Œæ¯”å¦‚jpgå›¾ç‰‡æˆ–è€…åºåˆ—åŒ–å¯¹è±¡</td>
<td align="center">â€”</td>
</tr>
<tr>
<td align="center">Hash(å­—å…¸)</td>
<td align="center">é”®å€¼å¯¹é›†åˆ</td>
<td align="center">é€‚åˆå­˜å‚¨å¯¹è±¡ï¼Œå¹¶ä¸”å¯ä»¥åƒæ•°æ®åº“ä¸­çš„updateä¸€ä¸ªå±æ€§ä¸€æ ·å€¼ä¿®æ”¹æŸä¸€é¡¹å±æ€§å€¼</td>
<td align="center">å­˜å‚¨ã€è¯»å–ã€ä¿®æ”¹ç”¨æˆ·å±æ€§</td>
</tr>
<tr>
<td align="center">List(åˆ—è¡¨)</td>
<td align="center">åŒå‘é“¾è¡¨</td>
<td align="center">å¢åˆ å¿«ï¼Œæä¾›äº†æ“ä½œæŸä¸€å…ƒç´ çš„api</td>
<td align="center">æœ€æ–°æ¶ˆæ¯æ’è¡Œï¼›æ¶ˆæ¯é˜Ÿåˆ—</td>
</tr>
<tr>
<td align="center">Set(é›†åˆ)</td>
<td align="center">hashè¡¨å®ç°ï¼Œå…ƒç´ ä¸é‡å¤</td>
<td align="center">å¢åˆ æŸ¥å¿«ï¼Œæä¾›äº†æ±‚äº¤é›†ã€å¹¶é›†å’Œå·®é›†çš„æ“ä½œ</td>
<td align="center">å…±åŒå¥½å‹:  åˆ©ç”¨å”¯ä¸€æ€§ï¼Œç»Ÿè®¡ç½‘ç«™UV</td>
</tr>
<tr>
<td align="center">Sorted Set(æœ‰åºé›†åˆ)</td>
<td align="center">å°†setä¸­çš„å…ƒç´ å¢åŠ ä¸€ä¸ªæƒé‡scoreï¼Œå…ƒç´ æŒ‰ç…§scoreæœ‰åºæ’åˆ—</td>
<td align="center">æ•°æ®æ’å…¥é›†åˆæ—¶ï¼Œå·²ç»è¿›è¡Œäº†å¤©ç„¶æ’åº</td>
<td align="center">æ’è¡Œæ¦œï¼›å¸¦æƒé‡çš„æ¶ˆæ¯é˜Ÿåˆ—</td>
</tr>
</tbody></table>
<p><strong>ğŸ²Key</strong></p>
<blockquote>
<p>æŸ¥çœ‹æ‰€æœ‰çš„key</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">keys *</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ›å»ºé”®å€¼å¯¹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">set &lt;key&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">get &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç§»é™¤é”®å€¼å¯¹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">move &lt;key&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">exists &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æŸ¥çœ‹keyçš„ç±»å‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">type &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è®¾ç½®keyçš„è¿‡æœŸæ—¶é—´/ç§’</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">expire &lt;key&gt; &lt;seconds&gt; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰æ•ˆæ—¶é—´/ç§’</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ttl &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰æ•ˆæ—¶é—´/æ¯«ç§’</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pttl &lt;key&gt;</span><br></pre></td></tr></table></figure>



<h4 id="7-1-1-âš½String"><a href="#7-1-1-âš½String" class="headerlink" title="7.1.1 âš½String"></a>7.1.1 âš½String</h4><blockquote>
<p>å‘keyä¸Šè¿½åŠ å­—ç¬¦ä¸²</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">append &lt;key&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„é•¿åº¦</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">strlen &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Integeræ“ä½œ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åŠ 1</span></span><br><span class="line">incr &lt;key&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> åŠ n</span></span><br><span class="line">incrby &lt;key&gt; n</span><br><span class="line"><span class="meta">#</span><span class="bash"> å‡1</span></span><br><span class="line">decr &lt;key&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> å‡n</span></span><br><span class="line">decrby &lt;key&gt; n</span><br></pre></td></tr></table></figure>

<blockquote>
<p>subString(start, end)æ“ä½œ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æˆªå–æ•´ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line">getrange &lt;key&gt; 0 -1</span><br><span class="line"><span class="meta">#</span><span class="bash"> æˆªå–éƒ¨åˆ†å­—ç¬¦ä¸²</span></span><br><span class="line">getrange &lt;key&gt; start end</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">set</span> s <span class="string">&quot;Khighness&quot;</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> getrange s 0 -1 <span class="comment"># &quot;Khighness&quot;</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> getrange s 1 4  <span class="comment"># &quot;high&quot;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>replace(start, end)æ“ä½œ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŠŠå­—ç¬¦ä¸²ä»nä½å¼€å§‹ä¹‹åçš„å­—ç¬¦æ›¿æ¢ä¸ºæ–°çš„å­—ç¬¦ä¸²newStr</span></span><br><span class="line">setrange &lt;key&gt; n newStr</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">set</span> s <span class="string">&quot;Khighness&quot;</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> setrange s 0 X </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> get s <span class="comment"># &quot;Xhighness&quot;</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> setrange s 5 <span class="string">&quot;XXXXX&quot;</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> get s <span class="comment"># &quot;XhighXXXXX&quot;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>setex (set with expire) åˆ›å»ºé”®å€¼å¯¹çš„åŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´</p>
<p>setnx (set if not exist)  å¦‚æœkeyä¸å­˜åœ¨åˆ™åˆ›å»ºé”®å€¼å¯¹ï¼Œé˜²æ­¢è¦†ç›–åŸæœ‰é”®å€¼å¯¹ (åˆ†å¸ƒå¼é”ä¸­ç»å¸¸ä½¿ç”¨)</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è®¾ç½®é”®å€¼å¯¹ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´</span></span><br><span class="line">setex &lt;key&gt; &lt;seconds&gt; &lt;value&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> keyä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºé”®å€¼å¯¹</span></span><br><span class="line">setnx &lt;key&gt; &lt;value&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line">127.0.0.1:6379&gt; setex k1 10 parak</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; ttl k1</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; ttl k1</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; ttl k1</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; ttl k1</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; ttl k1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl k1</span><br><span class="line">(integer) -2</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">(nil)</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; setnx k2 parak</span><br><span class="line">(integer) 1 # 1ä»£è¡¨è®¾ç½®æˆåŠŸ</span><br><span class="line">127.0.0.1:6379&gt; setnx k2 flowerk</span><br><span class="line">(integer) 0 # 0ä»£è¡¨è®¾ç½®å¤±è´¥</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;parak&quot;     </span><br><span class="line">127.0.0.1:6379&gt; setnx k2 FlowerK</span><br><span class="line">(integer) 0 </span><br><span class="line">127.0.0.1:6379&gt; set k2 FlowerK</span><br><span class="line">OK          # å¼ºåˆ¶è®¾ç½®value</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;FlowerK&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¤šä¸ªé”®å€¼å¯¹æ“ä½œ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä¸€æ¬¡æ€§åˆ›å»ºå¤šä¸ªé”®å€¼å¯¹</span></span><br><span class="line">mset &lt;key&gt; &lt;value&gt; [key value ...]</span><br><span class="line"><span class="meta">#</span><span class="bash"> è·å–å¤šä¸ªkeyçš„å€¼</span></span><br><span class="line">meget &lt;key&gt; [key ...]</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸å­˜åœ¨åˆ™åˆ›å»ºå¤šä¸ªé”®å€¼å¯¹</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åŸå­æ€§æ“ä½œï¼Œåªè¦å…¶ä¸­æœ‰ä¸€ä¸ªkeyå·²å­˜åœ¨ï¼Œå°±ä¼šå…¨éƒ¨åˆ›å»ºå¤±è´¥</span></span><br><span class="line">msetnx &lt;key&gt; &lt;value&gt; [key value ...]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line">127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget k1 k2 k3</span><br><span class="line">1) &quot;v1&quot;</span><br><span class="line">2) &quot;v2&quot;</span><br><span class="line">3) &quot;v3&quot;</span><br><span class="line">127.0.0.1:6379&gt; msetnx k2 v2 k4 v4 k5 v5</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;k2&quot;</span><br><span class="line">2) &quot;k3&quot;</span><br><span class="line">3) &quot;k1&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å·§å¦™è®¾è®¡key  object:&#123;id&#125;:&#123;field&#125;</span></span><br><span class="line">127.0.0.1:6379&gt; mset user:1:name Khighness user:1:age 18</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget user:1:name user:1:age</span><br><span class="line">1) &quot;Khighness&quot;</span><br><span class="line">2) &quot;18&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç»„åˆæ“ä½œ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ˆè·å–å€¼ï¼Œå†è®¾ç½®æ–°çš„å€¼</span></span><br><span class="line">getset k v</span><br></pre></td></tr></table></figure>



<h4 id="7-1-2-âš¾List"><a href="#7-1-2-âš¾List" class="headerlink" title="7.1.2 âš¾List"></a>7.1.2 âš¾List</h4><p>redisé‡Œé¢ï¼Œlistå¯ä»¥å½“æˆæ ˆã€é˜Ÿåˆ—ã€é˜Ÿåˆ—ã€‚</p>
<blockquote>
<p>å‘listçš„å¤´éƒ¨æ·»åŠ å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">lpush &lt;key&gt; value [value ...]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å‘listçš„å°¾éƒ¨æ·»åŠ å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rpush &lt;key&gt; value [value ...]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ¤æ–­listæ˜¯å¦å­˜åœ¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">exists &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç§»é™¤åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ </p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">lpop &lt;key&gt; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ </p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rpop &lt;key&gt; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç§»é™¤æŒ‡å®šçš„å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">lrem &lt;key&gt; &lt;count&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ›´æ–°list</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æ ¹æ®indexæ›´æ–°å€¼</span></span><br><span class="line">lset &lt;key&gt; &lt;index&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ ¹æ®ä¸‹æ ‡è·å–å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">lindex &lt;key&gt; &lt;index&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–listçš„é•¿åº¦</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">llen &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–listæŒ‡å®šèŒƒå›´çš„å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è·å–æ•´ä¸ªlistçš„å€¼</span></span><br><span class="line">lrange &lt;key&gt; 0 -1</span><br><span class="line"><span class="meta">#</span><span class="bash"> è·å–æŒ‡å®šèŒƒå›´çš„å€¼</span></span><br><span class="line">lrange &lt;key&gt; start end</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line">127.0.0.1:6379&gt; lpush list1 1 2 3 4 5 </span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; lrange list1 0 -1</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;4&quot;</span><br><span class="line">3) &quot;3&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">5) &quot;1&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrange list1 0 1</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;4&quot;</span><br><span class="line">127.0.0.1:6379&gt; rpush list2 1 2 3 4 5</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; lrange list2 0 -1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br><span class="line">4) &quot;4&quot;</span><br><span class="line">5) &quot;5&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrange list2 0 1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æˆªå–listä¸­æŒ‡å®šèŒƒå›´çš„å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä¿ç•™ä¸‹æ ‡[start, end]çš„å€¼</span></span><br><span class="line">ltrim &lt;key&gt; start end</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line">127.0.0.1:6379&gt; rpush list parak1 parak2 parak3 parak4 parak5</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; ltrim list 0 2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;parak1&quot;</span><br><span class="line">2) &quot;parak2&quot;</span><br><span class="line">3) &quot;parak3&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç»„åˆæ“ä½œ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ç§»é™¤<span class="built_in">source</span>çš„å°¾éƒ¨çš„å€¼æ’å…¥åˆ°destinationçš„å¤´éƒ¨</span></span><br><span class="line">rpoplpush &lt;source&gt; &lt;destination&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line">127.0.0.1:6379&gt; rpush list 1 2 3 4 5</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; rpoplpush list newlist</span><br><span class="line">&quot;5&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrange newlist 0 -1</span><br><span class="line">1) &quot;5&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨listä¸­æ’å…¥å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åœ¨listä¸­çš„æŸä¸ªå€¼ä¹‹å‰æ’å…¥</span></span><br><span class="line">linsert &lt;key&gt; before &lt;priot&gt; &lt;value&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨listä¸­çš„æŸä¸ªå€¼ä¹‹åæ’å…¥</span></span><br><span class="line">linsert &lt;key&gt; after &lt;priot&gt; &lt;value&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line">127.0.0.1:6379&gt; rpush list 1 2 3 4 5</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; linsert list before 3 6</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;6&quot;</span><br><span class="line">4) &quot;3&quot;</span><br><span class="line">5) &quot;4&quot;</span><br><span class="line">6) &quot;5&quot;</span><br><span class="line">127.0.0.1:6379&gt; linsert list after 5 7</span><br><span class="line">(integer) 7</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;6&quot;</span><br><span class="line">4) &quot;3&quot;</span><br><span class="line">5) &quot;4&quot;</span><br><span class="line">6) &quot;5&quot;</span><br><span class="line">7) &quot;7&quot;</span><br></pre></td></tr></table></figure>



<h4 id="7-1-3-ğŸ€Set"><a href="#7-1-3-ğŸ€Set" class="headerlink" title="7.1.3 ğŸ€Set"></a>7.1.3 ğŸ€Set</h4><p>set æ— åºä¸é‡å¤é›†åˆ</p>
<ul>
<li>seté€šè¿‡å“ˆå¸Œè¡¨å®ç°ï¼Œæ‰€æœ‰å¢åˆ æŸ¥çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1)</li>
</ul>
<blockquote>
<p>å‘setä¸­å›½æ·»åŠ å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sadd &lt;key&gt; &lt;value&gt; [value ...]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æŸ¥çœ‹setä¸­çš„æ‰€æœ‰å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">smembers &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æŸ¥çœ‹setä¸­æ˜¯å¦åŒ…å«å€¼value</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sismember &lt;key&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–setä¸­çš„å…ƒç´ ä¸ªæ•°</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scard &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç§»é™¤setä¸­çš„å€¼value</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">srem &lt;key&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–setä¸­çš„éšæœºå€¼(å¯ä»¥åšæŠ½å¥–åŠŸèƒ½)</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">srandmember &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>éšæœºç§»é™¤setä¸­çš„å…ƒç´ </p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">spop &lt;key&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å°†ä¸€ä¸ªseté›†åˆä¸­æŒ‡å®šçš„å€¼ç§»åŠ¨åˆ°å¦ä¸€ä¸ªseté›†åˆ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å°†<span class="built_in">source</span>ä¸­çš„valueç§»åŠ¨åˆ°destination</span></span><br><span class="line">smove &lt;source&gt; &lt;destination&gt; &lt;value&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line">127.0.0.1:6379&gt; sadd set k1 k2 k3 k4 k5 k6 k7</span><br><span class="line">(integer) 7</span><br><span class="line">127.0.0.1:6379&gt; sadd newset k1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; smove set newset k3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers newset</span><br><span class="line">1) &quot;k3&quot;</span><br><span class="line">2) &quot;k1&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é›†åˆè¿ç®—</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> é›†åˆs1å’Œs2çš„å¹¶é›†</span></span><br><span class="line">sunion &lt;s1&gt; &lt;s&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> é›†åˆs1å’Œs2çš„äº¤é›† (å®ç°å…±åŒå¥½å‹ã€å…±åŒå…³æ³¨)</span></span><br><span class="line">sinter &lt;s1&gt; &lt;s2&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> é›†åˆs1ä¸­ç‹¬æœ‰çš„å…ƒç´ </span></span><br><span class="line">sdiff &lt;s1&gt; &lt;s2&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line">127.0.0.1:6379&gt; sadd s1 k1 k2 k3 k4 k5 k6</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; sadd s2 k5 k6 k7 k8 k9 k10</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; sunion s1 s2</span><br><span class="line"> 1) &quot;k5&quot;</span><br><span class="line"> 2) &quot;k6&quot;</span><br><span class="line"> 3) &quot;k8&quot;</span><br><span class="line"> 4) &quot;k2&quot;</span><br><span class="line"> 5) &quot;k3&quot;</span><br><span class="line"> 6) &quot;k1&quot;</span><br><span class="line"> 7) &quot;k4&quot;</span><br><span class="line"> 8) &quot;k7&quot;</span><br><span class="line"> 9) &quot;k10&quot;</span><br><span class="line">10) &quot;k9&quot;</span><br><span class="line">127.0.0.1:6379&gt; sinter s1 s2</span><br><span class="line">1) &quot;k5&quot;</span><br><span class="line">2) &quot;k6&quot;</span><br><span class="line">127.0.0.1:6379&gt; sdiff s1 s2</span><br><span class="line">1) &quot;k2&quot;</span><br><span class="line">2) &quot;k1&quot;</span><br><span class="line">3) &quot;k3&quot;</span><br><span class="line">4) &quot;k4&quot;</span><br></pre></td></tr></table></figure>



<h4 id="7-1-4-ğŸˆHash"><a href="#7-1-4-ğŸˆHash" class="headerlink" title="7.1.4 ğŸˆHash"></a>7.1.4 ğŸˆHash</h4><p>ç›¸å½“äºkey-HashMapï¼Œvalueä¸ºä¸€ä¸ªmapé›†åˆï¼Œæ›´é€‚åˆäºå¯¹è±¡çš„å­˜å‚¨ï¼Œå¤šç”¨äºå­˜å‚¨å˜æ›´æ•°æ®ã€</p>
<blockquote>
<p>è®¾ç½®keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µçš„å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hset &lt;key&gt; &lt;field&gt; &lt;value&gt; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­ä¸å­˜åœ¨æŒ‡å®šå­—æ®µæ—¶ï¼Œè®¾ç½®å­—æ®µçš„å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hsetnx &lt;key&gt; &lt;field&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ é™¤keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hdel &lt;key&gt; &lt;field&gt; [field ...]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ¤æ–­keyæŒ‡å®šå“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µæ˜¯å¦å­˜åœ¨</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexists &lt;key&gt; &lt;field&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¯¹keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µçš„å€¼åŠ ä¸Šå¢é‡(Integerå‹ï¼Œå¯æ­£å¯è´Ÿï¼Œå­—æ®µä¸å­˜åœ¨åˆ™åœ¨æ“ä½œæ‰§è¡Œå‰æŠŠè¯¥å­—æ®µçš„å€¼è®¾ç½®ä¸º0)</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hincrby &lt;key&gt; &lt;field&gt; &lt;integer&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¯¹keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µçš„å€¼åŠ ä¸Šå¢é‡(floatå‹ï¼Œå¯æ­£å¯è´Ÿï¼Œå­—æ®µä¸å­˜åœ¨åˆ™åœ¨æ“ä½œæ‰§è¡Œå‰æŠŠè¯¥å­—æ®µçš„å€¼è®¾ç½®ä¸º0)</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hincrbyfloat &lt;key&gt; &lt;field&gt; &lt;float&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­å­—æ®µæ•°é‡</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hlen &lt;key&gt; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µçš„å€¼çš„å­—ç¬¦ä¸²é•¿åº¦</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hstrlen hash &lt;key&gt; &lt;value&gt; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>keyæŒ‡å®šçš„å“ˆå¸Œé›†æ“ä½œ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è®¾ç½®keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µçš„å€¼</span></span><br><span class="line">hmset &lt;key&gt; &lt;field&gt; &lt;value&gt; [field value ...]</span><br><span class="line"><span class="meta">#</span><span class="bash"> è·å–keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µæ‰€å…³è”çš„å€¼</span></span><br><span class="line">hmget &lt;key&gt; &lt;field&gt; [field ...]</span><br><span class="line"><span class="meta">#</span><span class="bash"> è·å–keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æ‰€æœ‰å­—æ®µçš„åå­—</span></span><br><span class="line">hkeys</span><br><span class="line"><span class="meta">#</span><span class="bash"> è·å–keyæŒ‡å®šå“ˆå¸Œé›†ä¸­æ‰€æœ‰å­—æ®µçš„å€¼</span></span><br><span class="line">hvals</span><br><span class="line"><span class="meta">#</span><span class="bash"> è·å–keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æ‰€æœ‰çš„å­—æ®µå’Œå€¼</span></span><br><span class="line">hgetall</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚</span></span><br><span class="line">127.0.0.1:6379&gt; hmset hash field1 hello field2 world</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; hmget hash field1 field2</span><br><span class="line">1) &quot;hello&quot;</span><br><span class="line">2) &quot;world&quot;</span><br><span class="line">127.0.0.1:6379&gt; hkeys hash</span><br><span class="line">1) &quot;field1&quot;</span><br><span class="line">2) &quot;field2&quot;</span><br><span class="line">127.0.0.1:6379&gt; hvals hash</span><br><span class="line">1) &quot;hello&quot;</span><br><span class="line">2) &quot;world&quot;</span><br><span class="line">127.0.0.1:6379&gt; hgetall hash</span><br><span class="line">1) &quot;field1&quot;</span><br><span class="line">2) &quot;hello&quot;</span><br><span class="line">3) &quot;field2&quot;</span><br><span class="line">4) &quot;world&quot;</span><br></pre></td></tr></table></figure>



<h4 id="7-1-5-ğŸ‰Sorted-Set"><a href="#7-1-5-ğŸ‰Sorted-Set" class="headerlink" title="7.1.5 ğŸ‰Sorted Set"></a>7.1.5 ğŸ‰Sorted Set</h4><p>æœ‰åºé›†åˆsorted setï¼Œé›†åˆä¸­æ¯ä¸ªå…ƒç´ éƒ½ä¼šå…³è”ä¸€ä¸ªdoubleç±»å‹çš„åˆ†æ•°ã€‚</p>
<ul>
<li><p>redisé€šè¿‡åˆ†æ•°å¯¹é›†åˆä¸­çš„æˆå‘˜è¿›è¡Œæ’åºã€‚</p>
</li>
<li><p>æœ‰åºé›†åˆä¸­æˆå‘˜æ˜¯å”¯ä¸€çš„ï¼Œåˆ†æ•°å¯ä»¥é‡å¤ã€‚</p>
</li>
<li><p>é›†åˆæ˜¯é€šè¿‡å“ˆå¸Œè¡¨å®ç°çš„ï¼Œæ‰€ä»¥å¢åˆ æŸ¥çš„äº‹ä»¶å¤æ‚åº¦éƒ½æ˜¯O(1)ã€‚</p>
</li>
<li><p>é›†åˆä¸­æœ€å¤§çš„æˆå‘˜æ•°é‡ä¸º2^32^-1(4294967295)ï¼Œ æ¯ä¸ªé›†åˆå¯å­˜å‚¨40å¤šäº¿ä¸ªæˆå‘˜ã€‚</p>
</li>
</ul>
<blockquote>
<p>å‘keyçš„æœ‰åºé›†åˆä¸­æ·»åŠ åºå·ä¸ºnumberçš„value</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zadd &lt;key&gt; &lt;number&gt; &lt;value&gt; [number value ...]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­çš„æ‰€æœ‰å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zrange &lt;key&gt; 0 -1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­çš„æˆå‘˜æ•°é‡</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zcard &lt;key&gt; </span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šä¸‹æ ‡åŒºé—´çš„æˆå‘˜</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zrange &lt;key&gt; start end</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜memberçš„ç´¢å¼•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zrank &lt;key&gt; member</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¯¹keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜memberçš„åˆ†æ•°åŠ ä¸Šå¢é‡</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zincrby &lt;key&gt; &lt;Integer&gt; member</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜memberçš„åˆ†æ•°å€¼</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zscore &lt;key&gt; member</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜memberçš„æ’å(ä»å°åˆ°å¤§)</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zrank &lt;key&gt; member</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜memberçš„æ’å(ä»å¤§åˆ°å°)</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zrevrank &lt;key&gt; member</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­åˆ†æ•°åœ¨æŒ‡å®šåŒºé—´[min,max]çš„æˆå‘˜æ•°é‡</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zcount &lt;key&gt; min max</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é€šè¿‡å­—å…¸åŒºé—´è·å–keyçš„æœ‰åºé›†åˆä¸­çš„æˆå‘˜æ•°é‡</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zlexcount &lt;key&gt; min max</span><br></pre></td></tr></table></figure>

<blockquote>
<p>é€šè¿‡å­—å…¸åŒºé—´è·å–keyçš„æœ‰åºé›†åˆä¸­çš„æˆå‘˜</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zrangebylex &lt;key&gt; min max [limit offset count]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­åˆ†æ•°åœ¨æŒ‡å®šåŒºé—´[min,max]çš„æˆå‘˜</p>
<blockquote>
<p>å‚æ•°è¯´æ˜</p>
<ul>
<li>min max<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ä¸ºé—­åŒºé—´ï¼Œå³[min ,max]</li>
<li>ä¹Ÿå¯ä»¥æ˜¯ä½¿ç”¨å¼€åŒºé—´ï¼Œå³(min, max)ï¼Œå†™æ³•ä¸º<code> (min  (max</code></li>
</ul>
</li>
<li>withscores<ul>
<li>è¿”å›æˆå‘˜çš„åŒæ—¶ä¼šè¿”å›åˆ†æ•°</li>
</ul>
</li>
<li>limit offset count<ul>
<li>offsetï¼šèµ·å§‹ä½ç½®ï¼Œcountï¼šä»èµ·å§‹ä½ç½®å¼€å§‹çš„è®°å½•æ•°é‡</li>
<li>å®ç°åˆ†é¡µæŸ¥è¯¢</li>
<li>å‚æ•°: é¡µæ•°pagenumï¼Œé¡µé¢å¤§å°pagesize</li>
<li>é‚£ä¹ˆå®é™…çš„offset = (pagenum - 1) * pagesizeï¼Œcount = pagesize</li>
<li>å³æŸ¥è¯¢è¯­å¥ä¸º<code>zrangebyscore salary min max withscores limit (pagenum - 1) * pagesize pagesize  </code></li>
</ul>
</li>
</ul>
</blockquote>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zrangebyscore &lt;key&gt; min max [withscores] [limit offset count]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¾‹å¦‚</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd salary -10000 W -20000 F -30000 S</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; zadd salary 10000 K 20000 A 30000 G</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore salary -20000 20000</span><br><span class="line">1) &quot;F&quot;</span><br><span class="line">2) &quot;W&quot;</span><br><span class="line">3) &quot;K&quot;</span><br><span class="line">4) &quot;A&quot;</span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore salary -inf inf </span><br><span class="line">1) &quot;S&quot;</span><br><span class="line">2) &quot;F&quot;</span><br><span class="line">3) &quot;W&quot;</span><br><span class="line">4) &quot;K&quot;</span><br><span class="line">5) &quot;A&quot;</span><br><span class="line">6) &quot;G&quot;</span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore salary -inf inf withscores</span><br><span class="line"> 1) &quot;S&quot;</span><br><span class="line"> 2) &quot;-30000&quot;</span><br><span class="line"> 3) &quot;F&quot;</span><br><span class="line"> 4) &quot;-20000&quot;</span><br><span class="line"> 5) &quot;W&quot;</span><br><span class="line"> 6) &quot;-10000&quot;</span><br><span class="line"> 7) &quot;K&quot;</span><br><span class="line"> 8) &quot;10000&quot;</span><br><span class="line"> 9) &quot;A&quot;</span><br><span class="line">10) &quot;20000&quot;</span><br><span class="line">11) &quot;G&quot;</span><br><span class="line">12) &quot;30000&quot;</span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore salary -inf inf withscores limit 4 2</span><br><span class="line">1) &quot;G&quot;</span><br><span class="line">2) &quot;30000&quot;</span><br><span class="line">3) &quot;K&quot;</span><br><span class="line">4) &quot;60000&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åˆ é™¤keyçš„æœ‰åºé›†åˆä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zrem &lt;key&gt; member [member ...]</span><br></pre></td></tr></table></figure>



<h3 id="7-2-ğŸŒŒä¸‰ç§ç‰¹æ®Šç±»å‹"><a href="#7-2-ğŸŒŒä¸‰ç§ç‰¹æ®Šç±»å‹" class="headerlink" title="7.2 ğŸŒŒä¸‰ç§ç‰¹æ®Šç±»å‹"></a>7.2 ğŸŒŒä¸‰ç§ç‰¹æ®Šç±»å‹</h3><h4 id="7-2-1-ğŸ”®Geospatial"><a href="#7-2-1-ğŸ”®Geospatial" class="headerlink" title="7.2.1 ğŸ”®Geospatial"></a>7.2.1 ğŸ”®Geospatial</h4><p>Geospatialï¼Œåœ°ç†ç©ºé—´ï¼Œç®€ç§°GEOï¼Œä¸»è¦ç”¨äºå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œå¹¶å¯¹å­˜å‚¨çš„ä¿¡æ¯è¿›è¡Œæ“ä½œã€‚</p>
<blockquote>
<p>æ“ä½œæ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">geoadd</td>
<td align="center">æ·»åŠ åœ°ç†ä½ç½®çš„åæ ‡</td>
</tr>
<tr>
<td align="center">geopos</td>
<td align="center">è·å–åœ°ç†ä½ç½®çš„åæ ‡</td>
</tr>
<tr>
<td align="center">geodist</td>
<td align="center">è®¡ç®—ä¸¤ä¸ªä½ç½®ä¹‹é—´çš„è·ç¦»</td>
</tr>
<tr>
<td align="center">georadius</td>
<td align="center">æ ¹æ®ç”¨æˆ·ç»™å®šçš„ç»çº¬åº¦åæ ‡æ¥è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆ</td>
</tr>
<tr>
<td align="center">georadiusbymember</td>
<td align="center">æ ¹æ®å‚¨å­˜åœ¨ä½ç½®é›†åˆé‡Œé¢çš„æŸä¸ªåœ°ç‚¹è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆ</td>
</tr>
<tr>
<td align="center">geohash</td>
<td align="center">è¿”å›ä¸€ä¸ªæˆ–è€…å¤šä¸ªä½ç½®å¯¹è±¡çš„geohashå€¼</td>
</tr>
</tbody></table>
<p>æŸ¥è¯¢åœ°ç†æ•°æ®ï¼š<a href="http://www.jsons.cn/lngcode/">åŸå¸‚ç»çº¬åº¦æŸ¥è¯¢</a></p>
<blockquote>
<p>æµ‹è¯•æ•°æ®</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">åœ°æ–¹</th>
<th align="center">ç»åº¦</th>
<th align="center">çº¬åº¦</th>
</tr>
</thead>
<tbody><tr>
<td align="center">é»„å†ˆå¸‚é»„æ¢…å¿</td>
<td align="center">115.94427</td>
<td align="center">30.07033</td>
</tr>
<tr>
<td align="center">æ­¦æ±‰å¸‚æ­¦æ˜ŒåŒº</td>
<td align="center">114.31589</td>
<td align="center">30.55389</td>
</tr>
<tr>
<td align="center">åŒ—äº¬å¸‚ä¸°å°åŒº</td>
<td align="center">116.28625</td>
<td align="center">39.8585</td>
</tr>
<tr>
<td align="center">ä¸Šæµ·å¸‚é»„æµ¦åŒº</td>
<td align="center">121.49295</td>
<td align="center">31.22337</td>
</tr>
<tr>
<td align="center">åˆè‚¥å¸‚èœ€å±±åŒº</td>
<td align="center">117.26104</td>
<td align="center">31.85117</td>
</tr>
<tr>
<td align="center">æ·±åœ³å¸‚å—å±±åŒº</td>
<td align="center">113.93029</td>
<td align="center">22.53291</td>
</tr>
<tr>
<td align="center">å¤§è¿å¸‚ä¸­å±±åŒº</td>
<td align="center">121.64465</td>
<td align="center">38.91859</td>
</tr>
<tr>
<td align="center">å¹¿å·å¸‚å¤©æ²³åŒº</td>
<td align="center">113.36112</td>
<td align="center">23.12467</td>
</tr>
</tbody></table>
<p>1ï¸âƒ£<strong>geoadd</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>geoaddç”¨äºå­˜å‚¨æŒ‡å®šçš„åœ°ç†ä½ç½®ç©ºé—´ï¼Œå¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ªç»åº¦(longitude)ã€çº¬åº¦(latitude)ã€ä½ç½®åç§°(member)æ·»åŠ åˆ°æŒ‡å®šçš„keyä¸­ã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">geoadd &lt;key&gt; longitude latitude member [longtitude latitude member ...]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è§„åˆ™</p>
</blockquote>
<ul>
<li>ä¸¤çº§æ— æ³•ç›´æ¥æ·»åŠ </li>
<li>æœ‰æ•ˆç»åº¦ï¼š-180 - 180</li>
<li>æœ‰æ•ˆçº¬åº¦ï¼š-85.05112878 - 85.05112878</li>
</ul>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd china:city 115.94427 30.07033 huanggang</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 114.31589 30.55389 wuhan</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 116.28625 39.8585 beijing</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 121.49295 31.22337 shanghai</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 117.26104 31.85117 hefei</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 113.93029 22.53291 shenzhen</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 121.64465 38.91859 dalian</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 113.36112 23.12467 guangzhou</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<p>å®é™…åº”ç”¨ä¸­ï¼Œä¸€èˆ¬ä¼šæŠŠåŸå¸‚åœ°ç†æ•°æ®å†™åœ¨æ–‡ä»¶ä¸­ï¼Œç›´æ¥é€šè¿‡javaç¨‹åºä¸€æ¬¡æ€§å¯¼å…¥ã€‚</p>
<p>2ï¸âƒ£<strong>geopos</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>geoposç”¨äºä»ç»™å®šçš„keyé‡Œè¿”å›æ‰€æœ‰æŒ‡å®šåç§°(member)çš„ä½ç½®(ç»åº¦å’Œçº¬åº¦)ï¼Œä¸å­˜åœ¨çš„è¿”å›nilã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">geopos &lt;key&gt; member [member ...]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos china:city huanggang shenzhen shanghai </span><br><span class="line">1) 1) &quot;115.94427019357681274&quot;</span><br><span class="line">   2) &quot;30.07033115798519418&quot;</span><br><span class="line">2) 1) &quot;113.93029063940048218&quot;</span><br><span class="line">   2) &quot;22.53290942281488896&quot;</span><br><span class="line">3) 1) &quot;121.49295061826705933&quot;</span><br><span class="line">   2) &quot;31.22337074392616074&quot;</span><br></pre></td></tr></table></figure>



<p>3ï¸âƒ£<strong>geodist</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>geodistç”¨äºè®¡ç®—ä¸¤ä¸ªç»™å®šä½ç½®ä¹‹é—´çš„è·ç¦»ã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">geodist &lt;key&gt; member1 member2 [m|km|ft|mi]</span><br></pre></td></tr></table></figure>

<p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li>member1å’Œmember2ä¸ºä¸¤ä¸ªåœ°ç†ä½ç½®</li>
<li>mï¼šç±³ï¼Œé»˜è®¤ä½ç½®</li>
<li>kmï¼šåƒç±³</li>
<li>miï¼šè‹±é‡Œ</li>
<li>ftï¼šè‹±å°º</li>
</ul>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geodist china:city huanggang shenzhen</span><br><span class="line">&quot;862016.4959&quot;</span><br><span class="line">127.0.0.1:6379&gt; geodist china:city huanggang hefei km</span><br><span class="line">&quot;234.5308&quot;</span><br><span class="line">127.0.0.1:6379&gt; geodist china:city shanghai dalian mi</span><br><span class="line">&quot;531.9085&quot;</span><br></pre></td></tr></table></figure>



<p>4ï¸âƒ£<strong>georadius</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>ç»™å®šä¸€ä¸ªä¸­å¿ƒçš„åœ°ç†ä½ç½®(ç»åº¦å’Œçº¬åº¦)ï¼Œç»™å®šä¸€ä¸ªæœ€å¤§è·ç¦»ï¼Œè¿”å›ç»™å®šçš„keyåŒ…å«çš„ä½ç½®å…ƒç´ ä¸­ï¼Œä¸ä¸­å¿ƒçš„è·ç¦»ä¸è¶…è¿‡æœ€å¤§è·ç¦»çš„æ‰€æœ‰ä½ç½®å…ƒç´ ã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">georadius &lt;key&gt; longitude latitude radius m|km|ft|mi [withcoord] [withdist] [withhash] [count] [asc|desc] [store key] [storedist key]</span><br></pre></td></tr></table></figure>

<p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li><p>longitudeï¼šç»™å®šä¸­å¿ƒçš„ç»åº¦</p>
</li>
<li><p>latitudeï¼šç»™å®šä¸­å¿ƒçš„çº¬åº¦</p>
</li>
<li><p>radiusï¼šç»™å®šçš„æœ€å¤§è·ç¦»</p>
</li>
<li><p>withcoordï¼šè¿”å›+(ä½ç½®å…ƒç´ çš„ç»åº¦å’Œçº¬åº¦)</p>
</li>
<li><p>withdistï¼šè¿”å›+(ä½ç½®å…ƒç´ ä¸ä¸­å¿ƒä¹‹é—´çš„è·ç¦»)</p>
</li>
<li><p>withhashï¼šä»¥ 52 ä½æœ‰ç¬¦å·æ•´æ•°çš„å½¢å¼ï¼Œ è¿”å›ä½ç½®å…ƒç´ ç»è¿‡åŸå§‹ geohash ç¼–ç çš„æœ‰åºé›†åˆåˆ†å€¼ã€‚ è¿™ä¸ªé€‰é¡¹ä¸»è¦ç”¨äºåº•å±‚åº”ç”¨æˆ–è€…è°ƒè¯•ï¼Œ å®é™…ä¸­çš„ä½œç”¨å¹¶ä¸å¤§ã€‚</p>
</li>
<li><p>countï¼šé™å®šè¿”å›çš„è®°å½•æ•°é‡</p>
</li>
<li><p>ascï¼šæŸ¥æ‰¾ç»“æœæ ¹æ®è·ç¦»ä»å°åˆ°å¤§æ’åº</p>
</li>
<li><p>descï¼šæŸ¥æ‰¾ç»“æœæ ¹æ®è·ç¦»ä»å¤§åˆ°å°æ’åº</p>
</li>
</ul>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹è·ç¦»å¹¿å·ä¸å¤§äº1000kmçš„åŸå¸‚</span></span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 113.36112 23.12467 1000 km asc</span><br><span class="line">1) &quot;guangzhou&quot;</span><br><span class="line">2) &quot;shenzhen&quot;</span><br><span class="line">3) &quot;huanggang&quot;</span><br><span class="line">4) &quot;wuhan&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹è·ç¦»æ­¦æ±‰ä¸å¤§äº1000kmçš„åŸå¸‚ï¼Œä»å¤§åˆ°å°ï¼Œé™åˆ¶5ä¸ªï¼Œå¹¶ä¸”æ˜¾ç¤ºè·ç¦»å’ŒåŸå¸‚ç»çº¬åº¦</span></span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 114.31589 30.55389 1000 km withcoord withdist count 5 desc </span><br><span class="line">1) 1) &quot;shenzhen&quot;</span><br><span class="line">   2) &quot;892.9663&quot;</span><br><span class="line">   3) 1) &quot;113.93029063940048218&quot;</span><br><span class="line">      2) &quot;22.53290942281488896&quot;</span><br><span class="line">2) 1) &quot;guangzhou&quot;</span><br><span class="line">   2) &quot;831.7263&quot;</span><br><span class="line">   3) 1) &quot;113.36112052202224731&quot;</span><br><span class="line">      2) &quot;23.12467049411647935&quot;</span><br><span class="line">3) 1) &quot;shanghai&quot;</span><br><span class="line">   2) &quot;688.9652&quot;</span><br><span class="line">   3) 1) &quot;121.49295061826705933&quot;</span><br><span class="line">      2) &quot;31.22337074392616074&quot;</span><br><span class="line">4) 1) &quot;hefei&quot;</span><br><span class="line">   2) &quot;315.1437&quot;</span><br><span class="line">   3) 1) &quot;117.26104170083999634&quot;</span><br><span class="line">      2) &quot;31.85117048067123591&quot;</span><br><span class="line">5) 1) &quot;huanggang&quot;</span><br><span class="line">   2) &quot;165.3475&quot;</span><br><span class="line">   3) 1) &quot;115.94427019357681274&quot;</span><br><span class="line">      2) &quot;30.07033115798519418&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹è·ç¦»åŒ—äº¬ä¸å¤§äº1500kmçš„åŸå¸‚</span></span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 116.28625 39.8585 1500 km withdist asc</span><br><span class="line">1) 1) &quot;beijing&quot;</span><br><span class="line">   2) &quot;0.0002&quot;</span><br><span class="line">2) 1) &quot;dalian&quot;</span><br><span class="line">   2) &quot;472.2545&quot;</span><br><span class="line">3) 1) &quot;hefei&quot;</span><br><span class="line">   2) &quot;894.9324&quot;</span><br><span class="line">4) 1) &quot;wuhan&quot;</span><br><span class="line">   2) &quot;1050.2106&quot;</span><br><span class="line">5) 1) &quot;shanghai&quot;</span><br><span class="line">   2) &quot;1069.3051&quot;</span><br><span class="line">6) 1) &quot;huanggang&quot;</span><br><span class="line">   2) &quot;1089.1453&quot;</span><br></pre></td></tr></table></figure>



<p>5ï¸âƒ£<strong>georadiusbymember</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>georadiusbymember å’Œ georadiuså‘½ä»¤ä¸€æ ·ï¼Œ éƒ½å¯ä»¥æ‰¾å‡ºä½äºæŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ï¼Œ ä½†æ˜¯ georadiusbymember çš„ä¸­å¿ƒç‚¹æ˜¯åªèƒ½ä»keyä¸­çš„ä½ç½®å…ƒç´ é€‰ã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">georadiusbymember &lt;key&gt; member radius m|km|ft|mi [withcoord] [withdist] [withhash] [count] [asc|desc] [store key] [storedist key]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹è·ç¦»é»„å†ˆä¸å¤§äº900kmçš„åŸå¸‚</span></span><br><span class="line">127.0.0.1:6379&gt; georadiusbymember china:city huanggang 900 km withdist asc</span><br><span class="line">1) 1) &quot;huanggang&quot;</span><br><span class="line">   2) &quot;0.0000&quot;</span><br><span class="line">2) 1) &quot;wuhan&quot;</span><br><span class="line">   2) &quot;165.3475&quot;</span><br><span class="line">3) 1) &quot;hefei&quot;</span><br><span class="line">   2) &quot;234.5308&quot;</span><br><span class="line">4) 1) &quot;shanghai&quot;</span><br><span class="line">   2) &quot;546.1566&quot;</span><br><span class="line">5) 1) &quot;guangzhou&quot;</span><br><span class="line">   2) &quot;814.0494&quot;</span><br><span class="line">6) 1) &quot;shenzhen&quot;</span><br><span class="line">   2) &quot;862.0165&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹è·ç¦»æ·±åœ³ä¸å¤§äº2000kmçš„åŸå¸‚</span></span><br><span class="line">127.0.0.1:6379&gt; georadiusbymember china:city shenzhen 2000 km withdist desc</span><br><span class="line">1) 1) &quot;dalian&quot;</span><br><span class="line">   2) &quot;1964.1097&quot;</span><br><span class="line">2) 1) &quot;beijing&quot;</span><br><span class="line">   2) &quot;1939.8454&quot;</span><br><span class="line">3) 1) &quot;shanghai&quot;</span><br><span class="line">   2) &quot;1222.7809&quot;</span><br><span class="line">4) 1) &quot;hefei&quot;</span><br><span class="line">   2) &quot;1087.3585&quot;</span><br><span class="line">5) 1) &quot;wuhan&quot;</span><br><span class="line">   2) &quot;892.9663&quot;</span><br><span class="line">6) 1) &quot;huanggang&quot;</span><br><span class="line">   2) &quot;862.0165&quot;</span><br><span class="line">7) 1) &quot;guangzhou&quot;</span><br><span class="line">   2) &quot;87.9580&quot;</span><br><span class="line">8) 1) &quot;shenzhen&quot;</span><br><span class="line">   2) &quot;0.0000&quot;</span><br></pre></td></tr></table></figure>



<p>6ï¸âƒ£<strong>geohash</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>geohashç”¨äºè·å–ä¸€ä¸ªæˆ–å¤šä¸ªä½ç½®å…ƒç´ çš„geohashå€¼ã€‚</p>
<blockquote>
<p>å®è´¨</p>
</blockquote>
<p><strong>é™ç»´æ‰“å‡»</strong>ï¼šå°†äºŒç»´çš„ç»çº¬åº¦è½¬æ¢ä¸ºä¸€ç»´çš„å­—ç¬¦ä¸²</p>
<p>å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²è¶Šæ¥è¿‘ï¼Œé‚£ä¹ˆè·ç¦»è¶Šè¿‘ã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">geohash &lt;key&gt; member [member ...]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geohash china:city huanggang beijing hefei</span><br><span class="line">1) &quot;wt67n6hh3k0&quot;</span><br><span class="line">2) &quot;wx4dy0j0d40&quot;</span><br><span class="line">3) &quot;wtemhq6fs20&quot;</span><br></pre></td></tr></table></figure>



<p>7ï¸âƒ£<strong>Other</strong></p>
<blockquote>
<p>GEO</p>
</blockquote>
<p>GEOçš„åº•å±‚åŸç†å°±æ˜¯Sorted Setï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Sorted Setå‘½ä»¤æ¥æ“ä½œGEOã€‚</p>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹åœ°å›¾ä¸­å…¨éƒ¨å…ƒç´ </span></span><br><span class="line">127.0.0.1:6379&gt; zrange china:city 0 -1</span><br><span class="line">1) &quot;shenzhen&quot;</span><br><span class="line">2) &quot;guangzhou&quot;</span><br><span class="line">3) &quot;wuhan&quot;</span><br><span class="line">4) &quot;huanggang&quot;</span><br><span class="line">5) &quot;hefei&quot;</span><br><span class="line">6) &quot;shanghai&quot;</span><br><span class="line">7) &quot;beijing&quot;</span><br><span class="line">8) &quot;dalian&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç§»é™¤å¤§è¿è¿™ä¸ªåŸå¸‚</span></span><br><span class="line">127.0.0.1:6379&gt; zrem china:city dalian</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŒ‰ç…§åˆ†æ•°ç»™åŸå¸‚æ’å</span></span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore china:city -inf inf withscores</span><br><span class="line"> 1) &quot;shenzhen&quot;</span><br><span class="line"> 2) &quot;4046431599170567&quot;</span><br><span class="line"> 3) &quot;guangzhou&quot;</span><br><span class="line"> 4) &quot;4046534293000673&quot;</span><br><span class="line"> 5) &quot;wuhan&quot;</span><br><span class="line"> 6) &quot;4051938129491420&quot;</span><br><span class="line"> 7) &quot;huanggang&quot;</span><br><span class="line"> 8) &quot;4052334404505800&quot;</span><br><span class="line"> 9) &quot;hefei&quot;</span><br><span class="line">10) &quot;4052764524670284&quot;</span><br><span class="line">11) &quot;shanghai&quot;</span><br><span class="line">12) &quot;4054757680623470&quot;</span><br><span class="line">13) &quot;beijing&quot;</span><br><span class="line">14) &quot;4069146323276357&quot;</span><br></pre></td></tr></table></figure>



<h4 id="7-2-2-ğŸ“„HyperLogLog"><a href="#7-2-2-ğŸ“„HyperLogLog" class="headerlink" title="7.2.2 ğŸ“„HyperLogLog"></a>7.2.2 ğŸ“„HyperLogLog</h4><p>HyperLogLogï¼ŒRedisä¸­åŸºæ•°ç»Ÿè®¡çš„ç®—æ³•ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<p>å ç”¨å†…å­˜å›ºå®šä¸”è¾ƒå°ã€‚æ¯ä¸ªHyperLogLogé”®å ç”¨12KBå†…å­˜ï¼Œå¯ä»¥è®¡ç®—2^64^ä¸ªä¸åŒå…ƒç´ çš„åŸºæ•°ã€‚</p>
<blockquote>
<p>åŸºæ•°</p>
</blockquote>
<p>ä¸€ä¸ªæ•°æ®é›†ä¸­ä¸é‡å¤å…ƒç´ çš„æ•°é‡</p>
<blockquote>
<p>åº”ç”¨åœºæ™¯</p>
</blockquote>
<p>ç»Ÿè®¡ç½‘ç«™UV</p>
<p>ä¼ ç»Ÿæ–¹å¼ï¼šä½¿ç”¨setä¿å­˜ç”¨æˆ·idï¼Œsetçš„å…ƒç´ æ•°é‡å¯ä½œä¸ºæ ‡å‡†åˆ¤æ–­ã€‚</p>
<p>è¿™ä¸ªæ–¹å¼å¦‚æœä¿å­˜å¤§é‡çš„ç”¨æˆ·idï¼Œå°±ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œç›®çš„æ˜¯è®¡æ•°ï¼Œè€Œéä¿å­˜ç”¨æˆ·idã€‚</p>
<p>ä½¿ç”¨HyperLogLogä¼šæœ‰**0.81%**çš„é”™è¯¯ç‡ï¼Œè¿™ä¸ªåœ¨ç»Ÿè®¡UVä»»åŠ¡ä¸­æ˜¯å¯ä»¥æ¥å—çš„ã€‚</p>
<blockquote>
<p>æ“ä½œæ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">pfadd &lt;key&gt; element [element â€¦]</td>
<td align="center">æ·»åŠ æŒ‡å®šå…ƒç´ åˆ°HyperLogLogä¸­</td>
</tr>
<tr>
<td align="center">pfcount &lt;key&gt;</td>
<td align="center">è¿”å›ç»™å®šHyperLogLogçš„åŸºæ•°ä¼°ç®—å€¼</td>
</tr>
<tr>
<td align="center">pfmerge &lt;destkey&gt; &lt;key&gt; [keyâ€¦]</td>
<td align="center">å°†å¤šä¸ªHyperLogLogåˆå¹¶ä¸ºä¸€ä¸ªHyperLogLog</td>
</tr>
</tbody></table>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºç¬¬ä¸€ç»„å…ƒç´ </span></span><br><span class="line">127.0.0.1:6379&gt; pfadd hyper K H I G H N E S S </span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç»Ÿè®¡ç¬¬ä¸€ç»„å…ƒç´ åŸºæ•°</span></span><br><span class="line">127.0.0.1:6379&gt; pfcount hyper</span><br><span class="line">(integer) 7</span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºç¬¬äºŒç»„å…ƒç´ </span></span><br><span class="line">127.0.0.1:6379&gt; pfadd hyper2 P A R A K</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç»Ÿè®¡ç¬¬äºŒç»„å…ƒç´ åŸºæ•°</span></span><br><span class="line">127.0.0.1:6379&gt; pfcount hyper2</span><br><span class="line">(integer) 4</span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆå¹¶ä¸¤ç»„å…ƒç´ </span></span><br><span class="line">127.0.0.1:6379&gt; pfmerge hyper hyper hyper2</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç»Ÿè®¡æ‰€æœ‰å…ƒç´ åŸºæ•°</span></span><br><span class="line">127.0.0.1:6379&gt; pfcount hyper</span><br><span class="line">(integer) 10</span><br></pre></td></tr></table></figure>





<h4 id="7-1-3-ğŸ”³Bitmaps"><a href="#7-1-3-ğŸ”³Bitmaps" class="headerlink" title="7.1.3 ğŸ”³Bitmaps"></a>7.1.3 ğŸ”³Bitmaps</h4><p>Bitmapsï¼Œä½å›¾ï¼Œæ“ä½œäºŒè¿›åˆ¶ä½æ¥è¿›è¡Œè®°å½•ï¼Œåªæœ‰0å’Œ1ä¸¤ä¸ªçŠ¶æ€ã€‚</p>
<blockquote>
<p>åº”ç”¨åœºæ™¯</p>
</blockquote>
<p>ç»Ÿè®¡ç”¨æˆ·æ´»è·ƒåº¦ï¼Œæ‰“å¡ï¼Œä¸¤ä¸ªçŠ¶æ€çš„éƒ½å¯ä»¥ä½¿ç”¨Bitmapsã€‚</p>
<blockquote>
<p>æ“ä½œæ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">setbit &lt;key&gt; offset value</td>
<td align="center">è®¾ç½®å€¼</td>
</tr>
<tr>
<td align="center">getbit &lt;key&gt;  offset</td>
<td align="center">è·å–å€¼</td>
</tr>
<tr>
<td align="center">bitcount &lt;key&gt; start end</td>
<td align="center">è·å–BitmapsæŒ‡å®šèŒƒå›´å€¼ä¸º1çš„ä¸ªæ•°</td>
</tr>
<tr>
<td align="center">bitop and|or|not|xor &lt;destkey&gt; key [key â€¦]</td>
<td align="center">Bitmapsçš„é›†åˆè¿ç®—</td>
</tr>
</tbody></table>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æ‰“å¡ 0-6:å‘¨ä¸€-å‘¨æ—¥</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2020å¹´ç¬¬ä¸€å‘¨æ‰“å¡</span></span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:1 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:1 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:1 2 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:1 3 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:1 4 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:1 5 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:1 6 0</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2020å¹´ç¬¬äºŒå‘¨æ‰“å¡</span></span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:2 0 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:2 1 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:2 2 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:2 3 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:2 4 0</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:2 5 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit 2020:week:2 6 1</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ£€æŸ¥æ‰“å¡</span></span><br><span class="line">127.0.0.1:6379&gt; getbit 2020:week:1 3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit 2020:week:2 1</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç»Ÿè®¡æ‰“å¡</span></span><br><span class="line">127.0.0.1:6379&gt; bitcount 2020:week:1</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; bitcount 2020:week:2</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯¹ä¸¤å‘¨æ‰“å¡ç»“æœå–å¹¶é›†</span></span><br><span class="line">127.0.0.1:6379&gt; bitop and andres 2020:week:1 2020:week:2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bitcount andres</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯¹ä¸¤å‘¨æ‰“å¡ç»“æœå–äº¤é›†</span></span><br><span class="line">127.0.0.1:6379&gt; bitop or orres 2020:week:1 2020:week:2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bitcount orres</span><br><span class="line">(integer) 7</span><br></pre></td></tr></table></figure>



<h2 id="8-ğŸ“©Redisäº‹åŠ¡"><a href="#8-ğŸ“©Redisäº‹åŠ¡" class="headerlink" title="8. ğŸ“©Redisäº‹åŠ¡"></a>8. ğŸ“©Redisäº‹åŠ¡</h2><blockquote>
<p> ğŸ’¡ è¯´æ˜</p>
</blockquote>
<p>Rediså•æ¡å‘½ä»¤æ‰§è¡Œå…·æœ‰åŸå­æ€§ï¼Œä½†æ˜¯äº‹åŠ¡ä¸ä¿è¯åŸå­æ€§ã€‚</p>
<h3 id="8-1ğŸ“–å®šä¹‰"><a href="#8-1ğŸ“–å®šä¹‰" class="headerlink" title="8. 1ğŸ“–å®šä¹‰"></a>8. 1ğŸ“–å®šä¹‰</h3><p>ä¸€ç»„å‘½ä»¤çš„é˜Ÿåˆ—</p>
<h3 id="8-2-ğŸŒ ç‰¹å¾"><a href="#8-2-ğŸŒ ç‰¹å¾" class="headerlink" title="8.2 ğŸŒ ç‰¹å¾"></a>8.2 ğŸŒ ç‰¹å¾</h3><ul>
<li>ä¸€æ¬¡æ€§</li>
<li>é¡ºåºæ€§</li>
<li>æ’ä»–æ€§</li>
</ul>
<h3 id="8-3-â³ä¸‰ä¸ªé˜¶æ®µ"><a href="#8-3-â³ä¸‰ä¸ªé˜¶æ®µ" class="headerlink" title="8.3 â³ä¸‰ä¸ªé˜¶æ®µ"></a>8.3 â³ä¸‰ä¸ªé˜¶æ®µ</h3><ul>
<li>å¼€å§‹äº‹åŠ¡ (multi)</li>
<li>å‘½ä»¤å…¥é˜Ÿ (â€¦)</li>
<li>æ‰§è¡Œäº‹åŠ¡ (exec)</li>
</ul>
<h3 id="8-4-ğŸ“æ“ä½œæ–¹æ³•"><a href="#8-4-ğŸ“æ“ä½œæ–¹æ³•" class="headerlink" title="8.4 ğŸ“æ“ä½œæ–¹æ³•"></a>8.4 ğŸ“æ“ä½œæ–¹æ³•</h3><table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">discard</td>
<td align="center">å–æ¶ˆäº‹åŠ¡ï¼Œæ”¾å¼ƒæ‰§è¡Œäº‹åŠ¡å—å†…çš„æ‰€æœ‰å‘½ä»¤</td>
</tr>
<tr>
<td align="center">exec</td>
<td align="center">æ‰§è¡Œäº‹åŠ¡å—å†…çš„æ‰€æœ‰å‘½ä»¤</td>
</tr>
<tr>
<td align="center">multi</td>
<td align="center">æ ‡è®°ä¸€ä¸ªäº‹åŠ¡çš„å¼€å§‹</td>
</tr>
<tr>
<td align="center">unwatch</td>
<td align="center">å–æ¶ˆwatchå‘½ä»¤å¯¹æ‰€æœ‰keyçš„ç›‘è§†</td>
</tr>
<tr>
<td align="center">watch</td>
<td align="center">ç›‘è§†ä¸€ä¸ªæˆ–å¤šä¸ªkeyï¼Œå¦‚æœåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰è¿™ä¸ªæˆ–è¿™äº›keyè¢«å…¶ä»–å‘½ä»¤é”æ”¹åŠ¨ï¼Œé‚£ä¹ˆäº‹åŠ¡å°†è¢«æ‰“æ–­</td>
</tr>
</tbody></table>
<h3 id="8-5-ğŸ•µï¸å®ä¾‹"><a href="#8-5-ğŸ•µï¸å®ä¾‹" class="headerlink" title="8.5 ğŸ•µï¸å®ä¾‹"></a>8.5 ğŸ•µï¸å®ä¾‹</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¼€å¯äº‹åŠ¡</span></span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> å‘½ä»¤å…¥é˜Ÿ</span></span><br><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2 </span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; mget k1 k2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; getset k3 v3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get k3</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰§è¡Œäº‹åŠ¡</span></span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) 1) &quot;v1&quot;</span><br><span class="line">   2) &quot;v2&quot;</span><br><span class="line">4) &quot;v3&quot;</span><br><span class="line">5) &quot;v3&quot;</span><br></pre></td></tr></table></figure>



<h3 id="8-6-â­•å¼‚å¸¸"><a href="#8-6-â­•å¼‚å¸¸" class="headerlink" title="8.6 â­•å¼‚å¸¸"></a>8.6 â­•å¼‚å¸¸</h3><ul>
<li>å‘½ä»¤å¼‚å¸¸ï¼šå‘½ä»¤å­˜åœ¨é”™è¯¯ï¼Œæ‰€æœ‰å‘½ä»¤éƒ½ä¸ä¼šè¢«æ‰§è¡Œ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; getset k3 # é”™è¯¯å‘½ä»¤</span><br><span class="line">(error) ERR wrong number of arguments for &#x27;getset&#x27; command</span><br><span class="line">127.0.0.1:6379&gt; set k4 v4</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; exec # æ‰§è¡Œäº‹åŠ¡æŠ¥é”™</span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br><span class="line">127.0.0.1:6379&gt; get k1 # æ‰€æœ‰å‘½ä»¤éƒ½æœªè¢«æ‰§è¡Œ</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿è¡Œå¼‚å¸¸ï¼šé”™è¯¯æ“ä½œçš„å‘½ä»¤æŠ›å‡ºå¼‚å¸¸ï¼Œå…¶ä»–å‘½ä»¤æ­£å¸¸æ‰§è¡Œ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi </span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incr k1 # é”™è¯¯æ“ä½œ</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; exec # æ‰§è¡Œäº‹åŠ¡ä»…é”™è¯¯æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œå…¶ä»–å‘½ä»¤æ‰§è¡ŒæˆåŠŸ</span><br><span class="line">1) OK</span><br><span class="line">2) (error) ERR value is not an integer or out of range</span><br><span class="line">3) OK</span><br><span class="line">127.0.0.1:6379&gt; mget k1 k2</span><br><span class="line">1) &quot;v1&quot;</span><br><span class="line">2) &quot;v2&quot;</span><br></pre></td></tr></table></figure>



<h3 id="9-7-ğŸ”­ç›‘æ§"><a href="#9-7-ğŸ”­ç›‘æ§" class="headerlink" title="9.7 ğŸ”­ç›‘æ§"></a>9.7 ğŸ”­ç›‘æ§</h3><ul>
<li>æ‚²è§‚é”ï¼šå¾ˆæ‚²è§‚ï¼Œè®¤ä¸ºä»€ä¹ˆæ—¶å€™éƒ½ä¼šå‡ºé—®é¢˜ï¼Œæ— è®ºåšä»€ä¹ˆéƒ½ä¼šåŠ é”ã€‚</li>
<li>ä¹è§‚é”ï¼šå¾ˆä¹è§‚ï¼Œè®¤ä¸ºä»€ä¹ˆæ—¶å€™éƒ½ä¸ä¼šå‡ºé—®é¢˜ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ã€‚æ›´æ–°æ•°æ®çš„æ—¶å€™ä¼šæ¯”è¾ƒversionï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦æ›´æ–°è¿‡ã€‚</li>
<li>watchçš„æœ¬è´¨ï¼šselect versionï¼Œä¸€æ—¦å‘ç°ç›‘è§†çš„æ•°æ®versionæ”¹å˜ï¼Œäº‹åŠ¡å°†è¢«æ‰“æ–­ã€‚</li>
</ul>
<blockquote>
<p>å®ä¾‹1-watchçš„ç›‘æ§æµ‹è¯•</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä¸ªäººè´¢åŠ¡</span></span><br><span class="line">127.0.0.1:6379&gt; set money 100</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸ªäººæ”¯å‡º</span></span><br><span class="line">127.0.0.1:6379&gt; set out 0</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç›‘æ§è´¢åŠ¡</span></span><br><span class="line">127.0.0.1:6379&gt; watch money </span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¼€å¯äº‹åŠ¡</span></span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¶ˆè´¹10å…ƒ</span></span><br><span class="line">127.0.0.1:6379&gt; decrby money 30</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ”¯å‡ºå¢åŠ </span></span><br><span class="line">127.0.0.1:6379&gt; incrby out 30</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰§è¡Œäº‹åŠ¡</span></span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">1) (integer) 70</span><br><span class="line">2) (integer) 30</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å®ä¾‹2-watchçš„å¤šçº¿ç¨‹æµ‹è¯•ï¼Œwatchå¯ä»¥å½“åšredisçš„ä¹è§‚é”æ“ä½œ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> çº¿ç¨‹1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç›‘æ§è´¢åŠ¡</span></span><br><span class="line">127.0.0.1:6379&gt; watch money</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¶ˆè´¹10å…ƒ</span></span><br><span class="line">127.0.0.1:6379&gt; decrby money 10</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ”¯å‡ºå¢åŠ </span></span><br><span class="line">127.0.0.1:6379&gt; incrby out 10</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰§è¡Œä¹‹å‰çº¿ç¨‹2ä¿®æ”¹äº†è´¢åŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå¯¼è‡´äº‹åŠ¡æ‰§è¡Œå¤±è´¥</span></span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">(nil)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> çº¿ç¨‹2 </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰§è¡Œåœ¨çº¿ç¨‹1çš„äº‹åŠ¡<span class="built_in">exec</span>ä¹‹å‰</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥è¯¢è´¢åŠ¡</span></span><br><span class="line">127.0.0.1:6379&gt; get money</span><br><span class="line">&quot;70&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> å……å€¼1000</span></span><br><span class="line">127.0.0.1:6379&gt; incrby money 1000</span><br><span class="line">(integer) 1070</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> çº¿ç¨‹1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰§è¡Œåœ¨çº¿ç¨‹1çš„äº‹åŠ¡<span class="built_in">exec</span>ä¹‹å</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1ã€å¦‚æœå‘ç°äº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œå°±å…ˆè§£é”</span></span><br><span class="line">127.0.0.1:6379&gt; unwatch </span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2ã€è·å–æœ€æ–°çš„å€¼ï¼Œå†æ¬¡ç›‘è§†</span></span><br><span class="line">127.0.0.1:6379&gt; watch money</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; decrby money 50</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incrby out 50</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3ã€å¯¹æ¯”ç›‘è§†çš„å€¼æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆå¯ä»¥æ‰§è¡ŒæˆåŠŸï¼Œå¦åˆ™æ‰§è¡Œå¤±è´¥</span></span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">1) (integer) 1020</span><br><span class="line">2) (integer) 80</span><br></pre></td></tr></table></figure>



<h2 id="9-ğŸ“©Jedis"><a href="#9-ğŸ“©Jedis" class="headerlink" title="9. ğŸ“©Jedis"></a>9. ğŸ“©Jedis</h2><blockquote>
<p>ğŸ“¢ è¯´æ˜</p>
</blockquote>
<p>Jedisæ˜¯Rediså®˜æ–¹æ¨èçš„Javaè¿æ¥å¼€å‘å·¥å…·ã€‚</p>
<p>Jedisä¸­çš„æ‰€æœ‰apiå°±å¯¹åº”Redisä¸­çš„æ‰€æœ‰å‘½ä»¤ã€‚</p>
<h3 id="9-1-â•å¯¼å…¥ä¾èµ–"><a href="#9-1-â•å¯¼å…¥ä¾èµ–" class="headerlink" title="9.1 â•å¯¼å…¥ä¾èµ–"></a>9.1 â•å¯¼å…¥ä¾èµ–</h3><blockquote>
<p>pom.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>top.parak<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">developers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">developer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>KHighness<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">email</span>&gt;</span>parakovo@gmail.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">developer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">developers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fastjson.version</span>&gt;</span>1.2.68<span class="tag">&lt;/<span class="name">fastjson.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jackson.version</span>&gt;</span>2.11.0<span class="tag">&lt;/<span class="name">jackson.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jedis.version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">jedis.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Springboot-Web  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Spring Test --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Springboot-Aop  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Springboot-Redis  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- SpringCloud-Context --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Fastjson --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;fastjson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Jackson --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Jedis --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jedis.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="9-2-âŒ¨ï¸ç¼–ç æµ‹è¯•"><a href="#9-2-âŒ¨ï¸ç¼–ç æµ‹è¯•" class="headerlink" title="9.2 âŒ¨ï¸ç¼–ç æµ‹è¯•"></a>9.2 âŒ¨ï¸ç¼–ç æµ‹è¯•</h3><h4 id="9-2-1-ğŸ…¿Pingæµ‹è¯•"><a href="#9-2-1-ğŸ…¿Pingæµ‹è¯•" class="headerlink" title="9.2.1 ğŸ…¿Pingæµ‹è¯•"></a>9.2.1 ğŸ…¿Pingæµ‹è¯•</h4><blockquote>
<p>Ping.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/11 17:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: æµ‹è¯•é“¾æ¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Ping</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        log.info(jedis.ping());</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">17:52:31.303 [main] INFO top.parak.jedis.Ping - PONG</span><br></pre></td></tr></table></figure>



<h4 id="9-2-1-âšªGEO-apiæµ‹è¯•"><a href="#9-2-1-âšªGEO-apiæµ‹è¯•" class="headerlink" title="9.2.1 âšªGEO-apiæµ‹è¯•"></a>9.2.1 âšªGEO-apiæµ‹è¯•</h4><blockquote>
<p>city.txt</p>
</blockquote>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">huanggang    115.94427    30.07033</span><br><span class="line">wuhan        114.31589    30.55389</span><br><span class="line">beijing      116.28625    39.8585</span><br><span class="line">shanghai     121.49295    31.22337</span><br><span class="line">hefei        117.26104    31.85117</span><br><span class="line">shenzhen     113.93029    22.53291</span><br><span class="line">dalian       121.64465    38.91859</span><br><span class="line">guangzhou    113.36112    23.12467</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Geo.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.ResourceUtils;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.GeoCoordinate;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.GeoUnit;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.params.GeoRadiusParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.FileChannel;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/11 17:59</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: æµ‹è¯•Geospatial</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Geo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»å–æ–‡ä»¶å°†åœ°ç†æ•°æ®å†™è¿›redis</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">readAndWriteIntoRedis</span><span class="params">(String path, Jedis jedis)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(path);</span><br><span class="line">        FileChannel channel = fileInputStream.getChannel();</span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">512</span>);</span><br><span class="line">        channel.read(byteBuffer);</span><br><span class="line">        String[] res = <span class="keyword">new</span> String(byteBuffer.array()).split(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        Map&lt;String, GeoCoordinate&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Arrays.stream(res).forEach(s -&gt; &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨æ­£åˆ™\s+åŒ¹é…å¤šä¸ªç©ºæ ¼ï¼Œåˆ†å‰²å­—ç¬¦ä¸²</span></span><br><span class="line">            String[] ss = s.split(<span class="string">&quot;\\s+&quot;</span>);</span><br><span class="line">            map.put(ss[<span class="number">0</span>], <span class="keyword">new</span> GeoCoordinate(Double.valueOf(ss[<span class="number">1</span>]), Double.valueOf(ss[<span class="number">2</span>])));</span><br><span class="line">        &#125;);</span><br><span class="line">        jedis.geoadd(<span class="string">&quot;china:city&quot;</span>, map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        readAndWriteIntoRedis(ResourceUtils.getFile(<span class="string">&quot;src/main/resources/city.txt&quot;</span>).getAbsolutePath(), jedis);</span><br><span class="line">        log.info(<span class="string">&quot;==========åœ°å›¾ä¸­çš„æ‰€æœ‰åŸå¸‚==========&quot;</span>);</span><br><span class="line">        jedis.zrange(<span class="string">&quot;china:city&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>).stream().forEach(s -&gt; &#123; log.info(s + <span class="string">&quot; &quot;</span>); &#125;);</span><br><span class="line">        log.info(<span class="string">&quot;==========æŸ¥è¯¢é»„å†ˆçš„ç»çº¬åº¦==========&quot;</span>);</span><br><span class="line">        log.info(jedis.geopos(<span class="string">&quot;china:city&quot;</span>, <span class="string">&quot;huanggang&quot;</span>));</span><br><span class="line">        log.info(<span class="string">&quot;==========æŸ¥è¯¢è·ç¦»æ­å·ä¸è¶…è¿‡1000kmçš„åŸå¸‚==========&quot;</span>);</span><br><span class="line">        GeoRadiusParam geoRadiusParam = <span class="keyword">new</span> GeoRadiusParam();</span><br><span class="line">        geoRadiusParam.withCoord().withDist().sortAscending();</span><br><span class="line">        jedis.georadius(<span class="string">&quot;china:city&quot;</span>, <span class="number">120.153576</span>, <span class="number">30.287459</span>, <span class="number">1000</span>, GeoUnit.KM, geoRadiusParam).forEach( c -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">&quot;åŸå¸‚åç§°ï¼š&#123;&#125;, ç»çº¬åº¦ï¼š&#123;&#125;ï¼Œè·ç¦»ï¼š&#123;&#125;KM&quot;</span>, c.getMemberByString(), c.getCoordinate(), c.getDistance());</span><br><span class="line">        &#125;);</span><br><span class="line">        log.info(<span class="string">&quot;==========æŸ¥è¯¢è·ç¦»æ­¦æ±‰ä¸è¶…è¿‡1000KMçš„åŸå¸‚==========&quot;</span>);</span><br><span class="line">        jedis.georadiusByMember(<span class="string">&quot;china:city&quot;</span>, <span class="string">&quot;wuhan&quot;</span>, <span class="number">1000</span>, GeoUnit.KM, geoRadiusParam).forEach( c -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">&quot;åŸå¸‚åç§°ï¼š&#123;&#125;, ç»çº¬åº¦ï¼š&#123;&#125;ï¼Œè·ç¦»ï¼š&#123;&#125;KM&quot;</span>, c.getMemberByString(), c.getCoordinate(), c.getDistance());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">20:21:02.671 [main] INFO top.parak.jedis.Geo - ==========åœ°å›¾ä¸­çš„æ‰€æœ‰åŸå¸‚==========</span><br><span class="line">20:21:02.718 [main] INFO top.parak.jedis.Geo - shenzhen </span><br><span class="line">20:21:02.718 [main] INFO top.parak.jedis.Geo - guangzhou </span><br><span class="line">20:21:02.718 [main] INFO top.parak.jedis.Geo - wuhan </span><br><span class="line">20:21:02.718 [main] INFO top.parak.jedis.Geo - huanggang </span><br><span class="line">20:21:02.718 [main] INFO top.parak.jedis.Geo - hefei </span><br><span class="line">20:21:02.718 [main] INFO top.parak.jedis.Geo - shanghai </span><br><span class="line">20:21:02.718 [main] INFO top.parak.jedis.Geo - beijing </span><br><span class="line">20:21:02.718 [main] INFO top.parak.jedis.Geo - dalian </span><br><span class="line">20:21:02.718 [main] INFO top.parak.jedis.Geo - ==========æŸ¥è¯¢é»„å†ˆçš„ç»çº¬åº¦==========</span><br><span class="line">20:21:02.720 [main] INFO top.parak.jedis.Geo - [(115.94427019357681,30.070331157985194)]</span><br><span class="line">20:21:02.721 [main] INFO top.parak.jedis.Geo - ==========æŸ¥è¯¢è·ç¦»æ­å·ä¸è¶…è¿‡1000kmçš„åŸå¸‚==========</span><br><span class="line">20:21:02.724 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šshanghai, ç»çº¬åº¦ï¼š(121.49295061826706,31.22337074392616)ï¼Œè·ç¦»ï¼š165.0KM</span><br><span class="line">20:21:02.724 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šhefei, ç»çº¬åº¦ï¼š(117.26104170084,31.851170480671236)ï¼Œè·ç¦»ï¼š325.8468KM</span><br><span class="line">20:21:02.725 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šhuanggang, ç»çº¬åº¦ï¼š(115.94427019357681,30.070331157985194)ï¼Œè·ç¦»ï¼š405.4241KM</span><br><span class="line">20:21:02.725 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šwuhan, ç»çº¬åº¦ï¼š(114.31589037179947,30.55389005243692)ï¼Œè·ç¦»ï¼š560.6357KM</span><br><span class="line">20:21:02.725 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šdalian, ç»çº¬åº¦ï¼š(121.64465099573135,38.91858901014995)ï¼Œè·ç¦»ï¼š969.6213KM</span><br><span class="line">20:21:02.725 [main] INFO top.parak.jedis.Geo - ==========æŸ¥è¯¢è·ç¦»æ­¦æ±‰ä¸è¶…è¿‡1000KMçš„åŸå¸‚==========</span><br><span class="line">20:21:02.725 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šwuhan, ç»çº¬åº¦ï¼š(114.31589037179947,30.55389005243692)ï¼Œè·ç¦»ï¼š0.0KM</span><br><span class="line">20:21:02.725 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šhuanggang, ç»çº¬åº¦ï¼š(115.94427019357681,30.070331157985194)ï¼Œè·ç¦»ï¼š165.3475KM</span><br><span class="line">20:21:02.726 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šhefei, ç»çº¬åº¦ï¼š(117.26104170084,31.851170480671236)ï¼Œè·ç¦»ï¼š315.1437KM</span><br><span class="line">20:21:02.726 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šshanghai, ç»çº¬åº¦ï¼š(121.49295061826706,31.22337074392616)ï¼Œè·ç¦»ï¼š688.9652KM</span><br><span class="line">20:21:02.726 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šguangzhou, ç»çº¬åº¦ï¼š(113.36112052202225,23.12467049411648)ï¼Œè·ç¦»ï¼š831.7263KM</span><br><span class="line">20:21:02.726 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šshenzhen, ç»çº¬åº¦ï¼š(113.93029063940048,22.53290942281489)ï¼Œè·ç¦»ï¼š892.9663KM</span><br></pre></td></tr></table></figure>



<h4 id="9-2-2-âš«Hyper-apiæµ‹è¯•"><a href="#9-2-2-âš«Hyper-apiæµ‹è¯•" class="headerlink" title="9.2.2 âš«Hyper-apiæµ‹è¯•"></a>9.2.2 âš«Hyper-apiæµ‹è¯•</h4><blockquote>
<p>Hyper.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/11 20:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: æµ‹è¯•hyper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hyper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.pfadd(<span class="string">&quot;hyper1&quot;</span>, <span class="string">&quot;K&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;I&quot;</span>, <span class="string">&quot;G&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;N&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;S&quot;</span>, <span class="string">&quot;S&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;hyper1ä¸­çš„å…ƒç´ åŸºæ•°ï¼š&#123;&#125;&quot;</span>, jedis.pfcount(<span class="string">&quot;hyper1&quot;</span>));</span><br><span class="line">        jedis.pfadd(<span class="string">&quot;hyper2&quot;</span>, <span class="string">&quot;P&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;R&quot;</span>, <span class="string">&quot;A&quot;</span>, <span class="string">&quot;K&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;hyper2ä¸­çš„å…ƒç´ åŸºæ•°ï¼š&#123;&#125;&quot;</span>, jedis.pfcount(<span class="string">&quot;hyper2&quot;</span>));</span><br><span class="line">        jedis.pfmerge(<span class="string">&quot;hyper&quot;</span>, <span class="string">&quot;hyper1&quot;</span>, <span class="string">&quot;hyper2&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;hyper1å’Œhyper2åˆå¹¶åçš„å…ƒç´ åŸºæ•°ï¼š&#123;&#125;&quot;</span>, jedis.pfcount(<span class="string">&quot;hyper&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">20:36:20.386 [main] INFO top.parak.jedis.Hyper - hyper1ä¸­çš„å…ƒç´ åŸºæ•°ï¼š7</span><br><span class="line">20:36:20.390 [main] INFO top.parak.jedis.Hyper - hyper2ä¸­çš„å…ƒç´ åŸºæ•°ï¼š4</span><br><span class="line">20:36:20.390 [main] INFO top.parak.jedis.Hyper - hyper1å’Œhyper2åˆå¹¶åçš„å…ƒç´ åŸºæ•°ï¼š10</span><br></pre></td></tr></table></figure>



<h4 id="9-2-3-ğŸ”´Bitmaps-apiæµ‹è¯•"><a href="#9-2-3-ğŸ”´Bitmaps-apiæµ‹è¯•" class="headerlink" title="9.2.3 ğŸ”´Bitmaps-apiæµ‹è¯•"></a>9.2.3 ğŸ”´Bitmaps-apiæµ‹è¯•</h4><blockquote>
<p>Bit.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.BitOP;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/11 20:38</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: æµ‹è¯•Bitmaps</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getChineseExpression</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">return</span> <span class="string">&quot;æ˜ŸæœŸä¸€&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">return</span> <span class="string">&quot;æ˜ŸæœŸäºŒ&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>: <span class="keyword">return</span> <span class="string">&quot;æ˜ŸæœŸä¸‰&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>: <span class="keyword">return</span> <span class="string">&quot;æ˜ŸæœŸå››&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>: <span class="keyword">return</span> <span class="string">&quot;æ˜ŸæœŸäº”&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>: <span class="keyword">return</span> <span class="string">&quot;æ˜ŸæœŸå…­&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>: <span class="keyword">return</span> <span class="string">&quot;æ˜ŸæœŸæ—¥&quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">return</span> <span class="string">&quot;Error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿä¸¤å‘¨çš„æ‰“å¡æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">boolean</span>[] bool1 = <span class="keyword">new</span> <span class="keyword">boolean</span>[]&#123;<span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>&#125;;</span><br><span class="line">        <span class="keyword">boolean</span>[] bool2 = <span class="keyword">new</span> <span class="keyword">boolean</span>[]&#123;<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bool1.length; i++) &#123; jedis.setbit(<span class="string">&quot;2020:week:1&quot;</span>, i, bool1[i]); &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bool2.length; i++) &#123; jedis.setbit(<span class="string">&quot;2020:week:2&quot;</span>, i, bool2[i]); &#125;</span><br><span class="line">        log.info(<span class="string">&quot;2020å¹´ç¬¬ä¸€å‘¨çš„æ‰“å¡å¤©æ•°ï¼š&#123;&#125;&quot;</span>, jedis.bitcount(<span class="string">&quot;2020:week:1&quot;</span>));</span><br><span class="line">        log.info(<span class="string">&quot;2020å¹´ç¬¬ä¸€å‘¨å…·ä½“æ‰“å¡æƒ…å†µ&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bool1.length; i++) &#123; log.info(getChineseExpression(i) + <span class="string">&quot;: &quot;</span> + (jedis.getbit(<span class="string">&quot;2020:week:1&quot;</span>, i) ? <span class="string">&quot;å·²æ‰“å¡&quot;</span> : <span class="string">&quot;æœªæ‰“å¡&quot;</span>)); &#125;</span><br><span class="line">        log.info(<span class="string">&quot;2020å¹´ç¬¬äºŒå‘¨çš„æ‰“å¡å¤©æ•°ï¼š&#123;&#125;&quot;</span>, jedis.bitcount(<span class="string">&quot;2020:week:2&quot;</span>));</span><br><span class="line">        log.info(<span class="string">&quot;2020å¹´ç¬¬äºŒå‘¨å…·ä½“æ‰“å¡æƒ…å†µ&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bool2.length; i++) &#123; log.info(getChineseExpression(i) + <span class="string">&quot;: &quot;</span> + (jedis.getbit(<span class="string">&quot;2020:week:2&quot;</span>, i) ? <span class="string">&quot;å·²æ‰“å¡&quot;</span> : <span class="string">&quot;æœªæ‰“å¡&quot;</span>)); &#125;</span><br><span class="line">        jedis.bitop(BitOP.AND, <span class="string">&quot;2020:week:1and2&quot;</span>, <span class="string">&quot;2020:week:1&quot;</span>, <span class="string">&quot;2020:week:2&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨ä¸¤å¤©éƒ½æ‰“å¡çš„å¤©æ•°ï¼š&#123;&#125;&quot;</span>, jedis.bitcount(<span class="string">&quot;2020:week:1and2&quot;</span>));</span><br><span class="line">        jedis.bitop(BitOP.OR, <span class="string">&quot;2020:week:1or2&quot;</span>, <span class="string">&quot;2020:week:1&quot;</span>, <span class="string">&quot;2020:week:2&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨è‡³å°‘æœ‰ä¸€å¤©æ‰“å¡çš„å¤©æ•°ï¼š&#123;&#125;&quot;</span>, jedis.bitcount(<span class="string">&quot;2020:week:1or2&quot;</span>));</span><br><span class="line">        jedis.bitop(BitOP.XOR,<span class="string">&quot;2020:week:1xor2&quot;</span>, <span class="string">&quot;2020:week:1&quot;</span>, <span class="string">&quot;2020:week:2&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨ä»…æœ‰ä¸€å¤©æ‰“å¡çš„å¤©æ•°ï¼š&#123;&#125;&quot;</span>, jedis.bitcount(<span class="string">&quot;2020:week:1xor2&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">21:07:40.042 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬ä¸€å‘¨çš„æ‰“å¡å¤©æ•°ï¼š5</span><br><span class="line">21:07:40.046 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬ä¸€å‘¨å…·ä½“æ‰“å¡æƒ…å†µ</span><br><span class="line">21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸä¸€: å·²æ‰“å¡</span><br><span class="line">21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸäºŒ: å·²æ‰“å¡</span><br><span class="line">21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸä¸‰: å·²æ‰“å¡</span><br><span class="line">21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸå››: å·²æ‰“å¡</span><br><span class="line">21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸäº”: å·²æ‰“å¡</span><br><span class="line">21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸå…­: æœªæ‰“å¡</span><br><span class="line">21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸæ—¥: æœªæ‰“å¡</span><br><span class="line">21:07:40.047 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬äºŒå‘¨çš„æ‰“å¡å¤©æ•°ï¼š3</span><br><span class="line">21:07:40.047 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬äºŒå‘¨å…·ä½“æ‰“å¡æƒ…å†µ</span><br><span class="line">21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸä¸€: æœªæ‰“å¡</span><br><span class="line">21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸäºŒ: æœªæ‰“å¡</span><br><span class="line">21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸä¸‰: æœªæ‰“å¡</span><br><span class="line">21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸå››: å·²æ‰“å¡</span><br><span class="line">21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸäº”: å·²æ‰“å¡</span><br><span class="line">21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸå…­: å·²æ‰“å¡</span><br><span class="line">21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸæ—¥: æœªæ‰“å¡</span><br><span class="line">21:07:40.048 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨ä¸¤å¤©éƒ½æ‰“å¡çš„å¤©æ•°ï¼š2</span><br><span class="line">21:07:40.048 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨è‡³å°‘æœ‰ä¸€å¤©æ‰“å¡çš„å¤©æ•°ï¼š6</span><br><span class="line">21:07:40.048 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨ä»…æœ‰ä¸€å¤©æ‰“å¡çš„å¤©æ•°ï¼š4</span><br></pre></td></tr></table></figure>



<h4 id="9-2-4-ğŸ”µäº‹åŠ¡æµ‹è¯•"><a href="#9-2-4-ğŸ”µäº‹åŠ¡æµ‹è¯•" class="headerlink" title="9.2.4 ğŸ”µäº‹åŠ¡æµ‹è¯•"></a>9.2.4 ğŸ”µäº‹åŠ¡æµ‹è¯•</h4><blockquote>
<p>Affair.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Transaction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/11 21:33</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: æµ‹è¯•äº‹åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Affair</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºjsonæ•°æ®</span></span><br><span class="line">        JSONObject jsonObject1 = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        jsonObject1.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">        jsonObject1.put(<span class="string">&quot;age&quot;</span>, <span class="number">19</span>);</span><br><span class="line">        jsonObject1.put(<span class="string">&quot;constellation&quot;</span>, <span class="string">&quot;Virgo&quot;</span>);</span><br><span class="line">        jsonObject1.put(<span class="string">&quot;Hobby&quot;</span>, <span class="string">&quot;Jay&quot;</span>);</span><br><span class="line">        String json1 = jsonObject1.toJSONString();</span><br><span class="line">        JSONObject jsonObject2 = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        jsonObject2.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;BingYao&quot;</span>);</span><br><span class="line">        jsonObject2.put(<span class="string">&quot;age&quot;</span>, <span class="number">16</span>);</span><br><span class="line">        jsonObject2.put(<span class="string">&quot;constellation&quot;</span>, <span class="string">&quot;Taurus&quot;</span>);</span><br><span class="line">        jsonObject2.put(<span class="string">&quot;Hobby&quot;</span>, <span class="string">&quot;Czk&quot;</span>);</span><br><span class="line">        String json2 = jsonObject2.toJSONString();</span><br><span class="line">        jedis.set(<span class="string">&quot;user1&quot;</span>, json1);</span><br><span class="line">        jedis.set(<span class="string">&quot;user2&quot;</span>, json2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ å…¥ä¹è§‚é”</span></span><br><span class="line">        jedis.watch(<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;user2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¼€å¯äº‹åŠ¡</span></span><br><span class="line">        Transaction multi = jedis.multi();</span><br><span class="line">        <span class="keyword">new</span> Thread( () -&gt; &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">               multi.set(<span class="string">&quot;user1&quot;</span>, json1);</span><br><span class="line">               multi.set(<span class="string">&quot;user2&quot;</span>, json2);</span><br><span class="line">               <span class="comment">// æ‰§è¡Œäº‹åŠ¡</span></span><br><span class="line">               multi.exec();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               <span class="comment">// å‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line">               <span class="comment">// æ”¾å¼ƒäº‹åŠ¡</span></span><br><span class="line">               multi.discard();</span><br><span class="line">               log.info(e.getMessage());</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               <span class="comment">// è¾“å‡ºæ•°æ®</span></span><br><span class="line">               log.info(<span class="string">&quot;user1: [&#123;&#125;]&quot;</span>, jedis.get(<span class="string">&quot;user1&quot;</span>));</span><br><span class="line">               log.info(<span class="string">&quot;user2: [&#123;&#125;]&quot;</span>, jedis.get(<span class="string">&quot;user2&quot;</span>));</span><br><span class="line">               jedis.close();</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;Multi&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦ä¸€çº¿ç¨‹</span></span><br><span class="line">        <span class="comment">// å¼€å¯åœ¨äº‹åŠ¡ä¹‹å‰</span></span><br><span class="line">        <span class="keyword">new</span> Thread( () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">new</span> Affair().resetInfo1(jedis);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                log.info(e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;Other&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resetInfo1</span><span class="params">(Jedis jedis)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        JSONObject jsonObject1 = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        jsonObject1.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">        jsonObject1.put(<span class="string">&quot;age&quot;</span>, <span class="number">20</span>);</span><br><span class="line">        jsonObject1.put(<span class="string">&quot;constellation&quot;</span>, <span class="string">&quot;Leo&quot;</span>);</span><br><span class="line">        jsonObject1.put(<span class="string">&quot;Hobby&quot;</span>, <span class="string">&quot;BingYao&quot;</span>);</span><br><span class="line">        String json1 = jsonObject1.toJSONString();</span><br><span class="line">        jedis.set(<span class="string">&quot;user1&quot;</span>, json1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Exception in thread &quot;Other&quot; redis.clients.jedis.exceptions.JedisDataException: Cannot use Jedis when in Multi. Please use Transaction or reset jedis state.</span><br><span class="line">	at redis.clients.jedis.BinaryJedis.checkIsInMultiOrPipeline(BinaryJedis.java:1895)</span><br><span class="line">	at redis.clients.jedis.Jedis.set(Jedis.java:152)</span><br><span class="line">	at top.parak.jedis.Affair.resetInfo1(Affair.java:82)</span><br><span class="line">	at top.parak.jedis.Affair.lambda$main$1(Affair.java:66)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">22:05:18.651 [Multi] INFO top.parak.jedis.Affair - user1: [&#123;&quot;constellation&quot;:&quot;Virgo&quot;,&quot;name&quot;:&quot;KHighness&quot;,&quot;Hobby&quot;:&quot;Jay&quot;,&quot;age&quot;:19&#125;]</span><br><span class="line">22:05:18.654 [Multi] INFO top.parak.jedis.Affair - user2: [&#123;&quot;constellation&quot;:&quot;Taurus&quot;,&quot;name&quot;:&quot;BingYao&quot;,&quot;Hobby&quot;:&quot;Czk&quot;,&quot;age&quot;:16&#125;]</span><br></pre></td></tr></table></figure>



<h2 id="10-ğŸ“©Springbootæ•´åˆ"><a href="#10-ğŸ“©Springbootæ•´åˆ" class="headerlink" title="10. ğŸ“©Springbootæ•´åˆ"></a>10. ğŸ“©Springbootæ•´åˆ</h2><blockquote>
<p>âš ï¸notice</p>
</blockquote>
<p>åœ¨SpringBoot2.Xä¹‹åï¼ŒåŸæ¥ä½¿ç”¨çš„jedisè¢«æ›¿æ¢ä¸ºäº†lettuceï¼Œåœ¨windowsä¸‹lettuceè¿æ¥æ± ä»…æ”¯æŒ3.2.100ç‰ˆæœ¬çš„Redis</p>
<ul>
<li><p>jedisï¼šé‡‡ç”¨çš„ç›´è¿ï¼Œå¤šä¸ªçº¿ç¨‹æ“ä½œçš„è¯ï¼Œæ˜¯ä¸å®‰å…¨çš„ï¼Œå¦‚æœæƒ³è¦é¿å…ä¸å®‰å…¨ï¼Œéœ€è¦ä½¿ç”¨jedis poolè¿æ¥æ± ï¼Œæ›´åƒBIOæ¨¡å¼</p>
</li>
<li><p>lettuceï¼šåº•å±‚æ•´åˆNettyï¼Œå®ä¾‹å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«ï¼Œä¸å­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µï¼Œå¯ä»¥å‡å°‘çº¿ç¨‹æ•°æ®ï¼Œæ›´åƒNIOæ¨¡å¼</p>
</li>
</ul>
<h3 id="10-1-ğŸ”æºç åˆ†æ"><a href="#10-1-ğŸ”æºç åˆ†æ" class="headerlink" title="10.1 ğŸ”æºç åˆ†æ"></a>10.1 ğŸ”æºç åˆ†æ</h3><blockquote>
<p>è‡ªåŠ¨é…ç½®ç±»ï¼šRedisAutoConfiguration.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(</span></span><br><span class="line"><span class="meta">    proxyBeanMethods = false</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;RedisOperations.class&#125;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;RedisProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Import(&#123;LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisAutoConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedisAutoConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(name = &#123;&quot;redisTemplate&quot;&#125;)</span> </span><br><span class="line">    <span class="comment">// ==&gt; è¿™ä¸ªæ³¨è§£è¯´æ˜ï¼Œä¸å­˜åœ¨æˆ‘ä»¬è‡ªå®šä¹‰åä¸ºredisTemplateçš„Beançš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªBeanæ‰ç”Ÿæ•ˆ</span></span><br><span class="line">    <span class="comment">// ==&gt; å› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„RedisTemplateï¼ŒSpringBootä¼šä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰RedisTemplate</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">        <span class="comment">// é»˜è®¤çš„RedisTemplateæ²¡æœ‰è¿‡å¤šçš„é…ç½®ï¼ŒRediså¯¹è±¡éƒ½éœ€è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–</span></span><br><span class="line">        <span class="comment">// ä¸¤ä¸ªæ³›å‹éƒ½æ˜¯ Object, Obeject çš„ç±»å‹ï¼Œæˆ‘ä»¬ä»¥åä½¿ç”¨éœ€è¦å¼ºåˆ¶è½¬æ¢æˆ String, Object</span></span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="comment">// ç”±äºStringæ˜¯Redisä¸­æœ€å¸¸ä½¿ç”¨çš„ç±»å‹ï¼Œæ‰€ä»¥å•ç‹¬ä¸€ä¸ªStringRedisTemplate</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥æ“ä½œStringç±»å‹ï¼Œç›´æ¥ä½¿ç”¨StringRedisTemplateå³å¯</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> StringRedisTemplate <span class="title">stringRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">        StringRedisTemplate template = <span class="keyword">new</span> StringRedisTemplate();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="10-2-ğŸ”‘æ•´åˆä½¿ç”¨"><a href="#10-2-ğŸ”‘æ•´åˆä½¿ç”¨" class="headerlink" title="10.2 ğŸ”‘æ•´åˆä½¿ç”¨"></a>10.2 ğŸ”‘æ•´åˆä½¿ç”¨</h3><blockquote>
<p>å¯¼å…¥ä¾èµ–ï¼špom.xml(è§ä¸Šjedis)</p>
</blockquote>
<blockquote>
<p>é…ç½®ç¯å¢ƒï¼šapplication.properties</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Redisæ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰</span></span><br><span class="line"><span class="meta">spring.redis.database</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># RedisæœåŠ¡å™¨åœ°å€</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment"># RedisæœåŠ¡å™¨è¿æ¥ç«¯å£</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="comment"># RedisæœåŠ¡å™¨è¿æ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Spring 2.Xä»¥åï¼Œä½¿ç”¨lettuceè¿æ¥æ± </span></span><br><span class="line"><span class="comment"># è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-active</span>=<span class="string">100</span></span><br><span class="line"><span class="comment"># è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-idle</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.min-idle</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.shutdown-timeout</span>=<span class="string">100ms</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>âŒ¨ï¸è‡ªå®šä¹‰RedisTemplateï¼šRedisConfig.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.jsontype.impl.LaissezFaireSubTypeValidator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/7 20:23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: è‡ªå®šä¹‰RedisTemplate</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;è‡ªå®šä¹‰redisTemplate&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisConnectionFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;redisTemplate&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* åˆ›å»ºredisTemplate */</span></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        <span class="comment">/* å…³è”redisConnectionFactory */</span></span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="comment">/* Jackson2JsonRedisSerializerï¼šJsonåºåˆ—åŒ–å™¨ */</span></span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line">        redisTemplate.setKeySerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        objectMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</span><br><span class="line">        <span class="comment">/* StringRedisSerializerï¼šStringåºåˆ—åŒ–å™¨ */</span></span><br><span class="line">        StringRedisSerializer stringRedisSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">        <span class="comment">/* è®¾ç½®keyçš„åºåˆ—åŒ–æ–¹å¼ï¼šString */</span></span><br><span class="line">        redisTemplate.setKeySerializer(stringRedisSerializer);</span><br><span class="line">        <span class="comment">/* è®¾ç½®valueçš„åºåˆ—åŒ–æ–¹å¼ï¼šJson */</span></span><br><span class="line">        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="comment">/* è®¾ç½®hashçš„keyçš„åºåˆ—åŒ–æ–¹å¼ï¼šJson */</span></span><br><span class="line">        redisTemplate.setHashKeySerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="comment">/* è®¾ç½®hashçš„valueçš„åºåˆ—åŒ–æ–¹å¼ï¼šJson */</span></span><br><span class="line">        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>âŒ¨ï¸Rediså·¥å…·ç±»ï¼šRedisUtil.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: KHighness</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/10/7 21:33</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@apiNote</span>: Redisæ“ä½œå·¥å…·ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*==================================================================</span></span><br><span class="line"><span class="comment">    //                            common                              //</span></span><br><span class="line"><span class="comment">    ==================================================================*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŒ‡å®šç¼“å­˜å¤±æ•ˆæ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time æ—¶é—´(ç§’)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true æˆåŠŸï¼Œfalse å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">expire</span><span class="params">(String key, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.expire(key, time, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®keyè·å–è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ—¶é—´(ç§’) è¿”å›0ä»£è¡¨æ°¸ä¹…æœ‰æ•ˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getExpire</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.getExpire(key, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*==================================================================</span></span><br><span class="line"><span class="comment">    //                            String                              //</span></span><br><span class="line"><span class="comment">    ==================================================================*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true å­˜åœ¨ï¼Œfalse ä¸å­˜åœ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.hasKey(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤ç¼“å­˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key å¯ä»¥ä¼ ä¸€ä¸ªæˆ–å¤šä¸ª</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(String... key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key != <span class="keyword">null</span> &amp;&amp; key.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key.length == <span class="number">1</span>) &#123;</span><br><span class="line">                redisTemplate.delete(key[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                redisTemplate.delete(CollectionUtils.arrayToList(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ™®é€šç¼“å­˜è·å–</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key == <span class="keyword">null</span> ? <span class="keyword">null</span> : redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ™®é€šç¼“å­˜æ”¾å…¥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true æˆåŠŸï¼Œfalse å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">set</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ™®é€šç¼“å­˜æ”¾å…¥å¹¶è®¾ç½®æ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time æ—¶é—´(ç§’) timeè¦å¤§äº0 å¦‚æœtimeå°äºç­‰äº0 å°†è®¾ç½®æ— é™æœŸ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true æˆåŠŸï¼Œfalse å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">set</span><span class="params">(String key, Object value, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                set(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€’å¢</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta å¢é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> é€’å¢åçš„å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">incr</span><span class="params">(String key, <span class="keyword">long</span> delta)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;å¢é‡å¿…é¡»å¤§äº0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€’å‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta å‡é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> é€’å‡åçš„å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">decr</span><span class="params">(String key, <span class="keyword">long</span> delta)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;å‡é‡å¿…é¡»å¤§äº0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().decrement(key, delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*==================================================================</span></span><br><span class="line"><span class="comment">    //                              map                               //</span></span><br><span class="line"><span class="comment">    ==================================================================*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashGet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  é”® ä¸èƒ½ä¸ºNULL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item é¡¹ ä¸èƒ½ä¸ºNULL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">hget</span><span class="params">(String key, String item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().get(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–hashKeyå¯¹åº”çš„æ‰€æœ‰é”®å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å¯¹åº”çš„å¤šä¸ªé”®å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title">hmget</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().entries(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashSet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map å¯¹åº”çš„å¤šä¸ªé”®å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true æˆåŠŸï¼Œfalse å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hmset</span><span class="params">(String key, Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashSet å¹¶è®¾ç½®æ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map å¯¹åº”å¤šä¸ªé”®å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time æ—¶é—´(ç§’)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true æˆåŠŸï¼Œfalse å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hmset</span><span class="params">(String key, Map&lt;String, Object&gt; map, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘ä¸€å¼ hashè¡¨ä¸­æ”¾å…¥æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item  é¡¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true æˆåŠŸï¼Œfalse å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hset</span><span class="params">(String key, String item, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘ä¸€å¼ hashè¡¨ä¸­æ”¾å…¥æ•°æ®ï¼Œå¹¶è®¾ç½®æ—¶é—´ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item  é¡¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  æ—¶é—´(ç§’) å¦‚æœå·²å­˜åœ¨çš„hashè¡¨æœ‰æ—¶é—´ï¼Œè¿™é‡Œä¼šæ›´æ–°åŸå€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true æˆåŠŸï¼Œfalse å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hset</span><span class="params">(String key, String item, Object value, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤hashè¡¨ä¸­çš„å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  é”® ä¸èƒ½ä¸ºNULL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item é¡¹ å¯ä»¥ä½¿å¤šä¸ª ä¸èƒ½ä¸ºNULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hdel</span><span class="params">(String key, Object... item)</span> </span>&#123;</span><br><span class="line">        redisTemplate.opsForHash().delete(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­hashè¡¨ä¸­æ˜¯å¦æœ‰è¯¥é¡¹çš„å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  é”® ä¸èƒ½ä¸ºNULL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item é¡¹ ä¸èƒ½ä¸ºNULL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true å­˜åœ¨ï¼Œfalse ä¸å­˜åœ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hHasKey</span><span class="params">(String key, String item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().hasKey(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hashé€’å¢ å¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªï¼Œå¹¶æŠŠé€’å¢åçš„å€¼è¿”å›</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> by   å¢é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> é€’å¢åçš„å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">hincr</span><span class="params">(String key, String item, <span class="keyword">double</span> by)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, by);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hashé€’å‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> by   å‡é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> é€’å‡åçš„å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">hdecr</span><span class="params">(String key, String item, <span class="keyword">double</span> by)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, -by);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*==================================================================</span></span><br><span class="line"><span class="comment">    //                              set                               //</span></span><br><span class="line"><span class="comment">    ==================================================================*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®keyè·å–Setä¸­çš„æ‰€æœ‰å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> setä¸­çš„æ‰€æœ‰å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">sGet</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().members(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®valueä»ä¸€ä¸ªsetä¸­æŸ¥è¯¢æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true å­˜åœ¨ï¼Œfalse ä¸å­˜åœ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sHasKey</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().isMember(key, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†æ•°æ®æ”¾å…¥setç¼“å­˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values å€¼ å¯ä»¥æ˜¯å¤šä¸ª</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æˆåŠŸä¸ªæ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sSet</span><span class="params">(String key, Object... values)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().add(key, values);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†setæ•°æ®æ”¾å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®æ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time   æ—¶é—´(ç§’)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values å€¼ å¯ä»¥æ˜¯å¤šä¸ª</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æˆåŠŸä¸ªæ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sSetAndTime</span><span class="params">(String key, <span class="keyword">long</span> time, Object... values)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Long count = redisTemplate.opsForSet().add(key, values);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–setç¼“å­˜çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> setçš„é•¿åº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sGetSetSize</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().size(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*==================================================================</span></span><br><span class="line"><span class="comment">    //                             list                               //</span></span><br><span class="line"><span class="comment">    ==================================================================*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–listç¼“å­˜çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> listçš„é•¿åº¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lGetListSize</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().size(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€šè¿‡ç´¢å¼•è·å–listä¸­çš„å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index ç´¢å¼• index &gt;= 0æ—¶ï¼Œ0 è¡¨å¤´ï¼Œ1 ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä¾æ¬¡ç±»æ¨ï¼›index &lt; 0æ—¶ï¼Œ-1 è¡¨å°¾ï¼Œ-2 å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä¾æ¬¡ç±»æ¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">lGetIndex</span><span class="params">(String key, <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().index(key, index);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†listæ”¾å…¥ç¼“å­˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true æˆåŠŸï¼Œfalse å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lSet</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†listæ”¾å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®æ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  æ—¶é—´(ç§’)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æˆåŠŸæ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lSet</span><span class="params">(String key, Object value, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®ç´¢å¼•ä¿®æ”¹listä¸­çš„æŸæ¡æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index ç´¢å¼•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true æˆåŠŸï¼Œfalse å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lUpdateIndex</span><span class="params">(String key, <span class="keyword">long</span> index, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().set(key, index, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§»é™¤Nä¸ªå€¼ä¸ºvalue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count ç§»é™¤æ•°é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç§»é™¤æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lRemove</span><span class="params">(String key, <span class="keyword">long</span> count ,Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Long remove = redisTemplate.opsForList().remove(key, count, value);</span><br><span class="line">            <span class="keyword">return</span> remove;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="10-3-ğŸ’¨apiæµ‹è¯•"><a href="#10-3-ğŸ’¨apiæµ‹è¯•" class="headerlink" title="10.3 ğŸ’¨apiæµ‹è¯•"></a>10.3 ğŸ’¨apiæµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.parak;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> top.parak.common.RedisUtil;</span><br><span class="line"><span class="keyword">import</span> top.parak.entity.User;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringbootRedisApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Kæ®¿ä¸‹&quot;</span>);</span><br><span class="line">        log.info(redisTemplate.opsForValue().get(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;Knum&quot;</span>, <span class="string">&quot;3&quot;</span>);</span><br><span class="line">        log.info(stringRedisTemplate.opsForValue().increment(<span class="string">&quot;Knum&quot;</span>, <span class="number">3</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User(<span class="string">&quot;KHighness&quot;</span>, <span class="number">19</span>);</span><br><span class="line">        String jsonUser = <span class="keyword">new</span> ObjectMapper().writeValueAsString(user);</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        log.info(redisTemplate.opsForValue().get(<span class="string">&quot;user&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HashMap hashMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;name1&quot;</span>, <span class="string">&quot;KHighness&quot;</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;name2&quot;</span>, <span class="string">&quot;ParaK&quot;</span>);</span><br><span class="line">        hashMap.put(<span class="string">&quot;name3&quot;</span>, <span class="string">&quot;FlowerK&quot;</span>);</span><br><span class="line">        redisUtil.hmset(<span class="string">&quot;K&quot;</span>, hashMap);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry k : redisUtil.hmget(<span class="string">&quot;K&quot;</span>).entrySet()) &#123;</span><br><span class="line">            log.info(k.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">                        __ __ __    _       __</span><br><span class="line">                       / <span class="comment">//_// /_  (_)___ _/ /_  ____  ___  __________</span></span><br><span class="line">                      / ,&lt;  / __ \/ / __ `/ __ \/ __ \/ _ \/ ___/ ___/</span><br><span class="line">                     / /| |/ / / / / /_/ / / / / / / /  __(__  |__  )</span><br><span class="line">                    /_/ |_/_/ /_/_/\__, /_/ /_/_/ /_/\___/____/____/</span><br><span class="line">                                  /____/</span><br><span class="line"></span><br><span class="line">                     Copyright Â© <span class="number">2020</span> KHighness. All Rights Reserved</span><br><span class="line"></span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">13</span>:<span class="number">36</span>:<span class="number">35.073</span>  INFO <span class="number">18840</span> --- [           main] t.parak.SpringbootRedisApplicationTest   : No active profile set, falling back to <span class="keyword">default</span> profiles: <span class="keyword">default</span></span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">13</span>:<span class="number">36</span>:<span class="number">35.417</span>  INFO <span class="number">18840</span> --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Multiple Spring Data modules found, entering strict repository configuration mode!</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">13</span>:<span class="number">36</span>:<span class="number">35.420</span>  INFO <span class="number">18840</span> --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Bootstrapping Spring Data Redis repositories in DEFAULT mode.</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">13</span>:<span class="number">36</span>:<span class="number">35.445</span>  INFO <span class="number">18840</span> --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Finished Spring Data repository scanning in <span class="number">10</span>ms. Found <span class="number">0</span> Redis repository interfaces.</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">13</span>:<span class="number">36</span>:<span class="number">35.534</span>  INFO <span class="number">18840</span> --- [           main] o.s.cloud.context.scope.GenericScope     : BeanFactory id=<span class="number">8d</span>774ca9-<span class="number">71</span>ca-<span class="number">37</span>a9-<span class="number">91e1</span>-<span class="number">35</span>cd9af79e44</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">13</span>:<span class="number">36</span>:<span class="number">35.699</span>  INFO <span class="number">18840</span> --- [           main] trationDelegate$BeanPostProcessorChecker : Bean <span class="string">&#x27;org.springframework.cloud.autoconfigure.ConfigurationPropertiesRebinderAutoConfiguration&#x27;</span> of type [org.springframework.cloud.autoconfigure.ConfigurationPropertiesRebinderAutoConfiguration$$EnhancerBySpringCGLIB$$<span class="number">67</span>ea5b63] <span class="function">is not eligible <span class="keyword">for</span> getting processed by all <span class="title">BeanPostProcessors</span> <span class="params">(<span class="keyword">for</span> example: not eligible <span class="keyword">for</span> auto-proxying)</span></span></span><br><span class="line"><span class="function">2020-10-12 13:36:36.483  INFO 18840 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService &#x27;applicationTaskExecutor&#x27;</span></span><br><span class="line"><span class="function">2020-10-12 13:36:36.818  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : Started SpringbootRedisApplicationTest in 2.287 <span class="title">seconds</span> <span class="params">(JVM running <span class="keyword">for</span> <span class="number">3.29</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">2020-10-12 13:36:37.191  INFO 18840 --- [           main] io.lettuce.core.EpollProvider            : Starting without optional epoll library</span></span><br><span class="line"><span class="function">2020-10-12 13:36:37.192  INFO 18840 --- [           main] io.lettuce.core.KqueueProvider           : Starting without optional kqueue library</span></span><br><span class="line"><span class="function">2020-10-12 13:36:37.740  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : Kæ®¿ä¸‹</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">2020-10-12 13:36:37.762  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : 6</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">2020-10-12 13:36:37.802  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : <span class="title">User</span><span class="params">(name=KHighness, age=<span class="number">19</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">2020-10-12 13:36:37.836  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : name3</span>=FlowerK</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">13</span>:<span class="number">36</span>:<span class="number">37.836</span>  INFO <span class="number">18840</span> --- [           main] t.parak.SpringbootRedisApplicationTest   : name2=ParaK</span><br><span class="line"><span class="number">2020</span>-<span class="number">10</span>-<span class="number">12</span> <span class="number">13</span>:<span class="number">36</span>:<span class="number">37.836</span>  INFO <span class="number">18840</span> --- [           main] t.parak.SpringbootRedisApplicationTest   : name1=KHighness</span><br></pre></td></tr></table></figure>



<h2 id="11-ğŸ“©RedisæŒä¹…åŒ–"><a href="#11-ğŸ“©RedisæŒä¹…åŒ–" class="headerlink" title="11. ğŸ“©RedisæŒä¹…åŒ–"></a>11. ğŸ“©RedisæŒä¹…åŒ–</h2><blockquote>
<p>ğŸ“Œtip</p>
</blockquote>
<p>Redisæ˜¯å†…å­˜æ•°æ®åº“ï¼Œå¦‚æœä¸å°†å†…å­˜ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¿å­˜åœ¨ç£ç›˜ï¼Œé‚£ä¹ˆä¸€æ—¦æœåŠ¡å™¨è¿›ç¨‹é€€å‡ºï¼ŒæœåŠ¡å™¨ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¹Ÿä¼šæ¶ˆå¤±ã€‚æ‰€ä»¥Redisæä¾›äº†æŒä¹…åŒ–åŠŸèƒ½ã€‚</p>
<ul>
<li><p>Redisé»˜è®¤æ˜¯æŒ‰ç…§å¿«ç…§RDBçš„æŒä¹…åŒ–æ–¹å¼</p>
</li>
<li><p>Redisé‡å¯çš„æ—¶å€™ä¼šä¼˜å…ˆä½¿ç”¨AOFæ–‡ä»¶è¿˜åŸæ•°æ®åº“çŠ¶æ€</p>
</li>
</ul>
<h3 id="11-1-ğŸ“RDB"><a href="#11-1-ğŸ“RDB" class="headerlink" title="11.1 ğŸ“RDB"></a>11.1 ğŸ“RDB</h3><blockquote>
<p>ğŸ””RDB = Redis Database</p>
</blockquote>
<p>å°†å†…å­˜ä¸­çš„æ•°æ®ä»¥å¿«ç…§â€RDBâ€çš„å½¢å¼å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜çš„ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶dump.rdbï¼Œå®šæ—¶ä¿å­˜ã€‚</p>
<blockquote>
<p>ğŸ”¨é…ç½®</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">save 900 1    # 15åˆ†é’Ÿå¤‡ä»½ä¸€æ¬¡</span><br><span class="line">save 300 10   # å¦‚æœåœ¨300så†…ï¼Œè‡³å°‘æœ‰10ä¸ªkeyè¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</span><br><span class="line">save 60 10000 # å¦‚æœåœ¨60så†…ï¼Œè‡³å°‘æœ‰10000ä¸ªkeyè¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨24å°æ—¶å†…ï¼Œæ¯å°æ—¶å¤‡ä»½ä¸€æ¬¡ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªæœˆçš„æ¯ä¸€å¤©ä¹Ÿå¤‡ä»½ä¸€ä¸ªRDBæ–‡ä»¶ã€‚</p>
<p>è¿™æ ·çš„è¯ï¼Œå³ä½¿é‡ä¸Šé—®é¢˜ï¼Œä¹Ÿå¯ä»¥éšæ—¶å°†æ•°æ®é›†æ¢å¤åˆ°ä¸åŒçš„ç‰ˆæœ¬ã€‚</p>
<blockquote>
<p>ğŸ”å·¥ä½œæœºåˆ¶</p>
</blockquote>
<p>Redisä¼šå•ç‹¬åˆ›å»º(fork)ä¸€ä¸ªå­è¿›ç¨‹æ¥è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¼šå…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå¾…æŒä¹…åŒ–è¿‡ç¨‹éƒ½ç»“æŸäº†ï¼Œå†ç”¨è¿™ä¸ªä¸´æ—¶æ–‡ä»¶æ›¿æ¢ä¸Šæ¬¡æŒä¹…åŒ–å¥½çš„æ–‡ä»¶ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»è¿›ç¨‹æ˜¯ä¸è¿›è¡Œä»»ä½•I/Oæ“ä½œçš„ã€‚è¿™å°±ç¡®ä¿äº†æé«˜çš„æ€§èƒ½ã€‚å¦‚æœéœ€è¦è¿›è¡Œå¤§è§„æ¨¡æ•°æ®çš„æ¢å¤ï¼Œä¸”å¯¹äºæ•°æ®æ¢å¤çš„å®Œæ•´æ€§ä¸æ˜¯éå¸¸æ•æ„Ÿï¼Œé‚£RDBæ–¹å¼è¦æ¯”AOFæ–¹å¼æ›´åŠ é«˜æ•ˆã€‚RDBçš„<strong>ç¼ºç‚¹æ˜¯æœ€åä¸€æ¬¡æŒä¹…åŒ–åçš„æ•°æ®å¯èƒ½ä¸¢å¤±</strong>ã€‚æˆ‘ä»¬é»˜è®¤çš„å°±æ˜¯RDBï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦ä¿®æ”¹è¿™ä¸ªé…ç½®ã€‚</p>
<blockquote>
<p>ğŸ’£è§¦å‘æœºåˆ¶</p>
</blockquote>
<ul>
<li>saveçš„è§„åˆ™æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¼šè‡ªåŠ¨è§¦å‘rdbè§„åˆ™</li>
<li>æ‰§è¡Œflushallå‘½ä»¤ï¼Œä¹Ÿä¼šè§¦å‘rdbè§„åˆ™</li>
<li>é€€å‡ºredisï¼Œä¹Ÿä¼šäº§ç”Ÿrdbæ–‡ä»¶</li>
</ul>
<blockquote>
<p>ğŸ’Ÿæ¢å¤rdb</p>
</blockquote>
<ul>
<li><p>å°†rdbæ–‡ä»¶æ”¾åœ¨rediså¯åŠ¨ç›®å½•ï¼ŒredisæœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨æ£€æŸ¥dump.rdbï¼Œæ¢å¤å…¶ä¸­çš„æ•°æ®</p>
</li>
<li><p>æŸ¥çœ‹éœ€è¦å­˜åœ¨çš„ä½ç½®</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get dir</span><br><span class="line">1) &quot;dir&quot;</span><br><span class="line">2) &quot;/usr/local/bin&quot; # å¦‚æœåœ¨è¿™ä¸ªç›®å½•ä¸‹å­˜åœ¨dump.rdbæ–‡ä»¶ï¼Œå¯åŠ¨å°±ä¼šè‡ªåŠ¨æ¢å¤å…¶ä¸­çš„æ•°æ®</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ğŸŒ ä¼˜ç‚¹ç¼ºç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li><p>é€‚åˆå¤§è§„æ¨¡çš„æ•°æ®æ¢å¤(é€‚åˆæ–‡ä»¶å¤‡ä»½)</p>
</li>
<li><p>å¯¹æ•°æ®çš„å®Œæ•´æ€§è¦æ±‚ä¸é«˜</p>
</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>RedisæœåŠ¡å™¨å®•æœºæ—¶ä¼šä¸¢å¤±æ•°æ®</p>
</li>
<li><p>forkè¿›ç¨‹ä¼šå ç”¨ä¸€å®šçš„å†…å®¹ç©ºé—´</p>
</li>
</ul>
<h3 id="11-2-ğŸ“AOF"><a href="#11-2-ğŸ“AOF" class="headerlink" title="11.2 ğŸ“AOF"></a>11.2 ğŸ“AOF</h3><blockquote>
<p>ğŸ””AOF = Append Only Mode</p>
</blockquote>
<p>æŠŠæ‰€æœ‰çš„å¯¹Redisçš„æœåŠ¡å™¨è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤éƒ½å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶(é»˜è®¤ä¸ºappendonly.aof)é‡Œï¼Œå‘½ä»¤çš„é›†åˆã€‚</p>
<blockquote>
<p>ğŸ””é…ç½®</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">appendonly yes # å¼€å¯AOF</span><br><span class="line">appendfsync yes # é»˜è®¤å¼€å¯åŒæ­¥</span><br><span class="line">appendfsync always # æ¯æ¬¡æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶å€™éƒ½ä¼šå†™å…¥AOFæ–‡ä»¶</span><br><span class="line">appendfsync everysec # æ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œè¿™ä¸ªæ­»AOFçš„ç¼ºçœç­–ç•¥</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ğŸ“AOFé‡å†™</p>
</blockquote>
<ul>
<li>AOFæ–‡ä»¶çš„å¤§å°éšç€æ—¶é—´çš„æµé€ä¸€å®šè¶Šæ¥è¶Šå¤§ï¼Œå½±å“åŒ…æ‹¬ä½†ä¸é™äºï¼šå¯¹äºRedisæœåŠ¡å™¨è®¡ç®—æœºçš„å­˜å‚¨å‹åŠ›ï¼›AOFè¿˜åŸæ•°æ®åº“çŠ¶æ€çš„æ—¶é—´å¢åŠ </li>
<li>ä¸ºäº†è§£å†³AOFæ–‡ä»¶ä½“ç§¯è†¨èƒ€çš„é—®é¢˜ï¼ŒRedisæä¾›äº†AOFé‡å†™åŠŸèƒ½ï¼šRedisæœåŠ¡å™¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„AOFæ–‡ä»¶æ¥æ›¿ä»£ç°æœ‰çš„AOFæ–‡ä»¶ï¼Œæ–°æ—§ä¸¤ä¸ªæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯æ–°çš„AOF æ–‡ä»¶ä¸ä¼šåŒ…å«ä»»ä½•æµªè´¹ç©ºé—´çš„å†—ä½™å‘½ä»¤ï¼Œé€šå¸¸ä¼šè¾ƒæ—§AOFæ–‡ä»¶å°å¾ˆå¤š</li>
</ul>
<p>Redisä¼šåœ¨æœ€è¿‘ä¸€æ¬¡é‡å†™åè®°ä½AOFæ–‡ä»¶çš„å¤§å°ï¼Œå°†æ¬¡åŸºæœ¬å¤§å°ä¸å½“å‰å¤§å°è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå½“å‰å¤§å°å¤§äºæŒ‡å®šçš„ç™¾åˆ†æ¯”ï¼Œåˆ™è§¦å‘é‡å†™ã€‚</p>
<p>æŒ‡å®šé›¶ç™¾åˆ†æ¯”å¯ä»¥ç¦ç”¨é‡å†™åŠŸèƒ½ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">auto-aof-rewrite-percentage 100 </span><br><span class="line">auto-aof-rewrite-min-size 64mb # è§¦å‘é‡å†™çš„AOFæ–‡ä»¶çš„æœ€å°å¤§å°</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ğŸ’¢äº§ç”Ÿé—®é¢˜</p>
</blockquote>
<p>æ¯æ¬¡é‡å¯Redisçš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆä½¿ç”¨AOFæ–‡ä»¶è¿˜åŸæ•°æ®ã€‚</p>
<p>å¦‚æœAOFæ–‡ä»¶ä»¥å¤–äº§ç”Ÿé”™ä½ï¼Œæˆ–è€…äººå·¥æ„å¤–æ”¹å†™ï¼Œå¯ä»¥é€šè¿‡<code>redis-check-aof --fix appendonly.aof</code>ä¿®å¤æ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@master bin]# redis-check-aof --fix appendonly.aof </span><br><span class="line">&#x27;x              3f: Expected prefix &#x27;*&#x27;, got: &#x27;</span><br><span class="line">AOF analyzed: size=114, ok_up_to=63, diff=51</span><br><span class="line">This will shrink the AOF from 114 bytes, with 51 bytes, to 63 bytes</span><br><span class="line">Continue? [y/N]: y</span><br><span class="line">Successfully truncated AOF</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ğŸŒ ä¼˜ç‚¹ç¼ºç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>AOFä¼šè®©rediså˜å¾—éå¸¸è€ä¹…ï¼ŒAOFçš„é»˜è®¤ç­–ç•¥æ˜¯æ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼Œåœ¨è¿™ç§é…ç½®ä¸‹ï¼Œå°±ç®—RedisæœåŠ¡å™¨å®•æœºï¼Œä¹Ÿæœ€å¤šä¸¢å¤±ä¸€ç§’é’Ÿçš„æ•°æ®</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>å¯¹äºç›¸åŒçš„æ•°æ®é›†æ¥è¯´ï¼ŒAOFçš„æ–‡ä»¶ä½“ç§¯è¦å¤§äºRDBçš„æ–‡ä»¶ä½“ç§¯ï¼Œæ•°æ®æ¢å¤çš„é€Ÿåº¦æ›´æ…¢</li>
<li>æ ¹æ®æ‰€ä½¿ç”¨çš„syncç­–ç•¥ï¼ŒAOFçš„é€Ÿåº¦å¯èƒ½æ…¢äºRDB</li>
</ul>
<h2 id="12-ğŸ“©Rediså‘å¸ƒè®¢é˜…"><a href="#12-ğŸ“©Rediså‘å¸ƒè®¢é˜…" class="headerlink" title="12. ğŸ“©Rediså‘å¸ƒè®¢é˜…"></a>12. ğŸ“©Rediså‘å¸ƒè®¢é˜…</h2><h3 id="12-1-ğŸ’¬è¯´æ˜"><a href="#12-1-ğŸ’¬è¯´æ˜" class="headerlink" title="12.1 ğŸ’¬è¯´æ˜"></a>12.1 ğŸ’¬è¯´æ˜</h3><p>Redis å‘å¸ƒè®¢é˜… (pub/sub) æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ï¼šå‘é€è€…(pub) å‘é€æ–¹æ¶ˆæ¯ï¼Œè®¢é˜…è€…(sub)æ¥æ”¶æ¶ˆæ¯ã€‚</p>
<p>Rediså®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ã€‚</p>
<h3 id="12-2-ğŸ“·æ¨¡å‹"><a href="#12-2-ğŸ“·æ¨¡å‹" class="headerlink" title="12.2 ğŸ“·æ¨¡å‹"></a>12.2 ğŸ“·æ¨¡å‹</h3><blockquote>
<p>ğŸ—¼è®¢é˜…æ¨¡å‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201125132811770.png" class="" title="image-20201125132811770"><br />

<blockquote>
<p>ğŸ—½æ¶ˆæ¯æ¨¡å‹</p>
</blockquote>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201125132839908.png" class="" title="image-20201125132839908"><br />



<blockquote>
<p>ğŸ“œå‘å¸ƒè®¢é˜…å‘½ä»¤</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">psubscribe pattern [pattern â€¦]</td>
<td align="center">è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªç¬¦åˆç»™å®šæ¨¡å¼çš„é¢‘é“</td>
</tr>
<tr>
<td align="center">pubsub subcommand [argument [argument â€¦]]</td>
<td align="center">æŸ¥çœ‹è®¢é˜…ä¸å‘å¸ƒç³»ç»ŸçŠ¶æ€</td>
</tr>
<tr>
<td align="center">publish channel message</td>
<td align="center">å°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šçš„é¢‘é“</td>
</tr>
<tr>
<td align="center">punsubscribe channel [channel â€¦]</td>
<td align="center">é€€è®¢æ‰€æœ‰ç»™å®šæ¨¡å¼çš„é¢‘é“</td>
</tr>
<tr>
<td align="center">subscribe channel [channel â€¦]</td>
<td align="center">è®¢é˜…ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“çš„ä¿¡æ¯</td>
</tr>
<tr>
<td align="center">unsubscribe [channel [channel â€¦]]</td>
<td align="center">é€€è®¢ç»™å®šçš„é¢‘é“</td>
</tr>
</tbody></table>
<blockquote>
<p>ğŸæ¼”ç¤º</p>
</blockquote>
<p>å¼€å¯ä¸‰ä¸ªredis-cli</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œè®¢é˜…é¢‘é“ï¼šKhighness</span></span><br><span class="line">127.0.0.1:6379&gt; subscribe Khighness</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) &quot;subscribe&quot;</span><br><span class="line">2) &quot;Khighness&quot;</span><br><span class="line">3) (integer) 1</span><br><span class="line">1) &quot;message&quot;</span><br><span class="line">2) &quot;Khighness&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¬¬äºŒä¸ªå®¢æˆ·ç«¯ï¼Œåœ¨é¢‘é“Khighnesså‘å¸ƒæ¶ˆæ¯</span></span><br><span class="line">127.0.0.1:6379&gt; publish Khighness &quot;Client1: Hello, Khighness&quot;</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¬¬ä¸‰ä¸ªå®¢æˆ·ç«¯ï¼Œåœ¨é¢‘é“Khighnesså‘å¸ƒæ¶ˆæ¯</span></span><br><span class="line">127.0.0.1:6379&gt; publish Khighness &quot;Client3: Hello, Khighness&quot;</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è®¢é˜…é¢‘é“çš„ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å°±èƒ½æ”¶åˆ°æ¶ˆæ¯</span></span><br><span class="line">1) &quot;message&quot;</span><br><span class="line">2) &quot;Khighness&quot;</span><br><span class="line">3) &quot;Client2: Hello, Khighness&quot;</span><br><span class="line">1) &quot;message&quot;</span><br><span class="line">2) &quot;Khighness&quot;</span><br><span class="line">3) &quot;Client3: Hello, Khighness&quot;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>ğŸ•µï¸åŸç†</p>
</blockquote>
<p>Redisæ˜¯Cè¯­è¨€ç¼–å†™çš„ï¼Œé€šè¿‡åˆ†æRedisæºä»£ç é‡Œé¢çš„pubsub.cæ–‡ä»¶ï¼Œäº†è§£å‘å¸ƒå’Œè®¢é˜…æœºåˆ¶çš„åº•å±‚å®ç°ã€‚</p>
<p>é€šè¿‡subscribeå‘½ä»¤è®¢é˜…æŸé¢‘é“åï¼Œredis-serveré‡Œç»´æŠ¤äº†ä¸€ä¸ªå­—å…¸ï¼Œå­—å…¸çš„é”®å°±æ˜¯ä¸€ä¸ªä¸ªé¢‘é“channelï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜äº†æ‰€æœ‰è®¢é˜…è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯clientã€‚subscribeå‘½ä»¤çš„å…³é”®ï¼Œå°±æ˜¯å°†clientæ·»åŠ åˆ°ç»™å®šchannelçš„è®¢é˜…é“¾ä¸­ã€‚</p>
<p>é€šè¿‡publishå‘½ä»¤å‘è®¢é˜…è€…å‘é€æ¶ˆæ¯ï¼Œredis-serverä¼šä½¿ç”¨ç»™å®šçš„é¢‘é“ä½œä¸ºé”®ï¼Œåœ¨å®ƒæ‰€ç»´æŠ¤çš„channelå­—å…¸æŸ¥æ‰¾è®°å½•äº†è®¢é˜…è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰å®¢æˆ·ç«¯çš„é“¾è¡¨ï¼Œéå†è¿™ä¸ªé“¾è¡¨ï¼Œå°†æ¶ˆæ¯å‘å¸ƒç»™æ‰€æœ‰è®¢é˜…è€…ã€‚</p>
<p>åœ¨Redisä¸­ï¼Œå¯ä»¥è®¾å®šå¯¹æŸä¸€ä¸ªkeyå€¼è¿›è¡Œæ¶ˆæ¯å‘å¸ƒåŠæ¶ˆæ¯è®¢é˜…ï¼Œå½“ä¸€ä¸ªkeyå€¼ä¸Šè¿›è¡Œäº†æ¶ˆæ¯å‘å¸ƒåï¼Œæ‰€æœ‰è®¢é˜…å®ƒçš„å®¢æˆ·ç«¯éƒ½ä¼šæ”¶åˆ°å“åº”çš„æ¶ˆæ¯ã€‚è¿™ä¸€åŠŸèƒ½æœ€æ˜æ˜¾çš„ç”¨æ³•å°±æ˜¯ç”¨ä½œå®æ—¶æ¶ˆæ¯ç³»ç»Ÿï¼Œæ™®é€šçš„å³æ—¶èŠå¤©å’Œç¾¤èŠåŠŸèƒ½ã€‚</p>
<h2 id="13-ğŸ“©Redisä¸»ä»å¤åˆ¶"><a href="#13-ğŸ“©Redisä¸»ä»å¤åˆ¶" class="headerlink" title="13. ğŸ“©Redisä¸»ä»å¤åˆ¶"></a>13. ğŸ“©Redisä¸»ä»å¤åˆ¶</h2><h3 id="13-1-ğŸ“–æ¦‚å¿µ"><a href="#13-1-ğŸ“–æ¦‚å¿µ" class="headerlink" title="13.1 ğŸ“–æ¦‚å¿µ"></a>13.1 ğŸ“–æ¦‚å¿µ</h3><p>ä¸»ä»å¤åˆ¶ï¼Œæ˜¯æŒ‡å°†ä¸€å°RedisæœåŠ¡å™¨çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°å…¶ä»–çš„RedisæœåŠ¡å™¨ã€‚å‰è€…ç§°ä¸ºä¸»ç»“ç‚¹(master)ï¼Œåè€…ç§°ä¸ºä»ç»“ç‚¹(slave)ï¼›æ•°æ®çš„å¤åˆ¶æ˜¯å•å‘çš„ï¼Œåªèƒ½ç”±ä¸»èŠ‚ç‚¹åˆ°ä»ç»“ç‚¹ã€‚masterä»¥å†™ä¸ºä¸»ï¼Œsalveä»¥è¯»ä¸ºä¸»ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯å°RedisæœåŠ¡å™¨éƒ½æ˜¯ä¸»ç»“ç‚¹ï¼›ä¸”ä¸€ä¸ªä¸»ç»“ç‚¹å¯ä»¥æœ‰å¤šä¸ªä»ç»“ç‚¹(æˆ–æ²¡æœ‰ä»ç»“ç‚¹)ï¼Œä½†ä¸€ä¸ªä»ç»“ç‚¹åªèƒ½æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ã€‚</p>
<h3 id="13-2-ğŸ”§ä½œç”¨"><a href="#13-2-ğŸ”§ä½œç”¨" class="headerlink" title="13.2 ğŸ”§ä½œç”¨"></a>13.2 ğŸ”§ä½œç”¨</h3><ol>
<li>æ•°æ®å†—ä½™ï¼šä¸»ä»å¤åˆ¶å®ç°äº†æ•°æ®çš„çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼</li>
<li>æ•…éšœæ¢å¤ï¼šå½“ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç”±ä»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤ï¼Œå®é™…ä¸Šæ˜¯ä¸€ç§æœåŠ¡çš„å†—ä½™</li>
<li>è´Ÿè½½å‡è¡¡ï¼šåœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ç”±ä¸»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼Œåˆ†æ‹…æœåŠ¡å™¨è´Ÿè½½ï¼›å°¤å…¶æ˜¯åœ¨å†™å°‘è¯»å¤šçš„åœºæ™¯ä¸‹ï¼Œé€šè¿‡å¤šä¸ªä»ç»“ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¯ä»¥å¤§å¤§æé«˜RedisæœåŠ¡å™¨çš„å¹¶å‘é‡</li>
<li>é«˜å¯ç”¨åŸºçŸ³ï¼šä¸»ä»å¤åˆ¶æ˜¯å“¨å…µå’Œé›†ç¾¤å¯å®æ–½çš„åŸºç¡€ï¼Œå› æ­¤è¯´ä¸»ä»å¤åˆ¶æ˜¯Redisé«˜å¯ç”¨çš„åŸºç¡€</li>
</ol>
<h3 id="13-3-ğŸ”å¤åˆ¶åŸç†"><a href="#13-3-ğŸ”å¤åˆ¶åŸç†" class="headerlink" title="13.3 ğŸ”å¤åˆ¶åŸç†"></a>13.3 ğŸ”å¤åˆ¶åŸç†</h3><p>slaveå¯åŠ¨æˆåŠŸè¿æ¥åˆ°masteråä¼šå‘é€ä¸€ä¸ªsyncåŒæ­¥å‘½ä»¤ã€‚</p>
<p>masteræ¥åˆ°å‘½ä»¤ï¼Œå¯åŠ¨åå°çš„å­˜ç›˜è¿›ç¨‹ï¼ŒåŒæ—¶æ”¶é›†æ‰€æœ‰æ¥æ”¶åˆ°çš„ç”¨äºä¿®æ”¹æ•°æ®é›†å‘½ä»¤ï¼Œåœ¨åå°è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œmasterå°†ä¼ é€æ•´ä¸ªæ•°æ®æ–‡ä»¶åˆ°slaveï¼Œå¹¶å®Œæˆä¸€æ¬¡å®Œå…¨åŒæ­¥ã€‚</p>
<p><strong>å…¨é‡å¤åˆ¶</strong>ï¼šslaveæœåŠ¡åœ¨æ¥æ”¶åˆ°æ•°æ®åº“æ–‡ä»¶åï¼Œå°†å…¶å­˜ç›˜å¹¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p>
<p><strong>å¢é‡å¤åˆ¶</strong>ï¼šmasterç»§ç»­å°†æ–°çš„æ‰€æœ‰æ”¶é›†åˆ°çš„ä¿®æ”¹å‘½ä»¤ä¾æ¬¡ä¼ ç»™slaveï¼Œå®ŒæˆåŒæ­¥ã€‚</p>
<p>ä½†æ˜¯åªè¦æ˜¯é‡æ–°è¿æ¥masterï¼Œä¸€æ¬¡å®Œå…¨åŒæ­¥(å…¨é‡å¤åˆ¶)å°†è¢«è‡ªåŠ¨æ‰§è¡Œã€‚</p>
<h2 id="14-ğŸ“©Redisé›†ç¾¤æ­å»º"><a href="#14-ğŸ“©Redisé›†ç¾¤æ­å»º" class="headerlink" title="14. ğŸ“©Redisé›†ç¾¤æ­å»º"></a>14. ğŸ“©Redisé›†ç¾¤æ­å»º</h2><h3 id="14-1-ğŸ”±æ–¹æ³•"><a href="#14-1-ğŸ”±æ–¹æ³•" class="headerlink" title="14.1 ğŸ”±æ–¹æ³•"></a>14.1 ğŸ”±æ–¹æ³•</h3><p>==æ­å»ºä¸´æ—¶ä¼ªé›†ç¾¤ï¼Œå‘½ä»¤æ“ä½œå³å¯==</p>
<p>ä¸»è¦æ“ä½œï¼š<strong>æ“ä½œä»æœºï¼Œè®¤è€å¤§ã€‚</strong></p>
<p>æŸ¥çœ‹redisæœåŠ¡å™¨ä¿¡æ¯ï¼š<code>info replication</code></p>
<p>åœ¨ä»æœºä¸Šè®¤è€å¤§masterï¼š<code>slaveof &lt;master-ip&gt; &lt;master-port&gt;</code></p>
<p>==æ­å»ºæ°¸ä¹…é›†ç¾¤ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶==</p>
<p>ä¸»è¦æ“ä½œï¼šä¿®æ”¹redis-confæ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt;  # é…ç½®masterçš„ipå’Œç«¯å£å·</span><br><span class="line">masterauth &lt;master-passwordd&gt;      # å¦‚æœmasteræœ‰å¯†ç åˆ™é…ç½®å¯†ç </span><br></pre></td></tr></table></figure>



<p>==masterå…³æœºè§£å†³â€”â€”è°‹æƒç¯¡ä½==</p>
<p>é€šè¿‡<code>slaveof no one</code>è®©slaveè‡ªå·±å˜æˆmaster</p>
<h3 id="14-2-ğŸ”ªæ“ä½œ"><a href="#14-2-ğŸ”ªæ“ä½œ" class="headerlink" title="14.2 ğŸ”ªæ“ä½œ"></a>14.2 ğŸ”ªæ“ä½œ</h3><ol>
<li>å¤åˆ¶ä¸‰ä»½redis.confæ–‡ä»¶ï¼Œä¿®æ”¹ä¿¡æ¯<ul>
<li>port</li>
<li>logfile</li>
<li>pidfile</li>
<li>dbfilename</li>
</ul>
</li>
<li>åˆ†åˆ«åœ¨ä¸‰ä¸ªé…ç½®æ–‡ä»¶ä¸‹å¯åŠ¨redisæœåŠ¡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@master bin]# ps -ef | grep redis</span><br><span class="line">root      18914      1  0 00:54 ?        00:01:38 redis-server 127.0.0.1:6379</span><br><span class="line">root      31612      1  0 11:51 ?        00:00:00 redis-server 127.0.0.1:6380</span><br><span class="line">root      31623      1  0 11:51 ?        00:00:00 redis-server 127.0.0.1:6381</span><br><span class="line">root      31634  31340  0 11:51 pts/2    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>å¼€å¯ä¸‰ä¸ªç»ˆç«¯å¼€å¯ä¸‰ä¸ªrediså®¢æˆ·ç«¯åˆ†åˆ«è¿æ¥ä¸‰ä¸ªredisæœåŠ¡å™¨</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Terminal1</span></span><br><span class="line">[parak@master bin]$ redis-cli -p 6379</span><br><span class="line"><span class="meta">#</span><span class="bash"> Terminal2</span></span><br><span class="line">[parak@master bin]$ redis-cli -p 6380</span><br><span class="line"><span class="meta">#</span><span class="bash"> Terminal3</span></span><br><span class="line">[parak@master bin]$ redis-cli -p 6381</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>å°†6379ç«¯å£çš„æœåŠ¡çš„é…ç½®æˆmasterï¼Œå¦å¤–ä¸¤ä¸ªé…ç½®æˆslave</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 6380</span></span><br><span class="line">127.0.0.1:6380&gt; slaveof 127.0.0.1 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:3</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:14</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:9c3e61afce386f90c00db9ee4e9a2e7b4b265297</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:14</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:14</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6381</span></span><br><span class="line">127.0.0.1:6381&gt; slaveof 127.0.0.1 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:8</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:42</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:9c3e61afce386f90c00db9ee4e9a2e7b4b265297</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:42</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:43</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6379</span></span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=2087,lag=0</span><br><span class="line">slave1:ip=127.0.0.1,port=6381,state=online,offset=2087,lag=0</span><br><span class="line">master_replid:9c3e61afce386f90c00db9ee4e9a2e7b4b265297</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:2087</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:2087</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>åœ¨masterä¸Šå†™å…¥å€¼ï¼Œåœ¨slaveä¸Šè¯»å–å€¼</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 6379</span></span><br><span class="line">127.0.0.1:6379&gt; hmset student:1 name Khighness gender male age 19</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; hmset student:2 name bingyao gender female age 16</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 6380</span></span><br><span class="line">127.0.0.1:6380&gt; hmget student:1 name gender age</span><br><span class="line">1) &quot;Khighness&quot;</span><br><span class="line">2) &quot;male&quot;</span><br><span class="line">3) &quot;19&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 6381</span></span><br><span class="line">127.0.0.1:6381&gt; hmget student:2 name gender age</span><br><span class="line">1) &quot;bingyao&quot;</span><br><span class="line">2) &quot;female&quot;</span><br><span class="line">3) &quot;16&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> slaveåªèƒ½è¯»å–ï¼Œä¸èƒ½å†™å…¥</span></span><br><span class="line">127.0.0.1:6380&gt; set K2 V2</span><br><span class="line">(error) READONLY You can&#x27;t write against a read only replica</span><br></pre></td></tr></table></figure>



<h2 id="15-ğŸ“©Rediså“¨å…µæ¨¡å¼"><a href="#15-ğŸ“©Rediså“¨å…µæ¨¡å¼" class="headerlink" title="15. ğŸ“©Rediså“¨å…µæ¨¡å¼"></a>15. ğŸ“©Rediså“¨å…µæ¨¡å¼</h2><p><del>é©¾æ ¡æ‰‹åŠ¨æŒ¡=&gt;ä¸Šè·¯è‡ªåŠ¨æŒ¡</del></p>
<h3 id="15-1-ğŸ“™æ¦‚è¿°"><a href="#15-1-ğŸ“™æ¦‚è¿°" class="headerlink" title="15.1 ğŸ“™æ¦‚è¿°"></a>15.1 ğŸ“™æ¦‚è¿°</h3><p>ä¸»ä»åˆ‡æ¢æŠ€æœ¯çš„æ–¹æ³•ï¼šå½“ä¸»æœåŠ¡å™¨å®•æœºåï¼Œéœ€è¦æ‰‹åŠ¨æŠŠä¸€å°ä»æœåŠ¡å™¨åˆ‡æ¢ä¸ºä¸»æœåŠ¡å™¨ï¼Œè¿™å°±éœ€è¦äººå·¥å¹²é¢„ï¼Œè´¹äº‹è´¹åŠ›ï¼Œè¿˜ä¼šé€ æˆä¸€æ®µæ—¶é—´å†…æœåŠ¡ä¸å¯ç”¨ã€‚è¿™ä¸æ˜¯ä¸€ç§æ¨èçš„æ–¹å¼ï¼Œæ›´å¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¼˜å…ˆè€ƒè™‘å“¨å…µæ¨¡å¼ã€‚Redisä»2.8å¼€å§‹æ­£å¼æä¾›äº†Sentinel(å“¨å…µ)æ¶æ„æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œå“¨å…µæ¨¡å¼å°±æ˜¯è°‹æƒç¯¡ä½çš„è‡ªåŠ¨ç‰ˆï¼Œèƒ½å¤Ÿåå°ç›‘æ§ä¸»æœºæ˜¯å¦æ•…éšœï¼Œå¦‚æœå‘ç”Ÿæ•…éšœåˆ™æ ¹æ®æŠ•ç¥¨æ•°è‡ªåŠ¨å°†åº“è½¬æ¢ä¸ºä¸»åº“ã€‚</p>
<p>å“¨å…µæ¨¡å¼æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ¨¡å¼ï¼Œé¦–å…ˆRedisæä¾›äº†å“¨å…µçš„å‘½ä»¤ï¼Œå“¨å…µæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä½œä¸ºè¿›ç¨‹ï¼Œå®ƒä¼šç‹¬ç«‹è¿è¡Œã€‚</p>
<p>åŸç†ï¼šå“¨å…µé€šè¿‡å‘é€å‘½ä»¤ï¼Œç­‰å¾…RedisæœåŠ¡å™¨å“åº”ï¼Œä»è€Œç›‘æ§è¿è¡Œçš„å¤šä¸ªRediså®ä¾‹ã€‚</p>
<div class="mermaid">
graph TD;
	A((å“¨å…µ))
	B(ä¸»RedisæœåŠ¡å™¨)
	C(ä»RedisæœåŠ¡å™¨1)
	D(ä»RedisæœåŠ¡å™¨2)
	S[ä»¥ç‹¬ç«‹çš„è¿›ç¨‹ç›‘æ§3å°æœåŠ¡å™¨Redisæ˜¯å¦æ­£å¸¸è¿è¡Œ] 
	S --&gt; A
	A --&gt; C
	A --&gt; B
	A --&gt; D
	B --&gt; C
	B --&gt; D</div>




<p>è¿™é‡Œçš„å“¨å…µæœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ul>
<li>é€šè¿‡å‘é€å‘½ä»¤ï¼Œè®©RedisæœåŠ¡å™¨è¿”å›ç›‘æ§å…¶è¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨</li>
<li>å½“å“¨å…µç›‘æµ‹åˆ°masterå®•æœºï¼Œä¼šè‡ªåŠ¨å°†slaveåˆ‡æ¢ä¸ºmasterï¼Œç„¶åé€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼é€šçŸ¥å…¶ä»–çš„ä»æœåŠ¡å™¨ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè®©å®ƒä»¬åˆ‡æ¢ä¸»æœº</li>
</ul>
<p>ä¸€ä¸ªå“¨å…µè¿›ç¨‹å¯¹RedisæœåŠ¡å™¨è¿›è¡Œç›‘æ§ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªå“¨å…µè¿›è¡Œç›‘æ§ï¼Œå„ä¸ªå“¨å…µä¹‹é—´è¿˜ä¼šè¿›è¡Œç›‘æ§ï¼Œè¿™æ ·å°±å½¢æˆäº†å¤šå“¨å…µæ¨¡å¼ã€‚</p>
<img src= "https://khighness-blog.oss-cn-shanghai.aliyuncs.com/common/loading.gif" data-lazy-src="/posts/bae4ff13/sentinel.jpg" class="" title="sentinel">



<p>å‡è®¾ä¸»æœåŠ¡å™¨å®•æœºï¼Œå“¨å…µ1å…ˆæ£€æµ‹åˆ°è¿™ä¸ªç»“æœï¼Œç³»ç»Ÿå¹¶ä¸ä¼šé©¬ä¸Šè¿›è¡Œfailoverè¿‡ç¨‹ï¼Œä»…ä»…æ˜¯å“¨å…µ1ä¸»ç®¡çš„è®¤ä¸ºä¸»æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œä»…ä»…æ˜¯å“¨å…µ1ä¸»è§‚çš„è®¤ä¸ºä¸»æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œè¿™ä¸ªç°è±¡ç§°ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œå½“åé¢çš„å“¨å…µä¹Ÿæ£€æµ‹åˆ°ä¸»æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œå¹¶ä¸”æ•°é‡è¾¾åˆ°ä¸€å®šå€¼æ—¶ï¼Œé‚£ä¹ˆå“¨å…µä¹‹é—´å°±ä¼šè¿›è¡Œä¸€æ¬¡æŠ•ç¥¨ï¼ŒæŠ•ç¥¨çš„ç»“æœç”±ä¸€ä¸ªå“¨å…µå‘èµ·ï¼Œè¿›è¡Œfailover[æ•…éšœè½¬ç§»]æ“ä½œã€‚åˆ‡æ¢æˆåŠŸåï¼Œå°±ä¼šé€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œè®©å„ä¸ªå“¨å…µæŠŠè‡ªå·±ç›‘æ§çš„ä»æœåŠ¡å™¨å®ç°åˆ‡æ¢ä¸»æœºï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå®¢è§‚ä¸‹çº¿ã€‚</p>
<h3 id="15-2-ğŸæµ‹è¯•"><a href="#15-2-ğŸæµ‹è¯•" class="headerlink" title="15.2 ğŸæµ‹è¯•"></a>15.2 ğŸæµ‹è¯•</h3><p>å‡†å¤‡ä¸‰ä¸ªredisæœåŠ¡ï¼Œ6379-masterã€6380-slaveã€6381-slave</p>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶sentinel.conf</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sentinel monitor mymaster 127.0.0.1 6379 1</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨å“¨å…µ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">34055:X 20 Oct 2020 14:39:15.404 * Increased maximum number of open files to 10032 (it was originally set to 1024).</span><br><span class="line">                _._                                                  </span><br><span class="line">           _.-``__ &#x27;&#x27;-._                                             </span><br><span class="line">      _.-``    `.  `_.  &#x27;&#x27;-._           Redis 5.0.8 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ &#x27;&#x27;-._                                   </span><br><span class="line"> (    &#x27;      ,       .-`  | `,    )     Running in sentinel mode</span><br><span class="line"> |`-._`-...-` __...-.``-._|&#x27;` _.-&#x27;|     Port: 26379</span><br><span class="line"> |    `-._   `._    /     _.-&#x27;    |     PID: 34055</span><br><span class="line">  `-._    `-._  `-./  _.-&#x27;    _.-&#x27;                                   </span><br><span class="line"> |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|                                  </span><br><span class="line"> |    `-._`-._        _.-&#x27;_.-&#x27;    |           http://redis.io        </span><br><span class="line">  `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;                                   </span><br><span class="line"> |`-._`-._    `-.__.-&#x27;    _.-&#x27;_.-&#x27;|                                  </span><br><span class="line"> |    `-._`-._        _.-&#x27;_.-&#x27;    |                                  </span><br><span class="line">  `-._    `-._`-.__.-&#x27;_.-&#x27;    _.-&#x27;                                   </span><br><span class="line">      `-._    `-.__.-&#x27;    _.-&#x27;                                       </span><br><span class="line">          `-._        _.-&#x27;                                           </span><br><span class="line">              `-.__.-&#x27;                                               </span><br><span class="line"></span><br><span class="line">34055:X 20 Oct 2020 14:39:15.407 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">34055:X 20 Oct 2020 14:39:15.408 # Sentinel ID is dbfb304470e8ed2bb81b4be42f847e21ff5d9519</span><br><span class="line">34055:X 20 Oct 2020 14:39:15.408 # +monitor master mymaster 127.0.0.1 6379 quorum 1</span><br><span class="line">34055:X 20 Oct 2020 14:40:15.646 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:40:25.731 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br></pre></td></tr></table></figure>

<p>å…³é—­masteræœåŠ¡</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 6379: master -&gt; shutdown</span></span><br><span class="line">127.0.0.1:6379&gt; SHUTDOWN</span><br><span class="line">not connected&gt; exit</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç›‘æ§åˆ°masterå®•æœº</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é€‰å‡º6380ä¸ºmaster</span></span><br><span class="line">34055:X 20 Oct 2020 14:43:47.509 # +sdown master mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:47.509 # +odown master mymaster 127.0.0.1 6379 #quorum 1/1</span><br><span class="line">34055:X 20 Oct 2020 14:43:47.509 # +new-epoch 1</span><br><span class="line">34055:X 20 Oct 2020 14:43:47.509 # +try-failover master mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:47.510 # +vote-for-leader dbfb304470e8ed2bb81b4be42f847e21ff5d9519 1</span><br><span class="line">34055:X 20 Oct 2020 14:43:47.510 # +elected-leader master mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:47.510 # +failover-state-select-slave master mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:47.594 # +selected-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:47.594 * +failover-state-send-slaveof-noone slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:47.678 * +failover-state-wait-promotion slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:48.296 # +promoted-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:48.296 # +failover-state-reconf-slaves master mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:48.371 * +slave-reconf-sent slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:49.310 * +slave-reconf-inprog slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:49.310 * +slave-reconf-done slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:49.362 # +failover-end master mymaster 127.0.0.1 6379</span><br><span class="line">34055:X 20 Oct 2020 14:43:49.362 # +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6380</span><br><span class="line">34055:X 20 Oct 2020 14:43:49.362 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6380</span><br><span class="line">34055:X 20 Oct 2020 14:43:49.362 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380</span><br><span class="line">34055:X 20 Oct 2020 14:44:19.365 # +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6380: æ–°ç‹ç™»åŸº</span></span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=127.0.0.1,port=6381,state=online,offset=42337,lag=1</span><br><span class="line">master_replid:12a540accf0c9347d3e45fad83ccddea86f3b3c3</span><br><span class="line">master_replid2:b80e4fbbe06a83ac070f38e89267bd81b26ec5ca</span><br><span class="line">master_repl_offset:42351</span><br><span class="line">second_repl_offset:20188</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:8342</span><br><span class="line">repl_backlog_histlen:34010</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6381: å‚æ‹œæ–°ç‹</span></span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6380</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:0</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:63969</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:12a540accf0c9347d3e45fad83ccddea86f3b3c3</span><br><span class="line">master_replid2:b80e4fbbe06a83ac070f38e89267bd81b26ec5ca</span><br><span class="line">master_repl_offset:63969</span><br><span class="line">second_repl_offset:20188</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:8053</span><br><span class="line">repl_backlog_histlen:55917</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é‡å¯6379çš„æœåŠ¡</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é‡å¯ä¹‹åä¿¯é¦–ç§°è‡£</span></span><br><span class="line">[root@master bin]# redis-server kconfig/redis6379.conf </span><br><span class="line">[root@master bin]# redis-cli -p 6379</span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; info relplication</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6380</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:2</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:50522</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:12a540accf0c9347d3e45fad83ccddea86f3b3c3</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:50522</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:48596</span><br><span class="line">repl_backlog_histlen:1927</span><br></pre></td></tr></table></figure>



<h3 id="15-3-ğŸŒ ä¼˜ç‚¹"><a href="#15-3-ğŸŒ ä¼˜ç‚¹" class="headerlink" title="15.3 ğŸŒ ä¼˜ç‚¹"></a>15.3 ğŸŒ ä¼˜ç‚¹</h3><ul>
<li>å“¨å…µé›†ç¾¤ï¼ŒåŸºäºä¸»ä»å¤åˆ¶æ¨¡å¼ï¼Œç»§æ‰¿äº†ä¸»ä»çš„æ‰€æœ‰ä¼˜ç‚¹</li>
<li>ä¸»ä»å¯ä»¥åˆ‡æ¢ï¼Œæ•…éšœå¯ä»¥è½¬ç§»ï¼Œå¢å¼ºç³»ç»Ÿçš„å¯ç”¨æ€§</li>
<li>å“¨å…µæ¨¡å¼æ˜¯ä¸»ä»æ¨¡å¼çš„å‡çº§ç‰ˆï¼Œæ‰‹åŠ¨åˆ°è‡ªåŠ¨ï¼Œæ›´åŠ å¥å£®</li>
</ul>
<h3 id="15-4-ğŸ“°é…ç½®è¯¦è§£"><a href="#15-4-ğŸ“°é…ç½®è¯¦è§£" class="headerlink" title="15.4 ğŸ“°é…ç½®è¯¦è§£"></a>15.4 ğŸ“°é…ç½®è¯¦è§£</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> sentinel.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å“¨å…µsentinelå®ä¾‹è¿è¡Œçš„ç«¯å£ï¼Œé»˜è®¤26379</span></span><br><span class="line">port 26379</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®ˆæŠ¤è¿›ç¨‹ </span></span><br><span class="line">daemonize no</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿›ç¨‹æ–‡ä»¶</span></span><br><span class="line">pidfile &quot;/var/run/redis-sentinel.pid&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿›ç¨‹æ–‡ä»¶</span></span><br><span class="line">logfile &quot;&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å·¥ä½œç›®å½•</span></span><br><span class="line">dir &quot;/tmp&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å“¨å…µsentinelç›‘æ§çš„masterçš„IPå’ŒPort</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> quorumé…ç½®å¤šå°‘ä¸ªå“¨å…µç»Ÿä¸€è®¤ä¸ºmasterå¤±è”ã€‚é‚£ä¹ˆè¿™æ—¶å®¢è§‚ä¸Šè®¤ä¸ºä¸»ç»“ç‚¹å¤±è”</span></span><br><span class="line">sentinel monitor &lt;master-name&gt; &lt;master-ip&gt; &lt;redis-ip&gt; &lt;quorum&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨rediså®ä¾‹ä¸­å¼€å¯äº†æˆæƒå¯†ç </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è®¾ç½®å“¨å…µsentiçš„è¿æ¥å¯†ç </span></span><br><span class="line">sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é…ç½®æŒ‡å®šåœ¨å‘ç”Ÿfailoverä¸»ä»åˆ‡æ¢æ—¶æœ€å¤šå¯ä»¥æœ‰å¤šå°‘ä¸ªslaveåŒæ—¶å¯¹æ–°çš„masteråŒæ­¥</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> numreplicasè¶Šå°ï¼Œå®Œæˆfailoverçš„äº‹ä»¶å°±è¶Šé•¿</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> numreplicasè¶Šå¤§ï¼Œå°±æ„å‘³ç€è¶Šå¤šçš„slaveå› ä¸ºreplication(å¤åˆ¶)è€Œä¸å¯ç”¨</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> numreplicasè®¾ç½®ä¸º1ï¼Œä¿è¯æ¯æ¬¡åªæœ‰slaveå¤„äºä¸èƒ½å¤„ç†å‘½ä»¤è¯·æ±‚çš„çŠ¶æ€</span></span><br><span class="line">sentinel parallel-syncs &lt;master-name&gt; &lt;numreplicas&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é…ç½®æŒ‡å®šå¤šmillisecondsæ¯«ç§’ä¹‹åï¼Œmasteræ²¡æœ‰å“åº”sentinel</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ­¤æ—¶ï¼Œå“¨å…µä¸»è§‚ä¸Šè®¤ä¸ºmasterä¸‹çº¿ï¼Œé»˜è®¤30ç§’</span></span><br><span class="line">sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é…ç½®æ•…éšœè½¬ç§»çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤2åˆ†é’Ÿ</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯ä»¥ç”¨äºä»¥ä¸‹æ–¹é¢</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1. åŒä¸€sentinelå¯¹åŒä¸€ä¸ªmasterä¸¤æ¬¡failo verçš„é—´éš”æ—¶é—´</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. å½“ä¸€ä¸ªslaveä»ä¸€ä¸ªé”™è¯¯çš„masteré‚£é‡ŒåŒæ­¥æ•°æ®å¼€å§‹è®¡ç®—æ—¶é—´ï¼Œç›´è‡³slaveè¢«çº æ­£ä¸ºå‘æ­£ç¡®çš„masteré‚£é‡ŒåŒæ­¥æ•°æ®</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. å½“æƒ³è¦å–æ¶ˆä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„failoveréœ€è¦çš„æ—¶é—´</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. å½“è¿›è¡Œfailoveræ—¶ï¼Œé…ç½®æ‰€æœ‰slavesæŒ‡å‘æ–°çš„masteræ‰€éœ€çš„æœ€å¤§æ—¶é—´</span></span><br><span class="line">sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> é€šçŸ¥è„šæœ¬</span></span><br><span class="line">sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®¢æˆ·ç«¯é‡æ–°é…ç½®ä¸»èŠ‚ç‚¹å‚æ•°è„šæœ¬</span></span><br><span class="line">sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</span><br></pre></td></tr></table></figure>



<h2 id="16-ğŸ“©Redisç©¿é€ã€å‡»ç©¿å’Œé›ªå´©"><a href="#16-ğŸ“©Redisç©¿é€ã€å‡»ç©¿å’Œé›ªå´©" class="headerlink" title="16. ğŸ“©Redisç©¿é€ã€å‡»ç©¿å’Œé›ªå´©"></a>16. ğŸ“©Redisç©¿é€ã€å‡»ç©¿å’Œé›ªå´©</h2><h3 id="16-1-ğŸ”¥ç¼“å­˜ç©¿é€"><a href="#16-1-ğŸ”¥ç¼“å­˜ç©¿é€" class="headerlink" title="16.1 ğŸ”¥ç¼“å­˜ç©¿é€"></a>16.1 ğŸ”¥ç¼“å­˜ç©¿é€</h3><blockquote>
<p>ğŸ’­é—®é¢˜è¯´æ˜</p>
</blockquote>
<p>æŸ¥è¯¢çš„keyå¯¹åº”çš„æ•°æ®ä¸åœ¨redisç¼“å­˜ä¸­ï¼Œå³ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œäºæ˜¯å‘æŒä¹…å±‚æ•°æ®åº“æŸ¥è¯¢ï¼Œæ•°æ®åº“ä¹Ÿæ²¡æœ‰ï¼Œå½“è¯·æ±‚é‡è¿‡å¤§çš„æ—¶å€™ï¼Œå¯èƒ½å‹å®æ•°æ®åº“ã€‚</p>
<p>å³å¤§é¢ç§¯çš„ç¼“å­˜å¤±æ•ˆï¼Œå¤§å¹¶å‘è¯·æ±‚æ‰“å´©DBã€‚</p>
<blockquote>
<p>ğŸ’–è§£å†³æ–¹æ³•</p>
</blockquote>
<p>1ï¸âƒ£<strong>å‚æ•°æ ¡éªŒ</strong></p>
<p>åœ¨æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œä¸åˆæ³•çš„å‚æ•°ç›´æ¥returnï¼Œæ¯”å¦‚id&lt;0ç›´æ¥æ‹¦æˆªã€‚</p>
<p>2ï¸âƒ£<strong>å¸ƒéš†è¿‡æ»¤å™¨</strong></p>
<p>åˆ©ç”¨é«˜æ•ˆçš„æ•°æ®ç»“æ„å’Œç®—æ³•å¿«é€Ÿåˆ¤æ–­å‡ºä½ è¿™ä¸ªKeyæ˜¯å¦åœ¨æ•°æ®åº“ä¸­å­˜åœ¨ï¼Œä¸å­˜åœ¨ä½ returnå°±å¥½äº†ï¼Œå­˜åœ¨ä½ å°±å»æŸ¥DBåˆ·æ–°KVå†returnã€‚</p>
<p>3ï¸âƒ£<strong>ç¼“å­˜ç©ºå¯¹è±¡</strong></p>
<p>å½“å­˜å‚¨å±‚ä¸å‘½ä¸­åï¼Œå³ä½¿è¿”å›çš„ç©ºå¯¹è±¡ä¹Ÿå°†å…¶ç¼“å­˜èµ·æ¥ï¼ŒåŒæ—¶ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œä¹‹åå†è®¿é—®è¿™ä¸ªæ•°æ®å°†ä¼šä»ç¼“å­˜ä¸­è·å–ï¼Œä¿æŠ¤æ•°æ®åº“ã€‚</p>
<h3 id="16-2-ğŸ’§ç¼“å­˜å‡»ç©¿"><a href="#16-2-ğŸ’§ç¼“å­˜å‡»ç©¿" class="headerlink" title="16.2 ğŸ’§ç¼“å­˜å‡»ç©¿"></a>16.2 ğŸ’§ç¼“å­˜å‡»ç©¿</h3><blockquote>
<p>ğŸ’­é—®é¢˜è¯´æ˜</p>
</blockquote>
<p>æŸ¥è¯¢çš„ä¸€ä¸ªkeyéå¸¸çƒ­ç‚¹ï¼Œåœ¨ä¸åœåœ°æ‰›ç€å¤§é‡çš„è¯·æ±‚ï¼Œå¤§å¹¶å‘é›†ä¸­å¯¹è¿™ä¸€ä¸ªç‚¹è¿›è¡Œè®¿é—®ï¼Œå½“è¿™ä¸ªkeyåœ¨å¤±æ•ˆçš„ç¬é—´ï¼ŒæŒç»­çš„å¤§å¹¶å‘ç›´æ¥è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå°±åœ¨è¿™ä¸ªKeyçš„ç‚¹ä¸Šå‡»ç©¿äº†ç¼“å­˜ã€‚</p>
<p>å³å•ä¸ªkeyçš„ç¼“å­˜å¤±æ•ˆï¼Œå¤§å¹¶å‘è¯·æ±‚å‡»ç©¿redisç›´è½DBã€‚</p>
<blockquote>
<p>ğŸ’™è§£å†³æ–¹æ³•</p>
</blockquote>
<p>è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸï¼Œæˆ–è€…åŠ ä¸Šäº’æ–¥é”ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getData</span><span class="params">(String key)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//ä»RedisæŸ¥è¯¢æ•°æ®</span></span><br><span class="line">        String result = getDataByKV(key);</span><br><span class="line">        <span class="comment">//å‚æ•°æ ¡éªŒ</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(result)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//è·å¾—é”</span></span><br><span class="line">                <span class="keyword">if</span> (reenLock.tryLock()) &#123;</span><br><span class="line">                    <span class="comment">//å»æ•°æ®åº“æŸ¥è¯¢</span></span><br><span class="line">                    result = getDataByDB(key);</span><br><span class="line">                    <span class="comment">//æ ¡éªŒ</span></span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.isNotBlank(result)) &#123;</span><br><span class="line">                        <span class="comment">//æ’è¿›ç¼“å­˜</span></span><br><span class="line">                        setDataToKV(key, result);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//ç¡ä¸€ä¼šå†æ‹¿</span></span><br><span class="line">                    Thread.sleep(<span class="number">100L</span>);</span><br><span class="line">                    result = getData(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">                reenLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="16-3-ğŸŒŠç¼“å­˜é›ªå´©"><a href="#16-3-ğŸŒŠç¼“å­˜é›ªå´©" class="headerlink" title="16.3 ğŸŒŠç¼“å­˜é›ªå´©"></a>16.3 ğŸŒŠç¼“å­˜é›ªå´©</h3><blockquote>
<p>ğŸ’­é—®é¢˜è¯´æ˜</p>
</blockquote>
<p>å½“redisæœåŠ¡å™¨é‡å¯æˆ–åˆ™å¤§é‡ç¼“å­˜é›†ä¸­åœ¨æŸä¸€ä¸ªæ—¶é—´æ®µå¤±æ•ˆï¼Œç¬é—´Redisè·Ÿæ²¡æœ‰ä¸€æ ·ï¼Œé‚£è¿™ä¸ªæ•°é‡çº§åˆ«çš„è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“å‡ ä¹æ˜¯ç¾éš¾æ€§çš„</p>
<blockquote>
<p>ğŸ’šè§£å†³æ–¹æ³•</p>
</blockquote>
<p>1ï¸âƒ£<strong>redisé«˜å¯ç”¨</strong></p>
<p>æ­å»ºé›†ç¾¤ï¼Œå¼‚åœ°å¤šæ´»</p>
<p>2ï¸âƒ£<strong>é™æµé™çº§</strong></p>
<p>åœ¨ç¼“å­˜å¤±æ•ˆåï¼Œé€šè¿‡åŠ é”æˆ–è€…é˜Ÿåˆ—å“æ§åˆ¶è¯»æ•°æ®åº“å†™ç¼“å­˜çš„çº¿ç¨‹æ•°é‡</p>
<p>3ï¸âƒ£<strong>æ•°æ®é¢„çƒ­</strong></p>
<p>åœ¨æ­£å¼éƒ¨ç½²ä¹‹å‰ï¼Œå…ˆæŠŠå¯èƒ½çš„æ•°æ®é¢„å…ˆè®¿é—®ä¸€éï¼Œè®©å¯èƒ½çš„æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚</p>
<p>åœ¨å³å°†å‘ç”Ÿå¤§å¹¶å‘è®¿é—®å†™å…¥keyçš„æ—¶å€™ï¼Œè®¾ç½®ä¸åŒçš„ç¼“å­˜æ—¶é—´ï¼Œè®©ç¼“å­˜å¤±æ•ˆçš„æ—¶é—´ç‚¹å°½é‡å‡åŒ€ã€‚</p>
]]></content>
      <categories>
        <category>MiddleWare</category>
      </categories>
      <tags>
        <tag>Cache</tag>
      </tags>
  </entry>
</search>
