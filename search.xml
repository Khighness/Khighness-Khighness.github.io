<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello, World</title>
    <url>/posts/19577/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ğŸš€ ç•ªå¤–ï¼š<a href="https://pan.baidu.com/s/1wPglwA80SSlQCoGbrJdATQ">https://pan.baidu.com/s/1wPglwA80SSlQCoGbrJdATQ</a> ï¼Œæå–ç ï¼škkkk </p>
<p>âš¡ é¢„è­¦ï¼šå¤šé‡ä¸–ç•Œï¼Œå¤šé‡ç©¿è¶Šï¼Œç›´å®å’Œç‰ç’ƒåœ¨è™šå®ä¸­çš„åŒå‘æ•‘èµã€‚</p>
<p>â“ è¿·æƒ‘ï¼šå‰ä¼ â€”â€”ç”·ä¸»åœ¨åŠªåŠ›æ•‘å¥³ä¸»ï¼Œç»“å°¾â€”â€”å¥³ä¸»åœ¨æœˆçƒæ•‘ç”·ä¸»ã€‚</p>
<blockquote>
<p>â€”â€”å³æ—¶ä¸–ç•Œæ¯ç­ï¼Œæˆ‘ä¹Ÿæƒ³å†è§ä½ ä¸€é¢ã€‚</p>
<p>â€”â€”äº¤å¾€æ˜¯ä¸€ä¸ªäººåšä¸åˆ°çš„ï¼Œæˆ‘ä»¬ä¸¤ä¸ªäººä¸€èµ·è¯•è¯•ã€‚</p>
<p>â€”â€”å¦‚æ²³è¾¹çš„èŠ±æœµèˆ¬ï¼Œæ¸©æŸ”ç»½æ”¾çš„ç¬‘å®¹ã€‚æˆ‘å–œæ¬¢çš„ï¼Œå°±æ˜¯å¥¹è¿™æ ·çš„ç¬‘å®¹ã€‚</p>
</blockquote>
<h2 id="å‰§æƒ…"><a href="#å‰§æƒ…" class="headerlink" title="å‰§æƒ…"></a>å‰§æƒ…</h2><p>ç•ªå¤–ï¼šè®²è¿°ç”·ä¸»ï¼ˆåšä¹¦ç›´å®ï¼‰ä¸å¥³ä¸»ï¼ˆä¸€è¡Œç‘ ç’ƒï¼‰ç›¸è¯†ã€ç›¸çˆ±ã€ç›¸ç¦»ã€‚å¥³ä¸»è¢«é›·ç”µæ‰€ä¼¤åè„‘æ­»äº¡ï¼Œç”·ä¸»å¥‹åŠ›å­¦ä¹ æƒ³æ•‘å›å¥³ä¸»ã€‚è¿™éƒ¨åˆ†æ°”æ°›å¾ˆå‹æŠ‘ï¼Œç”·ä¸»çš„ä¸–ç•Œæç»˜ä¸ºç°è‰²ï¼Œä½†æ˜¯æœ‰å¾ˆå¼ºçš„æƒ…æ„Ÿå¼ åŠ›ï¼Œç»†èŠ‚éƒ¨åˆ†æ¯”æ­£ç‰‡è¦å¥½ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/19577/Die.jpg" class="" title="Die">

<p>èƒŒæ™¯ï¼šé«˜ç§‘æŠ€é˜¿å°”å¡”æ‹‰é€šè¿‡é‡å­ç§‘æŠ€å®ç°æ— é™å­˜å‚¨ï¼Œå®ƒä¸äº¬éƒ½å¸‚è¿›è¡Œé¡¹ç›®åˆä½œï¼Œå­˜å‚¨åŸå¸‚è®°å¿†ï¼Œè¿›è¡Œå†å²å¤ç°ã€‚</p>
<p>æ•´éƒ¨ç”µå½±ä¸»è¦åˆ’åˆ†å››ä¸ªæ—¶ç©ºï¼š2027å¹´â€”â€”ç¬¬ä¸€æ—¶ç©ºï¼ˆè™šæ‹Ÿæ•°æ®ï¼‰ã€2037å¹´â€”â€”ç¬¬äºŒæ—¶ç©ºï¼ˆè™šæ‹Ÿæ•°æ®ï¼‰ã€2047å¹´â€”â€”ç¬¬ä¸‰æ—¶ç©ºï¼ˆçœŸå®ä¸–ç•Œï¼‰ä»¥åŠä¸€ä¸ªå…¨æ–°æ—¶ç©ºï¼ˆè™šæ‹Ÿæ•°æ®ï¼‰ã€‚</p>
<p>ç¬¬äºŒæ—¶ç©ºçš„ç›´å®ï¼ˆç•ªå¤–ç”·ä¸»ï¼Œç®€ç§°è€å¸ˆï¼‰ï¼Œä¸ºäº†æ•‘ç‰ç’ƒï¼Œä½¿ç”¨é˜¿å°”å¡”æ‹‰ç³»ç»Ÿçš„äº¬éƒ½2027å¹´æ•°æ®ï¼Œåˆ›é€ å‡ºç¬¬ä¸€æ—¶ç©ºï¼Œä¼å›¾æ”¹å˜å†å²ï¼Œä¿æŠ¤ç‰ç’ƒã€‚</p>
<p>ç²¾ç¥å½¢æ€çš„ä»–æ¥åˆ°ç¬¬ä¸€æ—¶ç©ºï¼Œæ— æ³•ä½œå‡ºç‰©è´¨æ”¹å˜ã€‚ç¢°å·§çš„æ˜¯ç©¿è¶Šè¿‡æ¥ç›´æ¥ç¢°åˆ°äº†åå¹´å‰çš„ç›´å®ï¼Œæ³¢æŠ˜ä¹‹åç›´å®æ¥å—äº†ä»–æœªæ¥çš„è®¾å®šï¼Œå¹¶å†³å®šå¸®åŠ©è€å¸ˆã€‚</p>
<p>åœ¨æœªæ¥æœ€å¼ºç§˜ç±çš„æŒ‡å¼•ä¸‹ï¼Œç›´å®ä¸ç‰ç’ƒé€æ¸å‡æ¸©å¹¶è¡¨ç™½æˆåŠŸã€‚åŒæ—¶ï¼Œç›´å®é ä¹Œé¸¦èµ äºˆçš„ç¥ä¹‹æ‰‹ä¸æ–­ç»ƒä¹ è€å¸ˆæ•™çš„åˆ›é€ æœ¯ï¼Œä¸€åˆ‡æ— å…³æƒ…æ„Ÿç²¾ç¥çš„ä¸œè¥¿çš†å¯åˆ›é€ ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/19577/Know.jpg" class="" title="Know">

<p>çƒŸèŠ±å¤§ä¼šä¹‹å¤œï¼Œç‹é¢äººï¼ˆé˜¿å°”å¡”æ‹‰è‡ªåŠ¨ä¿®å¤ç³»ç»Ÿï¼‰çªç„¶ç°èº«ï¼Œå®ƒä»¬æ„ŸçŸ¥åˆ°è®°å½•è¦è¢«ç¯¡æ”¹ï¼Œä¼å›¾å°†ä¸–ç•Œæ¢å¤åˆ°æ­£ç¡®çŠ¶æ€ã€‚ç›´å®å‡»é€€ç‹é¢äººåï¼Œä½¿ç”¨ç¥ä¹‹æ‰‹åˆ›é€ å‡ºé»‘æ´æŠµå¾¡é›·ç”µï¼ŒæˆåŠŸä¿æŠ¤ç‰ç’ƒã€‚</p>
<p>ä½†æ˜¯ï¼Œè€å¸ˆçªç„¶æ¨ªåˆ€å¤ºçˆ±ï¼Œå¸¦èµ°ç‰ç’ƒã€‚å› ä¸ºæ­¤æ—¶çš„ç‰ç’ƒï¼Œä¸åå¹´å‰è„‘æ­»äº¡çš„ç‰ç’ƒçš„ç²¾ç¥çŠ¶æ€åŸºæœ¬ä¸€è‡´ï¼Œåªè¦å°†2027å¹´çš„ç‰ç’ƒæ•°æ®å¸¦å›åˆ°2037å¹´ï¼Œå¹¶å°†æ•°æ®ä¸­çš„é‡å­ç²¾ç¥åŒæ­¥åˆ°ç¬¬äºŒæ—¶ç©ºç‰ç’ƒçš„ç‰©ç†ç²¾ç¥ï¼Œå°±èƒ½è®©å¥¹è‹é†’ã€‚ä½†æ˜¯ç‰ç’ƒè‹é†’çš„åŒæ—¶ï¼Œå¸¦ç€2027å¹´çš„æ•°æ®è®°å¿†ï¼Œè®¤å‡ºé¢å‰è¿™ä¸ªè€å¸ˆå¹¶éè‡ªå·±æ‰€çˆ±çš„ç›´å®ã€‚</p>
<p>ç¬¬ä¸€æ—¶ç©ºä¸­ï¼Œç›´å®å¤±å»æ‰€çˆ±ï¼ŒåŒæ—¶å¤±å»ç¥ä¹‹æ‰‹ã€‚ç‰ç’ƒæ•°æ®çš„ç¯¡æ”¹æ‰€å½±å“çš„èŒƒå›´è¶Šæ¥è¶Šå¤§ï¼Œé˜¿å°”å¡”æ‹‰ç ”ç©¶å®¤åœ¨ä¿®å¤æ— æœåå†³å®šé‡å¯ç¬¬ä¸€æ—¶ç©ºã€‚</p>
<p>ç—›è‹¦çš„ç›´å®æ„Ÿå—åˆ°ä¸–ç•Œå³å°†æ¯ç­ï¼Œæ¯…ç„¶è¿›å…¥è™«æ´å»æ•‘ç‰ç’ƒï¼Œå¹¶åœ¨æ—¶ç©ºéš§é“ä¸­ç›¸é‡ä¹Œé¸¦ã€‚ä¹Œé¸¦é‡æ–°èµ äºˆå…¶ç¥ä¹‹æ‰‹ï¼Œå¹¶æŒ‡å¼•ä»–å»ç¬¬äºŒæ—¶ç©ºæ•‘ç‰ç’ƒã€‚</p>
<p>ç¬¬äºŒæ—¶ç©ºä¸­ï¼Œå¼€å§‹å‡ºç°ç‹é¢äººï¼Œæ‰€ä»¥ç¬¬äºŒæ—¶ç©ºä¹Ÿæ˜¯è™šæ‹Ÿæ•°æ®ï¼Œå› ä¸ºç‰ç’ƒæ•°æ®è¢«ç¯¡æ”¹ï¼ŒåˆåŒæ—¶å‡ºç°äº†ä¸¤ä¸ªç›´å®ã€‚ç‹é¢äººå¿…é¡»æ¶ˆç­ç‰ç’ƒå’Œä¸¤ä¸ªç›´å®å…¶ä¸­çš„ä¸€ä¸ªã€‚</p>
<p>ä¸ºäº†åº”å¯¹ä¿®å¤ç³»ç»Ÿçš„ç‹é¢äººï¼Œç›´å®å¸¦ç€ç‰ç’ƒé€ƒè·‘ï¼Œè€å¸ˆä¹Ÿå¼€å§‹é†’æ‚Ÿã€‚åœ¨è€å¸ˆå’Œä¹Œé¸¦çš„å¸®åŠ©ä¸‹ï¼Œç›´å®å°†ç‰ç’ƒä¼ åˆ°å¦ä¸€å…¨æ–°æ—¶ç©ºã€‚è€å¸ˆæ·±çŸ¥ï¼Œä¸ªäººæ•°æ®è¿˜æ˜¯éš¾ä»¥æŠµæŒ¡ä¿®å¤ç³»ç»Ÿçš„åŠ›é‡ï¼Œæœ€åæ›¿ç›´å®æŠµæŒ¡ç³»ç»Ÿçš„æ”»å‡»ï¼Œç‰ºç‰²äº†è‡ªå·±ã€‚</p>
<p>ç›´å®å’Œç‰ç’ƒå»åˆ°å…¨æ–°æ—¶ç©ºï¼Œç›¸æ‹¥åœ¨ä¸€èµ·ã€‚</p>
<p>å½±ç‰‡çš„ç»“å°¾æ¥åˆ°äº†ç¬¬ä¸‰æ—¶ç©ºâ€”â€”æœˆçƒçš„ç ”ç©¶å®¤ï¼Œ2047å¹´ï¼Œç›´å®é†’æ¥ï¼Œå¹¶ä¸ç‰ç’ƒç›¸æ‹¥åœ¨ä¸€èµ·ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/19577/RealWorld.jpg" class="" title="RealWorld"> 



<h2 id="ç†è§£"><a href="#ç†è§£" class="headerlink" title="ç†è§£"></a>ç†è§£</h2><p>ä¸ºäº†ç†æ¸…é€»è¾‘ï¼Œåº”è¯¥ä»ç°å®ä¸–ç•Œåæ¨ã€‚</p>
<p>ã€ç¬¬ä¸‰æ—¶ç©ºâ€”â€”ç°å®ä¸–ç•Œã€‘</p>
<p>2027å¹´ï¼Œç›´å®ä¸ç‰ç’ƒç›¸è¯†ç›¸æ‹ã€‚</p>
<p>åœ¨çƒŸèŠ±å¤§ä¼šä¸Šï¼Œç›´å®ä¸ºäº†æ•‘ç‰ç’ƒï¼Œè¢«é›·ç”µå‡»ä¸­åè„‘æ­»äº¡ã€‚ã€æ­»äº¡æ—¶çš„ç²¾ç¥ï¼šä¸ºæ‰€çˆ±ä¹‹äººç‰ºç‰²è‡ªå·±ã€</p>
<p>ç‰ç’ƒç»è¿‡äº†10å¹´çš„å­¦ä¹ ä¸ç ”ç©¶ï¼Œå°†æ˜è¿·åå¹´çš„ç›´å®å¸¦ä¸Šäº†æœˆçƒçš„ç§‘ç ”åŸºåœ°ã€‚</p>
<p>ä¸ºäº†æ‹¯æ•‘ç›´å®ï¼Œç‰ç’ƒä½¿ç”¨é˜¿å°”å¡”æ‹‰åˆ›é€ ç¬¬äºŒæ—¶ç©ºï¼Œå¤ç°é›·å‡»åœºæ™¯ï¼Œä¼å›¾ä¿æŠ¤ç›´å®ï¼Œè·å–æ­¤æ—¶çš„é‡å­æ•°æ®ï¼Œä»¥åŒæ­¥ç°å®ä¸–ç•Œçš„ç‰©ç†ç²¾ç¥ã€‚ä½†æ˜¯è®¡åˆ’å¤±è´¥ï¼Œç‰ç’ƒè¢«é›·å‡»ä¸­åè„‘æ­»äº¡ã€‚</p>
<p>ã€ç¬¬äºŒæ—¶ç©ºâ€”â€”è™šæ‹Ÿæ•°æ®ã€‘</p>
<p>ç›´å®ç»è¿‡äº†åå¹´çš„å­¦ä¹ å’Œç ”ç©¶ï¼Œä¸ºäº†æ‹¯æ•‘ç‰ç’ƒï¼Œåœ¨è‡ªå·±èº«ä¸Šåšäº†æ— æ•°æ¬¡è¯•éªŒã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/19577/Try.jpg" class="" title="Try">

<p>æœ€ç»ˆä½¿ç”¨é˜¿å°”å¡”æ‹‰åˆ›é€ å‡ºç¬¬ä¸€æ—¶ç©ºï¼Œå¤ç°é›·å‡»åœºæ™¯ï¼ŒæˆåŠŸä¿æŠ¤ç‰ç’ƒï¼Œå¸¦èµ°äº†ç¬¬ä¸€æ—¶ç©ºçš„ç‰ç’ƒï¼Œå¯¼å…¥é‡å­ç²¾ç¥åˆ°ç¬¬äºŒæ—¶ç©ºç‰ç’ƒã€‚</p>
<p>ä½†æ˜¯ç¬¬äºŒæ—¶ç©ºçš„ç‰ç’ƒä¾ç„¶çˆ±ç€ç¬¬ä¸€æ—¶ç©ºçš„ç›´å®ï¼Œæœ€ç»ˆä¸ºäº†ç¬¬äºŒæ—¶ç©ºçš„å¥³ä¸»ï¼Œæ›¿ç¬¬ä¸€æ—¶ç©ºçš„ç”·ä¸»æŒ¡ä¸‹è‡´å‘½æ”»å‡»ç„¶åæ­»äº¡ã€‚ã€æ­»äº¡æ—¶çš„ç²¾ç¥ï¼šä¸ºæ‰€çˆ±ä¹‹äººç‰ºç‰²è‡ªå·±ã€</p>
<p>æ­¤æ—¶ä¹Œé¸¦æˆåŠŸè·å–åˆ°ç¬¬äºŒæ—¶ç©ºç›´å®çš„é‡å­ç²¾ç¥ï¼ŒåŒæ­¥åˆ°ç¬¬ä¸‰æ—¶ç©ºçš„ç›´å®ï¼Œç°å®ä¸–ç•Œçš„ç›´å®å¾—ä»¥è‹é†’ã€‚</p>
<p>ç‰ºç‰²ï¼Œé‡ç”Ÿã€‚</p>
<p>ã€å…¨æ–°æ—¶ç©ºâ€”â€”Hello Worldã€‘</p>
<p>ç¬¬äºŒæ—¶ç©ºçš„ç›´å®æ­»äº¡ä¹‹åï¼Œåƒå¤æ•™æˆå…³é—­äº†ä¿®å¤ç³»ç»Ÿã€‚</p>
<p>ç¬¬ä¸€æ—¶ç©ºçš„ç›´å®å’Œç‰ç’ƒæ¥åˆ°äº†å…¨æ–°æ—¶ç©ºï¼Œä¸å†å—åˆ°é™åˆ¶ï¼Œå³Hello Worldã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/19577/HelloWorld.jpg" class="" title="HelloWorld">

<p>ä½ å¥½ï¼Œä¸–ç•Œã€‚</p>
<h2 id="ç»†èŠ‚"><a href="#ç»†èŠ‚" class="headerlink" title="ç»†èŠ‚"></a>ç»†èŠ‚</h2><p>ç‰ç’ƒä¸ä¼šç”¨æ‰‹æœºï¼Œä½†ï¼Œåå¹´ç ”ç©¶ï¼Œåˆ›é€ å‡ºä¸¤ä¸ªè™šæ‹Ÿä¸–ç•Œã€‚</p>
<p>ç‰ç’ƒæ˜¯æœ‰æé«˜ç—‡ï¼Œä½†ï¼Œç™»ä¸Šæœˆçƒï¼Œæˆä¸ºé˜¿å°”å¡”æ‹‰ç§‘å­¦å®¶ã€‚</p>
<p>ç¬¬ä¸€æ—¶ç©ºçš„ä¹Œé¸¦ç”±ç¬¬äºŒæ—¶ç©ºçš„ç›´å®æ“çºµï¼Œç›®çš„æ˜¯å¤æ´»ç¬¬äºŒæ—¶ç©ºçš„ç‰ç’ƒã€‚</p>
<p>ç¬¬äºŒæ—¶ç©ºçš„ä¹Œé¸¦æ˜¯ç°å®ä¸–ç•Œçš„ä¸€è¡Œç‰ç’ƒï¼Œç›®çš„æ˜¯å¤æ´»ç°å®ä¸–ç•Œçš„ç›´å®ã€‚</p>
<h2 id="è¯„ä»·"><a href="#è¯„ä»·" class="headerlink" title="è¯„ä»·"></a>è¯„ä»·</h2><p>å½±ç‰‡ç»“å°¾ï¼Œçªç„¶åè½¬ï¼Œå¤šé‡æ—¶ç©ºå·²ç»æŠŠè„‘å­ç»•æ™•ï¼Œã€Šç›—æ¢¦ã€‹æœ‰å‰è½¦ä¹‹é‰´ã€‚</p>
<p>é¦–æ¬¡è§‚å½±ï¼Œè§‰å¾—æƒ…æ„Ÿçº¿æ¯”è¾ƒå•è°ƒï¼Œè—çš„å¾ˆå¤šï¼Œè¡¨ç°å¤ªå°‘ï¼Œåªèƒ½ç»†ç»†ä½“ä¼šã€‚</p>
<p>èµ°å‡ºå½±é™¢ï¼Œæ²¡æœ‰çœ‹å®Œã€Šå¤©æ°”ä¹‹å­ã€‹é‚£æ ·çš„å›è‚ è¡æ°”ï¼Œ90åˆ†é’Ÿçš„ç¡®ä¸å¤Ÿçˆ½ã€‚</p>
<p>ç¬¬ä¸€æ—¶ç©ºå¥³ä¸»çš„å†°å±±è„¸å‡ ä¹æ²¡æ€ä¹ˆå˜è¿‡ï¼Œç¬¬äºŒæ—¶ç©ºå¥³ä¸»æ¢å¼ å¿§éƒè„¸ç»§ç»­ä¿æŒï¼Œå¥½å§ï¼Œé•¿å¾—æ¼‚äº®å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºã€‚</p>
<p>ç”·ä¸»å¯¹çº¿é›·éœ†æ—¶ï¼Œå¥³ä¸»è¶´åœ¨åœ°ä¸Šèº«ä½“æ²¡åŠ¨(bug)ï¼Œç”·ä¸»æŠµå¾¡æˆåŠŸåå¥³ä¸»è„¸ä¸Šä¹Ÿæ¯«æ— æƒŠè®¶çš„è¡¨æƒ…ï¼Œå¥½åƒä¸å¤ªåˆç†ã€‚</p>
<p>å½“ç„¶ï¼Œ2Dæ¸²æŸ“3Dï¼Œç”»é£ç²¾è‡´ä¼˜ç¾ï¼Œæƒ…æ„Ÿç»†è…»çœŸå®ï¼Œçº¯çˆ±èåˆç§‘å¹»ï¼Œæƒ³è±¡ç‘°ä¸½å¥‡è°²ï¼Œè·¨è¶Šæ—¶ç©ºçš„æ•‘èµå¼•äººå…±æƒ…ã€‚</p>
<p>å¤šé‡ä¸–ç•Œï¼Œå¤šé‡è§£è¯»ï¼Œä½ å¯ä»¥é€‰æ‹©ä»»æ„åˆç†çš„è§’åº¦å»ç†è§£ã€‚</p>
<p>ä»¥ä¸Šã€‚</p>
<h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>ç”µå½±æ˜¯11å·çœ‹çš„ï¼Œå›åˆ°å®¿èˆå½±è¯„æ²¡æ¥å¾—åŠå†™å®Œã€‚</p>
<p>12å·ï¼Œå»åŒ»é™¢ä½“æ£€å›æ¥çš„è·¯ä¸Šè¢«è¯ˆéª—700ç°é‡‘ã€‚</p>
<p>å‘ç¤¾ä¼šäº¤äº†700å­¦è´¹ï¼Œæˆ–è®¸è¿™æ˜¯æˆ‘æˆé•¿çš„å¿…ç»ä¹‹äº‹ã€‚</p>
<p>è¿˜æ˜¯ä¸è‡ªæˆ‘å®‰æ…°äº†ï¼Œå°±æ˜¯è‡ªå·±ç¬¨ï¼Œç»™ä¸€ç›´ä»¥æ¥è‡ªè®¤ä¸ºç†æ€§çš„è‡ªå·±æ‰‡äº†ä¸€è€³å…‰ã€‚</p>
<p>å¤§å®¶é‡åˆ°è¿™ç§äº‹è¿˜æ˜¯è¦è­¦è§‰ï¼Œå­¦ä¼šæ‹’ç»ã€‚</p>
<p>é™Œç”Ÿäººå¯»åŠ©é€ä»–110ï¼Œæ•‘æ­»æ‰¶ä¼¤é€ä»–120ã€‚</p>
<p>å¸Œæœ›å¤©ä¸‹æ‰€æœ‰çš„å–„è‰¯éƒ½ä¸è¢«è¾œè´Ÿï¼Œæ‰€æœ‰çš„éª—å­éƒ½æ—©ç‚¹è¿›å¤§ç‰¢ï¼Œå…¨å®¶ICUé¢„è­¦ã€‚</p>
<p>13å·ï¼Œä¸¤ä¸ªå®¤å‹å“¥å“¥å¸¦æˆ‘å»è­¦å¯Ÿå±€åšç¬”å½•ï¼Œè¯¢é—®å”å”å¥½å‡¶ï¼Œç¬”å½•å°å“¥è¿˜ä¸é”™ã€‚</p>
<p>ä¸­åˆï¼Œä»–ä»¬è¯·æˆ‘åƒé¥­é¥­ï¼Œå¾½èœä¸è¡Œï¼ŒçœŸçš„ä¸è¡Œï¼ŒçœŸçš„å’¸ï¼Œå’¸çš„è¦å‘½ï¼Œä¸æ¨èã€‚</p>
<p>å¤§ä¸€åƒè¿‡ä¸€æ¬¡è‡­æ¡‚é±¼ç•™ä¸‹é˜´å½±ï¼Œä»Šå¤©çš„é±¼åˆæ˜¯åˆè…¥åˆå’¸ï¼Œç›´æ¥ç»™æˆ‘æ°¸ä¹…åŠé€€ã€‚</p>
]]></content>
      <categories>
        <category>å½±è¯„</category>
      </categories>
      <tags>
        <tag>å½±è¯„</tag>
      </tags>
  </entry>
  <entry>
    <title>çƒ­æ‹</title>
    <url>/posts/26035/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/26035/today.jpg" class="" title="today">

<p>å¤å¤©é è¿‘ï¼Œæˆ‘ä»¬å‡æ¸©ã€‚åæ¥çƒŸé›¨è½ç››äº¬ï¼Œä¸€äººæ’‘ä¼ä¸¤äººè¡Œã€‚</p>
<p>æƒ³æ¥ç³Ÿç³•ï¼Œé¬¼æ··çš„æ„¿æœ›è¿˜æ²¡å®Œæˆï¼Œå°±è¦æ¥å—å¨´å¨´çš„ç®¡è¾–äº†ã€‚</p>
<p style="text-align:right">â€”â€”2021.6.11 12:39</right>


]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringSecurity</title>
    <url>/posts/52913/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ğŸš€Githubä¼ é€é—¨ï¼š<a href="https://github.com/Khighness/spring-security">https://github.com/Khighness/spring-security</a></p>
<h2 id="1-Start-With-Maven"><a href="#1-Start-With-Maven" class="headerlink" title="1. Start With Maven"></a>1. Start With Maven</h2><pre><code class="xml">&lt;properties&gt;
    &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;lombok.version&gt;1.18.16&lt;/lombok.version&gt;
    &lt;mysql.version&gt;8.0.20&lt;/mysql.version&gt;
    &lt;druid.version&gt;1.2.3&lt;/druid.version&gt;
    &lt;jwt.version&gt;0.9.1&lt;/jwt.version&gt;
    &lt;spring-boot.version&gt;2.2.2.RELEASE&lt;/spring-boot.version&gt;
    &lt;spring-cloud.version&gt;Greenwich.SR1&lt;/spring-cloud.version&gt;
    &lt;mybatis.spring.boot.starter.version&gt;2.1.1&lt;/mybatis.spring.boot.starter.version&gt;
    &lt;mybatis-plus.boot.starter.version&gt;3.4.1&lt;/mybatis-plus.boot.starter.version&gt;
&lt;/properties&gt;

&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;!-- Lombok --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;version&gt;$&#123;lombok.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- MySQL --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;$&#123;mysql.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- JWT --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;
            &lt;artifactId&gt;jjwt&lt;/artifactId&gt;
            &lt;version&gt;$&#123;jwt.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- Druid--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid&lt;/artifactId&gt;
            &lt;version&gt;$&#123;druid.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- Druid Starter --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;$&#123;druid.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- Mybatis Starter --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;$&#123;mybatis.spring.boot.starter.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- Mybatis-Plus Starter --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;$&#123;mybatis-plus.boot.starter.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- SpringBoot--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;
            &lt;version&gt;$&#123;spring-boot.version&#125;&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!-- SpringCloud --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
            &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
<h2 id="2-Spring-Security-Guide"><a href="#2-Spring-Security-Guide" class="headerlink" title="2. Spring Security Guide"></a>2. Spring Security Guide</h2><p>ğŸ“–æ¦‚è¿°</p>
<p>Spring Securityæ˜¯ä¸€æ¬¾åŸºäºSpringçš„å®‰å…¨æ¡†æ¶ï¼Œä¸»è¦åŒ…å«è®¤è¯å’Œæˆæƒä¸¤å¤§å®‰å…¨æ¨¡å—ï¼Œå’Œå¦å¤–ä¸€æ¬¾æµè¡Œçš„å®‰å…¨æ¡†æ¶ç›¸æ¯”ï¼Œå®ƒæ‹¥æœ‰æ›´åŠ å¼ºå¤§çš„åŠŸèƒ½ã€‚Spring Securityä¹Ÿå¯ä»¥è½»æ¾çš„è‡ªå®šä¹‰æ‰©å±•ä»¥æ»¡è¶³å„ç§éœ€æ±‚ï¼Œå¹¶ä¸”å¯¹å¸¸è§çš„webå®‰å…¨æ”»å‡»æä¾›äº†é˜²æŠ¤æ”¯æŒã€‚</p>
<h3 id="2-1-å¿«é€Ÿå¼€å§‹"><a href="#2-1-å¿«é€Ÿå¼€å§‹" class="headerlink" title="2.1 å¿«é€Ÿå¼€å§‹"></a>2.1 å¿«é€Ÿå¼€å§‹</h3><p>åˆ›å»ºé¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–ï¼š</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
<p>åˆ›å»ºä¸€ä¸ªRESTæ¥å£ï¼š</p>
<pre><code class="java">@RestController
public class HelloController &#123;
    @GetMapping(&quot;/&#123;name&#125;&quot;)
    public String sayHello(@PathVariable(value = &quot;name&quot;) String name) &#123;
        return &quot;Hello &quot; + name + &quot;!&quot;;
    &#125;
&#125;</code></pre>
<p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®<a href="http://localhost:8080/KHighness">http://localhost:8080/KHighness</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221180532272.png" class="" title="image-20201221180532272">

<p>é»˜è®¤ç”¨æˆ·åä¸ºuserï¼Œé»˜è®¤å¯†ç ä¼šåœ¨IDEçš„æ§åˆ¶å°æ‰“å°ï¼š</p>
<pre><code class="powershell">Using default security password: af1489e7-58ea-4e12-a5b3-b2e0aae5b2f9</code></pre>
<p>è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç å³å¯è®¿é—®æ¥å£ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221180435109.png" class="" title="image-20201221180435109">

<p>å¼•å…¥Spring Securityä¾èµ–çš„æ—¶å€™ï¼Œé¡¹ç›®ä¼šé»˜è®¤å¼€å¯è®¤è¯ï¼š</p>
<ul>
<li><p>1.Xï¼šé»˜è®¤Http basicè®¤è¯</p>
</li>
<li><p>2.Xï¼šé»˜è®¤è¡¨å•ç™»å½•è®¤è¯</p>
</li>
<li><p>é»˜è®¤ç”¨æˆ·ï¼šuser</p>
</li>
<li><p>é»˜è®¤å¯†ç ï¼šéšæœºç”Ÿæˆ</p>
</li>
<li><p>é»˜è®¤æ‹¦æˆªï¼šæ‰€æœ‰è®¿é—®è·¯å¾„</p>
</li>
</ul>
<h3 id="2-2-ä¸¤ç§è®¤è¯"><a href="#2-2-ä¸¤ç§è®¤è¯" class="headerlink" title="2.2 ä¸¤ç§è®¤è¯"></a>2.2 ä¸¤ç§è®¤è¯</h3><p>SpringSecurity2.xé»˜è®¤éªŒè¯ä¸ºè¡¨å•éªŒè¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®å°†è¡¨å•è®¤è¯ä¿®æ”¹ä¸º<code>Http basic</code>è®¤è¯ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ªé…ç½®ç±»<code>BrowserSecurityConfig</code>ç»§æ‰¿<code>org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter</code>å¹¶ä¸”é‡å†™<code>configure</code>æ–¹æ³•ã€‚<code>WebSecurityConfigurerAdapter</code>æ˜¯æœ‰Spring Securityæä¾›çš„Webåº”ç”¨å®‰å…¨é…ç½®çš„é€‚é…å™¨ï¼š</p>
<pre><code>@Configuration
public class BrowserSecurityConfig extends WebSecurityConfigurerAdapter &#123;
    @Override
    public void configure(HttpSecurity httpSecurity) throws Exception &#123;
        httpSecurity.httpBasic()       // http basicè®¤è¯
                .and()
                .authorizeRequests()  // æˆæƒæ–¹å¼
                .anyRequest()         // æ‰€æœ‰è¯·æ±‚
                .authenticated();     // éƒ½éœ€è®¤è¯
    &#125;
&#125;</code></pre>
<p><code>HttpSecurity</code>æä¾›äº†è¿™ç§é“¾å¼çš„æ–¹æ³•è°ƒç”¨ã€‚ä»¥ä¸Šé…ç½®è®¤è¯æ–¹å¼ä¸ºHTTP basicè®¤è¯ï¼Œå¹¶ä¸”æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è¿›è¡Œè®¤è¯ã€‚</p>
<p>é‡å¯é¡¹ç›®ï¼Œå†æ¬¡è®¿é—®<a href="http://localhost:8080/KHighness%EF%BC%9A">http://localhost:8080/KHighnessï¼š</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221191139442.png" class="" title="image-20201221191139442">



<h3 id="2-3-åŸºæœ¬åŸç†"><a href="#2-3-åŸºæœ¬åŸç†" class="headerlink" title="2.3 åŸºæœ¬åŸç†"></a>2.3 åŸºæœ¬åŸç†</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221191555911.png" class="" title="image-20201221191555911">

<p>Spring SecurityåŒ…å«ä¼—å¤šçš„è¿‡æ»¤å™¨ï¼Œè¿™äº›è¿‡æ»¤å™¨å½¢æˆäº†ä¸€æ¡å®‰å…¨è¿‡æ»¤é“¾ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å¿…é¡»é€šè¿‡è¿™äº›è¿‡æ»¤å™¨åæ‰èƒ½æˆåŠŸè®¿é—®åˆ°èµ„æºã€‚å…¶ä¸­<code>UsernamePasswordAuthenticationFilter</code>è¿‡æ»¤å™¨ç”¨äºå¤„ç†åŸºäºè¡¨å•æ–¹å¼çš„ç™»å½•è®¤è¯ï¼Œè€Œ<code>BasicAuthenticationFilter</code>ç”¨äºå¤„ç†åŸºäº<code>HTTP Basic</code>æ–¹å¼çš„ç™»å½•éªŒè¯ï¼Œåé¢è¿˜å¯èƒ½åŒ…å«ä¸€ç³»åˆ—åˆ«çš„è¿‡æ»¤å™¨ï¼ˆå¯ä»¥é€šè¿‡ç›¸åº”é…ç½®å¼€å¯ï¼‰ã€‚åœ¨è¿‡æ»¤å™¨é“¾çš„æœ«å°¾æ˜¯ä¸€ä¸ªåä¸º<code>FilterSecurityInterceptor</code>çš„æ‹¦æˆªå™¨ï¼Œç”¨äºåˆ¤æ–­å½“å‰è¯·æ±‚èº«ä»½è®¤è¯æ˜¯å¦æˆåŠŸï¼Œæ˜¯å¦æœ‰ç›¸åº”çš„æƒé™ã€‚å½“èº«ä»½è®¤è¯å¤±è´¥æˆ–è€…æƒé™ä¸è¶³çš„æ—¶å€™ä¾¿ä¼šæŠ›å‡ºç›¸åº”çš„å¼‚å¸¸ã€‚</p>
<p><code>ExceptionTranslateFilter</code>æ•è·å¹¶å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨<code>ExceptionTranslateFilter</code>è¿‡æ»¤å™¨ç”¨äºå¤„ç†äº†<code>FilterSecurityInterceptor</code>æŠ›å‡ºçš„å¼‚å¸¸å¹¶è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚éœ€è¦èº«ä»½è®¤è¯æ—¶å°†è¯·æ±‚é‡å®šå‘åˆ°ç›¸åº”çš„è®¤è¯é¡µé¢ï¼Œå½“è®¤è¯å¤±è´¥æˆ–è€…æƒé™ä¸è¶³æ—¶è¿”å›ç›¸åº”çš„æç¤ºä¿¡æ¯ã€‚</p>
<p>å°†è®¤è¯æ–¹å¼æ”¹ä¸ºè¡¨å•è®¤è¯ï¼ŒDebugè¯æ˜è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>åœ¨<code>HelloController</code>ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221200542448.png" class="" title="image-20201221200542448">

<p>åœ¨<code>FilterSecurityInterceptor</code>ä¸Šçš„<code>invoke</code>æ–¹æ³•çš„<code>super.beforeInvocation(fi)</code>ä¸Šæ‰“ä¸ªæ–­ç‚¹</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221200713187.png" class="" title="image-20201221200713187">

<p>å½“è¿™è¡Œä»£ç æ‰§è¡Œé€šè¿‡åï¼Œä¾¿å¯ä»¥è°ƒç”¨ä¸‹ä¸€è¡Œçš„<code>doFilter</code>æ–¹æ³•æ¥çœŸæ­£è°ƒç”¨<code>/hello</code>æœåŠ¡ï¼Œå¦åˆ™å°†æŠ›å‡ºç›¸åº”çš„å¼‚å¸¸ã€‚</p>
<p>å½“<code>FilterSecurityInterceptor</code>æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¼‚å¸¸å°†ç”±<code>ExceptionTranslationFilter</code>æ•è·å¹¶å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨<code>ExceptionTranslationFilter</code>çš„<code>doFilter</code>æ–¹æ³•<code>catch</code>ä»£ç å—ç¬¬ä¸€è¡Œæ‰“ä¸ªæ–­ç‚¹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221201059087.png" class="" title="image-20201221201059087">

<p> ç­‰ä¼šæ¨¡æ‹Ÿæœªç™»å½•ç›´æ¥è®¿é—®/{name}ï¼Œæ‰€ä»¥åº”è¯¥æŠ›å‡ºç”¨æˆ·æœªç™»å½•çš„å¼‚å¸¸ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥åº”è¯¥è·³è½¬åˆ°<code>UsernamePasswordAuthenticationFilter</code>å¤„ç†è¡¨å•æ–¹å¼çš„ç”¨æˆ·è®¤è¯ï¼Œåœ¨<code>UsernamePasswordAuthenticationFilter</code>çš„<code>attemptAuthentication</code>æ–¹æ³•ä¸Šæ‰“ä¸ªæ–­ç‚¹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221201407487.png" class="" title="image-20201221201407487">



<p>å‡†å¤‡å®Œæ¯•ï¼Œè®¿é—®<a href="http://localhost:8080/KHighness%E3%80%82">http://localhost:8080/KHighnessã€‚</a></p>
<p>ä»£ç ç¬¬ä¸€æ­¥è·³è½¬åˆ°<code>FilterSecurityInterceptor</code>çš„<code>beforeInvocation</code>æ–­ç‚¹ä¸Šï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221202149865.png" class="" title="image-20201221202149865">

<p>å¾€ä¸‹æ‰§è¡Œï¼Œå› ä¸ºå½“å‰è¯·æ±‚æ²¡æœ‰ç»è¿‡èº«ä»½è®¤è¯ï¼Œæ‰€ä»¥æŠ›å‡ºå¼‚å¸¸å¹¶è¢«<code>ExceptionTranslationFilter</code>æ•è·ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221202314078.png" class="" title="image-20201221202314078">

<p>æ•è·å¼‚å¸¸åé‡å®šå‘åˆ°ç™»å½•è¡¨å•é¡µé¢ï¼Œå½“æˆ‘ä»¬åœ¨è¡¨å•ç™»é™†é¡µé¢è¾“å…¥ä¿¡æ¯å¹¶ç‚¹å‡»Sign inåï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221202956446.png" class="" title="image-20201221202956446">

<p>ä»£ç è·³è½¬åˆ°<code>UsernamePasswordAuthenticationFilter</code>çš„<code>attemptAuthentication</code>æ–­ç‚¹ä¸Šï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221202818305.png" class="" title="image-20201221202818305">

<p>åˆ¤æ–­ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®ä¹‹åï¼Œä»£ç åˆè·³å›åˆ°<code>FilterSecurityInterceptor</code>çš„<code>beforeInvocation</code>æ–­ç‚¹ä¸Šï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221203145555.png" class="" title="image-20201221203145555">

<p>å½“è®¤è¯é€šè¿‡æ—¶ï¼Œ<code>FilterSecurityInterceptor</code>ä»£ç å¾€ä¸‹æ‰§è¡Œ<code>invoke</code>ï¼Œç„¶åä»£ç æœ€ç»ˆè·³è½¬åˆ°ä¸Š<code>HelloController</code>ä¸Šï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201221203423267.png" class="" title="image-20201221203423267">

<p>æœ€åæµè§ˆå™¨å°†æ˜¾ç¤º<code>Hello KHighness!</code>ä¿¡æ¯ã€‚</p>
<h2 id="3-Spring-Security-Authentication"><a href="#3-Spring-Security-Authentication" class="headerlink" title="3. Spring Security Authentication"></a>3. Spring Security Authentication</h2><p>ğŸ“–æ¦‚è¿°</p>
<p>Spring Securityæ”¯æŒè‡ªå®šä¹‰è®¤è¯è¿‡ç¨‹ï¼Œå¦‚å¤„ç†ç”¨æˆ·ä¿¡æ¯è·å–é€»è¾‘ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ç™»å½•é¡µé¢æ›¿æ¢Spring Securityé»˜è®¤çš„ç™»å½•é¡µåŠè‡ªå®šä¹‰ç™»å½•æˆåŠŸæˆ–å¤±è´¥åçš„å¤„ç†é€»è¾‘ç­‰ã€‚</p>
<h3 id="3-1-æ›¿æ¢é»˜è®¤ç™»å½•é¡µ"><a href="#3-1-æ›¿æ¢é»˜è®¤ç™»å½•é¡µ" class="headerlink" title="3.1 æ›¿æ¢é»˜è®¤ç™»å½•é¡µ"></a>3.1 æ›¿æ¢é»˜è®¤ç™»å½•é¡µ</h3><p>åˆ›å»ºé¡¹ç›®ï¼Œå¯¼å…¥ä¾èµ–ï¼š</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
    &lt;artifactId&gt;lombok&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
    &lt;artifactId&gt;druid&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
    &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
<p>é¡¹ç›®åŸºæœ¬é…ç½®ï¼š</p>
<pre><code class="yml">server:
  port: 8080
  tomcat:
    uri-encoding: UTF-8

spring:
  application:
    name: CustomAuthenticationApplication
  thymeleaf:
    cache: false
    prefix: classpath:/templates/
    suffix: .html
    mode: HTML5
    encoding: UTF-8
  datasource:
    druid:
      driver-class-name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://localhost:3306/web?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowMultiQueries=true
      username: root
      password: KAG1823

mybatis-plus:
  mapper-locations: classpath*:/mapper/**/*.xml
  type-aliases-package: top.parak.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    banner: false</code></pre>
<p>åœ¨resourcesç›®å½•ä¸‹æ–°å»ºtemplatesç›®å½•ï¼Œåœ¨templatesç›®å½•åˆ›å»ºç™»å½•é¡µé¢<code>login.html</code>ï¼š</p>
<pre><code class="html">&lt;!DOCTYPE&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot;
          content=&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;&gt;
    &lt;title&gt;Login Page&lt;/title&gt;
    &lt;style type=&quot;text/css&quot;&gt;
        body&#123;
            margin: 0;
            padding: 0;
            height: 100vh;
            background: #2F323A;
            background-size: cover;
        &#125;
        .form&#123;
            background: #000;
            z-index: 1;
            font-family: &quot;Candara&quot;, sans-serif;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            padding: 0 45px 30px 45px;
            text-align: center;
            border-radius: 10px;
            opacity: 0.9;
        &#125;
        .form h2&#123;
            color: #fff;
            font-size: 28px;
            font-weight: 500;
            text-align: center;
            text-transform: uppercase;
        &#125;
        .form .icons i&#123;
            color: #fff;
            font-size: 25px;
            margin: 0 30px 30px 30px;
            transition: 0.8s;
            transition-property: color, transform;
        &#125;
        .form .icons i:hover&#123;
            color: #06C5CF;
            transform: scale(1.3);
        &#125;
        .form input&#123;
            outline: 0;
            background: none;
            font-size: 15px;
            color: #fff;
            text-align: center;
            width: 265px;
            margin-bottom: 30px;
            padding: 15px;
            box-sizing: border-box;
            border: 2.5px solid #2E86DE;
            border-radius: 25px;
            transition: 0.5s;
            transition-property: width;
        &#125;
        .form input:hover&#123;
            width: 300px;
        &#125;
        .form input:focus&#123;
            width: 300px;
        &#125;
        .form button&#123;
            outline: 0;
            background: none;
            color: #fff;
            font-size: 14px;
            text-transform: uppercase;
            width: 150px;
            padding: 15px;
            border: 2.5px solid #10AC84;
            border-radius: 25px;
            cursor: pointer;
            transition: 0.5s;
            transition-property: background, transform;
        &#125;
        .form button:hover, .form button:active, .form button:focus&#123;
            background: #10AC84;
            transform: scale(1.1);
        &#125;
        .form .options&#123;
            color: #bbb;
            font-size: 14px;
            margin: 20px 0 0;
        &#125;
        .form .options a&#123;
            text-decoration: none;
            color: #06C5CF;
        &#125;
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;form&quot;&gt;
    &lt;form class=&quot;login-form&quot; action=&quot;/login&quot; method=&quot;post&quot;&gt;
        &lt;h2&gt;Spring Security&lt;/h2&gt;
        &lt;input type=&quot;text&quot; name=&quot;username&quot; placeholder=&quot;Username&quot; required=&quot;required&quot;&gt;
        &lt;input type=&quot;password&quot; name=&quot;password&quot;  placeholder=&quot;Password&quot; required=&quot;required&quot;&gt;
        &lt;button type=&quot;submit&quot; name=&quot;button&quot;&gt;Login&lt;/button&gt;
        &lt;p class=&quot;options&quot;&gt;Not Registered? &lt;a href=&quot;/register&quot;&gt;Create an Account&lt;/a&gt;&lt;/p&gt;
    &lt;/form&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>åˆ›å»ºè®¤è¯é…ç½®ç±»<code>BrowserSecurityConfig</code>ï¼š</p>
<pre><code class="java">@Configuration
public class BrowserSecurityConfig extends WebSecurityConfigurerAdapter &#123;
    @Override
    protected void configure(HttpSecurity httpSecurity) throws Exception &#123;
        httpSecurity
            // è®¤è¯é…ç½®
            .formLogin()                                  // è®¾ç½®è¡¨å•ç™»å½•
            .loginPage(&quot;/authentication&quot;)                 // è®¾ç½®ç™»å½•é¡µé¢
            .loginProcessingUrl(&quot;/login&quot;)                 // å¤„ç†è¡¨å•ç™»å½•
            .usernameParameter(&quot;username&quot;)                // ç”¨æˆ·åè¾“å…¥æ¡†çš„name
            .passwordParameter(&quot;password&quot;)                // å¯†ç è¾“å…¥æ¡†çš„name
            .and()
             // æˆæƒé…ç½®
            .authorizeRequests()
            .antMatchers(&quot;/authentication&quot;).permitAll() // ä¸éœ€è¦è®¤è¯å³å¯è®¿é—®
            .anyRequest().authenticated()               // æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è®¤è¯
            .and()
            // å®‰å…¨é…ç½®
            .csrf().disable();                           // ç¦æ­¢è·¨ç«™CSRFæ”»å‡»
    &#125;
&#125;</code></pre>
<p>åˆ›å»ºä¸€ä¸ªRestæ¥å£ï¼š</p>
<pre><code class="java">@Controller
public class AuthenticationController &#123;

    @GetMapping(&quot;/authentication&quot;)
    public String authenticationLogin() &#123;
        return &quot;login&quot;;
    &#125;

    @ResponseBody
    @GetMapping(&quot;/hello&quot;)
    public String hello() &#123;
        return &quot;Hello Khighness&quot;;
    &#125;
&#125;</code></pre>
<p>æµ‹è¯•è®¿é—®<a href="http://localhost:8080/hello%EF%BC%8C%E8%B7%B3%E8%BD%AC%E5%88%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%EF%BC%9A">http://localhost:8080/helloï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢ï¼š</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201222134139487.png" class="" title="image-20201222134139487">

<p>è¾“å…¥ç”¨æˆ·åï¼ˆuserï¼‰å’Œå¯†ç ï¼ˆæ§åˆ¶å°æ‰“å°ï¼‰å³å¯çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20201222133437066.png" class="" title="image-20201222133437066">



<h3 id="3-2-è‡ªå®šä¹‰è®¤è¯è¿‡ç¨‹"><a href="#3-2-è‡ªå®šä¹‰è®¤è¯è¿‡ç¨‹" class="headerlink" title="3.2 è‡ªå®šä¹‰è®¤è¯è¿‡ç¨‹"></a>3.2 è‡ªå®šä¹‰è®¤è¯è¿‡ç¨‹</h3><p>è‡ªå®šä¹‰è®¤è¯çš„è¿‡ç¨‹éœ€è¦Spring Securityæä¾›çš„<code>UserDetailService</code>æ¥å£ï¼Œè¯¥æ¥å£åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre><code class="java">public interface UserDetailsService &#123;
    UserDetails loadUserByUsername(String var1) throws UsernameNotFoundException;
&#125;</code></pre>
<p><code>loadUserByUsername</code>æ–¹æ³•è¿”å›ä¸€ä¸ª<code>UserDetails</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒåŒ…å«ä¸€äº›ç”¨äºæè¿°ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•ï¼Œç”¨äºä¸ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œå¯¹æ¯”è®¤è¯ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<pre><code class="java">public interface UserDetails extends Serializable &#123;
    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();

    String getPassword();

    String getUsername();

    boolean isAccountNonExpired();

    boolean isAccountNonLocked();

    boolean isCredentialsNonExpired();

    boolean isEnabled();
&#125;</code></pre>
<p>è¿™äº›æ–¹æ³•çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">getAuthorities</td>
<td align="center">è·å–ç”¨æˆ·åŒ…å«çš„æƒé™ï¼Œè¿”å›æƒé™é›†åˆ</td>
</tr>
<tr>
<td align="center">getPassword</td>
<td align="center">è·å–å¯†ç ï¼Œè¿”å›Stringç±»å‹</td>
</tr>
<tr>
<td align="center">getUsername</td>
<td align="center">è·å–ç”¨æˆ·åï¼Œè¿”å›Stringç±»å‹</td>
</tr>
<tr>
<td align="center">isAccountNonExpired</td>
<td align="center">ç”¨äºåˆ¤æ–­è´¦æˆ·æ˜¯å¦æœªè¿‡æœŸï¼Œæœªè¿‡æœŸè¿”å›trueåæ­£è¿”å›false</td>
</tr>
<tr>
<td align="center">isAccountNonLocked</td>
<td align="center">ç”¨äºåˆ¤æ–­è´¦æˆ·æ˜¯å¦æœªé”å®šï¼Œæœªé”å®šè¿”å›trueåæ­£è¿”å›false</td>
</tr>
<tr>
<td align="center">isCredentialsNonExpired</td>
<td align="center">ç”¨äºåˆ¤æ–­è´¦æˆ·å‡­è¯(å³å¯†ç )æ˜¯å¦æœªè¿‡æœŸï¼Œæœªè¿‡æœŸè¿”å›trueåæ­£è¿”å›false</td>
</tr>
<tr>
<td align="center">isEnabled</td>
<td align="center">ç”¨äºåˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ç”¨ï¼Œå¯ç”¨è¿”å›trueåæ­£è¿”å›false</td>
</tr>
</tbody></table>
<p>åˆ›å»ºæ•°æ®åº“ï¼š</p>
<table>
<thead>
<tr>
<th align="center">ç”¨æˆ·å</th>
<th align="center">å¯†ç </th>
<th align="center">è§’è‰²</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Khighness</td>
<td align="center">KAG1823</td>
<td align="center">admin</td>
</tr>
<tr>
<td align="center">FlowerK</td>
<td align="center">KAG1823</td>
<td align="center">manager</td>
</tr>
<tr>
<td align="center">RubbishK</td>
<td align="center">KAG1823</td>
<td align="center">normal</td>
</tr>
</tbody></table>
<pre><code class="sql">CREATE TABLE `user` (
  `id` int NOT NULL AUTO_INCREMENT,
  `username` varchar(20) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
  `password` varchar(80) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
  `status` tinyint DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8 COLLATE=utf8_bin;
INSERT INTO `user` VALUES (1, &#39;Khighness&#39;, &#39;$2a$10$lACRBH58EGnTGHGrt2kya.OaF5vzpqkYR3Hx604FkWw0Lr6tu0goO&#39;, 1);
INSERT INTO `user` VALUES (2, &#39;FlowerK&#39;, &#39;$2a$10$lACRBH58EGnTGHGrt2kya.OaF5vzpqkYR3Hx604FkWw0Lr6tu0goO&#39;, 1);
INSERT INTO `user` VALUES (3, &#39;RubbishK&#39;, &#39;$2a$10$lACRBH58EGnTGHGrt2kya.OaF5vzpqkYR3Hx604FkWw0Lr6tu0goO&#39;, 1);

CREATE TABLE `role` (
  `id` int NOT NULL AUTO_INCREMENT,
  `role_name` varchar(255) COLLATE utf8_bin DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8 COLLATE=utf8_bin;
INSERT INTO `role` VALUES (1, &#39;admin&#39;);
INSERT INTO `role` VALUES (2, &#39;manager&#39;);
INSERT INTO `role` VALUES (3, &#39;normal&#39;);

CREATE TABLE `user_role` (
  `id` int NOT NULL AUTO_INCREMENT,
  `user_id` int NOT NULL,
  `role_id` int NOT NULL,
  PRIMARY KEY (`id`),
  KEY `user_id` (`user_id`),
  KEY `role_id` (`role_id`),
  CONSTRAINT `role_id` FOREIGN KEY (`role_id`) REFERENCES `role` (`id`),
  CONSTRAINT `user_id` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8 COLLATE=utf8_bin;
INSERT INTO `user_role` VALUES (1, 1, 1);
INSERT INTO `user_role` VALUES (2, 2, 2);
INSERT INTO `user_role` VALUES (3, 3, 3);</code></pre>
<p>é¦–å…ˆä¸‰ä¸ªåˆ›å»ºå®ä½“ç±»ã€‚</p>
<p>å®šä¹‰ç”¨æˆ·<code>MyUser</code>ï¼š</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
@TableName(&quot;user&quot;)
public class MyUser implements Serializable &#123;
    private static final long serialVersionUID = 1753000091845565507L;

    @TableId(value = &quot;id&quot;, type = IdType.AUTO)
    private int id;

    @TableField(value = &quot;username&quot;)
    private String username;

    @TableField(value = &quot;password&quot;)
    private String password;

    @TableField(exist = false)
    private boolean accountNonExpired = true;

    @TableField(exist = false)
    private boolean accountNonLocked= true;

    @TableField(exist = false)
    private boolean credentialsNonExpired= true;

    @TableField(exist = false)
    private boolean enabled= true;
&#125;</code></pre>
<p>å®šä¹‰è§’è‰²<code>MyRole</code>ï¼š</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
@TableName(&quot;role&quot;)
public class MyRole implements Serializable &#123;
    private static final long serialVersionUID = 7565000980394639717L;

    @TableId(value = &quot;id&quot;, type = IdType.AUTO)
    private int id;

    @TableField(value = &quot;role_name&quot;)
    private String roleName;
&#125;</code></pre>
<p>å®šä¹‰ç”¨æˆ·è§’è‰²å…³ç³»<code>UserToRole</code>ï¼š</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
@TableName(&quot;user_role&quot;)
public class UserToRole implements Serializable &#123;
    private static final long serialVersionUID = 252063821059124209L;

    @TableId(value = &quot;id&quot;, type = IdType.AUTO)
    private int id;

    @TableField(value = &quot;user_id&quot;)
    private int userId;

    @TableField(value = &quot;role_id&quot;)
    private int roleId;
&#125;</code></pre>
<p>æ¥ç€ä»¥ä¸Šä¸‰ä¸ªå®ä½“ç±»çš„æŒä¹…å±‚æ¥å£å…¨éƒ¨ç»§æ‰¿<code>Mybatis-plus</code>çš„<code>BaseMapper</code>ã€‚</p>
<p>ç„¶ååœ¨<code>BrowserSecurityConfig</code>ä¸­æ·»åŠ <code>Bean</code>ï¼Œä»¥å®ç°BCRåŠ å¯†ï¼š</p>
<pre><code class="java">@Bean
public PasswordEncoder passwordEncoder() &#123;
    return new BCryptPasswordEncoder();
&#125;</code></pre>
<p>é‡ç‚¹æ¥äº†ï¼Œè‡ªå®šä¹‰è®¤è¯ï¼Œåˆ›å»º<code>CustomUserDetailService</code>å®ç°<code>UserDetailsService</code>æ¥å£ï¼š</p>
<pre><code class="java">@Slf4j
@Configuration
public class CustomUserDetailService implements UserDetailsService &#123;
    @Resource
    private UserMapper userMapper;
    @Resource
    private RoleMapper roleMapper;
    @Resource
    private UserToRoleMapper userToRoleMapper;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;
        if (username != null) &#123;
            log.info(&quot;ç™»å½•ç”¨æˆ·å =&gt; [&#123;&#125;]&quot;, username);
        &#125;
        // æŸ¥è¯¢ç”¨æˆ·å¯†ç 
        QueryWrapper&lt;MyUser&gt; userQueryWrapper = new QueryWrapper&lt;&gt;();
        userQueryWrapper.eq(&quot;username&quot;, username);
        MyUser user = userMapper.selectOne(userQueryWrapper);
        // æŸ¥è¯¢è§’è‰²ID
        QueryWrapper&lt;UserToRole&gt; userToRoleQueryWrapper = new QueryWrapper&lt;&gt;();
        userToRoleQueryWrapper.eq(&quot;user_id&quot;, user.getId());
        UserToRole userToRole = userToRoleMapper.selectOne(userToRoleQueryWrapper);
        int roleId = userToRole.getRoleId();
        // æŸ¥è¯¢ç”¨æˆ·è§’è‰²
        QueryWrapper&lt;MyRole&gt; roleQueryWrapper = new QueryWrapper&lt;&gt;();
        roleQueryWrapper.eq(&quot;id&quot;, roleId);
        MyRole role = roleMapper.selectOne(roleQueryWrapper);
        // è¿”å›è®¤è¯ä¿¡æ¯
        return new User(username, user.getPassword(), user.isEnabled(),
                user.isAccountNonExpired(), user.isCredentialsNonExpired(),
                user.isAccountNonLocked(), AuthorityUtils.commaSeparatedStringToAuthorityList(role.getRoleName()));
    &#125;
&#125;</code></pre>
<p>æµ‹è¯•è®¿é—®<a href="http://localhost:8080/hello%EF%BC%8C%E8%BE%93%E5%85%A5%E7%94%A8%E6%88%B7%E5%90%8D(Khighness)%E5%92%8C%E5%AF%86%E7%A0%81(KAG1823)%E5%8D%B3%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%88%90%E5%8A%9F%E3%80%82">http://localhost:8080/helloï¼Œè¾“å…¥ç”¨æˆ·å(Khighness)å’Œå¯†ç (KAG1823)å³å¯è®¿é—®æˆåŠŸã€‚</a></p>
<h3 id="3-3-å¤„ç†æˆåŠŸå’Œå¤±è´¥"><a href="#3-3-å¤„ç†æˆåŠŸå’Œå¤±è´¥" class="headerlink" title="3.3 å¤„ç†æˆåŠŸå’Œå¤±è´¥"></a>3.3 å¤„ç†æˆåŠŸå’Œå¤±è´¥</h3><p>Spring Securityæœ‰ä¸€å¥—é»˜è®¤çš„å¤„ç†ç™»å½•æˆåŠŸå’Œå¤±è´¥çš„æ–¹æ³•ï¼šå½“ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶ï¼Œé¡µé¢ä¼šè·³è½¬ä¼šå¼•å‘ç™»å½•çš„è¯·æ±‚ï¼Œæ¯”å¦‚åœ¨æœªç™»å½•çš„æƒ…å†µä¸‹è®¿é—®<a href="http://localhost:8080/hello%EF%BC%8C%E9%A1%B5%E9%9D%A2%E4%BC%9A%E8%B7%B3%E8%BD%AC%E5%88%B0%E7%99%BB%E5%BD%95%E9%A1%B5%EF%BC%8C%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%E5%90%8E%E5%86%8D%E8%B7%B3%E8%BD%AC%E5%9B%9E%E6%9D%A5%EF%BC%9B%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5%E6%97%B6%E5%88%99%E6%98%AF%E8%B7%B3%E8%BD%AC%E5%88%B0Spring">http://localhost:8080/helloï¼Œé¡µé¢ä¼šè·³è½¬åˆ°ç™»å½•é¡µï¼Œç™»å½•æˆåŠŸåå†è·³è½¬å›æ¥ï¼›ç™»å½•å¤±è´¥æ—¶åˆ™æ˜¯è·³è½¬åˆ°Spring</a> Securityé»˜è®¤çš„é”™è¯¯æç¤ºé¡µé¢ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€äº›è‡ªå®šä¹‰é…ç½®æ¥æ›¿æ¢è¿™å¥—é»˜è®¤çš„å¤„ç†æœºåˆ¶ã€‚</p>
<p>ï¼ˆ1ï¼‰<strong>è‡ªå®šä¹‰ç™»å½•æˆåŠŸé€»è¾‘</strong></p>
<p>è¦æ”¹å˜é»˜è®¤çš„å¤„ç†æˆåŠŸé€»è¾‘å¾ˆç®€å•ï¼Œåªéœ€è¦å®ç°<code>org.springframework.security.web.authentication.AuthenticationSuccessHandler</code>æ¥å£çš„<code>onAuthenticationSuccess</code>æ–¹æ³•å³å¯ã€‚</p>
<p>ç™»å½•æˆåŠŸè¿”å›è®¤è¯ä¿¡æ¯ï¼š</p>
<pre><code class="java">@Component
public class MyAuthenticationSucessHandler implements AuthenticationSuccessHandler &#123;
    private RedirectStrategy redirectStrategy = new DefaultRedirectStrategy();

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException &#123;
        redirectStrategy.sendRedirect(request, response, &quot;/success&quot;);
    &#125;
&#125;</code></pre>
<p>åœ¨Restæ¥å£ä¸­æ·»åŠ <code>/success</code>æ¥å£ï¼š</p>
<pre><code class="java">@ResponseBody
@GetMapping(&quot;/success&quot;)
public Object success(Authentication authentication) &#123;
    return authentication;
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰<strong>è‡ªå®šä¹‰ç™»å½•å¤±è´¥é€»è¾‘</strong></p>
<p>ç™»å½•å¤±è´¥è¿”å›é”™è¯¯ä¿¡æ¯ï¼š</p>
<pre><code class="java">@Component
public class MyAuthenticationFailureHandler implements AuthenticationFailureHandler &#123;
    @Autowired
    private ObjectMapper mapper;

    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response,
                                        AuthenticationException exception) throws IOException &#123;
        response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());
        response.setContentType(&quot;application/json;charset=utf-8&quot;);
        response.getWriter().write(mapper.writeValueAsString(exception.getMessage()));
    &#125;
&#125;</code></pre>
<p>æœ€åä¿®æ”¹<code>BrowserSecurityConfig</code>ï¼š</p>
<pre><code class="java">@Configuration
public class BrowserSecurityConfig extends WebSecurityConfigurerAdapter &#123;
    @Autowired
    private MyAuthenticationSucessHandler authenticationSucessHandler;
    @Autowired
    private MyAuthenticationFailureHandler authenticationFailureHandler;

    @Bean
    public PasswordEncoder passwordEncoder() &#123;
        return new BCryptPasswordEncoder();
    &#125;

    @Override
    protected void configure(HttpSecurity httpSecurity) throws Exception &#123;
        httpSecurity
            // è®¤è¯é…ç½®
            .formLogin()                                  // è®¾ç½®è¡¨å•ç™»å½•
            .loginPage(&quot;/authentication&quot;)                 // è®¾ç½®ç™»å½•é¡µé¢
            .loginProcessingUrl(&quot;/login&quot;)                 // å¤„ç†è¡¨å•ç™»å½•
            .usernameParameter(&quot;username&quot;)                // ç”¨æˆ·åè¾“å…¥æ¡†çš„name
            .passwordParameter(&quot;password&quot;)                // å¯†ç è¾“å…¥æ¡†çš„name
            // ç»“æœå¤„ç†
            .successHandler(authenticationSucessHandler)  // ç™»å½•æˆåŠŸå¤„ç†
            .failureHandler(authenticationFailureHandler) // ç™»å½•å¤±è´¥å¤„ç†
            .and()
             // æˆæƒé…ç½®
            .authorizeRequests()
            .antMatchers(&quot;/authentication&quot;).permitAll()   // ä¸éœ€è¦è®¤è¯å³å¯è®¿é—®
            .anyRequest().authenticated()                 // æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è®¤è¯
            .and()
            // å…³é—­CSRFä¿æŠ¤
            .csrf().disable();
    &#125;
&#125;</code></pre>
<p>å¯åŠ¨é¡¹ç›®ï¼Œæµ‹è¯•è®¿é—®ï¼š<a href="http://localhost:8080/hello">http://localhost:8080/hello</a></p>
<p>ç™»å½•æˆåŠŸåè¿”å›å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<pre><code class="json">// 20201222153225
// http://localhost:8080/success
â€‹
&#123;
  &quot;authorities&quot;: [
    &#123;
      &quot;authority&quot;: &quot;admin&quot;
    &#125;
  ],
  &quot;details&quot;: &#123;
    &quot;remoteAddress&quot;: &quot;0:0:0:0:0:0:0:1&quot;,
    &quot;sessionId&quot;: null
  &#125;,Â·
  &quot;authenticated&quot;: true,
  &quot;principal&quot;: &#123;
    &quot;password&quot;: null,
    &quot;username&quot;: &quot;Khighness&quot;,
    &quot;authorities&quot;: [
      &#123;
        &quot;authority&quot;: &quot;admin&quot;
      &#125;
    ],
    &quot;accountNonExpired&quot;: true,
    &quot;accountNonLocked&quot;: true,
    &quot;credentialsNonExpired&quot;: true,
    &quot;enabled&quot;: true
  &#125;,
  &quot;credentials&quot;: null,
  &quot;name&quot;: &quot;Khighness&quot;
&#125;</code></pre>
<p>åƒ<code>password</code>ï¼Œ<code>credentials</code>è¿™äº›æ•æ„Ÿä¿¡æ¯ï¼ŒSpring Securityå·²ç»å°†å…¶å±è”½ã€‚</p>
<h2 id="4-Spring-Security-RememberMe"><a href="#4-Spring-Security-RememberMe" class="headerlink" title="4. Spring Security RememberMe"></a>4. Spring Security RememberMe</h2><p>ğŸ’ è¯´æ˜</p>
<p>è¿™ä¸€èŠ‚çš„ä»£ç åœ¨ä¸Šä¸€èŠ‚çš„åŸºç¡€ä¸Šä¿®æ”¹ã€‚</p>
<p>ğŸ“–æ¦‚è¿°</p>
<p>SpringSecurityè®°ä½æˆ‘åŠŸèƒ½çš„å®ç°è¿‡ç¨‹ï¼šç”¨æˆ·å‹¾é€‰äº†è®°ä½æˆ‘é€‰é¡¹å¹¶ç™»å½•æˆåŠŸåï¼ŒSpringSecurityä¼šç”Ÿæˆä¸€ä¸ªtokenï¼Œå¹¶æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œå¹¶ä¸”ç”Ÿæˆä¸€ä¸ªä¸è¯¥tokenç›¸å¯¹åº”çš„cookieè¿”å›ç»™æµè§ˆå™¨ã€‚å½“ç”¨æˆ·è¿‡æ®µæ—¶é—´å†æ¬¡è®¿é—®ç³»ç»Ÿæ—¶ï¼Œå¦‚æœè¯¥cookieæ²¡æœ‰è¿‡æœŸï¼ŒSpringSecurityä¾¿ä¼šæ ¹æ®cookieåŒ…å«çš„ä¿¡æ¯ä»æ•°æ®åº“è·å–ç›¸åº”çš„tokenä¿¡æ¯ï¼Œç„¶åå¸®ç”¨æˆ·è‡ªåŠ¨å®Œæˆç™»å½•æ“ä½œã€‚</p>
<h3 id="4-1-ç™»å½•ä¿®æ”¹"><a href="#4-1-ç™»å½•ä¿®æ”¹" class="headerlink" title="4.1 ç™»å½•ä¿®æ”¹"></a>4.1 ç™»å½•ä¿®æ”¹</h3><p>åœ¨ç™»å½•é¡µé¢ä¸­æ·»åŠ è®°ä½æˆ‘å¤é€‰æ¡†ï¼š</p>
<pre><code class="html">&lt;p&gt;&lt;input type=&quot;checkbox&quot; name=&quot;remember-me&quot;/&gt;remember me&lt;/p&gt;</code></pre>
<p>æ³¨æ„ï¼Œ<code>name</code>å¿…é¡»ä¸º<code>remember-me</code>ã€‚</p>
<h3 id="4-2-æ•°æ®åº“è¡¨"><a href="#4-2-æ•°æ®åº“è¡¨" class="headerlink" title="4.2 æ•°æ®åº“è¡¨"></a>4.2 æ•°æ®åº“è¡¨</h3><p>åœ¨æ•°æ®åº“ä¸­æ–°å»ºè¡¨ï¼Œå­˜å‚¨tokenï¼š</p>
<pre><code class="sql">CREATE TABLE persistent_logins (
    username VARCHAR (64) NOT NULL,
    series VARCHAR (64) PRIMARY KEY,
    token VARCHAR (64) NOT NULL,
    last_used TIMESTAMP NOT NULL
)</code></pre>
<h3 id="4-3-åç«¯é€»è¾‘"><a href="#4-3-åç«¯é€»è¾‘" class="headerlink" title="4.3 åç«¯é€»è¾‘"></a>4.3 åç«¯é€»è¾‘</h3><p>åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®tokenæŒä¹…åŒ–å¯¹è±¡ï¼š</p>
<pre><code class="java">@Configuration
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class BrowserSecurityConfig extends WebSecurityConfigurerAdapter &#123;
    ...

    @Qualifier(&quot;customUserDetailService&quot;)
    @Autowired
    private UserDetailsService userDetailsService;

    @Autowired
    private DataSource dataSource;

    @Bean
    public PersistentTokenRepository persistentTokenRepository() &#123;
        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();
        jdbcTokenRepository.setDataSource(dataSource);
        jdbcTokenRepository.setCreateTableOnStartup(false);
        return jdbcTokenRepository;
    &#125;
&#125;</code></pre>
<p>æœ€ååœ¨Spring Securityçš„è®¤è¯æµç¨‹ä¸­å¯ç”¨è®°ä½æˆ‘çš„åŠŸèƒ½ï¼Œå³åœ¨é…ç½®æ–‡ä»¶çš„<code>configure</code>æ–¹æ³•ä¸­å¼€å¯ï¼š</p>
<pre><code class="java">@Override
protected void configure(HttpSecurity httpSecurity) throws Exception &#123;
    httpSecurity
        ...
        .and()
        // è®°ä½æˆ‘è®¾ç½®
        .rememberMe()
        .tokenValiditySeconds(3600)                    // è¿‡æœŸæ—¶é—´ï¼Œå•ä½ç§’
        .tokenRepository(persistentTokenRepository())  // tokenæŒä¹…åŒ–ä»“åº“
        .userDetailsService(userDetailsService)        // å¤„ç†è‡ªåŠ¨ç™»å½•é€»è¾‘
        ;
&#125;</code></pre>
<h3 id="4-4-é‡æ–°æµ‹è¯•"><a href="#4-4-é‡æ–°æµ‹è¯•" class="headerlink" title="4.4 é‡æ–°æµ‹è¯•"></a>4.4 é‡æ–°æµ‹è¯•</h3><p>é‡å¯é¡¹ç›®ï¼Œç™»å½•é¡µé¢å¦‚ä¸‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601202452243.png" class="" title="image-20210601202452243">

<p>æ¯”è¾ƒéš¾çœ‹ï¼Œæ— ä¼¤å¤§é›…ã€‚å‹¾é€‰å¹¶ç™»å½•ï¼Œå¯ä»¥çœ‹åˆ°ç½‘é¡µå¤šäº†remember-meçš„cookieï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601202753546.png" class="" title="image-20210601202753546">

<p>æŸ¥çœ‹æ•°æ®åº“è¡¨<code>peristent_logins</code>ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601202821584.png" class="" title="image-20210601202821584">

<p>å¯ä»¥çœ‹åˆ°tokenä¿¡æ¯å·²ç»æˆåŠŸæŒä¹…åŒ–äº†ã€‚åœ¨cookieå¤±æ•ˆä¹‹å‰ï¼Œæ— è®ºæ˜¯é‡å¼€æµè§ˆå™¨è¿˜æ˜¯é‡å¯é¡¹ç›®ï¼Œç”¨æˆ·éƒ½æ— éœ€å†æ¬¡ç™»å½•å°±å¯ä»¥è®¿é—®ã€‚</p>
<h2 id="5-Spring-Security-Authorization"><a href="#5-Spring-Security-Authorization" class="headerlink" title="5. Spring Security Authorization"></a>5. Spring Security Authorization</h2><p>ğŸ’ è¯´æ˜</p>
<p>è¿™ä¸€èŠ‚çš„codeä¾ç„¶æ‰¿æ¥ä¸Šä¸€èŠ‚ã€‚</p>
<h3 id="5-1-å®‰å…¨æ³¨è§£"><a href="#5-1-å®‰å…¨æ³¨è§£" class="headerlink" title="5.1 å®‰å…¨æ³¨è§£"></a>5.1 å®‰å…¨æ³¨è§£</h3><p>é…åˆæˆæƒæ³¨è§£ä½¿ç”¨ï¼ŒSpring Securityæä¾›äº†ä¸‰ç§ä¸åŒçš„å®‰å…¨æ³¨è§£ï¼š</p>
<ol>
<li>Spring Securityè‡ªå¸¦çš„<code>@Secured</code></li>
<li>JSR-250çš„<code>@RolesAllowed</code></li>
<li>è¡¨è¾¾å¼é©±åŠ¨æ³¨è§£ï¼š<code>@PreAuthrize</code>ã€<code>@PostAuthorize</code>ã€<code>@PreFilter</code>å’Œ<code>@PostFilter</code>ã€‚</li>
</ol>
<h3 id="5-2-ç›¸å…³é…ç½®"><a href="#5-2-ç›¸å…³é…ç½®" class="headerlink" title="5.2 ç›¸å…³é…ç½®"></a>5.2 ç›¸å…³é…ç½®</h3><p>è¦å¼€å¯è¿™äº›æ³¨è§£ï¼Œåªéœ€è¦åœ¨Spring Securityé…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹æ³¨è§£ï¼š</p>
<pre><code class="java">@Configuration
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class BrowserSecurityConfig extends WebSecurityConfigurerAdapter &#123;
    ...
&#125;</code></pre>
<p>è‡ªå®šä¹‰ä¸€ä¸ªå¤„ç†å™¨ï¼Œå¤„ç†æƒé™ä¸è¶³çš„æƒ…å†µï¼š</p>
<pre><code class="java">@Component
public class MyAuthenticationAccessDeniedHandler implements AccessDeniedHandler &#123;

    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e) throws IOException, ServletException &#123;
        response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());
        response.setContentType(&quot;application/json;charset=utf-8&quot;);
        response.getWriter().write(&quot;å¾ˆæŠ±æ­‰ï¼Œæ‚¨æ²¡æœ‰è®¿é—®æƒé™ã€‚&quot; + e.getMessage());
    &#125;
&#125;</code></pre>
<p>å¹¶å°†è¿™ä¸ªå¤„ç†å™¨æ·»åŠ åˆ°é…ç½®é“¾ä¸­ï¼š</p>
<pre><code class="java">@Autowired
private MyAuthenticationAccessDeniedHandler authenticationAccessDeniedHandler;

@Override
protected void configure(HttpSecurity httpSecurity) throws Exception &#123;
    httpSecurity
        ...
        .and()
        // æƒé™é…ç½®
        .exceptionHandling()
        .accessDeniedHandler(authenticationAccessDeniedHandler) // æƒé™ä¸è¶³å¤„ç†
        ;
&#125;</code></pre>
<h3 id="5-3-æƒé™æµ‹è¯•"><a href="#5-3-æƒé™æµ‹è¯•" class="headerlink" title="5.3 æƒé™æµ‹è¯•"></a>5.3 æƒé™æµ‹è¯•</h3><p>ç¼–å†™ä¸¤ä¸ªæ¥å£ï¼Œä¸€ä¸ªæ¥å£åªå…è®¸adminå’Œmanagerè®¿é—®ï¼Œå¦ä¸€ä¸ªæ¥å£åªå…è®¸normalè®¿é—®ã€‚</p>
<pre><code class="java">@RestController
public class AuthorizationController &#123;

    @GetMapping(&quot;/auth/manage&quot;)
    @PreAuthorize(&quot;hasAnyAuthority(&#39;admin&#39;, &#39;manager&#39;)&quot;)
    public String manage() &#123;
        return &quot;æ‚¨æ˜¯Adminæˆ–è€…managerï¼Œå¯ä»¥è®¿é—®&quot;;
    &#125;

    @GetMapping(&quot;/auth/normal&quot;)
    @PreAuthorize(&quot;hasAuthority(&#39;normal&#39;)&quot;)
    public String normal() &#123;
        return &quot;æ‚¨æ˜¯æ™®é€šè§’è‰²ï¼Œå¯ä»¥è®¿é—®&quot;;
    &#125;
&#125;</code></pre>
<p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®<a href="http://localhost:8080/authentication">http://localhost:8080/authentication</a></p>
<p>ç™»å½•adminè´¦å·ï¼ˆKhighnessï¼ŒKAG1823ï¼‰</p>
<p>æµ‹è¯•è®¿é—®ï¼š<a href="http://localhost:8080/auth/manage">http://localhost:8080/auth/manage</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601210419188.png" class="" title="image-20210601210419188">

<p>æµ‹è¯•è®¿é—®ï¼š<a href="http://localhost:8080/auth/normal">http://localhost:8080/auth/normal</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601210448946.png" class="" title="image-20210601210448946">



<h2 id="6-Spring-Security-OAuth2-Guide"><a href="#6-Spring-Security-OAuth2-Guide" class="headerlink" title="6. Spring Security OAuth2 Guide"></a>6. Spring Security OAuth2 Guide</h2><p>ğŸŒå‚è€ƒ</p>
<ul>
<li><p><a href="http://www.rfcreader.com/#rfc6749">rfc6749</a></p>
</li>
<li><p><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">é˜®ä¸€å³°</a></p>
</li>
</ul>
<p>ğŸ“–æ¦‚è¿° </p>
<p>OAuthæ˜¯ä¸€ç§ç”¨æ¥è§„èŒƒä»¤ç‰Œï¼ˆTokenï¼‰å‘æ”¾çš„æˆæƒæœºåˆ¶ï¼Œä¸»è¦åŒ…å«äº†å››ç§æˆæƒæ¨¡å¼ï¼š</p>
<ul>
<li><p>æˆæƒç æ¨¡å¼ï¼ˆauthorization codeï¼‰</p>
</li>
<li><p>ç®€åŒ–æ¨¡å¼ï¼ˆimplicitï¼‰</p>
</li>
<li><p>å¯†ç æ¨¡å¼ï¼ˆresource owner password credentialsï¼‰</p>
</li>
<li><p>å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆclient credentialsï¼‰</p>
</li>
</ul>
<p>Spring Security OAuth2å¯¹è¿™å››ç§æˆæƒæ¨¡å¼è¿›è¡Œäº†å®ç°ã€‚</p>
<h3 id="6-1-åè¯å­¦ä¹ "><a href="#6-1-åè¯å­¦ä¹ " class="headerlink" title="6.1 åè¯å­¦ä¹ "></a>6.1 åè¯å­¦ä¹ </h3><p>åœ¨äº†è§£è¿™å››ç§æˆæƒæ¨¡å¼ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå­¦ä¹ ä¸€äº›å’ŒOAuthç›¸å…³çš„åè¯ã€‚</p>
<p>ä¸¾ä¸ªç¤¾äº¤ç™»å½•çš„ä¾‹å­ï¼Œæ¯”å¦‚æˆ‘åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨QQè´¦å·ç™»å½•è™ç‰™ç›´æ’­ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯ä»¥æå–å‡ºä»¥ä¸‹å‡ ä¸ªåè¯ï¼š</p>
<ol>
<li><code>Third-party application</code> ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åº =&gt; è™ç‰™ç›´æ’­</li>
<li><code>HTTP service</code> HTTPæœåŠ¡æä¾›å•† =&gt; QQ</li>
<li><code>Resource Owner</code> èµ„æºæ‰€æœ‰è€… =&gt; ç”¨æˆ·ï¼Œæˆ‘</li>
<li><code>User Agent</code> ç”¨æˆ·ä»£ç† =&gt; æµè§ˆå™¨</li>
<li><code>Authorization server</code> è®¤è¯æœåŠ¡å™¨ =&gt; QQæä¾›çš„ç¬¬ä¸‰æ–¹ç™»å½•æœåŠ¡</li>
<li><code>Resource server</code> èµ„æºæœåŠ¡å™¨ =&gt; è™ç‰™ç›´æ’­æä¾›çš„æœåŠ¡ï¼Œé«˜æ¸…ç›´æ’­ã€å¼¹å¹•å‘é€</li>
</ol>
<p>è®¤è¯æœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨å¯ä»¥åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Œæ¯”å¦‚å‰åç«¯åˆ†ç¦»çš„æœåŠ¡åå°ï¼Œå®ƒæä¾›è®¤è¯æœåŠ¡ï¼ˆæä¾›ä»¤ç‰Œï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡ä»¤ç‰Œæ¥ä»èµ„æºæœåŠ¡å™¨è·å–æœåŠ¡ï¼›å®ƒä»¬ä¹Ÿå¯ä»¥ä¸åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œæ¯”å¦‚ç¬¬ä¸‰æ–¹ç™»å½•çš„æ¡ˆä¾‹ã€‚</p>
<h3 id="6-2-è¿è¡Œæµç¨‹"><a href="#6-2-è¿è¡Œæµç¨‹" class="headerlink" title="6.2 è¿è¡Œæµç¨‹"></a>6.2 è¿è¡Œæµç¨‹</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601220314015.png" class="" title="image-20210601220314015">

<p>ï¼ˆAï¼‰ç”¨æˆ·æ‰“å¼€å®¢æˆ·ç«¯ä»¥åï¼Œå®¢æˆ·ç«¯è¦æ±‚ç”¨æˆ·ç»™äºˆæˆæƒ</p>
<p>ï¼ˆBï¼‰ç”¨æˆ·åŒæ„ç»™äºˆå®¢æˆ·ç«¯æˆæƒ</p>
<p>ï¼ˆCï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä¸Šä¸€æ­¥è·å¾—çš„æˆæƒï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œ</p>
<p>ï¼ˆDï¼‰è®¤è¯æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯åï¼Œç¡®è®¤æ— è¯¯ï¼Œç»Ÿä¸€å‘æ”¾ä»¤ç‰Œ</p>
<p>ï¼ˆEï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä»¤ç‰Œï¼Œå‘èµ„æºæœåŠ¡å™¨ç”³è¯·è·å–èµ„æº</p>
<p>ï¼ˆFï¼‰èµ„æºæœåŠ¡å™¨ç¡®è®¤ä»¤ç‰Œæ— è¯¯ï¼ŒåŒæ„å‘å®¢æˆ·ç«¯å¼€æ”¾èµ„æº</p>
<h3 id="6-3-å››ç§æ¨¡å¼"><a href="#6-3-å››ç§æ¨¡å¼" class="headerlink" title="6.3 å››ç§æ¨¡å¼"></a>6.3 å››ç§æ¨¡å¼</h3><p>ï¼ˆ1ï¼‰<strong>æˆæƒç æ¨¡å¼</strong></p>
<p>æˆæƒç æ¨¡å¼æ˜¯åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†çš„æˆæƒæ¨¡å¼ã€‚</p>
<p>å®ƒçš„ç‰¹ç‚¹æ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„åå°æœåŠ¡å™¨ï¼Œä¸æœåŠ¡æä¾›å•†çš„è®¤è¯æœåŠ¡å™¨è¿›è¡Œäº’åŠ¨ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601220838542.png" class="" title="image-20210601220838542">

<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆAï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨</p>
<p>ï¼ˆBï¼‰ç”¨æˆ·å†³å®šæ˜¯å¦ç»™å®¢æˆ·ç«¯æˆæƒ</p>
<p>ï¼ˆCï¼‰åŒæ„æˆæƒåï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æä¾›çš„URLï¼Œå¹¶é™„ä¸Šæˆæƒç </p>
<p>ï¼ˆDï¼‰å®¢æˆ·ç«¯é€šè¿‡é‡å®šå‘URLå’Œæˆæƒç åˆ°è®¤è¯æœåŠ¡å™¨æ¢å–ä»¤ç‰Œ</p>
<p>ï¼ˆEï¼‰æ ¡éªŒæ— è¯¯åå‘æ”¾ä»¤ç‰Œ</p>
<p>åœ¨Aæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯ç”³è¯·è®¤è¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><code>response_type</code>ï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º<code>code</code>ï¼Œæ ‡è¯†æˆæƒç æ¨¡å¼</li>
<li><code>client_id</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯IDï¼Œå¿…é€‰é¡¹</li>
<li><code>redirect_uri</code>ï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¯é€‰é¡¹</li>
<li><code>scope</code>ï¼šè¡¨ç¤ºç”³è¯·çš„æƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹</li>
<li><code>state</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼</li>
</ol>
<p>åœ¨Cæ­¥éª¤ä¸­ï¼ŒæœåŠ¡å™¨å›åº”å®¢æˆ·ç«¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>code</code>ï¼šè¡¨ç¤ºæˆæƒç ï¼Œå¿…é€‰é¡¹ã€‚è¯¥ç çš„æœ‰æ•ˆæœŸåº”è¯¥å¾ˆçŸ­ï¼Œé€šå¸¸è®¾ä¸º10åˆ†é’Ÿï¼Œå®¢æˆ·ç«¯åªèƒ½ä½¿ç”¨è¯¥ç ä¸€æ¬¡ï¼Œå¦åˆ™ä¼šè¢«æˆæƒæœåŠ¡å™¨æ‹’ç»ã€‚è¯¥ç ä¸å®¢æˆ·ç«¯IDå’Œé‡å®šå‘URIï¼Œæ˜¯ä¸€ä¸€å¯¹åº”å…³</p>
</li>
<li><p><code>state</code>ï¼šå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªå‚æ•°ï¼Œè®¤è¯æœåŠ¡å™¨çš„å›åº”ä¹Ÿå¿…é¡»ä¸€æ¨¡ä¸€æ ·åŒ…å«è¿™ä¸ªå‚æ•°ã€‚</p>
</li>
</ol>
<p>åœ¨Dæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><code>grant_type</code>ï¼šè¡¨ç¤ºä½¿ç”¨çš„æˆæƒæ¨¡å¼ï¼Œå¿…é€‰é¡¹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º<code>authorization_code</code></li>
<li><code>code</code>ï¼šè¡¨ç¤ºä¸Šä¸€æ­¥è·å¾—çš„æˆæƒç ï¼Œå¿…é€‰é¡¹</li>
<li><code>redirect_uri</code>ï¼šè¡¨ç¤ºé‡å®šå‘URIï¼Œå¿…é€‰é¡¹ï¼Œä¸”å¿…é¡»ä¸Aæ­¥éª¤ä¸­çš„è¯¥å‚æ•°å€¼ä¿æŒä¸€è‡´</li>
<li><code>client_id</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯IDï¼Œå¿…é€‰é¡¹</li>
</ol>
<p>åœ¨Eæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å‘é€çš„HTTPå›å¤ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>access_token</code>ï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹ã€‚</p>
</li>
<li><p><code>token_type</code>ï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹ï¼Œå¯ä»¥æ˜¯bearerç±»å‹æˆ–macç±»å‹ã€‚</p>
</li>
<li><p><code>expires_in</code>ï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</p>
</li>
<li><p><code>refresh_token</code>ï¼šè¡¨ç¤ºæ›´æ–°ä»¤ç‰Œï¼Œç”¨æ¥è·å–ä¸‹ä¸€æ¬¡çš„è®¿é—®ä»¤ç‰Œï¼Œå¯é€‰é¡¹ã€‚</p>
</li>
<li><p><code>scope</code>ï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥ã€‚</p>
</li>
</ol>
<p>ï¼ˆ2ï¼‰<strong>ç®€åŒ–æ¨¡å¼</strong></p>
<p>ç®€åŒ–æ¨¡å¼ä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè·³è¿‡äº†â€œæˆæƒç â€è¿™ä¸ªæ­¥éª¤ã€‚</p>
<p>å®ƒçš„ç‰¹ç‚¹æ˜¯æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯å¯è§çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è®¤è¯ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601221616906.png" class="" title="image-20210601221616906">

<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆAï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚</p>
<p>ï¼ˆBï¼‰ç”¨æˆ·å†³å®šæ˜¯å¦ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚</p>
<p>ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„â€é‡å®šå‘URIâ€ï¼Œå¹¶åœ¨URIçš„Hashéƒ¨åˆ†åŒ…å«äº†è®¿é—®ä»¤ç‰Œã€‚</p>
<p>ï¼ˆDï¼‰æµè§ˆå™¨å‘èµ„æºæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ä¸Šä¸€æ­¥æ”¶åˆ°çš„Hashå€¼ã€‚</p>
<p>ï¼ˆEï¼‰èµ„æºæœåŠ¡å™¨è¿”å›ä¸€ä¸ªç½‘é¡µï¼Œå…¶ä¸­åŒ…å«çš„ä»£ç å¯ä»¥è·å–Hashå€¼ä¸­çš„ä»¤ç‰Œã€‚</p>
<p>ï¼ˆFï¼‰æµè§ˆå™¨æ‰§è¡Œä¸Šä¸€æ­¥è·å¾—çš„è„šæœ¬ï¼Œæå–å‡ºä»¤ç‰Œã€‚</p>
<p>ï¼ˆGï¼‰æµè§ˆå™¨å°†ä»¤ç‰Œå‘ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>åœ¨Aæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>response_type</code>ï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º<code>token</code>ï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>client_id</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„IDï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>redirect_uri</code>ï¼šè¡¨ç¤ºé‡å®šå‘çš„URIï¼Œå¯é€‰é¡¹</p>
</li>
<li><p><code>scope</code>ï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹</p>
</li>
<li><p><code>state</code>ï¼šè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼Œè®¤è¯æœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼</p>
</li>
</ol>
<p>åœ¨Cæ­¥éª¤ä¸­ï¼Œè®¤è¯æœåŠ¡å™¨å›åº”å®¢æˆ·ç«¯çš„URIï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>access_token</code>ï¼šè¡¨ç¤ºè®¿é—®ä»¤ç‰Œï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>token_type</code>ï¼šè¡¨ç¤ºä»¤ç‰Œç±»å‹ï¼Œè¯¥å€¼å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>expires_in</code>ï¼šè¡¨ç¤ºè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚å¦‚æœçœç•¥è¯¥å‚æ•°ï¼Œå¿…é¡»å…¶ä»–æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´</p>
</li>
<li><p><code>scope</code>ï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¦‚æœä¸å®¢æˆ·ç«¯ç”³è¯·çš„èŒƒå›´ä¸€è‡´ï¼Œæ­¤é¡¹å¯çœç•¥</p>
</li>
<li><p><code>state</code>ï¼šå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚ä¸­åŒ…å«è¿™ä¸ªå‚æ•°ï¼Œè®¤è¯æœåŠ¡å™¨çš„å›åº”ä¹Ÿå¿…é¡»ä¸€æ¨¡ä¸€æ ·åŒ…å«è¿™ä¸ªå‚æ•°</p>
</li>
</ol>
<p>ï¼ˆ3ï¼‰<strong>å¯†ç æ¨¡å¼</strong></p>
<p>å¯†ç æ¨¡å¼ä¸­ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œå‘è®¤è¯æœåŠ¡å™¨ç´¢è¦æˆæƒã€‚</p>
<p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å­˜å‚¨å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç”±ä¸€ä¸ªè‘—åå…¬å¸å‡ºå“ã€‚è€Œè®¤è¯æœåŠ¡å™¨åªæœ‰åœ¨å…¶ä»–æˆæƒæ¨¡å¼æ— æ³•æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601221808782.png" class="" title="image-20210601221808782">

<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆAï¼‰ç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›ç”¨æˆ·åå’Œå¯†ç </p>
<p>ï¼ˆBï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·åå’Œå¯†ç å‘ç»™è®¤è¯æœåŠ¡å™¨ï¼Œå‘åè€…è¯·æ±‚ä»¤ç‰Œ</p>
<p>ï¼ˆCï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œ</p>
<p>åœ¨Bæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>grant_type</code>ï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸ºâ€passwordâ€ï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>username</code>ï¼šè¡¨ç¤ºç”¨æˆ·åï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>password</code>ï¼šè¡¨ç¤ºç”¨æˆ·çš„å¯†ç ï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>scope</code>ï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹</p>
</li>
</ol>
<p>ï¼ˆ4ï¼‰<strong>å®¢æˆ·ç«¯æ¨¡å¼</strong></p>
<p>å®¢æˆ·ç«¯æ¨¡å¼æŒ‡å®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰ï¼Œè€Œä¸æ˜¯ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œå‘æœåŠ¡æä¾›å•†è¿›è¡Œè®¤è¯ã€‚</p>
<p>ä¸¥æ ¼åœ°è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸å±äºOAuthæ¡†æ¶æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·ç›´æ¥å‘å®¢æˆ·ç«¯æ³¨å†Œï¼Œå®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰è¦æ±‚â€æœåŠ¡æä¾›å•†â€æä¾›æœåŠ¡ï¼Œå…¶å®ä¸å­˜åœ¨æˆæƒé—®é¢˜ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601222435410.png" class="" title="image-20210601222435410">

<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆAï¼‰å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œ</p>
<p>ï¼ˆBï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œ</p>
<p>åœ¨Aæ­¥éª¤ä¸­ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„HTTPè¯·æ±‚ï¼ŒåŒ…å«ä»¥ä¸‹å‚æ•°ï¼š</p>
<ol>
<li><p><code>grant_type</code>ï¼šè¡¨ç¤ºæˆæƒç±»å‹ï¼Œæ­¤å¤„çš„å€¼å›ºå®šä¸º<code>clientcredentials</code>ï¼Œå¿…é€‰é¡¹</p>
</li>
<li><p><code>scope</code>ï¼šè¡¨ç¤ºæƒé™èŒƒå›´ï¼Œå¯é€‰é¡¹</p>
</li>
</ol>
<h3 id="6-4-Spring-Security-OAuth2"><a href="#6-4-Spring-Security-OAuth2" class="headerlink" title="6.4 Spring Security OAuth2"></a>6.4 Spring Security OAuth2</h3><p>Springæ¡†æ¶å¯¹OAuth2åè®®è¿›è¡Œäº†å®ç°ï¼Œä¸‹é¢å­¦ä¹ æˆæƒç æ¨¡å¼å’Œå¯†ç æ¨¡å¼åœ¨Spring Security OAuth2ç›¸å…³æ¡†æ¶çš„ä½¿ç”¨ã€‚</p>
<p>Spring Security OAuth2ä¸»è¦åŒ…å«è®¤è¯æœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨è¿™ä¸¤å¤§å—çš„å®ç°ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210601231533673.png" class="" title="image-20210601231533673">

<p>è®¤è¯æœåŠ¡å™¨ä¸»è¦åŒ…å«äº†å››ç§æˆæƒæ¨¡å¼çš„å®ç°å’ŒTokençš„ç”Ÿæˆä¸å­˜å‚¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è®¤è¯æœåŠ¡å™¨ä¸­è‡ªå®šä¹‰è·å–Tokençš„æ–¹å¼ï¼›èµ„æºæœåŠ¡å™¨ä¸»è¦æ˜¯åœ¨Spring Securityçš„è¿‡æ»¤é“¾ä¸ŠåŠ äº†OAuth2AuthenticationProcessFilterè¿‡æ»¤å™¨ï¼Œå³ä½¿ç”¨OAuth2åè®®å‘æ”¾ä»¤ç‰Œè®¤è¯çš„æ–¹å¼æ¥ä¿è¯æˆ‘ä»¬çš„èµ„æºã€‚</p>
<p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
    &lt;artifactId&gt;lombok&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
    &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
<p>å…ˆå®šä¹‰ä¸€ä¸ª<code>MyUser</code>å¯¹è±¡ï¼š</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class MyUser implements Serializable &#123;
    private static final long serialVersionUID = -3088964382959687717L;

    private String userName;
    private String password;
    private boolean accountNonExpired = true;
    private boolean accountNonLocked= true;
    private boolean credentialsNonExpired= true;
    private boolean enabled= true;
&#125;</code></pre>
<p>æ¥ç€å®šä¹‰<code>CustomUserDetailService</code>å®ç°<code>UserDetailService</code>æ¥å£ï¼š</p>
<pre><code class="java">@Service
public class CustomUserDetailService implements UserDetailsService &#123;
    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;
        MyUser user = new MyUser();
        user.setUserName(username);
        user.setPassword(this.passwordEncoder.encode(&quot;KAG1823&quot;));
        return new User(username, user.getPassword(), user.isEnabled(),
                user.isAccountNonExpired(), user.isCredentialsNonExpired(),
                user.isAccountNonLocked(), AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;admin&quot;));
    &#125;
&#125;</code></pre>
<p>è¿™é‡Œçš„é€»è¾‘æ˜¯ç™»å½•è´¦å·çš„ç”¨æˆ·åæ— æ‰€è°“ï¼Œå¯†ç å¿…é¡»æ˜¯<code>KAG1823</code>ï¼Œå¹¶ä¸”æ‹¥æœ‰adminæƒé™ã€‚</p>
<p>æ¥ä¸‹æ¥åˆ›å»ºè®¤è¯æœåŠ¡å™¨ï¼Œå¹¶ä¸”åœ¨é‡Œé¢å®šä¹‰<code>UserDetailService</code>éœ€è¦ç”¨åˆ°çš„<code>PasswordEncoder</code>ã€‚</p>
<p>åˆ›å»ºè®¤è¯æœåŠ¡å™¨ï¼Œåªéœ€è¦åœ¨Spring Securityçš„é…ç½®ç±»ä¸Šä½¿ç”¨<code>@EnableAuthorizationServer</code>æ³¨è§£æ ‡æ³¨å³å¯ã€‚</p>
<p>åˆ›å»º<code>AuthorizationServerConfig</code>ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="java">@Configuration
@EnableAuthorizationServer
public class AuthorizationServerConfig extends WebSecurityConfigurerAdapter &#123;

    @Bean
    public PasswordEncoder passwordEncoder() &#123;
        return new BCryptPasswordEncoder();
    &#125;

&#125;</code></pre>
<p>å¯åŠ¨é¡¹ç›®ï¼Œä¼šå‘ç°æ§åˆ¶å°æ‰“å°äº†éšæœºåˆ†é…çš„<code>client-id</code>å’Œ<code>client-secret</code>ï¼š</p>
<pre><code class="powershell">security.oauth2.client.client-id = 0b560e22-4148-4bed-8c0d-e0f94813692b
security.oauth2.client.client-secret = 468daba6-e1e5-4c94-8a19-f092a81d7af5</code></pre>
<p>ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æŒ‡å®šè¿™ä¸¤ä¸ªå€¼ã€‚</p>
<p>åœ¨é…ç½®æ–‡ä»¶<code>application.yml</code>ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<pre><code class="yaml">security:
  oauth2:
    client:
      client-id: k
      client-secret: parak</code></pre>
<p>é‡å¯é¡¹ç›®ï¼Œå‘ç°æ§åˆ¶å°è¾“å‡ºï¼š</p>
<pre><code class="powershell">security.oauth2.client.client-id = k
security.oauth2.client.client-secret = ****</code></pre>
<p>è¯´æ˜æ›¿æ¢æˆåŠŸã€‚</p>
<p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®ï¼š<a href="http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=k&amp;redirect_uri=http://parak.top&amp;scope=all&amp;state=hello">http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=k&amp;redirect_uri=http://parak.top&amp;scope=all&amp;state=hello</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602134107689.png" class="" title="image-20210602134107689">

<p>è¾“å…¥éšæ„ç”¨æˆ·åï¼Œå¯†ç KAG1823ï¼Œç™»å½•è®¤è¯åï¼Œé¡µé¢å¦‚ä¸‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602134454758.png" class="" title="image-20210602134454758">

<p>åŸå› æ˜¯ä¸Šé¢æŒ‡å®šçš„redirect_uriå¿…é¡»åŒæ—¶åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼Œæˆ‘ä»¬å¾€application.ymlæ·»åŠ é…ç½®ï¼š</p>
<pre><code class="java">security:
  oauth2:
    client:
      client-id: k
      client-secret: parak
      registered-redirect-uri: http://parak.top</code></pre>
<p>é‡å¯é¡¹ç›®ï¼Œé‡æ–°æ‰§è¡Œä»¥ä¸Šæ­¥éª¤ï¼Œç™»å½•æˆåŠŸåè·³è½¬åˆ°æˆæƒé¡µé¢ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602134705789.png" class="" title="image-20210602134705789">

<p>é€‰æ‹©åŒæ„Approveï¼Œç„¶åç‚¹å‡»AuthorizeæˆæƒæŒ‰é’®ï¼Œé¡µé¢è·³è½¬åˆ°äº†æˆ‘ä»¬æŒ‡å®šçš„redirect_uriï¼Œå¹¶ä¸”å¸¦ä¸Šäº†æˆæƒç ä¿¡æ¯ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602134926178.png" class="" title="image-20210602134926178">

<p>å¯ä»¥çœ‹åˆ°æˆæƒç ä¸ºï¼šFtlxyfï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªæˆæƒç ä»è®¤è¯æœåŠ¡å™¨è·å–ä»¤ç‰ŒTokenäº†ã€‚</p>
<p>ä½¿ç”¨postmanå‘é€è¯·æ±‚ï¼š<a href="http://localhost:8080/oauth/token">http://localhost:8080/oauth/token</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602135802880.png" class="" title="image-20210602135802880">

<p>å…¶ä¸­äº”ä¸ªå‚æ•°å³ä¸ºç”³è¯·ä»¤ç‰Œçš„å‚æ•°ï¼Œ<code>grant_type</code>ä¸ºæˆæƒç±»å‹ï¼Œæ­¤å¤„å›ºå®šä¸º<code>authorization_code</code>ï¼Œ<code>code</code>ä¸ºä¸Šä¸€æ­¥è·å¾—çš„æˆæƒç ï¼Œ<code>client_id</code>ä¸ºå®¢æˆ·ç«¯idï¼Œ<code>redirect_uri</code>ä¸ºé‡å®šå‘URIï¼Œ<code>scope</code>ä¸ºç”³è¯·æƒé™èŒƒå›´ã€‚</p>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­å¡«å†™å¦‚ä¸‹å†…å®¹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602135843099.png" class="" title="image-20210602135843099">

<p>å…¶ä¸­ï¼Œkeyä¸º<code>Authorization</code>ï¼Œvalueä¸º<code>Basic Base64(client_id:client-secret)</code></p>
<p>Base64å·¥å…·ï¼š<a href="http://tool.chinaz.com/Tools/Base64.aspx">http://tool.chinaz.com/Tools/Base64.aspx</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602135958115.png" class="" title="image-20210602135958115">

<p>å‚æ•°å¡«å†™æ— è¯¯åï¼Œå‘é€è¯·æ±‚è¾¹è·å–åˆ°ä»¤ç‰Œï¼š</p>
<pre><code class="json">&#123;
    &quot;access_token&quot;: &quot;ef19f338-651b-43ae-9cea-66ec6e208d0c&quot;,
    &quot;token_type&quot;: &quot;bearer&quot;,
    &quot;refresh_token&quot;: &quot;6761af90-c79e-4023-b23a-3a9c4210e1d4&quot;,
    &quot;expires_in&quot;: 43199,
    &quot;scope&quot;: &quot;all&quot;
&#125;</code></pre>
<p>ä¸€ä¸ªæˆæƒç åªèƒ½è·å–ä¸€æ¬¡ä»¤ç‰Œï¼Œå¦‚æœå†æ¬¡è·å–ï¼Œå°†è¿”å›ï¼š</p>
<pre><code class="json">&#123;
    &quot;error&quot;: &quot;invalid_grant&quot;,
    &quot;error_description&quot;: &quot;Invalid authorization code: Ftlxyf&quot;
&#125;</code></pre>
<p>ä¸ºä»€ä¹ˆè¦é…ç½®èµ„æºæœåŠ¡å™¨å‘¢ï¼Ÿå…ˆæµ‹è¯•ä¸€ä¸‹åœ¨æ²¡æœ‰å®šä¹‰èµ„æºæœåŠ¡å™¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨Tokenå»è·å–èµ„æºä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
<p>å®šä¹‰ä¸€ä¸ªRestæ¥å£ï¼š</p>
<pre><code class="java">@RestController
public class IndexController &#123;

    @GetMapping(&quot;/index&quot;)
    public Object index(Authentication authentication) &#123;
        return authentication;
    &#125;
&#125;</code></pre>
<p>å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨å¯†ç æ¨¡å¼è·å–ä»¤ç‰Œï¼Œå‚æ•°åœ¨ä¸Šè¿°å››å¤§æ¨¡å¼ä¸­å·²ç»æåˆ°ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602143039788.png" class="" title="image-20210602143039788">

<p>ç„¶åä½¿ç”¨è¯¥ä»¤ç‰Œè®¿é—®<code>/index</code>ï¼Œvalueä¸º<code>token_type access_token</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602143155492.png" class="" title="image-20210602143155492">

<p>è™½ç„¶ä»¤ç‰Œæ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å¹¶æ— æ³•è®¿é—®<code>/index</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»é…ç½®èµ„æºæœåŠ¡å™¨ï¼Œè®©å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡åˆæ³•çš„ä»¤ç‰Œæ¥è·å–èµ„æºã€‚</p>
<p>èµ„æºæœåŠ¡å™¨çš„é…ç½®ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨é…ç½®ç±»ä¸Šä½¿ç”¨<code>@EnableResourceServer</code>æ³¨è§£å³å¯ï¼š</p>
<pre><code class="java">@Configuration
@EnableResourceServer
public class ResourceServerConfig &#123;
&#125;</code></pre>
<p>é‡å¯æœåŠ¡ï¼Œé‡å¤ä¸Šé¢æ­¥éª¤ï¼Œå†æ¬¡è®¿é—®<code>/index</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="json">&#123;
    &quot;authorities&quot;: [
        &#123;
            &quot;authority&quot;: &quot;admin&quot;
        &#125;
    ],
    &quot;details&quot;: &#123;
        &quot;remoteAddress&quot;: &quot;0:0:0:0:0:0:0:1&quot;,
        &quot;sessionId&quot;: null,
        &quot;tokenValue&quot;: &quot;5a5b41c7-80d1-4496-9b6b-a8151db23160&quot;,
        &quot;tokenType&quot;: &quot;bearer&quot;,
        &quot;decodedDetails&quot;: null
    &#125;,
    &quot;authenticated&quot;: true,
    &quot;userAuthentication&quot;: &#123;
        &quot;authorities&quot;: [
            &#123;
                &quot;authority&quot;: &quot;admin&quot;
            &#125;
        ],
        &quot;details&quot;: &#123;
            &quot;grant_type&quot;: &quot;password&quot;,
            &quot;username&quot;: &quot;Khighness&quot;,
            &quot;scope&quot;: &quot;all&quot;
        &#125;,
        &quot;authenticated&quot;: true,
        &quot;principal&quot;: &#123;
            &quot;password&quot;: null,
            &quot;username&quot;: &quot;Khighness&quot;,
            &quot;authorities&quot;: [
                &#123;
                    &quot;authority&quot;: &quot;admin&quot;
                &#125;
            ],
            &quot;accountNonExpired&quot;: true,
            &quot;accountNonLocked&quot;: true,
            &quot;credentialsNonExpired&quot;: true,
            &quot;enabled&quot;: true
        &#125;,
        &quot;credentials&quot;: null,
        &quot;name&quot;: &quot;Khighness&quot;
    &#125;,
    &quot;oauth2Request&quot;: &#123;
        &quot;clientId&quot;: &quot;k&quot;,
        &quot;scope&quot;: [
            &quot;all&quot;
        ],
        &quot;requestParameters&quot;: &#123;
            &quot;grant_type&quot;: &quot;password&quot;,
            &quot;username&quot;: &quot;Khighness&quot;,
            &quot;scope&quot;: &quot;all&quot;
        &#125;,
        &quot;resourceIds&quot;: [],
        &quot;authorities&quot;: [
            &#123;
                &quot;authority&quot;: &quot;ROLE_USER&quot;
            &#125;
        ],
        &quot;approved&quot;: true,
        &quot;refresh&quot;: false,
        &quot;redirectUri&quot;: null,
        &quot;responseTypes&quot;: [],
        &quot;extensions&quot;: &#123;&#125;,
        &quot;grantType&quot;: &quot;password&quot;,
        &quot;refreshTokenRequest&quot;: null
    &#125;,
    &quot;clientOnly&quot;: false,
    &quot;credentials&quot;: &quot;&quot;,
    &quot;principal&quot;: &#123;
        &quot;password&quot;: null,
        &quot;username&quot;: &quot;Khighness&quot;,
        &quot;authorities&quot;: [
            &#123;
                &quot;authority&quot;: &quot;admin&quot;
            &#125;
        ],
        &quot;accountNonExpired&quot;: true,
        &quot;accountNonLocked&quot;: true,
        &quot;credentialsNonExpired&quot;: true,
        &quot;enabled&quot;: true
    &#125;,
    &quot;name&quot;: &quot;Khighness&quot;
&#125;</code></pre>
<blockquote>
<p>åœ¨åŒæ—¶å®šä¹‰äº†è®¤è¯æœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨åï¼Œå†å»ä½¿ç”¨æˆæƒç æ¨¡å¼è·å–ä»¤ç‰Œå¯èƒ½ä¼šé‡åˆ°<code>Full authentication is required to access this resource </code>çš„é—®é¢˜ï¼Œè¿™æ—¶å€™åªè¦ç¡®ä¿è®¤è¯æœåŠ¡å™¨å…ˆäºèµ„æºæœåŠ¡å™¨é…ç½®å³å¯ï¼Œæ¯”å¦‚åœ¨è®¤è¯æœåŠ¡å™¨çš„é…èµ„ç±»ä¸Šä½¿ç”¨<code>@Order(1)</code>æ ‡æ³¨ï¼Œåœ¨èµ„æºæœåŠ¡å™¨çš„é…ç½®ç±»ä¸Šä½¿ç”¨<code>@Order(2)</code>æ ‡æ³¨ã€‚</p>
</blockquote>
<h2 id="7-Spring-Security-OAuth2-Custom"><a href="#7-Spring-Security-OAuth2-Custom" class="headerlink" title="7. Spring Security OAuth2 Custom"></a>7. Spring Security OAuth2 Custom</h2><p>ğŸ“–æ¦‚è¿°</p>
<p>è¿™ä¸€èŠ‚ä¸»è¦å®ç°é€šè¿‡è‡ªå®šä¹‰çš„ç”¨æˆ·åå¯†ç å’Œé‚®ç®±çŸ­ä¿¡éªŒè¯ç çš„æ–¹å¼æ¥è·å–ä»¤ç‰Œã€‚</p>
<h3 id="7-1-ç”¨æˆ·åå¯†ç "><a href="#7-1-ç”¨æˆ·åå¯†ç " class="headerlink" title="7.1 ç”¨æˆ·åå¯†ç "></a>7.1 ç”¨æˆ·åå¯†ç </h3><p>ç»§æ‰¿ä¸Šä¸€èŠ‚çš„é¡¹ç›®ï¼Œèµ„æºæœåŠ¡å™¨ä¸ŠåŠ å…¥ä¸€äº›åŸºæœ¬é…ç½®ï¼Œå°†è¡¨å•ç™»å½•çš„URLè®¾ç½®ä¸º<code>/login</code>ï¼ŒåŒæ—¶åŠ å…¥å¤„ç†ç™»å½•æˆåŠŸå’Œå¤±è´¥çš„é€»è¾‘ï¼š</p>
<pre><code class="java">@Configuration
@EnableResourceServer
public class ResourceServerConfig extends ResourceServerConfigurerAdapter &#123;
    @Autowired
    private MyAuthenticationSuccessHandler authenticationSuccessHandler;
    @Autowired
    private MyAuthenticationFailureHandler authenticationFailureHandler;

    @Override
    public void configure(HttpSecurity http) throws Exception &#123;
        http.formLogin()                  // è¡¨å•ç™»å½•
            .loginProcessingUrl(&quot;/login&quot;) // å¤„ç†è¡¨å•ç™»å½•URL
            .successHandler(authenticationSuccessHandler) // å¤„ç†ç™»å½•æˆåŠŸ
            .failureHandler(authenticationFailureHandler) // å¤„ç†ç™»å½•å¤±è´¥
        .and()
            .authorizeRequests() // æˆæƒé…ç½®
            .anyRequest()        // æ‰€æœ‰è¯·æ±‚
            .authenticated()     // éƒ½éœ€è®¤è¯
        .and()
            .csrf().disable()    // ç¦ç”¨CSRFä¿æŠ¤
        ;
    &#125;
&#125;</code></pre>
<p>å¤„ç†ç™»å½•å¤±è´¥çš„é€»è¾‘å¾ˆç®€å•ï¼Œç›´æ¥è¿”å›é”™è¯¯æç¤ºï¼š</p>
<pre><code class="java">@Component
public class MyAuthenticationFailureHandler implements AuthenticationFailureHandler &#123;
    @Autowired
    private ObjectMapper objectMapper;

    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException, ServletException &#123;
        response.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());
        response.setContentType(&quot;application/json;charset=utf-8&quot;);
        response.getWriter().write(objectMapper.writeValueAsString(e.getMessage()));
    &#125;
&#125;</code></pre>
<p>å¤„ç†ç™»å½•æˆåŠŸçš„é€»è¾‘æ˜¯å…³é”®ï¼ŒSpring Security OAuth2çš„ä»¤ç‰Œäº§ç”Ÿæµç¨‹å¦‚ä¸‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602163830912.png" class="" title="image-20210602163830912">

<p>å‚è€ƒè¿™ä¸ªæµç¨‹ï¼Œæ¥å®ç°åœ¨ç™»å½•æˆåŠŸå¤„ç†å™¨<code>MyAuthenticationSuccessHandler</code>é‡Œç”Ÿæˆä»¤ç‰Œå¹¶è¿”å›ï¼š</p>
<pre><code class="java">@Slf4j
@Component
public class MyAuthenticationSuccessHandler implements AuthenticationSuccessHandler &#123;
    @Autowired
    private ObjectMapper objectMapper;

    @Autowired
    private ClientDetailsService clientDetailsService;

    @Qualifier(&quot;defaultAuthorizationServerTokenServices&quot;)
    @Autowired
    private AuthorizationServerTokenServices authorizationServerTokenServices;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException &#123;
        // 1. ä»è¯·æ±‚å¤´è·å–clientId
        String header = request.getHeader(&quot;Authorization&quot;);
        if (header == null || !header.startsWith(&quot;Basic &quot;)) &#123;
            throw new UnapprovedClientAuthenticationException(&quot;No client information was found in the request header&quot;);
        &#125;
        String[] tokens = this.extractAndDecodeHeader(header);
        String clientId = tokens[0], clientSecret = tokens[1];
        TokenRequest tokenRequest = null;
        // 2. é€šè¿‡ClientDetailServiceè·å–ClientDetails
        ClientDetails clientDetails = clientDetailsService.loadClientByClientId(clientId);
        // 3. æ ¡éªŒClientIdå’ŒClientSecretçš„æ­£ç¡®æ€§
        if (clientDetails == null) &#123;
            throw new UnapprovedClientAuthenticationException(&quot;No client details was found for clientId &quot; + clientId);
        &#125; else if (!StringUtils.equals(clientDetails.getClientSecret(), clientSecret)) &#123;
            throw new UnapprovedClientAuthenticationException(&quot;The client secret is invalid&quot;);
        &#125; else &#123;
            // 4. é€šè¿‡TokenRequestæ„é€ å™¨ç”ŸæˆTokenRequest
            tokenRequest = new TokenRequest(new HashMap&lt;&gt;(), clientId, clientDetails.getScope(), &quot;custom&quot;);
        &#125;
        // 5. é€šè¿‡TokenRequestçš„createOAuth2Requestæ–¹æ³•è·å–OAuth2Request
        OAuth2Request auth2Request = tokenRequest.createOAuth2Request(clientDetails);
        // 6. é€šè¿‡Authenticationå’ŒOAuth2Requestæ„é€ å‡ºOAuth2Authentication
        OAuth2Authentication auth2Authentication = new OAuth2Authentication(auth2Request, authentication);
        // 7. é€šè¿‡AuthenticationSServerTokenServiceç”ŸæˆOAuth2AccessToken
        OAuth2AccessToken token = authorizationServerTokenServices.createAccessToken(auth2Authentication);
        // 8. è¿”å›token
        log.info(&quot;[&#123;&#125;]ç™»å½•æˆåŠŸ&quot;, authentication.getName());
        response.setContentType(&quot;application/json;charset=utf-8&quot;);
        response.getWriter().write(objectMapper.writeValueAsString(token));
    &#125;

    /**
     * ä»headerä¸­è·å–client-idå’Œclient-secret
     */
    private String[] extractAndDecodeHeader(String header) &#123;
        byte[] base64Token = header.substring(6).getBytes(StandardCharsets.UTF_8);
        byte[] decoded;
        try &#123;
            decoded = Base64.getDecoder().decode(base64Token);
        &#125; catch (IllegalArgumentException e) &#123;
            throw new BadCredentialsException(&quot;Failed to decode basic authentication token&quot;);
        &#125;
        String token = new String(decoded, StandardCharsets.UTF_8);
        int index = token.indexOf(&quot;:&quot;);
        if (index == -1) &#123;
            throw new BadCredentialsException(&quot;The basic authentication token is invalid&quot;);
        &#125; else &#123;
            return new String[]&#123;token.substring(0, index), token.substring(index + 1)&#125;;
        &#125;
    &#125;
&#125;</code></pre>
<p>å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨postmanå‘é€ç™»å½•è¯·æ±‚ï¼š<a href="http://localhost:8080/login?username=Khighness&amp;password=KAG1823">http://localhost:8080/login?username=Khighness&amp;password=KAG1823</a></p>
<p>åŒæ—¶åœ¨è¯·æ±‚å¤´ä¸­å¸¦ä¸ŠAuthorizationï¼š<code>Basic azpwYXJhaw==</code></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602163259549.png" class="" title="image-20210602163259549">

<p>æˆåŠŸè·å–åˆ°ä»¤ç‰Œåï¼Œå†è®¿é—®<code>/index</code>æ¥å£ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602163437616.png" class="" title="image-20210602163437616">



<h3 id="7-2-é‚®ä»¶éªŒè¯ç "><a href="#7-2-é‚®ä»¶éªŒè¯ç " class="headerlink" title="7.2 é‚®ä»¶éªŒè¯ç "></a>7.2 é‚®ä»¶éªŒè¯ç </h3><p>åˆ›å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
    &lt;artifactId&gt;lombok&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-mail&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
    &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
<p>é…ç½®securityï¼Œrediså’Œmailï¼š</p>
<pre><code class="yaml">security:
  oauth2:
    client:
      client-id: k
      client-secret: parak
      registered-redirect-uri: http://parak.top

spring:
  redis:
    host: 127.0.0.1
    password: KAG1823
    database: 0
  # é‚®ç®±è¿™æ ·é…ç½®ä¸€èˆ¬ä¸ä¼šå‡ºç°é—®é¢˜
  mail:
    username: &lt;é‚®ç®±&gt;
    password: &lt;é‚®ç®±æˆæƒç &gt;
    host: &lt;é‚®ä»¶STMPæœåŠ¡å™¨&gt;
    port: 465
    properties:
      mail:
        ssl:
          enable: true
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
          socketFactory:
            port: 465
            class: javax.net.ssl.SSLSocketFactory
            fallback: false</code></pre>
<p>åœ¨Spring Securityä¸­ï¼Œä½¿ç”¨ç”¨æˆ·åå¯†ç è®¤è¯çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹å›¾å·¦æµç¨‹æ‰€ç¤ºã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210602181133567.png" class="" title="image-20210602181133567">

<p>Spring Securityä½¿ç”¨<code>UsernamePasswordAuthenticationFilter</code>è¿‡æ»¤å™¨æ¥æ‹¦æˆªç”¨æˆ·åå¯†ç è®¤è¯è¯·æ±‚ï¼Œå°†ç”¨æˆ·åå’Œå¯†ç å°è£…æˆä¸€ä¸ª<code>UsernamePasswordAuthenticationToken</code>å¯¹è±¡äº¤ç»™<code>AuthenticationManager</code>å¤„ç†ã€‚<code>AuthenticationManager</code>å°†æŠ›å‡ºä¸€ä¸ªæ”¯æŒè¯¥ç±»å‹Tokençš„<code>AuthenticationProvider</code>æ¥è¿›è¡Œè®¤è¯ï¼Œè®¤è¯è¿‡ç¨‹ä¸­<code>DaoAuthenticationProvider</code>å°†è°ƒç”¨<code>UserDetailService</code>çš„<code>loadUserByUsername</code>æ¥è·å–<code>UserDetails</code>å¯¹è±¡ï¼Œå¦‚æœ<code>UserDetails</code>ä¸ä¸ºç©ºå¹¶ä¸”å¯†ç å’Œç”¨æˆ·è¾“å…¥çš„å¯†ç åŒ¹é…ä¸€è‡´çš„è¯ï¼Œåˆ™å°†è®¤è¯ä¿¡æ¯ä¿å­˜åˆ°sessionä¸­ï¼Œè®¤è¯åæˆ‘ä»¬ä¾¿å¯ä»¥é€šè¿‡<code>Authentication</code>å¯¹è±¡è·å–åˆ°è®¤è¯çš„ä¿¡æ¯ã€‚</p>
<p>ç”±äºSpring Securityå¹¶æ²¡æœ‰æä¾›éªŒè¯ç è®¤è¯çš„æµç¨‹ï¼Œæ‰€ä»¥æˆ‘éœ€è¦ä»¿ç…§ä¸Šå›¾å·¦è¾¹çš„æµç¨‹å®ç°ï¼Œå¦‚å³å›¾æ‰€ç¤ºã€‚</p>
<p>åœ¨è¿™ä¸ªæµç¨‹ä¸­ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªåä¸º<code>CodeAuthenticationFilter</code>çš„è¿‡æ»¤å™¨æ¥æ‹¦æˆªé‚®ä»¶éªŒè¯ç ç™»å½•è¯·æ±‚ï¼Œå¹¶å°†é‚®ç®±å°è£…åˆ°ä¸€ä¸ª<code>EmailCodeAuthenticationToken</code>å¯¹è±¡ä¸­ã€‚åœ¨Spring Securityä¸­ï¼Œè®¤è¯å¤„ç†éƒ½éœ€è¦é€šè¿‡<code>AuthenticationManager</code>æ¥ä»£ç†ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¾æ—§å°†<code>EmailCodeAuthenticationToken</code>äº¤ç”±<code>AuthenticationManager</code>å¤„ç†ã€‚æ¥ç€æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå¤„ç†<code>EmailCodeAuthenticationToken</code>å¯¹è±¡çš„<code>CodeAuthenticationProvider</code>ï¼Œ<code>EmailAuthenticationProvider</code>è°ƒç”¨<code>UserDetailService</code>çš„<code>loadUserByUsername</code>æ–¹æ³•æ¥å¤„ç†è®¤è¯ã€‚ä¸ç”¨æˆ·åå¯†ç è®¤è¯ä¸ä¸€æ ·çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯é€šè¿‡<code>EmailCodeAuthenticationToken</code>ä¸­çš„é‚®ç®±å»æ•°æ®åº“ä¸­æŸ¥è¯¢æ˜¯å¦æœ‰ä¸ä¹‹å¯¹åº”çš„ç”¨æˆ·ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°†è¯¥ç”¨æˆ·ä¿¡æ¯å°è£…åˆ°<code>UserDetails</code>å¯¹è±¡ä¸­è¿”å›å¹¶å°†è®¤è¯åçš„ä¿¡æ¯ä¿å­˜åˆ°<code>Authentication</code>å¯¹è±¡ä¸­ã€‚</p>
<p>ä¸ºäº†å®ç°è¿™ä¸ªæµç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å®ç°<code>EmailCodeAuthenticationToken</code>ã€<code>EmailCodeAuthenticationFilter</code>å’Œ<code>EmailCodeAuthenticationProvider</code>ï¼Œå¹¶å°†è¿™äº›ç»„åˆèµ·æ¥æ·»åŠ åˆ°Spring Securityä¸­ã€‚</p>
<p>æ•´ä¸ªé¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><code>top
â””â”€â”€ parak
     â”œâ”€â”€ SpringSecurityOAuth2EmailApplication     é¡¹ç›®å¯åŠ¨ç±»
     â”œâ”€â”€ config
     â”‚    â”œâ”€â”€ AuthorizationServerConfig            æˆæƒæœåŠ¡å™¨
     â”‚    â””â”€â”€ ResourceServerConfig                 èµ„æºæœåŠ¡å™¨
     â”œâ”€â”€ controller
     â”‚    â”œâ”€â”€ IndexController                      èµ„æºæ¥å£
     â”‚    â””â”€â”€ ValidateController                   éªŒè¯ç æ¥å£
     â”œâ”€â”€ entity
     â”‚    â””â”€â”€ MyUser                               è‡ªå®šä¹‰ç”¨æˆ·
     â”œâ”€â”€ handler
     â”‚    â”œâ”€â”€ MyAuthenticationFailureHandler       å¤„ç†ç™»å½•æˆåŠŸ
     â”‚    â””â”€â”€ MyAuthenticationSuccessHandler       å¤„ç†ç™»å½•å¤±è´¥
     â”œâ”€â”€ service
     â”‚    â”œâ”€â”€ EmailCodeService                     å‘é€é‚®ä»¶æœåŠ¡
     â”‚    â”œâ”€â”€ EmailUserDetailService               è‡ªå®šä¹‰é‚®ç®±è®¤è¯
     â”‚    â””â”€â”€ RedisCodeService.java                éªŒè¯ç ç¼“å­˜æ“ä½œ
     â””â”€â”€ validate
          â””â”€â”€ emailcode
               â”œâ”€â”€ EmailCode                        é‚®ä»¶éªŒè¯ç 
               â”œâ”€â”€ EmailCodeAuthenticationConfig    é‚®ä»¶éªŒè¯ç é…ç½®
               â”œâ”€â”€ EmailCodeAuthenticationFilter    ç™»å½•è¯·æ±‚è¿‡æ»¤å™¨
               â”œâ”€â”€ EmailCodeAuthenticationProvider  ç”¨æˆ·é‚®ç®±æ ¡éªŒ
               â”œâ”€â”€ EmailCodeAuthenticationToken     é‚®ä»¶éªŒè¯ç ä»¤ç‰Œ
               â””â”€â”€ EmailCodeFilter                  é‚®ä»¶éªŒè¯ç æ ¡éªŒ</code></pre>
<p>å…¶ä¸­è‡ªå®šä¹‰ç”¨æˆ·ã€æˆæƒæœåŠ¡å™¨ã€ç™»å½•æˆåŠŸå’Œå¤±è´¥çš„å¤„ç†å™¨ä»¥åŠé¦–é¡µæ¥å£å»¶ç”¨ä¸Šæ¬¡åˆ›å»ºçš„é¡¹ç›®å³å¯ã€‚</p>
<p>æˆ‘ä»¬å…ˆå®ç°é‚®ä»¶å‘é€åŠŸèƒ½ã€‚</p>
<p>å®šä¹‰<code>EmailCode</code>å°è£…é‚®ä»¶éªŒè¯ç ï¼š</p>
<pre><code class="java">@Data
@AllArgsConstructor
public class EmailCode &#123;
    private String code;
&#125;</code></pre>
<p>å®šä¹‰<code>EmailUserDetailService</code>å®ç°é‚®ç®±è®¤è¯é€»è¾‘ï¼š</p>
<pre><code class="java">@Configuration
public class EmailUserDetailService implements UserDetailsService &#123;
    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException &#123;
        // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢é€»è¾‘ï¼›æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·
        MyUser user = new MyUser();
        user.setUserName(email);
        user.setPassword(passwordEncoder.encode(&quot;KAG1823&quot;));
        List&lt;GrantedAuthority&gt; authorityList = new ArrayList&lt;&gt;();
        // åªæœ‰é‚®ç®±ä¸ºparakovo@gmailçš„ç”¨æˆ·æ‰ä¸ºç®¡ç†å‘˜adminï¼Œå…¶ä»–ç”¨æˆ·éƒ½ä¸ºè®¿å®¢guest
        if (StringUtils.equalsIgnoreCase(&quot;parakovo@gmail&quot;, email)) &#123;
            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;admin&quot;);
        &#125; else &#123;
            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;guest&quot;);
        &#125;
        return new User(email, user.getPassword(), user.isEnabled(),
                user.isAccountNonExpired(), user.isCredentialsNonExpired(),
                user.isAccountNonLocked(), authorityList);
    &#125;
&#125;</code></pre>
<p>å®šä¹‰<code>RedisCodeService</code>å®ç°ç¼“å­˜å¯¹äºéªŒè¯ç çš„æ“ä½œï¼š</p>
<pre><code class="java">@Service
public class RedisCodeService &#123;
    /** é‚®ç®±éªŒè¯ç keyçš„å‰ç¼€ */
    private final static String EMAIL_CODE_PREFIX = &quot;EMAIL_CODE:&quot;;
    /** é‚®ç®±éªŒè¯ç è¿‡æœŸæ—¶é—´S */
    private final static Integer EMAIL_CODE_TIMEOUT = 300;

    @Autowired
    private StringRedisTemplate redisTemplate;

    /**
     * ä¿å­˜éªŒè¯ç 
     */
    public void save(EmailCode emailCode, ServletWebRequest request, String email) throws Exception &#123;
        redisTemplate.opsForValue().set(key(request, email), emailCode.getCode(), EMAIL_CODE_TIMEOUT, TimeUnit.SECONDS);
    &#125;

    /**
     * è·å–éªŒè¯ç 
     */
    public String get(ServletWebRequest request, String email) throws Exception&#123;
        String key = key(request, email);
        Long expire = redisTemplate.opsForValue().getOperations().getExpire(key);
        if (expire == -2) // è¿‡æœŸ
            throw new Exception(&quot;The verification code has expired&quot;);
        return redisTemplate.opsForValue().get(key);
    &#125;

    /**
     * ç§»é™¤éªŒè¯ç 
     */
    public void remove(ServletWebRequest request, String email) throws Exception &#123;
        redisTemplate.delete(key(request, email));
    &#125;

    private String key(ServletWebRequest request, String email) throws Exception &#123;
        String deviceId = request.getHeader(&quot;deviceId&quot;);
        if (StringUtils.isBlank(deviceId)) &#123;
            throw new Exception(&quot;No device id was found in request header&quot;);
        &#125;
        return EMAIL_CODE_PREFIX + deviceId + &quot;:&quot; + email;
    &#125;
&#125;</code></pre>
<p>å®šä¹‰<code>EmailCodeService</code>å®ç°é‚®ä»¶éªŒè¯ç çš„å‘é€ï¼š</p>
<pre><code class="java">@Service
public class EmailCodeService &#123;
    @Value(&quot;$&#123;spring.mail.username&#125;&quot;)
    private String fromMail;

    @Autowired
    private MailSender mailSender;

    @Autowired
    private RedisCodeService redisCodeService;

    /**
     * å‘é€éªŒè¯ç åˆ°æŒ‡å®šé‚®ç®±
     * @param request è¯·æ±‚
     * @param code    éªŒè¯ç 
     * @param toMail  ç›®æ ‡é‚®ç®±
     */
    public void send(ServletWebRequest request, String code, String toMail) throws Exception &#123;
        SimpleMailMessage message = new SimpleMailMessage();
        message.setFrom(fromMail);
        message.setTo(toMail);
        message.setSubject(&quot;SpringSecurityéªŒè¯ç &quot;);
        message.setText(&quot;æ‚¨æ­£åœ¨ç™»å½•Spring-Security-OAuth2, éªŒè¯ç ä¸ºï¼š&quot; + code);
        try &#123;
            mailSender.send(message);
        &#125; catch (Exception e) &#123;
            redisCodeService.remove(request, toMail);
            throw new Exception(e.getMessage());
        &#125;
    &#125;
&#125;</code></pre>
<p>ç„¶åæˆ‘ä»¬ç¼–å†™RESTæ¥å£ï¼Œå‘é€é‚®ä»¶éªŒè¯ç ï¼š</p>
<pre><code class="java">@Slf4j
@RestController
public class ValidateController &#123;
    @Autowired
    private RedisCodeService redisCodeService;
    @Autowired
    private EmailCodeService emailCodeService;

    @GetMapping(&quot;/code/email&quot;)
    public void sendEmailCode(HttpServletRequest request, String email) throws Exception &#123;
        String code = RandomStringUtils.randomNumeric(6);
        EmailCode emailCode = new EmailCode(code);
        ServletWebRequest webRequest = new ServletWebRequest(request);
        emailCodeService.send(webRequest, code, email);
        redisCodeService.save(emailCode, webRequest, email);
        log.info(&quot;ç”¨æˆ·ä½¿ç”¨é‚®ç®±[&#123;&#125;]ç™»å½•ï¼ŒéªŒè¯ç ä¸ºï¼š[&#123;&#125;]&quot;, email, code);
    &#125;
&#125;</code></pre>
<p>ç„¶åå®ç°é‚®ä»¶éªŒè¯ç çš„è®¤è¯æµç¨‹ã€‚</p>
<p>æŸ¥çœ‹<code>UsernamePasswordAuthenticationToken</code>çš„æºç ï¼Œå°†å…¶å¤åˆ¶å‡ºæ¥é‡å‘½åä¸º<code>EmailCodeAuthenticationToken</code>ï¼Œå¹¶ç¨ä½œä¿®æ”¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="java">public class EmailCodeAuthenticationToken extends AbstractAuthenticationToken &#123;
    private static final long serialVersionUID = -8522249673088578015L;

    private final Object principal;

    public EmailCodeAuthenticationToken(String email) &#123;
        super(null);
        this.principal = email;
        setAuthenticated(false);
    &#125;

    public EmailCodeAuthenticationToken(Object principal, Collection&lt;? extends GrantedAuthority&gt; authorities) &#123;
        super(authorities);
        this.principal = principal;
        super.setAuthenticated(true);
    &#125;

    @Override
    public Object getCredentials() &#123;
        return null;
    &#125;

    @Override
    public Object getPrincipal() &#123;
        return this.principal;
    &#125;

    public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException &#123;
        if (isAuthenticated) &#123;
            throw new IllegalArgumentException(
                    &quot;Cannot set this token trusted - use constructor which takes a GrantedAuthority list instead&quot;
            );
        &#125;
        super.setAuthenticated(false);
    &#125;

    @Override
    public void eraseCredentials() &#123;
        super.eraseCredentials();
    &#125;
&#125;</code></pre>
<p><code>EmailCodeAuthenticationToken</code>åŒ…å«ä¸€ä¸ª<code>principal</code>å±æ€§ï¼Œä»å®ƒçš„ä¸¤ä¸ªæ„é€ å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œåœ¨è®¤è¯ä¹‹å‰<code>principal</code>å­˜çš„æ˜¯æ‰‹æœºå·ï¼Œè®¤è¯ä¹‹åå­˜çš„æ˜¯ç”¨æˆ·ä¿¡æ¯ã€‚<code>UsernamePasswordAuthenticationToken</code>åŸæ¥è¿˜åŒ…å«ä¸€ä¸ª<code>credentials</code>å±æ€§ç”¨äºå­˜æ”¾å¯†ç ï¼Œè¿™é‡Œä¸éœ€è¦å°±å»æ‰äº†ã€‚</p>
<p>æ¥ç€å®šä¹‰ç”¨äºå¤„ç†çŸ­ä¿¡éªŒè¯ç ç™»å½•è¯·æ±‚çš„è¿‡æ»¤å™¨<code>EmailCodeAuthenticationFilter</code>ï¼ŒåŒæ ·çš„å¤åˆ¶<code>UsernamePasswordAuthenticationFilter</code>æºç å¹¶ç¨ä½œä¿®æ”¹ï¼š</p>
<pre><code class="java">public class EmailCodeAuthenticationFilter extends AbstractAuthenticationProcessingFilter &#123;
    public static final String EMAIL_KEY = &quot;email&quot;;
    private String emailParameter = EMAIL_KEY;
    private boolean postOnly = true;

    protected EmailCodeAuthenticationFilter() &#123;
        super(new AntPathRequestMatcher(&quot;/login/email&quot;, &quot;POST&quot;));
    &#125;

    public void setEmailParameter(String emailParameter) &#123;
        this.emailParameter = emailParameter;
    &#125;

    public void setPostOnly(boolean postOnly) &#123;
        this.postOnly = postOnly;
    &#125;

    public final String getEmailParameter() &#123;
        return emailParameter;
    &#125;

    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException, IOException, ServletException &#123;
        if (postOnly &amp;&amp; !request.getMethod().equals(&quot;POST&quot;))
            throw new AuthenticationServiceException(&quot;Authentication method not supported: &quot; + request.getMethod());
        String email = request.getParameter(emailParameter);
        if (email == null) email = &quot;&quot;;
        email = email.trim();
        EmailCodeAuthenticationToken token = new EmailCodeAuthenticationToken(email);
        token.setDetails(authenticationDetailsSource.buildDetails(request));
        return this.getAuthenticationManager().authenticate(token);
    &#125;
&#125;</code></pre>
<p>æ„é€ å‡½æ•°ä¸­æŒ‡å®šäº†å½“è¯·æ±‚è·¯å¾„ä¸º<code>login.email</code>ï¼Œè¯·æ±‚æ–¹æ³•ä¸ºPOSTçš„æ—¶å€™è¯¥è¿‡æ»¤å™¨ç”Ÿæ•ˆã€‚<code>emailParameter</code>å±æ€§å€¼ä¸º<code>email</code>ï¼Œå¯¹åº”ç™»å½•é¡µé¢é‚®ä»¶è¾“å…¥æ¡†çš„<code>name</code>å±æ€§ï¼Œå¹¶è°ƒç”¨<code>EmailCodeAuthenticationToken</code>çš„æ„é€ æ–¹æ³•<code>EmailCodeAuthenticationToken(String email)</code>åˆ›å»ºäº†ä¸€ä¸ª<code>EmailCodeAuthenticationToken</code>ã€‚ä¸‹ä¸€æ­¥å°±å¦‚æµç¨‹å›¾ä¸­æ‰€ç¤ºçš„é‚£æ ·ï¼Œ<code>EmailCodeAuthenticationFilter</code>å°†<code>EmailCodeAuthenticationToken</code>äº¤ç»™<code>AuthenticationManager</code>å¤„ç†ã€‚</p>
<p>ç„¶åæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ”¯æŒå¤„ç†<code>EmailCodeAuthenticationToken</code>çš„ç±»ï¼Œå³<code>EmailCodeAuthenticationProvider</code>ï¼Œè¯¥ç±»éœ€è¦å®ç°<code>AuthenticationProvider</code>çš„ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œä¸»è¦å®ç°ç™»å½•çš„é‚®ç®±å­˜åœ¨æ€§æ ¡éªŒï¼š</p>
<pre><code class="java">public class EmailCodeAuthenticationProvider implements AuthenticationProvider &#123;
    private UserDetailsService userDetailsService;

    public UserDetailsService getUserDetailsService() &#123;
        return userDetailsService;
    &#125;

    public void setUserDetailsService(UserDetailsService userDetailsService) &#123;
        this.userDetailsService = userDetailsService;
    &#125;

    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException &#123;
        EmailCodeAuthenticationToken authenticationToken = (EmailCodeAuthenticationToken) authentication;
        UserDetails userDetails = userDetailsService.loadUserByUsername((String) authenticationToken.getPrincipal());
        if (userDetails == null) // æœªæ‰¾åˆ°ä¸è¯¥é‚®ç®±åŒ¹é…çš„ç”¨æˆ·
            throw new InternalAuthenticationServiceException(&quot;The user corresponding to the email was not found&quot;);
        EmailCodeAuthenticationToken authenticationResult = new EmailCodeAuthenticationToken(userDetails, userDetails.getAuthorities());
        authenticationResult.setDetails(authenticationToken.getDetails());
        return authenticationResult;
    &#125;

    @Override
    public boolean supports(Class&lt;?&gt; aClass) &#123;
        return EmailCodeAuthenticationToken.class.isAssignableFrom(aClass);
    &#125;
&#125;</code></pre>
<p>å…¶ä¸­<code>supports</code>æ–¹æ³•æŒ‡å®šäº†æ”¯æŒå¤„ç†çš„Tokenç±»å‹ä¸º<code>EmailCodeAuthenticationToken</code>ï¼Œ<code>authenticate</code>æ–¹æ³•ç”¨äºç¼–å†™å…·ä½“çš„èº«ä»½è®¤è¯é€»è¾‘ï¼Œä»<code>EmailCodeAuthenticationToken</code>ä¸­å–å‡ºé‚®ç®±ä¿¡æ¯ï¼Œå¹¶è°ƒç”¨<code>UserDeatilService</code>æ–¹æ³•çš„<code>loadUserByUsername</code>æ–¹æ³•ï¼Œé€šè¿‡é‚®ç®±æŸ¥è¯¢ç”¨æˆ·ï¼Œå¦‚æœå­˜åœ¨è¯¥ç”¨æˆ·åˆ™è®¤è¯æˆåŠŸï¼Œé€šè¿‡åæ¥ç€è°ƒç”¨<code>EmailCodeAuthenticationToken</code>çš„æ„é€ æ–¹æ³•<code>EmailCodeAuthenticationToken(Object principal, Collection&lt;? extends GrantedAuthority&gt; authorities)</code>æ„é€ ä¸€ä¸ªè®¤è¯é€šè¿‡çš„Tokenï¼ŒåŒ…å«äº†ç”¨æˆ·ä¿¡æ¯å’Œç”¨æˆ·æƒé™ã€‚</p>
<p>å®Œæˆé‚®ç®±å­˜åœ¨æ€§æ ¡éªŒä¹‹åï¼Œæˆ‘ä»¬éœ€è¦æ ¡éªŒéªŒè¯ç çš„æ­£ç¡®æ€§ï¼Œå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨<code>EmailCodeFilter</code>ï¼Œç»§æ‰¿ä¸€æ¬¡æ€§è¿‡æ»¤å™¨<code>OncePerRequestFilter</code>ï¼š</p>
<pre><code class="java">@Component
public class EmailCodeFilter extends OncePerRequestFilter &#123;
    @Autowired
    private AuthenticationFailureHandler authenticationFailureHandler;
    @Autowired
    private RedisCodeService redisCodeService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException &#123;
        if (StringUtils.equalsIgnoreCase(&quot;/login/email&quot;, request.getRequestURI()) &amp;&amp; StringUtils.equalsIgnoreCase(&quot;post&quot;, request.getMethod())) &#123;
            try &#123;
                validateCode(new ServletWebRequest(request));
            &#125; catch (Exception e) &#123;
                authenticationFailureHandler.onAuthenticationFailure(request, response, new AuthenticationServiceException(e.getMessage()));
                return;
            &#125;
        &#125;
        filterChain.doFilter(request, response);
    &#125;

    private void validateCode(ServletWebRequest request) throws Exception &#123;
        String codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(), &quot;code&quot;);
        String emailInRequest = ServletRequestUtils.getRequiredStringParameter(request.getRequest(), &quot;email&quot;);
        if (StringUtils.isBlank(codeInRequest))
            throw new Exception(&quot;The verification code cannot be null&quot;);
        String codeInRedis = redisCodeService.get(request, emailInRequest);
        if (codeInRedis == null)
            throw new Exception(&quot;No verification code was found for email &quot; + emailInRequest);
        if (!StringUtils.equals(codeInRequest, codeInRedis))
            throw new Exception(&quot;The verification code is wrong&quot;);
        redisCodeService.remove(request, emailInRequest);
    &#125;
&#125;</code></pre>
<p>ä¸»è¦æ–¹æ³•ä¸º<code>doFilterInternal</code>ï¼Œæˆ‘ä»¬åˆ¤æ–­äº†è¯·æ±‚è·¯å¾„æ˜¯å¦ä¸º<code>/login/email</code>ä»¥åŠè¯·æ±‚æ–¹æ³•æ˜¯å¦ä¸º<code>POST</code>ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡ŒéªŒè¯ç æ ¡éªŒé€»è¾‘ï¼Œå¦åˆ™ç›´æ¥æ‰§è¡Œ<code>filterChain.doFilter</code>è®©ä»£ç å‘ä¸‹æ‰§è¡Œã€‚åœ¨æ ¡éªŒéªŒè¯ç çš„<code>validateCode</code>æ–¹æ³•ï¼Œå°†è¯·æ±‚å‚æ•°ä¸­çš„éªŒè¯ç ä¸Redisä¸­çš„éªŒè¯ç è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæ•è·åˆ°å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨Spring Securityçš„æ ¡éªŒå¤±è´¥å¤„ç†å™¨<code>AuthenticationFailureHandler</code>è¿›è¡Œå¤„ç†ã€‚</p>
<p>åœ¨å®šä¹‰å®Œæ‰€æœ‰çš„ç»„ä»¶åï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€äº›é…ç½®ï¼Œå°†è¿™äº›ç»„ä»¶ç»„åˆèµ·æ¥å½¢æˆå’Œä¸Šé¢æµç¨‹å›¾å¯¹åº”çš„æµç¨‹ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ªé…ç½®ç±»<code>EmailCodeAuthenticationConfig</code>ï¼š</p>
<pre><code class="java">@Component
public class EmailCodeAuthenticationConfig extends SecurityConfigurerAdapter&lt;DefaultSecurityFilterChain, HttpSecurity&gt; &#123;
    @Autowired
    private AuthenticationSuccessHandler authenticationSuccessHandler;
    @Autowired
    private AuthenticationFailureHandler authenticationFailureHandler;
    @Qualifier(&quot;emailUserDetailService&quot;)
    @Autowired
    private UserDetailsService userDetailsService;

    @Override
    public void configure(HttpSecurity httpSecurity) throws Exception &#123;
        EmailCodeAuthenticationFilter emailCodeAuthenticationFilter = new EmailCodeAuthenticationFilter();
        emailCodeAuthenticationFilter.setAuthenticationManager(httpSecurity.getSharedObject(AuthenticationManager.class));
        emailCodeAuthenticationFilter.setAuthenticationSuccessHandler(authenticationSuccessHandler);
        emailCodeAuthenticationFilter.setAuthenticationFailureHandler(authenticationFailureHandler);

        EmailCodeAuthenticationProvider emailCodeAuthenticationProvider = new EmailCodeAuthenticationProvider();
        emailCodeAuthenticationProvider.setUserDetailsService(userDetailsService);

        httpSecurity.authenticationProvider(emailCodeAuthenticationProvider)
                .addFilterAfter(emailCodeAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
    &#125;
&#125;</code></pre>
<p>ç¬¬ä¸€æ­¥éœ€è¦é…ç½®<code>EmailCodeAuthenticationFilter</code>ï¼Œåˆ†åˆ«è®¾ç½®<code>AuthenticationManager</code>ã€<code>AuthenticationSuccessHandler</code>å’Œ<code>AuthenticationFailureHandler</code>è¿™ä¸‰ä¸ªå±æ€§ï¼Œéƒ½æ˜¯æ¥è‡ªå®ƒæ‰€ç»§æ‰¿çš„<code>AbstractAuthenticationProcessingFilter</code>ç±»ä¸­ã€‚ç¬¬äºŒæ­¥é…ç½®<code>EmailCodeAuthenticationProvider</code>ï¼Œè¿™ä¸€æ­¥åªéœ€è¦æŠŠè‡ªå®šä¹‰çš„<code>EmailUserDetailService</code>æ³¨å…¥è¿›æ¥å³å¯ã€‚ç¬¬ä¸‰æ­¥è°ƒç”¨<code>HttpSecurity</code>çš„<code>authenticationProvider</code>æ–¹æ³•æŒ‡å®š<code>AuthenticationProvider</code>ä¸º<code>EmailCodeAuthenticationProvider</code>ï¼Œå¹¶å°†<code>EmailCodeAuthenticationFilter</code>è¿‡æ»¤å™¨æ·»åŠ åˆ°<code>UsernamePasswordAuthenticationFilter</code>åé¢ã€‚</p>
<p>è‡³æ­¤æˆ‘ä»¬å·²ç»å°†é‚®ä»¶éªŒè¯ç çš„å„ä¸ªç»„ä»¶ç»„åˆèµ·æ¥äº†ï¼Œæœ€ä¼šä¸€æ­¥éœ€è¦åšçš„å°±æ˜¯é…ç½®é‚®ä»¶éªŒè¯ç è¿‡æ»¤å™¨ï¼Œå¹¶ä¸”å°†é‚®ä»¶éªŒè¯ç è®¤è¯æµç¨‹åŠ å…¥åˆ°Spring Securityä¸­ï¼Œåœ¨èµ„æºæœåŠ¡å™¨çš„<code>configure</code>æ–¹æ³•ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p>
<pre><code class="java">@Configuration
@EnableResourceServer
public class ResourceServerConfig extends ResourceServerConfigurerAdapter &#123;
    @Autowired
    private MyAuthenticationSuccessHandler authenticationSuccessHandler;
    @Autowired
    private MyAuthenticationFailureHandler authenticationFailureHandler;
    @Autowired
    private EmailCodeFilter emailCodeFilter;
    @Autowired
    private EmailCodeAuthenticationConfig emailCodeAuthenticationConfig;

    @Override
    public void configure(HttpSecurity http) throws Exception &#123;
        http.addFilterBefore(emailCodeFilter, UsernamePasswordAuthenticationFilter.class) // æ·»åŠ é‚®ä»¶éªŒè¯ç è¿‡æ»¤å™¨
                .formLogin()                  // è¡¨å•ç™»å½•
                .loginProcessingUrl(&quot;/login&quot;) // å¤„ç†è¡¨å•ç™»å½•URL
                .successHandler(authenticationSuccessHandler) // å¤„ç†ç™»å½•æˆåŠŸ
                .failureHandler(authenticationFailureHandler) // å¤„ç†ç™»å½•å¤±è´¥
        .and()
                .authorizeRequests()                    // æˆæƒé…ç½®
                .antMatchers(&quot;/code/email&quot;).permitAll() // éªŒè¯ç æ¥å£æ— éœ€è®¤è¯
                .anyRequest().authenticated()           // æ‰€æœ‰æ¥å£éƒ½éœ€è¦è®¤è¯
        .and()
                .csrf().disable() // å…³é—­CSRFä¿æŠ¤
        .apply(emailCodeAuthenticationConfig);
    &#125;
&#125;</code></pre>
<p>è‡³æ­¤ï¼Œcodingç»“æŸã€‚</p>
<p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®éªŒè¯ç æ¥å£ï¼š<a href="http://localhost:8080/code/email?email=parakovo@gmail.com">http://localhost:8080/code/email?email=parakovo@gmail.com</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603004716986.png" class="" title="image-20210603004716986">

<p>æ§åˆ¶å°æ—¥å¿—æ‰“å°ï¼š</p>
<pre><code class="java">2021-06-03 00:46:09.955  INFO 9756 --- [nio-8080-exec-3] top.parak.controller.ValidateController  : ç”¨æˆ·ä½¿ç”¨é‚®ç®±[parakovo@gmail.com]ç™»å½•ï¼ŒéªŒè¯ç ä¸ºï¼š[196267]</code></pre>
<p>ç„¶åè¯·æ±‚æˆæƒç æ¥å£ï¼š<a href="http://localhost:8080/login/email?email=parakovo@gmail.com&amp;code=196267">http://localhost:8080/login/email?email=parakovo@gmail.com&amp;code=196267</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603005013617.png" class="" title="image-20210603005013617">

<p>æœ€åæµ‹è¯•è®¿é—®èµ„æºï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603005142695.png" class="" title="image-20210603005142695">



<h2 id="8-Spring-Security-OAuth2-Config"><a href="#8-Spring-Security-OAuth2-Config" class="headerlink" title="8. Spring Security OAuth2 Config"></a>8. Spring Security OAuth2 Config</h2><p>ğŸ“–æ¦‚è¿°</p>
<p>Spring Securityå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰ä»¤ç‰Œé…ç½®ï¼Œæ¯”å¦‚ä¸åŒçš„client_idå¯¹åº”ä¸åŒçš„ä»¤ç‰Œï¼Œä»¤ç‰Œçš„æœ‰æ•ˆæ—¶é—´ã€ä»¤ç‰Œçš„å­˜å‚¨ç­–ç•¥ç­‰ï¼›æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨JWTæ¥æ›¿æ¢é»˜è®¤çš„ä»¤ç‰Œã€‚</p>
<h3 id="8-1-è‡ªå®šä¹‰ä»¤ç‰Œé…ç½®"><a href="#8-1-è‡ªå®šä¹‰ä»¤ç‰Œé…ç½®" class="headerlink" title="8.1 è‡ªå®šä¹‰ä»¤ç‰Œé…ç½®"></a>8.1 è‡ªå®šä¹‰ä»¤ç‰Œé…ç½®</h3><p>æ–°å»ºé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
    &lt;artifactId&gt;lombok&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
    &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
<p>åˆ›å»ºé…ç½®ç±»<code>SecurityConfig</code>ï¼Œç”¨äºæ³¨å†Œå¸¸ç”¨çš„beanï¼š</p>
<pre><code class="java">@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;

    @Bean
    public PasswordEncoder passwordEncoder() &#123;
        return new BCryptPasswordEncoder();
    &#125;

    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception &#123;
        return super.authenticationManagerBean();
    &#125;
&#125;</code></pre>
<p>å®šä¹‰<code>NameUserDetailService</code>å®ç°<code>UserDetailsService</code>ï¼Œå®ç°è‡ªå·±çš„ç”¨æˆ·åå¯†ç è®¤è¯é€»è¾‘ï¼š</p>
<pre><code class="java">@Configuration
public class NameUserDetailService implements UserDetailsService &#123;
    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;
        // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢é€»è¾‘ï¼›æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
        String password = passwordEncoder.encode(&quot;KAG1823&quot;);
        List&lt;GrantedAuthority&gt; authorityList = new ArrayList&lt;&gt;();
        // Khighnessä¸ºç®¡ç†å‘˜ï¼Œå…¶ä»–éƒ½ä¸ºè®¿å®¢
        if (StringUtils.equalsIgnoreCase(&quot;Khighness&quot;, username)) &#123;
            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;admin&quot;);
        &#125; else &#123;
            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;guest&quot;);
        &#125;
        return new User(username, password, authorityList);
    &#125;
&#125;</code></pre>
<p>ç„¶ååˆ›å»ºæˆæƒæœåŠ¡å™¨<code>AuthorizationServerConfig</code>ï¼Œæ³¨æ„åœ¨æ–°ç‰ˆæœ¬çš„spring-cloud-starter-oauth2ä¸­ï¼ŒæŒ‡å®šclient_secretéœ€è¦è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œè¿™é‡Œä¾ç„¶ä½¿ç”¨BCRåŠ å¯†ï¼š</p>
<pre><code class="java">@Configuration
@EnableAuthorizationServer
public class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter &#123;
    @Autowired
    private AuthenticationManager authenticationManager;
    @Qualifier(&quot;nameUserDetailService&quot;)
    @Autowired
    private UserDetailsService userDetailsService;
    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;
        endpoints.authenticationManager(authenticationManager)
                .userDetailsService(userDetailsService);
    &#125;

    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123;
        clients.inMemory()
                .withClient(&quot;k&quot;)
                .secret(passwordEncoder.encode(&quot;parak&quot;))
                .accessTokenValiditySeconds(3600)   // 1h
                .refreshTokenValiditySeconds(86400) // 1d
                .scopes(&quot;all&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)
                .authorizedGrantTypes(&quot;password&quot;, &quot;refresh_token&quot;)
            .and()
                .withClient(&quot;z&quot;)
                .secret(passwordEncoder.encode(&quot;paraz&quot;))
                .accessTokenValiditySeconds(7200)   // 2h
        ;
    &#125;
&#125;</code></pre>
<p>åœ¨é‡å†™çš„<code>configure(AuthorizationServerEndpointsConfigurer endpoints)</code>æ–¹æ³•ä¸­ï¼ŒæŒ‡å®š<code>AuthenticationManager</code>å’Œ<code>UserDetailsService</code>ã€‚</p>
<p>åœ¨é‡å†™çš„<code>configure(ClientDetailsServiceConfigurer clients)</code>æ–¹æ³•ä¸­ï¼Œä¸»è¦é…ç½®ï¼š</p>
<ol>
<li>å®šä¹‰ä¸¤ä¸ªclient_idï¼Œkä¸zï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ä¸åŒçš„client_idæ¥è·å–ä¸åŒçš„ä»¤ç‰Œï¼›</li>
<li>kçš„ä»¤ç‰Œæœ‰æ•ˆæ—¶é—´ä¸º3600ç§’ï¼ˆ1å°æ—¶ï¼‰ï¼Œzçš„ä»¤ç‰Œæœ‰æ•ˆæ—¶é—´ä¸º7200ç§’ï¼ˆ2å°æ—¶ï¼‰ï¼›</li>
<li>kçš„refresh_tokençš„æœ‰æ•ˆæ—¶é—´ä¸º86400ç§’ï¼ˆ1å¤©ï¼‰ï¼Œå³10å¤©å†…éƒ½å¯ä»¥é€šè¿‡refresh_tokenæ¢å–æ–°çš„ä»¤ç‰Œï¼›</li>
<li>åœ¨è·å–kçš„ä»¤ç‰Œæ—¶ï¼Œscopeåªèƒ½ä¸ºallã€aã€bã€cä¸­çš„æŸä¸ªå€¼ï¼Œå¦åˆ™å°†è·å–å¤±è´¥ï¼›</li>
<li>åœ¨è·å–kçš„ä»¤ç‰Œæ—¶ï¼Œåªèƒ½é€šè¿‡å¯†ç æ¨¡å¼ï¼ˆpasswordï¼‰å’Œåˆ·æ–°æ–¹å¼ï¼ˆrefresh_tokenï¼‰æ¥è·å–ä»¤ç‰Œã€‚</li>
</ol>
<p>æ³¨æ„ï¼Œè¿˜éœ€è¦ä¿®æ”¹ç™»å½•æˆåŠŸçš„å¤„ç†å™¨ï¼Œç”±äºclient_serectåŠ å¯†äº†ï¼Œæ‰€æœ‰åˆ¤æ–­é€»è¾‘ä¹Ÿéœ€è¦è°ƒæ•´ï¼š</p>
<pre><code class="java">@Slf4j
@Component
public class MyAuthenticationSuccessHandler implements AuthenticationSuccessHandler &#123;
    ...
    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException &#123;
        ...
        // 3. æ ¡éªŒClientIdå’ŒClientSecretçš„æ­£ç¡®æ€§
        if (clientDetails == null) &#123;
            throw new UnapprovedClientAuthenticationException(&quot;No client details was found for clientId &quot; + clientId);
        &#125; else if (!passwordEncoder.matches(clientSecret, clientDetails.getClientSecret())) &#123; // è¿™é‡Œè¿›è¡ŒåŠ å¯†åˆ¤æ–­
            throw new UnapprovedClientAuthenticationException(&quot;The client secret is invalid&quot;);
        &#125; 
        ...
    &#125;
&#125;</code></pre>
<p>æœ€åï¼Œåˆ›å»ºèµ„æºæœåŠ¡å™¨<code>ResourceServerConfig</code>ï¼Œå¤„ç†ç™»å½•å¤±è´¥çš„é€»è¾‘ä¸å˜ï¼š</p>
<pre><code class="java">@Configuration
@EnableResourceServer
public class ResourceServerConfig extends ResourceServerConfigurerAdapter &#123;
    @Autowired
    private MyAuthenticationSuccessHandler authenticationSuccessHandler;
    @Autowired
    private MyAuthenticationFailureHandler authenticationFailureHandler;

    @Override
    public void configure(HttpSecurity http) throws Exception &#123;
        http.formLogin()                      // è¡¨å•ç™»å½•
                .loginProcessingUrl(&quot;/login&quot;) // å¤„ç†è¡¨å•ç™»å½•URL
                .successHandler(authenticationSuccessHandler) // å¤„ç†ç™»å½•æˆåŠŸ
                .failureHandler(authenticationFailureHandler) // å¤„ç†ç™»å½•å¤±è´¥
        .and()
                .authorizeRequests()                                // æˆæƒé…ç½®
                .anyRequest().authenticated()                       // æ‰€æœ‰æ¥å£éƒ½éœ€è¦è®¤è¯
        .and()
                .csrf().disable() // å…³é—­CSRFä¿æŠ¤
        ;
    &#125;
&#125;</code></pre>
<p>å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨å¯†ç æ¨¡å¼è·å–ä»¤ç‰Œï¼Œæ³¨æ„è¯·æ±‚å¤´ä¸­æ·»åŠ <code>Basic Base54(k:parak)</code>ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603162437693.png" class="" title="image-20210603162437693">

<p>å¯ä»¥çœ‹åˆ°<code>expires_in</code>æ˜¯æˆ‘ä»¬å®šä¹‰çš„3600å¦™ã€‚</p>
<p>æµ‹è¯•ä¸€ä¸‹å°†scopeæŒ‡å®šä¸ºkä¼šæœ‰ä»€ä¹ˆç»“æœï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603162742562.png" class="" title="image-20210603162742562">



<h3 id="8-2-è‡ªå®šä¹‰å­˜å‚¨redis"><a href="#8-2-è‡ªå®šä¹‰å­˜å‚¨redis" class="headerlink" title="8.2 è‡ªå®šä¹‰å­˜å‚¨redis"></a>8.2 è‡ªå®šä¹‰å­˜å‚¨redis</h3><p>é»˜è®¤ä»¤ç‰Œæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä¿å­˜åˆ°ç¬¬ä¸‰æ–¹å­˜å‚¨ä¸­ï¼Œæ¯”å¦‚redisã€‚</p>
<p>é¦–å…ˆåˆ›å»º<code>TokenStoreConfig</code>ï¼š</p>
<pre><code class="java">@Configuration
public class TokenStoreConfig &#123;
    @Autowired
    private RedisConnectionFactory redisConnectionFactory;

    @Bean
    public TokenStore redisTokenStore() &#123;
        return new RedisTokenStore(redisConnectionFactory);
    &#125;
&#125;</code></pre>
<p>ç„¶ååœ¨è®¤è¯æœåŠ¡å™¨ä¸­è¿™ä¸ªæŒ‡å®šè¯¥å­˜å‚¨ç­–ç•¥ï¼š</p>
<pre><code class="java">@Qualifier(&quot;redisTokenStore&quot;)
@Autowired
private TokenStore redisTokenStore;

@Override
public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;
    endpoints.authenticationManager(authenticationManager)
        .userDetailsService(userDetailsService)
        .tokenStore(redisTokenStore);
&#125;</code></pre>
<p>é‡å¯é¡¹ç›®è·å–ä»¤ç‰Œï¼ŒæŸ¥çœ‹redisä¸­æ˜¯å¦å­˜å‚¨äº†ä»¤ç‰Œç›¸å…³ä¿¡æ¯ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603164059407.png" class="" title="image-20210603164059407">

<p>å¯ä»¥çœ‹åˆ°ï¼Œä»¤ç‰Œä¿¡æ¯å·²ç»å­˜å‚¨åœ¨redisä¸­äº†ã€‚</p>
<h3 id="8-2-è‡ªå®šä¹‰ä»¤ç‰Œjwt"><a href="#8-2-è‡ªå®šä¹‰ä»¤ç‰Œjwt" class="headerlink" title="8.2 è‡ªå®šä¹‰ä»¤ç‰Œjwt"></a>8.2 è‡ªå®šä¹‰ä»¤ç‰Œjwt</h3><p>é»˜è®¤ä»¤ç‰Œåº”è¯¥å¾ˆå®¹æ˜“çœ‹å¾—å‡ºæ¥ï¼Œä½¿ç”¨UUIDç”Ÿäº§ï¼ŒJWTæ›¿æ¢é»˜è®¤ä»¤ç‰Œåªéœ€è¦æŒ‡å®š<code>TokenStore</code>ä¸º<code>JwtTokenStore</code>å³å¯ã€‚</p>
<p>åˆ›å»ºä¸€ä¸ª<code>JWTokenConfig</code>é…ç½®ç±»ï¼š</p>
<pre><code class="java">@Configuration
public class JWTokenConfig &#123;
    @Bean
    public TokenStore jwtTokenStore() &#123;
        return new JwtTokenStore(jwtAccessTokenConverter());
    &#125;

    @Bean
    public JwtAccessTokenConverter jwtAccessTokenConverter() &#123;
        JwtAccessTokenConverter accessTokenConverter = new JwtAccessTokenConverter();
        accessTokenConverter.setSigningKey(&quot;parak.top&quot;); // ç­¾åå¯†é’¥
        return accessTokenConverter;
    &#125;
&#125;</code></pre>
<p>åœ¨è®¤è¯æœåŠ¡å™¨ä¸­æŒ‡å®šï¼š</p>
<pre><code class="java">@Qualifier(&quot;jwtTokenStore&quot;)
@Autowired
private TokenStore jwtTokenStore;
@Autowired
private JwtAccessTokenConverter jwtAccessTokenConverter;

@Override
public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;
    endpoints.authenticationManager(authenticationManager)
        .userDetailsService(userDetailsService)
        .tokenStore(jwtTokenStore)
        .accessTokenConverter(jwtAccessTokenConverter);
&#125;</code></pre>
<p>æœ€ååˆ›å»ºä¸€ä¸ªRESTæ¥å£ï¼š</p>
<pre><code class="java">@RestController
public class IndexController &#123;

    @GetMapping(&quot;/index&quot;)
    public Object index(@AuthenticationPrincipal Authentication authentication) &#123;
        return authentication;
    &#125;
&#125;</code></pre>
<p>é‡å¯æœåŠ¡å™¨ï¼Œè·å–ä»¤ç‰Œï¼š</p>
<pre><code class="json">&#123;
    &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MjI3MTQyNTcsInVzZXJfbmFtZSI6IktoaWdobmVzcyIsImF1dGhvcml0aWVzIjpbImd1ZXN0Il0sImp0aSI6IjU1MWE2OGRkLTczMmItNDMxNi04ZjE5LTNhNTQ5NTk3NmQ0NCIsImNsaWVudF9pZCI6ImsiLCJzY29wZSI6WyJhbGwiXX0.WUstg6FB2SO3dzuRgI2igpGfP4oZqLPUnXFwuc8BU8E&quot;,
    &quot;token_type&quot;: &quot;bearer&quot;,
    &quot;refresh_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJLaGlnaG5lc3MiLCJzY29wZSI6WyJhbGwiXSwiYXRpIjoiNTUxYTY4ZGQtNzMyYi00MzE2LThmMTktM2E1NDk1OTc2ZDQ0IiwiZXhwIjoxNjIyNzk3MDU3LCJhdXRob3JpdGllcyI6WyJndWVzdCJdLCJqdGkiOiJlMDM4ZjJjMi1hYjk2LTRmODgtYWVlMy05ZmQyNjAwNGE0ZWUiLCJjbGllbnRfaWQiOiJrIn0.3ox9jwGs8jQzwItcPDJ5gv4G6pusYLTca8GHJJUjP5w&quot;,
    &quot;expires_in&quot;: 3599,
    &quot;scope&quot;: &quot;all&quot;,
    &quot;jti&quot;: &quot;551a68dd-732b-4316-8f19-3a5495976d44&quot;
&#125;</code></pre>
<p>å°†<code>access_token</code>ä¸­çš„å†…å®¹å¤åˆ¶åˆ°<a href="https://jwt.io/">jwtå®˜ç½‘</a>è¿›è¡Œè§£æï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603173223840.png" class="" title="image-20210603173223840">

<p>ç„¶åæˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ª<code>access_token</code>è¯·æ±‚èµ„æºï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603173337645.png" class="" title="image-20210603173337645">

<p>æ­¤å¤–æˆ‘ä»¬è¿˜å¯ä»¥åœ¨jwtçš„åŸºç¡€ä¸Šè¿›è¡Œæ‹“å±•ï¼Œæ¯”å¦‚å¢åŠ ä¸€äº›è´Ÿè½½ï¼ˆåŒ…å«ä¸æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å®šä¹‰<code>JWTOkenEnhancer</code>å®ç°<code>TokenEnhancer</code>ï¼ˆTokenå¢å¼ºå™¨ï¼‰ï¼š</p>
<pre><code class="java">public class JWTokenEnhancer implements TokenEnhancer &#123;
    @Override
    public OAuth2AccessToken enhance(OAuth2AccessToken oAuth2AccessToken, OAuth2Authentication oAuth2Authentication) &#123;
        Map&lt;String, Object&gt; info = new HashMap&lt;&gt;();
        info.put(&quot;message&quot;, &quot;Hello Khighness&quot;);
        ((DefaultOAuth2AccessToken) oAuth2AccessToken).setAdditionalInformation(info);
        return oAuth2AccessToken;
    &#125;
&#125;</code></pre>
<p>æˆ‘ä»¬åœ¨Tokenä¸­æ·»åŠ äº†ä¿¡æ¯<code>message: Hello Khighness</code>ï¼Œç„¶ååœ¨<code>JWTokenConfig</code>ä¸­æ³¨å†Œè¯¥beanï¼š</p>
<pre><code class="java">@Bean
public TokenEnhancer tokenEnhancer() &#123;
    return new JWTokenEnhancer();
&#125;</code></pre>
<p>æœ€ååœ¨è®¤è¯æœåŠ¡å™¨ä¸­é…ç½®Tokenå¢å¼ºå™¨ï¼š</p>
<pre><code class="java">@Qualifier(&quot;jwtTokenStore&quot;)
@Autowired
private TokenStore jwtTokenStore;
@Autowired
private JwtAccessTokenConverter jwtAccessTokenConverter;
@Qualifier(&quot;jwTokenEnhancer&quot;)
@Autowired
private TokenEnhancer tokenEnhancer;

@Override
public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;
    TokenEnhancerChain tokenEnhancerChain = new TokenEnhancerChain();
    List&lt;TokenEnhancer&gt; enhancerList = new ArrayList&lt;&gt;();
    enhancerList.add(tokenEnhancer);
    enhancerList.add(jwtAccessTokenConverter);
    tokenEnhancerChain.setTokenEnhancers(enhancerList);
    endpoints.authenticationManager(authenticationManager)
        .userDetailsService(userDetailsService)
        .tokenEnhancer(tokenEnhancerChain);
&#125;</code></pre>
<p>é‡å¯é¡¹ç›®ï¼Œå†æ¬¡è·å–ä»¤ç‰Œï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="json">&#123;
    &quot;access_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJLaGlnaG5lc3MiLCJzY29wZSI6WyJhbGwiXSwiZXhwIjoxNjIyNzE3OTQ2LCJtZXNzYWdlIjoiSGVsbG8gS2hpZ2huZXNzIiwiYXV0aG9yaXRpZXMiOlsiYWRtaW4iXSwianRpIjoiYzQxYzI3ODItNDg5OS00ZDNjLTlmM2YtYjQ3YzNlNjNjYzU3IiwiY2xpZW50X2lkIjoiayJ9.TCrZOLP7cUFW1EjLgmk9xl75uv48bU3EUaNCn87ts1s&quot;,
    &quot;token_type&quot;: &quot;bearer&quot;,
    &quot;refresh_token&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJLaGlnaG5lc3MiLCJzY29wZSI6WyJhbGwiXSwiYXRpIjoiYzQxYzI3ODItNDg5OS00ZDNjLTlmM2YtYjQ3YzNlNjNjYzU3IiwiZXhwIjoxNjIyODAwNzQ2LCJtZXNzYWdlIjoiSGVsbG8gS2hpZ2huZXNzIiwiYXV0aG9yaXRpZXMiOlsiYWRtaW4iXSwianRpIjoiOTU3MTc1MDgtZGRkYS00MzNhLWEzNjktMzc0MjAwYzQxNjQxIiwiY2xpZW50X2lkIjoiayJ9.2dSVNonOZRXtyc0YhQ-xk1QwYnrj16JzDBzhASiOD9E&quot;,
    &quot;expires_in&quot;: 3599,
    &quot;scope&quot;: &quot;all&quot;,
    &quot;message&quot;: &quot;Hello Khighness&quot;,
    &quot;jti&quot;: &quot;c41c2782-4899-4d3c-9f3f-b47c3e63cc57&quot;
&#125;</code></pre>
<p>å¯ä»¥çœ‹åˆ°è¿”å›çš„jsonä¸­åŒ…å«äº†æˆ‘ä»¬æ·»åŠ çš„messageã€‚</p>
<p>ç„¶åæˆ‘ä»¬ä¿®æ”¹RESTæ¥å£ï¼Œå°†è¿”å›ç»“æœæ”¹ä¸ºJWTè§£æç»“æœï¼š</p>
<pre><code class="java">@GetMapping(&quot;/index&quot;)
public Object index(@AuthenticationPrincipal Authentication authentication, HttpServletRequest request) &#123;
    String authorization = request.getHeader(&quot;Authorization&quot;);
    String token = StringUtils.substringAfter(authorization, &quot;bearer&quot;);
    return Jwts.parser().setSigningKey(&quot;parak.top&quot;.getBytes(StandardCharsets.UTF_8)).parseClaimsJws(token).getBody();
&#125;</code></pre>
<p>å…¶ä¸­<code>signkey</code>éœ€è¦å’Œ<code>JwtAccessTokenConverter</code>ä¸­æŒ‡å®šçš„ç­¾åå¯†é’¥ä¸€ç›´ã€‚</p>
<p>é‡å¯é¡¹ç›®ï¼Œè·å–ä»¤ç‰Œè®¿é—®<code>/index</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="java">&#123;
    &quot;user_name&quot;: &quot;Khighness&quot;,
    &quot;scope&quot;: [
        &quot;all&quot;
    ],
    &quot;exp&quot;: 1622718508,
    &quot;message&quot;: &quot;Hello Khighness&quot;,
    &quot;authorities&quot;: [
        &quot;admin&quot;
    ],
    &quot;jti&quot;: &quot;a0653a55-5b63-4b8e-a95c-c9b81f3a575c&quot;,
    &quot;client_id&quot;: &quot;k&quot;
&#125;</code></pre>
<h3 id="8-4-ä»¤ç‰Œåˆ·æ–°refresh-token"><a href="#8-4-ä»¤ç‰Œåˆ·æ–°refresh-token" class="headerlink" title="8.4 ä»¤ç‰Œåˆ·æ–°refresh_token"></a>8.4 ä»¤ç‰Œåˆ·æ–°refresh_token</h3><p><code>refresh_token</code>ï¼Œæ˜¯å››ç§æ ‡å‡†çš„OAuth2äº†ä»¤ç‰Œè·å–æ–¹å¼ä¹‹å¤–ï¼ŒSpring Security OAuth2å†…éƒ¨å®ç°çš„ä¸€ä¸­æ‹“å±•çš„è·å–ä»¤ç‰Œçš„æ–¹å¼ã€‚</p>
<p>å‡è®¾ç°åœ¨<code>access_token</code>è¿‡æœŸäº†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>refresh_token</code>å»æ¢å–æ–°çš„ä»¤ç‰Œï¼š</p>
<p>ä½¿ç”¨postmanå‘é€è¯·æ±‚ï¼Œéœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œä»¤ç‰Œè·å–æ–¹å¼<code>grant_type</code>æŒ‡å®šä¸º<code>refresh_token</code>ï¼Œæ›´æ–°ä»¤ç‰Œ<code>refresh_token</code>è®¾ç½®ä¸ºä¸Šä¸€æ¬¡æœåŠ¡å™¨è¿”å›çš„<code>refresh_token</code>ã€‚å¦å¤–è¯·æ±‚å¤´ä¾ç„¶å¸¦ä¸Š<code>Basic BASE64(client_id:client_secret)</code>ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603182046137.png" class="" title="image-20210603182046137">



<h2 id="9-Spring-Security-OAuth2-SSO"><a href="#9-Spring-Security-OAuth2-SSO" class="headerlink" title="9. Spring Security OAuth2 SSO"></a>9. Spring Security OAuth2 SSO</h2><p>ğŸ“–æ¦‚è¿°</p>
<p>SSO(Single Sign On)ï¼Œå³å•ç‚¹ç™»å½•ï¼Œæ•ˆæœæ˜¯å¤šä¸ªç³»ç»Ÿé—´ï¼Œåªè¦ç™»å½•äº†å…¶ä¸­ä¸€ä¸ªç³»ç»Ÿï¼Œå…¶ä»–ç³»ç»Ÿä¹Ÿè‡ªåŠ¨ç™»å½•ã€‚</p>
<h3 id="9-1-æ¡†æ¶æ­å»º"><a href="#9-1-æ¡†æ¶æ­å»º" class="headerlink" title="9.1 æ¡†æ¶æ­å»º"></a>9.1 æ¡†æ¶æ­å»º</h3><p>æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªmavenå¤šæ¨¡å—é¡¹ç›®ï¼ŒåŒ…å«è®¤è¯æœåŠ¡å™¨å’Œä¸¤ä¸ªå®¢æˆ·ç«¯ã€‚</p>
<pre><code>sso
â”œâ”€â”€ sso-server   è®¤è¯æœåŠ¡å™¨
â”œâ”€â”€ sso-app-one  å®¢æˆ·ç«¯1
â””â”€â”€ sso-app-two  å®¢æˆ·ç«¯2</code></pre>
<p>åˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œå¼•å…¥ä¾èµ–ï¼š</p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-security&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
        &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
<p>ç„¶ååˆ›å»ºä¸‰ä¸ªmoduleï¼š</p>
<ul>
<li><code>sso-server</code>ï¼ˆ8080ï¼‰</li>
<li><code>sso-app-one</code>ï¼ˆ8081ï¼‰</li>
<li><code>sso-app-two</code>ï¼ˆ8082ï¼‰</li>
</ul>
<h3 id="9-2-è®¤è¯æœåŠ¡å™¨"><a href="#9-2-è®¤è¯æœåŠ¡å™¨" class="headerlink" title="9.2 è®¤è¯æœåŠ¡å™¨"></a>9.2 è®¤è¯æœåŠ¡å™¨</h3><p>è®¤è¯æœåŠ¡å™¨çš„ä½œç”¨å°±æ˜¯ä½œä¸ºç»Ÿä¸€ä»¤ç‰Œå‘æ”¾å¹¶æ ¡éªŒã€‚</p>
<p>é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="yaml">server:
  port: 8080
  servlet:
    context-path: /server</code></pre>
<p>æ–°å»ºä¸€ä¸ªSpring Securityé…ç½®ç±»<code>WebSecurityConfig</code>ï¼Œç»§æ‰¿<code>WebSecurityConfigurerAdpter</code>ï¼š</p>
<pre><code class="java">@Configuration
public class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123;

    @Bean
    public PasswordEncoder passwordEncoder() &#123;
        return new BCryptPasswordEncoder();
    &#125;

    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.formLogin() // è¡¨å•ç™»å½•
                .and()
                .authorizeRequests().anyRequest().authenticated(); // æ‰€æœ‰è¯·æ±‚éƒ½éœ€è®¤è¯
    &#125;
&#125;</code></pre>
<p>æ¥ç€å®šä¹‰<code>UserDetailService</code>å®ç°è‡ªå®šä¹‰ç”¨æˆ·ç™»å½•é€»è¾‘ï¼š</p>
<pre><code class="java">@Configuration
public class UserDetailService implements UserDetailsService &#123;
    @Autowired
    private PasswordEncoder passwordEncoder;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;
        String password = passwordEncoder.encode(&quot;KAG1823&quot;);
        List&lt;GrantedAuthority&gt; authorityList = new ArrayList&lt;&gt;();
        if (StringUtils.equalsIgnoreCase(&quot;Khighness&quot;, username)) &#123;
            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;admin&quot;);
        &#125; else &#123;
            authorityList = AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;guest&quot;);
        &#125;
        return new User(username, password, authorityList);
    &#125;
&#125;</code></pre>
<p>æœ€ååˆ›å»º<code>SsoAuthorizationServerConfig</code>é…ç½®è®¤è¯æœåŠ¡ï¼š</p>
<pre><code class="java">@Configuration
@EnableAuthorizationServer
public class SsoAuthorizationServerConfig extends AuthorizationServerConfigurerAdapter &#123;
    @Autowired
    private PasswordEncoder passwordEncoder;
    @Autowired
    private UserDetailService userDetailService;

    @Bean
    public TokenStore jwtTokenStore() &#123;
        return new JwtTokenStore(jwtAccessTokenConverter());
    &#125;

    @Bean
    public JwtAccessTokenConverter jwtAccessTokenConverter() &#123;
        JwtAccessTokenConverter accessTokenConverter = new JwtAccessTokenConverter();
        accessTokenConverter.setSigningKey(&quot;sso.parak.top&quot;);
        return accessTokenConverter;
    &#125;

    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123;
        clients.inMemory()
                .withClient(&quot;app-one&quot;)
                .secret(passwordEncoder.encode(&quot;app-one-parak&quot;))
                .authorizedGrantTypes(&quot;authorization_code&quot;, &quot;refresh_token&quot;)
                .accessTokenValiditySeconds(3600)
                .refreshTokenValiditySeconds(864000)
                .scopes(&quot;all&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;)
                .redirectUris(&quot;http://127.0.0.1:8081/app-one/login&quot;)
            .and()
                .withClient(&quot;app-two&quot;)
                .secret(passwordEncoder.encode(&quot;app-two-parak&quot;))
                .authorizedGrantTypes(&quot;authorization_code&quot;, &quot;refresh_token&quot;)
                .accessTokenValiditySeconds(3600)
                .refreshTokenValiditySeconds(864000)
                .scopes(&quot;all&quot;, &quot;d&quot;, &quot;e&quot;, &quot;f&quot;)
                .redirectUris(&quot;http://127.0.0.1:8082/app-two/login&quot;)
        ;
    &#125;

    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;
        endpoints.userDetailsService(userDetailService)
                .tokenStore(jwtTokenStore())
                .accessTokenConverter(jwtAccessTokenConverter());
    &#125;

    @Override
    public void configure(AuthorizationServerSecurityConfigurer security) throws Exception &#123;
        security.tokenKeyAccess(&quot;isAuthenticated()&quot;); // è·å–å¯†é’¥éœ€è¦è®¤è¯
    &#125;
&#125;</code></pre>
<p>é…ç½®äº†ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œéƒ½å¯ä»¥ä½¿ç”¨æˆæƒç æ¨¡å¼æˆ–è€…ä»¤ç‰Œæ›´æ–°è·å–ä»¤ç‰Œã€‚</p>
<h3 id="9-3-å®¢æˆ·ç«¯é…ç½®"><a href="#9-3-å®¢æˆ·ç«¯é…ç½®" class="headerlink" title="9.3 å®¢æˆ·ç«¯é…ç½®"></a>9.3 å®¢æˆ·ç«¯é…ç½®</h3><p>ä¸¤ä¸ªå®¢æˆ·ç«¯çš„ä»£ç ä¸€è‡´ï¼Œæ‰€ä»¥åªä»‹ç»ä¸€ä¸ªï¼Œ<code>sso-app-one</code>ã€‚</p>
<p>å®¢æˆ·ç«¯çš„SpringBootå¯åŠ¨ç±»ä¸Šæ·»åŠ <code>@EnableOAuth2Sso</code>æ³¨è§£ï¼Œå¼€å¯SSOçš„æ”¯æŒï¼š</p>
<pre><code class="java">@EnableOAuth2Sso
@SpringBootApplication
public class SsoOneApplication &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(SsoOneApplication.class, args);
    &#125;
&#125;</code></pre>
<p>é‡ç‚¹åœ¨äºé…ç½®ï¼Œä¸¤ä¸ªå®¢æˆ·ç«¯çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="yaml"># sso-app-one
server:
  port: 8081
  servlet:
    context-path: /app-one

security:
  oauth2:
    client:
      client-id: app-one
      client-secret: app-one-parak
      user-authorization-uri: http://127.0.0.1:8080/server/oauth/authorize
      access-token-uri: http://127.0.0.1:8080/server/oauth/token
    resource:
      jwt:
        key-uri: http://127.0.0.1:8080/server/oauth/token_key

sso-app-two
server:
  port: 8082
  servlet:
    context-path: /app-two

security:
  oauth2:
    client:
      client-id: app-two
      client-secret: app-two-parak
      user-authorization-uri: http://127.0.0.1:8080/server/oauth/authorize
      access-token-uri: http://127.0.0.1:8080/server/oauth/token
    resource:
      jwt:
        key-uri: http://127.0.0.1:8080/server/oauth/token_key</code></pre>
<p><code>security.oauth2.client.client-id</code>å’Œ<code>security.oauth2.client.client-secret</code>æŒ‡å®šäº†å®¢æˆ·ç«¯idå’Œå¯†ç ï¼Œ<code>user-authorization-uri</code>æŒ‡å®šäº†è®¤è¯æœåŠ¡å™¨çš„<code>/oauth/authorize</code>æˆæƒåœ°å€ï¼Œ<code>access-token-uri</code>æŒ‡å®šäº†è®¤è¯æœåŠ¡å™¨çš„<code>/oauth/token</code>ä»¤ç‰Œå‘æ”¾åœ°å€ï¼Œ<code>jwt.key-uri</code>æŒ‡å®šäº†è®¤è¯æœåŠ¡å™¨çš„<code>/oauth/token_key</code>åœ°å€ã€‚</p>
<p>æ¥ç€åœ¨<code>resources/static</code>ä¸‹æ–°å¢ä¸€ä¸ªindex.htmlé¡µé¢ï¼Œç”¨äºè·³è½¬åˆ°å¦ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¸‹é¢æ˜¯<code>sso-app-one</code>çš„é¡µé¢ï¼š</p>
<pre><code class="html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;app-1&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;app-1&lt;/h1&gt;
    &lt;a href=&quot;http://127.0.0.1:8082/app-two/index.html&quot;&gt;go to app-2&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>æœ€åå†™ä¸€ä¸ªRESTæ¥å£<code>UserController</code>ï¼š</p>
<pre><code class="java">@RestController
public class UserController &#123;

    @GetMapping(&quot;/principal&quot;)
    public Principal principal(Principal principal) &#123;
        return principal;
    &#125;
&#125;</code></pre>
<h3 id="9-4-æµ‹è¯•æ•ˆæœ"><a href="#9-4-æµ‹è¯•æ•ˆæœ" class="headerlink" title="9.4 æµ‹è¯•æ•ˆæœ"></a>9.4 æµ‹è¯•æ•ˆæœ</h3><p>é¦–å…ˆå¯åŠ¨<code>sso-server</code>ï¼Œç„¶åå¯åŠ¨<code>sso-app-one</code>ï¼Œæœ€åå¯åŠ¨<code>sso-app-two</code>ã€‚</p>
<p>è®¿é—®ï¼š<a href="http://127.0.0.1:8081/app-one/index.html">http://127.0.0.1:8081/app-one/index.html</a></p>
<p>è·³è½¬åˆ°å¦‚ä¸‹ç•Œé¢ï¼Œè¾“å…¥ä»»æ„ç”¨æˆ·åå’Œå¯†ç KAG1823ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603205325874.png" class="" title="image-20210603205325874">

<p>ç‚¹å‡»Sign in/Enterï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603205359505.png" class="" title="image-20210603205359505">

<p>ç‚¹å‡»Authorizeï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603205445140.png" class="" title="image-20210603205445140">

<p>è¿™æ—¶å€™app-oneç™»å½•æˆåŠŸï¼Œç‚¹å‡»go to app-2ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603205511526.png" class="" title="image-20210603205511526">

<p>ç‚¹å‡»Authorizeï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603205554118.png" class="" title="image-20210603205554118">

<p>å¯ä»¥çœ‹åˆ°app-twoä¹Ÿç™»å½•æˆåŠŸã€‚</p>
<p>æµ‹è¯•ä¸€ä¸‹èµ„æºï¼Œè®¿é—®ï¼š<a href="http://127.0.0.1:8082/app-two/principle">http://127.0.0.1:8082/app-two/principle</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603215049751.png" class="" title="image-20210603215049751">

<p>æˆåŠŸè·å–åˆ°ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡éƒ½éœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»Authorizeæˆæƒï¼Œä½“éªŒä¸æ˜¯å¾ˆå¥½ã€‚ä¿®æ”¹è®¤è¯æœåŠ¡å™¨clienté…ç½®ï¼š</p>
<pre><code class="java">clients.inMemory()
    .withClient(&quot;app-one&quot;)
    ...
    .autoApprove(true)
    ...</code></pre>
<p><code>autoApprove(true)</code>å®ç°è‡ªåŠ¨æˆæƒã€‚</p>
<h3 id="9-5-æƒé™æ ¡éªŒ"><a href="#9-5-æƒé™æ ¡éªŒ" class="headerlink" title="9.5 æƒé™æ ¡éªŒ"></a>9.5 æƒé™æ ¡éªŒ</h3><p>åœ¨å•ç‚¹ç™»å½•æ¨¡å¼ä¸‹è¿›è¡Œæƒé™æ ¡éªŒï¼Œåªéœ€è¦ä¿®æ”¹å®¢æˆ·ç«¯ã€‚</p>
<p>åœ¨å®¢æˆ·ç«¯æ–°å¢Spring Securityé…ç½®ç±»ï¼š</p>
<pre><code class="java">@Configuration
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class WebSecurityConfig &#123;
&#125;</code></pre>
<p>åœ¨å®¢æˆ·ç«¯çš„RESTæ¥å£ä¸­æ·»åŠ æ¥å£ç”¨äºæµ‹è¯•ï¼š</p>
<pre><code class="java">@GetMapping(&quot;/write&quot;)
@PreAuthorize(&quot;hasAuthority(&#39;admin&#39;)&quot;)
public String write() &#123;
    return &quot;æ‚¨æ‹¥æœ‰writeæƒé™ï¼&quot;;
&#125;

@GetMapping(&quot;/read&quot;)
@PreAuthorize(&quot;hasAuthority(&#39;guest&#39;)&quot;)
public String read() &#123;
    return &quot;æ‚¨æ‹¥æœ‰readæƒé™ï¼&quot;;
&#125;</code></pre>
<p>ç®¡ç†å‘˜åªæ‹¥æœ‰å†™æƒé™ï¼Œè®¿å®¢åªæœ‰è¯»æƒé™ã€‚</p>
<p>é‡å¯é¡¹ç›®ï¼Œä½¿ç”¨Khighnessï¼ˆadminï¼‰ç™»å½•app-one</p>
<p>æµ‹è¯•è®¿é—®å†™æ¥å£ï¼š<a href="http://127.0.0.1:8081/app-one/write">http://127.0.0.1:8081/app-one/write</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603221146634.png" class="" title="image-20210603221146634">

<p>æµ‹è¯•è®¿é—®è¯»æ¥å£ï¼š<a href="http://127.0.0.1:8081/app-one/read">http://127.0.0.1:8081/app-one/read</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/52913/image-20210603221207266.png" class="" title="image-20210603221207266">

<p>è¿”å›403ï¼Œæ— æƒé™ï¼Œè¯´æ˜æ³¨è§£ç”Ÿæ•ˆã€‚</p>
]]></content>
      <categories>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>spring-security-oauth2</tag>
      </tags>
  </entry>
  <entry>
    <title>Java-Excel</title>
    <url>/posts/57208/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><h3 id="POI"><a href="#POI" class="headerlink" title="POI"></a>POI</h3><blockquote>
<p>ç®€ä»‹</p>
</blockquote>
<p>Apache POIæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„å¼€æ”¾æºç å‡½å¼åº“ï¼ŒPOIæä¾›APIç»™Javaç¨‹åºå¯¹Microsoft Officeæ ¼å¼æ¡£æ¡ˆè¯»å’Œå†™çš„åŠŸèƒ½ã€‚</p>
<blockquote>
<p>åŠŸèƒ½</p>
</blockquote>
<p>HSSF ï¼ æä¾›è¯»å†™Microsoft Excelæ ¼å¼æ¡£æ¡ˆçš„åŠŸèƒ½ã€‚</p>
<p>XSSF ï¼ æä¾›è¯»å†™Microsoft Excel OOXMLæ ¼å¼æ¡£æ¡ˆçš„åŠŸèƒ½ã€‚</p>
<p>HWPF ï¼ æä¾›è¯»å†™Microsoft Wordæ ¼å¼æ¡£æ¡ˆçš„åŠŸèƒ½ã€‚</p>
<p>HSLF ï¼ æä¾›è¯»å†™Microsoft PowerPointæ ¼å¼æ¡£æ¡ˆçš„åŠŸèƒ½ã€‚</p>
<p>HDGF ï¼ æä¾›è¯»å†™Microsoft Visio  Visioæ ¼å¼æ¡£æ¡ˆçš„åŠŸèƒ½ã€‚</p>
<h3 id="EasyExcel"><a href="#EasyExcel" class="headerlink" title="EasyExcel"></a>EasyExcel</h3><blockquote>
<p>ç®€ä»‹</p>
</blockquote>
<p>EasyExcelæ˜¯alibabaçš„ä¸€ä¸ªåŸºäºJavaçš„ç®€å•ã€çœå†…å­˜çš„è¯»å†™Excelçš„å¼€æºé¡¹ç›®ã€‚</p>
<blockquote>
<p>æ–‡æ¡£</p>
</blockquote>
<p>yuque: <a href="https://www.yuque.com/easyexcel/doc/easyexcel">https://www.yuque.com/easyexcel/doc/easyexcel</a></p>
<p>github: <a href="https://github.com/alibaba/easyexcel">https://github.com/alibaba/easyexcel</a></p>
<h2 id="POI-1"><a href="#POI-1" class="headerlink" title="POI"></a>POI</h2><h3 id="dependency"><a href="#dependency" class="headerlink" title="dependency"></a>dependency</h3><pre><code class="xml">&lt;!-- test --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;junit&lt;/groupId&gt;
    &lt;artifactId&gt;junit&lt;/artifactId&gt;
    &lt;version&gt;4.12&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- xls(2003) --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.poi&lt;/groupId&gt;
    &lt;artifactId&gt;poi&lt;/artifactId&gt;
    &lt;version&gt;3.14&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- xlsx(2007) --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.poi&lt;/groupId&gt;
    &lt;artifactId&gt;poi-ooxml&lt;/artifactId&gt;
    &lt;version&gt;3.14&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- jodatime --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;joda-time&lt;/groupId&gt;
    &lt;artifactId&gt;joda-time&lt;/artifactId&gt;
    &lt;version&gt;2.10.8&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
<h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><blockquote>
<p>HSSFåˆ›å»ºxls(2003ç‰ˆæœ¬)</p>
</blockquote>
<pre><code class="java">    /**
     * &lt;p&gt;HSSFåˆ›å»ºxls&lt;/p&gt;
     * @throws Exception
     */
    @Test
    public void testWrite03() throws Exception &#123;
        // 1ã€åˆ›å»ºä¸€ä¸ªå·¥ä½œç°¿
        Workbook workbook = new HSSFWorkbook();
        // 2ã€åˆ›å»ºä¸€ä¸ªå·¥ä½œè¡¨
        Sheet sheet = workbook.createSheet(&quot;K1&quot;);
        // 3ã€åˆ›å»ºç¬¬ä¸€è¡Œæ•°æ®
        Row row1 = sheet.createRow(0);
        // 4ã€åˆ›å»ºä¸¤ä¸ªå•å…ƒæ ¼
        Cell cell11 = row1.createCell(0);
        cell11.setCellValue(&quot;ID&quot;);
        Cell cell12 = row1.createCell(1);
        cell12.setCellValue(1);
        // 5ã€åˆ›å»ºç¬¬äºŒè¡Œæ•°æ®
        Row row2 = sheet.createRow(1);
        Cell cell21 = row2.createCell(0);
        cell21.setCellValue(&quot;å§“å&quot;);
        Cell cell22 = row2.createCell(1);
        cell22.setCellValue(&quot;K1&quot;);
        // 6ã€åˆ›å»ºç¬¬ä¸‰è¡Œæ•°æ®
        Row row3 = sheet.createRow(2);
        Cell cell31 = row3.createCell(0);
        cell31.setCellValue(&quot;æ—¶é—´&quot;);
        Cell cell32 = row3.createCell(1);
        cell32.setCellValue(new DateTime().toString(&quot;yyyy-MM-dd HH:mm:ss&quot;));
        // 7ã€ç”Ÿæˆä¸€å¼ è¡¨
        FileOutputStream fileOutputStream = new FileOutputStream(System.getProperty(&quot;user.dir&quot;) + &quot;/file/ç»Ÿè®¡è¡¨03.xls&quot;);
        workbook.write(fileOutputStream);
        fileOutputStream.close();
    &#125;</code></pre>
<blockquote>
<p>XSSFåˆ›å»ºxlsx(2007ç‰ˆæœ¬)</p>
</blockquote>
<pre><code class="java">@Test
public void testWrite07() throws Exception &#123;
    // 1ã€åˆ›å»ºä¸€ä¸ªå·¥ä½œç°¿
    Workbook workbook = new XSSFWorkbook();
    // 2ã€åˆ›å»ºä¸€ä¸ªå·¥ä½œè¡¨
    Sheet sheet = workbook.createSheet(&quot;K1&quot;);
    // 3ã€åˆ›å»ºç¬¬ä¸€è¡Œæ•°æ®
    Row row1 = sheet.createRow(0);
    // 4ã€åˆ›å»ºä¸¤ä¸ªå•å…ƒæ ¼
    Cell cell11 = row1.createCell(0);
    cell11.setCellValue(&quot;ID&quot;);
    Cell cell12 = row1.createCell(1);
    cell12.setCellValue(1);
    // 5ã€åˆ›å»ºç¬¬äºŒè¡Œæ•°æ®
    Row row2 = sheet.createRow(1);
    Cell cell21 = row2.createCell(0);
    cell21.setCellValue(&quot;å§“å&quot;);
    Cell cell22 = row2.createCell(1);
    cell22.setCellValue(&quot;K1&quot;);
    // 6ã€åˆ›å»ºç¬¬ä¸‰è¡Œæ•°æ®
    Row row3 = sheet.createRow(2);
    Cell cell31 = row3.createCell(0);
    cell31.setCellValue(&quot;æ—¶é—´&quot;);
    Cell cell32 = row3.createCell(1);
    cell32.setCellValue(new DateTime().toString(&quot;yyyy-MM-dd HH:mm:ss&quot;));
    // 7ã€ç”Ÿæˆä¸€å¼ è¡¨
    FileOutputStream fileOutputStream = new FileOutputStream(System.getProperty(&quot;user.dir&quot;) + &quot;/file/ç»Ÿè®¡è¡¨07.xlsx&quot;);
    workbook.write(fileOutputStream);
    fileOutputStream.close();
&#125;</code></pre>
<blockquote>
<p> æ³¨æ„åŒºåˆ«</p>
</blockquote>
<ul>
<li>å¯¹è±¡ä¸åŒï¼Œ03ç‰ˆæœ¬æ˜¯<code>HSSFWorkBook</code>ï¼Œ07ç‰ˆæœ¬æ˜¯<code>XSSFWorkBook</code></li>
<li>æ–‡ä»¶åç¼€ï¼Œ03ç‰ˆæœ¬excelåç¼€æ˜¯<code>xls</code>ï¼Œ07ç‰ˆæœ¬excelåç¼€æ˜¯<code>xlsx</code></li>
</ul>
<blockquote>
<p>å¤§æ–‡ä»¶å†™HSSF</p>
</blockquote>
<p>ç¼ºç‚¹ï¼šæœ€å¤šåªèƒ½å¤„ç†65536è¡Œï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸</p>
<p>ä¼˜ç‚¹ï¼šè¿‡ç¨‹ä¸­å†™å…¥ç¼“å­˜ï¼Œä¸æ“ä½œç£ç›˜ï¼Œæœ€åä¸€æ¬¡æ€§å†™å…¥ç£ç›˜ï¼Œé€Ÿåº¦å¿«</p>
<pre><code class="java">@Test
public void testWrite03BigData() throws Exception&#123;
    // å¼€å§‹æ—¶é—´
    long start = System.currentTimeMillis();
    // åˆ›å»ºå·¥ä½œç°¿
    Workbook workbook = new HSSFWorkbook();
    // åˆ›å»ºä¸€å¼ è¡¨
    Sheet sheet = workbook.createSheet();
    // å†™å…¥æ•°æ®
    for (int rowNum = 0; rowNum &lt; 65537; rowNum++) &#123;
        Row row = sheet.createRow(rowNum);
        for (int cellNum = 0; cellNum &lt; 10; cellNum++) &#123;
            Cell cell = row.createCell(cellNum);
            cell.setCellValue(cellNum);
        &#125;
    &#125;
    FileOutputStream fileOutputStream = new FileOutputStream(System.getProperty(&quot;user.dir&quot;) + &quot;/file/testWrite03BigData.xls&quot;);
    workbook.write(fileOutputStream);
    fileOutputStream.close();
    long end = System.currentTimeMillis();
    System.out.println(&quot;è€—æ—¶ï¼š&quot; + (end - start) + &quot;ms&quot;);
&#125;</code></pre>
<blockquote>
<p>å¤§æ–‡ä»¶å†™XSSF</p>
</blockquote>
<p>ç¼ºç‚¹ï¼šå†™æ•°æ®æ—¶é€Ÿåº¦éå¸¸æ…¢ï¼Œéå¸¸è€—å†…å­˜ï¼Œä¹Ÿä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºï¼Œå¦‚100ä¸‡æ¡</p>
<p>ä¼˜ç‚¹ï¼šå¯ä»¥å†™è¾ƒå¤§çš„æ•°æ®é‡ï¼Œå¦‚20ä¸‡æ¡</p>
<pre><code class="java">@Test
public void testWrite07BigData() throws Exception&#123;
    // å¼€å§‹æ—¶é—´
    long start = System.currentTimeMillis();
    // åˆ›å»ºå·¥ä½œç°¿
    Workbook workbook = new XSSFWorkbook();
    // åˆ›å»ºä¸€å¼ è¡¨
    Sheet sheet = workbook.createSheet();
    // å†™å…¥æ•°æ®
    for (int rowNum = 0; rowNum &lt; 65537; rowNum++) &#123;
        Row row = sheet.createRow(rowNum);
        for (int cellNum = 0; cellNum &lt; 10; cellNum++) &#123;
            Cell cell = row.createCell(cellNum);
            cell.setCellValue(cellNum);
        &#125;
    &#125;
    FileOutputStream fileOutputStream = new FileOutputStream(System.getProperty(&quot;user.dir&quot;) + &quot;/file/testWrite07BigData.xlsx&quot;);
    workbook.write(fileOutputStream);
    fileOutputStream.close();
    long end = System.currentTimeMillis();
    System.out.println(&quot;è€—æ—¶ï¼š&quot; + (end - start) + &quot;ms&quot;);
&#125;</code></pre>
<blockquote>
<p>å¤§æ–‡ä»¶å†™SXSSF</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼šå¯ä»¥å†™éå¸¸å¤§çš„æ•°æ®é‡ï¼Œå¦‚100ä¸‡æ¡ç”šè‡³æ›´å¤šæ¡ï¼Œå†™æ•°æ®é€Ÿåº¦å¿«ï¼Œå ç”¨æ›´å°‘çš„å†…å­˜</p>
<p>æ³¨æ„ï¼š</p>
<p>è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿä¸´æ—¶æ–‡ä»¶ï¼Œéœ€è¦æ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€‚</p>
<p>é»˜è®¤ç”±100æ¡è®°å½•è¢«ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœè¶…è¿‡è¿™æ•°é‡ï¼Œåˆ™æœ€å‰é¢çš„æ•°æ®è¢«å†™å…¥ä¸´æ—¶æ–‡ä»¶ã€‚</p>
<p>å¦‚æœæƒ³è‡ªå®šä¹‰å†…å­˜ä¸­æ•°æ®çš„æ•°é‡ï¼Œå¯ä»¥ä½¿ç”¨new SXSSFWorkBookã€‚</p>
<pre><code class="java">@Test
public void testWrite07BigDataS() throws Exception&#123;
    // å¼€å§‹æ—¶é—´
    long start = System.currentTimeMillis();
    // åˆ›å»ºå·¥ä½œç°¿
    Workbook workbook = new SXSSFWorkbook();
    // åˆ›å»ºä¸€å¼ è¡¨
    Sheet sheet = workbook.createSheet();
    // å†™å…¥æ•°æ®
    for (int rowNum = 0; rowNum &lt; 10 * 10000; rowNum++) &#123;
        Row row = sheet.createRow(rowNum);
        for (int cellNum = 0; cellNum &lt; 10; cellNum++) &#123;
            Cell cell = row.createCell(cellNum);
            cell.setCellValue(cellNum);
        &#125;
    &#125;
    FileOutputStream fileOutputStream = new FileOutputStream(System.getProperty(&quot;user.dir&quot;) + &quot;/file/testWrite07BigDataS.xlsx&quot;);
    workbook.write(fileOutputStream);
    // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
    ((SXSSFWorkbook) workbook).dispose();
    fileOutputStream.close();
    long end = System.currentTimeMillis();
    System.out.println(&quot;è€—æ—¶ï¼š&quot; + (end - start) + &quot;ms&quot;);
&#125;</code></pre>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><blockquote>
<p>HSSFè¯»å–xls(2003ç‰ˆæœ¬)</p>
</blockquote>
<pre><code class="java">@Test
public void testRead03() throws Exception &#123;
    // è·å–æ–‡ä»¶æµ
    FileInputStream inputStream = new FileInputStream(System.getProperty(&quot;user.dir&quot;) + &quot;/file/ç»Ÿè®¡è¡¨03.xls&quot;);
    // åˆ›å»ºä¸€ä¸ªå·¥ä½œç°¿
    Workbook workbook = new HSSFWorkbook(inputStream);
    // è·å–è¡¨
    Sheet sheet = workbook.getSheetAt(0);
    // è·å–è¡Œ
    Row row = sheet.getRow(0);
    // è·å–åˆ—
    Cell cell = row.getCell(0);
    System.out.println(cell.getStringCellValue());
    // å…³é—­æµ
    inputStream.close();
&#125;</code></pre>
<blockquote>
<p>XSSFè¯»å–xlsx(2007ç‰ˆæœ¬)</p>
</blockquote>
<pre><code class="java">@Test
public void testRead07() throws Exception &#123;
    // è·å–æ–‡ä»¶æµ
    FileInputStream inputStream = new FileInputStream(System.getProperty(&quot;user.dir&quot;) + &quot;/file/ç»Ÿè®¡è¡¨07.xlsx&quot;);
    // åˆ›å»ºä¸€ä¸ªå·¥ä½œç°¿
    Workbook workbook = new XSSFWorkbook(inputStream);
    // è·å–è¡¨
    Sheet sheet = workbook.getSheetAt(0);
    // è·å–è¡Œ
    Row row = sheet.getRow(0);
    // è·å–åˆ—
    Cell cell = row.getCell(0);
    System.out.println(cell.getStringCellValue());
    // å…³é—­æµ
    inputStream.close();
&#125;</code></pre>
<blockquote>
<p>æµ‹è¯•è¯»å–å®Œæ•´è¡¨</p>
</blockquote>
<pre><code class="java">@Test
public void testReadCell() throws Exception &#123;
    // è·å–æ–‡ä»¶æµ
    FileInputStream inputStream = new FileInputStream(System.getProperty(&quot;user.dir&quot;) + &quot;/file/å­¦ç”ŸèŠ±åå†Œ.xlsx&quot;);
    // åˆ›å»ºå·¥ä½œç°¿
    Workbook workbook = new XSSFWorkbook(inputStream);
    // è·å–è¡¨
    Sheet sheet = workbook.getSheetAt(0);
    // è·å–æ ‡é¢˜
    Row rowTitle = sheet.getRow(0);
    // è¾“å‡ºæ ‡é¢˜
    System.out.print(&quot;|  &quot;);
    if (rowTitle != null) &#123;
        int cellCount = rowTitle.getPhysicalNumberOfCells();
        for (int cellNum = 0; cellNum &lt; cellCount; cellNum++) &#123;
            Cell cell = rowTitle.getCell(cellNum);
            if (cell != null) &#123;
                String cellValue = cell.getStringCellValue();
                System.out.print(cellValue + &quot;  |  &quot;);
            &#125;
        &#125;
    &#125;
    System.out.println();
    // è·å–è¡Œæ•°
    int rowCount = sheet.getLastRowNum();
    // è·å–æ•°æ®
    for (int rowNum = 1; rowNum &lt; rowCount; rowNum++) &#123;
        Row rowData = sheet.getRow(rowNum);
        if (rowData != null) &#123;
            int cellCount = rowData.getPhysicalNumberOfCells();
            for (int cellNum = 0; cellNum &lt; cellCount; cellNum++) &#123;
                Cell cell = rowData.getCell(cellNum);
                // åŒ¹é…å•å…ƒæ ¼çš„æ•°æ®ç±»å‹
                if (cell != null) &#123;
                    String cellValue = cell.getStringCellValue();
                    System.out.print(cellValue + &quot;\t&quot;);
                &#125;
            &#125;
            System.out.println();
        &#125;
    &#125;
    inputStream.close();
&#125;</code></pre>
<h2 id="EasyExcel-1"><a href="#EasyExcel-1" class="headerlink" title="EasyExcel"></a>EasyExcel</h2><h3 id="dependency-1"><a href="#dependency-1" class="headerlink" title="dependency"></a>dependency</h3><pre><code class="xml">&lt;!-- test --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;junit&lt;/groupId&gt;
    &lt;artifactId&gt;junit&lt;/artifactId&gt;
    &lt;version&gt;4.12&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- lombok --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
    &lt;artifactId&gt;lombok&lt;/artifactId&gt;
    &lt;version&gt;1.18.16&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- easyexcel--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
    &lt;artifactId&gt;easyexcel&lt;/artifactId&gt;
    &lt;version&gt;2.2.7&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- fastjson --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
    &lt;artifactId&gt;fastjson&lt;/artifactId&gt;
    &lt;version&gt;1.2.75&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- xls(2003) --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.poi&lt;/groupId&gt;
    &lt;artifactId&gt;poi&lt;/artifactId&gt;
    &lt;version&gt;3.17&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- xlsx(2007) --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.poi&lt;/groupId&gt;
    &lt;artifactId&gt;poi-ooxml&lt;/artifactId&gt;
    &lt;version&gt;3.17&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
<h3 id="write-1"><a href="#write-1" class="headerlink" title="write"></a>write</h3><blockquote>
<p>å‡†å¤‡æ•°æ®</p>
</blockquote>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class DemoData implements Serializable, Cloneable &#123;

    @ExcelProperty(&quot;å­—ç¬¦ä¸²å­—æ®µ&quot;)
    private String stringData;

    @ExcelProperty(&quot;æ—¥æœŸå­—æ®µ&quot;)
    private Date dateData;

    @ExcelProperty(&quot;æ•´æ•°å­—æ®µ&quot;)
    private Integer intData;

    @ExcelProperty(&quot;æµ®ç‚¹å­—æ®µ&quot;)
    private Double douData;

    @Override
    protected Object clone() throws CloneNotSupportedException &#123;
        return super.clone();
    &#125;
&#125;</code></pre>
<blockquote>
<p>æµ‹è¯•å†™å…¥</p>
</blockquote>
<pre><code class="java">private List&lt;DemoData&gt; data() &#123;
    List&lt;DemoData&gt; list = new ArrayList&lt;&gt;();
    Random random = new Random();
    for (int i = 1; i &lt;= 10; i++) &#123;
        DemoData demoData = new DemoData();
        demoData.setStringData(i + &quot;å·&quot;);
        demoData.setDateData(new Date());
        demoData.setIntData(random.nextInt(100));
        demoData.setDouData(random.nextDouble());
    &#125;
    return list;
&#125;

@org.junit.Test
    public void write() &#123;
    String fileName = System.getProperty(&quot;user.dir&quot;) + &quot;/file/simpleWrite.xlsx&quot;;
    EasyExcel.write(fileName, DemoData.class).sheet(&quot;è¡¨1&quot;).doWrite(data());
&#125;</code></pre>
<h3 id="read-1"><a href="#read-1" class="headerlink" title="read"></a>read</h3><blockquote>
<p>æ•°æ®è§£æå™¨</p>
</blockquote>
<pre><code class="java">public class DemoDataListener extends AnalysisEventListener&lt;DemoData&gt; &#123;
    private static final int BATCH_COUNT = 5;
    private static final List&lt;DemoData&gt; list = new ArrayList&lt;&gt;();

    // è¯»å–æ•°æ®è°ƒç”¨
    @Override
    public void invoke(DemoData demoData, AnalysisContext analysisContext) &#123;
        System.out.println(demoData);
        if (list.size() == BATCH_COUNT) &#123;
            list.clear();
        &#125;
    &#125;

    // è§£æå®Œæˆè°ƒç”¨
    @Override
    public void doAfterAllAnalysed(AnalysisContext analysisContext) &#123;
        System.out.println(&quot;è§£æå®Œæˆ&quot;);
    &#125;
&#125;</code></pre>
<blockquote>
<p>æµ‹è¯•è¯»å–</p>
</blockquote>
<pre><code class="java">@Test
public void read() &#123;
    String fileName = System.getProperty(&quot;user.dir&quot;) + &quot;/file/simpleWrite.xlsx&quot;;
    EasyExcel.read(fileName, DemoData.class, new DemoDataListener()).sheet().doRead();
&#125;</code></pre>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¹äºå•çº¯çš„è¡¨æ ¼æ•°æ®æ“ä½œï¼ŒPOIçš„ä½¿ç”¨è¿˜æ˜¯æ¯”è¾ƒå¥½çš„ã€‚</p>
<p>EasyExcelçš„å°è£…æ€§æ¯”è¾ƒå¼ºï¼ŒOOPå’ŒAOPå¾ˆæœ‰é’ˆå¯¹æ€§ã€‚</p>
<p>EasyExcelåšä¸€äº›æ•°æ®åº“çš„æ‰¹é‡å¯¼å‡ºå¯¼å…¥è¿˜æ˜¯ä¸é”™çš„ã€‚</p>
<p>é‰´äºPOIæ“ä½œä¸Šçš„è‡ªç”±æ€§ï¼Œè‡ªå·±å°è£…äº†ä¸€ä¸ªå·¥å…·ç±»ï¼š</p>
<pre><code class="java">import org.apache.poi.hssf.usermodel.HSSFFormulaEvaluator;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFFormulaEvaluator;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.junit.Test;

import java.io.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.time.temporal.TemporalAccessor;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Random;

/**
 * &lt;p&gt; Project: Excel &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.poi &lt;/p&gt;
 * &lt;p&gt; FileName: ExcelUtil &lt;p&gt;
 * &lt;p&gt; Description: Excelå·¥å…·ç±» &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2021/5/19
 */
public class ExcelUtil &#123;
    /** office2003 */
    private final static String EXCEL_TYPE_XLS = &quot;xls&quot;;
    /** office2007 */
    private final static String EXCEL_TYPE_XLSX = &quot;xlsx&quot;;
    /** ç©ºå­—ç¬¦ä¸² */
    private final static String CHAR_TYPE_BLANK = &quot;&quot;;
    /** é”™è¯¯å­—ç¬¦ */
    private final static String CHAR_TYPE_ERROR = &quot;error&quot;;
    /** æœªçŸ¥å­—ç¬¦ */
    private final static String CHAR_TYPE_UNKNOWN = &quot;unknown&quot;;
    /** åˆ—çš„é•¿åº¦å•ä½ */
    private final static Integer COLUMN_CELL_WIDTH = 1 &lt;&lt; 10;
    /** æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼ */
    private final static String DATE_FORMAT = &quot;yyyy-MM-dd HH:mm:ss.SSS&quot;;
    /** æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼åŒ–å™¨ */
    private final static DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern(DATE_FORMAT);

    /**
     * è¯»å–è¡¨æ ¼æ–‡ä»¶å¹¶è§£ææˆå­—ç¬¦ä¸²æ•°ç»„
     * @param file è¡¨æ ¼æ–‡ä»¶
     * @return æ•°æ®é›†åˆ
     */
    public static List&lt;List&lt;Object&gt;&gt; readExcel(File file) &#123;
        try &#123;
            checkFile(file);
        &#125; catch (FileNotFoundException e) &#123;
            e.printStackTrace();
        &#125;
        Workbook workBook = getWorkBook(file);
        return readProcess(workBook);
    &#125;

    /**
     * æ£€éªŒæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”ä¸ºè¡¨æ ¼æ–‡ä»¶
     * @param file æ–‡ä»¶
     * @throws NullPointerException æœªæ‰¾åˆ°æ–‡ä»¶
     * @throws FileNotFoundException éè¡¨æ ¼æ–‡ä»¶
     * @throws IllegalArgumentException åç¼€åé”™è¯¯
     */
    private static void checkFile(File file) throws FileNotFoundException &#123;
        if (file == null) &#123;
            throw new NullPointerException(&quot;File is null&quot;);
        &#125;
        if(!file.exists())&#123;
            throw new FileNotFoundException(&quot;File &quot; + file + &quot; does not exist&quot;);
        &#125;
        String fileName = file.getName();
        if(!fileName.endsWith(EXCEL_TYPE_XLS) &amp;&amp; !fileName.endsWith(EXCEL_TYPE_XLSX))&#123;
            throw new IllegalArgumentException(fileName + &quot; is not a kind of excel file&quot;);
        &#125;
    &#125;

    /**
     * è·å–æ–‡ä»¶å¯¹åº”çš„å·¥ä½œç°¿ï¼Œåˆ†ä¸ºXLSå’ŒXLSXç±»å‹
     * @param file è¡¨æ ¼æ–‡ä»¶
     * @return è¡¨æ ¼æ–‡ä»¶çš„å·¥ä½œç°¿
     */
    private static Workbook getWorkBook(File file) &#123;
        String fileName = file.getName();
        Workbook workbook = null;
        try &#123;
            InputStream in = new FileInputStream(file);
            workbook = fileName.endsWith(EXCEL_TYPE_XLS) ? new HSSFWorkbook(in) : new XSSFWorkbook(in);
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;
        return workbook;
    &#125;

    /**
     * è¯»å–å·¥ä½œç°¿ï¼Œä¸€è¡Œæ•°æ®è¯»ä½œä¸€ä¸ªæ•°ç»„ï¼Œæ‰€æœ‰è¡Œä½œä¸ºä¸€ä¸ªé›†åˆè¿”å›
     * @param workbook å·¥ä½œç°¿
     * @return æ•°æ®é›†åˆ
     */
    private static List&lt;List&lt;Object&gt;&gt; readProcess(Workbook workbook) &#123;
        List&lt;List&lt;Object&gt;&gt; res = new ArrayList&lt;&gt;();
        FormulaEvaluator evaluator = (workbook instanceof HSSFWorkbook) ?
                new HSSFFormulaEvaluator((HSSFWorkbook) workbook) : new XSSFFormulaEvaluator((XSSFWorkbook) workbook);
        if(workbook != null) &#123;
            for (int sheetNum = 0; sheetNum &lt; workbook.getNumberOfSheets(); sheetNum++) &#123;
                Sheet sheet = workbook.getSheetAt(sheetNum);
                if (sheet == null)
                    continue;
                int firstRowNum = sheet.getFirstRowNum();
                int lastRowNum = sheet.getLastRowNum();
                for (int rowNum = firstRowNum; rowNum &lt;= lastRowNum; rowNum++) &#123;
                    Row row = sheet.getRow(rowNum);
                    if (row == null)
                        continue;
                    int firstCellNum = row.getFirstCellNum();
                    int lastCellNum = row.getPhysicalNumberOfCells();
                    List&lt;Object&gt; curr = new ArrayList&lt;&gt;(lastCellNum - firstCellNum + 1);
                    for (int cellNum = firstCellNum; cellNum &lt; lastCellNum; cellNum++) &#123;
                        Cell cell = row.getCell(cellNum);
                        curr.add(getCellValue(cell, evaluator));
                    &#125;
                    res.add(curr);
                &#125;
            &#125;
            try &#123;
                workbook.close();
            &#125; catch (IOException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
        return res;
    &#125;

    /**
     * è·å–å•å…ƒæ ¼çš„å€¼
     * @param cell å•å…ƒæ ¼
     * @param evaluator å…¬å¼è®¡ç®—
     * @return å•å…ƒæ ¼çš„å€¼
     */
    private static Object getCellValue(Cell cell, FormulaEvaluator evaluator)&#123;
        Object cellValue = &quot;&quot;;
        if(cell == null)&#123;
            return cellValue;
        &#125;
        // åˆ¤æ–­æ•°æ®çš„ç±»å‹
        switch (cell.getCellType())&#123;
            case Cell.CELL_TYPE_NUMERIC: // æ•°å­—ç±»å‹
                cellValue = cell.getNumericCellValue(); break;
            case Cell.CELL_TYPE_STRING: // å­—ç¬¦ä¸²ç±»å‹
                cellValue = cell.getStringCellValue(); break;
            case Cell.CELL_TYPE_BOOLEAN: // å¸ƒå°”ç±»å‹
                cellValue = cell.getBooleanCellValue(); break;
            case Cell.CELL_TYPE_FORMULA: // å…¬å¼
                cellValue = evaluator.evaluate(cell); break;
            case Cell.CELL_TYPE_BLANK: // ç©ºå€¼
                cellValue = CHAR_TYPE_BLANK; break;
            case Cell.CELL_TYPE_ERROR: // é”™è¯¯
                cellValue = CHAR_TYPE_ERROR; break;
            default: cellValue = CHAR_TYPE_UNKNOWN; break;
        &#125;
        return cellValue;
    &#125;

    /**
     * å°†æ ‡é¢˜å’Œå†…å®¹å†™å…¥æ–°æ–‡ä»¶
     * @param file        æ–‡ä»¶
     * @param sheetName   è¡¨æ ¼å
     * @param titleList   æ ‡é¢˜åˆ—
     * @param contentList å†…å®¹åˆ—
     */
    public static void writeExcel(File file, String sheetName, List&lt;String&gt; titleList, List&lt;List&lt;Object&gt;&gt; contentList) &#123;
        String fileName = checkParam(file, sheetName, titleList, contentList);
        Workbook workbook = fileName.endsWith(EXCEL_TYPE_XLS) ? new HSSFWorkbook() : new XSSFWorkbook();
        Sheet sheet = workbook.createSheet(sheetName);
        initHead(workbook, sheet, titleList);
        writeContent(workbook, sheet, contentList);
        try &#123;
            FileOutputStream out = new FileOutputStream(file);
            workbook.write(out);
            out.close();
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    /**
     * æ£€æŸ¥å‚æ•°æ˜¯å¦åˆæ³•ï¼Œå¹¶è¿”å›æ–‡ä»¶å
     * @param file        æ–‡ä»¶
     * @param sheetName   è¡¨æ ¼å
     * @param titleList   æ ‡é¢˜åˆ—
     * @param contentList å†…å®¹åˆ—
     * @return æ–‡ä»¶å
     */
    private static String checkParam(File file, String sheetName, List&lt;String&gt; titleList, List&lt;List&lt;Object&gt;&gt; contentList) &#123;
        if (file == null)
            throw new NullPointerException(&quot;File is null&quot;);
        String fileName = file.getName();
        if (fileName.equals(&quot;&quot;) || !(fileName.endsWith(EXCEL_TYPE_XLS) || fileName.endsWith(EXCEL_TYPE_XLSX)))
            throw new IllegalArgumentException(&quot;File name is illegal&quot;);
        if (sheetName == null || sheetName.equals(&quot;&quot;))
            throw new IllegalArgumentException(&quot;Sheet name is blank&quot;);
        if (titleList == null)
            throw new IllegalArgumentException(&quot;Title list is null&quot;);
        if (contentList == null)
            throw new IllegalArgumentException(&quot;Content list is null&quot;);
        return fileName;
    &#125;

    /**
     * åˆå§‹åŒ–æ ‡é¢˜è¡Œ
     * @param book      å·¥ä½œç°¿
     * @param sheet     å½“å‰è¡¨
     * @param titleList æ ‡é¢˜åˆ—
     */
    private static void initHead(Workbook book, Sheet sheet, List&lt;String&gt; titleList) &#123;
        // æ ‡é¢˜æ ·å¼
        CellStyle style = book.createCellStyle();
        // å±…ä¸­å¯¹é½
        style.setAlignment(CellStyle.ALIGN_CENTER);
        style.setVerticalAlignment(CellStyle.VERTICAL_CENTER);
        // èƒŒæ™¯å¡«å……
        style.setFillForegroundColor(IndexedColors.GREY_50_PERCENT.getIndex());
        style.setFillPattern(CellStyle.SOLID_FOREGROUND);
        // å­—ä½“æ ·å¼
        Font font = book.createFont();
        font.setFontName(&quot;åæ–‡æ¥·ä½“&quot;);
        font.setFontHeightInPoints((short) 13);
        font.setBoldweight(Font.BOLDWEIGHT_BOLD);
        font.setColor(IndexedColors.WHITE.getIndex());
        style.setFont(font);
        // åˆ›å»ºç¬¬ä¸€è¡Œ
        Row head = sheet.createRow(0);
        head.setHeightInPoints(20);
        // åˆ—çš„å®½åº¦
        int columnWidth = 0;
        for (int i = 0; i &lt; titleList.size(); i++) &#123;
            Cell cell = head.createCell(i);
            cell.setCellStyle(style);
            String s = titleList.get(i);
            cell.setCellValue(s);
            columnWidth = s.length() * COLUMN_CELL_WIDTH;
            sheet.setColumnWidth(i, columnWidth);
        &#125;
    &#125;

    /**
     * å¡«å……å†…å®¹è¡Œ
     * @param book        å·¥ä½œç°¿
     * @param sheet       å½“å‰è¡¨
     * @param contentList å†…å®¹åˆ—
     */
    private static void writeContent(Workbook book, Sheet sheet, List&lt;List&lt;Object&gt;&gt; contentList) &#123;
        for (int i = 0; i &lt; contentList.size(); i++) &#123;
            Row curr = sheet.createRow(i + 1);
            List&lt;Object&gt; content = contentList.get(i);
            for (int c = 0; c &lt; content.size(); c++) &#123;
                writeProcess(book, curr, c, content.get(c));
            &#125;
        &#125;
    &#125;

    /**
     * å°†å€¼å¡«å…¥å•å…ƒæ ¼
     * @param book å·¥ä½œç°¿
     * @param row å½“å‰è¡Œ
     * @param col å½“å‰åˆ—
     * @param val å•å…ƒå€¼
     */
    private static void writeProcess(Workbook book, Row row, int col, Object val) &#123;
        // å†…å®¹æ ·å¼
        CellStyle style = book.createCellStyle();
        style.setVerticalAlignment(CellStyle.VERTICAL_CENTER);
        style.setBorderRight(CellStyle.BORDER_THIN);
        style.setRightBorderColor(IndexedColors.GREY_50_PERCENT.getIndex());
        style.setBorderLeft(CellStyle.BORDER_THIN);
        style.setLeftBorderColor(IndexedColors.GREY_50_PERCENT.getIndex());
        style.setBorderTop(CellStyle.BORDER_THIN);
        style.setTopBorderColor(IndexedColors.GREY_50_PERCENT.getIndex());
        style.setBorderBottom(CellStyle.BORDER_THIN);
        style.setBottomBorderColor(IndexedColors.GREY_50_PERCENT.getIndex());
        // å±…ä¸­å¯¹é½
        style.setAlignment(CellStyle.ALIGN_CENTER);
        // å­—ä½“æ ·å¼
        Font font = book.createFont();
        font.setFontName(&quot;Arial&quot;);
        font.setFontHeightInPoints((short) 10);
        style.setFont(font);
        Cell cell = row.createCell(col);
        cell.setCellStyle(style);
        try &#123;
            if (val == null) &#123;
                cell.setCellValue(CHAR_TYPE_BLANK);
            &#125; else &#123;
                if (val instanceof String) &#123;
                    cell.setCellValue((String) val);
                &#125; else if (val instanceof Integer) &#123;
                    cell.setCellValue((int) val);
                &#125; else if (val instanceof Long) &#123;
                    cell.setCellValue((Long) val);
                &#125; else if (val instanceof Double) &#123;
                    cell.setCellValue((Double) val);
                &#125; else if (val instanceof Float) &#123;
                    cell.setCellValue((Float) val);
                &#125; else if (val instanceof Boolean) &#123;
                    cell.setCellValue((Boolean) val);
                &#125; else if (val instanceof TemporalAccessor) &#123;
                    cell.setCellValue(DATE_TIME_FORMATTER.format((TemporalAccessor) val));
                &#125; else &#123;
                    cell.setCellValue(val.toString());
                &#125;
            &#125;
        &#125; catch (Exception e) &#123;
            cell.setCellValue(CHAR_TYPE_ERROR);
            e.printStackTrace();
        &#125;
    &#125;
&#125;</code></pre>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>poi</tag>
        <tag>easyexcel</tag>
      </tags>
  </entry>
  <entry>
    <title>ZooKeeper</title>
    <url>/posts/7340/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-Zookeeperæ¦‚è¿°"><a href="#1-Zookeeperæ¦‚è¿°" class="headerlink" title="1. Zookeeperæ¦‚è¿°"></a>1. Zookeeperæ¦‚è¿°</h2><h3 id="1-1-ç®€ä»‹"><a href="#1-1-ç®€ä»‹" class="headerlink" title="1.1 ç®€ä»‹"></a>1.1 ç®€ä»‹</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/7340/Zookeeper.jpg" class="" title="Zookeeper">

<p>Zookeeperæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„ä¸€ä¸ªè½¯ä»¶é¡¹ç›®ï¼Œå®ƒä¸ºå¤§å‹åˆ†å¸ƒå¼è®¡ç®—æä¾›å¼€æºçš„åˆ†å¸ƒå¼é…ç½®æœåŠ¡ã€åŒæ­¥æœåŠ¡å’Œå‘½åæ³¨å†Œã€‚</p>
<h3 id="1-2-æ¶æ„"><a href="#1-2-æ¶æ„" class="headerlink" title="1.2 æ¶æ„"></a>1.2 æ¶æ„</h3><p>é€šè¿‡å†—ä½™æœåŠ¡å®ç°é«˜å¯ç”¨æ€§ã€‚</p>
<h3 id="1-3-è®¾è®¡ç›®æ ‡"><a href="#1-3-è®¾è®¡ç›®æ ‡" class="headerlink" title="1.3 è®¾è®¡ç›®æ ‡"></a>1.3 è®¾è®¡ç›®æ ‡</h3><p>å°†å¤æ‚ä¸”å®¹æ˜“å‡ºé”™çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§æœåŠ¡å°è£…èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªé«˜æ•ˆå¯é çš„åŸè¯­é›†ï¼Œå¹¶ä»¥ä¸€ç³»åˆ—ç®€å•æ˜“ç”¨çš„æ¥å£æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ã€‚</p>
<h3 id="1-4-åŠŸèƒ½ç‰¹æ€§"><a href="#1-4-åŠŸèƒ½ç‰¹æ€§" class="headerlink" title="1.4 åŠŸèƒ½ç‰¹æ€§"></a>1.4 åŠŸèƒ½ç‰¹æ€§</h3><p>ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆï¼Œåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥åŸºäºå®ƒå®ç°è¯¸å¦‚æ•°æ®å‘å¸ƒ/è®¢é˜…ã€è´Ÿè½½å‡è¡¡ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼åè°ƒ/é€šçŸ¥ã€é›†ç¾¤ç®¡ç†ã€Masteré€‰ä¸¾ã€åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é˜Ÿåˆ—ç­‰åŠŸèƒ½ã€‚</p>
<h3 id="1-5-CAPç†è®º"><a href="#1-5-CAPç†è®º" class="headerlink" title="1.5 CAPç†è®º"></a>1.5 CAPç†è®º</h3><p>å¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œä»¥ä¸‹ä¸‰ç‚¹ä¸èƒ½åŒæ—¶æ»¡è¶³ï¼š</p>
<ul>
<li>Consistencyï¼šä¸€è‡´æ€§ï¼Œä¸€ä¸ªèŠ‚ç‚¹åœ¨æ•°æ®ä¸€è‡´çš„çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°æ“ä½œåï¼Œåº”è¯¥ä¿è¯ç³»ç»Ÿçš„æ•°æ®ä»ç„¶å¤„äºä¸€è‡´çš„çŠ¶æ€ã€‚</li>
<li>Availabilityï¼šå¯ç”¨æ€§ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„å“åº”ï¼Œä½†æ˜¯ä¸ä¿è¯è·å–çš„æ•°æ®ä¸ºæœ€æ–°æ•°æ®</li>
<li>Partion toleranceï¼šåˆ†åŒºå®¹é”™æ€§ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨é‡åˆ°ä»»ä½•ç½‘ç»œåˆ†åŒºæ•…éšœçš„æ—¶å€™ï¼Œä»ç„¶éœ€è¦èƒ½å¤Ÿä¿è¯å¯¹å¤–æä¾›æ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§çš„æœåŠ¡ï¼Œé™¤éæ•´ä¸ªç½‘ç»œç¯å¢ƒéƒ½å‘ç”Ÿäº†æ•…éšœã€‚</li>
</ul>
<p>ä¸‰å¤§å¤è€çš„æ³¨å†Œä¸­å¿ƒå¯¹æ¯”</p>
<table>
<thead>
<tr>
<th>ç»„ä»¶å</th>
<th>è¯­è¨€</th>
<th>CAP</th>
<th>æœåŠ¡å¥åº·æ£€æŸ¥</th>
<th>å¯¹å¤–æš´éœ²æ¥å£</th>
<th>Spring Cloudé›†æˆ</th>
</tr>
</thead>
<tbody><tr>
<td>Eureka</td>
<td>Java</td>
<td>AP</td>
<td>å¯é…æ”¯æŒ</td>
<td>HTTP</td>
<td>å·²é›†æˆ</td>
</tr>
<tr>
<td>Consul</td>
<td>Go</td>
<td>CP</td>
<td>æ”¯æŒ</td>
<td>HTTP/DNS</td>
<td>å·²é›†æˆ</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>Java</td>
<td>CP</td>
<td>æ”¯æŒ</td>
<td>å®¢æˆ·ç«¯</td>
<td>å·²é›†æˆ</td>
</tr>
</tbody></table>
<h3 id="1-6-BASEç†è®º"><a href="#1-6-BASEç†è®º" class="headerlink" title="1.6 BASEç†è®º"></a>1.6 BASEç†è®º</h3><p>BASEç†è®ºæ˜¯ä»¥ä¸‹ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ï¼š</p>
<ul>
<li>Basically Availableï¼šåŸºæœ¬å¯ç”¨ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå‡ºç°æ•…éšœï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼ˆæœåŠ¡é™çº§ï¼‰</li>
<li>Soft-stateï¼šè½¯çŠ¶æ€ï¼Œå…è®¸åˆ†å¸ƒå¼ç³»ç»Ÿå‡ºç°ä¸­é—´çŠ¶æ€ï¼Œè€Œä¸”ä¸­é—´çŠ¶æ€ä¸å½±å“ç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡ŒåŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨æ—¶å»¶ã€‚</li>
<li>Eventually Consistentï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½è¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚</li>
</ul>
<p>BASEç†è®ºæ˜¯å¯¹CAPä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§è¿›è¡Œä¸€ä¸ªæƒè¡¡çš„ç»“æœï¼Œæ ¸å¿ƒæ€æƒ³ï¼šæ— æ³•åšåˆ°å¼ºä¸€è‡´ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<h2 id="2-Zookeeperå®‰è£…"><a href="#2-Zookeeperå®‰è£…" class="headerlink" title="2. Zookeeperå®‰è£…"></a>2. Zookeeperå®‰è£…</h2><blockquote>
<p>æ³¨æ„</p>
</blockquote>
<p>3.4ç‰ˆæœ¬æ˜¯åŸºäºjdk8æ„å»ºçš„ï¼Œ3.5ç‰ˆæœ¬ä¹‹åæ˜¯åŸºäºjdk11æ„å»ºçš„ã€‚</p>
<h3 id="2-1-Linuxå®‰è£…"><a href="#2-1-Linuxå®‰è£…" class="headerlink" title="2.1 Linuxå®‰è£…"></a>2.1 Linuxå®‰è£…</h3><pre><code class="shell"># ä¸‹è½½jdk8
$ yum install -y java-1.8.0-openjdk-devel.x86_64
# é…ç½®ç¯å¢ƒå˜é‡
$ vim /etc/profile
export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.292.b10-1.el7_9.x86_64/jre/bin 
export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
export PATH=$JAVA_HOME/bin:$PATH
# ä½¿é…ç½®ç”Ÿæ•ˆ
source /etc/profile
# ä¸‹è½½æºç 
$ wget https://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.14/zookeeper-3.4.14.tar.gz
# è§£å‹å®‰è£…åŒ…
$ tar -zxvf zookeeper-3.4.14.tar.gz
# ä¿®æ”¹é…ç½®
$ cd conf/ &amp;&amp; cp zoo_sample.cfg zoo.cfg
# å¯åŠ¨æœåŠ¡ç«¯
$ cd ../bin/ &amp;&amp; sh zkServer.sh start</code></pre>
<h3 id="2-2-Dockerå®‰è£…"><a href="#2-2-Dockerå®‰è£…" class="headerlink" title="2.2 Dockerå®‰è£…"></a>2.2 Dockerå®‰è£…</h3><pre><code class="shell"># æ‹‰å–é•œåƒ
$ docker pull zookeeper:3.4.14
# å¯åŠ¨æœåŠ¡
$ docker run -d -p 2181:2181 -d --name zookeeper zookeeper:3.4.14</code></pre>
<h2 id="3-Zookeeperæ•°æ®æ¨¡å‹"><a href="#3-Zookeeperæ•°æ®æ¨¡å‹" class="headerlink" title="3. Zookeeperæ•°æ®æ¨¡å‹"></a>3. Zookeeperæ•°æ®æ¨¡å‹</h2><h3 id="3-1-æ¨¡å‹ç»“æ„"><a href="#3-1-æ¨¡å‹ç»“æ„" class="headerlink" title="3.1 æ¨¡å‹ç»“æ„"></a>3.1 æ¨¡å‹ç»“æ„</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/7340/structure.jpg" class="" title="structure">

<br>

<h3 id="3-2-æ¨¡å‹ç‰¹ç‚¹"><a href="#3-2-æ¨¡å‹ç‰¹ç‚¹" class="headerlink" title="3.2 æ¨¡å‹ç‰¹ç‚¹"></a>3.2 æ¨¡å‹ç‰¹ç‚¹</h3><ul>
<li>æ¯ä¸ªå­ç›®å½•å¦‚/app1éƒ½è¢«ç§°ä½œä¸€ä¸ªznode(èŠ‚ç‚¹)ï¼Œè¿™ä¸ªznodeæ˜¯è¢«å®ƒæ‰€åœ¨çš„è·¯å¾„å”¯ä¸€æ ‡è¯†</li>
<li>znodeå¯ä»¥æœ‰å­èŠ‚ç‚¹ç›®å½•ï¼Œå¹¶ä¸”æ¯ä¸ªznodeå¯ä»¥å­˜å‚¨æ•°æ®</li>
<li>znodeæ˜¯æœ‰ç‰ˆæœ¬çš„ï¼Œæ¯ä¸ªznodeä¸­å­˜å‚¨çš„æ•°æ®å¯ä»¥æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè®¿é—®è·¯å¾„ä¸­å¯ä»¥å­˜å‚¨å¤šä»½æ•°æ®</li>
<li>znodeå¯ä»¥è¢«ç›‘æ§ï¼ŒåŒ…æ‹¬è¿™ä¸ªç›®å½•ä¸­å­˜å‚¨çš„æ•°æ®ä¿®æ”¹ï¼Œå­èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–ç­‰ï¼Œä¸€æ—¦å˜åŒ–å¯ä»¥é€šçŸ¥è®¾ç½®ç›‘æ§çš„å®¢æˆ·ç«¯</li>
</ul>
<h3 id="3-3-èŠ‚ç‚¹åˆ†ç±»"><a href="#3-3-èŠ‚ç‚¹åˆ†ç±»" class="headerlink" title="3.3 èŠ‚ç‚¹åˆ†ç±»"></a>3.3 èŠ‚ç‚¹åˆ†ç±»</h3><p>ï¼ˆ1ï¼‰æŒä¹…èŠ‚ç‚¹ï¼ˆPERSISTENTï¼‰</p>
<p>æ˜¯æŒ‡åœ¨èŠ‚ç‚¹åˆ›å»ºåï¼Œå°±ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°æœ‰åˆ é™¤æ“ä½œæ¥ä¸»åŠ¨åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹â€”â€”ä¸ä¼šå› ä¸ºåˆ›å»ºè¯¥èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆè€Œæ¶ˆå¤±ã€‚</p>
<p>ï¼ˆ2ï¼‰æŒä¹…é¡ºåºèŠ‚ç‚¹ï¼ˆPERSISTENT_SEQUENTIALï¼‰</p>
<p>è¿™ç±»èŠ‚ç‚¹çš„åŸºæœ¬ç‰¹æ€§å’Œä¸Šé¢çš„èŠ‚ç‚¹ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚é¢å¤–çš„ç‰¹æ€§æ˜¯ï¼Œåœ¨ZKä¸­ï¼Œæ¯ä¸ªçˆ¶èŠ‚ç‚¹ä¼šä¸ºå®ƒçš„ç¬¬ä¸€çº§å­èŠ‚ç‚¹ç»´æŠ¤ä¸€ä»½æ—¶åºï¼Œä¼šè®°å½•æ¯ä¸ªå­èŠ‚ç‚¹åˆ›å»ºçš„å…ˆåé¡ºåºã€‚åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œåœ¨åˆ›å»ºå­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¯ä»¥è®¾ç½®è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºèŠ‚ç‚¹è¿‡ç¨‹ä¸­ï¼ŒZKä¼šè‡ªåŠ¨ä¸ºç»™å®šèŠ‚ç‚¹ååŠ ä¸Šä¸€ä¸ªæ•°å­—åç¼€ï¼Œä½œä¸ºæ–°çš„èŠ‚ç‚¹åã€‚è¿™ä¸ªæ•°å­—åç¼€çš„èŒƒå›´æ˜¯æ•´å½¢çš„æœ€å¤§å€¼ã€‚</p>
<p>ï¼ˆ3ï¼‰ä¸´æ—¶èŠ‚ç‚¹ï¼ˆEPHEMERALï¼‰</p>
<p>å’ŒæŒä¹…åŒ–èŠ‚ç‚¹ä¸åŒçš„æ˜¯ï¼Œä¸´æ—¶èŠ‚ç‚¹çš„ç”Ÿå‘½å‘¨æœŸå’Œå®¢æˆ·ç«¯ä¼šè¯ç»‘å®šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹å°±ä¼šè‡ªåŠ¨è¢«æ¸…é™¤æ‰ã€‚æ³¨æ„ï¼Œè¿™é‡Œæåˆ°çš„æ˜¯ä¼šè¯å¤±æ•ˆï¼Œè€Œéè¿æ¥æ–­å¼€ã€‚å¦å¤–ï¼Œåœ¨ä¸´æ—¶èŠ‚ç‚¹ä¸‹é¢ä¸èƒ½åˆ›å»ºå­èŠ‚ç‚¹ã€‚</p>
<p>ï¼ˆ4ï¼‰ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼ˆEPHEMERAL SEQUETIALï¼‰</p>
<p>å…·æœ‰ä¸´æ—¶èŠ‚ç‚¹ç‰¹ç‚¹ï¼Œé¢å¤–çš„ç‰¹æ€§æ˜¯ï¼Œæ¯ä¸ªçˆ¶èŠ‚ç‚¹ä¼šä¸ºå®ƒçš„ç¬¬ä¸€çº§å­èŠ‚ç‚¹ç»´æŠ¤ä¸€ä»½æ—¶åºï¼Œè¿™ç‚¹å’Œåˆšæ‰æåˆ°çš„æŒä¹…é¡ºåºèŠ‚ç‚¹ç±»ä¼¼ã€‚</p>
<h2 id="4-zookeeperé…ç½®æ–‡ä»¶"><a href="#4-zookeeperé…ç½®æ–‡ä»¶" class="headerlink" title="4. zookeeperé…ç½®æ–‡ä»¶"></a>4. zookeeperé…ç½®æ–‡ä»¶</h2><h3 id="4-1-zoo-cfg"><a href="#4-1-zoo-cfg" class="headerlink" title="4.1 zoo.cfg"></a>4.1 zoo.cfg</h3><pre><code># The number of milliseconds of each tick
tickTime=2000
# The number of ticks that the initial 
# synchronization phase can take
initLimit=10
# The number of ticks that can pass between 
# sending a request and getting an acknowledgement
syncLimit=5
# the directory where the snapshot is stored.
# do not use /tmp for storage, /tmp here is just 
# example sakes.
dataDir=/tmp/zookeeper
# the port at which the clients will connect
clientPort=2181
# the maximum number of client connections.
# increase this if you need to handle more clients
#maxClientCnxns=60

# Be sure to read the maintenance section of the 
# administrator guide before turning on autopurge.
# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance
# The number of snapshots to retain in dataDir
#autopurge.snapRetainCount=3
# Purge task interval in hours
# Set to &quot;0&quot; to disable auto purge feature
#autopurge.purgeInterval=1

## Metrics Providers
# https://prometheus.io Metrics Exporter
#metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
#metricsProvider.httpHost=0.0.0.0
#metricsProvider.httpPort=7000
#metricsProvider.exportJvmInfo=true</code></pre>
<h3 id="4-2-å‚æ•°è¯´æ˜"><a href="#4-2-å‚æ•°è¯´æ˜" class="headerlink" title="4.2 å‚æ•°è¯´æ˜"></a>4.2 å‚æ•°è¯´æ˜</h3><table>
<thead>
<tr>
<th>å‚æ•°</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>tickTime</td>
<td align="left">é›†ç¾¤æœåŠ¡å™¨èŠ‚ç‚¹ä¹‹é—´æˆ–è€…æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´ç»´æŒå¿ƒè·³çš„æ—¶é—´é—´éš”ï¼Œå³æ¯éš”tickTimeä¼šå‘ç”Ÿå¿ƒè·³åŒ…ï¼Œæ—¶é—´å•ä½ä¸ºmsï¼Œå¹¶ä¸”æœ€å°sessionè¶…æ—¶æ—¶é—´ä¸º2 * tickTimeã€‚</td>
</tr>
<tr>
<td>initLimit</td>
<td align="left">åˆå§‹åŒ–é›†ç¾¤æ—¶Leaderä¸Followerä¹‹é—´çš„æœ€å¤šå¿ƒè·³æ•°ï¼Œé™å®šFollowerè¿æ¥åˆ°Leaderçš„æ—¶é™ä¸ºinitLimit * tickTimeã€‚</td>
</tr>
<tr>
<td>syncLimit</td>
<td align="left">é›†ç¾¤è¿è¡Œæ—¶Leaderä¸Followerä¹‹é—´åŒæ­¥çš„æœ€å¤§å“åº”æ—¶é—´å•ä½ï¼Œå³å“åº”æ—¶é—´è¶…è¿‡syncLimit * tickTimeï¼ŒLeaderè®¤ä¸ºFolloweræ­»äº¡ï¼Œä»æœåŠ¡å™¨åˆ—è¡¨åˆ é™¤Followerã€‚</td>
</tr>
<tr>
<td>dataDir</td>
<td align="left">æ•°æ®å­˜å‚¨ä½ç½®ã€‚</td>
</tr>
<tr>
<td>clientPort</td>
<td align="left">æœåŠ¡ç›‘å¬ç«¯å£ã€‚</td>
</tr>
<tr>
<td>maxClientCnxns</td>
<td align="left">æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°é‡ã€‚</td>
</tr>
<tr>
<td>autopurge.snapRetainCount</td>
<td align="left">å¿«ç…§ä¿å­˜æ•°é‡ï¼Œåˆ°è¾¾è¿™ä¸ªæ•°é‡è‡ªåŠ¨è¿›è¡Œå¿«ç…§åˆå¹¶ã€‚</td>
</tr>
<tr>
<td>autopurge.purgeInterval</td>
<td align="left">å¿«ç…§æ¸…ç†é¢‘ç‡ï¼Œå•ä½ä¸ºå°æ—¶ï¼Œå³è¿™ä¸ªæ—¶é—´é—´éš”å†…å¿«ç…§æ•°é‡åˆ°è¾¾ä¸Šè¿°æŒ‡å®šæ•°é‡ï¼Œå°±è¿›è¡Œå¿«ç…§åˆå¹¶ã€‚</td>
</tr>
</tbody></table>
<h2 id="5-ZooKeeperåŸºæœ¬æŒ‡ä»¤"><a href="#5-ZooKeeperåŸºæœ¬æŒ‡ä»¤" class="headerlink" title="5. ZooKeeperåŸºæœ¬æŒ‡ä»¤"></a>5. ZooKeeperåŸºæœ¬æŒ‡ä»¤</h2><blockquote>
<p>è¿›å…¥dockerå†…éƒ¨å®¢æˆ·ç«¯</p>
</blockquote>
<pre><code class="shell">$ docker exec -it zookeeper bash
$ ./bin/zkCli.sh</code></pre>
<h3 id="5-1-åŸºæœ¬æŒ‡ä»¤"><a href="#5-1-åŸºæœ¬æŒ‡ä»¤" class="headerlink" title="5.1 åŸºæœ¬æŒ‡ä»¤"></a>5.1 åŸºæœ¬æŒ‡ä»¤</h3><pre><code class="shell">$ ls path                 # æŸ¥çœ‹ç‰¹å®šèŠ‚ç‚¹ä¸‹é¢çš„å­èŠ‚ç‚¹

$ create path data        # åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ç»™èŠ‚ç‚¹ç»‘å®šæ•°æ®ï¼ˆé»˜è®¤æ˜¯æŒä¹…æ€§èŠ‚ç‚¹ï¼‰
$ create -s path data     # åˆ›å»ºæŒä¹…æ€§é¡ºåºèŠ‚ç‚¹
$ create -e path data     # åˆ›å»ºä¸´æ—¶æ€§èŠ‚ç‚¹ï¼ˆä¸´æ—¶æ€§èŠ‚ç‚¹ä¸èƒ½å«æœ‰ä»»ä½•å­èŠ‚ç‚¹ï¼‰
$ create -e -s path data  # åˆ›å»ºä¸´æ—¶æ€§é¡ºåºèŠ‚ç‚¹ï¼ˆä¸´æ—¶æ€§èŠ‚ç‚¹ä¸èƒ½å«æœ‰ä»»ä½•å­èŠ‚ç‚¹ï¼‰

$ stat path               # æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
$ set path data           # ä¿®æ”¹èŠ‚ç‚¹æ•°æ®
$ ls2 path                # æŸ¥çœ‹èŠ‚ç‚¹ä¸‹å­©å­å’Œå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€
$ history                 # æŸ¥çœ‹æ“ä½œå†å²
$ get path                # è·å¾—èŠ‚ç‚¹ä¸Šç»‘å®šçš„æ•°æ®ä¿¡æ¯
$ delete path             # åˆ é™¤èŠ‚ç‚¹ï¼ˆåˆ é™¤èŠ‚ç‚¹ä¸èƒ½å«æœ‰å­èŠ‚ç‚¹ï¼‰
$ rmr path                # é€’å½’åˆ é™¤èŠ‚ç‚¹ï¼ˆä¼šå°†å½“å‰èŠ‚ç‚¹ä¸‹æ‰€æœ‰èŠ‚ç‚¹åˆ é™¤ï¼‰
$ quit                    # é€€å‡ºå½“å‰ä¼šè¯</code></pre>
<h3 id="5-2-statç»“æœè¯¦è§£"><a href="#5-2-statç»“æœè¯¦è§£" class="headerlink" title="5.2 statç»“æœè¯¦è§£"></a>5.2 statç»“æœè¯¦è§£</h3><pre><code>1) czxid - åˆ›å»ºèŠ‚ç‚¹çš„äº‹åŠ¡çš„zxid
2) ctime - åˆ›å»ºèŠ‚ç‚¹çš„æ¯«ç§’æ•°(ä»1970å¹´å¼€å§‹)
3) mzxid - æ›´æ–°èŠ‚ç‚¹çš„äº‹åŠ¡zxid
4) mtime - æœ€åæ›´æ–°çš„æ¯«ç§’æ•°(ä»1970å¹´å¼€å§‹)
5) pZxid - æœ€åæ›´æ–°å­èŠ‚ç‚¹çš„äº‹åŠ¡zxid
6) cversion - å­èŠ‚ç‚¹å˜åŒ–å·ï¼Œå­èŠ‚ç‚¹ä¿®æ”¹æ¬¡æ•°
7) dataversion - æ•°æ®å˜åŒ–å·
8) aclVersion - è®¿é—®æ§åˆ¶åˆ—è¡¨çš„å˜åŒ–å·
9) ephemeralOwner - å¦‚æœæ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ˜¯znodeæ‹¥æœ‰è€…çš„session idï¼›å¦‚æœä¸æ˜¯ä¸´æ—¶èŠ‚ç‚¹åˆ™æ˜¯0
10) dataLength - æ•°æ®é•¿åº¦
11) numChildren - å­èŠ‚ç‚¹æ•°é‡</code></pre>
<h3 id="5-3-èŠ‚ç‚¹ç›‘å¬æœºåˆ¶"><a href="#5-3-èŠ‚ç‚¹ç›‘å¬æœºåˆ¶" class="headerlink" title="5.3 èŠ‚ç‚¹ç›‘å¬æœºåˆ¶"></a>5.3 èŠ‚ç‚¹ç›‘å¬æœºåˆ¶</h3><p>å®¢æˆ·ç«¯å¯ä»¥ç›‘æµ‹znodeèŠ‚ç‚¹çš„å˜åŒ–ï¼Œ<strong>znodeèŠ‚ç‚¹çš„å˜åŒ–è§¦å‘ç›¸åº”çš„äº‹ä»¶ï¼Œç„¶åæ¸…é™¤å¯¹è¯¥èŠ‚ç‚¹çš„ç›‘æµ‹</strong>ã€‚å½“ç›‘æµ‹ä¸€ä¸ªznodeèŠ‚ç‚¹æ—¶å€™ï¼Œzookeeperä¼šå‘é€é€šçŸ¥ç»™ç›‘æµ‹èŠ‚ç‚¹ã€‚ä¸€ä¸ªwatchäº‹ä»¶æ˜¯ä¸€ä¸ªä¸€æ¬¡æ€§çš„è§¦å‘å™¨ï¼Œå½“è¢«è®¾ç½®äº†watchçš„æ•°æ®è·å–ç›®å½•å‘ç”Ÿäº†æ”¹å˜çš„æ—¶å€™ï¼Œåˆ™æœåŠ¡å™¨å°†è¿™ä¸ªæ”¹å˜å‘é€ç»™è®¾ç½®äº†watchçš„å®¢æˆ·ç«¯ä»¥ä¾¿é€šçŸ¥å®ƒä»¬ã€‚</p>
<pre><code class="shell">$ ls /path true            # ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–
$ get /path true           # ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–</code></pre>
<h2 id="6-Zookeeperé›†ç¾¤æ­å»º"><a href="#6-Zookeeperé›†ç¾¤æ­å»º" class="headerlink" title="6. Zookeeperé›†ç¾¤æ­å»º"></a>6. Zookeeperé›†ç¾¤æ­å»º</h2><h3 id="6-1-dockeræ­å»ºä¼ªé›†ç¾¤"><a href="#6-1-dockeræ­å»ºä¼ªé›†ç¾¤" class="headerlink" title="6.1 dockeræ­å»ºä¼ªé›†ç¾¤"></a>6.1 dockeræ­å»ºä¼ªé›†ç¾¤</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/7340/cluster.jpg" class="" title="cluster">

<pre><code class="shell"># æŸ¥çœ‹æœ€å°å®¹å™¨ip
$ docker network inspect bridge
# åˆ›å»ºä¸‰ä¸ªzkçš„ipåˆ†åˆ«åœ¨è¿™ä¸ªæœ€å°çš„ipä¸ŠåŠ ä¸Š1ï¼Œ2ï¼Œ3
# zk1: 172.17.0.7
# zk2: 172.17.0.8
# zk3: 172.17.0.9

# åˆ›å»ºé›†ç¾¤çš„æŒ‚è½½ç›®å½•
$ mkdir -p /opt/zookeeper/cluster/
# åˆ›å»ºé…ç½®å’Œæ•°æ®ç›®å½•
$ mkdir -p node1/conf node1/data node2/conf node2/data node3/conf node3/data
# åˆ›å»ºé…ç½®æ–‡ä»¶å’Œmyid
$ touch node1/conf/zoo.cfg node2/conf/zoo.cfg node3/conf/zoo.cfg node1/data/myid node2/data/myid node3/data/myid
# ç¼–è¾‘é…ç½®æ–‡ä»¶
# ä¸‰ä¸ªæ–‡ä»¶ç›¸åŒï¼Œå†…å®¹å¦‚ä¸‹
dataDir=/data
dataLogDir=/data/log
tickTime=2000
initLimit=5
syncLimit=2
autopurge.snapRetainCount=3
autopurge.purgeInterval=0
maxClientCnxns=60
standaloneEnabled=true
admin.enableServer=true
4lw.commands.whitelist=*
clientPort=2181
server.1=172.17.0.7:2888:3888
server.2=172.17.0.8:2888:3888
server.3=172.17.0.9:2888:3888
# ç¼–è¾‘myid
$ echo &quot;1&quot; &gt;&gt; node1/data/myid
$ echo &quot;2&quot; &gt;&gt; node2/data/myid
$ echo &quot;3&quot; &gt;&gt; node3/data/myid

# å¯åŠ¨ä¸‰ä¸ªå®¹å™¨
$ docker run -d -p 2182:2181 -v /opt/zookeeper/cluster/node1/conf:/conf -v /opt/zookeeper/cluster/node1/data:/data --name zk1 zookeeper:3.4.14
$ docker run -d -p 2183:2181 -v /opt/zookeeper/cluster/node2/conf:/conf -v /opt/zookeeper/cluster/node2/data:/data --name zk2 zookeeper:3.4.14
$ docker run -d -p 2184:2181 -v /opt/zookeeper/cluster/node3/conf:/conf -v /opt/zookeeper/cluster/node3/data:/data --name zk3 zookeeper:3.4.14</code></pre>
<h3 id="6-2-æŸ¥çœ‹èŠ‚ç‚¹znodeçŠ¶æ€"><a href="#6-2-æŸ¥çœ‹èŠ‚ç‚¹znodeçŠ¶æ€" class="headerlink" title="6.2 æŸ¥çœ‹èŠ‚ç‚¹znodeçŠ¶æ€"></a>6.2 æŸ¥çœ‹èŠ‚ç‚¹znodeçŠ¶æ€</h3><pre><code class="shell">$ docker exec -it zk&lt;i&gt; bash
$ ./bin/zkServer.sh status

# zk1
ZooKeeper JMX enabled by default
Using config: /conf/zoo.cfg
Mode: follower
# zk2
ZooKeeper JMX enabled by default
Using config: /conf/zoo.cfg
Mode: follower
# zk3
ZooKeeper JMX enabled by default
Using config: /conf/zoo.cfg
Mode: leader</code></pre>
<p>å¯ä»¥çœ‹åˆ°leaderç»“ç‚¹ä¸ºzk3ï¼Œzk1å’Œzk2ä¸ºfollowerèŠ‚ç‚¹ã€‚</p>
<h2 id="7-Javaå®¢æˆ·ç«¯æ“ä½œ"><a href="#7-Javaå®¢æˆ·ç«¯æ“ä½œ" class="headerlink" title="7. Javaå®¢æˆ·ç«¯æ“ä½œ"></a>7. Javaå®¢æˆ·ç«¯æ“ä½œ</h2><h3 id="7-1-å¼•å…¥ä¾èµ–"><a href="#7-1-å¼•å…¥ä¾èµ–" class="headerlink" title="7.1 å¼•å…¥ä¾èµ–"></a>7.1 å¼•å…¥ä¾èµ–</h3><pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;com.101tec&lt;/groupId&gt;
    &lt;artifactId&gt;zkclient&lt;/artifactId&gt;
    &lt;version&gt;0.10&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;junit&lt;/groupId&gt;
    &lt;artifactId&gt;junit&lt;/artifactId&gt;
    &lt;version&gt;4.12&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
<h3 id="7-2-æ—¥å¿—é…ç½®"><a href="#7-2-æ—¥å¿—é…ç½®" class="headerlink" title="7.2 æ—¥å¿—é…ç½®"></a>7.2 æ—¥å¿—é…ç½®</h3><pre><code class="properties">log4j.rootLogger = INFO,CONSOLE,FILE,HIGHNESS,

# è¾“å‡ºæ—¥å¿—åˆ°æ§åˆ¶å°
log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender
log4j.appender.CONSOLE.Threshold=INFO
log4j.appender.CONSOLE.Target=System.out
log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout
log4j.appender.CONSOLE.layout.ConversionPattern=%-d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; HIGHNESS %-5p [%c] [%t] [%F:%L]- %m%n

# è¾“å‡ºæ—¥å¿—åˆ°æ–‡ä»¶
log4j.appender.FILE=org.apache.log4j.FileAppender
log4j.appender.FILE.File=log/project.log
log4j.appender.FILE.Append=false
log4j.appender.FILE.layout=org.apache.log4j.PatternLayout
log4j.appender.FILE.layout.ConversionPattern=%d HIGHNESS %-5p [%c] - %m%n

# æ¯æ—¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶
log4j.appender.HIGHNESS=org.apache.log4j.DailyRollingFileAppender
# æ—¥å¿—æœ€ä½çš„è¾“å‡ºçº§åˆ«
log4j.appender.HIGHNESS.Threshold=INFO
# æ—¥å¿—æ—¥æœŸæ ¼å¼
log4j.appender.HIGHNESS.DatePattern=&#39;_&#39;yyyy-MM-dd
# æ—¥å¿—ç¼–ç æ ¼å¼
log4j.appender.HIGHNESS.encoding=UTF-8
# æœ‰æ—¥å¿—æ—¶ç«‹å³è¾“å‡º
log4j.appender.HIGHNESS.ImmediateFlush=true
# æ—¥å¿—æ–‡ä»¶çš„ä¿å­˜ä½ç½®åŠæ–‡ä»¶å
log4j.appender.HIGHNESS.File=log/ProjectDaily.log
# æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°
log4j.appender.HIGHNESS.maxFileSize=10KB
# æ—¥å¿—å¸ƒå±€æ–¹å¼
log4j.appender.HIGHNESS.layout=org.apache.log4j.PatternLayout
# æ—¥å¿—æ–‡ä»¶ä¸­æ—¥å¿—çš„æ ¼å¼
log4j.appender.HIGHNESS.layout.ConversionPattern=%-d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; HIGHNESS %-5p [%c]- %m%n</code></pre>
<h3 id="7-3-æ­å»ºå®¢æˆ·ç«¯"><a href="#7-3-æ­å»ºå®¢æˆ·ç«¯" class="headerlink" title="7.3 æ­å»ºå®¢æˆ·ç«¯"></a>7.3 æ­å»ºå®¢æˆ·ç«¯</h3><pre><code class="java">private final Logger log = LoggerFactory.getLogger(ZKClient.class);
private ZkClient zkClient;

@Before
public void before() &#123;
    // æœåŠ¡å™¨ip:port
    // ä¼šè¯è¶…æ—¶æ—¶é—´
    // è¿æ¥è¶…æ—¶æ—¶é—´
    // åºåˆ—åŒ–æ–¹å¼
    zkClient = new ZkClient(&quot;192.168.117.155:2181&quot;, 6000 * 30, 6000, new SerializableSerializer());
&#125;

@After
public void close() &#123;
    zkClient.close();
&#125;

private static class User implements Serializable &#123;
    private final Integer id;
    private final String name;
    public User(Integer id, String name) &#123;
        this.id = id;
        this.name = name;
    &#125;
    @Override
    public String toString() &#123;
        return &quot;User&#123;&quot; + &quot;id=&quot; + id + &quot;, name=&#39;&quot; + name + &#39;\&#39;&#39; + &#39;&#125;&#39;;
    &#125;
&#125;</code></pre>
<h3 id="7-4-åˆ›å»ºèŠ‚ç‚¹"><a href="#7-4-åˆ›å»ºèŠ‚ç‚¹" class="headerlink" title="7.4 åˆ›å»ºèŠ‚ç‚¹"></a>7.4 åˆ›å»ºèŠ‚ç‚¹</h3><pre><code class="java">@Test // åˆ›å»ºèŠ‚ç‚¹
public void create() &#123;
    // 1. æŒä¹…èŠ‚ç‚¹
    String k1 = zkClient.create(&quot;/para1&quot;, &quot;k1&quot;, CreateMode.PERSISTENT);
    log.info(&quot;åˆ›å»ºæŒä¹…èŠ‚ç‚¹: &#123;&#125;&quot;, k1);
    // 2. æŒä¹…é¡ºåºèŠ‚ç‚¹
    String k2 = zkClient.create(&quot;/para2&quot;, &quot;k2&quot;, CreateMode.PERSISTENT_SEQUENTIAL);
    log.info(&quot;åˆ›å»ºæŒä¹…é¡ºåºèŠ‚ç‚¹: &#123;&#125;&quot;, k2);
    // 3. ä¸´æ—¶èŠ‚ç‚¹
    String k3 = zkClient.create(&quot;/para3&quot;, &quot;k3&quot;, CreateMode.EPHEMERAL);
    log.info(&quot;åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹: &#123;&#125;&quot;, k3);
    // 4. ä¸´æ—¶é¡ºåºèŠ‚ç‚¹
    String k4 = zkClient.create(&quot;/para4&quot;, &quot;k4&quot;, CreateMode.EPHEMERAL_SEQUENTIAL);
    log.info(&quot;åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼š&#123;&#125;&quot;,k4);
&#125;</code></pre>
<h3 id="7-5-æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®"><a href="#7-5-æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®" class="headerlink" title="7.5 æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®"></a>7.5 æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®</h3><pre><code class="java">@Test // æŸ¥è¯¢èŠ‚ç‚¹æ•°æ®
public void get() &#123;
    Object data = zkClient.readData(&quot;/para1&quot;);
    log.info(&quot;è¯»å–/para1æ•°æ®ï¼š&#123;&#125;&quot;, data);
&#125;</code></pre>
<h3 id="7-6-æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€"><a href="#7-6-æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="7.6 æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€"></a>7.6 æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€</h3><pre><code class="java">@Test // æŸ¥è¯¢èŠ‚ç‚¹çŠ¶æ€
public void stat() &#123;
    Stat stat = new Stat();
    Object o = zkClient.readData(&quot;/para1&quot;, stat);
    log.info(&quot;èŠ‚ç‚¹/para1çŠ¶æ€ï¼š&#123;&#125;&quot;, stat);
    log.info(&quot;åˆ›å»ºèŠ‚ç‚¹çš„äº‹åŠ¡zxIDï¼š&#123;&#125;&quot;, stat.getCzxid());
    log.info(&quot;åˆ›å»ºæ¯«ç§’æ•°ï¼š&#123;&#125;&quot;, stat.getCtime());
    log.info(&quot;æ›´æ–°èŠ‚ç‚¹çš„äº‹åŠ¡zxIDï¼š&#123;&#125;&quot;, stat.getMzxid());
    log.info(&quot;æ›´æ–°æ¯«ç§’æ•°ï¼š&#123;&#125;&quot;, stat.getMtime());
    log.info(&quot;æ•°æ®é•¿åº¦: &#123;&#125;&quot;, stat.getDataLength());
    log.info(&quot;è®¿é—®æ§åˆ¶åˆ—è¡¨å˜åŒ–å·: &#123;&#125;&quot;, stat.getAversion());
    log.info(&quot;æ›´æ–°å­èŠ‚ç‚¹çš„äº‹åŠ¡zxIDï¼š&#123;&#125;&quot;, stat.getPzxid());
    log.info(&quot;å­èŠ‚ç‚¹çš„ä¿®æ”¹æ¬¡æ•°ï¼š&#123;&#125;&quot;, stat.getCversion());
    log.info(&quot;å­èŠ‚ç‚¹æ•°é‡ï¼š&#123;&#125;&quot;, stat.getNumChildren());
&#125;</code></pre>
<h3 id="7-7-ä¿®æ”¹èŠ‚ç‚¹æ•°æ®"><a href="#7-7-ä¿®æ”¹èŠ‚ç‚¹æ•°æ®" class="headerlink" title="7.7 ä¿®æ”¹èŠ‚ç‚¹æ•°æ®"></a>7.7 ä¿®æ”¹èŠ‚ç‚¹æ•°æ®</h3><pre><code class="java">@Test // ä¿®æ”¹èŠ‚ç‚¹æ•°æ®
public void set() &#123;
    zkClient.writeData(&quot;/para1&quot;, new User(1, &quot;KHighness&quot;));
    User user = zkClient.readData(&quot;/para1&quot;);
    log.info(&quot;ä¿®æ”¹åçš„/para1: &#123;&#125;&quot;, user);
&#125;</code></pre>
<h3 id="7-8-åˆ é™¤èŠ‚ç‚¹"><a href="#7-8-åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="7.8 åˆ é™¤èŠ‚ç‚¹"></a>7.8 åˆ é™¤èŠ‚ç‚¹</h3><pre><code class="java">@Test // åˆ é™¤èŠ‚ç‚¹
public void delete() &#123;
    boolean delete = zkClient.delete(&quot;/para1&quot;);
    log.info(&quot;delete /para1: &#123;&#125;&quot;, delete);
&#125;</code></pre>
<h3 id="7-9-ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–"><a href="#7-9-ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–" class="headerlink" title="7.9 ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–"></a>7.9 ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–</h3><pre><code class="java">@Test // ç›‘å¬èŠ‚ç‚¹æ•°æ®çš„å˜åŒ–ï¼Œéä¸€æ¬¡æ€§ï¼Œæ°¸ä¹…ç›‘å¬
public void getTrue() throws IOException &#123;
    zkClient.subscribeDataChanges(&quot;/para1&quot;, new IZkDataListener() &#123;
        // nodeNameï¼šå½“å‰ä¿®æ”¹èŠ‚ç‚¹çš„åç§°ï¼Œresultï¼šèŠ‚ç‚¹ä¿®æ”¹ä¹‹åçš„æ•°æ®
        public void handleDataChange(String nodeName, Object result) throws Exception &#123;
            log.info(&quot;ä¿®æ”¹èŠ‚ç‚¹çš„åç§°ï¼š&#123;&#125;&quot;, nodeName);
            log.info(&quot;ä¿®æ”¹åèŠ‚ç‚¹æ•°æ®ï¼š&#123;&#125;&quot;, result);
        &#125;
        // nodeNameï¼šå½“å‰ä¿®æ”¹èŠ‚ç‚¹çš„åç§°
        public void handleDataDeleted(String nodeName) throws Exception &#123;
            log.info(&quot;åˆ é™¤èŠ‚ç‚¹çš„åç§°ï¼š&#123;&#125;&quot;, nodeName);
        &#125;
    &#125;);
    // é˜»å¡å®¢æˆ·ç«¯
    System.in.read();
&#125;</code></pre>
<h3 id="7-10-ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–"><a href="#7-10-ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–" class="headerlink" title="7.10 ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–"></a>7.10 ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–</h3><pre><code class="java">@Test // ç›‘å¬èŠ‚ç‚¹ç›®å½•çš„å˜åŒ–ï¼Œéä¸€æ¬¡æ€§ï¼Œæ°¸ä¹…ç›‘å¬
public void lsTrue() throws IOException &#123;
    zkClient.subscribeChildChanges(&quot;/para1&quot;, new IZkChildListener() &#123;
        // nodeNameï¼šå½“å‰ä¿®æ”¹èŠ‚ç‚¹çš„åç§°ï¼Œlistï¼šå‘ç”Ÿä¿®æ”¹çš„æ‰€æœ‰å­èŠ‚ç‚¹åç§°
        public void handleChildChange(String nodeName, List&lt;String&gt; list) throws Exception &#123;
            log.info(&quot;ä¿®æ”¹èŠ‚ç‚¹çš„åç§°ï¼š&#123;&#125;&quot;, nodeName);
            log.info(&quot;å‘ç”Ÿä¿®æ”¹çš„æ‰€æœ‰å­èŠ‚ç‚¹åç§°ï¼š&#123;&#125;&quot;, list.toString());
        &#125;
    &#125;);
    // é˜»å¡å®¢æˆ·ç«¯
    System.in.read();
&#125;</code></pre>
<h3 id="7-11-æ“ä½œé›†ç¾¤"><a href="#7-11-æ“ä½œé›†ç¾¤" class="headerlink" title="7.11 æ“ä½œé›†ç¾¤"></a>7.11 æ“ä½œé›†ç¾¤</h3><pre><code class="java">@Test // é›†ç¾¤æ“ä½œ
public void cluster() &#123;
    // å¯ä»¥å°†æ‰€æœ‰èŠ‚ç‚¹çš„ip:portéƒ½æ”¾å…¥æ„é€ å‡½æ•°ï¼Œä¸­é—´ç”¨é€—å·éš”å¼€ï¼Œä¸è¦åŠ ç©ºæ ¼
    ZkClient cluster = new ZkClient(&quot;192.168.117.155:2182,192.168.117.155:2183,192.168.117.155:2184&quot;);
    Object o = zkClient.readData(&quot;/para1&quot;);
    log.info(&quot;é›†ç¾¤è¯»å–/para1: &#123;&#125;&quot;, o.toString());
&#125;</code></pre>
<hr>
<p>æš‚æ—¶å®Œç»“ï¼Œåé¢åˆ†å¸ƒå¼é”çš„è¯ï¼Œå¾…æ›´~</p>
]]></content>
      <categories>
        <category>åˆ†å¸ƒå¼</category>
      </categories>
      <tags>
        <tag>åˆ†å¸ƒå¼</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ</title>
    <url>/posts/33708/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°"><a href="#1-æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°" class="headerlink" title="1. æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°"></a>1. æ¶ˆæ¯é˜Ÿåˆ—æ¦‚è¿°</h2><h3 id="1-1-å®šä¹‰"><a href="#1-1-å®šä¹‰" class="headerlink" title="1.1 å®šä¹‰"></a>1.1 å®šä¹‰</h3><p>MQ(Message Queue)ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œé€šè¿‡å…¸å‹çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹ï¼Œç”Ÿäº§è€…ä¸æ–­å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä¸æ–­çš„ä»é˜Ÿåˆ—ä¸­ è·å–æ¶ˆæ¯ï¼Œå› ä¸ºæ¶ˆæ¯çš„ç”Ÿäº§å’Œæ¶ˆè´¹éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œè€Œä¸”åªå…³å¿ƒæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶ï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘çš„ä¾µå…¥ï¼Œè½»æ¾çš„å®ç°ç³»ç»Ÿé—´è§£è€¦ï¼Œåˆ«åä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ã€‚é€šè¿‡åˆ©ç”¨é«˜æ•ˆå¯é çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶è¿›è¡Œå¹³å°æ— å…³çš„æ•°æ®äº¤æµï¼Œå¹¶åŸºäºæ•°æ®é€šä¿¡æ¥è¿›è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„é›†æˆã€‚</p>
<h3 id="1-2-åº”ç”¨åœºæ™¯"><a href="#1-2-åº”ç”¨åœºæ™¯" class="headerlink" title="1.2 åº”ç”¨åœºæ™¯"></a>1.2 åº”ç”¨åœºæ™¯</h3><ul>
<li>è·¨ç³»ç»Ÿæ•°æ®ä¼ é€’</li>
<li>é«˜å¹¶å‘æµé‡å‰Šå³°</li>
<li>æ•°æ®åˆ†å‘å’Œå¼‚æ­¥å¤„ç†</li>
<li>å¤§æ•°æ®åˆ†æä¼ é€’</li>
<li>åˆ†å¸ƒå¼äº‹åŠ¡</li>
</ul>
<h3 id="1-3-ä¸»æµä½¿ç”¨"><a href="#1-3-ä¸»æµä½¿ç”¨" class="headerlink" title="1.3 ä¸»æµä½¿ç”¨"></a>1.3 ä¸»æµä½¿ç”¨</h3><ol>
<li>ActiveMQ</li>
</ol>
<p>ActiveMQæ˜¯Apacheå‡ºå“ï¼Œèƒ½åŠ›å¼ºåŠ²çš„å¼€æºæ¶ˆæ¯ç³»ç»Ÿï¼Œå®ƒæ˜¯ä¸€ä¸ªå®Œå…¨æ”¯æŒJMSè§„èŒƒçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¸°å¯Œçš„APIï¼Œå¤šç§é›†ç¾¤æ¶æ„æ¨¡å¼è®©ActiveMQåœ¨ä¸šç•Œæˆä¸ºè€ç‰Œçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œåœ¨ä¸­å°å‹ä¼ä¸šé¢‡å—æ¬¢è¿ã€‚</p>
<ol start="2">
<li>Kafka</li>
</ol>
<p>Kafkaæ˜¯LinkedInå¼€æºçš„åˆ†å¸ƒå¼å‘å¸ƒ-è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿï¼Œç›®å‰å½’å±äºApacheé¡¶çº§é¡¹ç›®ã€‚Kafkaä¸»è¦ç‰¹ç‚¹æ˜¯åŸºäºPullçš„æ¨¡å¼æ¥å¤„ç†æ¶ˆæ¯æ¶ˆè´¹ï¼Œè¿½æ±‚é«˜ååé‡ï¼Œä¸€å¼€å§‹çš„ç›®çš„å°±æ˜¯ç”¨äºæ—¥å¿—æ”¶é›†å’Œä¼ è¾“ã€‚0.8ç‰ˆæœ¬å¼€å§‹æ”¯æŒå¤åˆ¶ï¼Œä¸æ”¯æŒäº‹åŠ¡ï¼Œå¯¹æ¶ˆæ¯çš„é‡å¤ã€ä¸¢å¤±ã€é”™è¯¯æ²¡æœ‰ä¸¥æ ¼è¦æ±‚ï¼Œé€‚åˆäº§ç”Ÿå¤§é‡æ•°æ®çš„äº’è”ç½‘æœåŠ¡çš„æ•°æ®æ”¶é›†ä¸šåŠ¡ã€‚</p>
<ol start="3">
<li>RocketMQ</li>
</ol>
<p>RocketMQæ˜¯é˜¿é‡Œå¼€æºçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå®ƒæ˜¯çº¯Javaå¼€å‘ï¼Œå…·æœ‰é«˜ååé‡ã€é«˜å¯ç”¨æ€§ã€é€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿåº”ç”¨çš„ç‰¹ç‚¹ã€‚RocketMQæ€è·¯èµ·æºäºKafkaï¼Œä½†å¹¶ä¸æ˜¯Kafkaçš„ä¸€ä¸ªCopyï¼Œå®ƒå¯¹æ¶ˆæ¯å’Œå¯é ä¼ è¾“åŠäº‹åŠ¡æ€§åšäº†ä¼˜åŒ–ï¼Œç›®å‰åœ¨é˜¿é‡Œé›†å›¢å¹¿æ³›åº”ç”¨äºäº¤æ˜“ã€å……å€¼ã€æµè®¡ç®—ã€æ¶ˆæ¯æ¨é€ã€æ—¥å¿—æµå¼å¤„ç†ã€binglogåˆ†å‘ç­‰åœºæ™¯ã€‚</p>
<ol start="4">
<li>RabbitMQ</li>
</ol>
<p>RabbitMQæ˜¯ä½¿ç”¨Erlangè¯­è¨€å¼€å‘çš„å¼€æºæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ŒåŸºäºAMQPåè®®æ¥å®ç°ã€‚AMQPçš„ä¸»è¦ç‰¹å¾æ˜¯é¢å‘æ¶ˆæ¯ã€é˜Ÿåˆ—ã€è·¯ç”±ï¼ˆåŒ…æ‹¬ç‚¹å¯¹ç‚¹å’Œå‘å¸ƒ/è®¢é˜…ï¼‰ã€å¯é æ€§ã€å®‰å…¨ã€AMQPåè®®æ›´å¤šç”¨åœ¨ä¼ä¸šç³»ç»Ÿå†…å¯¹æ•°æ®ä¸€è‡´æ€§ã€ç¨³å®šæ€§å’Œå¯é æ€§è¦æ±‚å¾ˆé«˜çš„åœºæ™¯ï¼Œå¯¹æ€§èƒ½å’Œååé‡çš„è¦æ±‚è¿˜åœ¨å…¶æ¬¡ã€‚</p>
<h2 id="2-æ¶ˆæ¯é˜Ÿåˆ—åè®®"><a href="#2-æ¶ˆæ¯é˜Ÿåˆ—åè®®" class="headerlink" title="2. æ¶ˆæ¯é˜Ÿåˆ—åè®®"></a>2. æ¶ˆæ¯é˜Ÿåˆ—åè®®</h2><h3 id="2-1-AMQPåè®®"><a href="#2-1-AMQPåè®®" class="headerlink" title="2.1 AMQPåè®®"></a>2.1 AMQPåè®®</h3><p>AMQP(Advanced Message Queuing Protocol)æ˜¯æåŸºæ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œç”±æ‘©æ ¹å¤§é€šé›†å›¢è¿æ¥å…¶ä»–å…¬å¸å…±åŒè®¾è®¡ï¼Œæ˜¯ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯å’Œæ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ã€ä¸åŒçš„å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶ã€‚</p>
<h3 id="2-2-MQTTåè®®"><a href="#2-2-MQTTåè®®" class="headerlink" title="2.2 MQTTåè®®"></a>2.2 MQTTåè®®</h3><p>MQTT(Meesgae Queuing Telemetry Transport)æ¶ˆæ¯é˜Ÿåˆ—æ˜¯IBMå¼€æ”¾çš„ä¸€ä¸ªå³æ—¶é€šè®¯åè®®ï¼Œç‰©è”ç½‘ç³»ç»Ÿæ¶æ„ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚</p>
<h3 id="2-3-OpenMeesageåè®®"><a href="#2-3-OpenMeesageåè®®" class="headerlink" title="2.3 OpenMeesageåè®®"></a>2.3 OpenMeesageåè®®</h3><p>è¿‘å‡ å¹´ç”±é˜¿é‡Œå·´å·´ã€é›…è™å’Œæ»´æ»´å‡ºè¡Œã€Stremalioç­‰å…¬å¸å…±åŒå‚ä¸åˆ›ç«‹çš„åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶ã€æµå¤„ç†ç­‰é¢†åŸŸçš„åº”ç”¨å¼€å‘æ ‡å‡†ã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨httpåè®®ï¼Ÿ</p>
</blockquote>
<p>ï¼ˆ1ï¼‰å› ä¸ºhttpè¯·æ±‚æŠ¥æ–‡å¤´å’Œå“åº”æŠ¥æ–‡å¤´æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼ŒåŒ…å«äº†cookieã€æ•°æ®çš„åŠ å¯†è§£å¯†ã€çŠ¶æ€ç ç­‰é™„åŠ åŠŸèƒ½ï¼Œä½†æ˜¯å¯¹äºä¸€ä¸ªæ¶ˆæ¯è€Œè¨€ï¼Œå¹¶ä¸éœ€è¦è¿™ä¹ˆå¤æ‚ï¼Œåªéœ€è¦æ•°æ®ä¼ é€’ã€å­˜å‚¨å’Œåˆ†å‘å°±è¡Œï¼Œè¿½æ±‚çš„æ˜¯é«˜æ€§èƒ½ï¼Œå°½é‡ç®€æ´å’Œå¿«é€Ÿã€‚</p>
<p>ï¼ˆ2ï¼‰å¤§éƒ¨åˆ†æƒ…å†µä¸‹httpæ˜¯çŸ­è¿æ¥ï¼Œåœ¨å®é™…çš„äº¤äº’è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚åˆ°å“åº”å¾ˆæœ‰å¯èƒ½ä¼šä¸­æ–­ï¼Œä¸­æ–­ä»¥åå°±ä¸ä¼šè¿›è¡ŒæŒä¹…åŒ–ï¼Œå°±ä¼šé€ æˆè¯·æ±‚çš„ä¸¢å¤±ã€‚è¿™æ ·å°±ä¸åˆ©äºæ¶ˆæ¯ä¸­é—´ä»¶çš„ä¸šåŠ¡åœºæ™¯ï¼Œå› ä¸ºæ¶ˆæ¯ä¸­é—´ä»¶å¯èƒ½æ˜¯ä¸€ä¸ªé•¿æœŸçš„è·å–æ¶ˆæ¯çš„è¿‡ç¨‹ï¼Œå‡ºç°é—®é¢˜å’Œæ•…éšœè¦å¯¹æ•°æ®æˆ–æ¶ˆæ¯è¿›è¡ŒæŒä¹…åŒ–ç­‰ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ¶ˆæ¯å’Œæ•°æ®çš„é«˜å¯é å’Œç¨³å¥çš„è¿è¡Œã€‚</p>
<h2 id="3-RabbitMQå®‰è£…"><a href="#3-RabbitMQå®‰è£…" class="headerlink" title="3. RabbitMQå®‰è£…"></a>3. RabbitMQå®‰è£…</h2><p>å®‰è£…åŸç”Ÿçš„RabbitMQéœ€è¦erlangç¯å¢ƒï¼Œæ‡’å¾—è£…äº†ã€‚</p>
<h3 id="3-1-dockerå®‰è£…"><a href="#3-1-dockerå®‰è£…" class="headerlink" title="3.1 dockerå®‰è£…"></a>3.1 dockerå®‰è£…</h3><pre><code class="shell"># æŒ‚è½½ç›®å½•
$ mkdir -p /home/rabbitmq/data

# å¯åŠ¨å®¹å™¨
$ docker run -d --name rabbitmq \
-p 5672:5672 -p 15672:15672 \
-v /home/rabbitmq/data:/var/lib/rabbitmq \
-e RABBITMQ_DEFAULT_USER=Khighness \
-e RABBITMQ_DEFAULT_PASS=KAG1823 \
rabbitmq

# æŸ¥çœ‹æ’ä»¶
$ rabbitmq-plugins list
# å¯ç”¨|ç¦ç”¨æ’ä»¶
$ rabbitmq-plugins enable | disable &lt;plugin&gt;</code></pre>
<h3 id="3-2-webç®¡ç†"><a href="#3-2-webç®¡ç†" class="headerlink" title="3.2 webç®¡ç†"></a>3.2 webç®¡ç†</h3><pre><code class="shell">$ docker exec -it rabbitmq bash
$ rabbitmq-plugins enable rabbitmq_management</code></pre>
<p>ç™»å½•ç”¨æˆ·åå’Œå¯†ç å³ä¸º<code>RABBITMQ_DEFAULT_USER</code>å’Œ<code>RABBITMQ_DEFAULT_PASS</code>ã€‚</p>
<h2 id="4-RabbitMQæ¶ˆæ¯æ¨¡å‹"><a href="#4-RabbitMQæ¶ˆæ¯æ¨¡å‹" class="headerlink" title="4. RabbitMQæ¶ˆæ¯æ¨¡å‹"></a>4. RabbitMQæ¶ˆæ¯æ¨¡å‹</h2><blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
</blockquote>
<p>MQå‡†å¤‡ï¼š</p>
<p>åˆ›å»ºç”¨æˆ·ï¼ˆUsernameï¼‰<code>parak</code>ï¼Œå¯†ç ï¼ˆPasswordï¼‰<code>123456</code>ï¼Œåˆ›å»ºè™šæ‹Ÿä¸»æœºï¼ˆvistual hostsï¼‰<code>/learn</code>ã€‚</p>
<p>å¼•å…¥ä¾èµ–ï¼š</p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt;
        &lt;artifactId&gt;amqp-client&lt;/artifactId&gt;
        &lt;version&gt;5.7.3&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;version&gt;4.13&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
        &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
        &lt;version&gt;1.1.2&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
<p>æ—¥å¿—é…ç½®ï¼š</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration debug=&quot;false&quot;&gt;
    &lt;property name=&quot;LOG_HOME&quot; value=&quot;log/&quot; /&gt;

    &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
            &lt;FileNamePattern&gt;$&#123;LOG_HOME&#125;/rabbitmq.%d&#123;yyyy-MM-dd&#125;.log&lt;/FileNamePattern&gt;
            &lt;MaxHistory&gt;30&lt;/MaxHistory&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
        &lt;triggeringPolicy class=&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;&gt;
            &lt;MaxFileSize&gt;10MB&lt;/MaxFileSize&gt;
        &lt;/triggeringPolicy&gt;
    &lt;/appender&gt;

    &lt;root level=&quot;DEBUG&quot;&gt;
        &lt;appender-ref ref=&quot;STDOUT&quot; /&gt;
        &lt;appender-ref ref=&quot;FILE&quot;/&gt;
    &lt;/root&gt;

&lt;/configuration&gt;</code></pre>
<h3 id="4-1-Hello-Worldæ¨¡å‹"><a href="#4-1-Hello-Worldæ¨¡å‹" class="headerlink" title="4.1 Hello Worldæ¨¡å‹"></a>4.1 Hello Worldæ¨¡å‹</h3><p><strong>ç‰¹ç‚¹ï¼šç‚¹åˆ°ç‚¹</strong></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/33708/one.png" class="" title="one">

<p>åœ¨ä¸Šå›¾çš„æ¨¡å‹ä¸­ï¼Œæœ‰ä»¥ä¸‹æ¦‚å¿µï¼š</p>
<ul>
<li>Pï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€æ¶ˆæ¯çš„ç¨‹åº</li>
<li>Cï¼šæ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯çš„æ¥å—è€…ï¼Œä¼šä¸€ç›´ç­‰å¾…æ¶ˆæ¯åˆ°æ¥</li>
<li>queueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå›¾ä¸­çº¢è‰²éƒ¨åˆ†ï¼Œç”Ÿäº§è€…å‘å…¶ä¸­æŠ•å…¥æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åœ¨å…¶ä¸­è·å–æ¶ˆæ¯ã€‚</li>
</ul>
<p>æ„å»ºè¿æ¥å·¥å‚ï¼š</p>
<pre><code class="java">private static ConnectionFactory connectionFactory;

public static void init() &#123;
    // åˆ›å»ºMQè¿æ¥å·¥å‚
    connectionFactory = new ConnectionFactory();
    // è®¾ç½®æœåŠ¡å™¨IP:PORT
    connectionFactory.setHost(&quot;192.168.117.155&quot;);
    connectionFactory.setPort(5672);
    // è®¾ç½®è¿æ¥è™šæ‹Ÿä¸»æœº
    connectionFactory.setVirtualHost(&quot;/learn&quot;);
    // è®¾ç½®ç”¨æˆ·å¯†ç 
    connectionFactory.setUsername(&quot;parak&quot;);
    connectionFactory.setPassword(&quot;123456&quot;);
&#125;</code></pre>
<p>ç”Ÿäº§æ¶ˆæ¯ï¼š</p>
<pre><code class="java">public static void testSendMessage() throws IOException, TimeoutException &#123;
    // è·å–è¿æ¥å¯¹è±¡
    Connection connection = connectionFactory.newConnection();
    // è·å–è¿æ¥é€šé“
    Channel channel = connection.createChannel();
    // é€šé“ç»‘å®šæ¶ˆæ¯é˜Ÿåˆ—
    // å‚æ•°1ï¼šé˜Ÿåˆ—åç§°ï¼Œå¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º
    // å‚æ•°2ï¼šç”¨æ¥å®šä¹‰é˜Ÿåˆ—ç‰¹æ€§æ˜¯å¦è¦æŒä¹…åŒ–
    // å‚æ•°3ï¼šæ˜¯å¦ç‹¬å é˜Ÿåˆ—ï¼Œåªå…è®¸å½“å‰è¿æ¥å¯ç”¨
    // å‚æ•°4ï¼šæ˜¯å¦åœ¨æ¶ˆè´¹å®Œæˆåè‡ªåŠ¨åˆ é™¤é˜Ÿåˆ—
    // å‚æ•°5ï¼šé™„åŠ å‚æ•°
    channel.queueDeclare(&quot;hello&quot;, false, false, false, null);
    // å‘å¸ƒæ¶ˆæ¯
    // å‚æ•°1ï¼šäº¤æ¢æœºåç§°
    // å‚æ•°2ï¼šé˜Ÿåˆ—åç§°
    // å‚æ•°3ï¼šä¼ é€’çš„é¢å¤–è®¾ç½®
    // å‚æ•°4ï¼šæ¶ˆæ¯çš„å…·ä½“å†…å®¹
    channel.basicPublish(&quot;&quot;, &quot;hello&quot;, null, &quot;hello, highness&quot;.getBytes());
    // å…³é—­é€šé“
    channel.close();
    // å…³é—­è¿æ¥
    connection.close();
&#125;</code></pre>
<p>æ¶ˆè´¹æ¶ˆæ¯ï¼š</p>
<pre><code class="java">public static void testConsumeMessage() throws IOException, TimeoutException &#123;
    // åˆ›å»ºè¿æ¥å¯¹è±¡
    Connection connection = connectionFactory.newConnection();
    // åˆ›å»ºè¿æ¥é€šé“
    Channel channel = connection.createChannel();
    // é€šé“ç»‘å®šé˜Ÿåˆ—
    channel.queueDeclare(&quot;hello&quot;, false, false, false, null);
    // æ¶ˆè´¹æ¶ˆæ¯
    // å‚æ•°1ï¼šæ¶ˆè´¹çš„é˜Ÿåˆ—åç§°
    // å‚æ•°2ï¼šå¼€å§‹æ¶ˆæ¯çš„è‡ªåŠ¨ç¡®è®¤æœºåˆ¶
    // å‚æ•°3ï¼šæ¶ˆè´¹æ—¶çš„å›è°ƒæ¥å£
    channel.basicConsume(&quot;hello&quot;, true, new DefaultConsumer(channel) &#123;
        // å‚æ•°1ï¼šæ ‡ç­¾
        // å‚æ•°2ï¼šä¿¡å°
        // å‚æ•°3ï¼šå±æ€§
        // å‚æ•°4ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºçš„æ¶ˆæ¯
        @Override
        public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
            log.debug(&quot;æ¶ˆè´¹æ¶ˆæ¯ï¼š&#123;&#125;&quot;, new String(body));
        &#125;
    &#125;);
    // éœ€è¦ä¸æ–­æ¥æ”¶é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥ä¸å…³é—­é€šé“å’Œè¿æ¥
&#125;</code></pre>
<blockquote>
<p>è®©é˜Ÿåˆ—å’Œæ¶ˆæ¯éƒ½æŒä¹…åŒ–</p>
</blockquote>
<p><code>queueDeclare</code>æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°éœ€è¦è®¾ç½®ä¸º<code>true</code>ï¼›</p>
<p><code>basicPublish</code>æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°éœ€è¦è®¾ç½®ä¸ºå¸¦<code>MessageProperties</code>çš„<code>PERSISTENT</code>çš„å±æ€§ï¼š</p>
<ul>
<li>MINIMAL_PERSISTENT_BASIC</li>
<li>PERSISTENT_BASIC</li>
<li>PERSISTENT_TEXT_PLAIN</li>
</ul>
<h3 id="4-2-Work-Queuesæ¨¡å‹"><a href="#4-2-Work-Queuesæ¨¡å‹" class="headerlink" title="4.2 Work Queuesæ¨¡å‹"></a>4.2 Work Queuesæ¨¡å‹</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/33708/two.png" class="" title="two">

<p>Work Queuesï¼Œä»»åŠ¡æ¨¡å‹ã€‚å½“æ¶ˆæ¯å¤„ç†æ¯”è¾ƒè€—æ—¶çš„æ—¶å€™ï¼Œå¯èƒ½ç”Ÿäº§æ¶ˆæ¯çš„é€Ÿåº¦ä¼šè¿œè¿œå¤§äºæ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿåº¦ã€‚é•¿æ­¤ä»¥å¾€ï¼Œæ¶ˆæ¯å°±ä¼šå †ç§¯è¶Šæ¥è¶Šå¤šï¼Œæ— æ³•åŠæ—¶å¤„ç†ã€‚æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨Work Queuesï¼šè®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸€æ—¦æ¶ˆè´¹ï¼Œå°±ä¼šæ¶ˆå¤±ï¼Œå› æ­¤ä»»åŠ¡æ˜¯ä¸ä¼šè¢«é‡å¤æ‰§è¡Œçš„ã€‚</p>
<p><strong>æ¼”ç¤ºï¼šå¹³å‡åˆ†é…</strong></p>
<p>MQå‡†å¤‡ï¼š</p>
<ul>
<li>åˆ›å»ºè™šæ‹Ÿä¸»æœºï¼ˆvistual hostï¼‰<code>/work</code></li>
</ul>
<p>MQå·¥å‚ï¼š</p>
<pre><code class="java">public class RabbitMQUtil &#123;
    private static volatile ConnectionFactory connectionFactory = null;
    private static final String HOST = &quot;192.168.117.155&quot;;
    private static final int PORT = 5672;
    private static final String VIRTUAL_HOST = &quot;/learn&quot;;
    private static final String USERNAME = &quot;parak&quot;;
    private static final String PASSWORD = &quot;123456&quot;;

    public static Connection getConnection() &#123;
        if (connectionFactory == null) &#123;
            synchronized (RabbitMQUtil.class) &#123;
                if (connectionFactory == null) &#123;
                    connectionFactory = new ConnectionFactory();
                    connectionFactory.setHost(HOST);
                    connectionFactory.setPort(PORT);
                    connectionFactory.setVirtualHost(VIRTUAL_HOST);
                    connectionFactory.setUsername(USERNAME);
                    connectionFactory.setPassword(PASSWORD);
                &#125;
            &#125;
        &#125;
        try &#123;
            return connectionFactory.newConnection();
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125; catch (TimeoutException e) &#123;
            e.printStackTrace();
        &#125;
        return null;
    &#125;

    public static void closeConnectionAndChannel(Channel channel, Connection connection) &#123;
        try &#123;
            if (connection != null)
                channel.close();
            if (connection != null)
                connection.close();
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125; catch (TimeoutException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;</code></pre>
<p>æ¨¡å‹æ¼”ç¤ºï¼š</p>
<pre><code class="java">// ç”Ÿäº§è€…
public class Provider &#123;
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        channel.queueDeclare(&quot;work&quot;, true, false, false, null);
        for (int i = 0; i &lt; 10; i++) &#123;
            channel.basicPublish(&quot;&quot;, &quot;work&quot;, MessageProperties.PERSISTENT_TEXT_PLAIN, new String(&quot;message&quot; + (i + 1) + &quot; =&gt; hello, khighness&quot;).getBytes());
        &#125;
        RabbitMQUtil.closeConnectionAndChannel(channel, connection);
    &#125;
&#125;

// æ¶ˆè´¹è€…1
public class Consumer1 &#123;
    private static Logger log = LoggerFactory.getLogger(Consumer1.class);
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        channel.queueDeclare(&quot;work&quot;, true, false, false, null);
        channel.basicConsume(&quot;work&quot;, true, new DefaultConsumer(channel) &#123;
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
                log.debug(&quot;æ¶ˆè´¹è€…-1ï¼š&#123;&#125;&quot;, new String(body));
                try &#123;
                    TimeUnit.SECONDS.sleep(1);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125;);
    &#125;
&#125;

// æ¶ˆè´¹è€…2
public class Consumer2 &#123;
    private static Logger log = LoggerFactory.getLogger(Consumer2.class);
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        channel.queueDeclare(&quot;work&quot;, true, false, false, null);
        channel.basicConsume(&quot;work&quot;, true, new DefaultConsumer(channel) &#123;
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
                log.debug(&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;, new String(body));
            &#125;
        &#125;);
    &#125;
&#125;</code></pre>
<p>å…ˆè¿è¡Œæ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2ï¼Œæœ€åè¿è¡Œç”Ÿäº§è€…ï¼š</p>
<pre><code class="powershell"># æ¶ˆè´¹è€…1
2021-05-24 19:32:52.218 [pool-1-thread-4] DEBUG  top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…-1ï¼šmessage1 =&gt; hello, khighness
2021-05-24 19:32:53.225 [pool-1-thread-4] DEBUG  top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…-1ï¼šmessage3 =&gt; hello, khighness
2021-05-24 19:32:54.226 [pool-1-thread-4] DEBUG  top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…-1ï¼šmessage5 =&gt; hello, khighness
2021-05-24 19:32:55.229 [pool-1-thread-4] DEBUG  top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…-1ï¼šmessage7 =&gt; hello, khighness
2021-05-24 19:32:56.231 [pool-1-thread-5] DEBUG  top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…-1ï¼šmessage9 =&gt; hello, khighness
# æ¶ˆè´¹è€…2
2021-05-24 19:32:52.219 [pool-1-thread-4] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage2 =&gt; hello, khighness
2021-05-24 19:32:52.221 [pool-1-thread-4] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage4 =&gt; hello, khighness
2021-05-24 19:32:52.221 [pool-1-thread-4] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage6 =&gt; hello, khighness
2021-05-24 19:32:52.221 [pool-1-thread-4] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage8 =&gt; hello, khighness
2021-05-24 19:32:52.222 [pool-1-thread-5] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage10 =&gt; hello, khighness</code></pre>
<p>æ€»ç»“ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitMQæŒ‰é¡ºåºå°†æ¯ä¸ªæ¶ˆæ¯å‘é€ç»™ä¸‹ä¸€ä¸ªä½¿ç”¨è€…ã€‚å¹³å‡è€Œè¨€ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šæ”¶åˆ°ç›¸åŒæ•°é‡çš„æ¶ˆæ¯ï¼Œè¿™ç§åˆ†å‘æ¶ˆæ¯çš„æ–¹å¼æˆä¸ºå¾ªç¯ã€‚</p>
<p><strong>ä¿®æ”¹ï¼šæŒ‰åŠ³åˆ†é…</strong></p>
<pre><code class="java">public class Consumer1 &#123;
    private static Logger log = LoggerFactory.getLogger(Consumer1.class);
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        final Channel channel = connection.createChannel();
        // ä¸€æ¬¡åªèƒ½æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯
        channel.basicQos(1);
        channel.queueDeclare(&quot;work&quot;, true, false, false, null);
        // ç¬¬äºŒä¸ªå‚æ•°ï¼Œå…³é—­æ¶ˆæ¯è‡ªåŠ¨ç¡®è®¤
        channel.basicConsume(&quot;work&quot;, false, new DefaultConsumer(channel) &#123;
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
                log.debug(&quot;æ¶ˆè´¹è€…-1ï¼š&#123;&#125;&quot;, new String(body));
                try &#123;
                    TimeUnit.SECONDS.sleep(1);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                // ç¬¬äºŒä¸ªå‚æ•°ï¼Œå…³é—­è‡ªåŠ¨ç¡®è®¤
                channel.basicAck(envelope.getDeliveryTag(), false);
            &#125;
        &#125;);
    &#125;
&#125;

public class Consumer2 &#123;
    private static Logger log = LoggerFactory.getLogger(Consumer2.class);
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        final Channel channel = connection.createChannel();
        channel.basicQos(1);
        channel.queueDeclare(&quot;work&quot;, true, false, false, null);
        channel.basicConsume(&quot;work&quot;, false, new DefaultConsumer(channel) &#123;
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
                log.debug(&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;, new String(body));
                channel.basicAck(envelope.getDeliveryTag(), false);
            &#125;
        &#125;);
    &#125;
&#125;</code></pre>
<p>é‡æ–°è¿è¡Œï¼š</p>
<pre><code class="powershell"># consumer1
2021-05-24 20:58:34.534 [pool-1-thread-4] DEBUG top.parak.workqueue.Consumer1 - æ¶ˆè´¹è€…-1ï¼šmessage1 =&gt; hello, khighness

# consumer2
2021-05-24 20:58:33.531 [pool-1-thread-4] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage2 =&gt; hello, khighness
2021-05-24 20:58:33.535 [pool-1-thread-5] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage3 =&gt; hello, khighness
2021-05-24 20:58:33.536 [pool-1-thread-6] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage4 =&gt; hello, khighness
2021-05-24 20:58:33.537 [pool-1-thread-7] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage5 =&gt; hello, khighness
2021-05-24 20:58:33.538 [pool-1-thread-8] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage6 =&gt; hello, khighness
2021-05-24 20:58:33.538 [pool-1-thread-9] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage7 =&gt; hello, khighness
2021-05-24 20:58:33.539 [pool-1-thread-10] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage8 =&gt; hello, khighness
2021-05-24 20:58:33.540 [pool-1-thread-11] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage9 =&gt; hello, khighness
2021-05-24 20:58:33.541 [pool-1-thread-12] DEBUG top.parak.workqueue.Consumer2 - æ¶ˆè´¹è€…-2ï¼šmessage10 =&gt; hello, khighness</code></pre>
<h3 id="4-3-Publish-Subscribeæ¨¡å‹"><a href="#4-3-Publish-Subscribeæ¨¡å‹" class="headerlink" title="4.3 Publish/Subscribeæ¨¡å‹"></a>4.3 Publish/Subscribeæ¨¡å‹</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/33708/three.png" class="" title="three">

<p>Publish/Subscribeæ¨¡å‹ï¼Œä¹Ÿç§°ä¸ºfanoutæ¨¡å‹ï¼Œå³å‘å¸ƒ-è®¢é˜…æ¨¡å‹æˆ–è€…å¹¿æ’­æ¨¡å‹ã€‚</p>
<p>æµç¨‹ï¼š</p>
<ul>
<li>æ¯ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰è‡ªå·±çš„é˜Ÿåˆ—</li>
<li>æ¯ä¸ªé˜Ÿåˆ—éƒ½è¦ç»‘å®šäº¤æ¢æœº</li>
<li>ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œåªèƒ½å‘é€åˆ°äº¤æ¢æœºï¼Œäº¤æ¢æœºæ¥å†³å®šè¦å‘ç»™å“ªä¸ªé˜Ÿåˆ—ï¼Œç”Ÿäº§è€…æ— æ³•å†³å®šã€‚</li>
<li>äº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€åˆ°ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ—</li>
<li>é˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ‹¿åˆ°æ¶ˆæ¯ï¼Œå®ç°ä¸€æ¡æ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</li>
</ul>
<p>æ¨¡å‹æ¼”ç¤ºï¼š</p>
<pre><code class="java">// ç”Ÿäº§è€…
public class Provider &#123;
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        // æŒ‡å®šäº¤æ¢æœº
        // å‚æ•°1ï¼šäº¤æ¢æœºåç§°ï¼Œä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º
        // å‚æ•°2ï¼šäº¤æ¢æœºç±»å‹
        channel.exchangeDeclare(&quot;pubsub&quot;, &quot;fanout&quot;);
        // å‘é€æ¶ˆæ¯
        channel.basicPublish(&quot;pubsub&quot;, &quot;&quot;, null, &quot;khighness&#39;s message&quot;.getBytes());
        RabbitMQUtil.closeConnectionAndChannel(channel, connection);
    &#125;
&#125;

// æ¶ˆè´¹è€…-1
public class Consumer1 &#123;
    private static Logger log = LoggerFactory.getLogger(Consumer1.class);
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        // æŒ‡å®šäº¤æ¢æœº
        channel.exchangeDeclare(&quot;pubsub&quot;, &quot;fanout&quot;);
        // ä¸´æ—¶é˜Ÿåˆ—
        String queue = channel.queueDeclare().getQueue();
        // ç»‘å®šäº¤æ¢æœºå’Œé˜Ÿåˆ—
        channel.queueBind(queue, &quot;pubsub&quot;, &quot;&quot;);
        // æ¶ˆè´¹æ¶ˆæ¯
        channel.basicConsume(queue, true, new DefaultConsumer(channel) &#123;
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
                log.info(&quot;æ¶ˆè´¹è€…-1ï¼š&#123;&#125;&quot;, new String(body));
            &#125;
        &#125;);
    &#125;
&#125;

// æ¶ˆè´¹è€…-2
public class Consumer2 &#123;
    private static Logger log = LoggerFactory.getLogger(Consumer2.class);
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        // æŒ‡å®šäº¤æ¢æœº
        channel.exchangeDeclare(&quot;pubsub&quot;, &quot;fanout&quot;);
        // ä¸´æ—¶é˜Ÿåˆ—
        String queue = channel.queueDeclare().getQueue();
        // ç»‘å®šäº¤æ¢æœºå’Œé˜Ÿåˆ—
        channel.queueBind(queue, &quot;pubsub&quot;, &quot;&quot;);
        // æ¶ˆè´¹æ¶ˆæ¯
        channel.basicConsume(queue, true, new DefaultConsumer(channel) &#123;
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
                log.info(&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;, new String(body));
            &#125;
        &#125;);
    &#125;
&#125;</code></pre>
<p>å…ˆè¿è¡Œæ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2ï¼Œæœ€åè¿è¡Œç”Ÿäº§è€…ï¼š</p>
<pre><code class="powershell"># æ¶ˆè´¹è€…1
2021-05-24 21:40:58.365 [pool-1-thread-4] INFO  top.parak.pubsub.Consumer1 - æ¶ˆè´¹è€…-1ï¼škhighness&#39;s message

# æ¶ˆè´¹è€…2
2021-05-24 21:40:58.365 [pool-1-thread-4] INFO  top.parak.pubsub.Consumer2 - æ¶ˆè´¹è€…-2ï¼škhighness&#39;s message</code></pre>
<h3 id="4-4-Routingæ¨¡å‹"><a href="#4-4-Routingæ¨¡å‹" class="headerlink" title="4.4 Routingæ¨¡å‹"></a>4.4 Routingæ¨¡å‹</h3><p>åœ¨fanoutæ¨¡å‹ä¸­ï¼Œä¸€æ¡æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰è®¢é˜…çš„é˜Ÿåˆ—éƒ½æ¶ˆè´¹ï¼Œä½†æ˜¯ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸åŒçš„æ¶ˆæ¯è¢«ä¸åŒçš„é˜Ÿåˆ—æ¶ˆè´¹ï¼Œè¿™æ—¶å°±è¦ç”¨Routingçš„Directç±»å‹çš„äº¤æ¢æœºã€‚</p>
<p>åœ¨Directæ¨¡å‹ä¸­ï¼š</p>
<ul>
<li>é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ªRoutingKeyã€‚</li>
<li>æ¶ˆæ¯çš„å‘é€æ–¹åœ¨å‘Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„RoutingKeyã€‚</li>
<li>Exchangeä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„RoutingKeyè¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é˜Ÿåˆ—çš„RoutingKeyä¸æ¶ˆæ¯çš„RoutingKeyå®Œå…¨ä¸€è‡´ï¼Œæ‰ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚</li>
</ul>
<p>å›¾è§£ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/33708/four.png" class="" title="four">

<ul>
<li>Pï¼šç”Ÿäº§è€…ï¼Œå‘Exchangeå‘é€æ¶ˆæ¯ï¼Œå‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šæŒ‡å®šä¸€ä¸ªrouting key</li>
<li>Xï¼šäº¤æ¢æœºï¼Œæ¥æ”¶ç”Ÿäº§è€…çš„æ¶ˆæ¯ï¼Œç„¶åæŠŠæ¶ˆæ¯é€’äº¤ç»™ä¸routing keyå®Œå…¨åŒ¹é…çš„é˜Ÿåˆ—</li>
<li>C1ï¼šæ¶ˆè´¹è€…ï¼Œå…¶æ‰€åœ¨é˜Ÿåˆ—æŒ‡å®šäº†éœ€è¦routing keyä¸ºerrorçš„æ¶ˆæ¯</li>
<li>C2ï¼šæ¶ˆè´¹è€…ï¼Œå…¶æ‰€åœ¨é˜Ÿåˆ—æŒ‡å®šäº†éœ€è¦routing keyä¸ºinfoã€errorã€warningçš„æ¶ˆæ¯</li>
</ul>
<p>æ¨¡å‹æ¼”ç¤ºï¼š</p>
<pre><code class="java">// ç”Ÿäº§è€…
public class Provider &#123;
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        // æŒ‡å®šäº¤æ¢æœº
        channel.exchangeDeclare(&quot;routing&quot;, &quot;direct&quot;);
        // å‘é€æ¶ˆæ¯
        channel.basicPublish(&quot;routing&quot;, &quot;info&quot;, null, &quot;direct =&gt; info&quot;.getBytes());
        channel.basicPublish(&quot;routing&quot;, &quot;debug&quot;, null, &quot;direct =&gt; debug&quot;.getBytes());
        channel.basicPublish(&quot;routing&quot;, &quot;warn&quot;, null, &quot;direct =&gt; warn&quot;.getBytes());
        channel.basicPublish(&quot;routing&quot;, &quot;error&quot;, null, &quot;direct =&gt; error&quot;.getBytes());
        RabbitMQUtil.closeConnectionAndChannel(channel, connection);
    &#125;
&#125;

// æ¶ˆè´¹è€…1
public class Consumer1 &#123;
    private static Logger log = LoggerFactory.getLogger(Consumer1.class);
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        // æŒ‡å®šäº¤æ¢æœº
        channel.exchangeDeclare(&quot;routing&quot;, &quot;direct&quot;);
        // ä¸´æ—¶é˜Ÿåˆ—
        String queue = channel.queueDeclare().getQueue();
        // åŸºäºroute keyç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº
        channel.queueBind(queue, &quot;routing&quot;, &quot;info&quot;);
        // è·å–æ¶ˆè´¹çš„æ¶ˆæ¯
        channel.basicConsume(queue, true, new DefaultConsumer(channel) &#123;
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
                log.debug(&quot;æ¶ˆè´¹è€…-1ï¼š&#123;&#125;&quot;, new String(body));
            &#125;
        &#125;);
    &#125;
&#125;

// æ¶ˆè´¹è€…2
public class Consumer2 &#123;
    private static Logger log = LoggerFactory.getLogger(Consumer2.class);
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        // æŒ‡å®šäº¤æ¢æœº
        channel.exchangeDeclare(&quot;routing&quot;, &quot;direct&quot;);
        // ä¸´æ—¶é˜Ÿåˆ—
        String queue = channel.queueDeclare().getQueue();
        // åŸºäºroute keyç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº
        channel.queueBind(queue, &quot;routing&quot;, &quot;debug&quot;);
        channel.queueBind(queue, &quot;routing&quot;, &quot;warn&quot;);
        channel.queueBind(queue, &quot;routing&quot;, &quot;error&quot;);
        // è·å–æ¶ˆè´¹çš„æ¶ˆæ¯
        channel.basicConsume(queue, true, new DefaultConsumer(channel) &#123;
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
                log.debug(&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;, new String(body));
            &#125;
        &#125;);
    &#125;
&#125;</code></pre>
<p>å…ˆè¿è¡Œæ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2ï¼Œæœ€åè¿è¡Œç”Ÿäº§è€…ï¼š</p>
<pre><code class="powershell"># æ¶ˆè´¹è€…1
2021-05-24 22:47:26.753 [pool-1-thread-4] DEBUG top.parak.direct.Consumer1 - æ¶ˆè´¹è€…-1ï¼šdirect =&gt; info

# æ¶ˆè´¹è€…2
2021-05-24 22:47:26.753 [pool-1-thread-4] DEBUG top.parak.direct.Consumer2 - æ¶ˆè´¹è€…-2ï¼šdirect =&gt; debug
2021-05-24 22:47:26.756 [pool-1-thread-4] DEBUG top.parak.direct.Consumer2 - æ¶ˆè´¹è€…-2ï¼šdirect =&gt; warn
2021-05-24 22:47:26.756 [pool-1-thread-4] DEBUG top.parak.direct.Consumer2 - æ¶ˆè´¹è€…-2ï¼šdirect =&gt; error</code></pre>
<h3 id="4-5-Topicsæ¨¡å‹"><a href="#4-5-Topicsæ¨¡å‹" class="headerlink" title="4.5 Topicsæ¨¡å‹"></a>4.5 Topicsæ¨¡å‹</h3><p>Topicsæ¨¡å‹ä¸Directæ¨¡å‹ç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®RoutingKeyæŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ï¼Œåªä¸è¿‡Topicç±»å‹Exchangeå¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®šRoutingKeyçš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/33708/five.png" class="" title="five">

<p>Topicsæ¨¡å‹çš„RoutingKeyæ˜¯ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªå•è¯ç»„æˆï¼Œå¤šä¸ªå•è¯ä¹‹é—´ä»¥<code>.</code>åˆ†éš”ï¼Œæœ‰ä¸¤ç§é€šé…ç¬¦ï¼š</p>
<ul>
<li><code>*</code>ï¼šåŒ¹é…ä¸€ä¸ªå•è¯</li>
<li><code>#</code>ï¼šåŒ¹é…å¤šä¸ªå•è¯</li>
</ul>
<p>æ¨¡å‹æ¼”ç¤ºï¼š</p>
<pre><code class="java">// ç”Ÿäº§è€…
public class Provider &#123;
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(&quot;topics&quot;, &quot;topic&quot;);
        channel.basicPublish(&quot;topics&quot;, &quot;k.a&quot;, null, &quot;topics =&gt; k.a&quot;.getBytes());
        channel.basicPublish(&quot;topics&quot;, &quot;k.a.g&quot;, null, &quot;topics =&gt; k.a.g&quot;.getBytes());
        RabbitMQUtil.closeConnectionAndChannel(channel, connection);
    &#125;
&#125;

// æ¶ˆè´¹è€…1
public class Consumer2 &#123;
    private static Logger log = LoggerFactory.getLogger(Consumer2.class);
    public static void main(String[] args) throws IOException &#123;
        Connection connection = RabbitMQUtil.getConnection();
        Channel channel = connection.createChannel();
        channel.exchangeDeclare(&quot;topics&quot;, &quot;topic&quot;);
        String queue = channel.queueDeclare().getQueue();
        channel.queueBind(queue, &quot;topics&quot;, &quot;k.#&quot;);
        channel.basicConsume(queue, true, new DefaultConsumer(channel) &#123;
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
                log.debug(&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;, new String(body));
            &#125;
        &#125;);
    &#125;
&#125;
        // ä¸´æ—¶é˜Ÿåˆ—
        String queue = channel.queueDeclare().getQueue();
        // åŸºäºroute keyç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº
        channel.queueBind(queue, &quot;routing&quot;, &quot;debug&quot;);
        channel.queueBind(queue, &quot;routing&quot;, &quot;warn&quot;);
        channel.queueBind(queue, &quot;routing&quot;, &quot;error&quot;);
        // è·å–æ¶ˆè´¹çš„æ¶ˆæ¯
        channel.basicConsume(queue, true, new DefaultConsumer(channel) &#123;
            @Override
            public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123;
                log.debug(&quot;æ¶ˆè´¹è€…-2ï¼š&#123;&#125;&quot;, new String(body));
            &#125;
        &#125;);
    &#125;
&#125;</code></pre>
<p>å…ˆè¿è¡Œæ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2ï¼Œæœ€åè¿è¡Œç”Ÿäº§è€…ï¼š</p>
<pre><code class="powershell"># æ¶ˆè´¹è€…1
2021-05-24 23:14:53.574 [pool-1-thread-4] DEBUG top.parak.topics.Consumer1 - æ¶ˆè´¹è€…-1ï¼štopics =&gt; k.a

# æ¶ˆè´¹è€…2
2021-05-24 23:14:53.573 [pool-1-thread-4] DEBUG top.parak.topics.Consumer2 - æ¶ˆè´¹è€…-2ï¼štopics =&gt; k.a
2021-05-24 23:14:53.578 [pool-1-thread-4] DEBUG top.parak.topics.Consumer2 - æ¶ˆè´¹è€…-2ï¼štopics =&gt; k.a.g</code></pre>
<h2 id="5-RabbitMQæ•´åˆSprigBoot"><a href="#5-RabbitMQæ•´åˆSprigBoot" class="headerlink" title="5. RabbitMQæ•´åˆSprigBoot"></a>5. RabbitMQæ•´åˆSprigBoot</h2><p>å¼•å…¥ä¾èµ–ï¼š</p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;
        &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
        &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
<p>é…ç½®æ–‡ä»¶ï¼š</p>
<pre><code class="properties">server.port=3333
spring.application.name=springboot-rabbitmq
spring.rabbitmq.host=192.168.117.155
spring.rabbitmq.port=5672
spring.rabbitmq.virtual-host=/learn
spring.rabbitmq.username=parak
spring.rabbitmq.password=123456</code></pre>
<p>å·¥å…·ç±»ï¼š</p>
<pre><code class="java">public class TimeUtil &#123;
    private static class TimeFormatHolder &#123;
        static final DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;);
    &#125;

    public static String getTime() &#123;
        return TimeFormatHolder.formatter.format(LocalDateTime.now());
    &#125;
&#125;</code></pre>
<p>å¯åŠ¨ç±»ï¼š</p>
<pre><code class="java">@SpringBootApplication
public class RabbitMQApplication &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(RabbitMQApplication.class, args);
    &#125;
&#125;</code></pre>
<p>æµ‹è¯•ç±»ï¼š</p>
<pre><code class="java">@SpringBootTest(classes = RabbitMQApplication.class)
public class RabbitMQApplicationTest &#123;
    @Autowired
    private RabbitTemplate rabbitTemplate;
&#125;</code></pre>
<h3 id="5-1-Hello-Worldæ¨¡å‹"><a href="#5-1-Hello-Worldæ¨¡å‹" class="headerlink" title="5.1 Hello Worldæ¨¡å‹"></a>5.1 Hello Worldæ¨¡å‹</h3><pre><code class="java">// ç”Ÿäº§æ¶ˆæ¯
@Test void hello() &#123;
    rabbitTemplate.convertAndSend(&quot;hello&quot;, &quot;hello, Khighness&quot;);
&#125;

// æ¶ˆè´¹è€…
@Component
public class HelloConsumer &#123;
    @RabbitListener(queuesToDeclare = @Queue(value = &quot;hello&quot;))
    @RabbitHandler
    public void receive(String message) &#123;
        System.out.println(String.format(&quot;%s  INFO %d --- [consumer] %s receive message: %s&quot;, TimeUtil.getTime(), Thread.currentThread().getId(), this.getClass().getName(), message));
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="powershell">2021-05-25 11:50:31.703  INFO 17 --- [consumer] top.parak.consumer.HelloConsumer receive message: hello, Khighness</code></pre>
<h3 id="5-2-Work-Queueæ¨¡å‹"><a href="#5-2-Work-Queueæ¨¡å‹" class="headerlink" title="5.2 Work Queueæ¨¡å‹"></a>5.2 Work Queueæ¨¡å‹</h3><pre><code class="java">// ç”Ÿäº§æ¶ˆæ¯
@Test void work() &#123;
    for (int i = 1; i &lt;= 10; i++)
        rabbitTemplate.convertAndSend(&quot;work&quot;, &quot;work message-&quot; + i);
&#125;

// æ¶ˆè´¹è€…
@Component
public class WorkConsumer &#123;
    @RabbitListener(queuesToDeclare = @Queue(&quot;work&quot;))
    @RabbitHandler
    public void receive1(String message) &#123;
        System.out.println(String.format(&quot;%s  INFO %d --- [consumer-1] %s receive message: %s&quot;, TimeUtil.getTime(), Thread.currentThread().getId(), this.getClass().getName(), message));
    &#125;

    @RabbitListener(queuesToDeclare = @Queue(&quot;work&quot;))
    @RabbitHandler
    public void receive2(String message) &#123;
        System.out.println(String.format(&quot;%s  INFO %d --- [consumer-2] %s receive message: %s&quot;, TimeUtil.getTime(), Thread.currentThread().getId(), this.getClass().getName(), message));
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="powershell">2021-05-25 11:53:06.618  INFO 21 --- [consumer-2] top.parak.consumer.WorkConsumer receive message: work message-2
2021-05-25 11:53:06.618  INFO 19 --- [consumer-1] top.parak.consumer.WorkConsumer receive message: work message-1
2021-05-25 11:53:06.619  INFO 21 --- [consumer-2] top.parak.consumer.WorkConsumer receive message: work message-4
2021-05-25 11:53:06.619  INFO 19 --- [consumer-1] top.parak.consumer.WorkConsumer receive message: work message-3
2021-05-25 11:53:06.619  INFO 21 --- [consumer-2] top.parak.consumer.WorkConsumer receive message: work message-6
2021-05-25 11:53:06.620  INFO 19 --- [consumer-1] top.parak.consumer.WorkConsumer receive message: work message-5
2021-05-25 11:53:06.620  INFO 21 --- [consumer-2] top.parak.consumer.WorkConsumer receive message: work message-8
2021-05-25 11:53:06.620  INFO 19 --- [consumer-1] top.parak.consumer.WorkConsumer receive message: work message-7
2021-05-25 11:53:06.620  INFO 21 --- [consumer-2] top.parak.consumer.WorkConsumer receive message: work message-10
2021-05-25 11:53:06.620  INFO 19 --- [consumer-1] top.parak.consumer.WorkConsumer receive message: work message-9</code></pre>
<h3 id="5-3-Publish-Subscribeæ¨¡å‹"><a href="#5-3-Publish-Subscribeæ¨¡å‹" class="headerlink" title="5.3 Publish/Subscribeæ¨¡å‹"></a>5.3 Publish/Subscribeæ¨¡å‹</h3><pre><code class="java">// ç”Ÿäº§æ¶ˆæ¯
@Test void fanout() &#123;
    for (int i = 1; i &lt;= 3; i++)
        rabbitTemplate.convertAndSend(&quot;fanout&quot;, &quot;&quot;, &quot;fanout message-&quot; + i);
&#125;

// æ¶ˆè´¹è€…
@Component
public class FanoutConsumer &#123;
    @RabbitListener(bindings = &#123;
        @QueueBinding(value = @Queue, // æœªæŒ‡å®šåç§°ï¼Œåˆ›å»ºä¸´æ—¶é˜Ÿåˆ—
                      exchange = @Exchange(value = &quot;fanout&quot;, type = &quot;fanout&quot;) // ç»‘å®šäº¤æ¢æœº
                     )
    &#125;)
    @RabbitHandler
    public void receive1(String message) &#123;
        System.out.println(String.format(&quot;%s  INFO %d --- [consumer-1] %s receive message: %s&quot;, TimeUtil.getTime(), Thread.currentThread().getId(), this.getClass().getName(), message));
    &#125;

    @RabbitListener(bindings = &#123;
        @QueueBinding(value = @Queue, // æœªæŒ‡å®šåç§°ï¼Œåˆ›å»ºä¸´æ—¶é˜Ÿåˆ—
                      exchange = @Exchange(value = &quot;fanout&quot;, type = &quot;fanout&quot;) // ç»‘å®šäº¤æ¢æœº
                     )
    &#125;)
    @RabbitHandler
    public void receive2(String message) &#123;
        System.out.println(String.format(&quot;%s  INFO %d --- [consumer-2] %s receive message: %s&quot;, TimeUtil.getTime(), Thread.currentThread().getId(), this.getClass().getName(), message));
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="powershell">2021-05-25 12:21:17.283  INFO 19 --- [consumer-2] top.parak.consumer.FanoutConsumer receive message: fanout message-1
2021-05-25 12:21:17.283  INFO 17 --- [consumer-1] top.parak.consumer.FanoutConsumer receive message: fanout message-1
2021-05-25 12:21:17.284  INFO 17 --- [consumer-1] top.parak.consumer.FanoutConsumer receive message: fanout message-2
2021-05-25 12:21:17.284  INFO 19 --- [consumer-2] top.parak.consumer.FanoutConsumer receive message: fanout message-2
2021-05-25 12:21:17.284  INFO 17 --- [consumer-1] top.parak.consumer.FanoutConsumer receive message: fanout message-3
2021-05-25 12:21:17.284  INFO 19 --- [consumer-2] top.parak.consumer.FanoutConsumer receive message: fanout message-3</code></pre>
<h3 id="5-4-Routingæ¨¡å‹"><a href="#5-4-Routingæ¨¡å‹" class="headerlink" title="5.4 Routingæ¨¡å‹"></a>5.4 Routingæ¨¡å‹</h3><pre><code class="java">// ç”Ÿäº§æ¶ˆæ¯
@Test void routing() &#123;
    rabbitTemplate.convertAndSend(&quot;routing&quot;, &quot;info&quot;, &quot;routing info&quot;);
    rabbitTemplate.convertAndSend(&quot;routing&quot;, &quot;debug&quot;, &quot;routing debug&quot;);
    rabbitTemplate.convertAndSend(&quot;routing&quot;, &quot;warn&quot;, &quot;routing warn&quot;);
    rabbitTemplate.convertAndSend(&quot;routing&quot;, &quot;error&quot;, &quot;routing error&quot;);
&#125;

// æ¶ˆè´¹è€…
@Component
public class RoutingConsumer &#123;
    @RabbitListener(bindings = &#123;
            @QueueBinding(
                    value = @Queue, // ä¸´æ—¶é˜Ÿåˆ—
                    exchange = @Exchange(value = &quot;routing&quot;, type = &quot;direct&quot;),
                    key = &#123;&quot;info&quot;, &quot;debug&quot;&#125;
            )
    &#125;)
    @RabbitHandler
    public void receive1(String message) &#123;
        System.out.println(String.format(&quot;%s  INFO %d --- [consumer-1] %s receive message: %s&quot;, TimeUtil.getTime(), Thread.currentThread().getId(), this.getClass().getName(), message));
    &#125;

    @RabbitListener(bindings = &#123;
            @QueueBinding(
                    value = @Queue, // ä¸´æ—¶é˜Ÿåˆ—
                    exchange = @Exchange(value = &quot;routing&quot;, type = &quot;direct&quot;),
                    key = &#123;&quot;warn&quot;, &quot;error&quot;&#125;
            )
    &#125;)
    @RabbitHandler
    public void receive2(String message) &#123;
        System.out.println(String.format(&quot;%s  INFO %d --- [consumer-2] %s receive message: %s&quot;, TimeUtil.getTime(), Thread.currentThread().getId(), this.getClass().getName(), message));
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="powershell">2021-05-25 12:32:38.151  INFO 23 --- [consumer-1] top.parak.consumer.RoutingConsumer receive message: routing info
2021-05-25 12:32:38.151  INFO 25 --- [consumer-2] top.parak.consumer.RoutingConsumer receive message: routing warn
2021-05-25 12:32:38.152  INFO 23 --- [consumer-1] top.parak.consumer.RoutingConsumer receive message: routing debug
2021-05-25 12:32:38.152  INFO 25 --- [consumer-2] top.parak.consumer.RoutingConsumer receive message: routing error</code></pre>
<h3 id="5-5-Topicsæ¨¡å‹"><a href="#5-5-Topicsæ¨¡å‹" class="headerlink" title="5.5 Topicsæ¨¡å‹"></a>5.5 Topicsæ¨¡å‹</h3><pre><code class="java">// ç”Ÿäº§æ¶ˆæ¯
@Test void topics() &#123;
    rabbitTemplate.convertAndSend(&quot;topics&quot;, &quot;k.a&quot;, &quot;topics k.a&quot;);
    rabbitTemplate.convertAndSend(&quot;topics&quot;, &quot;k.a.g&quot;, &quot;topics k.a.g&quot;);
&#125;

// æ¶ˆè´¹è€…
@Component
public class TopicsConsumer &#123;
    @RabbitListener(bindings = &#123;
        @QueueBinding(value = @Queue,
                      exchange = @Exchange(name = &quot;topics&quot;, type = &quot;topic&quot;),
                      key = &#123;&quot;k.*&quot;&#125;
                     )
    &#125;)
    @RabbitHandler
    public void receive1(String message) &#123;
        System.out.println(String.format(&quot;%s  INFO %d --- [consumer-1] %s receive message: %s&quot;, TimeUtil.getTime(), Thread.currentThread().getId(), this.getClass().getName(), message));
    &#125;

    @RabbitListener(bindings = &#123;
        @QueueBinding(value = @Queue,
                      exchange = @Exchange(name = &quot;topics&quot;, type = &quot;topic&quot;),
                      key = &#123;&quot;k.#&quot;&#125;
                     )
    &#125;)
    @RabbitHandler
    public void receive2(String message) &#123;
        System.out.println(String.format(&quot;%s  INFO %d --- [consumer-2] %s receive message: %s&quot;, TimeUtil.getTime(), Thread.currentThread().getId(), this.getClass().getName(), message));
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="powershell">2021-05-25 13:33:11.243  INFO 29 --- [consumer-1] top.parak.consumer.TopicsConsumer receive message: topics k.a
2021-05-25 13:33:11.243  INFO 27 --- [consumer-2] top.parak.consumer.TopicsConsumer receive message: topics k.a
2021-05-25 13:33:11.244  INFO 27 --- [consumer-2] top.parak.consumer.TopicsConsumer receive message: topics k.a.g</code></pre>
<h2 id="6-RabbitMQåº”ç”¨åœºæ™¯"><a href="#6-RabbitMQåº”ç”¨åœºæ™¯" class="headerlink" title="6. RabbitMQåº”ç”¨åœºæ™¯"></a>6. RabbitMQåº”ç”¨åœºæ™¯</h2><h3 id="6-1-å¼‚æ­¥å¤„ç†"><a href="#6-1-å¼‚æ­¥å¤„ç†" class="headerlink" title="6.1 å¼‚æ­¥å¤„ç†"></a>6.1 å¼‚æ­¥å¤„ç†</h3><p>åœºæ™¯è¯´æ˜ï¼šç”¨æˆ·æ³¨å†Œï¼Œéœ€è¦å‘é€çŸ­ä¿¡é€šçŸ¥å’ŒéªŒè¯é‚®ä»¶ï¼Œä¼ ç»Ÿçš„åšæ³•æœ‰ä¸²è¡Œå’Œå¹¶è¡Œçš„æ–¹å¼ã€‚</p>
<ul>
<li>ä¸²è¡Œæ–¹å¼ï¼šå°†æ³¨å†Œä¿¡æ¯å†™å…¥æ•°æ®åº“åï¼Œå‘é€çŸ­ä¿¡é€šçŸ¥ï¼Œå†å‘é€éªŒè¯é‚®ä»¶ã€‚</li>
<li>å¹¶è¡Œæ–¹å¼ï¼šå°†æ³¨å†Œä¿¡æ¯å†™å…¥æ•°æ®åº“åï¼Œå‘é€çŸ­ä¿¡é€šçŸ¥åŒæ—¶å‘é€éªŒè¯é‚®ä»¶ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼šæ³¨å†Œåéƒ½éœ€è¦ç­‰å¾…ä»»åŠ¡å¤„ç†å®Œæˆæ‰èƒ½è¿”å›ã€‚</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå°†æ³¨å†Œä¿¡æ¯å†™å…¥æ•°æ®åº“åï¼Œå°†çŸ­ä¿¡å’Œé‚®ä»¶å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—åç›´æ¥è¿”å›ã€‚</p>
<h3 id="6-2-åº”ç”¨è§£è€¦"><a href="#6-2-åº”ç”¨è§£è€¦" class="headerlink" title="6.2 åº”ç”¨è§£è€¦"></a>6.2 åº”ç”¨è§£è€¦</h3><p>åœºæ™¯è¯´æ˜ï¼šç”¨æˆ·ä¸‹å•ï¼Œè®¢å•ç³»ç»Ÿéœ€è¦é€šçŸ¥åº“å­˜ç³»ç»Ÿï¼Œä¼ ç»Ÿåšæ³•å°±æ˜¯è®¢å•ç³»ç»Ÿè°ƒç”¨åº“å­˜ç³»ç»Ÿçš„æ¥å£ã€‚</p>
<p>ç¼ºç‚¹ï¼šå½“åº“å­˜ç³»ç»Ÿå‡ºç°æ•…éšœæ—¶ï¼Œè®¢å•å°±ä¼šå¤±è´¥ã€‚</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<ul>
<li>è®¢å•ç³»ç»Ÿï¼šç”¨æˆ·ä¸‹å•åï¼Œè®¢å•ç³»ç»Ÿå®ŒæˆæŒä¹…åŒ–å¤„ç†ï¼Œå°†æ¶ˆæ¯å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿”å›ç”¨æˆ·è®¢å•ä¸‹å•æˆåŠŸã€‚</li>
<li>åº“å­˜ç³»ç»Ÿï¼šè®¢é˜…ä¸‹å•çš„æ¶ˆæ¯ï¼Œè·å–ä¸‹å•æ¶ˆæ¯ï¼Œè¿›è¡Œåº“å­˜æ“ä½œã€‚å°±ç®—åº“å­˜ç³»ç»Ÿå‡ºç°æ•…éšœï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿèƒ½ä¿è¯æ¶ˆæ¯çš„å¯é æŠ•é€’ï¼Œä¸ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚</li>
</ul>
<h3 id="6-3-æµé‡å‰Šå³°"><a href="#6-3-æµé‡å‰Šå³°" class="headerlink" title="6.3 æµé‡å‰Šå³°"></a>6.3 æµé‡å‰Šå³°</h3><p>åœºæ™¯è¯´æ˜ï¼šç§’æ€æ´»åŠ¨ï¼Œä¸€èˆ¬ä¼šå› ä¸ºæµé‡è¿‡å¤§ï¼Œå¯¼è‡´åº”ç”¨æŒ‚æ‰ã€‚</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<ol>
<li>æ§åˆ¶æ´»åŠ¨äººæ•°ï¼Œè¶…è¿‡é˜ˆå€¼çš„è®¢å•ç›´æ¥ä¸¢å¼ƒã€‚</li>
<li>ç¼“è§£çŸ­æ—¶é—´çš„é«˜æµé‡å‹å®æœåŠ¡ã€‚</li>
</ol>
<hr>
<p>æœªå®Œç»“ï¼Œå å‘ï¼Œé›†ç¾¤ç•™ç€ï¼Œå¾…æ›´~</p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
      </categories>
      <tags>
        <tag>æ¶ˆæ¯é˜Ÿåˆ—</tag>
      </tags>
  </entry>
  <entry>
    <title>ç››å¤</title>
    <url>/posts/48247/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>çŠ¹ç„¶è®°å¾—ï¼Œ2017å¹´çš„å†¬å¤©ï¼Œæˆ‘çš„ä¸Šä¸€å±Šå­¦é•¿è¯´çš„è¯ï¼š</p>
<blockquote>
<p><em>â€œé«˜è€ƒåªæ˜¯ä¸ªè€ƒè¯•ï¼Œä½†æ˜¯ä½ æ€‚äº†ï¼Œä»¥åä½ ä¹Ÿä¼šæ€‚ä¸‹å»ã€‚â€</em></p>
</blockquote>
<p>ä½ ä»¥ä¸ºæ˜¯è‹¦æµ·ï¼Œå®é™…ä¸Šæ˜¯å¤©å ‚ï¼›</p>
<p>ä½ ä»¥ä¸ºæ˜¯å¼€å§‹ï¼Œå®é™…ä¸Šæ˜¯å·…å³°ï¼›</p>
<p>ä½ ä»¥ä¸ºä¼šè„±ç¦»ï¼Œæ­¤åæ— é™æ€€å¿µã€‚</p>
<br>

<p>è¯¦ç»†è®°å½•ä¸‹æˆ‘çš„æ•´ä¸ªé«˜è€ƒçŠ¶æ€ã€‚</p>
<p>2018.6.6ï¼Œæ™šä¸Š9ç‚¹ï¼Œæˆ‘å¼€å§‹èººåºŠï¼Œè¶Šç¡è¶Šæ¸…é†’ï¼Œæ¯äº²åŠå¤œ1ç‚¹ä¸ºæˆ‘æ¨æ‹¿ï¼Œæœ€åè™½ç„¶æ²¡ç¡ç€ï¼Œä½†è¿˜æ˜¯é—­çœ¼åˆ°äº†å¤©äº®ã€‚</p>
<p>2018.6.7ï¼Œæ•°å­¦è§£ç­”é¢˜ç¬¬ä¸€é¢˜æ²¡å†™ï¼ˆæŠŠå¹³é¢å››è¾¹å½¢çœ‹æˆå¹³è¡Œå››è¾¹å½¢ï¼Œç„¶ååœ¨ç­”é¢˜çº¸ä¸Šå†™äº†æ­¤é¢˜æœ‰è¯¯ï¼‰ï¼Œå¿ƒæ€ç‚¸è£‚ï¼Œåœ¨æ²¸æ²¸æ‰¬æ‰¬çš„150é‡Œï¼Œæ— é¢œé¢è§æˆ‘çš„ç­ä¸»ä»»ï¼Œæˆ‘åªæƒ³è‡ªé—­ï¼ˆä½†æ˜¯ç»“æœè¿˜æ˜¯è¶…äººæ„æ–™ï¼Œä»…ä»…æ‰£äº†é‚£ä¸€é¢˜çš„åˆ†æ•°ï¼‰ã€‚æ™šä¸Š9ç‚¹ï¼Œæ•…äº‹åˆé‡æ¼”ã€‚</p>
<p>ä¸¤å¤©ä¸­åˆçš„åˆç¡æµ…çš„ä¸èƒ½å†æµ…ï¼Œæ­¤å‰æ¨¡æ‹Ÿè¦æ˜¯è¿™ä¸ªçŠ¶æ€ï¼Œè€ƒè¯•å¤šå°‘éƒ½ä¼šå‡ºç‚¹é—®é¢˜ï¼Œä½†æ˜¯é«˜è€ƒå®ƒå°±æ˜¯ä¸ä¸€æ ·ï¼Œæ²¡æœ‰çŒç¡ï¼Œä½ åªç®¡è¡¨æ¼”ã€‚</p>
<br>

<p>ä½†æ˜¯2018å¹´çš„ç››å¤ï¼Œç»å¯¹æ˜¯æˆ‘äººç”Ÿä¸­æœ€å€¼å¾—æ€€å¿µçš„å¤å¤©ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/48247/bg.jpg" class="" title="ç››å¤">

<p>2018å¹´çš„æ°ä¼¦ï¼Œã€Šç­‰ä½ ä¸‹è¯¾ã€‹å’Œã€Šä¸çˆ±æˆ‘å°±æ‹‰å€’ã€‹ã€‚</p>
<p>2018å¹´çš„æŠ–éŸ³ï¼Œæœªè¿›å…¥ç—…æ¯’çºªå…ƒçš„å®ƒæ‰¿è½½æ— é™ç¾å¥½ã€‚</p>
<p>2018å¹´çš„å…­æœˆï¼Œå¿ƒä¸­æ»¡æº¢èƒŒèµ·è¡Œå›Šèµ°å‘ä¸–ç•Œçš„å†²åŠ¨ã€‚</p>
<p>2018å¹´çš„ä¸ƒæœˆï¼Œåœ¨æˆ‘æˆå¹´å‰æ‰“äº†ä¸€ä»½æ»¡æ„çš„æš‘å‡å·¥ã€‚</p>
<p>2018å¹´çš„å…«æœˆï¼Œå‡å­¦å®´ä¸Šæ¨æ¯æ¢ç›ä¸é’æ˜¥æœ€åé“åˆ«ã€‚</p>
<br>

<p>ä¸Šäº†å¤§å­¦ï¼Œå†ä¹Ÿæ²¡æœ‰è‡ªå·±å›ºå®šçš„åº§ä½ï¼Œæ²¡æœ‰æ—©è¯»æ—¶çš„æµ·å¹å’Œæ¼”å”±ä¼šï¼Œæ²¡æœ‰â€œèµ°å•Šï¼Œä¸€èµ·ä¸Šå•æ‰€â€ï¼Œæ²¡æœ‰å‚æ™šæ—¶çª—å¤–çš„ä¸€ç‰‡ç»¯çº¢ï¼Œæ²¡æœ‰ä¸‹æ™šè‡ªä¹ åçš„å¥”è·‘ï¼Œå°±è¿ä¸Šè¯¾ç¡è§‰éƒ½æ²¡æœ‰é‚£ä¹ˆé¦™ã€‚ä»æ­¤ï¼Œå†éš¾ä»¥æ‰¾å›é‚£æ—¶çš„æ„æ°”é£å‘å’Œè¸Œèº‡æ»¡å¿—ï¼Œä»¥åŠå•çº¯é’æ¶©çš„æƒ…æ„«ã€‚</p>
<p>ä¸”è¡Œä¸”çæƒœï¼ŒäºŒé›¶äºŒä¸€å±Šã€‚</p>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-15(åƒåœ¾å›æ”¶å™¨)</title>
    <url>/posts/11567/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="15-1-ğŸš€GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡"><a href="#15-1-ğŸš€GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡" class="headerlink" title="15.1 ğŸš€GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡"></a>15.1 ğŸš€GCåˆ†ç±»ä¸æ€§èƒ½æŒ‡æ ‡</h3><blockquote>
<p>ğŸ’¬åƒåœ¾å›æ”¶å™¨æ¦‚è¿°</p>
</blockquote>
<ul>
<li>åƒåœ¾å™¨æ²¡æœ‰åœ¨è§„èŒƒä¸­è¿›è¡Œè¿‡å¤šè§„å®šï¼Œå¯ä»¥ç”±ä¸åŒçš„å‚å•†ã€ä¸åŒç‰ˆæœ¬çš„JVMæ¥å®ç°ã€‚</li>
<li>ç”±äºJDKçš„ç‰ˆæœ¬å¤„äºé«˜é€Ÿè¿­ä»£è¿‡ç¨‹ä¸­ï¼Œå› æ­¤Javaå‘å±•è‡³ä»Šå·²ç»è¡ç”Ÿäº†ä¼—å¤šçš„GCç‰ˆæœ¬ã€‚</li>
<li>ä»ä¸åŒè§’åº¦åˆ†æåƒåœ¾å›æ”¶å™¨ï¼Œå¯å°†GCåˆ†ä¸ºä¸åŒçš„ç±»å‹ã€‚</li>
</ul>
<blockquote>
<p>ğŸ““åƒåœ¾å›æ”¶å™¨åˆ†ç±»</p>
</blockquote>
<p>æŒ‰ç…§å·¥ä½œæ¨¡å¼åˆ†ï¼š</p>
<ul>
<li>å¹¶å‘å¼åƒåœ¾å›æ”¶å™¨ï¼šä¸åº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿å·¥ä½œï¼Œä»¥å°½å¯èƒ½å‡å°‘åº”ç”¨ç¨‹åºçš„åœé¡¿æ—¶é—´ã€‚</li>
<li>ç‹¬å å¼åƒåœ¾å›æ”¶å™¨ï¼šä¸€æ—¦è¿è¡Œï¼Œå°±åœæ­¢åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ï¼Œç›´åˆ°åƒåœ¾å›æ”¶è¿‡ç¨‹å®Œå…¨ç»“æŸã€‚</li>
</ul>
<p>æŒ‰ç…§ç¢ç‰‡å¤„ç†æ–¹å¼åˆ†ï¼š</p>
<ul>
<li>å‹ç¼©å¼åƒåœ¾å›æ”¶å™¨ï¼šå›æ”¶å®Œæˆåï¼Œå¯¹å­˜æ´»å¯¹è±¡è¿›è¡Œå‹ç¼©æ•´ç†ï¼Œæ¶ˆé™¤å›æ”¶åçš„ç¢ç‰‡ã€‚</li>
<li>éå‹ç¼©å¼çš„åƒåœ¾å›æ”¶å™¨ï¼šå›æ”¶å®Œæˆä¸è¿›è¡Œå‹ç¼©ã€‚</li>
</ul>
<p>æŒ‰ç…§å·¥ä½œçš„å†…å­˜åŒºé—´åˆ†ï¼š</p>
<ul>
<li>å¹´è½»ä»£åƒåœ¾å›æ”¶å™¨</li>
<li>è€å¹´ä»£åƒåœ¾å›æ”¶å™¨</li>
</ul>
<blockquote>
<p>ğŸ“ˆè¯„ä¼°GCçš„æ€§èƒ½æŒ‡æ ‡</p>
</blockquote>
<ul>
<li>ååé‡ï¼šè¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´å æ€»è¿è¡Œæ—¶é—´çš„æ¯”ä¾‹ï¼ˆæ€»è¿è¡Œæ—¶é—´ = ç¨‹åºçš„è¿è¡Œæ—¶é—´ + å†…å­˜å›æ”¶çš„æ—¶é—´ï¼‰</li>
<li>åƒåœ¾å¼€é”€ï¼šååé‡çš„è¡¥æ•°ï¼Œåƒåœ¾æ‰€ç”¨æ—¶é—´å æ€»è¿è¡Œæ—¶é—´çš„æ¯”ä¾‹</li>
<li>æš‚åœæ—¶é—´ï¼šæ‰§è¡Œåƒåœ¾æ—¶ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹è¢«æš‚åœçš„æ—¶é—´</li>
<li>é¢‘ç‡ï¼šç›¸å¯¹äºåº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼Œæ“ä½œå‘ç”Ÿçš„é¢‘ç‡</li>
<li>å†…å­˜å ç”¨ï¼šJavaå †åŒºæ‰€å çš„å†…å­˜å¤§å°</li>
<li>å¿«é€Ÿï¼šä¸€ä¸ªå¯¹è±¡ä»è¯ç”Ÿåˆ°è¢«å›æ”¶æ‰€ç»å†çš„æ—¶é—´</li>
</ul>
<p>ä¸»è¦æŠ“ä½ä¸¤ç‚¹ï¼šååé‡å’Œæš‚åœæ—¶é—´</p>
<p>ç”±äºé«˜ååé‡å’Œä½æš‚åœæ—¶é—´æ˜¯ä¸¤ä¸ªå¯¹ç«‹çš„æ¡ä»¶ï¼Œä¸€ä¸ªGCç®—æ³•åªå¯èƒ½é’ˆå¯¹ä¸¤ä¸ªç›®æ ‡ä¹‹ä¸€ï¼Œæˆ–è€…å°è¯•ä¸€ä¸ªäºŒè€…çš„æŠ˜ä¸­ã€‚</p>
<p>ç°åœ¨æ ‡å‡†ï¼šåœ¨æœ€å¤§ååé‡ä¼˜å…ˆçš„æƒ…å†µä¸‹ï¼Œé™ä½åœé¡¿æ—¶é—´ã€‚</p>
<h3 id="15-2-ğŸ“–-ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°"><a href="#15-2-ğŸ“–-ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°" class="headerlink" title="15.2 ğŸ“– ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°"></a>15.2 ğŸ“– ä¸åŒçš„åƒåœ¾å›æ”¶å™¨æ¦‚è¿°</h3><blockquote>
<p>ğŸ›å†å²</p>
</blockquote>
<div class="hide-block"><button type="button" class="hide-button button--animated" style="background-color:  orange;color:  white">æ—¶é—´çº¿
    </button><div class="hide-content"></div></div>

<pre><code>&#123;% timeline æ—¶é—´çº¿ %&#125;

&#123;% timenode 2001-05-17 JDK1.3.1 %&#125;

ç¬¬ä¸€æ¬¾GCâ€”â€”ä¸²è¡ŒSerial GCå‘å¸ƒã€‚PerNew GCæ˜¯Serial GCçš„å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚

&#123;% endtimenode %&#125;

&#123;% timenode 2003-06-26 JDK1.4.2 %&#125;

Parallel GCå’ŒConsurrent Mark Sweep GCå‘å¸ƒã€‚

&#123;% endtimenode %&#125;

&#123;% timenode 2006-12-11 JDK1.6 %&#125;

Parallel GCç”ŸæˆHotspoté»˜è®¤GCã€‚

&#123;% endtimenode %&#125;

&#123;% timenode 2012 JDK1.7u4 %&#125;

G1å¯ç”¨ã€‚

&#123;% endtimenode %&#125;

&#123;% timenode 2017-09-21 JDK9 %&#125;

G1æˆä¸ºé»˜è®¤å›æ”¶å™¨ï¼Œä»£æ›¿CMSã€‚

&#123;% endtimenode %&#125;

&#123;% timenode 2018-03-21 JDK10 %&#125;

G1åƒåœ¾å›æ”¶å™¨çš„å¹¶è¡Œå®Œæ•´åƒåœ¾å›æ”¶ï¼Œå®ç°å¹¶è¡Œæ€§æ¥æ”¹å–„æœ€åæƒ…å†µä¸‹çš„å»¶è¿Ÿã€‚

&#123;% endtimenode %&#125;

&#123;% timenode 2018-09-25 JDK11 %&#125;

å¼•å…¥Epsilonåƒåœ¾å™¨ï¼ŒåŒæ—¶å¼•å…¥ZGCã€‚

&#123;% endtimenode %&#125;

&#123;% timenode 2019-03-19 JDK12 %&#125;

å¢å¼ºG1ï¼ˆè‡ªåŠ¨è¿”å›æœªç”¨å †å†…å­˜ç»™æ“ä½œç³»ç»Ÿï¼‰ã€‚åŒæ—¶ï¼Œå¼•å…¥Shenandoah GCã€‚

&#123;% endtimenode %&#125;

&#123;% timenode 2019-09-17 JDK13 %&#125;

å¢å¼ºZGCï¼ˆè‡ªåŠ¨è¿”å›æœªç”¨å †å†…å­˜ç»™æ“ä½œç³»ç»Ÿï¼‰ã€‚

&#123;% endtimenode %&#125;

&#123;% timenode 2020-03-17 JDK14 %&#125;

åˆ é™¤CMSï¼Œæ‰©å±•ZGCåœ¨macOSå’ŒWindowsä¸Šçš„åº”ç”¨ã€‚

&#123;% endtimenode %&#125;

&#123;% endtimeline %&#125;</code></pre>
<blockquote>
<p>ğŸ¨åˆ†ç±»</p>
</blockquote>
<ul>
<li>ä¸²è¡Œå›æ”¶å™¨ï¼šSerialã€Serial Old</li>
<li>å¹¶è¡Œå›æ”¶å™¨ï¼šParNewã€Parallel Scavengeã€Parallel Old</li>
<li>å¹¶å‘å›æ”¶å™¨ï¼šCMSã€G1</li>
</ul>
<blockquote>
<p>ğŸ“·å›¾ç¤º</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11567/image-20210402212144659.png" class="" title="image-20210402212144659.png">

<ul>
<li>æ–°ç”Ÿä»£å›æ”¶å™¨ï¼šSerialã€ParNewã€Parallel Scavenge</li>
<li>è€å¹´ä»£å›æ”¶å™¨ï¼šSerial Oldã€Parallel Oldã€CMS</li>
<li>æ•´å †å›æ”¶å™¨ï¼šG1</li>
</ul>
<blockquote>
<p>â“ä¸ºä»€ä¹ˆè¦æœ‰å¾ˆå¤šåƒåœ¾å›æ”¶å™¨ï¼Œä¸€ä¸ªä¸å¤Ÿå—ï¼Ÿ</p>
</blockquote>
<p>å› ä¸ºJavaçš„ä½¿ç”¨åœºæ™¯å¾ˆå¤šï¼Œç§»åŠ¨ç«¯ã€æœåŠ¡ç«¯ç­‰ã€‚æ‰€ä»¥å°±éœ€è¦é’ˆå¯¹ä¸åŒçš„åœºæ™¯ï¼Œæä¾›ä¸åŒçš„åƒåœ¾å›æ”¶å™¨ï¼Œæé«˜åƒåœ¾çš„æ€§èƒ½ã€‚</p>
<p>è™½ç„¶æˆ‘ä»¬ä¼šå¯¹å„ä¸ªå™¨è¿›è¡Œæ¯”è¾ƒï¼Œä½†å¹¶éä¸ºäº†æŒ‘é€‰ä¸€ä¸ªæœ€å¥½çš„å™¨å‡ºæ¥ã€‚æ²¡æœ‰ä¸€ç§æ”¾ä¹‹å››æµ·è€Œçš†å‡†ã€ä»»ä½•åœºæ™¯éƒ½é€‚ç”¨çš„å®Œç¾å™¨å­˜åœ¨ï¼Œæ›´åŠ æ²¡æœ‰ä¸‡èƒ½çš„å™¨ã€‚æ‰€ä»¥æˆ‘ä»¬é€‰æ‹©çš„åªæ˜¯å¯¹å…·ä½“åº”ç”¨æœ€åˆé€‚çš„å™¨ã€‚</p>
<blockquote>
<p>â“å¦‚ä½•æŸ¥çœ‹é»˜è®¤çš„åƒåœ¾å™¨ï¼Ÿ</p>
</blockquote>
<ul>
<li>ç¨‹åºä¸­ï¼š<code>-XX:+PrintCommandLineFlags</code></li>
<li>å‘½ä»¤è¡Œï¼š<code>jinfo -flag &lt;å‚æ•°&gt; &lt;è¿›ç¨‹ID&gt;</code></li>
</ul>
<h3 id="15-3-1ï¸âƒ£-Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶"><a href="#15-3-1ï¸âƒ£-Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶" class="headerlink" title="15.3 1ï¸âƒ£ Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶"></a>15.3 1ï¸âƒ£ Serialå›æ”¶å™¨ï¼šä¸²è¡Œå›æ”¶</h3><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>Serialå›æ”¶å™¨æ˜¯æœ€åŸºæœ¬ã€å†å²æœ€æ‚ ä¹…çš„åƒåœ¾å›æ”¶å™¨äº†ã€‚JDK1.3ä¹‹å‰å›æ”¶æ–°ç”Ÿä»£çš„å”¯ä¸€é€‰æ‹©ã€‚</li>
<li>Serialå›æ”¶å™¨ä½œä¸ºHotSpotä¸­Clientæ¨¡å¼ä¸‹çš„é»˜è®¤æ–°ç”Ÿä»£åƒåœ¾å™¨ã€‚</li>
<li>Serialå›æ”¶å™¨é‡‡ç”¨å¤åˆ¶ç®—æ³•ã€ä¸²è¡Œå›æ”¶å’ŒSTWæœºåˆ¶çš„æ–¹å¼æ‰§è¡Œå†…å­˜å›æ”¶ã€‚</li>
<li>é™¤äº†å¹´è½»ä»£ä¹‹å¤–ï¼ŒSerialå›æ”¶å™¨è¿˜æä¾›äº†ç”¨äºæ‰§è¡Œè€å¹´ä»£åƒåœ¾æ”¶é›†çš„Serial Oldå›æ”¶å™¨ã€‚Serial Oldæ”¶é›†å™¨åŒæ ·ä¹Ÿé‡‡ç”¨äº†ä¸²è¡Œå›æ”¶å’ŒSTWæœºåˆ¶ï¼Œåªä¸è¿‡å†…å­˜å›æ”¶ç®—æ³•ä½¿ç”¨çš„æ˜¯æ ‡è®°-å‹ç¼©ç®—æ³•ã€‚</li>
<li>Serial Oldæ˜¯è¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹é»˜è®¤çš„è€å¹´ä»£çš„åƒåœ¾å›æ”¶å™¨ã€‚</li>
<li>Serial Oldåœ¨Serveræ¨¡å¼ä¸‹ä¸»è¦æœ‰ä¸¤ä¸ªç”¨é€”ï¼šä¸æ–°ç”Ÿä»£çš„Parallel Scanvengeé…åˆä½¿ç”¨ï¼Œä½œä¸ºè€å¹´ä»£CMSå›æ”¶å™¨çš„åå¤‡åƒåœ¾æ–¹æ¡ˆã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<p>Serialå›æ”¶å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„å›æ”¶å™¨ï¼Œä½†å®ƒå•çº¿ç¨‹çš„æ„ä¹‰å¹¶ä¸ä»…ä»…è¯´æ˜å®ƒåªä¼šä½¿ç”¨ä¸€ä¸ªCPUæˆ–ä¸€æ¡å›æ”¶çº¿ç¨‹å»å®Œæˆåƒåœ¾å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯åœ¨å®ƒè¿›è¡Œåƒåœ¾æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°å®ƒç»“æŸã€‚</p>
<p>ä¼˜åŠ¿ï¼šç®€å•è€Œé«˜æ•ˆï¼Œå¯¹äºé™å®šå•ä¸ªCPUçš„ç¯å¢ƒæ¥è¯´ï¼ŒSerialæ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œä¸“å¿ƒåšåƒåœ¾å›æ”¶è‡ªç„¶å¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ•ˆç‡ã€‚è¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹çš„è™šæ‹Ÿæœºæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
<p>åœ¨ç”¨æˆ·çš„æ¡Œé¢åº”ç”¨åœºæ™¯ä¸­ï¼Œå¯ç”¨å†…å­˜ä¸€èˆ¬ä¸å¤§ï¼Œå¯ä»¥åœ¨è¾ƒçŸ­æ—¶é—´å†…å®Œæˆåƒåœ¾ï¼Œåªè¦ä¸é¢‘ç¹å‘ç”Ÿï¼Œä½¿ç”¨ä¸²è¡Œå›æ”¶å™¨æ˜¯å¯ä»¥æ¥å—çš„ã€‚</p>
<p>å¯¹äºäº¤äº’æ€§è¾ƒå¼ºçš„åº”ç”¨è€Œè¨€ï¼Œè¿™ç§åƒåœ¾å›æ”¶å™¨æ˜¯ä¸èƒ½æ¥å—çš„ã€‚ä¸€èˆ¬Java Webåº”ç”¨ç¨‹åºä¸­æ˜¯ä¸ä¼šé‡‡ç”¨ä¸²è¡Œåƒåœ¾å™¨çš„ã€‚</p>
<blockquote>
<p>âš™ï¸é…ç½®</p>
</blockquote>
<p>åœ¨HotSpotè™šæ‹Ÿæœºä¸­ï¼Œä½¿ç”¨<code>-XX:+UseSerialGC</code>å‚æ•°å¯ä»¥æŒ‡å®šå¹´è½»ä»£å’Œè€å¹´ä»£éƒ½ä½¿ç”¨ä¸²è¡Œå™¨ã€‚ç­‰ä»·äºæ–°ç”Ÿä»£ä½¿ç”¨Serial GCï¼Œä¸”è€å¹´ä»£è¿˜æœ‰é‚£ä¸ªSerial Old GCã€‚</p>
<h3 id="15-4-2ï¸âƒ£-ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶"><a href="#15-4-2ï¸âƒ£-ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶" class="headerlink" title="15.4 2ï¸âƒ£ ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶"></a>15.4 2ï¸âƒ£ ParNewå›æ”¶å™¨ï¼šå¹¶è¡Œå›æ”¶</h3><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>å¦‚æœè¯´Serial GCæ˜¯å¹´è½»ä»£ä¸­çš„å•çº¿ç¨‹åƒåœ¾å›æ”¶å™¨ï¼Œé‚£ä¹ˆParNewæ”¶é›†å™¨åˆ™æ˜¯Serialå›æ”¶å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ã€‚ï¼ˆParæ˜¯Parallelçš„ç¼©å†™ï¼ŒNewåªèƒ½å¤„ç†æ–°ç”Ÿä»£ï¼‰</li>
<li>ParNewå›æ”¶å™¨é™¤äº†é‡‡ç”¨å¹¶è¡Œå›æ”¶çš„æ–¹å¼æ‰§è¡Œå†…å­˜å›æ”¶å¤–ï¼Œä¸¤æ¬¾åƒåœ¾å›æ”¶å™¨ä¹‹é—´å‡ ä¹æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚ParNewæ”¶é›†å™¨åœ¨å¹´è½»ä»£ä¸­åŒæ ·ä¹Ÿæ˜¯é‡‡ç”¨å¤åˆ¶ç®—æ³•ã€STWæœºåˆ¶ã€‚</li>
<li>ParNewæ˜¯å¾ˆå¤šJVMè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹æ–°ç”Ÿä»£çš„é»˜è®¤åƒåœ¾æ”¶é›†å™¨ã€‚</li>
<li>å¯¹äºæ–°ç”Ÿä»£ï¼Œå›æ”¶æ¬¡æ•°é¢‘ç¹ï¼Œä½¿ç”¨å¹¶è¡Œæ–¹å¼é«˜æ•ˆã€‚</li>
<li>å¯¹äºè€å¹´ä»£ï¼Œå›æ”¶æ¬¡æ•°å°‘ï¼Œä½¿ç”¨ä¸²è¡Œæ–¹å¼èŠ‚çœèµ„æºã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<ul>
<li>åœ¨å¤šCPUçš„ç¯å¢ƒä¸‹ï¼ŒParNewç”±äºå¯ä»¥å……åˆ†åˆ©ç”¨å¤šCPUã€å¤šæ ¸å¿ƒç­‰ç‰©ç†ç¡¬ä»¶ç­‰èµ„æºä¼˜åŠ¿ï¼Œå¯ä»¥æ›´å¿«é€Ÿåœ°å®Œæˆåƒåœ¾æ”¶é›†ï¼Œæå‡ç¨‹åºçš„ååé‡ã€‚</li>
<li>ä½†æ˜¯åœ¨å•ä¸ªCPUçš„ç¯å¢ƒä¸‹ï¼ŒParNewå›æ”¶å™¨å¹¶æ²¡æœ‰Serialé«˜æ•ˆã€‚</li>
<li>é™¤äº†Serialå¤–ï¼Œç›®å‰åªæœ‰ParNew GCèƒ½ä¸CMSæ”¶é›†å™¨é…åˆå·¥ä½œã€‚</li>
</ul>
<blockquote>
<p>âš™ï¸é…ç½®</p>
</blockquote>
<ul>
<li><code>-XX:+UseParNewGC</code>ï¼šæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨ParNewå›æ”¶å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ã€‚ï¼ˆè¡¨ç¤ºå¹´è½»ä»£ä½¿ç”¨å¹¶è¡Œå›æ”¶å™¨ï¼Œä¸å½±å“è€å¹´ä»£ï¼‰</li>
<li><code>-XX:ParallelGCThreads</code>ï¼šé™åˆ¶çº¿ç¨‹æ•°é‡ã€‚ï¼ˆé»˜è®¤å¼€å¯å’ŒCPUæ•°æ®ç›¸åŒçš„çº¿ç¨‹æ•°ï¼‰</li>
</ul>
<h3 id="15-5-3ï¸âƒ£-Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ"><a href="#15-5-3ï¸âƒ£-Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ" class="headerlink" title="15.5 3ï¸âƒ£ Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ"></a>15.5 3ï¸âƒ£ Parallelå›æ”¶å™¨ï¼šååé‡ä¼˜å…ˆ</h3><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>HotSpotçš„å¹´è½»ä»£é™¤äº†æ‹¥æœ‰ParNewå›æ”¶å™¨æ˜¯åŸºäºå¹¶è¡Œå›æ”¶çš„ä»¥å¤–ï¼ŒParallel ScavengeåŒæ ·ä¹Ÿé‡‡ç”¨äº†å¤åˆ¶ç®—æ³•ã€å¹¶è¡Œå›æ”¶å’ŒSTWæœºåˆ¶ã€‚</li>
<li>å’ŒParNewå›æ”¶å™¨ä¸åŒï¼ŒParallel Scavengeå›æ”¶å™¨çš„ç›®æ ‡åˆ™æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ï¼Œå®ƒä¹Ÿè¢«ç§°ä¸ºååé‡ä¼˜å…ˆçš„åƒåœ¾å›æ”¶å™¨ï¼Œè‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ä¹Ÿæ˜¯Parallel Scavengeçš„ä¸€ä¸ªé‡è¦åŒºåˆ«ã€‚</li>
<li>é«˜ååé‡åˆ™å¯ä»¥é«˜æ•ˆç‡åœ°åˆ©ç”¨CPUæ—¶é—´ï¼Œå°½å¿«å®Œæˆç¨‹åºçš„è¿ç®—ä»»åŠ¡ï¼Œä¸»è¦é€‚åˆåœ¨åå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„ä»»åŠ¡ã€‚å› æ­¤ï¼Œå¸¸è§åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œé‚£äº›æ‰§è¡Œæ‰¹é‡å¤„ç†ã€è®¢å•å¤„ç†ã€å·¥èµ„æ”¯ä»˜ã€ç§‘å­¦è®¡ç®—çš„åº”ç”¨ç¨‹åºã€‚</li>
<li>Parallelå›æ”¶å™¨åœ¨JDK1.6æ—¶æä¾›äº†ç”¨äºæ‰§è¡Œè€å¹´ä»£åƒåœ¾æ”¶é›†çš„Parallel Oldæ”¶é›†å™¨ï¼Œç”¨æ¥ä»£æ›¿è€å¹´ä»£çš„Serial Oldæ”¶é›†å™¨ã€‚</li>
<li>Parallel Oldå›æ”¶å™¨é‡‡ç”¨äº†æ ‡è®°-å‹ç¼©ç®—æ³•ï¼Œä½†åŒæ ·ä¹Ÿæ˜¯åŸºäºå¹¶è¡Œå›æ”¶å’ŒSTWæœºåˆ¶ã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<p>åœ¨ç¨‹åºååé‡ä¼˜å…ˆçš„åº”ç”¨åœºæ™¯ä¸­ï¼ŒParallel Oldæ”¶é›†å™¨çš„ç»„åˆï¼Œåœ¨Serveræ¨¡å¼ä¸‹çš„å†…å­˜å›æ”¶æ€§èƒ½å¾ˆä¸é”™ã€‚</p>
<blockquote>
<p>âš™ï¸é…ç½®</p>
</blockquote>
<ul>
<li><code>-XX:+UseParallelGC</code>ï¼šæ‰‹åŠ¨æŒ‡å®šå¹´è½»ä»£ä½¿ç”¨Parallelå¹¶è¡Œå›æ”¶å™¨ã€‚</li>
<li><code>-XX:+UseParallelOldGC</code>ï¼šæ‰‹åŠ¨æŒ‡å®šè€å¹´ä»£ä½¿ç”¨Parallelå¹¶è¡Œå›æ”¶å™¨ã€‚</li>
<li><code>-XX:ParallelGCThreads</code>ï¼šè®¾ç½®å¹´è½»ä»£å¹¶è¡Œå›æ”¶å™¨çš„çº¿ç¨‹æ•°ã€‚ä¸€èˆ¬åœ°ï¼Œæœ€å¥½ä¸CPUæ•°é‡ç›¸ç­‰ï¼Œä»¥é¿å…è¿‡å¤šçš„çº¿ç¨‹æ•°å½±å“åƒåœ¾æ”¶é›†æ€§èƒ½ã€‚</li>
<li><code>-XX:MaxGCPauseMills=N</code>ï¼šè®¾ç½®åƒåœ¾å›æ”¶å™¨æœ€å¤§åœé¡¿æ—¶é—´ï¼ˆå³STWçš„æ—¶é—´ï¼‰ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚ä¸ºäº†å°½å¯èƒ½æŠŠåœé¡¿æ—¶é—´æ§åˆ¶åœ¨<code>MaxGCPauseMills</code>ä»¥å†…ï¼Œæ”¶é›†å™¨åœ¨å·¥ä½œæ—¶ä¼šè°ƒæ•´Javaå †å¤§å°æˆ–è€…å…¶ä»–ä¸€äº›å‚æ•°ã€‚å¯¹äºç”¨æˆ·æ¥è®²ï¼Œåœé¡¿æ—¶é—´è¶ŠçŸ­ä½“éªŒè¶Šå¥½ï¼›ä½†æ˜¯åœ¨æœåŠ¡ç«¯ï¼Œæˆ‘ä»¬æ³¨é‡é«˜å¹¶å‘ï¼Œæ•´ä½“çš„ååé‡ã€‚æ‰€ä»¥æœåŠ¡å™¨ç«¯é€‚åˆParallelï¼Œè¿›è¡Œæ§åˆ¶ã€‚</li>
<li><code>-XX:GCTimeRatio=N</code>ï¼šåƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ä¾‹ï¼ˆ= 1 / [N + 1]ï¼‰ï¼Œç”¨äºè¡¡é‡ååé‡çš„å¤§å°ã€‚0&lt;N&lt;100ï¼Œé»˜è®¤å€¼99ï¼Œå³åƒåœ¾å›æ”¶æ—¶é—´ä¸è¶…è¿‡1%ã€‚ä¸ä¸Šä¸€ä¸ªå‚æ•°æœ‰ä¸€å®šçŸ›ç›¾æ€§ï¼Œæš‚åœæ—¶é—´è¶Šé•¿ï¼ŒRadioå‚æ•°å°±å®¹æ˜“è¶…è¿‡è®¾å®šçš„æ¯”ä¾‹ã€‚</li>
<li><code>-XX:+UseAdaptiveSizePolicy</code>ï¼šè®¾ç½®Parallel Scavengeæ”¶é›†å™¨å…·æœ‰è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¹´è½»ä»£çš„å¤§å°ã€Edenå’ŒSurvivorçš„æ¯”ä¾‹ã€æ™‹å‡è€å¹´ä»£çš„å¯¹è±¡å¹´é¾„ç­‰å‚æ•°ä¼šè¢«è‡ªåŠ¨è°ƒæ•´ï¼Œå·²è¾¾åˆ°åœ¨å †å¤§å°ã€ååé‡å’Œåœé¡¿æ—¶é—´ä¹‹é—´çš„å¹³è¡¡ç‚¹ã€‚åœ¨æ‰‹åŠ¨è°ƒä¼˜æ¯”è¾ƒå›°éš¾çš„åœºåˆï¼Œè¯¾ç›´æ¥ä½¿ç”¨è¿™ç§è‡ªé€‚åº”çš„æ–¹å¼ï¼Œä»…æŒ‡å®šè™šæ‹Ÿæœºçš„æœ€å¤§å †ã€ç›®æ ‡çš„ååé‡ï¼ˆGCTimeRatioï¼‰å’Œåœé¡¿æ—¶é—´ï¼ˆMaxGCPauseMillsï¼‰ï¼Œè®©è™šæ‹Ÿæœºè‡ªå·±å®Œæˆè°ƒä¼˜å·¥ä½œã€‚</li>
<li>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“CPUæ•°é‡å°äº8ä¸ªæ—¶ï¼ŒParallelGCThreadsçš„å€¼ç­‰äºCPUæ•°é‡ï¼›åœ¨CPUæ•°é‡å¤§äº8ä¸ªæ—¶ï¼ŒParallelGCThreadsçš„å€¼ç­‰äº3 + [5 * CPU_COUNT / 8]ã€‚</li>
<li>JDK8é»˜è®¤ä½¿ç”¨Parallelå¹¶è¡Œå›æ”¶å™¨ï¼ŒåæœŸçš„JDKä¸­å¹´è½»ä»£å’Œè€å¹´ä»£ä»»æ„ä¸€ä¸ªå¼€å¯Parallelå¹¶è¡Œå›æ”¶å™¨ï¼Œå¦ä¸€ä¸ªä¹Ÿä¼šè¢«å¼€å¯ï¼Œäº’ç›¸æ¿€æ´»ã€‚</li>
</ul>
<h3 id="15-6-4ï¸âƒ£-CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ"><a href="#15-6-4ï¸âƒ£-CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ" class="headerlink" title="15.6 4ï¸âƒ£ CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ"></a>15.6 4ï¸âƒ£ CMSå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ</h3><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>åœ¨JDK1.5æ—¶æœŸï¼ŒHotSpotæ¨å‡ºäº†ä¸€æ¬¾åœ¨å¼ºäº¤äº’åº”ç”¨ä¸­å‡ ä¹å¯è®¤ä¸ºæœ‰åˆ’æ—¶ä»£æ„ä¹‰çš„åƒåœ¾å›æ”¶å™¨ï¼šCMS(Concurrent-Mark-Sweep)å›æ”¶å™¨ï¼Œè¿™æ¬¾å›æ”¶å™¨æ˜¯HotSpotè™šæ‹Ÿæœºä¸­ç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„å¹¶å‘å›æ”¶å™¨ï¼Œå®ƒç¬¬ä¸€æ¬¡å®ç°äº†è®©åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å·¥ä½œã€‚</li>
<li>CMSå›æ”¶å™¨çš„å…³æ³¨ç‚¹æ˜¯å°½å¯èƒ½ç¼©çŸ­åƒåœ¾æ”¶é›†æ—¶ç”¨æˆ·çº¿ç¨‹çš„åœé¡¿æ—¶é—´ã€‚åœé¡¿æ—¶é—´è¶ŠçŸ­ï¼ˆä½å»¶è¿Ÿï¼‰å°±è¶Šé€‚åˆä¸ç”¨æˆ·äº¤äº’çš„ç¨‹åºï¼Œè‰¯å¥½çš„å“åº”é€Ÿåº¦èƒ½æå‡ç”¨æˆ·ä½“éªŒã€‚</li>
<li>CMSçš„åƒåœ¾æ”¶é›†ç®—æ³•é‡‡ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼Œå¹¶ä¸”ä¹Ÿä¼šSTWã€‚</li>
<li>ä¸å¹¸çš„æ˜¯ï¼ŒCMSä½œä¸ºè€å¹´ä»£çš„å›æ”¶å™¨ï¼Œå´æ— æ³•ä¸JDK1.4.0ä¸­å·²ç»å­˜åœ¨çš„æ–°ç”Ÿä»£å›æ”¶å™¨Parallel Scavengeé…åˆå·¥ä½œï¼Œæ‰€ä»¥åœ¨JDK1.5ä¸­ä½¿ç”¨CMSæ¥æ”¶é›†è€å¹´ä»£çš„æ—¶å€™ï¼Œæ–°ç”Ÿä»£åªèƒ½é€‰æ‹©ParNewæˆ–è€…Serialæ”¶é›†å™¨ä¸­çš„ä¸€ä¸ªã€‚</li>
<li>JDK9ä¸­CMSè¢«æ ‡è®°ä¸ºDeprecateï¼ŒJDK14ä¸­CMSè¢«å½»åº•åˆ é™¤ã€‚</li>
<li>åœ¨G1å‡ºç°ä¹‹å‰ï¼ŒCMSçš„ä½¿ç”¨è¿˜æ˜¯éå¸¸å¹¿æ³›çš„ã€‚ä¸€ç›´åˆ°ä»Šå¤©ï¼Œä»ç„¶æœ‰å¾ˆå¤šç³»ç»Ÿä½¿ç”¨CMSã€‚</li>
</ul>
<blockquote>
<p>ğŸ”è¿‡ç¨‹</p>
</blockquote>
<p>CMSæ•´ä¸ªè¿‡ç¨‹æ¯”ä¹‹å‰çš„æ”¶é›†å™¨è¦å¤æ‚ï¼Œæ•´ä¸ªè¿‡ç¨‹åˆ†ä¸º4ä¸ªä¸»è¦é˜¶æ®µï¼Œå³åˆå§‹æ ‡è®°é˜¶æ®µã€å¹¶å‘æ ‡è®°é˜¶æ®µã€é‡æ–°æ ‡è®°é˜¶æ®µå’Œå¹¶å‘æ¸…é™¤é˜¶æ®µã€‚</p>
<p>ï¼ˆ1ï¼‰åˆå§‹æ ‡è®°ï¼ˆInitial-Markï¼‰é˜¶æ®µï¼šåœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼Œç¨‹åºæ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹éƒ½å°†ä¼šå› ä¸ºSTWæœºåˆ¶è€Œå‡ºç°çŸ­æš‚çš„æš‚åœï¼Œè¿™ä¸ªé˜¶æ®µçš„ä¸»è¦ä»»åŠ¡ä»…ä»…åªæ˜¯æ ‡è®°å‡ºGC Rootsèƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ã€‚ä¸€æ—¦æ ‡è®°å®Œæˆä¹‹åå°±ä¼šæ¢å¤ä¹‹å‰è¢«æš‚åœçš„æ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚ç”±äºç›´æ¥å…³è”å¯¹è±¡æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™é‡Œçš„é€Ÿåº¦éå¸¸å¿«ã€‚</p>
<p>ï¼ˆ2ï¼‰å¹¶å‘æ ‡è®°ï¼ˆConcurrent-Markï¼‰é˜¶æ®µï¼šä»GC Rootsçš„ç›´æ¥å…³è”å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹è€—æ—¶è¾ƒé•¿ä½†æ˜¯ä¸éœ€è¦åœé¡¿ç”¨æˆ·çº¿ç¨‹ï¼Œå¯ä»¥ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸€èµ·å¹¶å‘è¿è¡Œã€‚</p>
<p>ï¼ˆ3ï¼‰é‡æ–°æ ‡è®°ï¼ˆRemarkï¼‰é˜¶æ®µï¼šç”±äºåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µä¸­ï¼Œç¨‹åºçš„å·¥ä½œçº¿ç¨‹ä¼šå’Œåƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œï¼Œå› æ­¤ä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´ï¼Œå› ç”¨æˆ·ç¨‹åºç»§ç»­è¿ä½œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ï¼Œè¿™ä¸ªé˜¶æ®µçš„åœé¡¿æ—¶é—´é€šå¸¸ä¼šæ¯”åˆå§‹æ ‡è®°é˜¶æ®µç¨é•¿ä¸€äº›ï¼Œä½†ä¹Ÿè¿œæ¯”å¹¶å‘æ ‡è®°é˜¶æ®µçš„æ—¶é—´çŸ­ã€‚</p>
<p>ï¼ˆ4ï¼‰å¹¶å‘æ¸…é™¤ï¼ˆConcurrent-Sweepï¼‰é˜¶æ®µï¼šæ­¤é˜¶æ®µæ¸…ç†åˆ é™¤æ ‡è®°é˜¶æ®µåˆ¤æ–­çš„å·²ç»æ­»äº¡çš„å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜ç©ºé—´ã€‚ç”±äºä¸éœ€è¦ç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¸ªé˜¶æ®µä¹Ÿæ˜¯å¯ä»¥ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶å¹¶å‘çš„ã€‚</p>
<p>å°½ç®¡CMSæ”¶é›†å™¨é‡‡ç”¨çš„æ˜¯å¹¶å‘å›æ”¶ï¼ˆéç‹¬å å¼ï¼‰ï¼Œä½†æ˜¯åœ¨å…¶åˆå§‹åŒ–æ ‡è®°å’Œå†æ¬¡æ ‡è®°è¿™ä¸¤ä¸ªé˜¶æ®µä¸­ä»ç„¶éœ€è¦æ‰§è¡Œâ€œStop-the-Worldâ€æœºåˆ¶æš‚åœç¨‹åºä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œä¸è¿‡æš‚åœæ—¶é—´å¹¶ä¸ä¼šå¤ªé•¿ï¼Œå› æ­¤å¯ä»¥è¯´æ˜ç›®å‰æ‰€æœ‰çš„åƒåœ¾æ”¶é›†å™¨éƒ½åšä¸åˆ°å®Œå…¨ä¸éœ€è¦â€œstop-the-Worldâ€ï¼Œåªæ˜¯å°½å¯èƒ½åœ°ç¼©çŸ­æš‚åœæ—¶é—´ã€‚</p>
<p>ç”±äºæœ€è€—è´¹æ—¶é—´çš„å¹¶å‘æ ‡è®°ä¸å¹¶å‘æ¸…é™¤é˜¶æ®µéƒ½ä¸éœ€è¦æš‚åœå·¥ä½œï¼Œæ‰€ä»¥æ•´ä½“çš„å›æ”¶æ˜¯ä½åœé¡¿çš„ã€‚</p>
<p>å¦å¤–ï¼Œç”±äºåœ¨åƒåœ¾æ”¶é›†é˜¶æ®µç”¨æˆ·çº¿ç¨‹æ²¡æœ‰ä¸­æ–­ï¼Œæ‰€ä»¥åœ¨CMSå›æ”¶è¿‡ç¨‹ä¸­ï¼Œè¿˜åº”è¯¥ç¡®ä¿åº”ç”¨ç¨‹åºç”¨æˆ·çº¿ç¨‹æœ‰è¶³å¤Ÿçš„å†…å­˜å¯ç”¨ã€‚å› æ­¤ï¼ŒCMSæ”¶é›†å™¨ä¸èƒ½åƒå…¶ä»–æ”¶é›†å™¨é‚£æ ·ç­‰åˆ°è€å¹´ä»£å‡ ä¹å®Œå…¨è¢«å¡«æ»¡äº†å†è¿›è¡Œæ”¶é›†ï¼Œè€Œæ˜¯å½“å †å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ°æŸä¸€é˜ˆå€¼æ—¶ï¼Œä¾¿å¼€å§‹è¿›è¡Œå›æ”¶ï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºåœ¨CMSå·¥ä½œè¿‡ç¨‹ä¸­ä¾ç„¶æœ‰è¶³å¤Ÿçš„ç©ºé—´æ”¯æŒåº”ç”¨ç¨‹åºè¿è¡Œã€‚è¦æ˜¯CMSè¿è¡ŒæœŸé—´é¢„ç•™çš„å†…å­˜æ— æ³•æ»¡è¶³ç¨‹åºéœ€è¦ï¼Œå°±ä¼šå‡ºç°ä¸€æ¬¡â€œConcurrent Mode Failureâ€ å¤±è´¥ï¼Œè¿™æ—¶è™šæ‹Ÿæœºå°†å¯åŠ¨åå¤‡é¢„æ¡ˆï¼šä¸´æ—¶å¯ç”¨Serial oldæ”¶é›†å™¨æ¥é‡æ–°è¿›è¡Œè€å¹´ä»£çš„åƒåœ¾æ”¶é›†ï¼Œè¿™æ ·åœé¡¿æ—¶é—´å°±å¾ˆé•¿äº†ã€‚</p>
<p>CMSæ”¶é›†å™¨çš„åƒåœ¾æ”¶é›†ç®—æ³•é‡‡ç”¨çš„æ˜¯æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡æ‰§è¡Œå®Œå†…å­˜å›æ”¶åï¼Œç”±äºè¢«æ‰§è¡Œå†…å­˜å›æ”¶çš„æ— ç”¨å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ææœ‰å¯èƒ½æ˜¯ä¸è¿ç»­çš„ä¸€äº›å†…å­˜å—ï¼Œä¸å¯é¿å…åœ°å°†ä¼šäº§ç”Ÿä¸€äº›å†…å­˜ç¢ç‰‡ã€‚é‚£ä¹ˆCMSåœ¨ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´æ—¶ï¼Œå°†æ— æ³•ä½¿ç”¨æŒ‡é’ˆç¢°æ’ï¼ˆBump the Pointerï¼‰æŠ€æœ¯ï¼Œè€Œåªèƒ½å¤Ÿé€‰æ‹©ç©ºé—²åˆ—è¡¨ï¼ˆFree Listï¼‰æ‰§è¡Œå†…å­˜åˆ†é…ã€‚</p>
<p>é‚£ä¹ˆCMSä¸ºä»€ä¹ˆä¸é‡‡ç”¨æ ‡è®°æ•´ç†ç®—æ³•å‘¢ï¼Ÿå› ä¸ºå¹¶å‘æ”¶é›†åƒåœ¾çš„æ—¶å€™ï¼Œç”¨æˆ·çº¿ç¨‹ä¸ä¼šæš‚åœï¼Œæ•´ç†å†…å­˜ä¼šå¯¼è‡´ç”¨æˆ·çº¿ç¨‹çš„å¯¹è±¡å†…å­˜åœ°å€æ”¹å˜ã€‚</p>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¹¶å‘æ”¶é›†</li>
<li>ä½å»¶è¿Ÿ</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚å¯¼è‡´å¹¶å‘æ¸…é™¤åï¼Œç”¨æˆ·çº¿ç¨‹å¯ç”¨çš„ç©ºé—´ä¸è¶³ã€‚åœ¨æ— æ³•åˆ†é…å¤§å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œä¸å¾—ä¸æå‰è§¦å‘Full GCã€‚</li>
<li>CMSæ”¶é›†å™¨å¯¹CPUèµ„æºéå¸¸æ•æ„Ÿã€‚åœ¨å¹¶å‘é˜¶æ®µï¼Œå®ƒè™½ç„¶ä¸ä¼šå¯¼è‡´ç”¨æˆ·åœé¡¿ï¼Œä½†æ˜¯ä¼šå› ä¸ºå ç”¨äº†ä¸€éƒ¨åˆ†çº¿ç¨‹è€Œå¯¼è‡´åº”ç”¨ç¨‹åºå˜æ…¢ï¼Œæ€»ååé‡ä¼šé™ä½ã€‚</li>
<li>CMSæ”¶é›†å™¨æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ã€‚åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µç”±äºç¨‹åºçš„å·¥ä½œçº¿ç¨‹å’Œåƒåœ¾æ”¶é›†çº¿ç¨‹æ˜¯åŒæ—¶è¿è¡Œæˆ–è€…äº¤å‰è¿è¡Œçš„ï¼Œé‚£ä¹ˆåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µå¦‚æœäº§ç”Ÿæ–°çš„åƒåœ¾å¯¹è±¡ï¼ŒCMSå°†æ— æ³•å¯¹è¿™äº›åƒåœ¾å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œæœ€ç»ˆä¼šå¯¼è‡´è¿™äº›æ–°äº§ç”Ÿçš„åƒåœ¾å¯¹è±¡æ²¡æœ‰è¢«åŠæ—¶å›æ”¶ï¼Œä»è€Œåªèƒ½åœ¨ä¸‹ä¸€æ¬¡æ‰§è¡ŒGCæ—¶é‡Šæ”¾è¿™äº›ä¹‹å‰è¿èƒŒå›æ”¶çš„å†…å­˜ç©ºé—´ã€‚</li>
</ul>
<blockquote>
<p>âš™ï¸é…ç½®</p>
</blockquote>
<ul>
<li><code>-XX:+UseConcMarkSweepGC</code>ï¼šæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨CMSæ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ã€‚å¼€å¯è¯¥å‚æ•°åè‡ªåŠ¨å°†<code>-XX:+UseParNewGC</code>æ‰“å¼€ï¼Œå³ï¼šParNew(Young) + CMS(Old) + Serial Oldçš„ç»„åˆã€‚</li>
<li><code>-XX:CMSInitiatingOccupanyFraction</code>ï¼šè®¾ç½®å †å†…å­˜ä½¿ç”¨ç‡çš„é˜ˆå€¼ï¼Œä¸€æ—¦è¾¾åˆ°è¯¥é˜ˆå€¼ï¼Œä¾¿å¼€å§‹å›æ”¶ã€‚</li>
<li><code>-XX:+UseCMSCompactAtFullCollection</code>ï¼šç”¨äºæŒ‡å®šåœ¨æ‰§è¡Œå®ŒFull GCåå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©æ•´ç†ï¼Œä»¥æ­¤é¿å…å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿã€‚ä¸è¿‡ç”±äºå†…å­˜å‹ç¼©æ•´ç†è¿‡ç¨‹æ— æ³•å¹¶å‘æ‰§è¡Œï¼Œæ‰€å¸¦æ¥çš„é—®é¢˜å°±æ˜¯åœé¡¿æ—¶é—´å˜å¾—æ›´é•¿äº†ã€‚</li>
<li><code>-XX:CMSFullGCsBeforeCompaction</code>ï¼šè®¾ç½®åœ¨æ‰§è¡Œå¤šå°‘æ¬¡Full GCåå¯¹å†…å­˜ç©ºé—´è¿›è¡Œå‹ç¼©æ•´ç†ã€‚</li>
<li><code>-XX:ParallelCMSThreads</code>ï¼šè®¾ç½®CMSçš„çº¿ç¨‹æ•°é‡ã€‚CMSé»˜è®¤å¯åŠ¨çš„çº¿ç¨‹æ•°æ˜¯ï¼ˆParallelGCThreads + 3ï¼‰/ 4ï¼ŒParallelGCThreadsæ˜¯å¹´è½»ä»£å¹¶è¡Œå›æ”¶å™¨çš„çº¿ç¨‹æ•°ã€‚å½“CPUèµ„æºæ¯”è¾ƒç´§å¼ æ—¶ï¼Œå—åˆ°CMSæ”¶é›†å™¨çº¿ç¨‹çš„å½±å“ï¼Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½åœ¨åƒåœ¾å›æ”¶é˜¶æ®µä¼šéå¸¸ç³Ÿç³•ã€‚</li>
</ul>
<blockquote>
<p>âœ¨å°ç»“</p>
</blockquote>
<ul>
<li>å¦‚æœä½ æœ€æƒ³è¦æœ€å°åŒ–åœ°ä½¿ç”¨å†…å­˜å’Œå¹¶è¡Œå¼€é”€ï¼Œé€‰æ‹©Serial GC</li>
<li>å¦‚æœä½ æƒ³è¦æœ€å¤§åŒ–åº”ç”¨ç¨‹åºçš„ååé‡ï¼Œé€‰æ‹©Parallel GC</li>
<li>å¦‚æœä½ æƒ³è¦æœ€å°åŒ–GCçš„ä¸­æ–­æˆ–è€…åœé¡¿æ—¶é—´ï¼Œé€‰æ‹©CMS GC</li>
</ul>
<h3 id="15-7-5ï¸âƒ£-G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼"><a href="#15-7-5ï¸âƒ£-G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼" class="headerlink" title="15.7 5ï¸âƒ£ G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼"></a>15.7 5ï¸âƒ£ G1å›æ”¶å™¨ï¼šåŒºåŸŸåŒ–åˆ†ä»£å¼</h3><blockquote>
<p>ğŸŒƒèƒŒæ™¯</p>
</blockquote>
<p>éšç€åº”ç”¨ç¨‹åºæ‰€åº”å¯¹çš„ä¸šåŠ¡è¶Šæ¥è¶Šåºå¤§ã€å¤æ‚ï¼Œç”¨æˆ·è¶Šæ¥è¶Šå¤šï¼Œæ²¡æœ‰GCå°±ä¸èƒ½ä¿è¯åº”ç”¨ç¨‹åºæ­£å¸¸è¿›è¡Œï¼Œè€Œé€ æˆSTWçš„GCåˆè·Ÿä¸ä¸Šå®é™…çš„éœ€æ±‚ï¼Œæ‰€ä»¥æ‰ä¼šä¸æ–­å°è¯•å¯¹GCè¿›è¡Œä¼˜åŒ–ã€‚G1(Garbage-First)åƒåœ¾å›æ”¶å™¨æ˜¯åœ¨Java7 update 4ä¹‹åå¼•å…¥çš„ä¸€ä¸ªæ–°çš„åƒåœ¾å›æ”¶å™¨ï¼Œæ˜¯å½“ä»Šå›æ”¶å™¨æŠ€æœ¯å‘å±•çš„æœ€å‰æ²¿æˆæœä¹‹ä¸€ã€‚</p>
<p>ä¸æ­¤åŒæ—¶ï¼Œä¸ºäº†é€‚åº”ç°åœ¨ä¸æ–­æ‰©å¤§çš„å†…å­˜å’Œä¸æ–­å¢åŠ çš„å¤„ç†å™¨æ•°é‡ï¼Œè¿›ä¸€æ­¥é™ä½æš‚åœæ—¶é—´ï¼ŒåŒæ—¶å…¼é¡¾è‰¯å¥½çš„ååé‡ã€‚</p>
<p>å®˜æ–¹ç»™G1è®¾å®šçš„ç›®æ ‡æ˜¯åœ¨å»¶è¿Ÿå¯æ§çš„æƒ…å†µä¸‹è·å¾—å°½å¯èƒ½é«˜çš„ååé‡ï¼Œæ‰€ä»¥æ‰æ‹…èµ·â€œå…¨åŠŸèƒ½æ”¶é›†å™¨â€çš„è´£ä»»ä¸æœŸæœ›ã€‚</p>
<blockquote>
<p>âš¡åå­—</p>
</blockquote>
<ul>
<li>å› ä¸ºG1æ˜¯ä¸€ä¸ªå¹¶è¡Œå›æ”¶å™¨ï¼Œå®ƒæŠŠå †å†…å­˜åˆ†å‰²ä¸ºå¾ˆå¤šä¸ç›¸å…³çš„åŒºåŸŸï¼ˆRegionï¼‰ï¼ˆç‰©ç†ä¸Šä¸è¿ç»­çš„ï¼‰ã€‚ä½¿ç”¨ä¸åŒçš„Regionæ¥è¡¨ç¤ºEdenã€å¹¸å­˜è€…0åŒºã€å¹¸å­˜è€…1åŒºï¼Œè€å¹´ä»£ç­‰ã€‚</li>
<li>G1 GCæœ‰è®¡åˆ’åœ°é¿å…åœ¨æ•´ä¸ªJavaå †ä¸­è¿›è¡Œå…¨åŒºåŸŸçš„åƒåœ¾æ”¶é›†ã€‚G1è·Ÿè¸ªå„ä¸ªRegioné‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„åŒºåŸŸã€‚</li>
<li>ç”±äºè¿™ç§æ–¹å¼çš„ä¾§é‡ç‚¹åœ¨äºå›æ”¶åƒåœ¾æœ€å¤§é‡çš„Regionï¼Œæ‰€ä»¥æˆ‘ä»¬ç»™G1èµ·ä¸€ä¸ªåå­—ï¼šåƒåœ¾ä¼˜å…ˆï¼ˆGarbage-Firstï¼‰ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>G1æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„åƒåœ¾å›æ”¶å™¨ï¼Œä¸»è¦é’ˆå¯¹é…å¤‡å¤šæ ¸CPUåŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨ï¼Œä»¥æé«˜æ¦‚ç‡æ»¡è¶³GCåœé¡¿æ—¶é—´çš„åŒæ—¶ï¼Œè¿˜å…¼å…·é«˜ååé‡çš„æ€§èƒ½ç‰¹å¾ã€‚</p>
<p>åœ¨JDK1.7ç‰ˆæœ¬æ­£å¼å¯ç”¨ï¼Œç§»é™¤äº†Experimentalçš„æ ‡è¯†ã€‚åœ¨JDK8ä¸­è¿˜ä¸æ˜¯é»˜è®¤çš„åƒåœ¾å›æ”¶å™¨ï¼Œéœ€è¦ä½¿ç”¨<code>-XX:+UseG1GC</code>æ¥å¯ç”¨ã€‚åœ¨JDK9ä»¥åæˆä¸ºé»˜è®¤åƒåœ¾å›æ”¶å™¨ï¼Œå–ä»£äº†CMSå›æ”¶å™¨ä»¥åŠParallel + Parallel Oldç»„åˆï¼Œè¢«Oracleå®˜æ–¹ç§°ä¸ºå…¨åŠŸèƒ½çš„åƒåœ¾æ”¶é›†å™¨ã€‚</p>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<p>ä¸å…¶å®ƒçš„GCå›æ”¶å™¨ç›¸æ¯”ï¼ŒG1ä½¿ç”¨äº†å…¨æ–°çš„åˆ†åŒºç®—æ³•ï¼Œç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆ1ï¼‰å¹¶è¡Œä¸å¹¶å‘</p>
<ul>
<li>å¹¶è¡Œæ€§ï¼šG1åœ¨å›æ”¶æœŸé—´ï¼Œå¯ä»¥æœ‰å¤šä¸ªGCçº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œæœ‰æ•ˆåˆ©ç”¨å¤šæ ¸è®¡ç®—èƒ½åŠ›ã€‚</li>
<li>å¹¶å‘æ€§ï¼šG1æ‹¥æœ‰ä¸åº”ç”¨ç¨‹åºäº¤æ›¿æ‰§è¡Œçš„èƒ½åŠ›ï¼Œéƒ¨åˆ†å·¥ä½œå¯ä»¥å’Œåº”ç”¨ç¨‹åºåŒæ—¶æ‰§è¡Œï¼Œå› æ­¤ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸ä¼šåœ¨æ•´ä¸ªå›é¦–é˜¶æ®µå‘ç”Ÿå®Œå…¨é˜»å¡åº”ç”¨ç¨‹åºçš„æƒ…å†µã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰åˆ†ä»£æ”¶é›†</p>
<ul>
<li>ä»åˆ†ä»£ä¸Šçœ‹ï¼ŒG1ä¾ç„¶å±äºåˆ†ä»£å‹åƒåœ¾å›æ”¶å™¨ï¼Œå®ƒä¼šåŒºåˆ†å¹´è½»ä»£å’Œè€å¹´ä»£ï¼Œå¹´è½»ä»£ä¾ç„¶æœ‰EdenåŒºå’ŒSurvivoråŒºã€‚ä½†ä»å †çš„ç»“æ„ä¸Šçœ‹ï¼Œå®ƒä¸è¦æ±‚æ•´ä¸ªEdenåŒºã€å¹´è½»ä»£æˆ–è€…è€å¹´ä»£éƒ½æ˜¯è¿ç»­çš„ï¼Œä¹Ÿä¸å†åšæŒå›ºå®šå¤§å°å’Œå›ºå®šæ•°é‡ã€‚</li>
<li>å°†å †ç©ºé—´åˆ†ä¸ºè‹¥å¹²ä¸ªåŒºåŸŸï¼Œè¿™äº›åŒºåŸŸä¸­åŒ…å«äº†é€»è¾‘ä¸Šçš„å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚</li>
<li>å’Œä¹‹å‰çš„å„ç±»å›æ”¶å™¨ä¸åŒï¼Œå®ƒåŒæ—¶å…¼é¡¾å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚å¯¹æ¯”å…¶ä»–å›æ”¶å™¨ï¼Œæˆ–è€…å·¥ä½œåœ¨å¹´è½»ä»£ã€æˆ–è€…å·¥ä½œåœ¨è€å¹´ä»£ã€‚</li>
</ul>
<p>ï¼ˆ3ï¼‰ç©ºé—´æ•´åˆ</p>
<ul>
<li>CMSï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•ã€å†…å­˜ç¢ç‰‡ã€è‹¥å¹²æ¬¡GCåä¸€æ¬¡ç¢ç‰‡æ•´ç†ã€‚</li>
<li>G1å°†å†…å­˜åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªçš„regionï¼Œå†…å­˜çš„å›æ”¶æ˜¯ä»¥regionä½œä¸ºåŸºæœ¬å•ä½çš„ã€‚regionä¹‹é—´æ˜¯å¤åˆ¶ç®—æ³•ï¼Œä½†æ•´ä½“ä¸Šå®é™…å¯çœ‹åšæ˜¯æ ‡è®°-å‹ç¼©ç®—æ³•ï¼Œä¸¤ç§ç®—æ³•éƒ½å¯ä»¥é¿å…å†…å­˜ç¢ç‰‡ã€‚è¿™ç§ç‰¹æ€§æœ‰åˆ©äºç¨‹åºé•¿æ—¶é—´è¿è¡Œï¼Œåˆ†é…å¤§å¯¹è±¡æ—¶ä¸ä¼šå› ä¸ºæ— æ³•æ‰¾åˆ°è¿ç»­å†…å­˜ç©ºé—´è€Œæå‰è§¦å‘ä¸‹ä¸€æ¬¡GCã€‚å°¤å…¶æ˜¯å½“Javaå †éå¸¸å¤§çš„æ—¶å€™ã€‚G1çš„ä¼˜åŠ¿æ›´åŠ æ˜æ˜¾ã€‚</li>
</ul>
<p>ï¼ˆ4ï¼‰å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹</p>
<p>è¿™æ˜¯G1ç›¸å¯¹äºCMSçš„å¦ä¸€å¤§ä¼˜åŠ¿ï¼ŒG1é™¤äº†è¿½æ±‚ä½åœé¡¿å¤–ï¼Œè¿˜èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼Œèƒ½è®©ä½¿ç”¨è€…æ˜ç¡®æŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸ºMæ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œæ¶ˆè€—åœ¨åƒåœ¾æ”¶é›†ä¸Šçš„æ—¶é—´ä¸å¾—è¶…è¿‡Næ¯«ç§’ã€‚</p>
<ul>
<li>ç”±äºåˆ†åŒºçš„åŸå› ï¼ŒG1å¯ä»¥åªé€‰å–éƒ¨åˆ†åŒºåŸŸè¿›è¡Œå†…å­˜å›æ”¶ï¼Œè¿™æ ·ç¼©å°äº†å›æ”¶çš„èŒƒå›´ï¼Œå› æ­¤å¯¹äºå…¨å±€åœé¡¿æƒ…å†µçš„å‘ç”Ÿä¹Ÿèƒ½å¾—åˆ°è¾ƒå¥½çš„æ§åˆ¶ã€‚</li>
<li>G1è·Ÿè¸ªå„ä¸ªregioné‡Œé¢çš„åƒåœ¾å †ç§¯çš„ä»·å€¼å¤§å°ï¼ˆå›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€çš„æ—¶é—´çš„ç»éªŒå€¼ï¼‰ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆåˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆå›æ”¶ä»·å€¼æœ€å¤§çš„regionã€‚ä¿è¯äº†G1å›æ”¶å™¨åœ¨æœ‰é™çš„æ—¶é—´å†…å¯ä»¥è·å–å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡ã€‚</li>
<li>ç›¸æ¯”äºCMS GCï¼ŒG1æœªå¿…èƒ½åšåˆ°CMSåœ¨åšå¥½çš„æƒ…å†µä¸‹çš„å»¶æ—¶åœé¡¿ï¼Œä½†æ˜¯æœ€å·®æƒ…å†µè¦å¥½å¾ˆå¤šã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ ç¼ºç‚¹</p>
</blockquote>
<p>ç›¸è¾ƒäºCMSï¼ŒG1è¿˜ä¸å…·å¤‡å…¨æ–¹ä½ã€å‹å€’æ€§ä¼˜åŠ¿ã€‚æ¯”å¦‚åœ¨ç”¨æˆ·ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒG1æ— è®ºæ˜¯ä¸ºäº†åƒåœ¾æ”¶é›†äº§ç”Ÿçš„å†…å­˜å ç”¨è¿˜æ˜¯ç¨‹åºè¿è¡Œæ—¶çš„é¢å¤–æ‰§è¡Œè´Ÿè½½éƒ½è¦æ¯”CMSè¦é«˜ã€‚</p>
<p>ä»ç»éªŒä¸Šæ¥è¯´ï¼Œåœ¨å°å†…å­˜åº”ç”¨ä¸ŠCMSçš„è¡¨ç°å¤§æ¦‚ç‡ä¼šä¼˜äºG1ï¼Œè€ŒG1åœ¨å¤§å†…å­˜åº”ç”¨ä¸Šåˆ™å‘æŒ¥å…¶ä¼˜åŠ¿ã€‚å¹³è¡¡ç‚¹åœ¨6~8GBä¹‹é—´ã€‚</p>
<blockquote>
<p>âš™ï¸é…ç½®</p>
</blockquote>
<ul>
<li><code>-XX:+UseG1GC</code>ï¼šæ‰‹åŠ¨æŒ‡å®šä½¿ç”¨G1æ”¶é›†å™¨æ‰§è¡Œå†…å­˜å›æ”¶ä»»åŠ¡ã€‚</li>
<li><code>-XX:G1HeapRegionSize</code>ï¼šè®¾ç½®æ¯ä¸ªregionçš„å¤§å°ã€‚å€¼æ˜¯2çš„å¹‚ï¼ŒèŒƒå›´æ˜¯1MBåˆ°32MBä¹‹é—´ï¼Œç›®æ ‡æ˜¯æ ¹æ®æœ€å°çš„Javaå †å¤§å°åˆ’åˆ†å‡ºçº¦2048ä¸ªåŒºåŸŸã€‚é»˜è®¤æ˜¯å †å†…å­˜çš„1/2000ã€‚</li>
<li><code>-XX:MaxGCPauseMills</code>ï¼šè®¾ç½®æœŸæœ›è¾¾åˆ°çš„æœ€å¤§GCåœé¡¿æ—¶é—´æŒ‡æ ‡ï¼ˆJVMä¼šå°½åŠ›å®ç°ï¼Œä½†ä¸ä¿è¯è¾¾åˆ°ï¼‰ã€‚é»˜è®¤å€¼æ˜¯200msã€‚</li>
<li><code>-XX:ParallelGCThread</code>ï¼šè®¾ç½®STWå·¥ä½œçº¿ç¨‹çš„å€¼ã€‚æœ€å¤šè®¾ç½®ä¸º8ã€‚</li>
<li><code>-XX:ConcGCThreads</code>ï¼šè®¾ç½®å¹¶å‘æ ‡è®°çš„çº¿ç¨‹æ•°ã€‚å°†nè®¾ç½®ä¸ºå¹¶å‘åƒåœ¾å›æ”¶çº¿ç¨‹æ•°ï¼ˆParallelGCThreadsï¼‰çš„1/4å·¦å³ã€‚</li>
<li><code>-XX:InitiatingHeapOccupancyPercent</code>ï¼šè®¾ç½®è§¦å‘å¹¶å‘GCå‘¨æœŸçš„Javaå †å ç”¨ç‡é˜ˆå€¼ã€‚è¶…è¿‡æ­¤å€¼ï¼Œå°±è§¦å‘GCã€‚é»˜è®¤å€¼æ˜¯45ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’»ä½¿ç”¨</p>
</blockquote>
<p>G1çš„è®¾è®¡åŸåˆ™å°±æ˜¯ç®€åŒ–JVMæ€§èƒ½è°ƒä¼˜ï¼Œå¼€å‘äººå‘˜åªéœ€è¦ç®€å•çš„ä¸‰æ­¥å³å¯å®Œæˆè°ƒä¼˜ï¼š</p>
<p>ï¼ˆ1ï¼‰å¼€å¯G1åƒåœ¾å›æ”¶å™¨</p>
<p>ï¼ˆ2ï¼‰è®¾ç½®å †çš„æœ€å¤§å†…å­˜</p>
<p>ï¼ˆ3ï¼‰è®¾ç½®æœ€å¤§çš„åœé¡¿æ—¶é—´</p>
<p>G1æä¾›äº†ä¸‰ç§åƒåœ¾å›æ”¶æ¨¡å¼ï¼šYoung GCã€Mixed GCå’ŒFull GCï¼Œåœ¨ä¸åŒçš„æ¡ä»¶ä¸‹è¢«è§¦å‘ã€‚</p>
<blockquote>
<p>ğŸ”®é€‚ç”¨åœºæ™¯</p>
</blockquote>
<ul>
<li><p>é¢å‘æœåŠ¡ç«¯åº”ç”¨ï¼Œé’ˆå¯¹å…·æœ‰å¤§å†…å­˜ã€å¤šå¤„ç†å™¨çš„æœºå™¨ã€‚</p>
</li>
<li><p>æœ€ä¸»è¦çš„åº”ç”¨éœ€è¦ä½GCå»¶è¿Ÿï¼Œå¹¶å…·æœ‰å¤§å †çš„åº”ç”¨ç¨‹åºæä¾›è§£å†³æ–¹æ¡ˆã€‚</p>
</li>
<li><p>ç”¨æ¥æ›¿æ¢æ‰JDK1.5ä¸­çš„CMSæ”¶é›†å™¨ï¼Œåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼Œä½¿ç”¨G1æ¯”CMSå¥½ï¼š</p>
<ul>
<li>è¶…è¿‡50%çš„Javaå †è¢«æ´»åŠ¨æ•°æ®å ç”¨</li>
<li>å¯¹è±¡åˆ†é…é¢‘ç‡æˆ–å¹´ä»£æå‡é¢‘ç‡å˜åŒ–å¾ˆå¤§</li>
<li>GCåœé¡¿æ—¶é—´è¿‡é•¿</li>
</ul>
</li>
<li><p>HotSpotåƒåœ¾å›æ”¶å™¨é‡Œï¼Œé™¤äº†G1ä»¥å¤–ï¼Œå…¶ä»–çš„åƒåœ¾å›æ”¶å™¨ä½¿ç”¨å†…ç½®çš„JVMçº¿ç¨‹æ‰§è¡ŒGCçš„å¤šçº¿ç¨‹æ“ä½œï¼Œè€ŒG1 GCå¯ä»¥é‡‡ç”¨åº”ç”¨ç¨‹åºæ‰¿æ‹…åå°è¿è¡Œçš„GCå·¥ä½œï¼Œå³å½“JVMçš„GCçº¿ç¨‹å¤„ç†é€Ÿåº¦æ…¢æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨åº”ç”¨ç¨‹åºçº¿ç¨‹å¸®åŠ©åŠ é€Ÿåƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ”²åˆ†åŒºregionï¼šåŒ–æ•´ä¸ºé›¶</p>
</blockquote>
<p>ä½¿ç”¨G1å›æ”¶å™¨æ—¶ï¼Œå®ƒå°†æ•´ä¸ªJavaå †åˆ’åˆ†ä¸ºçº¦2048 ä¸ªå¤§å°ç›¸åŒçš„ç‹¬ç«‹regionå—ï¼Œæ¯ä¸ªregionå—å¤§å°æ ¹æ®å †ç©ºé—´çš„å®é™…å¤§å°è€Œå®šï¼Œæ•´ä½“è¢«æ§åˆ¶åœ¨1MBåˆ°32MBä¹‹é—´ï¼Œä¸”ä¸º2çš„Næ¬¡å¹‚ï¼Œå³1MBï¼Œ2MBï¼Œ4MBï¼Œ8MBï¼Œ16MBï¼Œ32MBã€‚å¯ä»¥é€šè¿‡<code>-XX:G1HeapRegionSize</code>è®¾å®šã€‚æ‰€æœ‰çš„regionå¤§å°éƒ½ç›¸åŒï¼Œä¸”åœ¨JVMç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šè¢«æ”¹å˜ã€‚</p>
<p>è™½ç„¶è¿˜ä¿ç•™ç€æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸å†æ˜¯ç‰©ç†éš”ç¦»çš„äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸€éƒ¨åˆ†regionï¼ˆä¸éœ€è¦è¿ç»­ï¼‰çš„é›†åˆã€‚é€šè¿‡regionçš„åŠ¨æ€åˆ†é…æ–¹å¼å®ç°é€»è¾‘ä¸Šçš„è¿ç»­ã€‚</p>
<p>ä¸€ä¸ªregionæœ‰å¯èƒ½å±äºEdenï¼ŒSurvivoræˆ–è€…Oldå†…å­˜åŒºåŸŸã€‚ä½†æ˜¯ä¸€ä¸ªregionåªå¯èƒ½å±äºä¸€ä¸ªè§’è‰²ã€‚G1åƒåœ¾å›æ”¶å™¨è¿˜å¢åŠ äº†ä¸€ç§æ–°çš„å†…å­˜åŒºåŸŸï¼Œå«åšHumongouså†…å­˜åŒºåŸŸã€‚</p>
<p>è®¾ç½®Humongousçš„åŸå› ï¼šå¯¹äºå †ä¸­çš„å¤§å¯¹è±¡ï¼Œé»˜è®¤ç›´æ¥ä¼šè¢«åˆ†é…åˆ°è€å¹´ä»£ï¼Œä½†æ˜¯å¦‚æœå®ƒæ˜¯ä¸€ä¸ªçŸ­æœŸå­˜åœ¨çš„å¤§å¯¹è±¡ï¼Œå°±ä¼šå¯¹åƒåœ¾æ”¶é›†å™¨é€ æˆè´Ÿé¢å½±å“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒG1åˆ’åˆ†äº†ä¸€ä¸ªHumongousåŒºï¼Œå®ƒç”¨æ¥ä¸“é—¨å­˜æ”¾å¤§å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªHåŒºè£…ä¸ä¸‹ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œé‚£ä¹ˆG1ä¼šå¯»æ‰¾è¿ç»­çš„HumongousåŒºæ¥å­˜å‚¨ã€‚ä¸ºäº†èƒ½æ‰¾åˆ°è¿ç»­çš„HumongousåŒºï¼Œæœ‰æ—¶å€™ä¸å¾—ä¸å¯åŠ¨Full GCã€‚G1çš„å¤§å¤šæ•°è¡Œä¸ºéƒ½æŠŠHåŒºä½œä¸ºè€å¹´ä»£çš„ä¸€éƒ¨åˆ†æ¥çœ‹å¾…ã€‚</p>
<blockquote>
<p>â³å›æ”¶è¿‡ç¨‹</p>
</blockquote>
<p>G1 GCçš„åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ä¸‰ä¸ªç¯èŠ‚ï¼š</p>
<ul>
<li>å¹´è½»ä»£ GCï¼ˆYoung GCï¼‰</li>
<li>è€å¹´ä»£å¹¶å‘æ ‡è®°è¿‡ç¨‹ ï¼ˆConcurrent Markï¼‰</li>
<li>æ··åˆå›æ”¶ï¼ˆMixed GCï¼‰</li>
<li>å¦‚æœéœ€è¦ï¼Œå•çº¿ç¨‹ã€ç‹¬å å¼ã€é«˜å¼ºåº¦çš„Full GCè¿˜æ˜¯ç»§ç»­å­˜åœ¨çš„ã€‚å®ƒé’ˆå¯¹GCçš„è¯„ä¼°å¤±è´¥æä¾›äº†ä¸€ç§å¤±è´¥ä¿æŠ¤æœºåˆ¶ï¼Œå³å¼ºåŠ›å›æ”¶ã€‚</li>
</ul>
<p>åº”ç”¨ç¨‹åºåˆ†é…å†…å­˜ï¼Œå½“å¹´è½»ä»£çš„EdenåŒºç”¨å°½æ—¶å¼€å§‹å¹´è½»ä»£å›æ”¶è¿‡ç¨‹ï¼šG1çš„å¹´è½»ä»£æ”¶é›†é˜¶æ®µæ˜¯ä¸€ä¸ªå¹¶è¡Œçš„ç‹¬å å¼æ”¶é›†å™¨ã€‚åœ¨å¹´è½»ä»£å›æ”¶æœŸï¼ŒG1 GCæš‚åœæ‰€æœ‰åº”ç”¨ç¨‹åºçº¿ç¨‹ï¼Œå¯åŠ¨å¤šçº¿ç¨‹æ‰§è¡Œå¹´è½»ä»£å›æ”¶ã€‚ç„¶åä»å¹´è½»ä»£åŒºé—´ç§»åŠ¨å­˜æ´»å¯¹è±¡åˆ°SurvivoråŒºé—´æˆ–è€…è€å¹´åŒºé—´ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸¤ä¸ªåŒºé—´éƒ½ä¼šæ¶‰åŠã€‚</p>
<p>å½“å †å†…å­˜ä½¿ç”¨è¾¾åˆ°ä¸€å®šå€¼ï¼ˆé»˜è®¤45%ï¼‰æ—¶ï¼Œå¼€å§‹è€å¹´ä»£å¹¶å‘æ ‡è®°è¿‡ç¨‹ã€‚</p>
<p>æ ‡è®°å®Œæˆé©¬ä¸Šå¼€å§‹æ··åˆå›æ”¶è¿‡ç¨‹ã€‚å¯¹äºä¸€ä¸ªæ··åˆå›æ”¶æœŸï¼ŒG1 GCä»è€å¹´åŒºé—´ç§»åŠ¨å­˜æ´»å¯¹è±¡åˆ°ç©ºé—²åŒºé—´ï¼Œè¿™äº›ç©ºé—²åŒºé—´ä¹Ÿå°±æˆä¸ºäº†è€å¹´ä»£çš„ä¸€éƒ¨åˆ†ã€‚å’Œå¹´è½»ä»£ä¸åŒï¼Œè€å¹´ä»£çš„G1å›æ”¶å™¨å’Œå…¶ä»–GCä¸åŒï¼ŒG1çš„è€å¹´ä»£å›æ”¶å™¨ä¸éœ€è¦æ•´ä¸ªè€å¹´ä»£è¢«å›æ”¶ï¼Œä¸€æ¬¡åªéœ€è¦æ‰«æ/å›æ”¶ä¸€éƒ¨åˆ†è€å¹´ä»£çš„regionå°±å¯ä»¥äº†ã€‚åŒæ—¶ï¼Œè¿™ä¸ªè€å¹´ä»£regionæ˜¯å’Œå¹´è½»ä»£ä¸€èµ·è¢«å›æ”¶çš„ã€‚</p>
<blockquote>
<p>ğŸŸªRemembered Set</p>
</blockquote>
<p>ä¸€ä¸ªå¯¹è±¡è¢«ä¸åŒåŒºåŸŸå¼•ç”¨çš„é—®é¢˜</p>
<p>ä¸€ä¸ªregionä¸å¯èƒ½æ˜¯å­¤ç«‹çš„ï¼Œä¸€ä¸ªregionä¸­çš„å¯¹è±¡å¯èƒ½è¢«å…¶ä»–ä»»æ„regionä¸­å¯¹è±¡å¼•ç”¨ï¼Œåˆ¤æ–­å¯¹è±¡å­˜æ´»æ—¶ï¼Œæ˜¯å¦éœ€è¦æ‰«ææ•´ä¸ªJavaå †æ‰èƒ½ä¿è¯å‡†ç¡®ï¼Ÿ</p>
<p>åœ¨å…¶ä»–çš„åˆ†ä»£å›æ”¶å™¨ï¼Œä¹Ÿå­˜åœ¨åœ¨è¿™æ ·çš„é—®é¢˜ï¼ŒG1æ›´çªå‡ºã€‚å›æ”¶æ–°ç”Ÿä»£ä¹Ÿä¸å¾—ä¸åŒæ—¶æ‰«æè€å¹´ä»£ï¼Ÿè¿™æ ·çš„è¯ä¼šé™ä½Minor GCçš„æ•ˆç‡ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<p>æ— è®ºG1è¿˜æ˜¯å…¶ä»–åˆ†ä»£å›æ”¶å™¨ï¼ŒJVMéƒ½æ˜¯ä½¿ç”¨Remembered Setæ¥é¿å…å…¨å±€æ‰«æã€‚</p>
<p>æ¯ä¸ªRegionéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„Remembered Setï¼›æ¯æ¬¡Referenceç±»å‹æ•°æ®å†™æ“ä½œæ—¶ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªWrite Barrieræš‚æ—¶ä¸­æ–­æ“ä½œï¼›ç„¶åæ£€æŸ¥å°†è¦å†™å…¥çš„å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡æ˜¯å¦å’Œè¯¥Regerenceç±»å‹æ•°æ®åœ¨ä¸åŒçš„Regionï¼ˆå…¶ä»–å›æ”¶å™¨ï¼šæ£€æŸ¥è€å¹´ä»£å¯¹è±¡æ˜¯å¦å¼•ç”¨äº†æ–°ç”Ÿä»£å¯¹è±¡ï¼‰ã€‚å¦‚æœä¸åŒï¼Œé€šè¿‡CardTableæŠŠç›¸å…³å¼•ç”¨ä¿¡æ¯è®°å½•åˆ°å¼•ç”¨æŒ‡å‘å¯¹è±¡çš„æ‰€åœ¨regionå¯¹åº”çš„Remembered Setä¸­ã€‚</p>
<p>å½“è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œåœ¨GCæ ¹èŠ‚ç‚¹çš„æšä¸¾èŒƒå›´åŠ å…¥Remembered Setï¼›å°±å¯ä»¥ä¿è¯ä¸è¿›è¡Œå…¨å±€æ‰«æï¼Œä¹Ÿä¸ä¼šé—æ¼ã€‚</p>
<blockquote>
<p>ğŸ”å›æ”¶ç»†èŠ‚</p>
</blockquote>
<p>ï¼ˆ1ï¼‰å¹´è½»ä»£GC</p>
<p>JVMå¯åŠ¨æ—¶ï¼ŒG1å…ˆå‡†å¤‡å¥½EdenåŒºï¼Œç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¸æ–­åˆ›é€ å¯¹è±¡åˆ°EdenåŒºï¼Œå½“Edenç©ºé—´è€—å°½æ—¶ï¼ŒG1ä¼šå¯åŠ¨ä¸€æ¬¡å¹´è½»ä»£åƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚</p>
<p>å¹´è½»ä»£åƒåœ¾å›æ”¶åªä¼šå›æ”¶EdenåŒºå’ŒSurvivoråŒºã€‚</p>
<p>Young GCæ—¶ï¼Œé¦–å…ˆG1åœæ­¢åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼ˆSTWï¼‰ï¼ŒG1åˆ›å»ºå›æ”¶é›†ï¼ˆCollection Setï¼‰ï¼Œå›æ”¶é›†æ˜¯æŒ‡éœ€è¦è¢«å›æ”¶çš„å†…å­˜åˆ†æ®µçš„é›†åˆï¼Œå¹´è½»ä»£å›æ”¶è¿‡ç¨‹çš„å›æ”¶é›†åŒ…å«å¹´è½»ä»£EdenåŒºå’ŒSurvivoråŒºæ‰€æœ‰çš„å†…å­˜åˆ†æ®µã€‚</p>
<p>ç„¶åå¼€å§‹å¦‚ä¸‹å›æ”¶è¿‡ç¨‹ï¼š</p>
<p>ç¬¬ä¸€é˜¶æ®µï¼šæ‰«ææ ¹ã€‚æ ¹æ˜¯æŒ‡staticå˜é‡æŒ‡å‘çš„å¯¹è±¡ï¼Œæ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•è°ƒç”¨é“¾ä¸Šçš„å±€éƒ¨å˜é‡ç­‰ã€‚æ ¹å¼•ç”¨è¿åŒRSetè®°å½•çš„å¤–éƒ¨å¼•ç”¨ä½œä¸ºæ‰«æå­˜æ´»å¯¹è±¡çš„å…¥å£ã€‚</p>
<p>ç¬¬äºŒé˜¶æ®µï¼šæ›´æ–°RSetã€‚å¤„ç†dirty card queueä¸­çš„cardï¼Œæ›´æ–°RSetã€‚æ­¤é˜¶æ®µå®Œæˆåï¼ŒRSetå¯ä»¥å‡†ç¡®çš„åæ˜ è€å¹´ä»£æ‰€åœ¨çš„å†…å­˜åˆ†æ®µä¸­å¯¹è±¡çš„å¼•ç”¨ã€‚</p>
<p>ç¬¬ä¸‰é˜¶æ®µï¼šå¤„ç†RSetã€‚è¯†åˆ«è¢«è€å¹´ä»£å¯¹è±¡æŒ‡å‘çš„Edenä¸­çš„å¯¹è±¡ï¼Œè¿™äº›è¢«æŒ‡å‘çš„Edenä¸­çš„å¯¹è±¡è¢«è®¤ä¸ºæ˜¯å­˜æ´»çš„å¯¹è±¡ã€‚</p>
<p>ç¬¬å››é˜¶æ®µï¼šå¤åˆ¶å¯¹è±¡ã€‚æ­¤é˜¶æ®µï¼Œå¯¹è±¡æ ‘è¢«éå†ï¼ŒEdenåŒºå†…å­˜æ®µä¸­å­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°SurvicoråŒºä¸­ç©ºçš„å†…å­˜åˆ†æ®µï¼ŒSurvivoråŒºå†…å­˜æ®µä¸­å­˜æ´»çš„å¯¹è±¡å¦‚æœå¹´é¾„æœªè¾¾åˆ°é˜ˆå€¼ï¼Œå¹´é¾„ä¼šåŠ 1ï¼Œè¾¾åˆ°é˜ˆå€¼ä¼šè¢«å¤åˆ¶åˆ°OldåŒºä¸­ç©ºçš„å†…å­˜åˆ†æ®µã€‚å¦‚æœSurvivorç©ºé—´ä¸å¤Ÿï¼ŒEdenç©ºé—´çš„éƒ¨åˆ†æ•°æ®ä¼šç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£ç©ºé—´ã€‚</p>
<p>ç¬¬äº”é˜¶æ®µï¼šå¤„ç†å¼•ç”¨ã€‚å¤„ç†Softï¼ŒWeakï¼ŒPhantomï¼ŒFinalï¼ŒJNI Weakç­‰å¼•ç”¨ã€‚æœ€ç»ˆEdenç©ºé—´çš„æ•°æ®ä¸ºç©ºï¼ŒGCåœæ­¢å·¥ä½œï¼Œè€Œç›®æ ‡å†…å­˜ä¸­çš„å¯¹è±¡éƒ½æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œæ²¡æœ‰ç¢ç‰‡ï¼Œæ‰€ä»¥å¤åˆ¶è¿‡ç¨‹å¯ä»¥è¾¾åˆ°å†…å­˜æ•´ç†çš„æ•ˆæœï¼Œå‡å°‘ç¢ç‰‡ã€‚</p>
<p>ï¼ˆ2ï¼‰å¹¶å‘æ ‡è®°</p>
<p>ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹æ ‡è®°é˜¶æ®µã€‚æ ‡è®°ä»æ ¹èŠ‚ç‚¹ç›´æ¥å¯è¾¾çš„å¯¹è±¡ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯STWçš„ï¼Œå¹¶ä¸”ä¼šè§¦å‘ä¸€æ¬¡å¹´è½»ä»£GCã€‚</p>
<p>ç¬¬äºŒé˜¶æ®µï¼šæ ¹åŒºåŸŸæ‰«æã€‚G1 GCæ‰«æSurvivoråŒºç›´æ¥å¯è¾¾çš„è€å¹´ä»£åŒºåŸŸå¯¹è±¡ï¼Œå¹¶æ ‡è®°è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚è¿™ä¸€è¿‡ç¨‹å¿…é¡»åœ¨Young GCä¹‹å‰å®Œæˆã€‚</p>
<p>ç¬¬ä¸‰é˜¶æ®µï¼šå¹¶å‘æ ‡è®°ã€‚åœ¨æ•´ä¸ªå †ä¸­è¿›è¡Œå¹¶å‘æ ‡è®°ï¼ˆå’Œåº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œï¼‰ï¼Œæ­¤è¿‡ç¨‹å¯èƒ½è¢«Young GCä¸­æ–­ã€‚åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µï¼Œè‹¥å‘ç°åŒºåŸŸå¯¹è±¡ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯åƒåœ¾ï¼Œé‚£è¿™ä¸ªåŒºåŸŸä¼šè¢«ç«‹å³å›æ”¶ã€‚åŒæ—¶ï¼Œå¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œä¼šè®¡ç®—æ¯ä¸ªåŒºåŸŸçš„å¯¹è±¡æ´»æ€§ï¼ˆåŒºåŸŸä¸­å­˜æ´»å¯¹è±¡çš„æ¯”ä¾‹ï¼‰ã€‚</p>
<p>ç¬¬å››é˜¶æ®µï¼šå†æ¬¡æ ‡è®°ã€‚ç”±äºåº”ç”¨ç¨‹åºæŒç»­è¿›è¡Œï¼Œéœ€è¦ä¿®æ­£ä¸Šä¸€æ¬¡çš„æ ‡è®°ç»“æœã€‚æ˜¯STWçš„ã€‚G1ä¸­é‡‡ç”¨äº†æ¯”CMSæ›´å¿«çš„åˆå§‹å¿«ç…§ç®—æ³•ï¼šsnapshot-at-the-beginningï¼ˆSATBï¼‰ã€‚</p>
<p>ç¬¬äº”é˜¶æ®µï¼šç‹¬å æ¸…ç†ã€‚è®¡ç®—å„ä¸ªåŒºåŸŸçš„å­˜è´§å¯¹è±¡å’ŒGCå›æ”¶æ¯”ä¾‹ï¼Œå¹¶è¿›è¡Œæ’åºï¼Œè¯†åˆ«å¯ä»¥æ··åˆå›æ”¶çš„åŒºåŸŸã€‚ä¸ºä¸‹é˜¶æ®µåšé“ºå«ï¼Œæ˜¯STWçš„ã€‚</p>
<p>ç¬¬å…­é˜¶æ®µï¼šå¹¶å‘æ¸…ç†é˜¶æ®µï¼šè¯†åˆ«å¹¶æ¸…ç†å®Œå…¨ç©ºé—²çš„åŒºåŸŸã€‚</p>
<p>ï¼ˆ3ï¼‰æ··åˆå›æ”¶</p>
<p>å½“è¶Šæ¥è¶Šå¤šçš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£Old Regionæ—¶ï¼Œä¸ºäº†é¿å…å †å†…å­˜è¢«è€—å°½ï¼Œè™šæ‹Ÿæœºä¼šè§¦å‘ä¸€ä¸ªæ··åˆçš„åƒåœ¾æ”¶é›†å™¨ï¼Œå³Mixed GCï¼Œè¯¥ç®—æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªOld GCï¼Œè¯¥ç®—æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªOld GCï¼Œé™¤äº†å›æ”¶æ•´ä¸ªYoung Regionï¼Œè¿˜ä¼šå›æ”¶ä¸€éƒ¨åˆ†çš„Old Regionã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼šæ˜¯ä¸€éƒ¨åˆ†è€å¹´ä»£ï¼Œè€Œä¸æ˜¯å…¨éƒ¨è€å¹´ä»£ã€‚å¯ä»¥é€‰æ‹©å“ªäº›Old Regionè¿›è¡Œæ”¶é›†ï¼Œä»è€Œå¯ä»¥å¯¹åƒåœ¾å›æ”¶çš„è€—æ—¶æ—¶é—´è¿›è¡Œæ§åˆ¶ã€‚ä¹Ÿè¦æ³¨æ„çš„Mixed GCå¹¶ä¸æ˜¯Full GCã€‚</p>
<p>å¹¶å‘æ ‡è®°ç»“æŸä»¥åï¼Œè€å¹´ä»£ä¸­ç™¾åˆ†ç™¾ä¸ºåƒåœ¾çš„å†…å­˜åˆ†æ®µè¢«å›æ”¶äº†ï¼Œéƒ¨åˆ†ä¸ºåƒåœ¾çš„å†…å­˜åˆ†æ®µè¢«è®¡ç®—äº†å‡ºæ¥ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›è€å¹´ä»£çš„å†…å­˜åˆ†æ®µä¼šåˆ†8æ¬¡ï¼ˆå¯ä»¥é€šè¿‡<code>-XX:G1MixedGCCountTarget</code>è®¾ç½®ï¼‰è¢«å›æ”¶ã€‚</p>
<p>æ··åˆå›æ”¶çš„å›æ”¶é›†ï¼ˆCollection Setï¼‰åŒ…æ‹¬å…«åˆ†ä¹‹ä¸€çš„è€å¹´ä»£å†…å­˜åˆ†æ®µï¼ŒEdenåŒºå†…å­˜åˆ†æ®µï¼ŒSurvivoråŒºå†…å­˜åˆ†æ®µã€‚æ··åˆå›æ”¶çš„ç®—æ³•å’Œå¹´è½»ä»£å›æ”¶çš„ç®—æ³•å®Œå…¨ä¸€æ ·ï¼Œåªæ˜¯å›æ”¶é›†å¤šäº†è€å¹´ä»£çš„å†…å­˜åˆ†æ®µã€‚</p>
<p>ç”±äºè€å¹´ä»£ä¸­çš„å†…å­˜åˆ†æ®µé»˜è®¤åˆ†8æ¬¡å›æ”¶ï¼ŒG1ä¼šä¼˜å…ˆå›æ”¶åƒåœ¾å¤šçš„å†…å­˜åˆ†æ®µã€‚åƒåœ¾å å†…å­˜åˆ†æ®µæ¯”ä¾‹è¶Šé«˜çš„ï¼Œè¶Šä¼šè¢«å…ˆå›æ”¶ã€‚å¹¶ä¸”æœ‰ä¸€ä¸ªé˜ˆå€¼ä¼šå†³å®šå†…å­˜åˆ†æ®µæ˜¯å¦è¢«å›æ”¶ï¼Œ<code>-XX:G1MixedGCLiveThresholdPercent</code>ï¼Œé»˜è®¤ä¸º65%ï¼Œæ„æ€æ˜¯åƒåœ¾å å†…å­˜åˆ†æ®µæ¯”ä¾‹è¦è¾¾åˆ°65%æ‰ä¼šè¢«å›æ”¶ã€‚å¦‚æœåƒåœ¾å æ¯”å¤ªä½ï¼Œæ„å‘³ç€å­˜æ´»çš„å¯¹è±¡å æ¯”é«˜ï¼Œåœ¨å¤åˆ¶çš„æ—¶å€™ä¼šèŠ±è´¹æ›´å¤šçš„æ—¶é—´ã€‚</p>
<p>æ··åˆå›æ”¶å¹¶ä¸ä¸€å®šè¦è¿›è¡Œ8æ¬¡ã€‚æœ‰ä¸€ä¸ªé˜ˆå€¼<code>-XX:G1HeapWastePercent</code>ï¼Œé»˜è®¤å€¼ä¸º10%ï¼Œæ„æ€æ˜¯å…è®¸æ•´ä¸ªå †å†…å­˜ä¸­æœ‰10%çš„ç©ºé—´è¢«æµªè´¹ï¼Œæ„å‘³ç€å¦‚æœå‘ç°å¯ä»¥å›æ”¶çš„åƒåœ¾å å †å†…å­˜çš„æ¯”ä¾‹ä½äº10%ï¼Œåˆ™ä¸å†è¿›è¡Œæ··åˆå›æ”¶ã€‚å› ä¸ºGCä¼šèŠ±è´¹å¾ˆå¤šçš„æ—¶é—´ä½†æ˜¯å›æ”¶åˆ°çš„å†…å­˜å´å¾ˆå°‘ã€‚</p>
<p>ï¼ˆ4ï¼‰å¯é€‰è¿‡ç¨‹ï¼šFull GC</p>
<p>G1çš„åˆè¡·å°±æ˜¯è¦é¿å…Full GCçš„å‡ºç°ã€‚ä½†æ˜¯å¦‚æœä¸Šè¿°æ–¹å¼ä¸èƒ½æ­£å¸¸å·¥ä½œï¼ŒG1ä¼šåœæ­¢åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼ˆSTWï¼‰ï¼Œä½¿ç”¨å•çº¿ç¨‹çš„å†…å­˜å›æ”¶ç®—æ³•è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œæ€§èƒ½ä¼šéå¸¸å·®ï¼Œåº”ç”¨ç¨‹åºåœé¡¿æ—¶é—´ä¼šå¾ˆé•¿ã€‚</p>
<p>è¦é¿å…Full GCçš„å‘ç”Ÿï¼Œä¸€æ—¦å‘ç”Ÿéœ€è¦è¿›è¡Œè°ƒæ•´ã€‚ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”ŸFull GCå‘¢ï¼Ÿæ¯”å¦‚å †å†…å­˜å¤ªå°ï¼Œå½“G1åœ¨å¤åˆ¶å­˜è´§å¯¹è±¡çš„æ—¶å€™æ²¡æœ‰ç©ºçš„å†…å­˜åˆ†æ®µå¯ç”¨ï¼Œåˆ™ä¼šå›é€€åˆ°Full GCï¼Œè¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡å¢å¤§å†…å­˜è§£å†³ã€‚</p>
<p>å¯¼è‡´G1 Full GCçš„åŸå› å¯èƒ½æœ‰ä¸¤ä¸ªï¼š</p>
<p>Evacuationçš„æ—¶å€™æ²¡æœ‰è¶³å¤Ÿçš„to-spaceæ¥å­˜æ”¾æ™‹å‡çš„å¯¹è±¡ï¼›å¹¶å‘å¤„ç†è¿‡ç¨‹å®Œæˆä¹‹å‰ç©ºé—´è€—å°½ã€‚</p>
<blockquote>
<p>ğŸ¤ä¼˜åŒ–å»ºè®®</p>
</blockquote>
<p>å¹´è½»ä»£å¤§å°ï¼š</p>
<ul>
<li>é¿å…ä½¿ç”¨<code>-Xmn</code>æˆ–<code>-XX:NewRatio</code>ç­‰ç›¸å…³é€‰é¡¹æ˜¾ç¤ºè®¾ç½®å¹´è½»ä»£å¤§å°</li>
<li>å›ºå®šå¹´è½»ä»£çš„å¤§å°ä¼šè¦†ç›–æš‚åœæ—¶é—´ç›®æ ‡</li>
</ul>
<p>æš‚åœæ—¶é—´ç›®æ ‡ä¸è¦å¤ªè¿‡ä¸¥è‹›</p>
<ul>
<li>G1 GCçš„ååé‡æ˜¯90%çš„åº”ç”¨ç¨‹åºæ—¶é—´å’Œ10%çš„åƒåœ¾å›æ”¶æ—¶é—´</li>
<li>è¯„ä¼°G1 GCçš„ååé‡æ—¶ï¼Œæš‚åœæ—¶é—´ç›®æ ‡ä¸è¦å¤ªè¿‡ä¸¥è‹›ã€‚ç›®æ ‡å¤ªè¿‡ä¸¥è‹›è¡¨ç¤ºä½ åŸå› æ‰¿å—æ›´å¤šçš„åƒåœ¾å›æ”¶å¼€é”€ï¼Œè€Œè¿™äº›ä¼šç›´æ¥å½±å“åˆ°ååé‡ã€‚</li>
</ul>
<h3 id="15-8-ğŸŒˆ-åƒåœ¾å›æ”¶å™¨æ€»ç»“"><a href="#15-8-ğŸŒˆ-åƒåœ¾å›æ”¶å™¨æ€»ç»“" class="headerlink" title="15.8 ğŸŒˆ åƒåœ¾å›æ”¶å™¨æ€»ç»“"></a>15.8 ğŸŒˆ åƒåœ¾å›æ”¶å™¨æ€»ç»“</h3><blockquote>
<p>ğŸ†šæ¯”è¾ƒ</p>
</blockquote>
<table>
<thead>
<tr>
<th>åƒåœ¾å›æ”¶å™¨</th>
<th>åˆ†ç±»</th>
<th>ä½œç”¨ä½ç½®</th>
<th>ä½¿ç”¨ç®—æ³•</th>
<th>ç‰¹ç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>Serial</td>
<td>ä¸²è¡Œè¿è¡Œ</td>
<td>æ–°ç”Ÿä»£</td>
<td>å¤åˆ¶ç®—æ³•</td>
<td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td>
<td>é€‚ç”¨äºå•CPUç¯å¢ƒä¸‹çš„Clientæ¨¡å¼</td>
</tr>
<tr>
<td>ParNew</td>
<td>å¹¶è¡Œè¿è¡Œ</td>
<td>æ–°ç”Ÿä»£</td>
<td>å¤åˆ¶ç®—æ³•</td>
<td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td>
<td>å¤šCPUç¯å¢ƒServeræ¨¡å¼ä¸‹ä¸CMSé…åˆä½¿ç”¨</td>
</tr>
<tr>
<td>Parallel</td>
<td>å¹¶è¡Œè¿è¡Œ</td>
<td>æ–°ç”Ÿä»£</td>
<td>å¤åˆ¶ç®—æ³•</td>
<td>ååé‡ä¼˜å…ˆ</td>
<td>é€‚ç”¨äºåå°è®¡ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„åœºæ™¯</td>
</tr>
<tr>
<td>Serial Old</td>
<td>ä¸²è¡Œè¿è¡Œ</td>
<td>è€å¹´ä»£</td>
<td>æ ‡è®°-å‹ç¼©ç®—æ³•</td>
<td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td>
<td>é€‚ç”¨äºå•CPUç¯å¢ƒä¸‹çš„Clientæ¨¡å¼</td>
</tr>
<tr>
<td>Parallel Old</td>
<td>å¹¶è¡Œè¿è¡Œ</td>
<td>è€å¹´ä»£</td>
<td>æ ‡è®°-å‹ç¼©ç®—æ³•</td>
<td>ååé‡ä¼˜å…ˆ</td>
<td>é€‚ç”¨äºåå°è¿ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’çš„åœºæ™¯</td>
</tr>
<tr>
<td>CMS</td>
<td>å¹¶å‘è¿è¡Œ</td>
<td>è€å¹´ä»£</td>
<td>æ ‡è®°-æ¸…é™¤ç®—æ³•</td>
<td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td>
<td>é€‚ç”¨äºäº’è”ç½‘æˆ–è€…B/Sä¸šåŠ¡</td>
</tr>
<tr>
<td>G1</td>
<td>å¹¶å‘ã€å¹¶è¡Œè¿è¡Œ</td>
<td>æ–°ç”Ÿä»£ã€è€å¹´ä»£</td>
<td>æ ‡è®°-å‹ç¼©ç®—æ³•ã€å¤åˆ¶ç®—æ³•</td>
<td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td>
<td>é¢å‘æœåŠ¡ç«¯</td>
</tr>
</tbody></table>
<blockquote>
<p>ğŸ“·æ­é…</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11567/image-20210601165415818.png" class="" title="image-20210601165415818">



<blockquote>
<p>ğŸ’¡æç¤º</p>
</blockquote>
<ul>
<li>æ²¡æœ‰æœ€å¥½çš„å›æ”¶å™¨ï¼Œæ›´æ²¡æœ‰ä¸‡èƒ½çš„å›æ”¶å™¨ã€‚</li>
<li>è°ƒä¼˜æ°¸è¿œæ˜¯é’ˆå¯¹ç‰¹å®šåœºæ™¯ã€ç‰¹å®šéœ€æ±‚ï¼Œä¸å­˜åœ¨ä¸€åŠ³æ°¸é€¸çš„å›æ”¶å™¨</li>
</ul>
<h3 id="15-9-ğŸ“„-GCæ—¥å¿—åˆ†æ"><a href="#15-9-ğŸ“„-GCæ—¥å¿—åˆ†æ" class="headerlink" title="15.9 ğŸ“„ GCæ—¥å¿—åˆ†æ"></a>15.9 ğŸ“„ GCæ—¥å¿—åˆ†æ</h3><blockquote>
<p>âš™ï¸å‚æ•°</p>
</blockquote>
<p>é€šè¿‡é˜…è¯»GCæ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£Javaè™šæ‹Ÿæœºå†…å­˜åˆ†é…å’Œå›æ”¶ç­–ç•¥ã€‚</p>
<ul>
<li><code>-XX:+PrintGC</code>ï¼šè¾“å‡ºGCæ—¥å¿—</li>
<li><code>-XX:+PrintGCDetails</code>ï¼šè¾“å‡ºGCçš„è¯¦ç»†æ—¥å¿—</li>
<li><code>-XX:+PrintGCTimeStamps</code>ï¼šè¾“å‡ºGCçš„æ—¶é—´æˆ³</li>
<li><code>-XX:+PrintGCDateStamps</code>ï¼šè¾“å‡ºGCçš„æ—¶é—´æˆ³</li>
<li><code>-XX:+PrintHeapAtGC</code>ï¼šåœ¨è¿›è¡ŒGCçš„å‰åæ‰“å°å‡ºå †çš„ä¿¡æ¯</li>
<li><code>-Xloggc:..logs/gc.log</code>ï¼šæ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„</li>
</ul>
<blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li><code>GC</code>å’Œ<code>Full GC</code>è¯´æ˜äº†è¿™æ¬¡åƒåœ¾æ”¶é›†çš„åœé¡¿ç±»å‹ï¼Œå¦‚æœæœ‰<code>Full</code>åˆ™è¯´æ˜GCå‘ç”Ÿäº†STWã€‚</li>
<li>ä½¿ç”¨Serialæ”¶é›†å™¨åœ¨æ–°ç”Ÿä»£çš„åå­—æ˜¯Default New Generationï¼Œå› æ­¤æ˜¾ç¤ºçš„æ˜¯<code>DefNew</code>ã€‚</li>
<li>ä½¿ç”¨ParNewå›æ”¶å™¨åœ¨æ–°ç”Ÿä»£çš„åå­—ä¼šå˜æˆ<code>ParNew</code>ï¼Œæ„æ€æ˜¯Parallel New Generationã€‚</li>
<li>ä½¿ç”¨Parallel Scavengeå›æ”¶å™¨åœ¨æ–°ç”Ÿä»£çš„åå­—æ˜¯<code>PSYoungGen</code>ã€‚</li>
<li>è€å¹´ä»£çš„æ”¶é›†å’Œæ–°ç”Ÿä»£çš„é“ç†ä¸€æ ·ï¼Œåå­—ä¹Ÿæ˜¯å›æ”¶å™¨å†³å®šçš„ã€‚</li>
<li>ä½¿ç”¨G1å›æ”¶å™¨çš„è¯ï¼Œä¼šæ˜¾ç¤ºä¸º<code>garbage-first heap</code>ã€‚</li>
<li><code>Allocation Failure</code>ï¼šè¡¨æ˜æœ¬æ¬¡å¼•èµ·GCçš„åŸå› æ˜¯å› ä¸ºåœ¨å¹´è½»ä»£ä¸­æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´èƒ½å¤Ÿå­˜å‚¨æ–°çš„æ•°æ®äº†ã€‚</li>
<li><code>[PSYoungGen: XXXK -&gt; XXXK(XXXK)] XXXK -&gt; XXXK(XXXK)</code>ï¼šä¸­æ‹¬å·å†…ï¼šGCå›æ”¶å‰å¹´è½»ä»£å¤§å°ï¼Œå›æ”¶åå¤§å°ï¼Œï¼ˆå¹´è½»ä»£æ€»å¤§å°ï¼‰ï¼›æ‹¬å·å¤–ï¼šGCå›æ”¶å‰å¹´è½»ä»£å’Œè€å¹´ä»£å¤§å°ï¼Œå›æ”¶åå¤§å°ï¼Œï¼ˆå¹´è½»ä»£å’Œè€å¹´ä»£æ€»å¤§å°ï¼‰</li>
<li><code>user</code>ç”¨æˆ·æ€å›æ”¶è€—æ—¶ï¼Œ<code>sys</code>å†…æ ¸æ€å›æ”¶è€—æ—¶ï¼Œ<code>real</code>å®é™…è€—æ—¶ã€‚ç”±äºå¤šæ ¸çš„åŸå› ï¼Œæ—¶é—´æ€»å’Œå¯èƒ½ä¼šè¶…è¿‡realæ—¶é—´ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“·å®ä¾‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11567/image-20210404181555136.png" class="" title="image-20210404181555136">



<blockquote>
<p>ğŸ”¨å·¥å…·</p>
</blockquote>
<ul>
<li>GC viewerï¼š<a href="https://github.com/chewiebug/GCViewer">https://github.com/chewiebug/GCViewer</a></li>
<li>GC easyï¼š<a href="https://gceasy.io/">https://gceasy.io/</a></li>
</ul>
<h3 id="15-10-6ï¸âƒ£-ZGCå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ"><a href="#15-10-6ï¸âƒ£-ZGCå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ" class="headerlink" title="15.10 6ï¸âƒ£ ZGCå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ"></a>15.10 6ï¸âƒ£ ZGCå›æ”¶å™¨ï¼šä½å»¶è¿Ÿ</h3><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>GCä»ç„¶å¤„äºé£é€Ÿå‘å±•ä¸­ï¼Œç›®å‰çš„é»˜è®¤é€‰é¡¹G1 GCåœ¨ä¸æ–­çš„è¿›è¡Œæ”¹è¿›ï¼Œå¾ˆå¤šæˆ‘ä»¬åŸæ¥è®¤ä¸ºçš„ç¼ºç‚¹ï¼Œä¾‹å¦‚ä¸²è¡Œçš„Full GCã€Card Tableæ‰«æçš„ä½æ•ˆç­‰ï¼Œéƒ½å·²ç»è¢«å¤§å¹…æ”¹è¿›ï¼Œä¾‹å¦‚ï¼ŒJDK 10ä»¥åï¼ŒFull GCå·²ç»æ˜¯å¹¶è¡Œè¿è¡Œï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œå…¶è¡¨ç°è¿˜ä¼˜äºParallel GCçš„å¹¶è¡ŒFull GCå®ç°ã€‚</p>
<p>å³ä½¿æ˜¯Serial GCï¼Œè™½ç„¶æ¯”è¾ƒå¤è€ï¼Œä½†æ˜¯ç®€å•çš„è®¾è®¡å’Œå®ç°æœªå¿…å°±æ˜¯è¿‡æ—¶çš„ï¼Œå®ƒæœ¬èº«çš„å¼€é”€ï¼Œä¸ç®¡æ˜¯GCç›¸å…³æ•°æ®ç»“æ„çš„å¼€é”€ï¼Œè¿˜æ˜¯çº¿ç¨‹çš„å¼€é”€ï¼Œéƒ½æ˜¯éå¸¸å°çš„ï¼Œæ‰€ä»¥éšç€äº‘è®¡ç®—çš„å…´èµ·ï¼Œåœ¨Serverlessç­‰æ–°çš„åº”ç”¨åœºæ™¯ä¸‹ï¼ŒSerial GCæ‰¾åˆ°äº†æ–°çš„èˆå°ã€‚</p>
<p>æ¯”è¾ƒä¸å¹¸çš„æ˜¯CMS GCï¼Œå› ä¸ºå…¶ç®—æ³•çš„ç†è®ºç¼ºé™·ç­‰åŸå› ï¼Œè™½ç„¶ç°åœ¨è¿˜æœ‰éå¸¸å¤§çš„ç”¨æˆ·ç¾¤ä½“ï¼Œä½†åœ¨JDK9ä¸­å·²ç»è¢«æ ‡è®°ä¸ºåºŸå¼ƒï¼Œå¹¶åœ¨JDK14ç‰ˆæœ¬ä¸­ç§»é™¤ã€‚</p>
<blockquote>
<p>ğŸ’«Oracle JDK11çš„ZGC</p>
</blockquote>
<p>ZGCä¸G1éƒ½æ˜¯åŸºäºRegionï¼Œä¸åˆ†ä»£ã€‚</p>
<p>ZGCä¸Shenandoahç›®æ ‡é«˜åº¦ç›¸ä¼¼ï¼Œåœ¨å°½å¯èƒ½å¯¹ååé‡å½±å“ä¸å¤§çš„å‰æä¸‹ï¼Œå®ç°åœ¨ä»»æ„å †å†…å­˜å¤§å°ä¸‹éƒ½å¯ä»¥æŠŠåƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´é™åˆ¶åœ¨10msä»¥å†…çš„ä½å»¶è¿Ÿã€‚</p>
<p>ZGCçš„å·¥ä½œè¿‡ç¨‹å¯ä»¥åˆ†ä¸º4ä¸ªé˜¶æ®µï¼šå¹¶å‘æ ‡è®°ã€å¹¶å‘é¢„å¤‡é‡åˆ†é…ã€å¹¶å‘é‡åˆ†é…ã€å¹¶å‘é‡æ˜ å°„ã€‚</p>
<p>ZGCå‡ ä¹åœ¨æ‰€æœ‰åœ°æ–¹å¹¶å‘æ‰§è¡Œçš„ï¼Œé™¤äº†åˆå§‹æ ‡è®°çš„æ˜¯STWçš„ã€‚æ‰€ä»¥åœé¡¿æ—¶é—´å‡ ä¹å°±è€—è´¹åœ¨åˆå§‹æ ‡è®°ä¸Šï¼Œè¿™éƒ¨åˆ†çš„å®é™…éƒ¨åˆ†æ˜¯éå¸¸å°‘çš„ã€‚</p>
<p>2018å¹´ï¼Œåœé¡¿æ—¶é—´å¯¹æ¯”ï¼ŒZGCå·²ç»æŠŠåœé¡¿æ—¶é—´æ‰¼åˆ¶åœ¨10msä»¥å†…ï¼Œä»¤äººææ€–çš„æä½å»¶æ—¶ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11567/image-20210601130647580.png" class="" title="image-20210601130647580">

<br>

<p><a class="btn-beautify button--animated " href="https://malloc.se" target="_blank" rel="noopener" title="å¼€å‘è€…åšå®¢"><i class="far fa-hand-point-right fa-fw"></i> å¼€å‘è€…åšå®¢</a></p>
<p><a class="btn-beautify button--animated " href="http://cr.openjdk.java.net/~pliden/slides" target="_blank" rel="noopener" title="æ‰€æœ‰æ–‡çŒ®"><i class="far fa-hand-point-right fa-fw"></i> æ‰€æœ‰æ–‡çŒ®</a></p>
<p><a class="btn-beautify button--animated " href="http://cr.openjdk.java.net/~pliden/slides/ZGC-OracleDevLive-2020.pdf" target="_blank" rel="noopener" title="å¼€å‘è€…åšå®¢"><i class="far fa-hand-point-right fa-fw"></i> 2020å¹´PDF</a></p>
<blockquote>
<p>ğŸ”ZGCçš„é»‘æŠ€å·§ï¼šæŸ“è‰²æŒ‡é’ˆ+å¤šé‡æ˜ å°„</p>
</blockquote>
<p><a href="https://www.baeldung.com/jvm-compressed-oops">å‹ç¼©æŒ‡é’ˆ</a>ï¼šæœ€åˆJVMæ˜¯32ä½çš„ï¼Œéšç€64ä½ç³»ç»Ÿçš„å…´èµ·ï¼ŒJVMä¹Ÿè¿æ¥äº†è½¬æ¢ã€‚ä½†æ˜¯64ä½å¼•ç”¨æ˜¯32ä½å¼•ç”¨çš„ä¸¤å€ï¼Œå¯¼è‡´äº†ç©ºé—´æµªè´¹ã€‚é€šè¿‡<code>-XX:+UseCompressedOops</code>å¯ä»¥å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼Œæ”¹å˜æ­£å¸¸æŒ‡é’ˆçš„éšæœºåœ°å€åˆ†é…ç‰¹æ€§<strong>ï¼Œ</strong>å¼ºåˆ¶å †åœ°å€ä»é›¶å¼€å§‹åˆ†é…ã€‚é€šè¿‡å¯¹é½å’Œåç§»é‡ï¼Œå¯ä»¥å°†64ä½æŒ‡é’ˆå‹ç¼©æˆ32ä½ã€‚</p>
<p><a href="https://www.jianshu.com/p/b6356e0ec63c">è™šæ‹Ÿåœ°å€</a>ï¼šä¸€ä¸ªè¿›ç¨‹èƒ½å¤Ÿçœ‹åˆ°çš„åœ°å€ç©ºé—´å«åšè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¯¹åº”ç€è®¡ç®—æœºçš„ç‰©ç†åœ°å€ç©ºé—´ã€‚å¤šä¸ªè™šæ‹Ÿåœ°å€å¯ä»¥å¯¹åº”ä¸€ä¸ªç‰©ç†åœ°å€ã€‚ç¢ç‰‡åŒ–çš„ç‰©ç†å†…å­˜å¯ä»¥æ˜ å°„æˆå®Œæ•´è¿ç»­çš„è™šæ‹Ÿå†…å­˜ï¼Œä¸€ä¸ªåº”ç”¨å¯ä»¥ç”³è¯·æ¯”ç‰©ç†å†…å­˜æ›´å¤§çš„å†…å­˜ï¼Œä»è€Œä½¿å¾—å¤šä¸ªè¿›ç¨‹äº’ä¸å¹²æ‰°ã€‚</p>
<p>å¯¹äºä¸€ä¸ª64bitçš„æŒ‡é’ˆåœ°å€æ¥è¯´ï¼Œå¯¹è±¡åœ°å€åªèƒ½å¯»å€44bitï¼Œå‰©ä¸‹çš„20ä½éƒ½æ˜¯æ²¡æœ‰ç”¨çš„ã€‚</p>
<p><strong>æŸ“è‰²æŒ‡é’ˆ</strong>ï¼šåœ¨å¯¹å †è¿›è¡ŒGCçš„æ—¶å€™ï¼Œå¯¹è±¡ä¼šæœ‰å„ç§çŠ¶æ€ï¼šæ˜¯å¦æ‰«æï¼Œæ˜¯å¦æ‹·è´ç­‰ç­‰ï¼Œä¼ ç»ŸGCéƒ½æ˜¯æŠŠè¿™äº›å­˜åœ¨é¢å¤–çš„å†…å­˜ç©ºé—´ä¸­ï¼ŒZGCç›´æ¥å°†è¿™äº›å­˜åœ¨å‰©ä½™çš„4ä½æŒ‡é’ˆä¸­ï¼Œcolor bitsï¼ˆæŸ“è‰²æŒ‡é’ˆï¼‰ï¼Œä¸åŒçš„é¢œè‰²ä»£è¡¨å¯¹è±¡ä¸åŒçš„çŠ¶æ€ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11567/image-20210601134700690.png" class="" title="image-20210601134700690">

<p><strong>å¤šé‡æ˜ å°„</strong>ï¼šå°†ä¸€ä¸ªç‰©ç†åœ°å€æ˜ å°„åˆ°å¤šä¸ªè™šæ‹Ÿåœ°å€ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11567/image-20210601134730306.png" class="" title="image-20210601134730306">

<p>è¿™æ ·åšå¸¦æ¥äº†ä¸€äº›é—®é¢˜ï¼šï¼ˆ1ï¼‰ä¸èƒ½ä½¿ç”¨OOPSï¼ˆå‹ç¼©æŒ‡é’ˆï¼‰ï¼Œå¯¼è‡´åº”ç”¨å ç”¨å†…å­˜æ˜¾è‘—å¢å¤§ï¼›ï¼ˆ2ï¼‰ç³»ç»Ÿé”™è¯¯æ˜¾ç¤ºå†…å­˜å ç”¨ï¼Œå ç”¨äº†å®é™…å†…å­˜çš„3å€ï¼Œå¯èƒ½å¯¼è‡´Linuxå†…æ ¸çš„OutOfMemory Killerã€‚</p>
<blockquote>
<p>ğŸ”°è¯»å±éšœLoad Barrier</p>
</blockquote>
<p>ç”±äºæŸ“è‰²æŒ‡é’ˆçš„å­˜åœ¨ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶è®¿é—®å¯¹è±¡çš„æ—¶å€™ï¼Œå¯ä»¥è½»æ˜“çŸ¥é“å¯¹è±¡åœ¨å†…å­˜çš„å­˜å‚¨çŠ¶æ€ï¼Œè‹¥è¯·æ±‚è¯»çš„å†…å­˜è¢«æŸ“è‰²äº†ï¼Œåˆ™ä¼šè§¦å‘è¯»å±éšœï¼Œè¯»å±éšœä¼šæ›´æ–°æŒ‡é’ˆå†è¿”å›ç»“æœï¼Œæ­¤è¿‡ç¨‹æœ‰ä¸€å®šçš„è€—è´¹ï¼Œä»è€Œè¾¾åˆ°ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘çš„æ•ˆæœã€‚</p>
<pre><code>Object o = obj.field;
&lt;load_barrier&gt;

mov 0x10(%rax), $rbx
test %rbx, 0x20(%r15)
jne slow_path</code></pre>
<ul>
<li>æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„é¢œè‰²</li>
<li>å¦‚æœé¢œè‰²é”™è¯¯ =&gt; slow path</li>
</ul>
<p class="div-border blue">ä¸æ ‡è®°å¯¹è±¡çš„ä¼ ç»Ÿç®—æ³•ç›¸æ¯”ï¼ŒZGCåœ¨æŒ‡é’ˆä¸Šåšæ ‡è®°ï¼Œåœ¨è®¿é—®æŒ‡é’ˆæ—¶åŠ å…¥Load Barrierï¼ˆè¯»å±éšœï¼‰ï¼Œæ¯”å¦‚å½“å¯¹è±¡æ­£è¢«GCç§»åŠ¨ï¼ŒæŒ‡é’ˆä¸Šçš„é¢œè‰²å°±ä¼šä¸å¯¹ï¼Œè¿™ä¸ªå±éšœå°±ä¼šå…ˆæŠŠæŒ‡é’ˆæ›´æ–°ä¸ºæœ‰æ•ˆåœ°å€å†è¿”å›ï¼Œä¹Ÿå°±æ˜¯ï¼Œæ°¸è¿œåªæœ‰å•ä¸ªå¯¹è±¡è¯»å–æ—¶æœ‰æ¦‚ç‡è¢«å‡é€Ÿï¼Œè€Œä¸å­˜åœ¨ä¸ºäº†ä¿æŒåº”ç”¨ä¸GCä¸€è‡´è€Œç²—æš´æ•´ä½“çš„Stop The Worldã€‚</p>







<h3 id="15-11-7ï¸âƒ£Shenandoah-GCï¼šä½åœé¡¿ã€ä½åå"><a href="#15-11-7ï¸âƒ£Shenandoah-GCï¼šä½åœé¡¿ã€ä½åå" class="headerlink" title="15.11 7ï¸âƒ£Shenandoah GCï¼šä½åœé¡¿ã€ä½åå"></a>15.11 7ï¸âƒ£Shenandoah GCï¼šä½åœé¡¿ã€ä½åå</h3><blockquote>
<p>âœˆï¸Open JDK12çš„Shenandoah GC</p>
</blockquote>
<p>Shenandoah ï¼Œæ— ç–‘æ˜¯ä¼—å¤šGCä¸­æœ€å­¤ç‹¬çš„ä¸€ä¸ªã€‚æ˜¯ç¬¬ä¸€æ¬¾ä¸ç”±Oracleå…¬å¸å›¢é˜Ÿé¢†å¯¼å¼€å‘çš„HotSpotåƒåœ¾å›æ”¶å™¨ï¼Œã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­è¯´å®ƒå› æ­¤è€Œä¸å¯é¿å…åœ°æ”¶åˆ°å®˜æ–¹çš„æ’æŒ¤ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œå¦‚æœOracleå°†å®ƒå‘å¸ƒåˆ°Oracle JDKçš„å•†ä¸šç‰ˆæœ¬ä¸­ï¼Œå‡ºç°é—®é¢˜å°†éš¾ä»¥ç»´æŠ¤ã€‚</p>
<p>Shenandoahåƒåœ¾å›æ”¶å™¨æœ€åˆç”±RedHatè¿›è¡Œçš„ä¸€é¡¹åƒåœ¾å›æ”¶å™¨ç ”ç©¶é¡¹ç›®Pauseless GCçš„å®ç°ï¼Œæ—¨åœ¨é’ˆå¯¹JVMä¸Šçš„å†…å­˜å›æ”¶å®ç°ä½åœé¡¿çš„éœ€æ±‚ã€‚åœ¨2014å¹´è´¡çŒ®ç»™Open JDKã€‚</p>
<p>RedHatç ”å‘Shenandoahå›¢é˜Ÿå¯¹å¤–å®£ç§°ï¼ŒShenandoahåƒåœ¾å›æ”¶å™¨çš„æš‚åœæ—¶é—´ä¸å †å¤§å°æ— å…³ï¼Œè¿™æ„å‘³ç€å°†å †è®¾ç½®ä¸º200MBè¿˜æ˜¯200GBï¼Œ99.9%çš„ç›®æ ‡éƒ½å¯ä»¥æŠŠåƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´é™åˆ¶åœ¨åæ¯«ç§’ä»¥å†…ã€‚ä¸è¿‡å®é™…ä½¿ç”¨æ€§èƒ½å°†å–å†³äºå®é™…å·¥ä½œå †çš„å¤§å°å’Œå·¥ä½œè´Ÿè½½ã€‚</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-14(åƒåœ¾å›æ”¶æ¦‚å¿µ)</title>
    <url>/posts/31658/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="14-1-ğŸ’»-System-gc"><a href="#14-1-ğŸ’»-System-gc" class="headerlink" title="14.1 ğŸ’» System.gc()"></a>14.1 ğŸ’» System.gc()</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œé€šè¿‡System.gc()æˆ–è€…Runtime.getRuntime().gc()çš„è°ƒç”¨ï¼Œä¼šæ˜¾å¼è§¦å‘Full GCï¼ŒåŒæ—¶å¯¹è€å¹´ä»£å’Œæ–°ç”Ÿä»£è¿›è¡Œå›æ”¶ï¼Œå°è¯•é‡Šæ”¾è¢«ä¸¢å¼ƒå¯¹è±¡å ç”¨çš„å†…å­˜ã€‚</li>
<li>System.gc()è°ƒç”¨é™„å¸¦ä¸€ä¸ªå…è´£å£°æ˜ï¼Œæ— æ³•ä¿è¯å¯¹åƒåœ¾å›æ”¶å™¨çš„è°ƒç”¨ã€‚</li>
<li>JVMå®ç°ç€å¯ä»¥é€šè¿‡System.gc()è°ƒç”¨æ¥å†³å®šJVMçš„GCè¡Œä¸ºã€‚è€Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåƒåœ¾å›æ”¶åº”è¯¥æ˜¯è‡ªåŠ¨è¿›è¡Œçš„ï¼Œæ— é¡»æ‰‹åŠ¨è§¦å‘ï¼Œå¦åˆ™å°±å¤ªè¿‡äºéº»çƒ¦äº†ã€‚åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¦‚æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ€§èƒ½åŸºå‡†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œä¹‹é—´è°ƒç”¨System.gc()ã€‚</li>
</ul>
<blockquote>
<p>âŒ¨ï¸æµ‹è¯•</p>
</blockquote>
<pre><code>public class LocalVarGC &#123;

    /**
     * è§¦å‘Minor GCæ²¡æœ‰å›æ”¶å¯¹è±¡ï¼Œç„¶ååœ¨Full GCå°†è¯¥å¯¹è±¡å­˜å…¥oldåŒº
     */
    public void localVarGC1() &#123;
        byte[] buffer = new byte[10 * 1024 * 1024]; // 10MB
        System.gc(); // æ— æ³•å›æ”¶
    &#125;

    /**
     * è§¦å‘Young GCçš„æ—¶å€™ï¼Œå·²ç»è¢«å›æ”¶äº†
     */
    public void localVarGC2() &#123;
        byte[] buffer = new byte[10 * 1024 * 1024]; // 10MB
        buffer = null;
        System.gc(); // å¯ä»¥å›æ”¶
    &#125;

    /**
     * ä¸ä¼šå›æ”¶ï¼Œå› ä¸ºå®ƒè¿˜å­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„æ§½ä¸­
     */
    public void localVarGC3() &#123;
        &#123;
            byte[] buffer = new byte[10 * 1024 * 1024]; // 10MB
        &#125;
        System.gc(); // ä¸ä¼šå›æ”¶
    &#125;

    /**
     * ä¼šè¢«å›æ”¶ï¼Œå› ä¸ºå®ƒè¿˜å­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„æ§½ä¸­ï¼Œä½†æ˜¯åé¢å®šä¹‰çš„valueæŠŠè¿™ä¸ªæ§½ç»™æ›¿æ¢äº†
     */
    public void localVarGC4() &#123;
        &#123;
            byte[] buffer = new byte[10 * 1024 * 1024]; // 10MB
        &#125;
        int value = 10;
        System.gc(); // å¯ä»¥å›æ”¶
    &#125;

    /**
     * å›æ”¶localVarGC1ä¸­çš„buffer
     */
    public void localVarGC5() &#123;
        localVarGC1();
        System.gc(); // å¯ä»¥å›æ”¶
    &#125;

    public static void main(String[] args) &#123;
        LocalVarGC localVarGC = new LocalVarGC();
        localVarGC.localVarGC5();
    &#125;
&#125;</code></pre>
<h2 id="14-2-ğŸŠå†…å­˜æº¢å‡º"><a href="#14-2-ğŸŠå†…å­˜æº¢å‡º" class="headerlink" title="14.2 ğŸŠå†…å­˜æº¢å‡º"></a>14.2 ğŸŠå†…å­˜æº¢å‡º</h2><blockquote>
<p>ğŸ“–æ¦‚è¿°</p>
</blockquote>
<p>å†…å­˜æº¢å‡ºç›¸å¯¹äºå†…å­˜æ³„éœ²æ¥è¯´ï¼Œå°½ç®¡æ›´å®¹æ˜“è¢«ç†è§£ï¼Œä½†æ˜¯åŒæ ·çš„ï¼Œå†…å­˜æº¢å‡ºä¹Ÿæ˜¯å¼•å‘ç¨‹åºå´©æºƒçš„ç½ªé­ç¥¸é¦–ä¹‹ä¸€ã€‚</p>
<p>ç”±äºGCä¸€ç›´åœ¨å‘å±•ï¼Œæ‰€æœ‰ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé™¤éåº”ç”¨ç¨‹åºå ç”¨çš„å†…å­˜å¢é•¿é€Ÿåº¦éå¸¸å¿«ï¼Œé€ æˆåƒåœ¾å›æ”¶å·²ç»è·Ÿä¸ä¸Šå†…å­˜æ¶ˆè€—çš„é€Ÿåº¦ï¼Œå¦åˆ™ä¸å¤ªå®¹æ˜“å‡ºç°OOMçš„æƒ…å†µã€‚</p>
<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒGCä¼šè¿›è¡Œå„ç§å¹´é¾„æ®µçš„åƒåœ¾å›æ”¶ï¼Œå®åœ¨ä¸è¡Œäº†å°±æ”¾å¤§æ‹›ï¼Œæ¥ä¸€æ¬¡ç‹¬å å¼çš„FULL FCæ“ä½œï¼Œè¿™æ—¶å€™ä¼šå›æ”¶å¤§é‡çš„å†…å­˜ï¼Œä¾›åº”ç”¨ç¨‹åºç»§ç»­ä½¿ç”¨ã€‚</p>
<p>javadocå¯¹OutOfMemoryErrorçš„è§£é‡Šæ˜¯ï¼Œæ²¡æœ‰ç©ºé—²å†…å­˜ï¼Œå¹¶ä¸”åƒåœ¾å™¨ä¹Ÿæ— æ³•æä¾›æ›´å¤šå†…å­˜ã€‚</p>
<p>æ²¡æœ‰ç©ºé—²å†…å­˜çš„æƒ…å†µï¼ŒåŸå› æœ‰äºŒï¼š</p>
<ul>
<li>Javaè™šæ‹Ÿæœºçš„å †å†…å­˜è®¾ç½®ä¸å¤Ÿã€‚</li>
<li>ä»£ç ä¸­åˆ›å»ºäº†å¤§é‡çš„å¯¹è±¡ï¼Œå¹¶ä¸”é•¿æ—¶é—´ä¸èƒ½è¢«åƒåœ¾å™¨ï¼ˆå­˜åœ¨è¢«å¼•ç”¨ï¼‰ã€‚</li>
<li>è¿™é‡Œé¢éšå«çš„ä¸€å±‚æ„æ€æ˜¯ï¼Œåœ¨æŠ›å‡ºOutOfMemoryä¹‹å‰ï¼Œé€šå¸¸åƒåœ¾å™¨ä¼šè¢«è§¦å‘ï¼Œå°½å…¶æ‰€èƒ½å»æ¸…ç†ç©ºé—´ã€‚</li>
<li>å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯åœ¨ä»»ä½•æƒ…å†µä¸‹åƒåœ¾å™¨éƒ½ä¼šè¢«è§¦å‘çš„ã€‚</li>
</ul>
<h2 id="14-3-ğŸ‰-å†…å­˜æ³„éœ²"><a href="#14-3-ğŸ‰-å†…å­˜æ³„éœ²" class="headerlink" title="14.3 ğŸ‰ å†…å­˜æ³„éœ²"></a>14.3 ğŸ‰ å†…å­˜æ³„éœ²</h2><blockquote>
<p>ğŸ“–æ¦‚è¿°</p>
</blockquote>
<p>ä¸¥æ ¼æ¥è¯´ï¼Œåªæœ‰å¯¹è±¡ä¸ä¼šå†è¢«ç¨‹åºç”¨åˆ°äº†ï¼Œä½†æ˜¯GCåˆä¸èƒ½å›æ”¶ä»–ä»¬çš„æƒ…å†µï¼Œæ‰å«åšå†…å­˜æ³„éœ²ã€‚</p>
<p>ä½†å®é™…æƒ…å†µå¾ˆå¤šæ—¶å€™ä¸€äº›ä¸å¤ªå¥½çš„å®è·µï¼ˆæˆ–ç–å¿½ï¼‰ä¼šå¯¼è‡´å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå˜å¾—å¾ˆé•¿ç”šè‡³å¯¼è‡´00Mï¼Œä¹Ÿå¯ä»¥å«åšå®½æ³›æ„ä¹‰ä¸Šçš„â€œå†…å­˜æ³„æ¼â€ã€‚</p>
<p>å°½ç®¡å†…å­˜æ³„æ¼å¹¶ä¸ä¼šç«‹åˆ»å¼•èµ·ç¨‹åºå´©æºƒï¼Œä½†æ˜¯ä¸€æ—¦å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œç¨‹åºä¸­çš„å¯ç”¨å†…å­˜å°±ä¼šè¢«é€æ­¥èš•é£Ÿï¼Œç›´è‡³è€—å°½æ‰€æœ‰å†…å­˜ï¼Œæœ€ç»ˆå‡ºç°OutofMemoryå¼‚å¸¸ï¼Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p>
<p>æ³¨æ„ï¼Œè¿™é‡Œçš„å­˜å‚¨ç©ºé—´å¹¶ä¸æ˜¯æŒ‡ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯æŒ‡è™šæ‹Ÿå†…å­˜å¤§å°ï¼Œè¿™ä¸ªè™šæ‹Ÿå†…å­˜å¤§å°å–å†³äºç£ç›˜äº¤æ¢åŒºè®¾å®šçš„å¤§å°ã€‚</p>
<blockquote>
<p>ğŸ¥–ä¸¾ä¾‹</p>
</blockquote>
<p>ï¼ˆ1ï¼‰å•ä¾‹æ¨¡å¼</p>
<p>å•ä¾‹çš„ç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç¨‹åºæ˜¯ä¸€æ ·é•¿çš„ï¼Œæ‰€ä»¥å•ä¾‹æ¨¡å¼ä¸­ï¼Œå¦‚æœæŒæœ‰å¯¹å¤–éƒ¨å¯¹è±¡çš„å¼•ç”¨çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå¤–éƒ¨å¯¹è±¡æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ï¼Œåˆ™ä¼šå¯¼è‡´å†…å­˜æ³„éœ²çš„äº§ç”Ÿã€‚</p>
<p>ï¼ˆ2ï¼‰ä¸€äº›æä¾›closeçš„èµ„æºæœªå…³é—­</p>
<p>æ•°æ®åº“è¿æ¥ã€ç½‘ç»œè¿æ¥å’ŒIOè¿æ¥å¿…é¡»å—åˆ°closeï¼Œå¦åˆ™æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ã€‚</p>
<h2 id="14-4-â¹ï¸-Stop-The-World"><a href="#14-4-â¹ï¸-Stop-The-World" class="headerlink" title="14.4 â¹ï¸ Stop The World"></a>14.4 â¹ï¸ Stop The World</h2><blockquote>
<p>ğŸ“–æ¦‚è¿°</p>
</blockquote>
<p>stop-the-worldï¼Œç®€ç§°STWï¼ŒæŒ‡çš„æ˜¯GCäº‹ä»¶å‘ç”Ÿè¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿåº”ç”¨ç¨‹åºçš„åœé¡¿ã€‚åœé¡¿äº§ç”Ÿæ—¶æ•´ä¸ªåº”ç”¨ç¨‹åºçº¿ç¨‹éƒ½ä¼šè¢«æš‚åœï¼Œæ²¡æœ‰ä»»ä½•å“åº”ï¼Œæœ‰ç‚¹åƒå¡æ­»çš„æ„Ÿè§‰ï¼Œè¿™ä¸ªåœé¡¿ç§°ä¸ºSTWã€‚</p>
<p>å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­æšä¸¾æ ¹èŠ‚ç‚¹ï¼ˆGC Rootsï¼‰ä¼šå¯¼è‡´æ‰€æœ‰Javaæ‰§è¡Œçº¿ç¨‹åœé¡¿ã€‚</p>
<ul>
<li>åˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½ç¡®ä¿ä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œ</li>
<li>ä¸€è‡´æ€§æŒ‡æ•´ä¸ªåˆ†ææœŸé—´æ•´ä¸ªæ‰§è¡Œç³»ç»Ÿçœ‹èµ·æ¥åƒè¢«å†»ç»“åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Š</li>
<li>å¦‚æœå‡ºç°åˆ†æè¿‡ç¨‹ä¸­å¯¹è±¡å¼•ç”¨å…³ç³»è¿˜åœ¨ä¸æ–­å˜åŒ–ï¼Œåˆ™åˆ†æç»“æœçš„å‡†ç¡®æ€§æ— æ³•ä¿è¯</li>
</ul>
<p>è¢«STWä¸­æ–­çš„åº”ç”¨ç¨‹åºçº¿ç¨‹ä¼šåœ¨å®ŒæˆGCä¹‹åæ¢å¤ï¼Œé¢‘ç¹ä¸­æ–­ä¼šè®©ç”¨æˆ·æ„Ÿè§‰åƒæ˜¯ç½‘é€Ÿä¸å¿«é€ æˆç”µå½±å¡å¸¦ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å‡å°‘STWçš„å‘ç”Ÿã€‚</p>
<blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>STWäº‹ä»¶å’Œé‡‡ç”¨å“ªæ¬¾GCæ— å…³æ‰€æœ‰çš„GCéƒ½æœ‰è¿™ä¸ªäº‹ä»¶ã€‚</p>
<p>å“ªæ€•æ˜¯G1ä¹Ÿä¸èƒ½å®Œå…¨é¿å…Stop-the-worldæƒ…å†µå‘ç”Ÿï¼Œåªèƒ½è¯´åƒåœ¾å›æ”¶å™¨è¶Šæ¥è¶Šä¼˜ç§€ï¼Œå›æ”¶æ•ˆç‡è¶Šæ¥è¶Šé«˜ï¼Œå°½å¯èƒ½åœ°ç¼©çŸ­äº†æš‚åœæ—¶é—´ã€‚</p>
<p>STWæ˜¯JVMåœ¨åå°è‡ªåŠ¨å‘èµ·å’Œè‡ªåŠ¨å®Œæˆçš„ã€‚åœ¨ç”¨æˆ·ä¸å¯è§çš„æƒ…å†µä¸‹ï¼ŒæŠŠç”¨æˆ·æ­£å¸¸çš„å·¥ä½œçº¿ç¨‹å…¨éƒ¨åœæ‰ã€‚</p>
<p>å¼€å‘ä¸­ä¸è¦ç”¨<code>System.gc()</code>ä¼šå¯¼è‡´stop-the-worldçš„å‘ç”Ÿã€‚</p>
<h2 id="14-5-ğŸ“–-åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘"><a href="#14-5-ğŸ“–-åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘" class="headerlink" title="14.5 ğŸ“– åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘"></a>14.5 ğŸ“– åƒåœ¾å›æ”¶çš„å¹¶è¡Œä¸å¹¶å‘</h2><blockquote>
<p>ğŸšå¹¶å‘</p>
</blockquote>
<ul>
<li>åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œå¹¶å‘æ˜¯æŒ‡ä¸€ä¸ªæ—¶é—´æ®µä¸­æœ‰å‡ ä¸ªç¨‹åºéƒ½å¤„äºå·²å¯åŠ¨è¿è¡Œåˆ°è¿è¡Œå®Œæ¯•ä¹‹é—´ï¼Œä¸”è¿™å‡ ä¸ªç¨‹åºéƒ½æ˜¯åœ¨åŒä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œã€‚</li>
<li>å¹¶å‘ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„â€åŒæ—¶è¿›è¡Œâ€œï¼Œåªæ˜¯CPUæŠŠä¸€ä¸ªæ—¶é—´æ®µåˆ’åˆ†æˆå‡ ä¸ªæ—¶é—´ç‰‡æ®µï¼ˆæ—¶é—´åŒºé—´ï¼‰ï¼Œç„¶ååœ¨è¿™å‡ ä¸ªæ—¶é—´åŒºé—´ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œç”±äºCPUçš„å¤„ç†çš„é€Ÿåº¦éå¸¸å¿«ï¼Œåªè¦æ—¶é—´é—´éš”å¤„ç†å¾—å½“ï¼Œå³å¯è®©ç”¨æˆ·æ„Ÿè§‰æ˜¯å¤šä¸ªåº”ç”¨ç¨‹åºåŒæ—¶åœ¨è¿›è¡Œã€‚</li>
</ul>
<blockquote>
<p>ğŸš—å¹¶è¡Œ</p>
</blockquote>
<ul>
<li>å½“ç³»ç»Ÿæœ‰ä¸€ä¸ªä»¥ä¸ŠCPUæ—¶ï¼Œå½“ä¸€ä¸ªCPUæ‰§è¡Œä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œå¦ä¸€ä¸ªCPUå¯ä»¥æ‰§è¡Œå¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸¤ä¸ªè¿›ç¨‹äº’è¡¥æŠ¢å CPUèµ„æºï¼Œå¯ä»¥åŒæ—¶è¿›è¡Œï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå¹¶è¡Œã€‚</li>
<li>å…¶å®å†³å®šå¹¶è¡Œçš„å› ç´ ä¸æ˜¯CPUçš„æ•°é‡ï¼Œè€Œæ˜¯CPUçš„æ ¸å¿ƒæ•°é‡ï¼Œæ¯”å¦‚ä¸€ä¸ªCPUå¤šä¸ªæ ¸ä¹Ÿå¯ä»¥å¹¶è¡Œã€‚</li>
</ul>
<blockquote>
<p>å¹¶è¡ŒğŸ†šå¹¶å‘</p>
</blockquote>
<p>å¹¶å‘ï¼ŒæŒ‡çš„æ˜¯å¤šä¸ªäº‹æƒ…ï¼Œåœ¨åŒä¸€æ—¶é—´æ®µå†…åŒæ—¶å‘ç”Ÿäº†ã€‚</p>
<p>å¹¶è¡Œï¼ŒæŒ‡çš„æ˜¯å¤šä¸ªäº‹æƒ…ï¼Œåœ¨åŒä¸€æ—¶é—´ç‚¹å†…åŒæ—¶å‘ç”Ÿäº†ã€‚</p>
<p>å¹¶å‘çš„å¤šä¸ªä»»åŠ¡ä¹‹é—´æ˜¯äº’ç›¸æŠ¢å èµ„æºçš„ï¼Œå¹¶è¡Œçš„å¤šä¸ªä»»åŠ¡ä¹‹é—´æ˜¯ä¸äº’ç›¸æŠ¢å èµ„æºçš„ã€‚</p>
<p>åªæœ‰åœ¨å¤šæ ¸CPUæˆ–è€…ä¸€ä¸ªCPUå¤šæ ¸çš„æƒ…å†µä¸­ï¼Œæ‰ä¼šå‘ç”Ÿå¹¶è¡Œã€‚</p>
<p>å¦åˆ™ï¼Œçœ‹ä¼¼åŒæ—¶å‘ç”Ÿçš„äº‹æƒ…ï¼Œå…¶å®éƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚</p>
<blockquote>
<p>ğŸ—‘ï¸åƒåœ¾å›æ”¶</p>
</blockquote>
<p>å¹¶å‘å’Œå¹¶è¡Œï¼Œåœ¨è°ˆè®ºåƒåœ¾å™¨çš„ä¸Šä¸‹æ–‡è¯­å¢ƒä¸­ï¼Œå®ƒä»¬å¯ä»¥è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li>å¹¶è¡Œï¼šæŒ‡å¤šæ¡åƒåœ¾çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œä½†æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä»å¤„äºç­‰å¾…çŠ¶æ€ã€‚</li>
<li>ä¸²è¡Œï¼šç›¸è¾ƒäºå¹¶è¡Œçš„æ¦‚å¿µï¼Œå•çº¿ç¨‹æ‰§è¡Œã€‚å¦‚æœå†…å­˜ä¸å¤Ÿï¼Œåˆ™ç¨‹åºæš‚åœï¼Œå¯åŠ¨JVMåƒåœ¾å›æ”¶å™¨è¿›è¡Œåƒåœ¾å›æ”¶ã€‚å›æ”¶å®Œï¼Œå†å¯åŠ¨ç¨‹åºçš„çº¿ç¨‹ã€‚</li>
</ul>
<h2 id="14-6-â›‘ï¸-å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºåŸŸ"><a href="#14-6-â›‘ï¸-å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºåŸŸ" class="headerlink" title="14.6 â›‘ï¸ å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºåŸŸ"></a>14.6 â›‘ï¸ å®‰å…¨ç‚¹å’Œå®‰å…¨åŒºåŸŸ</h2><blockquote>
<p>ğŸ“—å®‰å…¨ç‚¹(Safe Point)</p>
</blockquote>
<p>ç¨‹åºæ‰§è¡Œæ—¶å¹¶éåœ¨æ‰€æœ‰åœ°æ–¹éƒ½èƒ½åœé¡¿ä¸‹æ¥å¼€å§‹GCï¼Œåªæœ‰åœ¨ç‰¹å®šçš„ä½ç½®æ‰èƒ½åœé¡¿ä¸‹æ¥å¼€å§‹GCï¼Œè¿™äº›ä½ç½®ç§°ä¸ºâ€œå®‰å…¨ç‚¹â€ã€‚</p>
<p>å®‰å…¨ç‚¹çš„é€‰æ‹©å¾ˆé‡è¦ï¼Œå¦‚æœå¤ªå°‘å¯èƒ½å¯¼è‡´GCç­‰å¾…çš„æ—¶é—´å¤ªé•¿ï¼Œå¦‚æœå¤ªé¢‘ç¹å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶çš„æ€§èƒ½é—®é¢˜ã€‚å¤§éƒ¨åˆ†æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´éƒ½éå¸¸çŸ­æš‚ï¼Œé€šå¸¸ä¼šæ ¹æ®â€æ˜¯å¦å…·æœ‰è®©ç¨‹åºé•¿æ—¶é—´æ‰§è¡Œçš„ç‰¹å¾â€œä¸ºæ ‡å‡†ã€‚æ¯”å¦‚ï¼šé€‰æ‹©ä¸€äº›æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„æŒ‡ä»¤ä½œä¸ºSafe Pointï¼Œå¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬å’Œå¼‚å¸¸è·³è½¬ã€‚</p>
<blockquote>
<p>â”å¦‚ä½•åœ¨GCå‘ç”Ÿæ—¶ï¼Œæ£€æŸ¥æ‰€æœ‰çº¿ç¨‹éƒ½è·‘åˆ°æœ€è¿‘çš„å®‰å…¨ç‚¹åœé¡¿ä¸‹æ¥å‘¢ï¼Ÿ</p>
</blockquote>
<ul>
<li><p>æŠ¢å…ˆå¼è°ƒç”¨ï¼ˆç›®å‰æ²¡æœ‰è™šæ‹Ÿæœºä½¿ç”¨ï¼‰ï¼šé¦–å…ˆä¸­æ–­æ‰€æœ‰çº¿ç¨‹ã€‚å¦‚æœè¿˜æœ‰çº¿ç¨‹ä¸åœ¨å®‰å…¨ç‚¹ï¼Œå°±æ¢å¤çº¿ç¨‹ï¼Œè®©çº¿ç¨‹è·‘åˆ°å®‰å…¨ç‚¹ã€‚</p>
</li>
<li><p>ä¸»åŠ¨å¼ä¸­æ–­ï¼šè®¾ç½®ä¸€ä¸ªä¸­æ–­æ ‡å¿—ï¼Œå„ä¸ªçº¿ç¨‹è¿è¡Œåˆ°Safe Pointçš„æ—¶å€™ä¸»åŠ¨è½®è¯¢è¿™ä¸ªæ ‡å¿—ï¼Œå¦‚æœä¸­æ–­æ ‡å¿—ä¸ºçœŸï¼Œåˆ™å°†è‡ªå·±è¿›è¡Œä¸­æ–­æŒ‚èµ·ã€‚</p>
</li>
</ul>
<blockquote>
<p>â•è¡¥å……</p>
</blockquote>
<p>Safe Pointæœºåˆ¶ä¿è¯äº†ç¨‹åºæ‰§è¡Œæ—¶ï¼Œåœ¨ä¸å¤ªé•¿çš„æ—¶é—´å†…å°±ä¼šé‡åˆ°å¯è¿›å…¥GCçš„Safe Pointã€‚ä½†æ˜¯ï¼Œç¨‹åºâ€œä¸æ‰§è¡Œâ€çš„æ—¶å€™å‘¢ï¼Ÿä¾‹å¦‚çº¿ç¨‹å¤„äºSleepçŠ¶æ€æˆ–BlockedçŠ¶æ€ï¼Œè¿™æ—¶å€™çº¿ç¨‹æ— æ³•å“åº”JVMçš„ä¸­æ–­è¯·æ±‚ï¼Œâ€œèµ°â€åˆ°å®‰å…¨ç‚¹å»ä¸­æ–­æŒ‚èµ·ï¼ŒJVMä¹Ÿä¸å¤ªå¯èƒ½ç­‰å¾…çº¿ç¨‹è¢«å”¤é†’ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå°±éœ€è¦å®‰å…¨åŒºåŸŸæ¥è§£å†³ã€‚</p>
<blockquote>
<p>âœ…å®‰å…¨åŒºåŸŸ(Safe Region)</p>
</blockquote>
<p>å®‰å…¨åŒºåŸŸæ˜¯æŒ‡åœ¨ä¸€æ®µä»£ç ç‰‡æ®µä¸­ï¼Œå¯¹è±¡çš„å¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œåœ¨è¿™ä¸ªåŒºåŸŸä¸­çš„ä»»ä½•ä½ç½®å¼€å§‹GCéƒ½æ˜¯å®‰å…¨çš„ã€‚å¯ä»¥æŠŠSafe Regionçœ‹åšæ˜¯è¢«æ‰©å±•äº†çš„Safe Pointã€‚</p>
<blockquote>
<p>ğŸ”°å®é™…æ‰§è¡Œæ—¶</p>
</blockquote>
<ol>
<li><p>å½“çº¿ç¨‹è¿è¡Œåˆ°Safe Regionçš„ä»£ç æ—¶ï¼Œé¦–å…ˆæ ‡è¯†å·²ç»è¿›å…¥äº†Safe Regionï¼Œå¦‚æœè¿™æ®µæ—¶é—´å†…å‘ç”ŸGCï¼ŒJVMä¼šå¿½ç•¥è¡¨ç¤ºä¸ºSafe RegionçŠ¶æ€çš„çº¿ç¨‹ï¼›</p>
</li>
<li><p>å½“çº¿ç¨‹å³å°†ç¦»å¼€Safe Regionæ—¶ï¼Œä¼šæ£€æŸ¥JVMæ˜¯å¦å·²ç»å®ŒæˆGCï¼Œå¦‚æœå®Œæˆäº†ï¼Œåˆ™ç»§ç»­è¿è¡Œï¼Œå¦åˆ™çº¿ç¨‹å¿…é¡»ç­‰å¾…çŸ¥é“å¯ä»¥æ”¶åˆ°å¯ä»¥å®‰å…¨ç¦»å¼€Safe Regionçš„ä¿¡å·ä¸ºæ­¢ã€‚</p>
</li>
</ol>
<h2 id="14-7-ğŸ“œ-å¼•ç”¨"><a href="#14-7-ğŸ“œ-å¼•ç”¨" class="headerlink" title="14.7 ğŸ“œ å¼•ç”¨"></a>14.7 ğŸ“œ å¼•ç”¨</h2><blockquote>
<p>ğŸ“–æ¦‚è¿°</p>
</blockquote>
<ul>
<li>å¼ºå¼•ç”¨ï¼šæœ€ä¼ ç»Ÿçš„â€œå¼•ç”¨â€çš„å®šä¹‰ï¼Œæ˜¯æŒ‡åœ¨ç¨‹åºä»£ç ä¸­æ™®éå­˜åœ¨çš„å¼•ç”¨èµ‹å€¼ï¼Œå³ç±»ä¼¼<code>Object obj = new Object();</code>è¿™ç§å¼•ç”¨å…³ç³»ã€‚æ— è®ºä»»ä½•æƒ…å†µä¸‹ï¼Œåªè¦å¼ºå¼•ç”¨å…³ç³»è¿˜å­˜åœ¨ï¼Œåƒåœ¾å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶æ‰è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚</li>
<li>è½¯å¼•ç”¨ï¼šåœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºä¹‹å‰ï¼Œå°†ä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—å…¥å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ã€‚å¦‚æœè¿™æ¬¡å›æ”¶åè¿˜æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</li>
<li>å¼±å¼•ç”¨ï¼šè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾ä¹‹å‰ã€‚å½“åƒåœ¾å™¨å·¥ä½œæ—¶ï¼Œæ— è®ºå†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶æ‰è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚</li>
<li>è™šå¼•ç”¨ï¼šä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥è·å¾—ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„å°±æ˜¯èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«å™¨å›æ”¶å‰æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚</li>
</ul>
<blockquote>
<p>1ï¸âƒ£å¼ºå¼•ç”¨ï¼ˆStrong Reference/æ°¸ä¸å›æ”¶ï¼‰</p>
</blockquote>
<p>åœ¨Javaç¨‹åºä¸­ï¼Œæœ€å¸¸è§çš„å¼•ç”¨ç±»å‹æ˜¯å¼ºå¼•ç”¨ï¼ˆæ™®é€šç³»ç»Ÿ99%ä»¥ä¸Šéƒ½æ˜¯å¼ºå¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œä¹Ÿæ˜¯é»˜è®¤çš„å¼•ç”¨ç±»å‹ã€‚</p>
<p>å½“åœ¨Javaè¯­è¨€ä¸­ä½¿ç”¨newæ“ä½œç¬¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™å¦ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œè¿™ä¸ªå˜é‡å°±æˆä¸ºæŒ‡å‘è¯¥å¯¹è±¡çš„ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚</p>
<p>å¼ºå¼•ç”¨çš„å¯¹è±¡æ˜¯å¯è§¦åŠçš„ï¼Œåƒåœ¾å™¨å°±æ°¸è¿œä¸ä¼šå›æ”¶æ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼ŒJVMå®æ„¿æŠ›å‡ºOutOfMemoryå¼‚å¸¸ä¹Ÿä¸ä¼šå›æ”¶è¿™ç§å¯¹è±¡ã€‚</p>
<p>å¯¹äºä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çš„å¼•ç”¨å…³ç³»ï¼Œåªè¦è¶…è¿‡äº†å¼•ç”¨çš„ä½œç”¨åŸŸæˆ–è€…æ˜¾ç¤ºåœ°å°†ç›¸åº”å¼ºå¼•ç”¨èµ‹å€¼ä¸ºnullï¼Œå°±æ˜¯å¯ä»¥å½“ä½œåƒåœ¾è¢«äº†ï¼Œå½“ç„¶å…·ä½“å›æ”¶æ—¶æœºè¿˜æ˜¯è¦çœ‹åƒåœ¾ç­–ç•¥ã€‚</p>
<p>ç›¸å¯¹çš„ï¼Œè½¯å¼•ç”¨ã€å¼±å¼•å’Œè™šå¯¹è±¡æ˜¯è½¯å¯è§¦åŠã€å¼±å¯è§¦åŠå’Œè™šå¯è§¦åŠçš„ï¼Œåœ¨ä¸€å®šæ¡ä»¶ä¸‹ï¼Œéƒ½æ˜¯å¯ä»¥è¢«å›æ”¶çš„ã€‚æ‰€ä»¥ï¼Œå¼ºå¼•ç”¨æ˜¯é€ æˆJavaå†…å­˜æ³„æ¼çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚</p>
<p>å®ä¾‹ï¼š</p>
<pre><code>public class StrongReferenceTest &#123;
    /**
     * -Xmx1m -Xms1m
     */
    public static void main(String[] args) &#123;
        Object[] objs = new Object[1000 * 1000];
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space</code></pre>
<blockquote>
<p>2ï¸âƒ£è½¯å¼•ç”¨ï¼ˆSoft Reference/æº¢å‡ºå›æ”¶ï¼‰</p>
</blockquote>
<p>è½¯å¼•ç”¨æ˜¯ç”¨æ¥æè¿°ä¸€äº›è¿˜æœ‰ï¼Œä½†éå¿…éœ€çš„å¯¹è±¡ã€‚åªè¢«è½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ï¼Œåœ¨ç³»ç»Ÿå°†è¦å‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸å‰ï¼Œä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—è¿›å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ï¼Œå¦‚æœè¿™æ¬¡å›æ”¶è¿˜æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚</p>
<p>è½¯å¼•ç”¨é€šå¸¸ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„ç¼“å­˜ã€‚æ¯”å¦‚ï¼šé«˜é€Ÿç¼“å­˜å°±æœ‰ç”¨åˆ°è½¯å¼•ç”¨ï¼Œå¦‚æœè¿˜æœ‰ç©ºé—²å†…å­˜ï¼Œå°±å¯ä»¥æš‚æ—¶ä¿ç•™ç¼“å­˜ï¼Œå½“å†…å­˜ä¸è¶³æ—¶æ¸…ç†æ‰ï¼Œè¿™æ ·å°±ä¿è¯äº†ä½¿ç”¨ç¼“å­˜çš„åŒæ—¶ï¼Œä¸ä¼šè€—å°½å†…å­˜ã€‚</p>
<p>åƒåœ¾å›æ”¶å™¨åœ¨æŸä¸ªæ—¶åˆ»å†³å®šå›æ”¶è½¯å¯è¾¾çš„å¯¹è±¡çš„æ—¶å€™ï¼Œä¼šæ¸…ç†è½¯å¼•ç”¨ï¼Œå¹¶å¯é€‰åœ°æŠŠå¼•ç”¨å­˜æ”¾åˆ°ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ã€‚</p>
<p>ç±»ä¼¼å¼±å¼•ç”¨ï¼Œåªä¸è¿‡Javaè™šæ‹Ÿæœºä¼šå°½é‡è®©è½¯å¼•ç”¨çš„å­˜æ´»æ—¶é—´é•¿ä¸€ç‚¹ï¼Œè¿«ä¸å¾—å·²æ‰æ¸…ç†ã€‚</p>
<p>å®ä¾‹ï¼š</p>
<pre><code>public class SoftReferenceTest &#123;
    /**
     * -Xmx10m -Xms10m
     */
    public static void main(String[] args) &#123;
        /* å£°æ˜å¼ºå¼•ç”¨ */
        Object obj = new Object();
        System.out.println(obj);
        SoftReference&lt;Object&gt; softReference = new SoftReference&lt;Object&gt;(obj);
        /* é”€æ¯å¼ºå¼•ç”¨ */
        obj = null;
        System.out.println(softReference.get());
        /* ä¸»åŠ¨è¿›è¡ŒGC */
        System.gc();
        System.out.println(softReference.get());

        /* è®©ç³»ç»Ÿèµ„æºç´§å¼  */
        try &#123;
            byte[] bytes = new byte[1024 * 1024 * 7]; // 7m
        &#125; catch (Throwable e) &#123;
            e.printStackTrace();
        &#125; finally &#123;
            System.out.println(softReference.get()); // nullä»£è¡¨å·²ç»è¢«å›æ”¶
        &#125;
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>java.lang.Object@1b6d3586
java.lang.Object@1b6d3586
java.lang.Object@1b6d3586
java.lang.OutOfMemoryError: Java heap space
    at top.parak.SoftReferenceTest.main(SoftReferenceTest.java:35)
null</code></pre>
<blockquote>
<p>3ï¸âƒ£å¼±å¼•ç”¨ï¼ˆWeak Reference/å‘ç°å›æ”¶ï¼‰</p>
</blockquote>
<p>å¼±å¼•ç”¨ä¹Ÿæ˜¯ç”¨æ¥æè¿°é‚£äº›éå¿…é¡»å¯¹è±¡ï¼Œåªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾å‘ç”Ÿä¸ºæ­¢ã€‚åœ¨ç³»ç»ŸGCæ—¶ï¼Œåªè¦å‘ç°å¼±å¼•ç”¨ï¼Œä¸ç®¡ç³»ç»Ÿå †ç©ºé—´ä½¿ç”¨æ˜¯å¦å……è¶³ï¼Œéƒ½ä¼šå›æ”¶æ‰åªè¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚</p>
<p>ä½†æ˜¯ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨çš„çº¿ç¨‹é€šå¸¸ä¼˜å…ˆçº§å¾ˆä½ï¼Œå› æ­¤ï¼Œå¹¶ä¸ä¸€å®šèƒ½å¾ˆå¿«åœ°å‘ç°æŒæœ‰å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¼±å¼•ç”¨å¯¹è±¡å¯ä»¥å­˜åœ¨è¾ƒé•¿çš„æ—¶é—´ã€‚</p>
<p>å¼±å¼•ç”¨å’Œè½¯å¼•ç”¨ä¸€æ ·ï¼Œåœ¨æ„é€ å¼±å¼•ç”¨æ—¶ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼Œå½“å¼±å¼•ç”¨å¯¹è±¡è¢«å›æ”¶æ—¶ï¼Œå°±ä¼šåŠ å…¥æŒ‡å®šçš„å¼•ç”¨é˜Ÿåˆ—ï¼Œé€šè¿‡è¿™ä¸ªé˜Ÿåˆ—å¯ä»¥è·Ÿè¸ªå¯¹è±¡çš„å›æ”¶æƒ…å†µã€‚</p>
<p>è½¯å¼•ç”¨ã€å¼±å¼•ç”¨éƒ½éå¸¸é€‚åˆæ¥ä¿å­˜é‚£äº›å¯æœ‰å¯æ— çš„ç¼“å­˜æ•°æ®ã€‚å¦‚æœè¿™ä¹ˆåšï¼Œå½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼Œè¿™äº›ç¼“å­˜æ•°æ®ä¼šè¢«å›æ”¶ï¼Œä¸ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚è€Œå½“å†…å­˜èµ„æºå……è¶³æ—¶ï¼Œè¿™äº›ç¼“å­˜åˆå¯ä»¥å­˜åœ¨ç›¸å½“é•¿çš„æ—¶é—´ï¼Œä»è€Œèµ·åˆ°åŠ é€Ÿç³»ç»Ÿçš„ä½œç”¨ã€‚</p>
<p>å®ä¾‹ï¼š</p>
<pre><code>public class WeakReferenceTest &#123;
    public static void main(String[] args) &#123;
        Object obj = new Object();
        WeakReference&lt;Object&gt; weakReference = new WeakReference&lt;Object&gt;(obj);
        System.out.println(weakReference.get());
       /* è§£é™¤å¼ºå¼•ç”¨ */
        obj = null;
        /* ä¸»åŠ¨GC */
        System.gc();
        System.out.println(weakReference.get());
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>java.lang.Object@1b6d3586
null</code></pre>
<blockquote>
<p>4ï¸âƒ£è™šå¼•ç”¨ï¼ˆPhantom Reference/å›æ”¶è·Ÿè¸ªï¼‰</p>
</blockquote>
<p>è™šå¼•ç”¨ä¹Ÿç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œæ˜¯æ‰€æœ‰å¼•ç”¨ç±»å‹ä¸­æœ€å¼±çš„ä¸€ä¸ªã€‚</p>
<p>ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨ï¼Œå®Œå…¨ä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä»…æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå’Œå®ƒæ²¡æœ‰å¼•ç”¨å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œéšæ—¶éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</p>
<p>å®ƒä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥è·å–è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚å½“è¯•å›¾é€šè¿‡è™šå¼•ç”¨çš„get()æ–¹æ³•å–å¾—å¯¹è±¡æ—¶ï¼Œæ€»æ˜¯nullã€‚</p>
<p>ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„åœ¨äºè·Ÿè¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚æ¯”å¦‚ï¼šèƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«å™¨å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚</p>
<p>å®ä¾‹ï¼š</p>
<pre><code>public class PhantomReferenceTest &#123;
    public static PhantomReferenceTest obj;
    /**
     * å¼•ç”¨é˜Ÿåˆ—
     */
    public static ReferenceQueue&lt;PhantomReferenceTest&gt; phantomQueue = null;

    public static class CheckRefQueue extends Thread &#123;
        @Override
        public void run() &#123;
            while (true) &#123;
                if (phantomQueue != null) &#123;
                    PhantomReference&lt;PhantomReferenceTest&gt; objt = null;
                    try &#123;
                        objt = (PhantomReference&lt;PhantomReferenceTest&gt;) phantomQueue.remove();
                    &#125; catch (InterruptedException e) &#123;
                        e.printStackTrace();
                    &#125;
                    if (objt != null) &#123;
                        System.out.println(&quot;è¿½è¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹ï¼šPhantRefernceTestå®ä¾‹è¢«GCäº†&quot;);
                    &#125;
                &#125;
            &#125;
        &#125;
    &#125;

    @Override
    protected void finalize() throws Throwable &#123;
        super.finalize();
        System.out.println(&quot;è°ƒç”¨å½“å‰ç±»çš„finalize()æ–¹æ³•&quot;);
        obj = this;
    &#125;

    public static void main(String[] args) &#123;
        Thread t = new CheckRefQueue();
        t.setDaemon(true);  // å®ˆæŠ¤çº¿ç¨‹
        t.start();

        phantomQueue = new ReferenceQueue&lt;PhantomReferenceTest&gt;();
        obj = new PhantomReferenceTest();
        // æ„é€ äº†PhantomReferenceå¯¹è±¡çš„è™šå¼•ç”¨ï¼Œå¹¶æŒ‡å®šäº†å¼•ç”¨é˜Ÿåˆ—
        PhantomReference&lt;PhantomReferenceTest&gt; phantomRef = new PhantomReference&lt;&gt;(obj, phantomQueue);
        try &#123;
            // ä¸å¯è·å–è™šå¼•ç”¨ä¸­çš„å¯¹è±¡
            System.out.println(&quot;phantomRef.get() = &quot; + phantomRef.get());

            // ç¬¬ä¸€æ¬¡GCï¼Œç”±äºå¯¹è±¡å¯å¤æ´»ï¼Œå¹¶æŒ‡å®šäº†å¼•ç”¨é˜Ÿåˆ—
            System.out.println(&quot;=&gt;&gt;&gt; ç¬¬ä¸€æ¬¡GCæ“ä½œ&quot;);
            obj = null; // è§£é™¤å¼ºå¼•ç”¨
            System.gc();
            Thread.sleep(1000);
            System.out.println(obj == null ? &quot;obj == null&quot; : &quot;obj != null&quot;);

            System.out.println(&quot;=&gt;&gt;&gt; ç¬¬äºŒæ¬¡GC&quot;);
            obj = null; // è§£é™¤å¼ºå¼•ç”¨
            System.gc();
            Thread.sleep(1000);
            System.out.println(obj == null ? &quot;obj == null&quot; : &quot;obj != null&quot;);
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125; finally &#123;

        &#125;
    &#125;

&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>phantomRef.get() = null
=&gt;&gt;&gt; ç¬¬ä¸€æ¬¡GCæ“ä½œ
è°ƒç”¨å½“å‰ç±»çš„finalize()æ–¹æ³•
obj != null
=&gt;&gt;&gt; ç¬¬äºŒæ¬¡GC
è¿½è¸ªåƒåœ¾å›æ”¶è¿‡ç¨‹ï¼šPhantRefernceTestå®ä¾‹è¢«GCäº†
obj == null</code></pre>
<blockquote>
<p>5ï¸âƒ£ç»ˆç»“å™¨å¼•ç”¨</p>
</blockquote>
<ul>
<li>å®ƒç”¨ä»¥å®ç°å¯¹è±¡çš„finalize()æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æˆä¸ºç»ˆç»“å™¨å¼•ç”¨ã€‚</li>
<li>æ— éœ€æ‰‹åŠ¨ç¼–ç ï¼Œå…¶å†…éƒ¨é…åˆå¼•ç”¨é˜Ÿåˆ—ä½¿ç”¨ã€‚</li>
<li>åœ¨GCæ—¶ï¼Œç»ˆç»“å™¨å¼•ç”¨å…¥é˜Ÿã€‚ç”±Finalizerçº¿ç¨‹é€šè¿‡ç»ˆç»“å™¨å¼•ç”¨æ‰¾åˆ°è¢«å¼•ç”¨å¯¹è±¡å¹¶è°ƒç”¨å®ƒçš„finalize()æ–¹æ³•ï¼Œç¬¬äºŒæ¬¡GCæ—¶æ‰èƒ½å›æ”¶è¢«å¼•ç”¨å¯¹è±¡ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-13(åƒåœ¾å›æ”¶ç®—æ³•)</title>
    <url>/posts/25/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="13-1-ğŸ“–-åƒåœ¾å›æ”¶æ¦‚è¿°"><a href="#13-1-ğŸ“–-åƒåœ¾å›æ”¶æ¦‚è¿°" class="headerlink" title="13.1 ğŸ“– åƒåœ¾å›æ”¶æ¦‚è¿°"></a>13.1 ğŸ“– åƒåœ¾å›æ”¶æ¦‚è¿°</h2><blockquote>
<p>ğŸ—‘ï¸ ä»€ä¹ˆæ˜¯åƒåœ¾</p>
</blockquote>
<p>åƒåœ¾æ˜¯æŒ‡åœ¨è¿è¡Œç¨‹åºä¸­æ²¡æœ‰ä»»ä½•æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯éœ€è¦è¢«å›æ”¶çš„åƒåœ¾ã€‚</p>
<p>å¦‚æœä¸åŠæ—¶å¯¹å†…å­˜ä¸­çš„åƒåœ¾è¿›è¡Œæ¸…ç†ï¼Œé‚£ä¹ˆï¼Œè¿™äº›åƒåœ¾å¯¹è±¡æ‰€å çš„å†…å­˜ç©ºé—´ä¼šä¸€ç›´ä¿ç•™åˆ°åº”ç”¨ç¨‹åºçš„ç»“æŸï¼Œè¢«ä¿ç•™çš„ç©ºé—´æ— æ³•è¢«å…¶å®ƒå¯¹è±¡ä½¿ç”¨ï¼Œç”šè‡³å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚</p>
<blockquote>
<p>â“å¤§å‚é¢è¯•é¢˜</p>
</blockquote>
<p><strong>èš‚èšé‡‘æœ</strong></p>
<ul>
<li>ä½ çŸ¥é“å“ªå‡ ç§åƒåœ¾å›æ”¶å™¨ï¼Œå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œé‡ç‚¹è®²ä¸€ä¸‹cmså’ŒG1ï¼Ÿ</li>
<li>JVM GCç®—æ³•æœ‰å“ªäº›ï¼Œç›®å‰çš„JDKç‰ˆæœ¬é‡‡ç”¨ä»€ä¹ˆå›æ”¶ç®—æ³•ï¼Ÿ</li>
<li>G1å›æ”¶å™¨è®²ä¸‹å›æ”¶è¿‡ç¨‹GCæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦æœ‰GCï¼Ÿ</li>
<li>GCçš„ä¸¤ç§åˆ¤å®šæ–¹æ³•ï¼ŸCMSæ”¶é›†å™¨ä¸G1æ”¶é›†å™¨çš„ç‰¹ç‚¹ã€‚</li>
</ul>
<p><strong>ç™¾åº¦</strong></p>
<ul>
<li>è¯´ä¸€ä¸‹GCç®—æ³•ï¼Œåˆ†ä»£å›æ”¶è¯´ä¸‹ã€‚</li>
<li>åƒåœ¾ç­–ç•¥å’Œç®—æ³•ã€‚</li>
</ul>
<p><strong>å¤©çŒ«</strong></p>
<ul>
<li>JVM GCåŸç†ï¼ŒJVMæ€ä¹ˆå›æ”¶å†…å­˜ã€‚</li>
<li>CMSç‰¹ç‚¹ï¼Œåƒåœ¾å›æ”¶ç®—æ³•æœ‰å“ªäº›ï¼Ÿå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œä»–ä»¬å…±åŒçš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</li>
</ul>
<p><strong>æ»´æ»´</strong></p>
<p>Javaçš„åƒåœ¾å›æ”¶å™¨éƒ½æœ‰å“ªäº›ï¼Œè¯´ä¸‹G1çš„åº”ç”¨åœºæ™¯ï¼Œå¹³æ—¶ä½ æ˜¯å¦‚ä½•æ­é…ä½¿ç”¨åƒåœ¾å›æ”¶å™¨çš„ã€‚</p>
<p><strong>äº¬ä¸œ</strong></p>
<ul>
<li>ä½ çŸ¥é“å“ªå‡ ç§åƒåœ¾å™¨ï¼Œå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Œé‡ç‚¹è®²ä¸‹CMSå’ŒG1ã€‚</li>
<li>åŒ…æ‹¬åŸç†ï¼Œæµç¨‹ï¼Œä¼˜ç¼ºç‚¹ã€‚åƒåœ¾å›æ”¶ç®—æ³•çš„å®ç°åŸç†ã€‚</li>
</ul>
<p><strong>é˜¿é‡Œå·´å·´</strong></p>
<ul>
<li>è®²ä¸€è®²åƒåœ¾å›æ”¶ç®—æ³•ã€‚</li>
<li>ä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘åƒåœ¾å›æ”¶ï¼Ÿ</li>
<li>å¦‚ä½•é€‰æ‹©åˆé€‚çš„åƒåœ¾ç®—æ³•ï¼Ÿ</li>
<li>JVMæœ‰å“ªä¸‰ç§åƒåœ¾å›æ”¶å™¨ï¼Ÿ</li>
</ul>
<p><strong>å­—èŠ‚è·³åŠ¨</strong></p>
<ul>
<li>å¸¸è§çš„åƒåœ¾å›æ”¶å™¨ç®—æ³•æœ‰å“ªäº›ï¼Œå„æœ‰ä»€ä¹ˆä¼˜åŠ£ï¼Ÿ</li>
<li>System.gcï¼ˆï¼‰å’ŒRuntime.gcï¼ˆï¼‰ä¼šåšä»€ä¹ˆäº‹æƒ…ï¼Ÿ</li>
<li>Java GCæœºåˆ¶ï¼ŸGC Rootsæœ‰å“ªäº›ï¼Ÿ</li>
<li>Javaå¯¹è±¡çš„å›æ”¶æ–¹å¼ï¼Œå›æ”¶ç®—æ³•ã€‚</li>
<li>CMSå’ŒG1äº†è§£ä¹ˆï¼ŒCMSè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œè¯´ä¸€ä¸‹å›æ”¶çš„è¿‡ç¨‹ã€‚</li>
<li>CMSå›æ”¶åœé¡¿äº†å‡ æ¬¡ï¼Œä¸ºä»€ä¹ˆè¦åœé¡¿ä¸¤æ¬¡?</li>
</ul>
<blockquote>
<p>â™» GC</p>
</blockquote>
<p>å¯¹äºé«˜çº§è¯­è¨€æ¥è¯´ï¼Œä¸€ä¸ªåŸºæœ¬è®¤çŸ¥æ˜¯å¦‚æœä¸è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå†…å­˜è¿Ÿæ—©éƒ½ä¼šè¢«æ¶ˆè€—å®Œï¼Œå› ä¸ºä¸æ–­åœ°åˆ†é…å†…å­˜ç©ºé—´è€Œä¸è¿›è¡Œå›æ”¶ï¼Œå°±å¥½åƒä¸åœåœ°ç”Ÿäº§ç”Ÿæ´»åƒåœ¾è€Œä»æ¥ä¸æ‰“æ‰«ä¸€æ ·ã€‚</p>
<p>é™¤äº†é‡Šæ”¾æ²¡ç”¨çš„å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶ä¹Ÿå¯ä»¥æ¸…é™¤å†…å­˜é‡Œçš„è®°å½•ç¢ç‰‡ã€‚ç¢ç‰‡æ•´ç†å°†æ‰€å ç”¨çš„å †å†…å­˜ç§»åˆ°å †çš„ä¸€ç«¯ï¼Œä»¥ä¾¿JVMå°†æ•´ç†å‡ºçš„å†…å­˜åˆ†é…ç»™æ–°çš„å¯¹è±¡ã€‚</p>
<p>éšç€åº”ç”¨ç¨‹åºæ‰€åº”ä»˜çš„ä¸šåŠ¡è¶Šæ¥è¶Šåºå¤§ã€å¤æ‚ï¼Œç”¨æˆ·è¶Šæ¥è¶Šå¤šï¼Œæ²¡æœ‰GCå°±ä¸èƒ½ä¿è¯åº”ç”¨ç¨‹åºçš„æ­£å¸¸è¿›è¡Œã€‚è€Œç»å¸¸é€ æˆSTWçš„GCåˆè·Ÿä¸ä¸Šå®é™…çš„éœ€æ±‚ï¼Œæ‰€ä»¥æ‰ä¼šä¸æ–­åœ°å°è¯•å¯¹GCè¿›è¡Œä¼˜åŒ–ã€‚</p>
<blockquote>
<p>ğŸ”°åƒåœ¾å›æ”¶æœºåˆ¶</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<p>è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œæ— éœ€å¼€å‘äººå‘˜æ‰‹åŠ¨å‚ä¸å†…å­˜çš„åˆ†é…ä¸å›æ”¶ï¼Œè¿™æ ·é™ä½å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºçš„é£é™©ã€‚</p>
<p>æ²¡æœ‰åƒåœ¾å›æ”¶å™¨ï¼Œjavaä¹Ÿä¼šå’Œcppä¸€æ ·ï¼Œå„ç§æ‚¬å‚æŒ‡é’ˆï¼Œé‡æŒ‡é’ˆï¼Œæ³„éœ²é—®é¢˜è®©ä½ å¤´ç–¼ä¸å·²ã€‚</p>
<p>è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå°†ç¨‹åºå‘˜ä»ç¹é‡çš„å†…å­˜ç®¡ç†ä¸­é‡Šæ”¾å‡ºæ¥ï¼Œå¯ä»¥æ›´ä¸“å¿ƒåœ°ä¸“æ³¨äºä¸šåŠ¡å¼€å‘ã€‚</p>
<p>oracleå®˜ç½‘å…³äºåƒåœ¾å›æ”¶çš„ä»‹ç» <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html</a></p>
<p>æ‹…å¿§ï¼š</p>
<p>å¯¹äºJavaå¼€å‘äººå‘˜è€Œè¨€ï¼Œè‡ªåŠ¨å†…å­˜ç®¡ç†å°±åƒæ˜¯ä¸€ä¸ªé»‘åŒ£å­ï¼Œå¦‚æœè¿‡åº¦ä¾èµ–äºâ€œè‡ªåŠ¨â€ï¼Œé‚£ä¹ˆè¿™å°†ä¼šæ˜¯ä¸€åœºç¾éš¾ï¼Œæœ€ä¸¥é‡çš„å°±ä¼šå¼±åŒ–Javaå¼€å‘äººå‘˜åœ¨ç¨‹åºå‡ºç°å†…å­˜æº¢å‡ºæ—¶å®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜çš„èƒ½åŠ›ã€‚</p>
<p>æ­¤æ—¶ï¼Œäº†è§£JVMçš„è‡ªåŠ¨å†…å­˜åˆ†é…å’Œå†…å­˜å›æ”¶åŸç†å°±æ˜¾å¾—éå¸¸é‡è¦ï¼Œåªæœ‰åœ¨çœŸæ­£äº†è§£JVMæ˜¯å¦‚ä½•ç®¡ç†å†…å­˜åï¼Œæˆ‘ä»¬æ‰èƒ½å¤Ÿåœ¨é‡è§outofMemoryErroræ—¶ï¼Œå¿«é€Ÿåœ°æ ¹æ®é”™è¯¯å¼‚å¸¸æ—¥å¿—å®šä½é—®é¢˜å’Œè§£å†³é—®é¢˜ã€‚</p>
<p>å½“éœ€è¦æ’æŸ¥å„ç§å†…å­˜æº¢å‡ºã€å†…å­˜æ³„æ¼é—®é¢˜æ—¶ï¼Œå½“åƒåœ¾æˆä¸ºç³»ç»Ÿè¾¾åˆ°æ›´é«˜å¹¶å‘é‡çš„ç“¶é¢ˆæ—¶ï¼Œæˆ‘ä»¬å°±å¿…é¡»å¯¹è¿™äº›â€œè‡ªåŠ¨åŒ–â€çš„æŠ€æœ¯å®æ–½å¿…è¦çš„ç›‘æ§å’Œè°ƒèŠ‚ã€‚</p>
<p>GCä¸»è¦å…³æ³¨çš„åŒºåŸŸï¼šå †å’Œæ–¹æ³•åŒºã€‚</p>
<h2 id="13-2-ğŸ³â€ğŸŒˆ-æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•"><a href="#13-2-ğŸ³â€ğŸŒˆ-æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•" class="headerlink" title="13.2 ğŸ³â€ğŸŒˆ æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•"></a>13.2 ğŸ³â€ğŸŒˆ æ ‡è®°é˜¶æ®µï¼šå¼•ç”¨è®¡æ•°ç®—æ³•</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>å¼•ç”¨è®¡æ•°ç®—æ³•ï¼ˆReference Countingï¼‰æ¯”è¾ƒç®€å•ï¼Œå¯¹æ¯ä¸ªå¯¹è±¡ä¿å­˜ä¸€ä¸ªæ•´å‹çš„å¼•ç”¨è®¡æ•°å™¨å±æ€§ã€‚ç”¨äºè®°å½•å¯¹è±¡è¢«å¼•ç”¨çš„æƒ…å†µã€‚</li>
<li>å¯¹ä¸€ä¸ªå¯¹è±¡Aï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå¯¹è±¡å¼•ç”¨äº†Aï¼Œåˆ™Açš„è®¡æ•°å™¨å°±åŠ ä¸€ï¼›å½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œå¼•ç”¨è®¡æ•°å™¨å°±å‡ä¸€ã€‚åªè¦å¯¹è±¡Açš„å¼•ç”¨è®¡æ•°å™¨çš„å€¼ä¸º0ï¼Œå³è¡¨ç¤ºå¯¹è±¡Aä¸å¯èƒ½å†è¢«ä½¿ç”¨ï¼Œå¯è¿›è¡Œå›æ”¶ã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å®ç°ç®€å•ï¼Œåƒåœ¾å¯¹è±¡ä¾¿äºè¾¨è¯†ã€‚</li>
<li>åˆ¤å®šæ•ˆç‡é«˜ï¼Œå›æ”¶æ²¡æœ‰å»¶è¿Ÿæ€§ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>å®ƒéœ€è¦å•ç‹¬çš„å­—æ®µå­˜å‚¨è®¡æ•°å™¨ï¼Œè¿™æ ·çš„åšæ³•å¢åŠ äº†å­˜å‚¨ç©ºé—´çš„å¼€é”€ã€‚</li>
<li>æ¯æ¬¡èµ‹å€¼éƒ½éœ€è¦æ›´æ–°è®¡æ•°å™¨ï¼Œä¼´éšç€åŠ æ³•å’Œå‡æ³•æ“ä½œï¼Œå¢åŠ äº†æ—¶é—´å¼€é”€ã€‚</li>
<li>å¼•ç”¨è®¡æ•°å™¨æœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œå³æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨çš„æƒ…å†µã€‚è¿™æ˜¯ä¸€æ¡è‡´å‘½ç¼ºé™·ï¼Œå¯¼è‡´åœ¨Javaçš„åƒåœ¾å›æ”¶å™¨ä¸­æ²¡æœ‰ä½¿ç”¨è¿™ç±»ç®—æ³•ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“¸å¾ªç¯å¼•ç”¨</p>
</blockquote>
<p>å†…å­˜æ³„éœ²ï¼šç¨‹åºä¸­å·²åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› ç¨‹åºæœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœã€‚</p>


<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/25/image-20210309175155047.png" class="" title="image-20210309175155047">

<br>


<blockquote>
<p>ğŸ“‘å°ç»“</p>
</blockquote>
<ul>
<li>å¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œæ˜¯å¾ˆå¤šè¯­è¨€çš„èµ„æºå›æ”¶é€‰æ‹©ï¼Œä¾‹å¦‚Pythonï¼Œå®ƒæ›´æ˜¯åŒæ—¶æ”¯æŒå¼•ç”¨è®¡æ•°å’Œåƒåœ¾æœºåˆ¶ã€‚</li>
<li>Javaå¹¶æ²¡æœ‰é€‰æ‹©å¼•ç”¨è®¡æ•°ï¼Œæ˜¯å› ä¸ºå…¶å­˜åœ¨ä¸€ä¸ªåŸºæœ¬çš„éš¾é¢˜ï¼Œä¹Ÿå°±æ˜¯å¾ˆéš¾å¤„ç†å¾ªç¯å¼•ç”¨å…³ç³»ã€‚</li>
<li>Pythonå¦‚ä½•è§£å†³å¾ªç¯å¼•ç”¨ï¼š<ul>
<li>æ‰‹åŠ¨è§£é™¤ï¼šåœ¨åˆé€‚çš„æ—¶æœºï¼Œè§£é™¤å¼•ç”¨å…³ç³»ã€‚</li>
<li>ä½¿ç”¨å¼±å¼•ç”¨weakrefï¼ˆPythonæ ‡å‡†åº“ï¼Œæ—¨åœ¨è§£å†³å¾ªç¯å¼•ç”¨ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h2 id="13-3-ğŸ¦†-æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#13-3-ğŸ¦†-æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="13.3 ğŸ¦† æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•"></a>13.3 ğŸ¦† æ ‡è®°é˜¶æ®µï¼šå¯è¾¾æ€§åˆ†æç®—æ³•</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>ç›¸å¯¹äºå¼•ç”¨è®¡æ•°ç®—æ³•è€Œè¨€ï¼Œå¯è¾¾æ€§åˆ†æç®—æ³•ä¸ä»…åŒæ ·å…·å¤‡å®ç°ç®€å•å’Œæ‰§è¡Œé«˜æ•ˆç­‰ç‰¹ç‚¹ï¼Œæ›´é‡è¦çš„æ˜¯æ”¹ç®—æ³•å¯ä»¥æœ‰æ•ˆåœ°è§£å†³åœ¨å¼•ç”¨è®¡æ•°ç®—æ³•ä¸­å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²å‘ç”Ÿã€‚</li>
<li>ç›¸è¾ƒäºå¼•ç”¨è®¡æ•°ç®—æ³•ï¼Œè¿™é‡Œçš„å¯è¾¾æ€§åˆ†æå°±æ˜¯Javaã€C#é€‰æ‹©çš„ã€‚è¿™ç§ç±»å‹çš„åƒåœ¾é€šå¸¸ä¹Ÿå«ä½œè¿½è¸ªæ€§åƒåœ¾ï¼ˆTracing Garbage Collectionï¼‰</li>
</ul>
<blockquote>
<p>ğŸ”æ€è·¯</p>
</blockquote>
<ul>
<li>å¯è¾¾æ€§åˆ†æç®—æ³•æ˜¯ä»¥æ ¹å¯¹è±¡é›†åˆï¼ˆGC Rootsï¼‰ä¸ºèµ·å§‹ç‚¹ï¼ŒæŒ‰ç…§ä»ä¸Šè‡³ä¸‹çš„æ–¹å¼æœç´¢è¢«æ ¹å¯¹è±¡é›†åˆæ‰€è¿æ¥çš„ç›®æ ‡å¯¹è±¡æ˜¯å¦å¯è¾¾ã€‚</li>
<li>ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•åï¼Œå†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡éƒ½ä¼šè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–é—´æ¥è¿æ¥ç€ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾ï¼ˆReference Chainï¼‰ã€‚</li>
<li>å¦‚æœç›®æ ‡å¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿ï¼Œåˆ™æ˜¯ä¸å¯è¾¾çš„ï¼Œå°±æ„å‘³ç€è¯¥å¯¹è±¡å·²ç»æ­»äº¡ï¼Œå¯ä»¥æ ‡è®°ä¸ºåƒåœ¾å¯¹è±¡ã€‚</li>
<li>åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­ï¼Œåªæœ‰èƒ½å¤Ÿè¢«æ ¹å¯¹è±¡é›†åˆç›´æ¥æˆ–è€…é—´æ¥è¿æ¥çš„å¯¹è±¡æ‰æ˜¯å­˜æ´»å¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>â™GC Roots</p>
</blockquote>
<ul>
<li><p>è™šæ‹Ÿæœºæ ˆä¸­å¼•ç”¨çš„å¯¹è±¡</p>
</li>
<li><p>æœ¬åœ°æ–¹æ³•æ ˆå†…JNIï¼ˆæœ¬åœ°æ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡</p>
</li>
<li><p>æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</p>
</li>
<li><p>æ‰€æœ‰è¢«åŒæ­¥é”synchronizedæŒæœ‰çš„å¯¹è±¡</p>
</li>
<li><p>Javaè™šæ‹Ÿæœºå†…éƒ¨çš„å¼•ç”¨</p>
</li>
<li><p>åæ˜ Javaè™šæ‹Ÿæœºå†…éƒ¨æƒ…å†µçš„JMXBeanã€JVMTIä¸­æ³¨å†Œçš„å›è°ƒã€æœ¬åœ°ä»£ç ç¼“å­˜ç­‰</p>
</li>
<li><p>é™¤äº†è¿™äº›å›ºå®šçš„GC Rootsé›†åˆä»¥å¤–ï¼Œæ ¹æ®ç”¨æˆ·æ‰€é€‰ç”¨çš„åƒåœ¾å™¨ä»¥åŠå½“å‰å›æ”¶çš„å†…å­˜åŒºåŸŸä¸åŒï¼Œè¿˜å¯ä»¥æœ‰å…¶ä»–å¯¹è±¡â€œä¸´æ—¶æ€§â€åœ°åŠ å…¥ï¼Œå…±åŒæ„æˆå®Œæ•´GC Rootsé›†åˆã€‚æ¯”å¦‚ï¼šåˆ†ä»£å’Œå±€éƒ¨å›æ”¶ã€‚</p>
</li>
<li><ul>
<li>å¦‚æœåªé’ˆå¯¹Javaå †åŒºä¸­çš„æŸä¸€å—åŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå¿…é¡»è€ƒè™‘åˆ°å†…å­˜åŒºåŸŸæ˜¯è™šæ‹Ÿæœºè‡ªå·±çš„å®ç°ç»†èŠ‚ï¼Œæ›´ä¸æ˜¯å­¤ç«‹å°é—­çš„ï¼Œè¿™ä¸ªåŒºåŸŸçš„å¯¹è±¡å®Œå…¨æœ‰å¯èƒ½è¢«å…¶ä»–åŒºåŸŸçš„å¯¹è±¡æ‰€å¼•ç”¨ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä¸€å¹¶å°†å…³è”çš„åŒºåŸŸå¯¹è±¡ä¹ŸåŠ å…¥GC Rootsé›†åˆä¸­å»è€ƒè™‘ï¼Œæ‰èƒ½ä¿è¯å¯è¾¾æ€§åˆ†æçš„å‡†ç¡®æ€§ã€‚</li>
</ul>
</li>
<li><p>å°æŠ€å·§ï¼šç”±äºæ ˆæ–¹å¼å­˜æ”¾å˜é‡å’ŒæŒ‡é’ˆï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒä¿å­˜äº†å †å†…å­˜é‡Œé¢çš„å¯¹è±¡ï¼Œä½†æ˜¯è‡ªå·±ç”±ä¸å­˜æ”¾åœ¨å †å†…å­˜é‡Œé¢ï¼Œé‚£å®ƒå°±æ˜¯ä¸€ä¸ªRootã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸŸ¨æ³¨æ„</p>
</blockquote>
<ul>
<li>å¦‚æœè¦ä½¿ç”¨å¯è¾¾æ€§åˆ†æç®—æ³•æ¥åˆ¤æ–­å†…å­˜æ˜¯å¦å¯å›æ”¶ï¼Œé‚£ä¹ˆåˆ†æå·¥ä½œå¿…é¡»åœ¨ä¸€ä¸ªèƒ½å¤Ÿä¿éšœä¸€è‡´æ€§çš„å¿«ç…§ä¸­è¿›è¡Œã€‚è¿™ç‚¹éƒ½ä¸æ»¡è¶³çš„è¯åˆ†æç»“æœçš„å‡†ç¡®æ€§å°±æ— æ³•ä¿è¯ã€‚</li>
<li>è¿™ç‚¹ä¹Ÿæ˜¯å¯¼è‡´GCè¿›è¡Œæ—¶å¿…é¡»â€Stop the worldâ€çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚å³ä½¿æ˜¯ï¼ˆå‡ ä¹ï¼‰ä¸ä¼šåœé¡¿çš„CMSæ”¶é›†å™¨ä¸­ï¼Œæšä¸¾æ ¹èŠ‚ç‚¹æ—¶ä¹Ÿæ˜¯å¿…é¡»è¦åœé¡¿çš„ã€‚</li>
</ul>
<h2 id="13-4-ğŸ-å¯¹è±¡çš„finalizationæœºåˆ¶"><a href="#13-4-ğŸ-å¯¹è±¡çš„finalizationæœºåˆ¶" class="headerlink" title="13.4 ğŸ å¯¹è±¡çš„finalizationæœºåˆ¶"></a>13.4 ğŸ å¯¹è±¡çš„finalizationæœºåˆ¶</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li><p>Javaè¯­è¨€æä¾›äº†å¯¹è±¡ç»ˆæ­¢ï¼ˆfinalizationï¼‰æœºåˆ¶æ¥å…è®¸å¼€å‘äººå‘˜æä¾›å¯¹è±¡è¢«é”€æ¯ä¹‹å‰çš„è‡ªå®šä¹‰å¤„ç†é€»è¾‘ã€‚</p>
</li>
<li><p>å½“åƒåœ¾å›æ”¶å™¨å‘ç°æ²¡æœ‰å¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå³ï¼šåƒåœ¾å›æ”¶æ­¤å¯¹è±¡ä¹‹å‰ï¼Œæ€»ä¼šå…ˆè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•ã€‚</p>
</li>
<li><p>finalize()æ–¹æ³•å…è®¸åœ¨å­ç±»ä¸­è¢«é‡å†™ï¼Œç”¨äºåœ¨å¯¹è±¡è¢«å›æ”¶æ—¶è¿›è¡Œèµ„æºé‡Šæ”¾ã€‚é€šå¸¸åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿›è¡Œä¸€äº›èµ„æºé‡Šæ”¾å’Œæ¸…ç†çš„å·¥ä½œï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶ã€å¥—æ¥å­—å’Œæ•°æ®åº“è¿æ¥ç­‰ã€‚</p>
</li>
<li><p>æ°¸è¿œä¸è¦ä¸»åŠ¨è°ƒç”¨æŸä¸ªå¯¹è±¡çš„finalize()æ–¹æ³•ï¼Œåº”è¯¥äº¤ç»™åƒåœ¾æœºåˆ¶è°ƒç”¨ã€‚ç†ç”±å¦‚ä¸‹ï¼š</p>
</li>
<li><ul>
<li>åœ¨finalize()æ—¶å¯èƒ½ä¼šå¯¼è‡´å¯¹è±¡å¤æ´»ã€‚</li>
<li>finalize()æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´æ˜¯æ²¡æœ‰ä¿éšœçš„ï¼Œå®ƒå®Œå…¨ç”±GCçº¿ç¨‹å†³å®šï¼Œæç«¯æƒ…å†µä¸‹ï¼Œè‹¥ä¸å‘ç”ŸGCï¼Œåˆ™finalize()æ–¹æ³•å°†æ²¡æœ‰æ‰§è¡Œæœºä¼šã€‚</li>
<li>ä¸€ä¸ªç³Ÿç³•çš„finalize()ä¼šä¸¥é‡å½±å“GCçš„æ€§èƒ½ã€‚</li>
</ul>
</li>
<li><p>ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼Œfinalize()æ–¹æ³•ä¸Cä¸­çš„ææ„å‡½æ•°æ¯”è¾ƒç›¸ä¼¼ï¼Œä½†æ˜¯Javaé‡‡ç”¨çš„æ˜¯åŸºäºåƒåœ¾å›æ”¶å™¨çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œæ‰€ä»¥finalize()æ–¹æ³•åœ¨æœ¬è´¨ä¸Šä¸ç”¨äºCä¸­çš„ææ„å‡½æ•°ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ¼çŠ¶æ€</p>
</blockquote>
<p>ç”±äºfinalize()æ–¹æ³•çš„å­˜åœ¨ï¼Œè™šæ‹Ÿæœºä¸­çš„å¯¹è±¡ä¸€èˆ¬å¤„äºä¸‰ç§å¯èƒ½çš„çŠ¶æ€ã€‚</p>
<p>å¦‚æœä»æ‰€æœ‰çš„æ ¹èŠ‚ç‚¹éƒ½æ— æ³•è®¿é—®åˆ°æŸä¸ªå¯¹è±¡ï¼Œè¯´æ˜å¯¹è±¡å·²ç»ä¸å†ä½¿ç”¨äº†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ­¤å¯¹è±¡éœ€è¦è¢«å›æ”¶ã€‚ä½†äº‹å®ä¸Šï¼Œä¹Ÿå¹¶éæ˜¯â€œéæ­»ä¸å¯â€çš„ï¼Œè¿™æ—¶å€™å®ƒä»¬æš‚æ—¶å¤„äºâ€œç¼“åˆ‘â€é˜¶æ®µã€‚ä¸€ä¸ªæ— æ³•è§¦åŠçš„å¯¹è±¡æœ‰å¯èƒ½åœ¨æŸä¸€ä¸ªæ¡ä»¶ä¸‹â€œå¤æ´»â€è‡ªå·±ï¼Œå¦‚æœè¿™æ ·ï¼Œé‚£ä¹ˆå¯¹å®ƒçš„å›æ”¶å°±æ˜¯ä¸åˆç†çš„ï¼Œä¸ºæ­¤ï¼Œå®šä¹‰è™šæ‹Ÿæœºä¸­çš„å¯¹è±¡å¯èƒ½çš„ä¸‰ç§çŠ¶æ€ã€‚</p>
<p>å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¯è§¦åŠçš„ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå¯ä»¥åˆ°è¾¾è¿™ä¸ªå¯¹è±¡ã€‚</li>
<li>å¯å¤æ´»çš„ï¼šå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨éƒ½è¢«é‡Šæ”¾ï¼Œä½†æ˜¯å¯¹è±¡æœ‰å¯èƒ½åœ¨finalize()ä¸­å¤æ´»ã€‚</li>
<li>ä¸å¯è§¦åŠçš„ï¼šå¯¹è±¡çš„finalize()è¢«è°ƒç”¨ï¼Œå¹¶ä¸”æ²¡æœ‰å¤æ´»ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥ä¸å¯è§¦åŠçŠ¶æ€ã€‚ä¸å¯è§¦åŠçš„å¯¹è±¡ä¸å¯èƒ½è¢«å¤æ´»ï¼Œå› ä¸ºfinalize()åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</li>
</ul>
<p>ä»¥ä¸Šä¸‰ç§çŠ¶æ€ä¸­ï¼Œæ˜¯ç”±äºfinalize()æ–¹æ³•çš„å­˜åœ¨ï¼Œè¿›è¡Œçš„åŒºåˆ†ã€‚åªæœ‰åœ¨å¯¹è±¡ä¸å¯è§¦åŠæ—¶æ‰å¯ä»¥è¢«å›æ”¶ã€‚</p>
<blockquote>
<p>â³æ‰§è¡Œè¿‡ç¨‹</p>
</blockquote>
<p>åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡objAæ˜¯å¦å¯å›æ”¶ï¼Œè‡³å°‘è¦ç»å†ä¸¤æ¬¡æ ‡è®°è¿‡ç¨‹ï¼š</p>
<ol>
<li><p>å¦‚æœå¯¹è±¡objAåˆ°GC Rootsæ²¡æœ‰å¼•ç”¨é“¾ï¼Œåˆ™è¿›è¡Œç¬¬ä¸€æ¬¡æ ‡è®°ã€‚</p>
</li>
<li><p>è¿›è¡Œç­›é€‰ï¼Œåˆ¤æ–­æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ï¼š</p>
</li>
<li><ol>
<li>å¦‚æœå¯¹è±¡objAæ²¡æœ‰é‡å†™finalize()æ–¹æ³•ï¼Œæˆ–è€…finalize()æ–¹æ³•å·²ç»è¢«è™šæ‹Ÿæœºè°ƒç”¨è¿‡ï¼Œåˆ™è™šæ‹Ÿæœºè§†ä¸ºâ€œæ²¡æœ‰å¿…è¦æ‰§è¡Œâ€ï¼ŒobjAè¢«åˆ¤å®šä¸ºä¸å¯è§¦åŠçš„ã€‚</li>
<li>å¦‚æœå¯¹è±¡objAé‡å†™äº†finalize()æ–¹æ³•ï¼Œä¸”è¿˜æœªæ‰§è¡Œè¿‡ï¼Œé‚£ä¹ˆobjAä¼šæ’å…¥åˆ°F-Queueé˜Ÿåˆ—ä¸­ï¼Œç”±ä¸€ä¸ªè™šæ‹Ÿæœºè‡ªåŠ¨åˆ›å»ºçš„ã€ä½ä¼˜å…ˆçº§çš„Finalizerçº¿ç¨‹è§¦å‘å…¶finalize()æ–¹æ³•æ‰§è¡Œã€‚</li>
<li>finalize()æ–¹æ³•æ˜¯å¯¹è±¡é€ƒè„±æ­»äº¡çš„æœ€åæœºä¼šï¼Œç¨åGCä¼šå¯¹F-Queueé˜Ÿåˆ—ä¸­çš„å¯¹è±¡è¿›è¡Œç¬¬äºŒæ¬¡æ ‡è®°ã€‚å¦‚æœobjAåœ¨finalize()æ–¹æ³•ä¸­ä¸å¼•ç”¨é“¾ä¸Šçš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹äº†è”ç³»ï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒæ¬¡æ ‡è®°æ—¶ï¼ŒobjAä¼šè¢«ç§»å‡ºâ€œå³å°†å›æ”¶â€é›†åˆã€‚ä¹‹åï¼Œå¯¹è±¡ä¼šå†æ¬¡å‡ºç°æ²¡æœ‰å¼•ç”¨å­˜åœ¨çš„æƒ…å†µã€‚åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œfinalizeæ–¹æ³•ä¸ä¼šè¢«å†æ¬¡è°ƒç”¨ï¼Œå¯¹è±¡ä¼šç›´æ¥ç¼–ç¨‹ä¸å¯è§¦åŠçš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªå¯¹è±¡çš„finalizeæ–¹æ³•åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚ã€åˆ€ä¸‹ç•™äººï¼Œåªæœ‰ä¸€æ¬¡ã€‚ã€‘</li>
</ol>
</li>
</ol>
<h2 id="13-5-ğŸ§°-MATçš„GC-Rootsæº¯æº"><a href="#13-5-ğŸ§°-MATçš„GC-Rootsæº¯æº" class="headerlink" title="13.5 ğŸ§° MATçš„GC Rootsæº¯æº"></a>13.5 ğŸ§° MATçš„GC Rootsæº¯æº</h2><blockquote>
<p>â¬‡ï¸ä¸‹è½½</p>
</blockquote>
<p>å®˜ç½‘ï¼š<a href="https://www.eclipse.org/mat/">https://www.eclipse.org/mat/</a></p>
<blockquote>
<p>ğŸ“°è·å–dumpæ–‡ä»¶</p>
</blockquote>
<p>åº”ç”¨ç¨‹åº -&gt; è¿›ç¨‹ -&gt; ç›‘è§† -&gt; å †dump -&gt; å³é”®ä¿å­˜</p>
<h2 id="13-6-ğŸ³â€ğŸŒˆ-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•"><a href="#13-6-ğŸ³â€ğŸŒˆ-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•" class="headerlink" title="13.6 ğŸ³â€ğŸŒˆ æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•"></a>13.6 ğŸ³â€ğŸŒˆ æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-æ¸…é™¤ç®—æ³•</h2><blockquote>
<p>ğŸŒƒèƒŒæ™¯</p>
</blockquote>
<p>æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark-Sweepï¼‰æ˜¯ä¸€ç§éå¸¸åŸºç¡€å’Œå¸¸è§çš„åƒåœ¾ç®—æ³•ï¼Œè¯¥ç®—æ³•è¢«J.McCarthyç­‰äººåœ¨1960å¹´æå‡ºå¹¶åº”ç”¨äºLispè¯­è¨€ã€‚</p>
<blockquote>
<p>â³æ‰§è¡Œè¿‡ç¨‹</p>
</blockquote>
<p>å½“å †ä¸­çš„æœ‰æ•ˆå†…å­˜ç©ºé—´ï¼ˆavailable memoryï¼‰ç­‰è¢«è€—å°½çš„æ—¶å€™ï¼Œå°±ä¼šåœæ­¢æ•´ä¸ªç¨‹åºï¼ˆä¹Ÿè¢«ç§°ä¸ºstop the worldï¼Œç®€ç§°STWï¼‰ï¼Œç„¶åè¿›è¡Œä¸¤é¡¹å·¥ä½œï¼Œç¬¬ä¸€é¡¹æ˜¯æ ‡è®°ï¼Œç¬¬äºŒé¡¹æ˜¯æ¸…é™¤ï¼š</p>
<ul>
<li>æ ‡è®°ï¼šCollectorä»å¼•ç”¨æ ¹èŠ‚ç‚¹å¼€å§‹éå†ï¼Œæ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼ˆéåƒåœ¾å¯¹è±¡ï¼‰ã€‚ä¸€èˆ¬æ˜¯åœ¨å¯¹è±¡çš„Headerä¸­è®°å½•ä¸ºå¯è¾¾å¯¹è±¡ã€‚</li>
<li>æ¸…é™¤ï¼šCollectorå¯¹å †å†…å­˜ä»å¤´åˆ°å°¾è¿›è¡Œçº¿æ€§çš„éå†ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡åœ¨å…¶Headerä¸­æ²¡æœ‰æ ‡è®°ä¸ºå¯è¾¾å¯¹è±¡ï¼Œåˆ™å°†å…¶å›æ”¶ã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ•ˆç‡ä¸å¤Ÿé«˜ã€‚</li>
<li>åœ¨è¿›è¡ŒGCçš„æ—¶å€™ï¼Œéœ€è¦åœæ­¢æ•´ä¸ªåº”ç”¨ï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒå·®ã€‚</li>
<li>è¿™ç§æ–¹å¼æ¸…ç†å‡ºæ¥çš„ç©ºé—²å†…å­˜æ˜¯ä¸è¿ç»­çš„ï¼Œäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚éœ€è¦ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨ã€‚</li>
</ul>
<h2 id="13-7-ğŸ”˜-æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•"><a href="#13-7-ğŸ”˜-æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•" class="headerlink" title="13.7 ğŸ”˜ æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•"></a>13.7 ğŸ”˜ æ¸…é™¤é˜¶æ®µï¼šå¤åˆ¶ç®—æ³•</h2><blockquote>
<p>ğŸŒƒèƒŒæ™¯</p>
</blockquote>
<p>ä¸ºäº†è§£å†³æ ‡è®°-æ¸…æ¥šç®—æ³•åœ¨åƒåœ¾æ•ˆç‡æ–¹é¢çš„ç¼ºé™·ï¼ŒM.L.Minskyäº1963å¹´å‘è¡¨äº†è‘—åçš„è®ºæ–‡ï¼Œâ€œä½¿ç”¨åŒå­˜å‚¨åŒºçš„Lispè¯­è¨€åƒåœ¾å™¨CALISP Garbage Collector Algorithm Using Serial Secondary Storageâ€ã€‚M.L.Minskyåœ¨è®ºæ–‡ä¸­æè¿°çš„ç®—æ³•è¢«äººä»¬ç§°ä¸ºå¤åˆ¶ç®—æ³•ï¼Œå®ƒä¹Ÿè¢«M.L.Minskyæœ¬äººæˆåŠŸåœ°å¼•å…¥åˆ°äº†Lispè¯­è¨€çš„ä¸€ä¸ªå®ç°ç‰ˆæœ¬ä¸­ã€‚</p>
<blockquote>
<p>ğŸ”°æ ¸å¿ƒæ€æƒ³</p>
</blockquote>
<p>å°†æ´»ç€çš„å†…å­˜ç©ºé—´åˆ†ä¸ºä¸¤å—ï¼Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­ä¸€å—ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶å°†æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æœªè¢«ä½¿ç”¨çš„å†…å­˜å—ä¸­ï¼Œä¹‹åæ¸…é™¤æ­£åœ¨ä½¿ç”¨çš„å†…å­˜å—ä¸­çš„æ‰€æœ‰å¯¹è±¡ï¼Œäº¤æ¢ä¸¤ä¸ªå†…å­˜çš„è§’è‰²ï¼Œæœ€åå®Œæˆåƒåœ¾å›æ”¶ã€‚</p>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ²¡æœ‰æ ‡è®°å’Œæ¸…é™¤è¿‡ç¨‹ï¼Œå®ç°ç®€å•ï¼Œè¿è¡Œé«˜æ•ˆã€‚</li>
<li>å¤åˆ¶è¿‡å»ä»¥åä¿è¯ç©ºé—´çš„è¿ç»­æ€§ï¼Œä¸ä¼šå‡ºç°â€œç¢ç‰‡â€é—®é¢˜ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>éœ€è¦ä¸¤å€çš„å†…å­˜ç©ºé—´ã€‚</li>
<li>å¯¹äºG1è¿™ç§åˆ†æ‹†æˆä¸ºå¤§é‡regiençš„GCï¼Œå¤åˆ¶è€Œä¸æ˜¯ç§»åŠ¨ï¼Œæ„å‘³ç€GCéœ€è¦ç»´æŠ¤regionä¹‹é—´å¯¹è±¡å¼•ç”¨å…³ç³»ï¼Œä¸ç®¡æ˜¯å†…å­˜å ç”¨æˆ–è€…æ—¶é—´å¼€é”€ä¹Ÿä¸å°ã€‚</li>
</ul>
<p>ç‰¹åˆ«ï¼š</p>
<ul>
<li>å¦‚æœç³»ç»Ÿä¸­çš„åƒåœ¾å¯¹è±¡å¾ˆå¤šï¼Œå¤åˆ¶ç®—æ³•éœ€è¦å¤åˆ¶çš„å­˜æ´»å¯¹è±¡æ•°é‡å¹¶ä¸ä¼šå¤ªå¤§ï¼Œæˆ–è€…è¯´éå¸¸ä½æ‰è¡Œã€‚ï¼ˆè€å¹´ä»£çš„å¯¹è±¡å­˜æ´»ï¼Œé‚£ä¹ˆå¤åˆ¶çš„å¯¹è±¡å°†ä¼šæœ‰å¾ˆå¤šï¼Œæ•ˆç‡ä¼šå¾ˆä½ã€‚é€‚åˆä½¿ç”¨åœ¨æ–°ç”Ÿä»£å’Œå¹¸å­˜è€…åŒºï¼Œæœç”Ÿå¤•æ­»ã€‚ï¼‰</li>
</ul>
<h2 id="13-8-â›”-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-å‹ç¼©ç®—æ³•"><a href="#13-8-â›”-æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-å‹ç¼©ç®—æ³•" class="headerlink" title="13.8 â›” æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-å‹ç¼©ç®—æ³•"></a>13.8 â›” æ¸…é™¤é˜¶æ®µï¼šæ ‡è®°-å‹ç¼©ç®—æ³•</h2><blockquote>
<p>ğŸŒƒèƒŒæ™¯</p>
</blockquote>
<p>å¤åˆ¶ç®—æ³•çš„é«˜æ•ˆæ€§æ˜¯å»ºç«‹åœ¨å­˜æ´»å¯¹è±¡å°‘ã€åƒåœ¾å¯¹è±¡å¤šçš„å‰æä¸‹ã€‚è¿™ç§æƒ…å†µåœ¨æ–°ç”Ÿä»£ç»å¸¸å‘ç”Ÿï¼Œä½†æ˜¯åœ¨è€å¹´ä»£ï¼Œæ›´å¸¸è§çš„æƒ…å†µæ˜¯å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯å­˜æ´»å¯¹è±¡ã€‚å¦‚æœä¾ç„¶ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œç”±äºå­˜æ´»å¯¹è±¡è¾ƒå¤šï¼Œå¤åˆ¶çš„æˆæœ¬ä¹Ÿå°†å¾ˆé«˜ã€‚å› æ­¤ï¼ŒåŸºäºè€å¹´ä»£åƒåœ¾å›æ”¶çš„ç‰¹æ€§ï¼Œéœ€è¦ä½¿ç”¨å…¶ä»–çš„ç®—æ³•ã€‚</p>
<p>æ ‡è®°-æ¸…é™¤ç®—æ³•çš„ç¡®å¯ä»¥åº”ç”¨åœ¨è€å¹´ä»£ä¸­ï¼Œä½†æ˜¯è¯¥ç®—æ³•ä¸ä»…æ‰§è¡Œæ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”åœ¨æ‰§è¡Œå®Œå†…å­˜å›æ”¶åè¿˜ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œæ‰€ä»¥JVMçš„è®¾è®¡è€…éœ€è¦åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ”¹é€ ã€‚æ ‡è®°-å‹ç¼©ç®—æ³•ï¼ˆMark-Compactï¼‰ç”±æ­¤è¯ç”Ÿã€‚</p>
<p>1970å¹´å‰åï¼ŒG.L.Steeleã€C.J.Cheneå’ŒD.D.Wiseç­‰ç ”ç©¶è€…å‘å¸ƒæ ‡è®°-å‹ç¼©ç®—æ³•ã€‚åœ¨è®¸å¤šç°ä»£çš„åƒåœ¾å™¨ä¸­ï¼Œäººä»¬éƒ½ä½¿ç”¨æ ‡è®°-å‹ç¼©ç®—æ³•æˆ–å…¶æ”¹è¿›ç‰ˆæœ¬ã€‚</p>
<blockquote>
<p>â³æ‰§è¡Œè¿‡ç¨‹</p>
</blockquote>
<p>ç¬¬ä¸€é˜¶æ®µï¼šå’Œæ ‡è®°æ¸…é™¤ç®—æ³•ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹ä¸€æ ·ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹æ ‡è®°æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚</p>
<p>ç¬¬äºŒé˜¶æ®µï¼šå°†æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å‹ç¼©åˆ°å†…å­˜çš„ä¸€ç«¯ï¼ŒæŒ‰é¡ºåºæ’æ”¾ã€‚</p>
<p>ä¹‹åï¼Œæ¸…ç†è¾¹ç•Œå¤–æ‰€æœ‰çš„ç©ºé—´ã€‚</p>
<blockquote>
<p>æ ‡è®°-å‹ç¼©ğŸ†šæ ‡è®°-æ¸…é™¤</p>
</blockquote>
<p>æ ‡è®°-å‹ç¼©ç®—æ³•çš„æœ€ç»ˆç»“æœç­‰åŒäºæ ‡è®°-æ¸…é™¤ç®—æ³•æ‰§è¡Œå®Œæˆåï¼Œå†è¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡æ•´ç†ï¼Œå› æ­¤ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒç§°ä¸ºæ ‡è®°-æ¸…é™¤-å‹ç¼©ï¼ˆMark-Sweep-Compactï¼‰ç®—æ³•ã€‚</p>
<p>äºŒè€…çš„æœ¬è´¨å·®å¼‚åœ¨äºæ ‡è®°-æ¸…é™¤ç®—æ³•æ˜¯ä¸€ç§éç§»åŠ¨å¼çš„å›æ”¶ç®—æ³•ï¼Œæ ‡è®°-å‹ç¼©æ˜¯ç§»åŠ¨å¼ã€‚æ˜¯å¦ç§»åŠ¨å›æ”¶åçš„å­˜æ´»å¯¹è±¡æ˜¯ä¸€é¡¹ä¼˜ç¼ºç‚¹å¹¶å­˜çš„é£é™©å†³ç­–ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ ‡è®°çš„å­˜æ´»å¯¹è±¡å°†ä¼šè¢«æ•´ç†ï¼ŒæŒ‰ç…§å†…å­˜åœ°å€ä¸€æ¬¡æ’åˆ—ï¼Œè€Œæœªè¢«æ ‡è®°çš„å†…å­˜å°†ä¼šè¢«æ¸…ç†æ‰ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå½“æˆ‘ä»¬éœ€è¦ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒJVMåªéœ€è¦ç»´æŒä¸€ä¸ªå†…å­˜çš„èµ·å§‹åœ°å€å³å¯ï¼Œè¿™æ¯”ç»´æŠ¤ä¸€ä¸ªç©ºé—²åˆ—è¡¨æ˜¾ç„¶å°‘äº†è®¸å¤šå¼€é”€ã€‚</p>
<blockquote>
<p>ğŸ’¥æŒ‡é’ˆç¢°æ’</p>
</blockquote>
<p>å¦‚æœå†…å­˜ç©ºé—´ä»¥è§„æ•´å’Œæœ‰åºçš„æ–¹å¼åˆ†å¸ƒï¼Œå³å·²ç”¨å’Œæœªç”¨çš„å†…å­˜éƒ½å„è‡ªä¸€è¾¹ï¼Œå½¼æ­¤ä¹‹é—´ç»´ç³»ç€ä¸€ä¸ªè®°å½•ä¸‹ä¸€æ¬¡åˆ†é…èµ·å§‹ç‚¹çš„æ ‡è®°æŒ‡é’ˆï¼Œå½“ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œåªéœ€è¦é€šè¿‡ä¿®æ”¹æŒ‡é’ˆçš„åç§»é‡å°†æ–°å¯¹åˆ†é…å­ç¬¬ä¸€ä¸ªç©ºé—²å†…å­˜ä½ç½®ä¸Šï¼Œè¿™ç§åˆ†é…æ–¹å¼å°±å«åšæŒ‡é’ˆç¢°æ’ï¼ˆBump the Pointerï¼‰ã€‚</p>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆé™¤äº†æ ‡è®°-æ¸…é™¤ç®—æ³•å½“ä¸­ï¼Œå†…å­˜åŒºåŸŸåˆ†æ•£çš„ç¼ºç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ç»™æ–°å¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼ŒJVMåªéœ€è¦æŒæœ‰ä¸€ä¸ªå†…å­˜çš„èµ·å§‹åœ°å€å³å¯ã€‚</li>
<li>æ¶ˆé™¤äº†å¤åˆ¶ç®—æ³•å½“ä¸­ï¼Œå†…å­˜å‡åŠçš„é«˜é¢ä»£ä»·ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä»æ•ˆç‡ä¸Šæ¥è¯´ï¼Œæ ‡è®°-æ•´ç†ç®—æ³•è¦ä½äºå¤åˆ¶ç®—æ³•ã€‚</li>
<li>ç§»åŠ¨å¯¹è±¡çš„åŒæ—¶ï¼Œå¦‚æœå¯¹è±¡è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œåˆ™è¿˜éœ€è¦è°ƒæ•´å¼•ç”¨çš„åœ°å€ã€‚</li>
<li>ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å…¨ç¨‹æš‚åœç”¨æˆ·åº”ç”¨ç¨‹åºï¼Œå³STWã€‚</li>
</ul>
<blockquote>
<p>ğŸ“‹å°ç»“</p>
</blockquote>
<table>
<thead>
<tr>
<th>é¡¹ç›®\ç®—æ³•</th>
<th>Mark-Sweep</th>
<th>Mark-Compact</th>
<th>Copying</th>
</tr>
</thead>
<tbody><tr>
<td>é€Ÿåº¦</td>
<td>ä¸­ç­‰</td>
<td>æœ€æ…¢</td>
<td>æœ€å¿«</td>
</tr>
<tr>
<td>ç©ºé—´å¼€é”€</td>
<td>å°‘ï¼ˆä¼šå †ç§¯ç¢ç‰‡ï¼‰</td>
<td>å°‘ï¼ˆä¸å †ç§¯ç¢ç‰‡ï¼‰</td>
<td>å¤§ï¼ˆä¸å †ç§¯ç¢ç‰‡ï¼‰</td>
</tr>
<tr>
<td>ç§»åŠ¨å¯¹è±¡</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
</tbody></table>
<h2 id="13-9-ğŸ§“ğŸ½-åˆ†ä»£ç®—æ³•"><a href="#13-9-ğŸ§“ğŸ½-åˆ†ä»£ç®—æ³•" class="headerlink" title="13.9 ğŸ§“ğŸ½ åˆ†ä»£ç®—æ³•"></a>13.9 ğŸ§“ğŸ½ åˆ†ä»£ç®—æ³•</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>ç›®å‰å‡ ä¹æ‰€æœ‰çš„GCéƒ½æ˜¯é‡‡ç”¨åˆ†ä»£ï¼ˆGenerational Collectingï¼‰ç®—æ³•æ‰§è¡Œåƒåœ¾å›æ”¶çš„ã€‚</p>
<p>åœ¨HotSpotä¸­ï¼ŒåŸºäºåˆ†ä»£çš„æ¦‚å¿µï¼ŒGCæ‰€ä½¿ç”¨çš„å†…å­˜å›æ”¶ç®—æ³•å¿…é¡»ç»“åˆå¹´è½»ä»£å’Œè€å¹´ä»£å„è‡ªçš„ç‰¹ç‚¹ã€‚</p>
<p>ä»¥HotSpotä¸­çš„CMSå›æ”¶å™¨ä¸ºä¾‹ï¼ŒCMSæ˜¯åŸºäºMark-Sweepå®ç°çš„ï¼Œå¯¹äºå¯¹è±¡çš„å›æ”¶æ•ˆç‡å¾ˆé«˜ã€‚è€Œå¯¹äºç¢ç‰‡é—®é¢˜ï¼ŒCMSé‡‡ç”¨åŸºäºMark-Compactç®—æ³•çš„Serial Oldå›æ”¶å™¨ä½œä¸ºè¡¥å¿æªæ–½ï¼šå½“å†…å­˜å›æ”¶ä¸ä½³ï¼ˆç¢ç‰‡å¯¼è‡´çš„Concurrent Mode Failureæ—¶ï¼‰ï¼Œå°†é‡‡ç”¨Serial Oldæ‰§è¡ŒFull GCä»¥è¾¾åˆ°å¯¹è€å¹´ä»£å†…å­˜çš„æ•´ç†ã€‚</p>
<p>åˆ†ä»£çš„æ€æƒ³è¢«ç°åœ¨çš„è™šæ‹Ÿæœºå¹¿æ³›ä½¿ç”¨ã€‚å‡ ä¹æ‰€æœ‰çš„åƒåœ¾å›æ”¶å™¨éƒ½åŒºåˆ†æ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚</p>
<blockquote>
<p>ğŸ‘¶å¯¹äºæ–°ç”Ÿä»£</p>
</blockquote>
<p>å¹´è½»ä»£ç‰¹ç‚¹ï¼šåŒºåŸŸç›¸å¯¹äºè€å¹´ä»£è¾ƒå°ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œå­˜æ´»ç‡ä½ï¼Œå›æ”¶é¢‘ç¹ã€‚</p>
<p>è¿™ç§æƒ…å†µå¤åˆ¶ç®—æ³•çš„å›æ”¶æ•´ç†ï¼Œé€Ÿåº¦æ˜¯æœ€å¿«çš„ã€‚å¤åˆ¶ç®—æ³•çš„æ•ˆç‡åªå’Œå½“å‰å­˜æ´»å¯¹è±¡å¤§å°æœ‰å…³ï¼Œå› æ­¤å¾ˆé€‚ç”¨äºå¹´è½»ä»£çš„å›æ”¶ã€‚è€Œå¤åˆ¶ç®—æ³•å†…å­˜åˆ©ç”¨ç‡ä¸é«˜çš„é—®é¢˜ï¼Œé€šè¿‡HotSpotä¸­çš„ä¸¤ä¸ªSuivivorçš„è®¾è®¡å¾—åˆ°ç¼“è§£ã€‚</p>
<blockquote>
<p>ğŸ‘µå¯¹äºè€å¹´ä»£</p>
</blockquote>
<p>è€å¹´ä»£ç‰¹ç‚¹ï¼šåŒºåŸŸè¾ƒå¤§ï¼Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸé•¿ã€å­˜æ´»ç‡é«˜ï¼Œå›æ”¶ä¸åŠå¹´è½»ä»£é¢‘ç¹ã€‚</p>
<p>è¿™ç§æƒ…å†µå­˜åœ¨å¤§é‡å­˜æ´»ç‡é«˜çš„å¯¹è±¡ï¼Œå¤åˆ¶ç®—æ³•æ˜æ˜¾å˜å¾—ä¸åˆé€‚ã€‚ä¸€èˆ¬æ˜¯ç”±æ ‡è®°-æ¸…é™¤æˆ–è€…æ˜¯æ ‡è®°-æ¸…é™¤ä¸æ ‡è®°-æ•´ç†çš„æ··åˆå®ç°ã€‚</p>
<p>ï¼ˆ1ï¼‰Marké˜¶æ®µçš„å¼€é”€ä¸å­˜æ´»å¯¹è±¡çš„æ•°é‡æˆæ­£æ¯”ã€‚</p>
<p>ï¼ˆ2ï¼‰Sweepé˜¶æ®µçš„å¼€é”€ä¸æ‰€ç®¡ç†åŒºåŸŸçš„å¤§å°æˆæ­£ç›¸å…³ã€‚</p>
<p>ï¼ˆ3ï¼‰Compacté˜¶æ®µçš„å¼€é”€ä¸å­˜è´§å¯¹è±¡çš„æ•°æ®æˆæ­£æ¯”ã€‚</p>
<h2 id="13-10-â™-å¢é‡ç®—æ³•"><a href="#13-10-â™-å¢é‡ç®—æ³•" class="headerlink" title="13.10 â™ å¢é‡ç®—æ³•"></a>13.10 â™ å¢é‡ç®—æ³•</h2><blockquote>
<p>ğŸŒƒèƒŒæ™¯</p>
</blockquote>
<p>ä¸Šè¿°ç°æœ‰çš„ç®—æ³•ï¼Œåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåº”ç”¨è½¯ä»¶å°†å¤„äºä¸€ç§Stop the Worldçš„çŠ¶æ€ã€‚åœ¨Stop the WorldçŠ¶æ€ä¸‹ï¼Œåº”ç”¨ç¨‹åºæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šæŒ‚èµ·ï¼Œæš‚åœä¸€åˆ‡æ­£å¸¸çš„å·¥ä½œï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆã€‚å¦‚æœåƒåœ¾å›æ”¶æ—¶é—´è¿‡é•¿ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«æŒ‚èµ·å¾ˆä¹…ï¼Œå°†ä¸¥é‡å½±å“åˆ°ç”¨æˆ·ä½“éªŒæˆ–è€…ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå³å¯¹å®æ—¶åƒåœ¾ç®—æ³•çš„ç ”ç©¶ç›´æ¥çš„ç ”ç©¶ç›´æ¥å¯¼è‡´äº†å¢é‡ï¼ˆIncremental Collectingï¼‰ç®—æ³•çš„è¯ç”Ÿã€‚</p>
<blockquote>
<p>ğŸ”°åŸºæœ¬æ€æƒ³</p>
</blockquote>
<p>å¦‚æœä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„åƒåœ¾è¿›è¡Œå¤„ç†ï¼Œéœ€è¦é€ æˆç³»ç»Ÿé•¿æ—¶é—´çš„åœé¡¿ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®©åƒåœ¾çº¿ç¨‹å’Œåº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚æ¯æ¬¡ï¼Œåƒåœ¾çº¿ç¨‹åªä¸€å°ç‰‡åŒºåŸŸçš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€åˆ‡æ¢åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹äº¤æ›¿æ‰§è¡Œã€‚æ¯æ¬¡ï¼Œåƒåœ¾çº¿ç¨‹åªä¸€å°ç‰‡åŒºåŸŸçš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€åˆ‡æ¢åˆ°åº”ç”¨ç¨‹åºçº¿ç¨‹ã€‚ä¾æ¬¡åå¤ï¼Œç›´åˆ°åƒåœ¾å®Œæˆã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼Œå¢é‡ç®—æ³•çš„åŸºç¡€ä»æ˜¯ä¼ ç»Ÿçš„æ ‡è®°-æ¸…é™¤å’Œå¤åˆ¶ç®—æ³•ã€‚å¢é‡ç®—æ³•é€šè¿‡å¯¹çº¿ç¨‹é—´å†²çªçš„å¦¥å–„å¤„ç†ï¼Œå…è®¸åƒåœ¾çº¿ç¨‹ä»¥åˆ†é˜¶æ®µçš„æ–¹å¼å®Œæˆæ ‡è®°ã€æ¸…ç†æˆ–å¤åˆ¶å·¥ä½œã€‚</p>
<blockquote>
<p>ğŸ“›ç¼ºç‚¹</p>
</blockquote>
<p>ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œç”±äºåœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œé—´æ–­æ€§åœ°è¿˜æ‰§è¡Œäº†åº”ç”¨ç¨‹åºä»£ç ï¼Œæ‰€ä»¥èƒ½å‡å°‘ç³»ç»Ÿçš„åœé¡¿æ—¶é—´ã€‚ä½†æ˜¯ï¼Œå› ä¸ºçº¿ç¨‹åˆ‡æ¢å’Œä¸Šä¸‹æ–‡çš„æ¶ˆè€—ï¼Œä¼šä½¿å¾—åƒåœ¾å›æ”¶çš„æ€»ä½“æˆæœ¬ä¸Šå‡ï¼Œé€ æˆç³»ç»Ÿååé‡çš„ä¸‹é™ã€‚</p>
<h2 id="13-11-ğŸ’ -åˆ†åŒºç®—æ³•"><a href="#13-11-ğŸ’ -åˆ†åŒºç®—æ³•" class="headerlink" title="13.11 ğŸ’  åˆ†åŒºç®—æ³•"></a>13.11 ğŸ’  åˆ†åŒºç®—æ³•</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ç›¸åŒæ¡ä»¶ä¸‹ï¼Œå †ç©ºé—´è¶Šå¤§ï¼Œä¸€æ¬¡GCæ—¶æ‰€éœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ï¼Œæœ‰å…³GCäº§ç”Ÿçš„åœé¡¿ä¹Ÿå°±è¶Šé•¿ã€‚ä¸ºäº†æ›´å¥½åœ°æ§åˆ¶GCäº§ç”Ÿçš„åœé¡¿æ—¶é—´ï¼Œå°†ä¸€å—å¤§çš„å†…å­˜åŒºåŸŸåˆ†å‰²æˆå¤šä¸ªå°å—ï¼Œæ ¹æ®ç›®æ ‡çš„åœé¡¿æ—¶é—´ï¼Œæ¯æ¬¡åˆç†åœ°å›æ”¶è‹¥å¹²ä¸ªå°åŒºé—´ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå †ç©ºé—´ï¼Œä»è€Œå‡å°‘ä¸€æ¬¡GCæ‰€äº§ç”Ÿçš„åœé¡¿ã€‚</p>
<p>åˆ†ä»£ç®—æ³•å°†æŒ‰ç…§å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸé•¿çŸ­åˆ’åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åŒºç®—æ³•æ•´ä¸ªå †ç©ºé—´åˆ’åˆ†æˆè¿ç»­çš„ä¸åŒå°åŒºé—´ã€‚</p>
<p>æ¯ä¸€ä¸ªå°åŒºé—´éƒ½ç‹¬ç«‹ä½¿ç”¨ï¼Œç‹¬ç«‹å›æ”¶ã€‚è¿™ç§ç®—æ³•çš„å¥½å¤„æ˜¯å¯ä»¥æ§åˆ¶ä¸€æ¬¡å›æ”¶å¤šå°‘ä¸ªå°åŒºé—´ã€‚</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-12(String Table)</title>
    <url>/posts/59786/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="12-1-ğŸ“–-æ¦‚è¿°"><a href="#12-1-ğŸ“–-æ¦‚è¿°" class="headerlink" title="12.1 ğŸ“– æ¦‚è¿°"></a>12.1 ğŸ“– æ¦‚è¿°</h2><blockquote>
<p>ğŸŒ åŸºæœ¬ç‰¹æ€§</p>
</blockquote>
<ul>
<li>Stringå­—ç¬¦ä¸²ä½¿ç”¨ä¸€å¯¹â€â€å¼•èµ·æ¥è¡¨ç¤ºã€‚</li>
<li>Stringå£°æ˜ä¸ºfinalï¼Œä¸å¯è¢«ç»§æ‰¿ã€‚</li>
<li>Stringå®ç°äº†Serializableæ¥å£ï¼šè¡¨ç¤ºå­—ç¬¦ä¸²æ˜¯æ”¯æŒåºåˆ—åŒ–çš„ã€‚</li>
<li>Stringå®ç°äº†Comparableæ¥å£ï¼Œè¡¨ç¤ºStringå¯ä»¥æ¯”è¾ƒå¤§å°ã€‚</li>
<li>Stringåœ¨jdk8åŠä»¥å‰å†…éƒ¨å®šä¹‰äº†final char[] valueç”¨äºå­˜å‚¨å­—ç¬¦ä¸²æ•°æ®ã€‚jdk9æ—¶æ”¹ä¸ºbyte[]</li>
</ul>
<blockquote>
<p>â”Stringå­˜å‚¨ç»“æ„å˜æ›´çš„åŸå› </p>
</blockquote>
<p>JDK8åŠä»¥å‰ä¸­Stringç±»çš„å®ç°å°†å­—ç¬¦å­˜å‚¨åœ¨charæ•°ç»„ä¸­ï¼Œæ¯ä¸ªå­—ç¬¦å ç”¨ä¸¤ä¸ªå­—èŠ‚ã€‚ä»è®¸å¤šä¸åŒçš„åº”ç”¨ç¨‹åºæ”¶é›†çš„æ•°æ®è¡¨æ˜ï¼Œå­—ç¬¦ä¸²æ˜¯å †ä½¿ç”¨çš„ä¸»è¦ç»„æˆéƒ¨åˆ†ï¼Œè€Œä¸”ï¼Œå¤§å¤šæ•°å­—ç¬¦ä¸²å¯¹è±¡åªåŒ…å«æ‹‰ä¸å­—ç¬¦ã€‚è¿™äº›å­—ç¬¦åªéœ€è¦ä¸€ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼Œå› æ­¤è¿™äº›å­—ç¬¦ä¸²å¯¹è±¡çš„å†…éƒ¨charæ•°ç»„ä¸­æœ‰ä¸€åŠçš„ç©ºé—´å°†ä¸ä¼šä½¿ç”¨ã€‚</p>
<p>JDK9å°†Stringå†…éƒ¨è¡¨ç¤ºä»UTF-16çš„charæ•°ç»„æ”¹ä¸ºbyteæ•°ç»„+ç¼–ç æ ‡å¿—å­—æ®µã€‚æ–°çš„Stringç±»å°†æ ¹æ®å­—ç¬¦ä¸²çš„å†…å®¹å­˜å‚¨ç¼–ç ä¸ºISO-8859-1/Latin-1(æ¯ä¸ªå­—ç¬¦ä¸€ä¸ªå­—èŠ‚)æˆ–UTF-16(æ¯ä¸ªå­—ç¬¦ä¸¤ä¸ªå­—èŠ‚)çš„å­—ç¬¦ã€‚ç¼–ç æ ‡å¿—å°†æŒ‡ç¤ºä½¿ç”¨å“ªç§ç¼–ç ã€‚</p>
<p>æ€»ç»“ï¼šStringç”±char[]+UTF-16æ”¹ä¸ºbyte[]+encoding-flagï¼ŒèŠ‚çº¦äº†ä¸€äº›ç©ºé—´ã€‚</p>
<blockquote>
<p>ğŸ”˜ä¸å¯å˜æ€§</p>
</blockquote>
<ul>
<li>å½“å¯¹å­—ç¬¦ä¸²é‡æ–°èµ‹å€¼æ—¶ï¼Œéœ€è¦é‡å†™æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚</li>
<li>å½“å¯¹ç°æœ‰çš„å­—ç¬¦ä¸²è¿›è¡Œè¿æ¥æ“ä½œæ—¶ï¼Œä¹Ÿéœ€è¦é‡æ–°æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚</li>
<li>å½“è°ƒç”¨Stringçš„replace()æ–¹æ³•ä¿®æ”¹æŒ‡å®šå­—ç¬¦æˆ–å­—ç¬¦ä¸²æ—¶ï¼Œä¹Ÿéœ€è¦é‡æ–°æŒ‡å®šå†…å­˜åŒºåŸŸèµ‹å€¼ï¼Œä¸èƒ½ä½¿ç”¨åŸæœ‰çš„valueè¿›è¡Œèµ‹å€¼ã€‚</li>
<li>é€šè¿‡å­—é¢é‡çš„æ–¹å¼ï¼ˆåŒºåˆ«äºnewï¼‰ç»™ä¸€ä¸ªå­—ç¬¦ä¸²èµ‹å€¼ï¼Œæ­¤æ—¶çš„å­—ç¬¦ä¸²å£°æ˜åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚</li>
</ul>
<blockquote>
<p>ğŸ‘â€ğŸ—¨å­—ç¬¦ä¸²å¸¸é‡æ± </p>
</blockquote>
<p>å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯ä¸ä¼šå­˜å‚¨ç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²çš„ã€‚</p>
<ul>
<li>Stringçš„String Poolæ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„HashTableï¼Œé»˜è®¤å€¼å¤§å°é•¿åº¦æ˜¯1009ã€‚å¦‚æœæ”¾è¿›String Poolçš„Stringéå¸¸å¤šï¼Œå°±ä¼šé€ æˆHashå†²çªä¸¥é‡ï¼Œä»è€Œå¯¼è‡´é“¾è¡¨ä¼šå¾ˆé•¿ï¼Œè€Œé“¾è¡¨é•¿äº†åç›´æ¥ä¼šé€ æˆçš„å½±å“å°±æ˜¯å½“è°ƒç”¨String.internæ—¶æ€§èƒ½ä¼šå¤§å¹…ä¸‹é™ã€‚</li>
<li>ä½¿ç”¨-XX:StringTableSizeå¯è®¾ç½®StringTableçš„é•¿åº¦</li>
<li>åœ¨JDK6ä¸­StringTableæ˜¯å›ºå®šçš„ã€‚å°±æ˜¯1009çš„é•¿åº¦ï¼Œæ‰€ä»¥å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²è¿‡å¤šå°±ä¼šå¯¼è‡´æ•ˆç‡ä¸‹é™å¾ˆå¿«ã€‚StringTableSizeè®¾ç½®æ²¡æœ‰è¦æ±‚ã€‚</li>
<li>åœ¨JDK7ä¸­ï¼ŒStringTableçš„é•¿åº¦é»˜è®¤å€¼æ˜¯60013ã€‚</li>
<li>JDK8å¼€å§‹ï¼Œè®¾ç½®StringTableçš„é•¿åº¦çš„è¯ï¼Œ1009æ˜¯å¯è®¾ç½®çš„æœ€å°å€¼ã€‚</li>
</ul>
<h2 id="12-2-ğŸŒŒ-å†…å­˜åˆ†é…"><a href="#12-2-ğŸŒŒ-å†…å­˜åˆ†é…" class="headerlink" title="12.2 ğŸŒŒ å†…å­˜åˆ†é…"></a>12.2 ğŸŒŒ å†…å­˜åˆ†é…</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>åœ¨Javaè¯­è¨€ä¸­æœ‰8ä¸­åŸºæœ¬æ•°æ®ç±»å‹å’Œä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹Stringã€‚è¿™äº›ç±»å‹ä¸ºäº†ä½¿å®ƒä»¬åœ¨è¿è¡Œè¿‡ç¨‹ä¸­é€Ÿåº¦æ›´å¿«ã€æ›´èŠ‚çœå†…å­˜ï¼Œéƒ½æä¾›äº†ä¸€ç§å¸¸é‡æ± çš„æ¦‚å¿µã€‚</li>
<li>å¸¸é‡æ± å°±ç±»ä¼¼ä¸€ä¸ªJavaç³»ç»Ÿçº§åˆ«æä¾›çš„ç¼“å­˜ã€‚8ç§åŸºæœ¬æ•°æ®ç±»å‹çš„å¸¸é‡æ± éƒ½æ˜¯ç³»ç»Ÿåè°ƒçš„ï¼ŒStringç±»å‹çš„å¸¸é‡æ± æ¯”è¾ƒç‰¹æ®Šã€‚å®ƒçš„ä¸»è¦ä½¿ç”¨æ–¹æ³•æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯ä½¿ç”¨<strong>å­—é¢é‡å£°æ˜</strong>ï¼Œå¦ä¸€ç§æ˜¯ä½¿ç”¨<strong>String.intern()æ–¹æ³•</strong>ã€‚</li>
<li>åœ¨JDK6åŠä»¥å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å­˜æ”¾åœ¨æ°¸ä¹…ä»£(PermGen)ã€‚</li>
<li>Java7ä¸­Oracleçš„å·¥ç¨‹å¸ˆå¯¹å­—ç¬¦ä¸²æ± çš„é€»è¾‘åšäº†å¾ˆå¤šçš„æ”¹å˜ï¼Œå³å°†å­—ç¬¦ä¸²å¸¸é‡æ± çš„ä½ç½®è°ƒæ•´åˆ°Javaå †å†…ã€‚<ul>
<li>æ‰€æœ‰çš„å­—ç¬¦ä¸²éƒ½ä¿å­˜åœ¨å †ï¼ˆHeapï¼‰ä¸­ï¼Œå’Œå…¶ä»–æ™®é€šå¯¹è±¡ä¸€æ ·ï¼Œè¿™æ ·å¯ä»¥è®©ä½ åœ¨è¿›è¡Œè°ƒä¼˜åº”ç”¨æ—¶ä»…éœ€è¦è°ƒæ•´å †å¤§å°å°±å¯ä»¥äº†ã€‚</li>
<li>å­—ç¬¦ä¸²å¸¸é‡æ± æ¦‚å¿µåŸæœ¬ä½¿ç”¨å¾—æ¯”è¾ƒå¤šï¼Œä½†æ˜¯è¿™ä¸ªæ”¹åŠ¨ä½¿å¾—æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„ç†ç”±è®©æˆ‘ä»¬é‡æ–°è€ƒè™‘åœ¨Java 7ä¸­ä½¿ç”¨String.intern()ã€‚</li>
</ul>
</li>
<li>Java8å…ƒç©ºé—´ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± åœ¨å †ã€‚</li>
</ul>
<blockquote>
<p>â”StringTableè°ƒæ•´å†…å­˜ä½ç½®çš„åŸå› </p>
</blockquote>
<ul>
<li>PermSizeé»˜è®¤æ¯”è¾ƒå°</li>
<li>æ°¸ä¹…ä»£åƒåœ¾å›æ”¶é¢‘ç‡ä½</li>
</ul>
<h2 id="12-3-ğŸ› ï¸-å­—ç¬¦ä¸²æ“ä½œ"><a href="#12-3-ğŸ› ï¸-å­—ç¬¦ä¸²æ“ä½œ" class="headerlink" title="12.3 ğŸ› ï¸ å­—ç¬¦ä¸²æ“ä½œ"></a>12.3 ğŸ› ï¸ å­—ç¬¦ä¸²æ“ä½œ</h2><blockquote>
<p>ğŸ—ï¸å­—ç¬¦ä¸²æ‹¼æ¥</p>
</blockquote>
<ul>
<li>å¸¸é‡ä¸å¸¸é‡çš„æ‹¼æ¥ç»“æœåœ¨å¸¸é‡æ± ï¼Œå¸¸é‡æ‹¼æ¥çš„åŸç†æ˜¯ç¼–è¯‘æœŸä¼˜åŒ–ã€‚</li>
<li>å¸¸é‡æ± ä¸­ä¸ä¼šå­˜åœ¨ç›¸åŒå†…å®¹çš„å¸¸é‡ã€‚</li>
<li>åªè¦æœ‰ä¸€ä¸ªæ˜¯å˜é‡ï¼Œç»“æœå°±åœ¨å †ä¸­ã€‚å˜é‡æ‹¼æ¥çš„åŸç†æ˜¯StringBuilderã€‚</li>
<li>å¦‚æœæ‹¼æ¥çš„ç»“æœæ˜¯è°ƒç”¨intern()æ–¹æ³•ï¼Œåˆ™ä¸»åŠ¨å°†å¸¸é‡æ± ä¸­è¿˜æ²¡æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥æ± ä¸­ï¼Œå¹¶è¿”å›æ­¤å¯¹è±¡åœ°å€ã€‚</li>
</ul>
<blockquote>
<p>ğŸ”æŸ¥çœ‹åº•å±‚</p>
</blockquote>
<p>Javaä»£ç ï¼š</p>
<pre><code class="java">@Test
void test5() &#123;
    String s1 = &quot;a&quot;;
    String s2 = &quot;b&quot;;
    String s3 = &quot;ab&quot;;             // å­—ç¬¦ä¸²å¸¸é‡æ± 
    String s4 = s1 + s2;          // å †ç©ºé—´
    System.out.println(s3 == s4); // false
&#125;</code></pre>
<p>åç¼–è¯‘ï¼š</p>
<pre><code> 0 ldc #3 &lt;a&gt;  // å°†aä»è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å‹å…¥æ“ä½œæ•°æ ˆ
 2 astore_1    // å°†aå­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®
 3 ldc #17 &lt;b&gt; // å°†bä»è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å‹å…¥æ“ä½œæ•°æ ˆ
 5 astore_2    // å°†bå­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½®
 6 ldc #18 &lt;ab&gt;// å°†abä»è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å‹å…¥æ“ä½œæ•°æ ˆ
 8 astore_3    // å°†abå­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º3çš„ä½ç½®
 9 new #19 &lt;java/lang/StringBuilder&gt; // newä¸€ä¸ªStringBuilder
12 dup         // å¤åˆ¶æ“ä½œæ“ä½œæ•°æ ˆé¡¶çš„StringBuilderçš„å¼•ç”¨
13 invokespecial #20 &lt;java/lang/StringBuilder.&lt;init&gt;&gt; // è°ƒç”¨StringBuilderçš„åˆå§‹åŒ–æ–¹æ³•
16 aload_1     // ä»å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®è£…è½½ä¸€ä¸ªå¯¹è±¡å¼•ç”¨(a)åˆ°æ“ä½œæ•°æ ˆé¡¶
17 invokevirtual #21 &lt;java/lang/StringBuilder.append&gt; // è°ƒç”¨StringBuilderçš„appendæ–¹æ³•ï¼Œè¿æ¥a
20 aload_2     // ä»å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½®è£…è½½ä¸€ä¸ªå¯¹è±¡å¼•ç”¨(b)åˆ°æ“ä½œæ•°æ ˆé¡¶
21 invokevirtual #21 &lt;java/lang/StringBuilder.append&gt; // è°ƒç”¨StringBuilderçš„appendæ–¹æ³•ï¼Œè¿æ¥b
24 invokevirtual #22 &lt;java/lang/StringBuilder.toString&gt; // è°ƒç”¨StringBuilderçš„toStringæ–¹æ³•ï¼Œå°†è¯¥å­—ç¬¦ä¸²æ”¾åœ¨å †ä¸­ï¼Œå¼•ç”¨æ”¾åœ¨æ“ä½œæ•°æ ˆä¸­
27 astore 4    // å°†abå­˜æ”¾åœ¨å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º4çš„ä½ç½®
---</code></pre>
<p>å­—ç¬¦ä¸²æ‹¼æ¥ï¼ŒJDK5.0ä¹‹å‰ä½¿ç”¨çš„æ˜¯StringBufferï¼ŒJDK5.0ä¹‹åä½¿ç”¨çš„æ˜¯StringBuilderã€‚</p>
<p>å…³é”®å°±åœ¨äº<code>toString()</code>æ–¹æ³•ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æºä»£ç ï¼š</p>
<pre><code class="java">// StringBuilder
@Override
public String toString() &#123;
    // Create a copy, don&#39;t share the array
    return new String(value, 0, count);
&#125;

// StringBuffer
@Override
public synchronized String toString() &#123;
    if (toStringCache == null) &#123;
        toStringCache = Arrays.copyOfRange(value, 0, count);
    &#125;
    return new String(toStringCache, true);
&#125;</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªæ–¹æ³•ä¸­å‡é‡‡ç”¨äº†<code>new String()</code>çš„æ–¹æ³•ã€‚å› æ­¤å¯¹äºéå­—é¢é‡çš„æ‹¼æ¥æ“ä½œï¼Œéƒ½åœ¨å †ä¸­newäº†ä¸€ä¸ªStringå¯¹è±¡ã€‚</p>
<blockquote>
<p>âŒ¨ï¸ ==æµ‹è¯•</p>
</blockquote>
<pre><code class="java">@Test
void test4() &#123;
    String s1 = &quot;a&quot; + &quot;b&quot; + &quot;c&quot;;         // ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œæ‹¼æ¥ç»“æœå­˜æ”¾åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­
    String s2 = &quot;abc&quot;;                   // å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ä¸å­˜æ”¾ç›¸åŒçš„å­—ç¬¦ä¸²
    System.out.println(s1 ==s2);         // true
    System.out.println(s1.equals(s2));   // true
&#125;

@Test
void test5() &#123;
    String s1 = &quot;a&quot;;
    String s2 = &quot;b&quot;;
    String s3 = &quot;ab&quot;;
    String s4 = s1 + s2;
    System.out.println(s3 == s4);        // false
&#125;

@Test
void test6() &#123;
    String s1 = &quot;boot&quot;;
    String s2 = &quot;cloud&quot;;
    String s3 = &quot;boot&quot; + &quot;cloud&quot;;        // å­—ç¬¦ä¸²æ‹¼æ¥ç»“æœæ”¾åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­
    String s4 = s1 + &quot;cloud&quot;;            // å¸¦å˜é‡çš„æ‹¼æ¥ç»“æœæ”¾åœ¨å †ä¸­
    String s5 = &quot;boot&quot; + s2;             // å¸¦å˜é‡çš„æ‹¼æ¥ç»“æœæ”¾åœ¨å †ä¸­
    String s6 = s1 + s2;                 // å¸¦å˜é‡çš„æ‹¼æ¥ç»“æœæ”¾åœ¨å †ä¸­
    System.out.println(s3 == s4);        // flase
    System.out.println(s3 == s5);        // flase
    System.out.println(s3 == s6);        // flase
    System.out.println(s4 == s5);        // flase
    // intern(): åˆ¤æ–­å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ˜¯å¦å­˜åœ¨&quot;bootcloud&quot;å€¼
    // å¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­&quot;bootcloud&quot;çš„åœ°å€ï¼›
    // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æ·»åŠ ä¸€æ¬¡&quot;bootcloud&quot;ï¼Œå¹¶è¿”å›æ­¤å¯¹è±¡çš„åœ°å€
    String s7 = s5.intern();
    System.out.println(s3 == s7);        // true
&#125;

@Test
void test7() &#123;
    final String s1 = &quot;c&quot;;               // å¸¸é‡
    final String s2 = &quot;d&quot;;               // å¸¸é‡
    String s3 = &quot;cd&quot;; 
    String s4 = s1 + s2;                 // æ‹¼æ¥ç¬¦åˆå·¦å³ä¸¤è¾¹éƒ½æ˜¯å­—ç¬¦ä¸²å¸¸é‡æˆ–è€…å¸¸é‡å¼•ç”¨ï¼Œä»ç„¶ä½¿ç”¨ç¼–è¯‘æœŸä¼˜åŒ–
    System.out.println(s3 == s4);        // true
&#125;</code></pre>
<blockquote>
<p>âŒ¨ï¸æ•ˆç‡æµ‹è¯•</p>
</blockquote>
<pre><code class="java">public class StringAppendTest &#123;

    @Test
    void test1() &#123;
        String str = &quot;&quot;;
        long start = System.currentTimeMillis();
        for (int i = 0; i &lt; 100000; i++) &#123;
            str = str + &quot;k&quot;;
        &#125;
        long end = System.currentTimeMillis();
        System.out.println(&quot;Stringæ‹¼æ¥èŠ±è´¹æ—¶é—´ï¼š&quot; + (end - start) + &quot;ms&quot;); // 3935ms
    &#125;

    @Test
    void test2() &#123;
        StringBuilder sb = new StringBuilder(100000);
        long start = System.currentTimeMillis();
        for (int i = 0; i &lt; 100000; i++) &#123;
            sb.append(&quot;k&quot;);
        &#125;
        long end = System.currentTimeMillis();
        System.out.println(&quot;StringBuilderæ‹¼æ¥èŠ±è´¹æ—¶é—´ï¼š&quot; + (end - start) + &quot;ms&quot;); // 3ms
    &#125;
&#125;
</code></pre>
<p>æ•ˆç‡ï¼š</p>
<p>StringBuilderçš„appendAPI &gt;&gt; Stringçš„å­—ç¬¦ä¸²æ‹¼æ¥ </p>
<p>åŸå› ï¼š</p>
<p>(1) StringBuilderæ–¹å¼è‡ªå§‹è‡³ç»ˆåªåˆ›å»ºä¸€ä¸ªStringBuilderå¯¹è±¡ï¼ŒStringæ‹¼æ¥ä¼šåˆ›å»ºå¤šä¸ªStringBuilderå¯¹è±¡ã€‚</p>
<p>(2) ä½¿ç”¨Stringå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå†…å­˜ä¸­ç”±äºåˆ›å»ºäº†å¤šä¸ªStringBuilderå’ŒStringå¯¹è±¡,ä¼šå¢åŠ GCçš„é¢‘ç‡ï¼Œå½±å“æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p>æ”¹è¿›ï¼š</p>
<p>StringBuilderæ— å‚åˆ›å»ºçš„æ•°ç»„ç©ºé—´æ˜¯16ï¼Œå¦‚æœå®é™…å¼€å‘ä¸­é•¿åº¦å¤§äº16ï¼Œåˆ™éœ€è¦ä¸æ–­è¿›è¡Œæ•°ç»„æ‰©å®¹ã€‚</p>
<p>å¦‚æœæ˜ç¡®æ‹¼æ¥åçš„å­—ç¬¦ä¸²é•¿åº¦ä¸é«˜äºæŸä¸ªé™å®šå€¼highLevelï¼Œåœ¨å®šä¹‰StringBuilderçš„æ—¶å€™å³å¯èµ‹äºˆå“åº”ç©ºé—´ï¼Œå³<code>new StringBuilder[highLevel]</code>ã€‚</p>
<blockquote>
<p>ğŸ’¡intern()æ–¹æ³•</p>
</blockquote>
<p>ç¾å›¢æŠ€æœ¯å›¢é˜Ÿæ²™é¾™-internï¼š<a href="https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html">https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html</a></p>
<p>internæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œè°ƒç”¨çš„æ˜¯åº•å±‚Cè¯­è¨€å®ç°çš„æ–¹æ³•ã€‚</p>
<p>JDK1.8çš„APIè¯´æ˜ï¼šå­—ç¬¦ä¸²æ± æœ€åˆæ˜¯ç©ºçš„ï¼Œç”±Stringç±»ç§æœ‰åœ°ç»´æŠ¤ã€‚åœ¨ç»´æŠ¤internæ–¹æ³•æ—¶ï¼Œå¦‚æœæ± ä¸­å·²ç»åŒ…å«äº†ç”±equals(object)æ–¹æ³•ç¡®å®šçš„ä¸è¯¥å­—ç¬¦ä¸²å¯¹è±¡ç›¸ç­‰çš„å­—ç¬¦ä¸²ï¼Œåˆ™è¿”å›æ± ä¸­çš„å­—ç¬¦ä¸²ã€‚å¦åˆ™ï¼Œè¯¥<strong>å­—ç¬¦ä¸²å¯¹è±¡</strong>å°†è¢«æ·»åŠ åˆ°æ± ä¸­ï¼Œå¹¶è¿”å›å¯¹è¯¥<strong>å­—ç¬¦ä¸²å¯¹è±¡çš„å¼•ç”¨</strong>ã€‚å¦‚æœä¸æ˜¯ç”¨åŒå¼•å·å£°æ˜çš„stringå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨stringæä¾›çš„internæ–¹æ³•ï¼šinternæ–¹æ³•ä¼šä»å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­æŸ¥è¯¢å½“å‰å­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å°±ä¼šå°†å½“å‰å­—ç¬¦ä¸²æ”¾å…¥å¸¸é‡æ± ä¸­ã€‚</p>
<p>åœ¨JDK1.6ä¸­ï¼ŒString.intern()æ–¹æ³•å°è¯•å°†å­—ç¬¦ä¸²æ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¼šæŠŠæ­¤å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œæ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¯¹è±¡åœ°å€ã€‚</p>
<p>è‡ªJDK1.7èµ·ï¼ŒString.intern()æ–¹æ³•å°è¯•å°†å­—ç¬¦ä¸²æ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¼šæŠŠæ­¤å¯¹è±¡çš„å¼•ç”¨åœ°å€å¤åˆ¶ä¸€ä»½ï¼Œæ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­çš„å¼•ç”¨åœ°å€ã€‚</p>
<p>è‡³äºæ›´æ”¹åŸå› ï¼Œä¹Ÿä¸å¿…å¤šè¯´äº†ï¼Œä¹‹å‰æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡æ”¾åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œç°åœ¨æ˜¯å­˜æ”¾ä¸€ä¸ªå †ç©ºé—´ä¸­çš„å¼•ç”¨ï¼Œå½“ç„¶æ›´åŠ èŠ‚çœç©ºé—´ã€‚</p>
<p>å¯¹äºéœ€è¦å¤§é‡ä½¿ç”¨ç›¸åŒå­—ç¬¦ä¸²çš„ç½‘ç«™å¹³å°ï¼Œå»ºè®®ä½¿ç”¨internä¿å­˜åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ï¼Œä»¥èŠ‚çœå†…å­˜ç©ºé—´ã€‚</p>
<h2 id="12-4-â“-é¢è¯•é¢˜"><a href="#12-4-â“-é¢è¯•é¢˜" class="headerlink" title="12.4 â“ é¢è¯•é¢˜"></a>12.4 â“ é¢è¯•é¢˜</h2><blockquote>
<p>1ï¸âƒ£ new String(â€œabâ€) ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿ</p>
<p>new String(â€œaâ€) + new String(â€œbâ€)ä¼šåˆ›å»ºå‡ ä¸ªå¯¹è±¡ï¼Ÿ</p>
</blockquote>
<p>å‰è€…åˆ›å»ºäº†ä¸¤ä¸ªå¯¹è±¡ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªæ˜¯new å…³é”®å­—åœ¨å †ç©ºé—´åˆ›å»ºçš„å¯¹è±¡</li>
<li>ç¬¬äºŒä¸ªæ˜¯åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»ºçš„å­—ç¬¦ä¸²çš„å¼•ç”¨ï¼ˆæŒ‡å‘å †ç©ºé—´çš„åœ°å€ï¼‰</li>
</ul>
<p>åè€…åˆ›å»ºäº†å…­ä¸ªå¯¹è±¡ï¼š</p>
<ul>
<li>å¯¹è±¡1ï¼šnew StringBuilder()</li>
<li>å¯¹è±¡2ï¼šnew String(â€œaâ€)</li>
<li>å¯¹è±¡3ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­açš„å¼•ç”¨</li>
<li>å¯¹è±¡4ï¼šnew String(â€œbâ€)</li>
<li>å¯¹è±¡5ï¼šå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­bçš„å¼•ç”¨</li>
<li>æ·±å…¥å‰–æ<ul>
<li>å¯¹è±¡6ï¼šStringBuilderçš„toStringæ–¹æ³•ä¸­åˆ›å»ºçš„new String(â€œabâ€)</li>
<li>æ³¨æ„ï¼ŒtoStringæ–¹æ³•çš„è°ƒç”¨æ²¡æœ‰åœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆå­—ç¬¦ä¸²çš„å¼•ç”¨</li>
</ul>
</li>
</ul>
<blockquote>
<p>2ï¸âƒ£ ä¸‹åˆ—ä»£ç çš„æ‰§è¡Œç»“æœæ˜¯ï¼Ÿ</p>
<pre><code class="java">public class StringInternTest &#123;
 public static void main(String[] args) &#123;
     String s1 = new String(&quot;1&quot;);
     s1.intern(); 
     String s2 = &quot;1&quot;;
     System.out.println(s1 == s2); 

     String s3 = new String(&quot;1&quot;) + new String(&quot;1&quot;);
     s3.intern();
     String s4 = &quot;11&quot;;
     System.out.println(s3 == s4); 
 &#125;
&#125;</code></pre>
</blockquote>
<p>ç»“æœï¼š</p>
<ul>
<li>JDK6: false false</li>
<li>JDK7/8: false true</li>
</ul>
<p>è§£æï¼š</p>
<pre><code class="java">String s1 = new String(&quot;1&quot;);
// s1æ˜¯å †ç©ºé—´ä¸­åˆ›å»ºçš„&quot;1&quot;çš„åœ°å€
s1.intern();
// è°ƒç”¨æ­¤æ–¹æ³•ä¹‹å‰ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å·²ç»å­˜åœ¨äº†&quot;1&quot;
String s2 = &quot;1&quot;;
// s2æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­&quot;1&quot;çš„åœ°å€
System.out.println(s1 == s2);
// JDK1.6: false; JDK1.7/1.8: false

String s3 = new String(&quot;1&quot;) + new String(&quot;1&quot;);
// s3æ˜¯StringBuilderçš„toStringæ–¹æ³•new String(&quot;11&quot;)åœ¨å †ç©ºé—´ä¸­çš„åœ°å€ï¼Œ
// ä½†æ˜¯toStringçš„new Stringå¹¶æ²¡æœ‰æŠŠ&quot;11&quot;æ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± 
s3.intern();
// jdk1.6ä¼šå¤åˆ¶ä¸€ä¸ªå †ç©ºé—´ä¸­çš„&quot;11&quot;å¯¹è±¡ï¼Œå³åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œæ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆå…¨æ–°åœ°å€ï¼‰
// jdk1.7/1.8ä¼šå¤åˆ¶ä¸€ä¸ªå †ç©ºé—´ä¸­çš„&quot;11&quot;å¯¹è±¡çš„å¼•ç”¨åœ°å€ï¼Œæ”¾å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆå¼•ç”¨åœ°å€ï¼‰
String s4 = &quot;11&quot;;
// s4æ˜¯å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­&quot;11&quot;çš„å¯¹è±¡åœ°å€
System.out.println(s3 == s4);
// JDK1.6: false; JDK1.7/1.8: true</code></pre>
<h2 id="12-5-â™»-StringTableåƒåœ¾å›æ”¶"><a href="#12-5-â™»-StringTableåƒåœ¾å›æ”¶" class="headerlink" title="12.5 â™» StringTableåƒåœ¾å›æ”¶"></a>12.5 â™» StringTableåƒåœ¾å›æ”¶</h2><blockquote>
<p>âš™ï¸å¯åŠ¨æ‰“å°åƒåœ¾å›æ”¶æ—¥å¿—</p>
</blockquote>
<ul>
<li>-XX:+PrintStringTableStatisticsï¼šæ‰“å°å­—ç¬¦ä¸²å¸¸é‡æ± ç»Ÿè®¡ä¿¡æ¯</li>
<li>-XX:+PrintGCDetailsï¼šæ‰“å°GCæ—¥å¿—è¯¦æƒ…</li>
</ul>
<blockquote>
<p>âš™ï¸G1çš„Stringå»é‡æ“ä½œ</p>
</blockquote>
<ul>
<li>UseStringDeduplication(bool)ï¼šå¼€å¯Stringå»é‡ï¼ˆé»˜è®¤ä¸å¼€å¯ï¼‰</li>
<li>PrintStringDeduplicationStatistics(bool)ï¼šæ‰“å°è¯¦ç»†çš„å»é‡å¹´é¾„ç»Ÿè®¡ä¿¡æ¯</li>
<li>StringDeduplicationAgeThreshold(utinx)ï¼šè¾¾åˆ°å¹´é¾„çš„Stringå¯¹è±¡è¢«è®¤ä¸ºæ˜¯å»é‡çš„å€™é€‰å¯¹è±¡</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-11(æ‰§è¡Œå¼•æ“)</title>
    <url>/posts/58113/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="11-1-ğŸ“–-æ¦‚è¿°"><a href="#11-1-ğŸ“–-æ¦‚è¿°" class="headerlink" title="11.1 ğŸ“– æ¦‚è¿°"></a>11.1 ğŸ“– æ¦‚è¿°</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>æ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰æ˜¯Javaè™šæ‹Ÿæœºæ ¸å¿ƒçš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚</li>
<li>â€œè™šæ‹Ÿæœºâ€æ˜¯ä¸€ä¸ªç›¸å¯¹äºâ€œç‰©ç†æœºâ€çš„æ¦‚å¿µï¼Œè¿™ä¸¤ç§æœºå™¨éƒ½æœ‰ä»£ç æ‰§è¡Œèƒ½åŠ›ï¼Œå…¶åŒºåˆ«æ˜¯ç‰©ç†æœºçš„æ‰§è¡Œå¼•æ“æ˜¯ç›´æ¥å»ºç«‹åœ¨å¤„ç†å™¨ã€ç¼“å­˜ã€æŒ‡ä»¤é›†å’Œæ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„ï¼Œè€Œè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“åˆ™æ˜¯ç”±è½¯ä»¶è‡ªè¡Œå®ç°çš„ï¼Œå› æ­¤å¯ä»¥ä¸å—ç‰©ç†æ¡ä»¶åˆ¶çº¦åœ°å®šåˆ¶æŒ‡ä»¤é›†ä¸æ‰§è¡Œå¼•æ“çš„ç»“æ„ä½“ç³»ï¼Œèƒ½å¤Ÿæ‰§è¡Œé‚£äº›ä¸è¢«ç¡¬ä»¶ç›´æ¥æ”¯æŒçš„æŒ‡ä»¤é›†æ ¼å¼ã€‚</li>
</ul>
<blockquote>
<p>âœ¨æ„ä¹‰</p>
</blockquote>
<p>JVMçš„ä¸»è¦ä»»åŠ¡æ˜¯è´Ÿè´£è£…è½½å­—èŠ‚ç åˆ°å…¶å†…éƒ¨ï¼Œä½†å­—èŠ‚ç å¹¶ä¸èƒ½å¤Ÿç›´æ¥è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œå› ä¸ºå­—èŠ‚ç æŒ‡ä»¤å¹¶éç­‰ä»·äºæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œå®ƒå†…éƒ¨åŒ…å«çš„ä»…ä»…åªæ˜¯ä¸€äº›èƒ½å¤Ÿè¢«JVMæ‰€è¯†åˆ«çš„å­—èŠ‚ç æŒ‡ä»¤ã€ç¬¦å·è¡¨ä»¥åŠå…¶ä»–è¾…åŠ©ä¿¡æ¯ã€‚</p>
<p>é‚£ä¹ˆï¼Œæƒ³è¦è®©ä¸€ä¸ªJavaç¨‹åºè¿è¡Œèµ·æ¥ï¼Œæ‰§è¡Œå¼•æ“çš„ä»»åŠ¡å°±æ˜¯å°†å­—èŠ‚ç æŒ‡ä»¤è§£é‡Š/ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰å¯ä»¥ã€‚ç®€å•æ¥è¯´ï¼ŒJVMä¸­çš„æ‰§è¡Œå¼•æ“å……å½“äº†å°†é«˜çº§è¯­è¨€ç¿»è¯‘ä¸ºæœºå™¨è¯­è¨€çš„è¯‘è€…ã€‚</p>
<h2 id="11-2-â³-Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹"><a href="#11-2-â³-Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="11.2 â³ Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹"></a>11.2 â³ Javaä»£ç ç¼–è¯‘å’Œæ‰§è¡Œè¿‡ç¨‹</h2><blockquote>
<p>ğŸ“‹å·¥ä½œæµç¨‹</p>
</blockquote>
<p>ï¼ˆ1ï¼‰æ‰§è¡Œå¼•æ“åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ç©¶ç«Ÿéœ€è¦æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤å®Œå…¨ä¾èµ–äºPCå¯„å­˜å™¨ã€‚</p>
<p>ï¼ˆ2ï¼‰æ¯å½“æ‰§è¡Œå®Œä¸€é¡¹æŒ‡ä»¤æ“ä½œåï¼ŒPCå¯„å­˜å™¨å°±ä¼šæ›´æ–°ä¸‹ä¸€æ¡éœ€è¦è¢«æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚</p>
<p>ï¼ˆ3ï¼‰å½“ç„¶æ–¹æ³•åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œå¼•æ“æœ‰å¯èƒ½ä¼šé€šè¿‡å­˜å‚¨åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¯¹è±¡å¼•ç”¨å‡†ç¡®å®šä½åˆ°å­˜å‚¨åœ¨Javaå †åŒºä¸­çš„å¯¹è±¡å®ä¾‹ä¿¡æ¯ï¼Œä»¥åŠé€šè¿‡å¯¹è±¡å¤´ä¸­çš„å…ƒæ•°æ®æŒ‡é’ˆå®šä½åˆ°ç›®æ ‡å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ã€‚</p>
<p>ä»å¤–è§‚ä¸Šæ¥çœ‹ï¼Œæ‰€æœ‰çš„Javaè™šæ‹Ÿæœºçš„æ‰§è¡Œå¼•æ“è¾“å…¥ã€è¾“å‡ºéƒ½æ˜¯ä¸€è‡´çš„ï¼›è¾“å…¥çš„æ˜¯å­—èŠ‚ç äºŒè¿›åˆ¶æµï¼Œå¤„ç†è¿‡ç¨‹æ˜¯å­—èŠ‚ç è§£æçš„ç­‰æ•ˆè¿‡ç¨‹ï¼Œè¾“å‡ºçš„æ˜¯æ‰§è¡Œè¿‡ç¨‹ã€‚</p>
<blockquote>
<p>ğŸ“¼æµç¨‹å›¾ç¤º</p>
</blockquote>
<p>å¤§éƒ¨åˆ†çš„ç¨‹åºä»£ç è½¬æ¢æˆç‰©ç†æœºçš„ç›®æ ‡ä»£ç æˆ–è™šæ‹Ÿæœºèƒ½æ‰§è¡Œçš„æŒ‡ä»¤é›†ä¹‹å‰ï¼Œéƒ½éœ€è¦ç»è¿‡ä¸‹å›¾ä¸­çš„å„ä¸ªæ­¥éª¤ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/58113/image-20210307160507117.png" class="" title="image-20210307160507117">



<blockquote>
<p>ğŸ“·ç¼–è¯‘è¿‡ç¨‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/58113/image-20210307161035463.png" class="" title="image-20210307161035463">



<blockquote>
<p>ğŸ“·æ‰§è¡Œè¿‡ç¨‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/58113/image-20210307161149256.png" class="" title="image-20210307161149256">



<blockquote>
<p>â”ä»€ä¹ˆæ˜¯è§£é‡Šå™¨ï¼Œä»€ä¹ˆæ˜¯ä½ JITç¼–è¯‘å™¨ï¼Ÿ</p>
</blockquote>
<p>è§£é‡Šå™¨ï¼šå½“Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶ä¼šæ ¹æ®é¢„å®šä¹‰çš„è§„èŒƒå¯¹å­—èŠ‚ç é‡‡ç”¨é€è¡Œè§£é‡Šçš„æ–¹å¼æ‰§è¡Œï¼Œå°†æ¯æ¡å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å†…å®¹â€œç¿»è¯‘â€ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚</p>
<p>JITï¼ˆJust In Time Compilerï¼‰ç¼–è¯‘å™¨ï¼šå°±æ˜¯è™šæ‹Ÿæœºå°†æºä»£ç ç›´æ¥ç¼–è¯‘æˆå’Œæœ¬åœ°æœºå™¨å¹³å°ç›¸å…³çš„æœºå™¨è¯­è¨€ã€‚</p>
<p>æ¯”è¾ƒï¼š</p>
<p>è§£é‡Šå™¨å¯ä»¥çœå»ç¼–è¯‘çš„æ—¶é—´ï¼Œå¯ä»¥å¿«é€Ÿæ‰§è¡Œç¨‹åºï¼›</p>
<p>å³æ—¶ç¼–è¯‘å™¨æŠŠä»£ç ç¼–è¯‘æˆæœ¬åœ°æœºå™¨è¯­è¨€ï¼Œæ‰§è¡Œæ•ˆç‡é«˜ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/58113/image-20210307163417053.png" class="" title="image-20210307163417053">



<blockquote>
<p>â”ä¸ºä»€ä¹ˆè¯´Javaæ˜¯åŠç¼–è¯‘åŠè§£é‡Šå‹è¯­è¨€ï¼Ÿ</p>
</blockquote>
<p>JDK1.0æ—¶ä»£ï¼Œå°†Javaè¯­è¨€å®šä½ä¸ºâ€œè§£é‡Šæ‰§è¡Œâ€è¿˜æ˜¯æ¯”è¾ƒå‡†å¤‡çš„ã€‚å†åæ¥ï¼ŒJavaä¹Ÿå‘å±•å‡ºå¯ä»¥ç›´æ¥ç”Ÿæˆæœ¬åœ°ä»£ç çš„ç¼–è¯‘å™¨ã€‚</p>
<p>ç°åœ¨JVMåœ¨æ‰§è¡ŒJavaä»£ç çš„æ—¶å€™ï¼Œé€šå¸¸éƒ½ä¼šå°†è§£é‡Šæ‰§è¡Œä¸ç¼–è¯‘æ‰§è¡ŒäºŒè€…ç»“åˆèµ·æ¥è¿›è¡Œã€‚</p>
<h2 id="11-3-ğŸ’¤-æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€"><a href="#11-3-ğŸ’¤-æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€" class="headerlink" title="11.3 ğŸ’¤ æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€"></a>11.3 ğŸ’¤ æœºå™¨ç ã€æŒ‡ä»¤ã€æ±‡ç¼–è¯­è¨€</h2><blockquote>
<p>ğŸ“”æœºå™¨ç </p>
</blockquote>
<p>å„ç§ç”¨äºŒè¿›åˆ¶ç¼–ç æ–¹å¼è¡¨ç¤ºçš„æŒ‡ä»¤ï¼Œå«åšæœºå™¨æŒ‡ä»¤ç ã€‚å¼€å§‹ï¼Œäººä»¬å°±ç”¨å®ƒé‡‡ç¼–å†™ç¨‹åºï¼Œè¿™å°±æ˜¯æœºå™¨è¯­è¨€ã€‚</p>
<p>æœºå™¨è¯­è¨€è™½ç„¶èƒ½å¤Ÿè¢«è®¡ç®—æœºç†è§£å’Œæ¥å—ï¼Œä½†å’Œäººä»¬çš„è¯­è¨€å·®åˆ«å¤ªå¤§ï¼Œä¸æ˜“è¢«äººä»¬ç†è§£å’Œè®°å¿†ï¼Œå¹¶ä¸”ç”¨å®ƒç¼–ç¨‹å®¹æ˜“å‡ºå·®é”™ã€‚</p>
<p>ç”¨å®ƒç¼–å†™çš„ç¨‹åºä¸€ç»è¾“å…¥è®¡ç®—æœºï¼ŒCPUç›´æ¥è¯»å–è¿è¡Œï¼Œå› æ­¤å’Œå…¶ä»–è¯­è¨€ç¼–çš„ç¨‹åºç›¸æ¯”ï¼Œæ‰§è¡Œé€Ÿåº¦æœ€å¿«ã€‚</p>
<p>æœºå™¨æŒ‡ä»¤ä¸CPUç´§å¯†ç›¸å…³ï¼Œæ‰€ä»¥ä¸åŒç§ç±»çš„CPUæ‰€å¯¹åº”çš„æœºå™¨æŒ‡ä»¤ä¹Ÿå°±ä¸åŒã€‚</p>
<blockquote>
<p>ğŸ“•æŒ‡ä»¤</p>
</blockquote>
<p>ç”±äºæœºå™¨ç æ˜¯æœ‰0å’Œ1ç»„æˆçš„äºŒè¿›åˆ¶åºåˆ—ï¼Œå¯è¯»æ€§å®åœ¨å¤ªå·®ï¼Œäºæ˜¯äººä»¬å‘æ˜äº†æŒ‡ä»¤ã€‚</p>
<p>æŒ‡ä»¤å°±æ˜¯æŠŠæœºå™¨ç ä¸­ç‰¹å®šçš„0å’Œ1åºåˆ—ï¼Œç®€åŒ–æˆå¯¹åº”çš„æŒ‡ä»¤ï¼ˆä¸€èˆ¬ä¸ºè‹±æ–‡ç®€å†™ï¼Œå¦‚movï¼Œincç­‰ï¼‰ï¼Œå¯è¯»æ€§ç¨å¥½</p>
<p>ç”±äºä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œæ‰§è¡ŒåŒä¸€ä¸ªæ“ä½œï¼Œå¯¹åº”çš„æœºå™¨ç å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥ä¸åŒçš„ç¡¬ä»¶å¹³å°çš„åŒä¸€ç§æŒ‡ä»¤ï¼ˆæ¯”å¦‚movï¼‰ï¼Œå¯¹åº”çš„æœºå™¨ç ä¹Ÿå¯èƒ½ä¸åŒã€‚</p>
<blockquote>
<p>ğŸ“—æŒ‡ä»¤é›†</p>
</blockquote>
<p>ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œå„è‡ªæ”¯æŒçš„æŒ‡ä»¤ï¼Œæ˜¯æœ‰å·®åˆ«çš„ã€‚å› æ­¤æ¯ä¸ªå¹³å°æ‰€æ”¯æŒçš„æŒ‡ä»¤ï¼Œç§°ä¹‹ä¸ºå¯¹åº”å¹³å°çš„æŒ‡ä»¤é›†ã€‚ å¦‚å¸¸è§çš„</p>
<ul>
<li>x86æŒ‡ä»¤é›†ï¼Œå¯¹åº”çš„æ˜¯x86æ¶æ„çš„å¹³å°</li>
<li>ARMæŒ‡ä»¤é›†ï¼Œå¯¹åº”çš„æ˜¯ARMæ¶æ„çš„å¹³å°</li>
</ul>
<blockquote>
<p>ğŸ“˜æ±‡ç¼–è¯­è¨€</p>
</blockquote>
<p>ç”±äºæŒ‡ä»¤çš„å¯è¯»æ€§è¿˜æ˜¯å¤ªå·®ï¼Œäºæ˜¯äººä»¬åˆå‘æ˜äº†æ±‡ç¼–è¯­è¨€ã€‚</p>
<p>åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œç”¨åŠ©è®°ç¬¦ï¼ˆMnemonicsï¼‰ä»£æ›¿æœºå™¨æŒ‡ä»¤çš„æ“ä½œç ï¼Œç”¨åœ°å€ç¬¦å·ï¼ˆSymbo1ï¼‰æˆ–æ ‡å·ï¼ˆLabe1ï¼‰ä»£æ›¿æŒ‡ä»¤æˆ–æ“ä½œæ•°çš„åœ°å€ã€‚åœ¨ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œæ±‡ç¼–è¯­è¨€å¯¹åº”ç€ä¸åŒçš„æœºå™¨è¯­è¨€æŒ‡ä»¤é›†ï¼Œé€šè¿‡æ±‡ç¼–è¿‡ç¨‹è½¬æ¢æˆæœºå™¨æŒ‡ä»¤ã€‚</p>
<p>ç”±äºè®¡ç®—æœºåªè®¤è¯†æŒ‡ä»¤ç ï¼Œæ‰€ä»¥ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„ç¨‹åºè¿˜å¿…é¡»ç¿»è¯‘æˆæœºå™¨æŒ‡ä»¤ç ï¼Œè®¡ç®—æœºæ‰èƒ½è¯†åˆ«å’Œæ‰§è¡Œã€‚</p>
<blockquote>
<p>ğŸ“™é«˜çº§è¯­è¨€</p>
</blockquote>
<p>ä¸ºäº†ä½¿è®¡ç®—æœºç”¨æˆ·ç¼–ç¨‹åºæ›´å®¹æ˜“äº›ï¼Œåæ¥å°±å‡ºç°äº†å„ç§é«˜çº§è®¡ç®—æœºè¯­è¨€ã€‚</p>
<p>é«˜çº§è¯­è¨€æ¯”æœºå™¨è¯­è¨€ã€æ±‡ç¼–è¯­è¨€æ›´æ¥è¿‘äººçš„è¯­è¨€å½“è®¡ç®—æœºæ‰§è¡Œé«˜çº§è¯­è¨€ç¼–å†™çš„ç¨‹åºæ—¶ï¼Œä»ç„¶éœ€è¦æŠŠç¨‹åºè§£é‡Šå’Œç¼–è¯‘æˆæœºå™¨çš„æŒ‡ä»¤ç ã€‚å®Œæˆè¿™ä¸ªè¿‡ç¨‹çš„ç¨‹åºå°±å«åšè§£é‡Šç¨‹åºæˆ–ç¼–è¯‘ç¨‹åºã€‚</p>
<blockquote>
<p>ğŸ“’å­—èŠ‚ç </p>
</blockquote>
<p>å­—èŠ‚ç æ˜¯ä¸€ç§ä¸­é—´çŠ¶æ€ï¼ˆä¸­é—´ç ï¼‰çš„äºŒè¿›åˆ¶ä»£ç ï¼ˆæ–‡ä»¶ï¼‰ï¼Œå®ƒæ¯”æœºå™¨ç æ›´æŠ½è±¡ï¼Œéœ€è¦ç›´è¯‘å™¨è½¬è¯‘åæ‰èƒ½æˆä¸ºæœºå™¨ç </p>
<p>å­—èŠ‚ç ä¸»è¦ä¸ºäº†å®ç°ç‰¹å®šè½¯ä»¶è¿è¡Œå’Œè½¯ä»¶ç¯å¢ƒã€ä¸ç¡¬ä»¶ç¯å¢ƒæ— å…³ã€‚</p>
<p>å­—èŠ‚ç çš„å®ç°æ–¹å¼æ˜¯é€šè¿‡ç¼–è¯‘å™¨å’Œè™šæ‹Ÿæœºå™¨ã€‚ç¼–è¯‘å™¨å°†æºç ç¼–è¯‘æˆå­—èŠ‚ç ï¼Œç‰¹å®šå¹³å°ä¸Šçš„è™šæ‹Ÿæœºå™¨å°†å­—èŠ‚ç è½¬è¯‘ä¸ºå¯ä»¥ç›´æ¥æ‰§è¡Œçš„æŒ‡ä»¤ã€‚</p>
<ul>
<li>å­—èŠ‚ç å…¸å‹çš„åº”ç”¨ä¸ºï¼šJava bytecode</li>
</ul>
<h2 id="11-4-ğŸ›©ï¸-è§£é‡Šå™¨"><a href="#11-4-ğŸ›©ï¸-è§£é‡Šå™¨" class="headerlink" title="11.4 ğŸ›©ï¸ è§£é‡Šå™¨"></a>11.4 ğŸ›©ï¸ è§£é‡Šå™¨</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>è§£é‡Šå™¨çœŸæ­£æ„ä¹‰ä¸Šæ‰€æ‰¿æ‹…çš„è§’è‰²å°±æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶â€œç¿»è¯‘è€…â€ï¼Œå°†å­—èŠ‚ç æ–‡ä»¶ä¸­çš„å†…å®¹â€œç¿»è¯‘â€ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚</p>
<p>å½“ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤è¢«è§£é‡Šæ‰§è¡Œå®Œæˆåï¼Œæ¥ç€å†æ ¹æ®PCå¯„å­˜å™¨ä¸­è®°å½•çš„ä¸‹ä¸€æ¡éœ€è¦è¢«æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤æ‰§è¡Œè§£é‡Šæ“ä½œã€‚</p>
<blockquote>
<p>ğŸ”±è§£é‡Šå™¨åˆ†ç±»</p>
</blockquote>
<p>åœ¨Javaçš„å‘å±•å†å²é‡Œï¼Œä¸€å…±æœ‰ä¸¤å¥—è§£é‡Šæ‰§è¡Œå™¨ï¼Œå³å¤è€çš„å­—èŠ‚ç è§£é‡Šå™¨ã€ç°åœ¨æ™®éä½¿ç”¨çš„æ¨¡æ¿è§£é‡Šå™¨ã€‚</p>
<p>å­—èŠ‚ç è§£é‡Šå™¨åœ¨æ‰§è¡Œæ—¶é€šè¿‡çº¯è½¯ä»¶ä»£ç æ¨¡æ‹Ÿå­—èŠ‚ç çš„æ‰§è¡Œï¼Œæ•ˆç‡éå¸¸ä½ä¸‹ã€‚</p>
<p>è€Œæ¨¡æ¿è§£é‡Šå™¨å°†æ¯ä¸€æ¡å­—èŠ‚ç å’Œä¸€ä¸ªæ¨¡æ¿å‡½æ•°ç›¸å…³è”ï¼Œæ¨¡æ¿å‡½æ•°ä¸­ç›´æ¥äº§ç”Ÿè¿™æ¡å­—èŠ‚ç æ‰§è¡Œæ—¶çš„æœºå™¨ç ï¼Œä»è€Œå¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜äº†è§£é‡Šå™¨çš„æ€§èƒ½ã€‚</p>
<p>åœ¨HotSpot VMä¸­ï¼Œè§£é‡Šå™¨ä¸»è¦ç”±Interpreteræ¨¡å—å’ŒCodeæ¨¡å—æ„æˆã€‚</p>
<ul>
<li>Interpreteræ¨¡å—ï¼šå®ç°äº†è§£é‡Šå™¨çš„æ ¸å¿ƒåŠŸèƒ½</li>
<li>Codeæ¨¡å—ï¼šç”¨äºç®¡ç†HotSpot VMåœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„æœ¬åœ°æœºå™¨æŒ‡ä»¤</li>
</ul>
<blockquote>
<p>ğŸ—“ï¸ç°çŠ¶</p>
</blockquote>
<p>ç”±äºè§£é‡Šå™¨åœ¨è®¾è®¡å’Œå®ç°ä¸Šéå¸¸ç®€å•ï¼Œå› æ­¤é™¤äº†Javaè¯­è¨€ä¹‹å¤–ï¼Œè¿˜æœ‰è®¸å¤šé«˜çº§è¯­è¨€åŒæ ·ä¹Ÿæ˜¯åŸºäºè§£é‡Šå™¨æ‰§è¡Œçš„ï¼Œæ¯”å¦‚Pythonã€Per1ã€Rubyç­‰ã€‚ä½†æ˜¯åœ¨ä»Šå¤©ï¼ŒåŸºäºè§£é‡Šå™¨æ‰§è¡Œå·²ç»æ²¦è½ä¸ºä½æ•ˆçš„ä»£åè¯ï¼Œå¹¶ä¸”æ—¶å¸¸è¢«ä¸€äº›C/C++ç¨‹åºå‘˜æ‰€è°ƒä¾ƒã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJVMå¹³å°æ”¯æŒä¸€ç§å«ä½œå³æ—¶ç¼–è¯‘çš„æŠ€æœ¯ã€‚å³æ—¶ç¼–è¯‘çš„ç›®çš„æ˜¯é¿å…å‡½æ•°è¢«è§£é‡Šæ‰§è¡Œï¼Œè€Œæ˜¯å°†æ•´ä¸ªå‡½æ•°ä½“ç¼–è¯‘æˆä¸ºæœºå™¨ç ï¼Œæ¯æ¬¡å‡½æ•°æ‰§è¡Œæ—¶ï¼Œåªæ‰§è¡Œç¼–è¯‘åçš„æœºå™¨ç å³å¯ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ä½¿æ‰§è¡Œæ•ˆç‡å¤§å¹…åº¦æå‡ã€‚</p>
<p>ä¸è¿‡æ— è®ºå¦‚ä½•ï¼ŒåŸºäºè§£é‡Šå™¨çš„æ‰§è¡Œæ¨¡å¼ä»ç„¶ä¸ºä¸­é—´è¯­è¨€çš„å‘å±•åšå‡ºäº†ä¸å¯ç£¨ç­çš„è´¡çŒ®ã€‚</p>
<h2 id="11-5-âœˆï¸-JITç¼–è¯‘å™¨"><a href="#11-5-âœˆï¸-JITç¼–è¯‘å™¨" class="headerlink" title="11.5 âœˆï¸ JITç¼–è¯‘å™¨"></a>11.5 âœˆï¸ JITç¼–è¯‘å™¨</h2><blockquote>
<p>ğŸ’»HotSpot JVMæ‰§è¡Œæ–¹å¼</p>
</blockquote>
<p>å½“è™šæ‹Ÿæœºå¯åŠ¨çš„æ—¶å€™ï¼Œè§£é‡Šå™¨å¯ä»¥é¦–å…ˆå‘æŒ¥ä½œç”¨ï¼Œè€Œä¸å¿…ç­‰å¾…å³æ—¶ç¼–è¯‘å™¨å…¨éƒ¨ç¼–è¯‘å®Œæˆå†æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥çœå»è®¸å¤šä¸å¿…è¦çš„ç¼–è¯‘æ—¶é—´ã€‚å¹¶ä¸”éšç€ç¨‹åºè¿è¡Œæ—¶é—´çš„æ¨ç§»ï¼Œå³æ—¶ç¼–è¯‘å™¨é€æ¸å‘æŒ¥ä½œç”¨ï¼Œæ ¹æ®çƒ­ç‚¹æ¢æµ‹åŠŸèƒ½ï¼Œå°†æœ‰ä»·å€¼çš„å­—èŠ‚ç ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œä»¥æ¢å–æ›´é«˜çš„ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚</p>
<blockquote>
<p>ğŸ’¬è§£é‡Š</p>
</blockquote>
<ul>
<li>Javaè¯­è¨€çš„â€œç¼–è¯‘æœŸâ€å…¶å®æ˜¯ä¸€æ®µâ€œä¸ç¡®å®šâ€çš„æ“ä½œè¿‡ç¨‹ï¼Œå› ä¸ºå®ƒå¯èƒ½æ˜¯æŒ‡ä¸€ä¸ªå‰ç«¯ç¼–è¯‘å™¨æŠŠ.javaæ–‡ä»¶è½¬å˜æˆ.classæ–‡ä»¶çš„è¿‡ç¨‹ã€‚</li>
<li>ä¹Ÿå¯èƒ½æ˜¯æŒ‡è™šæ‹Ÿæœºçš„åç«¯è¿è¡ŒæœŸç¼–è¯‘å™¨ï¼ˆJITç¼–è¯‘å™¨ï¼‰æŠŠå­—èŠ‚ç è½¬å˜æˆæœºå™¨ç çš„è¿‡ç¨‹ã€‚</li>
<li>è¿˜å¯èƒ½æ˜¯æŒ‡ä½¿ç”¨é™æ€æå‰ç¼–è¯‘å™¨ï¼ˆAOTç¼–è¯‘å™¨ï¼‰ç›´æ¥æŠŠ.javaæ–‡ä»¶ç¼–è¯‘æˆæœ¬åœ°æœºå™¨ä»£ç çš„è¿‡ç¨‹ã€‚</li>
</ul>
<p>å‰ç«¯ç¼–è¯‘å™¨ï¼šSunçš„Javacã€Eclipse JDTä¸­çš„å¢é‡å¼ç¼–è¯‘ï¼ˆECJï¼‰ã€‚</p>
<p>JITç¼–è¯‘å™¨ï¼šHotSpot VMçš„C1ã€C2ç¼–è¯‘å™¨ã€‚</p>
<p>AOTç¼–è¯‘å™¨ï¼šGUN Compiler for Javaï¼ˆGCJï¼‰ã€Excelsior JETã€‚</p>
<blockquote>
<p>ğŸ”¥çƒ­ç‚¹ä»£ç </p>
</blockquote>
<p>æ˜¯å¦éœ€è¦å¯åŠ¨JITç¼–è¯‘å™¨å°†å­—èŠ‚ç ç›´æ¥ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œåˆ™éœ€è¦æ ¹æ®ä»£ç è¢«è°ƒç”¨æ‰§è¡Œçš„é¢‘ç‡è€Œå®šã€‚å…³äºé‚£äº›éœ€è¦è¢«ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç çš„å­—èŠ‚ç ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸ºâ€œçƒ­ç‚¹ä»£ç â€ï¼ŒJITç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶ä¼šé’ˆå¯¹é‚£äº›é¢‘ç¹è¢«è°ƒç”¨çš„â€œçƒ­ç‚¹ä»£ç â€åšå‡ºæ·±åº¦ä¼˜åŒ–ï¼Œå°†å…¶ç›´æ¥ç¼–è¯‘ä¸ºå¯¹åº”å¹³å°çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œä»¥æ­¤æå‡Javaç¨‹åºçš„æ‰§è¡Œæ€§èƒ½ã€‚</p>
<blockquote>
<p>ğŸ³â€ğŸŒˆçƒ­ç‚¹æ¢æµ‹æŠ€æœ¯</p>
</blockquote>
<ul>
<li>ä¸€ä¸ªè¢«å¤šæ¬¡è°ƒç”¨çš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ–¹æ³•ä½“å†…å¾ªç¯æ¬¡æ•°è¾ƒå¤šçš„å¾ªç¯ä½“éƒ½å¯ä»¥è¢«ç§°ä¹‹ä¸ºâ€œçƒ­ç‚¹ä»£ç â€ï¼Œå› æ­¤éƒ½å¯ä»¥é€šè¿‡JITç¼–è¯‘å™¨ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤ã€‚ç”±äºè¿™ç§ç¼–è¯‘æ–¹å¼å‘ç”Ÿåœ¨æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¹‹ä¸ºæ ˆä¸Šæ›¿æ¢ï¼Œæˆ–ç®€ç§°ä¸ºOSRï¼ˆOn Stack Replacementï¼‰ç¼–è¯‘ã€‚</li>
<li>ä¸€ä¸ªæ–¹æ³•ç©¶ç«Ÿè¦è¢«è°ƒç”¨å¤šå°‘æ¬¡ï¼Œæˆ–è€…ä¸€ä¸ªå¾ªç¯ä½“ç©¶ç«Ÿéœ€è¦æ‰§è¡Œå¤šå°‘æ¬¡æ‰å¯ä»¥è¾¾åˆ°è¿™ä¸ªæ ‡å‡†ï¼Ÿå¿…ç„¶éœ€è¦ä¸€ä¸ªæ˜ç¡®çš„é˜ˆå€¼ï¼ŒJITç¼–è¯‘å™¨æ‰ä¼šå°†è¿™äº›â€œçƒ­ç‚¹ä»£ç â€ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚è¿™é‡Œä¸»è¦ä¾é çƒ­ç‚¹æ¢æµ‹åŠŸèƒ½ã€‚</li>
<li>ç›®å‰HotSpot VMæ‰€é‡‡ç”¨çš„çƒ­ç‚¹æ¢æµ‹æ–¹å¼æ˜¯åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ã€‚</li>
<li>é‡‡ç”¨åŸºäºè®¡æ•°å™¨çš„çƒ­ç‚¹æ¢æµ‹ï¼ŒHotSpot VMå°†ä¼šä¸ºæ¯ä¸€ä¸ªæ–¹æ³•éƒ½å»ºç«‹2ä¸ªä¸åŒç±»å‹çš„è®¡æ•°å™¨ï¼Œåˆ†åˆ«æ˜¯æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼ˆInvocation Counterï¼‰å’Œå›è¾¹è®¡æ•°å™¨ï¼ˆBack Edge Counterï¼‰ã€‚<ul>
<li>æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ç”¨äºç»Ÿè®¡æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°</li>
<li>å›è¾¹è®¡æ•°å™¨åˆ™ç”¨äºç»Ÿè®¡å¾ªç¯ä½“æ‰§è¡Œçš„å¾ªç¯æ¬¡æ•°</li>
</ul>
</li>
</ul>
<blockquote>
<p>ğŸ”¢æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨</p>
</blockquote>
<ul>
<li>è¿™ä¸ªè®¡æ•°å™¨å°±ç”¨äºç»Ÿè®¡æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ï¼Œå®ƒçš„é»˜è®¤é˜ˆå€¼åœ¨Clientæ¨¡å¼ä¸‹æ˜¯1500æ¬¡ï¼Œåœ¨Serveræ¨¡å¼ä¸‹æ˜¯10000æ¬¡è¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œå°±ä¼šè§¦å‘JITç¼–è¯‘ã€‚</li>
<li>è¿™ä¸ªé˜ˆå€¼å¯ä»¥é€šè¿‡è™šæ‹Ÿæœºå‚æ•°-XX:CompileThresholdæ¥äººä¸ºè®¾å®šã€‚</li>
<li>å½“ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥è¯¥æ–¹æ³•æ˜¯å¦å­˜åœ¨è¢«JITç¼–è¯‘è¿‡çš„ç‰ˆæœ¬ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ç¼–è¯‘åçš„æœ¬åœ°ä»£ç æ¥æ‰§è¡Œï¼›å¦‚æœä¸å­˜åœ¨å·²è¢«ç¼–è¯‘è¿‡çš„ç‰ˆæœ¬ï¼Œåˆ™å°†æ­¤æ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨åŠ ä¸€ï¼Œç„¶ååˆ¤æ–­æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ä¸å›è¾¹è®¡æ•°å™¨ä¹‹å’Œæ˜¯å¦è¶…è¿‡æ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çš„é˜ˆå€¼ã€‚å¦‚æœå·²è¶…è¿‡é˜ˆå€¼ï¼Œé‚£ä¹ˆå°†ä¼šå‘å³æ—¶ç¼–è¯‘å™¨æäº¤ä¸€ä¸ªè¯¥æ–¹æ³•çš„ä»£ç ç¼–è¯‘è¯·æ±‚ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’§çƒ­ç‚¹è¡°å‡</p>
</blockquote>
<p>å¦‚æœä¸åšä»»ä½•è®¾ç½®ï¼Œæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ç»Ÿè®¡çš„å¹¶ä¸æ˜¯æ–¹æ³•è¢«è°ƒç”¨çš„ç»å¯¹æ¬¡æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªç›¸å¯¹çš„æ‰§è¡Œé¢‘ç‡ï¼Œå³ä¸€æ®µæ—¶é—´ä¹‹å†…æ–¹æ³•è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚å½“è¶…è¿‡ä¸€å®šçš„æ—¶é—´é™åº¦ï¼Œå¦‚æœæ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ä»ç„¶ä¸è¶³ä»¥è®©å®ƒæäº¤ç»™å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘ï¼Œé‚£è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨å°±ä¼šè¢«å‡å°‘ä¸€åŠï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨çƒ­åº¦çš„è¡°å‡ï¼ˆCounter Decayï¼‰ï¼Œè€Œè¿™æ®µæ—¶é—´å°±ç§°ä¸ºæ­¤æ–¹æ³•ç»Ÿè®¡çš„åŠè¡°å‘¨æœŸï¼ˆCounter Half Life Timeï¼‰</p>
<p>è¿›è¡Œçƒ­åº¦è¡°å‡çš„åŠ¨ä½œæ˜¯åœ¨è™šæ‹Ÿæœºè¿›è¡Œåƒåœ¾æ”¶é›†æ—¶é¡ºä¾¿è¿›è¡Œçš„ï¼Œå¯ä»¥ä½¿ç”¨è™šæ‹Ÿæœºå‚æ•° -XX:-UseCounterDecay æ¥å…³é—­çƒ­åº¦è¡°å‡ï¼Œè®©æ–¹æ³•è®¡æ•°å™¨ç»Ÿè®¡æ–¹æ³•è°ƒç”¨çš„ç»å¯¹æ¬¡æ•°ï¼Œè¿™æ ·ï¼Œåªè¦ç³»ç»Ÿè¿è¡Œæ—¶é—´è¶³å¤Ÿé•¿ï¼Œç»å¤§éƒ¨åˆ†æ–¹æ³•éƒ½ä¼šè¢«ç¼–è¯‘æˆæœ¬åœ°ä»£ç ã€‚</p>
<p>å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨-XX:CounterHalfLifeTimeå‚æ•°è®¾ç½®åŠè¡°å‘¨æœŸçš„æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚</p>
<blockquote>
<p>ğŸ”¢å›è¾¹è®¡æ•°å™¨</p>
</blockquote>
<p>å®ƒçš„ä½œç”¨æ˜¯ç»Ÿè®¡ä¸€ä¸ªæ–¹æ³•ä½“ä¸­å¾ªç¯ä½“ä»£ç æ‰§è¡Œçš„æ¬¡æ•°ï¼Œåœ¨å­—èŠ‚ç ä¸­é‡åˆ°æ§åˆ¶æµå‘åè·³è½¬çš„æŒ‡ä»¤ç§°ä¸ºâ€œå›è¾¹â€ï¼ˆBack Edgeï¼‰ã€‚æ˜¾ç„¶ï¼Œå»ºç«‹å›è¾¹è®¡æ•°å™¨ç»Ÿè®¡çš„ç›®çš„å°±æ˜¯ä¸ºäº†è§¦å‘OSRç¼–è¯‘ã€‚</p>
<blockquote>
<p>ğŸ”±HotSpot VMå¯ä»¥è®¾ç½®ç¨‹åºæ‰§è¡Œæ–¹å¼</p>
</blockquote>
<p>ç¼ºçœæƒ…å†µä¸‹HotSpot VMæ˜¯é‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„ï¼Œå½“ç„¶å¼€å‘äººå‘˜å¯ä»¥æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯ï¼Œé€šè¿‡å‘½ä»¤æ˜¾ç¤ºåœ°ä¸ºJavaè™šæ‹ŸæœºæŒ‡å®šåœ¨è¿è¡Œæ—¶åˆ°åº•æ˜¯é‡‡ç”¨è§£é‡Šå™¨æ‰§è¡Œè¿˜æ˜¯å®Œå…¨é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨æ‰§è¡Œã€‚</p>
<ul>
<li>-Xint: å®Œå…¨é‡‡ç”¨è§£é‡Šå™¨æ¨¡å¼æ‰§è¡Œç¨‹åºã€‚</li>
<li>Xcompï¼šå®Œå…¨é‡‡ç”¨å³æ—¶ç¼–è¯‘å™¨æ¨¡å¼æ‰§è¡Œç¨‹åºã€‚å¦‚æœå³æ—¶ç¼–è¯‘å‡ºç°é—®é¢˜ï¼Œè§£é‡Šå™¨ä¼šä»‹å…¥æ‰§è¡Œã€‚</li>
<li>-Xmixedï¼šé‡‡ç”¨è§£é‡Šå™¨+å³æ—¶ç¼–è¯‘å™¨çš„æ··åˆæ¨¡å¼å…±åŒæ‰§è¡Œç¨‹åºã€‚</li>
</ul>
<blockquote>
<p>ğŸ”±HotSpot VMä¸­JITåˆ†ç±»</p>
</blockquote>
<p>åœ¨HotSpot VMä¸­å†…åµŒæœ‰ä¸¤ä¸ªJITç¼–è¯‘å™¨ï¼Œåˆ†åˆ«ä¸ºClient Compilerå’ŒServer Compilerï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬ç®€ç§°ä¸ºC1ç¼–è¯‘å™¨å’ŒC2ç¼–è¯‘å™¨ã€‚å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ˜¾ç¤ºæŒ‡å®šJavaè™šæ‹Ÿæœºåœ¨è¿è¡Œæ—¶åˆ°åº•ä½¿ç”¨å“ªä¸€ç§å³æ—¶ç¼–è¯‘å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ul>
<li>-clientï¼šæŒ‡å®šJavaè™šæ‹Ÿæœºè¿è¡Œåœ¨Clientæ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨C1ç¼–è¯‘å™¨<ul>
<li>C1ç¼–è¯‘å™¨ä¼šå¯¹å­—èŠ‚ç è¿›è¡Œç®€å•å’Œå¯é çš„ä¼˜åŒ–ï¼Œè€—æ—¶çŸ­ã€‚ä»¥è¾¾åˆ°æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦ã€‚</li>
</ul>
</li>
<li>-serverï¼šæŒ‡å®šJavaè™šæ‹Ÿæœºè¿è¡Œåœ¨Serveræ¨¡å¼ä¸‹ï¼Œå¹¶ä½¿ç”¨C2ç¼–è¯‘å™¨ã€‚<ul>
<li>C2è¿›è¡Œè€—æ—¶è¾ƒé•¿çš„ä¼˜åŒ–ï¼Œä»¥åŠæ¿€è¿›ä¼˜åŒ–ã€‚ä½†ä¼˜åŒ–çš„ä»£ç æ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>ğŸ”°C1å’ŒC2ç¼–è¯‘å™¨ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥</p>
</blockquote>
<p>åœ¨ä¸åŒçš„ç¼–è¯‘å™¨ä¸Šæœ‰ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<p>C1ç¼–è¯‘å™¨ä¸Šä¸»è¦æœ‰æ–¹æ³•å†…è”ï¼Œå»è™šæ‹ŸåŒ–ã€å†—ä½™æ¶ˆé™¤ï¼š</p>
<ul>
<li>æ–¹æ³•å†…è”ï¼šå°†å¼•ç”¨çš„å‡½æ•°ä»£ç ç¼–è¯‘åˆ°å¼•ç”¨ç‚¹å¤„ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ ˆå¸§çš„ç”Ÿæˆï¼Œå‡å°‘å‚æ•°ä¼ é€’ä»¥åŠè·³è½¬è¿‡ç¨‹ã€‚</li>
<li>å»è™šæ‹ŸåŒ–ï¼šå¯¹å”¯ä¸€çš„å®ç°ç±»è¿›è¡Œå†…è”ã€‚</li>
<li>å†—ä½™æ¶ˆé™¤ï¼šåœ¨è¿è¡ŒæœŸé—´æŠŠä¸€äº›ä¸ä¼šæ‰§è¡Œçš„ä»£ç æŠ˜å æ‰ã€‚</li>
</ul>
<p>C2çš„ä¼˜åŒ–ä¸»è¦æ˜¯åœ¨å…¨å±€å±‚é¢ï¼Œé€ƒé€¸åˆ†ææ˜¯ä¼˜åŒ–çš„åŸºç¡€ã€‚åŸºäºé€ƒé€¸åˆ†æåœ¨C2ä¸Šæœ‰å¦‚ä¸‹çš„å‡ ç§ä¼˜åŒ–ï¼š</p>
<ul>
<li>æ ‡é‡æ›¿æ¢ï¼šç”¨æ ‡é‡å€¼æ›¿æ¢èšåˆå¯¹è±¡çš„å±æ€§å€¼</li>
<li>æ ˆä¸Šåˆ†é…ï¼šå¯¹äºæœªé€ƒé€¸çš„å¯¹è±¡åˆ†é…å¯¹è±¡åœ¨æ ˆè€Œä¸æ˜¯å †</li>
<li>åŒæ­¥æ¶ˆé™¤ï¼šæ¸…é™¤åŒæ­¥æ“ä½œï¼Œé€šå¸¸æŒ‡synchronized</li>
</ul>
<blockquote>
<p>ğŸ”°åˆ†å±‚ç¼–è¯‘ç­–ç•¥</p>
</blockquote>
<p>åˆ†å±‚ç¼–è¯‘ï¼ˆTiered Compilationï¼‰ç­–ç•¥ï¼šç¨‹åºè§£é‡Šæ‰§è¡Œï¼ˆä¸å¼€å¯æ€§èƒ½ç›‘æ§ï¼‰å¯ä»¥è§¦å‘C1ç¼–è¯‘ï¼Œå°†å­—èŠ‚ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œå¯ä»¥è¿›è¡Œç®€å•ä¼˜åŒ–ï¼Œä¹Ÿå¯ä»¥åŠ ä¸Šæ€§èƒ½ç›‘æ§ï¼ŒC2ç¼–è¯‘ä¼šæ ¹æ®æ€§èƒ½ç›‘æ§ä¿¡æ¯è¿›è¡Œæ¿€è¿›ä¼˜åŒ–ã€‚</p>
<p>ä¸è¿‡åœ¨Java7ç‰ˆæœ¬ä¹‹åï¼Œä¸€æ—¦å¼€å‘äººå‘˜åœ¨ç¨‹åºä¸­æ˜¾ç¤ºæŒ‡å®šå‘½ä»¤â€œ-serverâ€æ—¶ï¼Œé»˜è®¤ä¼šå¼€å¯åˆ†å±‚ç¼–è¯‘ç­–ç•¥ï¼Œç”±C1ç¼–è¯‘å™¨å’ŒC2ç¼–è¯‘å™¨ç›¸äº’åä½œå…±åŒæ¥æ‰§è¡Œç¼–è¯‘ä»»åŠ¡ã€‚</p>
<blockquote>
<p>ğŸ‘â€ğŸ—¨ Graalç¼–è¯‘å™¨</p>
</blockquote>
<ul>
<li>è‡ªJDK10èµ·ï¼ŒHotSpotåˆåŠ å…¥ä¸€ä¸ªå…¨æ–°çš„å³æ—¶ç¼–è¯‘å™¨ï¼šGraalç¼–è¯‘å™¨</li>
<li>ç¼–è¯‘æ•ˆæœçŸ­çŸ­å‡ å¹´æ—¶é—´å°±è¿½å¹³äº†C2ç¼–è¯‘å™¨ï¼Œæœªæ¥å¯æœŸã€‚</li>
<li>ç›®å‰ï¼Œå¸¦ç€â€œå®éªŒçŠ¶æ€â€æ ‡ç­¾ï¼Œéœ€è¦ä½¿ç”¨å¼€å…³å‚æ•°-XX:+UnlockExperimentalVMOptions -XX:+UseJVMCICompilerå»æ¿€æ´»ï¼Œæ‰å¯ä»¥ä½¿ç”¨ã€‚</li>
</ul>
<blockquote>
<p>ğŸ‘â€ğŸ—¨AOTç¼–è¯‘å™¨</p>
</blockquote>
<ul>
<li>JDK9å¼•å…¥äº†AOTç¼–è¯‘å™¨ï¼ˆé™æ€æå‰ç¼–è¯‘å™¨ï¼ŒAhead of Time Compilerï¼‰</li>
<li>Java 9å¼•å…¥äº†å®éªŒæ€§AOTç¼–è¯‘å·¥å…·jaotcã€‚å®ƒå€ŸåŠ©äº†Graalç¼–è¯‘å™¨ï¼Œå°†æ‰€è¾“å…¥çš„Javaç±»æ–‡ä»¶è½¬æ¢æˆ‘æœºå™¨ç ï¼Œå¹¶å­˜æ”¾è‡³ç”Ÿæˆçš„åŠ¨æ€å…±äº«åº“ä¸­ã€‚</li>
<li>æ‰€è°“AOTç¼–è¯‘å™¨ï¼Œæ˜¯ä¸å³æ—¶ç¼–è¯‘å™¨ç›¸å¯¹ç«‹çš„ä¸€ä¸ªæ¦‚å¿µã€‚å³æ—¶ç¼–è¯‘æŒ‡çš„æ˜¯åœ¨ç¨‹åºçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå°†å­—èŠ‚ç è½¬æ¢ä¸ºå¯åœ¨ç¡¬ä»¶ä¸Šç›´æ¥è¿è¡Œçš„æœºå™¨ç ï¼Œå¹¶éƒ¨ç½²è‡³æ‰˜ç®¡ç¯å¢ƒä¸­çš„è¿‡ç¨‹ã€‚è€ŒAOTç¼–è¯‘æŒ‡çš„åˆ™æ˜¯ï¼Œåœ¨ç¨‹åºè¿è¡Œä¹‹å‰ï¼Œä¾¿å°†å­—èŠ‚ç è½¬æ¢ä¸ºæœºå™¨ç çš„è¿‡ç¨‹ã€‚</li>
</ul>
<p>å¥½å¤„ï¼šJavaè™šæ‹ŸæœºåŠ è½½å·²ç»é¢„ç¼–è¯‘æˆäºŒè¿›åˆ¶åº“ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œã€‚ä¸å¿…ç­‰å¾…å³æ—¶ç¼–è¯‘å™¨çš„é¢„çƒ­ï¼Œå‡å°‘Javaåº”ç”¨ç»™äººå¸¦æ¥â€œç¬¬ä¸€æ¬¡è¿è¡Œæ…¢â€çš„ä¸è‰¯ä½“éªŒã€‚</p>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>ç ´åäº†Javaâ€œä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œâ€çš„ç‰¹ç‚¹ï¼Œå¿…é¡»ä¸ºæ¯ä¸ªä¸åŒç¡¬ä»¶ã€OSç¼–è¯‘å¯¹åº”çš„å‘è¡ŒåŒ…ã€‚</p>
</li>
<li><p>é™ä½äº†Javaé“¾æ¥è¿‡ç¨‹çš„åŠ¨æ€æ€§ï¼ŒåŠ è½½çš„ä»£ç åœ¨ç¼–è¯‘æœŸå°±å¿…é¡»å…¨éƒ¨å·²çŸ¥ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-10(ç›´æ¥å†…å­˜)</title>
    <url>/posts/6513/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="10-1-ğŸ“–-æ¦‚è¿°"><a href="#10-1-ğŸ“–-æ¦‚è¿°" class="headerlink" title="10.1 ğŸ“– æ¦‚è¿°"></a>10.1 ğŸ“– æ¦‚è¿°</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>ç›´æ¥å†…å­˜ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚</p>
<p>ç›´æ¥å†…å­˜æ˜¯åœ¨Javaå †å¤–çš„ï¼Œç›´æ¥å‘ç³»ç»Ÿç”³è¯·çš„å†…å­˜åŒºé—´ã€‚</p>
<p>æ¥æºäºNIOï¼Œé€šè¿‡å­˜åœ¨å †ä¸­çš„DirectByteBufferæ“ä½œNativeå†…å­˜ã€‚</p>
<blockquote>
<p>âš™ï¸è®¾ç½®</p>
</blockquote>
<ul>
<li>ç›´æ¥å†…å­˜å¤§å°å¯ä»¥é€šè¿‡<code>MaxDirectMemorySize</code>è®¾ç½®</li>
<li>å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸å †çš„æœ€å¤§å€¼<code>-Xmx</code>å‚æ•°å€¼ä¸€è‡´</li>
</ul>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<p>é€šå¸¸ï¼Œè®¿é—®ç›´æ¥å†…å­˜çš„é€Ÿåº¦ä¼šä¼˜äºJavaå †ï¼Œå³è¯»å†™æ€§èƒ½é«˜ã€‚</p>
<ul>
<li>å› æ­¤å‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œè¯»å†™é¢‘ç¹çš„åœºåˆå¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨ç›´æ¥å†…å­˜ã€‚</li>
<li>Javaçš„NIOåº“å…è®¸Javaç¨‹åºä½¿ç”¨ç›´æ¥å†…å­˜ï¼Œç”¨äºæ•°æ®ç¼“å†²åŒºã€‚</li>
</ul>
<blockquote>
<p>âŒ¨ï¸ç¤ºä¾‹</p>
</blockquote>
<p>ä½¿ç”¨ä¸‹åˆ—ä»£ç ï¼Œç›´æ¥åˆ†é…æœ¬åœ°å†…å­˜ç©ºé—´</p>
<pre><code class="java">public class BufferTest &#123;

    private static final int BUFFER = 1024 * 1024 * 1024;

    public static void main(String[] args) &#123;
        ByteBuffer byteBuffer = ByteBuffer.allocate(BUFFER);
        System.out.println(&quot;ç›´æ¥å†…å­˜åˆ†é…å®Œæ¯•&quot;);
        Scanner scanner = new Scanner(System.in);
        scanner.next();
        System.out.println(&quot;ç›´æ¥å†…å­˜å¼€å§‹é‡Šæ”¾&quot;);
        byteBuffer = null;
        System.gc();
    &#125;
&#125;</code></pre>
<p>è¿è¡Œä¹‹åå¯ä»¥çœ‹åˆ°è¿›ç¨‹å·²åˆ†é…å†…å­˜ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/6513/image-20210307135732364.png" class="" title="image-20210307135732364">



<h2 id="10-2-ğŸŒ€-éç›´æ¥ç¼“å†²åŒºå’Œç¼“å†²åŒº"><a href="#10-2-ğŸŒ€-éç›´æ¥ç¼“å†²åŒºå’Œç¼“å†²åŒº" class="headerlink" title="10.2 ğŸŒ€ éç›´æ¥ç¼“å†²åŒºå’Œç¼“å†²åŒº"></a>10.2 ğŸŒ€ éç›´æ¥ç¼“å†²åŒºå’Œç¼“å†²åŒº</h2><blockquote>
<p>ğŸŸ£éç›´æ¥ç¼“å†²åŒº</p>
</blockquote>
<p>è¯»å†™æ–‡ä»¶ï¼Œéœ€è¦ä¸ç£ç›˜äº¤äº’ï¼Œéœ€è¦ç”±ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸ã€‚åœ¨å†…æ ¸æ€æ—¶ï¼Œéœ€è¦å†…å­˜å¦‚ä¸‹å›¾çš„æ“ä½œã€‚</p>
<p>éœ€è¦ä¸¤ä»½å†…å­˜å­˜å‚¨é‡å¤æ•°æ®ï¼Œæ•ˆç‡ä½ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/6513/image-20210307140157439.png" class="" title="image-20210307140157439">



<blockquote>
<p>ğŸŸ ç›´æ¥ç¼“å†²åŒº</p>
</blockquote>
<p>ä½¿ç”¨NIOæ—¶ï¼Œå¦‚ä¸‹å›¾ã€‚</p>
<p>æ“ä½œç³»ç»Ÿåˆ’å‡ºçš„ç›´æ¥ç¼“å­˜åŒºå¯ä»¥è¢«Javaä»£ç ç›´æ¥è®¿é—®ï¼Œåªæœ‰ä¸€ä»½ã€‚</p>
<p>NIOé€‚åˆå¯¹å¤§æ–‡ä»¶çš„è¯»å†™æ“ä½œã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/6513/image-20210307140437915.png" class="" title="image-20210307140437915">



<blockquote>
<p>âŒ¨ï¸æµ‹è¯•æ¡ˆä¾‹</p>
</blockquote>
<p>åˆ†åˆ«ä½¿ç”¨BIOå’ŒNIOè¿›è¡Œå¤åˆ¶å¤è”å››ç”µå½±æ–‡ä»¶(3.74GB)ï¼š</p>
<pre><code class="java">public class CopyFileTest &#123;

    private static final String MOVIE_NAME = &quot;D:/BaiduNetdiskDownload/å¤ä»‡è€…è”ç›Ÿ4-ç»ˆå±€ä¹‹æˆ˜.mp4&quot;;
    private static final int ONE_HUNDRED_MB = 1024 * 1024 * 100;

    public static void main(String[] args) throws IOException &#123;
        System.out.println(&quot;BIOè€—æ—¶ï¼š&quot; + inDirectBuffer(MOVIE_NAME, MOVIE_NAME + &quot;.copy.mp4&quot;));
        System.out.println(&quot;NIOè€—æ—¶ï¼š&quot; + directBuffer(MOVIE_NAME, MOVIE_NAME+ &quot;.copy.mp4&quot;)); 
    &#125;

    /**
     * BIOå¤åˆ¶
     */
    private static long inDirectBuffer(String src, String dest) throws IOException&#123;
        long start = System.currentTimeMillis();
        FileInputStream inputStream = new FileInputStream(src);
        FileOutputStream outputStream = new FileOutputStream(dest);
        byte[] buffer = new byte[ONE_HUNDRED_MB];
        int len = 0;
        while ((len = inputStream.read(buffer)) != -1) &#123;
            outputStream.write(buffer, 0, len);
        &#125;
        long end = System.currentTimeMillis();
        inputStream.close();
        outputStream.close();
        return end - start;
    &#125;

    /**
     * NIOå¤åˆ¶
     */
    private static long directBuffer(String src, String dest) throws IOException&#123;
        long start = System.currentTimeMillis();
        FileChannel inChannel = new FileInputStream(src).getChannel();
        FileChannel outChannel = new FileOutputStream(dest).getChannel();
        ByteBuffer byteBuffer = ByteBuffer.allocate(ONE_HUNDRED_MB);
        while (inChannel.read(byteBuffer) != -1) &#123;
            byteBuffer.flip();
            outChannel.write(byteBuffer);
            byteBuffer.clear();
        &#125;
        long end = System.currentTimeMillis();
        inChannel.close();
        outChannel.close();
        return end - start;
    &#125;
&#125;</code></pre>
<p>è¿è¡Œç»“æœï¼š</p>
<pre><code>BIOè€—æ—¶ï¼š11946
NIOè€—æ—¶ï¼š9079</code></pre>
<h2 id="10-3-ğŸ’¢-å­˜åœ¨çš„é—®é¢˜"><a href="#10-3-ğŸ’¢-å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="10.3 ğŸ’¢ å­˜åœ¨çš„é—®é¢˜"></a>10.3 ğŸ’¢ å­˜åœ¨çš„é—®é¢˜</h2><blockquote>
<p>ğŸ”ºé—®é¢˜</p>
</blockquote>
<ul>
<li><p>ä¹Ÿå¯èƒ½å¯¼è‡´OutOfMemoryErrorå¼‚å¸¸ã€‚</p>
</li>
<li><p>ç”±äºç›´æ¥å†…å­˜åœ¨Javaå †å¤–ï¼Œå› æ­¤å®ƒçš„å¤§å°ä¸ä¼šç›´æ¥å—é™äº-XmxæŒ‡å®šçš„æœ€å¤§å †å¤§å°ï¼Œä½†æ˜¯ç³»ç»Ÿå†…å­˜æ˜¯æœ‰é™çš„ï¼ŒJavaå †å’Œç›´æ¥å†…å­˜çš„æ€»å’Œä¾ç„¶å—é™äºæ“ä½œç³»ç»Ÿèƒ½ç»™å‡ºçš„æœ€å¤§å†…å­˜ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ”»ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>åˆ†é…å›æ”¶æˆæœ¬é«˜ã€‚</li>
<li>ä¸å—JVMå†…å­˜å›æ”¶ç®¡ç†ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’Œæ€»ç»“</p>
</blockquote>
<p>java process memory = java heap + native memory</p>
<p>è¿›ç¨‹å†…å­˜ç©ºé—´ = å †ç©ºé—´ + æœ¬åœ°å†…å­˜</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-9(å¯¹è±¡)</title>
    <url>/posts/37633/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="9-1-ğŸ¤¦â€â™‚ï¸å¯¹è±¡å®ä¾‹åŒ–"><a href="#9-1-ğŸ¤¦â€â™‚ï¸å¯¹è±¡å®ä¾‹åŒ–" class="headerlink" title="9.1 ğŸ¤¦â€â™‚ï¸å¯¹è±¡å®ä¾‹åŒ–"></a>9.1 ğŸ¤¦â€â™‚ï¸å¯¹è±¡å®ä¾‹åŒ–</h2><blockquote>
<p>ğŸ“·æ€ç»´å¯¼å›¾</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37633/image-20210518160044708.png" class="" title="image-20210518160044708">



<blockquote>
<p>âŒ¨ï¸å¯¹è±¡åˆ›å»ºä¸»æµæ–¹å¼</p>
</blockquote>
<p>å®ä½“ç±»ï¼š</p>
<pre><code class="java">package top.parak.easy;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.io.Serializable;
import java.util.Date;

@Data 
@AllArgsConstructor 
@NoArgsConstructor 
public class DemoData implements Serializable, Cloneable &#123; 

    private String stringData; 
    private Date dateData; 
    private Integer intData; 
    private Double douData; 

    @Override 
    protected Object clone() throws CloneNotSupportedException &#123; 
        return super.clone(); 
    &#125; 
&#125;</code></pre>
<p>æµ‹è¯•ï¼š</p>
<pre><code class="java">@org.junit.Test
public void testClass() throws ClassNotFoundException, IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException, CloneNotSupportedException, IOException &#123;
    // 1 new
    DemoData demoData1 = new DemoData(&quot;1-start&quot;, new Date(), 1, 0.1);
    System.out.println(demoData1.toString());

    // 2 åå°„
    Class&lt;?&gt; clazz = Class.forName(&quot;top.parak.easy.DemoData&quot;);
    // ä½¿ç”¨Class.newInstance()åˆ›å»º
    DemoData demoData2 = (DemoData) clazz.newInstance();
    demoData2.setStringData(&quot;2-start&quot;);
    demoData2.setDateData(new Date());
    demoData2.setIntData(2);
    demoData2.setDouData(0.2);
    System.out.println(demoData2.toString());
    // ä½¿ç”¨Constructor.newInstance()åˆ›å»º
    Constructor&lt;?&gt; constructor = clazz.getDeclaredConstructor(String.class, Date.class, Integer.class, Double.class);
    DemoData demoData3 = (DemoData) constructor.newInstance(&quot;3-start&quot;, new Date(), 3, 0.3);
    System.out.println(demoData3.toString());

    // 3 clone
    DemoData demoData4 = (DemoData) demoData1.clone();
    demoData4.setStringData(&quot;4-start&quot;);
    demoData4.setIntData(4);
    demoData4.setDouData(0.4);
    System.out.println(demoData4.toString());

    // 4 Serializable
    ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;data.ser&quot;));
    objectOutputStream.writeObject(demoData1);
    objectOutputStream.close();
    ObjectInputStream objectInputStream =new ObjectInputStream(new FileInputStream(&quot;data.ser&quot;));
    DemoData demoData5 = (DemoData) objectInputStream.readObject();
    demoData5.setStringData(&quot;5-start&quot;);
    demoData5.setIntData(5);
    demoData5.setDouData(0.5);
    System.out.println(demoData5.toString());
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>DemoData(stringData=1-start, dateData=Tue Dec 15 20:23:31 CST 2020, intData=1, douData=0.1)
DemoData(stringData=2-start, dateData=Tue Dec 15 20:23:31 CST 2020, intData=2, douData=0.2)
DemoData(stringData=3-start, dateData=Tue Dec 15 20:23:31 CST 2020, intData=3, douData=0.3)
DemoData(stringData=4-start, dateData=Tue Dec 15 20:23:31 CST 2020, intData=4, douData=0.4)
DemoData(stringData=5-start, dateData=Tue Dec 15 20:23:31 CST 2020, intData=5, douData=0.5)</code></pre>
<blockquote>
<p>ğŸ¨å¯¹è±¡åˆ›å»ºå…­å¤§æ­¥éª¤</p>
</blockquote>
<p>ï¼ˆ1ï¼‰åˆ¤æ–­å¯¹è±¡å¯¹åº”çš„ç±»æ˜¯å¦åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–</p>
<p>è™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡newæŒ‡ä»¤ï¼Œé¦–å…ˆå»æ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°èƒ½å¦åœ¨Metaspaceçš„å¸¸é‡æ± ä¸­å®šä½åˆ°ä¸€ä¸ªç±»çš„ç¬¦åˆå¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»å·²ç»è¢«åŠ è½½ã€è§£æå’Œåˆå§‹åŒ–ï¼ˆå³åˆ¤æ–­ç±»å…ƒä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼‰ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆåœ¨åŒäº²å§”æ´¾æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨å½“å‰ç±»åŠ è½½å™¨ä»¥ClassLoader+åŒ…å+ç±»åä¸ºkeyè¿›è¡ŒæŸ¥æ‰¾å¯¹åº”çš„.classæ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œåˆ™æŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ï¼›å¦‚æœæ‰¾åˆ°åˆ™è¿›è¡Œç±»åŠ è½½ï¼Œå¹¶ç”Ÿæˆå“åº”çš„Classå¯¹è±¡ã€‚</p>
<p>ï¼ˆ2ï¼‰ä¸ºå¯¹è±¡åˆ†é…å†…å­˜</p>
<p>é¦–å…ˆè®¡ç®—å¯¹è±¡å ç”¨ææ¡ˆä»¶çš„å¤§å°ï¼Œæ¥ç€åœ¨å †ä¸­åˆ’åˆ†ä¸€å—å†…å­˜ç»™æ–°å¯¹è±¡ã€‚å¦‚æœå®ä¾‹æˆå‘˜å˜é‡æ˜¯å¼•ç”¨å˜é‡ï¼Œä»…åˆ†é…å¼•ç”¨å˜é‡ç©ºé—´å³å¯ï¼Œå³4ä¸ªå­—èŠ‚ã€‚</p>
<p>å¦‚æœå†…å­˜è§„æ•´ï¼šæŒ‡é’ˆç¢°æ’ã€‚</p>
<p>å¦‚æœå†…å­˜ä¸è§„æ•´ï¼šè™šæ‹Ÿæœºéœ€è¦ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨ï¼Œç©ºé—²åˆ—è¡¨ã€‚</p>
<p>å¦‚æœå†…å­˜æ˜¯è§„æ•´çš„ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°†é‡‡ç”¨æŒ‡é’ˆç¢°æ’æ³•ï¼ˆBump The Pointï¼‰æ¥ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚æ„æ€æ˜¯æ‰€æœ‰ç”¨è¿‡çš„å†…å­˜åœ¨ä¸€è¾¹ï¼Œç©ºé—²çš„å†…å­˜æ”¾å¦å¤–ä¸€è¾¹ï¼Œä¸­é—´æ”¾ç€ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºåˆ†ç•Œç‚¹çš„æŒ‡ç¤ºå™¨ï¼Œåˆ†é…å†…å­˜å°±ä»…ä»…æ˜¯æŠŠæŒ‡é’ˆæŒ‡å‘ç©ºé—²é‚£è¾¹æŒªåŠ¨ä¸€æ®µä¸å¯¹è±¡å¤§å°ç›¸ç­‰çš„è·ç¦»ç½¢äº†ã€‚å¦‚æœåƒåœ¾æ”¶é›†å™¨é€‰æ‹©çš„æ˜¯Serialï¼ŒParNewè¿™ç§åŸºäºå‹ç¼©ç®—æ³•çš„ï¼Œè™šæ‹Ÿæœºé‡‡ç”¨è¿™ç§åˆ†é…æ–¹å¼ã€‚ä¸€èˆ¬ä½¿ç”¨å¸¦Compactï¼ˆæ•´ç†ï¼‰è¿‡ç¨‹çš„æ”¶é›†å™¨æ—¶ï¼Œä½¿ç”¨æŒ‡é’ˆç¢°æ’ã€‚</p>
<p>å¦‚æœå†…å­˜æ˜¯ä¸è§„æ•´çš„ï¼Œå·²ä½¿ç”¨å†…å­˜å’Œæœªä½¿ç”¨çš„å†…å­˜ç›¸äº’äº¤é”™ï¼Œé‚£ä¹ˆè™šæ‹Ÿæœºå°†é‡‡ç”¨çš„æ˜¯ç©ºé—²åˆ—è¡¨æ¥ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ã€‚æ„æ€æ˜¯è™šæ‹Ÿæœºç»´æŠ¤äº†ä¸€ä¸ªåˆ—è¡¨ï¼Œè®°å½• ä¸Šé‚£äº›å†…å­˜å—æ˜¯å¯ç”¨çš„ï¼Œå†åˆ†é…çš„æ—¶å€™ä»åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´åˆ’åˆ†ç»™å¯¹è±¡å®ä¾‹ï¼Œå¹¶æ›´æ–°åˆ—è¡¨ä¸Šçš„å†…å®¹ã€‚è¿™ç§åˆ†é…æ–¹å¼æˆä¸ºäº†â€œç©ºé—²åˆ—è¡¨â€ã€‚</p>
<p>é€‰æ‹©å“ªç§åˆ†é…æ–¹å¼ç”±Javaå †æ˜¯å¦è§„æ•´æ‰€å†³å®šï¼Œè€ŒJavaå †æ˜¯å¦è§„æ•´åˆç”±æ‰€é‡‡ç”¨çš„åƒåœ¾æ”¶é›†å™¨æ˜¯å¦å¸¦æœ‰å‹ç¼©æ•´ç†åŠŸèƒ½å†³å®šã€‚</p>
<p>ï¼ˆ3ï¼‰å¤„ç†å¹¶å‘å®‰å…¨é—®é¢˜</p>
<p>åœ¨åˆ†é…å†…å­˜ç©ºé—´æ—¶ï¼Œå¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯åŠæ—¶ä¿è¯newå¯¹è±¡æ—¶å€™çš„çº¿ç¨‹å®‰å…¨æ€§ï¼šåˆ›å»ºå¯¹è±¡æ˜¯éå¸¸é•¿é¢‘ç¹çš„æ“ä½œï¼Œè™šæ‹Ÿæœºéœ€è¦è§£å†³å¹¶å‘é—®é¢˜ã€‚è™šæ‹Ÿæœºé‡‡ç”¨ä¸¤ç§æ–¹å¼è§£å†³å¹¶å‘é—®é¢˜ï¼š</p>
<ul>
<li><p>CAS(Compare And Swap)å¤±è´¥é‡è¯• ã€åŒºåŸŸåŠ é”ï¼šä¿è¯æŒ‡é’ˆæ›´æ–°æ“ä½œçš„åŸå­æ€§ï¼›</p>
</li>
<li><p>æ¯ä¸ªçº¿ç¨‹é¢„å…ˆåˆ†é…ä¸€å—TLAB(æœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²åŒº)ï¼Œæ˜¯å¦ä½¿ç”¨TLABé€šè¿‡-XX:+/-UseTLABå‚æ•°æ¥è®¾å®šã€‚</p>
</li>
</ul>
<p>ï¼ˆ4ï¼‰åˆå§‹åŒ–åˆ†é…åˆ°çš„ç©ºé—´</p>
<p>å†…å­˜åˆ†é…ç»“æŸï¼Œè™šæ‹Ÿæœºå°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–ä¸ºé›¶å€¼ã€‚è¿™ä¸€æ­¥ä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µåœ¨Javaä»£ç ä¸­å¯ä»¥ä¸ç”¨èµ‹åˆå§‹å€¼å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œç¨‹åºèƒ½è®¿é—®åˆ°è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹æ‰€å¯¹åº”çš„é›¶å€¼ã€‚</p>
<p>ç»™å¯¹è±¡å±æ€§èµ‹å€¼çš„æ“ä½œï¼š</p>
<ul>
<li>å±æ€§çš„é»˜è®¤åˆå§‹åŒ–</li>
<li>æ˜¾ç¤ºåˆå§‹åŒ–</li>
<li>ä»£ç å—ä¸­çš„åˆå§‹åŒ–</li>
<li>æ„é€ å™¨åˆå§‹åŒ–</li>
<li>æ‰€æœ‰å±æ€§è®¾ç½®é»˜è®¤å€¼ï¼Œä¿è¯å¯¹è±¡å®ä¾‹å­—æ®µåœ¨ä¸èµ‹å€¼çš„æƒ…å†µä¸‹å¯ä»¥ç›´æ¥ä½¿ç”¨</li>
</ul>
<p>ï¼ˆ5ï¼‰è®¾ç½®å¯¹è±¡çš„å¯¹è±¡å¤´</p>
<p>å°†å¯¹è±¡çš„æ‰€å±ç±»ï¼ˆå³ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ï¼‰ã€å¯¹è±¡çš„HashCodeå’Œå¯¹è±¡çš„GCä¿¡æ¯ã€é”ä¿¡æ¯ç­‰æ•°æ®å­˜å‚¨åœ¨å¯¹è±¡çš„å¯¹è±¡å¤´ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹çš„å…·ä½“è®¾ç½®æ–¹å¼å–å†³äºJVMå®ç°ã€‚</p>
<p>ï¼ˆ6ï¼‰æ‰§è¡Œinitæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–</p>
<p>åœ¨Javaç¨‹åºçš„è§†è§’æ¥çœ‹ï¼Œåˆå§‹åŒ–æ‰æ­£å¼å¼€å§‹ã€‚åˆå§‹åŒ–æˆå‘˜å˜é‡ï¼Œæ‰§è¡Œå®ä¾‹åŒ–ä»£ç å—ï¼Œè°ƒç”¨ç±»çš„æ„é€ æ–¹æ³•ï¼Œå¹¶æŠŠå †å†…å¯¹è±¡çš„é¦–åœ°å€å¤åˆ¶ç»™å¼•ç”¨å˜é‡ã€‚</p>
<p>å› æ­¤ä¸€èˆ¬æ¥è¯´ï¼ˆç”±å­—èŠ‚ç ä¸­è·ŸéšinvokespecialæŒ‡ä»¤æ‰€å†³å®šï¼‰ï¼ŒnewæŒ‡ä»¤ä¹‹åå°±æ˜¯æ‰§è¡Œæ–¹æ³•ï¼ŒæŠŠå¯¹è±¡æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·ä¸€ä¸ªçœŸæ­£å¯ç”¨çš„å¯¹è±¡æ‰ç®—å®Œæ•´åˆ›å»ºå‡ºæ¥ã€‚</p>
<h2 id="9-2-ğŸ”³-å¯¹è±¡å†…å­˜å¸ƒå±€"><a href="#9-2-ğŸ”³-å¯¹è±¡å†…å­˜å¸ƒå±€" class="headerlink" title="9.2 ğŸ”³ å¯¹è±¡å†…å­˜å¸ƒå±€"></a>9.2 ğŸ”³ å¯¹è±¡å†…å­˜å¸ƒå±€</h2><blockquote>
<p>ğŸ“·æ€ç»´å¯¼å›¾</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37633/image-20210518160117665.png" class="" title="image-20210518160117665">



<p>æ™®é€šå¯¹è±¡ Object Headerï¼ˆ64 bitsï¼‰</p>
<table>
<thead>
<tr>
<th>Mark Wordï¼ˆ32 bitsï¼‰</th>
<th>Class Pointerï¼ˆ32 bitsï¼‰</th>
</tr>
</thead>
</table>
<p>æ•°ç»„å¯¹è±¡ Object Headerï¼ˆ96 bitsï¼‰</p>
<table>
<thead>
<tr>
<th>Mark Wordï¼ˆ32 bitsï¼‰</th>
<th>Class Pointerï¼ˆ32 bitsï¼‰</th>
</tr>
</thead>
</table>
<p>å…¶ä¸­Mark Wordç»“æ„ï¼Œåœ¨æ­£å¸¸æ— é”çŠ¶æ€ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>hashcode ï¼ˆ25 bitsï¼‰</th>
<th>gc ageï¼ˆ4 bitsï¼‰</th>
<th>biased_lock ï¼ˆ1 bitsï¼‰</th>
<th>lock state ï¼ˆ2 bitsï¼‰</th>
</tr>
</thead>
</table>
<h2 id="9-3-ğŸ›°ï¸-å¯¹è±¡è®¿é—®å®šä½"><a href="#9-3-ğŸ›°ï¸-å¯¹è±¡è®¿é—®å®šä½" class="headerlink" title="9.3 ğŸ›°ï¸ å¯¹è±¡è®¿é—®å®šä½"></a>9.3 ğŸ›°ï¸ å¯¹è±¡è®¿é—®å®šä½</h2><blockquote>
<p>â”JVMæ˜¯å¦‚ä½•é€šè¿‡æ ˆå¸§ä¸­çš„å¯¹è±¡å¼•ç”¨è®¿é—®åˆ°å…¶å†…éƒ¨çš„å¯¹è±¡å®ä¾‹çš„å‘¢ï¼Ÿ</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37633/image-20210307115251686.png" class="" title="image-20210307115251686">



<blockquote>
<p>1ï¸âƒ£å¥æŸ„è®¿é—®</p>
</blockquote>
<p>æ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œè®°å½•çš„å¯¹è±¡çš„å¼•ç”¨ï¼Œç„¶ååœ¨å †ç©ºé—´ä¸­å¼€è¾Ÿäº†ä¸€å—ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯å¥æŸ„æ± ã€‚</p>
<p>ä¼˜ç‚¹ï¼šreferenceä¸­å­˜å‚¨ç¨³å®šå¥æŸ„åœ°å€ï¼Œå¯¹è±¡è¢«ç§»åŠ¨ï¼ˆåƒåœ¾æ”¶é›†æ—¶ç§»åŠ¨å¯¹è±¡å¾ˆæ™®éï¼‰æ—¶åªä¼šæ”¹å˜å¥æŸ„ä¸­å®ä¾‹æ•°æ®æŒ‡é’ˆå³å¯ï¼Œreferenceæœ¬èº«ä¸éœ€è¦è¢«ä¿®æ”¹ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37633/image-20210307120509642.png" class="" title="image-20210307120509642">





<blockquote>
<p>2ï¸âƒ£ç›´æ¥æŒ‡é’ˆ</p>
</blockquote>
<p>ç›´æ¥æŒ‡é’ˆæ˜¯å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¼•ç”¨ï¼Œç›´æ¥æŒ‡å‘å †ä¸­çš„å®ä¾‹ï¼Œåœ¨å¯¹è±¡å®ä¾‹ä¸­æœ‰ç±»å‹æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯æ–¹æ³•åŒºä¸­çš„å¯¹è±¡ç±»å‹æ•°æ®ã€‚</p>
<p>å¥½å¤„ï¼šèŠ‚çœç©ºé—´ï¼Œé€Ÿåº¦æ›´å¿«ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37633/image-20210307120911877.png" class="" title="image-20210307120911877">

]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-8(æ–¹æ³•åŒº)</title>
    <url>/posts/19997/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="8-1-ğŸ““-ç†è§£"><a href="#8-1-ğŸ““-ç†è§£" class="headerlink" title="8.1 ğŸ““ ç†è§£"></a>8.1 ğŸ““ ç†è§£</h2><blockquote>
<p>ğŸ“šè§„èŒƒ</p>
</blockquote>
<p>ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æ˜ç¡®è¯´æ˜ï¼šâ€œå°½ç®¡æ‰€æœ‰çš„æ–¹æ³•åŒºåœ¨é€»è¾‘ä¸Šæ˜¯å±äºå †çš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¸€äº›ç®€å•çš„å®ç°å¯èƒ½ä¸ä¼šé€‰æ‹©å»è¿›è¡Œåƒåœ¾æ”¶é›†æˆ–è€…è¿›è¡Œå‹ç¼©ã€‚â€ä½†å¯¹äºHotSpotJVMè€Œè¨€ï¼Œæ–¹æ³•åŒºè¿˜æœ‰ä¸€ä¸ªåˆ«åå«åšNon-Heapï¼ˆéå †ï¼‰ï¼Œç›®çš„å°±æ˜¯è¦å’Œå †åˆ†å¼€ã€‚</p>
<p>æ‰€ä»¥ï¼Œæ–¹æ³•åŒºçœ‹ä½œæ˜¯ä¸€å—ç‹¬ç«‹äºJavaå †çš„å†…å­˜ç©ºé—´ã€‚</p>
<blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>æ–¹æ³•åŒºä¸»è¦å­˜æ”¾çš„æ˜¯Classï¼Œè€Œå †ä¸­ä¸»è¦å­˜æ”¾çš„å®ä¾‹åŒ–çš„å¯¹è±¡ã€‚</p>
<ul>
<li><p>æ–¹æ³•åŒºå’ŒJavaå †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸã€‚</p>
</li>
<li><p>æ–¹æ³•åŒºåœ¨JVMå¯åŠ¨çš„æ—¶å€™è¢«åˆ›å»ºï¼Œå¹¶ä¸”å®ƒçš„å®é™…çš„ç‰©ç†å†…å­˜ç©ºé—´å’ŒJavaå †åŒºä¸€æ ·éƒ½å¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚</p>
</li>
<li><p>æ–¹æ³•åŒºçš„å¤§å°ï¼Œè·Ÿå †ä¸€æ ·ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–å¯æ‰©å±•ã€‚</p>
</li>
<li><p>æ–¹æ³•åŒºçš„å¤§å°ï¼Œè·Ÿå †ç©ºé—´ä¸€æ ·ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–è€…å¯æ‰©å±•ã€‚</p>
</li>
<li><p>æ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥ä¿å­˜å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿå®šä¹‰äº†å¤ªå¤šçš„ç±»ï¼Œå¯¼è‡´æ–¹æ³•åŒºæº¢å‡ºï¼Œè™šæ‹ŸæœºåŒæ ·ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºé”™è¯¯<code>java.lang.OutofMemoryError:PermGen space</code>æˆ–è€…<code>java.lang.OutOfMemoryError:Metaspace</code></p>
</li>
<li><ul>
<li>åŠ è½½å¤§é‡çš„ç¬¬ä¸‰æ–¹jaråŒ…</li>
<li>Tomcatéƒ¨ç½²çš„å·¥ç¨‹è¿‡å¤š</li>
<li>å¤§é‡åŠ¨æ€çš„ç”Ÿæˆåå°„ç±»</li>
</ul>
</li>
<li><p>å…³é—­JVMå°±ä¼šé‡Šæ”¾è¿™ä¸ªåŒºåŸŸçš„å†…å­˜ã€‚</p>
</li>
</ul>
<blockquote>
<p>â³æ¼”è¿›</p>
</blockquote>
<p>JDK7åŠä»¥å‰ï¼Œä¹ æƒ¯ä¸ŠæŠŠæ–¹æ³•åŒºï¼Œç§°ä¸ºæ°¸ä¹…ä»£ã€‚jdk8å¼€å§‹ï¼Œä½¿ç”¨å…ƒç©ºé—´å–ä»£äº†æ°¸ä¹…ä»£ã€‚</p>
<p>JDK8åï¼Œå…ƒç©ºé—´å­˜æ”¾åœ¨å †å¤–å†…å­˜ä¸­</p>
<p>æœ¬è´¨ä¸Šï¼Œæ–¹æ³•åŒºå’Œæ°¸ä¹…ä»£å¹¶ä¸ç­‰ä»·ã€‚ä»…æ˜¯å¯¹hotspotè€Œè¨€çš„ã€‚ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹å¦‚ä½•å®ç°æ–¹æ³•åŒºï¼Œä¸åšç»Ÿä¸€è¦æ±‚ã€‚ä¾‹å¦‚ï¼šBEAJRockit / IBM J9 ä¸­ä¸å­˜åœ¨æ°¸ä¹…ä»£çš„æ¦‚å¿µã€‚</p>
<p>è€Œåˆ°äº†JDK8ï¼Œç»ˆäºå®Œå…¨åºŸå¼ƒäº†æ°¸ä¹…ä»£çš„æ¦‚å¿µï¼Œæ”¹ç”¨ä¸JRockitã€J9ä¸€æ ·åœ¨æœ¬åœ°å†…å­˜ä¸­å®ç°çš„å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰æ¥ä»£æ›¿ã€‚</p>
<p>å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ã€‚ä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´ä¸åœ¨è™šæ‹Ÿæœºè®¾ç½®çš„å†…å­˜ä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚</p>
<p>æ°¸ä¹…ä»£ã€å…ƒç©ºé—´äºŒè€…å¹¶ä¸åªæ˜¯åå­—å˜äº†ï¼Œå†…éƒ¨ç»“æ„ä¹Ÿè°ƒæ•´äº†ã€‚</p>
<p>æ ¹æ®ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„è§„å®šï¼Œå¦‚æœæ–¹æ³•åŒºæ— æ³•æ»¡è¶³æ–°çš„å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œå°†æŠ›å‡ºOOMå¼‚å¸¸ã€‚</p>
<h2 id="8-2-âš™ï¸è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM"><a href="#8-2-âš™ï¸è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM" class="headerlink" title="8.2 âš™ï¸è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM"></a>8.2 âš™ï¸è®¾ç½®æ–¹æ³•åŒºå¤§å°ä¸OOM</h2><p>æ–¹æ³•åŒºçš„å¤§å°æ˜¯ä¸å¿…å›ºå®šçš„ï¼ŒJVMå¯ä»¥æ ¹æ®åº”ç”¨çš„éœ€è¦åŠ¨æ€è°ƒæ•´ã€‚</p>
<blockquote>
<p>7ï¸âƒ£JDK7ä»¥å‰</p>
</blockquote>
<ul>
<li>-XX:Permsizeï¼šè®¾ç½®æ°¸ä¹…ä»£åˆå§‹åˆ†é…ç©ºé—´ï¼ˆé»˜è®¤å€¼æ˜¯20.75Mï¼‰</li>
<li>-XX:MaxPersizeï¼šè®¾ç½®æ°¸ä¹…ä»£æœ€å¤§åˆ†é…ç©ºé—´ï¼ˆ32ä½æœºå™¨é»˜è®¤æ˜¯64Mï¼Œ64ä½æœºå™¨é»˜è®¤æ˜¯82Mï¼‰</li>
<li>å½“JVMåŠ è½½çš„ç±»ä¿¡æ¯å®¹é‡è¶…è¿‡äº†è¿™ä¸ªå€¼ï¼Œä¼šæŠ¥å¼‚å¸¸OutofMemoryErrorã€‚</li>
</ul>
<blockquote>
<p>8ï¸âƒ£JDK8ä»¥å</p>
</blockquote>
<ul>
<li>-XX:MetaspaceSizeï¼šè®¾ç½®å…ƒç©ºé—´åˆå§‹åˆ†é…ç©ºé—´</li>
<li>-XX:MaxMetaspaceSizeï¼šè®¾ç½®å…ƒç©ºé—´æœ€å¤§åˆ†é…ç©ºé—´</li>
<li>é»˜è®¤å€¼ä¾èµ–äºå¹³å°ï¼šWindowsä¸‹ï¼Œå…ƒç©ºé—´åˆå§‹ç©ºé—´21Mï¼Œå…ƒç©ºé—´æœ€å¤§ç©ºé—´-1ï¼Œå³æ²¡æœ‰é™åˆ¶ã€‚</li>
<li>ä¸æ°¸ä¹…ä»£ä¸åŒï¼Œå¦‚æœä¸æŒ‡å®šå¤§å°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰çš„å¯ç”¨ç³»ç»Ÿå†…å­˜ã€‚å¦‚æœå…ƒæ•°æ®åŒºå‘ç”Ÿæº¢å‡ºï¼Œè™šæ‹Ÿæœºä¸€æ ·ä¼šæŠ›å‡ºå¼‚å¸¸OutofMemoryErrorã€‚</li>
<li>å¯¹äºä¸€ä¸ª64ä½çš„æœåŠ¡å™¨ç«¯JVMæ¥è¯´ï¼Œå…¶é»˜è®¤çš„-XX:MetaspaceSizeå€¼ä¸º21MBã€‚è¿™å°±æ˜¯åˆå§‹çš„é«˜æ°´ä½çº¿ï¼Œä¸€æ—¦è§¦åŠè¿™ä¸ªæ°´ä½çº¿ï¼ŒFull GCå°†ä¼šè¢«è§¦å‘å¹¶å¸è½½æ²¡ç”¨çš„ç±»ï¼ˆå³è¿™äº›ç±»å¯¹åº”çš„ç±»åŠ è½½å™¨ä¸å†å­˜æ´»ï¼‰ï¼Œç„¶åè¿™ä¸ªé«˜æ°´ä½çº¿å°†ä¼šé‡ç½®ã€‚æ–°çš„é«˜æ°´ä½çº¿çš„å€¼å–å†³äºGCåé‡Šæ”¾äº†å¤šå°‘å…ƒç©ºé—´ã€‚å¦‚æœé‡Šæ”¾çš„ç©ºé—´ä¸è¶³ï¼Œé‚£ä¹ˆåœ¨ä¸è¶…è¿‡MaxMetaspaceSizeæ—¶ï¼Œé€‚å½“æé«˜è¯¥å€¼ï¼›å¦‚æœé‡Šæ”¾ç©ºé—´è¿‡å¤šï¼Œåˆ™é€‚å½“é™ä½è¯¥å€¼ã€‚</li>
<li>å¦‚æœåˆå§‹åŒ–çš„é«˜æ°´ä½çº¿è®¾ç½®è¿‡ä½ï¼Œä¸Šè¿°é«˜æ°´ä½è°ƒæ•´æƒ…å†µä¼šå‘ç”Ÿå¾ˆå¤šæ¬¡ã€‚é€šè¿‡åƒåœ¾å›æ”¶å™¨çš„æ—¥å¿—å¯ä»¥è§‚å¯Ÿåˆ°Full GCå¤šæ¬¡è°ƒç”¨ã€‚ä¸ºäº†é¿å…é¢‘å‘åœ°GCï¼Œå»ºè®®å°†-XX:MetaspaceSizeè®¾ç½®ä¸ºä¸€ä¸ªç›¸å¯¹è¾ƒé«˜çš„å€¼ã€‚</li>
</ul>
<blockquote>
<p>âœ…è§£å†³OOM</p>
</blockquote>
<ol>
<li>è¦è§£å†³OOMå¼‚å¸¸æˆ–è€…heap spaceçš„å¼‚å¸¸ï¼Œä¸€èˆ¬çš„æ‰‹æ®µæ˜¯é¦–å…ˆé€šè¿‡å†…å­˜æ˜ åƒåˆ†æå·¥å…·ï¼ˆå¦‚Eclipse Memory Analyzerï¼‰å¯¹dumpå‡ºæ¥çš„å †è½¬å‚¨å¿«ç…§è¿›è¡Œåˆ†æï¼Œé‡ç‚¹æ˜¯ç¡®è®¤å†…å­˜ä¸­çš„å¯¹è±¡æ˜¯å¦æ˜¯å¿…è¦çš„ï¼Œä¹Ÿå°±æ˜¯è¦åˆ†æ¸…æ¥šåˆ°åº•æ˜¯å‡ºç°äº†å†…å­˜æ³„éœ²ï¼ˆMemory Leakï¼‰è¿˜æ˜¯å†…å­˜æº¢å‡ºï¼ˆMemory Overflowï¼‰ã€‚</li>
<li>å¦‚æœæ˜¯å†…å­˜æ³„éœ²ï¼Œå¯è¿›ä¸€æ­¥é€šè¿‡å·¥å…·æŸ¥çœ‹æ³„éœ²å¯¹è±¡åˆ°GC Rootsçš„å¼•ç”¨é“¾ã€‚äºæ˜¯å°±èƒ½æ‰¾åˆ°æ³„éœ²å¯¹è±¡æ˜¯é€šè¿‡æ€æ ·çš„è·¯å¾„ä¸GC Rootsç›¸å…³è”å¹¶å¯¼è‡´åƒåœ¾æ”¶é›†å™¨æ— æ³•è‡ªåŠ¨å›æ”¶å®ƒä»¬çš„ã€‚æŒæ¡äº†æ³„éœ²å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ï¼Œä»¥åŠGC Rootså¼•ç”¨é“¾çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥æ¯”è¾ƒå‡†ç¡®åœ°å®šä½å‡ºæ³„éœ²ä»£ç çš„ä½ç½®ã€‚</li>
<li>å¦‚æœä¸å­˜åœ¨å†…å­˜æ³„éœ²ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡ç¡®å®éƒ½è¿˜å¿…é¡»å­˜æ´»ç€ï¼Œé‚£å°±åº”å½“æ£€æŸ¥è™šæ‹Ÿæœºçš„å †å‚æ•°ï¼ˆ-Xmxå’Œ-Xmsï¼‰ï¼Œä¸æœºå™¨ç‰©ç†å†…å­˜å¯¹æ¯”çœ‹æ˜¯å¦è¿˜å¯ä»¥è°ƒå¤§ï¼Œä»ä»£ç ä¸Šæ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸäº›å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè¿‡é•¿ã€æŒæœ‰çŠ¶æ€æ—¶é—´è¿‡é•¿çš„æƒ…å†µï¼Œå°è¯•å‡å°‘ç¨‹åºè¿è¡ŒæœŸçš„å†…å­˜æ¶ˆè€—ã€‚</li>
</ol>
<h2 id="8-3-ğŸ“‚æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„"><a href="#8-3-ğŸ“‚æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„" class="headerlink" title="8.3 ğŸ“‚æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„"></a>8.3 ğŸ“‚æ–¹æ³•åŒºçš„å†…éƒ¨ç»“æ„</h2><blockquote>
<p>ğŸŸ¦å­˜å‚¨</p>
</blockquote>
<p>å­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰ã€‚</p>
<blockquote>
<p>1ï¸âƒ£ç±»å‹ä¿¡æ¯</p>
</blockquote>
<p>å¯¹æ¯ä¸ªåŠ è½½çš„ç±»å‹ï¼ˆç±»classã€æ¥å£interfaceã€æšä¸¾enumã€æ³¨è§£annotationï¼‰ï¼ŒJVMå¿…é¡»åœ¨æ–¹æ³•åŒºä¸­å­˜å‚¨ä»¥ä¸‹ç±»å‹ä¿¡æ¯ï¼š</p>
<ul>
<li>è¿™ä¸ªç±»å‹çš„å®Œæ•´æœ‰æ•ˆåç§°ï¼ˆå…¨å=åŒ…å.ç±»åï¼‰</li>
<li>è¿™ä¸ªç±»å‹ç›´æ¥çˆ¶ç±»çš„å®Œæ•´æœ‰æ•ˆå(å¯¹äºinterfaceæˆ–Objectï¼Œéƒ½æ²¡æœ‰çˆ¶ç±»)</li>
<li>è¿™ä¸ªç±»å‹çš„ä¿®é¥°ç¬¦ï¼ˆpublicã€abstractã€finalçš„æŸä¸ªå­é›†ï¼‰</li>
<li>è¿™ä¸ªç±»å‹ç›´æ¥æ¥å£çš„ä¸€ä¸ªæœ‰åºåˆ—è¡¨</li>
</ul>
<blockquote>
<p>2ï¸âƒ£åŸŸä¿¡æ¯</p>
</blockquote>
<ul>
<li>JVMå¿…é¡»åœ¨æ–¹æ³•åŒºä¿å­˜ç±»å‹çš„æ‰€æœ‰åŸŸç›¸å…³ä¿¡æ¯ä»¥åŠåŸŸçš„å£°æ˜é¡ºåº</li>
<li>åŸŸç›¸å…³ä¿¡æ¯åŒ…æ‹¬ï¼šåŸŸåç§°ã€åŸŸç±»å‹ã€åŸŸä¿®é¥°ç¬¦ï¼ˆpublicã€privateã€protectedã€staticã€finalã€volatileã€transientçš„æŸä¸ªå­é›†ï¼‰</li>
</ul>
<blockquote>
<p>3ï¸âƒ£æ–¹æ³•ä¿¡æ¯</p>
</blockquote>
<p>JVMå¿…é¡»ä¿å­˜æ‰€æœ‰çš„ä»¥ä¸‹ä¿¡æ¯ä»¥åŠå£°æ˜é¡ºåºï¼š</p>
<ul>
<li>æ–¹æ³•åç§°</li>
<li>æ–¹æ³•çš„è¿”å›ç±»å‹</li>
<li>æ–¹æ³•å‚æ•°çš„æ•°é‡å’Œç±»å‹</li>
<li>æ–¹æ³•çš„ä¿®é¥°ç¬¦ï¼ˆpublicã€privateã€protectedã€staticã€finalã€synchronizedã€nativeã€abstractçš„æŸä¸ªå­é›†ï¼‰</li>
<li>æ–¹æ³•çš„å­—èŠ‚ç ã€æ“ä½œæ•°æ ˆã€å±€éƒ¨å˜é‡è¡¨åŠå¤§å°ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰</li>
<li>å¼‚å¸¸è¡¨ï¼ˆabstractå’Œnativeæ–¹æ³•é™¤å¤–ï¼‰<ul>
<li>æ¯ä¸ªå¼‚å¸¸å¤„ç†çš„å¼€å§‹ä½ç½®ã€ç»“æŸä½ç½®ã€ä»£ç å¤„ç†åœ¨ç¨‹åºè®¡æ•°å™¨ä¸­çš„åç§»åœ°å€ã€è¢«æ•è·çš„å¼‚å¸¸ç±»çš„å¸¸é‡æ± ç´¢å¼•</li>
</ul>
</li>
</ul>
<blockquote>
<p>4ï¸âƒ£static no-finalçš„ç±»å˜é‡</p>
</blockquote>
<ul>
<li>é™æ€å˜é‡å’Œç±»å…³è”åœ¨ä¸€èµ·ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œå®ƒä»¬ç§°ä¸ºç±»æ•°æ®åœ¨é€»è¾‘ä¸Šçš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>ç±»å˜é‡è¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ï¼Œå³ä½¿æ²¡æœ‰ç±»å®ä¾‹æ—¶ä¹Ÿå¯ä»¥è®¿é—®ã€‚</li>
</ul>
<blockquote>
<p>5ï¸âƒ£static finalçš„å…¨å±€å˜é‡</p>
</blockquote>
<ul>
<li>å…¨å±€å˜é‡åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šè¢«åˆ†é…ã€‚</li>
</ul>
<blockquote>
<p>è¿è¡Œæ—¶å¸¸é‡æ± ğŸ†šClassæ–‡ä»¶å¸¸é‡æ± </p>
</blockquote>
<ul>
<li>æ–¹æ³•åŒºï¼Œå†…éƒ¨åŒ…å«äº†è¿è¡Œæ—¶å¸¸é‡æ± ã€‚</li>
<li>å­—èŠ‚ç æ–‡ä»¶ï¼Œå†…éƒ¨åŒ…å«äº†Classæ–‡ä»¶å¸¸é‡æ± ã€‚</li>
<li>è¦å¼„æ¸…æ¥šæ–¹æ³•åŒºï¼Œéœ€è¦æ¸…æ¥šClassFileï¼Œå› ä¸ºåŠ è½½ç±»çš„ä¿¡æ¯éƒ½åœ¨æ–¹æ³•åŒºã€‚</li>
<li>éœ€è¦å¼„æ¸…æ¥šæ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œéœ€è¦ç†è§£æ¸…æ¥šClassFileä¸­çš„å¸¸é‡æ± ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“ƒClassæ–‡ä»¶å¸¸é‡æ± </p>
</blockquote>
<p>classæ–‡ä»¶ä¸­é™¤äº†åŒ…å«ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯å°±æ˜¯å¸¸é‡æ± ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚</p>
<p>å­—é¢é‡å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ã€è¢«å£°æ˜ä¸ºfinalçš„å¸¸é‡å€¼ç­‰ã€‚</p>
<p>ç¬¦å·å¼•ç”¨æ—¶ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ï¼Œç¬¦å·å¯ä»¥æ˜¯ä»»ä½•å½¢å¼çš„å­—é¢é‡ï¼Œåªè¦ä½¿ç”¨æ—¶èƒ½æ— æ­§ä¹‰åœ°å®šä½åˆ°ç›®æ ‡å³å¯ã€‚ä¸€èˆ¬åŒ…æ‹¬ä¸‹é¢ä¸‰ç±»å¸¸é‡ï¼š</p>
<ul>
<li>ç±»å’Œæ¥å£çš„å…¨é™å®šå</li>
<li>å­—æ®µçš„åç§°å’Œæè¿°ç¬¦</li>
<li>æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦</li>
</ul>
<blockquote>
<p>ğŸ“ƒè¿è¡Œæ—¶å¸¸é‡æ± </p>
</blockquote>
<ul>
<li>è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>å¸¸é‡æ± è¡¨ç¤ºClassæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ä¸ç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚</li>
<li>è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œåœ¨åŠ è½½ç±»å’Œæ¥å£åˆ°è™šæ‹Ÿæœºåï¼Œå°±ä¼šåˆ›å»ºå¯¹åº”çš„è¿è¡Œæ—¶å¸¸é‡æ± ã€‚</li>
<li>JVMä¸ºæ¯ä¸ªå·²åŠ è½½çš„ç±»å‹ï¼ˆç±»æˆ–æ¥å£ï¼‰éƒ½ç»´æŠ¤ä¸€ä¸ªå¸¸é‡æ± ã€‚æ± ä¸­çš„æ•°æ®é¡¹åƒæ•°æ®é¡¹ä¸€æ ·ï¼Œæ˜¯é€šè¿‡ç´¢å¼•è®¿é—®çš„ã€‚</li>
<li>è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å†…å«å¤šç§ä¸åŒçš„å¸¸é‡ï¼ŒåŒ…æ‹¬ç¼–è¯‘æœŸå°±å·²ç»æ˜ç¡®çš„æ•°å€¼å­—é¢é‡ï¼Œä¹ŸåŒ…æ‹¬åˆ°è¿è¡ŒæœŸè§£æåæ‰èƒ½å¤Ÿè·å¾—çš„æ–¹æ³•æˆ–è€…å­—æ®µå¼•ç”¨ã€‚æ­¤æ—¶ä¸å†æ˜¯å¸¸é‡æ± ä¸­çš„ç¬¦å·åœ°å€ï¼Œè¿™é‡Œæ¢ä¸ºçœŸå®åœ°å€ã€‚<ul>
<li>è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œç›¸å¯¹äºClassæ–‡ä»¶å¸¸é‡æ± çš„å¦ä¸€ç§é‡è¦ç‰¹å¾æ˜¯ï¼šå…·å¤‡åŠ¨æ€æ€§ã€‚</li>
</ul>
</li>
<li>è¿è¡Œæ—¶å¸¸é‡æ± ç±»ä¼¼äºä¼ ç»Ÿç¼–ç¨‹è¯­è¨€ä¸­çš„ç¬¦å·è¡¨ï¼Œä½†æ˜¯å®ƒæ‰€åŒ…å«çš„æ•°æ®å´æ¯”ç¬¦å·è¡¨è¦æ›´åŠ ä¸°å¯Œä¸€äº›ã€‚</li>
<li>å½“åˆ›å»ºç±»æˆ–æ¥å£çš„è¿è¡Œæ—¶å¸¸é‡æ± æ—¶ï¼Œå¦‚æœæ„é€ è¿è¡Œæ—¶å¸¸é‡æ± æ‰€éœ€çš„å†…å­˜ç©ºé—´è¶…è¿‡äº†æ–¹æ³•åŒºæ‰€èƒ½æä¾›çš„æœ€å¤§å€¼ï¼Œåˆ™JVMä¼šæŠ›å‡ºOOMå¼‚å¸¸ã€‚</li>
</ul>
<blockquote>
<p>ğŸ”°æ€»ç»“</p>
</blockquote>
<ul>
<li>Classæ–‡ä»¶å¸¸é‡æ± æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™æ¯ä¸ªclasså°±æœ‰çš„ï¼Œå­˜æ”¾çš„æ˜¯å¸¸é‡å’Œç¬¦å·å¼•ç”¨ã€‚</li>
<li>è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯åœ¨ç±»åŠ è½½å®Œæˆä¹‹åï¼Œå°†æ¯ä¸ªClassæ–‡ä»¶å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨å€¼è½¬å­˜åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œ</li>
</ul>
<h2 id="8-4-âŒ¨ï¸-æ–¹æ³•åŒºçš„ä½¿ç”¨ä¸¾ä¾‹"><a href="#8-4-âŒ¨ï¸-æ–¹æ³•åŒºçš„ä½¿ç”¨ä¸¾ä¾‹" class="headerlink" title="8.4 âŒ¨ï¸ æ–¹æ³•åŒºçš„ä½¿ç”¨ä¸¾ä¾‹"></a>8.4 âŒ¨ï¸ æ–¹æ³•åŒºçš„ä½¿ç”¨ä¸¾ä¾‹</h2><h2 id="8-5-ğŸ”­-æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚"><a href="#8-5-ğŸ”­-æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚" class="headerlink" title="8.5 ğŸ”­ æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚"></a>8.5 ğŸ”­ æ–¹æ³•åŒºçš„æ¼”è¿›ç»†èŠ‚</h2><blockquote>
<p>ã€°å¦‚ä¸‹</p>
</blockquote>
<ol>
<li>é¦–å…ˆæ˜ç¡®ã€‚åªæœ‰HotSpotæ‰æœ‰æ°¸ä¹…ä»£ã€‚BEA JRockitã€IBM J9ç­‰ä¸å­˜åœ¨æ°¸ä¹…ä»£ã€‚åŸåˆ™ä¸Šå¦‚ä½•å®ç°æ–¹æ³•åŒºå±äºè™šæ‹Ÿæœºå®ç°ç»†èŠ‚ï¼Œä¸å—ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ç®¡æŸï¼Œå¹¶ä¸è¦æ±‚ç»Ÿä¸€ã€‚</li>
<li>HotSpotä¸­æ–¹æ³•åŒºçš„å˜åŒ–ï¼š</li>
</ol>
<table>
<thead>
<tr>
<th>ç‰ˆæœ¬</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>JDK1.6åŠä¹‹å‰</td>
<td>æœ‰æ°¸ä¹…ä»£ã€‚é™æ€å˜é‡å­˜æ”¾åœ¨æ°¸ä¹…ä»£ä¸Šã€‚</td>
</tr>
<tr>
<td>JDK1.7</td>
<td>æœ‰æ°¸ä¹…ä»£ï¼Œä½†å·²ç»é€æ­¥â€œå»æ°¸ä¹…ä»£â€ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ç§»é™¤ï¼Œä¿å­˜åœ¨å †ä¸­ã€‚</td>
</tr>
<tr>
<td>JDK1.8åŠä¹‹å</td>
<td>æ— æ°¸ä¹…ä»£ï¼Œç±»å‹ä¿¡æ¯ã€å­—æ®µã€æ–¹æ³•ã€å¸¸é‡ä¿å­˜åœ¨æœ¬åœ°å†…å­˜çš„å…ƒç©ºé—´ï¼Œä½†å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ä»ç„¶åœ¨å †ä¸­ã€‚</td>
</tr>
</tbody></table>
<blockquote>
<p>â“ä¸ºä»€ä¹ˆæ°¸ä¹…ä»£è¦è¢«å…ƒç©ºé—´æ›¿ä»£</p>
</blockquote>
<p>JRockitæ˜¯å’ŒHotSpotèåˆåçš„ç»“æœï¼Œå› ä¸ºJRockitæ²¡æœ‰æ°¸ä¹…ä»£ï¼Œæ‰€ä»¥ä»–ä»¬ä¸éœ€è¦é…ç½®æ°¸ä¹…ä»£ã€‚</p>
<p>éšç€Java8çš„åˆ°æ¥ï¼ŒHotSpot VMä¸­å†ä¹Ÿè§ä¸åˆ°æ°¸ä¹…ä»£äº†ã€‚ä½†æ˜¯è¿™å¹¶ä¸æ„å‘³ç€ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ä¹Ÿæ¶ˆå¤±äº†ã€‚è¿™äº›æ•°æ®è¢«ç§»åˆ°äº†ä¸€ä¸ªä¸å †ä¸ç›¸è¿çš„æœ¬åœ°å†…å­˜åŒºåŸŸï¼Œè¿™ä¸ªåŒºåŸŸå«åšå…ƒç©ºé—´ï¼ˆMetaspaceï¼‰ã€‚</p>
<p>ç”±äºç±»çš„å…ƒæ•°æ®åˆ†é…åœ¨æœ¬åœ°å†…å­˜ä¸­ã€‚å…ƒç©ºé—´çš„æœ€å¤§å¯åˆ†é…ç©ºé—´å°±æ˜¯ç³»ç»Ÿå¯ç”¨å†…å­˜ç©ºé—´ï¼Œè¿™é¡¹æ”¹åŠ¨æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼ŒåŸå› æœ‰ï¼š</p>
<p>ï¼ˆ1ï¼‰ä¸ºæ°¸ä¹…ä»£è®¾ç½®ç©ºé—´å¤§å°æ˜¯å¾ˆéš¾ç¡®å®šçš„ã€‚</p>
<p>åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¦‚æœåŠ¨æ€åŠ è½½ç±»è¿‡å¤šï¼Œå®¹æ˜“äº§ç”ŸPermåŒºï¼ˆæ°¸ä¹…ä»£ï¼‰çš„OOMã€‚</p>
<p>å…ƒç©ºé—´å’Œæ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼šå…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶ã€‚</p>
<p>ï¼ˆ2ï¼‰å¯¹æ°¸ä¹…ä»£è¿›è¡Œè°ƒä¼˜æ˜¯å¾ˆå›°éš¾çš„ã€‚</p>
<p>ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹å¯¹æ–¹æ³•åŒºçš„çº¦æŸæ˜¯éå¸¸å®½æ¾çš„ï¼Œæåˆ°è¿‡å¯ä»¥ä¸è¦æ±‚è™šæ‹Ÿæœºåœ¨æ–¹æ³•åŒºä¸­å®ç°åƒåœ¾æ”¶é›†ã€‚äº‹å®ä¸Šä¹Ÿç¡®å®æœ‰æœªå®ç°æˆ–æœªèƒ½å®Œæ•´å®ç°æ–¹æ³•åŒºç±»å‹å¸è½½çš„æ”¶é›†å™¨å­˜åœ¨ï¼ˆå¦‚JDK11æ—¶æœŸçš„ZGCæ”¶é›†å™¨å°±ä¸æ”¯æŒç±»å¸è½½ï¼‰ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´è¿™ä¸ªåŒºåŸŸçš„å›æ”¶æ•ˆæœæ¯”è¾ƒä»¤äººéš¾ä»¥æ»¡æ„ï¼Œå°¤å…¶æ˜¯ç±»å‹çš„å¸è½½ï¼Œæ¡ä»¶ç›¸å½“è‹›åˆ»ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†åŒºåŸŸçš„å›æ”¶æœ‰æ—¶åˆç¡®å®æ˜¯å¿…è¦çš„ã€‚ä»¥å‰Sunå…¬å¸çš„Bugåˆ—è¡¨ä¸­ï¼Œæ›¾å‡ºç°è¿‡çš„è‹¥å¹²ä¸ªä¸¥é‡çš„Bugå°±æ˜¯ç”±äºä½ç‰ˆæœ¬çš„HotSpotè™šæ‹Ÿæœºå¯¹æ­¤åŒºåŸŸæœªå®Œå…¨å›æ”¶è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p>
<p>æ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†ä¸»è¦æ”¶é›†ä¸¤éƒ¨åˆ†å†…å®¹ï¼šå¸¸é‡æ± ä¸­åºŸå¼ƒçš„å¸¸é‡å’Œä¸å†ä½¿ç”¨çš„ç±»å‹ã€‚</p>
<blockquote>
<p>â“ä¸ºä»€ä¹ˆStringTableè°ƒæ•´ä½ç½®</p>
</blockquote>
<p>JDK7ä¸­å°†StringTableæ”¾åˆ°äº†å †ç©ºé—´ä¸­ã€‚å› ä¸ºæ°¸ä¹…ä»£çš„å›æ”¶æ•ˆç‡å¾ˆä½ï¼Œåœ¨full gcçš„æ—¶å€™æ‰ä¼šè§¦å‘ã€‚è€Œfull gcæ˜¯è€å¹´ä»£çš„ç©ºé—´ä¸è¶³ã€æ°¸ä¹…ä»£ä¸è¶³æ—¶æ‰ä¼šè§¦å‘ï¼Œè¿™å°±å¯¼è‡´StringTableå›æ”¶æ•ˆç‡ä¸é«˜ã€‚</p>
<p>è€Œæˆ‘ä»¬å¼€å‘ä¸­ä¼šæœ‰å¤§é‡çš„å­—ç¬¦ä¸²è¢«åˆ›å»ºï¼Œå›æ”¶æ•ˆç‡ä½ï¼Œå¯¼è‡´æ°¸ä¹…ä»£å†…å­˜ä¸è¶³ã€‚æ”¾åˆ°å †é‡Œï¼Œèƒ½åŠæ—¶å›æ”¶å†…å­˜ã€‚</p>
<h2 id="8-6-â™»-æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶"><a href="#8-6-â™»-æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶" class="headerlink" title="8.6 â™» æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶"></a>8.6 â™» æ–¹æ³•åŒºçš„åƒåœ¾å›æ”¶</h2><blockquote>
<p>ğŸ“–æ¦‚è¿°</p>
</blockquote>
<ul>
<li>åˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦åºŸå¼ƒè¿˜æ˜¯ç›¸å¯¹ç®€å•ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»å‹æ˜¯å¦å±äºâ€œä¸å†è¢«ä½¿ç”¨çš„ç±»â€çš„æ¡ä»¶å°±æ¯”è¾ƒè‹›åˆ»äº†ã€‚éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ï¼š</li>
</ul>
<ol>
<li><ol>
<li>è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯Javaå †ä¸­ä¸å­˜åœ¨è¯¥ç±»åŠå…¶ä»»ä½•æ´¾ç”Ÿå­ç±»çš„å®ä¾‹ã€‚</li>
<li>åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶ï¼Œè¿™ä¸ªæ¡ä»¶é™¤éæ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„å¯æ›¿æ¢ç±»åŠ è½½å™¨çš„åœºæ™¯ï¼Œå¦‚OSGIã€JSPçš„é‡åŠ è½½ç­‰ï¼Œå¦åˆ™é€šå¸¸æ˜¯å¾ˆéš¾è¾¾æˆçš„ã€‚</li>
<li>è¯¥ç±»å¯¹åº”çš„java.lang.Classå¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹åŒ–è¢«å¼•ç”¨ï¼Œæ— æ³•å†ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚</li>
</ol>
</li>
</ol>
<ul>
<li>Javaè™šæ‹Ÿæœºè¢«å…è®¸å¯¹æ»¡è¶³ä¸Šè¿°æ¡ä»¶çš„æ— ç”¨ç±»è¿›è¡Œå›æ”¶ï¼Œè¿™é‡Œè¯´çš„ä»…ä»…æ˜¯â€œè¢«å…è®¸â€ï¼Œè€Œå¹¶ä¸æ˜¯å’Œå¯¹è±¡ä¸€æ ·ï¼Œæ²¡æœ‰å¼•ç”¨äº†å°±å¿…ç„¶ä¼šå›æ”¶ã€‚å…³äºæ˜¯å¦è¦å¯¹ç±»å‹è¿›è¡Œå›æ”¶ï¼ŒHotSpotè™šæ‹Ÿæœºæä¾›äº†-Xnoclassgcå‚æ•°è¿›è¡Œæ§åˆ¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨-verbose:classä»¥åŠ-XX:+TranClass-Loadingã€-XX:+TraceClassUnLoadingæŸ¥çœ‹ç±»åŠ è½½å’Œå¸è½½ä¿¡æ¯ã€‚</li>
<li>åœ¨å¤§é‡ä½¿ç”¨åå°„ã€åŠ¨æ€ä»£ç†ã€CGLIBç­‰å­—èŠ‚ç æ¡†æ¶ï¼ŒåŠ¨æ€ç”ŸæˆJSPä»¥åŠOSGIè¿™ç±»é¢‘ç¹è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„åœºæ™¯ä¸­ï¼Œé€šå¸¸éƒ½éœ€è¦Javaè™šæ‹Ÿæœºå…·å¤‡ç±»å‹å¸è½½èƒ½åŠ›ï¼Œä»¥ä¿è¯ä¸ä¼šå¯¹æ–¹æ³•åŒºé€ æˆè¿‡å¤§çš„å†…å­˜å‹åŠ›ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-7(å †)</title>
    <url>/posts/11581/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="7-1-ğŸ“š-æ¦‚è¿°"><a href="#7-1-ğŸ“š-æ¦‚è¿°" class="headerlink" title="7.1 ğŸ“š æ¦‚è¿°"></a>7.1 ğŸ“š æ¦‚è¿°</h2><blockquote>
<p>ğŸ“–å®šä¹‰</p>
</blockquote>
<p>æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½åº”å½“åœ¨è¿è¡Œæ—¶åˆ†é…åœ¨å †ä¸Šã€‚</p>
<blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>æ•°ç»„å’Œå¯¹è±¡å¯èƒ½æ°¸è¿œä¸ä¼šå­˜å‚¨åœ¨æ ˆä¸Šï¼Œå› ä¸ºæ ˆå¸§ä¸­ä¿å­˜å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨æŒ‡å‘å¯¹è±¡æˆ–è€…æ•°ç»„åœ¨å †ä¸­çš„ä½ç½®ã€‚</li>
<li>åœ¨æ–¹æ³•ç»“æŸåï¼Œå †ä¸­çš„å¯¹è±¡ä¸ä¼šé©¬ä¸Šè¢«ç§»é™¤ï¼Œä»…ä»…åœ¨åƒåœ¾æ”¶é›†çš„æ—¶å€™æ‰ä¼šè¢«ç§»é™¤ã€‚</li>
<li>å †ï¼Œæ˜¯GCï¼ˆGarbage Collectionï¼Œåƒåœ¾æ”¶é›†å™¨ï¼‰æ‰§è¡Œåƒåœ¾å›æ”¶çš„é‡ç‚¹åŒºåŸŸã€‚</li>
<li>ä¸€ä¸ªJVMå®ä¾‹åªå­˜åœ¨ä¸€ä¸ªå †å†…å­˜ï¼Œå †ä¹Ÿæ˜¯Javaå†…å­˜ç®¡ç†çš„æ ¸å¿ƒåŒºåŸŸã€‚</li>
<li>Javaå †åŒºåœ¨JVMå¯åŠ¨çš„æ—¶å€™å³è¢«åˆ›å»ºï¼Œå…¶ç©ºé—´å¤§å°ä¹Ÿå°±ç¡®å®šäº†ï¼Œæ˜¯JVMç®¡ç†çš„æœ€å¤§ä¸€å—å†…å­˜ç©ºé—´ï¼ˆå †å†…å­˜çš„å¤§å°æ˜¯å¯ä»¥è°ƒèŠ‚çš„ï¼‰ã€‚</li>
<li>å †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œä½†åœ¨é€»è¾‘ä¸Šå®ƒåº”è¯¥è¢«è§†ä¸ºè¿ç»­çš„ã€‚</li>
<li>æ‰€æœ‰çš„çº¿ç¨‹å…±äº«Javaå †ï¼Œåœ¨è¿™é‡Œè¿˜å¯ä»¥åˆ’åˆ†çº¿ç¨‹ç§æœ‰çš„ç¼“å†²åŒºï¼ˆThread Local Allocation Bufferï¼ŒTLABï¼‰ã€‚</li>
</ul>
<blockquote>
<p>âœ‚ï¸å†…å­˜ç»†åˆ†</p>
</blockquote>
<p><strong>ç°ä»£åƒåœ¾æ”¶é›†å™¨å¤§éƒ¨åˆ†éƒ½åŸºäºåˆ†ä»£æ”¶é›†ç†è®ºè®¾è®¡</strong></p>
<p>Java 7åŠä¹‹å‰ï¼š</p>
<table>
<thead>
<tr>
<th>ä¸­æ–‡</th>
<th>æ´‹æ–‡</th>
<th>ç®€ç§°</th>
</tr>
</thead>
<tbody><tr>
<td>æ–°ç”ŸåŒº</td>
<td>Young Generation Sapce</td>
<td>Young (Eden + Survivor)</td>
</tr>
<tr>
<td>å…»è€åŒº</td>
<td>Tenure Generation Space</td>
<td>Old</td>
</tr>
<tr>
<td>æ°¸ä¹…åŒº</td>
<td>Permanent Space</td>
<td>Perm</td>
</tr>
</tbody></table>
<p>Java 8åŠä¹‹å</p>
<table>
<thead>
<tr>
<th>ä¸­æ–‡</th>
<th>æ´‹æ–‡</th>
<th>ç®€ç§°</th>
</tr>
</thead>
<tbody><tr>
<td>æ–°ç”ŸåŒº</td>
<td>Young Generation Sapce</td>
<td>Young (Eden + Survivor)</td>
</tr>
<tr>
<td>å…»è€åŒº</td>
<td>Tenure Generation Space</td>
<td>Old</td>
</tr>
<tr>
<td>å…ƒç©ºé—´</td>
<td>Meta Space</td>
<td>Meta</td>
</tr>
</tbody></table>
<p>çº¦å®šï¼šæ–°ç”ŸåŒºâ†”ï¸æ–°ç”Ÿä»£â†”ï¸å¹´è½»ä»£  å…»è€åŒºâ†”ï¸è€å¹´åŒºâ†”ï¸è€å¹´ä»£  æ°¸ä¹…åŒºâ†”ï¸æ°¸ä¹…ä»£</p>
<h2 id="7-2-âš™ï¸-è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM"><a href="#7-2-âš™ï¸-è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM" class="headerlink" title="7.2 âš™ï¸ è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM"></a>7.2 âš™ï¸ è®¾ç½®å †å†…å­˜å¤§å°ä¸OOM</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>Javaå †åŒºç”¨äºå­˜å‚¨Javaå¯¹è±¡å®ä¾‹ï¼Œé‚£ä¹ˆå †çš„å¤§å°åœ¨JVMå¯åŠ¨æ—¶å°±å·²ç»è®¾å®šå¥½äº†ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡é€‰é¡¹<code>-Xms</code>å’Œ<code>-Xms</code>æ¥è¿›è¡Œè®¾ç½®ã€‚<ul>
<li><code>-Xms</code>ï¼šç”¨äºè¡¨ç¤ºå †åŒºçš„èµ·å§‹å†…å­˜ï¼Œç­‰ä»·äº<code>-XX:InitialHeapSize</code></li>
<li><code>-Xmx</code>ï¼šç”¨äºè¡¨ç¤ºå †åŒºçš„æœ€å¤§å†…å­˜ï¼Œç­‰ä»·äº<code>-XX:MaxHeapSize</code></li>
</ul>
</li>
<li>ä¸€æ—¦å †åŒºä¸­çš„å†…å­˜å¤§å°è¶…è¿‡<code>-Xmx</code>æ‰€æŒ‡å®šçš„æœ€å¤§å†…å­˜æ—¶ï¼Œå°†ä¼šæŠ›å‡º<code>OutOfMemoryError</code>å¼‚å¸¸ã€‚</li>
<li>é€šå¸¸ä¼šå°†<code>-Xms</code>å’Œ<code>-Xmx</code>ä¸¤ä¸ªå‚æ•°é…ç½®ç›¸åŒçš„å€¼ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨Javaåƒåœ¾å›æ”¶æœºåˆ¶æ¸…ç†å®Œå †åŒºåä¸éœ€è¦é‡æ–°åˆ†éš”è®¡ç®—å †åŒºçš„å¤§å°ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹<ul>
<li>åˆå§‹å†…å­˜å¤§å° = ç‰©ç†ç”µè„‘å†…å­˜å¤§å° / 64</li>
<li>æœ€å¤§å†…å­˜å¤§å° = ç‰©ç†ç”µè„‘å†…å­˜å¤§å° / 4</li>
</ul>
</li>
<li>æŸ¥çœ‹è®¾ç½®å‚æ•°<ul>
<li>æ–¹å¼ä¸€ï¼š<code>jps</code>  +  <code>jstat -gc &lt;è¿›ç¨‹ID&gt;</code></li>
<li>æ–¹å¼äºŒï¼š<code>-XX:PrintGCDetails</code></li>
</ul>
</li>
</ul>
<h2 id="7-3-ğŸ§šâ€â™‚ï¸-å¹´è½»ä»£ä¸è€å¹´ä»£"><a href="#7-3-ğŸ§šâ€â™‚ï¸-å¹´è½»ä»£ä¸è€å¹´ä»£" class="headerlink" title="7.3 ğŸ§šâ€â™‚ï¸ å¹´è½»ä»£ä¸è€å¹´ä»£"></a>7.3 ğŸ§šâ€â™‚ï¸ å¹´è½»ä»£ä¸è€å¹´ä»£</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>å­˜å‚¨åœ¨JVMä¸­çš„Javaå¯¹è±¡å¯ä»¥è¢«åˆ’åˆ†ä¸ºä¸¤ç±»ï¼š<ul>
<li>ä¸€ç±»æ˜¯ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ç¬æ—¶å¯¹è±¡ï¼Œè¿™ç±»å¯¹è±¡çš„åˆ›å»ºå’Œæ¶ˆäº¡éƒ½éå¸¸è¿…é€Ÿã€‚</li>
<li>å¦å¤–ä¸€ç±»å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå´éå¸¸é•¿ï¼Œåœ¨æŸäº›æç«¯çš„æƒ…å†µä¸‹è¿˜èƒ½å¤Ÿä¸JVMçš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ã€‚</li>
</ul>
</li>
<li>Javaå †åŒºè¿›ä¸€æ­¥ç»†åˆ†çš„è¯ï¼Œå¯ä»¥åˆ’åˆ†ä¸ºå¹´è½»ä»£ï¼ˆYoungGenï¼‰å’Œè€å¹´ä»£ï¼ˆOldGenï¼‰ã€‚</li>
<li>å…¶ä¸­å¹´è½»ä»£åˆå¯ä»¥åˆ’åˆ†ä¸ºEdenç©ºé—´ã€Survior0ç©ºé—´å’ŒSurvivor1ç©ºé—´ï¼ˆæœ‰æ—¶ä¹Ÿå«åšfromåŒºã€toåŒºï¼‰ã€‚</li>
<li>åœ¨HotSpotä¸­ï¼ŒEdenåŒºå’Œå¦å¤–ä¸¤ä¸ªSurvivorç©ºé—´ç¼ºçœæ¯”ä¾‹æ˜¯8:1:1ã€‚</li>
<li>å‡ ä¹æ‰€æœ‰çš„Javaå¯¹è±¡éƒ½æ˜¯åœ¨EdenåŒºè¢«newå‡ºæ¥çš„ï¼Œç»å¤§éƒ¨åˆ†çš„Javaå¯¹è±¡çš„é”€æ¯éƒ½åœ¨æ–°ç”Ÿä»£è¿›è¡Œäº†ã€‚IBMå…¬å¸çš„ä¸“é—¨ç ”ç©¶è¡¨æ˜ï¼Œæ–°ç”Ÿä»£ä¸­80%çš„å¯¹è±¡éƒ½æ˜¯æœç”Ÿå¤•æ­»çš„ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“·å›¾ç¤º</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/image-20210206152459643.png" class="" title="image-20210206152459643">



<blockquote>
<p>ğŸ’ é…ç½®</p>
</blockquote>
<p>é…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”ã€‚</p>
<ul>
<li><p><code>-Xmn</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£æœ€å¤§å†…å­˜å¤§å°</p>
</li>
<li><p><code>-XX:NewRatio=x</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£å æ•´ä¸ªå †çš„1/(x+1)ï¼Œè€å¹´ä»£å æ•´ä¸ªå †çš„x/(x+1)ã€‚ï¼ˆé»˜è®¤å€¼æ˜¯2ï¼‰</p>
</li>
<li><p><code>-XX:SurvivorRatio</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£ä¸­EdenåŒºä¸SurvivoråŒºçš„æ¯”ä¾‹ã€‚ï¼ˆé»˜è®¤å€¼æ˜¯8ï¼‰</p>
</li>
<li><p><code>-XX:UseAdaptiveSizePolicy</code>ï¼šå…³é—­è‡ªé€‚åº”çš„å†…å­˜åˆ†é…ç­–ç•¥ã€‚ï¼ˆæš‚æ—¶ç”¨ä¸åˆ°ï¼‰</p>
</li>
</ul>
<h2 id="7-4-ğŸ“·-å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹"><a href="#7-4-ğŸ“·-å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹" class="headerlink" title="7.4 ğŸ“· å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹"></a>7.4 ğŸ“· å›¾è§£å¯¹è±¡åˆ†é…è¿‡ç¨‹</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>ä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜æ˜¯ä¸€ä»¶éå¸¸ä¸¥è°¨å’Œå¤æ‚çš„ä»»åŠ¡ã€‚JVMçš„è®¾è®¡è€…ä»¬ä¸ä»…éœ€è¦è€ƒè™‘å†…å­˜å¦‚ä½•åˆ†é…ã€åœ¨å“ªé‡Œåˆ†é…ç­‰é—®é¢˜ï¼Œå¹¶ä¸”ç”±äºå†…å­˜åˆ†é…ç®—æ³•ä¸å†…å­˜å›æ”¶ç®—æ³•å¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥è¿˜éœ€è¦è€ƒè™‘GCæ‰§è¡Œå®Œå†…å­˜å›æ”¶åæ˜¯å¦ä¼šåœ¨å†…å­˜ç©ºé—´ä¸­äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚</p>
<blockquote>
<p>â³è¿‡ç¨‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/image-20210206235400990.png" class="" title="image-20210206235400990">

<ol>
<li>newçš„å¯¹è±¡å…ˆæ”¾åœ¨ä¼Šç”¸å›­åŒºï¼Œæ­¤åŒºæœ‰å¤§å°é™åˆ¶ã€‚</li>
<li>å½“ä¼Šç”¸å›­åŒºçš„ç©ºé—´å¡«æ»¡æ—¶ï¼Œç¨‹åºåˆéœ€è¦åˆ›å»ºå¯¹è±¡ï¼ŒJVMçš„åƒåœ¾å›æ”¶å™¨å°†å¯¹ä¼Šç”¸å›­è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå°†ä¼Šç”¸å›­åŒºä¸­çš„ä¸å†è¢«å…¶ä»–å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œé”€æ¯ã€‚å†åŠ è½½æ–°çš„å¯¹è±¡æ”¾åˆ°ä¼Šç”¸å›­åŒºã€‚</li>
<li>ç„¶åå°†ä¼Šç”¸å›­åŒºçš„å‰©ä½™å¯¹è±¡ç§»åŠ¨åˆ°å¹¸å­˜è€…0åŒºã€‚</li>
<li>å¦‚æœå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¸Šæ¬¡å¹¸å­˜ä¸‹æ¥çš„æ”¾åˆ°å¹¸å­˜è€…0åŒºï¼Œå¦‚æœæ²¡æœ‰å›æ”¶ï¼Œå°±ä¼šæ”¾åˆ°å¹¸å­˜è€…1åŒºã€‚</li>
<li>å¦‚æœå†æ¬¡ç»å†åƒåœ¾å›æ”¶ï¼Œæ­¤æ—¶ä¼šé‡æ–°æ”¾å›å¹¸å­˜è€…0åŒºï¼Œæ¥ç€å†å»å¹¸å­˜è€…1åŒºã€‚</li>
<li>è‡³äºå•¥æ—¶å€™å»å…»è€åŒºï¼Œå¯ä»¥è®¾ç½®æ¬¡æ•°ã€‚é»˜è®¤æ˜¯15æ¬¡ã€‚</li>
<li>åœ¨å…»è€åŒºï¼Œç›¸å¯¹æ‚ é—²ã€‚å½“å…»è€åŒºå†…å­˜ä¸è¶³æ—¶ï¼Œå†æ¬¡è§¦å‘GC: Major GCï¼Œè¿›è¡Œå…»è€åŒºçš„å†…å­˜æ¸…ç†ã€‚</li>
<li>è‹¥å…»è€åŒºæ‰§è¡Œäº†Major GCä¹‹åå‘ç°ä¾ç„¶æ— æ³•è¿›è¡Œå¯¹è±¡çš„ä¿å­˜ï¼Œå°±ä¼šäº§ç”ŸOOMå¼‚å¸¸ã€‚</li>
</ol>
<blockquote>
<p>ğŸ”¬å›¾è§£</p>
</blockquote>
<p>æˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡ï¼Œä¸€èˆ¬éƒ½æ˜¯å­˜æ”¾åœ¨EdenåŒºçš„ï¼Œå½“æˆ‘ä»¬EdenåŒºæ»¡äº†åï¼Œå°±ä¼šè§¦å‘GCæ“ä½œï¼Œä¸€èˆ¬è¢«ç§°ä¸º YGC / Minor GC æ“ä½œã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/image-20210206235609719.png" class="" title="image-20210206235609719">

<p>å½“æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†åï¼Œçº¢è‰²çš„å°†ä¼šè¢«å›æ”¶ï¼Œè€Œç»¿è‰²çš„è¿˜ä¼šè¢«å ç”¨ç€ï¼Œå­˜æ”¾åœ¨S0(Survivor From)åŒºã€‚åŒæ—¶æˆ‘ä»¬ç»™æ¯ä¸ªå¯¹è±¡è®¾ç½®äº†ä¸€ä¸ªå¹´é¾„è®¡æ•°å™¨ï¼Œä¸€æ¬¡å›æ”¶åå°±æ˜¯1ã€‚</p>
<p>åŒæ—¶EdenåŒºç»§ç»­å­˜æ”¾å¯¹è±¡ï¼Œå½“EdenåŒºå†æ¬¡å­˜æ»¡çš„æ—¶å€™ï¼Œåˆä¼šè§¦å‘ä¸€ä¸ªMinor GCæ“ä½œï¼Œæ­¤æ—¶GCå°†ä¼šæŠŠEdenå’ŒS0(Survivor From)ä¸­çš„å¯¹è±¡è¿›è¡Œä¸€æ¬¡æ”¶é›†ï¼ŒæŠŠå­˜æ´»çš„å¯¹è±¡æ”¾åˆ° S1(Survivor To)AåŒºï¼ŒåŒæ—¶è®©å¹´é¾„ + 1ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/image-20210206235625078.png" class="" title="image-20210206235625078">

<p>æˆ‘ä»¬ç»§ç»­ä¸æ–­çš„è¿›è¡Œå¯¹è±¡ç”Ÿæˆå’Œåƒåœ¾å›æ”¶ï¼Œå½“Survivorä¸­çš„å¯¹è±¡çš„å¹´é¾„è¾¾åˆ°15çš„æ—¶å€™ï¼Œå°†ä¼šè§¦å‘ä¸€æ¬¡ Promotionæ™‹å‡çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯å°†å¹´è½»ä»£ä¸­çš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/image-20210206235645912.png" class="" title="image-20210206235645912">



<blockquote>
<p>â“æ€è€ƒ</p>
</blockquote>
<p>å½“ä¼Šç”¸å›­åŒºæ»¡äº†ä¹‹åä¼šè§¦å‘Minor GCï¼Œé‚£ä¹ˆå¹¸å­˜è€…åŒºæ»¡äº†ä¹‹åä¼šè§¦å‘Minor GCå—ï¼Ÿ</p>
<p>è§£æï¼š</p>
<p>å¹¸å­˜è€…åŒºæ»¡äº†ä¹‹åä¸ä¼šè§¦å‘Minor GCï¼Œä½†æ˜¯ä¼šè§¦å‘ä¸€äº›ç‰¹æ®Šçš„è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯å¯èƒ½ç›´æ¥æ™‹å‡è€å¹´ä»£ã€‚</p>
<p>å¹´é¾„å°äº15ç”šè‡³æ–°çš„å¯¹è±¡éƒ½å¯èƒ½ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚</p>
<blockquote>
<p>ğŸŒˆæ€»ç»“</p>
</blockquote>
<ul>
<li>é’ˆå¯¹å¹¸å­˜è€…S0å’ŒS1åŒºï¼šå¤åˆ¶ä¹‹åæœ‰äº¤æ¢ï¼Œè°ç©ºè°æ˜¯to</li>
<li>å…³äºåƒåœ¾å›æ”¶ï¼šé¢‘ç¹åœ¨æ–°ç”ŸåŒºæ”¶é›†ï¼Œå¾ˆå°‘åœ¨å…»è€åŒºæ”¶é›†ï¼Œå‡ ä¹ä¸åœ¨æ°¸ä¹…åŒº/å…ƒç©ºé—´æ”¶é›†ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“Šç‰¹æ®Šæƒ…å†µ</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/image-20200707091058346.png" class="" title="image-20200707091058346">



<blockquote>
<p>âŒ¨ï¸ç¤ºä¾‹</p>
</blockquote>
<p>ä¸æ–­åˆ›å»ºå¤§å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="java">public class HeapInstanceTest &#123;
    byte[] buffer = new byte[1024 * 3000];

    public static void main(String[] args) &#123;
        ArrayList&lt;HeapInstanceTest&gt; list = new ArrayList&lt;HeapInstanceTest&gt;();
        while (true) &#123;
            list.add(new HeapInstanceTest());
            try &#123;
                Thread.sleep(10);
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;
&#125;</code></pre>
<p>IDEA Configurationè®¾ç½®JVMå‚æ•°ï¼š</p>
<pre><code>-Xms600m -Xmx600m</code></pre>
<p>CMDè¾“å…¥æŒ‡ä»¤ï¼Œæ‰“å¼€VisualVMï¼š</p>
<pre><code class="powershell">jvisualvm</code></pre>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/HeapInstanceTest.gif" class="" title="HeapInstanceTest">

<p>æœ€ç»ˆè€å¹´ä»£å’Œæ–°ç”Ÿä»£éƒ½æ»¡äº†ï¼Œå‡ºç°OOM</p>
<pre><code class="powershell">Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space
    at top.parak.HeapInstanceTest.&lt;init&gt;(HeapInstanceTest.java:18)
    at top.parak.HeapInstanceTest.main(HeapInstanceTest.java:23)</code></pre>
<blockquote>
<p>ğŸ”§è°ƒä¼˜å·¥å…·</p>
</blockquote>
<ul>
<li>JDKå‘½ä»¤è¡Œ</li>
<li>Eclipseï¼šMemory Analyzer Tool</li>
<li>Jconsole</li>
<li>Visual VMï¼ˆå®æ—¶ç›‘æ§ æ¨èï¼‰</li>
<li>Jprofilerï¼ˆæ¨èï¼‰</li>
<li>Java Flight Recorderï¼ˆå®æ—¶ç›‘æ§ï¼‰</li>
<li>GCViewer</li>
<li>GCEasy</li>
</ul>
<h2 id="7-5-â™»-Minor-GCã€Major-GCã€Full-GC"><a href="#7-5-â™»-Minor-GCã€Major-GCã€Full-GC" class="headerlink" title="7.5 â™» Minor GCã€Major GCã€Full GC"></a>7.5 â™» Minor GCã€Major GCã€Full GC</h2><blockquote>
<p>ğŸ“–æ¦‚è¿°</p>
</blockquote>
<p>JVMåœ¨è¿›è¡ŒGCæ—¶ï¼Œå¹¶éæ¯æ¬¡éƒ½å¯¹ä¸‰ä¸ªå†…å­˜åŒºåŸŸï¼ˆæ–°ç”Ÿä»£ã€è€å¹´ä»£ã€æ–¹æ³•åŒºï¼‰ä¸€èµ·å›æ”¶çš„ï¼Œå¤§éƒ¨åˆ†æ—¶å€™å›æ”¶çš„éƒ½æ˜¯æŒ‡æ–°ç”Ÿä»£ã€‚é’ˆå¯¹HotSpot VMçš„å®ç°ï¼Œå®ƒé‡Œé¢çš„GCæŒ‰ç…§å›æ”¶åŒºåŸŸåˆåˆ†ä¸ºä¸¤å¤§ç§ç±»å‹</p>
<ul>
<li>éƒ¨åˆ†æ”¶é›†<ul>
<li>Minor GC(Young GC): æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†</li>
<li>Major GC(Old GC): è€å¹´ä»£çš„åƒåœ¾æ”¶é›†<ul>
<li>ç›®å‰ï¼Œåªæœ‰CMS GCä¼šæœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸º</li>
<li>æ³¨æ„ï¼Œå¾ˆå¤šæ—¶å€™Major GCä¼šå’ŒFull GCæ··æ·†ä½¿ç”¨ï¼Œéœ€è¦å…·ä½“åˆ†è¾¨æ˜¯è€å¹´ä»£å›æ”¶è¿˜æ˜¯æ•´å †å›æ”¶</li>
</ul>
</li>
<li>Mixed GC: æ··åˆæ”¶é›†ï¼Œæ•´ä¸ªæ–°ç”Ÿä»£ä»¥åŠéƒ¨åˆ†è€å¹´ä»£çš„åƒåœ¾</li>
</ul>
</li>
<li>æ•´å †æ”¶é›†(Full GC): æ”¶é›†æ•´ä¸ªJavaå †å’Œæ–¹æ³•åŒºçš„åƒåœ¾æ”¶é›†</li>
</ul>
<blockquote>
<p>ğŸ”†è§¦å‘æœºåˆ¶</p>
</blockquote>
<p>1ï¸âƒ£ Minor GC</p>
<ul>
<li>å½“å¹´è½»ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œå°±ä¼šè§¦å‘Minor GCï¼Œè¿™é‡Œçš„å¹´è½»ä»£æ»¡æŒ‡çš„æ˜¯Edenä»£æ»¡ï¼ŒSurvivoræ»¡ä¸ä¼šå¼•å‘GCã€‚</li>
<li>å› ä¸ºJavaå¯¹è±¡å¤§å¤šéƒ½å…·å¤‡æœç”Ÿå¤•ç­çš„ç‰¹æ€§ï¼Œæ‰€ä»¥Minor GCéå¸¸é¢‘ç¹ï¼Œä¸€èˆ¬å›æ”¶é€Ÿåº¦ä¹Ÿæ¯”è¾ƒå¿«ã€‚</li>
<li>Minor GCä¼šå¼•å‘STWï¼Œæš‚åœå…¶ä»–çš„ç”¨æˆ·çš„çº¿ç¨‹ï¼Œç­‰åƒåœ¾å›æ”¶ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¢å¤è¿è¡Œã€‚</li>
</ul>
<p>2ï¸âƒ£ Major GC / Full GC</p>
<ul>
<li>å¯¹è±¡ä»è€å¹´ä»£æ¶ˆå¤±ï¼Œæˆ‘ä»¬è¯´â€Major GCâ€æˆ–â€Full GCâ€å‘ç”Ÿäº†ã€‚</li>
<li>å‡ºç°äº†â€Major GCâ€ï¼Œç»å¸¸ä¼šä¼´éšè‡³å°‘ä¸€æ¬¡çš„Minor GCï¼ˆä½†éç»å¯¹çš„ï¼Œåœ¨Parallel Scavengeæ”¶é›†å™¨çš„æ”¶é›†ç­–ç•¥é‡Œå°±æœ‰ç›´æ¥è¿›è¡Œçš„Major GCçš„ç­–ç•¥é€‰æ‹©è¿‡ç¨‹ï¼‰ã€‚å³åœ¨è€å¹´ä»£ç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šå°è¯•è§¦å‘Minor GCï¼›å¦‚æœä¹‹åç©ºé—´è¿˜ä¸è¶³ï¼Œåˆ™è§¦å‘Major GCã€‚</li>
<li>Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10å€ä»¥ä¸Šï¼ŒSTWçš„æ—¶é—´æ›´é•¿ã€‚</li>
<li>å¦‚æœMajor GCåï¼Œå†…å­˜è¿˜ä¸è¶³ï¼Œå°±æŠ¥OOMäº†ã€‚</li>
<li>Major GCçš„é€Ÿåº¦ä¸€èˆ¬ä¼šæ¯”Minor GCæ…¢10å€ä»¥ä¸Šã€‚</li>
</ul>
<p>3ï¸âƒ£ Full GCè§¦å‘æœºåˆ¶</p>
<ol>
<li>è°ƒç”¨<code>System.gc()</code>æ—¶ï¼Œç³»ç»Ÿå»ºè®®æ‰§è¡ŒFull GCï¼Œä½†æ˜¯ä¸å¿…ç„¶æ‰§è¡Œ</li>
<li>è€å¹´ä»£ç©ºé—´ä¸è¶³</li>
<li>æ–¹æ³•åŒºç©ºé—´ä¸è¶³</li>
<li>é€šè¿‡Minor GCåè¿›å…¥è€å¹´ä»£çš„å¹³å‡å¤§å°å¤§äºè€å¹´ä»£çš„å¯ç”¨å†…å­˜</li>
<li>ç”±EdenåŒºã€Survivor Space 0 (From Space)åŒºå‘Survivor Space 1 (To Space)åŒºå¤åˆ¶æ—¶ï¼Œå¯¹è±¡å¤§å°å¤§äºTo Spaceå¯ç”¨å†…å­˜ï¼Œåˆ™æŠŠè¯¥å¯¹è±¡è½¬å­˜åˆ°è€å¹´ä»£ï¼Œåˆ‡è€å¹´ä»£çš„å¯ç”¨å†…å­˜å°äºè¯¥å¯¹è±¡å¤§å°</li>
</ol>
<p>è¯´æ˜ï¼šFull GCæ˜¯å¼€å‘æˆ–è°ƒä¼˜ä¸­å°½é‡è¦é¿å…çš„ã€‚</p>
<h2 id="7-6-ğŸ§ -å †ç©ºé—´åˆ†ä»£æ€æƒ³"><a href="#7-6-ğŸ§ -å †ç©ºé—´åˆ†ä»£æ€æƒ³" class="headerlink" title="7.6 ğŸ§  å †ç©ºé—´åˆ†ä»£æ€æƒ³"></a>7.6 ğŸ§  å †ç©ºé—´åˆ†ä»£æ€æƒ³</h2><blockquote>
<p>ğŸ”¸åˆ†ä»£åŸå› </p>
</blockquote>
<p>å…¶å®ä¸åˆ†ä»£å®Œå…¨å¯ä»¥ï¼Œåˆ†ä»£çš„å”¯ä¸€ç†ç”±å°±æ˜¯ä¼˜åŒ–GCæ€§èƒ½ã€‚å¦‚æœæ²¡æœ‰åˆ†ä»£ï¼Œé‚£æ‰€æœ‰çš„å¯¹è±¡éƒ½åœ¨ä¸€å—ï¼Œå°±å¦‚åŒæŠŠä¸€ä¸ªå­¦æ ¡çš„äººéƒ½å…³åœ¨ä¸€ä¸ªæ•™å®¤ã€‚GCçš„æ—¶å€™è¦æ‰¾åˆ°å“ªäº›å¯¹è±¡æ²¡ç”¨ï¼Œè¿™æ ·å°±ä¼šå¯¹å †çš„æ‰€æœ‰åŒºåŸŸè¿›è¡Œæ‰«æã€‚è€Œå¾ˆå¤šå¯¹è±¡æ˜¯æœç”Ÿå¤•æ­»çš„ï¼Œå¦‚æœåˆ†ä»£çš„è¯ï¼ŒæŠŠæ–°åˆ›å»ºçš„å¯¹è±¡æ”¾åœ¨æŸä¸€åœ°æ–¹ï¼Œå½“GCçš„æ—¶å€™å…ˆæŠŠè¿™å—å­˜å‚¨â€œæœç”Ÿå¤•æ­»â€å¯¹è±¡çš„åŒºåŸŸè¿›è¡Œå›æ”¶ï¼Œè¿™æ ·å°±ä¼šè…¾å‡ºå¾ˆå¤§çš„ç©ºé—´æ¥ã€‚</p>
<h2 id="7-7-ğŸ”°-å†…å­˜åˆ†é…ç­–ç•¥"><a href="#7-7-ğŸ”°-å†…å­˜åˆ†é…ç­–ç•¥" class="headerlink" title="7.7 ğŸ”° å†…å­˜åˆ†é…ç­–ç•¥"></a>7.7 ğŸ”° å†…å­˜åˆ†é…ç­–ç•¥</h2><blockquote>
<p>ğŸ“‹æ€»ç»“</p>
</blockquote>
<p>å¦‚æœå¯¹è±¡åœ¨Edenå‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡Minor GCåä»ç„¶å­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢«Survivorå®¹çº³çš„è¯ï¼Œå°†è¢«ç§»åŠ¨åˆ°Survivorç©ºé—´ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º1ã€‚å¯¹è±¡åœ¨SurvivoråŒºä¸­æ¯ç†¬è¿‡ä¸€æ¬¡Minor GCï¼Œå¹´é¾„å°±å¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ï¼ˆé»˜è®¤5å²ï¼Œå…¶å®æ¯ä¸ªJVMã€æ¯ä¸ªGCéƒ½æœ‰æ‰€ä¸åŒï¼‰æ—¶ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚</p>
<p>å¯¹è±¡æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡é€‰é¡¹<code>-XX:MaxTenuringThreshold</code>æ¥è®¾ç½®ã€‚</p>
<blockquote>
<p>ğŸŒ€åŸåˆ™</p>
</blockquote>
<ul>
<li>ä¼˜å…ˆåˆ†é…åˆ°Eden</li>
<li>å¤§å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£<ul>
<li>å°½é‡é¿å…ç¨‹åºä¸­é•¿æœŸå­˜æ´»çš„å¯¹è±¡åˆ†é…åˆ°è€å¹´ä»£å‡ºç°è¿‡å¤šçš„å¤§å¯¹è±¡</li>
</ul>
</li>
<li>åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤æ–­<ul>
<li>å¦‚æœSurvivoråŒºä¸­ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œå¤§äºSurvivorç©ºé—´çš„ä¸€èˆ¬ï¼Œå¹´é¾„å¤§äºæˆ–ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œæ— é¡»ç­‰åˆ°MaxTenuringThresholdä¸­è¦æ±‚çš„å¹´é¾„ã€‚</li>
</ul>
</li>
<li>ç©ºé—´åˆ†é…æ‹…ä¿<ul>
<li>-XX:HandlePromotionFailure</li>
</ul>
</li>
</ul>
<h2 id="7-8-ğŸŒŒ-ä¸ºå¯¹è±¡åˆ†é…å†…å­˜"><a href="#7-8-ğŸŒŒ-ä¸ºå¯¹è±¡åˆ†é…å†…å­˜" class="headerlink" title="7.8 ğŸŒŒ ä¸ºå¯¹è±¡åˆ†é…å†…å­˜"></a>7.8 ğŸŒŒ ä¸ºå¯¹è±¡åˆ†é…å†…å­˜</h2><blockquote>
<p>â˜ªå‡ºç°èƒŒæ™¯</p>
</blockquote>
<ul>
<li>å †åŒºæ˜¯çº¿ç¨‹å…±äº«åŒºåŸŸï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®åˆ°å †åŒºä¸­çš„å…±äº«æ•°æ®</li>
<li>ç”±äºå¯¹è±¡å®ä¾‹çš„åˆ›å»ºåœ¨JVMä¸­éå¸¸é¢‘ç¹ï¼Œå› æ­¤åœ¨å¹¶å‘ç¯å¢ƒä¸‹ä»å †åŒºåˆ’åˆ†å†…å­˜ç©ºé—´æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</li>
<li>ä¸ºé¿å…å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€åœ°å€ï¼Œéœ€è¦ä½¿ç”¨åŠ é”ç­‰æœºåˆ¶ï¼Œè¿›è€Œå½±å“åˆ†é…é€Ÿåº¦</li>
</ul>
<blockquote>
<p>ğŸ’«TLAB(Thread Local Allocation Buffer)</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/image-20210211230044163.png" class="" title="image-20210211230044163">

<ul>
<li>ä»å†…å­˜æ¨¡å‹è€Œä¸æ˜¯åƒåœ¾æ”¶é›†çš„è§’åº¦ï¼Œå¯¹EdenåŒºåŸŸç»§ç»­è¿›è¡Œåˆ’åˆ†ï¼ŒJVMä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†ä¸€ä¸ªç§æœ‰ç¼“å­˜åŒºåŸŸï¼Œå®ƒåŒ…å«åœ¨Edenç©ºé—´å†…ã€‚</li>
<li>å¤šçº¿ç¨‹åŒæ—¶åˆ†é…å†…å­˜æ—¶ï¼Œä½¿ç”¨TLABå¯ä»¥é¿å…ä¸€ç³»åˆ—çš„éçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿæå‡å†…å­˜åˆ†é…çš„ååé‡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¿™ç§å†…å­˜åˆ†é…æ–¹å¼ç§°ä¹‹ä¸ºå¿«é€Ÿåˆ†é…ç­–ç•¥ã€‚</li>
</ul>
<blockquote>
<p>â³åˆ†é…è¿‡ç¨‹</p>
</blockquote>
<p>å¯¹è±¡é¦–å…ˆæ˜¯é€šè¿‡TLABå¼€è¾Ÿç©ºé—´ï¼Œå¦‚æœä¸èƒ½æ”¾å…¥ï¼Œé‚£ä¹ˆéœ€è¦é€šè¿‡Edenæ¥è¿›è¡Œåˆ†é…ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/image-20210211225613422.png" class="" title="image-20210211225613422">



<blockquote>
<p>ğŸ’¬å†è¯´æ˜</p>
</blockquote>
<ul>
<li>å°½ç®¡ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½èƒ½å¤Ÿåœ¨TLABä¸­åˆ†é…å†…å­˜ï¼Œä½†JVMç¡®å®æ—¶å°†TLABä½œä¸ºå†…å­˜åˆ†é…çš„é¦–é€‰ã€‚</li>
<li>åœ¨ç¨‹åºä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€šè¿‡é€‰æ‹©<code>-XX:UseTLAB</code>è®¾ç½®æ˜¯å¦å¼€å¯TLABç©ºé—´ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒTLABç©ºé—´çš„å†…å­˜éå¸¸å°ï¼Œä»…å æœ‰æ•´ä¸ªEdenç©ºé—´çš„1%ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡é€‰å‹â€-XX:TLABWasteTargetPercentâ€è®¾ç½®TLABç©ºé—´æ‰€å Edenç©ºé—´çš„ç™¾åˆ†æ¯”å¤§å°ã€‚</li>
<li>ä¸€æ—¦å¯¹è±¡åœ¨TLABç©ºé—´åˆ†é…å†…å­˜å¤±è´¥æ—¶ï¼ŒJVMå°±ä¼šå°è¯•ç€é€šè¿‡åŠ é”æœºåˆ¶ç¡®ä¿æ•°æ®æ“ä½œçš„åŸå­æ€§ï¼Œä»è€Œç›´æ¥åœ¨Edenç©ºé—´ä¸­åˆ†é…å†…å­˜ã€‚</li>
</ul>
<h2 id="7-9-ğŸ’¤-å †ç©ºé—´çš„å‚æ•°è®¾ç½®"><a href="#7-9-ğŸ’¤-å †ç©ºé—´çš„å‚æ•°è®¾ç½®" class="headerlink" title="7.9 ğŸ’¤ å †ç©ºé—´çš„å‚æ•°è®¾ç½®"></a>7.9 ğŸ’¤ å †ç©ºé—´çš„å‚æ•°è®¾ç½®</h2><blockquote>
<p>ğŸ“‹æ€»ç»“</p>
</blockquote>
<ul>
<li><code>-XX:+PrintFlagsInitial</code>ï¼šæŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°çš„é»˜è®¤åˆå§‹å€¼</li>
<li><code>-XX:+PrintFlagsFinal</code>ï¼šæŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°çš„æœ€ç»ˆå€¼ï¼ˆå¯èƒ½ä¼šå­˜åœ¨ä¿®æ”¹ï¼Œä¸å†æ˜¯åˆå§‹å€¼ï¼‰</li>
<li><code>-Xms</code>ï¼šåˆå§‹å †ç©ºé—´å†…å­˜ï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/64ï¼‰</li>
<li><code>-Xmx</code>ï¼šæœ€å¤§å †ç©ºé—´å†…å­˜ï¼ˆé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„1/4ï¼‰</li>
<li><code>-Xmn</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£çš„å¤§å°ã€‚ï¼ˆåˆå§‹å€¼åŠæœ€å¤§å€¼ï¼‰</li>
<li><code>-XX:NewRatio</code>ï¼šé…ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”</li>
<li><code>-XX:SurvivorRatio</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£ä¸­Edenå’ŒS0/S1ç©ºé—´çš„æ¯”ä¾‹</li>
<li><code>-XX:MaxTenuringThreshold</code>ï¼šè®¾ç½®æ–°ç”Ÿä»£åƒåœ¾çš„æœ€å¤§å¹´é¾„</li>
<li><code>-XX:+PrintGCDetails</code>ï¼šè¾“å‡ºè¯¦ç»†çš„GCå¤„ç†æ—¥å¿—<ul>
<li>æ‰“å°gcç®€è¦ä¿¡æ¯ï¼šâ‘ <code>-XX:+PrintGC</code> â‘¡<code> - verbose:gc</code></li>
</ul>
</li>
<li><code>-XX:HandlePromotionFalilure</code>ï¼šæ˜¯å¦è®¾ç½®ç©ºé—´åˆ†é…æ‹…ä¿</li>
<li><code>-XX:PretenureSizeThreshold</code>ï¼šå¯ç›´æ¥è¿›å…¥è€å¹´ä»£çš„newå¯¹è±¡å¤§å°</li>
</ul>
<p>åœ¨å‘ç”ŸMinor GCä¹‹å‰ï¼Œè™šæ‹Ÿæœºä¼šæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨çš„è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡çš„æ€»ç©ºé—´ã€‚</p>
<ul>
<li>å¦‚æœå¤§äºï¼Œåˆ™æ­¤æ¬¡Minor GCæ˜¯å®‰å…¨çš„ã€‚</li>
<li>å¦‚æœå°äºï¼Œåˆ™è™šæ‹Ÿæœºä¼šæŸ¥çœ‹-XX:HandlePromotionFailureè®¾ç½®å€¼æ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥ã€‚<ul>
<li>å¦‚æœHandlePromotionFailure=trueï¼Œé‚£ä¹ˆä¼šç»§ç»­æ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºå†æ¬¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¯¹è±¡çš„å¹³å‡å¤§å°ã€‚<ul>
<li>å¦‚æœå¤§äºï¼Œåˆ™å°è¯•è¿›è¡Œä¸€æ¬¡Minor GCï¼Œä½†è¿™æ¬¡Minor GCä¾ç„¶æ˜¯æœ‰é£é™©çš„ï¼›</li>
<li>å¦‚æœå°äºï¼Œåˆ™æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡Full GCã€‚</li>
</ul>
</li>
<li>å¦‚æœHandlePromotionFailure=falseï¼Œåˆ™æ”¹ä¸ºè¿›è¡Œä¸€æ¬¡Full GCã€‚</li>
</ul>
</li>
</ul>
<p>åœ¨JDK6 Update24ä¹‹åï¼ŒHandlePromotionFailureå‚æ•°ä¸ä¼šå†å½±å“åˆ°è™šæ‹Ÿæœºçš„ç©ºé—´åˆ†é…æ‹…ä¿ç­–ç•¥ï¼Œè§‚å¯ŸopenJDKä¸­çš„æºç å˜åŒ–ï¼Œè™½ç„¶æºç ä¸­è¿˜å®šä¹‰äº†HandlePromotionFailureå‚æ•°ï¼Œä½†æ˜¯åœ¨ä»£ç ä¸­å·²ç»ä¸ä¼šå†ä½¿ç”¨å®ƒã€‚JDK6 Update 24ä¹‹åçš„è§„åˆ™å˜ä¸ºåªè¦è€å¹´ä»£çš„è¿ç»­ç©ºé—´å¤§äºæ–°ç”Ÿä»£å¯¹è±¡æ€»å¤§å°æˆ–è€…å†æ¬¡æ™‹å‡çš„å¹³å‡å¤§å°å°±ä¼šè¿›è¡ŒMinor GCï¼Œå¦åˆ™å°†è¿›è¡ŒFullGCã€‚</p>
<h2 id="7-10-â“-å †æ˜¯åˆ†é…å¯¹è±¡å­˜å‚¨çš„å”¯ä¸€é€‰æ‹©å—"><a href="#7-10-â“-å †æ˜¯åˆ†é…å¯¹è±¡å­˜å‚¨çš„å”¯ä¸€é€‰æ‹©å—" class="headerlink" title="7.10 â“ å †æ˜¯åˆ†é…å¯¹è±¡å­˜å‚¨çš„å”¯ä¸€é€‰æ‹©å—"></a>7.10 â“ å †æ˜¯åˆ†é…å¯¹è±¡å­˜å‚¨çš„å”¯ä¸€é€‰æ‹©å—</h2><blockquote>
<p>ğŸ“˜å¼•ç”¨</p>
</blockquote>
<p>åœ¨ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹ä¸­å…³äºJavaå †å†…å­˜æœ‰è¿™æ ·ä¸€æ®µæè¿°ï¼š</p>
<p>éšç€JITç¼–è¯‘æœŸçš„å‘å±•ä¸é€ƒé€¸åˆ†ææŠ€æœ¯é€æ¸æˆç†Ÿï¼Œæ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢ä¼˜åŒ–æŠ€æœ¯å°†ä¼šå¯¼è‡´ä¸€äº›å¾®ç§’çš„å˜åŒ–ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½åˆ†é…åˆ°å †ä¸Šä¹Ÿæ¸æ¸å˜å¾—ä¸é‚£ä¹ˆç»å¯¹äº†ã€‚</p>
<p>åœ¨Javaè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡æ˜¯åœ¨Javaå †ä¸­åˆ†é…å†…å­˜çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªæ™®éçš„å¸¸è¯†ã€‚ä½†æ˜¯æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œé‚£å°±æ˜¯å¦‚æœç»è¿‡é€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰åå‘ç°ï¼Œä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œé‚£ä¹ˆä¹…å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚è¿™æ ·å°±æ— éœ€åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œä¹Ÿæ— éœ€è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚è¿™ä¹Ÿæ˜¯æœ€å¸¸è§çš„å †å¤–å­˜å‚¨æŠ€æœ¯ã€‚</p>
<p>æ­¤å¤–ï¼Œå‰é¢æåˆ°çš„åŸºäºOpenJDKæ·±åº¦å®šåˆ¶çš„TaoBaoVMï¼Œå…¶ä¸­åˆ›æ–°çš„GCIHï¼ˆGC invisible heapï¼‰æŠ€æœ¯å®ç°çš„off-heapï¼Œå°†ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„Javaå¯¹è±¡ä»heapä¸­ç§»è‡³heapå¤–ï¼Œå¹¶ä¸”GCä¸èƒ½ç®¡ç†GCIHå†…éƒ¨çš„Javaå¯¹è±¡ï¼Œä»¥æ­¤è¾¾åˆ°é™ä½GCçš„å›æ”¶é¢‘ç‡å’Œæå‡GCçš„å›æ”¶æ•ˆç‡çš„ç›®çš„ã€‚</p>
<blockquote>
<p>ğŸ“–é€ƒé€¸åˆ†ææ¦‚è¿°</p>
</blockquote>
<ul>
<li>å¦‚ä½•å°†å †ä¸Šçš„å¯¹è±¡åˆ†é…åˆ°æ ˆï¼Œéœ€è¦ä½¿ç”¨é€ƒé€¸åˆ†ææ‰‹æ®µã€‚</li>
<li>è¿™æ˜¯ä¸€ç§æœ‰æ•ˆå‡å°‘Javaç¨‹åºä¸­åŒæ­¥è´Ÿè½½å’Œå†…å­˜å †å†…å­˜çš„è·¨å‡½æ•°å…¨å±€æ•°æ®æµåˆ†æç®—æ³•ã€‚</li>
<li>é€šè¿‡é€ƒé€¸åˆ†æï¼ŒJava Hotspotç¼–è¯‘å™¨èƒ½å¤Ÿåˆ†æå‡ºä¸€ä¸ªæ–°çš„å¯¹è±¡çš„å¼•ç”¨çš„ä½¿ç”¨èŒƒå›´ä»è€Œå†³å®šæ˜¯å¦å°†è¿™ä¸ªå¯¹è±¡åˆ†é…åˆ°å †ä¸Šã€‚</li>
<li>é€ƒé€¸åˆ†æçš„åŸºæœ¬è¡Œä¸ºå°±æ˜¯åˆ†æå¯¹è±¡åŠ¨æ€ä½œç”¨åŸŸï¼š<ul>
<li>å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•å†…è¢«å®šä¹‰åï¼Œå¯¹è±¡åªåœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œåˆ™è®¤ä¸ºæ²¡æœ‰å‘ç”Ÿé€ƒé€¸ã€‚</li>
<li>å½“ä¸€ä¸ªå¯¹è±¡åœ¨æ–¹æ³•ä¸­è¢«å®šä¹‰åï¼Œå®ƒè¢«å¤–éƒ¨æ–¹æ³•æ‰€å¼•ç”¨ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿé€ƒé€¸ã€‚ä¾‹å¦‚ä½œä¸ºè°ƒç”¨å‚æ•°ä¼ é€’åˆ°å…¶ä»–æ–¹æ³•ä¸­ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>âš™ï¸å‚æ•°è®¾ç½®</p>
</blockquote>
<p>åœ¨JDK 1.7 ç‰ˆæœ¬ä¹‹åï¼ŒHotSpotä¸­é»˜è®¤å°±å·²ç»å¼€å¯äº†é€ƒé€¸åˆ†æ</p>
<p>å¦‚æœä½¿ç”¨çš„æ˜¯è¾ƒæ—©çš„ç‰ˆæœ¬ï¼Œå¼€å‘äººå‘˜åˆ™å¯ä»¥é€šè¿‡ï¼š</p>
<ul>
<li>é€‰é¡¹<code>-xx:+DoEscapeAnalysis</code>æ˜¾å¼å¼€å¯é€ƒé€¸åˆ†æ</li>
<li>é€‰é¡¹<code>-xx:+PrintEscapeAnalysis</code>æŸ¥çœ‹é€ƒé€¸åˆ†æçš„ç­›é€‰ç»“æœ</li>
</ul>
<blockquote>
<p>âœ…ç»“è®º</p>
</blockquote>
<p>å¼€å‘ä¸­èƒ½ä½¿ç”¨å±€éƒ¨å˜é‡çš„ï¼Œå°±ä¸ç”¨ä½¿ç”¨åœ¨æ–¹æ³•å¤–å®šä¹‰ã€‚</p>
<p>ä½¿ç”¨é€ƒé€¸åˆ†æï¼Œç¼–è¯‘å™¨å¯ä»¥å¯¹ä»£ç åšå¦‚ä¸‹ä¼˜åŒ–ï¼š</p>
<ul>
<li>æ ˆä¸Šåˆ†é…ï¼šå°†å †åˆ†é…è½¬åŒ–ä¸ºæ ˆåˆ†é…ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨å­ç¨‹åºä¸­è¢«åˆ†é…ï¼Œè¦ä½¿æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆæ°¸è¿œä¸ä¼šå‘ç”Ÿé€ƒé€¸ï¼Œå¯¹è±¡å¯èƒ½æ˜¯æ ˆä¸Šåˆ†é…çš„å€™é€‰ï¼Œè€Œä¸æ˜¯å †ä¸Šåˆ†é…ã€‚</li>
<li>åŒæ­¥çœç•¥ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è¢«å‘ç°åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªå¯¹è±¡çš„æ“ä½œå¯ä»¥ä¸è€ƒè™‘åŒæ­¥ã€‚</li>
<li>åˆ†ç¦»å¯¹è±¡æˆ–æ ‡é‡æ›¿æ¢ï¼šæœ‰çš„å¯¹è±¡å¯èƒ½ä¸éœ€è¦ä½œä¸ºä¸€ä¸ªè¿ç»­çš„å†…å­˜ç»“æ„å­˜åœ¨ä¹Ÿä¹Ÿå¯ä»¥è¢«è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå¯¹è±¡çš„éƒ¨åˆ†ï¼ˆæˆ–å…¨éƒ¨ï¼‰å¯ä»¥ä¸å­˜å‚¨åœ¨å†…å­˜ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨CPUå¯„å­˜å™¨ä¸­ã€‚</li>
</ul>
<blockquote>
<p>âŒ¨ï¸ä»£ç ç¤ºä¾‹</p>
</blockquote>
<pre><code class="java">/**
 * @author KHighness
 * @since 2021/2/12
 * é€ƒé€¸åˆ†æï¼šå°±çœ‹newçš„å¯¹è±¡æ˜¯å¦æœ‰å¯èƒ½åœ¨æ–¹æ³•å¤–è¢«è°ƒç”¨
 */
public class EscapeAnalysis &#123;

    public EscapeAnalysis obj;

    /**
     * æ–¹æ³•è¿”å›EscapeAnalysiså¯¹è±¡ï¼Œå‘ç”Ÿé€ƒé€¸
     */
    public EscapeAnalysis getInstance() &#123;
        return obj == null ? new EscapeAnalysis() : obj;
    &#125;

    /**
     * ä¸ºæˆå‘˜å±æ€§èµ‹å€¼ï¼Œå‘ç”Ÿé€ƒé€¸
     */
    public void setObj() &#123;
        this.obj = new EscapeAnalysis();
    &#125;

    /**
     * å¯¹è±¡çš„ä½œç”¨åŸŸä»…åœ¨å½“å‰æ–¹æ³•ä¸­æœ‰æ•ˆï¼Œæ²¡æœ‰å‘ç”Ÿé€ƒé€¸
     */
    public void useEscapeAnalysis() &#123;
        EscapeAnalysis escapeAnalysis = new EscapeAnalysis();
    &#125;

    /**
     * å¼•ç”¨æˆå‘˜å˜é‡çš„å€¼ï¼Œå‘ç”Ÿé€ƒé€¸
     */
    public void useEscapeAnalysis1() &#123;
        EscapeAnalysis escapeAnalysis = getInstance();
    &#125;

&#125;</code></pre>
<blockquote>
<p>1ï¸âƒ£æ ˆä¸Šåˆ†é…</p>
</blockquote>
<p>JITç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´æ ¹æ®é€ƒé€¸åˆ†æçš„ç»“æœï¼Œå‘ç°å¦‚æœä¸€ä¸ªå¯¹è±¡å¹¶æ²¡æœ‰é€ƒé€¸å‡ºæ–¹æ³•çš„è¯ï¼Œå°±å¯èƒ½è¢«ä¼˜åŒ–æˆæ ˆä¸Šåˆ†é…ã€‚åˆ†é…å®Œæˆåï¼Œç»§ç»­åœ¨è°ƒç”¨æ ˆå†…æ‰§è¡Œï¼Œæœ€åçº¿ç¨‹ç»“æŸï¼Œæ ˆç©ºé—´è¢«å›æ”¶ï¼Œå±€éƒ¨å˜é‡å¯¹è±¡ä¹Ÿè¢«å›æ”¶ã€‚è¿™æ ·å°±æ— é¡»è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚</p>
<p>åœºæ™¯ï¼šæˆå‘˜å˜é‡èµ‹å€¼ã€æ–¹æ³•è¿”å›å€¼ã€å®ä¾‹å¼•ç”¨ä¼ é€’ã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<pre><code class="java">/**
 * @author KHighness
 * @since 2021/2/22
 */
class User &#123;
    private String name;
    private String age;
    private String gender;
    private String phone;
&#125;

public class StackAllocation &#123;
    public static void main(String[] args) &#123;
        long start = System.currentTimeMillis();
        // åˆ†é…ä¸€ç™¾ä¸‡ä¸ªå¯¹è±¡
        for (int i = 0; i &lt; 100000000; i++) &#123;
            alloc();
        &#125;
        long end = System.currentTimeMillis();
        // æŸ¥çœ‹æ‰§è¡Œæ—¶é—´
        System.out.println(&quot;æ‰§è¡Œæ—¶é—´ =&gt; [&quot; + (end - start)+ &quot;ms]&quot;);
        // ä¼‘çœ ä»¥æŸ¥çœ‹å†…å­˜
        try &#123;
            Thread.sleep(1000000);
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    private static void alloc() &#123;
        // æœªå‘ç”Ÿé€ƒé€¸
        User user = new User();
    &#125;
&#125;
</code></pre>
<p>ä¸å¼€å¯é€ƒé€¸åˆ†æï¼š</p>
<pre><code>-Xmx1G -Xms1G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails</code></pre>
<p>è¿è¡Œç»“æœï¼š</p>
<pre><code>æ‰§è¡Œæ—¶é—´ =&gt; [4ms]</code></pre>
<p>é€šè¿‡æŠ½æ ·å™¨æŸ¥çœ‹å†…å­˜æƒ…å†µï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/image-20210222170206155.png" class="" title="image-20210222170206155">

<p>å‘ç°å†…å­˜ä¸­æœ‰8w+çš„Userå®ä¾‹ã€‚</p>
<p>å¼€å¯é€ƒé€¸åˆ†æï¼š</p>
<pre><code>-Xmx1G -Xms1G -XX:-DoEscapeAnalysis -XX:+PrintGCDetails</code></pre>
<p>è¿è¡Œç»“æœï¼š</p>
<pre><code>æ‰§è¡Œæ—¶é—´ =&gt; [5ms]</code></pre>
<p>é€šè¿‡æŠ½æ ·å™¨æŸ¥çœ‹å†…å­˜æƒ…å†µï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/11581/image-20210222170124218.png" class="" title="image-20210222170124218">

<p>å‘ç°å†…å­˜ä¸­æœ‰9w+çš„å†…å­˜å®ä¾‹ã€‚</p>
<p>è¿™å¯¹æ¯”æ˜¯ç¥é©¬ç©æ„ï¼Œå“‡åäº†â€¦â€¦</p>
<blockquote>
<p>2ï¸âƒ£åŒæ­¥çœç•¥</p>
</blockquote>
<p>çº¿ç¨‹åŒæ­¥çš„ä»£ä»·æ˜¯ç›¸å½“é«˜çš„ï¼ŒåŒæ­¥çš„åæœæ˜¯é™ä½å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚</p>
<p>åœ¨åŠ¨æ€ç¼–è¯‘åŒæ­¥å—çš„æ—¶å€™ï¼ŒJITç¼–è¯‘å™¨å¯ä»¥å€ŸåŠ©é€ƒé€¸åˆ†æåŒæ­¥å—æ‰€ä½¿ç”¨çš„é”å¯¹è±¡æ˜¯å¦èƒ½å¤Ÿè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®è€Œæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶ä»–çº¿ç¨‹ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆJITç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿™ä¸ªåŒæ­¥å—çš„æ—¶å€™å°±ä¼šå–æ¶ˆå¯¹è¿™ä¸ªä»£ç å—çš„åŒæ­¥ã€‚è¿™æ ·å°±èƒ½å¤§å¤§æé«˜å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚è¿™ä¸ªå–æ¶ˆåŒæ­¥çš„è¿‡ç¨‹å°±å«åŒæ­¥çœç•¥ï¼Œä¹Ÿå«é”æ¶ˆé™¤ã€‚</p>
<p>å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="java">public void f() &#123;
    Object obj = new Object();
    synchronized(obj) &#123;
        System.out.println(obj);
    &#125;
&#125;</code></pre>
<p>ä»£ç å—å¯¹<code>obj</code>è¿™ä¸ªå¯¹è±¡åŠ é”ï¼Œä½†æ˜¯<code>obj</code>å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåªåœ¨æ–¹æ³•ä¸­ï¼Œå¹¶ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹é”è®¿é—®åˆ°ï¼Œæ‰€ä»¥åœ¨JITç¼–è¯‘é˜¶æ®µå°±ä¼šè¢«ä¼˜åŒ–æ‰ï¼Œä¼˜åŒ–æˆï¼š</p>
<pre><code class="java">public void f() &#123;
    Object obj = new Object();
    System.out.println(obj);
&#125;</code></pre>
<blockquote>
<p>3ï¸âƒ£åˆ†ç¦»å¯¹è±¡å’Œæ ‡é‡æ›¿æ¢</p>
</blockquote>
<p>æ ‡é‡ï¼ˆscalarï¼‰æ˜¯æŒ‡ä¸€ä¸ªæ— æ³•å†åˆ†è§£æˆæ›´å°çš„æ•°æ®çš„æ•°æ®ã€‚Javaä¸­çš„åŸå§‹æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ã€‚</p>
<p>ç›¸å¯¹çš„ï¼Œé‚£ä¹ˆè¿˜å¯ä»¥åˆ†è§£çš„æ•°æ®å«åšèšåˆé‡ï¼ˆAggregateï¼‰ï¼ŒJavaä¸­çš„å¯¹è±¡å°±æ˜¯èšåˆé‡ï¼Œå› ä¸ºä»–å¯ä»¥åˆ†è§£æˆå…¶ä»–èšåˆé‡å’Œæ ‡é‡ã€‚</p>
<p>åœ¨JITé˜¶æ®µï¼Œå¦‚ä½•ç»è¿‡é€ƒé€¸åˆ†æï¼Œå‘ç°ä¸€ä¸ªå¯¹è±¡ä¸ä¼šè¢«å¤–ç•Œè®¿é—®çš„è¯ï¼Œé‚£ä¹ˆç»è¿‡JITä¼˜åŒ–ï¼Œå°±ä¼šæŠŠè¿™ä¸ªå¯¹è±¡æ‹†è§£æˆè‹¥å¹²ä¸ªå…¶ä¸­åŒ…å«çš„è‹¥å¹²ä¸ªæˆå‘˜å˜é‡æ¥ä»£æ›¿ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ ‡é‡æ›¿æ¢ã€‚</p>
<p>å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="java">public static void main(String args[]) &#123;
    alloc();
&#125;
class Point &#123;
    private int x;
    private int y;
&#125;
private static void alloc() &#123;
    Point point = new Point(1,2);
    System.out.println(&quot;point.x&quot; + point.x + &quot;;point.y&quot; + point.y);
&#125;</code></pre>
<p>ç»è¿‡æ ‡é‡æ›¿æ¢åï¼Œå°±ä¼šå˜æˆï¼š</p>
<pre><code class="java">private static void alloc() &#123;
    int x = 1;
    int y = 2;
    System.out.println(&quot;point.x = &quot; + x + &quot;; point.y=&quot; + y);
&#125;</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>Point</code>è¿™ä¸ªèšåˆé‡ç»è¿‡é€ƒé€¸åˆ†æåï¼Œå‘ç°å®ƒå¹¶æ²¡æœ‰é€ƒé€¸ï¼Œå°±è¢«æ›¿æ¢æˆä¸¤ä¸ªæ ‡é‡äº†ã€‚é‚£ä¹ˆæ ‡é‡æ›¿æ¢æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿå°±æ˜¯å¯ä»¥å¤§å¤§å‡å°‘å†…å­˜çš„å ç”¨ã€‚å› ä¸ºä¸€æ—¦ä¸éœ€è¦åˆ›å»ºå¯¹è±¡äº†ï¼Œé‚£ä¹ˆä¹…ä¸å†éœ€è¦åˆ†é…å†…å­˜äº†ã€‚æ ‡é‡æ›¿æ¢ä¸ºæ ˆä¸Šåˆ†é…æä¾›äº†å¾ˆå¥½çš„åŸºç¡€ã€‚</p>
<blockquote>
<p>ğŸ“‹ä»£ç ä¼˜åŒ–</p>
</blockquote>
<ul>
<li><p>XX:+DoEscapeAnalysisï¼šå¯ç”¨é€ƒé€¸åˆ†æ</p>
</li>
<li><p>XX:+EliminateAllocationsï¼šå¼€å¯äº†æ ‡é‡æ›¿æ¢ï¼ˆé»˜è®¤æ‰“å¼€ï¼‰ï¼Œå…è®¸å°†å¯¹è±¡æ‰“æ•£åˆ†é…åœ¨æ ˆä¸Šã€‚æ¯”å¦‚å¯¹è±¡æ‹¥æœ‰idå’Œnameä¸¤ä¸ªå­—æ®µï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå­—æ®µå°†ä¼šè¢«è§†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å±€éƒ¨å˜é‡è¿›è¡Œåˆ†é…ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ”ºé€ƒé€¸åˆ†æçš„ä¸è¶³</p>
</blockquote>
<p>å…³äºé€ƒé€¸åˆ†æçš„è®ºæ–‡åœ¨1999å¹´å°±å·²ç»å‘è¡¨äº†ï¼Œä½†ç›´åˆ°JDK1.6æ‰æœ‰å®ç°ï¼Œè€Œä¸”è¿™é¡¹æŠ€æœ¯åˆ°å¦‚ä»Šä¹Ÿå¹¶ä¸æ˜¯ååˆ†æˆç†Ÿã€‚</p>
<p>å…¶æ ¹æœ¬åŸå› å°±æ˜¯æ— æ³•ä¿è¯é€ƒé€¸åˆ†æçš„æ€§èƒ½æ¶ˆè€—ä¸€å®šèƒ½é«˜äºä»–çš„æ¶ˆè€—ã€‚è™½ç„¶ç»è¿‡é€ƒé€¸åˆ†æå¯ä»¥åšæ ‡é‡æ›¿æ¢ã€æ ˆä¸Šåˆ†é…ã€å’Œé”æ¶ˆé™¤ã€‚ä½†æ˜¯é€ƒé€¸åˆ†æè‡ªèº«ä¹Ÿæ˜¯éœ€è¦è¿›è¡Œä¸€ç³»åˆ—å¤æ‚çš„åˆ†æçš„ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹è€—æ—¶çš„è¿‡ç¨‹ã€‚ ä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼Œå°±æ˜¯ç»è¿‡é€ƒé€¸åˆ†æä¹‹åï¼Œå‘ç°æ²¡æœ‰ä¸€ä¸ªå¯¹è±¡æ˜¯ä¸é€ƒé€¸çš„ã€‚é‚£è¿™ä¸ªé€ƒé€¸åˆ†æçš„è¿‡ç¨‹å°±ç™½ç™½æµªè´¹æ‰äº†ã€‚</p>
<p>è™½ç„¶è¿™é¡¹æŠ€æœ¯å¹¶ä¸ååˆ†æˆç†Ÿï¼Œä½†æ˜¯å®ƒä¹Ÿæ˜¯å³æ—¶ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ä¸­ä¸€ä¸ªååˆ†é‡è¦çš„æ‰‹æ®µã€‚æ³¨æ„åˆ°æœ‰ä¸€äº›è§‚ç‚¹ï¼Œè®¤ä¸ºé€šè¿‡é€ƒé€¸åˆ†æï¼ŒJVMä¼šåœ¨æ ˆä¸Šåˆ†é…é‚£äº›ä¸ä¼šé€ƒé€¸çš„å¯¹è±¡ï¼Œè¿™åœ¨ç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å–å†³äºJvMè®¾è®¡è€…çš„é€‰æ‹©ã€‚æ®æˆ‘æ‰€çŸ¥ï¼Œoracle Hotspot JVMä¸­å¹¶æœªè¿™ä¹ˆåšï¼Œè¿™ä¸€ç‚¹åœ¨é€ƒé€¸åˆ†æç›¸å…³çš„æ–‡æ¡£é‡Œå·²ç»è¯´æ˜ï¼Œæ‰€ä»¥å¯ä»¥æ˜ç¡®æ‰€æœ‰çš„å¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ›å»ºåœ¨å †ä¸Šã€‚</p>
<p>ç›®å‰å¾ˆå¤šä¹¦ç±è¿˜æ˜¯åŸºäºJDK7ä»¥å‰çš„ç‰ˆæœ¬ï¼ŒJDKå·²ç»å‘ç”Ÿäº†å¾ˆå¤§å˜åŒ–ï¼Œinternå­—ç¬¦ä¸²çš„ç¼“å­˜å’Œé™æ€å˜é‡æ›¾ç»éƒ½è¢«åˆ†é…åœ¨æ°¸ä¹…ä»£ä¸Šï¼Œè€Œæ°¸ä¹…ä»£å·²ç»è¢«å…ƒæ•°æ®åŒºå–ä»£ã€‚ä½†æ˜¯ï¼Œinternå­—ç¬¦ä¸²ç¼“å­˜å’Œé™æ€å˜é‡å¹¶ä¸æ˜¯è¢«è½¬ç§»åˆ°å…ƒæ•°æ®åŒºï¼Œè€Œæ˜¯ç›´æ¥åœ¨å †ä¸Šåˆ†é…ï¼Œæ‰€ä»¥è¿™ä¸€ç‚¹åŒæ ·ç¬¦åˆå‰é¢ä¸€ç‚¹çš„ç»“è®ºï¼šå¯¹è±¡å®ä¾‹éƒ½æ˜¯åˆ†é…åœ¨å †ä¸Šã€‚</p>
<p><strong>å°ç»“</strong></p>
<p>å¹´è½»ä»£æ˜¯å¯¹è±¡çš„è¯ç”Ÿã€æˆé•¿ã€æ¶ˆäº¡çš„åŒºåŸŸï¼Œä¸€ä¸ªå¯¹è±¡åœ¨è¿™é‡Œäº§ç”Ÿã€åº”ç”¨ï¼Œæœ€åè¢«åƒåœ¾å›æ”¶å™¨æ”¶é›†ã€ç»“æŸç”Ÿå‘½ã€‚</p>
<p>è€å¹´ä»£æ”¾ç½®é•¿ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼Œé€šå¸¸éƒ½æ˜¯ä»survivoråŒºåŸŸç­›é€‰æ‹·è´è¿‡æ¥çš„Javaå¯¹è±¡ã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰ç‰¹æ®Šæƒ…å†µï¼Œæˆ‘ä»¬çŸ¥é“æ™®é€šçš„å¯¹è±¡ä¼šè¢«åˆ†é…åœ¨TLABä¸Šï¼›å¦‚æœå¯¹è±¡è¾ƒå¤§ï¼ŒJVMä¼šè¯•å›¾ç›´æ¥åˆ†é…åœ¨Edenå…¶ä»–ä½ç½®ä¸Šï¼›å¦‚æœå¯¹è±¡å¤ªå¤§ï¼Œå®Œå…¨æ— æ³•åœ¨æ–°ç”Ÿä»£æ‰¾åˆ°è¶³å¤Ÿé•¿çš„è¿ç»­ç©ºé—²ç©ºé—´ï¼ŒJVMå°±ä¼šç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ã€‚å½“GCåªå‘ç”Ÿåœ¨å¹´è½»ä»£ä¸­ï¼Œå›æ”¶å¹´è½»ä»£å¯¹è±¡çš„è¡Œä¸ºè¢«ç§°ä¸ºMinorGcã€‚</p>
<p>å½“GCå‘ç”Ÿåœ¨è€å¹´ä»£æ—¶åˆ™è¢«ç§°ä¸ºMajorGcæˆ–è€…FullGCã€‚ä¸€èˆ¬çš„ï¼ŒMinorGcçš„å‘ç”Ÿé¢‘ç‡è¦æ¯”MajorGCé«˜å¾ˆå¤šï¼Œå³è€å¹´ä»£ä¸­åƒåœ¾å›æ”¶å‘ç”Ÿçš„é¢‘ç‡å°†å¤§å¤§ä½äºå¹´è½»ä»£ã€‚</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-6(æœ¬åœ°æ–¹æ³•æ¥å£)</title>
    <url>/posts/31917/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="6-1-ğŸ³ï¸â€ğŸŒˆæœ¬åœ°æ–¹æ³•"><a href="#6-1-ğŸ³ï¸â€ğŸŒˆæœ¬åœ°æ–¹æ³•" class="headerlink" title="6.1 ğŸ³ï¸â€ğŸŒˆæœ¬åœ°æ–¹æ³•"></a>6.1 ğŸ³ï¸â€ğŸŒˆæœ¬åœ°æ–¹æ³•</h2><blockquote>
<p>ğŸ“–æ¦‚è¿°</p>
</blockquote>
<p>ç®€å•åœ°è®²ï¼Œä¸€ä¸ªNative Methodå°±æ˜¯ä¸€ä¸ªJavaè°ƒç”¨éJavaä»£ç çš„æ¥å£ã€‚ä¸€ä¸ªNative Methodæ˜¯è¿™æ ·ä¸€ä¸ªJavaæ–¹æ³•ï¼šè¯¥æ–¹æ³•çš„å®ç°ç”±éJavaè¯­è¨€å®ç°ï¼Œæ¯”å¦‚Cã€‚è¿™ä¸ªç‰¹å¾å¹¶éJavaæ‰€æŒæœ‰ï¼Œå¾ˆå¤šå…¶å®ƒçš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰è¿™ä¸€æœºåˆ¶ã€‚æ¯”å¦‚åœ¨C++ä¸­ï¼Œä½ å¯ä»¥ç”¨extern â€œCâ€å‘ŠçŸ¥C++ç¼–è¯‘å™¨å»è°ƒç”¨ä¸€ä¸ªCçš„å‡½æ•°ã€‚</p>
<p>åœ¨å®šä¹‰ä¸€ä¸ªnative methodæ—¶ï¼Œå¹¶ä¸æä¾›å®ç°ä½“ï¼ˆæœ‰äº›åƒå®šä¹‰ä¸€ä¸ªJava interfaceï¼‰ï¼Œå› ä¸ºå…¶å®ç°ä½“æ˜¯ç”±éJavaè¯­è¨€åœ¨å¤–é¢å®ç°çš„ã€‚</p>
<blockquote>
<p>ğŸ”¨ä½œç”¨</p>
</blockquote>
<p>æœ¬åœ°æ¥å£çš„ä½œç”¨æ˜¯<strong>èåˆä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¸ºJavaæ‰€ç”¨</strong>ï¼Œå®ƒçš„åˆè¡·æ˜¯èåˆC/C++ç¨‹åºã€‚</p>
<p>æœ‰äº›å±‚æ¬¡çš„ä»»åŠ¡ç”¨Javaå®ç°èµ·æ¥ä¸å®¹æ˜“ï¼Œæˆ–è€…åœ¨æ„ç¨‹åºçš„æ•ˆç‡æ—¶ï¼Œé—®é¢˜å°±æ¥äº†ã€‚</p>
<ol>
<li><p>ä¸Javaç¯å¢ƒå¤–äº¤äº’</p>
<p>æœ‰æ—¶Javaåº”ç”¨éœ€è¦ä¸Javaå¤–é¢çš„ç¯å¢ƒäº¤äº’ï¼Œè¿™æ˜¯æœ¬åœ°æ–¹æ³•å­˜åœ¨çš„ä¸»è¦åŸå› ã€‚</p>
<p>æœ¬åœ°æ–¹æ³•å¯ä»¥æä¾›ä¸åº•å±‚ç³»ç»Ÿï¼Œå¦‚æ“ä½œç³»ç»Ÿæˆ–æŸäº›ç¡¬ä»¶äº¤æ¢ä¿¡æ¯æ—¶çš„æƒ…å†µã€‚</p>
<p>å®ƒä¸ºæˆ‘ä»¬æä¾›ä¸€ä¸ªéå¸¸ç®€æ´çš„æ¥å£ï¼Œè€Œä¸”æˆ‘ä»¬æ— éœ€å»äº†è§£Javaåº”ç”¨ä¹‹å¤–çš„ç¹ççš„ç»†èŠ‚ã€‚</p>
</li>
<li><p>ä¸æ“ä½œç³»ç»Ÿäº¤äº’</p>
<p>JVMæ”¯æŒç€Javaè¯­è¨€æœ¬èº«å’Œè¿è¡Œæ—¶åº“ï¼Œå®ƒæ˜¯Javaç¨‹åºèµ–ä»¥ç”Ÿå­˜çš„å¹³å°ï¼Œå®ƒç”±ä¸€ä¸ªè§£é‡Šå™¨ï¼ˆè§£é‡Šå­—èŠ‚ç ï¼‰å’Œä¸€äº›è¿æ¥åˆ°æœ¬åœ°ä»£ç çš„åº“ç»„æˆã€‚ç„¶è€Œä¸ç®¡æ€æ ·ï¼Œå®ƒæ¯•ç«Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿï¼Œå®ƒç»å¸¸ä¾èµ–äºä¸€äº›åº•å±‚ç³»ç»Ÿçš„æ”¯æŒã€‚è¿™äº›åº•å±‚ç³»ç»Ÿå¸¸å¸¸æ˜¯å¼ºå¤§çš„æ“ä½œç³»ç»Ÿã€‚é€šè¿‡ä½¿ç”¨æœ¬åœ°æ–¹æ³•ï¼Œæˆ‘ä»¬å¾—ä»¥ç”¨Javaå®ç°äº†jreä¸åº•å±‚ç³»ç»Ÿçš„äº¤äº’ï¼Œç”šè‡³JVMçš„ä¸€äº›éƒ¨åˆ†å°±æ˜¯ç”¨Cå†™çš„ã€‚è¿˜æœ‰ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ä¸€äº›Javaè¯­è¨€æœ¬èº«æ²¡æœ‰æä¾›å°è£…çš„æ“ä½œç³»ç»Ÿçš„ç‰¹æ€§æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä½¿ç”¨æœ¬åœ°æ–¹æ³•ã€‚</p>
</li>
<li><p>Sunâ€™s Java</p>
<p>Sunçš„è§£é‡Šå™¨æ˜¯ç”¨Cå®ç°çš„ï¼Œè¿™ä½¿å¾—å®ƒèƒ½åƒä¸€äº›æ™®é€šçš„Cä¸€æ ·ä¸å¤–éƒ¨äº¤äº’ã€‚jreå¤§éƒ¨åˆ†æ˜¯ç”¨Javaå®ç°çš„ï¼Œå®ƒä¹Ÿé€šè¿‡ä¸€äº›æœ¬åœ°æ–¹æ³•ä¸å¤–ç•Œäº¤äº’ã€‚ä¾‹å¦‚ï¼š<code>java.lang.Thread</code>çš„<code>setPriority()</code>æ–¹æ³•æ˜¯ç”¨Javaå®ç°çš„ï¼Œä½†æ˜¯å®ƒå®ç°è°ƒç”¨çš„æ˜¯è¯¥ç±»é‡Œçš„æœ¬åœ°æ–¹æ³•<code>setPriority()</code>ã€‚è¿™ä¸ªæœ¬åœ°æ–¹æ³•æ˜¯ç”¨Cå®ç°çš„ï¼Œå¹¶è¢«æ¤å…¥JVMå†…éƒ¨ï¼Œåœ¨<code>Windows 95</code>çš„å¹³å°ä¸Šï¼Œè¿™ä¸ªæœ¬åœ°æ–¹æ³•æœ€ç»ˆå°†è°ƒç”¨<code>Win 32 SetPriority() API</code>ã€‚è¿™æ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•çš„å…·ä½“å®ç°ç”±JVMç›´æ¥æä¾›ï¼Œæ›´å¤šçš„æƒ…å†µæ˜¯æœ¬åœ°æ–¹æ³•ç”±å¤–éƒ¨çš„åŠ¨æ€é“¾æ¥åº“ï¼ˆ<code>external dynamic link library</code>ï¼‰æä¾›ï¼Œç„¶åè¢«JVMè°ƒç”¨ã€‚</p>
</li>
</ol>
<blockquote>
<p>âŒ¨ï¸ä¸¾ä¾‹</p>
</blockquote>
<pre><code class="java">public class IHaveNatives &#123;

    public native void Native1(int x);

    native static public long Native2();

    native synchronized private float Native3(Object obj);

    native void Native4(int[] array) throws Exception;

&#125;</code></pre>
<p>æ ‡è¯†ç¬¦<code>native</code>å¯ä»¥ä¸æ‰€æœ‰å…¶ä»–çš„Javaæ ‡è¯†ç¬¦è¿ç”¨ï¼Œä½†æ˜¯<code>abstract</code>é™¤å¤–ã€‚</p>
<h2 id="6-2-ğŸ¨æœ¬åœ°æ–¹æ³•æ ˆ"><a href="#6-2-ğŸ¨æœ¬åœ°æ–¹æ³•æ ˆ" class="headerlink" title="6.2 ğŸ¨æœ¬åœ°æ–¹æ³•æ ˆ"></a>6.2 ğŸ¨æœ¬åœ°æ–¹æ³•æ ˆ</h2><blockquote>
<p>ğŸ“–æ¦‚è¿°</p>
</blockquote>
<ul>
<li><p>Javaè™šæ‹Ÿæœºæ ˆç”¨äºç®¡ç†Javaæ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆç”¨äºç®¡ç†æœ¬åœ°æ–¹æ³•çš„è°ƒç”¨ã€‚</p>
</li>
<li><p>æœ¬åœ°æ–¹æ³•æ ˆï¼Œä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</p>
</li>
<li><p>å…è®¸è¢«å®ç°æˆå›ºå®šæˆ–è€…æ˜¯å¯åŠ¨æ€æ‰©å±•çš„å†…å­˜å¤§å°ã€‚</p>
<ul>
<li>å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡æœ¬åœ°æ–¹æ³•æ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª<code>StackOverflowError</code>å¼‚å¸¸ã€‚</li>
<li>å¦‚æœæœ¬åœ°æ–¹æ³•æ ˆå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„æœ¬åœ°æ–¹æ³•æ ˆï¼Œé‚£ä¹ˆJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ª<code>OutofMemoryError</code>å¼‚å¸¸ã€‚</li>
</ul>
</li>
<li><p>æœ¬åœ°æ–¹æ³•æ˜¯ä½¿ç”¨Cè¯­è¨€å®ç°çš„ã€‚</p>
</li>
<li><p>å®ƒçš„å…·ä½“åšæ³•æ˜¯<code>Native Method Stack</code>ä¸­ç™»è®°nativeæ–¹æ³•ï¼Œåœ¨<code>Execution Engine</code>æ‰§è¡Œæ—¶åŠ è½½æœ¬åœ°æ–¹æ³•åº“ã€‚</p>
</li>
<li><p>å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨ä¸€ä¸ªæœ¬åœ°æ–¹æ³•æ—¶ï¼Œå®ƒå°±è¿›å…¥äº†ä¸€ä¸ªå…¨æ–°çš„å¹¶ä¸”ä¸å†å—è™šæ‹Ÿæœºé™åˆ¶çš„ä¸–ç•Œã€‚å®ƒå’Œè™šæ‹Ÿæœºæ‹¥æœ‰åŒæ ·çš„æƒé™ã€‚</p>
<ul>
<li>æœ¬åœ°æ–¹æ³•å¯ä»¥é€šè¿‡æœ¬åœ°æ–¹æ³•æ¥å£æ¥å‘ä¸ªæ–‡è™šæ‹Ÿæœºå†…éƒ¨çš„è¿è¡Œæ—¶æ•°æ®åŒºã€‚</li>
<li>å®ƒç”šè‡³å¯ä»¥ç›´æ¥ä½¿ç”¨æœ¬åœ°å¤„ç†å™¨ä¸­çš„å¯„å­˜å™¨ã€‚</li>
<li>ç›´æ¥ä»æœ¬åœ°å†…å­˜çš„å †ä¸­åˆ†é…ä»»æ„æ•°é‡çš„å†…å­˜ã€‚</li>
</ul>
</li>
<li><p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„JVMéƒ½æ”¯æŒæœ¬åœ°æ–¹æ³•ã€‚å› ä¸ºJavaè™šæ‹Ÿæœºè§„èŒƒå¹¶æ²¡æœ‰æ˜ç¡®è¦æ±‚æœ¬åœ°æ–¹æ³•æ ˆçš„ä½¿ç”¨è¯­è¨€ã€å…·ä½“å®ç°æ–¹å¼ã€æ•°æ®ç»“æ„ç­‰ã€‚å¦‚æœJVMäº§å“ä¸æ‰“ç®—æ”¯æŒnativeæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ— éœ€å®ç°æœ¬åœ°æ–¹æ³•æ ˆã€‚</p>
</li>
<li><p>åœ¨Hotspot JVMä¸­ï¼Œç›´æ¥å°†æœ¬åœ°æ–¹æ³•æ ˆå’Œè™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-5(è™šæ‹Ÿæœºæ ˆ)</title>
    <url>/posts/31700/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="5-1-ğŸ“š-æ¦‚è¿°"><a href="#5-1-ğŸ“š-æ¦‚è¿°" class="headerlink" title="5.1 ğŸ“š æ¦‚è¿°"></a>5.1 ğŸ“š æ¦‚è¿°</h2><blockquote>
<p>ğŸ“Œå†…å­˜ä¸­çš„æ ˆä¸å †</p>
</blockquote>
<p>æ ˆæ˜¯è¿è¡Œæ—¶çš„å•ä½ï¼Œå †æ˜¯å­˜å‚¨æ—¶çš„å•ä½ã€‚</p>
<p>æ ˆè§£å†³ç¨‹åºçš„è¿è¡Œé—®é¢˜ï¼Œå³ç¨‹åºå¦‚ä½•æ‰§è¡Œï¼Œæˆ–è€…è¯´å¦‚ä½•å¤„ç†æ•°æ®ã€‚</p>
<p>å †è§£å†³çš„æ—¶æ•°æ®å­˜å‚¨çš„é—®é¢˜ï¼Œå³æ•°æ®æ€ä¹ˆæ”¾ã€æ”¾åœ¨å“ªå„¿ã€‚</p>
<blockquote>
<p>ğŸ“–Javaè™šæ‹Ÿæœºæ ˆ</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºæ ˆï¼Œæ—©æœŸä¹Ÿå«Javaæ ˆã€‚</p>
<p>æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ ˆï¼Œå…¶å†…éƒ¨ä¿å­˜ä¸€ä¸ªä¸ªçš„æ ˆå¸§ï¼Œå¯¹åº”ç€ä¸€æ¬¡æ¬¡çš„Javaæ–¹æ³•è°ƒç”¨ã€‚</p>
<blockquote>
<p>âŒ›ç”Ÿå‘½å‘¨æœŸ</p>
</blockquote>
<p>ä¸çº¿ç¨‹ä¸€è‡´ã€‚</p>
<blockquote>
<p>ğŸ”¨ä½œç”¨</p>
</blockquote>
<p>ä¸»ç®¡Javaç¨‹åºçš„è¿è¡Œï¼Œå®ƒä¿å­˜æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€éƒ¨åˆ†ç»“æœï¼Œå¹¶å‚ä¸æ–¹æ³•çš„è°ƒç”¨å’Œè¿”å›ã€‚</p>
<blockquote>
<p>ğŸŒ ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>æ ˆæ˜¯ä¸€ç§å¿«é€Ÿæœ‰æ•ˆçš„åˆ†é…å­˜å‚¨æ–¹å¼ï¼Œè®¿é—®é€Ÿåº¦ä»…æ¬¡äºç¨‹åºè®¡æ•°å™¨</li>
<li>JVMç›´æ¥å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼š<ul>
<li>æ¯ä¸ªæ–¹æ³•æ‰§è¡Œï¼Œä¼´éšç€è¿›æ ˆ</li>
<li>æ‰§è¡Œç»“æŸåçš„å‡ºæ ˆå·¥ä½œ</li>
</ul>
</li>
<li>å¯¹äºæ ˆæ¥è¯´ä¸å­˜åœ¨åƒåœ¾å›æ”¶é—®é¢˜</li>
</ul>
<blockquote>
<p>â—æ ˆä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºè§„èŒƒå…è®¸Javaæ ˆçš„å¤§å°æ˜¯åŠ¨æ€çš„æˆ–è€…å›ºå®šä¸å˜çš„ã€‚</p>
<ul>
<li><p>å¦‚æœé‡‡ç”¨å›ºå®šå¤§å°çš„Javaè™šæ‹Ÿæœºæ ˆï¼Œé‚£æ¯ä¸€ä¸ªçº¿ç¨‹çš„Javaè™šæ‹Ÿæœºæ ˆå®¹é‡å¯ä»¥åœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ç‹¬ç«‹é€‰å®šã€‚å¦‚æœçº¿ç¨‹è¯·æ±‚åˆ†é…çš„æ ˆå®¹é‡è¶…è¿‡Javaè™šæ‹Ÿæœºæ ˆå…è®¸çš„æœ€å¤§å®¹é‡ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ªStackOverflowErrorå¼‚å¸¸ã€‚</p>
<pre><code class="java">// æ ˆæº¢å‡ºå…¸å‹å®ä¾‹
public class StackOverflow &#123;
    public static void main(String[] args) &#123;
        new StackOverflow().keep();
    &#125;
    public void keep() &#123;
        keep();
    &#125;
&#125;</code></pre>
</li>
<li><p>å¦‚æœJavaè™šæ‹Ÿæœºå¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå¹¶ä¸”åœ¨å°è¯•æ‰©å±•çš„æ—¶å€™æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œæˆ–è€…åœ¨åˆ›å»ºæ–°çš„çº¿ç¨‹æ—¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å»åˆ›å»ºå¯¹åº”çš„è™šæ‹Ÿæœºæ ˆï¼Œé‚£Javaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡ºä¸€ä¸ªOutOfMemoryErrorå¼‚å¸¸ã€‚</p>
</li>
</ul>
<h2 id="5-2-ğŸ”³-æ ˆçš„å­˜å‚¨å•ä½"><a href="#5-2-ğŸ”³-æ ˆçš„å­˜å‚¨å•ä½" class="headerlink" title="5.2 ğŸ”³ æ ˆçš„å­˜å‚¨å•ä½"></a>5.2 ğŸ”³ æ ˆçš„å­˜å‚¨å•ä½</h2><blockquote>
<p>ğŸ“¦æ ˆä¸­å­˜å‚¨ä»€ä¹ˆ</p>
</blockquote>
<ul>
<li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆï¼Œæ ˆä¸­çš„æ•°æ®éƒ½æ˜¯ä»¥æ ˆå¸§(Stack Frame)çš„æ ¼å¼å­˜åœ¨ã€‚</li>
<li>åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šæ­£åœ¨æ‰§è¡Œçš„æ¯ä¸ªæ–¹æ³•éƒ½å„è‡ªå¯¹åº”ä¸€ä¸ªæ ˆå¸§(Stack Frame)ã€‚</li>
<li>æ ˆå¸§æ˜¯ä¸€ä¸ªå†…å­˜åŒºå—ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®é›†ï¼Œç»´ç³»ç€æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§æ•°æ®ä¿¡æ¯ã€‚</li>
</ul>
<blockquote>
<p>ğŸ”æ ˆçš„è¿è¡ŒåŸç†</p>
</blockquote>
<ul>
<li>JVMç›´æ¥å¯¹Javaæ ˆçš„æ“ä½œåªæœ‰ä¸¤ä¸ªï¼Œå°±æ˜¯å¯¹æ ˆå¸§çš„å‹æ ˆå’Œå‡ºæ ˆï¼Œéµå¾ªâ€œå…ˆè¿›åå‡ºâ€æˆ–è€…â€œåè¿›å…ˆå‡ºâ€åŸåˆ™ã€‚</li>
<li>åœ¨ä¸€æ¡æ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œåªä¼šæœ‰ä¸€ä¸ªæ´»åŠ¨çš„æ ˆå¸§ã€‚å³åªæœ‰å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•çš„æ ˆå¸§ï¼ˆæ ˆé¡¶æ ˆå¸§ï¼‰æ˜¯æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªæ ˆå¸§è¢«ç§°ä¸ºå½“å‰æ ˆå¸§ï¼ˆCurrent Frameï¼‰ï¼Œä¸å½“å‰æ ˆå¸§ç›¸å¯¹åº”çš„æ–¹æ³•å°±æ˜¯å½“å‰æ–¹æ³•ï¼ˆCurrent Methodï¼‰ï¼Œå®šä¹‰è¿™ä¸ªæ–¹æ³•çš„ç±»å°±æ˜¯å½“å‰ç±»ï¼ˆCurrent Classï¼‰ã€‚</li>
<li>æ‰§è¡Œå¼•æ“è¿è¡Œçš„æ‰€æœ‰å­—èŠ‚ç æŒ‡ä»¤åªé’ˆå¯¹å½“å‰æ ˆå¸§è¿›è¡Œæ“ä½œã€‚</li>
<li>å¦‚æœåœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œå¯¹åº”çš„æ–°çš„æ ˆå¸§ä¼šè¢«åˆ›å»ºå‡ºæ¥ï¼Œæ”¾åœ¨æ ˆçš„é¡¶ç«¯ï¼Œæˆä¸ºæ–°çš„å½“å‰å¸§ã€‚</li>
<li>ä¸åŒçº¿ç¨‹ä¸­æ‰€åŒ…å«çš„æ ˆå¸§æ˜¯ä¸å…è®¸å­˜åœ¨ç›¸äº’å¼•ç”¨çš„ï¼Œå³ä¸å¯èƒ½åœ¨ä¸€ä¸ªå¸§ä¹‹ä¸­å¼•ç”¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„æ ˆå¸§ã€‚</li>
<li>å¦‚æœå½“å‰æ–¹æ³•è°ƒç”¨äº†å…¶ä»–æ–¹æ³•ï¼Œæ–¹æ³•è¿”å›ä¹‹é™…ï¼Œå½“å‰æ ˆå¸§ä¼šä¼ å›æ­¤æ–¹æ³•çš„æ‰§è¡Œç»“æœç»™å‰ä¸€ä¸ªæ ˆå¸§ï¼Œæ¥ç€ï¼Œè™šæ‹Ÿæœºä¼šä¸¢å¼ƒå½“å‰æ ˆå¸§ï¼Œä½¿å¾—å‰ä¸€ä¸ªæ ˆå¸§é‡æ–°æˆä¸ºå½“å‰æ ˆå¸§ã€‚</li>
<li>Javaæ–¹æ³•æœ‰ä¸¤ç§è¿”å›å‡½æ•°çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯æ­£å¸¸çš„å‡½æ•°è¿”å›ï¼Œä½¿ç”¨returnæŒ‡ä»¤ï¼›å¦å¤–ä¸€ç§æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚ä¸ç®¡ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½ä¼šå¯¼è‡´æ ˆå¸§è¢«å¼¹å‡ºã€‚</li>
</ul>
<blockquote>
<p>ğŸ”©æ ˆå¸§å†…éƒ¨ç»“æ„</p>
</blockquote>
<ul>
<li>å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰</li>
<li>æ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰</li>
<li>åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰</li>
<li>æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰</li>
<li>ä¸€äº›é™„åŠ ä¿¡æ¯</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/31700/image-20210131221048905.png" class="" title="image-20210131221048905">





<h2 id="5-3-ğŸ“…-å±€éƒ¨å˜é‡è¡¨"><a href="#5-3-ğŸ“…-å±€éƒ¨å˜é‡è¡¨" class="headerlink" title="5.3 ğŸ“… å±€éƒ¨å˜é‡è¡¨"></a>5.3 ğŸ“… å±€éƒ¨å˜é‡è¡¨</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>å±€éƒ¨å˜é‡è¡¨ä¹Ÿè¢«ç§°ä¹‹ä¸ºå±€éƒ¨å˜é‡æ•°ç»„æˆ–æœ¬åœ°å˜é‡è¡¨ã€‚</li>
<li>å®šä¹‰ä¸ºä¸€ä¸ªæ•°å­—æ•°ç»„ï¼Œä¸»è¦ç”¨äºå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå®šä¹‰åœ¨æ–¹æ³•ä½“å†…çš„å±€éƒ¨å˜é‡ï¼Œè¿™äº›æ•°æ®ç±»å‹åŒ…æ‹¬å„ç±»åŸºæœ¬æ•°æ®ç±»å‹ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceï¼‰ï¼Œä»¥åŠreturnAddressç±»å‹ã€‚</li>
<li>ç”±äºå±€éƒ¨å˜é‡è¡¨ç¤ºå»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šï¼Œæ˜¯çº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œå› æ­¤ä¸å­˜åœ¨æ•°æ®å®‰å…¨é—®é¢˜ã€‚</li>
<li>å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å®¹é‡å¤§å°æ˜¯åœ¨ç¼–è¯‘æœŸç¡®å®šä¸‹æ¥ï¼Œå¹¶ä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§çš„maximum local variablesç±»å‹ã€‚</li>
<li>ç”±äºå±€éƒ¨å˜é‡è¡¨æ˜¯å»ºç«‹åœ¨çº¿ç¨‹çš„æ ˆä¸Šï¼Œæ˜¯çº¿ç¨‹çš„ç§æœ‰æ•°æ®ï¼Œå› æ­¤ä¸å­˜åœ¨æ•°æ®å®‰å…¨é—®é¢˜ã€‚</li>
<li>å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å®¹é‡å¤§å°æ˜¯åœ¨ç¼–è¯‘å™¨ç¡®å®šä¸‹æ¥çš„ï¼Œå¹¶ä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§çš„maximum local variablesæ•°æ®é¡¹ä¸­ã€‚åœ¨æ–¹æ³•è¿è¡ŒæœŸé—´æ˜¯ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°çš„ã€‚</li>
<li>æ–¹æ³•åµŒå¥—è°ƒç”¨çš„æ¬¡æ•°ç”±æ ˆçš„å¤§å°å†³å®šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ ˆè¶Šå¤§ï¼Œæ–¹æ³•åµŒå¥—è°ƒç”¨æ¬¡æ•°è¶Šå¤šã€‚å¯¹ä¸€ä¸ªå‡½æ•°è€Œè¨€ï¼Œå®ƒçš„å‚æ•°å’Œå±€éƒ¨å˜é‡è¶Šå¤šï¼Œä½¿å¾—å±€éƒ¨å˜é‡è¡¨è†¨èƒ€ï¼Œå®ƒçš„æ ˆå¸§å°±è¶Šå¤§ï¼Œä»¥æ»¡è¶³æ–¹æ³•è°ƒç”¨æ‰€éœ€ä¼ é€’çš„ä¿¡æ¯å¢å¤§çš„éœ€æ±‚ã€‚è¿›è€Œå‡½æ•°è°ƒç”¨å°±ä¼šå ç”¨æ›´å¤šçš„æ ˆç©ºé—´ï¼Œå¯¼è‡´å…¶åµŒå¥—è°ƒç”¨æ¬¡æ•°å°±ä¼šå‡å°‘ã€‚</li>
<li>å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡åªåœ¨å½“å‰æ–¹æ³•è°ƒç”¨ä¸­æœ‰æ•ˆã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºé€šè¿‡ä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆå‚æ•°å€¼åˆ°å‚æ•°å˜é‡åˆ—è¡¨çš„ä¼ é€’è¿‡ç¨‹ã€‚å½“æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œéšç€æ–¹æ³•æ ˆå¸§çš„é”€æ¯ï¼Œå±€éƒ¨å˜é‡è¡¨ä¹Ÿä¼šéšä¹‹é”€æ¯ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“¬Slot</p>
</blockquote>
<ul>
<li><p>å‚æ•°å€¼çš„å­˜æ”¾æ€»æ˜¯åœ¨å±€éƒ¨å˜é‡æ•°ç»„çš„index0å¼€å§‹ï¼Œåˆ°æ•°ç»„é•¿åº¦-1çš„ç´¢å¼•ç»“æŸã€‚</p>
</li>
<li><p>å±€éƒ¨å˜é‡è¡¨ï¼Œæœ€åŸºæœ¬çš„å­˜å‚¨å•å…ƒæ˜¯Slotï¼ˆå˜é‡æ§½ï¼‰ã€‚</p>
</li>
<li><p>å±€éƒ¨å˜é‡è¡¨ä¸­å­˜æ”¾ç¼–è¯‘å™¨å¯çŸ¥çš„å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼ˆ8ç§ï¼‰ï¼Œå¼•ç”¨ç±»å‹ï¼ˆreferenceï¼‰ï¼ŒreturnAddressç±»å‹çš„å˜é‡ã€‚</p>
</li>
<li><p>åœ¨å±€éƒ¨å˜é‡è¡¨é‡Œï¼Œ32ä½ä»¥å†…çš„ç±»å‹åªå ç”¨ä¸€ä¸ªSlotï¼ˆåŒ…æ‹¬returnAddressç±»å‹ï¼‰ï¼Œ64ä½çš„ç±»å‹ï¼ˆlongå’Œdoubleï¼‰å ç”¨ä¸¤ä¸ªslotã€‚</p>
<ul>
<li>byteã€shortã€charåœ¨å­˜å‚¨å‰è¢«è½¬æ¢ä¸ºintï¼Œbooleanä¹Ÿè¢«è½¬æ¢ä¸ºintï¼Œ0è¡¨ç¤ºfalseï¼Œé0è¡¨ç¤ºtrueã€‚</li>
<li>longå’Œdoubleåˆ™å æ®ä¸¤ä¸ªSlotã€‚</li>
</ul>
</li>
<li><p>JVMä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªSlotéƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å‘ƒå±€éƒ¨å˜é‡å€¼ã€‚</p>
</li>
<li><p>å½“ä¸€ä¸ªå®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„æ–¹æ³•å‚æ•°å’Œæ–¹æ³•ä½“å†…éƒ¨å®šä¹‰çš„å±€éƒ¨ä¾¿ä»¤éƒ½ä¼šæŒ‰ç…§é¡ºåºè¢«å¤åˆ¶åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼ã€‚</p>
</li>
<li><p>å¦‚æœéœ€è¦è®¿é—®å±€éƒ¨å˜é‡è¡¨ä¸­ä¸€ä¸ª64bitçš„å±€éƒ¨å˜é‡å€¼æ—¶ï¼Œåªéœ€è¦ä½¿ç”¨å‰ä¸€ä¸ªç´¢å¼•å³å¯ã€‚</p>
</li>
<li><p>å¦‚æœå½“å‰å¸§æ˜¯ç”±æ„é€ æ–¹æ³•æˆ–è€…å®ä¾‹æ–¹æ³•åˆ›å»ºçš„ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å¼•ç”¨thiså°†ä¼šå­˜æ”¾åœ¨indexä¸º0çš„slotå¤„ï¼Œå…¶ä½™çš„å‚æ•°æŒ‰ç…§å‚æ•°è¡¨é¡ºåºç»§ç»­æ’åºã€‚</p>
</li>
<li><p>JVMä¼šä¸ºå±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªSlotéƒ½åˆ†é…ä¸€ä¸ªè®¿é—®ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å³å¯æˆåŠŸè®¿é—®åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­æŒ‡å®šçš„å±€éƒ¨å˜é‡å€¼ã€‚</p>
</li>
<li><p>å½“ä¸€ä¸ªå®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„æ–¹æ³•å‚æ•°å’Œæ–¹æ³•ä½“å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡å°†ä¼šæŒ‰ç…§é¡ºåºè¢«å¤åˆ¶åˆ°å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ¯ä¸€ä¸ªSlotä¸Šã€‚</p>
</li>
<li><p>å¦‚æœéœ€è¦è®¿é—®å±€éƒ¨å˜é‡è¡¨ä¸­ä¸€ä¸ª64bitçš„å±€éƒ¨å˜é‡å€¼æ—¶ï¼Œåªéœ€è¦ä½¿ç”¨å‰ä¸€ä¸ªç´¢å¼•å³å¯ã€‚</p>
</li>
<li><p>å¦‚æœå½“å‰å¸§æ˜¯ç”±æ„é€ æ–¹æ³•æˆ–è€…å®ä¾‹æ–¹æ³•åˆ›å»ºçš„ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å¼•ç”¨thiså°†ä¼šå­˜æ”¾åœ¨indexä¸º0çš„Slotå¤„ï¼Œå…¶ä½™çš„å‚æ•°æŒ‰ç…§å‚æ•°è¡¨çš„é¡ºåºç»§ç»­æ’åˆ—ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ—³Slotçš„é‡å¤åˆ©ç”¨</p>
</blockquote>
<p>æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡è¡¨ä¸­çš„æ§½ä½æ˜¯å¯ä»¥é‡ç”¨çš„ï¼Œå¦‚æœä¸€ä¸ªå±€éƒ¨å˜é‡è¿‡äº†å…¶ä½œç”¨åŸŸï¼Œé‚£ä¹ˆåœ¨å…¶ä½œç”¨åŸŸä¹‹åç”³æ˜çš„æ–°çš„å±€éƒ¨å˜é‡å°±å¾ˆæœ‰å¯èƒ½ä¼šå¤ç”¨è¿‡æœŸå±€éƒ¨å˜é‡çš„æ§½ä½ï¼Œä»è€Œè¾¾åˆ°èŠ‚çœèµ„æºçš„ç›®çš„ã€‚</p>
<blockquote>
<p>é™æ€å˜é‡ ğŸ†š å±€éƒ¨å˜é‡</p>
</blockquote>
<p>å˜é‡æŒ‰ç…§åœ¨ç±»ä¸­å£°æ˜çš„ä½ç½®åˆ†ï¼š</p>
<ul>
<li>æˆå‘˜å˜é‡ï¼šåœ¨ä½¿ç”¨å‰ï¼Œéƒ½ç»å†è¿‡é»˜è®¤åˆå§‹åŒ–å€¼<ul>
<li>é™æ€å˜é‡ï¼ˆç±»å˜é‡/staticå˜é‡ï¼‰ï¼šé“¾æ¥çš„å‡†å¤‡é˜¶æ®µï¼Œç»™ç±»å˜é‡é»˜è®¤èµ‹å€¼ â€”&gt; initialé˜¶æ®µï¼šç»™ç±»å˜é‡æ˜¾ç¤ºèµ‹å€¼å³é™æ€ä»£ç å—èµ‹å€¼ã€‚</li>
<li>å®ä¾‹å˜é‡ï¼ˆéstaticå˜é‡ï¼‰ï¼šéšç€å¯¹è±¡çš„åˆ›å»ºï¼Œä¼šåœ¨å †ç©ºé—´ä¸­åˆ†é…å®ä¾‹å˜é‡ç©ºé—´ï¼Œå¹¶è¿›è¡Œé»˜è®¤èµ‹å€¼ã€‚</li>
</ul>
</li>
<li>å±€éƒ¨å˜é‡ï¼šåœ¨ä½¿ç”¨å‰ï¼Œå¿…é¡»è¦è¿›è¡Œæ˜¾ç¤ºèµ‹å€¼ï¼Œå¦åˆ™ç¼–è¯‘ä¸é€šè¿‡ã€‚</li>
</ul>
<blockquote>
<p>ğŸ””è¡¥å……</p>
</blockquote>
<ul>
<li>åœ¨æ ˆå¸§ä¸­ï¼Œä¸æ€§èƒ½è°ƒä¼˜å…³ç³»æœ€ä¸ºå¯†åˆ‡çš„éƒ¨åˆ†å°±æ˜¯å‰é¢æåˆ°çš„å±€éƒ¨å˜é‡è¡¨ã€‚åœ¨æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºä½¿ç”¨å±€éƒ¨å˜é‡è¡¨å®Œæˆæ–¹æ³•çš„ä¼ é€’ã€‚</li>
<li>å±€éƒ¨å˜é‡è¡¨ä¸­çš„å˜é‡ä¹Ÿæ˜¯é‡è¦çš„åƒåœ¾å›æ”¶æ ¹èŠ‚ç‚¹ï¼Œåªè¦è¢«å±€éƒ¨å˜é‡è¡¨ä¸­ç›´æ¥æˆ–ç®€ä»‹å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶ã€‚</li>
</ul>
<h2 id="5-4-ğŸ“¥-æ“ä½œæ•°æ ˆ"><a href="#5-4-ğŸ“¥-æ“ä½œæ•°æ ˆ" class="headerlink" title="5.4 ğŸ“¥ æ“ä½œæ•°æ ˆ"></a>5.4 ğŸ“¥ æ“ä½œæ•°æ ˆ</h2><blockquote>
<p>ğŸ’¬æ¦‚è¿°</p>
</blockquote>
<ul>
<li>æ¯ä¸€ä¸ªç‹¬ç«‹åœ°æ ˆå¸§ä¸­é™¤äº† åŒ…å«å±€éƒ¨å˜é‡è¡¨ä»¥å¤–ï¼Œè¿˜åŒ…å«ä¸€ä¸ªåè¿›å…ˆå‡ºï¼ˆLast-In-First-Outï¼‰çš„æ“ä½œæ•°æ ˆï¼Œä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºè¡¨è¾¾å¼æ ˆï¼ˆExpress Stackï¼‰ã€‚</li>
<li>æ“ä½œæ•°æ ˆï¼Œåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å­—èŠ‚ç æŒ‡ä»¤ï¼Œå¾€æ ˆä¸­å†™å…¥æ•°æ®æˆ–æå–æ•°æ®ï¼Œå³å…¥æ ˆ(push)/å‡ºæ ˆ(pop)ã€‚<ul>
<li>æŸäº›å­—èŠ‚ç æŒ‡ä»¤å°†å€¼å‹å…¥æ“ä½œæ•°æ ˆï¼Œå…¶ä½™çš„å­—èŠ‚ç æŒ‡ä»¤å°†æ“ä½œæ•°å–å‡ºæ ˆã€‚ä½¿ç”¨å®ƒä»¬åå†æŠŠç»“æœå‹å…¥æ ˆã€‚</li>
<li>æ¯”å¦‚ï¼šæ‰§è¡Œå¤åˆ¶ã€äº¤æ¢ã€æ±‚å’Œç­‰æ“ä½œã€‚</li>
</ul>
</li>
<li>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•å¸¦æœ‰è¿”å›å€¼çš„è¯ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å‹å…¥å½“å‰æ ˆå¸§çš„æ“ä½œæ•°æ ˆä¸­ï¼Œå¹¶æ›´æ–°PCå¯„å­˜å™¨ä¸­ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</li>
<li>æ“ä½œæ•°æ ˆä¸­å…ƒç´ çš„æ•°æ®ç±»å‹å¿…é¡»ä¸å­—èŠ‚ç æŒ‡ä»¤çš„åºåˆ—ä¸¥æ ¼åŒ¹é…ï¼Œè¿™ç”±ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸé—´è¿›è¡ŒéªŒè¯ï¼ŒåŒæ—¶åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„ç±»æ£€éªŒé˜¶æ®µçš„æ•°æ®æµåˆ†æé˜¶æ®µè¦å†æ¬¡éªŒè¯ã€‚</li>
<li>Javaè™šæ‹Ÿæœºçš„è§£é‡Šå¼•æ“åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“ï¼Œå…¶ä¸­çš„æ ˆæŒ‡çš„å°±æ˜¯æ“ä½œæ•°æ ˆã€‚</li>
</ul>
<blockquote>
<p>ğŸ“–ç†è®º</p>
</blockquote>
<ul>
<li>æ“ä½œæ•°æ ˆï¼Œä¸»è¦ç”¨äºä¿å­˜è®¡ç®—è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼ŒåŒæ—¶ä½œä¸ºè®¡ç®—è¿‡ç¨‹ä¸­å˜é‡ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´ã€‚</li>
<li>æ“ä½œæ•°æ ˆå°±æ˜¯JVMæ‰§è¡Œå¼•æ“çš„ä¸€ä¸ªå·¥ä½œåŒºï¼Œå½“ä¸€ä¸ªæ–¹æ³•åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§ä¹Ÿä¼šéšä¹‹è¢«åˆ›å»ºå‡ºæ¥ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„ã€‚</li>
<li>æ¯ä¸€ä¸ªæ“ä½œæ•°æ ˆéƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ˆæ·±åº¦ç”¨äºå­˜å‚¨æ•°å€¼ï¼Œå…¶æ‰€éœ€çš„æœ€å¤§æ·±åº¦åœ¨ç¼–è¯‘æœŸå°±å®šä¹‰å¥½äº†ï¼Œä¿å­˜åœ¨æ–¹æ³•çš„Codeå±æ€§ä¸­ï¼Œä¸ºmax_stackçš„å€¼ã€‚</li>
<li>æ ˆä¸­çš„ä»»ä½•ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯å¯ä»¥ä»»æ„çš„Javaæ•°æ®ç±»å‹ã€‚<ul>
<li>32bitçš„ç±»å‹å ç”¨ä¸€ä¸ªæ ˆå•ä½æ·±åº¦ã€‚</li>
<li>64bitçš„ç±»å‹å ç”¨ä¸¤ä¸ªæ ˆå•ä½æ·±åº¦ã€‚</li>
</ul>
</li>
<li>æ“ä½œæ•°æ ˆå¹¶éé‡‡ç”¨è®¿é—®ç´¢å¼•çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®è®¿é—®çš„ã€‚è€Œæ˜¯åªèƒ½é€šè¿‡æ ‡å‡†çš„å…¥æ ˆ(push)å’Œå‡ºæ ˆ(pop)æ“ä½œæ¥å®Œæˆä¸€æ¬¡æ•°æ®è®¿é—®ã€‚</li>
</ul>
<h2 id="5-5-ğŸ“¡-ä»£ç è¿½è¸ª"><a href="#5-5-ğŸ“¡-ä»£ç è¿½è¸ª" class="headerlink" title="5.5 ğŸ“¡ ä»£ç è¿½è¸ª"></a>5.5 ğŸ“¡ ä»£ç è¿½è¸ª</h2><blockquote>
<p>âŒ¨ï¸ä»£ç </p>
</blockquote>
<pre><code class="java">public class OperandStackTest &#123;

    public int getSum() &#123;
        int m = 10;
        int n = 20;
        int k = m + n;
        return k;
    &#125;

    public void testGetSum() &#123;
        // è·å–ä¸Šä¸€ä¸ªæ ˆå¸§è¿”å›çš„ç»“æœï¼Œå¹¶ä¿å­˜åœ¨æ“ä½œæ•°æ ˆä¸­
        int i = getSum();
        int j = 10;
    &#125;

&#125;</code></pre>
<blockquote>
<p>ğŸ”è§£æ</p>
</blockquote>
<p>jclasslibå­—èŠ‚ç å¦‚ä¸‹ï¼š</p>
<ul>
<li>getSumå‡½æ•°</li>
</ul>
<pre><code class="java">æŒ‡ä»¤åœ°å€ æ“ä½œæŒ‡ä»¤
     0 bipush 10  // å°†10å‹å…¥æ“ä½œæ•°æ ˆ
     2 istore_1   // æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®
     3 bipush 20  // å°†20å‹å…¥æ“ä½œæ•°æ ˆ
     5 istore_2   // æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½®
     6 iload_1    // ä»å±€éƒ¨å˜é‡è¡¨ä¸­å–å‡ºç´¢å¼•ä¸º1çš„æ•°æ®ï¼Œå‹å…¥æ“ä½œæ•°æ ˆ
     7 iload_2    // ä»å±€éƒ¨å˜é‡è¡¨ä¸­å–å‡ºç´¢å¼•ä¸º2çš„æ•°æ®ï¼Œå‹å…¥æ“ä½œæ•°æ ˆ
     8 iadd       // å°†æ ˆé¡¶çš„ä¸¤ä¸ªæ•°å‡ºæ ˆå¹¶ç›¸åŠ ï¼Œå‹å›æ“ä½œæ•°æ ˆ
     9 istore_3   // æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨
    10 ireturn    // ä»å½“å‰å¸§çš„æ“ä½œæ•°æ ˆå¼¹å‡ºå€¼ï¼Œå¹¶å°†å…¶å‹å…¥è°ƒç”¨è€…çš„å¸§çš„æ“ä½œæ•°æ ˆï¼Œå½“å‰æ–¹æ³•çš„æ“ä½œæ•°å †æ ˆä¸Šçš„ä»»ä½•å…¶ä»–å€¼éƒ½å°†è¢«ä¸¢å¼ƒ</code></pre>
<ul>
<li>testGetSumå‡½æ•°</li>
</ul>
<pre><code class="java">æŒ‡ä»¤åœ°å€ æ“ä½œæŒ‡ä»¤   
    0 aload_0      // åŠ è½½thiså˜é‡ï¼Œå°†thisçš„å¼•ç”¨å‹å…¥æ“ä½œæ•°æ ˆ
    1 invokevirtual #2 &lt;top/parak/OperandStackTest.getSum&gt; // è°ƒç”¨this.getSumæ–¹æ³•
    4 istore_1     // å°†æ–¹æ³•è¿”å›å€¼å­˜å‚¨åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®
    5 bipush 10    // å°†10å‹å…¥æ“ä½œæ•°æ ˆ
    7 istore_2     // æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½®
    8 return       // ç›´æ¥è¿”å›</code></pre>
<blockquote>
<p>i++ ğŸ†š ++i</p>
</blockquote>
<p>æºä»£ç ï¼š</p>
<pre><code class="java">public void add() &#123;
    int i1 = 10;
    int i3 = i1++;

    int i2 = 10;
    int i4 = ++i2;
&#125;</code></pre>
<p>å­—èŠ‚ç ï¼š</p>
<pre><code class="java">æŒ‡ä»¤åœ°å€ æ“ä½œæŒ‡ä»¤ 
     0 bipush 10    // å°†10å‹å…¥æ“ä½œæ•°æ ˆ
     2 istore_1     // æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½® 
     3 iload_1      // ä»å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1ä½ç½®åŠ è½½å˜é‡åˆ°æ ˆå¸§ä¸­
     4 iinc 1 by 1  // å¯¹ç´¢å¼•ä¸º1ä½ç½®çš„å˜é‡è¿›è¡Œ+1æ“ä½œ 
     7 istore_2     // æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½® 
     8 bipush 10    // å°†10å‹å…¥æ“ä½œæ•°æ ˆ
    10 istore_3     // æ“ä½œæ•°æ ˆå‡ºæ ˆï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º3çš„ä½ç½® 
    11 iinc 3 by 1  // å¯¹ç´¢å¼•ä¸º3ä½ç½®çš„å˜é‡è¿›è¡Œ+1æ“ä½œ 
    14 iload_3      // ä»å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º3ä½ç½®åŠ è½½å˜é‡åˆ°æ ˆå¸§ä¸­
    15 istore 4     // å°†æ ˆå¸§çš„å€¼ä¿å­˜åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º4çš„ä½ç½®
    17 return        // è¿”å›</code></pre>
<h2 id="5-6-ğŸ“¤-æ ˆé¡¶ç¼“å­˜æŠ€æœ¯"><a href="#5-6-ğŸ“¤-æ ˆé¡¶ç¼“å­˜æŠ€æœ¯" class="headerlink" title="5.6 ğŸ“¤ æ ˆé¡¶ç¼“å­˜æŠ€æœ¯"></a>5.6 ğŸ“¤ æ ˆé¡¶ç¼“å­˜æŠ€æœ¯</h2><blockquote>
<p>ğŸ”˜èƒŒæ™¯</p>
</blockquote>
<p>ç”±äºæ“ä½œæ•°æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œå› æ­¤é¢‘ç¹åœ°æ‰§è¡Œå†…å­˜è¯»/å†™å¿…ç„¶ä¼šå½±å“æ‰§è¡Œé€Ÿåº¦ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒHotSpot JVMçš„è®¾è®¡è€…ä»¬æå‡ºäº†æ ˆé¡¶ç¼“å­˜ï¼ˆToS, Top-of-Stack Cashingï¼‰æŠ€æœ¯ï¼Œå°†æ ˆé¡¶å…ƒç´ å…¨éƒ¨ç¼“å­˜åœ¨ç‰©ç†CPUçš„å¯„å­˜å™¨ï¼ˆæŒ‡ä»¤æ›´å°‘ï¼Œé€Ÿåº¦æ›´å¿«ï¼‰ä¸­ï¼Œä»¥æ­¤é™ä½å¯¹å†…å­˜çš„è¯»/å†™æ¬¡æ•°ï¼Œæå‡æ‰§è¡Œå¼•æ“çš„æ‰§è¡Œæ•ˆç‡ã€‚</p>
<h2 id="5-7-ğŸ“-åŠ¨æ€é“¾æ¥"><a href="#5-7-ğŸ“-åŠ¨æ€é“¾æ¥" class="headerlink" title="5.7 ğŸ“ åŠ¨æ€é“¾æ¥"></a>5.7 ğŸ“ åŠ¨æ€é“¾æ¥</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>æ¯ä¸€ä¸ªæ ˆå¸§å†…éƒ¨éƒ½åŒ…å«ä¸€ä¸ªæŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨ã€‚åŒ…å«è¿™ä¸ªå¼•ç”¨çš„ç›®çš„å°±æ˜¯ä¸ºäº†æ”¯æŒå½“å‰æ–¹æ³•çš„ä»£ç èƒ½å¤Ÿå®ç°åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰ã€‚æ¯”å¦‚ï¼šinvokedynamicæŒ‡ä»¤</li>
<li>ä¸ºJavaæºæ–‡ä»¶è¢«ç¼–è¯‘åˆ°å­—èŠ‚ç æ–‡ä»¶ä¸­æ—¶ï¼Œæ‰€æœ‰çš„å˜é‡å’Œæ–¹æ³•å¼•ç”¨éƒ½ä½œä¸ºç¬¦å·å¼•ç”¨ï¼ˆSysmbolic Refrenceï¼‰ä¿å­˜åœ¨classæ–‡ä»¶çš„å¸¸é‡æ± é‡Œã€‚æ¯”å¦‚ï¼šæè¿°ä¸€ä¸ªæ–¹æ³•è°ƒç”¨äº†å¦å¤–çš„å…¶ä»–æ–¹æ³•æ—¶ï¼Œå°±æ˜¯é€šè¿‡å¸¸é‡æ± ä¸­æŒ‡å‘æ–¹æ³•çš„ç¬¦å·å¼•ç”¨æ¥è¡¨ç¤ºçš„ï¼Œé‚£ä¹ˆåŠ¨æ€é“¾æ¥çš„ä½œç”¨å°±æ˜¯ä¸ºäº†å°†è¿™äº›ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ã€‚</li>
</ul>
<blockquote>
<p>ğŸ“·å›¾ç¤º</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/31700/image-20210131234913621.png" class="" title="image-20210131234913621">



<blockquote>
<p>ğŸ”¨å¸¸é‡æ± çš„ä½œç”¨</p>
</blockquote>
<p>æä¾›ä¸€äº›ç¬¦å·å’Œå¸¸é‡ï¼Œä¾¿äºæŒ‡ä»¤çš„è¯†åˆ«ã€‚</p>
<h2 id="5-8-ğŸ”±-æ–¹æ³•çš„è°ƒç”¨ï¼šè§£æä¸åˆ†æ´¾"><a href="#5-8-ğŸ”±-æ–¹æ³•çš„è°ƒç”¨ï¼šè§£æä¸åˆ†æ´¾" class="headerlink" title="5.8 ğŸ”± æ–¹æ³•çš„è°ƒç”¨ï¼šè§£æä¸åˆ†æ´¾"></a>5.8 ğŸ”± æ–¹æ³•çš„è°ƒç”¨ï¼šè§£æä¸åˆ†æ´¾</h2><blockquote>
<p>ğŸ”—é“¾æ¥</p>
</blockquote>
<p>åœ¨JVMä¸­ï¼Œå°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºè°ƒç”¨æ–¹æ³•çš„ç›´æ¥å¼•ç”¨ä¸æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ç›¸å…³ã€‚</p>
<ul>
<li>é™æ€é“¾æ¥ï¼š</li>
</ul>
<p>å½“ä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶è¢«è£…è½½è¿›JVMå†…éƒ¨æ—¶ï¼Œå¦‚æœè¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•åœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ã€‚è¿™ç§æƒ…å†µä¸‹å°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºé™æ€é“¾æ¥ã€‚</p>
<ul>
<li>åŠ¨æ€é“¾æ¥ï¼š</li>
</ul>
<p>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸå°†è°ƒç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œç”±äºè¿™ç§å¼•ç”¨è½¬æ¢è¿‡ç¨‹å…·å¤‡åŠ¨æ€æ€§ï¼Œå› æ­¤ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºåŠ¨æ€é“¾æ¥ã€‚</p>
<blockquote>
<p>ğŸ—ç»‘å®š</p>
</blockquote>
<p>å¯¹åº”çš„æ–¹æ³•çš„ç»‘å®šæœºåˆ¶ä¸ºï¼šæ—©æœŸç»‘å®šï¼ˆEarly Bindingï¼‰å’Œæ™šæœŸç»‘å®šï¼ˆLate Bindingï¼‰ã€‚ç»‘å®šæ˜¯ä¸€ä¸ªå­—æ®µã€æ–¹æ³•æˆ–è€…ç±»åœ¨ç¬¦å·å¼•ç”¨è¢«æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ï¼Œè¿™ä»…ä»…å‘ç”Ÿä¸€æ¬¡ã€‚</p>
<ul>
<li>æ—©æœŸç»‘å®šï¼š</li>
</ul>
<p>æ—©æœŸç»‘å®šå°±æ˜¯æŒ‡è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•å¦‚æœåœ¨ç¼–è¯‘æœŸå¯çŸ¥ï¼Œä¸”è¿è¡ŒæœŸä¿æŒä¸å˜æ—¶ï¼Œå³å¯å°†è¿™ä¸ªæ–¹æ³•ä¸æ‰€å±çš„ç±»å‹è¿›è¡Œç»‘å®šï¼Œè¿™æ ·ä¸€æ¥ï¼Œç”±äºæ˜ç¡®äº†è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³•ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªï¼Œå› æ­¤ä¹Ÿå°±å¯ä»¥ä½¿ç”¨é™æ€é“¾æ¥çš„æ–¹å¼å°†ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚</p>
<ul>
<li>æ™šæœŸç»‘å®šï¼š</li>
</ul>
<p>å¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•åœ¨ç¼–è¯‘æœŸæ— æ³•è¢«ç¡®å®šä¸‹æ¥ï¼Œåªèƒ½å¤Ÿåœ¨ç¨‹åºè¿è¡ŒæœŸæ ¹æ®å®é™…çš„ç±»å‹ç»‘å®šç›¸å…³çš„æ–¹æ³•ï¼Œè¿™ç§ç»‘å®šæ–¹å¼ä¹Ÿå°±è¢«ç§°ä¹‹ä¸ºæ™šæœŸç»‘å®šã€‚</p>
<blockquote>
<p>ğŸ¹æ‹“å±•</p>
</blockquote>
<p>éšç€é«˜çº§è¯­è¨€çš„æ¨ªè·¨å‡ºä¸–ï¼Œç±»ä¼¼äºJavaä¸€æ ·çš„åŸºäºé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€å¦‚ä»Šè¶Šæ¥è¶Šå¤šï¼Œå°½ç®¡è¿™ç±»ç¼–ç¨‹è¯­è¨€åœ¨è¯­æ³•é£æ ¼ä¸Šå­˜åœ¨ä¸€å®šçš„å·®åˆ«ï¼Œä½†æ˜¯å®ƒä»¬å½¼æ­¤ä¹‹é—´å§‹ç»ˆä¿æŒç€ä¸€ä¸ªå…±æ€§ï¼Œé‚£å°±æ˜¯éƒ½æ”¯æŒå°è£…ã€ç»§æ‰¿å’Œå¤šæ€ç­‰é¢å‘å¯¹è±¡ç‰¹æ€§ï¼Œæ—¢ç„¶è¿™ä¸€ç±»çš„ç¼–ç¨‹è¯­è¨€å…·å¤‡å¤šæ€ç‰¹æ€§ï¼Œé‚£ä¹ˆè‡ªç„¶ä¹Ÿå°±å…·å¤‡æ—©æœŸç»‘å®šå’Œæ™šæœŸç»‘å®šä¸¤åªç»‘å®šæ–¹å¼ã€‚</p>
<p>Javaä¸­ä»»ä½•ä¸€ä¸ªæ™®é€šçš„æ–¹æ³•å…¶å®éƒ½å…·å¤‡å‡½æ•°çš„ç‰¹å¾ï¼Œå®ƒä»¬ç›¸å½“äºC++è¯­è¨€ä¸­çš„è™šå‡½æ•°ï¼ˆC++ä¸­åˆ™éœ€è¦ä½¿ç”¨å…³é”®å­—virtualæ¥æ˜¾ç¤ºå®šä¹‰ï¼‰ã€‚å¦‚æœåœ¨Javaç¨‹åºä¸­ä¸å¸Œæœ›æŸä¸ªæ–¹æ³•æ‹¥æœ‰ è™šå‡½æ•°çš„ç‰¹å¾æ—¶ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å…³é”®å­—<code>final</code>æ¥æ ‡è®°è¿™ä¸ªæ–¹æ³•ã€‚</p>
<blockquote>
<p>ğŸŒ€éè™šæ–¹æ³•</p>
</blockquote>
<p>å¦‚æœæ–¹æ³•åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šäº†å…·ä½“çš„è°ƒç”¨ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬åœ¨è¿è¡Œæ—¶æ˜¯ä¸å¯å˜çš„ï¼Œè¿™æ ·çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•ã€‚</p>
<ul>
<li>é™æ€æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€finalæ–¹æ³•ã€å®ä¾‹æ„é€ å™¨å’Œçˆ¶ç±»æ–¹æ³•éƒ½æ˜¯éè™šæ–¹æ³•ã€‚</li>
<li>å…¶ä»–æ–¹æ³•ç§°ä¸ºè™šæ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p> ğŸ“‘æ–¹æ³•è°ƒç”¨æŒ‡ä»¤</p>
</blockquote>
<p>æ™®é€šè°ƒç”¨æŒ‡ä»¤ï¼š</p>
<ul>
<li><code>invokestatic</code>ï¼šè°ƒç”¨é™æ€æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬</li>
<li><code>invokespecial</code>: è°ƒç”¨<init>æ–¹æ³•ã€ç§æœ‰åŠçˆ¶ç±»æ–¹æ³•ï¼Œè§£æé˜¶æ®µç¡®å®šå”¯ä¸€æ–¹æ³•ç‰ˆæœ¬</li>
<li><code>invokevirtual</code>ï¼šè°ƒç”¨æ‰€æœ‰è™šæ–¹æ³•</li>
<li><code>invokeinterface</code>: è°ƒç”¨æ¥å£æ–¹æ³•</li>
</ul>
<p>åŠ¨æ€è°ƒç”¨æŒ‡ä»¤ï¼š</p>
<ul>
<li><code>invokedynamic</code>: åŠ¨æ€è§£æå‡ºéœ€è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œ</li>
</ul>
<p>æ™®é€šè°ƒç”¨æŒ‡ä»¤å›ºåŒ–åœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œæ–¹æ³•çš„è°ƒç”¨æ‰§è¡Œä¸å¯äººä¸ºå¹²é¢„ï¼Œè€Œ<code>invokedynamic</code>æŒ‡ä»¤åˆ™æ”¯æŒç”±ç”¨æˆ·ç¡®å®šæ–¹æ³•ç‰ˆæœ¬ï¼Œå…¶ä¸­<code>invokestatic</code>æŒ‡ä»¤å’Œ<code>invokespecial</code>æŒ‡ä»¤è°ƒç”¨çš„æ–¹æ³•ç§°ä¸ºéè™šæ–¹æ³•ï¼Œå…¶ä½™çš„ï¼ˆfinalä¿®é¥°çš„é™¤å¤–ï¼‰ç§°ä¸ºè™šæ–¹æ³•ã€‚</p>
<blockquote>
<p>åŠ¨æ€ç±»å‹è¯­è¨€ğŸ†šé™æ€ç±»å‹è¯­è¨€</p>
</blockquote>
<p>åŒºåˆ«ï¼šå¯¹ç±»å‹çš„æ£€æŸ¥æ˜¯åœ¨ç¼–è¯‘æœŸè¿˜æ˜¯åœ¨è¿è¡ŒæœŸï¼Œæ»¡è¶³å‰è€…å°±æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œåä¹‹å°±æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ã€‚</p>
<p>é™æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡è‡ªèº«çš„ç±»å‹ä¿¡æ¯ï¼›åŠ¨æ€ç±»å‹è¯­è¨€æ˜¯åˆ¤æ–­å˜é‡å€¼çš„ç±»å‹ä¿¡æ¯ï¼Œå˜é‡æ²¡æœ‰ç±»å‹ä¿¡æ¯ï¼Œå˜é‡å€¼æ‰æœ‰ç±»å‹ä¿¡æ¯ï¼Œè¿™æ˜¯åŠ¨æ€è¯­è¨€çš„ä¸€ä¸ªé‡è¦ç‰¹å¾ã€‚</p>
<blockquote>
<p>ğŸ”æ–¹æ³•é‡å†™çš„æœ¬è´¨</p>
</blockquote>
<ol>
<li>æ‰¾åˆ°æ“ä½œæ•°æ ˆé¡¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ‰€æ‰§è¡Œçš„å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œè®°åšCã€‚</li>
<li>å¦‚æœåœ¨ç±»å‹Cä¸­æ‰¾åˆ°ä¸å¸¸é‡ä¸­çš„æè¿°ç¬¦åˆç®€å•åç§°éƒ½ç›¸ç¬¦çš„æ–¹æ³•ï¼Œåˆ™è¿›è¡Œè®¿é—®æƒé™æ ¡éªŒï¼Œå¦‚æœé€šè¿‡åˆ™è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç»“æŸï¼›å¦‚æœä¸é€šè¿‡ï¼Œåˆ™è¿”å›<code>java.lang.IllegalAccessError</code>å¼‚å¸¸ã€‚</li>
<li>å¦åˆ™ï¼ŒæŒ‰ç…§ç»§æ‰¿å…³ç³»ä»ä¸‹å¾€ä¸Šä¾æ¬¡å¯¹Cçš„å„ä¸ªçˆ¶ç±»è¿›è¡Œç¬¬2æ­¥çš„æœç´¢å’ŒéªŒè¯è¿‡ç¨‹ã€‚</li>
<li>å¦‚æœå§‹ç»ˆæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ–¹æ³•ï¼Œåˆ™æŠ›å‡º<code>java.lang.AbstractMethodError</code>å¼‚å¸¸ã€‚</li>
</ol>
<p>ã€</p>
<blockquote>
<p>ğŸŸ¨è™šæ–¹æ³•è¡¨</p>
</blockquote>
<ul>
<li>åœ¨é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ä¸­ï¼Œä¼šå¾ˆé¢‘ç¹çš„ä½¿ç”¨åˆ°åŠ¨æ€åˆ†æ´¾ï¼Œå¦‚æœåœ¨æ¯æ¬¡åŠ¨æ€åˆ†æ´¾çš„è¿‡ç¨‹ä¸­éƒ½è¦é‡æ–°åœ¨ç±»çš„æ–¹æ³•å…ƒæ•°æ®ä¸­æœç´¢åˆé€‚çš„ç›®æ ‡çš„è¯å¯èƒ½å½±å“åˆ°æ‰§è¡Œæ•ˆç‡ã€‚å› æ­¤ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼ŒHVMé‡‡ç”¨åœ¨ç±»çš„æ–¹æ³•åŒºå»ºç«‹ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œä½¿ç”¨ç´¢å¼•è¡¨æ¥ä»£æ›¿æŸ¥æ‰¾ã€‚</li>
<li>æ¯ä¸ªç±»ä¸­éƒ½æœ‰ä¸€ä¸ªè™šæ–¹æ³•è¡¨ï¼Œè¡¨ä¸­å­˜æ”¾ç€å„ä¸ªæ–¹æ³•çš„å®é™…å…¥å£ã€‚</li>
<li>è™šæ–¹æ³•è¡¨åˆ›å»ºçš„æ—¶é—´ï¼šè™šæ–¹æ³•è¡¨ä¼šåœ¨ç±»åŠ è½½çš„é“¾æ¥é˜¶æ®µè¢«åˆ›å»ºå¹¶å¼€å§‹åˆå§‹åŒ–ï¼Œç±»çš„å˜é‡åˆå§‹å€¼å‡†å¤‡å®Œæˆä¹‹åï¼ŒJVMä¼šæŠŠè¯¥ç±»çš„æ–¹æ³•è¡¨ä¹Ÿåˆå§‹åŒ–å®Œæ¯•ã€‚</li>
</ul>
<h2 id="5-9-â­•-æ–¹æ³•è¿”å›åœ°å€"><a href="#5-9-â­•-æ–¹æ³•è¿”å›åœ°å€" class="headerlink" title="5.9 â­• æ–¹æ³•è¿”å›åœ°å€"></a>5.9 â­• æ–¹æ³•è¿”å›åœ°å€</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>å­˜æ”¾è°ƒç”¨è¯¥æ–¹æ³•çš„PCå¯„å­˜å™¨çš„å€¼ã€‚</li>
<li>ä¸€ä¸ªæ–¹æ³•çš„ç»“æŸï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š<ul>
<li>æ­£å¸¸æ‰§è¡Œå®Œæˆ</li>
<li>å‡ºç°æœªå¤„ç†çš„å¼‚å¸¸ï¼Œéæ­£å¸¸é€€å‡º</li>
</ul>
</li>
<li>æ— è®ºé€šè¿‡å“ªç§æ–¹å¼é€€å‡ºï¼Œåœ¨æ–¹æ³•é€€å‡ºåéƒ½è¿”å›è¯¥æ–¹æ³•è¢«è°ƒç”¨çš„ä½ç½®ã€‚æ–¹æ³•æ­£å¸¸é€€å‡ºæ—¶ï¼Œè°ƒç”¨è€…çš„PCè®¡æ•°å™¨çš„å€¼ä½œä¸ºè¿”å›åœ°å€ï¼Œå³è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚è€Œé€šè¿‡å¼‚å¸¸é€€å‡ºçš„ï¼Œè¿”å›åœ°å€æ˜¯è¦é€šè¿‡å¼‚å¸¸è¡¨æ¥ç¡®å®šï¼Œæ ˆå¸§ä¸­ä¸€èˆ¬ä¸ä¼šä¿å­˜è¿™éƒ¨åˆ†ä¿¡æ¯ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’¨é€€å‡º</p>
</blockquote>
<p>å½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œåï¼Œåªæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é€€å‡ºè¿™ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li><p>æ‰§è¡Œå¼•æ“é‡åˆ°ä»»æ„ä¸€ä¸ªæ–¹æ³•è¿”å›çš„å­—èŠ‚ç æŒ‡ä»¤ï¼ˆreturnï¼‰ï¼Œä¼šæœ‰è¿”å›å€¼ä¼ é€’ç»™ä¸Šå±‚çš„æ–¹æ³•è°ƒç”¨è€…ï¼Œç®€ç§°æ­£å¸¸å®Œæˆå‡ºå£ã€‚</p>
<ul>
<li>ä¸€ä¸ªæ–¹æ³•åœ¨æ­£å¸¸è°ƒç”¨å®Œæˆä¹‹åç©¶ç«Ÿéœ€è¦ä½¿ç”¨å“ªä¸€ä¸ªè¿”å›æŒ‡ä»¤è¿˜éœ€è¦æ ¹æ®æ–¹æ³•çš„è¿”å›å€¼çš„å®é™…æ•°æ®ç±»å‹è€Œå®šã€‚</li>
<li>åœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­ï¼Œè¿”å›æŒ‡ä»¤åŒ…å«ireturnï¼ˆå½“è¿”å›å€¼æ˜¯booleanã€byteã€charã€shortå’Œintç±»å‹æ—¶ä½¿ç”¨ï¼‰ã€lreturnï¼ˆlongï¼‰ã€freturnï¼ˆfloatï¼‰ä»¥åŠareturnï¼ˆStringï¼‰ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªreturnæŒ‡ä»¤ä¾›å£°æ˜ä¸ºvoidçš„æ–¹æ³•ã€å®ä¾‹åˆå§‹åŒ–æ–¹æ³•ã€ç±»å’Œæ¥å£çš„åˆå§‹åŒ–æ–¹æ³•ä½¿ç”¨ã€‚</li>
</ul>
</li>
<li><p>åœ¨æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸ï¼ˆExceptionï¼‰ï¼Œå¹¶ä¸”è¿™ä¸ªå¼‚å¸¸æ²¡æœ‰åœ¨æ–¹æ³•å†…è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯åªè¦åœ¨æœ¬æ–¹æ³•çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æœç´¢åˆ°åŒ¹é…çš„å¼‚å¸¸å¤„ç†å™¨ï¼Œå°±ä¼šå¯¼è‡´æ–¹æ³•é€€å‡ºï¼Œç®€ç§°å¼‚å¸¸å®Œæˆå‡ºå£ã€‚</p>
<ul>
<li>æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶çš„å¼‚å¸¸å¤„ç†ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªå¼‚å¸¸å¤„ç†è¡¨ï¼Œæ–¹ä¾¿åœ¨å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æ‰¾åˆ°å¤„ç†å¼‚å¸¸çš„ä»£ç ã€‚</li>
</ul>
</li>
</ol>
<blockquote>
<p>ğŸ‘â€ğŸ—¨æœ¬è´¨</p>
</blockquote>
<p>æœ¬è´¨ä¸Šï¼Œæ–¹æ³•çš„é€€å‡ºå°±æ˜¯å½“å‰å¸§å‡ºæ ˆçš„è¿‡ç¨‹ã€‚æ­¤æ—¶ï¼Œéœ€è¦æ¢å¤ä¸Šå±‚æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å°†è¿”å›å€¼å‹å…¥è°ƒç”¨è€…æ ˆå¸§çš„æ“ä½œæ•°æ ˆã€è®¾ç½®PCå¯„å­˜å™¨å€¼ç­‰ï¼Œè®©è°ƒç”¨è€…æ–¹æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚</p>
<p>æ­£å¸¸å®Œæˆå‡ºå£å’Œå¼‚å¸¸å®Œæˆå‡ºå£çš„åŒºåˆ«åœ¨äºï¼šé€šè¿‡å¼‚å¸¸å®Œæˆå‡ºå£é€€å‡ºçš„ä¸ä¼šç»™ä»–çš„ä¸Šå±‚è°ƒç”¨è€…äº§ç”Ÿä»»ä½•çš„è¿”å›å€¼ã€‚</p>
<h2 id="5-10-â•-é™„åŠ ä¿¡æ¯"><a href="#5-10-â•-é™„åŠ ä¿¡æ¯" class="headerlink" title="5.10 â• é™„åŠ ä¿¡æ¯"></a>5.10 â• é™„åŠ ä¿¡æ¯</h2><p>ä¸»è¦çœ‹è™šæ‹Ÿæœºçš„å®ç°ã€‚</p>
<p>æ ˆå¸§ä¸­è¿˜å…è®¸æºå¸¦ä¸Javaè™šæ‹Ÿæœºå®ç°ç›¸å…³çš„ä¸€äº›é™„åŠ ä¿¡æ¯ã€‚</p>
<p>ä¾‹å¦‚ï¼šå¯¹ç¨‹åºè°ƒè¯•æä¾›æ”¯æŒçš„ä¿¡æ¯ã€‚</p>
<h2 id="5-11-â“-ç›¸å…³é¢è¯•é¢˜"><a href="#5-11-â“-ç›¸å…³é¢è¯•é¢˜" class="headerlink" title="5.11 â“ ç›¸å…³é¢è¯•é¢˜"></a>5.11 â“ ç›¸å…³é¢è¯•é¢˜</h2><p>1ï¸âƒ£ ä¸¾ä¾‹æ ˆæº¢å‡ºçš„æƒ…å†µï¼ˆStackOverlowErrorï¼‰</p>
<p>é€šè¿‡-Xssè®¾ç½®æ ˆçš„å¤§å°ï¼šOOM</p>
<p>2ï¸âƒ£ è°ƒæ•´æ ˆå¤§å°ï¼Œå°±èƒ½ä¿è¯ä¸å‡ºç°æº¢å‡ºå—</p>
<p>ä¸èƒ½</p>
<p>3ï¸âƒ£ åˆ†é…çš„æ ˆå†…å­˜è¶Šå¤§è¶Šå¥½å—</p>
<p>ä¸æ˜¯</p>
<p>4ï¸âƒ£ åƒåœ¾å›æ”¶æ˜¯å¦ä¼šæ¶‰åŠåˆ°è™šæ‹Ÿæœºæ ˆ</p>
<p>ä¸ä¼š</p>
<p>5ï¸âƒ£ æ–¹æ³•ä¸­å®šä¹‰çš„å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨</p>
<p>å…·ä½“é—®é¢˜å…·ä½“åˆ†æ</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-4(ç¨‹åºè®¡æ•°å™¨)</title>
    <url>/posts/28643/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>ğŸ”Šä»‹ç»</p>
</blockquote>
<p>JVMä¸­çš„ç¨‹åºè®¡æ•°å¯„å­˜å™¨(Program Counter Register)ä¸­ï¼Œå¯„å­˜å™¨å­˜å‚¨æŒ‡ä»¤ç›¸å…³çš„ç°åœºä¿¡æ¯ï¼ŒCPUåªæœ‰æŠŠæ•°æ®è£…è½½åˆ°å¯„å­˜å™¨æ‰èƒ½å¤Ÿè¿è¡Œã€‚</p>
<p>JVMä¸­çš„ç¨‹åºè®¡æ•°å™¨æ˜¯å¯¹ç‰©ç†è®¡ç®—æœºå¯„å­˜å™¨çš„ä¸€ç§æ¨¡æ‹Ÿï¼Œå¹¶éæ˜¯æŒ‡å¹¿ä¹‰ä¸Šæ‰€æŒ‡çš„ç‰©ç†å¯„å­˜å™¨ï¼Œä¹Ÿå«PCå¯„å­˜å™¨ã€‚</p>
<blockquote>
<p>ğŸ”¨ä½œç”¨</p>
</blockquote>
<p>PCå¯„å­˜å™¨ç”¨æ¥å­˜å‚¨ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œå³å³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤ä»£ç ã€‚ç”±æ‰§è¡Œå¼•æ“è¯»å–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/28643/image-20201031111450893.png" class="" title="image-20201031111450893">



<blockquote>
<p>ğŸ“„è¯¦è¿°</p>
</blockquote>
<ul>
<li>å®ƒæ˜¯ä¸€å—å¾ˆå°çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ä¹Ÿæ˜¯è¿è¡Œé€Ÿåº¦æœ€å¿«çš„å­˜å‚¨åŒºåŸŸã€‚</li>
<li>åœ¨JVMè§„èŒƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ˜¯ç°è½¦ç»™ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ã€‚</li>
<li>ä»»ä½•æ—¶é—´ä¸€ä¸ªçº¿ç¨‹éƒ½åªæœ‰ä¸€ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å½“å‰æ–¹æ³•ã€‚ç¨‹åºè®¡æ•°å™¨ä¼šå­˜å‚¨å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„Javaæ–¹æ³•çš„JVMæŒ‡ä»¤åœ°å€ï¼›æˆ–è€…ï¼Œå¦‚æœæ˜¯åœ¨æ‰§è¡Œnativeæ–¹æ³•ï¼Œåˆ™æ˜¯æœªæŒ‡å®šå€¼(undefined)ã€‚</li>
<li>å®ƒæ˜¯ç¨‹åºæ§åˆ¶æµçš„æŒ‡ç¤ºå™¨ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚</li>
<li>å­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</li>
<li>å®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨Javaè™šæ‹Ÿæœºè§„èŒƒä¸­æ²¡æœ‰è§„å®šä»»ä½•OutOfMemoryErroræƒ…å†µçš„åŒºåŸŸã€‚</li>
</ul>
<blockquote>
<p>âŒ¨ï¸å®ä¾‹</p>
</blockquote>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="java">public class PCRegisterTest &#123;
    public static void main(String[] args) &#123;
        int i = 10;
        int j = 20;
        int k = i + j;
        String s = &quot;KHighness&quot;;
        System.out.println(k);
        System.out.println(s);
    &#125;
&#125;</code></pre>
<p>ç¼–è¯‘åå†åç¼–è¯‘:<code>javap -v PCRegisterTest.java</code></p>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="powershell">D:\Java\Test\Test\target\classes\top\parak\chapter01&gt;javap -v PCRegisterTest.class
Classfile /D:/Java/Test/Test/target/classes/top/parak/chapter01/PCRegisterTest.class
  Last modified 2020-10-31; size 722 bytes
  MD5 checksum 8a19ae86b495f9dd8ef414436e2baef5
  Compiled from &quot;PCRegisterTest.java&quot;
public class top.parak.chapter01.PCRegisterTest
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #7.#27         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V
   #2 = String             #28            // KHighness
   #3 = Fieldref           #29.#30        // java/lang/System.out:Ljava/io/PrintStream;
   #4 = Methodref          #31.#32        // java/io/PrintStream.println:(I)V
   #5 = Methodref          #31.#33        // java/io/PrintStream.println:(Ljava/lang/String;)V
   #6 = Class              #34            // top/parak/chapter01/PCRegisterTest
   #7 = Class              #35            // java/lang/Object
   #8 = Utf8               &lt;init&gt;
   #9 = Utf8               ()V
  #10 = Utf8               Code
  #11 = Utf8               LineNumberTable
  #12 = Utf8               LocalVariableTable
  #13 = Utf8               this
  #14 = Utf8               Ltop/parak/chapter01/PCRegisterTest;
  #15 = Utf8               main
  #16 = Utf8               ([Ljava/lang/String;)V
  #17 = Utf8               args
  #18 = Utf8               [Ljava/lang/String;
  #19 = Utf8               i
  #20 = Utf8               I
  #21 = Utf8               j
  #22 = Utf8               k
  #23 = Utf8               s
  #24 = Utf8               Ljava/lang/String;
  #25 = Utf8               SourceFile
  #26 = Utf8               PCRegisterTest.java
  #27 = NameAndType        #8:#9          // &quot;&lt;init&gt;&quot;:()V
  #28 = Utf8               KHighness
  #29 = Class              #36            // java/lang/System
  #30 = NameAndType        #37:#38        // out:Ljava/io/PrintStream;
  #31 = Class              #39            // java/io/PrintStream
  #32 = NameAndType        #40:#41        // println:(I)V
  #33 = NameAndType        #40:#42        // println:(Ljava/lang/String;)V
  #34 = Utf8               top/parak/chapter01/PCRegisterTest
  #35 = Utf8               java/lang/Object
  #36 = Utf8               java/lang/System
  #37 = Utf8               out
  #38 = Utf8               Ljava/io/PrintStream;
  #39 = Utf8               java/io/PrintStream
  #40 = Utf8               println
  #41 = Utf8               (I)V
  #42 = Utf8               (Ljava/lang/String;)V
&#123;
  public top.parak.chapter01.PCRegisterTest();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V
         4: return
      LineNumberTable:
        line 14: 0
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0       5     0  this   Ltop/parak/chapter01/PCRegisterTest;

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=5, args_size=1
         0: bipush        10
         2: istore_1
         3: bipush        20
         5: istore_2
         6: iload_1
         7: iload_2
         8: iadd
         9: istore_3
        10: ldc           #2                  // String KHighness
        12: astore        4
        14: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;
        17: iload_3
        18: invokevirtual #4                  // Method java/io/PrintStream.println:(I)V
        21: getstatic     #3                  // Field java/lang/System.out:Ljava/io/PrintStream;
        24: aload         4
        26: invokevirtual #5                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        29: return
      LineNumberTable:
        line 17: 0
        line 18: 3
        line 19: 6
        line 21: 10
        line 22: 14
        line 23: 21
        line 24: 29
      LocalVariableTable:
        Start  Length  Slot  Name   Signature
            0      30     0  args   [Ljava/lang/String;
            3      27     1     i   I
            6      24     2     j   I
           10      20     3     k   I
           14      16     4     s   Ljava/lang/String;
&#125;
SourceFile: &quot;PCRegisterTest.java&quot;</code></pre>
<p>Codeæ¨¡å—è§£æï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/28643/image-20201031134509185.png" class="" title="image-20201031134509185">



<blockquote>
<p>â“å¸¸è§é—®é¢˜</p>
</blockquote>
<ol>
<li><p>ä¸ºä»€ä¹ˆä½¿ç”¨PCå¯„å­˜å™¨è®°å½•å½“å‰çº¿ç¨‹çš„æ‰§è¡Œåœ°å€ï¼Ÿ</p>
<p>å› ä¸ºCPUéœ€è¦ä¸åœçš„æ¥å›åˆ‡æ¢å„ä¸ªçº¿ç¨‹ï¼Œè¿™æ—¶å€™åˆ‡æ¢å›æ¥ä»¥åï¼Œå°±éœ€è¦çŸ¥é“æ¥ç€ä»å“ªå¼€å§‹ç»§ç»­æ‰§è¡Œã€‚</p>
<p>JVMçš„çš„å­—èŠ‚ç è§£é‡Šå™¨å°±éœ€è¦é€šè¿‡æ”¹å˜PCå¯„å­˜å™¨çš„å€¼æ¥æ˜ç¡®ä¸‹ä¸€æ¡åº”è¯¥æ‰§è¡Œä»€ä¹ˆæ ·çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚</p>
</li>
<li><p>PCå¯„å­˜å™¨ä¸ºä»€ä¹ˆä¼šè¢«è®¾å®šä¸ºçº¿ç¨‹ç§æœ‰ï¼Ÿ</p>
<p>ä¸ºäº†èƒ½å¤Ÿå‡†ç¡®åœ°è®°å½•å„ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å½“å‰å­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åˆ†é…ä¸€ä¸ªPCå¯„å­˜å™¨ï¼Œè¿™æ ·ä¸€æ¥å„ä¸ªçº¿ç¨‹ä¹‹é—´å°±å¯ä»¥è¿›è¡Œç‹¬ç«‹è®¡ç®—ï¼Œä»è€Œä¸ä¼šå‡ºç°ç›¸äº’å¹²æ‰°çš„æƒ…å†µã€‚</p>
<p>ç”±äºCPUæ—¶é—´ç‰‡è½®é™åˆ¶ï¼Œä¼—å¤šçº¿ç¨‹å†å¹¶å‘æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨æˆ–è€…å¤šæ ¸å¤„ç†å™¨ä¸­çš„ä¸€ä¸ªå†…æ ¸ï¼Œåªä¼šæ‰§è¡ŒæŸä¸ªçº¿ç¨‹ä¸­çš„ä¸€æ¡æŒ‡ä»¤ã€‚</p>
<p>è¿™æ ·å¿…ç„¶å¯¼è‡´ç»å¸¸ä¸­æ–­æˆ–æ¢å¤ï¼Œå¦‚ä½•ä¿è¯åˆ†æ¯«æ— å·®å‘¢ï¼Ÿæ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºåï¼Œéƒ½ä¼šäº§ç”Ÿè‡ªå·±çš„ç¨‹åºè®¡æ•°å™¨å’Œæ ˆå¸§ï¼Œç¨‹åºè®¡æ•°å™¨åœ¨å„ä¸ªçº¿ç¨‹ä¹‹é—´äº’ä¸å½±å“ã€‚</p>
</li>
</ol>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-3(è¿è¡Œæ—¶æ•°æ®åŒº)</title>
    <url>/posts/2398/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="3-1-ğŸ“š-æ¦‚è¿°"><a href="#3-1-ğŸ“š-æ¦‚è¿°" class="headerlink" title="3.1 ğŸ“š æ¦‚è¿°"></a>3.1 ğŸ“š æ¦‚è¿°</h2><blockquote>
<p> ğŸ”—å†…å­˜</p>
</blockquote>
<p>å†…å­˜æ˜¯éå¸¸é‡è¦çš„ç³»ç»Ÿèµ„æºï¼Œæ˜¯ç¡¬ç›˜å’ŒCPUçš„ä¸­é—´ä»“åº“åŠæ¡¥æ¢ï¼Œæ‰¿è½½ç€æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„å®æ—¶è¿è¡Œ.ã€‚JVMå†…å­˜å¸ƒå±€è§„å®šäº†Javaåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ç”³è¯·ã€åˆ†é…å’Œç®¡ç†çš„ç­–ç•¥ï¼Œä¿è¯äº†JVMçš„é«˜æ•ˆç¨³å®šè¿è¡Œã€‚ä¸åŒçš„JVMå¯¹äºå†…å­˜çš„åˆ’åˆ†æ–¹å¼å’Œç®¡ç†æœºåˆ¶å­˜åœ¨ç€éƒ¨åˆ†å·®å¼‚ã€‚</p>
<blockquote>
<p>ğŸ“·è¿è¡Œæ—¶æ•°æ®åŒºæ¨¡å‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/2398/image-20201030165643871.png" class="" title="image-20201030165643871">



<blockquote>
<p>ğŸ“¸è¿è¡Œæ—¶æ•°æ®å¿«ç…§</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/2398/image-2021030911201911.jpg" class="" title="image-2021030911201911">



<blockquote>
<p>ğŸ“·çº¿ç¨‹æ•°æ®åŒºæ¨¡å‹</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºå®šä¹‰äº†è‹¥å¹²ç§ç¨‹åºè¿è¡ŒæœŸé—´ä¼šä½¿ç”¨åˆ°çš„è¿è¡Œæ—¶æ•°æ®åŒºï¼Œå…¶ä¸­æœ‰ä¸€äº›ä¼šéšç€è™šæ‹Ÿæœºå¯åŠ¨è€Œåˆ›å»ºï¼Œéšç€è™šæ‹Ÿæœºé€€å‡ºè€Œé”€æ¯ã€‚å¦å¤–åˆ™æ˜¯ä¸çº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„ï¼Œè¿™äº›ä¸çº¿ç¨‹å¯¹åº”çš„æ•°æ®åŒºä¼šéšç€çº¿ç¨‹å¼€å§‹å’Œç»“æŸè€Œåˆ›å»ºå’Œé”€æ¯ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/2398/image-20201030215501981.png" class="" title="image-20201030215501981">

<p>ä¸Šå›¾ä¸­ï¼Œæ©™è‰²ä¸ºå¤šçº¿ç¨‹å…±äº«çš„ï¼Œç°è‰²ä¸ºå•ç‹¬çº¿ç¨‹ç§æœ‰çš„</p>
<ul>
<li>å…±äº«ï¼šå †(Heap)ã€æ–¹æ³•åŒº(Method Area)ã€å †å¤–å†…å­˜(æ°¸ä¹…ä»£/å…ƒç©ºé—´ã€ä»£ç ç¼“å­˜)</li>
<li>ç§æœ‰ï¼šçº¿ç¨‹è®¡æ•°å™¨(PC)ã€è™šæ‹Ÿæœºæ ˆ(Virtual Machine Stack)ã€æœ¬åœ°æ–¹æ³•æ ˆ(Native Method Stack)</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/2398/image-20210301164207012.png" class="" title="image-20210301164207012">





<h2 id="3-2-ğŸ“™-çº¿ç¨‹"><a href="#3-2-ğŸ“™-çº¿ç¨‹" class="headerlink" title="3.2 ğŸ“™ çº¿ç¨‹"></a>3.2 ğŸ“™ çº¿ç¨‹</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<ul>
<li>çº¿ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºé‡Œçš„è¿è¡Œå•å…ƒã€‚JVMå…è®¸ä¸€ä¸ªåº”ç”¨æœ‰å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œã€‚</li>
<li>åœ¨HotSpot JVMé‡Œï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¸æ“ä½œç³»ç»Ÿçš„æœ¬åœ°çº¿ç¨‹ç›´æ¥æ˜ å°„ã€‚å³å½“ä¸€ä¸ªJavaçº¿ç¨‹å‡†å¤‡å¥½æ‰§è¡Œä»¥åï¼Œæ­¤æ—¶ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„æœ¬åœ°çº¿ç¨‹ä¹ŸåŒæ—¶åˆ›å»ºï¼›Javaçº¿ç¨‹æ‰§è¡Œç»ˆæ­¢åï¼Œæœ¬åœ°çº¿ç¨‹ä¹Ÿä¼šå›æ”¶ã€‚</li>
<li>æ“ä½œç³»ç»Ÿè´Ÿè´£æ‰€æœ‰çº¿ç¨‹çš„å®‰æ’è°ƒåº¦åˆ°ä»»ä½•ä¸€ä¸ªå¯ç”¨çš„CPUä¸Šã€‚ä¸€æ—¦æœ¬åœ°çº¿ç¨‹åˆå§‹åŒ–æˆåŠŸï¼Œå®ƒå°±ä¼šè°ƒç”¨Javaçº¿ç¨‹ä¸­çš„run()æ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>ğŸš¤JVMç³»ç»Ÿçº¿ç¨‹</p>
</blockquote>
<p>JVMä¸­çš„åå°ç³»ç»Ÿçº¿ç¨‹ï¼š</p>
<ul>
<li>è™šæ‹Ÿæœºçº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹çš„æ“ä½œæ˜¯éœ€è¦JVMè¾¾åˆ°å®‰å…¨ç‚¹æ‰ä¼šå‡ºç°ã€‚æ‰§è¡Œç±»å‹åŒ…æ‹¬åƒåœ¾æ”¶é›†ã€çº¿ç¨‹æ ˆæ”¶é›†ã€çº¿ç¨‹æŒ‚èµ·ä»¥åŠåå‘é”æ’¤é”€ã€‚</li>
<li>å‘¨æœŸä»»åŠ¡çº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹æ˜¯æ—¶é—´å‘¨æœŸäº‹ä»¶çš„ä½“ç°(æ¯”å¦‚ä¸­æ–­)ï¼Œä¸€èˆ¬ç”¨äºå‘¨æœŸæ€§æ“ä½œçš„è°ƒåº¦æ‰§è¡Œã€‚</li>
<li>GCçº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹å¯¹åœ¨JVMé‡Œä¸åŒç§ç±»çš„åƒåœ¾æ”¶é›†è¡Œä¸ºæä¾›äº†æ”¯æŒã€‚</li>
<li>ç¼–è¯‘çº¿ç¨‹ï¼šè¿™ç§çº¿ç¨‹åœ¨è¿è¡Œæ—¶ä¼šå°†å­—èŠ‚ç ç¼–è¯‘æˆæœ¬åœ°ä»£ç ã€‚</li>
<li>ä¿¡å·è°ƒåº¦çº¿ç¨‹ï¼šè¿™ç§ç‚¹æˆæ¥æ”¶ä¿¡å·å¹¶å‘é€ç»™JVMï¼Œåœ¨å®ƒå†…éƒ¨é€šè¿‡è°ƒç”¨é€‚å½“çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-2(ç±»åŠ è½½å­ç³»ç»Ÿ)</title>
    <url>/posts/22607/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="2-1-ğŸ““ç±»åŠ è½½å­ç³»ç»Ÿ"><a href="#2-1-ğŸ““ç±»åŠ è½½å­ç³»ç»Ÿ" class="headerlink" title="2.1 ğŸ““ç±»åŠ è½½å­ç³»ç»Ÿ"></a>2.1 ğŸ““ç±»åŠ è½½å­ç³»ç»Ÿ</h2><blockquote>
<p>ğŸ“·ç±»åŠ è½½å­ç³»ç»Ÿå›¾ç¤º</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/22607/image-20201026183523366.png" class="" title="image-20201026183523366">



<blockquote>
<p>ğŸ”¨ç±»åŠ è½½å­ç³»ç»Ÿä½œç”¨</p>
</blockquote>
<ul>
<li>ç±»åŠ è½½å­ç³»ç»Ÿè´Ÿè´£ä»æ–‡ä»¶ç³»ç»Ÿæˆ–è€…ç½‘ç»œä¸­åŠ è½½classæ–‡ä»¶ï¼Œclassæ–‡ä»¶åœ¨æ–‡ä»¶å¼€å¤´æœ‰ç‰¹å®šçš„æ–‡ä»¶æ ‡è¯†ã€‚</li>
<li>ClassLoaderåªè´Ÿè´£classæ–‡ä»¶çš„åŠ è½½ï¼Œè‡³äºå®ƒæ˜¯å¦å¯ä»¥è¿è¡Œï¼Œåˆ™ç”±Execution Engine(æ‰§è¡Œå¼•æ“)å†³å®šã€‚</li>
<li>åŠ è½½çš„ç±»ä¿¡æ¯å­˜æ”¾äºä¸€å—ç§°ä¸ºæ–¹æ³•åŒºçš„å†…å­˜ç©ºé—´ã€‚é™¤äº†ç±»çš„ä¿¡æ¯ä»¥å¤–ï¼Œæ–¹æ³•åŒºä¸­è¿˜ä¼šæœ‰å­˜æ”¾è¿è¡Œæ—¶å¸¸é‡æ± ä¿¡æ¯ï¼Œå¯èƒ½è¿˜åŒ…æ‹¬å­—ç¬¦ä¸²é¢é‡å’Œæ•°å­—å¸¸é‡ã€‚</li>
</ul>
<h2 id="2-2-ğŸš€ç±»çš„åŠ è½½è¿‡ç¨‹"><a href="#2-2-ğŸš€ç±»çš„åŠ è½½è¿‡ç¨‹" class="headerlink" title="2.2 ğŸš€ç±»çš„åŠ è½½è¿‡ç¨‹"></a>2.2 ğŸš€ç±»çš„åŠ è½½è¿‡ç¨‹</h2><blockquote>
<p>ğŸ“„ç±»çš„åŠ è½½å™¨-ClassLoader</p>
</blockquote>
<ol>
<li>class fileå­˜åœ¨äºæœ¬åœ°ç¡¬ç›˜ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºè®¾è®¡å¸ˆç”»åœ¨çº¸ä¸Šçš„æ¨¡æ¿ï¼Œè€Œæœ€ç»ˆè¿™ä¸ªæ¨¡æ¿åœ¨æ‰§è¡Œçš„æ—¶å€™æ˜¯è¦åŠ è½½åˆ°JVMå½“ä¸­æ¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶å®ä¾‹åŒ–å‡ºnä¸ªä¸€æ¨¡ä¸€æ ·çš„å®ä¾‹ã€‚</li>
<li>class fileåŠ è½½åˆ°JVMä¸­ï¼Œè¢«ç§°ä¸ºDNAå…ƒæ•°æ®æ¨¡æ¿ï¼Œæ”¾åœ¨æ–¹æ³•åŒºã€‚</li>
<li>åœ¨.classæ–‡ä»¶ -&gt; JVM -&gt; æœ€ç»ˆæˆä¸ºå…ƒæ•°æ®æ¨¡æ¿ï¼Œæ­¤è¿‡ç¨‹å°±è¦ä¸€ä¸ªè¿è¾“å·¥å…·(ç±»è£…è½½å™¨ClassLoader)ï¼Œæ‰®æ¼”ä¸€ä¸ªå¿«é€’å‘˜çš„è§’è‰²ã€‚</li>
</ol>
<blockquote>
<p>â°ç±»çš„åŠ è½½è¿‡ç¨‹</p>
</blockquote>
<div class="mermaid">graph LR
A(å¼€å§‹)
B{è£…è½½ç±»}
C{é“¾æ¥}
D[åˆå§‹åŒ–]
E[è°ƒç”¨main]
F(ç»“æŸ)
G{ClassLoaderè£…è½½é¡ºåˆ©}
H[è¾“å‡ºå¼‚å¸¸]
A --&gt; B
B --&gt; |Yes| C
C --&gt; D
D --&gt; E
E --&gt; F
B --&gt; |No| G
G --&gt; |Yes| C
G --&gt; |No| H</div>

<ol>
<li>åŠ è½½<ol>
<li>é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµã€‚</li>
<li>å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ã€‚</li>
<li>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚</li>
</ol>
</li>
<li>é“¾æ¥<ol>
<li>éªŒè¯<ul>
<li> ç›®çš„åœ¨äºç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºè¦æ±‚ï¼Œä¿è¯è¢«åŠ è½½ç±»çš„æ­£ç¡®æ€§ï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨ã€‚</li>
<li> ä¸»è¦åŒ…æ‹¬å››ç§éªŒè¯ï¼šæ–‡ä»¶æ ¼å¼éªŒè¯ï¼Œå…ƒæ•°æ®éªŒè¯ï¼Œå­—èŠ‚ç éªŒè¯ï¼Œç¬¦å·å¼•ç”¨éªŒè¯ã€‚</li>
</ul>
</li>
<li>å‡†å¤‡<ul>
<li>ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶ä¸”è®¾ç½®è¯¥ç±»å˜é‡çš„é»˜è®¤åˆå§‹å€¼ï¼Œå³é›¶å€¼ã€‚</li>
<li>è¿™é‡Œä¸åŒ…å«ç”¨finalä¿®é¥°çš„staticï¼Œå› ä¸ºfinalåœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šåˆ†é…äº†ï¼Œå‡†å¤‡é˜¶æ®µä¼šæ˜¾å¼åˆå§‹åŒ–ã€‚</li>
<li>è¿™é‡Œä¸ä¼šä¸ºå®ä¾‹å˜é‡åˆ†é…åˆå§‹åŒ–ï¼Œç±»å˜é‡ä¼šåˆ†é…åœ¨æ–¹æ³•åŒºä¸­ï¼Œè€Œå®ä¾‹å˜é‡æ˜¯ä¼šéšç€å¯¹è±¡ä¸€èµ·åˆ†é…åˆ°Javaå †ä¸­ã€‚</li>
</ul>
</li>
<li>è§£æ<ul>
<li>å°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹ã€‚</li>
<li>äº‹å®ä¸Šï¼Œè§£ææ“ä½œå¾€å¾€ä¼šä¼´éšç€JVMåœ¨æ‰§è¡Œå®Œåˆå§‹åŒ–ä¹‹åå†æ‰§è¡Œã€‚</li>
<li>ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°æ‰€å¼•ç”¨çš„ç›®æ ‡ã€‚ç¬¦å·å¼•ç”¨çš„å­—é¢é‡å½¢å¼æ˜ç¡®å®šä¹‰åœ¨Javaè™šæ‹Ÿæœºè§„èŒƒçš„Classæ–‡ä»¶æ ¼å¼ä¸­ã€‚ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚</li>
<li>è§£æåŠ¨ä½œä¸»è¦é’ˆå¯¹ç±»æˆ–æ¥å£ã€å­—æ®µã€ç±»æ–¹æ³•ã€æ¥å£æ–¹æ³•ã€æ–¹æ³•ç±»å‹ç­‰ã€‚å¯¹åº”å¸¸é‡æ± ä¸­çš„CONSTANT_Class_infoã€CONSTANT_Filedref_infoã€CONSTANT_Methodref_infoç­‰ã€‚</li>
</ul>
</li>
</ol>
</li>
<li>åˆå§‹åŒ–<ul>
<li>åˆå§‹åŒ–é˜¶æ®µå°±æ˜¯æ‰§è¡Œç±»æ„é€ å™¨æ–¹æ³•clinit()çš„è¿‡ç¨‹ã€‚</li>
<li>æ­¤æ–¹æ³•ä¸éœ€è¦å®šä¹‰ï¼Œæ˜¯javacç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ä¸­çš„è¯­å¥åˆå¹¶è€Œæ¥ã€‚</li>
<li>æ„é€ å™¨æ–¹æ³•ä¸­æŒ‡ä»¤æŒ‰è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºæ‰§è¡Œã€‚</li>
<li>clinit()ä¸åŒäºç±»çš„æ„é€ å™¨ã€‚(æ„é€ å™¨æ˜¯è™šæ‹Ÿæœºè§†è§’ä¸‹çš„init())ã€‚</li>
<li>è‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼ŒJVMä¼šä¿è¯å­ç±»çš„clinit()æ‰§è¡Œå‰ï¼Œçˆ¶ç±»çš„clinit()å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚</li>
<li>è™šæ‹Ÿæœºå¿…é¡»ä¿è¯ä¸€ä¸ªç±»çš„clinit()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹è¢«åŒæ­¥åŠ é”ã€‚</li>
</ul>
</li>
</ol>
<h2 id="2-3-ğŸ“‘ç±»åŠ è½½å™¨è¯¦è§£"><a href="#2-3-ğŸ“‘ç±»åŠ è½½å™¨è¯¦è§£" class="headerlink" title="2.3 ğŸ“‘ç±»åŠ è½½å™¨è¯¦è§£"></a>2.3 ğŸ“‘ç±»åŠ è½½å™¨è¯¦è§£</h2><blockquote>
<p>â¬ç±»åŠ è½½å™¨çš„åˆ†ç±»</p>
</blockquote>
<ul>
<li>JVMæ”¯æŒä¸¤ç§ç±»å‹çš„ç±»åŠ è½½å™¨ï¼Œåˆ†åˆ«ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨(BootStrap ClassLoader)å’Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨(User-Defined ClassLoader)ã€‚</li>
<li>ä»æ¦‚å¿µä¸Šæ¥è®²ï¼Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€èˆ¬æŒ‡çš„æ˜¯ç¨‹åºä¸­ç”±å¼€å‘äººå‘˜è‡ªå®šä¹‰çš„ä¸€ç±»ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯Javaè™šæ‹Ÿæœºè§„èŒƒå´æ²¡æœ‰è¿™ä¹ˆå®šä¹‰ï¼Œè€Œæ˜¯å°†æ‰€æœ‰æ´¾ç”ŸäºæŠ½è±¡ç±»ClassLoaderçš„ç±»åŠ è½½å™¨éƒ½åˆ’åˆ†ä¸ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚</li>
<li>æ— è®ºç±»åŠ è½½å™¨çš„ç±»å‹å¦‚ä½•åˆ’åˆ†ï¼Œåœ¨ç¨‹åºä¸­æœ€å¸¸è§çš„ç±»åŠ è½½å™¨å§‹ç»ˆåªæœ‰3ä¸ªï¼Œå¦‚ä¸‹æ‰€ç¤º</li>
</ul>
<div class="mermaid">graph TD
A[...]
B[...]
C[User Defined Class Loader]
D[User Defined Class Loader]
E[User Defined Class Loader]
F[User Defined Class Loader]
G[System Class Loader]
H[Extension Class Loader]
I[Bootstrap Class Loader]
A --&gt; C 
C --&gt; E
B --&gt; D
D --&gt; F
E --&gt; G
F --&gt; G
G --&gt; H
H --&gt; I</div>



<blockquote>
<p>âš¡ï¸å…³äºClassLoader </p>
</blockquote>
<p>ClassLoaderç±»ï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶åæ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½ç»§æ‰¿è‡ªClassLoaderã€‚</p>
<div class="mermaid">classDiagram
ExtClassLoader --&gt; URLClassLoader
AppClassLoader --&gt; URLClassLoader
AppClassLoader : loadClass(String, booean)
URLClassLoader --&gt; SecureClassLoader
URLClassLoader : findClass(String)
SecureClassLoader --&gt; abstract ClassLoader
abstract ClassLoader : loadClass(String)
abstract ClassLoader : resolveClass(Class&lt;?&gt;)
abstract ClassLoader : findClass(String)
abstract ClassLoader : defineClass(byte[], int, int)</div>


<p>ClassLoaderçš„å¸¸ç”¨æ–¹æ³•</p>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">getParent()</td>
<td align="center">è¿”å›è¯¥ç±»åŠ è½½å™¨çš„è¶…ç±»åŠ è½½å™¨</td>
</tr>
<tr>
<td align="center">loadClass(String name)</td>
<td align="center">åŠ è½½åç§°ä¸ºnameçš„ç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹</td>
</tr>
<tr>
<td align="center">findClass(String name)</td>
<td align="center">æŸ¥æ‰¾åç§°ä¸ºnameçš„ç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹</td>
</tr>
<tr>
<td align="center">findLoadedClass(String name)</td>
<td align="center">æŸ¥æ‰¾åç§°ä¸ºnameçš„å·²ç»è¢«åŠ è½½è¿‡çš„ç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹</td>
</tr>
<tr>
<td align="center">defineClass(String name, byte[] b, int off, int len)</td>
<td align="center">æŠŠå­—èŠ‚æ•°ç»„bä¸­çš„å†…å®¹è½¬æ¢ä¸ºä¸€ä¸ªJavaç±»ï¼Œè¿”å›ç»“æœä¸ºjava.lang.Classç±»çš„å®ä¾‹</td>
</tr>
<tr>
<td align="center">resloveClass(Class&lt;?&gt; c)</td>
<td align="center">è¿æ¥æŒ‡å®šçš„ä¸€ä¸ªJavaç±»</td>
</tr>
</tbody></table>
<p>è·å–ClassLoaderçš„é€”å¾„</p>
<table>
<thead>
<tr>
<th align="center">æè¿°</th>
<th align="center">æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td align="center">è·å–å½“å‰ç±»çš„ClassLoader</td>
<td align="center">clazz.getClassLoader()</td>
</tr>
<tr>
<td align="center">è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ClassLoader</td>
<td align="center">Thread.currentThread().getContextLoader()</td>
</tr>
<tr>
<td align="center">è·å–ç³»ç»Ÿçš„ClassLoader</td>
<td align="center">ClassLoader.getSystemClassLoader()</td>
</tr>
<tr>
<td align="center">è·å–è°ƒç”¨è€…çš„ClassLoader</td>
<td align="center">DriveManager.getCallerClassLoader()</td>
</tr>
</tbody></table>
<blockquote>
<p>ğŸ€è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨</p>
</blockquote>
<ul>
<li>å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader)<ul>
<li>C/C++è¯­è¨€ç¼–å†™ï¼ŒåµŒå¥—åœ¨JVMå†…éƒ¨ï¼Œæ— æ³•è·å–</li>
<li>å®ƒç”¨æ¥åŠ è½½Javaçš„æ ¸å¿ƒåº“ï¼Œç”¨äºæä¾›JVMè‡ªèº«éœ€è¦çš„ç±»</li>
<li>å¹¶ä¸ç»§æ‰¿è‡ªjava.lang.Classoaderï¼Œæ²¡æœ‰çˆ¶ç±»åŠ è½½å™¨</li>
<li>åŠ è½½æ‰©å±•ç±»å’Œåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼Œå¹¶æŒ‡å®šä¸ºä»–ä»¬çš„çˆ¶ç±»åŠ è½½å™¨</li>
<li><strong>å‡ºäºå®‰å…¨è€ƒè™‘ï¼ŒBootStrapå¯åŠ¨ç±»åŠ è½½å™¨åªåŠ è½½åŒ…åä¸º<u>java</u>ã€<u>javax</u>ã€<u>sun</u>ç­‰å¼€å¤´çš„ç±»</strong></li>
</ul>
</li>
<li>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨(Application ClassLoader)<ul>
<li>Javaè¯­è¨€ç¼–å†™ï¼Œç”±sun.misc.Launcher$AppClassLoaderå®ç°</li>
<li>æ´¾ç”ŸäºClassLoaderç±»</li>
<li>çˆ¶ç±»åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨</li>
<li>å®ƒè´Ÿè´£åŠ è½½ç¯å¢ƒå˜é‡classpathæˆ–ç³»ç»Ÿå±æ€§java.class.pathæŒ‡å®šè·¯å¾„ä¸‹çš„ç±»åº“</li>
<li>è¯¥ç±»åŠ è½½æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒJavaåº”ç”¨çš„ç±»éƒ½æ˜¯ç”±å®ƒæ¥å®ŒæˆåŠ è½½</li>
<li>é€šè¿‡ClassLoader$getSystemClassLoader()æ–¹æ³•å¯ä»¥è·å–åˆ°è¯¥ç±»åŠ è½½å™¨</li>
</ul>
</li>
<li>æ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader)<ul>
<li>Javaè¯­è¨€ç¼–å†™ï¼Œç”±sun.misc.Launcher$ExtClassLoaderå®ç°</li>
<li>å®ƒè´Ÿè´£åŠ è½½%JAVA_HOME%\lib\extç›®å½•ä¸­æˆ–è€…è¢«java.ext.dirsç³»ç»Ÿå˜é‡æ‰€æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“</li>
<li>å¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨</li>
</ul>
</li>
</ul>
<blockquote>
<p>ğŸ€ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨</p>
</blockquote>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>éš”ç¦»åŠ è½½ç±»</li>
<li>ä¿®æ”¹ç±»åŠ è½½çš„æ–¹å¼</li>
<li>æ‰©å±•åŠ è½½æº</li>
<li>é˜²æ­¢æºç æ³„éœ²</li>
</ul>
<p>å®ç°æ­¥éª¤ï¼š</p>
<ul>
<li>å¼€å‘äººå‘˜å¯ä»¥é€šè¿‡ç»§æ‰¿æŠ½è±¡ç±»java.lang.ClassLoaderç±»çš„æ–¹å¼ï¼Œå®ç°è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œä»¥æ»¡è¶³ä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚ã€‚</li>
<li>åœ¨JDK1.2ä¹‹å‰ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œæ€»ä¼šå»ç»§æ‰¿ClassLoaderç±»å¹¶é‡å†™loadClass()æ–¹æ³•ï¼Œä»è€Œå®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œä½†æ˜¯åœ¨JDK1.2ä¹‹åå·²ä¸å†å»ºè®®ç”¨æˆ·å»è¦†ç›–loadClass()æ–¹æ³•ï¼Œè€Œæ˜¯å»ºè®®æŠŠè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨é€»è¾‘å†™åœ¨findClass()æ–¹æ³•ä¸­ã€‚</li>
<li>åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¤ªè¿‡äºå¤æ‚çš„éœ€æ±‚ï¼Œå¯ä»¥ç›´æ¥ç»§æ‰¿URLClassLoaderç±»ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…è‡ªå·±å»ç¼–å†™findClass()æ–¹æ³•åŠå…¶è·å–å­—èŠ‚ç æµçš„æ–¹å¼ï¼Œä½¿è‡ªå®šä¹‰ç±»åŠ è½½å™¨ç¼–å†™æ›´åŠ ç®€æ´ã€‚</li>
</ul>
<h2 id="2-5-ğŸ’‘åŒäº²å§”æ´¾æœºåˆ¶"><a href="#2-5-ğŸ’‘åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="2.5 ğŸ’‘åŒäº²å§”æ´¾æœºåˆ¶"></a>2.5 ğŸ’‘åŒäº²å§”æ´¾æœºåˆ¶</h2><blockquote>
<p>ğŸ•µï¸å·¥ä½œåŸç†</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/22607/image-20201028095903827.png" class="" title="image-20201028095903827">

<p><strong>è´£ä»»é“¾æ¨¡å¼</strong></p>
<ul>
<li>å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œå®ƒå¹¶ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ‰˜ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œã€‚</li>
<li>å¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’å½’ï¼Œè¯·æ±‚æœ€ç»ˆå°†åˆ°è¾¾é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ã€‚</li>
<li>å¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå€˜è‹¥çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ã€‚</li>
</ul>
<blockquote>
<p>ğŸŒ ä¼˜åŠ¿</p>
</blockquote>
<ul>
<li>é¿å…ç±»çš„é‡å¤åŠ è½½</li>
<li>ä¿æŠ¤ç¨‹åºå®‰å…¨ï¼Œé˜²æ­¢æ ¸å¿ƒAPè¢«éšæ„ç¯¡æ”¹</li>
</ul>
<blockquote>
<p>ğŸ“˜æ²™ç®±å®‰å…¨æœºåˆ¶</p>
</blockquote>
<p>å‡å¦‚åœ¨java.langåŒ…ä¸‹è‡ªå®šä¹‰Stringç±»ï¼Œç¨‹åºä¼šæŠ¥é”™ã€‚</p>
<p>å› ä¸ºåœ¨åŠ è½½è‡ªå®šä¹‰Stringç±»çš„æ—¶å€™å›ç‡å…ˆä½¿ç”¨å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½ï¼Œè€Œå¼•å¯¼ç±»åŠ è½½å™¨åœ¨åŠ è½½çš„è¿‡ç¨‹ä¸­ä¼šå…ˆåŠ è½½jdkè‡ªå¸¦çš„æ–‡ä»¶(rt.jaråŒ…ä¸­java/lang/String.class)ï¼ŒæŠ¥é”™ä¿¡æ¯æ˜¯æ‰¾ä¸åˆ°mainæ–¹æ³•ï¼Œå°±æ˜¯å› ä¸ºåŠ è½½çš„æ˜¯rt.jarä¸­çš„Stringç±»ã€‚è¿™æ ·å¯ä»¥ä¿è¯å¯¹Javaæ ¸å¿ƒæºä»£ç çš„ä¿æŠ¤ã€‚</p>
<h2 id="2-6-ğŸ”°å…¶ä»–"><a href="#2-6-ğŸ”°å…¶ä»–" class="headerlink" title="2.6 ğŸ”°å…¶ä»–"></a>2.6 ğŸ”°å…¶ä»–</h2><blockquote>
<p>âš“åœ¨JVMä¸­è¡¨ç¤ºä¸¤ä¸ªclasså¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ä¸ªç±»å­˜åœ¨çš„ä¸¤ä¸ªå¿…è¦æ¡ä»¶</p>
</blockquote>
<ul>
<li>ç±»çš„å®Œæ•´ç±»åå¿…é¡»ä¸€è‡´ï¼ŒåŒ…æ‹¬åŒ…å</li>
<li>åŠ è½½è¿™ä¸ªç±»çš„ClassLoaderå¿…é¡»ç›¸åŒ</li>
</ul>
<p>æ¢å¥è¯è¯´ï¼Œåœ¨JVMä¸­ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»å¯¹è±¡æ¥æºäºåŒä¸€ä¸ªclassæ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹Ÿæœºæ‰€åŠ è½½ï¼Œä½†åªè¦åŠ è½½å®ƒä»¬çš„ClassLoaderå®ä¾‹å¯¹è±¡ä¸åŒï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å¯¹è±¡ä¹Ÿæ˜¯ä¸ç›¸ç­‰çš„ã€‚</p>
<blockquote>
<p>âš“å¯¹ç±»åŠ è½½å™¨çš„å¼•ç”¨</p>
</blockquote>
<p>JVMå¿…é¡»çŸ¥é“ä¸€ä¸ªç±»å‹æ˜¯ç”±å¯åŠ¨åŠ è½½å™¨åŠ è½½çš„è¿˜æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ã€‚å¦‚æœä¸€ä¸ªç±»å‹æ˜¯ç”±ç”¨æˆ·ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œé‚£ä¹ˆJVMä¼šå°†è¿™ä¸ªç±»åŠ è½½å™¨çš„ä¸€ä¸ªå¼•ç”¨ä½œä¸ºç±»å‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†ä¿å­˜åœ¨æ–¹æ³•åŒºä¸­ã€‚å½“è§£æä¸€ä¸ªç±»å‹åˆ°å¦ä¸€ä¸ªç±»å‹çš„å¼•ç”¨çš„æ—¶å€™ï¼ŒJVMéœ€è¦ä¿è¯è¿™ä¸¤ä¸ªç±»å‹çš„ç±»åŠ è½½å™¨æ˜¯ç›¸åŒçš„ã€‚</p>
<blockquote>
<p>âš“ç±»çš„ä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨</p>
</blockquote>
<p>Javaç¨‹åºå¯¹ç±»çš„ä½¿ç”¨æ–¹å¼åˆ†ä¸ºï¼šä¸»åŠ¨ä½¿ç”¨å’Œè¢«åŠ¨ä½¿ç”¨</p>
<p>ä¸»åŠ¨ä½¿ç”¨ï¼Œåˆ†ä¸ºä¸ƒç§æƒ…å†µï¼š</p>
<ul>
<li>åˆ›å»ºç±»çš„å®ä¾‹</li>
<li>è®¿é—®æŸä¸ªç±»æˆ–æ¥å£çš„é™æ€å˜é‡ï¼Œæˆ–è€…å¯¹è¯¥é™æ€å˜é‡èµ‹å€¼</li>
<li>è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•</li>
<li>åå°„(æ¯”å¦‚ï¼šClass.forName(â€œtop.parakâ€))</li>
<li>åˆå§‹åŒ–ä¸€ä¸ªç±»çš„å­ç±»</li>
<li>Javaè™šæ‹Ÿæœºå¯åŠ¨æ—¶è¢«æ ‡æ˜ä¸ºå¯åŠ¨ç±»çš„ç±»</li>
<li>JDK7å¼€å§‹æä¾›çš„åŠ¨æ€è¯­è¨€æ”¯æŒï¼šjava.lang.invoke.MethodHandleå®ä¾‹çš„è§£æç»“æœ<br>REF_getStaticã€REF_putStaticã€REF_invokeStaticå¥æŸ„å¯¹åº”çš„ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–</li>
</ul>
<p>é™¤äº†ä»¥ä¸Šä¸ƒç§æƒ…å†µï¼Œå…¶ä»–ä½¿ç”¨Javaç±»çš„æ–¹å¼éƒ½è¢«çœ‹åšæ˜¯è¢«åŠ¨ä½¿ç”¨ï¼Œéƒ½ä¸ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-1(JVMæ¦‚è¿°)</title>
    <url>/posts/21157/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-1-ğŸ“š-æ¦‚è¿°"><a href="#1-1-ğŸ“š-æ¦‚è¿°" class="headerlink" title="1.1 ğŸ“š æ¦‚è¿°"></a>1.1 ğŸ“š æ¦‚è¿°</h2><blockquote>
<p>ğŸ“–å®šä¹‰</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºå°±æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç çš„è¿è¡Œç¯å¢ƒï¼Œè´Ÿè´£è£…è½½å­—èŠ‚ç åˆ°å…¶å†…éƒ¨ï¼Œè§£é‡Š/ä¾¿äºä¸ºå¯¹åº”å¹³å°ä¸Šçš„æœºå™¨æŒ‡ä»¤æ‰§è¡Œã€‚</p>
<blockquote>
<p>ğŸŒ ç‰¹ç‚¹</p>
</blockquote>
<ul>
<li>ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œ</li>
<li>è‡ªåŠ¨å†…å­˜ç®¡ç†</li>
<li>åƒåœ¾è‡ªåŠ¨å›æ”¶</li>
</ul>
<div class="mermaid">graph TD
A[Javaç¨‹åº]
B[å­—èŠ‚ç æ–‡ä»¶]
C[Winç‰ˆJVM]
D[Linuxç‰ˆJVM]
E[Maç‰ˆJVM]
A --&gt; B
B --&gt; C
B --&gt; D
B --&gt; E</div>



<blockquote>
<p>ğŸ•µï¸Javaä»£ç çš„æ‰§è¡Œæµç¨‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/21157/image-20201026120407011.png" class="" title="image-20201026120407011">





<blockquote>
<p>ğŸ”°æ‹“å±•</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºä¸ä»…ä»…èƒ½ç”¨æ¥è§£é‡ŠJavaè¯­è¨€ã€‚</p>
<p>JVMæ ¹æœ¬ä¸å…³å¿ƒè¿è¡Œåœ¨å…¶å†…éƒ¨çš„ç¨‹åºåˆ°åº•æ˜¯ä½•ç§è¯­è¨€ç¼–å†™çš„ï¼Œå®ƒåªå…³å¿ƒâ€œå­—èŠ‚ç â€æ–‡ä»¶ã€‚</p>
<p>å³JVMå…·æœ‰è¯­è¨€æ— å…³æ€§ï¼Œå¹¶ä¸ä¼šå•çº¯åœ°ä¸Javaè¯­è¨€ç»ˆèº«ç»‘å®šï¼Œåªè¦å…¶ä»–ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘ç»“æœæ»¡è¶³å¹¶åŒ…å«JVMçš„å†…éƒ¨æŒ‡ä»¤é›†ã€ç¬¦å·è¡¨ä»¥åŠå…¶ä»–çš„è¾…åŠ©ä¿¡æ¯ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œèƒ½å¤Ÿè¢«JVMæ‰€è¯†åˆ«ã€è£…è½½å¹¶è¿è¡Œã€‚</p>
<p><u>Javaå¹¶ä¸æ˜¯æœ€å¼ºå¤§çš„è¯­è¨€ï¼Œä½†JVMæ˜¯æœ€å¼ºå¤§çš„è™šæ‹Ÿæœºã€‚</u></p>
<div class="mermaid">graph TD
A1((Kotlin))
B1((Clojure))
C1((Groovy))
D1((Scala))
E1((Jython))
F1((JRuby))
G1((JavaScript))
A2[ç¼–è¯‘å™¨]
B2[ç¼–è¯‘å™¨]
C2[ç¼–è¯‘å™¨]
D2[ç¼–è¯‘å™¨]
E2[ç¼–è¯‘å™¨]
F2[ç¼–è¯‘å™¨]
G2[ç¼–è¯‘å™¨]
H[å­—èŠ‚ç æ–‡ä»¶]
I[Javaè™šæ‹Ÿæœº]
A1 --&gt; A2
B1 --&gt; B2
C1 --&gt; C2
D1 --&gt; D2 
E1 --&gt; E2
F1 --&gt; F2
G1 --&gt; G2
A2 --&gt; H
B2 --&gt; H
C2 --&gt; H
D2 --&gt; H
E2 --&gt; H
F2 --&gt; H
G2 --&gt; H
H --&gt; I</div>



<h2 id="1-2-ğŸ“‚-ç»“æ„"><a href="#1-2-ğŸ“‚-ç»“æ„" class="headerlink" title="1.2 ğŸ“‚ ç»“æ„"></a>1.2 ğŸ“‚ ç»“æ„</h2><blockquote>
<p>ğŸ“˜è¯´æ˜</p>
</blockquote>
<ul>
<li>HotSpot VMæ˜¯ç›®å‰å¸‚é¢ä¸Šé«˜æ€§èƒ½è™šæ‹Ÿæœºçš„ä»£è¡¨ä½œä¹‹ä¸€</li>
<li>å®ƒé‡‡ç”¨è§£é‡Šå™¨ä¸å³æ—¶ç¼–è¯‘å™¨å¹¶å­˜çš„æ¶æ„</li>
</ul>
<blockquote>
<p>ğŸ“·JVMæ¶æ„å›¾</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/21157/image-20201026111606382.png" class="" title="image-20201026111606382">

<blockquote>
<p>ğŸ”¬è¯¦ç»†å›¾</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/21157/image-20201026111249155.png" class="" title="image-20201026111249155">



<h2 id="1-3-â³-ç”Ÿå‘½å‘¨æœŸ"><a href="#1-3-â³-ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="1.3 â³ ç”Ÿå‘½å‘¨æœŸ"></a>1.3 â³ ç”Ÿå‘½å‘¨æœŸ</h2><blockquote>
<p>ğŸè™šæ‹Ÿæœºçš„å¯åŠ¨</p>
</blockquote>
<p>Javaè™šæ‹Ÿæœºçš„å¯åŠ¨æ˜¯é€šè¿‡å¼•å¯¼ç±»åŠ è½½å™¨(Bootstrap Class Loader)åˆ›å»ºä¸€ä¸ªåˆå§‹ç±»(initial class)æ¥å®Œæˆçš„ï¼Œè¿™ä¸ªç±»æ˜¯ç”±è™šæ‹Ÿæœºçš„å…·ä½“å®ç°æŒ‡å®šçš„ã€‚</p>
<blockquote>
<p>ğŸè™šæ‹Ÿæœºçš„æ‰§è¡Œ</p>
</blockquote>
<ul>
<li>ä¸€ä¸ªè¿è¡Œä¸­çš„Javaè™šæ‹Ÿæœºæœ‰ç€ä¸€ä¸ªæ¸…æ™°çš„ä»»åŠ¡ï¼šæ‰§è¡ŒJavaç¨‹åº</li>
<li>ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶ä»–æ‰è¿è¡Œï¼Œç¨‹åºç»“æŸæ—¶ä»–å°±åœæ­¢</li>
<li>æ‰§è¡Œä¸€ä¸ªæ‰€è°“çš„Javaç¨‹åºçš„æ—¶å€™ï¼ŒçœŸçœŸæ­£æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªå«åšJavaè™šæ‹Ÿæœºçš„è¿›ç¨‹</li>
</ul>
<blockquote>
<p>ğŸè™šæ‹Ÿæœºçš„é€€å‡º</p>
</blockquote>
<ul>
<li>ç¨‹åºæ­£å¸¸æ‰§è¡Œç»“æŸ</li>
<li>ç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°äº†å¼‚å¸¸æˆ–é”™è¯¯è€Œå¼‚å¸¸ç»ˆæ­¢</li>
<li>ç”±äºæ“ä½œç³»ç»Ÿå‡ºç°é”™è¯¯è€Œå¯¼è‡´Javaè™šæ‹Ÿæœºè¿›ç¨‹ç»ˆæ­¢</li>
<li>æŸçº¿ç¨‹è°ƒç”¨Runtimeç±»æˆ–Systemç±»çš„exitæ–¹æ³•ï¼Œæˆ–Runtimeç±»çš„haltæ–¹æ³•ï¼Œå¹¶ä¸”Javaå®‰å…¨ç®¡ç†å™¨ä¹Ÿå…è®¸è¿™æ¬¡exitæˆ–haltæ“ä½œ</li>
<li>é™¤æ­¤ä¹‹å¤–ï¼ŒJNIè§„èŒƒæè¿°äº†ç”¨JNI Invocation APIæ¥åŠ è½½æˆ–å¸è½½Javaè™šæ‹Ÿæœºæ—¶ï¼ŒJavaè™šæ‹Ÿæœºçš„é€€å‡ºæƒ…å†µã€‚</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-8(å¹¶å‘å·¥å…·ä¹‹åŒæ­¥å™¨)</title>
    <url>/posts/23706/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="8-1-CountDownLatch"><a href="#8-1-CountDownLatch" class="headerlink" title="8.1 CountDownLatch"></a>8.1 CountDownLatch</h2><p><code>CountDownLatch</code>è®¡æ•°å™¨</p>
<p>ç‰¹ç‚¹ï¼šå†…éƒ¨è®¡æ•°å™¨é€’å‡ã€‚</p>
<p>åŠŸèƒ½ï¼šä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•è¿›è¡Œæ±‡æ€»ã€‚</p>
<h3 id="8-1-1-æ¡ˆä¾‹"><a href="#8-1-1-æ¡ˆä¾‹" class="headerlink" title="8.1.1 æ¡ˆä¾‹"></a>8.1.1 æ¡ˆä¾‹</h3><p>ä»»åŠ¡åˆ†è§£ï¼Œç¬¬ä¸‰ä¸ªä»»åŠ¡éœ€è¦ç­‰å¾…ç¬¬ä¸€ä¸ªä»»åŠ¡å’Œç¬¬äºŒä¸ªä»»åŠ¡æ‰§è¡Œè®¡ç®—åè¿›è¡Œæ±‡æ€»ã€‚</p>
<pre><code class="java">import lombok.extern.slf4j.Slf4j;

import java.util.concurrent.*;

/**
 * @author KHighness
 * @since 2021-05-07
 */

@Slf4j(topic = &quot;CountDownLatch&quot;)
public class CountDownLatchDemo &#123;
    private static int total = 0;
    private static final CountDownLatch countDownLatch = new CountDownLatch(2);
    private static final ExecutorService executorService = Executors.newFixedThreadPool(3);

    private static void sleep(int timeout, TimeUnit unit) &#123;
        try &#123;
            unit.sleep(timeout);
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    public static void main(String[] args) &#123;
        executorService.submit(() -&gt; &#123;
            log.debug(&quot;state = &#123;&#125;&quot;, countDownLatch.getCount());
            total += 1;
            sleep(1, TimeUnit.SECONDS);
            log.debug(&quot;&#123;&#125; run over&quot;, Thread.currentThread().getName());
            countDownLatch.countDown();
            log.debug(&quot;state = &#123;&#125;&quot;, countDownLatch.getCount());
        &#125;);
        executorService.submit(() -&gt; &#123;
            log.debug(&quot;state = &#123;&#125;&quot;, countDownLatch.getCount());
            total += 2;
            sleep(1, TimeUnit.SECONDS);
            log.debug(&quot;&#123;&#125; run over&quot;, Thread.currentThread().getName());
            countDownLatch.countDown();
            log.debug(&quot;state = &#123;&#125;&quot;, countDownLatch.getCount());
        &#125;);
        executorService.submit(() -&gt; &#123;
            log.debug(&quot;state = &#123;&#125;&quot;, countDownLatch.getCount());
            try &#123;
                countDownLatch.await();
                log.debug(&quot;result: total = &#123;&#125;&quot;, total);
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
            log.debug(&quot;&#123;&#125; run over&quot;, Thread.currentThread().getName());
        &#125;);
        executorService.shutdown();
        sleep(3, TimeUnit.SECONDS);
        executorService.shutdownNow();
    &#125;
&#125;
</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="powershell">2021-05-08 12:14:58.374 [pool-1-thread-1] DEBUG CountDownLatch - state = 2
2021-05-08 12:14:58.374 [pool-1-thread-2] DEBUG CountDownLatch - state = 2
2021-05-08 12:14:58.374 [pool-1-thread-3] DEBUG CountDownLatch - state = 2
2021-05-08 12:14:59.379 [pool-1-thread-2] DEBUG CountDownLatch - pool-1-thread-2 run over
2021-05-08 12:14:59.379 [pool-1-thread-1] DEBUG CountDownLatch - pool-1-thread-1 run over
2021-05-08 12:14:59.380 [pool-1-thread-2] DEBUG CountDownLatch - state = 1
2021-05-08 12:14:59.380 [pool-1-thread-1] DEBUG CountDownLatch - state = 0
2021-05-08 12:14:59.380 [pool-1-thread-3] DEBUG CountDownLatch - result: total = 3
2021-05-08 12:14:59.380 [pool-1-thread-3] DEBUG CountDownLatch - pool-1-thread-3 run over</code></pre>
<h3 id="8-1-2-åŸç†"><a href="#8-1-2-åŸç†" class="headerlink" title="8.1.2 åŸç†"></a>8.1.2 åŸç†</h3><p>ç±»å›¾</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/23706/image-20210508154726370.png" class="" title="image-20210508154726370">



<p>ï¼ˆ1ï¼‰æ„é€ æ–¹æ³•</p>
<p>å…¥å‚ï¼š<code>count</code>ï¼Œä¼šå°†è®¡æ•°å™¨å€¼<code>count</code>èµ‹ç»™äº†AQSçš„çŠ¶æ€å˜é‡<code>state</code>ã€‚</p>
<pre><code class="java">// CountDownLatch
public CountDownLatch(int count) &#123;
    if (count &lt; 0) throw new IllegalArgumentException(&quot;count &lt; 0&quot;);
    this.sync = new Sync(count);
&#125;

// Sync
Sync(int count) &#123;
    setState(count);
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰<code>void await()</code>æ–¹æ³•</p>
<p>å½“çº¿ç¨‹è°ƒç”¨<code>CountDownLatch</code>çš„<code>await</code>æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹å°±ä¼šé˜»å¡ï¼Œç›´åˆ°ï¼š</p>
<ul>
<li>æ‰€æœ‰çº¿ç¨‹éƒ½è°ƒç”¨äº†<code>CountDownLatch</code>å¯¹è±¡çš„<code>countDown</code>æ–¹æ³•åï¼Œå³è®¡æ•°å™¨å€¼ä¸º0æ—¶</li>
<li>å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•ä¸­æ–­äº†å½“å‰çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹æŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸</li>
</ul>
<pre><code class="java">// CountDownLatch
public void await() throws InterruptedException &#123;
    sync.acquireSharedInterruptibly(1);
&#125;

// AQS
// è·å–å…±äº«èµ„æºæ—¶å¯è¢«ä¸­æ–­
public final void acquireSharedInterruptibly(int arg) throws InterruptedException &#123;
    // å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­å³æŠ›å‡ºå¼‚å¸¸
    if (Thread.interrupted())
        throw new InterruptedException();
    // æŸ¥çœ‹å½“å‰è®¡æ•°å™¨å€¼æ˜¯å¦ä¸º0ï¼Œä¸º0åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™è¿›å…¥AQSçš„é˜Ÿåˆ—ç­‰å¾…
    if (tryAcquireShared(arg) &lt; 0)
        doAcquireSharedInterruptibly(arg);
&#125;

// Sync
// å®ç°çš„AQSæ¥å£
protected int tryAcquireShared(int acquires) &#123;
    return (getState() == 0) ? 1 : -1;
&#125;</code></pre>
<p>ï¼ˆ3ï¼‰<code>boolean await(long timeout, TimeUnit unit)</code>æ–¹æ³•</p>
<p>å½“çº¿ç¨‹è°ƒç”¨äº†<code>CountDownLatch</code>çš„è¯¥æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°ï¼š</p>
<ul>
<li>æ‰€æœ‰çº¿ç¨‹éƒ½è°ƒç”¨äº†<code>CountDownLatch</code>å¯¹è±¡çš„<code>countDown</code>æ–¹æ³•åï¼Œå³è®¡æ•°å™¨å€¼ä¸º0æ—¶</li>
<li>è®¾ç½®çš„<code>timeout</code>æ—¶é—´åˆ°äº†ï¼Œå› ä¸ºè¶…æ—¶è¿”å›<code>false</code></li>
<li>å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•ä¸­æ–­äº†å½“å‰çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹æŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸</li>
</ul>
<pre><code class="java">// CountDownLatch
public boolean await(long timeout, TimeUnit unit)
    throws InterruptedException &#123;
    return sync.tryAcquireSharedNanos(1, unit.toNanos(timeout));
&#125;</code></pre>
<p>ï¼ˆ4ï¼‰<code>void countDown()</code>æ–¹æ³•</p>
<p>çº¿ç¨‹è°ƒç”¨è¯¥æ–¹æ³•åï¼Œè®¡æ•°å™¨çš„å€¼é€’å‡ï¼Œé€’å‡åå¦‚æœè®¡æ•°å™¨çš„å€¼ä¸º0åˆ™å”¤é†’æ‰€æœ‰å› è°ƒç”¨awaitæ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚</p>
<p>å¦‚æœstateåŸå§‹å€¼ä¸ºnï¼Œæœ‰(n+1)ä¸ªçº¿ç¨‹è°ƒç”¨äº†<code>countDown</code>æ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬(n+1)ä¸ªçº¿ç¨‹è°ƒç”¨æ— æ•ˆã€‚</p>
<pre><code class="java">// CountDownLatch
public void countDown() &#123;
    sync.releaseShared(1);
&#125;

// AQS
public final boolean releaseShared(int arg) &#123;
    // è°ƒç”¨Syncçš„å®ç°ï¼ŒæˆåŠŸåˆ™å”¤é†’é˜»å¡çš„çº¿ç¨‹
    if (tryReleaseShared(arg)) &#123;
        // AQSé‡Šæ”¾èµ„æº
        doReleaseShared();
        return true;
    &#125;
    return false;
&#125;

// Sync
protected boolean tryReleaseShared(int releases) &#123;
    // å¾ªç¯CASä½¿è®¡æ•°å™¨ï¼ˆçŠ¶æ€å€¼stateï¼‰å‡1å¹¶æ›´æ–°ï¼Œç›´åˆ°æˆåŠŸ
    for (;;) &#123;
        int c = getState();
        // é˜²æ­¢stateå˜æˆè´Ÿæ•°
        if (c == 0)
            return false;
        int nextc = c-1;
        if (compareAndSetState(c, nextc))
            return nextc == 0;
    &#125;
&#125;</code></pre>
<p>ï¼ˆ5ï¼‰<code>long getCount()</code>æ–¹æ³•</p>
<p>è·å–å½“å‰è®¡æ•°å™¨çš„å€¼ï¼Œå³AQSçš„<code>state</code>å€¼ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•ã€‚</p>
<pre><code class="java">// CountDownLatch
public long getCount() &#123;
    return sync.getCount();
&#125;

// AQS
int getCount() &#123;
    return getState();
&#125;</code></pre>
<h3 id="8-1-3-å°ç»“"><a href="#8-1-3-å°ç»“" class="headerlink" title="8.1.3 å°ç»“"></a>8.1.3 å°ç»“</h3><p><code>CountDownLatch</code>ç›¸æ¯”äºä½¿ç”¨çº¿ç¨‹çš„<code>join</code>æ–¹æ³•æ¥å®ç°çº¿ç¨‹é—´åŒæ­¥ï¼Œå‰è€…æ›´å…·æœ‰çµæ´»æ€§å’Œæ–¹ä¾¿æ€§ï¼Œå› ä¸ºåœ¨<code>ExecutorService</code>çº¿ç¨‹æ± ä¸­æ— æ³•ç›´æ¥è°ƒç”¨å…¶ä»–çº¿ç¨‹çš„<code>join</code>æ–¹æ³•ã€‚</p>
<p><code>CountDownLatch</code>ä½¿ç”¨AQSçš„çŠ¶æ€å˜é‡<code>state</code>æ¥å­˜æ”¾è®¡æ•°å™¨çš„å€¼ã€‚é¦–å…ˆåœ¨åˆå§‹åŒ–è®¾ç½®è®¡æ•°å™¨å€¼ï¼ˆAQSçŠ¶æ€å€¼ï¼‰ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨<code>countDown</code>æ–¹æ³•å®é™…æ˜¯åŸå­æ€§é€’å‡AQSçš„çŠ¶æ€å€¼ã€‚å½“çº¿ç¨‹è°ƒç”¨<code>await</code>æ–¹æ³•åå½“å‰çº¿ç¨‹ä¼šè¢«æ”¾å…¥AQSçš„é˜»å¡é˜Ÿåˆ—ç­‰å¾…ï¼Œå¾…è®¡æ•°å™¨ä¸º0å†è¿”å›ã€‚å…¶ä»–çº¿ç¨‹è°ƒç”¨<code>countDown</code>æ–¹æ³•è®©è®¡æ•°å™¨å€¼é€’å‡1ï¼Œå½“è®¡æ•°å™¨å€¼å˜æˆ0æ—¶ï¼Œå½“å‰çº¿ç¨‹è¿˜è¦è°ƒç”¨AQSçš„<code>doReleaseSShared</code>æ–¹æ³•æ¥æ¿€æ´»ç”±äºè°ƒç”¨<code>await</code>æ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹ã€‚</p>
<h2 id="8-2-CyclicBarrier"><a href="#8-2-CyclicBarrier" class="headerlink" title="8.2 CyclicBarrier"></a>8.2 CyclicBarrier</h2><p><code>CyclicBarrier</code>å›ç¯<a href="%E5%9B%9E%E7%8E%AF%E6%98%AF%E5%9B%A0%E4%B8%BA%E5%BD%93%E6%89%80%E6%9C%89%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%AF%95%EF%BC%8C%E5%B9%B6%E9%87%8D%E7%BD%AE%60CylicBarrier%60%E7%9A%84%E7%8A%B6%E6%80%81%E4%BB%A5%E4%BE%BF%E9%87%8D%E7%94%A8%E3%80%82">^1</a>å±éšœ<a href="%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%60await%60%E6%96%B9%E6%B3%95%E5%90%8E%E5%B0%B1%E4%BC%9A%E8%A2%AB%E9%98%BB%E5%A1%9E%EF%BC%8C%E8%BF%99%E4%B8%AA%E9%98%BB%E5%A1%9E%E7%82%B9%E5%B0%B1%E7%A7%B0%E4%B8%BA%E5%B1%8F%E9%9A%9C%E7%82%B9%EF%BC%8C%E7%AD%89%E6%89%80%E6%9C%89%E7%BA%BF%E7%A8%8B%E9%83%BD%E8%B0%83%E7%94%A8%E4%BA%86%60await%60%E6%96%B9%E6%B3%95%E5%90%8E%EF%BC%8C%E7%BA%BF%E7%A8%8B%E4%BB%AC%E5%B0%B1%E4%BC%9A%E5%86%B2%E7%A0%B4%E5%B1%8F%E9%9A%9C%EF%BC%8C%E7%BB%A7%E7%BB%AD%E5%90%91%E4%B8%8B%E8%BF%90%E8%A1%8C%E3%80%82">^2</a></p>
<p>ç‰¹ç‚¹ï¼šå†…éƒ¨è®¡æ•°å™¨é€’å‡ã€‚</p>
<p>åŠŸèƒ½ï¼šè®©ä¸€ç»„çº¿ç¨‹å…¨éƒ¨è¾¾åˆ°ä¸€ä¸ªçŠ¶æ€åå†å…¨éƒ¨åŒæ—¶æ‰§è¡Œã€‚</p>
<p>[^ 1]ï¼š å›ç¯æ˜¯å› ä¸ºå½“æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶é‡ç½®<code>CylicBarrier</code>çš„çŠ¶æ€ä»¥ä¾¿é‡ç”¨ã€‚</p>
<p>[^ 2]ï¼šçº¿ç¨‹è°ƒç”¨<code>await</code>æ–¹æ³•åå°±ä¼šè¢«é˜»å¡ï¼Œè¿™ä¸ªé˜»å¡ç‚¹å°±ç§°ä¸ºå±éšœç‚¹ï¼Œç­‰æ‰€æœ‰çº¿ç¨‹éƒ½è°ƒç”¨äº†<code>await</code>æ–¹æ³•åï¼Œçº¿ç¨‹ä»¬å°±ä¼šå†²ç ´å±éšœï¼Œç»§ç»­å‘ä¸‹è¿è¡Œã€‚</p>
<h3 id="8-2-1-æ¡ˆä¾‹"><a href="#8-2-1-æ¡ˆä¾‹" class="headerlink" title="8.2.1 æ¡ˆä¾‹"></a>8.2.1 æ¡ˆä¾‹</h3><p>ä¸€ä¸ªä»»åŠ¡éœ€è¦ä¸‰æ­¥å®Œæˆï¼Œéœ€è¦æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚</p>
<pre><code class="java">@Slf4j(topic = &quot;CyclicBarrier&quot;)
public class CyclicBarrierDemo &#123;
    private static final CyclicBarrier cyclicBarrier = new CyclicBarrier(3, () -&gt; &#123;log.debug(&quot;==========================&quot;);&#125;);
    private static final ExecutorService executorService = Executors.newFixedThreadPool(10);

    private static void sleep(int timeout, TimeUnit unit) &#123;
        try &#123;
            unit.sleep(timeout);
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    public static void main(String[] args) &#123;
        for (int i = 0; i &lt; 3; i++) &#123;
            executorService.submit(() -&gt; &#123;
                try &#123;
                    log.debug(&quot;&#123;&#125; first step&quot;, Thread.currentThread().getName());
                    sleep(1, TimeUnit.SECONDS);
                    cyclicBarrier.await();
                    log.debug(&quot;&#123;&#125; second step&quot;, Thread.currentThread().getName());
                    sleep(1, TimeUnit.SECONDS);
                    cyclicBarrier.await();
                    log.debug(&quot;&#123;&#125; third step&quot;, Thread.currentThread().getName());
                &#125; catch (InterruptedException | BrokenBarrierException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;);
        &#125;
        executorService.shutdown();
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="powershell">2021-05-08 16:28:58.549 [pool-1-thread-2] DEBUG CyclicBarrier - pool-1-thread-2 first step
2021-05-08 16:28:58.549 [pool-1-thread-1] DEBUG CyclicBarrier - pool-1-thread-1 first step
2021-05-08 16:28:58.549 [pool-1-thread-3] DEBUG CyclicBarrier - pool-1-thread-3 first step
2021-05-08 16:28:59.558 [pool-1-thread-2] DEBUG CyclicBarrier - ==========================
2021-05-08 16:28:59.559 [pool-1-thread-2] DEBUG CyclicBarrier - pool-1-thread-2 second step
2021-05-08 16:28:59.559 [pool-1-thread-3] DEBUG CyclicBarrier - pool-1-thread-3 second step
2021-05-08 16:28:59.559 [pool-1-thread-1] DEBUG CyclicBarrier - pool-1-thread-1 second step
2021-05-08 16:29:00.570 [pool-1-thread-2] DEBUG CyclicBarrier - ==========================
2021-05-08 16:29:00.570 [pool-1-thread-2] DEBUG CyclicBarrier - pool-1-thread-2 third step
2021-05-08 16:29:00.570 [pool-1-thread-1] DEBUG CyclicBarrier - pool-1-thread-1 third step
2021-05-08 16:29:00.570 [pool-1-thread-3] DEBUG CyclicBarrier - pool-1-thread-3 third step</code></pre>
<h3 id="8-2-2-åŸç†"><a href="#8-2-2-åŸç†" class="headerlink" title="8.2.2 åŸç†"></a>8.2.2 åŸç†</h3><p>ç±»å›¾</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/23706/image-20210508154851790.png" class="" title="image-20210508154851790">

<p><code>CyclicBarrier</code>åŸºäºç‹¬å é”å®ç°ï¼Œæœ¬è´¨åº•å±‚è¿˜æ˜¯åŸºäºAQSçš„ã€‚</p>
<p>å±æ€§ï¼š</p>
<ul>
<li><p><code>lock</code>ï¼šç‹¬å é”ã€‚</p>
</li>
<li><p><code>trip</code>ï¼šæ¡ä»¶å˜é‡ã€‚</p>
</li>
<li><p><code>barrierCommand</code>ï¼šåˆ°è¾¾å±éšœç‚¹æ‰§è¡Œçš„ä»»åŠ¡ã€‚</p>
</li>
<li><p><code>parties</code>ï¼šçº¿ç¨‹è®¡æ•°å™¨ï¼Œè¿™é‡Œè¡¨ç¤ºå¤šå°‘çº¿ç¨‹è°ƒç”¨<code>await</code>åï¼Œæ‰€æœ‰çº¿ç¨‹æ‰ä¼šå†²ç ´å±éšœç»§ç»­å‘ä¸‹å…è®¸ã€‚</p>
</li>
<li><p><code>count</code>ï¼šæ‰§è¡Œè®°å½•å™¨ï¼Œä¸€å¼€å§‹ç­‰äº<code>parties</code>ï¼Œæ¯å½“æœ‰çº¿ç¨‹è°ƒç”¨<code>await</code>å°±é€’å‡1ï¼Œå½“<code>count</code>ä¸º0æ—¶å°±è¡¨ç¤ºæ‰€æœ‰çº¿ç¨‹éƒ½åˆ°äº†å±éšœç‚¹ã€‚</p>
</li>
</ul>
<p><code>parties</code>å§‹ç»ˆç”¨æ¥è®°å½•æ€»çš„çº¿ç¨‹ä¸ªæ•°ï¼Œå½“<code>count</code>è®¡æ•°å™¨å€¼å˜ä¸º0åï¼Œä¼šå°†<code>parties</code>çš„å€¼èµ‹ç»™<code>count</code>ï¼Œè¿›è€Œè¿›è¡Œæœç”¨ã€‚</p>
<p>å†…éƒ¨ç±»<code>Generation</code>ä»…æœ‰ä¸€ä¸ªå±æ€§<code>broken</code>ï¼Œç”¨æ¥è®°å½•å½“å‰å±éšœæ˜¯å¦è¢«æ‰“ç ´ã€‚æ˜¯åœ¨é”å†…ä½¿ç”¨å˜é‡ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰å£°æ˜ä¸º<code>volatile</code>ã€‚</p>
<p>ï¼ˆ1ï¼‰æ„é€ æ–¹æ³•</p>
<p>å…¥å‚ï¼š<code>parties</code>ï¼ˆå¿…é€‰ï¼‰ã€<code>barrierAction</code>ï¼ˆå¯é€‰ï¼‰</p>
<pre><code class="java">public CyclicBarrier(int parties, Runnable barrierAction) &#123;
    if (parties &lt;= 0) throw new IllegalArgumentException();
    this.parties = parties;
    this.count = parties;
    this.barrierCommand = barrierAction;
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰<code>int await()</code>æ–¹æ³•</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨äº†<code>CyclicBarrier</code>çš„è¯¥æ–¹æ³•æ—¶ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°ï¼š</p>
<ul>
<li><code>parties</code>ä¸ªçº¿ç¨‹éƒ½è°ƒç”¨äº†<code>await</code>æ–¹æ³•ï¼Œçº¿ç¨‹åˆ°è¾¾å±éšœç‚¹</li>
<li>å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•ä¸­æ–­äº†å½“å‰çº¿ç¨‹ï¼Œåˆ™å½“å‰çº¿ç¨‹æŠ›å‡º<code>InterruptedExcetion</code>å¼‚å¸¸</li>
<li>ä¸å½“å‰å±éšœç‚¹å…³è”çš„<code>Generation</code>å¯¹è±¡çš„<code>broken</code>æ ‡å¿—è¢«è®¾ç½®ä¸º<code>true</code>æ—¶ï¼Œä¼šæŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸</li>
</ul>
<p>å†…éƒ¨è°ƒç”¨<code>dowait</code>æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºfalseè¯´æ˜ä¸è®¾ç½®è¶…æ—¶æ—¶é—´</p>
<pre><code class="java">public int await() throws InterruptedException, BrokenBarrierException &#123;
    try &#123;
        return dowait(false, 0L);
    &#125; catch (TimeoutException toe) &#123;
        throw new Error(toe); // cannot happen
    &#125;
&#125;</code></pre>
<p>ï¼ˆ3ï¼‰<code>boolean await(long timeout, TimeUnit unit)</code>æ–¹æ³•</p>
<p>å½“å…ˆçº¿ç¨‹è°ƒç”¨äº†<code>CyclicBarrier</code>çš„è¯¥æ–¹æ³•æ—¶ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°ï¼š</p>
<ul>
<li><code>parties</code>ä¸ªçº¿ç¨‹éƒ½è°ƒç”¨äº†<code>await</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹éƒ½åˆ°äº†å±éšœç‚¹ï¼Œè¿™æ—¶å€™è¿”å›<code>true</code></li>
<li>è®¾ç½®çš„<code>timeout</code>æ—¶é—´åˆ°äº†ï¼Œå› ä¸ºè¶…æ—¶è¿”å›<code>false</code></li>
<li>å…¶ä»–çº¿ç¨‹è°ƒç”¨å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•ä¸­æ–­äº†å½“å‰çº¿ç¨‹ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šæŠ›å‡º<code>InterruptedException</code></li>
<li>ä¸å½“å‰å±éšœç‚¹å…³è”çš„<code>Generation</code>å¯¹è±¡çš„<code>broken</code>æ ‡å¿—è¢«è®¾ç½®ä¸º<code>true</code>æ—¶ï¼Œä¼šæŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸</li>
</ul>
<p>å†…éƒ¨è°ƒç”¨<code>dowait</code>æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¯´æ˜è®¾ç½®è¶…æ—¶ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¶…æ—¶æ—¶é—´</p>
<pre><code class="java">public int await(long timeout, TimeUnit unit) throws InterruptedException, BrokenBarrierException, TimeoutException &#123;
    return dowait(true, unit.toNanos(timeout));
&#125;</code></pre>
<p>ï¼ˆ3ï¼‰<code>int dowait(boolean timed, long nanos)</code>æ–¹æ³•</p>
<pre><code class="java">private int dowait(boolean timed, long nanos) throws InterruptedException, BrokenBarrierException, TimeoutException &#123;
    final ReentrantLock lock = this.lock;
    lock.lock();
    try &#123;
        ...

        // (1)å¦‚æœindex=0åˆ™è¯´æ˜æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°äº†å±éšœç‚¹ï¼Œæ­¤æ—¶æ‰§è¡Œåˆå§‹åŒ–æ—¶ä¼ é€’çš„ä»»åŠ¡
        int index = --count;
        if (index == 0) &#123;  // tripped
            boolean ranAction = false;
            try &#123;
                // (2) æ‰§è¡Œä»»åŠ¡
                final Runnable command = barrierCommand;
                if (command != null)
                    command.run();
                ranAction = true;
                // (3)æ¿€æ´»å…¶ä»–å› è°ƒç”¨awaitæ–¹æ³•è€Œè¢«é˜»å¡çš„çº¿ç¨‹ï¼Œå¹¶ä¸”é‡ç½®CyclicBarrier
                nextGeneration();
                return 0;
            &#125; finally &#123;
                if (!ranAction)
                    breakBarrier();
            &#125;
        &#125;

        // (4)å¦‚æœindex!=0
        for (;;) &#123;
            try &#123;
                // (5)æœªè®¾ç½®è¶…æ—¶æ—¶é—´
                if (!timed)
                    trip.await();
                   // ï¼ˆ6ï¼‰è®¾ç½®äº†è¶…æ—¶æ—¶é—´
                else if (nanos &gt; 0L)
                    nanos = trip.awaitNanos(nanos);
            &#125; catch (InterruptedException ie) &#123;
                ...
            &#125;
            ...
        &#125;
    &#125; finally &#123;
        lock.unlock();
    &#125;
&#125;

private void nextGeneration() &#123;
    // (7)å”¤é†’æ¡ä»¶é˜Ÿåˆ—ä¸­çš„é˜»å¡çº¿ç¨‹
    trip.signalAll();
    // (8)é‡ç½®CyclicBarrier
    count = parties;
    generation = new Generation();
&#125;</code></pre>
<h3 id="8-2-3-å°ç»“"><a href="#8-2-3-å°ç»“" class="headerlink" title="8.2.3 å°ç»“"></a>8.2.3 å°ç»“</h3><p><code>CycleBarrier</code>ä¸<code>CountDownLatch</code>çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå‰è€…æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œå¹¶ä¸”å‰è€…ç‰¹åˆ«é€‚åˆåˆ†æ®µä»»åŠ¡æœ‰åºæ‰§è¡Œçš„åœºæ™¯ã€‚</p>
<p>å†…éƒ¨é€šè¿‡<code>ReentrantLock</code>ç‹¬å é”å®ç°è®¡æ•°å™¨åŸå­æ€§æ›´æ–°ï¼Œå¹¶ä½¿ç”¨æ¡ä»¶å˜é‡é˜Ÿåˆ—æ¥å®ç°çº¿ç¨‹åŒæ­¥ã€‚</p>
<h2 id="8-3-Semaphore"><a href="#8-3-Semaphore" class="headerlink" title="8.3 Semaphore"></a>8.3 Semaphore</h2><p><code>Semaphore</code>ä¿¡å·é‡</p>
<p>ç‰¹ç‚¹ï¼šå†…éƒ¨è®¡æ•°å™¨é€’å¢ã€‚</p>
<p>åŠŸèƒ½ï¼šé™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™ã€‚</p>
<h3 id="8-3-1-æ¡ˆä¾‹"><a href="#8-3-1-æ¡ˆä¾‹" class="headerlink" title="8.3.1 æ¡ˆä¾‹"></a>8.3.1 æ¡ˆä¾‹</h3><p>ä¸»çº¿ç¨‹ç­‰å¾…ä¸¤ä¸ªå­ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</p>
<pre><code class="java">@Slf4j(topic = &quot;CountDownLatch&quot;)
public class CountDownLatchDemo &#123;
    private static final CountDownLatch countDownLatch = new CountDownLatch(2);
    private static final ExecutorService executorService = Executors.newFixedThreadPool(2);

    private static void sleep(int timeout, TimeUnit unit) &#123;
        try &#123;
            unit.sleep(timeout);
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    public static void main(String[] args) throws InterruptedException &#123;
        executorService.submit(() -&gt; &#123;
            sleep(1, TimeUnit.SECONDS);
            countDownLatch.countDown();
        &#125;);
        executorService.submit(() -&gt; &#123;
            sleep(1, TimeUnit.SECONDS);
            countDownLatch.countDown();
        &#125;);
        log.debug(&quot;wait all child thread over&quot;);
        countDownLatch.await();
        log.debug(&quot;all child thread over&quot;);
    &#125;
&#125;</code></pre>
<h3 id="8-3-2-åŸç†"><a href="#8-3-2-åŸç†" class="headerlink" title="8.3.2 åŸç†"></a>8.3.2 åŸç†</h3><p>ç±»å›¾</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/23706/image-20210508204931688.png" class="" title="image-20210508204931688">

<p><code>Semaphore</code>è¿˜æ˜¯ä½¿ç”¨AQSå®ç°çš„ï¼Œ<code>Sync</code>åªæ˜¯å¯¹AQSçš„ä¸€ä¸ªä¿®é¥°ï¼Œå¹¶ä¸”<code>Sync</code>æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œç”¨æ¥æŒ‡å®šè·å–ä¿¡å·é‡æ—¶æ˜¯å¦é‡‡ç”¨å…¬å¹³ç­–ç•¥ã€‚</p>
<p>ï¼ˆ1ï¼‰æ„é€ æ–¹æ³•</p>
<p>å…¥å‚ï¼š<code>permits</code>ï¼ˆå¿…é€‰ï¼‰ã€<code>fair</code>ï¼ˆå¯é€‰ï¼‰</p>
<p><code>Semphore</code>é»˜è®¤é‡‡ç”¨éå…¬å¹³ç­–ç•¥ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨å…¬å¹³ç­–ç•¥éœ€è¦ä½¿ç”¨åŒå‚æ„é€ æ–¹æ³•ã€‚åˆå§‹åŒ–ä¿¡å·é‡ä¸ªæ•°<code>permits</code>è¢«èµ‹ç»™äº†AQSçš„çŠ¶æ€å˜é‡<code>state</code>ã€‚</p>
<pre><code class="java">// Semophore
public Semaphore(int permits, boolean fair) &#123;
    sync = fair ? new FairSync(permits) : new NonfairSync(permits);
&#125;

// Sync
Sync(int permits) &#123;
    setState(permits);
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰<code>void acquire()</code>æ–¹æ³•</p>
<p>å½“å‰çº¿ç¨‹è°ƒç”¨è¯¥æ–¹æ³•çš„ç›®çš„æ˜¯å¸Œæœ›è·å–ä¸€ä¸ªä¿¡å·é‡èµ„æºã€‚</p>
<p>å¦‚æœå½“å‰ä¿¡å·é‡ä¸ªæ•°å¤§äº0ï¼Œåˆ™å½“å‰ä¿¡å·é‡çš„è®¡æ•°ä¼šå‡1ï¼Œç„¶åç›´æ¥è¿”å›ã€‚</p>
<pre><code class="java">public void acquire() throws InterruptedException &#123;
     // ä¼ é€’å‚æ•°ä¸º1ï¼Œè¯´æ˜è¦è·å–ä¸€ä¸ªä¿¡å·é‡èµ„æº
    sync.acquireSharedInterruptibly(1);
&#125;

public final void acquireSharedInterruptibly(int arg) throws InterruptedException &#123;
    // (1)å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡ºä¸­æ–­å¼‚å¸¸
    if (Thread.interrupted())
        throw new InterruptedException();
    // (2)å¦åˆ™è°ƒç”¨Syncå­ç±»æ–¹æ³•å°è¯•è·å–ï¼Œè¿™é‡Œæ ¹æ®æ„é€ æ–¹æ³•ç¡®å®šNonfairSyncè¿˜æ˜¯FairSync
    if (tryAcquireShared(arg) &lt; 0)
        doAcquireSharedInterruptibly(arg);
&#125;</code></pre>
<p>å¯¹äº<code>tryAcquireShared</code>ï¼Œåˆ†ä¸¤ç§æƒ…å†µè®¨è®ºï¼š</p>
<ol>
<li><p>éå…¬å¹³é”</p>
<pre><code class="java">// NonfairSync
protected int tryAcquireShared(int acquires) &#123;
    return nonfairTryAcquireShared(acquires);
&#125;

// Sync
final int nonfairTryAcquireShared(int acquires) &#123;
    for (;;) &#123;
        // è·å–å½“å‰ä¿¡å·é‡
        int available = getState();
        // è®¡ç®—å½“å‰å‰©ä½™é‡
        int remaining = available - acquires;
        // å¦‚æœå½“å‰å‰©ä½™å€¼å°äº0æˆ–è€…CASè®¾ç½®æˆåŠŸåˆ™è¿”å›
        if (remaining &lt; 0 ||
            compareAndSetState(available, remaining))
            return remaining;
    &#125;
&#125;</code></pre>
<p>å…ˆè·å–å½“å‰ä¿¡å·é‡ï¼Œç„¶åå‡å»éœ€è¦è·å–çš„å€¼ï¼Œå¾—åˆ°å‰©ä½™ä¿¡å·é‡ä¸ªæ•°ï¼Œå¦‚æœå‰©ä½™ä¿¡å·é‡å°äº0åˆ™è¯´æ˜å½“å‰ä¿¡å·é‡ä¸ªæ•°æ»¡è¶³ä¸äº†éœ€æ±‚ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›è´Ÿæ•°ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹ä¼šè¢«æ”¾å…¥AQSçš„é˜»å¡é˜Ÿåˆ—è€Œè¢«æŒ‚èµ·ã€‚å¦‚æœå‰©ä½™å€¼å¤§äº0ï¼Œåˆ™ä½¿ç”¨CASæ“ä½œè®¾ç½®å½“å‰ä¿¡å·é‡å€¼ä¸ºå‰©ä½™å€¼ï¼Œç„¶åè¿”å›å‰©ä½™å€¼ã€‚</p>
<p>å¦å¤–ï¼Œç”±äº<code>NonfairSync</code>æ˜¯éå…¬å¹³è·å–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å…ˆè°ƒç”¨<code>acquire</code>æ–¹æ³•è·å–ä¿¡å·é‡çš„çº¿ç¨‹ä¸ä¸€å®šæ¯”åæ¥è€…å…ˆè·å–åˆ°ä¿¡å·é‡ã€‚</p>
</li>
<li><p>å…¬å¹³é”</p>
<pre><code class="java">protected int tryAcquireShared(int acquires) &#123;
    for (;;) &#123;
        // å…ˆæ£€æŸ¥é˜»å¡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±ç»“ç‚¹
        if (hasQueuedPredecessors())
            return -1;
        int available = getState();
        int remaining = available - acquires;
        if (remaining &lt; 0 ||
            compareAndSetState(available, remaining))
            return remaining;
    &#125;
&#125;</code></pre>
<p>AQSå…¬å¹³æ€§çš„ä¿è¯å°±é <code>hasQueuedPredecessors</code>è¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœå½“å‰çº¿ç¨‹èŠ‚ç‚¹çš„å‰é©±ç»“ç‚¹æ˜¯å¦ä¹Ÿåœ¨ç­‰å¾…è·å–è¯¥èµ„æºï¼Œæ˜¯åˆ™æ”¾å¼ƒè‡ªå·±è·å–ä¿¡å·é‡çš„èµ„æ ¼ã€‚</p>
</li>
</ol>
<p>ï¼ˆ3ï¼‰<code>void acquire(int permits)</code>æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•ä¸<code>acquire()</code>æ–¹æ³•ä¸åŒï¼Œåè€…åªéœ€è¦è·å–ä¸€ä¸ªä¿¡å·é‡å€¼ï¼Œè€Œå‰è€…åˆ™è·å–<code>perimits</code>ä¸ªã€‚</p>
<pre><code class="java">public void acquire(int permits) throws InterruptedException &#123;
    if (permits &lt; 0) throw new IllegalArgumentException();
    sync.acquireSharedInterruptibly(permits);
&#125;</code></pre>
<p>ï¼ˆ4ï¼‰<code>void acquireUninterruptibly()</code>æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•ä¸<code>acquire()</code>ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºè¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸å“åº”ï¼Œä¹Ÿå°±æ˜¯å½“å½“å‰çº¿ç¨‹è°ƒç”¨äº†<code>acquireUninterruptibly</code>è·å–èµ„æºæ—¶ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt</code>æ–¹æ³•è®¾ç½®äº†å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ï¼Œæ­¤æ—¶å½“å‰çº¿ç¨‹å¹¶ä¸ä¼šæŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸è€Œè¿”å›ã€‚</p>
<p>ï¼ˆ5ï¼‰<code>void accquireUninterruptibly(int permits)</code>æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•ä¸<code>acquire(int permits)</code>æ–¹æ³•çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œè¯¥æ–¹æ³•å¯¹ä¸­æ–­ä¸å“åº”ã€‚</p>
<pre><code class="java">public void acquireUninterruptibly(int permits) &#123;
    if (permits &lt; 0) throw new IllegalArgumentException();
    sync.acquireShared(permits);
&#125;</code></pre>
<p>ï¼ˆ6ï¼‰<code>void release()</code>æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯æŠŠå½“å‰<code>Semaphore</code>å¯¹è±¡çš„ä¿¡å·é‡å¢åŠ <code>1</code>ï¼Œå¦‚æœå½“å‰æœ‰çº¿ç¨‹å› ä¸ºè°ƒç”¨<code>acquire</code>æ–¹æ³•è¢«é˜»å¡è€Œè¢«æ”¾å…¥AQSçš„é˜»å¡é˜Ÿåˆ—ï¼Œåˆ™ä¼šæ ¹æ®å…¬å¹³ç­–ç•¥é€‰æ‹©ä¸€ä¸ªä¿¡å·é‡ä¸ªæ•°èƒ½è¢«æ»¡è¶³çš„çº¿ç¨‹è¿›è¡Œæ¿€æ´»ï¼Œæ¿€æ´»çš„çº¿ç¨‹ä¼šå°è¯•è·å–åˆšå¢åŠ çš„ä¿¡å·é‡ã€‚</p>
<pre><code class="java">// Semaphore
public void release() &#123;
    // (1)arg=1
    sync.releaseShared(1);
&#125;

// AQS
public final boolean releaseShared(int arg) &#123;
    // (2) å°è¯•é‡Šæ”¾èµ„æºé”
    if (tryReleaseShared(arg)) &#123;
        // (3)èµ„æºé‡Šæ”¾æˆåŠŸåˆ™è°ƒç”¨parkæ–¹æ³•å”¤é†’AQSé˜Ÿåˆ—é‡Œé¢æœ€å…ˆæŒ‚èµ·çš„çº¿ç¨‹
        doReleaseShared();
        return true;
    &#125;
    return false;
&#125;

// Sync
protected final boolean tryReleaseShared(int releases) &#123;
    for (;;) &#123;
        // (4)è·å–å½“å‰ä¿¡å·é‡å€¼
        int current = getState();
        // (5)å½“å‰ä¿¡å·é‡å€¼+1
        int next = current + releases;
        if (next &lt; current) // overflow
            throw new Error(&quot;Maximum permit count exceeded&quot;);
       // (6)é€šè¿‡CASæ›´æ–°ä¿¡å·é‡çš„å€¼
        if (compareAndSetState(current, next))
            return true;
    &#125;
&#125;</code></pre>
<p>ï¼ˆ7ï¼‰<code>void release(int permits)</code>æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•ä¸<code>release()</code>çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå‰è€…è®©ä¿¡å·é‡åŠ <code>permits</code>ï¼Œåè€…åŠ <code>1</code>ã€‚</p>
<h3 id="8-3-3-å°ç»“"><a href="#8-3-3-å°ç»“" class="headerlink" title="8.3.3 å°ç»“"></a>8.3.3 å°ç»“</h3><p><code>Semaphore</code>å®Œå…¨å¯ä»¥è¾¾åˆ°<code>CountDownLatch</code>çš„æ•ˆæœï¼Œä½†æ˜¯<code>Semaphore</code>çš„è®¡æ•°å™¨æ˜¯ä¸å¯ä»¥è‡ªåŠ¨é‡ç½®çš„ï¼Œä¸è¿‡é€šè¿‡å˜ç›¸çš„æ”¹å˜<code>acquire</code>æ–¹æ³•çš„å‚æ•°è¿˜æ˜¯å¯ä»¥å®ç°<code>CyclicBarrier</code>çš„åŠŸèƒ½çš„ã€‚</p>
<h2 id="8-4-é¡ºåºæ§åˆ¶"><a href="#8-4-é¡ºåºæ§åˆ¶" class="headerlink" title="8.4 é¡ºåºæ§åˆ¶"></a>8.4 é¡ºåºæ§åˆ¶</h2><p>æœ‰Aï¼ŒBï¼ŒCä¸‰ä¸ªçº¿ç¨‹ï¼Œå¦‚ä½•åœ¨å¹¶å‘æƒ…å†µä¸‹ä¿è¯ä¸‰ä¸ªçº¿ç¨‹ä¾æ¬¡æ‰§è¡Œï¼Ÿå¦‚ä½•ä¿è¯ä¸‰ä¸ªçº¿ç¨‹æœ‰åºäº¤é”™è¿›è¡Œï¼Ÿ</p>
<p>ä¾æ¬¡æ‰§è¡Œï¼š<code>volatile</code></p>
<pre><code class="java">import lombok.extern.slf4j.Slf4j;

import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

/**
 * @author KHighness
 * @since 2021-05-07
 * @apiNote ä¾æ¬¡æ‰§è¡Œ
 */

@Slf4j(topic = &quot;Successively&quot;)
public class SuccessivelyDemo &#123;
    /**
     * &lt;li&gt;resource = 0, print A&lt;/li&gt;
     * &lt;li&gt;resource = 1, print B&lt;/li&gt;
     * &lt;li&gt;resource = 2, print C&lt;/li&gt;
     */
    private static volatile int resource = 0;
    private static final int size = 3;
    private static final char[] arr = &#123;&#39;A&#39;, &#39;B&#39;, &#39;C&#39;&#125;;
    private static final ExecutorService executorService = Executors.newFixedThreadPool(3);

    public static void main(String[] args) throws InterruptedException &#123;
        for (int i = 0; i &lt; size; i++) &#123;
            final int finalI = i;
            executorService.submit(() -&gt; &#123;
                while (true) &#123;
                    if (resource == finalI) &#123;
                        // æ­¤å¤„ç”¨&#123;@code System.out.println()&#125;ï¼Œåº•å±‚æ˜¯synchronizedï¼Œå°±æ²¡å¿…è¦ç»™resourceåŠ ä¸Švolatile
                        log.debug(&quot;&#123;&#125; =&gt; [&#123;&#125;]&quot;, arr[finalI], System.nanoTime());
                        resource = (resource + 1) % size;
                        break;
                    &#125;
                &#125;
            &#125;);
        &#125;
        TimeUnit.SECONDS.sleep(1);
        executorService.shutdown();
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="powershell">2021-05-08 10:23:55.432 [pool-1-thread-1] DEBUG Successively - A =&gt; [87673300371400]
2021-05-08 10:23:55.432 [pool-1-thread-2] DEBUG Successively - B =&gt; [87673303841800]
2021-05-08 10:23:55.432 [pool-1-thread-3] DEBUG Successively - C =&gt; [87673303936700]</code></pre>
<p>äº¤é”™æ‰§è¡Œï¼š<code>Semophore</code></p>
<pre><code class="java">/**
 * @author KHighness
 * @since 2021-05-07
 * @apiNote äº¤æ›¿æ‰§è¡Œ
 */

@Slf4j(topic = &quot;Alternately&quot;)
public class AlternatelyDemo &#123;
    /**
     * ä¸‰ä¸ªä¿¡å·é‡åˆ†åˆ«æ§åˆ¶Aï¼ŒBï¼ŒCçš„æ‰“å°
     */
    private static final Semaphore[] s = &#123; new Semaphore(1), new Semaphore(1), new Semaphore(1)&#125;;
    private static final int size = 3;
    private static final char[] arr = &#123;&#39;A&#39;, &#39;B&#39;, &#39;C&#39;&#125;;
    private static final ExecutorService executorService = Executors.newFixedThreadPool(3);

    public static void main(String[] args) throws InterruptedException &#123;
        s[1].acquire();
        s[2].acquire();
        for (int i = 0; i &lt; size; i++) &#123;
            final int finalI = i;
            executorService.submit(() -&gt; &#123;
                while (true) &#123;
                    try &#123;
                        s[finalI].acquire();
                        TimeUnit.MILLISECONDS.sleep(100);
                        log.debug(&quot;&#123;&#125; =&gt; [&#123;&#125;]&quot;, arr[finalI], System.nanoTime());
                    &#125; catch (InterruptedException e) &#123;
                        e.printStackTrace();
                    &#125; finally &#123;
                        s[(finalI + 1) % size].release();
                    &#125;
                &#125;
            &#125;);
        &#125;
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="powershell">2021-05-08 10:24:09.177 [pool-1-thread-1] DEBUG Alternately - A =&gt; [87687040947900]
2021-05-08 10:24:09.282 [pool-1-thread-2] DEBUG Alternately - B =&gt; [87687145895400]
2021-05-08 10:24:09.402 [pool-1-thread-3] DEBUG Alternately - C =&gt; [87687265876500]
2021-05-08 10:24:09.522 [pool-1-thread-1] DEBUG Alternately - A =&gt; [87687385861900]
2021-05-08 10:24:09.642 [pool-1-thread-2] DEBUG Alternately - B =&gt; [87687505684000]
2021-05-08 10:24:09.742 [pool-1-thread-3] DEBUG Alternately - C =&gt; [87687605949000]
2021-05-08 10:24:09.862 [pool-1-thread-1] DEBUG Alternately - A =&gt; [87687725648300]
2021-05-08 10:24:09.982 [pool-1-thread-2] DEBUG Alternately - B =&gt; [87687845915200]
2021-05-08 10:24:10.102 [pool-1-thread-3] DEBUG Alternately - C =&gt; [87687965867100]
2021-05-08 10:24:10.205 [pool-1-thread-1] DEBUG Alternately - A =&gt; [87688068762800]
2021-05-08 10:24:10.313 [pool-1-thread-2] DEBUG Alternately - B =&gt; [87688176761000]
2021-05-08 10:24:10.422 [pool-1-thread-3] DEBUG Alternately - C =&gt; [87688285678600]
...</code></pre>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-7(å¹¶å‘å·¥å…·ä¹‹é”åŸç†)</title>
    <url>/posts/61205/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>å…¨ç¨‹é«˜èƒ½ï¼Œæºç è§£è¯»ï¼Œæ‹œè¯»Doug Leaå‰è¾ˆçš„å¹¶å‘ç†å¿µå’Œç„å¦™è®¾è®¡ã€‚</p>
<p>åˆ†æå¹¶ä¸å®Œå…¨é€å½»ï¼Œåªèƒ½å¤§æ¦‚æ¢³ç†å‡ºå¤§è‡´æµç¨‹ï¼Œæœ‰æ—¶é—´å†æ·±å…¥å§ã€‚</p>
<p>ï¼ˆæˆ‘åªæ˜¯Javadocçš„æ¬è¿å·¥ç½¢äº†ã€‚ï¼‰</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210502211334391.png" class="" title="image-20210502211334391">



<h2 id="7-1-AbstractQueuedSynchronizer"><a href="#7-1-AbstractQueuedSynchronizer" class="headerlink" title="7.1 AbstractQueuedSynchronizer"></a>7.1 AbstractQueuedSynchronizer</h2><h3 id="7-1-1-AQSæ¦‚è¿°"><a href="#7-1-1-AQSæ¦‚è¿°" class="headerlink" title="7.1.1 AQSæ¦‚è¿°"></a>7.1.1 AQSæ¦‚è¿°</h3><p><code>AbstractQueuedSynchronizer</code>(æŠ½è±¡åŒæ­¥é˜Ÿåˆ—)ï¼Œæ˜¯é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶ã€‚</p>
<ul>
<li>ä½¿ç”¨<code>state</code>å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å–é”å’Œé‡Šæ”¾é”ã€‚<ul>
<li><code>getState</code>ï¼šè·å–stateçŠ¶æ€</li>
<li><code>setState</code>ï¼šè®¾ç½®stateçŠ¶æ€</li>
<li><code>compareAndSetState</code>ï¼šä¹è§‚é”æœºåˆ¶è®¾ç½®stateçŠ¶æ€</li>
<li>ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œè€Œå…±äº«æ¨¡å¼å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æº</li>
</ul>
</li>
<li>æä¾›äº†åŸºäºFIFOçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œåœ¨å…¶å†…éƒ¨é€šè¿‡èŠ‚ç‚¹<code>head</code>å’Œ<code>tail</code>è®°å½•å¯¹æ‰‹å’Œé˜Ÿå°¾å…ƒç´ ï¼Œé˜Ÿåˆ—çš„å…ƒç´ ç±»å‹ä¸º<code>Node</code>ã€‚<ul>
<li><code>SHARED</code>ï¼šç”¨æ¥æ ‡è®°è¯¥çº¿ç¨‹æ˜¯æ˜¯å¦æ˜¯è·å–å…±äº«èµ„æºæ—¶è¢«é˜»å¡æŒ‚èµ·åæ”¾å…¥AQSé˜Ÿåˆ—çš„</li>
<li><code>EXCLUSIVE</code>ï¼šç”¨æ¥æ ‡è®°çº¿ç¨‹æ˜¯è·å–ç‹¬å èµ„æºæ—¶è¢«æŒ‚èµ·åæ”¾å…¥AQSé˜Ÿåˆ—çš„</li>
<li><code>waitStatus</code>ï¼šè®°å½•å½“å‰çº¿ç¨‹ç­‰å¾…çŠ¶æ€<ul>
<li>1ï¼šCANCELLEDï¼Œçº¿ç¨‹ç»“ç‚¹å·²é‡Šæ”¾ï¼ˆè¶…æ—¶ã€ä¸­æ–­ï¼‰ï¼Œå·²å–æ¶ˆçš„èŠ‚ç‚¹ä¸ä¼šå†é˜»å¡</li>
<li>-1ï¼šSIGNALï¼Œè¯¥çº¿ç¨‹çš„åç»­çº¿ç¨‹éœ€è¦é˜»å¡ï¼Œå³åªè¦å‰é©±ç»“ç‚¹é‡Šæ”¾é”ï¼Œå°±ä¼šé€šçŸ¥æ ‡è¯†ä¸ºSIGNALçŠ¶æ€çš„åç»§ç»“ç‚¹çš„çº¿ç¨‹</li>
<li>-2ï¼šCONDITIONï¼Œè¯¥çº¿ç¨‹åœ¨conditioné˜Ÿåˆ—ä¸­é˜»å¡</li>
<li>-3ï¼šPROPAGATEï¼Œé‡Šæ”¾å…±äº«èµ„æºæ—¶éœ€è¦é€šçŸ¥å…¶ä»–èŠ‚ç‚¹</li>
</ul>
</li>
<li><code>prev</code>è®°å½•å½“å‰èŠ‚ç‚¹çš„å‰é©±ç»“ç‚¹ï¼Œ<code>next</code>è®°å½•å½“å‰é˜¶æ®µçš„åç»§ç»“ç‚¹</li>
</ul>
</li>
<li>å†…éƒ¨ç±»<code>ConditionObject</code>ï¼Œç”¨æ¥ç»“åˆé”å®ç°çº¿ç¨‹åŒæ­¥ï¼Œæ˜¯æ¡ä»¶å˜é‡ï¼Œæ¯ä¸ªæ¡ä»¶å˜é‡å¯¹åº”ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—ï¼ˆå•å‘é“¾è¡¨é˜Ÿåˆ—ï¼‰ï¼Œç”¨æ¥å­˜æ”¾è°ƒç”¨æ¡ä»¶å˜é‡çš„<code>await</code>æ–¹æ³•åè¢«é˜»å¡çš„çº¿ç¨‹ï¼Œé˜Ÿåˆ—çš„å¤´ã€å°¾å…ƒç´ åˆ†åˆ«æ˜¯<code>firstWaiter</code>å’Œ<code>lastWaiter</code>ã€‚</li>
</ul>
<h3 id="7-1-2-è·å–ä¸é‡Šæ”¾èµ„æº"><a href="#7-1-2-è·å–ä¸é‡Šæ”¾èµ„æº" class="headerlink" title="7.1.2 è·å–ä¸é‡Šæ”¾èµ„æº"></a>7.1.2 è·å–ä¸é‡Šæ”¾èµ„æº</h3><p>å¯¹äºAQSæ¥è¯´ï¼Œçº¿ç¨‹åŒæ­¥çš„å…³é”®æ˜¯å¯¹çŠ¶æ€å€¼<code>state</code>è¿›è¡Œæ“ä½œã€‚æ ¹æ®<code>state</code>æ˜¯å¦å±äºä¸€ä¸ªçº¿ç¨‹ï¼Œæ“ä½œ<code>state</code>çš„æ–¹å¼åˆ†ä¸ºç‹¬å æ–¹å¼å’Œå…±äº«æ–¹å¼ã€‚</p>
<ul>
<li>ç‹¬å æ–¹å¼ï¼š<code>void acquire(int arg)</code>  <code>void acquireInterruptibly(int arg)</code> <code>boolean release(int arg)</code></li>
<li>å…±äº«æ–¹å¼ï¼š<code>void acquireShared(int arg)</code>  <code>void acquireSharedInterruptibly(int arg)</code> <code>boolean releaseShared(int arg)</code></li>
</ul>
<p>ä½¿ç”¨ç‹¬å æ–¹å¼è·å–çš„èµ„æºæ˜¯ä¸å…·ä½“çº¿ç¨‹ç»‘å®šçš„ï¼Œå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªçº¿ç¨‹è·å–åˆ°äº†èµ„æºï¼Œå°±ä¼šæ ‡è®°åˆ°æ˜¯è¿™ä¸ªçº¿ç¨‹è·å–åˆ°äº†ï¼Œå…¶ä»–çº¿ç¨‹å†å°è¯•æ“ä½œ<code>state</code>è·å–èµ„æºæ—¶ä¼šå‘ç°å½“å‰è¯¥èµ„æºä¸æ˜¯è‡ªå·±æŒæœ‰çš„ï¼Œå°±ä¼šåœ¨è·å–å¤±è´¥åè¢«é˜»å¡ã€‚æ¯”å¦‚ç‹¬å é”<code>ReentrantLock</code>çš„å®ç°ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†<code>ReentrantLock</code>çš„é”åï¼Œåœ¨AQSå†…éƒ¨ä¼šé¦–å…ˆä½¿ç”¨CASæ“ä½œæŠŠ<code>state</code>çŠ¶æ€å€¼ä»0å˜ä¸º1ï¼Œç„¶åè®¾ç½®å½“å‰é”çš„æŒæœ‰è€…<code>exclusiveOwnerThread</code>ä¸ºå½“å‰çº¿ç¨‹ï¼Œå½“è¯¥çº¿ç¨‹å†æ¬¡è·å–é”æ—¶å‘ç°å®ƒå°±æ˜¯é”çš„æŒæœ‰è€…ï¼Œåˆ™ä¼šæŠŠçŠ¶æ€å€¼<code>state</code>ä»1å˜ä¸º2ï¼Œå³è®¾ç½®å¯é‡å…¥æ¬¡æ•°ï¼Œè€Œå½“å¦å¤–ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶å‘ç°è‡ªå·±å¹¶ä¸æ˜¯è¯¥é”çš„æŒæœ‰è€…å°±ä¼šè¢«æ”¾å…¥AQSé˜»å¡é˜Ÿåˆ—åæŒ‚èµ·ã€‚</p>
<p>å¯¹åº”å…±äº«æ–¹å¼çš„èµ„æºä¸å…·ä½“çº¿ç¨‹æ˜¯ä¸ç›¸å…³çš„ï¼Œå½“å¤šä¸ªçº¿ç¨‹å»è¯·æ±‚èµ„æºæ—¶é€šè¿‡CASæ–¹å¼ç«äº‰è·å–èµ„æºï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°äº†èµ„æºåï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹å†æ¬¡å»è·å–æ—¶å¦‚æœå½“å‰èµ„æºè¿˜èƒ½æ»¡è¶³å®ƒçš„éœ€è¦ï¼Œåˆ™å½“å‰çº¿ç¨‹åªéœ€è¦ä½¿ç”¨CASæ–¹å¼è¿›è¡Œè·å–å³å¯ã€‚æ¯”å¦‚<code>Semaphore</code>ä¿¡å·é‡ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹é€šè¿‡<code>acquire()</code>æ–¹æ³•è·å–ä¿¡å·é‡æ—¶ï¼Œä¼šé¦–å…ˆçœ‹å½“å‰ä¿¡å·é‡ä¸ªæ•°æ˜¯å¦æ»¡è¶³éœ€è¦ï¼Œä¸æ»¡è¶³åˆ™æŠŠå½“å‰çº¿ç¨‹æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¦‚æœæ»¡è¶³åˆ™é€šè¿‡è‡ªæ—‹CASè·å–ä¿¡å·é‡ã€‚</p>
<h4 id="7-1-2-1-ç‹¬å æ–¹å¼"><a href="#7-1-2-1-ç‹¬å æ–¹å¼" class="headerlink" title="7.1.2.1 ç‹¬å æ–¹å¼"></a>7.1.2.1 ç‹¬å æ–¹å¼</h4><p>ï¼ˆ1ï¼‰å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>acquire(int arg)</code>æ–¹æ³•è·å–ç‹¬å èµ„æºæ—¶ï¼Œä¼šé¦–å…ˆä½¿ç”¨<code>tryAcquire</code>æ–¹æ³•å°è¯•è·å–èµ„æºï¼Œå…·ä½“æ˜¯è®¾ç½®çŠ¶æ€å˜é‡<code>state</code>çš„å€¼ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼Œå¤±è´¥åˆ™å°†å½“å‰çº¿ç¨‹å°è£…ä¸ºç±»å‹ä¸º<code>Node.EXCLUSIVE</code>çš„<code>Node</code>èŠ‚ç‚¹åæ’å…¥åˆ°AQSé˜»å¡é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶è°ƒç”¨<code>LockSupport.park(this)</code>æ–¹æ³•æŒ‚èµ·è‡ªå·±ã€‚</p>
<pre><code class="java">public final void acquire(int arg) &#123;
    if (!tryAcquire(arg) &amp;&amp;
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>release(int arg)</code>æ–¹æ³•æ—¶ä¼šå°è¯•ä½¿ç”¨<code>tryRelease</code>æ“ä½œé‡Šæ”¾èµ„æºï¼Œè¿™é‡Œæ˜¯è®¾ç½®çŠ¶æ€å˜é‡<code>state</code>çš„å€¼ï¼Œç„¶åè°ƒç”¨<code>LockSupport.unpark(thread)</code>æ–¹æ³•æ¿€æ´»AQSé˜Ÿåˆ—é‡Œé¢è¢«é˜»å¡çš„ä¸€ä¸ªçº¿ç¨‹ï¼ˆthreadï¼‰ã€‚è¢«æ¿€æ´»çš„çº¿ç¨‹åˆ™ä½¿ç”¨<code>tryAcquire</code>å°è¯•ï¼Œçœ‹å½“å‰çŠ¶æ€å˜é‡<code>state</code>çš„å€¼æ˜¯å¦èƒ½æ»¡è¶³è‡ªå·±çš„éœ€è¦ï¼Œæ»¡è¶³åˆ™è¯¥çº¿ç¨‹è¢«æ¿€æ´»ï¼Œç„¶åç»§ç»­å‘ä¸‹è¿è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šè¢«æ”¾å…¥AQSé˜Ÿåˆ—å¹¶è¢«æŒ‚èµ·ã€‚</p>
<pre><code class="java">public final boolean release(int arg) &#123;
    if (tryRelease(arg)) &#123;
        Node h = head;
        if (h != null &amp;&amp; h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    &#125;
    return false;
&#125;</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAQSç±»å¹¶æ²¡æœ‰æä¾›å¯ç”¨çš„<code>tryAcquire</code>å’Œ<code>tryRelease</code>æ–¹æ³•ï¼Œæ­£å¦‚AQSæ˜¯é”é˜»å¡å’ŒåŒæ­¥å™¨çš„åŸºç¡€æ¡†æ¶ä¸€æ ·ï¼Œ<code>tryAcquire</code>å’Œ<code>tryRelease</code>éœ€è¦ç”±å…·ä½“çš„å­ç±»æ¥å®ç°ã€‚å­ç±»åœ¨å®ç°<code>tryAcquire</code>å’Œ<code>tryRelease</code>æ—¶è¦æ ¹æ®å…·ä½“åœºæ™¯ä½¿ç”¨CASç®—æ³•å°è¯•ä¿®æ”¹<code>state</code>çŠ¶æ€å€¼ï¼ŒæˆåŠŸåˆ™è¿”å›<code>true</code>ï¼Œå¦åˆ™è¿”å›<code>false</code>ã€‚å­ç±»è¿˜éœ€è¦å®šä¹‰ï¼Œåœ¨è°ƒç”¨<code>acquire</code>å’Œ<code>release</code>æ–¹æ³•æ—¶<code>state</code>çŠ¶æ€å€¼çš„å¢å‡ä»£è¡¨ä»€ä¹ˆå«ä¹‰ã€‚</p>
<h4 id="7-1-2-2-å…±äº«æ–¹å¼"><a href="#7-1-2-2-å…±äº«æ–¹å¼" class="headerlink" title="7.1.2.2 å…±äº«æ–¹å¼"></a>7.1.2.2 å…±äº«æ–¹å¼</h4><p>ï¼ˆ1ï¼‰å½“çº¿ç¨‹è°ƒç”¨<code>acquireShared(int arg)</code>è·å–å…±äº«èµ„æºæ—¶ï¼Œä¼šé¦–å…ˆä½¿ç”¨<code>tryAcquireShared</code>å°è¯•è·å–èµ„æºï¼Œå…·ä½“æ˜¯è®¾ç½®çŠ¶æ€<code>state</code>çš„å€¼ï¼ŒæˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼Œå¤±è´¥åˆ™å°†å½“å‰çº¿ç¨‹å°è£…ä¸ºç±»å‹ä¸º<code>Node.SHARED</code>çš„<code>Node</code>èŠ‚ç‚¹åæ’å…¥åˆ°AQSé˜»å¡é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå¹¶ä½¿ç”¨<code>LockSupport.park(this)</code>æ–¹æ³•æŒ‚èµ·è‡ªå·±ã€‚</p>
<pre><code class="java">public final void acquireShared(int arg) &#123;
    if (tryAcquireShared(arg) &lt; 0)
        doAcquireShared(arg);
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>releaseShared(int arg)</code>æ—¶ä¼šå°è¯•ä½¿ç”¨<code>tryReleaseShared</code>æ“ä½œé‡Šæ”¾èµ„æºï¼Œè¿™é‡Œæ˜¯è®¾ç½®çŠ¶æ€å˜é‡<code>state</code>çš„å€¼ï¼Œç„¶åä½¿ç”¨<code>LockSupport.unpark(thread)</code>æ¿€æ´»AQSé˜Ÿåˆ—é‡Œé¢è¢«é˜»å¡çš„ä¸€ä¸ªçº¿ç¨‹ï¼ˆthreadï¼‰ã€‚è¢«æ¿€æ´»çš„çº¿ç¨‹åˆ™ä½¿ç”¨<code>tryReleaseShared</code>æŸ¥çœ‹å½“å‰çŠ¶æ€å˜é‡<code>state</code>çš„å€¼æ˜¯å¦èƒ½æ»¡è¶³è‡ªå·±çš„éœ€è¦ï¼Œæ»¡è¶³åˆ™è¯¥çº¿ç¨‹è¢«æ¿€æ´»ï¼Œç„¶åç»§ç»­å‘ä¸‹è¿è¡Œï¼Œå¦åˆ™è¿˜æ˜¯ä¼šè¢«æ”¾å…¥AQSé˜Ÿåˆ—å¹¶è¢«æŒ‚èµ·ã€‚</p>
<pre><code class="java">public final boolean releaseShared(int arg) &#123;
    if (tryReleaseShared(arg)) &#123;
        doReleaseShared();
        return true;
    &#125;
    return false;
&#125;</code></pre>
<p>åŒæ ·éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒAQSç±»å¹¶æ²¡æœ‰æä¾›å¯ç”¨çš„<code>tryAcquireShared</code>å’Œ<code>tryReleaseShared</code>æ–¹æ³•ï¼Œæ­£å¦‚AQSæ˜¯é”é˜»å¡å’ŒåŒæ­¥å™¨çš„åŸºç¡€æ¡†æ¶ä¸€æ ·ï¼Œ<code>tryAcquire</code>å’Œ<code>tryRelease</code>éœ€è¦ç”±å…·ä½“çš„å­ç±»æ¥å®ç°ã€‚å­ç±»åœ¨å®ç°<code>tryAcquireShared</code>å’Œ<code>tryReleaseShared</code>æ—¶è¦æ ¹æ®å…·ä½“åœºæ™¯ä½¿ç”¨CASç®—æ³•å°è¯•ä¿®æ”¹stateçŠ¶æ€å€¼ï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</p>
<h4 id="7-1-2-3-å…¥é˜Ÿæ“ä½œ"><a href="#7-1-2-3-å…¥é˜Ÿæ“ä½œ" class="headerlink" title="7.1.2.3 å…¥é˜Ÿæ“ä½œ"></a>7.1.2.3 å…¥é˜Ÿæ“ä½œ</h4><p>å½“ä¸€ä¸ªçº¿ç¨‹è·å–é”å¤±è´¥åè¯¥çº¿ç¨‹ä¼šè¢«è½¬æ¢ä¸º<code>Node</code>èŠ‚ç‚¹ï¼Œç„¶åå°±ä¼šä½¿ç”¨<code>enq(final Node node)</code>æ–¹æ³•å°†è¯¥èŠ‚ç‚¹æ’å…¥åˆ°AQSçš„é˜»å¡é˜Ÿåˆ—ã€‚</p>
<pre><code class="java">private Node enq(final Node node) &#123;
    for (;;) &#123;
        Node t = tail;                          // (1)
        if (t == null) &#123; // åˆå§‹åŒ–
            if (compareAndSetHead(new Node()))  // (2)
                tail = head;
        &#125; else &#123;
            node.prev = t;                      // (3)
            if (compareAndSetTail(t, node)) &#123;   // (4)
                t.next = node;
                return t;
            &#125;
        &#125;
    &#125;
&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210503145933217.png" class="" title="image-20210503145933217">

<p>åœ¨ç¬¬ä¸€æ¬¡å¾ªç¯ä¸­ï¼Œåœ¨é˜Ÿåˆ—å°¾éƒ¨æ’å…¥å…ƒç´ æ—¶ï¼Œé˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆdefaultï¼‰æ‰€ç¤ºï¼Œé˜Ÿåˆ—å¤´å°¾èŠ‚ç‚¹éƒ½æŒ‡å‘nullï¼›</p>
<p>æ‰§è¡Œä»£ç ï¼ˆ1ï¼‰åèŠ‚ç‚¹tæŒ‡å‘äº†å°¾éƒ¨èŠ‚ç‚¹ï¼Œæ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆIï¼‰æ‰€ç¤ºï¼›</p>
<p>æ‰§è¡Œä»£ç ï¼ˆ2ï¼‰ï¼Œä½¿ç”¨CASè®¾ç½®ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹ä¸ºå¤´ç»“ç‚¹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™è®©å°¾éƒ¨èŠ‚ç‚¹ä¹ŸæŒ‡å‘å“¨å…µèŠ‚ç‚¹ï¼Œæ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆIIï¼‰æ‰€ç¤ºã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210503151528555.png" class="" title="image-20210503151528555">

<p>ç¬¬ä¸€æ¬¡å¾ªç¯ä¹‹ååªæ’å…¥äº†ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œè¿˜éœ€è¦æ’å…¥nodeèŠ‚ç‚¹ã€‚</p>
<p>åœ¨ç¬¬äºŒæ¬¡å¾ªç¯ä¸­ï¼Œæ‰§è¡Œä»£ç ï¼ˆ1ï¼‰åèŠ‚ç‚¹tæŒ‡å‘äº†å“¨å…µèŠ‚ç‚¹ï¼Œæ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆIIIï¼‰æ‰€ç¤ºï¼›</p>
<p>æ‰§è¡Œä»£ç ï¼ˆ3ï¼‰ï¼Œè®¾ç½®nodeçš„å‰é©±ç»“ç‚¹ä¸ºå“¨å…µèŠ‚ç‚¹ï¼Œæ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆIVï¼‰æ‰€ç¤ºï¼›</p>
<p>æ‰§è¡Œä»£ç ï¼ˆ4ï¼‰ï¼Œé€šè¿‡CASè®¾ç½®nodeèŠ‚ç‚¹ä¸ºå°¾éƒ¨èŠ‚ç‚¹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆVï¼‰æ‰€ç¤ºï¼›</p>
<p>ç„¶åè®¾ç½®å“¨å…µèŠ‚ç‚¹çš„åç»§ç»“ç‚¹ä¸ºnodeç»“ç‚¹ï¼Œæ­¤æ—¶é˜Ÿåˆ—çŠ¶æ€å¦‚å›¾ï¼ˆVIï¼‰æ‰€ç¤ºã€‚</p>
<h4 id="7-1-2-4-è¡¥å……"><a href="#7-1-2-4-è¡¥å……" class="headerlink" title="7.1.2.4 è¡¥å……"></a>7.1.2.4 è¡¥å……</h4><p>åŸºäºAQSå®ç°çš„é”é™¤äº†éœ€è¦é‡å†™ä¸Šé¢æ–¹æ³•ä»¥å¤–ï¼Œè¿˜éœ€è¦é‡å†™<code>isHeldExclusively</code>æ–¹æ³•ï¼Œæ¥åˆ¤æ–­æ˜¯è¢«å½“å‰çº¿ç¨‹ç‹¬å è¿˜æ˜¯è¢«å…±äº«ã€‚</p>
<p>æ­¤å¤–ï¼Œä¸<code>acquire</code>å’Œ<code>release</code>å¯¹åº”çš„éƒ½æœ‰ä¸€ä¸ªå¸¦æœ‰<code>Interruptibly</code>å…³é”®å­—çš„å‡½æ•°ã€‚</p>
<p>åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<p>ä¸å¸¦<code>interruptibly</code>å…³é”®å­—çš„æ–¹æ³•çš„æ„æ€æ˜¯ä¸å¯¹ä¸­æ–­è¿›è¡Œå“åº”ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹åœ¨è°ƒç”¨ä¸å¸¦<code>interruptibly</code>å…³é”®å­—çš„æ–¹æ³•è·å–èµ„æºæ—¶æˆ–è€…è·å–èµ„æºå¤±è´¥è¢«æŒ‚èµ·æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸­æ–­äº†è¯¥çº¿ç¨‹ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¸ä¼šå› ä¸ºè¢«ä¸­æ–­è€ŒæŠ›å‡ºå¼‚å¸¸ï¼Œå®ƒè¿˜æ˜¯ç»§ç»­è·å–èµ„æºæˆ–è€…è¢«æŒ‚èµ·ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸å¯¹ä¸­æ–­è¿›è¡Œå“åº”ï¼Œå¿½ç•¥ä¸­æ–­ã€‚</p>
<p>è€Œå¸¦<code>interruptibly</code>å…³é”®å­—çš„æ–¹æ³•è¦å¯¹ä¸­æ–­è¿›è¡Œå“åº”ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹åœ¨è°ƒç”¨å¸¦<code>interruptibly</code>å…³é”®å­—çš„æ–¹æ³•è·å–èµ„æºæ—¶æˆ–è€…è·å–èµ„æºå¤±è´¥è€Œè¢«æŒ‚èµ·æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸­æ–­äº†è¯¥çº¿ç¨‹ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ä¼šæŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸è€Œè¿”å›ã€‚</p>
<h2 id="7-2-ReentrantLock"><a href="#7-2-ReentrantLock" class="headerlink" title="7.2 ReentrantLock"></a>7.2 ReentrantLock</h2><h3 id="7-2-1-æ¦‚è¿°ä¸åº”ç”¨"><a href="#7-2-1-æ¦‚è¿°ä¸åº”ç”¨" class="headerlink" title="7.2.1 æ¦‚è¿°ä¸åº”ç”¨"></a>7.2.1 æ¦‚è¿°ä¸åº”ç”¨</h3><p><code>ReentrantLock</code>æ˜¯å¯é‡å…¥çš„ç‹¬å é”ï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–è¯¥é”ï¼Œå…¶ä»–è·å–è¯¥é”çš„çº¿ç¨‹ä¼šè¢«é˜»å¡è€Œè¢«æ”¾å…¥è¯¥é”çš„AQSé˜»å¡é˜Ÿåˆ—ä¸­ã€‚</p>
<p>ç¤ºä¾‹1ï¼šåŸºäºAQSå®ç°çš„ä¸å¯é‡å…¥çš„ç‹¬å é”</p>
<pre><code class="java">import java.io.Serializable;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.AbstractQueuedSynchronizer;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;

/**
 * @author KHighness
 * @since 2021-05-02
 * @apiNote ä¸å¯å†²å…¥ç‹¬å é”
 */

public class ParaKLock implements Lock, Serializable &#123;
    private static final long serialVersionUID = 7379874578553124018L;

    // ç‹¬å é”åŒæ­¥å™¨
    private static class ParaKSync extends AbstractQueuedSynchronizer &#123;
        private static final long serialVersionUID = 6278547169976524823L;

        @Override // æ˜¯å¦é”å·²ç»è¢«æŒæœ‰
        protected boolean isHeldExclusively() &#123;
            return getState() == 1;
        &#125;

        @Override // å¦‚æœstateä¸º0ï¼Œåˆ™å°è¯•è·å–é”
        protected boolean tryAcquire(int arg) &#123;
            if (Thread.currentThread() == this.getExclusiveOwnerThread())
                throw new IllegalMonitorStateException(&quot;ä¸æ”¯æŒé”é‡å…¥&quot;);
            if (compareAndSetState(0, 1)) &#123;
                // è®¾ç½®ç‹¬å è€…çº¿ç¨‹
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            &#125;
            return false;
        &#125;

        @Override // å°é‡Šæ”¾é”ï¼Œè®¾ç½®state = 0
        protected boolean tryRelease(int arg) &#123;
            assert arg == 1;
            if (getState() == 0)
                throw new IllegalMonitorStateException(&quot;å½“å‰stateä¸ä¸º0&quot;);
            setExclusiveOwnerThread(null);
            setState(0);
            return true;
        &#125;

        // æä¾›æ¡ä»¶å˜é‡æ¥å£
        Condition newCondition() &#123;
            return new ConditionObject();
        &#125;
    &#125;

    private final ParaKSync sync = new ParaKSync();

    @Override // ä¸€ç›´å°è¯•ï¼Œå¤±è´¥è¿›å…¥AQSé˜Ÿåˆ—
    public void lock() &#123;
        sync.acquire(1);
    &#125;

    @Override // å°è¯•ä¸€æ¬¡
    public boolean tryLock() &#123;
        return sync.tryAcquire(1);
    &#125;

    @Override // è¶…æ—¶å°è¯•
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException &#123;
        return sync.tryAcquireNanos(1, unit.toNanos(time));
    &#125;

    @Override // è§£é”
    public void unlock() &#123;
        sync.release(1);
    &#125;

    // æ˜¯å¦è¢«å æœ‰
    public boolean isLocked() &#123;
        return sync.isHeldExclusively();
    &#125;

    @Override // å¯è¢«æ‰“æ–­å¼åŠ é”
    public void lockInterruptibly() throws InterruptedException &#123;
        sync.acquireInterruptibly(1);
    &#125;

    @Override
    public Condition newCondition() &#123;
        return sync.newCondition();
    &#125;
&#125;</code></pre>
<p>ç¤ºä¾‹2ï¼šåŸºäºä¸Šé¢è‡ªå®šä¹‰ç‹¬å é”å®ç°ç”Ÿäº§-æ¶ˆè´¹æ¨¡å‹</p>
<pre><code class="java">import lombok.extern.slf4j.Slf4j;

import java.util.Queue;
import java.util.Random;
import java.util.concurrent.LinkedBlockingDeque;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Condition;

/**
 * @author KHighness
 * @since 2021-05-03
 * @apiNote ç”Ÿäº§-æ¶ˆè´¹æ¨¡å‹
 */

@Slf4j(topic = &quot;ProducerConsumerModel&quot;)
public class ProducerConsumerModel &#123;
    /** ä¸å¯é‡å…¥ç‹¬å é” */
    private final static ParaKLock LOCK = new ParaKLock();
    /** å·²æ»¡ï¼šç”Ÿäº§è€…æ¡ä»¶å˜é‡ */
    private final static Condition FULL = LOCK.newCondition();
    /** å·²ç©ºï¼šæ¶ˆè´¹è€…è€…æ¡ä»¶å˜é‡ */
    private final static Condition EMPTY = LOCK.newCondition();
    /** äº§å“é˜Ÿåˆ— */
    private final static Queue&lt;Character&gt; QUEUE = new LinkedBlockingDeque&lt;&gt;();
    /** æœ€å¤§å®¹é‡ */
    private final static int QUEUE_MAX_SIZE = 5;
    /** éšæœºå˜é‡ */
    private final static Random RANDOM = new Random();

    /**
     * ç”Ÿæˆéšæœºæ•°å­—/å­—æ¯å­—ç¬¦
     * ascii  char
     * 48-57  0~9
     * 65-90  A~Z
     * 97-122 a~z
     * @return asciiç å­—ç¬¦
     */
    private static Character randomChar() &#123;
        int choice = RANDOM.nextInt(3);
        if (choice == 0)
            return (char) (RANDOM.nextInt(10) + 48);
        else if (choice == 1)
            return (char) (RANDOM.nextInt(26) + 65);
         else
            return (char) (RANDOM.nextInt(26) + 97);
    &#125;

    /**
     * ç”Ÿäº§è€…çº¿ç¨‹
     */
    static class Producer extends Thread &#123;
        public Producer() &#123;
            super.setName(&quot;Producer&quot;);
        &#125;

        @Override
        public void run() &#123;
            while (true) &#123;
                // è·å–ç‹¬å é”
                LOCK.lock();
                try &#123;
                    // (1) å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œç­‰å¾…
                    while (QUEUE.size() == QUEUE_MAX_SIZE) &#123;
                        FULL.await();
                    &#125;
                    // (2) ç”Ÿäº§ä¸€ä¸ªå…ƒç´ åˆ°é˜Ÿåˆ—
                    Character character = randomChar();
                    TimeUnit.SECONDS.sleep(1);
                    log.debug(&quot;ç”Ÿäº§ =&gt; [&#123;&#125;]&quot;, character);
                    QUEUE.add(character);
                    // (3) å”¤é†’æ¶ˆè´¹è€…çº¿ç¨‹
                    EMPTY.signalAll();
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125; finally &#123;
                    // é‡Šæ”¾ç‹¬å é”
                    LOCK.unlock();
                &#125;
            &#125;
        &#125;
    &#125;

    /**
     * æ¶ˆè´¹è€…çº¿ç¨‹
     */
    static class Consumer extends Thread &#123;
        public Consumer() &#123;
            super.setName(&quot;Consumer&quot;);
        &#125;

        @Override
        public void run() &#123;
            while (true) &#123;
                // è·å–ç‹¬å é”
                LOCK.lock();
                try &#123;
                    // (1) å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…
                    while (QUEUE.isEmpty()) &#123;
                        EMPTY.await();
                    &#125;
                    // (2) æ¶ˆè´¹ä¸€ä¸ªå…ƒç´ 
                    Character character = QUEUE.poll();
                    TimeUnit.SECONDS.sleep(1);
                    log.debug(&quot;æ¶ˆè´¹ =&gt; [&#123;&#125;]&quot;, character);
                    // (3) å”¤é†’ç”Ÿäº§è€…çº¿ç¨‹
                    FULL.signalAll();
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125; finally &#123;
                    LOCK.unlock();
                &#125;
            &#125;
        &#125;
    &#125;

    public static void main(String[] args) &#123;
        Producer producer = new Producer();
        Consumer consumer = new Consumer();
        producer.start();
        consumer.start();
    &#125;
&#125;</code></pre>
<h3 id="7-2-2-éå…¬å¹³é”åŸç†"><a href="#7-2-2-éå…¬å¹³é”åŸç†" class="headerlink" title="7.2.2 éå…¬å¹³é”åŸç†"></a>7.2.2 éå…¬å¹³é”åŸç†</h3><p>å…ˆç»“åˆ<code>ReentrantLock</code>çš„å†…éƒ¨ç±»<code>Sync</code> ã€<code>NonfailSync</code>å’Œ<code>AbstractQueuedSynchronizer</code>ä¸­çš„æ–¹æ³•è¿›è¡Œåˆ†æã€‚</p>
<p>å¯¹äº<code>Sync</code>ä¸­çš„æŠ½è±¡æ–¹æ³•<code>lock</code>ï¼Œå…¬å¹³é”ä¸éå…¬å¹³é”åˆ†åˆ«æœ‰ä¸åŒçš„å®ç°ï¼š</p>
<pre><code class="java">abstract void lock();</code></pre>
<p>éå…¬å¹³é”<code>NonfairSync</code>çš„å®ç°å¦‚ä¸‹ï¼š</p>
<pre><code class="java">// (ä¸€)
final void lock() &#123;
    if (compareAndSetState(0, 1))        
        // ç›´æ¥CASï¼Œè€Œä¸å»é˜»å¡é˜Ÿåˆ—ä¸­æ£€æŸ¥ï¼Œä½“ç°éå…¬å¹³æ€§
        // æˆåŠŸåˆ™è®¾ç½®ç‹¬å çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1); // è¿™ä¸ªæ–¹æ³•åœ¨AQSä¸­å·²ç»å®ç°å¥½äº†
&#125;

// (ä¸‰)
protected final boolean tryAcquire(int acquires) &#123;
    return nonfairTryAcquire(acquires); // è¿™ä¸ªæ–¹æ³•åœ¨Syncä¸­å·²ç»å®ç°å¥½äº†
&#125;</code></pre>
<p><code>Sync</code>ä¸­çš„<code>nonfairTryAcquire</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">// (å››)
final boolean nonfairTryAcquire(int acquires) &#123;
    // è·å–å½“å‰è¿›å…¥æ–¹æ³•çš„çº¿ç¨‹
    final Thread current = Thread.currentThread();
    // è·å–stateçŠ¶æ€å€¼
    int c = getState();
    // å¦‚æœè¿˜æœªè·å¾—é”
    if (c == 0) &#123;
        // ä¸å»AQSé˜Ÿåˆ—æ£€æŸ¥ï¼Œç›´æ¥å°è¯•ç”¨CASè·å¾—é”ï¼Œä½“ç°äº†ä¸å…¬å¹³æ€§
        if (compareAndSetState(0, acquires)) &#123;
            // æˆåŠŸè·å–åˆ°é”ï¼Œå®˜å®£ç‹¬å 
            setExclusiveOwnerThread(current);
            return true;
        &#125;
    &#125;
    // å¦‚æœå·²ç»è·å¾—äº†é”å¹¶ä¸”å½“å‰çº¿ç¨‹æ˜¯ç‹¬å çº¿ç¨‹ï¼Œè¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥
    else if (current == getExclusiveOwnerThread()) &#123;
        // state++
        int nextc = c + acquires;
        if (nextc &lt; 0) // overflow
            throw new Error(&quot;Maximum lock count exceeded&quot;);
        setState(nextc);
        return true;
    &#125;
    // è·å–å¤±è´¥ï¼Œå›åˆ°è°ƒç”¨å¤„
    return false;
&#125;</code></pre>
<p><code>AbstractQueuedSynchronizer</code>ä¸­æ¶‰åŠåˆ°çš„ä¸»è¦æ–¹æ³•ï¼š</p>
<pre><code class="java">// (äºŒ) 
// ä»¥ç‹¬å æ¨¡å¼è·å–ï¼Œå¿½ç•¥ä¸­æ–­ã€‚é€šè¿‡è‡³å°‘è°ƒç”¨ä¸€æ¬¡tryAcquireè¿”å›æˆåŠŸã€‚
// å¦åˆ™çº¿ç¨‹ä¼šæ’é˜Ÿï¼Œå¯èƒ½ä¼šåå¤é˜»å¡å’Œè§£é™¤é˜»å¡ï¼Œè°ƒç”¨tryAcquireç›´åˆ°æˆåŠŸã€‚
public final void acquire(int arg) &#123;
    if (!tryAcquire(arg) &amp;&amp; 
        // å°è¯•ç›´æ¥è·å–é”ï¼Œçœ‹åå­—å°±çŸ¥é“ï¼Œåªæ˜¯è¯•ä¸€è¯•
        // æœ‰å¯èƒ½ç›´æ¥æˆåŠŸäº†ï¼Œå°±ä¸éœ€è¦è¿›é˜Ÿåˆ—æ’é˜Ÿäº†
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) 
        // Javaç¼–è¯‘å™¨ä¼šä¼˜åŒ–ï¼Œ&amp;&amp;å‰é¢å·²ç»ä¸ºfalseï¼Œåé¢çš„æ¡ä»¶ä¸å†è¿›è¡Œåˆ¤æ–­
        // èµ°åˆ°è¿™ä¸€æ­¥è¯´æ˜ï¼Œè·å–é”å¤±è´¥ï¼Œç„¶åæ‰§è¡ŒaddWaiteræ–¹æ³•ï¼ŒèŠ‚ç‚¹è®¾ç½®ä¸ºç‹¬å æ¨¡å¼
        // èŠ‚ç‚¹æ·»åŠ å®Œæ¯•åï¼Œæ‰§è¡ŒacquireQueuedæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ‰æ˜¯æœ€ç»ˆçš„BOSS
        // è¿™ä¸ªæ–¹æ³•ä¸€ç›´å¾ªç¯åˆ°è¿”å›ç»“æœä¸ºtrueï¼Œè¿›å…¥ifå—å†…çš„ä»£ç æ‰§è¡Œ
        selfInterrupt(); 
&#125;

// (äº”)
// æ·»åŠ ç­‰å¾…èŠ‚ç‚¹è‡³é˜Ÿåˆ—æœ«å°¾
private Node addWaiter(Node mode) &#123;
    // åˆ›å»ºæ–°èŠ‚ç‚¹nodeï¼Œæ¨¡å¼ä¸ºEXCLUSIVE(ç‹¬å )
    Node node = new Node(Thread.currentThread(), mode);
    // è·å–å°¾éƒ¨èŠ‚ç‚¹
    Node pred = tail;
    // å°¾éƒ¨èŠ‚ç‚¹éç©º
    if (pred != null) &#123;
        // å…ˆå°†nodeçš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰å°¾éƒ¨èŠ‚ç‚¹
        node.prev = pred;
        // é€šè¿‡CASæ“ä½œå°†nodeèŠ‚ç‚¹è®¾ç½®ä¸ºtailå°¾éƒ¨èŠ‚ç‚¹
        if (compareAndSetTail(pred, node)) &#123;
            // å¦‚æœCASæˆåŠŸï¼Œåˆ™å°†åŸtailèŠ‚ç‚¹çš„åç»§ç»“ç‚¹è®¾ç½®ä¸ºå½“å‰å°¾éƒ¨èŠ‚ç‚¹node
            pred.next = node;
            return node;
        &#125;
    &#125;
    // å°¾éƒ¨èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜æ²¡æœ‰å“¨å…µèŠ‚ç‚¹
    // è¿™ä¸ªæ–¹æ³•åœ¨7.1.2.3å·²ç»è¯¦è¿°è¿‡
    // éœ€è¦åˆ›å»ºæ–°çš„å“¨å…µèŠ‚ç‚¹ï¼Œç„¶åæ’å…¥å½“å‰èŠ‚ç‚¹
    enq(node); 
    return node;
&#125;

// (å…­)
// åœ¨é˜Ÿåˆ—ä¸­å¾ªç¯å°è¯•è·å–é”
final boolean acquireQueued(final Node node, int arg) &#123;
    boolean failed = true;
    try &#123;
        // çº¿ç¨‹è·å–é”çš„è¿‡ç¨‹ä¸­æ˜¯å¦äº§ç”Ÿäº†ä¸­æ–­
        boolean interrupted = false;
        for (;;) &#123;
            // è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹
            final Node p = node.predecessor();
            // å¦‚æœå‰é©±èŠ‚ç‚¹ä¸ºheadå“¨å…µèŠ‚ç‚¹ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹ä¸ºç¬¬äºŒèŠ‚ç‚¹
            // æ‹¥æœ‰å°è¯•è·å–é”çš„èµ„æ ¼
            // è·å–é”æˆåŠŸåˆ™è¿›å…¥ifä»£ç å—ï¼Œå‰”é™¤å½“å‰èŠ‚ç‚¹
            if (p == head &amp;&amp; tryAcquire(arg)) &#123;
                // å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼Œå±æ€§threadå’Œprevéƒ½è®¾ç½®ä¸ºnull
                // ç›´æ¥ä½¿ç”¨setHeadè€ŒécompareAndSetHeadï¼Œæ²¡æœ‰ä½¿ç”¨CAS
                // æ˜¯å› ä¸ºæ­¤æ—¶å·²ç»æˆåŠŸè·å–åˆ°ç‹¬å é”
                setHead(node);
                   // è¾…åŠ©GC
                p.next = null; 
                failed = false;
                return interrupted;
            &#125;
            // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œåªæœ‰ä¸¤ç§æƒ…å†µ
            // (1)ä¸ç¬¦åˆè·å–é”çš„å‰æï¼Œå³å½“å‰èŠ‚ç‚¹ä¸æ˜¯ç¬¬äºŒèŠ‚ç‚¹
            // (2)tryAcquireå¤±è´¥ï¼Œå³æ²¡æœ‰æŠ¢å åˆ°é”
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                interrupted = true; // äº§ç”Ÿäº†ä¸­æ–­ï¼Œè®¾ç½®åæ°¸ä¹…ä¿ç•™
        &#125;
    &#125; finally &#123;
        // å½“tryAcquireä¸ºæŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œfailedä¸ºtrue
        if (failed)
            cancelAcquire(node);
    &#125;
&#125;

// (ä¸ƒ)
// è·å–å¤±è´¥ååº”è¯¥æŒ‚èµ·
// å¯»æ‰¾nodeçš„æœ‰æ•ˆå‰é©±ï¼Œå¹¶ä¸”å°†æœ‰æ•ˆå‰é©±çŠ¶æ€è®¾ç½®ä¸ºSIGNALï¼Œè¿”å›trueä»£è¡¨é©¬ä¸Šå¯ä»¥é˜»å¡
private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123;
    // å‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€
    int ws = pred.waitStatus;
    // å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸ºSIGNALï¼ŒçŠ¶æ€æ­£å¸¸ï¼Œå½“å‰çº¿ç¨‹éœ€è¦æŒ‚èµ·ï¼Œè‡ªå·±çš„å”¤é†’ä¾èµ–äºå‰é©±èŠ‚ç‚¹ã€‚
    // å¦‚æœå‰é©±èŠ‚ç‚¹å˜æˆäº†headï¼Œå¹¶ä¸”headçš„ä»£è¡¨çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œå°±ä¼šæ ¹æ®è¿™ä¸ªSIGNALå”¤é†’è‡ªå·±ã€‚
    if (ws == Node.SIGNAL)
        // è¿”å›trueï¼Œåˆ™è¿›å…¥parakAndCheckInterruptæŒ‚èµ·å½“å‰çº¿ç¨‹
        return true;
    // å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸ºCANCELLEDï¼Œè¯´æ˜å‰é©±èŠ‚ç‚¹å› ä¸ºè¶…æ—¶æˆ–è€…å“åº”äº†ä¸­æ–­è€Œå–æ¶ˆæ’é˜Ÿã€‚
    // å› æ­¤éœ€è¦è·¨è¶Šè¿™äº›CANCELLEDç»“ç‚¹ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªçŠ¶æ€&lt;0çš„èŠ‚ç‚¹åšè‡ªå·±çš„å‰é©±ã€‚
    if (ws &gt; 0) &#123;
        do &#123;
            node.prev = pred = pred.prev;
        &#125; while (pred.waitStatus &gt; 0);
        pred.next = node;
    &#125; 
    // å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º0ï¼Œé€šè¿‡CASå°†å…¶çŠ¶æ€è®¾ç½®ä¸ºSIGNAL(-1)
    else &#123;
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    &#125;
    // è¿”å›falseåˆ™ä¸è¿›å…¥parakAndChecKInterruptç»§ç»­åœ¨acquireQueeudä¸­å¾ªç¯
    // å†æ¬¡è¿›å…¥è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œä¾¿ä¼šä»ç¬¬ä¸€ä¸ªifåˆ†æ”¯è¿”å›true
    return false;
&#125;

// (å…«)
// æŒ‚èµ·å¹¶æ£€æŸ¥ä¸­æ–­çŠ¶æ€
private final boolean parkAndCheckInterrupt() &#123;
    // æŒ‚èµ·å½“å‰çº¿ç¨‹
    // å”¤é†’æ–¹å¼ï¼šunpark/interrupt/return
    LockSupport.park(this);
    // è¿”å›ä¸­æ–­çŠ¶æ€ï¼Œå¹¶ä¸”æ¸…é™¤ä¸­æ–­æ ‡è®°
    return Thread.interrupted();
&#125;

// (ä¹)
// è¡¥å……ä¸­æ–­æ ‡è®°
static void selfInterrupt() &#123; 
    Thread.currentThread().interrupt();
&#125;</code></pre>
<p>éå…¬å¹³æŠ¢é”è¿‡ç¨‹æ€»ç»“ï¼š</p>
<p>è°ƒç”¨<code>ReentrantLock</code>çš„<code>lock</code>æ–¹æ³•ï¼Œä¼šæ‰§è¡ŒAQSçš„<code>acquire</code>æ–¹æ³•ï¼Œå…ˆæ‰§è¡Œ<code>NonFairSync</code>çš„<code>tryAcquire</code>æ–¹æ³•å°è¯•è·å–é”ï¼Œå¤±è´¥åˆ™æ‰§è¡ŒAQSçš„<code>acquireQueued</code>æ–¹æ³•åœ¨é˜Ÿåˆ—ä¸­å¾ªç¯è·å–é”ã€‚</p>
<p><code>tryAcquire</code>ï¼šæ£€æŸ¥<code>state</code>çŠ¶æ€å€¼ï¼Œä¸º0è¯´æ˜è¿˜æœªæœ‰çº¿ç¨‹è·å–é”ï¼Œé‚£ä¹ˆè‡ªå·±å°±ç›´æ¥å°è¯•é€šè¿‡CASæ“ä½œå°†<code>state</code>è®¾ç½®ä¸º1ï¼ŒæˆåŠŸåˆ™å®˜å®£è‡ªå·±ç‹¬å ï¼›ä¸ä¸º0ä¸”å½“å‰çº¿ç¨‹æ˜¯ç‹¬å çº¿ç¨‹ï¼Œè¡¨ç¤ºé”å†²å…¥ï¼Œé‚£ä¹ˆ<code>state</code>+1ã€‚ä»¥ä¸Šä¸¤ç§æƒ…å†µæˆåŠŸéƒ½è¿”å›<code>true</code>ï¼Œä»è€Œç»“æŸæŠ¢é”è¿‡ç¨‹ï¼Œå…¶ä»–æƒ…å†µéƒ½ä»£è¡¨è·å–å¤±è´¥ï¼Œè¿”å›<code>false</code>ã€‚</p>
<p>è·å–å¤±è´¥åï¼Œå…ˆæ‰§è¡Œ<code>addWaiter</code>æ–¹æ³•å°†å½“å‰çº¿ç¨‹å°è£…ä¸ºèŠ‚ç‚¹æ·»åŠ åˆ°é˜Ÿåˆ—æœ«å°¾ï¼Œç„¶åè¿›å…¥<code>acquireQueued</code>æ–¹æ³•ï¼Œå¾ªç¯è·å–ç›´åˆ°æˆåŠŸï¼Œæ‰§è¡Œ<code>selfInterrupt</code>æ–¹æ³•ã€‚</p>
<p><code>acquireQueued</code>ï¼šè®¾ç½®ä¸€ä¸ªæ ‡å¿—<code>interrupted = false</code>ï¼Œä»£è¡¨çº¿ç¨‹è·å–é”çš„è¿‡ç¨‹ä¸­æ˜¯å¦äº§ç”Ÿäº†ä¸­æ–­ï¼Œç¬¬ä¸€ä¸ªifåˆ†æ”¯ï¼Œåˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºå“¨å…µèŠ‚ç‚¹ï¼Œæ˜¯åˆ™æ‹¥æœ‰è·å–é”çš„èµ„æ ¼ï¼Œæ‰§è¡Œ<code>tryAcquire</code>å°è¯•è·å–é”ï¼ŒæˆåŠŸåˆ™å°†å‰é©±èŠ‚ç‚¹å‰”é™¤ï¼Œå¹¶ä¸”è¿”å›<code>interrupted</code>ï¼›å¾€ä¸‹æ‰§è¡Œï¼Œç¬¬äºŒä¸ªifåˆ†æ”¯ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯ç¬¬äºŒèŠ‚ç‚¹ï¼Œæ²¡æœ‰è·å–é”çš„èµ„æ ¼ï¼Œæˆ–è€…æ˜¯<code>tryAcquire</code>å¤±è´¥ï¼Œæ²¡æœ‰æŠ¢å åˆ°é”ï¼Œæ‰§è¡Œ<code>shouldParkAfterFailedAcquire</code>å’Œ<code>parkAndCheckInterrupt</code>ï¼Œæ‰§è¡ŒæˆåŠŸåå°†<code>interrupted</code>è®¾ç½®ä¸º<code>true</code>ã€‚è¿”å›<code>false</code>åˆ™ç›´æ¥é€€å‡º<code>acquireQueued</code>è¿‡ç¨‹ï¼Œè¿”å›<code>true</code>åˆ™è¯´æ˜è·å–é”çš„è¿‡ç¨‹ä¸­äº§ç”Ÿäº†ä¸­æ–­ï¼Œä½†æ˜¯è¿™ä¸ªä¸­æ–­æ ‡è®°åœ¨<code>parkAndCheckInterrupt</code>æ¸…é™¤äº†ï¼Œæ‰€ä»¥éœ€è¦å¡«è¡¥ä¸­æ–­æ ‡è®°ã€‚</p>
<p><code>shouldParkAfterFailedAcquire</code>ï¼šé¡¾åæ€ä¹‰ï¼Œè·å–å¤±è´¥ååº”è¯¥æŒ‚èµ·ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º<code>SIGNAL</code>ï¼Œé‚£ä¹ˆå‰é©±èŠ‚ç‚¹é‡Šæ”¾é”åä¼šé€šçŸ¥è‡ªå·±ï¼Œè‡ªå·±å°±å¯ä»¥å®‰å¿ƒé˜»å¡ï¼Œå¹¶è¿”å›<code>true</code>ï¼›å¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º<code>CANCELLED</code>å³å–æ¶ˆæ’é˜Ÿï¼Œé‚£ä¹ˆéœ€è¦å¯»æ‰¾å½“å‰èŠ‚ç‚¹çš„æœ‰æ•ˆå‰é©±ï¼Œå³è·³è¿‡çŠ¶æ€ä¸º<code>CANCELLED</code>çš„èŠ‚ç‚¹ï¼Œæ‰¾åˆ°ä¸€ä¸ªçŠ¶æ€ä¸º<code>SIGNAL</code>çš„èŠ‚ç‚¹ï¼›å¦åˆ™å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º0ï¼Œåˆ™é€šè¿‡CASæ“ä½œå°†å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º<code>SIGNAL</code>ï¼Œåä¸¤ç§éƒ½ä¼šè¿”å›<code>false</code>ï¼Œé‚£ä¹ˆä¼šåœ¨<code>acquireQueued</code>çš„forå¾ªç¯ä¸­è¿›è¡Œä¸‹ä¸€è½®ï¼Œç¬¬äºŒæ¬¡ä¼šæŒ‰ç…§ç¬¬ä¸€ç§æƒ…å†µè¿”å›<code>true</code>ã€‚è¿”å›<code>true</code>åï¼Œæ‰§è¡Œ<code>parkAndCheckInterrupt</code>ã€‚</p>
<p><code>parkAndCheckInterrupt</code>ï¼šå…ˆè°ƒç”¨<code>LockSupport.park</code>æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ˆæœ‰ä¸‰ç§å”¤é†’æ–¹å¼ï¼šâ‘ unpark â‘¡interrupt â‘¢returnï¼‰ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹ç­‰å¾…å”¤é†’ï¼ˆè¢«å”¤é†’çš„æ—¶å€™ä¼šè¿›å…¥<code>acquireQueued</code>çš„ç¬¬ä¸€ä¸ªifåˆ†æ”¯ï¼‰ï¼Œåè°ƒç”¨<code>Thread.interrupted</code>æ–¹æ³•è¿”å›å¹¶é‡ç½®ä¸­æ–­çŠ¶æ€ï¼Œ</p>
<blockquote>
<p>è¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦æ¸…é™¤ä¸­æ–­çŠ¶æ€å‘¢ï¼Ÿè¯·çœ‹çŸ¥ä¹å›ç­”ï¼š <a href="https://www.zhihu.com/question/399039232/answer/1260843911">https://www.zhihu.com/question/399039232/answer/1260843911</a></p>
<p>å¦‚æœä¸æ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¿”å›<code>Thread.currentThread.isInterrupt()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹æŒ‚èµ·åä¾ç„¶æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œé‚£ä¹ˆä¸‹ä¸€è½®å¾ªç¯çš„æ—¶å€™<code>LockSupport.lock</code>æ–¹æ³•å°†ä¼šå¤±æ•ˆï¼Œä½¿å¾—å½“å‰çº¿ç¨‹æŒç»­è¿è¡Œï¼Œåœ¨<code>acquireQueued</code>çš„forå¾ªç¯ä¸­ç©ºè½¬ï¼Œå¯¼è‡´CPU100%ã€‚</p>
</blockquote>
<p>ä¸‹é¢å¼€å§‹å›¾ç¤ºè¯¦è§£ï¼š</p>
<p>æ²¡æœ‰ç«äº‰æ—¶</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210502211712585.png" class="" title="image-20210502211712585">

<p>ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°æ—¶</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210502211848516.png" class="" title="image-20210502211848516">

<p>Thread-1æ‰§è¡Œäº†</p>
<ol>
<li><code>CASC</code>å°è¯•å°†<code>state</code>ç”±<code>0</code>æ”¹ä¸º<code>1</code>ï¼Œç»“æœå¤±è´¥</li>
<li>è¿›å…¥<code>tryAcquire</code>é€»è¾‘ï¼Œè¿™æ—¶<code>state</code>å·²ç»æ˜¯<code>1</code>ï¼Œç»“æœä»ç„¶å¤±è´¥</li>
<li>æ¥ä¸‹æ¥è¿›å…¥<code>addWaiter</code>é€»è¾‘ï¼Œæ„é€ <code>Node</code>é˜Ÿåˆ—<ul>
<li>å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥<code>Node</code>çš„<code>waitStatus</code>çŠ¶æ€ï¼Œå…¶ä¸­0ä¸ºé»˜è®¤æ­£å¸¸çŠ¶æ€</li>
<li>Nodeçš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„</li>
<li>å…¶ä¸­ç¬¬ä¸€ä¸ª<code>Node</code>ç§°ä¸º<code>Dummy</code>ï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹</li>
</ul>
</li>
</ol>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210502213906982.png" class="" title="image-20210502213906982">

<p>è¿›å…¥<code>acquireQueued</code>é€»è¾‘</p>
<ol>
<li><code>acquireQueued</code>ä¼šåœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥<code>park</code>é˜»å¡</li>
<li>å¦‚æœè‡ªå·±æ˜¯ç´§é‚»ç€<code>head</code>ï¼ˆæ’ç¬¬äºŒä½ï¼‰ï¼Œé‚£ä¹ˆå†æ¬¡<code>tryAcquire</code>å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶<code>state</code>ä»ä¸º<code>1</code>ï¼Œå¤±è´¥</li>
<li>è¿›å…¥<code>shouldParkAfterFailedAcquire</code>é€»è¾‘ï¼Œå°†å‰é©±<code>node</code>ï¼Œå³<code>head</code>çš„<code>waitStatus</code>æ”¹ä¸º<code>-1</code>ï¼Œè¿™æ¬¡è¿”å›<code>false</code></li>
</ol>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210502220340804.png" class="" title="image-20210502220340804">

<ol start="4">
<li><p><code>shouldParkAfterFailedAcquire</code>æ‰§è¡Œå®Œæ¯•å›åˆ°<code>acquireQueued</code>ï¼Œå†æ¬¡<code>tryAcquire</code>å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶<code>state</code>ä»ç„¶ä¸º1ï¼Œå¤±è´¥</p>
</li>
<li><p>å½“å†æ¬¡è¿›å…¥<code>shouldParkAfterFailedAcquire</code>æ—¶ï¼Œè¿™æ—¶å› ä¸ºå…¶å‰é©±<code>node</code>çš„<code>waitStatus</code>å·²ç»æ˜¯<code>-1</code>ï¼Œè¿™æ¬¡è¿”å›<code>true</code></p>
</li>
<li><p>è¿›å…¥<code>parkAndCheckInterrupt</code>ï¼ŒThread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰</p>
</li>
</ol>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210502220921530.png" class="" title="image-20210502220921530">

<p>å†æ¬¡æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ä¸Šè¿°è¿‡ç¨‹ç«äº‰å¤±è´¥ï¼Œå˜æˆè¿™ä¸ªæ ·å­</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210502221051585.png" class="" title="image-20210502221051585">

<p>Thread-0é‡Šæ”¾é”</p>
<ul>
<li>è®¾ç½®<code>exclusiveOwnerThread</code>ä¸º<code>null</code></li>
<li><code>state</code> = 0</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210502221412738.png" class="" title="image-20210502221412738">

<p>å½“å‰é˜Ÿåˆ—ä¸ä¸º<code>null</code>ï¼Œå¹¶ä¸”<code>head</code>çš„<code>waitStatus</code>ï¼Œè¿›å…¥<code>unparkSuccessor</code>æµç¨‹</p>
<p>æ‰¾åˆ°é˜Ÿåˆ—ä¸­ç¦»<code>head</code>æœ€è¿‘çš„ä¸€ä¸ª<code>node</code>ï¼ˆæ²¡å–æ¶ˆçš„ï¼‰ï¼Œ<code>unpark</code>æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸ºThread-1ã€‚</p>
<p>å›åˆ°Thread-1çš„<code>acquireQueued</code>æµç¨‹</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210502222848420.png" class="" title="image-20210502222848420">

<p>å¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®</p>
<ul>
<li><code>exclusiveOwnerThread</code>ä¸ºThread-1ï¼Œ<code>state</code> = 1</li>
<li><code>head</code>æŒ‡å‘åˆšåˆšThread-1æ‰€åœ¨çš„<code>Node</code>ï¼Œè¯¥<code>node</code>æ¸…ç©ºThread</li>
<li>åŸæœ¬çš„<code>head</code>å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œè€Œå¯è¢«åƒåœ¾å›æ”¶</li>
</ul>
<p>å¦‚æœè¿™æ—¶å€™æœ‰å…¶ä»–çº¿ç¨‹æ¥ç«äº‰ï¼ˆéå…¬å¹³çš„ä½“ç°ï¼‰ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰Thrtead-4æ¥äº†</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210502224147622.png" class="" title="image-20210502224147622">

<p>å¦‚æœä¸å·§åˆè¢«Thread-4å äº†å…ˆ</p>
<ul>
<li>Thread-4è¢«è®¾ç½®ä¸º<code>exclusiveOwnerThread</code>ï¼Œ<code>state</code> = 1</li>
<li>Thread-1å†æ¬¡è¿›å…¥<code>acquireQueued</code>æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥<code>park</code>é˜»å¡</li>
</ul>
<h3 id="7-2-3-å…¬å¹³é”åŸç†"><a href="#7-2-3-å…¬å¹³é”åŸç†" class="headerlink" title="7.2.3 å…¬å¹³é”åŸç†"></a>7.2.3 å…¬å¹³é”åŸç†</h3><p><code>ReentrantLock-Fair</code>çš„<code>Sync</code>è¦†ç›–æ–¹æ³•<code>tryAcquire</code>ï¼š</p>
<pre><code class="java">protected final boolean tryAcquire(int acquires) &#123;
    final Thread current = Thread.currentThread();
    int c = getState();
    if (c == 0) &#123;
        // å…ˆæ£€æŸ¥AQSé˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ‰å»ç«äº‰
        if (!hasQueuedPredecessors() &amp;&amp;
            compareAndSetState(0, acquires)) &#123;
            setExclusiveOwnerThread(current);
            return true;
        &#125;
    &#125;
    else if (current == getExclusiveOwnerThread()) &#123;
        int nextc = c + acquires;
        if (nextc &lt; 0)
            throw new Error(&quot;Maximum lock count exceeded&quot;);
        setState(nextc);
        return true;
    &#125;
    return false;
&#125;</code></pre>
<p><code>AbstractQueuedSynchronizer</code>ä¸­æ¶‰åŠåˆ°çš„æ–¹æ³•ï¼š</p>
<pre><code class="java">// æŸ¥è¯¢æ˜¯å¦æœ‰çº¿ç¨‹ç­‰å¾…è·å–çš„æ—¶é—´è¶…è¿‡å½“å‰çº¿ç¨‹ï¼Œå³æŸ¥è¯¢ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹
public final boolean hasQueuedPredecessors() &#123;
    Node t = tail; // å°¾èŠ‚ç‚¹è¦ä¹ˆä¸ºç©ºï¼Œè¦ä¹ˆä¸ºç­‰å¾…
    Node h = head; // å¤´èŠ‚ç‚¹è¦ä¹ˆä¸ºç©ºï¼Œè¦ä¹ˆä¸ºå“¨å…µèŠ‚ç‚¹
    Node s;
    return h != t &amp;&amp; // å¤´å°¾èŠ‚ç‚¹ä¸åŒè¯´æ˜é˜Ÿåˆ—ä¸­æœ‰å…¶ä»–èŠ‚ç‚¹
        ((s = h.next) == null || //è¡¨ç¤ºé˜Ÿåˆ—ä¸­æ²¡æœ‰ç¬¬äºŒèŠ‚ç‚¹
         s.thread != Thread.currentThread()); // æˆ–è€…é˜Ÿåˆ—ä¸­ç¬¬äºŒçº¿ç¨‹ä¸æ˜¯æ­¤çº¿ç¨‹
&#125;</code></pre>
<h3 id="7-2-4-å¯é‡å…¥åŸç†"><a href="#7-2-4-å¯é‡å…¥åŸç†" class="headerlink" title="7.2.4 å¯é‡å…¥åŸç†"></a>7.2.4 å¯é‡å…¥åŸç†</h3><p><code>ReentrantLock</code>çš„å†…éƒ¨ç±»<code>Sync</code></p>
<pre><code class="java">// è·å–é”
final boolean nonfairTryAcquire(int acquires) &#123;
    // è·å–å½“å‰çº¿ç¨‹
    final Thread current = Thread.currentThread();
    // è·å–stateçŠ¶æ€å€¼
    int c = getState();
    // å¦‚æœæœªè·å¾—é”
    if (c == 0) &#123;
        // CASæˆåŠŸåè®¾ç½®ç‹¬å çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹å³å¯
        if (compareAndSetState(0, acquires)) &#123;
            setExclusiveOwnerThread(current);
            return true;
        &#125;
    &#125;
    // å¦‚æœå·²ç»è·å¾—é”ï¼Œå½“å‰çº¿ç¨‹æ˜¯ç‹¬å çº¿ç¨‹ï¼Œè¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥
    else if (current == getExclusiveOwnerThread()) &#123;
        // stateåœ¨å½“å‰åŸºç¡€ä¸ŠåŠ acquires
        int nextc = c + acquires;
        if (nextc &lt; 0) // overflow
            throw new Error(&quot;Maximum lock count exceeded&quot;);
        setState(nextc);
        return true;
    &#125;
    // å¦‚æœå·²ç»è·å¾—é”ï¼Œå½“å‰çº¿ç¨‹éç‹¬å çº¿ç¨‹ï¼Œå› ä¸ºæ˜¯ç‹¬å é”ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½é˜»å¡
    return false;
&#125;

// é‡Šæ”¾é”
protected final boolean tryRelease(int releases) &#123;
    int c = getState() - releases;
    // å½“å‰çº¿ç¨‹éç‹¬å çº¿ç¨‹åˆ™æŠ›å‡ºå¼‚å¸¸
    if (Thread.currentThread() != getExclusiveOwnerThread())
        throw new IllegalMonitorStateException();
    boolean free = false;
    // å½“stateå‡ä¸º0æ—¶é”æ‰é‡Šæ”¾æˆåŠŸ
    if (c == 0) &#123;
        free = true;
        setExclusiveOwnerThread(null);
    &#125;
    setState(c);
    return free;
&#125;</code></pre>
<h3 id="7-2-5-å¯æ‰“æ–­åŸç†"><a href="#7-2-5-å¯æ‰“æ–­åŸç†" class="headerlink" title="7.2.5 å¯æ‰“æ–­åŸç†"></a>7.2.5 å¯æ‰“æ–­åŸç†</h3><p>ä¸å¯æ‰“æ–­æ¨¡å¼ï¼š</p>
<pre><code class="java">// çº¿ç¨‹æ— æ³•è·å¾—é”æ—¶ï¼Œè¿›å…¥è¿™ä¸ªæ–¹æ³•
final boolean acquireQueued(final Node node, int arg) &#123;
    boolean failed = true;
    try &#123;
        boolean interrupted = false;
        for (;;) &#123;
            final Node p = node.predecessor();
            if (p == head &amp;&amp; tryAcquire(arg)) &#123;
                setHead(node);
                p.next = null; // help GC
                failed = false;
                // è¿˜æ˜¯éœ€è¦è·å¾—é”åï¼Œæ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€
                return interrupted;
            &#125;
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                // å¦‚æœæ˜¯å› ä¸ºinterruptè¢«å”¤é†’ï¼Œè¿”å›æ‰“æ–­çŠ¶æ€ä¸ºtrue
                interrupted = true;
        &#125;
    &#125; finally &#123;
        if (failed)
            cancelAcquire(node);
    &#125;
&#125;

private final boolean parkAndCheckInterrupt() &#123;
    // å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯trueï¼Œåˆ™parkä¼šå¤±æ•ˆ
    LockSupport.park(this);
    // interruptedä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°
    return Thread.interrupted();
&#125;

// é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­
static void selfInterrupt() &#123;
    Thread.currentThread().interrupt();
&#125;</code></pre>
<p>å¯æ‰“æ–­æ¨¡å¼ï¼š</p>
<pre><code class="java">public final void acquireInterruptibly(int arg)
    throws InterruptedException &#123;
    if (Thread.interrupted())
        throw new InterruptedException();
    // å¦‚æœæ²¡æœ‰è·å¾—åˆ°é”ï¼Œè¿›å…¥
    if (!tryAcquire(arg))
        doAcquireInterruptibly(arg);
&#125;

// å¯æ‰“æ–­é”çš„è·å–æµç¨‹
private void doAcquireInterruptibly(int arg)
    throws InterruptedException &#123;
    final Node node = addWaiter(Node.EXCLUSIVE);
    boolean failed = true;
    try &#123;
        for (;;) &#123;
            final Node p = node.predecessor();
            if (p == head &amp;&amp; tryAcquire(arg)) &#123;
                setHead(node);
                p.next = null; // help GC
                failed = false;
                return;
            &#125;
            if (shouldParkAfterFailedAcquire(p, node) &amp;&amp;
                parkAndCheckInterrupt())
                // åœ¨parkè¿‡ç¨‹ä¸­å¦‚æœè¢«interruptä¼šè¿›å…¥æ­¤
                // è¿™æ—¶å€™æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸ä¼šå†æ¬¡è¿›å…¥forå¾ªç¯
                throw new InterruptedException();
        &#125;
    &#125; finally &#123;
        if (failed)
            cancelAcquire(node);
    &#125;
&#125;</code></pre>
<h3 id="7-2-6-æ¡ä»¶å˜é‡å®ç°åŸç†"><a href="#7-2-6-æ¡ä»¶å˜é‡å®ç°åŸç†" class="headerlink" title="7.2.6 æ¡ä»¶å˜é‡å®ç°åŸç†"></a>7.2.6 æ¡ä»¶å˜é‡å®ç°åŸç†</h3><p>æ¯ä¸ªæ¡ä»¶å˜é‡å…¶å®å°±å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå…¶å®ç°ç±»æ˜¯<code>ConditionObject</code>ã€‚</p>
<p>å†…éƒ¨å±æ€§ï¼š</p>
<pre><code class="java">// æˆå‘˜å˜é‡
private transient Node firstWaiter; // é¦–èŠ‚ç‚¹
private transient Node lastWaiter;  // å°¾èŠ‚ç‚¹
// å¸¸é‡
private static final int REINTERRUPT =  1; // ä»ç­‰å¾…çŠ¶æ€åˆ‡æ¢ä¸ºä¸­æ–­çŠ¶æ€
private static final int THROW_IE    = -1; // æŠ›å‡ºå¼‚å¸¸æ ‡è¯†</code></pre>
<p><strong>awaitæµç¨‹</strong></p>
<pre><code class="java">// å‘é˜Ÿåˆ—ä¸­æ·»åŠ èŠ‚ç‚¹å¹¶è¿”å›
private Node addConditionWaiter()
// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”
final int fullyRelease(Node node)
// åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­
final boolean isOnSyncQueue(Node node)
// æ£€æŸ¥çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼Œå¦‚æœæ˜¯åˆ™ç»ˆæ­¢ConditionçŠ¶æ€å¹¶åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—
private int checkInterruptWhileWaiting(Node node)
// æ“ä½œèŠ‚ç‚¹å»ç”³è¯·é”
final boolean acquireQueued(final Node node, int arg)
// æ¸…ç†ç­‰å¾…é˜Ÿåˆ—ä¸­æ— æ•ˆèŠ‚ç‚¹
private void unlinkCancelledWaiters()
// å¤„ç†çº¿ç¨‹ä¸­æ–­æƒ…å†µ
private void reportInterruptAfterWait(int interruptMode)</code></pre>
<p>å¼€å§‹Thread-0æŒæœ‰é”ï¼Œè°ƒç”¨<code>await</code>ï¼Œè¿›å…¥<code>ConditionObject</code>çš„<code>addConditionWaiter</code>æµç¨‹ã€‚</p>
<p>åˆ›å»ºæ–°çš„<code>Node</code>çŠ¶æ€ä¸º-2ï¼ˆ<code>Node.CONDITION</code>ï¼‰ï¼Œå…³è”Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210504184051341.png" class="" title="image-20210504184051341">

<p>æ¥ä¸‹æ¥è¿›å…¥AQSçš„<code>fullRelease</code>æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210505112113307.png" class="" title="image-20210505112113307">

<p>unpark AQSé˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç«äº‰é”ï¼Œå‡è®¾æ²¡æœ‰å…¶ä»–ç«äº‰çº¿ç¨‹ï¼Œé‚£ä¹ˆThread-1ç«äº‰æˆåŠŸ</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210505112236553.png" class="" title="image-20210505112236553">

<p>parké˜»å¡Thread-0</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210505112338808.png" class="" title="image-20210505112338808">



<p><strong>signalæµç¨‹</strong></p>
<pre><code class="java">// å”¤é†’çº¿ç¨‹å…¥å£
public final void signal()
// åˆ¤å®šå½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰é”
protected boolean isHeldExclusively()
// å”¤é†’firstèŠ‚ç‚¹
private void doSignal(Node first) 
// è½¬æ¢èŠ‚ç‚¹çŠ¶æ€
final boolean transferForSignal(Node node) </code></pre>
<p>å‡è®¾Thread-1è¦æ¥å”¤é†’Thread-0</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210505115153129.png" class="" title="image-20210505115153129">

<p>è¿›å…¥<code>ConditionObject</code>çš„<code>doSignal</code>æµç¨‹ï¼Œå–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª<code>Node</code>ï¼ŒThread-0æ‰€åœ¨<code>Node</code></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210505120611070.png" class="" title="image-20210505120611070">

<p>æ‰§è¡Œ<code>transferForSignal</code>æµç¨‹ï¼Œå°†è¯¥<code>Node</code>åŠ å…¥åˆ°AQSé˜Ÿåˆ—å°¾éƒ¨ï¼Œå°†Thread-0çš„<code>waitStatus</code>æ”¹ä¸º0ï¼ŒThread-3çš„<code>waitStatus</code>æ”¹ä¸º-1</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/61205/image-20210505121200958.png" class="" title="image-20210505121200958">

<p>Thread-1é‡Šæ”¾é”ï¼Œè¿›å…¥<code>unlock</code>æµç¨‹ã€‚</p>
<h2 id="7-3-ReentrantReadWriteLock"><a href="#7-3-ReentrantReadWriteLock" class="headerlink" title="7. 3 ReentrantReadWriteLock"></a>7. 3 ReentrantReadWriteLock</h2><h3 id="7-3-1-æ¦‚è¿°ä¸åº”ç”¨"><a href="#7-3-1-æ¦‚è¿°ä¸åº”ç”¨" class="headerlink" title="7.3.1 æ¦‚è¿°ä¸åº”ç”¨"></a>7.3.1 æ¦‚è¿°ä¸åº”ç”¨</h3><p>å½“è¯»æ“ä½œè¿œè¿œé«˜äºå†™æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ä½¿ç”¨è¯»å†™é”è®©è¯»-è¯»å¯ä»¥å¹¶å‘ï¼Œæé«˜æ€§èƒ½ã€‚</p>
<ul>
<li>è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡</li>
<li>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒï¼šæŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ï¼Œä¼šå¯¼è‡´å†™é”æ°¸ä¹…ç­‰å¾…</li>
<li>é‡å…¥æ—¶é™çº§æ”¯æŒï¼šæŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”</li>
</ul>
<p>ç¤ºä¾‹1ï¼šæ•°æ®å®¹å™¨</p>
<pre><code class="java">import lombok.extern.slf4j.Slf4j;

import java.util.Random;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.ReentrantReadWriteLock;

/**
 * @author KHighness
 * @since 2021-05-05
 */

@Slf4j(topic = &quot;DataContainer&quot;)
class DataContainer &#123;
    private Object data;
    private final static Random RANDOM = new Random();
    private final ReentrantReadWriteLock lock = new ReentrantReadWriteLock();
    private final ReentrantReadWriteLock.ReadLock readLock = lock.readLock();
    private final ReentrantReadWriteLock.WriteLock writeLock = lock.writeLock();

    private static Character randomChar() &#123;
        int choice = RANDOM.nextInt(3);
        if (choice == 0)
            return (char) (RANDOM.nextInt(10) + 48);
        else if (choice == 1)
            return (char) (RANDOM.nextInt(26) + 65);
        else
            return (char) (RANDOM.nextInt(26) + 97);
    &#125;

    public void read() &#123;
        log.debug(&quot;è·å–è¯»é”...&quot;);
        readLock.lock();
        try &#123;
            log.debug(&quot;è¯»å–æ•°æ® =&gt; [&#123;&#125;]&quot;, data);
        &#125; finally &#123;
            log.debug(&quot;é‡Šæ”¾è¯»é”...&quot;);
            readLock.unlock();
        &#125;
    &#125;

    public void write() &#123;
        log.debug(&quot;è·å–å†™é”...&quot;);
        writeLock.lock();
        try &#123;
            log.debug(&quot;å†™å…¥æ•°æ® =&gt; [&#123;&#125;]&quot;, data = randomChar());
        &#125; finally &#123;
            log.debug(&quot;é‡Šæ”¾å†™é”...&quot;);
            writeLock.unlock();
        &#125;
    &#125;
&#125;</code></pre>
<p>ç¤ºä¾‹2ï¼šæ–‡æ¡£ä¸­çš„åº”ç”¨ç¤ºä¾‹</p>
<pre><code class="java">import java.util.Random;
import java.util.concurrent.locks.ReentrantReadWriteLock;

/**
 * @author KHighness
 * @since 2021-05-05
 */
class CachedData &#123;
    Object data;
    // æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœå¤±æ•ˆï¼Œéœ€è¦é‡æ–°è®¡ç®—data
    volatile boolean cacheValid;
    final static Random RANDOM = new Random();
    final ReentrantReadWriteLock lock = new ReentrantReadWriteLock();

    void processCachedData() &#123;
        lock.readLock().lock();
        if (!cacheValid) &#123;
            // ä¸æ”¯æŒé”å‡çº§ï¼Œè·å–å†™é”é’±å¿…é¡»é‡Šæ”¾è¯»é”
            lock.readLock().unlock();
            lock.writeLock().lock();
            try &#123;
                // åŒé‡æ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦å…¶ä»–çº¿ç¨‹å·²ç»è·å–äº†è¯»é”æ›´æ–°ç¼“å­˜ï¼Œé¿å…é‡å¤æ›´æ–°
                if (!cacheValid) &#123;
                    data = write();
                    cacheValid = true;
                &#125;
                // é™ä¸ºè¯»é”ï¼Œé‡Šæ”¾å†™é”ï¼Œè®©å…¶ä»–çº¿ç¨‹è¯»å–ç¼“å­˜
                lock.readLock().lock();
            &#125; finally &#123;
                lock.writeLock().unlock();
            &#125;
        &#125;
        // ä½¿ç”¨æ•°æ®ï¼Œé‡Šæ”¾è¯»é”
        try &#123;
            use(data);
        &#125; finally &#123;
            lock.readLock().unlock();
        &#125;
    &#125;
&#125;</code></pre>
<p>ç¤ºä¾‹3ï¼šRedisçš„Javaç¼“å­˜</p>
<pre><code class="java">import lombok.extern.slf4j.Slf4j;
import redis.clients.jedis.Jedis;

import java.lang.reflect.Field;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;
import java.util.concurrent.locks.ReentrantReadWriteLock;

/**
 * @author KHighness
 * @since 2021-05-05
 */

@Slf4j(topic = &quot;GenericRedisDemo&quot;)
public class GenericRedisDemo &#123;
    public static void main(String[] args) &#123;
        GenericCached cached = new GenericCached();
        cached.update(new User(1, &quot;KHighness&quot;, &quot;parakovo@gmail.com&quot;));
        cached.update(new User(2, &quot;RubbishK&quot;, &quot;rubbish@gmail.com&quot;));
        cached.update(new User(3, &quot;FlowerK&quot;, &quot;flower@gmail.com&quot;));
        log.debug(cached.query(User.class, 1).toString());
        log.debug(cached.query(User.class, 1).toString());
        log.debug(cached.query(User.class, 2).toString());
    &#125;
&#125;

class User &#123;
    private Integer id;
    private String name;
    private String email;
    public User(Integer id, String name, String email) &#123;
        this.id = id;
        this.name = name;
        this.email = email;
    &#125;
&#125;

interface Generic &#123;
    String update(Object obj);
    Map&lt;String, String&gt; query(Class&lt;?&gt; clazz, Integer id);
&#125;

class GenericRedis implements Generic &#123;
    private final Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);

    public String update(Object obj) &#123;
        Class&lt;?&gt; clazz = obj.getClass();
        Field[] declaredFields = clazz.getDeclaredFields();
        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
        Integer id = null;
        try &#123;
            Field idField = clazz.getDeclaredField(&quot;id&quot;);
            idField.setAccessible(true);
            id = (Integer) idField.get(obj);
        &#125; catch (NoSuchFieldException | IllegalAccessException e) &#123;
            e.printStackTrace();
        &#125;
        for (Field field : declaredFields) &#123;
            field.setAccessible(true);
            try &#123;
                map.put(field.getName(), field.get(obj).toString());
            &#125; catch (IllegalAccessException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
        return jedis.hmset(clazz.getSimpleName() + &quot;:&quot; + id, map);
    &#125;

    public Map&lt;String, String&gt; query(Class&lt;?&gt; clazz, Integer id) &#123;
        return jedis.hgetAll(clazz.getSimpleName() + &quot;:&quot; + id);
    &#125;
&#125;

// è£…é¥°å™¨æ¨¡å¼ï¼Œå¼ºåŒ–
@Slf4j(topic = &quot;GenericCached&quot;)
class GenericCached implements Generic &#123;
    private final GenericRedis redis = new GenericRedis();
    private final Map&lt;Key, Map&lt;String, String&gt;&gt; cache = new HashMap&lt;&gt;();
    private final ReentrantReadWriteLock lock = new ReentrantReadWriteLock();

    static class Key &#123;
        Class&lt;?&gt; clazz;
        Integer id;

        public Key(Class&lt;?&gt; clazz, Integer id) &#123;
            this.clazz = clazz;
            this.id = id;
        &#125;

        @Override
        public boolean equals(Object o) &#123;
            if (this == o) return true;
            if (o == null || getClass() != o.getClass()) return false;
            Key key = (Key) o;
            return Objects.equals(clazz, key.clazz) &amp;&amp; Objects.equals(id, key.id);
        &#125;

        @Override
        public int hashCode() &#123;
            return Objects.hash(clazz, id);
        &#125;

        @Override
        public String toString() &#123;
            return &quot;Key[&quot; + &quot;clazz=&quot; + clazz + &quot;, id=&quot; + id + &#39;]&#39;;
        &#125;
    &#125;

    // å…ˆæ›´æ–°rediså†æ¸…é™¤ç¼“å­˜ï¼Œéœ€è¦åŠ å†™é”
    @Override
    public String update(Object obj) &#123;
        String res = null;
        lock.writeLock().lock();
        try &#123;
            // æ›´æ–°redis
            res = redis.update(obj);
            // æ¸…é™¤ç¼“å­˜
            Field idField = obj.getClass().getDeclaredField(&quot;id&quot;);
            idField.setAccessible(true);
            Key key = new Key(obj.getClass(), (int) idField.get(obj));
            if (cache.remove(key) != null) &#123;
                log.debug(&quot;æ¸…é™¤ç¼“å­˜: &#123;&#125;&quot;, key);
            &#125;
        &#125; catch (IllegalAccessException | NoSuchFieldException e) &#123;
            e.printStackTrace();
        &#125; finally &#123;
            lock.writeLock().unlock();
        &#125;
        return res;
    &#125;

    // å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œéœ€è¦åŠ è¯»é”ï¼›
    // æ²¡æœ‰åˆ™æŸ¥è¯¢redisæ·»åŠ åˆ°ç¼“å­˜ï¼Œéœ€è¦åŠ å†™é”
    @Override
    public Map&lt;String, String&gt; query(Class&lt;?&gt; clazz, Integer id) &#123;
        Key key = new Key(clazz, id);
        Map&lt;String, String&gt; res = null;
        lock.readLock().lock();
        // æŸ¥è¯¢ç¼“å­˜
        try &#123;
            if (cache.containsKey(key)) &#123;
                log.debug(&quot;ç¼“å­˜æŸ¥è¯¢: &#123;&#125;&quot;, res = cache.get(key));
                return res;
            &#125;
        &#125; finally &#123;
            lock.readLock().unlock();
        &#125;
        lock.writeLock().lock();
        // æŸ¥è¯¢æ•°æ®åº“ï¼Œæ·»åŠ åˆ°ç¼“å­˜
        try &#123;
            // åŒé‡æ£€æŸ¥
            if (cache.containsKey(key)) &#123;
                log.debug(&quot;ç¼“å­˜æŸ¥è¯¢: &#123;&#125;&quot;, res = cache.get(key));
                return res;
            &#125;
            cache.put(key, res = redis.query(clazz, id));
            log.debug(&quot;æ·»åŠ ç¼“å­˜: &#123;&#125;&quot;, key);
        &#125; finally &#123;
            lock.writeLock().unlock();
        &#125;
        return res;
    &#125;
&#125;</code></pre>
<h3 id="7-3-2-å†…éƒ¨ç±»Syncæ¦‚è¿°"><a href="#7-3-2-å†…éƒ¨ç±»Syncæ¦‚è¿°" class="headerlink" title="7.3.2 å†…éƒ¨ç±»Syncæ¦‚è¿°"></a>7.3.2 å†…éƒ¨ç±»Syncæ¦‚è¿°</h3><p>è¯»å†™é”çš„å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª<code>ReadLock</code>å’Œä¸€ä¸ª<code>WriteLock</code>ï¼Œå®ƒä»¬ä¾èµ–<code>Sync</code>å®ç°å…·ä½“åŠŸèƒ½ï¼Œ<code>Sync</code>ç»§æ‰¿è‡ªAQSï¼Œå¹¶ä¸”ä¹Ÿæä¾›äº†å…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°ã€‚</p>
<p>AQSä¸­åªç»´æŠ¤äº†ä¸€ä¸ª<code>state</code>çŠ¶æ€ï¼Œé‚£ä¹ˆå¦‚ä½•è¡¨ç¤ºè¯»å’Œå†™ä¸¤ç§çŠ¶æ€å‘¢ï¼Ÿ</p>
<p><code>Sync</code>å·§å¦™åœ°ä½¿ç”¨<code>state</code>çš„é«˜16ä½è¡¨ç¤ºè¯»è·å–åˆ°è¯»é”çš„æ¬¡æ•°ï¼Œä½16ä½è¡¨ç¤ºè·å–åˆ°å†™é”çš„çº¿ç¨‹çš„å¯é‡å…¥æ¬¡æ•°ã€‚</p>
<pre><code class="java">static final int SHARED_SHIFT   = 16;
// å…±äº«é”ï¼ˆè¯»é”ï¼‰çŠ¶æ€å•ä½å€¼65536
static final int SHARED_UNIT    = (1 &lt;&lt; SHARED_SHIFT);
// å…±äº«é”çº¿ç¨‹æœ€å¤§ä¸ªæ•°65535
static final int MAX_COUNT      = (1 &lt;&lt; SHARED_SHIFT) - 1;
// æ’å®ƒé”ï¼ˆå†™é”ï¼‰æ©ç 
static final int EXCLUSIVE_MASK = (1 &lt;&lt; SHARED_SHIFT) - 1;

/** è¿”å›è¯»é”çº¿ç¨‹æ•°  */
static int sharedCount(int c)    &#123; return c &gt;&gt;&gt; SHARED_SHIFT; &#125;
/** è¿”å›å†™é”å¯é‡å…¥ä¸ªæ•° */
static int exclusiveCount(int c) &#123; return c &amp; EXCLUSIVE_MASK; &#125;</code></pre>
<p><code>Sync</code>çš„æˆå‘˜ï¼š</p>
<ul>
<li><code>firstReader</code>ï¼šè®°å½•ç¬¬ä¸€ä¸ªè·å–åˆ°è¯»é”çš„çº¿ç¨‹</li>
<li><code>firstReaderHoldCount</code>ï¼šè®°å½•ç¬¬ä¸€ä¸ªè·å–åˆ°è¯»é”çš„çº¿ç¨‹è·å–è¯»é”çš„å¯é‡å…¥æ¬¡æ•°</li>
<li><code>cacheHoldCounter</code>ï¼šè®°å½•æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹è·å–è¯»é”çš„å¯é‡å…¥æ¬¡æ•°</li>
<li><code>readHolds</code>ï¼šå­˜æ”¾é™¤å»ç¬¬ä¸€ä¸ªè·å–é”çº¿ç¨‹å¤–çš„å…¶ä»–çº¿ç¨‹è·å–è¯»é”çš„å¯é‡å…¥æ¬¡æ•°</li>
</ul>
<pre><code class="java">static final class HoldCounter &#123;
    int count = 0;
    // çº¿ç¨‹ID
    final long tid = getThreadId(Thread.currentThread());
&#125;

static final class ThreadLocalHoldCounter extends ThreadLocal&lt;HoldCounter&gt; &#123;
    public HoldCounter initialValue() &#123;
        return new HoldCounter();
    &#125;
&#125;</code></pre>
<h3 id="7-3-3-å†™é”çš„è·å–ä¸é‡Šæ”¾"><a href="#7-3-3-å†™é”çš„è·å–ä¸é‡Šæ”¾" class="headerlink" title="7.3.3 å†™é”çš„è·å–ä¸é‡Šæ”¾"></a>7.3.3 å†™é”çš„è·å–ä¸é‡Šæ”¾</h3><p>åœ¨<code>ReentrantReadWriteLock</code>ä¸­å†™é”ä½¿ç”¨<code>WriteLock</code>å®ç°ã€‚</p>
<p><strong>è·å–</strong></p>
<p>å†™é”æ˜¯ä¸ªç‹¬å é”ï¼ŒæŸæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–è¯¥é”ã€‚</p>
<p>å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹è·å–åˆ°è¯»é”å’Œå†™é”ï¼Œåˆ™å½“å‰çº¿ç¨‹å¯ä»¥è·å–åˆ°å†™é”ç„¶åè¿”å›ã€‚</p>
<p>å¦‚æœå½“å‰å·²ç»æœ‰çº¿ç¨‹è·å–åˆ°è¯»é”å’Œå†™é”ï¼Œåˆ™å½“å‰è¯·æ±‚å†™é”çš„çº¿ç¨‹ä¼šè¢«é˜»å¡æŒ‚èµ·ã€‚</p>
<p>å¦å¤–ï¼Œå†™é”æ˜¯å¯é‡å…¥é”ï¼Œå†æ¬¡è·å–åªæ˜¯ç®€å•åœ°æŠŠå¯é‡å…¥æ¬¡æ•°åŠ 1åç›´æ¥è¿”å›ã€‚</p>
<p>ï¼ˆ1ï¼‰<code>WriteLock</code>çš„<code>lock</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">public void lock() &#123;
    sync.acquire(1);  // ç»§æ‰¿è‡ªAQS
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰<code>AbstractQueuedSynchronizer</code>çš„<code>acquire</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">public final void acquire(int arg) &#123;
    if (!tryAcquire(arg) &amp;&amp; // Syncé‡å†™
        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
&#125;</code></pre>
<p>ï¼ˆ3ï¼‰<code>Sync</code>é‡å†™çš„<code>tryAcquire</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">protected final boolean tryAcquire(int acquires) &#123;
    Thread current = Thread.currentThread();
    int c = getState();
    int w = exclusiveCount(c);
    // (1) c != 0è¯´æ˜è¯»é”æˆ–è€…å†™é”å·²ç»è¢«æŸçº¿ç¨‹è·å–
    if (c != 0) &#123;
        // (2) w = 0è¯´æ˜å·²ç»æœ‰çº¿ç¨‹è·å–äº†è¯»é”ï¼Œw != 0å¹¶ä¸”å½“å‰çº¿ç¨‹ä¸æ˜¯å†™é”æ‹¥æœ‰è€…ï¼Œåˆ™è¿”å›false
        if (w == 0 || current != getExclusiveOwnerThread())
            return false;
        // (3) è¯´æ˜å½“å‰çº¿ç¨‹è·å–äº†å†™é”ï¼Œåˆ¤æ–­å¯é‡å…¥æ¬¡æ•°
        if (w + exclusiveCount(acquires) &gt; MAX_COUNT)
            throw new Error(&quot;Maximum lock count exceeded&quot;);
        // ï¼ˆ4ï¼‰è®¾ç½®å¯é‡å…¥æ¬¡æ•°(+1)
        setState(c + acquires);
        return true;
    &#125;
    // (5) c == 0è¯´æ˜ç¬¬ä¸€ä¸ªå†™çº¿ç¨‹è·å–å†™é”
    if (writerShouldBlock() ||
        !compareAndSetState(c, c + acquires))
        return false;
    setExclusiveOwnerThread(current);
    return true;
&#125;</code></pre>
<p>ï¼ˆ4ï¼‰<code>writerShouldBlock</code>æ–¹æ³•ï¼š</p>
<ul>
<li>å…¬å¹³é”<code>NonfairSync</code>å®ç°ï¼š<code>return false</code>ï¼Œå³æŠ¢å å¼æ‰§è¡ŒCASå°è¯•è·å–å†™é”ï¼Œè·å–æˆåŠŸåˆ™è®¾ç½®å½“å‰é”çš„æŒæœ‰è€…ä¸ºå½“å‰çº¿ç¨‹å¹¶è¿”å›trueã€‚</li>
<li>éå…¬å¹³é”<code>FairSync</code>çš„å®ç°ï¼š<code>return hashQueuedPredecessors()</code>ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹èŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±ç»“ç‚¹ï¼Œæœ‰åˆ™æ”¾å¼ƒè·å–å†™é”çš„æƒé™ï¼Œç›´æ¥è¿”å›falseã€‚</li>
</ul>
<p><strong>é‡Šæ”¾</strong></p>
<p>å¦‚æœå½“å‰çº¿ç¨‹æŒæœ‰è¯¥æ‰€ï¼Œ<code>unlock</code>ä¼šè®©è¯¥çº¿ç¨‹å¯¹è¯¥çº¿ç¨‹æŒæœ‰çš„AQSçŠ¶æ€å€¼å‡1ï¼Œå¦‚æœå‡1åå½“å‰çŠ¶æ€å€¼ä¸º0åˆ™å½“å‰çº¿ç¨‹ä¼šé‡Šæ”¾è¯¥é”ï¼Œå¦åˆ™ä»…ä»…å‡1è€Œå·²ã€‚</p>
<p>å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰æŒæœ‰è¯¥é”è€Œè°ƒç”¨<code>unlock</code>æŠ›å‡º<code>IllegalMonitorStateException</code>å¼‚å¸¸ã€‚</p>
<p>ï¼ˆ1ï¼‰<code>WriteLock</code>çš„<code>unlock</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">public void unlock() &#123;
    sync.release(1);  // ç»§æ‰¿è‡ªAQS
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰<code>AbstractQueuedSynchronizer</code>çš„<code>release</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">public final boolean release(int arg) &#123;
    if (tryRelease(arg)) &#123; // Syncé‡å†™
        Node h = head;
        // æ¿€æ´»é˜»å¡é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹
        if (h != null &amp;&amp; h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    &#125;
    return false;
&#125;</code></pre>
<p>ï¼ˆ3ï¼‰<code>Sync</code>é‡å†™çš„<code>tryRelease</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">protected final boolean tryRelease(int releases) &#123;
    // (1) æ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºé”æ‹¥æœ‰è€…
    if (!isHeldExclusively())
        throw new IllegalMonitorStateException();
    // (2) è·å–å¯é‡å…¥å€¼ï¼Œè¿™é‡Œæ²¡æœ‰è€ƒè™‘é«˜16ä½ï¼Œå› ä¸ºè·å–å†™é”æ—¶è¯»é”çŠ¶æ€å€¼è‚¯å®šä¸º0
    int nextc = getState() - releases;
    boolean free = exclusiveCount(nextc) == 0;
    // (3) å¦‚æœå†™é”å¯é‡å…¥å€¼ä¸º0åˆ™é‡Šæ”¾é”ï¼Œå¦åˆ™åªæ˜¯ç®€å•æ›´æ–°çŠ¶æ€å€¼
    if (free)
        setExclusiveOwnerThread(null);
    setState(nextc);
    return free;
&#125;</code></pre>
<h3 id="7-3-4-è¯»é”çš„è·å–ä¸é‡Šæ”¾"><a href="#7-3-4-è¯»é”çš„è·å–ä¸é‡Šæ”¾" class="headerlink" title="7.3.4 è¯»é”çš„è·å–ä¸é‡Šæ”¾"></a>7.3.4 è¯»é”çš„è·å–ä¸é‡Šæ”¾</h3><p>åœ¨<code>ReentrantReadWriteLock</code>ä¸­è¯»é”ä½¿ç”¨<code>ReadLock</code>å®ç°ã€‚</p>
<p><strong>è·å–</strong></p>
<p>å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œåˆ™å½“å‰çº¿ç¨‹å¯ä»¥è·å–é”ï¼ŒAQSçš„çŠ¶æ€å€¼<code>state</code>çš„é«˜16ä½çš„å€¼ä¼šåŠ 1ï¼Œç„¶åæ–¹æ³•è¿”å›ã€‚</p>
<p>å¦‚æœå…¶ä»–ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šé˜»å¡ã€‚</p>
<p>ï¼ˆ1ï¼‰<code>Read</code>çš„<code>lock</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">public void lock() &#123;
    sync.acquireShared(1); // ç»§æ‰¿è‡ªAQS
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰<code>AbstractQueuedSynchronizer</code>çš„<code>acquireShared</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">public final void acquireShared(int arg) &#123;
    if (tryAcquireShared(arg) &lt; 0) // Syncé‡å†™
        doAcquireShared(arg);
&#125;</code></pre>
<p>ï¼ˆ3ï¼‰<code>Sync</code>é‡å†™çš„<code>tryAcquireShared</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">protected final int tryAcquireShared(int unused) &#123;
    // (1) è·å–å½“å‰çº¿ç¨‹
    Thread current = Thread.currentThread();
    // (2) è·å–å½“å‰çŠ¶æ€å€¼
    int c = getState();
    // (3) åˆ¤æ–­å½“å‰å†™é”æ˜¯å¦è¢«å ç”¨
    if (exclusiveCount(c) != 0 &amp;&amp; getExclusiveOwnerThread() != current)
        return -1;
    // (4) è·å–è¯»é”è®¡æ•°
    int r = sharedCount(c);
    // (5) å°è¯•è·å–é”ï¼Œå¤šä¸ªåº¦çº¿ç¨‹åªæœ‰ä¸€ä¸ªä¼šæˆåŠŸï¼Œå¤±è´¥çš„è¿›å…¥fullTryAcquireSharedè¿›è¡Œé‡è¯•
    if (!readerShouldBlock() &amp;&amp;
        r &lt; MAX_COUNT &amp;&amp;
        compareAndSetState(c, c + SHARED_UNIT)) &#123;
        // (6) å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–é”çš„çº¿ç¨‹
        if (r == 0) &#123;
            firstReader = current;
            firstReaderHoldCount = 1;
        &#125; 
        // (7) å¦‚æœå½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹
        else if (firstReader == current) &#123;
            firstReaderHoldCount++;
        &#125; else &#123;
            // (8) è®°å½•æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹æˆ–è€…è®°å½•å…¶ä»–çº¿ç¨‹è¯»é”çš„å¯é‡å…¥ä¸ªæ•°
            HoldCounter rh = cachedHoldCounter;
            if (rh == null || rh.tid != getThreadId(current))
                cachedHoldCounter = rh = readHolds.get();
            else if (rh.count == 0)
                readHolds.set(rh);
            rh.count++;
        &#125;
        return 1;
    &#125;
    // (9) è‡ªæ—‹è·å–
    return fullTryAcquireShared(current);
&#125;</code></pre>
<p>ï¼ˆ4ï¼‰<code>readerShouldBlock</code>æ–¹æ³•ï¼š</p>
<ul>
<li><p>å…¬å¹³é”<code>NonfairStnc</code>å®ç°ï¼š<code>return apparentlyFirstQueuedIsExclusive()</code>ï¼Œå®ç°å¦‚ä¸‹ï¼š</p>
<pre><code class="java">final boolean apparentlyFirstQueuedIsExclusive() &#123;
    Node h, s;
    return (h = head) != null &amp;&amp;
        (s = h.next)  != null &amp;&amp;
        !s.isShared()         &amp;&amp;
        s.thread != null;
&#125;</code></pre>
<p>ä¸Šè¿°ä»£ç çš„ä½œç”¨æ˜¯ï¼Œå¦‚æœé˜Ÿåˆ—é‡Œé¢å­˜åœ¨ä¸€ä¸ªå…ƒç´ ï¼Œå’‹åˆ¤æ–­ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä¸æ˜¯æ­£åœ¨å°è¯•è·å–å†™é”ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™å½“å‰çº¿ç¨‹åˆ¤æ–­å½“å‰è·å–è¯»é”çš„çº¿ç¨‹æ˜¯å¦åˆ°è¾¾äº†æœ€å¤§å€¼ï¼Œæœ€åæ‰§è¡ŒCASæ“ä½œå°†AQSçŠ¶æ€å€¼çš„é«˜16ä½å€¼åŠ 1ã€‚</p>
</li>
<li><p>éå…¬å¹³é”<code>FairSync</code>çš„å®ç°ï¼š<code>return hashQueuedPredecessors()</code>ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹èŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±ç»“ç‚¹ï¼Œæœ‰åˆ™æ”¾å¼ƒè·å–è¯»é”çš„æƒé™ã€‚</p>
</li>
</ul>
<p>ï¼ˆ5ï¼‰<code>Sync</code>çš„<code>fullTryAcquireShared</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">final int fullTryAcquireShared(Thread current) &#123;
    HoldCounter rh = null;
    for (;;) &#123;
        int c = getState();
        if (exclusiveCount(c) != 0) &#123;
            if (getExclusiveOwnerThread() != current)
                return -1;
            // else we hold the exclusive lock; blocking here
            // would cause deadlock.
        &#125; else if (readerShouldBlock()) &#123;
            // Make sure we&#39;re not acquiring read lock reentrantly
            if (firstReader == current) &#123;
                // assert firstReaderHoldCount &gt; 0;
            &#125; else &#123;
                if (rh == null) &#123;
                    rh = cachedHoldCounter;
                    if (rh == null || rh.tid != getThreadId(current)) &#123;
                        rh = readHolds.get();
                        if (rh.count == 0)
                            readHolds.remove();
                    &#125;
                &#125;
                if (rh.count == 0)
                    return -1;
            &#125;
        &#125;
        if (sharedCount(c) == MAX_COUNT)
            throw new Error(&quot;Maximum lock count exceeded&quot;);
        if (compareAndSetState(c, c + SHARED_UNIT)) &#123;
            if (sharedCount(c) == 0) &#123;
                firstReader = current;
                firstReaderHoldCount = 1;
            &#125; else if (firstReader == current) &#123;
                firstReaderHoldCount++;
            &#125; else &#123;
                if (rh == null)
                    rh = cachedHoldCounter;
                if (rh == null || rh.tid != getThreadId(current))
                    rh = readHolds.get();
                else if (rh.count == 0)
                    readHolds.set(rh);
                rh.count++;
                cachedHoldCounter = rh; // cache for release
            &#125;
            return 1;
        &#125;
    &#125;
&#125;</code></pre>
<p><strong>é‡Šæ”¾</strong></p>
<p>ï¼ˆ1ï¼‰<code>ReadLock</code>çš„<code>unlock</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">public void unlock() &#123;
    sync.releaseShared(1); // ç»§æ‰¿è‡ªAQS
&#125;</code></pre>
<p>ï¼ˆ2ï¼‰<code>AbstractQueuedSynchronizer</code>çš„<code>releaseShared</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">public final boolean releaseShared(int arg) &#123;
    if (tryReleaseShared(arg)) &#123;
        doReleaseShared();
        return true;
    &#125;
    return false;
&#125;</code></pre>
<p>ï¼ˆ3ï¼‰<code>Sync</code>çš„<code>tryReleaseShared</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">protected final boolean tryReleaseShared(int unused) &#123;
    Thread current = Thread.currentThread();
    // (1) åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹
    if (firstReader == current) &#123;
        // å¯ä¿è¯firstReaderHoldCount &gt; 0
        // å¯é‡å…¥æ¬¡æ•°ä¸º1ï¼Œæ¸…ç©ºè¯»é”ç¬¬ä¸€çº¿ç¨‹
        if (firstReaderHoldCount == 1) 
            firstReader = null;
        // å¦åˆ™ï¼Œå¯é‡å…¥æ¬¡æ•°å‡ä¸€
        else
            firstReaderHoldCount--;
    &#125; 
    // (2) é‚£ä¹ˆç»´æŠ¤æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹çš„å¯é‡å…¥æ¬¡æ•°
    else &#123;
        // æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹çš„å¯é‡å…¥æ¬¡æ•°
        HoldCounter rh = cachedHoldCounter;
        // åˆå§‹åŒ–ch
        if (rh == null || rh.tid != getThreadId(current))
            rh = readHolds.get();
        int count = rh.count;
        // å¦‚æœå¯é‡å…¥æ¬¡æ•°å°äºç­‰äº1ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ²¡æœ‰æŒæœ‰è¯»é”ï¼Œchæ˜¯get()æˆçš„
        if (count &lt;= 1) &#123;
            readHolds.remove();
            if (count &lt;= 0)
                throw unmatchedUnlockException();
        &#125;
        // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æŒæœ‰è¯»é”ä¸­ï¼Œå¯é‡å…¥æ¬¡æ•°å‡ä¸€
        --rh.count;
    &#125;
    // (3) ä¿®æ”¹åŒæ­¥çŠ¶æ€ï¼Œå¾ªç¯ç›´åˆ°è‡ªå·±çš„è¯»è®¡æ•°-1ï¼ŒCASæ›´æ–°æˆåŠŸ
    for (;;) &#123;
        int c = getState();
        int nextc = c - SHARED_UNIT;
        if (compareAndSetState(c, nextc))
            // çŠ¶æ€å€¼=0é‡Šæ”¾æˆåŠŸ
            return nextc == 0;
    &#125;
&#125;</code></pre>
<h2 id="7-4-StampedLock"><a href="#7-4-StampedLock" class="headerlink" title="7.4 StampedLock"></a>7.4 StampedLock</h2><p><code>StampedLock</code>æ˜¯JDK1.8æ–°å¢çš„ä¸€ä¸ªé”ï¼Œè¯¥é”æä¾›äº†ä¸‰ç§æ¨¡å¼çš„è¯»å†™æ§åˆ¶ï¼Œä½†æ˜¯ä¸æ”¯æŒæ¡ä»¶å˜é‡å’Œé”é‡å…¥ã€‚</p>
<p>å½“è°ƒç”¨è·å–é”çš„ç³»åˆ—å‡½æ•°æ—¶ï¼Œä¼šè¿”å›ä¸€ä¸ª<code>long</code>å‹çš„å˜é‡ï¼Œç§°ä¸ºæˆ³è®°(stamp)ï¼Œä»£è¡¨äº†é”çš„çŠ¶æ€ã€‚å…¶ä¸­tryç³»åˆ—è·å–é”çš„å‡½æ•°ï¼Œå½“è·å–å¤±è´¥åä¼šè¿”å›ä¸º0çš„stampå€¼ã€‚å½“è°ƒç”¨é‡Šæ”¾é”å’Œè½¬æ¢é”çš„æ–¹æ³•æ—¶éœ€è¦ä¼ å…¥è·å–é”æ—¶è¿”å›çš„stampå€¼ã€‚</p>
<p><code>StampedLock</code>æä¾›äº†ä¸‰ç§è¯»å†™æ¨¡å¼çš„é”ï¼š</p>
<ol>
<li><p>å†™é”<code>writeLock</code>ï¼šæ˜¯ä¸€ä¸ªç‹¬å é”ï¼Œä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–åˆ°è¯¥é”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–è¯¥é”åï¼Œå…¶ä»–è¯·æ±‚è¯»é”å’Œå†™é”çš„çº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œè¿™ç±»ä¼¼äº<code>ReentrantReadWriteLock</code>çš„å†™é”ï¼ˆä¸åŒçš„æ˜¯è¿™é‡Œçš„å†™é”æ˜¯ä¸å¯é‡å…¥é”ï¼‰ï¼›å½“ç›®å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰è¯»é”æˆ–è€…å†™é”æ—¶æ‰å¯ä»¥è·å–åˆ°è¯¥é”ã€‚è¯·æ±‚è¯¥é”æˆåŠŸåä¼šè¿”å›ä¸€ä¸ª<code>stamp</code>å˜é‡ç”¨æ¥è¡¨ç¤ºè¯¥é”çš„ç‰ˆæœ¬ï¼Œå½“è§£é‡Šè¯¥é”æ—¶éœ€è¦è°ƒç”¨<code>unlockWrite</code>æ–¹æ³•å¹¶ä¼ é€’è·å–é”æ—¶çš„<code>stamp</code>å‚æ•°ã€‚å¹¶ä¸”å®ƒæä¾›äº†éé˜»å¡çš„<code>tryWriteLock</code>æ–¹æ³•ã€‚</p>
<pre><code class="java">long stamp = lock.writeLock();
lock.unlockWrite(stamp);</code></pre>
</li>
<li><p>æ‚²è§‚è¯»é”<code>readLock</code>ï¼šæ˜¯ä¸€ä¸ªå…±äº«é”ï¼Œåœ¨æ²¡æœ‰çº¿ç¨‹è·å–ç‹¬å å†™é”çš„æƒ…å†µä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è·å–è¯¥é”ã€‚å¦‚æœå·²ç»æœ‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œåˆ™å…¶ä»–çº¿ç¨‹è¯·æ±‚è·å–è¯¥é”ä¼šè¢«é˜»å¡ï¼Œè¿™ç±»ä¼¼äº<code>ReentrantReadWriteLock</code>çš„è¯»é”ï¼ˆä¸åŒçš„æ˜¯è¿™é‡Œçš„è¯»é”æ˜¯ä¸å¯é‡å…¥é”ï¼‰ã€‚è¿™é‡Œè¯´çš„æ‚²è§‚æ˜¯æŒ‡å…·ä½“æ“ä½œæ•°æ®å‰ä¼šæ‚²è§‚åœ°è®¤ä¸ºå…¶ä»–çº¿ç¨‹å¯ä»¥è¦å¯¹è‡ªå·±æ“ä½œçš„æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥éœ€è¦å…ˆå¯¹æ•°æ®åŠ é”ï¼Œè¿™æ˜¯åœ¨è¯»å°‘å†™å¤šçš„æƒ…å†µä¸‹çš„ä¸€ç§è€ƒè™‘ã€‚è¯·æ±‚è¯¥æ‰€æˆåŠŸåä¼šè¿”å›ä¸€ä¸ª<code>stamp</code>å˜é‡ç”¨æ¥è¡¨ç¤ºè¯¥é”çš„ç‰ˆæœ¬ï¼Œå½“é‡Šæ”¾è¯¥é”æ—¶éœ€è¦è°ƒç”¨<code>unlockRead</code>æ–¹æ³•å¹¶ä¼ é€’<code>stamp</code>å‚æ•°ã€‚å¹¶ä¸”å®ƒæä¾›äº†éé˜»å¡çš„<code>tryReadLock</code>æ–¹æ³•ã€‚</p>
<pre><code class="java">long stamp = lock.readLock();
lock.unlockRead(stamp);</code></pre>
</li>
<li><p>ä¹è§‚è¯»é”<code>tryOptimisticRead</code>ï¼šå®ƒæ˜¯ç›¸å¯¹äºæ‚²è§‚é”æ¥è¯´çš„ï¼Œåœ¨æ“ä½œæ•°æ®å‰å¹¶æ²¡æœ‰é€šè¿‡CASè®¾ç½®é”çš„çŠ¶æ€ï¼Œä»…ä»…é€šè¿‡ä½è¿ç®—æµ‹è¯•ã€‚å¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹æŒæœ‰å†™é”ï¼Œåˆ™ç®€å•åœ°è¿”å›ä¸€ä¸ªé0çš„<code>stamp</code>å€¼ã€‚è·å–è¯¥<code>stamp</code>ååœ¨å…·ä½“æ“ä½œæ•°æ®å‰è¿˜éœ€è¦è°ƒç”¨<code>validate</code>æ–¹æ³•éªŒè¯è¯¥<code>stamp</code>æ˜¯å¦å·²ç»ä¸å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯çœ‹å½“è°ƒç”¨<code>tryOptimisticRead</code>è¿”å›<code>stamp</code>ååˆ°å½“å‰æ—¶é—´æœŸé—´æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰äº†å†™é”ï¼Œå¦‚æœæ˜¯åˆ™<code>validate</code>ä¼šè¿”å›0ï¼Œå¦åˆ™å°±å¯ä»¥ä½¿ç”¨è¯¥<code>stamp</code>ç‰ˆæœ¬çš„é”å¯¹æ•°æ®è¿›è¡Œæ“ä½œã€‚ç”±äº<code>tryOptimisticRead</code>å¹¶æ²¡æœ‰ä½¿ç”¨CASè®¾ç½®é”çŠ¶æ€ï¼Œæ‰€ä»¥ä¸éœ€è¦æ˜¾å¼åœ°é‡Šæ”¾è¯¥é”ã€‚è¯¥é”çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå› ä¸ºè·å–è¯»é”åªæ˜¯ä½¿ç”¨ä½æ“ä½œè¿›è¡Œæ£€éªŒï¼Œä¸æ¶‰åŠCASæ“ä½œï¼Œæ‰€ä»¥æ•ˆç‡ä¸Šä¼šé«˜å¾ˆå¤šï¼Œä½†æ˜¯åŒæ—¶ç”±äºæ²¡æœ‰ä½¿ç”¨çœŸæ­£çš„é”ï¼Œåœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§ä¸Šéœ€è¦å¤åˆ¶ä¸€ä»½è¦æ“ä½œçš„å˜é‡åˆ°æ–¹æ³•æ ˆï¼Œå¹¶ä¸”åœ¨æ“ä½œæ•°æ®æ—¶å¯èƒ½å…¶ä»–å†™çº¿ç¨‹å·²ç»ä¿®æ”¹äº†æ•°æ®ï¼Œè€Œæˆ‘ä»¬æ“ä½œçš„æ˜¯æ–¹æ³•æ ˆé‡Œé¢çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå¿«ç…§ï¼Œæ‰€ä»¥æœ€å¤šè¿”å›çš„ä¸æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œä½†æ˜¯ä¸€è‡´æ€§è¿˜æ˜¯å¾—åˆ°ä¿éšœçš„ã€‚</p>
<pre><code class="java">long stamp = lock.tryOptimisticRead();
if (!lock.validate(stamp)) &#123;
    // é”å‡çº§
&#125;</code></pre>
</li>
</ol>
<p>ç¤ºä¾‹ï¼šç¬›å¡å°”äºŒç»´ç‚¹</p>
<pre><code class="java">import java.util.concurrent.locks.StampedLock;

/**
 * @author KHighness
 * @since 2021-05-05
 */

public class Point &#123;
    /**
     * æ¨ªåæ ‡
     */
    private double x;
    /**
     * çºµåæ ‡
     */
    private double y;
    /**
     * é”å®ä¾‹
     */
    private final StampedLock lock = new StampedLock();

    /**
     * ç§»åŠ¨ç‚¹åˆ°æ–°ä½ç½®
     * &lt;p&gt;ä½¿ç”¨æ’å®ƒé”-å†™é”&lt;/p&gt;
     * @param deltaX æ¨ªåæ ‡å˜åŒ–å€¼
     * @param deltaY çºµåæ ‡å˜åŒ–å€¼
     */
    void move(double deltaX, int deltaY) &#123;
        long stamp = lock.writeLock();
        try &#123;
            x += deltaX;
            y += deltaY;
        &#125; finally &#123;
            lock.unlockWrite(stamp);
        &#125;
    &#125;

    /**
     * è®¡ç®—å½“å‰ä½ç½®åˆ°åŸç‚¹çš„è·ç¦»
     * &lt;p&gt;ä½¿ç”¨ä¹è§‚é”è¯»&lt;/p&gt;
     * @return è·ç¦»åŸç‚¹çš„è·ç¦»
     */
    double distanceFromOrigin() &#123;
        long stamp = lock.tryOptimisticRead();
        double currentX = x, currentY = y;
        // æ£€æŸ¥è·å–stampåï¼Œé”æ˜¯å¦è¢«å…¶ä»–å†™çº¿ç¨‹æ’ä»–æ€§æŠ¢å 
        if (!lock.validate(stamp)) &#123;
            // å¦‚æœè¢«æŠ¢å åˆ™è¿›è¡Œé”å‡çº§ï¼Œè·å–æ‚²è§‚è¯»é”
            stamp = lock.readLock();
            try &#123;
                currentX = x;
                currentY = y;
            &#125; finally &#123;
                lock.unlockRead(stamp);
            &#125;
        &#125;
        return Math.sqrt(currentX * currentX + currentY * currentY);
    &#125;

    /**
     * å¦‚æœå½“å‰ä½ç½®åœ¨åŸç‚¹åˆ™ç§»åŠ¨è‡³æ–°ä½ç½®
     * &lt;p&gt;ä½¿ç”¨æ‚²è§‚é”è·å–è¯»é”ï¼Œå¹¶å°è¯•è½¬æ¢ä¸ºå†™é”&lt;/p&gt;
     * @param newX æ–°ä½ç½®çš„æ¨ªåæ ‡
     * @param newY æ–°ä½ç½®çš„çºµåæ ‡
     */
    void moveIfAtOrigin(double newX, double newY) &#123;
        // è¿™é‡Œå¯ä»¥ç”¨ä¹è§‚é”è¯»æ›¿æ¢
        long stamp = lock.readLock();
        try &#123;
            while (x == 0.0 &amp;&amp; y == 0.0) &#123;
                // å°è¯•å°†è¯»é”å‡çº§ä¸ºå†™é”
                long ws = lock.tryConvertToWriteLock(stamp);
                // å‡çº§æˆåŠŸï¼Œåˆ™æ›´æ¢æˆ³è®°ï¼Œæ›´æ–°åæ ‡ï¼Œé€€å‡ºå¾ªç¯
                if (ws != 0L) &#123;
                    stamp = ws;
                    x = newX;
                    y = newY;
                    break;
                &#125; 
                // å‡çº§å¤±è´¥ï¼Œåˆ™é‡Šæ”¾è¯»é”ï¼Œæ˜¾å¼è·å–å†™é”ï¼Œå¾ªç¯é‡è¯•
                else &#123;
                    lock.unlockRead(stamp);
                    stamp = lock.writeLock();
                &#125;
            &#125;
        &#125; finally &#123;
            // é‡Šæ”¾é”
            lock.unlockWrite(stamp);
        &#125;
    &#125;
&#125;</code></pre>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-6(å¹¶å‘å·¥å…·ä¹‹çº¿ç¨‹æ± )</title>
    <url>/posts/62082/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="6-1-è‡ªå®šä¹‰çº¿ç¨‹æ± "><a href="#6-1-è‡ªå®šä¹‰çº¿ç¨‹æ± " class="headerlink" title="6.1 è‡ªå®šä¹‰çº¿ç¨‹æ± "></a>6.1 è‡ªå®šä¹‰çº¿ç¨‹æ± </h2><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62082/image-20210430145117537.png" class="" title="image-20210430145117537.png">

<pre><code class="java">import lombok.extern.slf4j.Slf4j;

import java.util.ArrayDeque;
import java.util.Deque;
import java.util.HashSet;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.ReentrantLock;

/**
 * @author KHighness
 * @since 2021-04-30
 */

@Slf4j(topic = &quot;ParaKThreadPoolDemo&quot;)
public class ParaKThreadPoolDemo &#123;
    public static void main(String[] args) &#123;
        ParaKThreadPool threadPool = new ParaKThreadPool(
                1, 1000, TimeUnit.MILLISECONDS, 1,
                // (1) ä¸€ç›´ç­‰å¾…
                // BlockingQueue::put
//                (2) è¶…æ—¶ç­‰å¾…
                (queue, task) -&gt; &#123;
                    queue.offer(task, 1500, TimeUnit.MILLISECONDS);
                &#125;
                // (3) æ”¾å¼ƒæ‰§è¡Œ
//                (queue, task) -&gt; &#123;
//                    log.debug(&quot;æ”¾å¼ƒæ‰§è¡Œ: &#123;&#125;&quot;, task);
//                &#125;
                // (4) æŠ›å‡ºå¼‚å¸¸
//                (queue, task) -&gt; &#123;
//                    throw new RuntimeException(&quot;ä»»åŠ¡æ‰§è¡Œå¤±è´¥: &quot; + task);
//                &#125;
                // (5) è‡ªå·±æ‰§è¡Œ
//                (queue, task) -&gt; &#123;
//                    task.run();
//                &#125;
        );
        for (int i = 0; i &lt; 3; i++) &#123;
            int k = i;
            threadPool.execute(() -&gt; &#123;
                try &#123;
                    TimeUnit.SECONDS.sleep(1);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                log.debug(&quot;&#123;&#125;&quot;, k);
            &#125;);
        &#125;
    &#125;
&#125;

@Slf4j(topic = &quot;ParaKThreadPool&quot;)
class ParaKThreadPool &#123;
    // ä»»åŠ¡é˜Ÿåˆ—
    private BlockingQueue&lt;Runnable&gt; taskQueue;

    // çº¿ç¨‹é›†åˆ
    private final HashSet&lt;Worker&gt; workers = new HashSet&lt;&gt;();

    // æ ¸å¿ƒçº¿ç¨‹æ•°
    private final int coreSize;

    // è·å–ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´
    private final long timeout;

    // æ—¶é—´å•ä½
    private final TimeUnit timeUnit;

    // æ‹’ç»ç­–ç•¥
    private RejectPolicy&lt;Runnable&gt; rejectPolicy;

    // æ„é€ å‡½æ•°
    public ParaKThreadPool(int coreSize, long timeout, TimeUnit timeUnit, int queueCapacity, RejectPolicy&lt;Runnable&gt; rejectPolicy) &#123;
        this.coreSize = coreSize;
        this.timeout = timeout;
        this.timeUnit = timeUnit;
        this.taskQueue = new BlockingQueue&lt;&gt;(queueCapacity);
        this.rejectPolicy = rejectPolicy;
    &#125;

    // æ‰§è¡Œä»»åŠ¡
    public void execute(Runnable task) &#123;
        // å½“ä»»åŠ¡æ•°æ²¡æœ‰è¶…è¿‡coreSizeæ—¶ï¼Œç›´æ¥äº¤ç»™workerå¯¹è±¡æ‰§è¡Œ
        // å¦‚æœä»»åŠ¡æ•°è¶…è¿‡coreSizeæ—¶ï¼ŒåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—æš‚å­˜
        synchronized (workers) &#123;
            if (workers.size() &lt; coreSize) &#123;
                Worker worker = new Worker(task);
                log.debug(&quot;æ‰§è¡Œçº¿ç¨‹æ–°å¢: &#123;&#125;&quot;, worker);
                workers.add(worker);
                worker.start();
            &#125; else &#123;
                // (1) ä¸€ç›´ç­‰å¾…
                // (2) è¶…æ—¶ç­‰å¾…
                // (3) æ”¾å¼ƒæ‰§è¡Œ
                // (4) æŠ›å‡ºå¼‚å¸¸
                // (5) è®©è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡
                taskQueue.tryPut(rejectPolicy, task);
            &#125;
        &#125;
    &#125;

    class Worker extends Thread &#123;
        private Runnable task;

        public Worker(Runnable task) &#123;
            this.task = task;
        &#125;

        @Override
        public void run() &#123;
            // æ‰§è¡Œä»»åŠ¡
            // (1) å½“taskä¸ä¸ºç©ºï¼Œæ‰§è¡Œä»»åŠ¡
            // (2) å½“taskæ‰§è¡Œå®Œæ¯•ï¼Œå†æ¥ç€ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡å¹¶æ‰§è¡Œ
//            while (task != null || (task = taskQueue.take()) != null) &#123;
            while (task != null || (task = taskQueue.poll(timeout, timeUnit)) != null) &#123;
                try &#123;
                    log.debug(&quot;æ­£åœ¨æ‰§è¡Œ =&gt; &#123;&#125;&quot;, task);
                    task.run();
                &#125; catch (Exception e) &#123;
                    e.printStackTrace();
                &#125; finally &#123;
                    task = null;
                &#125;
            &#125;
            synchronized (workers) &#123;
                log.debug(&quot;æ‰§è¡Œçº¿ç¨‹ç§»é™¤: &#123;&#125;&quot;, this);
                workers.remove(this);
            &#125;
        &#125;
    &#125;

    public static void main(String[] args) &#123;
    &#125;
&#125;

@Slf4j(topic = &quot;BlockingQueue&quot;)
class BlockingQueue&lt;T&gt; &#123;

    // ä»»åŠ¡é˜Ÿåˆ—
    private final Deque&lt;T&gt; queue = new ArrayDeque&lt;&gt;();

    // é”
    private final ReentrantLock lock = new ReentrantLock();

    // æœ€å¤§å®¹é‡
    private final int capacity;

    // ç”Ÿäº§è€…æ¡ä»¶å˜é‡
    private final Condition fullWaitSet = lock.newCondition();

    // æ¶ˆè´¹è€…æ¡ä»¶å˜é‡
    private final Condition emptyWaitSet = lock.newCondition();

    public BlockingQueue(int capacity) &#123;
        this.capacity = capacity;
    &#125;

    // å¸¦è¶…æ—¶çš„é˜»å¡è·å–
    public T poll(long timeout, TimeUnit unit) &#123;
        lock.lock();
        try &#123;
            // å°†è¶…æ—¶æ—¶é—´ç»Ÿä¸€è½¬æ¢ä¸ºçº³ç§’
            long nanos = unit.toNanos(timeout);
            while (queue.isEmpty()) &#123;
                try &#123;
                    // è¿”å›å‰©ä½™æ—¶é—´
                    if (nanos &lt;= 0) &#123;
                        return null;
                    &#125;
                    nanos = emptyWaitSet.awaitNanos(nanos);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
            T t = queue.removeFirst();
            fullWaitSet.signal();
            return t;
        &#125; finally &#123;
            lock.unlock();
        &#125;
    &#125;

    // é˜»å¡è·å–
    public T take() &#123;
        lock.lock();
        try &#123;
            // é˜Ÿåˆ—ä¸ºç©ºï¼Œé˜»å¡
            while (queue.isEmpty()) &#123;
                try &#123;
                    emptyWaitSet.await();
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
            T t = queue.removeFirst();
            fullWaitSet.signal();
            return t;
        &#125; finally &#123;
            lock.unlock();
        &#125;
    &#125;

    // é˜»å¡æ·»åŠ 
    public void put(T element) &#123;
        lock.lock();
        try &#123;
            // é˜Ÿåˆ—å·²æ»¡ï¼Œé˜»å¡
            while (queue.size() == capacity) &#123;
                log.debug(&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—: &#123;&#125;...&quot;, element);
                fullWaitSet.await();
            &#125;
            log.debug(&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—: &#123;&#125;&quot;, element);
            queue.addLast(element);
            emptyWaitSet.signal();
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125; finally &#123;
            lock.unlock();
        &#125;
    &#125;

    // å¸¦è¶…æ—¶æ—¶é—´æ·»åŠ 
    public boolean offer(T element, long timeout, TimeUnit timeUnit) &#123;
        lock.lock();
        try &#123;
            long nanos = timeUnit.toNanos(timeout);
            // é˜Ÿåˆ—å·²æ»¡ï¼Œé˜»å¡
            while (queue.size() == capacity) &#123;
                if (nanos &lt;= 0) &#123;
                    return false;
                &#125;
                log.debug(&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—: &#123;&#125;...&quot;, element);
                try &#123;
                    nanos = fullWaitSet.awaitNanos(nanos);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
            log.debug(&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—: &#123;&#125;&quot;, element);
            queue.addLast(element);
            emptyWaitSet.signal();
            return true;
        &#125;finally &#123;
            lock.unlock();
        &#125;
    &#125;

    // è·å–å¤§å°
    public int size() &#123;
        lock.lock();
        try &#123;
            return queue.size();
        &#125; finally &#123;
            lock.unlock();
        &#125;
    &#125;

    public void tryPut(RejectPolicy&lt;T&gt; rejectPolicy, T task) &#123;
        lock.lock();
        try &#123;
            // åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡
            if (queue.size() == capacity) &#123;
                rejectPolicy.reject(this, task);
            &#125; else &#123; // æœ‰ç©ºé—²
                log.debug(&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ— &#123;&#125;&quot;, task);
                queue.addLast(task);
                emptyWaitSet.signal();
            &#125;
        &#125; finally &#123;
            lock.unlock();
        &#125;
    &#125;
&#125;

@FunctionalInterface
interface RejectPolicy&lt;T&gt; &#123;
    void reject(BlockingQueue&lt;T&gt; queue, T task);
&#125;</code></pre>
<h2 id="6-2-ThreadPoolExecutor"><a href="#6-2-ThreadPoolExecutor" class="headerlink" title="6.2 ThreadPoolExecutor"></a>6.2 ThreadPoolExecutor</h2><h3 id="6-2-1-çº¿ç¨‹æ± çš„ç»§æ‰¿å…³ç³»"><a href="#6-2-1-çº¿ç¨‹æ± çš„ç»§æ‰¿å…³ç³»" class="headerlink" title="6.2.1 çº¿ç¨‹æ± çš„ç»§æ‰¿å…³ç³»"></a>6.2.1 çº¿ç¨‹æ± çš„ç»§æ‰¿å…³ç³»</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62082/image-20210430184352672.png" class="" title="image-20210430184352672">



<h3 id="6-2-2-Executoræ¡†æ¶ç»“æ„"><a href="#6-2-2-Executoræ¡†æ¶ç»“æ„" class="headerlink" title="6.2.2 Executoræ¡†æ¶ç»“æ„"></a>6.2.2 Executoræ¡†æ¶ç»“æ„</h3><p>ä¸‰å¤§éƒ¨åˆ†ï¼š</p>
<ul>
<li>ä»»åŠ¡ç±»ï¼ˆRunnable / Callableï¼‰ï¼šæ‰§è¡Œä»»åŠ¡éœ€è¦å®ç°çš„<code>Runnable</code>æˆ–è€…<code>Callable</code>æ¥å£ã€‚</li>
<li>ä»»ä½•çš„æ‰§è¡Œï¼ˆExecutorï¼‰ï¼šä»»åŠ¡æ‰§è¡Œæœºåˆ¶çš„æ ¸å¿ƒæ¥å£<code>Executor</code>ï¼Œä»¥åŠç»§æ‰¿è‡ª<code>Executor</code>æ¥å£çš„<code>ExecutorService</code>æ¥å£ã€‚</li>
<li>å¼‚æ­¥è®¡ç®—ç»“æœï¼ˆFutureï¼‰ï¼š<code>Future</code>æ¥å£ä»¥åŠ<code>FutureTask</code>ç±»éƒ½å¯ä»¥ä»£è¡¨å¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚</li>
</ul>
<p>ä½¿ç”¨ç¤ºæ„ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62082/image-20210430184722889.png" class="" title="image-20210430184722889.png">



<h3 id="6-2-3-çº¿ç¨‹æ± çŠ¶æ€"><a href="#6-2-3-çº¿ç¨‹æ± çŠ¶æ€" class="headerlink" title="6.2.3 çº¿ç¨‹æ± çŠ¶æ€"></a>6.2.3 çº¿ç¨‹æ± çŠ¶æ€</h3><p><code>ThreadPoolExecutor</code>ä½¿ç”¨intçš„é«˜3ä½æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½29ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡ã€‚</p>
<table>
<thead>
<tr>
<th>çŠ¶æ€å</th>
<th>é«˜3ä½</th>
<th>æ¥æ”¶æ–°ä»»åŠ¡</th>
<th>å¤„ç†é˜»å¡é˜Ÿåˆ—ä»»åŠ¡</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>RUNNING</td>
<td>111</td>
<td>Y</td>
<td>Y</td>
<td>æ¥æ”¶æ–°ä»»åŠ¡ï¼ŒåŒæ—¶å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</td>
</tr>
<tr>
<td>SHUTDOWN</td>
<td>000</td>
<td>N</td>
<td>Y</td>
<td>ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†ä¼šå¤„ç†é˜»å¡é˜Ÿåˆ—å‰©ä½™ä»»åŠ¡</td>
</tr>
<tr>
<td>STOP</td>
<td>001</td>
<td>N</td>
<td>N</td>
<td>ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å¼ƒé˜»å¡é˜Ÿåˆ—ä»»åŠ¡</td>
</tr>
<tr>
<td>TIDYING</td>
<td>010</td>
<td>-</td>
<td>-</td>
<td>ä»»åŠ¡å…¨æ‰§è¡Œå®Œæ¯•ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸º0å³å°†è¿›å…¥ç»ˆç»“</td>
</tr>
<tr>
<td>TERMINATED</td>
<td>011</td>
<td>-</td>
<td>-</td>
<td>ç»ˆç»“çŠ¶æ€</td>
</tr>
</tbody></table>
<p>ä»æ•°å­—ä¸Šæ¯”è¾ƒï¼ˆç¬¬ä¸€ä½æ˜¯ç¬¦å·ä½ï¼‰ï¼ŒTERMINATED &gt; TIDYING &gt; STOP &gt; SHUTDOWN &gt; RUNNINGã€‚</p>
<p>è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåŸå­å˜é‡ctlä¸­ï¼Œç›®çš„æ˜¯å°†çº¿ç¨‹æ± çŠ¶æ€ä¸çº¿ç¨‹ä¸ªæ•°åˆäºŒä¸ºä¸€ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸€æ¬¡CASåŸå­æ“ä½œè¿›è¡Œèµ‹å€¼ã€‚</p>
<pre><code class="java">// cä¸ºæ—§å€¼ï¼ŒctlOfè¿”å›ç»“æœä¸ºæ–°å€¼
ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c)));

// rsä¸ºé«˜ä¸‰ä½ä»£è¡¨çº¿ç¨‹æ± çŠ¶æ€ï¼Œwcä¸ºä½29ä½ä»£è¡¨çº¿ç¨‹ä¸ªæ•°ï¼Œctlæ˜¯åˆå¹¶å®ƒä»¬
private static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125;</code></pre>
<h3 id="6-2-4-çº¿ç¨‹æ± å±æ€§"><a href="#6-2-4-çº¿ç¨‹æ± å±æ€§" class="headerlink" title="6.2.4 çº¿ç¨‹æ± å±æ€§"></a>6.2.4 çº¿ç¨‹æ± å±æ€§</h3><pre><code class="java">/** å·¥ä½œçº¿ç¨‹ */
private final class Worker extends AbstractQueuedSynchronizer implements Runnable
&#123;
    /** æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ */
    final Thread thread;
    /** åˆå§‹åŒ–ä»»åŠ¡ */
    Runnable firstTask;
    /** å·²å®Œæˆçš„ä»»åŠ¡æ•°é‡ */
    volatile long completedTasks;
&#125;
/** é˜»å¡é˜Ÿåˆ— */
private final BlockingQueue&lt;Runnable&gt; workQueue;
/** é” */
private final ReentrantLock mainLock = new ReentrantLock();
/** çº¿ç¨‹å®¹å™¨ */
private final HashSet&lt;Worker&gt; workers = new HashSet&lt;Worker&gt;();</code></pre>
<h3 id="6-2-5-æ„é€ å‡½æ•°å’Œå‚æ•°"><a href="#6-2-5-æ„é€ å‡½æ•°å’Œå‚æ•°" class="headerlink" title="6.2.5 æ„é€ å‡½æ•°å’Œå‚æ•°"></a>6.2.5 æ„é€ å‡½æ•°å’Œå‚æ•°</h3><p>æœ€å…¨æ„é€ å‡½æ•°ï¼š</p>
<pre><code class="java">public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue&lt;Runnable&gt; workQueue,
                          ThreadFactory threadFactory,
                          RejectedExecutionHandler handler)</code></pre>
<p>å‚æ•°è§£é‡Šï¼š</p>
<ul>
<li><code>corePoolSize</code>ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°é‡</li>
<li><code>maximumPoolSize</code>ï¼šæœ€å¤§çº¿ç¨‹æ•°é‡<ul>
<li><code>maximumPool - corePoolSize</code>ï¼šæ•‘æ€¥çº¿ç¨‹æ•°é‡</li>
<li>åœ¨æ²¡æœ‰ç©ºé—²çš„æ ¸å¿ƒçº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—æ»¡äº†çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨æ•‘æ€¥çº¿ç¨‹</li>
</ul>
</li>
<li><code>keepAliveTime</code>ï¼šæœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼ˆå¯¹äºæ•‘æ€¥çº¿ç¨‹ï¼‰</li>
<li><code>unit</code>ï¼šæ—¶é—´å•ä½</li>
<li><code>workQueue</code>ï¼šé˜»å¡é˜Ÿåˆ—ï¼ˆå­˜æ”¾ä»»åŠ¡ï¼‰<ul>
<li>æœ‰ç•Œé˜»å¡é˜Ÿåˆ—<code>ArrayBlockingQueue</code></li>
<li>æ— ç•Œé˜»å¡é˜Ÿåˆ—<code>LinkedBlockingQueue</code></li>
<li>æœ€å¤šåªæœ‰ä¸€ä¸ªåŒæ­¥å…ƒç´ çš„<code>SynchronousQueue</code></li>
<li>ä¼˜å…ˆé˜Ÿåˆ—<code>PriorityBlockingQueue</code></li>
</ul>
</li>
<li><code>threadFactory</code>ï¼šçº¿ç¨‹å·¥å‚</li>
<li><code>handler</code>ï¼šæ‹’ç»ç­–ç•¥</li>
</ul>
<p>å·¥ä½œæµç¨‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62082/image-20210430203563881.png" class="" title="image-20210430203563881.png">





<h3 id="6-2-6-æ‹’ç»ç­–ç•¥å’Œåœºæ™¯"><a href="#6-2-6-æ‹’ç»ç­–ç•¥å’Œåœºæ™¯" class="headerlink" title="6.2.6 æ‹’ç»ç­–ç•¥å’Œåœºæ™¯"></a>6.2.6 æ‹’ç»ç­–ç•¥å’Œåœºæ™¯</h3><p>å¦‚æœçº¿ç¨‹æ•°é‡è¾¾åˆ°<code>maximumPoolSize</code>ä»ç„¶æœ‰æ–°äººç‰©æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼ŒJDKæä¾›äº†å››ç§å®ç°ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62082/image-20210430215158450.png" class="" title="image-20210430215158450">

<p>å…·ä½“ï¼š</p>
<p>ï¼ˆ1ï¼‰<code>AbortPolicy</code>ç»ˆæ­¢ç­–ç•¥ï¼šä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡º<code>RejectedExecutionException</code>å¼‚å¸¸ï¼Œè¿™æ˜¯é»˜è®¤ç­–ç•¥ã€‚</p>
<ul>
<li>è¯¦è¿°ï¼šè¿™æ˜¯çº¿ç¨‹æ± é»˜è®¤çš„æ‹’ç»ç­–ç•¥ï¼Œåœ¨ä»»åŠ¡ä¸èƒ½å†æäº¤çš„æ—¶å€™ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼ŒåŠæ—¶åé¦ˆç¨‹åºè¿è¡ŒçŠ¶æ€ã€‚å¦‚æœæ˜¯æ¯”è¾ƒå…³é”®çš„ä¸šåŠ¡ï¼Œæ¨èä½¿ç”¨æ­¤æ‹’ç»ç­–ç•¥ï¼Œè¿™æ ·å­åœ¨ç³»ç»Ÿä¸èƒ½æ‰¿è½½æ›´å¤§çš„å¹¶å‘é‡çš„æ—¶å€™ï¼Œèƒ½å¤ŸåŠæ—¶çš„é€šè¿‡å¼‚å¸¸å‘ç°ã€‚</li>
<li>åŠŸèƒ½ï¼šå½“è§¦å‘æ‹’ç»ç­–ç•¥æ—¶ï¼Œç›´æ¥æŠ›å‡ºæ‹’ç»æ‰§è¡Œçš„å¼‚å¸¸ï¼Œä¸­æ­¢ç­–ç•¥çš„æ„æ€ä¹Ÿå°±æ˜¯æ‰“æ–­å½“å‰æ‰§è¡Œæµç¨‹ã€‚</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šè¿™ä¸ªå°±æ²¡æœ‰ç‰¹æ®Šçš„åœºæ™¯äº†ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹è¦æ­£ç¡®å¤„ç†æŠ›å‡ºçš„å¼‚å¸¸ã€‚ThreadPoolExecutorä¸­é»˜è®¤çš„ç­–ç•¥å°±æ˜¯AbortPolicyï¼ŒExecutorServiceæ¥å£çš„ç³»åˆ—ThreadPoolExecutorå› ä¸ºéƒ½æ²¡æœ‰æ˜¾ç¤ºçš„è®¾ç½®æ‹’ç»ç­–ç•¥ï¼Œæ‰€ä»¥é»˜è®¤çš„éƒ½æ˜¯è¿™ä¸ªã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼ŒExecutorServiceä¸­çš„çº¿ç¨‹æ± å®ä¾‹é˜Ÿåˆ—éƒ½æ˜¯æ— ç•Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æŠŠå†…å­˜æ’‘çˆ†äº†éƒ½ä¸ä¼šè§¦å‘æ‹’ç»ç­–ç•¥ã€‚å½“è‡ªå·±è‡ªå®šä¹‰çº¿ç¨‹æ± å®ä¾‹æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªç­–ç•¥ä¸€å®šè¦å¤„ç†å¥½è§¦å‘ç­–ç•¥æ—¶æŠ›çš„å¼‚å¸¸ï¼Œå› ä¸ºä»–ä¼šæ‰“æ–­å½“å‰çš„æ‰§è¡Œæµç¨‹ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰<code>DiscardPolicy</code>ä¸¢å¼ƒç­–ç•¥ï¼šä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœçº¿ç¨‹é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™åç»­æäº¤çš„ä»»åŠ¡éƒ½ä¼šè¢«ä¸¢å¼ƒï¼Œä¸”é™é»˜ä¸¢å¼ƒã€‚</p>
<ul>
<li>è¯¦è¿°ï¼šä½¿ç”¨æ­¤ç­–ç•¥ï¼Œå¯èƒ½ä½¿æˆ‘ä»¬æ— æ³•å‘ç°ç³»ç»Ÿçš„å¼‚å¸¸çŠ¶æ€ã€‚å»ºè®®æ˜¯ä¸€äº›æ— å…³ç´§è¦çš„ä¸šåŠ¡é‡‡ç”¨æ­¤ç­–ç•¥ã€‚</li>
<li>åŠŸèƒ½ï¼šç›´æ¥é™é™åœ°ä¸¢å¼ƒè¿™ä¸ªä»»åŠ¡ï¼Œä¸è§¦å‘ä»»ä½•åŠ¨ä½œã€‚</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä½ æäº¤çš„ä»»åŠ¡æ— å…³ç´§è¦ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨å®ƒ ã€‚å› ä¸ºå®ƒå°±æ˜¯ä¸ªç©ºå®ç°ï¼Œä¼šæ‚„æ— å£°æ¯çš„åå™¬ä½ çš„çš„ä»»åŠ¡ã€‚æ‰€ä»¥è¿™ä¸ªç­–ç•¥åŸºæœ¬ä¸Šä¸ç”¨äº†ã€‚</li>
</ul>
<p>ï¼ˆ3ï¼‰<code>DiscardOldestPolicy</code>å¼ƒè€ç­–ç•¥ï¼šä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°æäº¤è¢«æ‹’ç»çš„ä»»åŠ¡ã€‚</p>
<ul>
<li>è¯¦è¿°ï¼šå–œæ–°åŒæ—§çš„æ‹’ç»ç­–ç•¥ã€‚æ˜¯å¦é‡‡ç”¨è¿˜æ˜¯å¾—æ ¹æ®å®é™…ä¸šåŠ¡æ˜¯å¦å…è®¸ä¸¢å¼ƒè€ä»»åŠ¡æ¥è®¤çœŸè¡¡é‡ã€‚</li>
<li>åŠŸèƒ½ï¼šå¦‚æœçº¿ç¨‹æ± æœªå…³é—­ï¼Œå°±å¼¹å‡ºé˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ ï¼Œç„¶åå°è¯•æ‰§è¡Œã€‚</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šè¿™ä¸ªç­–ç•¥è¿˜æ˜¯ä¼šä¸¢å¼ƒä»»åŠ¡ï¼Œä¸¢å¼ƒæ—¶ä¹Ÿæ˜¯æ¯«æ— å£°æ¯ï¼Œä½†æ˜¯ç‰¹ç‚¹æ˜¯ä¸¢å¼ƒçš„æ˜¯è€çš„æœªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œè€Œä¸”æ˜¯å¾…æ‰§è¡Œä¼˜å…ˆçº§è¾ƒé«˜çš„ä»»åŠ¡ã€‚åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œæƒ³åˆ°çš„åœºæ™¯å°±æ˜¯ï¼Œå‘å¸ƒæ¶ˆæ¯å’Œä¿®æ”¹æ¶ˆæ¯ï¼Œå½“æ¶ˆæ¯å‘å¸ƒå‡ºå»åï¼Œè¿˜æœªæ‰§è¡Œï¼Œæ­¤æ—¶æ›´æ–°çš„æ¶ˆæ¯åˆæ¥äº†ï¼Œè¿™ä¸ªæ—¶å€™æœªæ‰§è¡Œçš„æ¶ˆæ¯çš„ç‰ˆæœ¬æ¯”ç°åœ¨æäº¤çš„æ¶ˆæ¯ç‰ˆæœ¬è¦ä½å°±å¯ä»¥è¢«ä¸¢å¼ƒäº†ã€‚å› ä¸ºé˜Ÿåˆ—ä¸­è¿˜æœ‰å¯èƒ½å­˜åœ¨æ¶ˆæ¯ç‰ˆæœ¬æ›´ä½çš„æ¶ˆæ¯ä¼šæ’é˜Ÿæ‰§è¡Œï¼Œæ‰€ä»¥åœ¨çœŸæ­£å¤„ç†æ¶ˆæ¯çš„æ—¶å€™ä¸€å®šè¦åšå¥½æ¶ˆæ¯çš„ç‰ˆæœ¬æ¯”è¾ƒã€‚</li>
</ul>
<p>ï¼ˆ4ï¼‰<code>CallerRunsPolicy</code>è°ƒç”¨è€…è¿è¡Œç­–ç•¥ï¼šç”±è°ƒç”¨çº¿ç¨‹å¤„ç†è¯¥ä»»åŠ¡ã€‚</p>
<ul>
<li>åŠŸèƒ½ï¼šå½“è§¦å‘æ‹’ç»ç­–ç•¥æ—¶ï¼Œåªè¦çº¿ç¨‹æ²¡æœ‰å…³é—­ï¼Œå°±ç”±æäº¤ä»»åŠ¡çš„å½“å‰çº¿ç¨‹å¤„ç†ã€‚</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šä¸€èˆ¬åœ¨ä¸å…è®¸å¤±è´¥çš„ã€å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜ã€å¹¶å‘é‡è¾ƒå°çš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œå› ä¸ºçº¿ç¨‹æ± ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå…³é—­ï¼Œä¹Ÿå°±æ˜¯æäº¤çš„ä»»åŠ¡ä¸€å®šä¼šè¢«è¿è¡Œï¼Œä½†æ˜¯ç”±äºæ˜¯è°ƒç”¨è€…çº¿ç¨‹è‡ªå·±æ‰§è¡Œçš„ï¼Œå½“å¤šæ¬¡æäº¤ä»»åŠ¡æ—¶ï¼Œå°±ä¼šé˜»å¡åç»­ä»»åŠ¡æ‰§è¡Œï¼Œæ€§èƒ½å’Œæ•ˆç‡è‡ªç„¶å°±æ…¢äº†ã€‚</li>
</ul>
<blockquote>
<p>å…¶ä»–æ¡†æ¶å®ç°</p>
<ul>
<li>Dubboï¼šåœ¨æŠ›å‡º<code>RejectedExecutionException</code>å¼‚å¸¸ä¹‹å‰ä¼šè®°å½•æ—¥å¿—å’Œdumpçº¿ç¨‹æ ˆä¿¡æ¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜</li>
<li>Nettyï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</li>
<li>ActiveMQï¼šè¶…æ—¶ç­‰å¾…(60s)ï¼Œå°è¯•æ”¾å…¥é˜Ÿåˆ—</li>
<li>PinPointï¼šä½¿ç”¨äº†ä¸€ç§æ‹’ç»ç­–ç•¥é“¾ï¼Œä¼šé€ä¸€å°è¯•ç­–ç•¥é“¾ä¸­æ¯ç§æ‹’ç»ç­–ç•¥</li>
</ul>
</blockquote>
<p>å£è¯€ï¼šæ‹’ç»ˆä¸¢è€è°ƒï¼ˆçº¿ç¨‹æ± æ‹’ç»ç­–ç•¥ï¼šç»ˆæ­¢ç­–ç•¥ã€ä¸¢å¼ƒç­–ç•¥ã€å¼ƒè€ç­–ç•¥ã€è°ƒç”¨è€…è¿è¡Œç­–ç•¥ï¼‰</p>
<p>åœºæ™¯ï¼š</p>
<ul>
<li>ç»ˆæ­¢ç­–ç•¥ï¼šæ— ç‰¹æ®Šåœºæ™¯</li>
<li>ä¸¢å¼ƒç­–ç•¥ï¼šæ— å…³ç´§è¦çš„ä»»åŠ¡</li>
<li>å¼ƒè€ç­–ç•¥ï¼šå‘å¸ƒæ¶ˆæ¯</li>
<li>è°ƒç”¨è€…è¿è¡Œç­–ç•¥ï¼šä¸å…è®¸å¤±è´¥</li>
</ul>
<p>è¿‡ç¨‹ï¼š</p>
<ol>
<li>çº¿ç¨‹æ± ä¸­åˆšå¼€å§‹æ²¡æœ‰çº¿ç¨‹ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</li>
<li>å½“çº¿ç¨‹æ•°è¾¾åˆ°<code>corePoolSize</code>å¹¶æ²¡æœ‰çº¿ç¨‹ç©ºé—²ï¼Œè¿™æ—¶å†åŠ å…¥ä»»åŠ¡ï¼Œæ–°åŠ çš„ä»»åŠ¡ä¼šè¢«åŠ å…¥<code>workQueue</code>é˜Ÿåˆ—ï¼Œç›´åˆ°æœ‰ç©ºé—²çš„çº¿ç¨‹ã€‚</li>
<li>å¦‚æœé˜Ÿåˆ—é€‰æ‹©äº†æœ‰ç•Œé˜Ÿåˆ—ï¼Œé‚£ä¹ˆä»»åŠ¡è¶…è¿‡äº†é˜Ÿåˆ—å¤§å°æ—¶ï¼Œä¼šåˆ›å»º<code>maximumPoolSize</code>-<code>corePoolSize</code>æ•°ç›®çš„çº¿ç¨‹æ¥æ•‘æ€¥ã€‚</li>
<li>å¦‚æœçº¿ç¨‹è¾¾åˆ°<code>maximumPoolSize</code>ä»ç„¶æœ‰æ–°ä»»åŠ¡æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚</li>
<li>å½“é«˜å³°è¿‡å»åï¼Œè¶…è¿‡<code>corePoolSize</code>çš„æ•‘æ€¥çº¿ç¨‹å¦‚æœä¸€æ®µæ—¶é—´æ²¡æœ‰ä»»åŠ¡åšï¼Œéœ€è¦ç»“æŸèŠ‚çœèµ„æºï¼Œè¿™ä¸ªæ—¶é—´<code>kepAliveTime</code>å’Œ<code>unit</code>æ¥æ§åˆ¶ã€‚</li>
</ol>
<h3 id="6-2-7-å›ºå®šå¤§å°çº¿ç¨‹æ± "><a href="#6-2-7-å›ºå®šå¤§å°çº¿ç¨‹æ± " class="headerlink" title="6.2.7 å›ºå®šå¤§å°çº¿ç¨‹æ± "></a>6.2.7 å›ºå®šå¤§å°çº¿ç¨‹æ± </h3><p><code>newFixedThreadPool</code></p>
<p>æ„é€ æ–¹æ³•çš„å‚æ•°ï¼š</p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š<code>nThreads</code></li>
<li>çº¿ç¨‹å·¥å‚ï¼š<code>threadFactory</code></li>
</ul>
<pre><code class="java">public static ExecutorService newFixedThreadPool(int nThreads, ThreadFactory threadFactory) &#123;
    return new ThreadPoolExecutor(nThreads, nThreads,
                                  0L, TimeUnit.MILLISECONDS,
                                  new LinkedBlockingQueue&lt;Runnable&gt;(),
                                  threadFactory);
&#125;</code></pre>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•° = æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹ï¼Œæ— éœ€è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚</li>
<li>é˜»å¡é˜Ÿåˆ—æ˜¯æ— ç•Œçš„ï¼Œå¯ä»¥æ”¾ä»»æ„æ•°é‡çš„ä»»åŠ¡ã€‚</li>
</ul>
<p>åœºæ™¯ï¼šé€‚ç”¨äºä»»åŠ¡é‡å·²çŸ¥ï¼Œç›¸å¯¹è€—æ—¶çš„ä»»åŠ¡ã€‚</p>
<h3 id="6-2-8-æ— ç•Œé™åˆ¶çº¿ç¨‹æ± "><a href="#6-2-8-æ— ç•Œé™åˆ¶çº¿ç¨‹æ± " class="headerlink" title="6.2.8 æ— ç•Œé™åˆ¶çº¿ç¨‹æ± "></a>6.2.8 æ— ç•Œé™åˆ¶çº¿ç¨‹æ± </h3><p><code>newCachedThreadPool</code></p>
<p>æ„é€ æ–¹æ³•çš„å‚æ•°ï¼š</p>
<ul>
<li>çº¿ç¨‹å·¥å‚ï¼š<code>threadFactory</code></li>
</ul>
<pre><code class="java">public static ExecutorService newCachedThreadPool(ThreadFactory threadFactory) &#123;
    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,
                                  60L, TimeUnit.SECONDS,
                                  new SynchronousQueue&lt;Runnable&gt;(),
                                  threadFactory);
&#125;</code></pre>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ˜¯<code>0</code>ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯<code>Integer.MAX_VALUE</code>ï¼Œæ•‘æ€¥çº¿ç¨‹çš„ç©ºé—²ç”Ÿå­˜æ—¶é—´æ˜¯<code>60S</code>ï¼Œæ„å‘³ç€<ul>
<li>å…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼ˆç©ºé—²60Såå¯ä»¥å›æ”¶ï¼‰</li>
<li>æ•‘æ€¥çº¿ç¨‹å¯ä»¥æ— é™åˆ›å»º</li>
</ul>
</li>
<li>ä»»åŠ¡é˜Ÿåˆ—é‡‡ç”¨<code>SyncheonousQueue</code>å®ç°ç‰¹ç‚¹æ˜¯ï¼Œå®ƒæ²¡æœ‰å®¹é‡ï¼Œæ²¡æœ‰çº¿ç¨‹æ¥å–æ˜¯æ”¾ä¸è¿›å»çš„</li>
</ul>
<p>åœºæ™¯ï¼š</p>
<ul>
<li>æ•´ä¸ªçº¿ç¨‹æ± è¡¨ç°ä¸ºçº¿ç¨‹æ•°ä¼šæ ¹æ®ä»»åŠ¡é‡ä¸æ–­å¢é•¿ï¼Œæ²¡æœ‰ä¸Šé™ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç©ºé—²1åˆ†é’Ÿåé‡Šæ”¾çº¿ç¨‹ã€‚</li>
<li>é€‚åˆä»»åŠ¡æ•°æ¯”è¾ƒå¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µã€‚</li>
</ul>
<p><code>SyncheonousQueue</code>ç¤ºä¾‹ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;SynchronousQueue&quot;)
public class SynchronousQueueDemo &#123;
    public static void main(String[] args) throws InterruptedException &#123;
        SynchronousQueue&lt;Integer&gt; integers = new SynchronousQueue&lt;&gt;();
        new Thread(() -&gt; &#123;
            try &#123;
                log.debug(&quot;putting &#123;&#125;&quot;, 1);
                integers.put(1);
                log.debug(&quot;&#123;&#125; finish&quot;, 1);

                log.debug(&quot;putting &#123;&#125;&quot;, 2);
                integers.put(2);
                log.debug(&quot;&#123;&#125; finish&quot;, 2);
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;, &quot;t1&quot;).start();

        TimeUnit.SECONDS.sleep(1);

        new Thread(() -&gt; &#123;
           try &#123;
               log.debug(&quot;taking &#123;&#125;&quot;, 1);
               integers.take();
           &#125; catch (InterruptedException e) &#123;
               e.printStackTrace();
           &#125;
        &#125;, &quot;t2&quot;).start();

        TimeUnit.SECONDS.sleep(1);

        new Thread(() -&gt; &#123;
            try &#123;
                log.debug(&quot;taking &#123;&#125;&quot;, 2);
                integers.take();
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;, &quot;t3&quot;).start();
    &#125;
&#125;</code></pre>
<p>è¾“å‡ºï¼š</p>
<pre><code>2021-05-01 15:19:10.611 [t1] DEBUG SynchronousQueue - putting 1
2021-05-01 15:19:11.621 [t2] DEBUG SynchronousQueue - taking 1
2021-05-01 15:19:11.621 [t1] DEBUG SynchronousQueue - 1 finish
2021-05-01 15:19:11.621 [t1] DEBUG SynchronousQueue - putting 2
2021-05-01 15:19:12.632 [t3] DEBUG SynchronousQueue - taking 2
2021-05-01 15:19:12.633 [t1] DEBUG SynchronousQueue - 2 finish</code></pre>
<h3 id="6-2-9-å§‹ç»ˆå¦‚ä¸€çº¿ç¨‹æ± "><a href="#6-2-9-å§‹ç»ˆå¦‚ä¸€çº¿ç¨‹æ± " class="headerlink" title="6.2.9 å§‹ç»ˆå¦‚ä¸€çº¿ç¨‹æ± "></a>6.2.9 å§‹ç»ˆå¦‚ä¸€çº¿ç¨‹æ± </h3><p><code>newSingleThreadExecutor</code></p>
<p>æ„é€ æ–¹æ³•çš„å‚æ•°ï¼š</p>
<ul>
<li>çº¿ç¨‹å·¥å‚ï¼š<code>threadFactory</code></li>
</ul>
<pre><code>public static ExecutorService newSingleThreadExecutor(ThreadFactory threadFactory) &#123;
    return new FinalizableDelegatedExecutorService
        (new ThreadPoolExecutor(1, 1,
                                0L, TimeUnit.MILLISECONDS,
                                new LinkedBlockingQueue&lt;Runnable&gt;(),
                                threadFactory));
&#125;</code></pre>
<p>åœºæ™¯ï¼šå¸Œæœ›å¤šä¸ªä»»åŠ¡æ’é˜Ÿæ‰§è¡Œã€‚çº¿ç¨‹æ•°å›ºå®šä¸º1ï¼Œä»»åŠ¡æ•°å¤šäº1æ—¶ï¼Œä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿã€‚ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å”¯ä¸€çš„çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚</p>
<p>åŒºåˆ«ï¼š</p>
<ul>
<li>å¯¹æ¯”ï¼šåˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œä»»åŠ¡<ul>
<li>å•çº¿ç¨‹å¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥è€Œç»ˆæ­¢é‚£ä¹ˆæ²¡æœ‰ä»»ä½•è¡¥æ•‘æªæ–½ã€‚</li>
<li><code>newSingleThreadExecutor</code>çº¿ç¨‹æ± è¿˜ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿è¯çº¿ç¨‹æ± çš„æ­£å¸¸å·¥ä½œã€‚</li>
</ul>
</li>
<li>å¯¹æ¯”ï¼š<code>Executors.newFixedThreadPool(1)</code><ul>
<li><code>newFixedThreadPool</code>å¯¹å¤–æš´éœ²çš„æ˜¯<code>ThreadPoolExecutor</code>å¯¹è±¡ï¼Œå¯ä»¥å¼ºè½¬åè°ƒç”¨<code>setCoreSize</code>ç­‰æ–¹æ³•è¿›è¡Œä¿®æ”¹ã€‚</li>
<li><code>FinalizableDelegatedExecutorService</code>åº”ç”¨çš„æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåªå¯¹å¤–æš´éœ²äº†<code>ExecutorService</code>æ¥å£ï¼Œå› æ­¤ä¸èƒ½<code>ThreadPoolExecutor</code>ä¸­ç‰¹æœ‰çš„æ–¹æ³•ã€‚</li>
</ul>
</li>
</ul>
<h3 id="6-2-10-æ‰§è¡Œ-æäº¤ä»»åŠ¡"><a href="#6-2-10-æ‰§è¡Œ-æäº¤ä»»åŠ¡" class="headerlink" title="6.2.10 æ‰§è¡Œ/æäº¤ä»»åŠ¡"></a>6.2.10 æ‰§è¡Œ/æäº¤ä»»åŠ¡</h3><pre><code class="java">// æ‰§è¡Œä»»åŠ¡
void execute(Runnable command);

// æäº¤ä»»åŠ¡taskï¼Œç”¨è¿”å›å€¼Futureè·å¾—ä»»åŠ¡æ‰§è¡Œç»“æœ
&lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);

// æäº¤tasksä¸­æ‰€æœ‰ä»»åŠ¡
&lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) throws InterruptedException;

// æäº¤taksä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå¸¦è¶…æ—¶æ—¶é—´
&lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit) throws InterruptedException;

// æäº¤tasksä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶ä»–ä»»åŠ¡å–æ¶ˆ
&lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) throws InterruptedException, ExecutionException;

// æäº¤tasksä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶ä»–ä»»åŠ¡å–æ¶ˆ
&lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit) sthrows InterruptedException, ExecutionException, TimeoutException;</code></pre>
<h3 id="6-2-11-å…³é—­çº¿ç¨‹æ± "><a href="#6-2-11-å…³é—­çº¿ç¨‹æ± " class="headerlink" title="6.2.11 å…³é—­çº¿ç¨‹æ± "></a>6.2.11 å…³é—­çº¿ç¨‹æ± </h3><p><code>shutdown</code></p>
<ul>
<li>å°†çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹ä¸º<code>SHUTDOWN</code></li>
<li>ä¸å†æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šå°†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œ</li>
</ul>
<pre><code class="java">public void shutdown() &#123;
    final ReentrantLock mainLock = this.mainLock;
    mainLock.lock();
    try &#123;
        checkShutdownAccess();
        // ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€
        advanceRunState(SHUTDOWN);
        // ä»…æ‰“æ–­ç©ºé—²çº¿ç¨‹
        interruptIdleWorkers();
        onShutdown(); // hook for ScheduledThreadPoolExecutor
    &#125; finally &#123;
        mainLock.unlock();
    &#125;
    // å°è¯•ç»ˆç»“
    tryTerminate();
&#125;</code></pre>
<p><code>shutdownNow</code></p>
<ul>
<li>å°†çº¿ç¨‹æ± çš„çŠ¶æ€æ”¹ä¸º<code>STOP</code></li>
<li>ä¸å†æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šå†æ‰§è¡Œé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</li>
<li>ä¼šå°†é˜»å¡é˜Ÿåˆ—ä¸­æœªæ‰§è¡Œçš„ä»»åŠ¡ä½œä¸ºæ–¹æ³•è¿”å›å€¼</li>
<li>å¹¶ç”¨<code>interrupt</code>çš„æ–¹å¼ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</li>
</ul>
<pre><code class="java">public List&lt;Runnable&gt; shutdownNow() &#123;
    List&lt;Runnable&gt; tasks;
    final ReentrantLock mainLock = this.mainLock;
    mainLock.lock();
    try &#123;
        checkShutdownAccess();
        // ä¿®æ”¹çº¿ç¨‹æ± çŠ¶æ€
        advanceRunState(STOP);
        // æ‰“æ–­æ‰€æœ‰çº¿ç¨‹
        interruptWorkers();
        // è·å–é˜Ÿåˆ—ä¸­å‰©ä½™ä»»åŠ¡
        tasks = drainQueue();
    &#125; finally &#123;
        mainLock.unlock();
    &#125;
    // å°è¯•ç»ˆç»“
    tryTerminate();
    return tasks;
&#125;</code></pre>
<p>å…¶ä»–æ–¹æ³•ï¼š</p>
<pre><code class="java">// åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯éRUNNING
public boolean isShutdown();

// åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯TERMINATED
public boolean isTerminated();

// è°ƒç”¨shutdownåï¼Œç”±äºè°ƒç”¨çº¿ç¨‹å¹¶ä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡è¿è¡Œç»“æŸï¼Œå› æ­¤å¦‚æœå®ƒæƒ³åœ¨çº¿ç¨‹æ± TERMINATEDååšäº›äº‹æƒ…ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ–¹æ³•ç­‰å¾…
public boolean awaitTermination(long timeout, TimeUnit unit);</code></pre>
<h2 id="6-3-å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹"><a href="#6-3-å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹" class="headerlink" title="6.3 å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹"></a>6.3 å¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹</h2><h3 id="6-3-1-æ¦‚è¿°"><a href="#6-3-1-æ¦‚è¿°" class="headerlink" title="6.3.1 æ¦‚è¿°"></a>6.3.1 æ¦‚è¿°</h3><p><strong>å®šä¹‰</strong>ï¼šè®©æœ‰é™çš„å·¥ä½œçº¿ç¨‹ï¼ˆWorker Threadï¼‰æ¥è½®æµç§»é™¤å¤„ç†æ— é™å¤šçš„ä»»åŠ¡ã€‚ä¹Ÿå¯ä»¥å°†å…¶å½’ç±»ä¸ºåˆ†å·¥æ¨¡å¼ï¼Œå®ƒçš„å…¸å‹å®ç°å°±æ˜¯çº¿ç¨‹æ± ï¼Œä¹Ÿä½“ç°äº†ç»å…¸è®¾è®¡æ¨¡å¼ä¸­çš„äº«å…ƒæ¨¡å¼ã€‚</p>
<p><strong>ä¾‹å¦‚</strong>ï¼šæµ·åº•æçš„æœåŠ¡å‘˜ï¼ˆçº¿ç¨‹ï¼‰ï¼Œè½®æµå¤„ç†æ¯ä½å®¢äººçš„ç‚¹é¤ï¼ˆä»»åŠ¡ï¼‰ï¼Œå¦‚æœä¸ºæ¯ä½å®¢äººéƒ½é…ä¸€åä¸“å±çš„æœåŠ¡å‘˜ï¼Œé‚£ä¹ˆæˆæœ¬å°±å¤ªé«˜äº†ã€‚ï¼ˆå¯¹æ¯”å¦ä¸€ç§å¤šçº¿ç¨‹è®¾è®¡æ¨¡å¼ï¼šThread-Per-Messageï¼‰</p>
<p><strong>æ³¨æ„</strong>ï¼šä¸åŒä»»åŠ¡ç±»å‹åº”è¯¥ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± ï¼Œè¿™æ ·èƒ½å¤Ÿé¿å…é¥¥é¥¿ï¼Œå¹¶èƒ½æå‡æ•ˆç‡ã€‚</p>
<p><strong>ä¾‹å¦‚</strong>ï¼šå¦‚æœä¸€ä¸ªé¤é¦†çš„å·¥äººæ—¢è¦æ‹›å‘¼å®¢äººï¼ˆä»»åŠ¡ç±»å‹Aï¼‰ï¼Œåˆè¦åˆ°åå¨åšèœï¼ˆä»»åŠ¡ç±»å‹Bï¼‰æ˜¾ç„¶æ•ˆç‡ä¸å’‹åœ°ï¼Œåˆ†æˆæœåŠ¡å‘˜ï¼ˆçº¿ç¨‹æ± Aï¼‰ä¸å¨å¸ˆï¼ˆçº¿ç¨‹æ± Bï¼‰æ›´ä¸ºåˆç†ï¼Œå½“ç„¶è¿˜æœ‰æ›´ç»†çš„åˆ†å·¥ã€‚</p>
<p><strong>é¥¥é¥¿</strong>ï¼šå›ºå®šå¤§å°çº¿ç¨‹æ± ä¼šæœ‰é¥¥é¥¿ç°è±¡</p>
<ul>
<li>ä¸¤ä¸ªå·¥äººæ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ± ä¸­çš„ä¸¤ä¸ªçº¿ç¨‹</li>
<li>ä»–ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šä¸ºå®¢äººç‚¹é¤å’Œåˆ°åå¨åšèœï¼Œè¿™æ˜¯ä¸¤ä¸ªé˜¶æ®µçš„å·¥ä½œ<ul>
<li>å®¢äººç‚¹é¤ï¼šå¿…é¡»å…ˆç‚¹å®Œé¤ï¼Œç­‰èœåšå¥½ï¼Œä¸Šèœï¼Œåœ¨æ­¤æœŸé—´å¤„ç†ç‚¹é¤çš„å·¥äººå¿…é¡»ç­‰å¾…</li>
<li>åå¨åšèœï¼šåšå°±å®Œäº†</li>
</ul>
</li>
<li>å¦‚æœåªæœ‰ä¸€ä¸ªå®¢äººï¼Œå·¥äººAå¤„ç†äº†ç‚¹é¤ä»»åŠ¡ï¼Œæ¥ä¸‹æ¥å®ƒè¦ç­‰ç€å·¥äººBå»æŠŠèœåšå¥½ï¼Œç„¶åä¸Šèœ</li>
<li>å¦‚æœåŒæ—¶æ¥äº†ä¸¤ä¸ªå®¢äººï¼Œè¿™ä¸ªæ—¶å€™å·¥äººAå’Œå·¥äººBéƒ½å»å¤„ç†ç‚¹é¤äº†ï¼Œè¿™æ—¶æ²¡äººåšé¥­äº†ï¼Œé¥¥é¥¿</li>
</ul>
<p><strong>è§£å†³</strong>ï¼š</p>
<p>å¯ä»¥å¢åŠ çº¿ç¨‹æ± çš„å¤§å°ï¼Œä½†æ˜¯ä¸æ˜¯æ ¹æœ¬è§£å†³ä¹‹é“ã€‚ä¸åŒçš„ä»»åŠ¡ç±»å‹ï¼Œåˆ›å»ºä¸åŒçš„çº¿ç¨‹æ± ã€‚</p>
<pre><code class="java">@Slf4j(topic = &quot;Starvation&quot;)
public class StarvationDemo &#123;
    /**
     * èœå•
     */
    static final List&lt;String&gt; MENU = Arrays.asList(&quot;é±¼é¦™è‚‰ä¸&quot;, &quot;å®«ä¿é¸¡ä¸&quot;, &quot;çº¢çƒ§è‚‰&quot;, &quot;çƒ¤é¸¡ç¿…&quot;);
    static final Random RANDOM = new Random();
    /**
     * éšæœºåšä¸ªèœ
     */
    static String cooking() &#123;
        return MENU.get(RANDOM.nextInt(MENU.size()));
    &#125;

    public static void main(String[] args) &#123;
        // æœåŠ¡å‘˜
        ExecutorService waiterPool = Executors.newFixedThreadPool(1);
        // å¨å¸ˆ
        ExecutorService cookPool =  Executors.newFixedThreadPool(1);
        // 10ä½å®¢äºº
        for (int i = 0; i &lt; 10; i++) &#123;
            waiterPool.execute(() -&gt; &#123;
                log.debug(&quot;å¤„ç†ç‚¹é¤&quot;);
                Future&lt;String&gt; future = cookPool.submit(() -&gt; &#123;
                    log.debug(&quot;åšèœ&quot;);
                    return cooking();
                &#125;);
                try &#123;
                    log.debug(&quot;ä¸Šèœ: &#123;&#125;&quot;, future.get());
                &#125; catch (InterruptedException | ExecutionException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;);
        &#125;
    &#125;
&#125;</code></pre>
<h3 id="6-3-2-åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚"><a href="#6-3-2-åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚" class="headerlink" title="6.3.2 åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚"></a>6.3.2 åˆ›å»ºå¤šå°‘çº¿ç¨‹æ± åˆé€‚</h3><ul>
<li>è¿‡å°ä¼šå¯¼è‡´ç¨‹åºä¸èƒ½å……åˆ†åœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºã€å®¹æ˜“å¯¼è‡´é¥¥é¥¿</li>
<li>è¿‡å¤§åå¯¼è‡´æ›´å¤šçš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå ç”¨æ›´å¤šå†…å­˜</li>
</ul>
<p><strong>CPUå¯†é›†å‹è¿ç®—</strong></p>
<p>é€šå¸¸é‡‡ç”¨CPUæ ¸æ•° + 1èƒ½å¤Ÿå®ç°æœ€ä¼˜çš„CPUåˆ©ç”¨ç‡ï¼Œ+1æ˜¯ä¿è¯å½“çº¿ç¨‹ç”±äºé¡µç¼ºå¤±æ•…éšœï¼ˆæ“ä½œç³»ç»Ÿï¼‰æˆ–å…¶ä»–åŸå› å¯¼è‡´æš‚åœæ—¶ï¼Œé¢å¤–çš„è¿™ä¸ªçº¿ç¨‹å°±èƒ½é¡¶ä¸Šå»ï¼Œä¿è¯CPUæ—¶é’Ÿå‘¨æœŸä¸è¢«æµªè´¹ã€‚</p>
<p><strong>I/Oå¯†é›†å‹è¿ç®—</strong></p>
<p>CPUä¸æ€»æ˜¯å¤„äºç¹å¿™çŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œå½“ä½ æ‰§è¡Œä¸šåŠ¡è®¡ç®—æ—¶ï¼Œè¿™æ—¶å€™ä¼šä½¿ç”¨CPUèµ„æºï¼Œä½†å½“ä½ æ‰§è¡ŒIOæ“ä½œæ—¶ã€è¿œç¨‹RPCè°ƒç”¨æ—¶ï¼ŒåŒ…æ‹¬è¿›è¡Œæ•°æ®æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™CPUå°±é—²ä¸‹æ¥äº†ï¼Œä½ å¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹æé«˜å®ƒçš„åˆ©ç”¨ç‡ã€‚</p>
<p>ç»éªŒå…¬å¼ï¼š<code>çº¿ç¨‹æ•° = æ ¸æ•° * æœŸæœ›CPUåˆ©ç”¨ç‡ * æ€»æ—¶é—´(CPUè®¡ç®—æ—¶é—´ + ç­‰å¾…æ—¶é—´) / CPUè®¡ç®—æ—¶é—´</code></p>
<h3 id="6-3-3-ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± "><a href="#6-3-3-ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± " class="headerlink" title="6.3.3 ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± "></a>6.3.3 ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </h3><p>åœ¨ã€ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ã€åŠŸèƒ½åŠ å…¥ä¹‹å‰ï¼Œå¯ä»¥ä½¿ç”¨<code>java.util.Timer</code>æ¥å®ç°å®šæ—¶åŠŸèƒ½ï¼Œ<code>Timer</code>çš„ä¼˜ç‚¹åœ¨äºç®€å•æ˜“ç”¨ï¼Œä½†ç”±äºæ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è°ƒåº¦ï¼Œå› æ­¤æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡å†æ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡çš„å»¶è¿Ÿæˆ–å¼‚å¸¸éƒ½å°†ä¼šå½±å“åˆ°ä¹‹åçš„ä»»åŠ¡ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;Timer&quot;)
public class TimerDemo &#123;
    public static void main(String[] args) &#123;
        Timer timer = new Timer();
        TimerTask task1 = new TimerTask() &#123;
            @Override
            public void run() &#123;
                log.debug(&quot;task1&quot;);
                try &#123;
                    TimeUnit.SECONDS.sleep(2);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125;;
        TimerTask task2 = new TimerTask() &#123;
            @Override
            public void run() &#123;
                log.debug(&quot;task2&quot;);
            &#125;
        &#125;;
        log.debug(&quot;start...&quot;);
        timer.schedule(task1, 1000);
        timer.schedule(task2, 1000);
    &#125;
&#125;</code></pre>
<p>è¾“å‡ºï¼š</p>
<pre><code>2021-05-01 22:34:08.514 [main] DEBUG Timer - start...
2021-05-01 22:34:09.528 [Timer-0] DEBUG Timer - task1
2021-05-01 22:34:11.541 [Timer-0] DEBUG Timer - task2</code></pre>
<p>ç”±äºtask1çš„åŸå› å¯¼è‡´task2è¢«å»¶è¿Ÿæ‰§è¡Œã€‚</p>
<p>ä½¿ç”¨<code>ScheduledThreadPool</code>ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;NewScheduledThreadPool&quot;)
public class NewScheduledThreadPoolDemo &#123;
    public static void main(String[] args) &#123;
        ScheduledExecutorService pool = Executors.newScheduledThreadPool(2);
        pool.schedule(() -&gt; &#123;
            log.debug(&quot;task1&quot;);
            try &#123;
                TimeUnit.SECONDS.sleep(2);
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
            int i = 1 / 0;
        &#125;, 1, TimeUnit.SECONDS);
        pool.schedule(() -&gt; &#123;
            log.debug(&quot;task2&quot;);
        &#125;, 1, TimeUnit.SECONDS);
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>2021-05-01 22:46:23.053 [pool-1-thread-2] DEBUG NewScheduledThreadPool - task2
2021-05-01 22:46:23.053 [pool-1-thread-1] DEBUG NewScheduledThreadPool - task1</code></pre>
<p>task1å‡ºç°å»¶è¿Ÿæˆ–è€…æŠ›å‡ºå¼‚å¸¸éƒ½ä¸ä¼šå½±å“åˆ°task2çš„æ‰§è¡Œã€‚</p>
<p><code>scheduleAtFixedRate</code>ï¼šåˆ›å»ºå¹¶æ‰§è¡Œå‘¨æœŸæ€§æ“ä½œã€‚è¯¥æ“ä½œåœ¨ç»™å®šçš„åˆå§‹å»¶è¿ŸinitialDelayåé¦–å…ˆå¯ç”¨ï¼Œéšååœ¨ç»™å®šçš„å‘¨æœŸperiodå†…å¯ç”¨ã€‚</p>
<p>ä½œç”¨ï¼šç»™ä¸€ä¸ªæ‰§è¡Œçš„å¼€å§‹å’Œä¸‹ä¸€ä¸ªæ‰§è¡Œçš„å¼€å§‹åŠ ä¸Šç»™å®šçš„å»¶è¿Ÿperiodã€‚</p>
<p>å¼‚å¸¸ï¼šå¦‚æœä»»åŠ¡çš„ä»»ä½•æ‰§è¡Œé‡åˆ°å¼‚å¸¸ï¼Œåˆ™ä¼šæŠ‘åˆ¶åç»­æ‰§è¡Œã€‚å¦åˆ™ï¼Œä»»åŠ¡å°†ä»…é€šè¿‡å–æ¶ˆæˆ–ç»ˆæ­¢æ‰§è¡Œç¨‹åºæ¥ç»ˆæ­¢ã€‚å¦‚æœæ­¤ä»»åŠ¡çš„ä»»ä½•æ‰§è¡Œæ—¶é—´è¶…è¿‡å…¶å‘¨æœŸï¼Œåˆ™åç»­æ‰§è¡Œå¯èƒ½ä¼šè¾ƒæ™šå¼€å§‹ï¼Œä½†ä¸ä¼šå¹¶å‘æ‰§è¡Œã€‚ã€ä»»åŠ¡çš„å¼‚å¸¸è¢«catchåˆ™ä¸å½±å“åç»­æ‰§è¡Œã€</p>
<pre><code class="java">// å»¶è¿Ÿä¸€ç§’æ‰§è¡Œï¼Œé—´éš”æ—¶é—´ä¸ºMax&#123;è®¾ç½®é—´éš”æ—¶é—´ï¼Œçº¿ç¨‹æ‰§è¡Œæ—¶é—´&#125;
pool.scheduleAtFixedRate(() -&gt; &#123;
    log.debug(&quot;running&quot;);
    try &#123;
        TimeUnit.SECONDS.sleep(2);
    &#125; catch (InterruptedException e) &#123;
        e.printStackTrace();
    &#125;
&#125;, 1, 1, TimeUnit.SECONDS);</code></pre>
<p><code>scheduleWithFixedDelay</code>ï¼šåˆ›å»ºå¹¶æ‰§è¡Œå‘¨æœŸæ€§æ“ä½œã€‚è¯¥æ“ä½œåœ¨ç»™å®šçš„åˆå§‹å»¶è¿ŸinitialDelayåé¦–å…ˆå¯ç”¨ï¼Œéšååœ¨ç»™å®šçš„å‘¨æœŸperiodå†…å¯ç”¨ã€‚</p>
<p>ä½œç”¨ï¼šç»™ä¸€ä¸ªæ‰§è¡Œçš„ç»ˆæ­¢å’Œä¸‹ä¸€ä¸ªæ‰§è¡Œçš„å¼€å§‹åŠ ä¸Šç»™å®šçš„å»¶è¿Ÿperiodã€‚</p>
<p>å¼‚å¸¸ï¼šå¦‚æœä»»åŠ¡çš„ä»»ä½•æ‰§è¡Œé‡åˆ°å¼‚å¸¸ï¼Œåˆ™ä¼šæŠ‘åˆ¶åç»­æ‰§è¡Œã€‚å¦åˆ™ï¼Œä»»åŠ¡å°†ä»…é€šè¿‡å–æ¶ˆæˆ–ç»ˆæ­¢æ‰§è¡Œç¨‹åºæ¥ç»ˆæ­¢ã€‚ã€ä»»åŠ¡çš„å¼‚å¸¸è¢«catchåˆ™ä¸å½±å“åç»­æ‰§è¡Œã€</p>
<pre><code class="java">// å»¶è¿Ÿä¸€ç§’æ‰§è¡Œï¼Œé—´éš”æ—¶é—´ä¸ºè®¾ç½®æ—¶é—´+çº¿ç¨‹ç¡çœ æ—¶é—´
pool.scheduleWithFixedDelay(() -&gt; &#123;
    log.debug(&quot;running&quot;);
    try &#123;
        TimeUnit.SECONDS.sleep(2);
    &#125; catch (InterruptedException e) &#123;
        e.printStackTrace();
    &#125;
&#125;, 1, 1, TimeUnit.SECONDS);</code></pre>
<h3 id="6-3-4-æ­£ç¡®å¤„ç†å¼‚å¸¸"><a href="#6-3-4-æ­£ç¡®å¤„ç†å¼‚å¸¸" class="headerlink" title="6.3.4 æ­£ç¡®å¤„ç†å¼‚å¸¸"></a>6.3.4 æ­£ç¡®å¤„ç†å¼‚å¸¸</h3><p>çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå¦‚æœä»»åŠ¡æŠ›å‡ºäº†å¼‚å¸¸ï¼Œé»˜è®¤æ˜¯ä¸­æ–­è¯¥ä»»åŠ¡è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸æˆ–è€…æ‰“å°å¼‚å¸¸ä¿¡æ¯ã€‚</p>
<ul>
<li>ä¸»åŠ¨æ•è·å¼‚å¸¸</li>
<li>ä½¿ç”¨Future</li>
</ul>
<h3 id="6-3-5-å®ç°å®šæ—¶ä»»åŠ¡"><a href="#6-3-5-å®ç°å®šæ—¶ä»»åŠ¡" class="headerlink" title="6.3.5 å®ç°å®šæ—¶ä»»åŠ¡"></a>6.3.5 å®ç°å®šæ—¶ä»»åŠ¡</h3><pre><code class="java">@Slf4j(topic = &quot;Schedule&quot;)
public class ScheduleDemo &#123;
    private static final ScheduledExecutorService pool = Executors.newScheduledThreadPool(1);

    public static void main(String[] args) &#123;
        // æ¯å‘¨å…­15ï¼š16ï¼š00æ‰“å°KHighness
        solution(DayOfWeek.SUNDAY, 15, 16, 00, () -&gt; &#123; log.debug(&quot;KHighness&quot;); &#125;);
    &#125;

    /**
     * æŒ‡å®šæ—¶é—´æ‰§è¡Œä»»åŠ¡
     *
     * @param day     å‘¨å‡ 
     * @param hour    å‡ æ—¶
     * @param minute  å‡ åˆ†
     * @param second  å‡ ç§’
     * @param task    ä»»åŠ¡
     */
    public static void solution(DayOfWeek day, int hour, int minute, int second, Runnable task) &#123;
        // å½“å‰æ—¶é—´
        LocalDateTime now = LocalDateTime.now();
        // ç›®æ ‡æ—¶é—´
        LocalDateTime tar = now.withHour(hour).withMinute(minute).withSecond(second).with(day);
        // å¦‚æœå½“å‰æ—¶é—´ &gt; ç›®æ ‡æ—¶é—´ï¼Œåˆ™ä¸ºä¸‹å‘¨
        if (now.compareTo(tar) &gt; 0) &#123;
            tar.plusWeeks(1);
        &#125;
        // é—´éš”æ—¶é—´
        long initialDelay = Duration.between(now, tar).toMillis();
        // å¾ªç¯å‘¨æœŸ
        long period = 7 * 24 * 3600 * 1000;
        // æ‰§è¡Œä»»åŠ¡
        pool.scheduleAtFixedRate(task, initialDelay, period, TimeUnit.MILLISECONDS);
    &#125;
&#125;</code></pre>
<h2 id="6-4-Tomcatçº¿ç¨‹æ± "><a href="#6-4-Tomcatçº¿ç¨‹æ± " class="headerlink" title="6.4 Tomcatçº¿ç¨‹æ± "></a>6.4 Tomcatçº¿ç¨‹æ± </h2><h3 id="6-4-1-æ€»ä½“ç»“æ„"><a href="#6-4-1-æ€»ä½“ç»“æ„" class="headerlink" title="6.4.1 æ€»ä½“ç»“æ„"></a>6.4.1 æ€»ä½“ç»“æ„</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62082/image-20210502151900797.png" class="" title="image-20210502151900797">

<ul>
<li>LimitLatchç”¨æ¥é™æµï¼Œå¯ä»¥æ§åˆ¶æœ€å¤§è¿æ¥ä¸ªæ•°ï¼Œç±»ä¼¼JUCä¸­çš„Semaphore</li>
<li>Acceptoråªè´Ÿè´£æ¥æ”¶æ–°çš„socketè¿æ¥</li>
<li>Polleråªè´Ÿè´£ç›‘å¬socket channelæ˜¯å¦æœ‰æ–°çš„å¯è¯»çš„I/Oäº‹ä»¶</li>
<li>ä¸€æ—¦å¯è¯»ï¼Œå°è£…ä¸€ä¸ªä»»åŠ¡å¯¹è±¡socketProcessorï¼Œæäº¤ç»™Executorçº¿ç¨‹æ± å¤„ç†</li>
<li>Executorçº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æœ€ç»ˆè´Ÿè´£å¤„ç†è¯·æ±‚</li>
</ul>
<h3 id="6-4-2-ä¸åŒä¹‹å¤„"><a href="#6-4-2-ä¸åŒä¹‹å¤„" class="headerlink" title="6.4.2 ä¸åŒä¹‹å¤„"></a>6.4.2 ä¸åŒä¹‹å¤„</h3><p>Tomcatçº¿ç¨‹æ± æ‰©å±•äº†ThreadPoolExecutorï¼Œè¡Œä¸ºç¨æœ‰ä¸åŒ</p>
<ul>
<li>å¦‚æœæ€»çº¿ç¨‹æ•°è¾¾åˆ°<code>maximumPoolSize</code><ul>
<li>è¿™æ—¶ä¸ä¼šç«‹åˆ»æŠ›<code>RejectedExecutionException</code></li>
<li>è€Œæ˜¯å°è¯•å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œå¦‚æœè¿˜å¤±è´¥ï¼Œæ‰æŠ›å‡º<code>RejectedExecutionException</code></li>
</ul>
</li>
</ul>
<p><code>tomcat-7.0.42</code>æºç  </p>
<pre><code class="java">public void execute(Runnable command, long timeout, TimeUnit unit) &#123;
    submittedCount.incrementAndGet();
    try &#123;
        super.execute(command);
    &#125; catch (RejectedExecutionException rx) &#123;
        if (super.getQueue() instanceof TaskQueue) &#123;
            final TaskQueue queue = (TaskQueue)super.getQueue();
            try &#123;
                // å°è¯•å°†ä»»åŠ¡é‡æ–°åŠ å…¥é˜»å¡é˜Ÿåˆ—
                if (!queue.force(command, timeout, unit)) &#123;
                    submittedCount.decrementAndGet();
                    throw new RejectedExecutionException(&quot;Queue capacity is full.&quot;);
                &#125;
            &#125; catch (InterruptedException x) &#123;
                // ä¾ç„¶å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
                submittedCount.decrementAndGet();
                Thread.interrupted();
                throw new RejectedExecutionException(x);
            &#125;
        &#125; else &#123;
            submittedCount.decrementAndGet();
            throw rx;
        &#125;
    &#125;
&#125;</code></pre>
<pre><code>public boolean force(Runnable o, long timeout, TimeUnit unit) throws InterruptedException &#123;
    if ( parent.isShutdown() )
        throw new RejectedExecutionException(
                &quot;Executor not running, can&#39;t force a command into the queue&quot;
        );
    return super.offer(o,timeout,unit); //forces the item onto the queue, to be used if the task is rejected
&#125;</code></pre>
<h3 id="6-4-3-å¯é…ç½®é¡¹"><a href="#6-4-3-å¯é…ç½®é¡¹" class="headerlink" title="6.4.3 å¯é…ç½®é¡¹"></a>6.4.3 å¯é…ç½®é¡¹</h3><p>Connectoré…ç½®</p>
<table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>é»˜è®¤å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>acceptorThreadCount</td>
<td>1</td>
<td>accterçº¿ç¨‹æ•°é‡</td>
</tr>
<tr>
<td>pollerThreadCount</td>
<td>1</td>
<td>pollerçº¿ç¨‹æ•°é‡</td>
</tr>
<tr>
<td>minSpareThreads</td>
<td>10</td>
<td>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³corePoolSize</td>
</tr>
<tr>
<td>maxThreads</td>
<td>200</td>
<td>æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³maximumPoolSize</td>
</tr>
<tr>
<td>executor</td>
<td>-</td>
<td>Executoråç§°ï¼Œç”¨æ¥å¼•ç”¨ä¸‹é¢çš„Executor</td>
</tr>
</tbody></table>
<p>Executoré…ç½®</p>
<table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>é»˜è®¤å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>threadPriority</td>
<td>5</td>
<td>çº¿ç¨‹ä¼˜å…ˆçº§</td>
</tr>
<tr>
<td>daemon</td>
<td>true</td>
<td>æ˜¯å¦å®ˆæŠ¤çº¿ç¨‹</td>
</tr>
<tr>
<td>minSpareThreads</td>
<td>25</td>
<td>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³corePoolSize</td>
</tr>
<tr>
<td>maxThreads</td>
<td>200</td>
<td>æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³maximumPoolSize</td>
</tr>
<tr>
<td>maxIdleTime</td>
<td>60000</td>
<td>çº¿ç¨‹ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œé»˜è®¤å€¼å³1åˆ†é’Ÿ</td>
</tr>
<tr>
<td>maxQueueSize</td>
<td>Integer.MAX_VALUE</td>
<td>é˜Ÿåˆ—é•¿åº¦</td>
</tr>
<tr>
<td>prestartminSpareThreads</td>
<td>false</td>
<td>æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å¯åŠ¨</td>
</tr>
</tbody></table>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62082/image-20210502155938527.png" class="" title="image-20210502155938527">



<h2 id="6-5-Fork-Join"><a href="#6-5-Fork-Join" class="headerlink" title="6.5 Fork/Join"></a>6.5 Fork/Join</h2><h3 id="6-5-1-æ¦‚è¿°"><a href="#6-5-1-æ¦‚è¿°" class="headerlink" title="6.5.1 æ¦‚è¿°"></a>6.5.1 æ¦‚è¿°</h3><p>Fork/Joinæ˜¯JDK1.7åŠ å…¥çš„æ–°çš„çº¿ç¨‹æ± å®ç°ï¼Œå®ƒä½“ç°çš„æ˜¯ä¸€ç§åˆ†æ²»æ€æƒ³ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„CPUå¯†é›†å‹è¿ç®—ã€‚</p>
<p>æ‰€è°“çš„ä»»åŠ¡æ‹†åˆ†ï¼Œæ˜¯å°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†æˆç®—æ³•ä¸Šç›¸åŒçš„å°äººç‰©ï¼Œç›´è‡³ä¸èƒ½æ‹†åˆ†æˆå¯ä»¥ç›´æ¥æ±‚è§£ã€‚è·Ÿé€’å½’ç›¸å…³çš„ä¸€äº›è®¡ç®—ï¼Œå¦‚å½’å¹¶æ’åºã€æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œéƒ½å¯ä»¥ç”¨åˆ†æ²»æ€æƒ³è¿›è¡Œæ±‚è§£ã€‚</p>
<p>Fork/Joinåœ¨åˆ†æ²»çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å¤šçº¿ç¨‹ï¼Œå¯ä»¥æŠŠæ¯ä¸ªä»»åŠ¡çš„åˆ†è§£å’Œåˆå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥å®Œæˆï¼Œè¿›ä¸€æ­¥æå‡äº†è¿ç®—æ•ˆç‡ã€‚</p>
<p>Fork/Joiné»˜è®¤ä¼šåˆ›å»ºä¸CPUæ ¸å¿ƒæ•°å¤§å°ç›¸åŒçš„çº¿ç¨‹æ± ã€‚</p>
<h3 id="6-5-2-ä½¿ç”¨"><a href="#6-5-2-ä½¿ç”¨" class="headerlink" title="6.5.2 ä½¿ç”¨"></a>6.5.2 ä½¿ç”¨</h3><p>æäº¤ç»™Fork/Joinçº¿ç¨‹æ± çš„ä»»åŠ¡éœ€è¦ç»§æ‰¿<code>RecursiveTask</code>ï¼ˆæœ‰è¿”å›å€¼ï¼‰æˆ–<code>RecuisiveAction</code>ï¼ˆæ²¡æœ‰è¿”å›å€¼ï¼‰ï¼Œä¾‹å¦‚ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå¯¹1~nä¹‹é—´çš„æ•´æ•°æ±‚å’Œçš„ä»»åŠ¡ã€‚</p>
<p>å¦‚ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå¯¹1~nä¹‹é—´çš„æ•´æ•°æ±‚å’Œçš„ä»»åŠ¡</p>
<pre><code class="java">@Slf4j(topic = &quot;ForkJoin&quot;)
public class ForkJoinDemo &#123;
    public static void main(String[] args) &#123;
        ForkJoinPool pool = new ForkJoinPool(4);
        System.out.println(pool.invoke(new Task(5)));
    &#125;
&#125;

@Slf4j(topic = &quot;Task&quot;)
class Task extends RecursiveTask&lt;Integer&gt; &#123;
    private final int n;

    public Task(int n) &#123;
        this.n = n;
    &#125;

    @Override
    public String toString() &#123;
        return &quot;ã€&quot; + n +  &quot;ã€&quot;;
    &#125;

    @Override
    protected Integer compute() &#123;
        if (n == 1) return 1;
        Task tas = new Task(n - 1);
        tas.fork();
        log.debug(&quot;fork: &#123;&#125; &#123;&#125;&quot;, n, tas);
        int res = n + tas.join();
        log.debug(&quot;join: &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;, n, tas, res);
        return res;
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>2021-05-02 17:04:41.631 [ForkJoinPool-1-worker-2] DEBUG Task - fork: 4 ã€3ã€
2021-05-02 17:04:41.631 [ForkJoinPool-1-worker-1] DEBUG Task - fork: 5 ã€4ã€
2021-05-02 17:04:41.631 [ForkJoinPool-1-worker-0] DEBUG Task - fork: 2 ã€1ã€
2021-05-02 17:04:41.631 [ForkJoinPool-1-worker-3] DEBUG Task - fork: 3 ã€2ã€
2021-05-02 17:04:41.634 [ForkJoinPool-1-worker-0] DEBUG Task - join: 2 + ã€1ã€ = 3
2021-05-02 17:04:41.634 [ForkJoinPool-1-worker-3] DEBUG Task - join: 3 + ã€2ã€ = 6
2021-05-02 17:04:41.634 [ForkJoinPool-1-worker-2] DEBUG Task - join: 4 + ã€3ã€ = 10
2021-05-02 17:04:41.634 [ForkJoinPool-1-worker-1] DEBUG Task - join: 5 + ã€4ã€ = 15
15</code></pre>
<p>æµç¨‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62082/image-20210502171007613.png" class="" title="image-20210502171007613">

<p>æ”¹è¿›ï¼šä»»åŠ¡æ‹†åˆ†</p>
<pre><code class="java">@Slf4j(topic = &quot;AddTask&quot;)
class AddTask extends RecursiveTask&lt;Integer&gt; &#123;
    int begin;
    int end;

    public AddTask(int begin, int end) &#123;
        this.begin = begin;
        this.end = end;
    &#125;

    @Override
    public String toString() &#123;
        return &quot;ã€&quot; + begin + &quot;, &quot; + end + &quot;ã€&quot;;
    &#125;

    @Override
    protected Integer compute() &#123;
        if (begin == end) &#123;
            log.debug(&quot;join: &#123;&#125;&quot;, begin);
            return begin;
        &#125;
        if (end - begin == 1) &#123;
            log.debug(&quot;join: &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;, begin, end, begin + end);
            return begin + end;
        &#125;
        int mid = begin + (end - begin &gt;&gt; 1);
        AddTask task1 = new AddTask(begin, mid);
        task1.fork();
        AddTask task2 = new AddTask(mid + 1, end);
        task2.fork();
        log.debug(&quot;fork: &#123;&#125; + &#123;&#125; = ?&quot;, task1, task2);
        int res = task1.join() + task2.join();
        log.debug(&quot;join: &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;, task1, task2, res);
        return res;
    &#125;
&#125;</code></pre>
<p>æµç¨‹ï¼š</p>
<pre><code>2021-05-02 17:39:00.721 [ForkJoinPool-1-worker-0] DEBUG AddTask - join: 1 + 2 = 3
2021-05-02 17:39:00.721 [ForkJoinPool-1-worker-2] DEBUG AddTask - fork: ã€1, 2ã€ + ã€3, 3ã€ = ?
2021-05-02 17:39:00.721 [ForkJoinPool-1-worker-3] DEBUG AddTask - join: 4 + 5 = 9
2021-05-02 17:39:00.721 [ForkJoinPool-1-worker-1] DEBUG AddTask - fork: ã€1, 3ã€ + ã€4, 5ã€ = ?
2021-05-02 17:39:00.724 [ForkJoinPool-1-worker-0] DEBUG AddTask - join: 3
2021-05-02 17:39:00.724 [ForkJoinPool-1-worker-2] DEBUG AddTask - join: ã€1, 2ã€ + ã€3, 3ã€ = 6
2021-05-02 17:39:00.724 [ForkJoinPool-1-worker-1] DEBUG AddTask - join: ã€1, 3ã€ + ã€4, 5ã€ = 15
15</code></pre>
<p>æµç¨‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62082/image-20210502174452155.png" class="" title="image-20210502174452155">

]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-5(å…±äº«æ¨¡å‹ä¹‹ä¸å¯å˜)</title>
    <url>/posts/53165/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ä¸å¯å˜ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡å­ä¸èƒ½å¤Ÿä¿®æ”¹å…¶å†…éƒ¨çŠ¶æ€ï¼ˆå±æ€§ï¼‰ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºä¸å­˜åœ¨å¹¶å‘ä¿®æ”¹ã€‚</p>
<h2 id="7-1-ä¸å¯å˜ç±»çš„ä½¿ç”¨"><a href="#7-1-ä¸å¯å˜ç±»çš„ä½¿ç”¨" class="headerlink" title="7.1 ä¸å¯å˜ç±»çš„ä½¿ç”¨"></a>7.1 ä¸å¯å˜ç±»çš„ä½¿ç”¨</h2><h3 id="7-1-1-é—®é¢˜æå‡º"><a href="#7-1-1-é—®é¢˜æå‡º" class="headerlink" title="7.1.1 é—®é¢˜æå‡º"></a>7.1.1 é—®é¢˜æå‡º</h3><p><code>SimpleDateFormat</code>ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸‹åˆ—ä»£ç æ‰§è¡Œæ—¶ä¼šäº§ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;SimpleDateFormat&quot;)
public class SimpleDateFormatDemo &#123;
    private static final SimpleDateFormat SDF = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;);
    public static void main(String[] args) &#123;
        String dateStr = &quot;2001-09-11 00:00:00.000&quot;;
        for (int i = 0; i &lt; 10; i++) &#123;
            new Thread(() -&gt; &#123;
                try &#123;
                    log.debug(SDF.parse(dateStr).toString());
                &#125; catch (ParseException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;).start();
        &#125;
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="java">java.lang.NumberFormatException: multiple points
    at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:1890)
    at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:110)
    at java.lang.Double.parseDouble(Double.java:538)
    at java.text.DigitList.getDouble(DigitList.java:169)
    at java.text.DecimalFormat.parse(DecimalFormat.java:2089)
    at java.text.SimpleDateFormat.subParse(SimpleDateFormat.java:1869)
    at java.text.SimpleDateFormat.parse(SimpleDateFormat.java:1514)
    at java.text.DateFormat.parse(DateFormat.java:364)
    at top.parak.immutable.SimpleDateFormatDemo.lambda$main$0(SimpleDateFormatDemo.java:22)
    at java.lang.Thread.run(Thread.java:748)
2021-04-29 11:30:23.116 [Thread-2] DEBUG SimpleDateFormat - Sun Sep 11 00:00:00 CST 1121
2021-04-29 11:30:23.117 [Thread-9] DEBUG SimpleDateFormat - Sun Sep 11 00:00:00 CST 1121
2021-04-29 11:30:23.117 [Thread-5] DEBUG SimpleDateFormat - Tue Sep 11 00:00:00 CST 2001</code></pre>
<h3 id="7-1-2-åŒæ­¥é”"><a href="#7-1-2-åŒæ­¥é”" class="headerlink" title="7.1.2 åŒæ­¥é”"></a>7.1.2 åŒæ­¥é”</h3><p>ä½¿ç”¨åŒæ­¥é”<code>synchronized</code>èƒ½è§£å†³å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚</p>
<pre><code class="java">synchronized (SDF) &#123;
    log.debug(SDF.parse(dateStr).toString());
&#125;</code></pre>
<h3 id="7-1-3-ä¸å¯å˜"><a href="#7-1-3-ä¸å¯å˜" class="headerlink" title="7.1.3 ä¸å¯å˜"></a>7.1.3 ä¸å¯å˜</h3><p>ä½¿ç”¨JDK1.8ä¸­çš„ä¸å¯å˜æ—¥æœŸæ ¼å¼ç±»<code>DateTimeFormatter</code>ã€‚</p>
<pre><code class="java">@Slf4j(topic = &quot;DateTimeFormatter&quot;)
public class DateTimeFormatterDemo &#123;
    private static final DateTimeFormatter DTF = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;);
    public static void main(String[] args) &#123;
        String dateStr = &quot;2001-09-11 00:00:00.000&quot;;
        for (int i = 0; i &lt; 10; i++) &#123;
            new Thread(() -&gt; &#123;
                TemporalAccessor date = DTF.parse(dateStr);
                log.debug(&quot;&#123;&#125;&quot;, date);
            &#125;).start();
        &#125;
    &#125;
&#125;</code></pre>
<h2 id="7-2-ä¸å¯å˜ç±»çš„è®¾è®¡"><a href="#7-2-ä¸å¯å˜ç±»çš„è®¾è®¡" class="headerlink" title="7.2 ä¸å¯å˜ç±»çš„è®¾è®¡"></a>7.2 ä¸å¯å˜ç±»çš„è®¾è®¡</h2><h3 id="7-1-1-finalçš„ä½¿ç”¨"><a href="#7-1-1-finalçš„ä½¿ç”¨" class="headerlink" title="7.1.1 finalçš„ä½¿ç”¨"></a>7.1.1 finalçš„ä½¿ç”¨</h3><p><code>Integer</code>ã€<code>Double</code>ã€<code>String</code>ã€<code>DateTimeFormatter</code>ä»¥åŠåŸºæœ¬ç±»å‹åŒ…è£…ç±»ï¼Œéƒ½æ˜¯ç”¨finalä¿®é¥°çš„ã€‚</p>
<ul>
<li>å±æ€§ç”¨finalä¿®é¥°ä¿è¯äº†è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ä¿®æ”¹</li>
<li>ç±»ç”¨finalä¿®é¥°ä¿è¯äº†è¯¥ç±»ä¸­çš„æ–¹æ³•ä¸èƒ½è¢«è¦†ç›–ï¼Œé˜²æ­¢å­ç±»æ— æ„é—´ç ´åä¸å¯å˜æ€§</li>
</ul>
<h3 id="7-2-2-ä¿æŠ¤æ€§æ‹·è´"><a href="#7-2-2-ä¿æŠ¤æ€§æ‹·è´" class="headerlink" title="7.2.2 ä¿æŠ¤æ€§æ‹·è´"></a>7.2.2 ä¿æŠ¤æ€§æ‹·è´</h3><p>ä»¥<code>String</code>çš„<code>substring</code>æ–¹æ³•ä¸ºä¾‹ï¼Œæ–¹æ³•çš„æœ€åè¿˜æ˜¯<code>new String</code></p>
<pre><code class="java">public String substring(int beginIndex, int endIndex) &#123;
    if (beginIndex &lt; 0) &#123;
        throw new StringIndexOutOfBoundsException(beginIndex);
    &#125;
    if (endIndex &gt; value.length) &#123;
        throw new StringIndexOutOfBoundsException(endIndex);
    &#125;
    int subLen = endIndex - beginIndex;
    if (subLen &lt; 0) &#123;
        throw new StringIndexOutOfBoundsException(subLen);
    &#125;
    return ((beginIndex == 0) &amp;&amp; (endIndex == value.length)) ? this
        : new String(value, beginIndex, subLen);
&#125;</code></pre>
<p>è¿™ç§åˆ›å»ºå‰¯æœ¬å¯¹è±¡æ¥é¿å…å…±äº«çš„æ‰‹æ®µç§°ä¸ºä¿æŠ¤æ€§æ‹·è´ï¼ˆdefensive copyï¼‰ã€‚</p>
<h3 id="7-2-3-æ¨¡å¼ä¹‹äº«å…ƒ"><a href="#7-2-3-æ¨¡å¼ä¹‹äº«å…ƒ" class="headerlink" title="7.2.3 æ¨¡å¼ä¹‹äº«å…ƒ"></a>7.2.3 æ¨¡å¼ä¹‹äº«å…ƒ</h3><p>å®šä¹‰ï¼šè¿ç”¨å…±äº«æŠ€æœ¯æ¥æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦å¯¹è±¡çš„å¤ç”¨ã€‚</p>
<p>ä¼˜åŠ¿ï¼šç›¸åŒå¯¹è±¡åªä¿å­˜ä¸€ä»½ï¼Œè¿™é™ä½äº†ç³»ç»Ÿä¸­å¯¹è±¡çš„æ•°é‡ï¼Œé™ä½å†…å­˜å‹åŠ›ã€‚</p>
<p>åœ¨JDKä¸­<code>Boolean</code>ã€<code>Byte</code>ã€<code>Short</code>ã€<code>Long</code>ã€<code>Character</code>ç­‰åŒ…è£…ç±»æä¾›äº†<code>valueOf</code>æ–¹æ³•ã€‚</p>
<p>ä¾‹å¦‚<code>Longh.valueOf()</code>ï¼Œåœ¨-128~127ä¹‹é—´çš„Longå¯¹è±¡ï¼Œåœ¨è¿™ä¸ªèŒƒå›´å†…ä¼šç”¨ç¼“å­˜å¯¹è±¡ï¼Œè¶…è¿‡è¿™ä¸ªèŒƒå›´ï¼Œæ‰ä¼šä¿¡ä»¶Longå¯¹è±¡ã€‚</p>
<pre><code class="java">public static Long valueOf(long l) &#123;
    final int offset = 128;
    if (l &gt;= -128 &amp;&amp; l &lt;= 127) &#123; // will cache
        return LongCache.cache[(int)l + offset];
    &#125;
    return new Long(l);
&#125;</code></pre>
<p>æ³¨æ„ï¼š</p>
<ul>
<li><code>Byte</code>ã€<code>Short</code>ã€<code>Long</code>ç¼“å­˜çš„èŒƒå›´ï¼š-128~127</li>
<li><code>Character</code>ç¼“å­˜çš„èŒƒå›´ï¼š0~127</li>
<li><code>Integer</code>çš„é»˜è®¤èŒƒå›´ï¼š-128~127ï¼Œæœ€å°å€¼ä¸èƒ½å˜ï¼Œæœ€å¤§å€¼é€šè¿‡è™šæ‹Ÿæœºå‚æ•°<code>-Djava.lang.Integer.IntegerCache.high</code>æ¥æ”¹å˜ã€‚</li>
<li><code>Boolean</code>ç¼“å­˜ï¼štrue / false</li>
</ul>
<h3 id="7-2-4-DIYè¿æ¥æ± "><a href="#7-2-4-DIYè¿æ¥æ± " class="headerlink" title="7.2.4 DIYè¿æ¥æ± "></a>7.2.4 DIYè¿æ¥æ± </h3><p>ä¾‹å¦‚ï¼šä¸€ä¸ªçº¿ä¸Šå•†åŸåº”ç”¨ï¼ŒQPS è¾¾åˆ°æ•°åƒï¼Œå¦‚æœæ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºå’Œå…³é—­æ•°æ®åº“è¿æ¥ï¼Œæ€§èƒ½ä¼šå—åˆ°æå¤§å½±å“ã€‚ è¿™æ—¶é¢„å…ˆåˆ›å»ºå¥½ä¸€æ‰¹è¿æ¥ï¼Œæ”¾å…¥è¿æ¥æ± ã€‚ä¸€æ¬¡è¯·æ±‚åˆ°è¾¾åï¼Œä»è¿æ¥æ± è·å–è¿æ¥ï¼Œä½¿ç”¨å®Œæ¯•åå†è¿˜å›è¿æ¥æ± ï¼Œè¿™æ ·æ—¢èŠ‚çº¦äº†è¿æ¥çš„åˆ›å»ºå’Œå…³é—­æ—¶é—´ï¼Œä¹Ÿå®ç°äº†è¿æ¥çš„é‡ç”¨ï¼Œä¸è‡³äºè®©åºå¤§çš„è¿æ¥æ•°å‹å®æ•°æ®åº“ã€‚</p>
<pre><code class="java">import java.sql.*;
import java.util.Map;
import java.util.Properties;
import java.util.Random;
import java.util.concurrent.Executor;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicIntegerArray;

/**
 * @author KHighness
 * @since 2021-04-29
 */

public class PoolDemo &#123;
    public static void main(String[] args) &#123;
        Pool pool = new Pool(2);
        for (int i = 0; i &lt; 5; i++) &#123;
            new Thread(() -&gt; &#123;
               Connection connection = pool.get();
               try &#123;
                   TimeUnit.MILLISECONDS.sleep(new Random().nextInt(1000));
               &#125; catch (InterruptedException e) &#123;
                   e.printStackTrace();
               &#125;
               pool.free(connection);
            &#125;, &quot;T-&quot; + (i + 1)).start();
        &#125;
    &#125;
&#125;

@Slf4j(topic = &quot;Pool&quot;)
class Pool &#123;

    /**
     * è¿æ¥æ± å¤§å°
     */
    private final int poolSize;

    /**
     * è¿æ¥æ•°ç»„
     */
    private final Connection[] connections;

    /**
     * è¿æ¥çŠ¶æ€æ•°ç»„
     */
    private final AtomicIntegerArray states;

    /**
     * åˆå§‹åŒ–è¿æ¥æ± 
     */
    public Pool(int pollSize) &#123;
        this.poolSize = pollSize;
        connections = new Connection[pollSize];
        states = new AtomicIntegerArray(new int[pollSize]);
        for (int i = 0; i &lt; pollSize; i++) &#123;
            connections[i] = new ParaKConnection(&quot;è¿æ¥&quot; + (i + 1));
        &#125;
    &#125;

    /**
     * è·å–ä¸€ä¸ªè¿æ¥
     */
    public Connection get() &#123;
        while (true) &#123;
            // æŸ¥çœ‹æ˜¯å¦æœ‰ç©ºé—²è¿æ¥
            for (int i = 0; i &lt; poolSize; i++) &#123;
                if (states.get(i) == 0) &#123;
                    if (states.compareAndSet(i, 0, 1)) &#123;
                        log.debug(&quot;get &#123;&#125;&quot;, connections[i]);
                        return connections[i];
                    &#125;
                &#125;
            &#125;
            // æ²¡æœ‰ç©ºé—²è¿æ¥åˆ™ç­‰å¾…
            synchronized (this) &#123;
                try &#123;
                    log.debug(&quot;wait...&quot;);
                    this.wait();
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125;
    &#125;

    /**
     * é‡Šæ”¾ä¸€ä¸ªè¿æ¥
     */
    public void free(Connection connection) &#123;
        for (int i = 0; i &lt; poolSize; i++) &#123;
            if (connections[i] == connection) &#123;
                states.set(i, 0);
                synchronized (this) &#123;
                    log.debug(&quot;free &#123;&#125;&quot;, connection);
                    this.notifyAll();
                &#125;
                break;
            &#125;
        &#125;
    &#125;
&#125;

class ParaKConnection implements Connection &#123;

    private String name;

    public ParaKConnection(String name) &#123;
        this.name = name;
    &#125;

    @Override
    public String toString() &#123;
        return &quot;ParaKConnection[&quot; +
                &quot;name=&#39;&quot; + name + &#39;\&#39;&#39; +
                &#39;]&#39;;
    &#125;

    // ...
&#125;</code></pre>
<p>å¯æ”¹è¿›ç‚¹ï¼š</p>
<ul>
<li>è¿æ¥çš„åŠ¨æ€å¢é•¿ä¸æ”¶ç¼©</li>
<li>è¿æ¥ä¿æ´»ï¼ˆå¯ç”¨æ€§æ£€æµ‹ï¼‰</li>
<li>ç­‰å¾…è¶…æ—¶å¤„ç†</li>
<li>åˆ†å¸ƒå¼hash</li>
</ul>
<h2 id="7-3-finalåŸç†"><a href="#7-3-finalåŸç†" class="headerlink" title="7.3 finalåŸç†"></a>7.3 finalåŸç†</h2><h3 id="7-3-1-è®¾ç½®finalå˜é‡çš„åŸç†"><a href="#7-3-1-è®¾ç½®finalå˜é‡çš„åŸç†" class="headerlink" title="7.3.1 è®¾ç½®finalå˜é‡çš„åŸç†"></a>7.3.1 è®¾ç½®finalå˜é‡çš„åŸç†</h3><p>å¯¹äºä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="java">public class FinalDemo &#123;
    final int k = 3;
&#125;</code></pre>
<p>initå­—èŠ‚ç å¦‚ä¸‹ï¼š</p>
<pre><code>0 aload_0
1 invokespecial #1 &lt;java/lang/Object.&lt;init&gt;&gt;
4 aload_0
5 iconst_3
6 putfield #2 &lt;top/parak/immutable/FinalDemo.k&gt;
&lt;================== å†™å±éšœ
9 return</code></pre>
<p>å‘ç°finalå˜é‡çš„èµ‹å€¼ä¹Ÿä¼šé€šè¿‡putfieldæŒ‡ä»¤æ¥å®Œæˆï¼ŒåŒæ ·åœ¨è¿™æ¡æŒ‡ä»¤ä¹‹åä¹Ÿä¼šåŠ å…¥å†™å±éšœï¼Œä¿è¯åœ¨å…¶ä»–çº¿ç¨‹è¯»åˆ°å®ƒçš„å€¼æ—¶ä¸ä¼šå‡ºç°ä¸º0çš„æƒ…å†µã€‚</p>
<h3 id="7-3-2-è·å–finalå˜é‡çš„åŸç†"><a href="#7-3-2-è·å–finalå˜é‡çš„åŸç†" class="headerlink" title="7.3.2 è·å–finalå˜é‡çš„åŸç†"></a>7.3.2 è·å–finalå˜é‡çš„åŸç†</h3><p>å¯¹äºä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="java">public class FinalDemo &#123;
    int a = 3;
    static int A = 33333;
    final int b = 3;
    final static int B = 33333;

    public static void main(String[] args) &#123;
        System.out.println(new FinalDemo().a);
        System.out.println(A);
        System.out.println(new FinalDemo().b);
        System.out.println(B);
    &#125;
&#125;</code></pre>
<p>mainå­—èŠ‚ç å¦‚ä¸‹ï¼š</p>
<pre><code> # è·å–æ‰“å°æµ
 0 getstatic #4 &lt;java/lang/System.out&gt;

 # æ‰“å°a
 3 new #5 &lt;top/parak/immutable/FinalDemo&gt;
 6 dup
 7 invokespecial #6 &lt;top/parak/immutable/FinalDemo.&lt;init&gt;&gt;
10 getfield #2 &lt;top/parak/immutable/FinalDemo.a&gt;
13 invokevirtual #7 &lt;java/io/PrintStream.println&gt;

# æ‰“å°A
16 getstatic #4 &lt;java/lang/System.out&gt;
# ä¸åŠ finalï¼Œè·å–Aå˜é‡çš„æ—¶å€™ä½¿ç”¨getStaticï¼Œä½¿ç”¨å…±äº«å†…å­˜
19 getstatic #8 &lt;top/parak/immutable/FinalDemo.A&gt;  
22 invokevirtual #7 &lt;java/io/PrintStream.println&gt;
25 getstatic #4 &lt;java/lang/System.out&gt;

# æ‰“å°b
28 new #5 &lt;top/parak/immutable/FinalDemo&gt;
31 dup
32 invokespecial #6 &lt;top/parak/immutable/FinalDemo.&lt;init&gt;&gt;
35 invokevirtual #9 &lt;java/lang/Object.getClass&gt;
38 pop
39 iconst_3
40 invokevirtual #7 &lt;java/io/PrintStream.println&gt;

# æ‰“å°B
43 getstatic #4 &lt;java/lang/System.out&gt;
# åŠ äº†finalï¼Œæ²¡æœ‰ç›´æ¥å»è·å–Aå˜é‡ï¼Œè€Œæ˜¯å°†Aå¤åˆ¶åˆ°å½“å‰Javaè™šæ‹Ÿæœºæ ˆä¸­
46 ldc #10 &lt;33333&gt;
48 invokevirtual #7 &lt;java/io/PrintStream.println&gt;
51 return</code></pre>
<p>é€šè¿‡è§‚å¯Ÿå­—èŠ‚ç å¯ä»¥å‘ç°ï¼Œfinalä¿®é¥°çš„å˜é‡æœ‰æ ˆå†…å­˜è¯»å–é€Ÿåº¦çš„ä¼˜åŒ–ã€‚</p>
<h2 id="7-4-æ— çŠ¶æ€"><a href="#7-4-æ— çŠ¶æ€" class="headerlink" title="7.4 æ— çŠ¶æ€"></a>7.4 æ— çŠ¶æ€</h2><p>è®¾è®¡Servletæ—¶ä¸ºäº†ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ï¼Œéƒ½ä¼šæœ‰è¿™æ ·çš„å»ºè®®ï¼Œä¸è¦ä¸ºServletè®¾ç½®æˆå‘˜å˜é‡ï¼Œè¿™ç§æ²¡æœ‰ä»»ä½•æˆå‘˜å˜é‡çš„ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>å› ä¸ºæˆå‘˜å˜é‡ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥ç§°ä¸ºæ— çŠ¶æ€ä¿¡æ¯ï¼Œå› ä¸ºæ²¡æœ‰æˆå‘˜å˜é‡å°±ç§°ä¹‹ä¸ºã€æ— çŠ¶æ€ã€‘ã€‚</p>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-4(å…±äº«æ¨¡å‹ä¹‹æ— é”)</title>
    <url>/posts/62265/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>ä¸»è¦å†…å®¹</p>
</blockquote>
<ul>
<li>CASä¸volatile</li>
<li>åŸå­æ•´æ•°</li>
<li>åŸå­å¼•ç”¨</li>
<li>åŸå­ç´¯åŠ å™¨</li>
<li>Unsafe</li>
</ul>
<h2 id="4-1-é—®é¢˜æå‡º"><a href="#4-1-é—®é¢˜æå‡º" class="headerlink" title="4.1 é—®é¢˜æå‡º"></a>4.1 é—®é¢˜æå‡º</h2><h3 id="4-1-1-æå–æ¬¾é—®é¢˜"><a href="#4-1-1-æå–æ¬¾é—®é¢˜" class="headerlink" title="4.1.1 æå–æ¬¾é—®é¢˜"></a>4.1.1 æå–æ¬¾é—®é¢˜</h3><p>æœ‰å¦‚ä¸‹éœ€æ±‚ï¼Œä¿è¯accountã€withdrawå–æ¬¾æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<pre><code class="java">interface Account &#123;
    // è·å–ä½™é¢
    Integer geBalance();
    // å–æ¬¾
    void withdraw(Integer amount);

    /**
     * æ–¹æ³•å†…ä¼šå¯åŠ¨1000ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åš-10å…ƒæ“ä½œ
     * å¦‚æœåˆå§‹ä½™é¢ä¸º10000ï¼Œé‚£ä¹ˆæ­£ç¡®çš„ç»“æœåº”è¯¥æ˜¯0
     * @param account è´¦æˆ·
     */
    static void demo(Account account) &#123;
        List&lt;Thread&gt; ts = new ArrayList&lt;&gt;();
        for (int i = 0; i &lt; 1000; i++) &#123;
            ts.add(new Thread(() -&gt; &#123;
                account.withdraw(10);
            &#125;));
        &#125;
        long start = System.nanoTime();
        ts.forEach(Thread::start);
        ts.forEach(t -&gt; &#123;
            try &#123;
                t.join();
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;);
        ts.forEach(t -&gt; &#123;
            try &#123;
                t.join();
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;);
        long end = System.nanoTime();
        System.out.printf(&quot;final balance: %d, spend time(ms): %d] &quot;, account.geBalance(), (end - start) / 1000_000);
    &#125;
&#125;</code></pre>
<p>æ˜¾ç„¶ä»¥ä¸Šåšæ³•æ— æ³•ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<h3 id="4-1-2-é”è§£å†³æ–¹æ¡ˆ"><a href="#4-1-2-é”è§£å†³æ–¹æ¡ˆ" class="headerlink" title="4.1.2 é”è§£å†³æ–¹æ¡ˆ"></a>4.1.2 é”è§£å†³æ–¹æ¡ˆ</h3><p>ä¿æŠ¤å…±äº«å˜é‡ï¼Œç»™ä¸´ç•ŒåŒºåŠ é”ã€‚</p>
<pre><code class="java">class AccountSafe implements Account &#123;
    // ä½™é¢
    private Integer balance;

    public AccountSafe(Integer balance) &#123;
        this.balance = balance;
    &#125;

    @Override
    public Integer geBalance() &#123;
        return this.balance;
    &#125;

    @Override
    public void withdraw(Integer amount) &#123;
        synchronized (this) &#123;
            this.balance -= amount;
        &#125;
    &#125;
&#125;</code></pre>
<h3 id="4-1-2-æ— é”è§£å†³æ–¹æ¡ˆ"><a href="#4-1-2-æ— é”è§£å†³æ–¹æ¡ˆ" class="headerlink" title="4.1.2 æ— é”è§£å†³æ–¹æ¡ˆ"></a>4.1.2 æ— é”è§£å†³æ–¹æ¡ˆ</h3><p>ä½¿ç”¨åŸå­æ•´æ•°è¿›è¡ŒCASæ“ä½œï¼š</p>
<pre><code class="java">class AccountCAS implements Account &#123;
    private AtomicInteger balance;

    public AccountCAS(Integer balance) &#123;
        this.balance = new AtomicInteger(balance);
    &#125;

    @Override
    public Integer geBalance() &#123;
        return balance.get();
    &#125;

    @Override
    public void withdraw(Integer amount) &#123;
        while (true) &#123;
            // è·å–ä½™é¢çš„æœ€æ–°å€¼
            int prev = this.balance.get();
            // ä¿®æ”¹åçš„ä½™é¢
            int next = prev - amount;
            // åŒæ­¥åˆ°ä¸»å­˜
            // CAS(é¢„æœŸå€¼ï¼Œä¿®æ”¹å€¼) =&gt; boolean(æ˜¯å¦ä¿®æ”¹æˆåŠŸ)
            if (this.balance.compareAndSet(prev, next)) &#123;
                break;
            &#125;
        &#125;
    &#125;
&#125;</code></pre>
<h3 id="4-1-3-æµ‹è¯•"><a href="#4-1-3-æµ‹è¯•" class="headerlink" title="4.1.3 æµ‹è¯•"></a>4.1.3 æµ‹è¯•</h3><p>ç¼–å†™ä»¥ä¸‹ä»£ç è¿›è¡Œæµ‹è¯•ï¼š</p>
<pre><code class="java">public class AccountDemo &#123;
    public static void main(String[] args) &#123;
        System.out.print(&quot;[Unsafe =&gt; &quot;);
        Account a1 = new AccountUnsafe(10000);
        Account.demo(a1);
        System.out.print(&quot;[synchronized =&gt; &quot;);
        Account a2 = new AccountSafe(10000);
        Account.demo(a2);
        System.out.print(&quot;[compareAndSet =&gt; &quot;);
        Account a3 = new AccountCAS(10000);
        Account.demo(a3);
        System.out.println();
    &#125;
&#125;</code></pre>
<p>æµ‹è¯•è„šæœ¬ï¼š</p>
<pre><code class="powershell">for ($i=0; $i -le 10; $i++) &#123; java top.parak.none.AccountDemo &#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62265/image-20210426225654053.png" class="" title="image-20210426225654053">



<h3 id="4-1-5-compareAndSet"><a href="#4-1-5-compareAndSet" class="headerlink" title="4.1.5 compareAndSet"></a>4.1.5 compareAndSet</h3><p>compareAndSetï¼Œç®€ç§°CASï¼ˆä¹Ÿæœ‰Compare And Swapçš„è¯´æ³•ï¼‰ï¼Œå®ƒå¿…é¡»æ˜¯åŸå­æ“ä½œã€‚</p>
<pre><code class="java">while (true) &#123;
    // è·å–ä½™é¢çš„æœ€æ–°å€¼
    int prev = this.balance.get();
    // ä¿®æ”¹åçš„ä½™é¢
    int next = prev - amount;
    // åŒæ­¥åˆ°ä¸»å­˜
    // CAS(é¢„æœŸå€¼ï¼Œä¿®æ”¹å€¼) =&gt; boolean(æ˜¯å¦ä¿®æ”¹æˆåŠŸ)
    if (this.balance.compareAndSet(prev, next)) &#123;
        break;
    &#125;
&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62265/image-20210426230136937.png" class="" title="image-20210426230136937">



<h2 id="4-2-CASä¸volatile"><a href="#4-2-CASä¸volatile" class="headerlink" title="4.2 CASä¸volatile"></a>4.2 CASä¸volatile</h2><h3 id="4-2-1-volatile"><a href="#4-2-1-volatile" class="headerlink" title="4.2.1 volatile"></a>4.2.1 volatile</h3><p>è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨volatileä¿®é¥°ã€‚</p>
<p>å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œå®ƒå¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œvolatileå˜é‡éƒ½æ˜¯æ“ä½œä¸»å­˜ã€‚å³ä¸€ä¸ªçº¿ç¨‹å¯¹volatileå˜é‡çš„ä¿®æ”¹ï¼Œå¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ã€‚</p>
<p>CASå¿…é¡»å€ŸåŠ©volatileæ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°ã€æ¯”è¾ƒå¹¶äº¤æ¢ã€‘çš„æ•ˆæœã€‚</p>
<h3 id="4-2-2-ä¸ºä»€ä¹ˆCAS-é‡è¯•æ•ˆç‡é«˜ï¼Ÿ"><a href="#4-2-2-ä¸ºä»€ä¹ˆCAS-é‡è¯•æ•ˆç‡é«˜ï¼Ÿ" class="headerlink" title="4.2.2 ä¸ºä»€ä¹ˆCAS+é‡è¯•æ•ˆç‡é«˜ï¼Ÿ"></a>4.2.2 ä¸ºä»€ä¹ˆCAS+é‡è¯•æ•ˆç‡é«˜ï¼Ÿ</h3><ul>
<li>åœ¨æ— é”æƒ…å†µä¸‹ï¼Œå³ä½¿é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹å§‹ç»ˆåœ¨é«˜é€Ÿè¿è¡Œï¼Œæ²¡æœ‰åœæ­‡ï¼Œè€Œsynchronizedä¼šè®©çº¿ç¨‹åœ¨æ²¡æœ‰è·å¾—é”çš„æ—¶å€™ï¼Œå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡ã€‚</li>
<li>ä½†æ˜¯ï¼Œåœ¨æ— é”æƒ…å†µä¸‹ï¼Œå› ä¸ºçº¿ç¨‹è¦ä¿æŒè¿è¡Œï¼Œéœ€è¦é¢å¤–CPUçš„æ”¯æŒï¼ŒCPUåœ¨è¿™é‡Œå°±å¥½æ¯”é«˜é€Ÿè·‘é“ï¼Œæ²¡æœ‰é¢å¤–çš„è·‘é“ï¼Œçº¿ç¨‹æƒ³é«˜é€Ÿè¿è¡Œä¹Ÿæ— ä»è°ˆèµ·ï¼Œè™½ç„¶ä¹Ÿä¸ä¼šè¿›å…¥é˜»å¡ï¼Œä½†ç”±äºæ²¡æœ‰åˆ†åˆ°æ—¶é—´ç‰‡ï¼Œä»ç„¶ä¼šè¿›å…¥å¯è¿è¡ŒçŠ¶æ€ï¼Œè¿˜æ˜¯ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li>
</ul>
<h3 id="4-2-3-CASåº”ç”¨åœºæ™¯"><a href="#4-2-3-CASåº”ç”¨åœºæ™¯" class="headerlink" title="4.2.3 CASåº”ç”¨åœºæ™¯"></a>4.2.3 CASåº”ç”¨åœºæ™¯</h3><p>ç»“åˆCASå’Œvolatileå¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºçº¿ç¨‹æ•°å°‘ã€å¤šæ ¸CPUçš„åœºæ™¯ä¸‹ï¼š</p>
<ul>
<li>CASæ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³ï¼šéå¸¸ä¹è§‚ï¼Œå‡è®¾æ²¡æœ‰åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†å½“å‰çº¿ç¨‹å°±å†æ¬¡é‡è¯•ã€‚</li>
<li>synchronizedæ˜¯åŸºäºæ‚²è§‚é”çš„æ€æƒ³ï¼šéå¸¸æ‚²è§‚ï¼Œæé˜²å…¶ä»–çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå½“å‰çº¿ç¨‹è·å–èµ„æºå°±ç«‹é©¬ä¸Šé”ï¼Œå…¶ä»–äº‰æŠ¢èµ„æºå¤±è´¥çš„çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä¿®æ”¹ç»“æŸæ‰å¼€é”ï¼Œ</li>
<li>CASä½“ç°çš„æ˜¯æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘<ul>
<li>å› ä¸ºæ²¡æœ‰ä½¿ç”¨æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘ï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ã€‚</li>
<li>ä½†æ˜¯å¦‚æœç«äº‰æ¿€çƒˆï¼Œé‡è¯•å¿…ç„¶ é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šæ”¶åˆ°å½±å“ã€‚</li>
</ul>
</li>
</ul>
<h3 id="4-2-4-CASç‰¹ç‚¹"><a href="#4-2-4-CASç‰¹ç‚¹" class="headerlink" title="4.2.4 CASç‰¹ç‚¹"></a>4.2.4 CASç‰¹ç‚¹</h3><p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¯ä»¥ä¿è¯å˜é‡æ“ä½œçš„åŸå­æ€§</li>
<li>å¹¶å‘é‡ä½æ—¶ï¼ŒCASæ•ˆç‡é«˜äºsynchronized</li>
<li>åœ¨çº¿ç¨‹å¯¹å…±äº«èµ„æºå ç”¨æ—¶é—´è¾ƒçŸ­çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨CASæœºåˆ¶æ•ˆç‡ä¹Ÿä¼šè¾ƒé«˜</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ— æ³•è§£å†³ABAé—®é¢˜</li>
<li>å¯èƒ½ä¼šæ¶ˆè€—è¾ƒé«˜çš„CPU</li>
<li>ä¸èƒ½ä¿è¯ä»£ç å—çš„åŸå­æ€§</li>
</ul>
<h2 id="4-3-åŸå­æ•´æ•°"><a href="#4-3-åŸå­æ•´æ•°" class="headerlink" title="4.3 åŸå­æ•´æ•°"></a>4.3 åŸå­æ•´æ•°</h2><blockquote>
<p>JUCæä¾›</p>
</blockquote>
<ul>
<li><code>AtomicBoolean</code></li>
<li><code>AtomicInteger</code></li>
<li><code>AtomicLong</code></li>
</ul>
<blockquote>
<p><code>AtomicInteger</code>-API</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62265/image-20210427144944862.png" class="" title="image-20210427144944862">



<h2 id="4-4-åŸå­å¼•ç”¨"><a href="#4-4-åŸå­å¼•ç”¨" class="headerlink" title="4.4 åŸå­å¼•ç”¨"></a>4.4 åŸå­å¼•ç”¨</h2><blockquote>
<p>JUCæä¾›</p>
</blockquote>
<ul>
<li><code>AtomicReference</code>ï¼šæ™®é€šåŸå­å¼•ç”¨ç±»å‹ï¼Œå¯¹å¯¹è±¡è¿›è¡ŒåŸå­æ“ä½œ</li>
<li><code>AtomicStampedReference</code>ï¼šå¸¦intç±»å‹ç‰ˆæœ¬æˆ³çš„åŸå­å¼•ç”¨ç±»å‹ï¼Œè®°å½•æ›´æ”¹æ¬¡æ•°</li>
<li><code>AtomicMarkableReference</code>ï¼šå¸¦booleanç±»å‹ç‰ˆæœ¬æˆ³çš„åŸå­å¼•ç”¨ç±»å‹ï¼Œè®°å½•æ˜¯å¦æ›´æ”¹</li>
</ul>
<p>ä½œç”¨ï¼šä¿è¯å¼•ç”¨ç±»å‹çš„å…±äº«å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>ä½¿ç”¨<code>BigDemical</code>å®ç°æå–æ¬¾é—®é¢˜çš„çº¿ç¨‹å®‰å…¨è§£å†³æ–¹æ¡ˆï¼š</p>
<pre><code class="java">class DecimalAccountCAS implements DecimalAccount &#123;
    private AtomicReference&lt;BigDecimal&gt; balance;

    public DecimalAccountCAS(BigDecimal balance) &#123;
        this.balance = new AtomicReference&lt;&gt;(balance);
    &#125;

    @Override
    public BigDecimal getBalance() &#123;
        return balance.get();
    &#125;

    @Override
    public void withdraw(BigDecimal amount) &#123;
        while (true) &#123;
            BigDecimal prev = balance.get();
            BigDecimal next = prev.subtract(amount);
            if (balance.compareAndSet(prev, next)) &#123;
                break;
            &#125;
        &#125;
    &#125;
&#125;

interface DecimalAccount &#123;
    BigDecimal getBalance();
    void withdraw(BigDecimal amount);
&#125;</code></pre>
<h3 id="4-4-1-ABAé—®é¢˜"><a href="#4-4-1-ABAé—®é¢˜" class="headerlink" title="4.4.1 ABAé—®é¢˜"></a>4.4.1 ABAé—®é¢˜</h3><p>å¦‚ä¸‹ç¨‹åºæ‰€ç¤ºï¼Œè™½ç„¶åœ¨<code>other</code>æ–¹æ³•ä¸­å­˜åœ¨ä¸¤ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œä½†æ˜¯ç»è¿‡äº†ä¸¤è½®ä¿®æ”¹åˆå˜æˆäº†åŸå€¼ï¼Œmainçº¿ç¨‹å¯¹ä¿®æ”¹å…±äº«å˜é‡çš„è¿‡ç¨‹æ˜¯ä¸å¯è§çš„ï¼Œè¿™ç§æ“ä½œå¯¹ä¸šåŠ¡ä»£ç å¹¶æ— å½±å“ã€‚</p>
<pre><code class="java">@Slf4j(topic = &quot;ABAAtomicReference&quot;)
public class ABAAtomicReferenceDemo &#123;
    private static AtomicReference&lt;String&gt; ref = new AtomicReference&lt;&gt;(&quot;A&quot;);

    public static void main(String[] args) throws InterruptedException &#123;
        log.debug(&quot;main start...&quot;);
        String prev = ref.get();
        other();
        TimeUnit.SECONDS.sleep(1);
        log.debug(&quot;change A -&gt; K ? &#123;&#125;&quot;, ref.compareAndSet(prev, &quot;K&quot;));
    &#125;

    private static void other() &#123;
        new Thread(() -&gt; log.debug(&quot;change A -&gt; B ? &#123;&#125;&quot;, ref.compareAndSet(ref.get(), &quot;B&quot;)), &quot;B&quot;).start();
        new Thread(() -&gt; log.debug(&quot;change B -&gt; A ? &#123;&#125;&quot;, ref.compareAndSet(ref.get(), &quot;A&quot;)), &quot;A&quot;).start();
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>2021-04-27 17:29:12.538 [main] DEBUG ABAAtomicReference - main start...
2021-04-27 17:29:12.575 [A] DEBUG ABAAtomicReference - change B -&gt; A ? true
2021-04-27 17:29:12.575 [B] DEBUG ABAAtomicReference - change A -&gt; B ? true
2021-04-27 17:29:13.580 [main] DEBUG ABAAtomicReference - change A -&gt; K ? true</code></pre>
<p>è™½ç„¶ABAå¯¹ä¸šåŠ¡æ²¡æœ‰å½±å“ï¼Œä½†æ˜¯å¦‚ä½•è®©ä¸»çº¿ç¨‹æ„ŸçŸ¥åˆ°å…¶ä»–çº¿ç¨‹çš„ä¿®æ”¹å‘¢ï¼Ÿ</p>
<h3 id="4-4-2-AtomicStampedReference"><a href="#4-4-2-AtomicStampedReference" class="headerlink" title="4.4.2 AtomicStampedReference"></a>4.4.2 AtomicStampedReference</h3><p>è§£å†³ABAé—®é¢˜ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;ABAAtomicStampedReference&quot;)
public class ABAAtomicStampedReferenceDemo &#123;
   private static AtomicStampedReference&lt;String&gt; ref = new AtomicStampedReference&lt;&gt;(&quot;A&quot;, 0);

    public static void main(String[] args) throws InterruptedException &#123;
        log.debug(&quot;main start...&quot;);
        int stamp = ref.getStamp();
        other();
        TimeUnit.SECONDS.sleep(1);
        boolean res = ref.compareAndSet(ref.getReference(), &quot;K&quot;, stamp, stamp + 1);
        log.debug(&quot;change A -&gt; K ? &#123;&#125;&quot;, res);
    &#125;

    private static void other() &#123;
        new Thread(() -&gt; &#123;
            int stamp = ref.getStamp();
            boolean res = ref.compareAndSet(ref.getReference(), &quot;B&quot;, stamp, stamp + 1);
            log.debug(&quot;change A -&gt; B ? &#123;&#125;&quot;, res);
        &#125;).start();
        new Thread(() -&gt; &#123;
            int stamp = ref.getStamp();
            boolean res = ref.compareAndSet(ref.getReference(), &quot;A&quot;, stamp, stamp + 1);
            log.debug(&quot;change B -&gt; A ? &#123;&#125;&quot;, res);
        &#125;).start();
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>2021-04-27 18:18:00.754 [main] DEBUG ABAAtomicStampedReference - main start...
2021-04-27 18:18:00.787 [A] DEBUG ABAAtomicStampedReference - change B -&gt; A ? true
2021-04-27 18:18:00.787 [B] DEBUG ABAAtomicStampedReference - change A -&gt; B ? true
2021-04-27 18:18:01.792 [main] DEBUG ABAAtomicStampedReference - change A -&gt; K ? false</code></pre>
<h3 id="4-4-3-AtomMarkableReference"><a href="#4-4-3-AtomMarkableReference" class="headerlink" title="4.4.3 AtomMarkableReference"></a>4.4.3 AtomMarkableReference</h3><p>ä¸å…³å¿ƒå¼•ç”¨å˜é‡æ›´æ”¹äº†å‡ æ¬¡ï¼Œåªæ˜¯å•çº¯çš„å…³å¿ƒæ˜¯å¦æ›´æ”¹è¿‡ã€‚</p>
<p>æ¡ˆä¾‹ï¼š</p>
<p>å®¶é‡Œæœ‰æ¸…æ´æœºå™¨äººå’Œä¿æ´é˜¿å§¨ï¼Œåƒåœ¾è¢‹æ»¡æ—¶ï¼Œéœ€è¦æ›´æ¢ï¼Œæœºå™¨äººæ¢äº†é˜¿å§¨åˆ™ä¸éœ€è¦æ¢ï¼Œåä¹‹äº¦ç„¶ã€‚</p>
<pre><code class="java">@Slf4j(topic = &quot;ABAAtomicMarkableReference&quot;)
public class ABAAtomicMarkableReferenceDemo &#123;
    private static GarbageBag bag = new GarbageBag(&quot;è£…æ»¡åƒåœ¾&quot;);
    private static AtomicMarkableReference&lt;GarbageBag&gt; ref = new AtomicMarkableReference&lt;&gt;(bag, true);

    public static void main(String[] args) throws InterruptedException &#123;
        log.debug(&quot;å®¶é‡Œéœ€è¦æ¢åƒåœ¾è¢‹...&quot;);
        GarbageBag prev = ref.getReference();
        robot();
        TimeUnit.MILLISECONDS.sleep(10);
        aunt();
        TimeUnit.MILLISECONDS.sleep(10);
        log.debug(ref.getReference().toString());
    &#125;

    // æ¸…æ´æœºå™¨äºº
    private static void robot() &#123;
        new Thread(() -&gt; &#123;
            log.debug(&quot;æ¸…æ´æœºå™¨äººå¼€å§‹æ‰“æ‰«å«ç”Ÿ...&quot;);
            boolean res = ref.compareAndSet(ref.getReference(), new GarbageBag(&quot;æ–°åƒåœ¾è¢‹&quot;),
                    true, false);
            log.debug(&quot;æœºå™¨äººæ˜¯å¦æ¢äº†åƒåœ¾è¢‹ ? &#123;&#125;&quot;, res);
        &#125;, &quot;robot&quot;).start();
    &#125;

    // ä¿æ´é˜¿å§¨
    private static void aunt() &#123;
        new Thread(() -&gt; &#123;
            log.debug(&quot;ä¿æ´é˜¿å§¨å¼€å§‹æ‰“æ‰«å«ç”Ÿ...&quot;);
            bag.setDesc(&quot;ç©ºåƒåœ¾è¢‹&quot;);
            boolean res = ref.compareAndSet(ref.getReference(), new GarbageBag(&quot;æ–°åƒåœ¾è¢‹&quot;),
                    true, false);
            log.debug(&quot;é˜¿å§¨æ˜¯å¦æ¢äº†åƒåœ¾è¢‹ ? &#123;&#125;&quot;, res);
        &#125;, &quot;aunt&quot;).start();
    &#125;
&#125;

class GarbageBag &#123;
    String desc;

    public GarbageBag(String desc) &#123; this.desc = desc; &#125;

    public void setDesc(String desc) &#123; this.desc = desc; &#125;

    @Override
    public String toString() &#123; return &quot;GarbageBag[desc=&#39;&quot; + desc + &quot;&#39;]&quot;; &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>2021-04-27 20:01:20.764 [main] DEBUG ABAAtomicMarkableReference - éœ€è¦æ¢åƒåœ¾è¢‹...
2021-04-27 20:01:20.796 [robot] DEBUG ABAAtomicMarkableReference - æ¸…æ´æœºå™¨äººå¼€å§‹æ‰“æ‰«å«ç”Ÿ...
2021-04-27 20:01:20.796 [robot] DEBUG ABAAtomicMarkableReference - æœºå™¨äººæ˜¯å¦æ¢äº†åƒåœ¾è¢‹ ? true
2021-04-27 20:01:20.809 [aunt] DEBUG ABAAtomicMarkableReference - ä¿æ´é˜¿å§¨å¼€å§‹æ‰“æ‰«å«ç”Ÿ...
2021-04-27 20:01:20.809 [aunt] DEBUG ABAAtomicMarkableReference - é˜¿å§¨æ˜¯å¦æ¢äº†åƒåœ¾è¢‹ ? false
2021-04-27 20:01:20.823 [main] DEBUG ABAAtomicMarkableReference - GarbageBag[desc=&#39;æ–°åƒåœ¾è¢‹&#39;]</code></pre>
<h2 id="4-5-åŸå­æ•°ç»„"><a href="#4-5-åŸå­æ•°ç»„" class="headerlink" title="4.5 åŸå­æ•°ç»„"></a>4.5 åŸå­æ•°ç»„</h2><blockquote>
<p>JUCæä¾›</p>
</blockquote>
<ul>
<li><code>AtomicIntegerArray</code></li>
<li><code>AtomicLongArray</code></li>
<li><code>AtomicReferenceArray</code></li>
</ul>
<p>ä½œç”¨ï¼šä¿è¯æ•°ç»„å†…çš„å…ƒç´ çš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;AtomicArray&quot;)
public class AtomicArrayDemo &#123;
    public static void main(String[] args) &#123;
        demo(
                () -&gt; new int[10],
                array -&gt; array.length,
                (array, index) -&gt; array[index]++,
                array -&gt;  log.debug(&quot;æ™®é€šæ•°ç»„ï¼š&#123;&#125;&quot;, Arrays.toString(array))
        );
        demo(
                () -&gt; new AtomicIntegerArray(10),
                AtomicIntegerArray::length,
                AtomicIntegerArray::getAndIncrement,
                array -&gt; log.debug(&quot;å®‰å…¨æ•°ç»„ï¼š&#123;&#125;&quot;, array)
        );
    &#125;

    /**
     * @param arraySupplier   æä¾›æ•°ç»„
     * @param lengthFunction  è·å–æ•°ç»„é•¿åº¦çš„æ–¹æ³•
     * @param putConsumer     æŒ‡å®šå…ƒç´ çš„è‡ªå¢æ–¹æ³•
     * @param printConsumer   æ‰“å°æ•°ç»„å…ƒç´ çš„æ–¹æ³•
     * @apiNote
     * &lt;p&gt; Supplier æä¾›è€… æ— ä¸­ç”Ÿæœ‰         () -&gt; ç»“æœ &lt;/p&gt;
     * &lt;p&gt; Function  å‡½æ•°  ä¸€ä¸ªå‚æ•°ä¸€ä¸ªç»“æœ (å‚æ•°) -&gt; ç»“æœ  | BiFunction (å‚æ•°1ï¼Œå‚æ•°2) -&gt; ç»“æœ &lt;/p&gt;
     * &lt;p&gt; Consumer æ¶ˆè´¹è€… ä¸€ä¸ªå‚æ•°æ²¡æœ‰ç»“æœ (å‚æ•°) -&gt; Void  | BiConsumer (å‚æ•°1ï¼Œå‚æ•°2) -&gt; Void &lt;/p&gt;
     */
    private static &lt;T&gt; void demo(Supplier&lt;T&gt; arraySupplier, Function&lt;T, Integer&gt; lengthFunction,
            BiConsumer&lt;T, Integer&gt; putConsumer, Consumer&lt;T&gt; printConsumer) &#123;
        List&lt;Thread&gt; list = new ArrayList&lt;&gt;();
        T array = arraySupplier.get();
        int length = lengthFunction.apply(array);

        for (int i = 0; i &lt; length; i++) &#123;
            list.add(new Thread(() -&gt; &#123;
                for (int j = 0; j &lt; 10000; j++) &#123; // æ­£ç¡®ç»“æœåº”è¯¥æ˜¯æ•°ç»„å…ƒç´ éƒ½ä¸º10000
                    putConsumer.accept(array, j % length);
                &#125;
            &#125;));
        &#125;

        list.forEach(Thread::start);
        list.forEach(t -&gt; &#123;
            try &#123;
                t.join();
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;);
        printConsumer.accept(array);
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>2021-04-27 21:09:01.160 [main] DEBUG AtomicArray - æ™®é€šæ•°ç»„ï¼š[6531, 6533, 6501, 6566, 6515, 6508, 6499, 6519, 6489, 6527]
2021-04-27 21:09:01.166 [main] DEBUG AtomicArray - å®‰å…¨æ•°ç»„ï¼š[10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000]</code></pre>
<h2 id="4-6-å­—æ®µæ›´æ–°å™¨"><a href="#4-6-å­—æ®µæ›´æ–°å™¨" class="headerlink" title="4.6 å­—æ®µæ›´æ–°å™¨"></a>4.6 å­—æ®µæ›´æ–°å™¨</h2><blockquote>
<p>JUCæä¾›</p>
</blockquote>
<ul>
<li><code>AtomicReferenceFeildUpdater</code>ï¼šå¼•ç”¨ç±»å‹çš„å±æ€§</li>
<li><code>AtomicIntegerFieldUpdater</code>ï¼šæ•´å½¢çš„å±æ€§</li>
<li><code>AtomicLongFeildUpdater</code>ï¼šé•¿æ•´å½¢çš„å±æ€§</li>
</ul>
<p>æ³¨æ„ï¼šåˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆvolatileä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚</p>
<pre><code>Exception in thread &quot;main&quot; java.lang.IllegalArgumentException: Must be volatile type</code></pre>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;AtomicFieldUpdater&quot;)
public class AtomicFieldUpdaterDemo &#123;
    public static void main(String[] args) &#123;
        Student stu = new Student();
        AtomicReferenceFieldUpdater updater = AtomicReferenceFieldUpdater.newUpdater(Student.class, String.class, &quot;name&quot;);
        log.debug(&quot;update ? &#123;&#125;&quot;, updater.compareAndSet(stu, null, &quot;RubbishK&quot;));
        log.debug(&quot;update ? &#123;&#125;&quot;, updater.compareAndSet(stu, stu.getName(), &quot;FlowerK&quot;));
        log.debug(stu.toString());
    &#125;
&#125;

class Student &#123;
    volatile String name;

    public String getName() &#123; return name; &#125;

    @Override
    public String toString() &#123; return &quot;Student[name=&#39;&quot; + name + &quot;&#39;]&quot;; &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>2021-04-27 21:36:51.784 [main] DEBUG AtomicFieldUpdater - update ? true
2021-04-27 21:36:51.786 [main] DEBUG AtomicFieldUpdater - update ? true
2021-04-27 21:36:51.786 [main] DEBUG AtomicFieldUpdater - Student[name=&#39;FlowerK&#39;]</code></pre>
<h2 id="4-7-åŸå­ç´¯åŠ å™¨"><a href="#4-7-åŸå­ç´¯åŠ å™¨" class="headerlink" title="4.7 åŸå­ç´¯åŠ å™¨"></a>4.7 åŸå­ç´¯åŠ å™¨</h2><blockquote>
<p>JUCæä¾›</p>
</blockquote>
<ul>
<li><code>LongAddr</code></li>
<li><code>LongAccumulator</code></li>
<li><code>DouleAddr</code></li>
<li><code>DoubleAccumulator</code></li>
</ul>
<h3 id="4-7-1-ç´¯åŠ æ€§èƒ½æ¯”è¾ƒ"><a href="#4-7-1-ç´¯åŠ æ€§èƒ½æ¯”è¾ƒ" class="headerlink" title="4.7.1 ç´¯åŠ æ€§èƒ½æ¯”è¾ƒ"></a>4.7.1 ç´¯åŠ æ€§èƒ½æ¯”è¾ƒ</h3><p>ç´¯åŠ æ€§èƒ½æ¯”è¾ƒ<code>AtomicLong</code>ï¼Œ<code>LongAddr</code></p>
<pre><code class="java">@Slf4j(topic = &quot;Compare&quot;)
public class PerformanceCompareDemo &#123;
    public static void main(String[] args) &#123;
        for (int i = 0; i &lt; 5; i++) &#123;
            demo(AtomicLong::new, AtomicLong::getAndIncrement);
        &#125;
        for (int i = 0; i &lt; 5; i++) &#123;
            demo(LongAdder::new, LongAdder::increment);
        &#125;
    &#125;

    private static &lt;T&gt; void demo(Supplier&lt;T&gt; supplier, Consumer&lt;T&gt; consumer) &#123;
        T adder = supplier.get();
        long start = System.nanoTime();
        List&lt;Thread&gt; list = new ArrayList&lt;&gt;();
        for (int i = 0; i &lt; 40; i++) &#123;
            list.add(new Thread(() -&gt; &#123;
                for (int k = 0; k &lt; 50_0000; k++) &#123;
                    consumer.accept(adder);
                &#125;
            &#125;));
        &#125;
        list.forEach(Thread::start);
        list.forEach(t -&gt; &#123;
            try &#123;
                t.join();
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;);
        long end = System.nanoTime();
        log.debug(&quot;&#123;&#125; cost: &#123;&#125;(ns)&quot;, adder.getClass().getSimpleName(), (end - start));
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="java">2021-04-27 22:34:29.842 [main] DEBUG Compare - AtomicLong cost: 363865900(ns)
2021-04-27 22:34:30.176 [main] DEBUG Compare - AtomicLong cost: 331326300(ns)
2021-04-27 22:34:30.565 [main] DEBUG Compare - AtomicLong cost: 388361700(ns)
2021-04-27 22:34:30.961 [main] DEBUG Compare - AtomicLong cost: 396090500(ns)
2021-04-27 22:34:31.349 [main] DEBUG Compare - AtomicLong cost: 386800900(ns)
2021-04-27 22:34:31.404 [main] DEBUG Compare - LongAdder cost: 53539000(ns)
2021-04-27 22:34:31.438 [main] DEBUG Compare - LongAdder cost: 33946400(ns)
2021-04-27 22:34:31.479 [main] DEBUG Compare - LongAdder cost: 40203000(ns)
2021-04-27 22:34:31.511 [main] DEBUG Compare - LongAdder cost: 32314300(ns)
2021-04-27 22:34:31.546 [main] DEBUG Compare - LongAdder cost: 34245400(ns)</code></pre>
<p>å¯ä»¥å‘ç°ï¼Œ<code>LongAddr</code>çš„é€Ÿåº¦è¦æ¯”<code>AtomicLong</code>é«˜å‡ºä¸€ä¸ªæ•°é‡çº§ã€‚</p>
<h3 id="4-7-2-LongAdderæºç åˆ†æ"><a href="#4-7-2-LongAdderæºç åˆ†æ" class="headerlink" title="4.7.2 LongAdderæºç åˆ†æ"></a>4.7.2 LongAdderæºç åˆ†æ</h3><p>å…ˆè´´ä¸€ä¸‹å‰è¾ˆçš„ä¸»é¡µï¼š<a href="http://gee.cs.oswego.edu/">http://gee.cs.oswego.edu</a></p>
<p>ä½œä¸ºå¹¶å‘å¤§å¸ˆ@Doug lea çš„ä½œå“<code>LongAdder</code>ï¼Œå®ƒçš„è®¾è®¡éå¸¸ç²¾å·§ã€‚</p>
<p><code>LongAdder</code>ç±»æœ‰å‡ ä¸ªå…³é”®åŸŸï¼š</p>
<pre><code class="java">// ç´¯åŠ å•å…ƒæ•°ç»„ï¼Œæ‡’æƒ°åˆå§‹åŒ–
transient volatile Cell[] cells;

// åŸºç¡€å€¼ï¼Œå¦‚æœæ²¡æœ‰ç«äº‰ï¼Œåˆ™ç”¨CASç´¯åŠ è¿™ä¸ªåŸŸ
transient volatile long base;

// åœ¨cellsåˆ›å»ºæˆ–è€…æ‰©å®¹æ—¶ï¼Œç½®ä¸º1ï¼Œè¡¨ç¤ºåŠ é”
transient volatile int cellsBusy;</code></pre>
<h4 id="4-7-2-1-CASé”"><a href="#4-7-2-1-CASé”" class="headerlink" title="4.7.2.1 CASé”"></a>4.7.2.1 CASé”</h4><p>åˆ‡å‹¿ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒã€‚</p>
<pre><code>@Slf4j(topic = &quot;LockCAS&quot;)
public class LockCASDemo &#123;
    // 0è¡¨ç¤ºæ²¡åŠ é”
    // 1è¡¨ç¤ºåŠ äº†é”
    private final AtomicInteger state = new AtomicInteger(0);

    private void lock() &#123;
        while (true) &#123;
            if (state.compareAndSet(0, 1)) &#123;
                break;
            &#125;
        &#125;
    &#125;

    public void unlock() &#123;
        log.debug(&quot;unlock...&quot;);
        state.set(0);
    &#125;
&#125;</code></pre>
<h4 id="4-7-2-1-åŸç†ä¹‹ä¼ªå…±äº«"><a href="#4-7-2-1-åŸç†ä¹‹ä¼ªå…±äº«" class="headerlink" title="4.7.2.1 åŸç†ä¹‹ä¼ªå…±äº«"></a>4.7.2.1 åŸç†ä¹‹ä¼ªå…±äº«</h4><p>Cellå³ä¸ºç´¯åŠ å•å…ƒã€‚</p>
<pre><code class="java">// é˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«ï¼ˆä¸€ä¸ªç¼“å­˜è¡Œå®¹çº³å¤šä¸ªCellå¯¹è±¡ï¼‰
@Sun.misc.Contented
static final class Cell &#123;
    volatile long value;
    Cell(long x) &#123; value = x; &#125;

    // æœ€é‡è¦çš„æ–¹æ³•ï¼Œç”¨CASæ–¹å¼è¿›è¡Œç´¯åŠ ï¼Œprevè¡¨ç¤ºæ—§å€¼ï¼Œnextè¡¨ç¤ºæ–°å€¼
    final boolean cas(long prev, long next) &#123;
        return UNSAFE.compareAndSwapLong(this, valueOffset, prev, next);
    &#125;
    // ...
&#125;</code></pre>
<p>ä»ç¼“å­˜è¯´èµ·ï¼Œç¼“å­˜ä¸å†…å­˜çš„é€Ÿåº¦æ¯”è¾ƒï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62265/image-20210427234550770.png" class="" title="image-20210427234550770">

<table>
<thead>
<tr>
<th align="center">ä»CPUåˆ°</th>
<th align="center">å¤§çº¦éœ€è¦çš„æ—¶é’Ÿå‘¨æœŸ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">å¯„å­˜å™¨</td>
<td align="center">1 cycleï¼ˆ4GHzçš„CPUçº¦ä¸º0.25nsï¼‰</td>
</tr>
<tr>
<td align="center">L1</td>
<td align="center">3~4 cycle</td>
</tr>
<tr>
<td align="center">L2</td>
<td align="center">10~20 cycle</td>
</tr>
<tr>
<td align="center">L3</td>
<td align="center">40~45 cycle</td>
</tr>
<tr>
<td align="center">å†…å­˜</td>
<td align="center">120~240 cycle</td>
</tr>
</tbody></table>
<p>å› ä¸ºCPUä¸å†…å­˜çš„é€Ÿåº¦å·®å¼‚å¾ˆå¤§ï¼Œéœ€è¦é é¢„è¯»æ•°æ®è‡³ç¼“å­˜æ¥æå‡æ•ˆç‡ã€‚</p>
<p>è€Œç¼“å­˜ä»¥ç¼“å­˜è¡Œä¸ºå•ä½ï¼Œæ¯ä¸ªç¼“å­˜å¯¹åº”ç€ä¸€å—å†…å­˜ï¼Œä¸€èˆ¬æ˜¯64 byteï¼ˆ8ä¸ªlongï¼‰ã€‚</p>
<p>ç¼“å­˜çš„åŠ å…¥ä¼šé€ æˆæ•°æ®å‰¯æœ¬çš„äº§ç”Ÿï¼Œå³åŒä¸€ä»½æ•°æ®ä¼šç¼“å­˜åœ¨ä¸åŒæ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­ã€‚</p>
<p>CPUè¦ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¦‚æœæŸä¸ªCPUæ ¸å¿ƒæ›´æ”¹äº†æ•°æ®ï¼Œå…¶ä»–CPUæ ¸å¿ƒå¯¹åº”çš„æ•´ä¸ªç¼“å­˜è¡Œå¿…é¡»å¤±æ•ˆã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62265/image-20210428124344773.png" class="" title="image-20210428124344773">

<p>å› ä¸ºCellæ˜¯æ•°ç»„å½¢å¼ï¼Œåœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„ï¼Œä¸€ä¸ªCellä¸º24å­—èŠ‚ï¼ˆ16å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ8å­—èŠ‚çš„valueï¼‰ï¼Œå› æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹2ä¸ªçš„Cellå¯¹è±¡ã€‚è¿™æ ·é—®é¢˜æ¥äº†ï¼›</p>
<ul>
<li>Core-0è¦ä¿®æ”¹Cell[0]</li>
<li>Core-1è¦ä¿®æ”¹Cell[1]</li>
</ul>
<p>æ— è®ºè°ä¿®æ”¹æˆåŠŸï¼Œéƒ½ä¼šå¯¼è‡´å¯¹æ–¹Coreçš„ç¼“å­˜è¡Œå¤±æ•ˆï¼Œæ¯”å¦‚Core-0ä¸­Cell[0] = 6000ï¼ŒCell[1] = 8000ã€‚è¦ç´¯åŠ Cell[0] = 6001ï¼ŒCell[1] = 8000ï¼Œè¿™æ—¶ä¼šè®©Core-1ç¼“å­˜è¡Œå¤±æ•ˆã€‚</p>
<p><code>@sun.misc.Contented</code>ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„åŸç†æ˜¯åœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„å‰åå„å¢åŠ 128å­—èŠ‚å¤§å°çš„paddingï¼Œä»è€Œè®©CPUå°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œï¼Œè¿™æ ·ï¼Œä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62265/image-20210428200500865.png" class="" title="image-20210428200500865">



<h4 id="4-7-2-2-ä¸»è¦æ–¹æ³•"><a href="#4-7-2-2-ä¸»è¦æ–¹æ³•" class="headerlink" title="4.7.2.2 ä¸»è¦æ–¹æ³•"></a>4.7.2.2 ä¸»è¦æ–¹æ³•</h4><blockquote>
<p>add</p>
</blockquote>
<pre><code class="java">public void add(long x) &#123;
    Cell[] as; long b, v; int m; Cell a;
    if ((as = cells) != null         /* cellsæ˜¯å¦ä¸ºç©º */ 
        || !casBase(b = base, b + x) /* cas baseç´¯åŠ ï¼ŒæˆåŠŸåˆ™ä¸ä¼šè¿›å…¥ifä»£ç å— */) &#123;
        boolean uncontended = true;
        if (as == null || (m = as.length - 1) &lt; 0 ||
            (a = as[getProbe() &amp; m]) == null || /* å½“å‰çº¿ç¨‹cellæ˜¯å¦åˆ›å»º */
            !(uncontended = a.cas(v = a.value, v + x))) /* cas baseç´¯åŠ ï¼Œå¤±è´¥åˆ™è¿›å…¥ */
            longAccumulate(x, null, uncontended);
    &#125;
&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62265/image-20210428203546219.png" class="" title="image-20210428203546219">



<blockquote>
<p>longAccumulate</p>
</blockquote>
<pre><code class="java">final void longAccumulate(long x, LongBinaryOperator fn,
                          boolean wasUncontended) &#123;
    int h;
    if ((h = getProbe()) == 0) &#123;
        ThreadLocalRandom.current(); // force initialization
        h = getProbe();
        wasUncontended = true;
    &#125;
    boolean collide = false;                // True if last slot nonempty
    for (;;) &#123; // ä¸æ–­å°è¯•
        Cell[] as; Cell a; int n; long v;
        if ((as = cells) != null &amp;&amp; (n = as.length) &gt; 0) &#123;
            // ï¼ˆ1ï¼‰cellså·²åˆ›å»ºï¼ŒCellæœªåˆ›å»º
            if ((a = as[(n - 1) &amp; h]) == null) &#123;
                if (cellsBusy == 0) &#123;       // å°è¯•è·å–cellsæ•°ç»„
                    Cell r = new Cell(x);   // ä¹è§‚åˆ›å»ºCellå¯¹è±¡
                    if (cellsBusy == 0 &amp;&amp; casCellsBusy()) &#123;
                        // å½“å‰æ— äººä¸Šé”ï¼Œè‡ªå·±å°è¯•ä¸Šé”
                        boolean created = false;  // æ˜¯å¦å·²åˆ›å»º
                        try &#123;               // Recheck under lock
                            Cell[] rs; int m, j;
                            if ((rs = cells) != null &amp;&amp;
                                (m = rs.length) &gt; 0 &amp;&amp;
                                rs[j = (m - 1) &amp; h] == null) &#123;
                                // å†æ¬¡æ£€æŸ¥æ•°ç»„æ•°ç»„ä¸ä¸ºç©ºä¸”é•¿åº¦å¤§äº0
                                // ä¸”æ•°ç»„ä¸­ç©ºç½®çš„æ§½ä½ä¸ºç©º
                                rs[j] = r;  // å°†åˆ›å»ºçš„æ–°çš„Cellå¯¹è±¡å¡«å……åˆ°æ•°ç»„çš„ç©ºæ§½ä½
                                created = true;
                            &#125;
                        &#125; finally &#123;
                            cellsBusy = 0;  // é‡Šæ”¾é”
                        &#125;
                        if (created)
                            break;          // åˆ›å»ºæˆåŠŸåˆ™é€€å‡ºå¾ªç¯
                        continue;           // Slot is now non-empty
                    &#125;
                &#125;
                collide = false;
            &#125;
            // ï¼ˆ2ï¼‰cellså·²åˆ›å»ºã€‚Cellå·²åˆ›å»º
            else if (!wasUncontended)       // CAS already known to fail
                wasUncontended = true;      // Continue after rehash
            else if (a.cas(v = a.value, ((fn == null) ? v + x :
                                         fn.applyAsLong(v, x))))
                // å¯¹ç´¯åŠ å•å…ƒaè¿›è¡ŒCAS+xï¼Œæ“ä½œæˆåŠŸåˆ™é€€å‡º
                break;
            else if (n &gt;= NCPU || cells != as)
                // æ£€æŸ¥å½“å‰næ˜¯å¦è¶…è¿‡æœºå™¨çš„CPUä¸Šé™
                collide = false;            // At max size or stale
            else if (!collide)  
                // ä¸Šä¸ªæ¡ä»¶åŒ¹é…ä¹‹åï¼Œä¸‹æ¬¡å¾ªç¯å°±èµ°è¿™ä¸ªåˆ¤æ–­ï¼Œä¸ä¼šè¿›å…¥ä¸‹é¢çš„æ‰©å®¹é€»è¾‘
                collide = true;
            else if (cellsBusy == 0 &amp;&amp; casCellsBusy()) &#123;
                // æ‰©å®¹
                try &#123;
                    if (cells == as) &#123;      // Expand table unless stale
                        Cell[] rs = new Cell[n &lt;&lt; 1];  // å·¦ç§»ä¸€ä½ï¼Œæ‰©å®¹ä¸¤å€
                        for (int i = 0; i &lt; n; ++i)
                            rs[i] = as[i];  // å°†æ—§æ•°ç»„æ‹·è´åˆ°æ–°æ•°ç»„
                        cells = rs;         // æ›¿æ¢cells
                    &#125;
                &#125; finally &#123;
                    cellsBusy = 0;
                &#125;
                collide = false;
                continue;                   // Retry with expanded table
            &#125;
            h = advanceProbe(h);  // ä»¥ä¸Šæ¡ä»¶å‡ä¸åŒ¹é…ï¼Œæ”¹å˜çº¿ç¨‹å¯¹åº”çš„cellå¯¹è±¡
        &#125;
        else if (cellsBusy == 0 &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;
            // ï¼ˆ3ï¼‰cellsæ•°ç»„æœªåˆ›å»ºï¼Œä¸‰ä¸ªæ¡ä»¶å¦‚ä¸‹
            // cellsBusyæ˜¯æ ‡è®°ä½ï¼Œ0ä»£è¡¨æœªåŠ é”ï¼Œ1ä»£è¡¨å·²åŠ é”
            // cells == asä»£è¡¨æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ”¹å˜cellsæ•°ç»„ï¼Œasæ˜¯ç¬¬ä¸€æ¬¡ifåˆ¤æ–­è¯»å–åˆ°çš„æ•°ç»„å¼•ç”¨
            // casCellsBusy()è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°è¯•é€šè¿‡CASå°†cellsBusyä»0æ”¹ä¸º1ï¼ŒæˆåŠŸè¯´æ˜åŠ é”æˆåŠŸ
            boolean init = false;             // æ˜¯å¦åˆå§‹åŒ–
            try &#123;                             // Initialize table
                if (cells == as) &#123;            // å†æ¬¡åˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†cells
                    Cell[] rs = new Cell[2];  // åˆå§‹å¤§å°ä¸º2
                    rs[h &amp; 1] = new Cell(x);  // èµ‹åˆå§‹å€¼1
                    cells = rs;               // å°†åˆšåˆšåˆ›å»ºçš„æ•°ç»„èµ‹å€¼ç»™æˆå‘˜å˜é‡
                    init = true;              
                &#125;
            &#125; finally &#123;
                cellsBusy = 0;                // å°†æ ‡è®°ä½è®¾ä¸º0ï¼Œä»£è¡¨è§£é”
            &#125;
            if (init)                         // åˆå§‹åŒ–æˆåŠŸåˆ™é€€å‡ºå¾ªç¯
                break;                           
        &#125;
        else if (casBase(v = base, ((fn == null) ? v + x :
                                    fn.applyAsLong(v, x))))
            // åŠ é”å¤±è´¥ï¼Œè¿›è¡Œcas baseç´¯åŠ ï¼ŒæˆåŠŸåˆ™breakï¼Œå¤±è´¥åˆ™ç»§ç»­å¾ªç¯
            break;                          // Fall back on using base
    &#125;
&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62265/image-20210428211351713.png" class="" title="image-20210428211351713">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62265/image-20210428220931544.png" class="" title="image-20210428220931544">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62265/image-20210428204940662.png" class="" title="image-20210428204940662">



<blockquote>
<p>sum</p>
</blockquote>
<pre><code class="java">public long sum() &#123;
    Cell[] as = cells; Cell a;
    long sum = base;
    if (as != null) &#123; // åˆ¤ç©º
        for (int i = 0; i &lt; as.length; ++i) &#123;
            if ((a = as[i]) != null) // å¯¹æ¯ä¸ªå…ƒç´ åˆ¤ç©º
                sum += a.value;      // ç´¯åŠ æ¯ä¸ªå•å…ƒå€¼
        &#125;
    &#125;
    return sum;
&#125;</code></pre>
<h2 id="4-8-Unsafe"><a href="#4-8-Unsafe" class="headerlink" title="4.8 Unsafe"></a>4.8 Unsafe</h2><h3 id="4-8-1-æ¦‚è¿°"><a href="#4-8-1-æ¦‚è¿°" class="headerlink" title="4.8.1 æ¦‚è¿°"></a>4.8.1 æ¦‚è¿°</h3><p><code>Unsafe</code>å¯¹è±¡æä¾›äº†éå¸¸åº•å±‚çš„ï¼Œæ“ä½œå†…å­˜ã€çº¿ç¨‹çš„åŠæ³•ï¼Œ<code>Unsafe</code>å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œæ™ºèƒ½é€šè¿‡åå°„è·å¾—ï¼š</p>
<pre><code class="java">public class UnsafeAccessor &#123;
    private static Unsafe unsafe;

    static &#123;
        try &#123;
            Field theUnsafe = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);
            theUnsafe.setAccessible(true);
            unsafe = (Unsafe) theUnsafe.get(null);
        &#125; catch (NoSuchFieldException | IllegalAccessException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    static Unsafe getUnsafe() &#123;
        return unsafe;
    &#125;
&#125;</code></pre>
<h3 id="4-8-2-CASæ“ä½œ"><a href="#4-8-2-CASæ“ä½œ" class="headerlink" title="4.8.2 CASæ“ä½œ"></a>4.8.2 CASæ“ä½œ</h3><pre><code class="java">public class UnsafeDemo &#123;
    public static void main(String[] args) throws NoSuchFieldException &#123;
        Unsafe unsafe = UnsafeAccessor.getUnsafe();
        Field id = User.class.getDeclaredField(&quot;id&quot;);
        Field name = User.class.getDeclaredField(&quot;name&quot;);
        // è·å¾—åŸŸçš„åç§»åœ°å€
        long idOffset = unsafe.objectFieldOffset(id);
        long nameOffset = unsafe.objectFieldOffset(name);
        // ä½¿ç”¨CASæ–¹æ³•æ›¿æ¢æˆå‘˜å˜é‡
        User user = new User();
        unsafe.compareAndSwapInt(user, idOffset, 0, 1);
        unsafe.compareAndSwapObject(user, nameOffset, null, &quot;KHighness&quot;);
        System.out.println(user);
    &#125;
&#125;

class User &#123;
    volatile int id;
    volatile String name;

    public int getId() &#123; return id; &#125;

    public void setId(int id) &#123; this.id = id; &#125;

    public String getName() &#123; return name; &#125;

    public void setName(String name) &#123; this.name = name; &#125;

    @Override
    public String toString() &#123;
        return &quot;User[&quot; +
                &quot;id=&quot; + id +
                &quot;, name=&#39;&quot; + name + &#39;\&#39;&#39; +
                &#39;]&#39;;
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="java">User[id=1, name=&#39;KHighness&#39;]</code></pre>
<h3 id="4-8-3-è‡ªå®šä¹‰åŸå­å®ç°ç±»"><a href="#4-8-3-è‡ªå®šä¹‰åŸå­å®ç°ç±»" class="headerlink" title="4.8.3 è‡ªå®šä¹‰åŸå­å®ç°ç±»"></a>4.8.3 è‡ªå®šä¹‰åŸå­å®ç°ç±»</h3><p>ä½¿ç”¨è‡ªå®šä¹‰çš„<code>AtomicData</code>å®ç°ä¹‹å‰çº¿ç¨‹å®‰å…¨çš„åŸå­æ•´æ•°<code>Account</code>å®ç°ï¼š</p>
<pre><code class="java">class KAtomicInteger implements Account&#123;
    private volatile int value;
    private static long valueOffset;
    private static final Unsafe UNSAFE;

    static &#123;
        UNSAFE = UnsafeAccessor.getUnsafe();
        try &#123;
            valueOffset = UNSAFE.objectFieldOffset(KAtomicInteger.class.getDeclaredField(&quot;value&quot;));
        &#125; catch (NoSuchFieldException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    public KAtomicInteger(int value) &#123;
        this.value = value;
    &#125;

    public int getValue() &#123;
        return value;
    &#125;

    public void decrement(int amount) &#123;
        while (true) &#123;
            int prev = this.value;
            int next = prev - amount;
            if (UNSAFE.compareAndSwapInt(this, valueOffset, prev, next)) &#123;
                break;
            &#125;
        &#125;
    &#125;

    @Override
    public Integer geBalance() &#123;
        return getValue();
    &#125;

    @Override
    public void withdraw(Integer amount) &#123;
        decrement(amount);
    &#125;
&#125;</code></pre>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-3(å…±äº«æ¨¡å‹ä¹‹å†…å­˜)</title>
    <url>/posts/37386/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>JMMå³Java Memory Modelï¼Œå®ƒå®šä¹‰äº†ä¸»å­˜ã€å·¥ä½œå†…å­˜æŠ½è±¡æ¦‚å¿µï¼Œåº•å±‚å¯¹åº”ç€CPUå¯„å­˜å™¨ã€ç¼“å­˜ã€ç¡¬ä»¶å†…å­˜ã€CPUæŒ‡ä»¤ä¼˜åŒ–ç­‰ã€‚</p>
<p>JMMä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>åŸå­æ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“</li>
<li>å¯è§æ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—CPUç¼“å­˜çš„å½±å“</li>
<li>æœ‰åºæ€§ï¼šä¿è¯æŒ‡ä»¤ä¸ä¼šå—CPUæŒ‡ä»¤å¹¶è¡Œä¼˜åŒ–çš„å½±å“</li>
</ul>
<h2 id="3-1-å¯è§æ€§"><a href="#3-1-å¯è§æ€§" class="headerlink" title="3.1 å¯è§æ€§"></a>3.1 å¯è§æ€§</h2><h3 id="3-1-1-é€€ä¸å‡ºçš„å¾ªç¯"><a href="#3-1-1-é€€ä¸å‡ºçš„å¾ªç¯" class="headerlink" title="3.1.1 é€€ä¸å‡ºçš„å¾ªç¯"></a>3.1.1 é€€ä¸å‡ºçš„å¾ªç¯</h3><p>å…ˆçœ‹ä¸€ä¸ªç°è±¡ï¼Œmainçº¿ç¨‹å¯¹runå˜é‡çš„ä¿®æ”¹å¯¹äºtçº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº†tçº¿ç¨‹æ— æ³•åœæ­¢ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;While&quot;)
public class WhileDemo &#123;
    static boolean run = true;
    public static void main(String[] args) throws InterruptedException &#123;
        Thread t = new Thread(() -&gt; &#123;
            while (run) &#123; &#125;
        &#125;, &quot;t&quot;);
        t.start();
        TimeUnit.SECONDS.sleep(1);
        run = false;
    &#125;
&#125;</code></pre>
<h3 id="3-1-2-åˆ†æ"><a href="#3-1-2-åˆ†æ" class="headerlink" title="3.1.2 åˆ†æ"></a>3.1.2 åˆ†æ</h3><ol>
<li>åˆå§‹çŠ¶æ€ï¼Œtçº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº†runçš„å€¼åˆ°å·¥ä½œå†…å­˜ã€‚</li>
</ol>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37386/image-20210423224812159.png" class="" title="image-20210423224812159">

<ol start="2">
<li><p>å› ä¸ºtçº¿ç¨‹è¦é¢‘ç¹åœ°ä»ä¸»å†…å­˜ä¸­è¯»å–runçš„å€¼ï¼ŒJITç¼–è¯‘å™¨ä¼šå°†runçš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå‡å°‘å¯¹ä¸»å­˜ä¸­runçš„è®¿é—®ï¼Œæé«˜æ•ˆç‡ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37386/image-20210423225409195.png" class="" title="image-20210423225409195">
</li>
<li><p>1ç§’ä¹‹åï¼Œmainçº¿ç¨‹ä¿®æ”¹äº†runçš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œtæ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37386/image-20210423230248092.png" class="" title="image-20210423230248092">



</li>
</ol>
<h3 id="3-1-3-è§£å†³åŠæ³•"><a href="#3-1-3-è§£å†³åŠæ³•" class="headerlink" title="3.1.3 è§£å†³åŠæ³•"></a>3.1.3 è§£å†³åŠæ³•</h3><p>ï¼ˆ1ï¼‰ç»™å˜é‡<code>run</code>åŠ ä¸Šä¿®é¥°ç¬¦<code>volatile</code>ã€‚</p>
<p>å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ<code>volitale</code>å˜é‡éƒ½è¯´ç›´æ¥æ“ä½œä¸»å­˜ã€‚</p>
<p>ï¼ˆ2ï¼‰ä½¿ç”¨<code>synchronized</code></p>
<pre><code class="java">@Slf4j(topic = &quot;While&quot;)
public class WhileDemo &#123;
    private static volatile boolean run = true;
    private static final Object lock = new Object();
    public static void main(String[] args) throws InterruptedException &#123;
        Thread t = new Thread(() -&gt; &#123;
            while (run) &#123;
                synchronized (lock) &#123; &#125;
            &#125;
        &#125;, &quot;t&quot;);
        t.start();
        TimeUnit.SECONDS.sleep(1);
        run = false;
        synchronized (lock) &#123;
            run = false;
        &#125;
    &#125;
&#125;</code></pre>
<p>ï¼ˆ3ï¼‰åœ¨<code>while</code>å¾ªç¯ä¸­ä½¿ç”¨<code>System.out.println()</code>ä¹Ÿä¼šç»ˆæ­¢å¾ªç¯ï¼ŒåŸå› å¯ä»¥çœ‹<code>println()</code>çš„æºä»£ç ï¼Œå…¶ä¸­æ‰§è¡Œçš„æ˜¯<code>PrintStream#newLine()</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">private void newLine() &#123;
    try &#123;
        synchronized (this) &#123;  // åŠ é”
            ensureOpen();
            textOut.newLine();
            textOut.flushBuffer();
            charOut.flushBuffer();
            if (autoFlush)
                out.flush();
        &#125;
    &#125;
    catch (InterruptedIOException x) &#123;
        Thread.currentThread().interrupt();
    &#125;
    catch (IOException x) &#123;
        trouble = true;
    &#125;
&#125;</code></pre>
<h3 id="3-1-4-synchronized-volatile"><a href="#3-1-4-synchronized-volatile" class="headerlink" title="3.1.4 synchronized/volatile"></a>3.1.4 synchronized/volatile</h3><ul>
<li><code>synchronized</code>å¯ä»¥ä¿®é¥°å˜é‡å’Œæ–¹æ³•ï¼Œ<code>volatile</code>åªèƒ½ä¿®é¥°å˜é‡ã€‚</li>
<li><code>synchronized</code>ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œ<code>volatile</code>ä¿æŒå˜é‡çš„å¯è§æ€§ã€‚</li>
<li><code>synchronized</code>é€šå¸¸é€‚ç”¨äºå†™å¤šè¯»å°‘çš„åœºæ™¯ï¼Œ<code>volatile</code>é€šå¸¸é€‚ç”¨äºå†™å°‘è¯»å¤šçš„åœºæ™¯ã€‚</li>
</ul>
<h2 id="3-2-æ¨¡å¼"><a href="#3-2-æ¨¡å¼" class="headerlink" title="3.2 æ¨¡å¼"></a>3.2 æ¨¡å¼</h2><h3 id="3-2-1-ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼"><a href="#3-2-1-ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼" class="headerlink" title="3.2.1 ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼"></a>3.2.1 ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</h3><p>ä½¿ç”¨<code>volatile</code>å®ç°ä¸¤é˜¶æ®µç»ˆæ­¢ï¼š</p>
<pre><code class="java">public class TwoStageTerminationDemo &#123;
    public static void main(String[] args) throws InterruptedException &#123;
        TwoStageTermination tst = new TwoStageTermination();
        tst.start();
        Thread.sleep(3500);
        tst.stop();
    &#125;
&#125;

@Slf4j(topic = &quot;TwoStageTermination&quot;)
class TwoStageTermination &#123;
    // ç›‘æ§çº¿ç¨‹
    private Thread monitorThread;
    // æ˜¯å¦è¢«æ‰“æ–­
    private volatile boolean stop = false;

    public void start() &#123;
        monitorThread = new Thread(() -&gt; &#123;
            while (true) &#123;
                Thread current = Thread.currentThread();
                // æ˜¯å¦è¢«æ‰“æ–­
                if (stop) &#123;
                    log.debug(&quot;æ–™ç†åäº‹&quot;);
                    break;
                &#125;
                try &#123;
                    TimeUnit.SECONDS.sleep(1);
                    log.info(&quot;æ‰§è¡Œç›‘æ§...&quot;);
                &#125; catch (InterruptedException e) &#123;
                    // ç¡çœ è¢«æ‰“æ–­è¢«æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œéœ€è¦é‡æ–°è®¾ç½®
                    current.interrupt();
                &#125;
            &#125;
        &#125;, &quot;monitor&quot;);
        monitorThread.start();
    &#125;

    public void stop() &#123;
        stop = true;
    &#125;
&#125;</code></pre>
<h3 id="3-2-2-åŒæ­¥æ¨¡å¼ä¹‹Balking"><a href="#3-2-2-åŒæ­¥æ¨¡å¼ä¹‹Balking" class="headerlink" title="3.2.2 åŒæ­¥æ¨¡å¼ä¹‹Balking"></a>3.2.2 åŒæ­¥æ¨¡å¼ä¹‹Balking</h3><p>Balkingï¼ˆçŠ¹è±«ï¼‰æ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹å°±æ— éœ€å†åšäº†ï¼Œç›´æ¥ç»“æŸè¿”å›ï¼Œå®é™…ä¸Šæ˜¯ä¸€ç§å•ä¾‹æ¨¡å¼ã€‚</p>
<p>ä¿®æ”¹ä¸¤é˜¶æ®µç»ˆæ­¢å¦‚ä¸‹ï¼Œç›‘æ§çº¿ç¨‹æ‰§è¡Œä¸€æ¬¡ä¹‹åå°±ä¸å†æ‰§è¡Œã€‚</p>
<pre><code class="java">public class BalkingTwoStageTerminationDemo &#123;
    public static void main(String[] args) throws InterruptedException &#123;
        BalkingTwoStageTermination btst = new BalkingTwoStageTermination();
        btst.start();
        TimeUnit.SECONDS.sleep(3);
        btst.stop();
        TimeUnit.SECONDS.sleep(1);
        btst.start();
        TimeUnit.SECONDS.sleep(3);
        btst.stop();
    &#125;
&#125;

@Slf4j(topic = &quot;BalkingTwoStageTermination&quot;)
class BalkingTwoStageTermination &#123;
    // ç›‘æ§çº¿ç¨‹
    private Thread monitorThread;
    // æ˜¯å¦è¢«æ‰“æ–­
    private volatile boolean stop = false;
    // æ˜¯å¦å·²æ‰§è¡Œ
    private volatile boolean started = false;

    // å¯åŠ¨
    public void start() &#123;
        synchronized (this) &#123;
            if (started) &#123;
                return;
            &#125;
            stop = false;
            started = true;
        &#125;
        monitorThread = new Thread(() -&gt; &#123;
            while (true) &#123;
                Thread current = Thread.currentThread();
                // æ˜¯å¦è¢«æ‰“æ–­
                if (stop) &#123;
                    log.debug(&quot;åœæ­¢ç›‘æ§&quot;);
                    break;
                &#125;
                try &#123;
                    TimeUnit.SECONDS.sleep(1);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                log.info(&quot;æ‰§è¡Œç›‘æ§...&quot;);
            &#125;
        &#125;, &quot;monitor&quot;);
        monitorThread.start();
    &#125;

    // æš‚åœ
    public void stop() &#123;
        stop = true;
        started = false;
    &#125;
&#125;</code></pre>
<h2 id="3-3-æœ‰åºæ€§"><a href="#3-3-æœ‰åºæ€§" class="headerlink" title="3.3 æœ‰åºæ€§"></a>3.3 æœ‰åºæ€§</h2><h3 id="3-3-1-æŒ‡ä»¤é‡æ’åº"><a href="#3-3-1-æŒ‡ä»¤é‡æ’åº" class="headerlink" title="3.3.1 æŒ‡ä»¤é‡æ’åº"></a>3.3.1 æŒ‡ä»¤é‡æ’åº</h3><p>JITå³æ—¶ç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŒ‡ä»¤é‡æ’ã€‚JVMä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œè°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚</p>
<p>ï¼ˆ1ï¼‰ä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="java">static int i, j;

// æ“ä½œ
i = 0;
j = 1;</code></pre>
<p>å¯¹äº<code>i</code>å’Œ<code>j</code>çš„èµ‹å€¼æ“ä½œé¡ºåºï¼Œå¯¹æœ€ç»ˆçš„ç»“æœéƒ½æ²¡æœ‰å½±å“ã€‚å› æ­¤åœ¨çœŸæ­£æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯èƒ½<code>i</code>ä¹Ÿå¯èƒ½æ˜¯<code>j</code>å…ˆè¢«èµ‹å€¼ã€‚ä½†æ˜¯åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æŒ‡ä»¤é‡æ’åºä¼šå½±å“æ­£ç¡®æ€§ã€‚</p>
<p>ï¼ˆ2ï¼‰æ¯”å¦‚<code>new</code>ä¸€ä¸ªå¯¹è±¡ï¼š                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ä¸€èˆ¬é¡ºåºä¸ºï¼ˆ1ï¼‰åˆ†é…å†…å­˜ï¼ˆ2ï¼‰å¯¹è±¡åˆå§‹åŒ–ï¼ˆ3ï¼‰å»ºç«‹æŒ‡é’ˆå¯¹åº”å…³ç³»ï¼Œé«˜å¹¶å‘æƒ…å†µä¸‹é¡ºåºå¯èƒ½ä¹±æˆ132ï¼Œå¯¹è±¡åˆå§‹åŒ–æ—¶å°±è¢«å¦ä¸€ä¸ªçº¿ç¨‹è¯»å–é€ æˆé—®é¢˜ã€‚</p>
<h3 id="3-3-3-è¯¡å¼‚çš„ç»“æœ"><a href="#3-3-3-è¯¡å¼‚çš„ç»“æœ" class="headerlink" title="3.3.3 è¯¡å¼‚çš„ç»“æœ"></a>3.3.3 è¯¡å¼‚çš„ç»“æœ</h3><p>åœ¨å¦‚ä¸‹ä»£ç ä¸­ï¼Œ<code>I_Result</code> æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§<code>r1</code>ç”¨æ¥ä¿å­˜ç»“æœã€‚</p>
<p>çº¿ç¨‹1æ‰§è¡Œ<code>actor1</code>æ–¹æ³•ï¼Œçº¿ç¨‹2æ‰§è¡Œ<code>actor2</code>æ–¹æ³•ï¼Œæ€è€ƒ<code>r1</code>çš„å¯èƒ½ç»“æœã€‚</p>
<pre><code class="java">int num = 0;
boolean ready = false;

public void actor1(I_Result r) &#123;
    if (ready) &#123;
        r.r1 = num + num;
    &#125; else &#123;
        r.r1 = 1;
    &#125;
&#125;

public void actor2(I_Result r) &#123;
    num = 2;
    ready = true;
&#125;</code></pre>
<ol>
<li>çº¿ç¨‹1å…ˆæ‰§è¡Œï¼Œçº¿ç¨‹2åæ‰§è¡Œï¼Œæ­¤æ—¶ç»“æœä¸º1</li>
<li>çº¿ç¨‹2å…ˆæ‰§è¡Œï¼Œçº¿ç¨‹1åæ‰§è¡Œï¼Œæ­¤æ—¶ç»“æœä¸º4</li>
<li>çº¿ç¨‹2å…ˆæ‰§è¡Œï¼Œæ‰§è¡Œåˆ°<code>num = 2</code>ï¼Œçº¿ç¨‹1å¼€å§‹æ‰§è¡Œï¼Œæ­¤æ—¶ç»“æœä¸º1</li>
<li>çº¿ç¨‹2å…ˆæ‰§è¡Œï¼Œä½†æ˜¯æŒ‡ä»¤é‡æ’ï¼Œå…ˆæ‰§è¡Œ<code>ready = true</code>ï¼Œçº¿ç¨‹1å¼€å§‹æ‰§è¡Œï¼Œè¿›å…¥<code>if (ready)</code>ï¼Œæ­¤æ—¶ç»“æœä¸º2</li>
</ol>
<p>è§£å†³æ–¹æ³•ï¼šç»™<code>ready</code>åŠ ä¸Šä¿®å¤ç¬¦<code>volatile</code>ã€‚</p>
<h3 id="3-3-2-é‡æ’åºè§„åˆ™"><a href="#3-3-2-é‡æ’åºè§„åˆ™" class="headerlink" title="3.3.2 é‡æ’åºè§„åˆ™"></a>3.3.2 é‡æ’åºè§„åˆ™</h3><ul>
<li>æŒ‡ä»¤é‡æ’åºä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œè¿›è¡Œé‡æ’åºã€‚æ¯”å¦‚ï¼š<code>a= 1; b = a;</code>ã€‚</li>
<li>é‡æ’åºæ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œä½†æ˜¯ä¸ç®¡å¦‚ä½•é‡æ’ï¼Œå•çº¿ç¨‹ä¸‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½æ”¹å˜ã€‚</li>
<li>æŒ‡ä»¤é‡æ’åºä¿è¯å•çº¿ç¨‹æ¨¡å¼ä¸‹çš„ç»“æœæ­£ç¡®æ€§ï¼Œä½†æ˜¯ä¸ä¿è¯å¤šçº¿ç¨‹æ¨¡å¼ä¸‹çš„æ­£ç¡®æ€§ã€‚</li>
<li>è§£å†³æ–¹æ³•ï¼š<code>volatile</code>ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ã€‚</li>
</ul>
<h2 id="3-4-volatileåŸç†"><a href="#3-4-volatileåŸç†" class="headerlink" title="3.4 volatileåŸç†"></a>3.4 volatileåŸç†</h2><p><code>volatile</code>çš„åº•å±‚å®ç°åŸç†æ˜¯å†…å­˜å±éšœï¼ŒMemory barrierã€‚</p>
<ul>
<li>å¯¹<code>volatile</code>å˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥å†™å±éšœã€‚</li>
<li>å¯¹<code>volatile</code>å˜é‡çš„è¯»æŒ‡ä»¤åä¼šåŠ å…¥è¯»å±éšœã€‚</li>
</ul>
<h3 id="3-4-1-ä¿è¯å¯è§æ€§"><a href="#3-4-1-ä¿è¯å¯è§æ€§" class="headerlink" title="3.4.1 ä¿è¯å¯è§æ€§"></a>3.4.1 ä¿è¯å¯è§æ€§</h3><p>å†™å±éšœä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åœ¨ä¸»å­˜å½“ä¸­ã€‚</p>
<pre><code class="java">public void actor2(I_Result r) &#123;
    num = 2;
    readt = true; // readyæ˜¯volatileèµ‹å€¼å¸¦å†™å±éšœ
    // å†™å±éšœ
&#125;</code></pre>
<p>è¯»å±éšœä¿è¯åœ¨è¯¥å±éšœä¹‹åçš„ï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­çš„æœ€æ–°æ•°æ®ã€‚</p>
<pre><code class="java">public void actor1(I_Result r) &#123;
    // è¯»å±éšœ
    // readyæ˜¯volatileè¯»å–å€¼å¸¦è¯»å±éšœ
    if (ready) &#123;
        r.r1 = num + num;
    &#125; else &#123;
        r.r1 = 1;
    &#125;
&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37386/image-20210424184907780.png" class="" title="image-20210424184907780">



<h3 id="3-4-2-ä¿è¯æœ‰åºæ€§"><a href="#3-4-2-ä¿è¯æœ‰åºæ€§" class="headerlink" title="3.4.2 ä¿è¯æœ‰åºæ€§"></a>3.4.2 ä¿è¯æœ‰åºæ€§</h3><p>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹åã€‚</p>
<pre><code class="java">public void actor2(I_Result r) &#123;
    num = 2;
    ready = true; // readyæ˜¯volatileèµ‹å€¼åˆ°
       // å†™å±éšœ
&#125;</code></pre>
<p>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</p>
<pre><code class="java">public void actor1(I_Result r) &#123;
    // è¯»å±éšœ
    // readyæ˜¯volatileè¯»å–å€¼
    if (ready) &#123;
        r.r1 = num + num;
    &#125; else &#123;
        r.r1 = 1;
    &#125;
&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37386/image-20210424213414173.png" class="" title="image-20210424213414173">



<p>ä½†æ˜¯ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™ï¼š</p>
<ul>
<li>å†™å±éšœä»…ä»…æ˜¯ä¿è¯ä¹‹åçš„è¯»èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœï¼Œä½†ä¸èƒ½ä¿è¯è¯»åœ¨å†™æ“ä½œä¹‹å‰è¿˜æ˜¯ä¹‹å</li>
<li>æœ‰åºæ€§çš„ä¿è¯ä¹Ÿåªæ˜¯ä¿è¯äº†æœ¬çº¿ç¨‹å†…ç›¸å…³ä»£ç ä¸è¢«é‡æ’åº</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37386/image-20210424215341050.png" class="" title="image-20210424215341050">



<h3 id="3-4-3-double-checked-locking"><a href="#3-4-3-double-checked-locking" class="headerlink" title="3.4.3 double-checked locking"></a>3.4.3 double-checked locking</h3><p>ä»¥è‘—åçš„DCL(double-checked locking)å•ä¾‹æ¨¡å¼ä¸ºä¾‹</p>
<pre><code class="java">public class DCLSingleton &#123;
    private DCLSingleton() &#123; &#125;
    private static DCLSingleton INSTANCE = null;
    /**
     * åœ¨ç¬¬ä¸€æ¬¡çº¿ç¨‹è°ƒç”¨getInstance()ï¼Œç›´æ¥åœ¨synchronizedå¤–ï¼Œåˆ¤æ–­instanceå¯¹è±¡æ˜¯å¦å­˜åœ¨
     * å¦‚æœä¸å­˜åœ¨ï¼Œæ‰ä¼šå»è·å–é”ï¼Œç„¶ååˆ›å»ºå•ä¾‹å¯¹è±¡ï¼Œå¹¶ä¸”è¿”å›ï¼›ç¬¬äºŒä¸ªçº¿ç¨‹è°ƒç”¨getInstance()ï¼Œ
     * ä¼šè¿›è¡Œinstanceçš„ç©ºåˆ¤æ–­ï¼Œå¦‚æœå·²ç»æœ‰å•ä¾‹å¯¹è±¡å°±ä¸ä¼šå»åŒæ­¥å—ä¸­è·å–é”ï¼Œæé«˜æ•ˆç‡ã€‚
     */
    private static DCLSingleton getInstance() &#123;
        if (INSTANCE == null) &#123;
            // è¿™ä¸ªåˆ¤æ–­å¹¶ä¸åœ¨synchronizedåŒæ­¥ä»£ç å—ä¸­ï¼Œ
            // ä¸èƒ½ä¿è¯åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§ï¼Œå¯èƒ½å¯¼è‡´æŒ‡ä»¤é‡æ’
            synchronized (DCLSingleton.class) &#123;
                if (INSTANCE == null) &#123;
                    INSTANCE = new DCLSingleton();
                &#125;
            &#125;
        &#125;
        return INSTANCE;
    &#125;
&#125;</code></pre>
<p>ä»¥ä¸Šå®ç°çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å»¶è¿Ÿå®ä¾‹åŒ–</li>
<li>é¦–æ¬¡ä½¿ç”¨<code>getInstance()</code>æ‰ä½¿ç”¨<code>synchronbized</code>åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”ã€‚</li>
<li>æœ‰éšå«çš„ï¼Œä½†å¾ˆå…³é”®çš„ä¸€ç‚¹ï¼šç¬¬ä¸€ä¸ª<code>if</code>ä½¿ç”¨äº†<code>INSTANCE</code>å˜é‡ï¼Œæ˜¯åœ¨åŒæ­¥å—ä¹‹å¤–ã€‚</li>
</ul>
<p>ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œ<code>getInstance()</code>æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š</p>
<pre><code> 0 getstatic #2 &lt;top/parak/jmm/DCLSingleton.INSTANCE&gt;  # è·å–é™æ€å˜é‡INSTANCE
 3 ifnonnull 37 (+34)                                  # åˆ¤æ–­INSTANCEæ˜¯å¦ä¸ºç©º
 6 ldc #3 &lt;top/parak/jmm/DCLSingleton&gt;                 # ä»è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å°†DCLSingetonçš„classå¯¹è±¡æ¨å…¥æ“ä½œæ•°æ ˆ
 8 dup                                                 # å¤åˆ¶æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å€¼ï¼Œå³DCLSingletonçš„classå¯¹è±¡
 9 astore_0                                            # å°†DCLSingletonçš„classå¯¹è±¡å­˜å…¥å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º0çš„ä½ç½®
10 monitorenter                                        # è¿›å…¥INSTANCEå¯¹è±¡çš„monitor
11 getstatic #2 &lt;top/parak/jmm/DCLSingleton.INSTANCE&gt;  # è·å–é™æ€å˜é‡INSTANCE
14 ifnonnull 27 (+13)                                  # åˆ¤æ–­INSTANCEæ˜¯å¦ä¸ºç©º
17 new #3 &lt;top/parak/jmm/DCLSingleton&gt;                 # newä¸€ä¸ªDCLSingleton
20 dup                                                 # å¤åˆ¶æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å€¼ï¼Œå³DCLSingletonçš„classå¯¹è±¡
21 invokespecial #4 &lt;top/parak/jmm/DCLSingleton.&lt;init&gt;&gt;# è°ƒç”¨DCLSingetonçš„æ„é€ æ–¹æ³•
24 putstatic #2 &lt;top/parak/jmm/DCLSingleton.INSTANCE&gt;  # å°†æ–°å¯¹è±¡èµ‹å€¼ç»™é™æ€å˜é‡INSTANCE
27 aload_0                                             # ä»å±€éƒ¨å˜é‡è¡¨å¯¼å‡ºç´¢å¼•ä¸º0ä½ç½®çš„å…ƒç´ 
28 monitorexit                                         # é€€å‡ºINSTANCEå¯¹è±¡çš„monitor
29 goto 37 (+8)                                        # goto37è¡Œå¤„ç†
32 astore_1                                            # 32-35æ˜¯å¼‚å¸¸
33 aload_0
34 monitorexit
35 aload_1
36 athrow
37 getstatic #2 &lt;top/parak/jmm/DCLSingleton.INSTANCE&gt; # è·å–é™æ€å˜é‡INSTANCE
40 areturn</code></pre>
<p>é‡ç‚¹å…³æ³¨17-24è¡Œï¼š</p>
<ul>
<li>17ï¼šåˆ›å»º<code>DCLSingleton</code>å¯¹è±¡</li>
<li>20ï¼šå¤åˆ¶<code>DCLSingleton</code>çš„classå¯¹è±¡</li>
<li>21ï¼šè°ƒç”¨classå¯¹è±¡çš„é»˜è®¤æ„é€ æ–¹æ³•</li>
<li>24ï¼šå°†æ–°å¯¹è±¡èµ‹å€¼ç»™é™æ€å˜é‡<code>INSTANCE</code></li>
</ul>
<p>ä¹Ÿè®¸JVMä¼šä¼˜åŒ–ä¸ºï¼šå…ˆæ‰§è¡Œ24ï¼Œå†æ‰§è¡Œ21ï¼Œå³å…ˆèµ‹å€¼ï¼Œå†è°ƒæ„é€ ã€‚</p>
<p>å¯èƒ½é€ æˆï¼šä¸€ä¸ªçº¿ç¨‹æ­£åœ¨é€ å¯¹è±¡ï¼Œå¯¹è±¡è¿˜ä¸ºç©ºçš„æ—¶å€™å°±è¢«å¦ä¸€çº¿ç¨‹æ‹¿å»ä½¿ç”¨ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<pre><code class="java">public class DCLSingleton &#123;
    private DCLSingleton() &#123; &#125;
    private volatile static DCLSingleton INSTANCE = null;
    private static DCLSingleton getInstance() &#123;
        if (INSTANCE == null) &#123;
            synchronized (DCLSingleton.class) &#123;
                if (INSTANCE == null) &#123;
                    INSTANCE = new DCLSingleton();
                &#125;
            &#125;
        &#125;
        return INSTANCE;
    &#125;
&#125;</code></pre>
<p>ä»å­—èŠ‚ç ä¸Šçœ‹ä¸å‡ºvolatileçš„æ•ˆæœï¼Œä½†æ˜¯æˆ‘ä»¬ä»å±éšœçš„è§’åº¦åˆ†æï¼š</p>
<pre><code> # ====================================================&gt; åŠ å…¥å¯¹INSTANCEçš„è¯»å±éšœ
 # ä¿è¯æ­¤åçš„è¯»å–ï¼ŒåŠ è½½çš„éƒ½æ˜¯ä¸»å­˜ä¸­çš„æœ€æ–°æ•°æ®
 0 getstatic #2 &lt;top/parak/jmm/DCLSingleton.INSTANCE&gt;
 3 ifnonnull 37 (+34)
 6 ldc #3 &lt;top/parak/jmm/DCLSingleton&gt;
 8 dup
 9 astore_0
10 monitorenter # =====================================&gt; ä¿è¯åŸå­æ€§å’Œå¯è§æ€§
11 getstatic #2 &lt;top/parak/jmm/DCLSingleton.INSTANCE&gt;
14 ifnonnull 27 (+13)
17 new #3 &lt;top/parak/jmm/DCLSingleton&gt;
20 dup
21 invokespecial #4 &lt;top/parak/jmm/DCLSingleton.&lt;init&gt;&gt;
24 putstatic #2 &lt;top/parak/jmm/DCLSingleton.INSTANCE&gt;
 # ====================================================&gt; åŠ å…¥å¯¹INSTANCEçš„å†™å±éšœ
 # ä¿è¯æ­¤å‰çš„å†™å…¥ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­
27 aload_0
28 monitorexit  # =====================================&gt; ä¿è¯åŸå­æ€§å’Œå¯è§æ€§
29 goto 37 (+8)
32 astore_1
33 aload_0
34 monitorexit
35 aload_1
36 athrow
37 getstatic #2 &lt;top/parak/jmm/DCLSingleton.INSTANCE&gt;
40 areturn</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/37386/image-20210425100017250.png" class="" title="image-20210425100017250">



<h3 id="3-4-4-happens-before"><a href="#3-4-4-happens-before" class="headerlink" title="3.4.4 happens-before"></a>3.4.4 happens-before</h3><p>happens-beforeè§„å®šäº†å¯¹å…±äº«å˜é‡çš„å†™æ“ä½œå¯¹å…¶ä»–çº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼ŒæŠ›å¼€ä»¥ä¸‹happens-beforeè§„åˆ™ï¼ŒJMMå¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§ã€‚</p>
<ol>
<li>çº¿ç¨‹è§£é”mä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹måŠ é”çš„å…¶ä»–çº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</li>
</ol>
<pre><code class="java">static int x;
static Object m = new Object();

new Thread(() -&gt; &#123;
    synchronized (m) &#123;
        x = 10;
    &#125;
&#125;, &quot;t1&quot;).start();

new Thread(() -&lt; &#123;
    synchronized (m) &#123;
        System.out.println(x);
    &#125;
&#125;, &quot;t2&quot;);</code></pre>
<ol start="2">
<li>çº¿ç¨‹å¯¹volatileå˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶ä»–çº¿ç¨‹å¯¹æ”¹å˜äº†çš„è¯»å¯è§</li>
</ol>
<pre><code class="java">volatile static int x;

new Thread(() -&gt; &#123;
    x = 10;
&#125;, &quot;t1&quot;).start();

new Thread(() -&gt; &#123;
    System.out.println(x);
&#125;, &quot;t2&quot;).start();</code></pre>
<ol start="3">
<li>çº¿ç¨‹startå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§</li>
</ol>
<pre><code class="-java">static int x;

x = 10;

new Thread(() -&gt; &#123;
    System.out.println(x);
&#125;, &quot;t2&quot;).start();</code></pre>
<ol start="4">
<li>çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶ä»–çº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§ï¼ˆæ¯”å¦‚å…¶ä»–çº¿ç¨‹è°ƒç”¨<code>t1.isAlive()</code>æˆ–<code>t1.join()</code>ç­‰å¾…å®ƒç»“æŸï¼‰</li>
</ol>
<pre><code class="java">static int x;

Thread t1 = new Thread(() -&gt; &#123;
    x = 10;
&#125;);
t1.start();

t1.join();
System.out.println(x);</code></pre>
<ol start="5">
<li>çº¿ç¨‹<code>t1</code>æ‰“æ–­<code>t2</code>å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥<code>t2</code>è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§</li>
</ol>
<pre><code class="java">@Slf4j(topic = &quot;InterruptRead&quot;)
public class InterruptReadDemo &#123;
    private static int x;
    public static void main(String[] args) &#123;
        Thread t2 = new Thread(() -&gt; &#123;
            while (true) &#123;
                log.debug(&quot;x: &#123;&#125;&quot;, x);
                if (Thread.currentThread().isInterrupted()) &#123;
                    log.debug(&quot;x: &#123;&#125;&quot;, x);
                    break;
                &#125;
            &#125;
        &#125;, &quot;t2&quot;);
        t2.start();
        new Thread(() -&gt; &#123;
            try &#123;
                TimeUnit.MILLISECONDS.sleep(1);
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
            x = 3;
            t2.interrupt();
        &#125;, &quot;t1&quot;).start();
        while (!t2.isInterrupted()) &#123;
            Thread.yield();
        &#125;
        log.debug(&quot;x: &#123;&#125;&quot;, x);
    &#125;
&#125;</code></pre>
<ol start="6">
<li><p>å¯¹å˜é‡é»˜è®¤å€¼ï¼ˆ0ï¼Œfalseï¼Œnullï¼‰çš„å†™ï¼Œå¯¹å…¶ä»–çº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</p>
</li>
<li><p>å…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœ<code>x hb =&gt; y</code>å¹¶ä¸”<code>y hb =&gt; z</code>é‚£ä¹ˆæœ‰<code>x hb =&gt; z</code>ï¼Œé…åˆ<code>volatile</code>çš„é˜²æ­¢æŒ‡ä»¤é‡æ’åºï¼Œæœ‰ä¸‹é¢çš„ä¾‹å­</p>
<pre><code class="java">volatile static int x;
static int y;

new Thread(() -&gt; &#123;
    y = 10;
    x = 10;
&#125;, &quot;t1&quot;).start();

new Thread(() -&gt; &#123;
    // x = 20å¯¹t2å¯è§
    // åŒæ—¶y = 20å¯¹t2å¯è§ 
    System.out.println(x);
&#125;, &quot;t2&quot;).start();</code></pre>
</li>
</ol>
<h2 id="3-5-ä¹ é¢˜"><a href="#3-5-ä¹ é¢˜" class="headerlink" title="3.5 ä¹ é¢˜"></a>3.5 ä¹ é¢˜</h2><h3 id="3-5-1-balkingæ¨¡å¼"><a href="#3-5-1-balkingæ¨¡å¼" class="headerlink" title="3.5.1 balkingæ¨¡å¼"></a>3.5.1 balkingæ¨¡å¼</h3><p>å¸Œæœ›<code>doInit()</code>æ–¹æ³•ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹é¢çš„å®ç°æ˜¯å¦æœ‰é—®é¢˜ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
<pre><code class="java">@Slf4j(topic = &quot;BalkingPractice&quot;)
public class BalkingPractice &#123;
    static volatile boolean initialized = false;

    private static void init() &#123;
        if (initialized) &#123;
            return;
        &#125;
        doInit();
        initialized = true;
    &#125;

    private static void doInit() &#123;
        log.debug(&quot;init...&quot;);
    &#125;
&#125;</code></pre>
<p>æœ‰é—®é¢˜ï¼Œ<code>volatile</code>æ— æ³•ä¿è¯åŸå­æ€§ï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨<code>init()</code>æ–¹æ³•æ—¶ï¼Œæ­¤æ—¶éƒ½è¿›å…¥åˆ°<code>if</code>åˆ¤æ–­ï¼Œéƒ½è°ƒç”¨<code>doInit()</code>æ–¹æ³•ï¼Œæ­¤æ—¶å°±è°ƒç”¨äº†å¤šæ¬¡ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼šå¯¹<code>init()</code>æ–¹æ³•çš„æ–¹æ³•ä½“ï¼Œé€šè¿‡<code>synchronized</code>åŠ é”ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹å…±äº«<code>initialized</code>ã€‚</p>
<pre><code class="java">@Slf4j(topic = &quot;BalkingPractice&quot;)
public class BalkingPractice &#123;
    static volatile boolean initialized = false;
    final static Object lock = new Object();

    private static void init() &#123;
        synchronized (lock) &#123;
            if (initialized) &#123;
                return;
            &#125;
            doInit();
            initialized = true;
        &#125;
    &#125;

    private static void doInit() &#123;
        log.debug(&quot;init...&quot;);
    &#125;
&#125;</code></pre>
<h3 id="3-5-2-çº¿ç¨‹å®‰å…¨å•ä¾‹"><a href="#3-5-2-çº¿ç¨‹å®‰å…¨å•ä¾‹" class="headerlink" title="3.5.2 çº¿ç¨‹å®‰å…¨å•ä¾‹"></a>3.5.2 çº¿ç¨‹å®‰å…¨å•ä¾‹</h3><blockquote>
<p>é¥¿æ±‰å¼</p>
</blockquote>
<pre><code class="java">// é—®é¢˜1ï¼šä¸ºä»€ä¹ˆåŠ finalï¼Ÿ
// ç­”ï¼šé˜²æ­¢å­ç±»ç»§æ‰¿ä¿®æ”¹ã€‚
public final class Singleton implaments Serializable &#123;
    // é—®é¢˜2ï¼šä¸ºä»€ä¹ˆæ„é€ å‡½æ•°è®¾ä¸ºç§æœ‰ï¼Ÿæ˜¯å¦èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹ï¼Ÿ
    // ç­”ï¼šé˜²æ­¢å…¶ä»–ç±»ä¸­ä½¿ç”¨newç”Ÿæˆæ–°çš„å®ä¾‹ï¼Œä¸èƒ½é˜²æ­¢åå°„åˆ›å»ºæ–°çš„å®ä¾‹ã€‚
    private Singleton() &#123; &#125;

    // é—®é¢˜3ï¼šè¿™æ ·åˆå§‹åŒ–æ˜¯å¦èƒ½ä¿è¯å•ä¾‹å¯¹è±¡åˆ›å»ºæ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Ÿ
    // ç­”ï¼šèƒ½ï¼Œç±»å˜é‡åœ¨JVMç±»åŠ è½½çš„åˆå§‹åŒ–(clinit)é˜¶æ®µå®Œæˆèµ‹å€¼ï¼ŒJVMä¿è¯æ­¤æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚
    private static Singleton INSTANCE = new Singleton();

    // é—®é¢˜4ï¼šä¸ºä»€ä¹ˆæä¾›é™æ€æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥å°†INSTANCEè®¾ç½®ä¸ºpublicï¼Ÿ
    // ç­”ï¼šï¼ˆ1ï¼‰æä¾›æ›´å¥½çš„å°è£…æ€§ï¼ˆ2ï¼‰æä¾›æ³›å‹çš„æ”¯æŒ
    public static Singleton getInstance() &#123;
        return INSTANCE;
    &#125;

    // é—®é¢˜5ï¼šè¿™ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆä½œç”¨?
    // ç­”ï¼šé˜²æ­¢ååºåˆ—åŒ–æ—¶ç”Ÿæˆä¸åŒçš„å•ä¾‹å¯¹è±¡ã€‚
    public Object readResolve() &#123;
        return INSTANCE;
    &#125;
&#125;</code></pre>
<blockquote>
<p>DCLæ‡’æ±‰å¼</p>
</blockquote>
<pre><code class="java">public final class DCLSingleton &#123;
    private DCLSingleton() &#123; &#125;
    // é—®é¢˜1ï¼šä¸ºä»€ä¹ˆè¦ç»™å•ä¾‹å˜é‡åŠ ä¸Švolatileå…³é”®å­—ä¿®é¥°ï¼Ÿ
    // ç­”ï¼šé˜²æ­¢ç¬¬ä¸€æ¬¡åˆ›å»ºå¯¹è±¡æ—¶æŒ‡ä»¤é‡æ’åºã€‚
    private volatile static DCLSingleton INSTANCE = null;
    private static DCLSingleton getInstance() &#123;
        if (INSTANCE == null) &#123;
            synchronized (DCLSingleton.class) &#123;
                // é—®é¢˜3ï¼šå‰é¢å·²ç»è¿›è¡Œä¸€æ¬¡åˆ¤ç©ºï¼Œä¸ºä»€ä¹ˆè¿˜è¦åœ¨è¿™é‡ŒåŠ ä¸Šä¸ºç©ºåˆ¤æ–­ï¼Ÿ
                // ç­”ï¼šé˜²æ­¢å¤šçº¿ç¨‹å¹¶å‘å¯¼è‡´ä¸å®‰å…¨çš„é—®é¢˜ï¼šå•ä¾‹å¯¹è±¡é‡å¤åˆ›å»ºã€‚
                // æ¯”å¦‚ï¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹ã€‚éƒ½è¿›å…¥äº†ç¬¬ä¸€æ¬¡åˆ¤ç©ºï¼Œå®ƒä»¬éƒ½åˆ¤æ–­å•ä¾‹ä¸ºç©ºã€‚
                // ï¼ˆ1ï¼‰t1çº¿ç¨‹è·å–åˆ°å•ä¾‹å¯¹è±¡é”ï¼Œç„¶ååˆ›å»ºå¯¹è±¡ï¼Œé‡Šæ”¾é”ã€‚
                // ï¼ˆ2ï¼‰t2çº¿ç¨‹è·å–åˆ°å•ä¾‹å¯¹è±¡é”ï¼Œç”±äºç¬¬ä¸€æ¬¡åˆ¤ç©ºä¸ºçœŸï¼Œ
                //     å¦‚æœæ²¡æœ‰è¿›è¡Œç¬¬äºŒæ¬¡åˆ¤ç©ºï¼Œå®ƒä¹Ÿä¼šåˆ›å»ºå•ä¾‹å¯¹è±¡ï¼Œç ´åå•ä¾‹ã€‚
                if (INSTANCE == null) &#123;
                    INSTANCE = new DCLSingleton();
                &#125;
            &#125;
        &#125;
        return INSTANCE;
    &#125;
&#125;</code></pre>
<blockquote>
<p>é™æ€å†…éƒ¨ç±»</p>
</blockquote>
<pre><code class="java">public final class Singleton &#123;
    private Singleton() &#123; &#125;
    // é—®é¢˜1ï¼šé™æ€å†…éƒ¨ç±»å±äºé¥¿æ±‰å¼è¿˜æ˜¯æ‡’æ±‰å¼ï¼Ÿ
    // ç­”ï¼šå±äºæ‡’æ±‰å¼ï¼Œå½“SinletonåŠ è½½çš„æ—¶å€™ï¼ŒSingletonHolderå¹¶æ²¡æœ‰åŠ è½½è¿›å†…å­˜ï¼Œåªè¦å½“ç¬¬ä¸€æ¬¡è°ƒç”¨getInstanceçš„æ—¶å€™ï¼ŒSingletonHolderæ‰ä¼šåŠ è½½è¿›å†…å­˜ï¼Œå¹¶ä¸”åˆå§‹åŒ–INSTANCEå®ä¾‹ã€‚
    private static class SingletonHolder &#123;
        // é—®é¢˜2ï¼šè¿™æ ·åˆ›å»ºå•ä¾‹å¯¹è±¡æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ
        // ç­”ï¼šç±»åŠ è½½æ—¶JVMä¼šä¿è¯çº¿ç¨‹å®‰å…¨ã€‚
        static final Singleton INSTANCE = new Singleton();
    &#125;
    public static Singleton getInstance() &#123;
        return Singletonolder.INSTANCE;
    &#125;
&#125;</code></pre>
<blockquote>
<p>æšä¸¾ç±»</p>
</blockquote>
<pre><code class="java">// é—®é¢˜1ï¼šæšä¸¾å•ä¾‹æ˜¯å¦‚ä½•é™åˆ¶å®ä¾‹ä¸ªæ•°çš„ï¼Ÿ
// ç­”ï¼šåˆ›å»ºæšä¸¾ç±»çš„æ—¶å€™å°±å·²ç»å®šä¹‰å¥½äº†ï¼Œæ¯ä¸ªæšä¸¾å¸¸é‡å…¶å®å°±æ˜¯æšä¸¾ç±»çš„ä¸€ä¸ªé™æ€æˆå‘˜å˜é‡ã€‚
// é—®é¢˜2ï¼šæšä¸¾å•ä¾‹åœ¨åˆ›å»ºæ—¶æ˜¯å¦æœ‰å¹¶å‘é—®é¢˜ï¼Ÿ
// ç­”ï¼šæ²¡æœ‰å¹¶å‘é—®é¢˜ï¼Œæšä¸¾ç±»æˆå‘˜åº•å±‚æ˜¯ä¸€ä¸ªé™æ€æˆå‘˜è¾¹æ¡†ï¼Œåœ¨ç±»åŠ è½½æ—¶å°±åˆ›å»ºäº†ï¼ŒJVMä¼šä¿è¯çº¿ç¨‹å®‰å…¨ã€‚
// é—®é¢˜3ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«åå°„ç ´åå•ä¾‹?
// ç­”ï¼šä¸èƒ½ï¼Œåå°„åœ¨newInstanceçš„æ—¶å€™ä¼šæ£€æŸ¥ï¼Œå¦‚æœæ˜¯æšä¸¾ç±»å‹å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚
// é—®é¢˜4ï¼šæšä¸¾å•ä¾‹èƒ½å¦è¢«ååºåˆ—åŒ–ç ´åå•ä¾‹ï¼Ÿ
// ç­”ï¼šä¸èƒ½ï¼Œæšä¸¾ç±»çš„å®ç°è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œååºåˆ—åŒ–åä¾ç„¶æ˜¯ä»å‰çš„å•ä¾‹ã€‚
// é—®é¢˜5ï¼šæšä¸¾å•ä¾‹å¦‚æœå¸Œæœ›åŠ å…¥ä¸€äº›å•ä¾‹åˆ›å»ºæ—¶çš„åˆå§‹åŒ–é€»è¾‘åº”è¯¥å¦‚ä½•åšï¼Ÿ
// ç­”ï¼šåŠ æ„é€ æ–¹æ³•ã€‚
enum Singleton&#123;
    INSTANCE;
&#125;</code></pre>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-2(å…±äº«æ¨¡å‹ä¹‹ç®¡ç¨‹)</title>
    <url>/posts/62531/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="2-1-ç¬¬ä¸€éƒ¨åˆ†-çº¿ç¨‹å®‰å…¨"><a href="#2-1-ç¬¬ä¸€éƒ¨åˆ†-çº¿ç¨‹å®‰å…¨" class="headerlink" title="2.1 ç¬¬ä¸€éƒ¨åˆ†-çº¿ç¨‹å®‰å…¨"></a>2.1 ç¬¬ä¸€éƒ¨åˆ†-çº¿ç¨‹å®‰å…¨</h2><h3 id="2-1-1-çº¿ç¨‹å®‰å…¨é—®é¢˜"><a href="#2-1-1-çº¿ç¨‹å®‰å…¨é—®é¢˜" class="headerlink" title="2.1.1 çº¿ç¨‹å®‰å…¨é—®é¢˜"></a>2.1.1 çº¿ç¨‹å®‰å…¨é—®é¢˜</h3><blockquote>
<p>æ¡ˆä¾‹</p>
</blockquote>
<p>ä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º0çš„é™æ€å˜é‡ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œç»“æœæ˜¯0å—ï¼Ÿ</p>
<pre><code class="java">@Slf4j(topic = &quot;AddSub&quot;)
public class AddSubDemo &#123;

    static int counter = 0;

    public static void main(String[] args) throws InterruptedException &#123;
        Thread t1 = new Thread(() -&gt; &#123;
            for (int i = 0; i &lt; 5000; i++) &#123;
                counter++;
            &#125;
        &#125;, &quot;t1&quot;);
        Thread t2 = new Thread(() -&gt; &#123;
            for (int i = 0; i &lt; 5000; i++) &#123;
                counter--;
            &#125;
        &#125;);
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug(&quot;counter = &#123;&#125;&quot;, counter);
    &#125;
&#125;</code></pre>
<p>ç»“æœæ˜¯å˜åŒ–çš„ã€‚</p>
<blockquote>
<p>åˆ†æ</p>
</blockquote>
<p>å¯¹äºé™æ€å˜é‡iï¼Œè‡ªå¢å’Œè‡ªå‡çš„å­—èŠ‚ç æŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="java"># i++
getstatic i // è·å–é™æ€å˜é‡içš„å€¼
iconst_1    // å‡†å¤‡å¸¸é‡1
iadd        // è‡ªå¢
putstatic i // å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
# i--
getstatic i // è·å–é™æ€å˜é‡içš„å€¼
iconst_1    // å‡†å¤‡å¸¸é‡1
isub        // è‡ªå‡
putstatic i // å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i</code></pre>
<p>Javaçš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢å’Œè‡ªå‡ï¼Œéœ€è¦åœ¨ä¸»å­˜å’Œå·¥ä½œå†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210407174859979.png" class="" title="image-20210407174859979">

<p>å¦‚æœæ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œä»¥ä¸Š8è¡Œå­—èŠ‚ç æŒ‡ä»¤ï¼Œä¸ä¼šå‡ºç°é—®é¢˜ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210407175158573.png" class="" title="image-20210407175158573">

<p>ä½†æ˜¯åœ¨åŒçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¼šäº§ç”ŸæŒ‡ä»¤é‡æ’åºï¼Œå¯¼è‡´å„ç§é—®é¢˜ï¼Œæ¯”å¦‚è„è¯»ï¼ˆè¯»å–æ›´æ–°æœªä¿å­˜çš„æ•°æ®ï¼‰ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210407175406638.png" class="" title="image-20210407175406638">



<blockquote>
<p>æ‹“å±•</p>
</blockquote>
<p><code>i++</code>ã€<code>i--</code>ã€<code>++i</code>ã€<code>--i</code>ç­‰æ“ä½œéƒ½æ˜¯éåŸå­æ€§çš„ï¼Œå› ä¸ºJVMæŒ‡ä»¤å¯å¹¶éä¸€æ¡ã€‚å¯ä»¥åˆ†æä¸€ä¸‹å­—èŠ‚ç æŒ‡ä»¤ï¼ˆ<code>javap -v</code>ï¼‰ã€‚</p>
<p><code>i++</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="java">int i = 0;
System.out.println(i++);</code></pre>
<p>å­—èŠ‚ç æŒ‡ä»¤ï¼š</p>
<pre><code>0 iconst_0                                         # å°†å¸¸é‡0åŠ è½½åˆ°æ ˆé¡¶
1 istore_1                                         # å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå¹¶èµ‹å€¼ç»™å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„ä½ç½®
2 getstatic #2 &lt;java/lang/System.out&gt;              # è·å–ç³»ç»Ÿç±»çš„é™æ€å±æ€§
5 iload_1                                          # å°†å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„å…ƒç´ åŠ è½½åˆ°æ ˆé¡¶
6 iinc 1 by 1                                      # ç›´æ¥æŠŠå±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„å…ƒç´ å€¼+1
9 invokevirtual #3 &lt;java/io/PrintStream.println&gt;   # è°ƒç”¨æµçš„æ‰“å°æ–¹æ³•</code></pre>
<p>é¡ºåºï¼šå…ˆå°†å…ƒç´ åŠ è½½åˆ°æ ˆé¡¶ï¼Œç„¶åæ›´æ–°å±€éƒ¨å˜é‡è¡¨çš„å…ƒç´ çš„å€¼ã€‚</p>
<p><code>++i</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="java">int i = 0;
System.out.println(++i);</code></pre>
<p>å­—èŠ‚ç æŒ‡ä»¤ï¼š</p>
<pre><code class="j">0 iconst_0                                         # å°†å¸¸é‡0åŠ è½½åˆ°æ ˆé¡¶
1 istore_1                                         # å¼¹å‡ºæ ˆé¡¶å…ƒç´ ï¼Œå¹¶èµ‹å€¼ç»™å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„ä½ç½®
2 getstatic #2 &lt;java/lang/System.out&gt;              # è·å–ç³»ç»Ÿç±»çš„é™æ€å±æ€§
5 iinc 1 by 1                                      # ç›´æ¥æŠŠå±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„å…ƒç´ å€¼+1
8 iload_1                                          # å°†å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„å…ƒç´ åŠ è½½åˆ°æ ˆé¡¶
9 invokevirtual #3 &lt;java/io/PrintStream.println&gt;   # è°ƒç”¨æµçš„æ‰“å°æ–¹æ³•</code></pre>
<p>é¡ºåºï¼šå…ˆæ›´æ–°å±€éƒ¨å˜é‡è¡¨çš„å…ƒç´ çš„å€¼ï¼Œå†å°†å…ƒç´ åŠ è½½åˆ°æ ˆé¡¶ã€‚</p>
<blockquote>
<p>ä¸´ç•ŒåŒº</p>
</blockquote>
<p>ä¸€æ®µä»£ç å—å†…å¦‚æœå†…å­˜å †å…±äº«èµ„æºçš„å¤šçº¿ç¨‹è¯»å†™æ“ä½œï¼Œç§°è¿™æ®µä»£ç å—ä¸ºä¸´ç•ŒåŒºã€‚</p>
<blockquote>
<p>ç«æ€æ¡ä»¶</p>
</blockquote>
<p>å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„æ‰§è¡Œåºåˆ—ä¸åŒè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†ç«æ€æ¡ä»¶ã€‚</p>
<h3 id="2-1-2-synchronizedè§£å†³æ–¹æ¡ˆ"><a href="#2-1-2-synchronizedè§£å†³æ–¹æ¡ˆ" class="headerlink" title="2.1.2 synchronizedè§£å†³æ–¹æ¡ˆ"></a>2.1.2 synchronizedè§£å†³æ–¹æ¡ˆ</h3><blockquote>
<p>åº”ç”¨äº’æ–¥</p>
</blockquote>
<p>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ï¼š</p>
<ul>
<li>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼š<code>synchoronized</code>ï¼Œ<code>Lock</code></li>
<li>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡<code>AtomicInteger</code>ã€<code>AtomicLong</code></li>
</ul>
<blockquote>
<p>synchronized</p>
</blockquote>
<p>è¯­æ³•;</p>
<pre><code class="java">synchronized (å¯¹è±¡) &#123;
    ä¸´ç•ŒåŒº
&#125;</code></pre>
<p>è§£å†³ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;AddSub&quot;)
public class SafeAddSubDemo &#123;

    static Integer counter = 0;
    static Object lock = new Object();

    public static void main(String[] args) throws InterruptedException &#123;
        Thread t1 = new Thread(() -&gt; &#123;
            for (int i = 0; i &lt; 5000; i++) &#123;
                synchronized (lock) &#123;
                    counter++;
                &#125;
            &#125;
        &#125;, &quot;t1&quot;);
        Thread t2 = new Thread(() -&gt; &#123;
            for (int i = 0; i &lt; 5000; i++) &#123;
                synchronized (lock) &#123;
                    counter--;
                &#125;
            &#125;
        &#125;);
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug(&quot;counter = &#123;&#125;&quot;, counter);
    &#125;
&#125;</code></pre>
<p>è¿™æ ·å°±èƒ½ä¿è¯è¾“å‡ºç»“æœä¸º0äº†ã€‚</p>
<blockquote>
<p>æ€è€ƒ</p>
</blockquote>
<p><code>synchronized</code>å®é™…æ˜¯ç”¨å¯¹è±¡é”ä¿è¯äº†ä¸´ç•ŒåŒºä»£ç çš„åŸå­æ€§ï¼Œä¸´ç•ŒåŒºå†…çš„ä»£ç å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­ã€‚</p>
<p>æ€è€ƒå¦‚ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li><p>å¦‚æœæŠŠ<code>synchronized(obj)</code>æ”¾åœ¨forå¾ªç¯çš„å¤–é¢, å¦‚ä½•ç†è§£ï¼Ÿ</p>
<p>forå¾ªç¯ä¹Ÿæ˜¯ä¸€ä¸ªåŸå­æ“ä½œ, è¡¨ç°å‡ºåŸå­æ€§ã€‚</p>
</li>
<li><p>å¦‚æœt1<code>synchronized(obj1)</code> è€Œ t2<code>synchronized(obj2)</code>ä¼šæ€ä¹ˆè¿è¡Œ?<br>å› ä¸ºt1,ã€t2æ‹¿åˆ°ä¸æ˜¯åŒä¸€æŠŠå¯¹è±¡é”,ï¼Œæ‰€ä»¥ä»–ä»¬ä»ç„¶ä¼šå‘ç°å®‰å…¨é—®é¢˜ï¼Œ å¿…é¡»è¦æ˜¯åŒä¸€æŠŠå¯¹è±¡é”ã€‚</p>
</li>
<li><p>å¦‚æœt1<code>synchronized(obj)</code>è€Œt2æ²¡æœ‰åŠ ä¼šæ€ä¹ˆæ · ?<br>å› ä¸ºt2æ²¡æœ‰åŠ é”ï¼Œæ‰€ä»¥t2ä¸éœ€è¦è·å–t1çš„é”ï¼Œ ç›´æ¥å°±å¯ä»¥æ‰§è¡Œä¸‹é¢çš„ä»£ç , ä»ç„¶ä¼šå‡ºç°å®‰å…¨é—®é¢˜ã€‚</p>
</li>
</ul>
<blockquote>
<p>é¢å‘å¯¹è±¡æ”¹è¿›</p>
</blockquote>
<pre><code class="java">@Slf4j(topic = &quot;BetterAddAndSub&quot;)
public class BetterAddSubDemo &#123;
    public static void main(String[] args) throws InterruptedException &#123;
        Room room = new Room();
        Thread t1 = new Thread(() -&gt; &#123;
            for (int i = 0; i &lt; 5000; i++) &#123;
                room.increment();
            &#125;
        &#125;, &quot;t1&quot;);
        Thread t2 = new Thread(() -&gt; &#123;
            for (int i = 0; i &lt; 5000; i++) &#123;
                room.decrement();
            &#125;
        &#125;);
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug(&quot;counter = &#123;&#125;&quot;, room.getCounter());
    &#125;
&#125;

class Room &#123;
    private int counter = 0;

    public void increment() &#123;
        synchronized (this) &#123;
            counter++;
        &#125;
    &#125;

    public void decrement() &#123;
        synchronized (this) &#123;
            counter--;
        &#125;
    &#125;

    public int getCounter() &#123;
        synchronized (this) &#123;
            return counter;
        &#125;
    &#125;
&#125;</code></pre>
<h3 id="2-1-3-å…«é”ç°è±¡"><a href="#2-1-3-å…«é”ç°è±¡" class="headerlink" title="2.1.3 å…«é”ç°è±¡"></a>2.1.3 å…«é”ç°è±¡</h3><blockquote>
<p>æ–¹æ³•ä¸Šçš„synchronized</p>
</blockquote>
<pre><code class="java">class Test &#123;
    public synchronized void test() &#123; 
        // do something
    &#125;
    // ç­‰ä»·äºï¼ˆé”ä½çš„æ˜¯å®ä¾‹å¯¹è±¡ï¼‰
    public void test() &#123;
        synchronized(this) &#123;
        // do something
        &#125;
    &#125;

    public synchronized static void test() &#123;
        // do something
    &#125;
    // ç­‰ä»·äºï¼ˆé”ä½çš„æ˜¯ç±»å¯¹è±¡ï¼‰
    public static void test() &#123;
        synchronized(Test.class) &#123;
            // do something
        &#125;
    &#125;
&#125;</code></pre>
<blockquote>
<p>å…«é”ç°è±¡</p>
</blockquote>
<p>æƒ…å†µä¸€ï¼š<code>synchronized</code>æ–¹æ³•é”ä½çš„æ˜¯å®ä¾‹å¯¹è±¡ï¼Œä¸¤ä¸ªæ–¹æ³•ä½¿ç”¨åŒä¸€ä¸ªé”ï¼Œè°å…ˆè·å–é”è°å…ˆæ‰§è¡Œã€‚</p>
<p>ç»“æœï¼š<u>AB</u></p>
<pre><code class="java">@Slf4j(topic = &quot;LockTest&quot;)
public class LockDemo1 &#123;
    public static void main(String[] args) throws InterruptedException &#123;
        Lock lock = new Lock();
        new Thread(lock::printA, &quot;A&quot;).start();
        TimeUnit.SECONDS.sleep(1);
        new Thread(lock::printB, &quot;B&quot;).start();
    &#125;
&#125;
@Slf4j(topic = &quot;Lock&quot;)
class Lock &#123;
    public synchronized void printA() &#123; log.debug(&quot;A =&gt; [&#123;&#125;]&quot;, System.nanoTime()); &#125;
    public synchronized void printB() &#123; log.debug(&quot;B =&gt; [&#123;&#125;]&quot;, System.nanoTime()); &#125;
&#125;</code></pre>
<p>æƒ…å†µäºŒï¼š<code>synchronized</code>æ–¹æ³•é”ä½çš„æ˜¯å®ä¾‹å¯¹è±¡ï¼Œä¸¤ä¸ªæ–¹æ³•ä½¿ç”¨åŒä¸€ä¸ªé”ï¼Œè°å…ˆè·å–é”è°å…ˆæ‰§è¡Œã€‚</p>
<p>ç»“æœï¼š<u>AB</u></p>
<pre><code class="java">@Slf4j(topic = &quot;LockTest1&quot;)
public class LockDemo2 &#123;
    @SneakyThrows
    public static void main(String[] args) &#123;
        Lock2 lock = new Lock2();
        new Thread(lock::printA, &quot;A&quot;).start();
        TimeUnit.SECONDS.sleep(1);
        new Thread(lock::printB, &quot;B&quot;).start();
    &#125;
&#125;
@Slf4j(topic = &quot;Lock&quot;)
class Lock2 &#123;
    @SneakyThrows
    public synchronized void printA() &#123;
        TimeUnit.SECONDS.sleep(2);
        log.debug(&quot;A =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
    public synchronized void printB() &#123;
        log.debug(&quot;B =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
&#125;</code></pre>
<p>æƒ…å†µä¸‰ï¼šæœªåŠ <code>synchronized</code>çš„æ–¹æ³•ä¸éœ€è¦ç­‰å¾…é”ã€‚</p>
<p>ç»“æœï¼š<u>CAB</u></p>
<pre><code class="java">@Slf4j(topic = &quot;LockTest3&quot;)
public class LockDemo3 &#123;
    @SneakyThrows
    public static void main(String[] args) &#123;
        Lock3 lock = new Lock3();
        new Thread(lock::printA, &quot;A&quot;).start();
        new Thread(lock::printB, &quot;B&quot;).start();
        new Thread(lock::printC, &quot;C&quot;).start();
    &#125;
&#125;

@Slf4j(topic = &quot;Lock3&quot;)
class Lock3 &#123;
    @SneakyThrows
    public synchronized void printA() &#123;
        TimeUnit.SECONDS.sleep(1); // ä¼šè®©å‡ºCPUæ‰§è¡Œæƒ
        log.debug(&quot;A =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
    public synchronized void printB() &#123;
        log.debug(&quot;B =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
    public void printC() &#123;
        log.debug(&quot;C =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
&#125;</code></pre>
<p>æƒ…å†µå››ï¼šä¸¤ä¸ªçº¿ç¨‹çš„æ–¹æ³•é”ä½æ˜¯å„è‡ªçš„å®ä¾‹å¯¹è±¡ï¼Œä¸å­˜åœ¨äº’æ–¥ï¼Œå¹¶ä¸”ç¡çœ ä¼šè®©å‡ºCPUæ‰§è¡Œæƒã€‚</p>
<p>ç»“æœï¼š<u>BA</u></p>
<pre><code class="java">@Slf4j(topic = &quot;LockTest4&quot;)
public class LockDemo4 &#123;
    public static void main(String[] args) &#123;
        Lock4 lock1 = new Lock4();
        Lock4 lock2 = new Lock4();
        new Thread(lock1::printA, &quot;A&quot;).start();
        new Thread(lock2::printB, &quot;B&quot;).start();
    &#125;
&#125;
@Slf4j(topic = &quot;Lock4&quot;)
class Lock4 &#123;
    @SneakyThrows
    public synchronized void printA() &#123;
        TimeUnit.SECONDS.sleep(1); 
        log.debug(&quot;A =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
    public synchronized void printB() &#123;
        log.debug(&quot;B =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
&#125;</code></pre>
<p>æƒ…å†µ5ï¼š<code>static synchronized</code>æ–¹æ³•é”ä½çš„æ˜¯ç±»å¯¹è±¡ï¼Œ<code>synchronized</code>æ–¹æ³•é”ä½çš„æ˜¯å®ä¾‹å¯¹è±¡ã€‚ä¸¤çº¿ç¨‹é”ä½çš„å¯¹è±¡ä¸åŒï¼Œä¸å­˜åœ¨äº’æ–¥ã€‚</p>
<p>ç»“æœï¼š<u>BA</u></p>
<pre><code class="java">@Slf4j(topic = &quot;LockTest5&quot;)
public class LockDemo5 &#123;
    public static void main(String[] args) &#123;
        Lock5 lock5 = new Lock5();
        new Thread(Lock5::printA, &quot;A&quot;).start();
        new Thread(lock5::printB, &quot;B&quot;).start();
    &#125;
&#125;
@Slf4j(topic = &quot;Lock5&quot;)
class Lock5 &#123;
    @SneakyThrows
    public static synchronized void printA() &#123;
        TimeUnit.SECONDS.sleep(1);
        log.debug(&quot;A =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
    public synchronized void printB() &#123;
        log.debug(&quot;B =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
&#125;</code></pre>
<p>æƒ…å†µå…­ï¼š<code>synchronized</code>æ–¹æ³•é”ä½çš„æ˜¯ç±»å¯¹è±¡ï¼Œä¸¤çº¿ç¨‹ä½¿ç”¨åŒä¸€ä¸ªé”ï¼Œè°å…ˆè·å–è°å…ˆæ‰§è¡Œã€‚</p>
<p>ç»“æœï¼š<u>AB</u></p>
<pre><code class="java">@Slf4j(topic = &quot;LockTest6&quot;)
public class LockDemo6 &#123;
    public static void main(String[] args) &#123;
        new Thread(Lock6::printA, &quot;A&quot;).start();
        new Thread(Lock6::printB, &quot;B&quot;).start();
    &#125;
&#125;
@Slf4j(topic = &quot;Lock6&quot;)
class Lock6 &#123;
    @SneakyThrows
    public static synchronized void printA() &#123;
        TimeUnit.SECONDS.sleep(1);
        log.debug(&quot;A =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
    public static synchronized void printB() &#123;
        log.debug(&quot;B =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
&#125;</code></pre>
<p>æƒ…å†µä¸ƒï¼šä¸¤ä¸ªçº¿ç¨‹ä½¿ç”¨çš„ä¸€ä¸ªæ˜¯ç±»å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯å®ä¾‹å¯¹è±¡ï¼Œä¸å­˜åœ¨äº’æ–¥ã€‚</p>
<p>ç»“æœï¼š<u>BA</u></p>
<pre><code class="java">@Slf4j(topic = &quot;LockTest7&quot;)
public class LockDemo7 &#123;
    public static void main(String[] args) &#123;
        Lock7 lock7 = new Lock7();
        new Thread(Lock7::printA, &quot;A&quot;).start();
        new Thread(lock7::printB, &quot;B&quot;).start();
    &#125;
&#125;
@Slf4j(topic = &quot;Lock7&quot;)
class Lock7 &#123;
    @SneakyThrows
    public static synchronized void printA() &#123;
        TimeUnit.SECONDS.sleep(1);
        log.debug(&quot;A =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
    public synchronized void printB() &#123;
        log.debug(&quot;B =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
&#125;</code></pre>
<p>æƒ…å†µå…«ï¼šä¸¤ä¸ªçº¿ç¨‹çš„æ–¹æ³•é”ä½çš„éƒ½æ˜¯ç±»å¯¹è±¡ï¼Œè°å…ˆè·å–è°å…ˆæ‰§è¡Œã€‚</p>
<p>ç»“æœï¼š<u>AB</u></p>
<pre><code class="java">@Slf4j(topic = &quot;LockTest8&quot;)
public class LockDemo8 &#123;
    public static void main(String[] args) &#123;
        new Thread(Lock8::printA, &quot;A&quot;).start();
        new Thread(Lock8::printB, &quot;B&quot;).start();
    &#125;
&#125;
@Slf4j(topic = &quot;Lock8&quot;)
class Lock8 &#123;
    @SneakyThrows
    public static synchronized void printA() &#123;
        TimeUnit.SECONDS.sleep(1);
        log.debug(&quot;A =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
    public static synchronized void printB() &#123;
        log.debug(&quot;B =&gt; [&#123;&#125;]&quot;, System.nanoTime());
    &#125;
&#125;</code></pre>
<h3 id="2-1-4-å˜é‡çš„çº¿ç¨‹å®‰å…¨"><a href="#2-1-4-å˜é‡çš„çº¿ç¨‹å®‰å…¨" class="headerlink" title="2.1.4  å˜é‡çš„çº¿ç¨‹å®‰å…¨"></a>2.1.4  å˜é‡çš„çº¿ç¨‹å®‰å…¨</h3><blockquote>
<p>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡</p>
</blockquote>
<ul>
<li>å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li>
<li>å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼š<ul>
<li>å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li>
<li>å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li>
</ul>
</li>
</ul>
<blockquote>
<p>å±€éƒ¨å˜é‡</p>
</blockquote>
<ul>
<li>å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li>å±€éƒ¨å˜é‡çš„å¼•ç”¨æœªå¿…æ˜¯çº¿ç¨‹å®‰å…¨çš„<ul>
<li>å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li>å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»äº†æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</li>
</ul>
</li>
</ul>
<blockquote>
<p>æˆå‘˜å˜é‡æ¡ˆä¾‹åˆ†æ</p>
</blockquote>
<p>æœ‰å¦‚ä¸‹ç±»ï¼š</p>
<pre><code class="java">class UnsafeOperation &#123;
    ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();

    public void method1(int loopNumber) &#123;
        for (int i = 0; i &lt; loopNumber; i++) &#123;
            // &#123; ä¸´ç•ŒåŒºï¼Œä¼šäº§ç”Ÿç«æ€æ¡ä»¶
                method2();
                method3();
            // &#125; ä¸´ç•ŒåŒº
        &#125;
    &#125;

    private void method2() &#123; list.add(&quot;1&quot;); &#125;

    private void method3() &#123; list.remove(0); &#125;
&#125;</code></pre>
<p>æ‰§è¡Œå¦‚ä¸‹ä»£ç åˆ™ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;UnsafeArrayList&quot;)
public class UnsafeArrayListDemo &#123;
    static final int THREAD_NUMBER = 2;
    static final int LOOP_NUMBER = 200;

    public static void main(String[] args) &#123;
        UnsafeOperation operation = new UnsafeOperation();
        for (int i = 0; i &lt; THREAD_NUMBER; i++) &#123;
            new Thread(() -&gt; operation.method1(LOOP_NUMBER), &quot;Thread&quot; + (i + 1)).start();
        &#125;
    &#125;
&#125;</code></pre>
<p>åˆ†æï¼š</p>
<ul>
<li>ä¸¤ä¸ªçº¿ç¨‹ä¸­çš„<code>method2</code>å¼•ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ä¸­çš„listæˆå‘˜å˜é‡ã€‚</li>
<li><code>method3</code>å’Œ<code>method2</code>åˆ†æç›¸åŒã€‚</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210407220707659.png" class="" title="image-20210407220707659">

<p>å°†åŸç±»ä¸­çš„æˆå‘˜å˜é‡ä¿®æ”¹ä¸ºå±€éƒ¨å˜é‡åˆ™ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p>
<pre><code class="java">class SafeOperation &#123;

    public void method1(int loopNumber) &#123;
        ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();
        for (int i = 0; i &lt; loopNumber; i++) &#123;
            method2(list);
            method3(list);
        &#125;
    &#125;

    private void method2(ArrayList&lt;String&gt; list) &#123; list.add(&quot;1&quot;); &#125;

    private void method3(ArrayList&lt;String&gt; list) &#123; list.remove(0); &#125;
&#125;</code></pre>
<p>åˆ†æï¼š</p>
<ul>
<li><code>list</code>æ˜¯å±€éƒ¨å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨æ—¶ä¼šåˆ›å»ºå…¶ä¸åŒå®ä¾‹ï¼Œæ²¡æœ‰å…±äº«ã€‚</li>
<li><code>method2</code>çš„å‚æ•°æ˜¯ä»<code>method1</code>ä¸­ä¼ é€’è¿‡æ¥çš„ï¼Œä¸<code>method1</code>ä¸­å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡ã€‚</li>
<li><code>method3</code>çš„å‚æ•°åˆ†æä¸<code>method2</code>ç›¸åŒã€‚</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210407221447318.png" class="" title="image-20210407221447318">



<blockquote>
<p>privateæˆ–finalçš„é‡è¦æ€§</p>
</blockquote>
<p>åœ¨ä¸Šè¿°çš„<code>SafeOperation</code>ä¸­ï¼Œå¦‚æœæŠŠ<code>method2</code>å’Œ<code>method3</code>çš„æ–¹æ³•ä¿®æ”¹ä¸º<code>public</code>ä¼šä¸ä¼šå¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</p>
<p>æƒ…å†µä¸€ï¼šæœ‰å…¶ä»–çº¿ç¨‹è°ƒç”¨<code>method2</code>å’Œ<code>method3</code>ã€‚</p>
<p>ç»“æœï¼šä¸ä¼šå¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºä¸€ä¸ªçº¿ç¨‹è°ƒç”¨<code>method1</code>ä¸­çš„å±€éƒ¨å˜é‡<code>list</code>ä¸å…¶ä»–çº¿ç¨‹ä¼ ç»™<code>method2</code>å’Œ<code>method3</code>çš„å‚æ•°ä¸åŒã€‚</p>
<p>æƒ…å†µäºŒï¼šä¸º<code>SafeOperation</code>æ·»åŠ å­ç±»ï¼Œå­ç±»è¦†ç›–<code>method3</code>æ–¹æ³•ã€‚</p>
<pre><code class="java">class SubSafeOperation extends SafeOperation&#123;
    @Override
    public void method3(ArrayList&lt;String&gt; list) &#123;
        new Thread(() -&gt; list.remove(0)).start();
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼šç”±äº<code>method3</code>çš„è®¿é—®æƒé™ä¸º<code>public</code>ï¼Œæ­¤æ—¶å­ç±»é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œå­ç±»å’Œçˆ¶ç±»å…±äº«<code>list</code>å¯¹è±¡ï¼Œåœ¨å­ç±»ä¸­æ–°å¼€çº¿ç¨‹æ¥æ“ä½œ<code>list</code>å¯¹è±¡ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<p>æ‰€ä»¥ä¸æƒ³å­ç±»é‡å†™çˆ¶ç±»çš„æ–¹æ³•çš„ï¼Œéœ€è¦å°†çˆ¶ç±»ä¸­çš„æ–¹æ³•è®¾ç½®ä¸º<code>private</code>æˆ–è€…<code>final</code>ï¼Œè¿™ä¾¿æ˜¯å¼€é—­åŸåˆ™ä¸­çš„ã€é—­ã€‘ã€‚</p>
<blockquote>
<p>4.5 å¸¸è§çº¿ç¨‹å®‰å…¨ç±»</p>
</blockquote>
<ul>
<li>String</li>
<li>Integer</li>
<li>StringBuffer</li>
<li>Random</li>
<li>Vector</li>
<li>HashTable</li>
<li>ConcurrentMap</li>
<li>java.util.concurrent</li>
</ul>
<p>å®ƒä»¬çš„æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„ï¼Œä½†æ˜¯å®ƒä»¬å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„ã€‚</p>
<h3 id="2-1-5-ä¹ é¢˜"><a href="#2-1-5-ä¹ é¢˜" class="headerlink" title="2.1.5 ä¹ é¢˜"></a>2.1.5 ä¹ é¢˜</h3><blockquote>
<p>å–ç¥¨</p>
</blockquote>
<pre><code class="java">@Slf4j(topic = &quot;ExerciseSell&quot;)
public class ExerciseSellDemo &#123;
    // Randomä¸ºçº¿ç¨‹å®‰å…¨
    static Random random = new Random();

    // éšæœºæ•°1~5
    public static int randomAmount() &#123;
        return random.nextInt(5) + 1;
    &#125;

    public static void main(String[] args) throws InterruptedException &#123;
        // å”®ç¥¨çª—å£ï¼Œæ€»å…±1000å¼ ç¥¨
        TicketWindow window = new TicketWindow(1000);
        // çº¿ç¨‹é›†åˆï¼Œæ¨¡æ‹Ÿå¤šäººä¹°ç¥¨
        List&lt;Thread&gt; threadList = new ArrayList&lt;&gt;();
        // å–å‡ºçš„ç¥¨æ•°ç»Ÿè®¡ï¼ŒVectorçº¿ç¨‹å®‰å…¨
        List&lt;Integer&gt; amountList = new Vector&lt;&gt;();
        // æ¨¡æ‹Ÿ1000ä¸ªäººä¹°ç¥¨
        for (int i = 0; i &lt; 1000; i++) &#123;
            Thread thread = new Thread(() -&gt; &#123;
                // ä¹°ç¥¨
                int amount = window.sell(randomAmount());
                // ç¡çœ 
                try &#123;
                    Thread.sleep(randomAmount());
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                // ç»Ÿè®¡ä¹°ç¥¨æ•°
                amountList.add(amount);
            &#125;);
            threadList.add(thread);
            thread.start();
        &#125;
        for (Thread thread : threadList) &#123;
            thread.join();
        &#125;
        // æŸ¥çœ‹ä½™ç¥¨æ•°é‡å’Œå”®ç¥¨æ•°é‡ä¹‹å’Œæ˜¯å¦ä¸º1000
        log.debug(&quot;ä½™ç¥¨ =&gt; [&#123;&#125;]&quot;, window.getCount());
        log.debug(&quot;å”®ç¥¨ =&gt; [&#123;&#125;]&quot;, amountList.stream().mapToInt(i -&gt; i).sum());
    &#125;
&#125;

/**
 * å”®ç¥¨çª—å£
 */
class TicketWindow &#123;
    // ç¥¨æ€»æ•°
    private int count;

    public TicketWindow(int count) &#123;
        this.count = count;
    &#125;

    // è·å–ä½™ç¥¨æ•°é‡
    public int getCount() &#123;
        return count;
    &#125;

    // å”®ç¥¨
    public int sell(int amount) &#123;
        if (this.count &gt;= amount) &#123;
            this.count -= amount;
            return amount;
        &#125; else &#123;
            return 0;
        &#125;
    &#125;
&#125;</code></pre>
<p>ä¸ºäº†æµ‹å‡ºå¼‚å¸¸ç»“æœï¼Œä½¿ç”¨windowsæµ‹è¯•è„šæœ¬ï¼š</p>
<pre><code class="powershell">for /L %n in (1,1,10) do java -cp &quot;.;C:\Java\maven\localRepository\org\projectlombok\lombok\1.18.12\lombok-1.18.12.jar;C:\Java\maven\localRepository\ch\qos\logback\logback-classic\1.1.2\logback-classic-1.1.2.jar;C:\Java\maven\localRepository\ch\qos\logback\logback-core\1.1.2\logback-core-1.1.2.jar;C:\Java\maven\localRepository\org\slf4j\slf4j-api\1.7.6\slf4j-api-1.7.6.jar&quot; top.parak.safe.ExerciseSellDemo</code></pre>
<p>å¤šæ¬¡æµ‹è¯•ï¼Œç»ˆäºå‘ç°é”™è¯¯ç»“æœï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210408140200022.png" class="" title="image-20210408140200022">

<p>åˆ†æåŸå› ï¼Œå°±åœ¨äºä¸´ç•ŒåŒº<code>TicketWindow</code>çš„<code>sell()</code>æ–¹æ³•ï¼Œå¤šä¸ªçº¿ç¨‹å¯¹ç±»çš„æˆå‘˜å˜é‡<code>count</code>è¿›è¡Œå†™æ“ä½œï¼Œè€Œè¿™ä¸ªæ–¹æ³•å¹¶æœªå—åˆ°ä¿æŠ¤ï¼Œäºæ˜¯å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚åªéœ€è¦åœ¨æ–¹æ³•å¤´ä¸Šæ ‡è¯†<code>synchronized</code>å³å¯ï¼Œé”ä½å®ä¾‹å¯¹è±¡ï¼Œåˆ™çº¿ç¨‹å®‰å…¨ã€‚</p>
<blockquote>
<p>è½¬è´¦</p>
</blockquote>
<pre><code class="java">@Slf4j(topic = &quot;ExerciseTransfer&quot;)
public class ExerciseTransferDemo &#123;
    // Randomä¸ºçº¿ç¨‹å®‰å…¨
    static Random random = new Random();

    // éšæœºæ•°1~100
    public static int randomAmount() &#123;
        return random.nextInt(100) + 1;
    &#125;

    public static void main(String[] args) throws InterruptedException &#123;
        // æ¨¡æ‹Ÿä¸¤ä¸ªè´¦æˆ·
        Account k1 = new Account(1000);
        Account k2 = new Account(1000);
        // äº’ç›¸è½¬è´¦1000æ¬¡
        Thread t1 = new Thread(() -&gt; &#123;
           for (int i = 0; i &lt; 1000; i++) &#123;
               k1.transfer(k2, randomAmount());
           &#125;
        &#125;, &quot;t1&quot;);
        Thread t2 = new Thread(() -&gt; &#123;
            for (int i = 0; i &lt; 1000; i++) &#123;
                k2.transfer(k1, randomAmount());
            &#125;
        &#125;, &quot;t2&quot;);
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        // æŸ¥çœ‹è½¬è´¦2000æ¬¡åçš„ä½™é¢
        log.debug(&quot;k1 =&gt; [&#123;&#125;]&quot;, k1.getMoney());
        log.debug(&quot;k2 =&gt; [&#123;&#125;]&quot;, k2.getMoney());
    &#125;
&#125;

/**
 * è´¦æˆ·
 */
class Account &#123;
    private int money;

    public Account(int money) &#123;
        this.money = money;
    &#125;

    public int getMoney() &#123;
        return money;
    &#125;

    public void setMoney(int money) &#123;
        this.money = money;
    &#125;

    public void transfer(Account target, int amount) &#123;
        if (this.money &gt;= amount) &#123;
            this.setMoney(this.getMoney() - amount);
            target.setMoney(target.getMoney() + amount);
        &#125;
    &#125;
&#125;</code></pre>
<p>è¿è¡Œä¸€æ¬¡ï¼š</p>
<pre><code>2021-04-08 14:47:33.703 [main] DEBUG ExerciseTransfer - k1 =&gt; [1]
2021-04-08 14:47:33.706 [main] DEBUG ExerciseTransfer - k2 =&gt; [145]</code></pre>
<p>å‘ç°<code>k1</code>å’Œ<code>k2</code>çš„ä½™é¢ä¹‹å’Œä¸ä¸º2000ï¼Œæ‰€ä»¥<code>Account</code>æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</p>
<p>ç”±äºè½¬è´¦éœ€è¦æ“ä½œè‡ªå·±å’Œå¯¹æ–¹çš„<code>money</code>ï¼Œæ‰€ä»¥éœ€è¦ç›´æ¥é”ä½ä¸¤ä¸ªç±»çš„<code>money</code>ï¼Œå³é”ä½<code>Account</code>ç±»ã€‚</p>
<p>æ”¹è¿›å¦‚ä¸‹ï¼š</p>
<pre><code class="java">public void transfer(Account target, int amount) &#123;
    synchronized (Account.class) &#123;
        if (this.money &gt;= amount) &#123;
            this.setMoney(this.getMoney() - amount);
            target.setMoney(target.getMoney() + amount);
        &#125;
    &#125;
&#125;</code></pre>
<h2 id="2-2-ç¬¬äºŒéƒ¨åˆ†-Monitor"><a href="#2-2-ç¬¬äºŒéƒ¨åˆ†-Monitor" class="headerlink" title="2.2 ç¬¬äºŒéƒ¨åˆ†-Monitor"></a>2.2 ç¬¬äºŒéƒ¨åˆ†-Monitor</h2><h3 id="2-2-1-Monitor"><a href="#2-2-1-Monitor" class="headerlink" title="2.2.1 Monitor"></a>2.2.1 Monitor</h3><blockquote>
<p>Javaå¯¹è±¡å¤´</p>
</blockquote>
<p>æ™®é€šå¯¹è±¡</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210408123514132.png" class="" title="image-20210408123514132">

<p>æ•°ç»„å¯¹è±¡</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210408123633123.png" class="" title="image-20210408123633123">

<p>å…¶ä¸­Mark Wordç»“æ„ä¸ºï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210408123818981.png" class="" title="image-20210408123818981">

<ul>
<li><code>Normal</code>ï¼šä¸€èˆ¬çŠ¶æ€ï¼Œæ²¡æœ‰åŠ ä»»ä½•é”ï¼ŒMark Wordå‰é¢30ä½ä¿å­˜çš„æ˜¯å¯¹è±¡çš„ä¿¡æ¯ï¼Œæœ€å2ä½ä¸ºçŠ¶æ€ï¼ˆ01ï¼‰ï¼Œå€’æ•°ç¬¬ä¸‰ä½è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨åå‘é”ï¼ˆæœªä½¿ç”¨ï¼š0ï¼‰</li>
<li><code>Biased</code>ï¼šåå‘çŠ¶æ€ï¼Œä½¿ç”¨åå‘é”ï¼ŒMark Wordå‰é¢30ä½ä¿å­˜å½“å‰çº¿ç¨‹çš„IDï¼Œæœ€å2ä½ä¸ºçŠ¶æ€ï¼ˆ01ï¼‰ï¼Œå€’æ•°ç¬¬ä¸‰ä½è¡¨ç¤ºæ˜¯å¦ä½¿ç”¨åå‘é”ï¼ˆä½¿ç”¨ï¼š1ï¼‰</li>
<li><code>Lightweight</code>ï¼šä½¿ç”¨è½»é‡çº§é”ï¼ŒMark Wordå‰30ä½ä¿å­˜çš„æ˜¯é”è®°å½•çš„æŒ‡é’ˆï¼Œæœ€å2ä½ä¸ºçŠ¶æ€ï¼ˆ00ï¼‰</li>
<li><code>Heavyweight</code>ï¼šä½¿ç”¨é‡é‡çº§é”ï¼ŒMark Wordå‰30ä½ä¿å­˜çš„æ˜¯Monitorçš„åœ°å€æŒ‡é’ˆï¼Œæœ€å2ä½çŠ¶æ€ï¼ˆ10ï¼‰</li>
</ul>
<blockquote>
<p>Monitor</p>
</blockquote>
<p>Monitorè¢«ç¿»è¯‘ä¸ºç›‘è§†å™¨æˆ–ç®¡ç¨‹</p>
<p>æ¯ä¸ªJavaå¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ªMonitorå¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨<code>synchronized</code>ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„Mark Wordä¸­å°±è¢«è®¾ç½®æŒ‡å‘Monitorå¯¹è±¡çš„æŒ‡é’ˆã€‚</p>
<p>Monitorç»“æ„å¦‚ä¸‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210408204555166.png" class="" title="image-20210408204555166">

<ul>
<li>åˆšå¼€å§‹<code>Monitor</code>ä¸­<code>Owner</code>ä¸ºnullã€‚</li>
<li>å½“<code>Thread-2</code>æ‰§è¡Œ<code>synchronized(obj)</code>å°±ä¼šå°†<code>Monitor</code>çš„æ‰€æœ‰è€…<code>Owner</code>ç½®ä¸º<code>Thread-2</code>ï¼Œ<code>Monitor</code>ä¸­åªèƒ½æœ‰ä¸€ä¸ª<code>Owner</code>ã€‚</li>
<li>å½“<code>Thread-2</code>ä¸Šé”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ<code>Thread-3</code>ã€<code>Thread-4</code>ã€<code>Thread-5</code>ä¹Ÿæ¥æ‰§è¡Œ<code>synchronized(obj)</code>ï¼Œå°±ä¼šè¿›å…¥<code>EntryList BLOCKED</code>ã€‚</li>
<li><code>Thread-2</code>æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œç„¶åå”¤é†’<code>EntryList</code>ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰çš„æ˜¯éå…¬å¹³çš„ã€‚</li>
<li>å›¾ä¸­çš„<code>WaitSet</code>ä¸­çš„<code>Thread-0</code>ã€<code>Thread-1</code>æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥<code>WAITING</code>çŠ¶æ€çš„çº¿ç¨‹ã€‚</li>
</ul>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>synchronizedå¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„Monitoræ‰æœ‰ä¸Šè¿°çš„æ•ˆæœã€‚</li>
<li>ä¸åŠ synchronizedçš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™ã€‚</li>
</ul>
<h3 id="2-2-2-synchronizedåŸç†"><a href="#2-2-2-synchronizedåŸç†" class="headerlink" title="2.2.2 synchronizedåŸç†"></a>2.2.2 synchronizedåŸç†</h3><p>Demoï¼š</p>
<pre><code class="java">static final Object lock = new Object();
static int counter = 0;

public static void main(String[] args) &#123;
    synchronized (lock) &#123;
        counter++;
    &#125;
&#125;</code></pre>
<p>å­—èŠ‚ç å¦‚ä¸‹ï¼š</p>
<pre><code class="java"> public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=3, args_size=1
         0: getstatic     #2         // ä»ç±»ä¸­è·å–é™æ€å˜é‡lock (synchronizedå¼€å§‹)
         3: dup                      // å¤åˆ¶æ“ä½œæ•°æ ˆçš„æ ˆé¡¶æ•°å€¼
         4: astore_1                 // å°†å¤åˆ¶çš„å¼•ç”¨æ’å…¥åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º1çš„ä½ç½®
         5: monitorenter             // è¿›å…¥lockå¯¹è±¡çš„MarkWordçš„monitor
         6: getstatic     #3         // ä»ç±»ä¸­è·å–é™æ€å˜é‡i
         9: iconst_1                 // å°†iæ”¾å…¥å¸¸é‡æ± 
        10: iadd                     // è®©iè‡ªå¢
        11: putstatic     #3         // å°†ç±»ä¸­çš„é™æ€å˜é‡iå€¼è®¾ç½®ä¸ºæ–°å€¼
        14: aload_1                  // å¯¼å‡ºå±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„ä½ç½®çš„å¯¹è±¡ï¼Œå³lockå¼•ç”¨
        15: monitorexit              // é€€å‡ºlockå¯¹è±¡çš„MarkWordçš„monitorï¼Œå”¤é†’EntryList
        16: goto          24         // ç›´æ¥goto24çš„return 
        19: astore_2                 // å°†å¼‚å¸¸å¯¹è±¡æ’å…¥åˆ°å±€éƒ¨å˜é‡è¡¨ç´¢å¼•ä¸º2çš„ä½ç½®
        20: aload_1                  // åŠ è½½å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º1çš„ä½ç½®çš„å¯¹è±¡ï¼Œå³lockå¼•ç”¨
        21: monitorexit              // é€€å‡ºlockå¯¹è±¡çš„MarkWordçš„monitorï¼Œå”¤é†’EntryList
        22: aload_2                  // åŠ è½½å±€éƒ¨å˜é‡è¡¨ä¸­ç´¢å¼•ä¸º2çš„ä½ç½®çš„å¯¹è±¡ï¼Œå³å¼‚å¸¸
        23: athrow                   // throw Exception
        24: return
      Exception table:
         from    to  target type
             6    16    19   any     // åŒæ­¥ä»£ç å—6-16ï¼Œå…±äº«ä¸€ä¸ªå¼‚å¸¸
            19    22    19   any     // åŒæ­¥ä»£ç å—19-22ï¼Œå…±äº«ä¸€ä¸ªå¼‚å¸¸</code></pre>
<h3 id="2-2-3-è½»é‡çº§é”"><a href="#2-2-3-è½»é‡çº§é”" class="headerlink" title="2.2.3 è½»é‡çº§é”"></a>2.2.3 è½»é‡çº§é”</h3><p>ä½¿ç”¨åœºæ™¯ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è®¿é—®ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚</p>
<p>è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯<code>synchronized</code>ã€‚</p>
<p>å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼š</p>
<pre><code class="java">static final Object obj = new Object();
public static vod method1() &#123;
    synchronized (obj) &#123;
        // åŒæ­¥å—A
        method2();
    &#125;
&#125;

public static void method2() &#123;
    synchronized (obj) &#123;
        // åŒæ­¥å—B
    &#125;
&#125;</code></pre>
<p>åŠ é”æµç¨‹ï¼š</p>
<ul>
<li><p>æ ˆå¸§ä¸­åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰å¯¹è±¡ï¼šæ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„Mark Word</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210409150238190.png" class="" title="image-20210409150238190">
</li>
<li><p>è®©é”è®°å½•ä¸­Object referenceæŒ‡å‘é”å¯¹è±¡ï¼Œå¹¶å°è¯•ç”¨CASæ›¿æ¢Objectçš„Mark Wordï¼Œå°†Mark Wordçš„å€¼å­˜å…¥é”è®°å½•</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210409150651052.png" class="" title="image-20210409150651052">
</li>
<li><p>å¦‚æœCASæ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº†é”è®°å½•åœ°å€å’ŒçŠ¶æ€ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”ï¼Œè¿™æ—¶å›¾ç¤ºå¦‚ä¸‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210409155409161.png" class="" title="image-20210409155409161">
</li>
<li><p>å¦‚æœCASæ›¿æ¢å¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœæ˜¯å…¶ä»–çº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥Objectçš„è½»é‡çº§é”ï¼Œè¿™æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€è¿‡ç¨‹</li>
<li>å¦‚æœæ˜¯è‡ªå·±æ‰§è¡Œäº†synchronizedé”é‡å…¥ï¼Œé‚£ä¹ˆå†æ·»åŠ ä¸€æ¡Lock Recordä½œä¸ºé‡å…¥çš„è®¡æ•°ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210409155939040.png" class="" title="image-20210409155939040">
</li>
<li><p>å½“é€€å‡ºsynchronizedä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰å¦‚æœæœ‰å–å€¼ä½nullçš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ˜¯é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°å‡ä¸€</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210409160448791.png" class="" title="image-20210409160448791">
</li>
<li><p>å½“é€€å‡ºsynchronizedä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰é”è®°å½•çš„å€¼ä¸ä¸ºnullï¼Œè¿™æ—¶ä½¿ç”¨CASå°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ã€‚</p>
<ul>
<li>æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ</li>
<li>å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä½é‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹</li>
</ul>
</li>
</ul>
<h3 id="2-2-4-é‡é‡çº§é”"><a href="#2-2-4-é‡é‡çº§é”" class="headerlink" title="2.2.4 é‡é‡çº§é”"></a>2.2.4 é‡é‡çº§é”</h3><p>å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCASæ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶ä»–çº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ˜¯éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ã€‚</p>
<pre><code class="java">static Object obj = new Object();
public static void method1() &#123;
    synchronized (obj) &#123;
        // åŒæ­¥å—
    &#125;
&#125;</code></pre>
<ul>
<li><p>å½“Thread-1è¿›è¡Œè½»é‡çº§åŠ é”æ—¶ï¼ŒThread-0å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210409161426089.png" class="" title="image-20210409161426089">
</li>
<li><p>è¿™æ—¶Thread-1åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹ï¼ˆå› ä¸ºThread-1çº¿ç¨‹åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè½»é‡çº§é”æ²¡æœ‰é˜»å¡é˜Ÿåˆ—çš„æ¦‚å¿µï¼Œæ‰€ä»¥æ­¤æ—¶å°±è¦ä¸ºå¯¹è±¡ç”³è¯·Monitoré”ï¼ˆé‡é‡çº§é”ï¼‰ï¼Œè®©ObjectæŒ‡å‘é‡é‡çº§é”ï¼Œç„¶åThread-1è‡ªå·±è¿›å…¥äº†Monitorçš„EntryListå˜æˆBLOCKEDçŠ¶æ€ã€‚ï¼‰</p>
<ul>
<li>å³ä¸ºObjectå¯¹è±¡ç”³è¯·Monitoré”ï¼Œè®©ObjectæŒ‡å‘é‡é‡çº§é”åœ°å€</li>
<li>ç„¶åè‡ªå·±è¿›å…¥Monitorçš„EntryList BLOCKED</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210409163035688.png" class="" title="image-20210409163035688">
</li>
<li><p>å½“Thread-0é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨CASå°†Mark Wordçš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´ï¼Œè‚¯å®šæ¢å¤å¤±è´¥ï¼Œå› ä¸ºå¯¹è±¡çš„å¯¹è±¡å¤´ä¸­å­˜å‚¨çš„æ˜¯é‡é‡çº§é”çš„åœ°å€ã€‚è¿™æ—¶ä¼šè¿›å…¥é‡é‡çº§è§£é”æµç¨‹ï¼Œå³æŒ‰ç…§Monitoråœ°å€æ‰¾åˆ°Monitorå¯¹è±¡ï¼Œè®¾ç½®Ownerä¸ºnullï¼Œå”¤é†’EntryListä¸­BLOCKEDçº¿ç¨‹Thread-1ã€‚</p>
</li>
</ul>
<blockquote>
<p>è‡ªæ—‹é”ä¼˜åŒ–</p>
</blockquote>
<p>é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚</p>
<p>åœ¨Java 6ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚</p>
<p>Java 7ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½ã€‚</p>
<h3 id="2-2-5-åå‘é”"><a href="#2-2-5-åå‘é”" class="headerlink" title="2.2.5 åå‘é”"></a>2.2.5 åå‘é”</h3><p>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡ŒCASæ“ä½œã€‚</p>
<p>Java 6ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨CASå°†çº¿ç¨‹IDè®¾ç½®åˆ°å¯¹è±¡çš„Mark Wordå¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹IDæ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–°CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">static final Object obj = new Object();
public static void m1() &#123;
    synchronized (obj) &#123;
        // åŒæ­¥å—A
        m2();
    &#125;
&#125;
public static void m2() &#123;
    synchronized (obj) &#123;
        // åŒæ­¥å—B
        m3();
    &#125;
&#125;
public static void m3() &#123;
    synchronized (obj) &#123;
        // åŒæ­¥å—C
    &#125;
&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210409171350303.png" class="" title="image-20210409171350303">



<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210409171429240.png" class="" title="image-20210409171429240">



<blockquote>
<p>åå‘çŠ¶æ€</p>
</blockquote>
<p>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š</p>
<ul>
<li><p>å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼ŒMark Wordå€¼ä¸º0x05å³æœ€åä¸‰ä½ä¸º101ï¼Œè¿™æ—¶å®ƒçš„thread_idã€epochã€ageéƒ½ä¸º0ã€‚</p>
</li>
<li><p>åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ VMå‚æ•°</p>
<p><code>-XX:BiasedLockingStartupDelay=0</code>æ¥ç¦ç”¨å»¶è¿Ÿã€‚</p>
</li>
<li><p>å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼ŒMark Wordå€¼ä¸º0x01å³æœ€å3ä½ä¸º001ï¼Œè¿™æ—¶å®ƒçš„hashcodeã€ageéƒ½ä¸º0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ°hashcodeæ—¶æ‰ä¼šèµ‹å€¼ã€‚</p>
</li>
<li><p>JVMç¦ç”¨åå‘é”ï¼š<code>-XX:-UseBiasedLocking</code></p>
</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;Biased&quot;)
public class BiasedDemo &#123;

    public static void main(String[] args) throws InterruptedException &#123;
        Biased biased = new Biased();
        log.debug(&quot;Before Biased Lock&quot;);
        log.debug(ClassLayout.parseInstance(biased.toPrintable());
        TimeUnit.SECONDS.sleep(3);
        log.debug(&quot;After Biased Lock&quot;);
        log.debug(ClassLayout.parseInstance(biased).toPrintable());
    &#125;
&#125;

class Biased &#123;

&#125;</code></pre>
<p>è¿è¡Œç»“æœï¼š</p>
<pre><code>2021-04-09 19:14:30.487 [main] DEBUG Biased - Before Biased Lock
2021-04-09 19:14:32.083 [main] DEBUG Biased - top.parak.safe.Biased object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)
      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4        (object header)                           70 b8 01 f8 (01110000 10111000 00000001 11111000) (-134104976)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

2021-04-09 19:14:35.096 [main] DEBUG Biased - After Biased Lock
2021-04-09 19:14:35.097 [main] DEBUG Biased - top.parak.safe.Biased object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)
      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4        (object header)                           70 b8 01 f8 (01110000 10111000 00000001 11111000) (-134104976)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total</code></pre>
<p>å› ä¸ºåå‘é”æœ‰å»¶è¿Ÿï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒæ¬¡åˆ›å»ºå¯¹è±¡å‰å»¶æ—¶5Sã€‚</p>
<p>ç¬¬ä¸€æ¬¡åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¯¹è±¡å¤´çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>00000001</code>ï¼Œå³æ²¡æœ‰åŠ é”ï¼Œ</p>
<p>ç¬¬äºŒæ¬¡åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¯¹è±¡å¤´çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>00000101</code>ï¼Œå³åŠ åå‘é”ã€‚</p>
<blockquote>
<p>å·¥å…·ç±»</p>
</blockquote>
<p>è¿™ä¸ªå·¥å…·ç±»ä¸»è¦æ˜¯å°†ç¹ççš„<code>ClassLayout.parseInstance(obj).toPrintable()</code>çš„è¯¦ç»†ä¿¡æ¯è¾“å‡ºåšä¸€æ­¥ç®€åŒ–ï¼Œåªè¾“å‡ºå…³äºMark Wordé”é‚£ä¸€è¡Œçš„éƒ¨åˆ†ï¼š</p>
<pre><code class="java">import org.openjdk.jol.info.ClassLayout;

/**
 * @author KHighness
 * @since 2021-04-09
 */

public class ClassLayoutUtil &#123;

    private final static int FIRST_LINE_START = 185;
    private final static int LINE_LENGTH = 53;

    public static String printSimple(ClassLayout instance) &#123;
        return instance.toPrintable().substring(FIRST_LINE_START, FIRST_LINE_START + LINE_LENGTH);
    &#125;

&#125;</code></pre>
<blockquote>
<p>æ’¤é”€åå‘é”-hashcodeæ–¹æ³•</p>
</blockquote>
<p>ä½¿ç”¨åå‘é”åˆ™è¿›å…¥BiasedçŠ¶æ€ï¼Œä½¿ç”¨<code>hashcode()</code>æ–¹æ³•åˆ™è¿›å…¥NormalçŠ¶æ€ã€‚</p>
<p>NormalçŠ¶æ€ä¸‹ï¼šMark Word(32) = hashcode(25) + age(4) + biased(1) + 01(2)</p>
<p>BiasedçŠ¶æ€ä¸‹ï¼šMark Word(32) = thread_id(23) + epoch(2) + biased(1) + 01(2) </p>
<pre><code class="java">@Slf4j(topic = &quot;HashcodeBiased&quot;)
public class HashcodeBiasedDemo &#123;
    /**
     * -XX:BiasedLockingStartupDelay=0  ç¦ç”¨åå‘é”å»¶è¿Ÿ
     */
    public static void main(String[] args) &#123;
        HashcodeBiased biased = new HashcodeBiased();
        log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased))); // åå‘é”
        log.debug(String.valueOf(biased.hashCode()));
        log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased))); // æ— é”
    &#125;
&#125;

class HashcodeBiased &#123;

&#125;</code></pre>
<p>è¾“å‡ºç»“æœï¼š</p>
<pre><code>2021-04-09 23:03:39.378 [main] DEBUG HashcodeBiased - 00 00 00 (00000101 00000000 00000000 00000000) (5)
2021-04-09 23:03:39.380 [main] DEBUG HashcodeBiased - 1268650975
2021-04-09 23:03:39.381 [main] DEBUG HashcodeBiased - df 13 9e (00000001 11011111 00010011 10011110) (-1642</code></pre>
<p>å¯ä»¥çœ‹åˆ°ç¬¬ä¸€è¡Œä¸º<code>101</code>ï¼Œç¬¬ä¸‰è¡Œä¸º<code>001</code>ï¼Œè¯´æ˜å¯¹è±¡çš„åå‘é”è¢«æ’¤é”€ã€‚</p>
<blockquote>
<p>æ’¤é”€åå‘é”-å…¶ä»–çº¿ç¨‹ä½¿ç”¨å¯¹è±¡</p>
</blockquote>
<p>å½“æœ‰å…¶ä»–çº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ã€‚</p>
<pre><code class="java">@Slf4j(topic = &quot;OtherThreadBiased&quot;)
public class OtherThreadBiasedDemo &#123;
    /**
     * -XX:BiasedLockingStartupDelay=0  ç¦ç”¨åå‘é”å»¶è¿Ÿ
     */
    public static void main(String[] args) &#123;
        OtherThreadBiased biased = new OtherThreadBiased();
        new Thread(() -&gt; &#123;
            log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased)));     //  åå‘é”
            synchronized (biased) &#123;
                log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased))); // åå‘é”
            &#125;
            log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased)));     // åå‘é”
            synchronized (OtherThreadBiased.class) &#123;
                OtherThreadBiased.class.notify();
            &#125;
        &#125;, &quot;t1&quot;).start();
        new Thread(() -&gt; &#123;
            synchronized (OtherThreadBiased.class) &#123;
                try &#123;
                    OtherThreadBiased.class.wait();
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
            log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased)));      // åå‘é”
            synchronized (biased) &#123;
                log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased)));  // åå‘é”
            &#125;
            log.debug(ClassLayoutUtil.printSimple(ClassLayout.parseInstance(biased)));      // æ— é”
        &#125;, &quot;t2&quot;).start();
    &#125;
&#125;

class OtherThreadBiased &#123;

&#125;</code></pre>
<p>è¾“å‡ºç»“æœï¼š</p>
<pre><code>2021-04-09 23:20:08.722 [t1] DEBUG OtherThreadBiased - 05 00 00 00 (00000101 00000000 00000000 00000000) (5)
2021-04-09 23:20:08.724 [t1] DEBUG OtherThreadBiased - 05 80 71 20 (00000101 10000000 01110001 00100000) (54
2021-04-09 23:20:08.725 [t1] DEBUG OtherThreadBiased - 05 80 71 20 (00000101 10000000 01110001 00100000) (54
2021-04-09 23:20:08.726 [t2] DEBUG OtherThreadBiased - 05 80 71 20 (00000101 10000000 01110001 00100000) (54
2021-04-09 23:20:08.727 [t2] DEBUG OtherThreadBiased - a0 f2 c0 20 (10100000 11110010 11000000 00100000) (54
2021-04-09 23:20:08.728 [t2] DEBUG OtherThreadBiased - 01 00 00 00 (00000001 00000000 00000000 00000000) (1)</code></pre>
<blockquote>
<p>æ’¤é”€åå‘é”-è°ƒç”¨wait/notify</p>
</blockquote>
<p>å› ä¸ºwait/notifyåªæœ‰é‡é‡çº§é”æ‰æœ‰ã€‚</p>
<blockquote>
<p>æ‰¹é‡é‡å®šå‘</p>
</blockquote>
<p>å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹T1çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„Thread IDã€‚</p>
<p>å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡20æ¬¡åï¼ŒJVMä¼šè¿™æ ·è§‰å¾—ï¼Œæˆ‘æ˜¯ä¸æ˜¯åå‘é”™äº†å‘¢ï¼Œäºæ˜¯ä¼šå†ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹ã€‚</p>
<blockquote>
<p>æ‰¹é‡æ’¤é”€</p>
</blockquote>
<p>å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡40æ¬¡åï¼ŒJVMä¼šè¿™æ ·è§‰å¾—ï¼Œè‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ï¼Œäºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„ã€‚</p>
<blockquote>
<p>é”æ¶ˆé™¤</p>
</blockquote>
<ul>
<li>çº¿ç¨‹åŒæ­¥çš„ä»£ä»·æ˜¯ç›¸å½“é«˜çš„ï¼ŒåŒæ­¥çš„åæœæ˜¯é™ä½å¹¶å‘æ€§å’Œæ€§èƒ½ã€‚</li>
<li>åœ¨åŠ¨æ€ç¼–è¯‘åŒæ­¥å—çš„æ—¶å€™ï¼ŒJITç¼–è¯‘å™¨å¯ä»¥å€ŸåŠ©é€ƒé€¸åˆ†ææ¥åˆ¤æ–­åŒæ­¥å—æ‰€ä½¿ç”¨çš„é”å¯¹è±¡æ˜¯å¦åªèƒ½å¤Ÿè¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®è€Œæ²¡æœ‰è¢«å‘å¸ƒåˆ°å…¶ä»–çº¿ç¨‹ã€‚</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆJITç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿™ä¸ªåŒæ­¥å—çš„æ—¶å€™å°±ä¼šå–æ¶ˆå¯¹è¿™éƒ¨åˆ†ä»£ç çš„åŒæ­¥ã€‚</li>
</ul>
<h2 id="2-3-ç¬¬ä¸‰éƒ¨åˆ†-æ¨¡å¼"><a href="#2-3-ç¬¬ä¸‰éƒ¨åˆ†-æ¨¡å¼" class="headerlink" title="2.3 ç¬¬ä¸‰éƒ¨åˆ†-æ¨¡å¼"></a>2.3 ç¬¬ä¸‰éƒ¨åˆ†-æ¨¡å¼</h2><h3 id="2-3-1-wait-notify"><a href="#2-3-1-wait-notify" class="headerlink" title="2.3.1 wait notify"></a>2.3.1 wait notify</h3><blockquote>
<p>wait/notifyåŸç†</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210410164622176.png" class="" title="image-20210410164622176">



<ul>
<li><code>Owner</code>çº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨<code>wait</code>æ–¹æ³•ï¼Œå³å¯è¿›å…¥<code>WaitSet</code>å˜æˆ<code>WAITING</code>çŠ¶æ€</li>
<li><code>BLOCKED</code>å’Œ<code>WAITING</code>çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨CPUæ—¶é—´ç‰‡</li>
<li><code>BLOCKED</code>çº¿ç¨‹ä¼šåœ¨<code>Owner</code>çº¿ç¨‹åŠ é”æ—¶å”¤é†’</li>
<li><code>WAITING</code>çº¿ç¨‹ä¼šåœ¨<code>Owner</code>çº¿ç¨‹è°ƒç”¨<code>notify</code>æˆ–<code>notifyAll</code>æ—¶å”¤é†’ï¼Œä½†å”¤é†’åå¹¶ä¸æ„å‘³ç€ç«‹åˆ»è·å¾—é”ï¼Œä»éœ€è¿›å…¥<code>EntryList</code>é‡æ–°ç«äº‰ã€‚</li>
</ul>
<blockquote>
<p>APIä»‹ç»</p>
</blockquote>
<ul>
<li><code>obj.wait()</code> è®©è¿›å…¥objectç›‘è§†å™¨çš„çº¿ç¨‹åˆ°<code>WaitSet</code>ç­‰å¾…</li>
<li><code>obj.notify()</code> åœ¨objectä¸Šæ­£åœ¨<code>WaitSet</code>ç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’</li>
<li><code>obj.notifyAll()</code> è®©objectä¸Šæ­£åœ¨<code>WaitSet</code>ç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’</li>
</ul>
<p>å®ƒä»¬éƒ½æ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œåä½œçš„æ‰‹æ®µï¼Œéƒ½å±äºobjectå¯¹è±¡çš„æ–¹æ³•ï¼Œå¿…é¡»è·å¾—æ­¤å¯¹è±¡çš„é”ï¼Œæ‰èƒ½è°ƒç”¨è¿™å‡ ä¸ªæ–¹æ³•ã€‚</p>
<p>æ¡ˆä¾‹ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;WaitNotify&quot;)
public class WaitNotifyDemo &#123;
    final static Object obj = new Object();

    public static void main(String[] args) throws InterruptedException &#123;
        new Thread(() -&gt; &#123;
            synchronized (obj) &#123;
                log.debug(&quot;æ‰§è¡Œ...&quot;);
                try &#123;
                    obj.wait();
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                log.debug(&quot;å…¶å®ƒä»£ç ...&quot;);
            &#125;
        &#125;, &quot;t1&quot;).start();
        new Thread(() -&gt; &#123;
            synchronized (obj) &#123;
                log.debug(&quot;æ‰§è¡Œ...&quot;);
                try &#123;
                    obj.wait();
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                log.debug(&quot;å…¶å®ƒä»£ç ...&quot;);
            &#125;
        &#125;, &quot;t2&quot;).start();
        TimeUnit.SECONDS.sleep(1);
        log.debug(&quot;å”¤é†’objä¸Šå…¶ä»–çº¿ç¨‹&quot;);
        synchronized (obj) &#123;
            obj.notify();     // (1)
            obj.notifyAll();  // (2)
        &#125;
    &#125;
&#125;
</code></pre>
<p>æ³¨é‡Šï¼ˆ2ï¼‰ï¼Œå³è°ƒç”¨<code>obj.notify()</code>ï¼š</p>
<pre><code>2021-04-10 19:53:10.709 [t1] DEBUG WaitNotify - æ‰§è¡Œ...
2021-04-10 19:53:10.711 [t2] DEBUG WaitNotify - æ‰§è¡Œ...
2021-04-10 19:53:11.717 [main] DEBUG WaitNotify - å”¤é†’objä¸Šå…¶ä»–çº¿ç¨‹
2021-04-10 19:53:11.717 [t1] DEBUG WaitNotify - å…¶å®ƒä»£ç ...</code></pre>
<p>æ³¨é‡Šï¼ˆ1ï¼‰ï¼Œå³è°ƒç”¨<code>obj.notifyAll()</code>ï¼š</p>
<pre><code>2021-04-10 19:54:13.288 [t1] DEBUG WaitNotify - æ‰§è¡Œ...
2021-04-10 19:54:13.289 [t2] DEBUG WaitNotify - æ‰§è¡Œ...
2021-04-10 19:54:14.296 [main] DEBUG WaitNotify - å”¤é†’objä¸Šå…¶ä»–çº¿ç¨‹
2021-04-10 19:54:14.296 [t2] DEBUG WaitNotify - å…¶å®ƒä»£ç ...
2021-04-10 19:54:14.296 [t1] DEBUG WaitNotify - å…¶å®ƒä»£ç ...</code></pre>
<p>å¯ä»¥çœ‹åˆ°<code>notify</code>åªèƒ½å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œ<code>notifyAll</code>å”¤é†’äº†æ‰€æœ‰çº¿ç¨‹ã€‚</p>
<blockquote>
<p>sleepä¸wait</p>
</blockquote>
<p><code>Thread#sleep()</code>ä¸<code>Object#wait()</code></p>
<p>ç›¸åŒç‚¹ï¼š</p>
<ul>
<li>çº¿ç¨‹è¿›å…¥äº†<code>sleep</code>å’Œ<code>wait</code>éƒ½è¿›å…¥<code>TIMED_WAITING</code>çŠ¶æ€ã€‚</li>
</ul>
<p>ä¸åŒç‚¹ï¼š</p>
<ul>
<li><code>sleep</code>ä¸éœ€è¦å¼ºåˆ¶å’Œ<code>synchronized</code>é…åˆä½¿ç”¨ï¼Œä½†æ˜¯<code>wait</code>ä¸€å®šè¦å’Œ<code>synchronized</code>é…åˆä½¿ç”¨</li>
<li><code>sleep</code>åœ¨ç¡çœ çš„åŒæ—¶ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œä½†æ˜¯<code>wait</code>åœ¨ç­‰å¾…æ—¶ä¼šé‡Šæ”¾å¯¹è±¡é”ã€‚</li>
</ul>
<p>æ¡ˆä¾‹ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;SleepAndWait&quot;)
public class SleepAndWaitDemo &#123;

    private static final Object lock = new Object();

    public static void main(String[] args) throws InterruptedException &#123;
        new Thread(() -&gt; &#123;
            synchronized (lock) &#123;
                log.debug(&quot;è·å¾—é”&quot;);
                try &#123;
                    Thread.sleep(20_000);  // (1)
                    lock.wait(20_000);   // (2)
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125;, &quot;t1&quot;).start();
        TimeUnit.SECONDS.sleep(1);
        synchronized (lock) &#123;
            log.debug(&quot;è·å¾—é”&quot;);
        &#125;
    &#125;
&#125;</code></pre>
<p>æ³¨é‡Šï¼ˆ2ï¼‰ï¼Œå³è°ƒç”¨<code>Thread.sleep()</code>ï¼š</p>
<pre><code>2021-04-10 20:23:40.382 [t1] DEBUG SleepAndWait - è·å¾—é”
2021-04-10 20:24:00.386 [main] DEBUG SleepAndWait - è·å¾—é”</code></pre>
<p>æ³¨é‡Šï¼ˆ1ï¼‰ï¼Œå³è°ƒç”¨<code>obj.wait()</code>ï¼š</p>
<pre><code class="java">2021-04-10 20:26:40.335 [t1] DEBUG SleepAndWait - è·å¾—é”
2021-04-10 20:26:41.335 [main] DEBUG SleepAndWait - è·å¾—é”</code></pre>
<p>å¯ä»¥çœ‹åˆ°sleepæƒ…å†µä¸‹ä¸»çº¿ç¨‹20Såæ‰æ‹¿åˆ°é”ï¼Œè€Œwaitæƒ…å†µä¸‹ä¸»çº¿ç¨‹ç«‹å³å¯ä»¥æ‹¿åˆ°é”ã€‚</p>
<blockquote>
<p>wait/notifyæ­£ç¡®å§¿åŠ¿</p>
</blockquote>
<pre><code class="java">// ä¸€ä¸ªçº¿ç¨‹
synchronized (lock) &#123;
    while (condition) &#123; // é˜²æ­¢è™šå‡å”¤é†’
        lock.wait();
    &#125;
    // do something
&#125;

// å¦ä¸€ä¸ªçº¿ç¨‹
synchronized (lock) &#123;
    lock.notifyAll();
&#125;</code></pre>
<h3 id="2-3-2-åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ"><a href="#2-3-2-åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ" class="headerlink" title="2.3.2 åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ"></a>2.3.2 åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</h3><blockquote>
<p>è¦ç‚¹</p>
</blockquote>
<p>Guarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœã€‚</p>
<ul>
<li>æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©ä»–ä»¬å…³è”åˆ°ä¸€ä¸ªGuarded Object</li>
<li>å¦‚æœæœ‰ç»“æœä¸æ–­ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰</li>
<li>JDKä¸­ï¼Œjoinçš„å®ç°ã€futureçš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼</li>
<li>å› ä¸ºè¦ç­‰å¾…å¦ä¸€æ–¹çš„ç»“æœï¼Œå› æ­¤å½’ç±»åˆ°åŒæ­¥æ¨¡å¼</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210411112747728.png" class="" title="image-20210411112747728">



<blockquote>
<p>ç¤ºä¾‹</p>
</blockquote>
<p>ä¸€ä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ä¸‹è½½ç»“æœï¼Œå¹¶ä¸”è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚</p>
<pre><code class="java">@Slf4j(topic = &quot;GuardedObject&quot;)
public class GuardedObjectDemo &#123;

    public static void main(String[] args) &#123;
        GuardedObject guardedObject = new GuardedObject();
        // è·å–ç»“æœçº¿ç¨‹
        new Thread(() -&gt; &#123;
            log.debug(&quot;ç­‰å¾…ç»“æœ&quot;);
            List&lt;String&gt; response = (List&lt;String&gt;) guardedObject.getResponse(5000);
            if (response != null) &#123;
                log.debug(&quot;ç»“æœå¤§å°ï¼š&#123;&#125;&quot;, response.size());
            &#125; else &#123;
                log.debug(&quot;ä¸‹è½½å¤±è´¥&quot;);
            &#125;
        &#125;, &quot;receive&quot;).start();
        // ä¸‹è½½å†…å®¹çº¿ç¨‹
        new Thread(() -&gt; &#123;
            log.debug(&quot;æ‰§è¡Œä¸‹è½½&quot;);
            List&lt;String&gt; download = ParaKDownloader.download(&quot;https://www.parak.top&quot;);
            guardedObject.setResponse(download);
        &#125;, &quot;download&quot;).start();
    &#125;
&#125;

class GuardedObject &#123;
    // ç»“æœ
    private Object response;

    // è·å–ç»“æœ
    public Object getResponse(long timeout) &#123;
        synchronized (this) &#123;
            // å¼€å§‹æ—¶é—´
            long start = System.currentTimeMillis();
            // ç»å†æ—¶é—´
            long pass = 0;
            // æ²¡æœ‰ç»“æœ
            while (response == null) &#123;
                // æ­¤è½®å¾ªç¯åº”è¯¥ç­‰å¾…çš„æ—¶é—´
                long wait = timeout - pass;
                if (wait &lt;= 0) &#123;
                    break;
                &#125;
                try &#123;
                    this.wait(wait);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                pass = System.currentTimeMillis() - start;
            &#125;
            return response;
        &#125;
    &#125;

    // äº§ç”Ÿç»“æœ
    public void setResponse(Object response) &#123;
        synchronized (this) &#123;
            this.response = response;
            this.notifyAll();
        &#125;
    &#125;
&#125;

class ParaKDownloader &#123;
    public static List&lt;String&gt; download(String url) &#123;
        HttpURLConnection connection = null;
        List&lt;String&gt; res = new ArrayList&lt;&gt;();
        String line = null;
        try &#123;
            connection = (HttpURLConnection) new URL(url).openConnection();
            BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), StandardCharsets.UTF_8));
            while ((line = reader.readLine()) != null) &#123;
                res.add(line);
            &#125;
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;
        return res;
    &#125;
&#125;</code></pre>
<blockquote>
<p>joinåŸç†</p>
</blockquote>
<p>çœ‹ä¸€çœ‹<code>Thread#join()</code>çš„æºä»£ç ï¼Œå³æ˜¯åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœçš„åº”ç”¨ã€‚</p>
<pre><code class="java">public final synchronized void join(long millis) throws InterruptedException &#123;
    long base = System.currentTimeMillis();  // å¼€å§‹æ—¶é—´
    long now = 0;                            // å½“å‰æ—¶é—´
    if (millis &lt; 0) &#123; // å‚æ•°æ ¡éªŒ
        throw new IllegalArgumentException(&quot;timeout value is negative&quot;);
    &#125;

    if (millis == 0) &#123; // ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°çº¿ç¨‹ç»“æŸ
        while (isAlive()) &#123;
            wait(0);
        &#125;
    &#125; else &#123;
        while (isAlive()) &#123;
            long delay = millis - now; // è¿™è½®éœ€è¦ç­‰å¾…çš„æ—¶é—´
            if (delay &lt;= 0) &#123;
                break;
            &#125;
            wait(delay);               // ç­‰å¾…
            now = System.currentTimeMillis() - base; // ç»è¿‡æ—¶é—´
        &#125;
    &#125;
&#125;</code></pre>
<blockquote>
<p>æ‰©å±•</p>
</blockquote>
<p>å¦‚æœéœ€è¦åœ¨å¤šä¸ªç±»ä¸­é—´ä½¿ç”¨<code>GuardedObject</code>å¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œå› æ­¤è®¾è®¡ä¸€ä¸ªç”¨æ¥è§£è€¦çš„ä¸­é—´ç±»ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210411231829154.png" class="" title="image-20210411231829154">

<p>æ¯”å¦‚ä¸€ä¸ªå°åŒºæœ‰ä¸€ä¸ªä¿¡ç®±ï¼Œæ¯ä¸ªå±…æ°‘åªéœ€è¦åœ¨ä¿¡ç®±é‡Œæ ¹æ®IDå–åˆ°è‡ªå·±çš„ä¿¡ä»¶ï¼Œè€Œæ¯ä¸€å°ä¿¡ä»¶éƒ½ç”±ä¸åŒçš„é‚®é€’å‘˜é€è¾¾ã€‚</p>
<pre><code class="java">public class MailBoxesDemo &#123;
    public static void main(String[] args) throws InterruptedException &#123;
        for (int i = 0; i &lt; 5; i++) &#123;
            new People().start();
        &#125;
        TimeUnit.SECONDS.sleep(1);
        for (Integer id : MailBoxes.getIds()) &#123;
            new Postman(id, &quot;å†…å®¹&quot; + id).start();
        &#125;
    &#125;
&#125;

// å±…æ°‘
@Slf4j(topic = &quot;People&quot;)
class People extends Thread &#123;
    @Override
    public void run() &#123;
        Mail mail = MailBoxes.createMail();
        log.debug(&quot;å¼€å§‹æ”¶ä¿¡: &#123;&#125;&quot;, mail.getId());
        String content = (String) mail.getContent(5000);
        log.debug(&quot;æ”¶åˆ°ä¿¡ä»¶: &#123;&#125;&quot;,  content);
    &#125;
&#125;

// é‚®é€’å‘˜
@Slf4j(topic = &quot;Postman&quot;)
class Postman extends Thread&#123;
    private int id;
    private String content;

    public Postman(int id, String content) &#123;
        this.id = id;
        this.content = content;
    &#125;

    @Override
    public void run() &#123;
        Mail mail = MailBoxes.getMail(id);
        log.debug(&quot;é€ä¿¡ [id=&#123;&#125;, content=&#123;&#125;]&quot;, id, content);
        mail.setContent(content);
    &#125;
&#125;

// ä¿¡ç®±
class MailBoxes &#123;
    private static Map&lt;Integer, Mail&gt; boxes = new Hashtable&lt;&gt;();

    private static int id = 0;

    private static synchronized int generateId() &#123;
        return ++id;
    &#125;

    public static Mail getMail(int id) &#123;
        return boxes.remove(id);
    &#125;

    public static Mail createMail() &#123;
        int id = generateId();
        Mail mail = new Mail(id);
        boxes.put(id, mail);
        return mail;
    &#125;

    public static Set&lt;Integer&gt; getIds() &#123;
        return boxes.keySet();
    &#125;
&#125;

// ä¿¡ä»¶
class Mail &#123;
    // ä¿¡ä»¶ID
    private final int id;

    public Mail(int id) &#123;
        this.id = id;
    &#125;

    public int getId() &#123;
        return id;
    &#125;

    // ä¿¡ä»¶å†…å®¹
    private Object content;

    // è·å–å†…å®¹
    public Object getContent(long timeout) &#123;
        synchronized (this) &#123;
            // å¼€å§‹æ—¶é—´
            long start = System.currentTimeMillis();
            // ç»å†æ—¶é—´
            long pass = 0;
            // æ²¡æœ‰ç»“æœ
            while (content == null) &#123;
                // æ­¤è½®å¾ªç¯åº”è¯¥ç­‰å¾…çš„æ—¶é—´
                long wait = timeout - pass;
                if (wait &lt;= 0) &#123;
                    break;
                &#125;
                try &#123;
                    this.wait(wait);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                pass = System.currentTimeMillis() - start;
            &#125;
            return content;
        &#125;
    &#125;

    // è®¾ç½®å†…å®¹
    public void setContent(Object content) &#123;
        synchronized (this) &#123;
            this.content = content;
            this.notifyAll();
        &#125;
    &#125;
&#125;</code></pre>
<h3 id="2-3-3-å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…-æ¶ˆè´¹è€…"><a href="#2-3-3-å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…-æ¶ˆè´¹è€…" class="headerlink" title="2.3.3 å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…"></a>2.3.3 å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…/æ¶ˆè´¹è€…</h3><blockquote>
<p>è¦ç‚¹</p>
</blockquote>
<ul>
<li>æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„èµ„æº</li>
<li>ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸å…³å¿ƒæ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡é™åˆ¶çš„ï¼Œæ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®</li>
<li>JDKä¸­å„ç§é˜»å¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210411232117401.png" class="" title="image-20210411232117401">



<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">public class MessageQueueDemo &#123;
    public static void main(String[] args) &#123;
        MessageQueue queue = new MessageQueue(2);
        // 3ä¸ªç”Ÿäº§è€…
        for (int i = 0; i &lt; 3; i++) &#123;
            final int id = i + 1;
            new Thread(() -&gt; &#123;
                queue.put(new Message(id, &quot;å€¼&quot; + id));
            &#125;, &quot;ç”Ÿäº§è€…&quot; + id).start();
        &#125;
        // 1ä¸ªæ¶ˆè´¹è€…
        new Thread(() -&gt; &#123;
            while (true) &#123;
                // 1Sæ¶ˆè´¹ä¸€ä¸ªçº¿ç¨‹
                try &#123;
                    TimeUnit.SECONDS.sleep(1);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                queue.get();
            &#125;
        &#125;, &quot;æ¶ˆè´¹è€…&quot;).start();
    &#125;
&#125;

// æ¶ˆæ¯é˜Ÿåˆ—ç±»
@Slf4j(topic = &quot;MessageDemo&quot;)
class MessageQueue &#123;
    // æ¶ˆæ¯é˜Ÿåˆ—é›†åˆ
    private LinkedList&lt;Message&gt; list;
    // æ¶ˆæ¯é˜Ÿåˆ—å®¹é‡
    private int capacity;

    public MessageQueue(int capacity) &#123;
        this.capacity = capacity;
        this.list = new LinkedList&lt;&gt;();
    &#125;

    // è·å–æ¶ˆæ¯
    public Message get() &#123;
        // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
        synchronized (list) &#123;
            while (list.isEmpty()) &#123;
                try &#123;
                    log.debug(&quot;é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…&quot;);
                    list.wait();
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
            // ä»é˜Ÿåˆ—å¤´éƒ¨è·å–æ¶ˆæ¯å¹¶è¿”å›
            Message message = list.removeFirst();
            log.debug(&quot;æ¶ˆè´¹æ¶ˆæ¯ &lt;= &#123;&#125;&quot;, message.toString());
            list.notifyAll();
            return message;
        &#125;
    &#125;

    // å­˜å…¥æ¶ˆæ¯
    public void put(Message message) &#123;
        synchronized (list) &#123;
            // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å·²æ»¡
            while (list.size() == capacity) &#123;
                try &#123;
                    log.debug(&quot;é˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…&quot;);
                    list.wait();
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
            // å°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨
            list.addLast(message);
            log.debug(&quot;ç”Ÿäº§æ¶ˆæ¯ =&gt; &#123;&#125;&quot;, message.toString());
            list.notifyAll();
        &#125;
    &#125;
&#125;

// æ¶ˆæ¯
class Message &#123;
    private int id;
    private Object value;

    public Message(int id, Object value) &#123;
        this.id = id;
        this.value = value;
    &#125;

    public int getId() &#123;
        return id;
    &#125;

    public Object getValue() &#123;
        return value;
    &#125;

    @Override
    public String toString() &#123;
        return &quot;Message[&quot; +
                &quot;id=&quot; + id +
                &quot;, value=&quot; + value +
                &#39;]&#39;;
    &#125;
&#125;</code></pre>
<h3 id="2-3-4-park-unprak"><a href="#2-3-4-park-unprak" class="headerlink" title="2.3.4 park unprak"></a>2.3.4 park unprak</h3><blockquote>
<p>ä»‹ç»</p>
</blockquote>
<p>å®ƒä»¬æ˜¯<code>LockSupport</code>ç±»ä¸­çš„æ–¹æ³•ï¼š</p>
<pre><code class="java">// æš‚åœå½“å‰çº¿ç¨‹
LockSupport.park();
// æ¢å¤çº¿ç¨‹è¿è¡Œ
LockSupport.unpark(Thread thread);</code></pre>
<blockquote>
<p>ç‰¹ç‚¹</p>
</blockquote>
<p><code>park &amp; unpark</code> ä¸<code>wait &amp; notify</code></p>
<ul>
<li><code>wai</code>tã€<code>notify</code>å’Œ<code>notifyAll</code>å¿…é¡»é…åˆObject Monitorä¸€èµ·ä½¿ç”¨ï¼Œè€Œ<code>park</code>å’Œ<code>unpark</code>ä¸å¿…ã€‚</li>
<li><code>park/unpark</code>æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½ç±»ã€é˜»å¡ã€‘å’Œã€å”¤é†’ã€‘çº¿ç¨‹ï¼Œè€Œ<code>notify</code>åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼Œ<code>notifyAll</code>æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°±ä¸é‚£ä¹ˆã€ç²¾ç¡®ã€‘ã€‚</li>
<li><code>park &amp; unpark</code>å¯ä»¥å…ˆ<code>unpark</code>ï¼Œè€Œ<code>wait &amp; notify</code>ä¸èƒ½å…ˆ<code>notify</code>ã€‚</li>
</ul>
<blockquote>
<p>ç¤ºä¾‹</p>
</blockquote>
<pre><code class="java">@Slf4j(topic = &quot;ParkUnpark&quot;)
public class ParkUnparkDemo &#123;
    public static void main(String[] args) &#123;
        Scanner sc = new Scanner(System.in);
        String str  = null;
        while (!(str = sc.nextLine()).equals(&quot;&quot;)) &#123;
            String[] s = str.split(&quot; &quot;);
            int time1 = Integer.parseInt(s[0]);
            int time2 = Integer.parseInt(s[1]);

            // park
            Thread t1 = new Thread(() -&gt; &#123;
                log.debug(&quot;start...&quot;);
                try &#123;
                    TimeUnit.SECONDS.sleep(time1);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                log.debug(&quot;park...&quot;);
                LockSupport.park();
                log.debug(&quot;continue...&quot;);
            &#125;, &quot;t1&quot;);
            t1.start();
            // unpark
            try &#123;
                TimeUnit.SECONDS.sleep(time2);
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
            // unparkæ—¢å¯ä»¥åœ¨parkä¹‹å‰è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨parkä¹‹åè°ƒç”¨
            log.debug(&quot;unpark...&quot;);
            LockSupport.unpark(t1);
        &#125;
    &#125;
&#125;</code></pre>
<p>è¿è¡Œç»“æœï¼š</p>
<pre><code class="powershell">1 2
2021-04-18 20:20:53.213 [t1] DEBUG ParkUnpark - start...
2021-04-18 20:20:54.217 [t1] DEBUG ParkUnpark - park...
2021-04-18 20:20:55.226 [main] DEBUG ParkUnpark - unpark...
2021-04-18 20:20:55.226 [t1] DEBUG ParkUnpark - continue...
2 1
2021-04-18 20:20:57.756 [t1] DEBUG ParkUnpark - start...
2021-04-18 20:20:58.771 [main] DEBUG ParkUnpark - unpark...
2021-04-18 20:20:59.762 [t1] DEBUG ParkUnpark - park...
2021-04-18 20:20:59.762 [t1] DEBUG ParkUnpark - continue...
</code></pre>
<p>ç¬¬ä¸€æ¬¡è¾“å…¥ï¼Œ<code>time1</code> = 1ï¼Œ <code>time2</code> = 2ï¼Œäºæ˜¯å…ˆæ‰§è¡Œ<code>park</code>ï¼Œåæ‰§è¡Œ<code>unpark</code>ï¼Œæœ€ç»ˆæ‰§è¡Œäº†<code>continue</code>ï¼›</p>
<p>ç¬¬ä¸€æ¬¡è¾“å…¥ï¼Œ<code>time1</code> = 2ï¼Œ <code>time2</code> = 1ï¼Œäºæ˜¯å…ˆæ‰§è¡Œ<code>unpark</code>ï¼Œåæ‰§è¡Œ<code>park</code>ï¼Œæœ€ç»ˆä¹Ÿæ‰§è¡Œäº†<code>continue</code>ã€‚</p>
<p>è¯æ˜<code>unpark</code>çš„æ‰§è¡Œæ¯”è¾ƒéšæ„ã€‚</p>
<blockquote>
<p>park/unparkåŸç†</p>
</blockquote>
<p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„Parkerå¯¹è±¡ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š<code>_countrer</code>ã€<code>_cond</code>å’Œ<code> _mutex</code>æ‰“ä¸ªæ¯”å–»ã€‚</p>
<ul>
<li>çº¿ç¨‹å°±åƒä¸€ä¸ªæ—…äººï¼ŒParkerå°±åƒä¸ºä»–éšèº«æºå¸¦çš„èƒŒåŒ…ï¼Œ<code>_cond</code>å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¸ç¯·ï¼Œ<code>_counter</code></li>
</ul>
<p>å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¤‡ç”¨å¹²ç²®ï¼ˆ0ä¸ºè€—å°½ï¼Œ1ä¸ºå……è¶³ï¼‰</p>
<ul>
<li>è°ƒç”¨<code>park</code>å°±æ˜¯è¦çœ‹éœ€ä¸éœ€è¦åœä¸‹æ¥æ­‡æ¯<ul>
<li>å¦‚æœå¤‡ç”¨å¹²ç²®è€—å°½ï¼ˆ<code>_counter</code> = 0ï¼‰ï¼Œé‚£ä¹ˆé’»è¿›å¸ç¯·æ­‡æ¯ã€‚</li>
<li>å¦‚æœå¤‡ç”¨å¹²ç²®å……è¶³ï¼ˆ<code>_counter</code> = 1ï¼‰ï¼Œé‚£ä¹ˆå°±ä¸éœ€åœç•™ï¼Œç»§ç»­å‰è¿›ã€‚</li>
</ul>
</li>
<li>è°ƒç”¨<code>unpark</code>ï¼Œå°±å¥½æ¯”å‘èƒŒåŒ…ä¸­è¡¥å……å¹²ç²®<ul>
<li>å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨æ•ç¯·ï¼Œå°±å”¤é†’è®©ä»–ç»§ç»­å‰è¿›ã€‚</li>
<li>å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆä¸‹æ¬¡ä»–è°ƒç”¨<code>park</code>æ—¶ï¼Œä»…æ˜¯æ¶ˆè€—æ‰å¤‡ç”¨å¹²ç²®ï¼Œä¸éœ€åœç•™ç»§ç»­å‰è¿›ã€‚<ul>
<li>å› ä¸ºèƒŒåŒ…ç©ºé—´æœ‰é™ï¼Œå¤šæ¬¡è°ƒç”¨<code>unpark</code>ä»…ä¼šè¡¥å……ä¸€ä»½å¤‡ç”¨å¹²ç²®ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>å›¾ç¤º</strong></p>
<p>ï¼ˆ1ï¼‰å…ˆè°ƒç”¨<code>park</code>å†è°ƒç”¨<code>unpark</code></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210418212139187.png" class="" title="image-20210418212139187">

<ol>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>Unsafe.park()</code>æ–¹æ³•</li>
<li>æ£€æŸ¥<code>_counter</code>ï¼Œæœ¬æƒ…å†µä¸º0ï¼Œè¿™æ—¶ï¼Œè·å¾—<code>_mutex</code>äº’æ–¥é”</li>
<li>çº¿ç¨‹è¿›å…¥<code>_cond</code>æ¡ä»¶å˜é‡é˜»å¡</li>
<li>è®¾ç½®<code>_counter = 0</code></li>
</ol>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210419110033795.png" class="" title="image-20210419110033795">

<ol>
<li>è°ƒç”¨<code>Unsafe.unpark(Thread_0)</code>æ–¹æ³•ï¼Œè®¾ç½®<code>_counter</code>ä¸º1</li>
<li>å”¤é†’<code>_cond</code>æ¡ä»¶å˜é‡ä¸­çš„<code>Thread_0</code></li>
<li><code>Thread_0</code>æ¢å¤è¿è¡Œ</li>
<li>è®¾ç½®<code>_counter</code>ä¸º0</li>
</ol>
<p>ï¼ˆ2ï¼‰å…ˆè°ƒç”¨<code>unpark</code>å†è°ƒç”¨<code>park</code></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210419214214099.png" class="" title="image-20210419214214099">

<ol>
<li>è°ƒç”¨<code>Unsafe.unpark(Thread)0</code>æ–¹æ³•ï¼Œè®¾ç½®<code>_counter</code>ä¸º1</li>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>Unsafe.park()</code>æ–¹æ³•</li>
<li>æ£€æŸ¥<code>_counter</code>ï¼Œæœ¬æƒ…å†µä¸º1ï¼Œè¿™æ—¶çº¿ç¨‹æ— éœ€é˜»å¡ï¼Œç»§ç»­è¿è¡Œ</li>
<li>è®¾ç½®<code>_counter</code>ä¸º0</li>
</ol>
<h3 id="2-3-5-çº¿ç¨‹çŠ¶æ€è½¬æ¢"><a href="#2-3-5-çº¿ç¨‹çŠ¶æ€è½¬æ¢" class="headerlink" title="2.3.5 çº¿ç¨‹çŠ¶æ€è½¬æ¢"></a>2.3.5 çº¿ç¨‹çŠ¶æ€è½¬æ¢</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210419222926434.png" class="" title="image-20210419222926434">

<p>å‡è®¾æœ‰çº¿ç¨‹t:</p>
<p>ï¼ˆ1ï¼‰æƒ…å†µ1ï¼š<code>NEW</code> ==&gt; <code>RUNNABLE</code></p>
<p>å½“è°ƒç”¨<code>t.start()</code>æ–¹æ³•æ—¶ï¼Œç”±<code>NEW</code> =&gt; <code>RUNNABLE</code></p>
<p>ï¼ˆ2ï¼‰æƒ…å†µ2ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>WAITING</code></p>
<p><code>t</code>çº¿ç¨‹ç”¨<code>synchronized(obj)</code>è·å–äº†å¯¹è±¡é”å</p>
<ul>
<li><p>è°ƒç”¨<code>obj.wait()</code>æ–¹æ³•æ—¶ï¼Œtçº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>WAITING</code></p>
</li>
<li><p>è°ƒç”¨<code>obj.notify()</code>ã€<code>obj.notifyAll()</code>ã€<code>t.interrupt()</code>æ—¶</p>
<ul>
<li>ç«äº‰é”æˆåŠŸï¼Œtçº¿ç¨‹ä»<code>WAITING</code> ==&gt; <code>RUNNABLE</code></li>
<li>ç«äº‰é”å¤±è´¥ï¼Œtçº¿ç¨‹ä»<code>WAITING</code> ==&gt; <code>BLOCKED</code></li>
</ul>
</li>
</ul>
<p>ï¼ˆ3ï¼‰æƒ…å†µ3ï¼š<code>RUNNABLE</code> &lt;==&gt; <code> WAITING</code></p>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>t.join()</code>æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>WAITING</code><ul>
<li>æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨<code>t</code>çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾… </li>
</ul>
</li>
<li><code>t</code>çº¿ç¨‹è¿è¡Œç»“æŸï¼Œæˆ–è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt()</code>æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>WAITING</code> ==&gt; <code>RUNNABLE</code></li>
</ul>
<p>ï¼ˆ4ï¼‰æƒ…å†µ4ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>WAITING</code></p>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>LockSupport.park()</code>æ–¹æ³•ä¼šè®©å½“å‰çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>WAITING</code></li>
<li>è°ƒç”¨<code>LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)</code>æˆ–è€…è°ƒç”¨äº†çº¿ç¨‹çš„<code>interrupt()</code>ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä»<code>WAITING</code> ==&gt; <code>RUNNABLE</code></li>
</ul>
<p>ï¼ˆ5ï¼‰æƒ…å†µ5ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>WAITING</code></p>
<p><code>t</code>çº¿ç¨‹ç”¨<code>synchronized(obj)</code>è·å–äº†å¯¹è±¡é”å</p>
<ul>
<li>è°ƒç”¨<code>obj.wait(long n)</code>æ–¹æ³•æ—¶ï¼Œ<code>t</code>çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>TIMED_WAITING</code></li>
<li><code>t</code>çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº†næ¯«ç§’ï¼Œæˆ–è°ƒç”¨<code>obj.notify()</code>ï¼Œ<code>obj.notifyAll()</code>ï¼Œ<code>t.interrupt()</code>æ—¶<ul>
<li>ç«äº‰æ—¶æˆåŠŸï¼Œ<code>t</code>çº¿ç¨‹ä»<code>TIMED_WAITING</code> ==&gt; <code>RUNNABLE</code></li>
<li>ç«äº‰é”å¤±è´¥ï¼Œ<code>t</code>çº¿ç¨‹ä»<code>TIMED_WAITING</code> ==&gt; <code>BLOCKED</code></li>
</ul>
</li>
</ul>
<p>ï¼ˆ6ï¼‰æƒ…å†µ6ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>TIMED_WAITING</code></p>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>t.join(long n)</code>æ–¹æ³•æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>TIMED_WAITING</code><ul>
<li>æ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨<code>t</code>çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</li>
</ul>
</li>
<li>å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº†næ¯«ç§’ï¼Œæˆ–è€…<code>t</code>çº¿ç¨‹è¿è¡Œç»“æŸï¼Œæˆ–è€…è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„<code>interrupt()</code>æ—¶ï¼Œå½“å‰çº¿ç¨‹ä»<code>TIMED_WAITING</code> ==&gt; <code>RUNNABLE</code></li>
</ul>
<p>ï¼ˆ7ï¼‰æƒ…å†µ7ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>TIMED_WAITING</code></p>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>Thread.sleep(long n)</code>ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>TIMED_WAITING</code></li>
<li>å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡äº†næ¯«ç§’ï¼Œå½“å‰çº¿ç¨‹ä»<code>TIMED_WAITING</code> ==&gt; <code>RUNNABLE</code></li>
</ul>
<p>ï¼ˆ8ï¼‰æƒ…å†µ8ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>TIMED_WAITING</code></p>
<ul>
<li>å½“å‰çº¿ç¨‹è°ƒç”¨<code>LockSupport.parkNanos(long nanos)</code>æˆ–<code>LockSupport.parkUntil(long millons)</code>ï¼Œå½“å‰çº¿ç¨‹ä»<code>RUNNABLE</code> ==&gt; <code>TIMED_WAITING</code></li>
<li>è°ƒç”¨<code>LockSupport.unpark(ç›®æ ‡çº¿ç¨‹)</code>æˆ–è€…è°ƒç”¨äº†çº¿ç¨‹çš„<code>interrupt()</code>ï¼Œæˆ–æ—¶ç­‰å¾…è¶…æ—¶ï¼Œä¼šè®©ç›®æ ‡çº¿ç¨‹ä»<code>TIMED_WAITING</code> ==&gt; <code>RUNNABLE</code></li>
</ul>
<p>ï¼ˆ9ï¼‰æƒ…å†µ9ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>BLOCKED</code></p>
<ul>
<li><code>t</code>çº¿ç¨‹ç”¨<code>synchronized(obj)</code>è·å–äº†å¯¹è±¡é”æ—¶å¦‚æœç«äº‰å¤±è´¥ï¼Œä»<code>RUNNABLE</code> ==&gt; <code>BLOCKED</code></li>
<li>æŒ<code>obj</code>é”çº¿ç¨‹çš„åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼Œä¼šå”¤é†’è¯¥å¯¹è±¡ä¸Šæ‰€æœ‰<code>BLOCKED</code>çš„çº¿ç¨‹é‡æ–°ç«äº‰ï¼Œå¦‚æœå…¶ä¸­<code>t</code>çº¿ç¨‹ç«äº‰æˆåŠŸï¼Œä»<code>BLOCKED</code> ==&gt; <code>RUNNABLE</code>ï¼Œå…¶ä»–å¤±è´¥çš„çº¿ç¨‹ä»ç„¶<code>BLOCKED</code></li>
</ul>
<p>ï¼ˆ10ï¼‰æƒ…å†µ10ï¼š<code>RUNNABLE</code> &lt;==&gt; <code>TERMINATED</code></p>
<p>å½“å…ˆçº¿ç¨‹æ‰€æœ‰ä»£ç è¿è¡Œå®Œæ¯•ï¼Œè¿›å…¥<code>TERMINATED</code></p>
<h2 id="2-4-ç¬¬å››éƒ¨åˆ†-é”"><a href="#2-4-ç¬¬å››éƒ¨åˆ†-é”" class="headerlink" title="2.4 ç¬¬å››éƒ¨åˆ†-é”"></a>2.4 ç¬¬å››éƒ¨åˆ†-é”</h2><h3 id="2-4-1-å¤šæŠŠé”"><a href="#2-4-1-å¤šæŠŠé”" class="headerlink" title="2.4.1 å¤šæŠŠé”"></a>2.4.1 å¤šæŠŠé”</h3><p><strong>å¤šæŠŠä¸ç›¸å¹²çš„é”</strong></p>
<p>ä¸€ä»¶å¤§å±‹å­æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼šç¡è§‰ã€å­¦ä¹ ï¼Œäº’ä¸ç›¸å¹²ã€‚</p>
<p>ç°åœ¨å°å—è¦å­¦ä¹ ï¼Œå°å¥³è¦ç¡è§‰ï¼Œä½†å¦‚æœåªç”¨ä¸€é—´å±‹å­ï¼ˆä¸€ä¸ªå¯¹è±¡é”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">public class MultiLockDemo &#123;
    public static void main(String[] args) &#123;
        BigRoom bigRoom = new BigRoom();
        new Thread(() -&gt; &#123;
            try &#123;
                bigRoom.study();
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;, &quot;å°å—&quot;).start();
        new Thread(() -&gt; &#123;
            try &#123;
                bigRoom.sleep();
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;, &quot;å°å¥³&quot;).start();
    &#125;
&#125;

@Slf4j(topic = &quot;BigRoom&quot;)
class BigRoom &#123;
    public void sleep() throws InterruptedException &#123;
        synchronized (this) &#123;
            log.debug(&quot;sleep2ä¸ªå°æ—¶&quot;);
            TimeUnit.SECONDS.sleep(2);
        &#125;
    &#125;

    public void study() throws InterruptedException &#123;
        synchronized (this) &#123;
            log.debug(&quot;sleep1ä¸ªå°æ—¶&quot;);
            TimeUnit.SECONDS.sleep(1);
        &#125;
    &#125;
&#125;</code></pre>
<p>è§£å†³æ–¹æ³•æ˜¯å‡†å¤‡å¤šä¸ªæˆ¿é—´ï¼ˆå¤šä¸ªå¯¹è±¡é”ï¼‰ï¼Œè®©å°å—å’Œå°å¥³è·å¾—ä¸åŒçš„é”ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;BigRoom&quot;)
class BigRoom &#123;
    /* ä¹¦æˆ¿ */
    private final Object studyRoom = new Object();
    /* å§å®¤ */
    private final Object sleepRoom = new Object();
    public void sleep() throws InterruptedException &#123;
        synchronized (sleepRoom) &#123;
            log.debug(&quot;sleep2ä¸ªå°æ—¶&quot;);
            TimeUnit.SECONDS.sleep(2);
        &#125;
    &#125;

    public void study() throws InterruptedException &#123;
        synchronized (studyRoom) &#123;
            log.debug(&quot;sleep1ä¸ªå°æ—¶&quot;);
            TimeUnit.SECONDS.sleep(1);
        &#125;
    &#125;
&#125;</code></pre>
<p>é”çš„ç²’åº¦ç»†åˆ†ï¼š</p>
<ul>
<li>å¥½å¤„ï¼šå¢å¼ºç¨‹åºçš„å¹¶å‘æ€§ã€‚</li>
<li>åå¤„ï¼šå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”ã€‚</li>
</ul>
<h3 id="2-4-2-æ´»è·ƒæ€§"><a href="#2-4-2-æ´»è·ƒæ€§" class="headerlink" title="2.4.2 æ´»è·ƒæ€§"></a>2.4.2 æ´»è·ƒæ€§</h3><ul>
<li><p>å› ä¸ºæŸç§åŸå› ï¼Œä½¿å¾—ä»£ç ä¸€ç›´æ— æ³•æ‰§è¡Œå®Œæ¯•ï¼Œè¿™æ ·çš„ç°è±¡å«åšæ´»è·ƒæ€§ã€‚</p>
</li>
<li><p>æ´»è·ƒæ€§ç›¸å…³çš„ä¸€ç³»åˆ—é—®é¢˜éƒ½å¯ä»¥ç”¨<code>ReentrantLock</code>è¿›è¡Œè§£å†³ã€‚</p>
</li>
</ul>
<h4 id="2-4-2-1-æ­»é”"><a href="#2-4-2-1-æ­»é”" class="headerlink" title="2.4.2.1 æ­»é”"></a>2.4.2.1 æ­»é”</h4><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>ä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”ã€‚</p>
<p>å¦‚ï¼šçº¿ç¨‹1è·å–Aå¯¹è±¡é”ï¼Œçº¿ç¨‹2è·å–Bå¯¹è±¡é”ï¼Œæ­¤æ—¶çº¿ç¨‹1åˆæƒ³è·å–Bå¯¹è±¡é”ï¼Œçº¿ç¨‹2åˆæƒ³è·å–Aå¯¹è±¡é”ï¼Œå®ƒä»¬éƒ½ç­‰ç€å¯¹è±¡é‡Šæ”¾é”ï¼Œæ­¤æ—¶å°±ç§°ä¸ºæ­»é”ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;DeadLock&quot;)
public class DeadLockDemo &#123;
    public static void main(String[] args) &#123;
        final Object A = new Object();
        final Object B = new Object();
        new Thread(() -&gt; &#123;
            synchronized (A) &#123;
                log.debug(&quot;lock A&quot;);
                try &#123;
                    TimeUnit.SECONDS.sleep(1);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                synchronized (B) &#123;
                    log.debug(&quot;lock B&quot;);
                &#125;
            &#125;
        &#125;, &quot;t1&quot;).start();
        new Thread(() -&gt; &#123;
            synchronized (B) &#123;
                log.debug(&quot;lock B&quot;);
                try &#123;
                    TimeUnit.SECONDS.sleep(1);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                synchronized (A) &#123;
                    log.debug(&quot;lock A&quot;);
                &#125;
            &#125;
        &#125;, &quot;t2&quot;).start();
    &#125;
&#125;</code></pre>
<p>è¿è¡Œï¼š</p>
<pre><code class="java">2021-04-22 22:48:27.708 [t2] DEBUG DeadLock - lock B
2021-04-22 22:48:27.708 [t1] DEBUG DeadLock - lock A</code></pre>
<blockquote>
<p>å‘ç”Ÿæ­»é”çš„å¿…è¦æ¡ä»¶</p>
</blockquote>
<ul>
<li>äº’æ–¥æ¡ä»¶ï¼šåœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œä¸€ç§èµ„æºåªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹æ‰€ä½¿ç”¨ã€‚</li>
<li>è¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼šè¿›ç¨‹å·²ç»æ‹¥æœ‰äº†è‡³å°‘ä¸€ç§èµ„æºï¼ŒåŒæ—¶åˆå»ç”³è¯·å…¶ä»–èµ„æºã€‚å› ä¸ºå…¶ä»–èµ„æºè¢«åˆ«çš„è¿›ç¨‹æ‰€ä½¿ç”¨ï¼Œè¯¥è¿›ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œå¹¶ä¸”ä¸é‡Šæ”¾è‡ªå·±å·²æœ‰çš„èµ„æºã€‚</li>
<li>ä¸å¯å‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å¯¹å·²è·å¾—çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œæˆå‰ä¸èƒ½è¢«å¼ºå ï¼Œåªèƒ½åœ¨è¿›ç¨‹ä½¿ç”¨å®Œåè‡ªå·±é‡Šæ”¾ã€‚</li>
<li>å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šå‘ç”Ÿæ­»é”æ—¶ï¼Œå¿…ç„¶å­˜åœ¨ä¸€ä¸ªè¿›ç¨‹â€”â€”èµ„æºçš„å¾ªç¯é“¾ã€‚</li>
</ul>
<blockquote>
<p>å®šä½æ­»é”çš„æ–¹æ³•</p>
</blockquote>
<p>å…ˆè¿è¡Œä¸Šè¿°æ­»é”ç¤ºä¾‹ï¼Œä¿è¯ç³»ç»Ÿä¸­å­˜åœ¨æ­»é”è¿›ç¨‹ã€‚</p>
<ol>
<li>jpsè¿›ç¨‹id + jstackå®šä½æ­»é”</li>
</ol>
<pre><code class="powershell">PS &gt; jps
13616 Jps
14432 Launcher 
13796 DeadLockDemo      // æ­»é”è¿›ç¨‹
16676
26428 RemoteMavenServer36
PS &gt; jstack 13796
2021-04-22 11:15:43
Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.221-b11 mixed mode):

......

Found one Java-level deadlock: // å‘ç°ä¸€ä¸ªJavaçº§åˆ«çš„æ­»é”
=============================
// æ­»é”çš„å¼•ç”¨æƒ…å†µ
&quot;t2&quot;:
  waiting to lock monitor 0x000000001d390b08 (object 0x000000076cfd4e58, a java.lang.Object),
  which is held by &quot;t1&quot;
&quot;t1&quot;:
  waiting to lock monitor 0x000000001d393028 (object 0x000000076cfd4e68, a java.lang.Object),
  which is held by &quot;t2&quot;

Java stack information for the threads listed above:
===================================================
&quot;t2&quot;:
        at top.parak.share.DeadLockDemo.lambda$main$1(DeadLockDemo.java:39) // å‘ç”Ÿæ­»é”çš„ä½ç½®
        - waiting to lock &lt;0x000000076cfd4e58&gt; (a java.lang.Object)
        - locked &lt;0x000000076cfd4e68&gt; (a java.lang.Object)
        at top.parak.share.DeadLockDemo$$Lambda$2/885951223.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)
&quot;t1&quot;:
        at top.parak.share.DeadLockDemo.lambda$main$0(DeadLockDemo.java:26) // å‘ç”Ÿæ­»é”çš„ä½ç½®
        - waiting to lock &lt;0x000000076cfd4e68&gt; (a java.lang.Object)
        - locked &lt;0x000000076cfd4e58&gt; (a java.lang.Object)
        at top.parak.share.DeadLockDemo$$Lambda$1/1854778591.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

Found 1 deadlock.</code></pre>
<ol start="2">
<li>jconsoleå·¥å…·æ£€æµ‹æ­»é”</li>
</ol>
<p>powershellè¾“å…¥<code>jconsole</code>ï¼Œè¿æ¥æœ¬åœ°è¿›ç¨‹ï¼Œé€‰æ‹©çº¿ç¨‹ç•Œé¢</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210422112258636.png" class="" title="image-20210422112258636">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210422112653368.png" class="" title="image-20210422112653368">



<blockquote>
<p>æ­»é”ä¸¾ä¾‹ï¼šå“²å­¦å®¶å°±é¤é—®é¢˜</p>
</blockquote>
<p>æœ‰äº”ä½å“²å­¦å®¶ï¼Œå›´ååœ¨åœ†æ¡Œæ—ï¼š</p>
<ul>
<li>ä»–ä»¬åªåšä¸¤ä»¶äº‹ï¼Œæ€è€ƒå’Œåƒé¥­ï¼Œæ€è€ƒä¸€ä¼šåƒå£é¥­ï¼Œåƒå®Œé¥­æ¥ç€æ€è€ƒã€‚</li>
<li>åƒé¥­æ—¶è¦ç”¨ä¸¤æ ¹ç­·å­åƒï¼Œæ¡Œå­ä¸Šå…±æœ‰äº”æ ¹ç­·å­ï¼Œæ¯ä½å“²å­¦å®¶å·¦å³æ‰‹è¾¹å„æœ‰ä¸€æ ¹ç­·å­ã€‚</li>
<li>å¦‚æœç­·å­è¢«èº«è¾¹çš„äººæ‹¿ç€ï¼Œè‡ªå·±å°±å¾—ç­‰å¾…ã€‚</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210422110000353.png" class="" title="image-20210422110000353">

<p>å½“æ¯ä½å“²å­¦å®¶å³çº¿ç¨‹æŒæœ‰ä¸€æ ¹ç­·å­æ—¶ï¼Œä»–ä»¬éƒ½åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾é”ï¼Œå› æ­¤é€ æˆäº†æ­»é”ã€‚</p>
<p>ä»£ç ï¼š</p>
<pre><code class="java">public class PhilosophersEatingDemo &#123;
    private final static int NUM = 5;
    public static void main(String[] args) &#123;
        Chopstick[] c = new Chopstick[NUM];
        for (int i = 0; i &lt; NUM; i++) &#123;
            c[i] = new Chopstick(String.valueOf(i));
        &#125;
        new Philosopher(&quot;è‹æ ¼æ‹‰åº•&quot;, c[0], c[1]).start();
        new Philosopher(&quot;æŸæ‹‰å›¾&quot;, c[1], c[2]).start();
        new Philosopher(&quot;äºšé‡Œå£«å¤šå¾·&quot;, c[2], c[3]).start();
        new Philosopher(&quot;éƒæ‹‰å…‹åˆ©ç‰¹&quot;, c[3], c[4]).start();
        new Philosopher(&quot;é˜¿åŸºç±³å¾·&quot;, c[4], c[0]).start();
    &#125;
&#125;

// å“²å­¦å®¶
@Slf4j(topic = &quot;Philosopher&quot;)
class Philosopher extends Thread &#123;
    final Chopstick left;  // å·¦æ‰‹ç­·å­
    final Chopstick right; // å³æ‰‹ç­·å­

    public Philosopher(String name, Chopstick left, Chopstick right) &#123;
        super(name);
        this.left = left;
        this.right = right;
    &#125;

    public void run() &#123;
        while (true) &#123;
            // å°è¯•è·å¾—å·¦æ‰‹ç­·å­
            synchronized (left) &#123;
                // å°è¯•è·å¾—å³æ‰‹ç­·å­
                synchronized (right) &#123;
                    eat();
                &#125;
            &#125;
        &#125;
    &#125;

    // åƒé¥­
    private void eat() &#123;
        log.debug(&quot;eating...&quot;);
        try &#123;
            TimeUnit.SECONDS.sleep(1);
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;

// ç­·å­
class Chopstick &#123;
    String name;

    public Chopstick(String name) &#123;
        this.name = name;
    &#125;

    @Override
    public String toString() &#123;
        return &quot;ç­·å­[&quot; +
                &quot;name=&#39;&quot; + name + &#39;\&#39;&#39; +
                &#39;]&#39;;
    &#125;
&#125;</code></pre>
<p>è¿è¡Œï¼š</p>
<pre><code class="powershell">2021-04-22 14:15:57.623 [äºšé‡Œå£«å¤šå¾·] DEBUG Philosopher - eating...
2021-04-22 14:15:57.623 [è‹æ ¼æ‹‰åº•] DEBUG Philosopher - eating...
2021-04-22 14:15:58.632 [äºšé‡Œå£«å¤šå¾·] DEBUG Philosopher - eating...
2021-04-22 14:15:58.632 [è‹æ ¼æ‹‰åº•] DEBUG Philosopher - eating...
2021-04-22 14:15:59.643 [æŸæ‹‰å›¾] DEBUG Philosopher - eating...
2021-04-22 14:16:00.647 [æŸæ‹‰å›¾] DEBUG Philosopher - eating...</code></pre>
<p>jconsoleæ£€æµ‹æ­»é”ï¼š</p>
<pre><code>---------------------------------------------------------------------
åç§°: è‹æ ¼æ‹‰åº•
çŠ¶æ€: top.parak.share.Chopstick@798c4fadã€ç­·å­1ã€‘ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: æŸæ‹‰å›¾
æ€»é˜»æ­¢æ•°: 8, æ€»ç­‰å¾…æ•°: 6

å †æ ˆè·Ÿè¸ª: 
top.parak.share.Philosopher.run(PhilosophersEatingDemo.java:45)
   - å·²é”å®š top.parak.share.Chopstick@6ea242baã€ç­·å­0ã€‘
---------------------------------------------------------------------
åç§°: æŸæ‹‰å›¾
çŠ¶æ€: top.parak.share.Chopstick@6057af47ã€ç­·å­2ã€‘ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: äºšé‡Œå£«å¤šå¾·
æ€»é˜»æ­¢æ•°: 3, æ€»ç­‰å¾…æ•°: 2

å †æ ˆè·Ÿè¸ª: 
top.parak.share.Philosopher.run(PhilosophersEatingDemo.java:45)
   - å·²é”å®š top.parak.share.Chopstick@798c4fadã€ç­·å­1ã€‘
---------------------------------------------------------------------
åç§°: äºšé‡Œå£«å¤šå¾·
çŠ¶æ€: top.parak.share.Chopstick@6796caf6ã€ç­·å­3ã€‘ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: éƒæ‹‰å…‹åˆ©ç‰¹
æ€»é˜»æ­¢æ•°: 8, æ€»ç­‰å¾…æ•°: 2

å †æ ˆè·Ÿè¸ª: 
top.parak.share.Philosopher.run(PhilosophersEatingDemo.java:45)
   - å·²é”å®š top.parak.share.Chopstick@6057af47ã€ç­·å­2ã€‘
---------------------------------------------------------------------
åç§°: éƒæ‹‰å…‹åˆ©ç‰¹
çŠ¶æ€: top.parak.share.Chopstick@16b56e05ã€ç­·å­4ã€‘ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: é˜¿åŸºç±³å¾·
æ€»é˜»æ­¢æ•°: 2, æ€»ç­‰å¾…æ•°: 0

å †æ ˆè·Ÿè¸ª: 
top.parak.share.Philosopher.run(PhilosophersEatingDemo.java:45)
   - å·²é”å®š top.parak.share.Chopstick@6796caf6ã€ç­·å­3ã€‘
---------------------------------------------------------------------
åç§°: é˜¿åŸºç±³å¾·
çŠ¶æ€: top.parak.share.Chopstick@6ea242baã€ç­·å­0ã€‘ä¸Šçš„BLOCKED, æ‹¥æœ‰è€…: è‹æ ¼æ‹‰åº•
æ€»é˜»æ­¢æ•°: 1, æ€»ç­‰å¾…æ•°: 0

å †æ ˆè·Ÿè¸ª: 
top.parak.share.Philosopher.run(PhilosophersEatingDemo.java:45)
   - å·²é”å®š top.parak.share.Chopstick@16b56e05ã€ç­·å­4ã€‘</code></pre>
<p>å¤§å®¶éƒ½æ‹¿ç€ä¸€æ ¹ç­·å­ï¼Œç­‰ç€å¦ä¸€æ ¹ç­·å­ï¼Œé€ æˆæ­»é”ï¼Œè§£å†³å¾—çœ‹åé¢çš„<code>ReentrantLock</code>ã€‚</p>
<h4 id="2-4-2-2-æ´»é”"><a href="#2-4-2-2-æ´»é”" class="headerlink" title="2.4.2.2 æ´»é”"></a>2.4.2.2 æ´»é”</h4><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;LiveLock&quot;)
public class LiveLockDemo &#123;

    static volatile int count = 10;
    static final Object lock = new Object();

    public static void main(String[] args) &#123;
        new Thread(() -&gt; &#123;
            // æœŸæœ›å‡åˆ°0ï¼Œé€€å‡ºå¾ªç¯
            while (count &gt; 0) &#123;
                try &#123;
                    TimeUnit.MILLISECONDS.sleep(10);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                count--;
                log.debug(&quot;count: &#123;&#125;&quot;, count);
            &#125;
        &#125;, &quot;t1&quot;).start();
        new Thread(() -&gt; &#123;
            // æœŸæœ›è¶…è¿‡20é€€å‡ºå¾ªç¯
            while (count &lt; 20) &#123;
                try &#123;
                    TimeUnit.MILLISECONDS.sleep(10);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
                count++;
                log.debug(&quot;count: &#123;&#125;&quot;, count);
            &#125;
        &#125;, &quot;t2&quot;).start();
    &#125;
&#125;</code></pre>
<p>è§£å†³ï¼šåœ¨çº¿ç¨‹æ‰§è¡Œæ—¶ï¼Œä¸­é€”ç»™äºˆä¸åŒçš„é—´éš”æ—¶é—´ï¼Œè®©æŸä¸ªçº¿ç¨‹å…ˆç»“æŸå³å¯ã€‚</p>
<p>æ­»é”ä¸æ´»é”çš„åŒºåˆ«ï¼š</p>
<ul>
<li>æ­»é”æ˜¯å› ä¸ºçº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹è±¡æƒ³è¦çš„é”ï¼Œå¹¶ä¸”éƒ½ä¸é‡Šæ”¾ï¼Œæœ€ååˆ°æ—¶çº¿ç¨‹é˜»å¡ï¼Œåœæ­¢è¿è¡Œçš„ç°è±¡ã€‚</li>
<li>æ´»é”æ˜¯å› ä¸ºçº¿ç¨‹é—´ä¿®æ”¹äº†å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œä»è€Œå¯¼è‡´ä»£ç ä¸€ç›´åœ¨è¿è¡Œï¼Œå´ä¸€ç›´è¿è¡Œä¸å®Œçš„ç°è±¡ã€‚</li>
</ul>
<h4 id="2-4-2-3-é¥¥é¥¿"><a href="#2-4-2-3-é¥¥é¥¿" class="headerlink" title="2.4.2.3 é¥¥é¥¿"></a>2.4.2.3 é¥¥é¥¿</h4><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>æŸäº›çº¿ç¨‹å› ä¸ºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ°CPUè°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸã€‚</p>
<p>åœ¨ä½¿ç”¨é¡ºåºåŠ é”æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°é¥¥é¥¿ç°è±¡ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210422165813526.png" class="" title="image-20210422165813526">

<p>é¡ºåºåŠ é”çš„è§£å†³æ–¹æ¡ˆï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/62531/image-20210422205258032.png" class="" title="image-20210422205258032">



<h3 id="2-4-3-ReentrantLock"><a href="#2-4-3-ReentrantLock" class="headerlink" title="2.4.3 ReentrantLock"></a>2.4.3 ReentrantLock</h3><blockquote>
<p>ç‰¹ç‚¹ï¼ˆsynchronizedä¸å…·å¤‡çš„ï¼‰</p>
</blockquote>
<ul>
<li>å¯ä¸­æ–­</li>
<li>å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´</li>
<li>å¯ä»¥è®¾ç½®ä¸ºå…¬å¹³é”</li>
<li>æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</li>
</ul>
<p>ä¸<code>synchronized</code>ä¸€æ ·ï¼Œéƒ½æ”¯æŒå¯é‡å…¥ã€‚</p>
<blockquote>
<p>æ¯”è¾ƒ</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>Lock</th>
<th>synchronized</th>
</tr>
</thead>
<tbody><tr>
<td>å±‚æ¬¡æ–¹é¢</td>
<td>ï¼ˆ1ï¼‰<code>Lock</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ˜¯åœ¨ç±»çº§åˆ«ä¸Šçš„å®ç°ï¼›ï¼ˆ2ï¼‰JDKå±‚æ¬¡çš„å®ç°</td>
<td>ï¼ˆ1ï¼‰<code>synchronized</code>æ˜¯Javaå…³é”®å­—ï¼›ï¼ˆ2ï¼‰JVMå±‚æ¬¡å®šä¹‰ çš„</td>
</tr>
<tr>
<td>çµæ´»æ€§æ–¹é¢</td>
<td><code>Lock</code>æ¥å£æä¾›çš„<code>lock()</code>å’Œ<code>unlock()</code>æ–¹æ³•ï¼Œå¯ä»¥éšæ—¶è·å¾—é”ã€é‡Šæ”¾é”ï¼Œéå¸¸çµæ´»ã€‚</td>
<td>é‡Šæ”¾é”ã€è·å¾—é”æ˜¯è¢«åŠ¨çš„ã€‚é‡Šæ”¾é”åªæœ‰ä¸¤ç§æƒ…å†µï¼šï¼ˆ1ï¼‰åŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•ï¼ˆ2ï¼‰æŠ›å‡ºå¼‚å¸¸ï¼ŒåŒæ­¥å™¨æ‰§è¡Œ<code>monitor.exit()</code>é‡Šæ”¾é”ã€‚</td>
</tr>
<tr>
<td>é”çš„çŠ¶æ€æ–¹é¢</td>
<td>ï¼ˆ1ï¼‰<code>Lock</code>å¯ä»¥åˆ¤æ–­é”çš„çŠ¶æ€ï¼Œå®ƒä¼šæä¾›<code>tryLock()</code>æ–¹æ³•æ¥å‘Šè¯‰æˆ‘ä»¬æ˜¯å¦è·å¾—é”æˆåŠŸã€‚ï¼ˆ2ï¼‰<code>tryLock()</code>æœ‰è¿”å›å€¼ï¼Œç”¨æ¥å°è¯•è·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™è¿”å›falseï¼›è·å–å¤±è´¥ï¼Œè¿”å›falseï¼Œè¿™ä¸ªæ–¹æ³•æ— è®ºå¦‚ä½•éƒ½ä¼šç«‹å³è¿”å›ã€‚åœ¨æ‹¿ä¸åˆ°é”æ—¶ä¸ä¼šä¸€ç›´åœ¨é‚£ç­‰å¾…ã€‚</td>
<td>ï¼ˆ1ï¼‰åœ¨é”çš„çŠ¶æ€æ–¹é¢ï¼Œ<code>synchronized</code>å®Œå…¨æ˜¯è¢«åŠ¨çš„ï¼Œæ²¡æ³•åˆ¤æ–­é”çš„çŠ¶æ€ã€‚ï¼ˆ2ï¼‰<code>synchronized</code>åœ¨æ‹¿ä¸åˆ°é”æ—¶ï¼Œåˆ™ä¼šé˜»å¡åœ¨é‚£é‡Œï¼Œä¸€ç›´ç­‰å¾…ã€‚</td>
</tr>
<tr>
<td>é”çš„ç±»å‹æ–¹é¢</td>
<td>åŸºäº<code>Lock</code>æ¥å£ï¼Œæœ‰å¤šç§é”çš„å®ç°ï¼Œå¦‚ï¼šï¼ˆ1ï¼‰å¯é‡å…¥é”ï¼š<code>ReentrantLock</code>ï¼›ï¼ˆ2ï¼‰å¯é‡å…¥è¯»å†™é”ï¼š<code>ReentrantReadWriteLock</code>ç­‰ã€‚é’ˆå¯¹å¯é‡å…¥é”ï¼Œè¿˜æœ‰å…¬å¹³é”å’Œéå…¬å¹³é”ä¹‹åˆ†ã€‚</td>
<td>å¯¹äº<code>synchronized</code>æ¥è¯´ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªJVMå±‚æ¬¡çš„å…³é”®å­—ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ²¡æœ‰å…·ä½“å®ç°ã€‚</td>
</tr>
</tbody></table>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<pre><code class="java">// è·å–é”
reentrantLock.lock();
try &#123;
    // ä¸´ç•ŒåŒº
&#125; finally &#123;
    // é‡Šæ”¾é”
    reentrantLock.unlock();
&#125;</code></pre>
<h4 id="2-4-3-1-å¯é‡å…¥"><a href="#2-4-3-1-å¯é‡å…¥" class="headerlink" title="2.4.3.1 å¯é‡å…¥"></a>2.4.3.1 å¯é‡å…¥</h4><p>å¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå› ä¸ºå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé”ã€‚å¦‚æœæ˜¯ä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;ReentrantLock&quot;)
public class ReentrantLockDemo &#123;

    private static ReentrantLock lock = new ReentrantLock();

    public static void main(String[] args) &#123;
        lock.lock();
        try &#123;
            log.debug(&quot;enter main&quot;);
            m1();
        &#125; finally &#123;
            lock.unlock();
        &#125;
    &#125;

    public static void m1() &#123;
        lock.lock();
        try &#123;
            log.debug(&quot;enter m1&quot;);
            m2();
        &#125; finally &#123;
            lock.unlock();
        &#125;
    &#125;

    public static void m2() &#123;
        lock.lock();
        try &#123;
            log.debug(&quot;enter m2&quot;);
        &#125; finally &#123;
            lock.unlock();
        &#125;
    &#125;

&#125;</code></pre>
<p>è¿è¡Œï¼š</p>
<pre><code>2021-04-22 22:49:46.320 [main] DEBUG ReentrantLock - enter main
2021-04-22 22:49:46.322 [main] DEBUG ReentrantLock - enter m1
2021-04-22 22:49:46.322 [main] DEBUG ReentrantLock - enter m2</code></pre>
<h4 id="2-4-3-2-å¯æ‰“æ–­"><a href="#2-4-3-2-å¯æ‰“æ–­" class="headerlink" title="2.4.3.2 å¯æ‰“æ–­"></a>2.4.3.2 å¯æ‰“æ–­</h4><p><code>synchoronized</code>å’Œ<code>reentrantLock.lock()</code>çš„é”ï¼Œæ˜¯ä¸å¯è¢«æ‰“æ–­çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åˆ«çš„çº¿ç¨‹å·²ç»è·å¾—äº†é”ï¼Œæˆ‘çš„çº¿ç¨‹å°±éœ€è¦ä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œä¸èƒ½ä¸­æ–­ã€‚</p>
<p>å¯è¢«ä¸­æ–­çš„é”ï¼Œé€šè¿‡<code>reentrantLock.lockInterruptibly()</code>è·å–çš„é”å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨é˜»å¡çº¿ç¨‹çš„<code>interrupt()</code>æ–¹æ³•ã€‚</p>
<p>å¦‚æœæŸä¸ªçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œå¯ä»¥è°ƒç”¨å…¶<code>interrupt()</code>æ–¹æ³•è®©å…¶åœæ­¢é˜»å¡ï¼Œè·å¾—é”å¤±è´¥ã€‚å¤„äºé˜»å¡çŠ¶æ€çš„çº¿ç¨‹ï¼Œè¢«æ‰“æ–­äº†å°±ä¸ç”¨é˜»å¡äº†ï¼Œç›´æ¥åœæ­¢å°±è¡Œã€‚</p>
<p>å¯ä¸­æ–­çš„é”ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥è¢«åŠ¨çš„å‡å°‘æ­»é”çš„æ¦‚ç‡ï¼Œä¹‹æ‰€ä»¥è¢«åŠ¨ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è°ƒç”¨é˜»å¡çº¿ç¨‹çš„<code>interrupt()</code>æ–¹æ³•ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;LockInterruptibly&quot;)
public class LockInterruptiblyDemo &#123;
    private static ReentrantLock lock = new ReentrantLock();
    public static void main(String[] args) &#123;
        Thread t1 = new Thread(() -&gt; &#123;
            try &#123;
                // å¦‚æœæ²¡æœ‰ç«äº‰é‚£ä¹ˆæ­¤æ–¹æ³•å°±ä¼šè·å–lockå¯¹è±¡é”
                // å¦‚æœæœ‰ç«äº‰å°±è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ç”¨interruptæ–¹æ³•æ‰“æ–­
                log.debug(&quot;å°è¯•è·å¾—é”&quot;);
                lock.lockInterruptibly();
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
                log.debug(&quot;æœªè·å–é”&quot;);
                return;
            &#125;
            try &#123;
                log.debug(&quot;è·å–åˆ°é”&quot;);
            &#125; finally &#123;
                lock.unlock();
            &#125;
        &#125;, &quot;t1&quot;);
        lock.lock();
        t1.start();
        try &#123;
            TimeUnit.SECONDS.sleep(1);
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
        log.debug(&quot;æ‰“æ–­t1çº¿ç¨‹&quot;);
        t1.interrupt();
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>2021-04-22 22:57:01.129 [t1] DEBUG LockInterruptibly - å°è¯•è·å¾—é”
2021-04-22 22:57:02.148 [main] DEBUG LockInterruptibly - æ‰“æ–­t1çº¿ç¨‹
2021-04-22 22:57:02.149 [t1] DEBUG LockInterruptibly - æœªè·å–é”
java.lang.InterruptedException</code></pre>
<h4 id="2-4-3-3-é”è¶…æ—¶"><a href="#2-4-3-3-é”è¶…æ—¶" class="headerlink" title="2.4.3.3 é”è¶…æ—¶"></a>2.4.3.3 é”è¶…æ—¶</h4><p>é˜²æ­¢æ— é™åˆ¶ç­‰å¾…ï¼Œå‡å°‘æ­»é”ã€‚</p>
<ul>
<li><code>reentrantLock.tryLock()</code>ä¼šè¿”å›é”æ˜¯å¦æˆåŠŸã€‚å¦‚æœæˆåŠŸåˆ™è¿”å›trueï¼Œåä¹‹åˆ™è¿”å›falseã€‚</li>
<li><code>tryLock(long timeoutï¼Œ TimeUnit unit)</code>å¯ä»¥è®¾ç½®æŒ‡å®šç­‰å¾…æ—¶é—´ï¼Œå…¶ä¸­timeoutä¸ºæœ€é•¿ç­‰å¾…æ—¶é—´ï¼Œunitä¸ºæ—¶é—´å•ä½ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code>@Slf4j(topic = &quot;TryLock&quot;)
public class TryLockDemo &#123;
    private static final ReentrantLock lock = new ReentrantLock();
    public static void main(String[] args) throws InterruptedException &#123;
        Thread t1 = new Thread(() -&gt; &#123;
            log.debug(&quot;å°è¯•è·å–é”&quot;);
            try &#123;
                if (!lock.tryLock(2, TimeUnit.SECONDS)) &#123; // å°è¯•ç­‰å¾…2Sï¼Œè·å–é”
                    log.debug(&quot;è·å–ä¸åˆ°é”&quot;);
                    return;
                &#125;
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
                log.debug(&quot;è·å–ä¸åˆ°é”&quot;);
                return;
            &#125;
            try &#123;
                log.debug(&quot;è·å–åˆ°é”&quot;);
            &#125; finally &#123;
                lock.unlock();
            &#125;
        &#125;, &quot;t1&quot;);
        lock.lock();
        log.debug(&quot;è·å–åˆ°é”&quot;);
        t1.start();
        TimeUnit.SECONDS.sleep(1);
        lock.unlock();
        log.debug(&quot;é‡Šæ”¾äº†é”&quot;);
    &#125;
&#125;</code></pre>
<p>è¿è¡Œï¼š</p>
<pre><code>2021-04-23 00:46:54.944 [main] DEBUG TryLock - è·å–åˆ°é”
2021-04-23 00:46:54.946 [t1] DEBUG TryLock - å°è¯•è·å–é”
2021-04-23 00:46:55.949 [main] DEBUG TryLock - é‡Šæ”¾äº†é”
2021-04-23 00:46:55.949 [t1] DEBUG TryLock - è·å–åˆ°é”</code></pre>
<blockquote>
<p>è§£å†³å“²å­¦å®¶å°±é¤çš„é—®é¢˜</p>
</blockquote>
<p>å°è¯•è·å–ç­·å­ï¼Œè·å–ä¸åˆ°å°±æ”¾ä¸‹ã€‚</p>
<pre><code class="java">public class PhilosophersEatingDemo &#123;
    private final static int NUM = 5;
    public static void main(String[] args) &#123;
        Chopstick[] c = new Chopstick[NUM];
        for (int i = 0; i &lt; NUM; i++) &#123;
            c[i] = new Chopstick(String.valueOf(i));
        &#125;
        new Philosopher(&quot;è‹æ ¼æ‹‰åº•&quot;, c[0], c[1]).start();
        new Philosopher(&quot;æŸæ‹‰å›¾&quot;, c[1], c[2]).start();
        new Philosopher(&quot;äºšé‡Œå£«å¤šå¾·&quot;, c[2], c[3]).start();
        new Philosopher(&quot;éƒæ‹‰å…‹åˆ©ç‰¹&quot;, c[3], c[4]).start();
        new Philosopher(&quot;é˜¿åŸºç±³å¾·&quot;, c[4], c[0]).start();
    &#125;
&#125;

// å“²å­¦å®¶
@Slf4j(topic = &quot;Philosopher&quot;)
class Philosopher extends Thread &#123;
    final Chopstick left;  // å·¦æ‰‹ç­·å­
    final Chopstick right; // å³æ‰‹ç­·å­

    public Philosopher(String name, Chopstick left, Chopstick right) &#123;
        super(name);
        this.left = left;
        this.right = right;
    &#125;

    public void run() &#123;
        while (true) &#123;
            if (left.tryLock()) &#123; // å°è¯•è·å¾—å·¦æ‰‹ç­·å­
                try &#123;
                    if (right.tryLock()) &#123; // å°è¯•è·å¾—å³æ‰‹ç­·å­
                        try &#123;
                            eat();
                        &#125; finally &#123;
                            right.unlock(); // é‡Šæ”¾å³æ‰‹ç­·å­
                        &#125;
                    &#125;
                &#125; finally &#123;
                    left.unlock();  // é‡Šæ”¾å·¦æ‰‹ç­·å­
                &#125;
            &#125;
        &#125;
    &#125;

    // åƒé¥­
    private void eat() &#123;
        log.debug(&quot;eating...&quot;);
        try &#123;
            TimeUnit.SECONDS.sleep(1);
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;

// ç­·å­
class Chopstick extends ReentrantLock  &#123;
    String name;

    public Chopstick(String name) &#123;
        this.name = name;
    &#125;

    @Override
    public String toString() &#123;
        return &quot;ç­·å­[&quot; + &quot;name=&#39;&quot; + name + &#39;]&#39;;
    &#125;
&#125;</code></pre>
<h4 id="2-4-3-4-å…¬å¹³é”"><a href="#2-4-3-4-å…¬å¹³é”" class="headerlink" title="2.4.3.4 å…¬å¹³é”"></a>2.4.3.4 å…¬å¹³é”</h4><ul>
<li>å¯ä»¥æŠŠç«äº‰çš„çº¿ç¨‹æ”¾åœ¨ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜»å¡é˜Ÿåˆ—ä¸Š</li>
<li>åªè¦æŒæœ‰é”çš„çº¿ç¨‹æ‰§è¡Œå®Œäº†ï¼Œå”¤é†’é˜»å¡é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªçº¿ç¨‹è·å–é”å³å¯</li>
<li>å…ˆè¿›å…¥é˜Ÿåˆ—çš„çº¿ç¨‹å…ˆè·å–åˆ°é”</li>
</ul>
<p>synchronizedæ˜¯ä¸å…¬å¹³é”ã€‚ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œå…¶ä»–çº¿ç¨‹è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼›å½“è¿™ä¸ªçº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œé‚£ä¹ˆé˜»å¡é˜Ÿåˆ—çš„çº¿ç¨‹å°±ä¼šä¸€èµ·å»äº‰æŠ¢ï¼Œè€Œä¸æ˜¯æŒ‰ç…§å…ˆæ¥å…ˆå¾—çš„é¡ºåºã€‚</p>
<p>ReentrantLocké»˜è®¤æ˜¯ä¸å…¬å¹³çš„ï¼Œä½†æ˜¯å¯ä»¥åˆ‡æ¢ä¸ºå…¬å¹³é”ï¼Œçœ‹ä¸€çœ¼å¸¦å‚æ„é€ æ–¹æ³•ï¼š</p>
<pre><code class="java">public ReentrantLock(boolean fair) &#123;
    sync = fair ? new FairSync() : new NonfairSync();
&#125;</code></pre>
<p>æ„é€ ä¸€ä¸ªå…¬å¹³é”<code>new ReentrantLock(true)</code>ï¼Œå…¬å¹³é”æ²¡æœ‰å¿…è¦ï¼Œä¼šé™ä½å¹¶å‘åº¦ã€‚</p>
<h4 id="2-4-3-5-æ¡ä»¶å˜é‡"><a href="#2-4-3-5-æ¡ä»¶å˜é‡" class="headerlink" title="2.4.3.5 æ¡ä»¶å˜é‡"></a>2.4.3.5 æ¡ä»¶å˜é‡</h4><p>synchronizedä¸­ä¹Ÿæœ‰æ¡ä»¶å˜é‡ï¼Œå°±æ˜¯<code>waitSet</code>ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥<code>waitSet</code>ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥<code>waitSet</code>ç­‰å¾…ã€‚<code>ReentrantLock</code>çš„æ¡ä»¶å˜é‡æ¯”<code>synchronized</code>å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡çš„ã€‚</p>
<ul>
<li><code>synchronized</code>è®©é‚£äº›ä¸æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹éƒ½åœ¨ä¸€é—´ä¼‘æ¯å®¤ç­‰æ¶ˆæ¯</li>
<li><code>ReentrantLock</code>æ”¯æŒå¤šé—´ä¼‘æ¯å®¤ï¼Œæœ‰ä¸“é—¨ç­‰çš„ä¼‘æ¯å®¤ã€ä¸“é—¨ç­‰æ—©é¤çš„ä¼‘æ¯å®¤ã€å”¤é†’æ—¶ä¹Ÿæ˜¯æŒ‰ä¼‘æ¯å®¤æ¥å”¤é†’</li>
</ul>
<p>ä½¿ç”¨æµç¨‹ï¼š</p>
<ul>
<li><code>await</code>å‰éœ€è¦è·å¾—é”</li>
<li><code>await</code>æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”ï¼Œè¿›å…¥<code>conditionObject</code>ç­‰å¾…</li>
<li><code>await</code>çš„çº¿ç¨‹è¢«å”¤é†’ï¼ˆæˆ–æ‰“æ–­ã€æˆ–è¶…æ—¶ï¼‰é‡æ–°ç«äº‰locké”</li>
<li>ç«äº‰locké”æˆåŠŸåï¼Œä»awaitåç»§ç»­æ‰§è¡Œ</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;CorrectPostureStep4&quot;)
public class CorrectPostureStep4Demo &#123;
    static boolean hasCigarette = false;
    static boolean hasTakeAway = false;
    static ReentrantLock ROOM = new ReentrantLock();
    // ç­‰çƒŸçš„ä¼‘æ¯å®¤
    static Condition waitCigaretteSet = ROOM.newCondition();
    // ç­‰å¤–å–çš„ä¼‘æ¯å®¤
    static Condition waitTakeAwaySet = ROOM.newCondition();

    public static void main(String[] args) throws InterruptedException &#123;
        new Thread(() -&gt; &#123;
            ROOM.lock();
            try &#123;
                String name = Thread.currentThread().getName();
                log.debug(&quot;æœ‰çƒŸå— ? [&#123;&#125;]&quot;, hasCigarette);
                while (!hasCigarette) &#123; // é˜²æ­¢è™šå‡å”¤é†’
                    log.debug(&quot;æ²¡æœ‰çƒŸ =&gt; [&#123;&#125;]å…ˆæ­‡ä¼š...&quot;, name);
                    waitCigaretteSet.await();
                &#125;
                log.debug(&quot;å†çœ‹çœ‹æœ‰çƒŸå— ? [&#123;&#125;]&quot;, hasCigarette);
                if (hasCigarette) &#123;
                    log.debug(&quot;æœ‰çƒŸäº† =&gt; [&#123;&#125;]å¼€å§‹å¹²æ´»ing&quot;, name);
                &#125; else &#123;
                    log.debug(&quot;ä¾ç„¶æ²¡æœ‰çƒŸ =&gt; [&#123;&#125;]ä¸å¹²æ´»äº†&quot;, name);
                &#125;
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125; finally &#123;
                ROOM.unlock();
            &#125;
        &#125;, &quot;FlowerK&quot;).start();
        new Thread(() -&gt; &#123;
            ROOM.lock();
            try &#123;
                String name = Thread.currentThread().getName();
                log.debug(&quot;å¤–å–æ˜¯å¦é€åˆ° ? [&#123;&#125;]&quot;, hasTakeAway);
                if (!hasTakeAway) &#123;
                    log.debug(&quot;å¤–å–è¿˜æœªé€åˆ° =&gt; [&#123;&#125;]å…ˆæ­‡ä¼š...&quot;, name);
                    waitTakeAwaySet.await();
                &#125;
                log.debug(&quot;å†çœ‹çœ‹å¤–å–æ˜¯å¦é€åˆ° ? [&#123;&#125;]&quot;, hasTakeAway);
                if (hasTakeAway) &#123;
                    log.debug(&quot;å¤–å–å·²ç»é€åˆ° =&gt; [&#123;&#125;]å¼€å§‹å¹²æ´»ing&quot;, name);
                &#125; else &#123;
                    log.debug(&quot;å¤–å–ä»ç„¶æœªåˆ° =&gt; [&#123;&#125;]ä¸å¹²æ´»äº†&quot;, hasTakeAway);
                &#125;
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125; finally &#123;
                ROOM.unlock();
            &#125;
        &#125;, &quot;RubbishK&quot;).start();
        TimeUnit.SECONDS.sleep(1);
        new Thread(() -&gt; &#123;
            ROOM.lock();
            try &#123;
                hasTakeAway = true;
                waitTakeAwaySet.signal();
                log.debug(&quot;å¤–å–å·²é€åˆ°&quot;);
            &#125; finally &#123;
                ROOM.unlock();
            &#125;
        &#125;, &quot;ç¾å›¢å¤–å–&quot;).start();
        TimeUnit.SECONDS.sleep(1);
        new Thread(() -&gt; &#123;
            ROOM.lock();
            try &#123;
                hasCigarette = true;
                waitCigaretteSet.signal();
                log.debug(&quot;çƒŸå·²é€åˆ°&quot;);
            &#125; finally &#123;
                ROOM.unlock();
            &#125;
        &#125;, &quot;é¥¿äº†ä¹ˆ&quot;).start();
    &#125;
&#125;</code></pre>
<h3 id="2-4-4-åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶"><a href="#2-4-4-åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶" class="headerlink" title="2.4.4 åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶"></a>2.4.4 åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</h3><h4 id="2-4-4-1-å›ºå®šè¾“å‡º"><a href="#2-4-4-1-å›ºå®šè¾“å‡º" class="headerlink" title="2.4.4.1 å›ºå®šè¾“å‡º"></a>2.4.4.1 å›ºå®šè¾“å‡º</h4><p>æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹Aæ‰“å°1ï¼Œçº¿ç¨‹Bæ‰“å°2ã€‚</p>
<p>è¦æ±‚ï¼šç¨‹åºå¿…é¡»å…ˆæ‰“å°2å†æ‰“å°1ã€‚</p>
<blockquote>
<p>wait/notifyç‰ˆæœ¬</p>
</blockquote>
<pre><code class="java">@Slf4j(topic = &quot;OrderWaitNotify&quot;)
public class OrderWaitNotifyDemo &#123;
    private static final Object lock = new Object();
    private static boolean bRunned = false; // è¡¨ç¤ºt2æ˜¯å¦è¿è¡Œ
    public static void main(String[] args) &#123;
        Thread a = new Thread(() -&gt; &#123;
            synchronized (lock) &#123;
                while (!bRunned) &#123;
                    try &#123;
                        lock.wait();
                    &#125; catch (InterruptedException e) &#123;
                        e.printStackTrace();
                    &#125;
                &#125;
            &#125;
            log.debug(&quot;1&quot;);
        &#125;, &quot;A&quot;);
        Thread b = new Thread(() -&gt; &#123;
            synchronized (lock)  &#123;
                log.debug(&quot;2&quot;);
                bRunned = true;
                lock.notify();
            &#125;
        &#125;, &quot;B&quot;);
        a.start();
        b.start();
    &#125;
&#125;</code></pre>
<blockquote>
<p>await/signalç‰ˆæœ¬</p>
</blockquote>
<pre><code class="java">@Slf4j(topic = &quot;OrderReentrant&quot;)
public class OrderReentrantDemo &#123;
    private static final ReentrantLock lock = new ReentrantLock();
    private static final Condition condition = lock.newCondition();
    private static boolean bRunned = false;
    public static void main(String[] args) &#123;
        Thread a = new Thread(() -&gt; &#123;
            lock.lock();
            try &#123;
                if (!bRunned) &#123;
                    condition.await();
                &#125;
                log.debug(&quot;1&quot;);
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125; finally &#123;
                lock.unlock();
            &#125;
        &#125;, &quot;A&quot;);
        Thread b = new Thread(() -&gt; &#123;
            lock.lock();
            try &#123;
                log.debug(&quot;2&quot;);
                bRunned = true;
                condition.signal();
            &#125; finally &#123;
                lock.unlock();
            &#125;
        &#125;, &quot;B&quot;);
        a.start();
        b.start();
    &#125;
&#125;</code></pre>
<blockquote>
<p>park/unparkç‰ˆæœ¬</p>
</blockquote>
<pre><code class="java">@Slf4j(topic = &quot;OrderParkUnpark&quot;)
public class OrderParkUnparkDemo &#123;
    public static void main(String[] args) &#123;
        Thread a = new Thread(() -&gt; &#123;
            LockSupport.park();
            log.debug(&quot;1&quot;);
        &#125;, &quot;A&quot;);
        Thread b = new Thread(() -&gt; &#123;
            log.debug(&quot;2&quot;);
            LockSupport.unpark(a);
        &#125;, &quot;B&quot;);
        a.start();
        b.start();
    &#125;
&#125;</code></pre>
<h4 id="2-4-4-2-äº¤æ›¿è¾“å‡º"><a href="#2-4-4-2-äº¤æ›¿è¾“å‡º" class="headerlink" title="2.4.4.2 äº¤æ›¿è¾“å‡º"></a>2.4.4.2 äº¤æ›¿è¾“å‡º</h4><p>çº¿ç¨‹Aè¾“å‡ºaäº”æ¬¡ï¼Œçº¿ç¨‹Bè¾“å‡ºbäº”æ¬¡ï¼Œçº¿ç¨‹Cè¾“å‡ºcäº”æ¬¡ã€‚</p>
<p>è¦æ±‚ï¼šç¨‹åºäº¤æ›¿è¾“å‡º5æ¬¡<code>abc</code>ã€‚</p>
<blockquote>
<p>wait/notifyç‰ˆæœ¬</p>
</blockquote>
<pre><code class="java">public class AlternateWaitNotifyDemo &#123;
    public static void main(String[] args) &#123;
        AlternateWaitNotify alternateWaitNotify = new AlternateWaitNotify(1, 5);
        new Thread(() -&gt; alternateWaitNotify.print(&quot;a&quot;, 1, 2), &quot;A&quot;).start();
        new Thread(() -&gt; alternateWaitNotify.print(&quot;b&quot;, 2, 3), &quot;B&quot;).start();
        new Thread(() -&gt; alternateWaitNotify.print(&quot;c&quot;, 3, 1), &quot;C&quot;).start();
    &#125;
&#125;

@Slf4j(topic = &quot;AlternateWaitNotify&quot;)
class AlternateWaitNotify &#123;
    // å½“å‰æ ‡è®°
    private int flag;
    // å¾ªç¯æ¬¡æ•°
    private final int loopNumber;

    public AlternateWaitNotify(int flag, int loopNumber) &#123;
        this.flag = flag;
        this.loopNumber = loopNumber;
    &#125;

    /**
     *   è¾“å‡ºå†…å®¹   ç­‰å¾…æ ‡è®°   ä¸‹ä¸ªæ ‡è®°
     *      a         1         2
     *      b         2         3
     *      c         3         1
     *
     * @param str       è¾“å‡ºå†…å®¹
     * @param waitFlag  ç­‰å¾…æ ‡è®°
     * @param nextFlag  ä¸‹ä¸ªæ ‡è®°
     */
    public void print(String str, int waitFlag, int nextFlag) &#123;
        for (int i = 0; i &lt; loopNumber; i++) &#123;
            synchronized (this) &#123;
                while (waitFlag != this.flag) &#123;
                    try &#123;
                        this.wait();
                    &#125; catch (InterruptedException e) &#123;
                        e.printStackTrace();
                    &#125;
                &#125;
                log.debug(str);
                this.flag = nextFlag;
                this.notifyAll();
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
<blockquote>
<p>await/signalç‰ˆæœ¬</p>
</blockquote>
<pre><code class="java">public class AlternateAwaitSignalDemo &#123;
    public static void main(String[] args) &#123;
        AlternateAwaitSignal alternateWaitNotify = new AlternateAwaitSignal(5);
        Condition aCondition = alternateWaitNotify.newCondition();
        Condition bCondition = alternateWaitNotify.newCondition();
        Condition cCondition = alternateWaitNotify.newCondition();
        new Thread(() -&gt; alternateWaitNotify.print(&quot;a&quot;, aCondition, bCondition), &quot;A&quot;).start();
        new Thread(() -&gt; alternateWaitNotify.print(&quot;b&quot;, bCondition, cCondition), &quot;B&quot;).start();
        new Thread(() -&gt; alternateWaitNotify.print(&quot;c&quot;, cCondition, aCondition), &quot;C&quot;).start();
    &#125;
&#125;

@Slf4j(topic = &quot;AlternateAwaitSignal&quot;)
class AlternateAwaitSignal extends ReentrantLock &#123;
    private final int loopNumber;

    public AlternateAwaitSignal(int loopNumber) &#123;
        this.loopNumber = loopNumber;
    &#125;

    /**
     * @param str   æ‰“å°å†…å®¹
     * @param curr  å½“å‰ä¼‘æ¯å®¤
     * @param next  ä¸‹ä¸ªä¼‘æ¯å®¤
     */
    public void print(String str, Condition curr, Condition next) &#123;
        for (int i = 0; i &lt; loopNumber; i++) &#123;
            lock();
            try &#123;
                curr.await();
                log.debug(str);
                next.signal();
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125; finally &#123;
                unlock();
            &#125;
        &#125;
    &#125;
&#125;</code></pre>
<blockquote>
<p>park/unparkç‰ˆæœ¬</p>
</blockquote>
<pre><code class="java">public class AlternateParkUnparkDemo &#123;
    static Thread t1;
    static Thread t2;
    static Thread t3;
    public static void main(String[] args) &#123;
        AlternateParkUnpark alternateParkUnpark = new AlternateParkUnpark(5);
        t1 = new Thread(() -&gt; alternateParkUnpark.print(&quot;a&quot;, t2), &quot;t1&quot;);
        t2 = new Thread(() -&gt; alternateParkUnpark.print(&quot;b&quot;, t3), &quot;t2&quot;);
        t3 = new Thread(() -&gt; alternateParkUnpark.print(&quot;c&quot;, t1), &quot;t3&quot;);
        t1.start();
        t2.start();
        t3.start();
        LockSupport.unpark(t1);
    &#125;
&#125;

@Slf4j(topic = &quot;AlternateParkUnpark&quot;)
class AlternateParkUnpark &#123;
    private final int loopNumber;

    public AlternateParkUnpark(int loopNumber) &#123;
        this.loopNumber = loopNumber;
    &#125;

    public void print(String str, Thread next) &#123;
        for (int i = 0; i &lt; loopNumber; i++) &#123;
            LockSupport.park();
            log.debug(str);
            LockSupport.unpark(next);
        &#125;
    &#125;
&#125;</code></pre>
<blockquote>
<p>å°ç»“</p>
</blockquote>
<p>é‡ç‚¹æŒæ¡ï¼š</p>
<ul>
<li>åˆ†æå¤šçº¿ç¨‹è®¿é—®èµ„æºæ—¶ï¼Œå“ªäº›ä»£ç ç‰‡æ®µå±äºä¸´ç•ŒåŒº</li>
<li>ä½¿ç”¨<code>synchronized</code>äº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜<ul>
<li>æŒæ¡<code>synchronized</code>é”å¯¹è±¡è¯­æ³•</li>
<li>æŒæ¡<code>synchronized</code>åŠ è½½æˆå‘˜æ–¹æ³•å’Œé™æ€æ–¹æ³•è¯­æ³•</li>
<li>æŒæ¡<code>wait/notify</code>åŒæ­¥æ–¹æ³•</li>
</ul>
</li>
<li>ä½¿ç”¨<code>Lock</code>äº’æ–¥è§£å†³ä¸´ç•ŒåŒºçš„çº¿ç¨‹å®‰å…¨é—®é¢˜<ul>
<li>æŒæ¡<code>Lock</code>çš„ä½¿ç”¨ç»†èŠ‚ï¼šå¯æ‰“æ–­ã€é”è¶…æ—¶ã€å…¬å¹³é”ã€æ¡ä»¶å˜é‡</li>
</ul>
</li>
<li>å­¦ä¼šåˆ†æå˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§ã€æŒæ¡å¸¸è§çº¿ç¨‹å®‰å…¨ç±»çš„ä½¿ç”¨</li>
<li>äº†è§£çº¿ç¨‹æ´»è·ƒæ€§é—®é¢˜ï¼šæ­»é”ã€æ´»é”ã€é¥¥é¥¿</li>
<li>åº”ç”¨æ–¹é¢<ul>
<li>äº’æ–¥ï¼šä½¿ç”¨<code>synchronized</code>æˆ–<code>Lock</code>è¾¾åˆ°å…±äº«èµ„æºäº’æ–¥æ•ˆæœ</li>
<li>åŒæ­¥ï¼šä½¿ç”¨<code>wait/notify</code>æˆ–<code>Lock</code>çš„æ¡ä»¶å˜é‡æ¥è¾¾åˆ°çº¿ç¨‹é—´é€šä¿¡æ•ˆæœ</li>
</ul>
</li>
<li>åŸç†æ–¹é¢<ul>
<li><code>monitor</code>ã€<code>sychronized</code>ã€<code>wait/notify</code>åŸç†</li>
<li><code>synchronized</code>è¿›é˜¶åŸç†</li>
<li><code>park &amp; unpark</code>åŸç†</li>
</ul>
</li>
<li>æ¨¡å¼æ–¹é¢<ul>
<li>åŒæ­¥æ¨¡å¼ä¹‹ä¿æŠ¤æ€§æš‚åœ</li>
<li>å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…æ¶ˆè´¹è€…</li>
<li>åŒæ­¥æ¨¡å¼ä¹‹é¡ºåºæ§åˆ¶</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JUC-1(çº¿ç¨‹åŸºç¡€)</title>
    <url>/posts/9175/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-1-é¡¹ç›®å‡†å¤‡"><a href="#1-1-é¡¹ç›®å‡†å¤‡" class="headerlink" title="1.1 é¡¹ç›®å‡†å¤‡"></a>1.1 é¡¹ç›®å‡†å¤‡</h2><h3 id="1-1-1-ä½•è°“JUC"><a href="#1-1-1-ä½•è°“JUC" class="headerlink" title="1.1.1 ä½•è°“JUC"></a>1.1.1 ä½•è°“JUC</h3><p><code>java.util.concurrent</code></p>
<h3 id="1-1-2-Mavenå·¥ç¨‹"><a href="#1-1-2-Mavenå·¥ç¨‹" class="headerlink" title="1.1.2 Mavenå·¥ç¨‹"></a>1.1.2 Mavenå·¥ç¨‹</h3><p>pom.xmlï¼š</p>
<pre><code class="xml">&lt;properties&gt;
    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
    &lt;lombok.version&gt;1.18.12&lt;/lombok.version&gt;
    &lt;logback.version&gt;1.1.2&lt;/logback.version&gt;
    &lt;jmh.version&gt;1.28&lt;/jmh.version&gt;
    &lt;junit.version&gt;4.13.1&lt;/junit.version&gt;
&lt;/properties&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
        &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;version&gt;$&#123;lombok.version&#125;&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
        &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
        &lt;version&gt;$&#123;logback.version&#125;&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.openjdk.jmh&lt;/groupId&gt;
        &lt;artifactId&gt;jmh-core&lt;/artifactId&gt;
        &lt;version&gt;$&#123;jmh.version&#125;&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;version&gt;$&#123;junit.version&#125;&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
<h3 id="1-1-3-æ—¥å¿—é…ç½®"><a href="#1-1-3-æ—¥å¿—é…ç½®" class="headerlink" title="1.1.3 æ—¥å¿—é…ç½®"></a>1.1.3 æ—¥å¿—é…ç½®</h3><p>logback.xml</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration debug=&quot;false&quot;&gt;

    &lt;!-- å®šä¹‰æ—¥å¿—æ–‡ä»¶çš„å­˜å‚¨åœ°å€ --&gt;
    &lt;property name=&quot;LOG_HOME&quot; value=&quot;log/&quot; /&gt;

    &lt;!-- æ§åˆ¶å°è¾“å‡º --&gt;
    &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;
            &lt;!-- æ ¼å¼åŒ–è¾“å‡ºï¼š%dè¡¨ç¤ºæ—¥æœŸï¼Œ%threadè¡¨ç¤ºçº¿ç¨‹åï¼Œ%-5levelï¼šçº§åˆ«ä»å·¦æ˜¾ç¤º5ä¸ªå­—ç¬¦å®½åº¦,%msgï¼šæ—¥å¿—æ¶ˆæ¯ï¼Œ%næ˜¯æ¢è¡Œç¬¦ --&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!-- æ–‡ä»¶æ—¥å¿—ï¼ŒæŒ‰ç…§æ¯å¤©ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ --&gt;
    &lt;appender name=&quot;FILE&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
            &lt;!-- æ—¥å¿—æ–‡ä»¶è¾“å‡ºçš„æ–‡ä»¶å --&gt;
            &lt;FileNamePattern&gt;$&#123;LOG_HOME&#125;/juc.%d&#123;yyyy-MM-dd&#125;.log&lt;/FileNamePattern&gt;
            &lt;!-- æ—¥å¿—æ–‡ä»¶ä¿ç•™å¤©æ•° --&gt;
            &lt;MaxHistory&gt;30&lt;/MaxHistory&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;
            &lt;!-- æ ¼å¼åŒ–è¾“å‡ºï¼š%dè¡¨ç¤ºæ—¥æœŸï¼Œ%threadè¡¨ç¤ºçº¿ç¨‹åï¼Œ%-5levelï¼šçº§åˆ«ä»å·¦æ˜¾ç¤º5ä¸ªå­—ç¬¦å®½åº¦%msgï¼šæ—¥å¿—æ¶ˆæ¯ï¼Œ%næ˜¯æ¢è¡Œç¬¦ --&gt;
            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
        &lt;!-- æ—¥å¿—æ–‡ä»¶æœ€å¤§çš„å¤§å° --&gt;
        &lt;triggeringPolicy class=&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;&gt;
            &lt;MaxFileSize&gt;10MB&lt;/MaxFileSize&gt;
        &lt;/triggeringPolicy&gt;
    &lt;/appender&gt;

    &lt;!-- æ—¥å¿—è¾“å‡ºçº§åˆ« --&gt;
    &lt;root level=&quot;DEBUG&quot;&gt;
        &lt;appender-ref ref=&quot;STDOUT&quot; /&gt;
        &lt;appender-ref ref=&quot;FILE&quot;/&gt;
    &lt;/root&gt;

&lt;/configuration&gt;</code></pre>
<h2 id="1-2-ç›¸å…³æ¦‚å¿µ"><a href="#1-2-ç›¸å…³æ¦‚å¿µ" class="headerlink" title="1.2 ç›¸å…³æ¦‚å¿µ"></a>1.2 ç›¸å…³æ¦‚å¿µ</h2><h3 id="1-2-1-çº¿ç¨‹ä¸è¿›ç¨‹"><a href="#1-2-1-çº¿ç¨‹ä¸è¿›ç¨‹" class="headerlink" title="1.2.1 çº¿ç¨‹ä¸è¿›ç¨‹"></a>1.2.1 çº¿ç¨‹ä¸è¿›ç¨‹</h3><blockquote>
<p>è¿›ç¨‹</p>
</blockquote>
<ul>
<li>ç¨‹åºç”±æŒ‡ä»¤å’Œæ•°æ®ç»„æˆï¼Œä½†è¿™äº›æŒ‡ä»¤è¦è¿è¡Œï¼Œæ•°æ®è¦è¯»å†™ï¼Œå°±å¿…é¡»å°†æŒ‡ä»¤åŠ è½½è‡³CPUï¼Œæ•°æ®åŠ è½½è‡³å†…å­˜ã€‚åœ¨æŒ‡ä»¤è¿è¡Œè¿‡ç¨‹ä¸­è¿˜éœ€è¦ç”¨åˆ°ç£ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡ã€‚è¿›ç¨‹å°±æ˜¯ç”¨æ¥åŠ è½½æŒ‡ä»¤ã€ç®¡ç†å†…å­˜ã€ç®¡ç†IOçš„ã€‚</li>
<li>å½“ä¸€ä¸ªç¨‹åºè¢«è¿è¡Œï¼Œä»ç£ç›˜åŠ è½½è¿™ä¸ªç¨‹åºçš„ä»£ç è‡³å†…å­˜ï¼Œè¿™æ—¶å°±å¼€å¯äº†ä¸€ä¸ªè¿›ç¨‹ã€‚</li>
<li>è¿›ç¨‹å°±å¯ä»¥è§†ä¸ºç¨‹åºçš„ä¸€ä¸ªå®ä¾‹ã€‚å¤§éƒ¨åˆ†ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚IntelliJ IDEAï¼‰ï¼Œä¹Ÿæœ‰çš„ç¨‹åºåªèƒ½å¯åŠ¨ä¸€ä¸ªå®ä¾‹è¿›ç¨‹ï¼ˆä¾‹å¦‚QQéŸ³ä¹ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>çº¿ç¨‹</p>
</blockquote>
<ul>
<li>ä¸€ä¸ªè¿›ç¨‹ä¹‹å†…å¯ä»¥åˆ†åˆ°å¤šä¸ªçº¿ç¨‹ã€‚</li>
<li>ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªæŒ‡ä»¤æµï¼Œå°†æŒ‡ä»¤æµä¸­çš„ä¸€æ¡æ¡æŒ‡ä»¤ä»¥ä¸€å®šçš„é¡ºåºäº¤ç»™CPUæ‰§è¡Œã€‚</li>
<li>Javaä¸­ï¼Œçº¿ç¨‹ä½œä¸ºæœ€å°è°ƒåº¦å•ä½ï¼Œè¿›ç¨‹ä½œä¸ºèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚åœ¨Windowsä¸­è¿›ç¨‹æ˜¯ä¸æ´»åŠ¨çš„ï¼Œåªæ˜¯ä½œä¸ºçº¿ç¨‹çš„å®¹å™¨ã€‚</li>
</ul>
<blockquote>
<p>åŒºåˆ«</p>
</blockquote>
<ul>
<li>çº¿ç¨‹æ˜¯ç¨‹åºæ‰§è¡Œçš„æœ€å°å•ä½ï¼Œè¿›ç¨‹æ˜¯OSåˆ†é…èµ„æºçš„æœ€å°å•ä½ã€‚</li>
<li>ä¸€ä¸ªè¿›ç¨‹ç”±ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç»„æˆï¼Œçº¿ç¨‹æ˜¯ä¸€ä¸ªè¿›ç¨‹ä¸­ä»£ç çš„ä¸åŒæ‰§è¡Œè·¯çº¿ã€‚</li>
<li>è¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œä½†åŒä¸€è¿›ç¨‹ä¸‹çš„å„ä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ç¨‹åºçš„å†…å­˜ç©ºé—´(åŒ…æ‹¬ä»£ç æ®µã€æ•°æ®é›†å’Œå †ç­‰)åŠä¸€äº›è¿›ç¨‹çº§çš„èµ„æºï¼Œä¸€ä¸ªè¿›ç¨‹å†…çš„çº¿ç¨‹åœ¨å…¶ä»–è¿›ç¨‹ä¸å¯è§ã€‚</li>
<li>è°ƒåº¦å’Œåˆ‡æ¢ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è¦å¿«å¾—å¤šã€‚</li>
</ul>
<blockquote>
<p>è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼</p>
</blockquote>
<p>ï¼ˆ1ï¼‰ç®¡é“ï¼šåˆ†ä¸ºæ— åç®¡é“å’Œæœ‰åç®¡é“ï¼Œéƒ½æ˜¯åŠåŒå·¥çš„é€šä¿¡æ–¹å¼</p>
<p>æ— åç®¡é“ï¼šæ•°æ®åªèƒ½å•å‘æµåŠ¨ï¼Œè€Œä¸”åªèƒ½åœ¨å…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ä½¿ç”¨ã€‚</p>
<p>æœ‰åç®¡é“ï¼šå…è®¸æ— äº²ç¼˜å…³ç³»è¿›ç¨‹é—´çš„é€šä¿¡ã€‚ï¼ˆäº²ç¼˜å…³ç³»ä¸€èˆ¬æŒ‡çˆ¶å­è¿›ç¨‹ï¼‰</p>
<p>ï¼ˆ2ï¼‰ä¿¡å·é‡</p>
<p>ä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚ä¿¡å·é‡å¸¸ä½œä¸ºä¸€ç§é”æœºåˆ¶ï¼Œç”¨äºå®ç°è¿›ç¨‹é—´çš„äº’æ–¥ä¸åŒæ­¥ï¼ˆæˆ–è€…åŒä¸€ä¸ªè¿›ç¨‹é—´çš„ä¸åŒè¿›ç¨‹é—´çš„åŒæ­¥ï¼‰ï¼Œè€Œä¸æ˜¯ç”¨äºå­˜å‚¨è¿›ç¨‹é—´é€šä¿¡æ•°æ®ã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ä¿¡å·é‡ç”¨äºè¿›ç¨‹é—´åŒæ­¥ï¼Œè‹¥è¦åœ¨è¿›ç¨‹é—´ä¼ é€’æ•°æ®éœ€è¦ç»“åˆå…±äº«å†…å­˜ã€‚</li>
<li>ä¿¡å·é‡åŸºäºæ“ä½œç³»ç»Ÿçš„PVæ“ä½œï¼Œç¨‹åºå¯¹ä¿¡å·é‡çš„æ“ä½œéƒ½æ˜¯åŸå­æ“ä½œã€‚</li>
<li>æ¯æ¬¡å¯¹ä¿¡å·é‡çš„PVæ“ä½œä¸ä»…é™äºå¯¹ä¿¡å·é‡å€¼åŠ 1æˆ–å‡1ï¼Œè€Œä¸”å¯ä»¥åŠ å‡ä»»æ„æ­£æ•´æ•°ã€‚</li>
<li>æ”¯æŒä¿¡å·é‡ç»„ã€‚</li>
</ul>
<p>ï¼ˆ3ï¼‰æ¶ˆæ¯é˜Ÿåˆ—</p>
<p>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ¶ˆæ¯çš„é“¾è¡¨ï¼Œå­˜æ”¾åœ¨å†…æ ¸ä¸­ã€‚ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ç”±ä¸€ä¸ªé˜Ÿåˆ—æ ‡è¯†ç¬¦ï¼ˆé˜Ÿåˆ—IDï¼‰æ¥æ ‡è¯†ã€‚æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†ä¿¡å·ä¼ é€’ä¿¡æ¯å°‘ã€ç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç¼ºç‚¹ã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯é¢å‘è®°å½•çš„ï¼Œå…¶ä¸­çš„æ¶ˆæ¯å…·æœ‰ç‰¹å®šçš„æ ¼å¼å’Œç‰¹å®šçš„ä¼˜å…ˆçº§ã€‚</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—ç‹¬ç«‹äºå‘é€å’Œæ¥æ”¶è¿›ç¨‹ã€‚è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—åŠå…¶å†…å®¹å¹¶ä¸ä¼šè¢«åˆ é™¤ã€‚</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å®ç°æ¶ˆæ¯çš„éšæœºæŸ¥è¯¢ï¼Œæ¶ˆæ¯ä¸ä¸€å®šè¦ä»¥å…ˆè¿›å…ˆå‡ºçš„æ¬¡åºè¯»å–ï¼Œä¹Ÿå¯ä»¥æŒ‰æ¶ˆæ¯çš„ç±»å‹è¯»å–ã€‚</li>
</ul>
<p>ï¼ˆ4ï¼‰å…±äº«å†…å­˜</p>
<p>å…±äº«å†…å­˜ï¼ŒæŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹å…±äº«ä¸€ä¸ªç»™å®šçš„å­˜å‚¨åŒºã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å…±äº«å†…å­˜æ˜¯æœ€å¿«çš„ä¸€ç§IPCï¼Œå› ä¸ºè¿›ç¨‹æ˜¯ç›´æ¥å¯¹å†…å­˜è¿›è¡Œå­˜å–ã€‚</li>
<li>å› ä¸ºå¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶æ“ä½œï¼Œæ‰€ä»¥éœ€è¦è¿›è¡ŒåŒæ­¥ã€‚</li>
<li>ä¿¡å·é‡+å…±äº«å†…å­˜é€šå¸¸ç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ï¼Œä¿¡å·é‡ç”¨æ¥åŒæ­¥å¯¹å…±äº«å†…å­˜çš„è®¿é—®ã€‚</li>
</ul>
<p>ï¼ˆ5ï¼‰ä¿¡å·</p>
<p>ä¿¡å·æ˜¯ä¸€ç§æ¯”è¾ƒå¤æ‚çš„é€šä¿¡æ–¹å¼ï¼Œç”¨äºé€šçŸ¥æ¥æ”¶è¿›ç¨‹æŸä¸ªäº‹ä»¶å·²ç»å‘ç”Ÿã€‚</p>
<p>ï¼ˆ6ï¼‰å¥—æ¥å­—</p>
<p>å¥—æ¥å­—ä¹Ÿæ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œå¯ç”¨äºä¸åŒä¸»æœºé—´çš„è¿›ç¨‹é€šä¿¡ã€‚</p>
<h3 id="1-2-2-å¹¶å‘ä¸å¹¶è¡Œ"><a href="#1-2-2-å¹¶å‘ä¸å¹¶è¡Œ" class="headerlink" title="1.2.2 å¹¶å‘ä¸å¹¶è¡Œ"></a>1.2.2 å¹¶å‘ä¸å¹¶è¡Œ</h3><blockquote>
<p>å¹¶å‘</p>
</blockquote>
<p>å•æ ¸CPUä¸‹ï¼Œçº¿ç¨‹å®é™…è¿˜æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚æ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨å°†CPUçš„æ—¶é—´ç‰‡ï¼ˆWindowsä¸‹æ—¶é—´æœ€å°çº¦15msï¼‰åˆ†ç»™ä¸åŒçš„çº¿ç¨‹ä½¿ç”¨ï¼Œåªæ˜¯ç”±äºCPUåœ¨çº¿ç¨‹é—´ï¼ˆæ—¶é—´ç‰‡å¾ˆçŸ­ï¼‰çš„åˆ‡æ¢éå¸¸å¿«ï¼Œäººç±»æ„Ÿè§‰æ˜¯åŒæ—¶è¿è¡Œçš„ã€‚å¾®è§‚ä¸²è¡Œï¼Œå®è§‚å¹¶è¡Œã€‚</p>
<p>ä¸€èˆ¬ä¼šå°†è¿™ç§çº¿ç¨‹è½®æµä½¿ç”¨CPUçš„åšæ³•å«åšå¹¶å‘ï¼Œconcurrentã€‚</p>
<blockquote>
<p>å¹¶è¡Œ</p>
</blockquote>
<p>å¤šæ ¸CPUä¸‹ï¼Œæ¯ä¸ªæ ¸éƒ½å¯ä»¥è°ƒåº¦è¿è¡Œçº¿ç¨‹ï¼Œè¿™æ—¶å€™çº¿ç¨‹å¯ä»¥æ˜¯å¹¶è¡Œçš„ï¼Œparallelã€‚</p>
<blockquote>
<p>åŒºåˆ«</p>
</blockquote>
<p>å¹¶å‘ï¼šå¤šçº¿ç¨‹æ“ä½œä¸€ä¸ªèµ„æºï¼ˆä¸ä¸€å®šåŒæ—¶ï¼‰ï¼ŒCPUä¸€æ ¸äº¤æ›¿è¿è¡Œå¤šæ¡çº¿ç¨‹</p>
<p>å¹¶è¡Œï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼ˆåŒæ—¶ï¼‰ï¼ŒCPUå¤šæ ¸åŒæ—¶æ‰§è¡Œå¤šæ¡çº¿ç¨‹</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/9175/BFBX.jpg" class="" title="BFBX">



<blockquote>
<p>TIP</p>
</blockquote>
<p>æŸ¥çœ‹CPUæ ¸æ•°ï¼š<code>Runtime.getRuntime().availableProcessors()</code></p>
<h3 id="1-2-3-åº”ç”¨"><a href="#1-2-3-åº”ç”¨" class="headerlink" title="1.2.3 åº”ç”¨"></a>1.2.3 åº”ç”¨</h3><blockquote>
<p>å¼‚æ­¥è°ƒç”¨</p>
</blockquote>
<p>ä»æ–¹æ³•è°ƒç”¨çš„è§’åº¦æ¥è®²ï¼Œå¦‚æœï¼š</p>
<ul>
<li>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥</li>
<li>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</li>
</ul>
<p>æ³¨æ„ï¼šåŒæ­¥åœ¨å¤šçº¿ç¨‹ä¸­è¿˜æœ‰ä¸€å±‚æ„æ€ï¼Œæ˜¯è®©å¤šä¸ªçº¿ç¨‹æ­¥è°ƒä¸€è‡´ã€‚</p>
<blockquote>
<p>è®¾è®¡</p>
</blockquote>
<p>å¤šçº¿ç¨‹å¯ä»¥è®©æ–¹æ³• æ‰§è¡Œå˜ä¸ºå¼‚æ­¥çš„ã€‚</p>
<ul>
<li>æ¯”å¦‚åœ¨é¡¹ç›®ä¸­ï¼Œè§†é¢‘æ–‡ä»¶éœ€è¦è½¬æ¢æ ¼å¼ç­‰æ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œè¿™æ—¶å¼€ä¸€ä¸ªçº¿ç¨‹å¤„ç†è§†é¢‘è½¬æ¢ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚</li>
<li>tomcatçš„å¼‚æ­¥servletyä¹Ÿæ˜¯ç±»ä¼¼çš„ç›®çš„ï¼Œè®©ç”¨æˆ·çº¿ç¨‹å¤„ç†è€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œé¿å…é˜»å¡tomcatçš„å·¥ä½œçº¿ç¨‹ã€‚</li>
<li>UIç¨‹åºä¸­ï¼Œå¼€çº¿ç¨‹è¿›è¡Œå…¶ä»–æ“ä½œï¼Œé¿å…é˜»å¡UIçº¿ç¨‹ã€‚</li>
</ul>
<h2 id="1-3-Javaçº¿ç¨‹"><a href="#1-3-Javaçº¿ç¨‹" class="headerlink" title="1.3 Javaçº¿ç¨‹"></a>1.3 Javaçº¿ç¨‹</h2><h3 id="1-3-1-åˆ›å»ºçº¿ç¨‹"><a href="#1-3-1-åˆ›å»ºçº¿ç¨‹" class="headerlink" title="1.3.1 åˆ›å»ºçº¿ç¨‹"></a>1.3.1 åˆ›å»ºçº¿ç¨‹</h3><blockquote>
<p>Thread</p>
</blockquote>
<p>æ–¹å¼ä¸€ï¼šç»§æ‰¿<code>Thread</code>ï¼Œé‡å†™<code>run()</code>æ–¹æ³•ã€‚</p>
<p>ä¼˜ç‚¹ï¼šåœ¨<code>run()</code>æ–¹æ³•å†…è·å–å½“å‰çº¿ç¨‹ç›´æ¥ä½¿ç”¨<code>this</code>å³å¯ã€‚</p>
<pre><code class="java">public class ThreadTest &#123;

    public static class MyThread extends Thread &#123;
        @Override
        public void run() &#123;
            System.out.println(&quot;I am a child thread.&quot;);
        &#125;
    &#125;

    public static void main(String[] args) &#123;
        MyThread thread = new MyThread();
        thread.start();
    &#125;
&#125;</code></pre>
<blockquote>
<p>Runnable</p>
</blockquote>
<p>æ–¹å¼äºŒï¼šå®ç°<code>Runnable</code>ï¼Œå®ç°<code>run()</code>æ–¹æ³•ã€‚</p>
<p>ä¼˜ç‚¹ï¼šä»»åŠ¡ä¸é€»è¾‘åˆ†ç¦»ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ã€‚</p>
<pre><code class="java">public class RunnableTaskTest implements Runnable&#123;

    @Override
    public void run() &#123;
        System.out.println(&quot;I am a child thread.&quot;);
    &#125;

    public static void main(String[] args) &#123;
        RunnableTaskTest task = new RunnableTaskTest();
        new Thread(task).start();
        new Thread(task).start();
    &#125;
&#125;</code></pre>
<blockquote>
<p>FutureTask</p>
</blockquote>
<p>æ–¹å¼ä¸‰ï¼šå®ç°<code>Callable</code>æ¥å£ï¼Œå®ç°<code>call</code>æ–¹æ³•ï¼Œé€šè¿‡<code>FutureTask</code>åˆ›å»ºçº¿ç¨‹ã€‚</p>
<p>ä¼˜ç‚¹ï¼šä»»åŠ¡å¯ä»¥æºå¸¦è¿”å›å€¼ã€‚</p>
<pre><code class="java">public class CallerTaskTest &#123;

    public static class CallerTask implements Callable&lt;String&gt; &#123;
        @Override
        public String  call() throws Exception &#123;
            return &quot;KHighness&quot;;
        &#125;
    &#125;

    public static void main(String[] args) throws InterruptedException&#123;
        FutureTask&lt;String&gt; futureTask = new FutureTask&lt;&gt;(new CallerTask());
        new Thread(futureTask).start();
        try &#123;
            String result = futureTask.get();
            System.out.println(result);
        &#125; catch (ExecutionException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

&#125;</code></pre>
<h3 id="1-3-2-æŸ¥çœ‹çº¿ç¨‹"><a href="#1-3-2-æŸ¥çœ‹çº¿ç¨‹" class="headerlink" title="1.3.2 æŸ¥çœ‹çº¿ç¨‹"></a>1.3.2 æŸ¥çœ‹çº¿ç¨‹</h3><blockquote>
<p>Windows</p>
</blockquote>
<ul>
<li><code>taskmgr</code>ï¼šæ‰“å¼€ä»»åŠ¡ç®¡ç†å™¨</li>
<li><code>tasklist | findstr &lt;pid&gt;/&lt;pname&gt;  </code>ï¼šæ ¹æ®è¿›ç¨‹idæˆ–è€…åç§°æŸ¥æ‰¾è¿›ç¨‹</li>
<li><code>taskkill /pid &lt;pid&gt;  </code> ï¼šæ ¹æ®è¿›ç¨‹idç»ˆæ­¢è¿›ç¨‹</li>
<li><code>taskkill /im &lt;pname&gt;</code>ï¼šæ ¼å±€è¿›ç¨‹åç§°ç»ˆæ­¢è¿›ç¨‹</li>
<li><code>/t</code>ï¼šç»ˆæ­¢æŒ‡å®šçš„è¿›ç¨‹å’Œç”±å®ƒå¯ç”¨çš„å­è¿›ç¨‹</li>
<li><code>/f</code>ï¼šæŒ‡å®šå¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹</li>
</ul>
<blockquote>
<p>Linux</p>
</blockquote>
<ul>
<li><code>ps -ef</code>ï¼šæŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹</li>
<li><code>ps -fT -p &lt;pid&gt;</code>ï¼šæŸ¥çœ‹æŸä¸ªè¿›ç¨‹(ID)çš„æ‰€æœ‰çº¿ç¨‹</li>
<li><code>kill</code>ï¼šç»ˆæ­¢è¿›ç¨‹</li>
<li><code>top -H -p &lt;pid&gt;</code>ï¼šæŸ¥çœ‹æŸä¸ªè¿›ç¨‹(ID)çš„æ‰€æœ‰çº¿ç¨‹</li>
</ul>
<blockquote>
<p>Java</p>
</blockquote>
<ul>
<li><code>jps</code>ï¼šæŸ¥çœ‹æ‰€æœ‰javaè¿›ç¨‹</li>
<li><code>jstack &lt;pid&gt;</code>ï¼šæŸ¥çœ‹æŸä¸ªJavaè¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€</li>
</ul>
<blockquote>
<p>jconsoleè¿œç¨‹ç›‘æ§</p>
</blockquote>
<p>éœ€è¦å¦‚ä¸‹æ–¹å¼è¿è¡Œç±»ï¼š</p>
<pre><code class="shell">java -Djava.rmi.server.hostname=&lt;ip&gt; -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=&lt;port&gt; -Dcom.sun.management.jmxremote.ssl=&lt;true/false&gt; -Dcom.sun.management.jmxremote.authenticate=&lt;true/false&gt; &lt;class&gt;</code></pre>
<p>å¦‚æœè®¤è¯è®¿é—®åˆ™éœ€è¦ï¼š</p>
<ul>
<li>å¤åˆ¶jmxremote.passwordæ–‡ä»¶</li>
<li>ä¿®æ”¹jmxremote.passwordå’Œjmxremote.accessæ–‡ä»¶çš„æƒé™ä¸º600</li>
<li>è¿æ¥æ—¶å€™å¡«å…¥c</li>
</ul>
<h3 id="1-3-3-è¿è¡ŒåŸç†"><a href="#1-3-3-è¿è¡ŒåŸç†" class="headerlink" title="1.3.3 è¿è¡ŒåŸç†"></a>1.3.3 è¿è¡ŒåŸç†</h3><blockquote>
<p>æ ˆä¸æ ˆå¸§</p>
</blockquote>
<p>Java Virtual Machine Stacksï¼ˆJavaè™šæ‹Ÿæœºæ ˆï¼‰</p>
<ul>
<li>æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å çš„å†…å­˜</li>
<li>æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•</li>
</ul>
<blockquote>
<p>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</p>
</blockquote>
<p>å› ä¸ºä»¥ä¸‹åŸå› å¯¼è‡´CPUä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç ï¼š</p>
<ul>
<li>çº¿ç¨‹çš„CPUæ—¶é—´ç‰‡ç”¨å®Œ</li>
<li>åƒåœ¾å›æ”¶</li>
<li>æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ</li>
<li>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº†sleepã€yieldã€waitã€joinã€parkã€sychronizedã€lockç­‰æ–¹æ³•</li>
</ul>
<p>å½“Thread Context Switchå‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒJavaä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯è®°ä½ä¸‹ä¸€æ¡JVMæŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</p>
<ul>
<li>çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰</li>
<li>Thread Context Switché¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½</li>
</ul>
<h3 id="1-3-4-å¸¸è§æ–¹æ³•"><a href="#1-3-4-å¸¸è§æ–¹æ³•" class="headerlink" title="1.3.4 å¸¸è§æ–¹æ³•"></a>1.3.4 å¸¸è§æ–¹æ³•</h3><table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>åŠŸèƒ½</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>start()</code></td>
<td>å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåœ¨æ–°çš„çº¿ç¨‹è¿è¡Œrunæ–¹æ³•ä¸­çš„ä»£ç </td>
<td>startæ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥å°±ç»ªï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç†ç§‘è¿è¡Œï¼ˆCPUçš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„startæ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç°<code>IllegalThreadStateException</code>ã€‚</td>
</tr>
<tr>
<td><code>run()</code></td>
<td>æ–°çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨çš„æ–¹æ³•</td>
<td>å¦‚æœåœ¨æ„é€ <code>Thread</code>å¯¹è±¡æ—¶ä¼ é€’äº†<code>Runnable</code>å‚æ•°ï¼Œåˆ™çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨<code>Runnable</code>ä¸­çš„runæ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º<code>Thread</code>çš„å­ç±»å¯¹è±¡ï¼Œæ¥è¦†ç›–é»˜è®¤è¡Œä¸ºã€‚</td>
</tr>
<tr>
<td><code>join()</code></td>
<td>ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸ</td>
<td></td>
</tr>
<tr>
<td><code>join(long n)</code></td>
<td>ç­‰å¾…çº¿ç¨‹è¿è¡Œç»“æŸï¼Œæœ€å¤šç­‰å¾…næ¯«ç§’</td>
<td></td>
</tr>
<tr>
<td><code>getId()</code></td>
<td>è·å–çº¿ç¨‹é•¿æ•´å‹çš„id</td>
<td>idå”¯ä¸€</td>
</tr>
<tr>
<td><code>getName()</code></td>
<td>è·å–çº¿ç¨‹å</td>
<td></td>
</tr>
<tr>
<td><code>setName(String)</code></td>
<td>ä¿®æ”¹çº¿ç¨‹å</td>
<td></td>
</tr>
<tr>
<td><code>getPriority()</code></td>
<td>è·å–çº¿ç¨‹ä¼˜å…ˆçº§</td>
<td></td>
</tr>
<tr>
<td><code>setPriority(int)</code></td>
<td>ä¿®æ”¹çº¿ç¨‹ä¼˜å…ˆçº§</td>
<td>Javaä¸­è§„å®šçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯1~10çš„æ•´æ•°ï¼Œè¾ƒå¤§çš„ä¼˜å…ˆçº§èƒ½æé«˜è¯¥çº¿ç¨‹è¢«CPUè°ƒåº¦çš„å‡ ç‡</td>
</tr>
<tr>
<td><code>getState()</code></td>
<td>è·å–çº¿ç¨‹çŠ¶æ€</td>
<td>Javaä¸­çº¿ç¨‹çŠ¶æ€æ˜¯ç”¨6ä¸ª<code>enum</code>è¡¨ç¤ºï¼Œåˆ†åˆ«ä¸ºï¼š<code>NEW</code>ã€<code>RUNNABLE</code>ã€<code>BLOCKED</code>ã€<code>WAITING</code>ã€<code>TIMED_WAITING</code>ã€<code>TERMINATED</code>ã€‚</td>
</tr>
<tr>
<td><code>isInterrupted()</code></td>
<td>åˆ¤æ–­æ˜¯å¦ç»™æ‰“æ–­</td>
<td>ä¸ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°ã€‚çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ä¸å—æ­¤æ–¹æ³•çš„å½±å“ã€‚</td>
</tr>
<tr>
<td><code>isAlive()</code></td>
<td>çº¿ç¨‹æ˜¯å¦å­˜æ´»</td>
<td></td>
</tr>
<tr>
<td><code>interrupt()</code></td>
<td>æ‰“æ–­çº¿ç¨‹</td>
<td>å¦‚æœè¢«æ‰“æ–­çº¿ç¨‹æ­£åœ¨sleepã€waitã€joinä¼šå¯¼è‡´è¢«æ‰“æ–­çš„çº¿ç¨‹æŠ›å‡º<code>InterruptedException</code>ï¼Œå¹¶æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼›å¦‚æœæ‰“æ–­çš„æ˜¯æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œåˆ™ä¼šè®¾ç½®æ‰“æ–­æ ‡è®°ï¼›parkçš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œä¹Ÿä¼šè®¾ç½®æ‰“æ–­æ ‡è®°ã€‚</td>
</tr>
<tr>
<td><code>interrupted()</code> static</td>
<td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­</td>
<td>æ¸…é™¤çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ã€‚å¦‚æœè¿™ä¸ªæ–¹æ³•è¿ç»­è°ƒç”¨ä¸¤æ¬¡ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è°ƒç”¨å°†è¿”å›falseã€‚</td>
</tr>
<tr>
<td><code>currentThread()</code> static</td>
<td>è·å–å½“å‰çº¿ç¨‹</td>
<td></td>
</tr>
<tr>
<td><code>sleep()</code> static</td>
<td>è®©å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ä¼‘çœ næ¯«ç§’ï¼Œä¼‘çœ æ—¶é—´è®©å‡ºCPUçš„æ—¶é—´ç‰‡ç»™å…¶ä»–çº¿ç¨‹</td>
<td></td>
</tr>
<tr>
<td><code>yield()</code> static</td>
<td>æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹CPUçš„ä½¿ç”¨</td>
<td>ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•å’Œè°ƒè¯•</td>
</tr>
</tbody></table>
<h3 id="1-3-5-startå’Œrun"><a href="#1-3-5-startå’Œrun" class="headerlink" title="1.3.5 startå’Œrun"></a>1.3.5 startå’Œrun</h3><ul>
<li>startï¼šè®©çº¿ç¨‹å¤„äºå°±ç»ªçŠ¶æ€ï¼Œå¹¶æ²¡æœ‰è¿è¡Œï¼Œä¸€æ—¦å¾—åˆ°CPUæ—¶é—´ç‰‡ï¼Œå°±å¼€å§‹è¿è¡Œrun()æ–¹æ³•ã€‚</li>
<li>runï¼šå¦‚æœè¯¥çº¿ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„<code>Runnable</code>è¿è¡Œå¯¹è±¡æ„é€ çš„ï¼Œåˆ™è°ƒç”¨è¯¥<code>Runnable</code>å¯¹è±¡çš„run()æ–¹æ³•ï¼Œå¦åˆ™ï¼Œè¯¥æ–¹æ³•ä¸æ‰§è¡Œä»»ä½•æ“ä½œè¿”å›ã€‚</li>
<li>æ€»ç»“ï¼šè°ƒç”¨<code>start</code>æ–¹æ³•å¯å¯åŠ¨çº¿ç¨‹ï¼Œè€Œ<code>run</code>æ–¹æ³•åªæ˜¯<code>Thread</code>ç±»ä¸­çš„ä¸€ä¸ªæ™®é€šè°ƒç”¨ï¼Œè¿˜æ˜¯åœ¨ä¸»çº¿ç¨‹é‡Œæ‰§è¡Œã€‚</li>
</ul>
<h3 id="1-3-6-sleepä¸yield"><a href="#1-3-6-sleepä¸yield" class="headerlink" title="1.3.6 sleepä¸yield"></a>1.3.6 sleepä¸yield</h3><blockquote>
<p>sleep</p>
</blockquote>
<ul>
<li>è°ƒç”¨<code>sleep</code>ä¼šè®©å½“å‰çº¿ç¨‹ä»<code>RUNNING</code>è¿›å…¥åˆ°<code>TIMED_WAITING</code>çŠ¶æ€</li>
<li>å…¶ä»–çº¿ç¨‹å¯ä»¥ä½¿ç”¨<code>interrupt</code>æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ã€‚</li>
<li>ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œã€‚</li>
<li>å»ºè®®ä½¿ç”¨<code>TimeUnit</code>çš„<code>sleep</code>ä»£æ›¿<code>Thread</code>çš„<code>sleep</code>æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§ã€‚</li>
</ul>
<blockquote>
<p>yield</p>
</blockquote>
<ul>
<li>è°ƒç”¨<code>yield</code>ä¼šè®©å½“å‰çº¿ç¨‹ä»<code>RUNNING</code>è¿›å…¥<code>RUNNABLE</code>å°±ç»ªçŠ¶æ€ï¼Œç„¶åè°ƒåº¦æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚</li>
<li>å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨ã€‚</li>
</ul>
<h3 id="1-3-7-çº¿ç¨‹ä¼˜å…ˆçº§"><a href="#1-3-7-çº¿ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="1.3.7 çº¿ç¨‹ä¼˜å…ˆçº§"></a>1.3.7 çº¿ç¨‹ä¼˜å…ˆçº§</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li>çº¿ç¨‹ä¼˜å…ˆçº§ä¼šæç¤ºè°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒã€‚</li>
<li>å¦‚æœCPUæ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½†æ˜¯CPUé—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡æœ‰ä½œç”¨ã€‚</li>
</ul>
<h3 id="1-3-8-join"><a href="#1-3-8-join" class="headerlink" title="1.3.8 join"></a>1.3.8 join</h3><blockquote>
<p>ç¤ºä¾‹</p>
</blockquote>
<p>åœ¨ä¸‹é¢çš„ç¨‹åºä¸­ï¼Œæƒ³è®©<code>update</code>è¾“å‡ºiä¿®æ”¹åçš„ç»“æœï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;Join&quot;)
public class JoinDemo &#123;

    static int i = 3;

    public static void main(String[] args) throws InterruptedException &#123;
        update();
    &#125;

    public static void update() throws InterruptedException &#123;
        log.debug(&quot;main thread start&quot;);
        Thread t1 = new Thread(() -&gt; &#123;
            log.debug(&quot;child thread start&quot;);
            try &#123;
                TimeUnit.SECONDS.sleep(1);
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
            log.debug(&quot;child thread end&quot;);
            i *= i;
        &#125;, &quot;t1&quot;);
        t1.start();
        log.debug(&quot;i =&gt; [&#123;&#125;]&quot;, i);
        log.debug(&quot;main thread end&quot;);
    &#125;
&#125;</code></pre>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<pre><code class="java">2021-04-06 16:16:52.692 [main] DEBUG Join - main thread start
2021-04-06 16:16:52.726 [t1] DEBUG Join - child thread start
2021-04-06 16:16:52.726 [main] DEBUG Join - i =&gt; [3]
2021-04-06 16:16:52.727 [main] DEBUG Join - main thread end
2021-04-06 16:16:53.734 [t1] DEBUG Join - child thread end</code></pre>
<p>åœ¨ç¬¬22è¡Œåæ·»åŠ <code>t1.join();</code>æ–¹æ³•åçš„è¾“å‡ºç»“æœï¼š</p>
<pre><code class="java">2021-04-06 16:14:53.431 [main] DEBUG Join - main thread start
2021-04-06 16:14:53.461 [t1] DEBUG Join - child thread start
2021-04-06 16:14:54.474 [t1] DEBUG Join - child thread end
2021-04-06 16:14:54.474 [main] DEBUG Join - i =&gt; [9]
2021-04-06 16:14:54.475 [main] DEBUG Join - main thread end</code></pre>
<h3 id="1-3-9-interrupt"><a href="#1-3-9-interrupt" class="headerlink" title="1.3.9 interrupt"></a>1.3.9 interrupt</h3><blockquote>
<p>API</p>
</blockquote>
<ul>
<li><code>interrupt()</code>ï¼šå£°æ˜æ­¤çº¿ç¨‹ä¸­æ–­ï¼Œä½†æ˜¯çº¿ç¨‹å¹¶ä¸ä¼šç«‹å³ä¸­æ–­</li>
<li><code>isInterrupted</code>ï¼šåˆ¤æ–­æ­¤çº¿ç¨‹æ˜¯å¦å·²ä¸­æ–­ï¼Œåˆ¤æ–­å®Œåä¸ä¿®æ”¹å¿åŸç®¡çš„ä¸­æ–­çŠ¶æ€</li>
<li><code>interrupted()</code>ï¼šåˆ¤æ–­æ­¤çº¿ç¨‹å·²ä¸­æ–­ï¼Œåˆ¤æ–­å®Œåæ¸…é™¤çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€</li>
</ul>
<blockquote>
<p>ç†è§£</p>
</blockquote>
<ul>
<li><code>interrupt()</code>ï¼šçš‡ä¸Šï¼ˆçº¿ç¨‹ï¼‰æ¯æ™šæŒ‘é€‰ä¸€ä¸ªå¦ƒå­ä¾å¯ï¼Œåˆ°äº†æ—¶é—´ï¼Œå¤ªç›‘ä¼šå‘Šè¯‰çš‡ä¸Šï¼Œæ—¶é—´åˆ°äº†ï¼ˆå£°æ˜çº¿ç¨‹ä¸­æ–­ï¼‰ï¼Œçš‡ä¸ŠçŸ¥é“äº†ï¼Œåœä¸åœè¿˜æ˜¯çš‡ä¸Šè¯´äº†ç®—ã€‚</li>
<li><code>isInterrupted()</code>ï¼šå¦‚æœï¼ˆ<code>isInterrupted = true</code>ï¼‰åˆ™å¯ä»¥æ§åˆ¶çš‡ä¸Šï¼ˆçº¿ç¨‹ï¼‰åœæ­¢ï¼Œçš‡ä¸Šåœæ­¢åï¼Œçº¿ç¨‹è¿˜æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œå³<code>interruptes = true</code>ã€‚</li>
<li><code>interrupted()</code>ï¼šå¦‚æœï¼ˆ<code>isInterrupted = true</code>ï¼‰åˆ™å¯ä»¥æ§åˆ¶çš‡ä¸Šï¼ˆçº¿ç¨‹ï¼‰åœæ­¢ï¼Œçš‡ä¸Šåœæ­¢åï¼Œçº¿ç¨‹ä¼šæ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œå³<code>interruptes = false</code>ã€‚</li>
</ul>
<blockquote>
<p>è¯æ˜</p>
</blockquote>
<pre><code class="java">@Slf4j(topic = &quot;InterruptAPI&quot;)
public class InterruptDemo &#123;
    public static void main(String[] args) throws InterruptedException &#123;
        Thread t = new Thread(() -&gt; &#123;
            Thread thread = Thread.currentThread();
            while (!thread.isInterrupted()) &#123;  // (1) isInterrupted
//            while (!Thread.interrupted()) &#123;      // (2) interrupted(static)
                log.debug(&quot;&#123;&#125;&quot;, thread.isInterrupted());
            &#125;
            log.debug(&quot;&#123;&#125;&quot;, thread.isInterrupted());
        &#125;, &quot;t&quot;);
        t.start();
        TimeUnit.MILLISECONDS.sleep(1);
        t.interrupt();
    &#125;
&#125;</code></pre>
<p>æ³¨é‡Šï¼ˆ2ï¼‰ç»“æœï¼š</p>
<pre><code class="java">2021-04-24 14:04:26.851 [t] DEBUG InterruptAPI - false
2021-04-24 14:04:26.853 [t] DEBUG InterruptAPI - true</code></pre>
<p>è¯æ˜<code>isInterrupted()</code>ä¸ä¼šä¿®æ”¹ä¸­æ–­çŠ¶æ€ã€‚</p>
<p>æ³¨é‡Šï¼ˆ1ï¼‰ç»“æœï¼š</p>
<pre><code class="java">2021-04-24 14:04:54.046 [t] DEBUG InterruptAPI - false
2021-04-24 14:04:54.049 [t] DEBUG InterruptAPI - false</code></pre>
<p>è¯æ˜<code>interrupted()</code>ä¼šé‡ç½®ä¸­æ–­çŠ¶æ€ã€‚</p>
<h3 id="1-3-10-ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼"><a href="#1-3-10-ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼" class="headerlink" title="1.3.10 ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼"></a>1.3.10 ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼</h3><blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<pre><code class="mermaid">graph TD
w(&quot;while(true)&quot;) --&gt; a
a(&quot;æœ‰æ²¡æœ‰è¢«æ‰“æ–­&quot;) -- æ˜¯ --&gt; b(æ–™ç†åäº‹)
b --&gt; c((ç»“æŸå¾ªç¯))
a -- å¦ --&gt; d(ç¡çœ 2S)
d -- æ— å¼‚å¸¸ --&gt; e(æ‰§è¡Œç›‘æ§è®°å½•)
d -- æœ‰å¼‚å¸¸ --&gt; i(è®¾ç½®æ‰“æ–­æ ‡è®°)
i --&gt; w
e --&gt; w</code></pre>
<blockquote>
<p>ä»£ç </p>
</blockquote>
<pre><code class="java">@Slf4j(topic = &quot;TwoStageTermination&quot;)
class TwoStageTermination &#123;
     Thread monitor;

    // å¯åŠ¨ç›‘æ§çº¿ç¨‹
    public void start() &#123;
        monitor = new Thread(() -&gt; &#123;
            while (true) &#123;
                Thread current = Thread.currentThread();
                // æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œç›´æ¥è®¾ç½®æ‰“æ–­æ ‡è®°
                if (current.isInterrupted()) &#123;
                    log.debug(&quot;æ–™ç†åäº‹&quot;);
                    break;
                &#125;
                try &#123;
                    TimeUnit.SECONDS.sleep(1);
                    log.info(&quot;æ‰§è¡Œç›‘æ§...&quot;);
                &#125; catch (InterruptedException e) &#123;
                    log.debug(e.getMessage());
                    // æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹è¢«æ‰“æ–­ï¼Œä¼šè¢«æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œéœ€è¦é‡æ–°è®¾ç½®è®¾ç½®æ‰“æ–­æ ‡è®°
                    current.interrupt();
                &#125;
            &#125;
        &#125;);
        monitor.start();
    &#125;

    // åœæ­¢ç›‘æ§çº¿ç¨‹
    public void stop() &#123;
        monitor.interrupt();
    &#125;
&#125;
</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="java">2021-04-24 14:26:23.321 [Thread-0] INFO  TwoStageTermination - æ‰§è¡Œç›‘æ§...
2021-04-24 14:26:24.329 [Thread-0] INFO  TwoStageTermination - æ‰§è¡Œç›‘æ§...
2021-04-24 14:26:25.336 [Thread-0] INFO  TwoStageTermination - æ‰§è¡Œç›‘æ§...
2021-04-24 14:26:25.823 [Thread-0] DEBUG TwoStageTermination - sleep interrupted
2021-04-24 14:26:25.823 [Thread-0] DEBUG TwoStageTermination - æ–™ç†åäº‹</code></pre>
<blockquote>
<p>park</p>
</blockquote>
<p><code>LockSupport</code>çš„<code>park()</code>å¯ç”¨äºæš‚åœå½“å‰çº¿ç¨‹</p>
<pre><code class="java">@Slf4j(topic = &quot;Park&quot;)
public class ParkDemo &#123;

    public static void main(String[] args) throws InterruptedException &#123;
        park();
    &#125;

    public static void park() throws InterruptedException &#123;
        Thread t1 = new Thread(() -&gt; &#123;
            log.debug(&quot;park...&quot;);
            log.debug(&quot;isInterrupted =&gt; [&#123;&#125;]&quot;, Thread.currentThread().isInterrupted());
            LockSupport.park();
            log.debug(&quot;unpark...&quot;);
            log.debug(&quot;isInterrupted =&gt; [&#123;&#125;]&quot;, Thread.currentThread().isInterrupted());
            LockSupport.park();
            Thread.interrupted();
            log.debug(&quot;isInterrupted =&gt; [&#123;&#125;]&quot;, Thread.currentThread().isInterrupted());
            log.debug(&quot;unpark...&quot;);
        &#125;, &quot;t1&quot;);
        t1.start();

        TimeUnit.SECONDS.sleep(1);
        t1.interrupt();
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="java">2021-04-06 20:23:08.234 [t1] DEBUG Park - park...
2021-04-06 20:23:08.237 [t1] DEBUG Park - isInterrupted =&gt; [false]
2021-04-06 20:23:09.234 [t1] DEBUG Park - unpark...
2021-04-06 20:23:09.234 [t1] DEBUG Park - isInterrupted =&gt; [true]
2021-04-06 20:23:09.234 [t1] DEBUG Park - isInterrupted =&gt; [false]
2021-04-06 20:23:09.234 [t1] DEBUG Park - unpark...</code></pre>
<blockquote>
<p>æ‰“æ–­çº¿ç¨‹çš„é”™è¯¯æ€è·¯</p>
</blockquote>
<ul>
<li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„<code>stop()</code>æ–¹æ³•åœæ­¢çº¿ç¨‹ï¼š<code>stop()</code>æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•é‡Šæ”¾é”ã€‚</li>
<li>ä½¿ç”¨<code>System.exit(int)</code>æ–¹æ³•ç»ˆæ­¢çº¿ç¨‹ï¼šç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢ã€‚</li>
</ul>
<p>ä»¥ä¸‹æ–¹æ³•ä¸æ¨èä½¿ç”¨ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td><code>stop()</code></td>
<td>åœæ­¢çº¿ç¨‹è¿è¡Œ</td>
</tr>
<tr>
<td><code>suspend()</code></td>
<td>æŒ‚èµ·çº¿ç¨‹è¿è¡Œ</td>
</tr>
<tr>
<td><code>resume()</code></td>
<td>æ¢å¤çº¿ç¨‹è¿è¡Œ</td>
</tr>
</tbody></table>
<h3 id="1-3-11-ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹"><a href="#1-3-11-ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹" class="headerlink" title="1.3.11 ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹"></a>1.3.11 ä¸»çº¿ç¨‹ä¸å®ˆæŠ¤çº¿ç¨‹</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒJavaè¿›ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸï¼Œæ‰ä¼šç»“æŸã€‚æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶ä»–éå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚</p>
<blockquote>
<p>å®ˆæŠ¤çº¿ç¨‹ç¤ºä¾‹</p>
</blockquote>
<pre><code class="java">@Test
public void test1() throws InterruptedException&#123;
    Thread t1 = new Thread(() -&gt; &#123;
        while (true) &#123;
            if (Thread.currentThread().isInterrupted()) &#123;
                break;
            &#125;
        &#125;
        log.debug(&quot;&#123;&#125; end&quot;, Thread.currentThread().getName());
    &#125;, &quot;t1&quot;);
    t1.start();
    TimeUnit.SECONDS.sleep(1);
    log.debug(&quot;&#123;&#125; end&quot;, Thread.currentThread().getName());
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="java">2021-04-07 10:37:04.886 [main] DEBUG Daemon - main end</code></pre>
<p>è™½ç„¶mainçº¿ç¨‹ç»ˆæ­¢ï¼Œä½†æ˜¯t1çº¿ç¨‹å¹¶æœªç»ˆæ­¢ã€‚</p>
<p>ä½†æ˜¯<code>t1.setDaemon(true);</code>ä¹‹åï¼Œmainçº¿ç¨‹ç»ˆæ­¢ï¼Œt1çº¿ç¨‹ç«‹é©¬ç»ˆæ­¢ã€‚</p>
<h3 id="1-3-12-äº”ç§çŠ¶æ€"><a href="#1-3-12-äº”ç§çŠ¶æ€" class="headerlink" title="1.3.12 äº”ç§çŠ¶æ€"></a>1.3.12 äº”ç§çŠ¶æ€</h3><blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/9175/image-20210407110528028.png" class="" title="image-20210407110528028">

<ul>
<li>ã€åˆå§‹çŠ¶æ€ã€‘ï¼šä»…æ˜¯åœ¨è¯­è¨€å±‚é¢åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æœªä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹å…³è”</li>
<li>ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ï¼šè¯¥çº¿ç¨‹å·²ç»è¢«åˆ›å»ºï¼Œä¸æ“ä½œç³»ç»Ÿå…³è”ï¼Œå¤„äºå°±ç»ªçŠ¶æ€ï¼Œå¯ä»¥ç”±CPUè°ƒåº¦æ‰§è¡Œ</li>
<li>ã€è¿è¡ŒçŠ¶æ€ã€‘ï¼šè·å–äº†CPUæ—¶é—´ç‰‡è¿è¡Œä¸­çš„çŠ¶æ€<ul>
<li>å½“CPUæ—¶é—´ç‰‡ç”¨å®Œï¼Œä¼šä»è¿è¡ŒçŠ¶æ€è½¬æ¢æˆå¯è¿è¡ŒçŠ¶æ€ï¼Œä¼šå¯¼è‡´çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
</ul>
</li>
<li>ã€é˜»å¡çŠ¶æ€ã€‘ï¼š<ul>
<li>å¦‚æœè°ƒç”¨äº†é˜»å¡APIï¼Œå¦‚BIOè¯»å†™æ–‡ä»¶ï¼Œè¿™æ—¶è¯¥çº¿ç¨‹å®é™…ä¸ä¼šç”¨åˆ°CPUï¼Œä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€</li>
<li>ç­‰BIOæ“ä½œå®Œæ¯•ï¼Œä¼šç”±æ“ä½œç³»ç»Ÿå”¤é†’é˜»å¡çš„çº¿ç¨‹ï¼Œè½¬æ¢è‡³ã€å¯è¿è¡ŒçŠ¶æ€ã€‘</li>
</ul>
</li>
<li>ã€ç»ˆæ­¢çŠ¶æ€ã€‘ï¼šè¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œä¸ä¼šå†è½¬æ¢ä¸ºå…¶ä»–çŠ¶æ€ã€‚</li>
</ul>
<h3 id="1-3-13-å…­ç§çŠ¶æ€"><a href="#1-3-13-å…­ç§çŠ¶æ€" class="headerlink" title="1.3.13 å…­ç§çŠ¶æ€"></a>1.3.13 å…­ç§çŠ¶æ€</h3><p>ä»Java APIå±‚é¢æè¿°ï¼Œæ ¹æ®<code>Thread.State</code>æšä¸¾ï¼Œåˆ†ä¸ºå…­ç§çŠ¶æ€ï¼š</p>
<pre><code>NEW            æ–°å»ºçŠ¶æ€
RUNNABLE       è¿è¡ŒçŠ¶æ€ï¼ˆå°±ç»ªçŠ¶æ€ã€è¿è¡Œä¸­çŠ¶æ€ï¼‰
BLOCKED        é˜»å¡çŠ¶æ€
WAITING        ç­‰å¾…çŠ¶æ€
TIMED_WAITING  è®¡æ—¶ç­‰å¾…çŠ¶æ€
TERMINATED     ç»ˆæ­¢çŠ¶æ€</code></pre>
<ul>
<li>NEWçº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è°ƒç”¨<code>start()</code>æ–¹æ³•</li>
<li>RUNNABLEå½“è°ƒç”¨äº†<code>start()</code>æ–¹æ³•ä¹‹åï¼Œæ³¨æ„ï¼ŒJava APIå±‚é¢çš„RUNNABLEçŠ¶æ€æ¶µç›–äº†æ“ä½œç³»ç»Ÿå±‚é¢çš„ã€å¯è¿è¡ŒçŠ¶æ€ã€‘ã€ã€è¿è¡ŒçŠ¶æ€ã€‘å’Œã€é˜»å¡çŠ¶æ€ã€‘ï¼ˆç”±äºBIOå¯¼è‡´çš„çº¿ç¨‹é˜»å¡ï¼Œåœ¨Javaé‡Œæ— æ³•åŒºåˆ†ï¼Œä»ç„¶è®¤ä¸ºæ˜¯å¯è¿è¡Œï¼‰ã€‚</li>
<li>BLOCKEDã€WAITINGã€TIMED_WAITINGéƒ½æ˜¯Java APIå±‚é¢å¯¹ã€é˜»å¡çŠ¶æ€ã€‘çš„ç»†åˆ†ã€‚â€˜</li>
<li>TERMINATEDå½“çº¿ç¨‹ä»£ç è¿è¡Œç»“æŸã€‚</li>
</ul>
<blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/9175/image-20210407114128028.png" class="" title="image-20210407114128028">



<blockquote>
<p>ç¤ºä¾‹</p>
</blockquote>
<pre><code class="java">@Slf4j(topic = &quot;State&quot;)
public class StateDemo &#123;

    public static void main(String[] args) &#123;
        Thread t1 = new Thread(() -&gt; log.debug(&quot;&#123;&#125; running...&quot;, Thread.currentThread().getName()), &quot;t1&quot;);
        Thread t2 = new Thread(() -&gt; &#123; while (true) &#123;&#125; &#125;, &quot;t2&quot;);
        Thread t3 = new Thread(() -&gt; log.debug(&quot;&#123;&#125; running...&quot;, Thread.currentThread().getName()), &quot;t3&quot;);
        Thread t4 = new Thread(() -&gt; &#123;
            synchronized (StateDemo.class) &#123;
                try &#123;
                    TimeUnit.SECONDS.sleep(100);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125;, &quot;t4&quot;);
        Thread t5 = new Thread(() -&gt; &#123;
            try &#123;
                t2.join();
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;, &quot;t5&quot;);
        Thread t6 = new Thread(() -&gt; &#123;
            synchronized (StateDemo.class) &#123;
                try &#123;
                    TimeUnit.SECONDS.sleep(100);
                &#125; catch (InterruptedException e) &#123;
                    e.printStackTrace();
                &#125;
            &#125;
        &#125;, &quot;t4&quot;);
        t2.start();
        t3.start();
        t4.start();
        t5.start();
        t6.start();
        try &#123;
            TimeUnit.MILLISECONDS.sleep(500);
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
        log.debug(&quot;t1 =&gt; [&#123;&#125;]&quot;, t1.getState());   // TERMINATED
        log.debug(&quot;t2 =&gt; [&#123;&#125;]&quot;, t2.getState());   // RUNNABLE
        log.debug(&quot;t3 =&gt; [&#123;&#125;]&quot;, t3.getState());   // TERMINATED
        log.debug(&quot;t4 =&gt; [&#123;&#125;]&quot;, t4.getState());   // TIMED_WAITING
        log.debug(&quot;t5 =&gt; [&#123;&#125;]&quot;, t5.getState());   // WAITING
        log.debug(&quot;t6 =&gt; [&#123;&#125;]&quot;, t6.getState());   // BLOCKED
    &#125;
&#125;</code></pre>
<p> 1.3.14 ä¹ é¢˜</p>
<blockquote>
<p>åº”ç”¨ä¹‹ç»Ÿç­¹ï¼ˆçƒ§æ°´æ³¡èŒ¶ï¼‰</p>
</blockquote>
<pre><code>ç»Ÿç­¹æ–¹æ³•ï¼Œæ˜¯ä¸€ç§å®‰æ’å·¥ä½œè¿›ç¨‹çš„æ•°å­¦æ–¹æ³•ã€‚å®ƒçš„å®ç”¨èŒƒå›´æå¹¿æ³›ï¼Œåœ¨ä¼ä¸šç®¡ç†å’ŒåŸºæœ¬å»ºè®¾ä¸­ï¼Œä»¥åŠå…³ç³»å¤æ‚çš„ç§‘ç ”é¡¹ç›®çš„ç»„ç»‡ä¸ç®¡ç†ä¸­ï¼Œéƒ½å¯ä»¥åº”ç”¨ã€‚
æ€æ ·åº”ç”¨å‘¢ï¼Ÿä¸»è¦æ˜¯æŠŠå·¥åºå®‰æ’å¥½ã€‚
æ¯”å¦‚ï¼Œæƒ³æ³¡å£¶èŒ¶å–ã€‚å½“æ—¶çš„æƒ…å†µæ˜¯ï¼šå¼€æ°´æ²¡æœ‰ï¼›æ°´å£¶è¦æ´—ï¼ŒèŒ¶å£¶ã€èŒ¶æ¯è¦æ´—ï¼›ç«å·²ç”Ÿäº†ï¼ŒèŒ¶å¶ä¹Ÿæœ‰äº†ã€‚æ€ä¹ˆåŠï¼Ÿ

- åŠæ³•ç”²ï¼šæ´—å¥½æ°´å£¶ï¼ŒçŒä¸Šå‡‰æ°´ï¼Œæ”¾åœ¨ç«ä¸Šï¼›åœ¨ç­‰å¾…æ°´å¼€çš„æ—¶é—´é‡Œï¼Œæ´—èŒ¶å£¶ã€æ´—èŒ¶æ¯ã€æ‹¿èŒ¶å¶ï¼›ç­‰æ°´å¼€äº†ï¼Œæ³¡èŒ¶å–ã€‚
- åŠæ³•ä¹™ï¼šå…ˆåšå¥½ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ´—æ°´å£¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ï¼Œæ‹¿èŒ¶å¶ï¼›ä¸€åˆ‡å°±ç»ªï¼ŒçŒæ°´çƒ§æ°´ï¼›åå¾…æ°´å¼€äº†ï¼Œæ³¡èŒ¶å–ã€‚
- åŠæ³•ä¸™ï¼šæ´—å‡€æ°´å£¶ï¼ŒçŒä¸Šå‡‰æ°´ï¼Œæ”¾åœ¨ç«ä¸Šï¼Œåå¾…æ°´å¼€ï¼›æ°´å¼€äº†ä¹‹åï¼Œæ€¥æ€¥å¿™å¿™æ‰¾èŒ¶å¶ï¼Œæ´—èŒ¶å£¶èŒ¶æ¯ï¼Œæ³¡èŒ¶å–ã€‚

å“ªä¸€ç§æ–¹æ³•çœæ—¶é—´ï¼Ÿæˆ‘ä»¬èƒ½ä¸€çœ¼çœ‹å‡ºï¼Œç¬¬ä¸€ç§åŠæ³•å¥½ï¼Œåä¸¤ç§åŠæ³•éƒ½çªäº†å·¥ã€‚
â€”â€”åç½—åºšã€Šç»Ÿç­¹æ–¹æ³•ã€‹</code></pre>
<pre><code class="mermaid">graph LR
a(æ´—æ°´å£¶) --&gt; b(çƒ§å¼€æ°´)
c(æ´—èŒ¶å£¶,æ´—èŒ¶æ¯,æ‹¿èŒ¶å¶)
b --&gt; d(æ³¡èŒ¶)
c --&gt; d(æ³¡èŒ¶)</code></pre>
<p>ä»£ç ï¼š</p>
<pre><code class="java">@Slf4j(topic = &quot;BoilWaterToMakeTea&quot;)
public class PlanDemo &#123;

    public static void main(String[] args) &#123;
        Thread t1 = new Thread(() -&gt; &#123;
            log.debug(&quot;æ´—æ°´å£¶&quot;);
            sleep(60);      // æ´—æ°´å£¶ 1åˆ†é’Ÿ
            log.debug(&quot;çƒ§å¼€æ°´&quot;);
            sleep(60 * 5);  // çƒ§å¼€æ°´ 5åˆ†é’Ÿ
        &#125;, &quot;t1&quot;);
        Thread t2 = new Thread(() -&gt; &#123;
            log.debug(&quot;æ´—èŒ¶å£¶&quot;);
            sleep(60);      // æ´—æ°´å£¶ 1åˆ†é’Ÿ
            log.debug(&quot;æ´—èŒ¶æ¯&quot;);
            sleep(60 * 2);  // æ´—èŒ¶æ¯ 2åˆ†é’Ÿ
            log.debug(&quot;æ‹¿èŒ¶å¶&quot;);
            sleep(60 );     // çƒ§å¼€æ°´ 1åˆ†é’Ÿ
            try &#123;
                t1.join();               // ç­‰å¾…t1çƒ§æ°´
            &#125; catch (InterruptedException e) &#123;
                e.printStackTrace();
            &#125;
            log.debug(&quot;æ³¡èŒ¶&quot;);
        &#125;, &quot;t2&quot;);
        t1.start();
        t2.start();
    &#125;

    public static void sleep(int nanoSeconds) &#123;
        try &#123;
            TimeUnit.NANOSECONDS.sleep(nanoSeconds);
        &#125; catch (InterruptedException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code>2021-04-07 14:12:12.989 [t1] DEBUG top.parak.demo.BoilWaterToMakeTea - æ´—æ°´å£¶
2021-04-07 14:12:12.989 [t2] DEBUG top.parak.demo.BoilWaterToMakeTea - æ´—èŒ¶å£¶
2021-04-07 14:12:12.994 [t1] DEBUG top.parak.demo.BoilWaterToMakeTea - çƒ§å¼€æ°´
2021-04-07 14:12:12.994 [t2] DEBUG top.parak.demo.BoilWaterToMakeTea - æ´—èŒ¶æ¯
2021-04-07 14:12:12.996 [t2] DEBUG top.parak.demo.BoilWaterToMakeTea - æ‹¿èŒ¶å¶
2021-04-07 14:12:12.998 [t2] DEBUG top.parak.demo.BoilWaterToMakeTea - æ³¡èŒ¶</code></pre>
<blockquote>
<p>å°ç»“</p>
</blockquote>
<ul>
<li>sleepä¸é‡Šæ”¾é”ï¼Œé‡Šæ”¾CPU</li>
<li>joiné‡Šæ”¾é”ï¼ŒæŠ¢å CPU</li>
<li>yieldä¸é‡Šæ”¾é”ï¼Œé‡Šæ”¾CPU</li>
<li>waité‡Šæ”¾é”ï¼Œé‡Šæ”¾CPU</li>
</ul>
]]></content>
      <categories>
        <category>JUC</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java-Serilizable</title>
    <url>/posts/29446/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><a name="YYYCK"></a></p>
<h2 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><p>åºåˆ—åŒ–ï¼šå°†Javaå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—ï¼Œä»¥ä¾¿æŒä¹…åŒ–åˆ°ç£ç›˜æˆ–è€…ç½‘ç»œä¼ è¾“ã€‚</p>
<p>ååºåˆ—åŒ–ï¼šå°†ç£ç›˜æ–‡ä»¶æˆ–è€…ç½‘ç»œæ–‡ä»¶ä¸­çš„å­—èŠ‚åºåˆ—æ¢å¤ä¸ºåŸå…ˆçš„Javaå¯¹è±¡ã€‚</p>
<p>Javaå¯¹è±¡çš„åºåˆ—åŒ–çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>å®ç°<code>Serilizable</code>æ¥å£ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚</li>
<li>å®ç°<code>Exteranlizable</code>æ¥å£ï¼Œéœ€è¦é‡å†™<code>writeExternal</code>å’Œ<code>readExterna</code>æ–¹æ³•ã€‚</li>
</ul>
<p>å®šä¹‰Userï¼š</p>
<pre><code class="java">public class User implements Serializable &#123;
    private Integer id;
    private String username;
    private Date birth;

    // AllArgsConstructor
    // ToString
&#125;</code></pre>
<p>åºåˆ—åŒ–ï¼š</p>
<pre><code class="java">public static void serialize(Object obj) throws IOException &#123;
    ObjectOutputStream output = new ObjectOutputStream(new FileOutputStream(
        new File(System.getProperty(&quot;user.dir&quot;) + &quot;/src/main/resources/public/&quot; + &quot;user.txt&quot;)));
    output.writeObject(obj);
    output.close();
&#125;</code></pre>
<p>ååºåˆ—åŒ–ï¼š</p>
<pre><code class="java">public static User deserialize() throws IOException, ClassNotFoundException &#123;
    ObjectInputStream input = new ObjectInputStream(new FileInputStream(
        new File(System.getProperty(&quot;user.dir&quot;) + &quot;/src/main/resources/public/&quot; + &quot;user.txt&quot;)));
    return (User) input.readObject();
&#125;</code></pre>
<p>æµ‹è¯•ï¼š</p>
<pre><code class="java">public static void main(String[] args) throws Exception &#123;
    User user = new User(1, &quot;Khighness&quot;, new Date());
    serialize(user);
    User des = deserialize();
    System.out.println(des);
&#125;</code></pre>
<p>æ§åˆ¶å°è¾“å‡ºï¼š</p>
<pre><code class="powershell">User[id=1, username=&#39;Khighness&#39;, birth=Thu Apr 22 12:12:48 CST 2021]</code></pre>
<p><a name="P1aos"></a><br></p>
<h2 id="Serializable"><a href="#Serializable" class="headerlink" title="Serializable"></a>Serializable</h2><p>çœ‹ä¸€ä¸‹æºä»£ç ï¼š</p>
<pre><code class="java">public interface Serializable &#123;
&#125;</code></pre>
<p>å‘ç°åªæ˜¯ä¸ªç©ºæ¥å£ï¼Œå› æ­¤è¿™åªæ˜¯ä¸ªæ ‡ç¤ºæ€§æ¥å£ã€‚<br />é‚£æˆ‘ä»¬ç‚¹è¿›åˆšæ‰ä½¿ç”¨çš„<code>writeObject</code>æ–¹æ³•ï¼š</p>
<pre><code class="java">public final void writeObject(Object obj) throws IOException &#123;
    if (enableOverride) &#123;           // è¡¨ç¤ºæ˜¯å¦å¯è¦†å†™ï¼Œé»˜è®¤false
        writeObjectOverride(obj);
        return;
    &#125;
    try &#123;
        writeObject0(obj, false); // ä¸»è¦æ‰§è¡Œçš„æ–¹æ³•
    &#125; catch (IOException ex) &#123;
        if (depth == 0) &#123;
            writeFatalException(ex);
        &#125;
        throw ex;
    &#125;
&#125;</code></pre>
<p>å¯ä»¥çœ‹åˆ°å®ƒè°ƒç”¨çš„æ˜¯<code>writeObject0</code>æ–¹æ³•ï¼Œå†è¿›å…¥è¿™ä¸ªæ–¹æ³•ï¼š</p>
<pre><code class="java">// remaining cases åˆ¤æ–­å¯¹è±¡
if (obj instanceof String) &#123;              // æ˜¯å¦ä¸ºå­—ç¬¦ä¸²
    writeString((String) obj, unshared);
&#125; else if (cl.isArray()) &#123;                // æ˜¯å¦ä¸ºæ•°ç»„
    writeArray(obj, desc, unshared);
&#125; else if (obj instanceof Enum) &#123;         // æ˜¯å¦ä¸ºæšä¸¾ç±»
    writeEnum((Enum&lt;?&gt;) obj, desc, unshared);
&#125; else if (obj instanceof Serializable) &#123; // æ˜¯å¦å®ç°äº†Serializableæ¥å£
    writeOrdinaryObject(obj, desc, unshared);
&#125; else &#123;                                  // å››éåˆ™æŠ›å‡ºå¼‚å¸¸
    if (extendedDebugInfo) &#123;
        throw new NotSerializableException(
            cl.getName() + &quot;\n&quot; + debugInfoStack.toString());
    &#125; else &#123;
        throw new NotSerializableException(cl.getName());
    &#125;
&#125;</code></pre>
<p><a name="fYvZd"></a><br></p>
<h2 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h2><p>ç»§ç»­æµ‹è¯•ï¼Œç»™Userç±»æ·»åŠ å­—æ®µï¼š</p>
<pre><code class="java">private String email;</code></pre>
<p>å°†æµ‹è¯•ä»£ç æ”¹ä¸ºï¼š</p>
<pre><code class="java">public static void main(String[] args) throws Exception &#123;
    User des = deserialize();
    System.out.println(des);
&#125;</code></pre>
<p>è¿è¡Œç»“æœï¼š</p>
<pre><code class="powershell">Exception in thread &quot;main&quot; java.io.InvalidClassException: top.parak.entity.User; local class incompatible: stream classdesc serialVersionUID = -5676367428859465228, local class serialVersionUID = -1182591043963610802</code></pre>
<p>å‘ç°æŠ¥é”™ï¼Œå¹¶ä¸”æŠ›å‡º<code>InvalidClassException</code>å¼‚å¸¸ï¼Œæç¤ºä¿¡æ¯ï¼šæœ¬åœ°ç±»ä¸å…¼å®¹ï¼Œåºåˆ—åŒ–å‰åçš„<code>serialVersionUID</code>ä¸åŒã€‚<br />å› æ­¤ï¼Œæœ‰ä¸¤ä¸ªé‡è¦ç»“è®ºï¼š</p>
<ul>
<li><code>serialVersionUID</code>æ˜¯åºåˆ—åŒ–å‰åçš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚</li>
<li>é»˜è®¤å¦‚æœæ²¡æœ‰æ˜¾ç¤ºå®šä¹‰<code>serialVersionUID</code>ï¼Œåˆ™ç¼–è¯‘å™¨ä¼šä¸ºå®ƒè‡ªåŠ¨å£°æ˜ä¸€ä¸ªã€‚</li>
</ul>
<p>æ‰©å±•ï¼š</p>
<ul>
<li><code>serialVersionUID</code>åºåˆ—åŒ–IDï¼Œå¯ä»¥çœ‹æˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ä¸­çš„æš—å·ï¼ˆè¿ä¸Šå½¼æ­¤çš„è®¯å·æ‰æœ‰ä¸ªä¾é ï¼‰ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ï¼ŒJVMä¼šæŠŠå­—èŠ‚æµä¸­çš„åºåˆ—åŒ–IDå’Œè¢«åºåˆ—å·ç±»ä¸­çš„åºåˆ—åŒ–IDåšå¯¹æ¯”ï¼Œåªæœ‰ä¸¤è€…ä¸€è‡´ï¼Œæ‰èƒ½é‡æ–°ååºåˆ—åŒ–ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚</li>
<li>å¦‚æœåœ¨å®šä¹‰ä¸€ä¸ªå¯åºåˆ—åŒ–çš„ç±»æ—¶ï¼Œæ²¡æœ‰äººä¸ºæ˜¾ç¤ºåœ°ç»™å®ƒå®šä¹‰ä¸€ä¸ª<code>serialVersionUID</code>çš„è¯ï¼Œåˆ™Javaè¿è¡Œæ—¶ç¯å¢ƒä¼šæ ¹æ®è¯¥ç±»çš„å„æ–¹é¢ä¿¡æ¯è‡ªåŠ¨åœ°ä¸ºå®ƒç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„<code>serialVersionUID</code>ï¼Œä¸€æ—¦æ›´æ”¹äº†ç±»çš„ç»“æ„æˆ–è€…ä¿¡æ¯ï¼Œåˆ™ç±»çš„<code>serialVersionUID</code>ä¹Ÿä¼šè·Ÿç€å˜åŒ–ã€‚</li>
</ul>
<p><a name="B8uH5"></a><br></p>
<h2 id="static-amp-transient"><a href="#static-amp-transient" class="headerlink" title="static&amp;transient"></a>static&amp;transient</h2><p>ç»§ç»­æµ‹è¯•ï¼Œå°†<code>User</code>ç±»çš„<code>email</code>å­—æ®µæ·»åŠ ä¿®é¥°ç¬¦<code>static</code>æˆ–è€…<code>transient</code>ï¼Œå‘ç°æµ‹è¯•æˆåŠŸã€‚<br />äºæ˜¯å¯ä»¥å¾—å‡ºç»“è®ºï¼Œå¯¹äº<code>Serilizable</code>æ¥å£ï¼š</p>
<ol>
<li>å‡¡æ˜¯è¢«<code>static</code>ä¿®é¥°çš„å­—æ®µæ˜¯ä¸ä¼šè¢«åºåˆ—åŒ–çš„</li>
<li>å‡¡æ˜¯è¢«<code>transient</code>ä¿®é¥°çš„å­—æ®µæ˜¯ä¸ä¼šè¢«åºåˆ—åŒ–çš„</li>
</ol>
<blockquote>
<p>transient</p>
</blockquote>
<p><code>transient</code>å…³é”®å­—çš„ä½œç”¨å°±æ˜¯æŠŠè¢«ä¿®é¥°çš„å­—æ®µçš„ç”Ÿå‘½å‘¨æœŸä»…å­˜äºè°ƒç”¨è€…çš„å†…å­˜è€Œä¸ä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚<br /></p>
<blockquote>
<p>æ³¨æ„</p>
</blockquote>
<p>å®ç°<code>Exteranlizable</code>æ¥å£æ—¶ï¼Œ<code>transient</code>æ˜¯æ— æ•ˆçš„ã€‚<br /></p>
<p><a name="PzCRj"></a><br></p>
<h2 id="å•ä¾‹æ¨¡å¼å¢å¼º"><a href="#å•ä¾‹æ¨¡å¼å¢å¼º" class="headerlink" title="å•ä¾‹æ¨¡å¼å¢å¼º"></a>å•ä¾‹æ¨¡å¼å¢å¼º</h2><p>é™æ€å†…éƒ¨ç±»çš„å•ä¾‹æ¨¡å¼ï¼š</p>
<pre><code class="java">public class Singleton implements Serializable &#123;
    private static final long serialVersionUID = 3992737853791586260L;

    private Singleton() &#123; &#125;

    private static class SingletonHolder &#123;
        private static final Singleton singleton = new Singleton();
    &#125;

    public static synchronized Singleton getInstance() &#123;
        return SingletonHolder.singleton;
    &#125;
&#125;</code></pre>
<p>ç„¶åå†™ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼š</p>
<pre><code class="java">public static void main(String[] args) throws IOException, ClassNotFoundException &#123;
    // åºåˆ—åŒ–
    Singleton instance = Singleton.getInstance();
    ObjectOutputStream output = new ObjectOutputStream(new FileOutputStream(
        new File(System.getProperty(&quot;user.dir&quot;) + &quot;/src/main/resources/public/&quot; + &quot;singleton.txt&quot;)));
    output.writeObject(instance);
    output.close();
    // ååºåˆ—åŒ–
    ObjectInputStream input = new ObjectInputStream(new FileInputStream(
        new File(System.getProperty(&quot;user.dir&quot;) + &quot;/src/main/resources/public/&quot; + &quot;singleton.txt&quot;)));
    Singleton singleton = (Singleton) input.readObject();
    // è¾“å‡ºç»“æœ
    System.out.println(instance == singleton);
&#125;</code></pre>
<p>è¿è¡Œä¹‹åï¼Œå‘ç°æ§åˆ¶å°æ‰“å°çš„æ˜¯<code>false</code>ã€‚<br />è§£å†³æ–¹æ³•ï¼šåœ¨å•ä¾‹ä¸­æ‰‹å†™<code>readResolve</code>å‡½æ•°ï¼Œç›´æ¥è¿”å›å•ä¾‹å¯¹è±¡ï¼Œæ¥è§„é¿ä¹‹ã€‚</p>
<pre><code class="java">public Object readResolve() &#123;
    return SingletonHolder.singleton;
&#125;</code></pre>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Golang-MySQL</title>
    <url>/posts/52018/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å®‰è£…é©±åŠ¨"><a href="#å®‰è£…é©±åŠ¨" class="headerlink" title="å®‰è£…é©±åŠ¨"></a>å®‰è£…é©±åŠ¨</h2><p>æ–¹å¼ä¸€ï¼šè®¾ç½®ä»£ç†å¹¶å®‰è£…é©±åŠ¨</p>
<pre><code class="powershell">$ go env -w GOPROXY=https://goproxy.cn
$ go get github.com/go-sql-driver/mysql
$ go get github.com/jmoiron/sqlx</code></pre>
<p>æ–¹å¼äºŒï¼šä½¿ç”¨modåˆ›å»ºé¡¹ç›®</p>
<pre><code class="powershell"># åˆå§‹åŒ–
$ go mod init go-mysql
# åœ¨go.modä¸­æ·»åŠ 
require github.com/go-sql-driver/mysql v1.6.0
# ä¸‹è½½ä¾èµ–
$ go mod download</code></pre>
<h2 id="æ•°æ®å‡†å¤‡"><a href="#æ•°æ®å‡†å¤‡" class="headerlink" title="æ•°æ®å‡†å¤‡"></a>æ•°æ®å‡†å¤‡</h2><blockquote>
<p>å»ºè¡¨è¯­å¥</p>
</blockquote>
<pre><code class="powershell">CREATE TABLE `user` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(25) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `age` tinyint unsigned NOT NULL DEFAULT &#39;0&#39;,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=utf8;</code></pre>
<blockquote>
<p>åˆå§‹æ•°æ®</p>
</blockquote>
<pre><code class="sql">INSERT INTO `demo`.`user`(`id`, `name`, `age`) VALUES (1, &#39;Khighness&#39;, 19);
INSERT INTO `demo`.`user`(`id`, `name`, `age`) VALUES (2, &#39;RabbishK&#39;, 18);
INSERT INTO `demo`.`user`(`id`, `name`, `age`) VALUES (3, &#39;UnknownK&#39;, 17);</code></pre>
<h2 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h2><pre><code>go-mysql
â”œâ”€â”€ .idea
â”œâ”€â”€ db
â”‚   â”œâ”€â”€ delete.go
â”‚   â”œâ”€â”€ insert.go
â”‚   â”œâ”€â”€ mysql.go
â”‚   â”œâ”€â”€ select.go
â”‚   â”œâ”€â”€ transaction.go
â”‚   â”œâ”€â”€ update.go
â”‚   â””â”€â”€ user.go
â”œâ”€â”€ db_test.go
â”œâ”€â”€ go.mod
â””â”€â”€ go.sum</code></pre>
<h2 id="MySQLè¿æ¥æ± "><a href="#MySQLè¿æ¥æ± " class="headerlink" title="MySQLè¿æ¥æ± "></a>MySQLè¿æ¥æ± </h2><pre><code class="go">package db

import (
    &quot;database/sql&quot;
    &quot;fmt&quot;
    _ &quot;github.com/go-sql-driver/mysql&quot;
    &quot;log&quot;
    &quot;time&quot;
)

/**
 * @author KHighness
 * @since 2021-04-20
 */

var MysqlDB *sql.DB
var MysqlDBERR error

const (
    USERNAME = &quot;root&quot;
    PASSWORD = &quot;KAG1823&quot;
    HOST     = &quot;8.133.183.149&quot;
    PORT     = &quot;3306&quot;
    DATABASE = &quot;demo&quot;
    CHARSET  = &quot;utf8&quot;
)

// åˆå§‹åŒ–é“¾æ¥
func init() &#123;
    dbDSN := fmt.Sprintf(&quot;%s:%s@tcp(%s:%s)/%s?charset=%s&quot;, USERNAME, PASSWORD, HOST, PORT, DATABASE, CHARSET)

    // æ‰“å¼€è¿æ¥å¤±è´¥
    MysqlDB, MysqlDBERR = sql.Open(&quot;mysql&quot;, dbDSN)
    if MysqlDBERR != nil &#123;
        log.Println(&quot;dbDSN: &quot; + dbDSN)
        panic(&quot;æ•°æ®æºé…ç½®é”™è¯¯: &quot; + MysqlDBERR.Error())
    &#125;

    // æœ€å¤§è¿æ¥æ•°
    MysqlDB.SetMaxOpenConns(100)
    // é—²ç½®è¿æ¥æ•°
    MysqlDB.SetMaxIdleConns(20)
    // æœ€å¤§è¿æ¥å‘¨æœŸ
    MysqlDB.SetConnMaxLifetime(100 * time.Second)

    if MysqlDBERR = MysqlDB.Ping(); nil != MysqlDBERR &#123;
        panic(&quot;æ•°æ®åº“è¿æ¥å¤±è´¥: &quot; + MysqlDBERR.Error())
    &#125;

&#125;</code></pre>
<h2 id="ç”¨æˆ·ç»“æ„ä½“"><a href="#ç”¨æˆ·ç»“æ„ä½“" class="headerlink" title="ç”¨æˆ·ç»“æ„ä½“"></a>ç”¨æˆ·ç»“æ„ä½“</h2><pre><code class="go">package db

/**
 * @author KHighness
 * @since 2021-04-20
 */

// ç”¨æˆ·ç»“æ„ä½“
type User struct &#123;
    Id int64 `db:&quot;id&quot;`
    Name string `db:&quot;name&quot;`
    Age int `db:&quot;age&quot;`
&#125;</code></pre>
<h2 id="INSERTæ“ä½œ"><a href="#INSERTæ“ä½œ" class="headerlink" title="INSERTæ“ä½œ"></a>INSERTæ“ä½œ</h2><pre><code class="go">package db

import &quot;log&quot;

/**
 * @author KHighness
 * @since 2021-04-20
 */

// ä¿å­˜ç”¨æˆ·
func SaveUser(user User)  &#123;
    res, _ := MysqlDB.Exec(&quot;INSERT INTO user(name, age) VALUES (?, ?)&quot;, user.Name, user.Age)
    lastInsertId, _ := res.LastInsertId()
    rowsAffected, _ := res.RowsAffected()
    log.Printf(&quot;æ’å…¥ID =&gt; [%d], å½±å“è¡Œæ•° =&gt; [%d]&quot;, lastInsertId, rowsAffected)
&#125;</code></pre>
<h2 id="SELECTæ“ä½œ"><a href="#SELECTæ“ä½œ" class="headerlink" title="SELECTæ“ä½œ"></a>SELECTæ“ä½œ</h2><pre><code class="go">package db

import (
    &quot;log&quot;
)

/**
 * @author KHighness
 * @since 2021-04-20
 */

// æ ¹æ®IDæŸ¥è¯¢
func QueryById(id int)  &#123;
    user := new(User)
    row := MysqlDB.QueryRow(&quot;SELECT * FROM user WHERE id = ?&quot;, id)
    if err :=row.Scan(&amp;user.Id,&amp;user.Name,&amp;user.Age); err != nil&#123;
        log.Printf(&quot;scan failed, err:%v&quot;,err)
        return
    &#125;
    log.Printf(&quot;query result =&gt; [%s]\n&quot;, user)
&#125;

// æŸ¥è¯¢æ‰€æœ‰
func QueryList() &#123;
    users := make([]User, 0)
    rows, _ := MysqlDB.Query(&quot;SELECT * FROM user&quot;)
    // éå†
    var user User
    for rows.Next() &#123;
        _ = rows.Scan(&amp;user.Id, &amp;user.Name, &amp;user.Age)
        users = append(users, user)
    &#125;
    log.Printf(&quot;query result =&gt; [%s]\n&quot;, users)
&#125;</code></pre>
<h2 id="UPDATEæ“ä½œ"><a href="#UPDATEæ“ä½œ" class="headerlink" title="UPDATEæ“ä½œ"></a>UPDATEæ“ä½œ</h2><pre><code class="go">package db

import &quot;log&quot;

/**
 * @author KHighness
 * @since 2021-04-20
 */

// æ›´æ–°ç”¨æˆ·
func UpdateById(user User)  &#123;
    res, _ := MysqlDB.Exec(&quot;UPDATE user SET name = ?, age = ? WHERE id = ? &quot;, user.Name, user.Age, user.Id)
    lastInsertId, _ := res.LastInsertId()
    rowsAffected, _ := res.RowsAffected()
    log.Printf(&quot;æ›´æ–°ID =&gt; [%d], å½±å“è¡Œæ•° =&gt; [%d]&quot;, lastInsertId, rowsAffected)
&#125;</code></pre>
<h2 id="DELETEæ“ä½œ"><a href="#DELETEæ“ä½œ" class="headerlink" title="DELETEæ“ä½œ"></a>DELETEæ“ä½œ</h2><pre><code class="go">package db

import &quot;log&quot;

/**
 * @author KHighness
 * @since 2021-04-20
 */

// åˆ é™¤ç”¨æˆ·
func DeleteById(id int)  &#123;
    res, _ := MysqlDB.Exec(&quot;DELETE FROM user WHERE id = ?&quot;, id)
    lastInsertId, _ := res.LastInsertId()
    rowsAffected, _ := res.RowsAffected()
    log.Printf(&quot;åˆ é™¤ID =&gt; [%d], å½±å“è¡Œæ•° =&gt; [%d]&quot;, lastInsertId, rowsAffected)
&#125;</code></pre>
<h2 id="äº‹åŠ¡æ“ä½œ"><a href="#äº‹åŠ¡æ“ä½œ" class="headerlink" title="äº‹åŠ¡æ“ä½œ"></a>äº‹åŠ¡æ“ä½œ</h2><pre><code class="go">import (
    &quot;log&quot;
    &quot;strconv&quot;
)

/**
 * @author KHighness
 * @since 2021-04-20
 */

// äº‹åŠ¡: æ‰¹é‡æ’å…¥5ä¸ªç”¨æˆ·
func BatchSaveUser(users [5]User)  &#123;
    // å¼€å§‹äº‹åŠ¡
    tx, _ := MysqlDB.Begin()
    var total int64 = 0
    for _, user := range users &#123;
        res, _ := MysqlDB.Exec(&quot;INSERT INTO user(name, age) VALUES(?, ?)&quot;, user.Name, user.Age)
        aff, _ := res.RowsAffected()
        total += aff
    &#125;
    // è½¬å­—ç¬¦ä¸²æ¯”è¾ƒ
    if  strconv.FormatInt(total, 10) == strconv.Itoa(len(users)) &#123;     // æäº¤äº‹åŠ¡
        _ = tx.Commit()
        log.Print(&quot;äº‹åŠ¡æäº¤&quot;)
    &#125; else &#123; // å›æ»š
        _ = tx.Rollback()
        log.Print(&quot;äº‹åŠ¡å›æ»š&quot;)
    &#125;

&#125;</code></pre>
<h2 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h2><pre><code class="powershell">package main

import (
    &quot;fmt&quot;
    &quot;go-mysql/db&quot;
    &quot;testing&quot;
)

/**
 * @author KHighness
 * @since 2021-04-20
 */


// æµ‹è¯•æŸ¥è¯¢
func TestQueryById(t *testing.T) &#123;
    db.QueryById(1)
&#125;

// æµ‹è¯•æŸ¥è¯¢æ‰€æœ‰
func TestQueryList(t *testing.T) &#123;
    db.QueryList()
&#125;

// æµ‹è¯•ä¿å­˜
func TestSaveUser(t *testing.T) &#123;
    user := db.User&#123;Name: &quot;FlowerK&quot;, Age: 16&#125;
    db.SaveUser(user)
&#125;

// æµ‹è¯•æ›´æ–°
func TestUpdateById(t *testing.T)  &#123;
    user := db.User&#123;Id: 1, Name: &quot;K&quot;, Age: 20&#125;
    db.UpdateById(user)
&#125;

// æµ‹è¯•åˆ é™¤
func TestDeleteById(t *testing.T)  &#123;
    db.DeleteById(4)
&#125;

// æµ‹è¯•äº‹åŠ¡
func TestBatchSaveUser(t *testing.T)  &#123;
    var users [5]db.User
    for i := 0; i &lt; 5; i++ &#123;
        users[i] = db.User&#123;Name: fmt.Sprintf(&quot;%s-%d&quot;, &quot;K&quot;, i + 1), Age: i + 1&#125;
    &#125;
    db.BatchSaveUser(users)
&#125;</code></pre>
]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title>Golang-Module</title>
    <url>/posts/58003/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a>å®˜æ–¹æ–‡æ¡£</h2><p>modulesçš„wiki: <a href="https://github.com/golang/go/wiki/Modules">https://github.com/golang/go/wiki/Modules</a></p>
<blockquote>
<p>go 1.14</p>
</blockquote>
<p>æ¨¡å—æ”¯æŒå·²ç»å‡†å¤‡å¥½ç”¨äºç”Ÿäº§ï¼Œå¹¶ä¸”é¼“åŠ±æ‰€æœ‰ç”¨æˆ·ä»å…¶ä»–ä¾èµ–ç®¡ç†ç³»ç»Ÿè¿ç§»åˆ°æ¨¡å—ã€‚</p>
<blockquote>
<p>go 1.16</p>
</blockquote>
<p>æ¨¡å—æ¨¡å¼é»˜è®¤å¼€å¯ï¼Œå³GO111MODULE=onã€‚</p>
<h2 id="GO111MODULE"><a href="#GO111MODULE" class="headerlink" title="GO111MODULE"></a>GO111MODULE</h2><p>GO111MODULEæœ‰ä¸‰ä¸ªå€¼ï¼šoffã€onå’Œautoï¼Œä¸åŒç‰ˆæœ¬çš„é»˜è®¤å€¼ä¸å°½ç›¸åŒã€‚</p>
<ol>
<li>offï¼šgoå‘½ä»¤è¡Œå°†ä¸ä¼šæ”¯æŒmoduleåŠŸèƒ½ï¼Œå¯»æ‰¾ä¾èµ–åŒ…çš„æ–¹å¼å°†ä¼šæ²¿ç”¨æ—§ç‰ˆæœ¬é€šè¿‡vendorç›®å½•æˆ–è€…GOPATHæ¨¡å¼æŸ¥æ‰¾ã€‚</li>
<li>onï¼šgoå‘½ä»¤è¡Œä¼šä½¿ç”¨modulesï¼Œè€Œä¸”ä¸€ç‚¹ä¹Ÿä¸ä¼šå»GOPATHç›®å½•ä¸‹æŸ¥æ‰¾ã€‚</li>
<li>autoï¼šgoå‘½ä»¤è¡Œå°†ä¼šæ ¹æ®å½“å‰ç›®å½•æ¥å†³å®šæ˜¯å¦å¯ç”¨moduleåŠŸèƒ½ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å½¢ï¼š<ol>
<li>å½“å‰ç›®å½•åœ¨$GOPATH/srcä¹‹å¤–ä¸”è¯¥ç›®å½•åŒ…å«go.modæ–‡ä»¶</li>
<li>å½“å‰æ–‡ä»¶åœ¨åŒ…å«go.modæ–‡ä»¶çš„ç›®å½•ä¸‹é¢</li>
</ol>
</li>
</ol>
<p>è¯´æ˜ï¼šå½“modules åŠŸèƒ½å¯ç”¨æ—¶ï¼Œä¾èµ–åŒ…çš„å­˜æ”¾ä½ç½®å˜æ›´ä¸º$GOPATH/pkgï¼Œå…è®¸åŒä¸€ä¸ªpackageå¤šä¸ªç‰ˆæœ¬å¹¶å­˜ï¼Œä¸”å¤šä¸ªé¡¹ç›®å¯ä»¥å…±äº«ç¼“å­˜çš„ moduleã€‚</p>
<h2 id="åŸºæœ¬å‘½ä»¤"><a href="#åŸºæœ¬å‘½ä»¤" class="headerlink" title="åŸºæœ¬å‘½ä»¤"></a>åŸºæœ¬å‘½ä»¤</h2><p>golangæä¾›äº†<code>go mod</code>å‘½ä»¤æ¥ç®¡ç†åŒ…ï¼Œåç½®å‚æ•°å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>download</td>
<td>ä¸‹è½½ä¾èµ–åŒ…</td>
</tr>
<tr>
<td>edit</td>
<td>ç¼–è¾‘go.mod</td>
</tr>
<tr>
<td>graph</td>
<td>æ‰“å°æ¨¡å—ä¾èµ–å›¾</td>
</tr>
<tr>
<td>init</td>
<td>åœ¨å½“å‰ç›®å½•åˆå§‹åŒ–mod</td>
</tr>
<tr>
<td>tidy</td>
<td>æ‹‰å–ç¼ºå°‘çš„æ¨¡å—ï¼Œç§»é™¤ä¸ç”¨çš„æ¨¡å—</td>
</tr>
<tr>
<td>vendor</td>
<td>å°†ä¾èµ–å¤åˆ¶åˆ°vendorä¸‹</td>
</tr>
<tr>
<td>verify</td>
<td>éªŒè¯ä¾èµ–æ˜¯å¦æ­£ç¡®</td>
</tr>
<tr>
<td>why</td>
<td>è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ä¾èµ–</td>
</tr>
</tbody></table>
<h2 id="modæ–‡ä»¶"><a href="#modæ–‡ä»¶" class="headerlink" title="modæ–‡ä»¶"></a>modæ–‡ä»¶</h2><p>go.modæ–‡ä»¶ä¸­æä¾›äº†å››ä¸ªå‘½ä»¤ï¼š</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>module</td>
<td>æŒ‡å®šåŒ…çš„åç§°</td>
</tr>
<tr>
<td>require</td>
<td>æŒ‡å®šä¾èµ–é¡¹æ¨¡å—</td>
</tr>
<tr>
<td>replace</td>
<td>æ›¿æ¢ä¾èµ–é¡¹æ¨¡å—</td>
</tr>
<tr>
<td>exclude</td>
<td>å¿½ç•¥ä¾èµ–é¡¹æ¨¡å—</td>
</tr>
</tbody></table>
<h2 id="é¡¹ç›®æ¡ˆä¾‹"><a href="#é¡¹ç›®æ¡ˆä¾‹" class="headerlink" title="é¡¹ç›®æ¡ˆä¾‹"></a>é¡¹ç›®æ¡ˆä¾‹</h2><p>ç¯å¢ƒï¼šgo 1.16.3</p>
<blockquote>
<p>åˆ›å»ºé¡¹ç›®</p>
</blockquote>
<pre><code class="powershell">$ mkdir go-mod &amp;&amp; cd go-mod
$ go mod init hello
$ touch server.go
$ mkdir api &amp;&amp; cd api
$ touch hello.go &amp;&amp; touch print.go</code></pre>
<blockquote>
<p>é¡¹ç›®ç»“æ„</p>
</blockquote>
<pre><code class="powershell">go-mod
â”œâ”€â”€ go.mod
â”œâ”€â”€ server.go
â””â”€â”€ api
    â”œâ”€â”€ hello.mod
    â””â”€â”€ print.go</code></pre>
<p>å…¶ä¸­serveréœ€è¦è°ƒç”¨apiä¸­çš„helloçš„<code>_HelloKHighness_</code>å’Œprintçš„<code>_ConsolePrint_</code>æ¥å£ã€‚</p>
<p>åˆå§‹åŒ–çš„go-modä¸­å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="powershell">module hello

go 1.16</code></pre>
<blockquote>
<p>hello.go</p>
</blockquote>
<pre><code class="go">package api

/**
 * @author KHighness
 * @since 2021-04-20
 */

import (
    &quot;github.com/labstack/echo&quot;
    &quot;net/http&quot;
)

func HelloKHighness(c echo.Context) error &#123;
    return c.JSON(http.StatusOK, &quot;Hello KHighness!&quot;)
&#125;</code></pre>
<blockquote>
<p>print.go</p>
</blockquote>
<pre><code class="go">package api

/**
 * @author KHighness
 * @since 2021-04-20
 */

import &quot;fmt&quot;

func ConsolePrint()  &#123;
    fmt.Println(&quot;Hello, KHighness!&quot;)
&#125;</code></pre>
<blockquote>
<p>server.go</p>
</blockquote>
<pre><code class="go">package main

/**
 * @author KHighness
 * @since 2021-04-20
 */

import (
    &quot;github.com/labstack/echo&quot;
    helloAPI &quot;hello/api&quot; 
)

func main() &#123;
    helloAPI.ConsolePrint()
    e := echo.New()
    e.GET(&quot;/&quot;, helloAPI.HelloKHighness)
    e.Logger.Fatal(e.Start(&quot;:3333&quot;))
&#125;</code></pre>
<blockquote>
<p>å®‰è£…ä¾èµ–</p>
</blockquote>
<pre><code class="powershell">$ go mod tidy
go: finding module for package github.com/labstack/echo
go: found github.com/labstack/echo in github.com/labstack/echo v3.3.10+incompatible
go: finding module for package github.com/stretchr/testify/assert
go: finding module for package github.com/labstack/gommon/color
go: finding module for package github.com/labstack/gommon/log
go: finding module for package golang.org/x/crypto/acme/autocert
go: found github.com/labstack/gommon/color in github.com/labstack/gommon v0.3.0
go: found github.com/labstack/gommon/log in github.com/labstack/gommon v0.3.0
go: found golang.org/x/crypto/acme/autocert in golang.org/x/crypto v0.0.0-20210415154028-4f45737414dc
go: found github.com/stretchr/testify/assert in github.com/stretchr/testify v1.7.0</code></pre>
<p>å®‰è£…åå¯ä»¥çœ‹åˆ°go.modæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<pre><code>module hello

go 1.16

require (
    github.com/labstack/echo v3.3.10+incompatible
    github.com/labstack/gommon v0.3.0 // indirect
    github.com/stretchr/testify v1.7.0 // indirect
    golang.org/x/crypto v0.0.0-20210415154028-4f45737414dc // indirect
)</code></pre>
<blockquote>
<p>è¿è¡Œé¡¹ç›®</p>
</blockquote>
<pre><code class="powershell">$ go run server.go
Hello, KHighness!

   ____    __
  / __/___/ /  ___
 / _// __/ _ \/ _ \
/___/\__/_//_/\___/ v3.3.10-dev
High performance, minimalist Go web framework
https://echo.labstack.com
____________________________________O/_______
                                    O\
â‡¨ http server started on [::]:3333</code></pre>
<blockquote>
<p>é¡¹ç›®æµ‹è¯•</p>
</blockquote>
<pre><code class="powershell"> $ curl -X GET http://127.0.0.1:3333
&quot;Hello KHighness!&quot;</code></pre>
<blockquote>
<p>é¡¹ç›®æ‰“åŒ…</p>
</blockquote>
<pre><code class="powershell">$ go build</code></pre>
<p>æ‰“åŒ…ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°hello.exeå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p>[1] modules wiki: <a href="https://github.com/golang/go/wiki/Modules">https://github.com/golang/go/wiki/Modules</a><br>[2] go mod ä½¿ç”¨: <a href="https://juejin.cn/post/6844903798658301960">https://juejin.cn/post/6844903798658301960</a><br>[3] å†æ¢go modules: <a href="https://www.cnblogs.com/apocelipes/p/10295096.html">https://www.cnblogs.com/apocelipes/p/10295096.html</a></p>
]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title>RMI &amp; RPC</title>
    <url>/posts/18721/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h2><p>Remote Method Invocationï¼šè¿œç¨‹æ–¹æ³•è°ƒç”¨</p>
<h3 id="è°ƒç”¨è¿‡ç¨‹"><a href="#è°ƒç”¨è¿‡ç¨‹" class="headerlink" title="è°ƒç”¨è¿‡ç¨‹"></a>è°ƒç”¨è¿‡ç¨‹</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/18721/rmi.png" class="" title="rmi">

<ul>
<li>Clientè°ƒç”¨Client Stubä¸Šçš„æ–¹æ³•</li>
<li>Client Stubå°†æ–¹æ³•å’Œå‚æ•°è¿›è¡Œåºåˆ—åŒ–ï¼ˆç¼–ç ï¼‰æˆå¯ä¼ è¾“æ¶ˆæ¯ä½“</li>
<li>æ¶ˆæ¯é€šè¿‡ç½‘ç»œä¼ è¾“åˆ°Server</li>
<li>Server Stubå°†æ¶ˆæ¯è¿›è¡Œååºåˆ—åŒ–ï¼ˆè§£ç ï¼‰</li>
<li>Serveræ ¹æ®è§£ç ç»“æœè°ƒç”¨æ–¹æ³•ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™Server Stub</li>
<li>Server Stubå¯¹è¿”å›ç»“æœè¿›è¡Œåºåˆ—åŒ–ï¼ˆç¼–ç ï¼‰æˆå¯ä¼ è¾“æ¶ˆæ¯ä½“</li>
<li>æ¶ˆæ¯ç½‘ç»œä¼ è¾“åˆ°Client</li>
<li>Client Stubå¯¹æ¶ˆæ¯è¿›è¡Œååºåˆ—åŒ–ï¼ˆè§£ç ï¼‰</li>
<li>Client Stubå°†è§£ç ç»“æœè¿”å›ç»™Client</li>
</ul>
<br>


<h2 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h2><p>Remote Procedure Callï¼šè¿œç¨‹è¿‡ç¨‹è°ƒç”¨</p>
<h3 id="æ¡†æ¶ç»„æˆ"><a href="#æ¡†æ¶ç»„æˆ" class="headerlink" title="æ¡†æ¶ç»„æˆ"></a>æ¡†æ¶ç»„æˆ</h3><ul>
<li>å®¢æˆ·ç«¯ï¼ˆClientï¼‰ï¼šæœåŠ¡è°ƒç”¨æ–¹</li>
<li>å®¢æˆ·ç«¯å­˜æ ¹ï¼ˆClient Stubï¼‰ï¼šå­˜æ”¾æœåŠ¡ç«¯åœ°å€ä¿¡æ¯ï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚å‚æ•°æ•°æ®ä¿¡æ¯æ‰“åŒ…æˆç½‘ç»œæ¶ˆæ¯ï¼Œå†é€šè¿‡ç½‘ç»œä¼ è¾“å‘é€ç»™æœåŠ¡ç«¯</li>
<li>æœåŠ¡ç«¯å­˜æ ¹ï¼ˆServer Stubï¼‰ï¼šæ¥æ”¶å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚æ¶ˆæ¯å¹¶è¿›è¡Œè§£åŒ…ï¼Œç„¶åå†è°ƒç”¨æœ¬åœ°æœåŠ¡è¿›è¡Œå¤„ç†</li>
<li>æœåŠ¡ç«¯ï¼ˆServerï¼‰ï¼šæœåŠ¡çš„çœŸæ­£æä¾›è€…</li>
<li>Network Serviceï¼šåº•å±‚ä¼ è¾“ï¼Œå¯ä»¥æ˜¯ TCP æˆ– HTTP</li>
</ul>
<h3 id="è°ƒç”¨è¿‡ç¨‹-1"><a href="#è°ƒç”¨è¿‡ç¨‹-1" class="headerlink" title="è°ƒç”¨è¿‡ç¨‹"></a>è°ƒç”¨è¿‡ç¨‹</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/18721/rpc.png" class="" title="rpc">

<ul>
<li>Clienté€šè¿‡æœ¬åœ°è°ƒç”¨çš„æ–¹å¼è°ƒç”¨æœåŠ¡</li>
<li>Client Stubæ¥æ”¶åˆ°è°ƒç”¨è¯·æ±‚åè´Ÿè´£å°†æ–¹æ³•ã€å‚æ•°ç­‰ç¼–ç æˆå¯ä¼ è¾“æ¶ˆæ¯ä½“</li>
<li>Client Stubæ‰¾åˆ°è¿œç¨‹çš„æœåŠ¡åœ°å€ï¼Œå¹¶ä¸”å°†æ¶ˆæ¯é€šè¿‡ç½‘ç»œå‘é€ç»™Server</li>
<li>Server Stubæ”¶åˆ°æ¶ˆæ¯åè¿›è¡Œè§£ç æ“ä½œ</li>
<li>Server Stubæ ¹æ®è§£ç ç»“æœè°ƒç”¨æœ¬åœ°çš„æœåŠ¡è¿›è¡Œç›¸å…³å¤„ç†</li>
<li>Serverè¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†</li>
<li>Serverå°†å¤„ç†ç»“æœè¿”å›ç»™Server Stub</li>
<li>Server Stubå°†è¿”å›ç»“æœè¿›è¡Œç¼–ç </li>
<li>Server Stubå°†ç»“æœé€šè¿‡ç½‘ç»œå‘é€è‡³æ¶ˆè´¹æ–¹</li>
<li>Client Stubæ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¹¶è¿›è¡Œè§£ç </li>
<li>Clientå¾—åˆ°æœ€ç»ˆç»“æœ</li>
</ul>
<h3 id="æ ¸å¿ƒåŠŸèƒ½"><a href="#æ ¸å¿ƒåŠŸèƒ½" class="headerlink" title="æ ¸å¿ƒåŠŸèƒ½"></a>æ ¸å¿ƒåŠŸèƒ½</h3><ul>
<li>æœåŠ¡å¯»å€</li>
<li>æ•°æ®æµçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</li>
<li>ç½‘ç»œä¼ è¾“</li>
</ul>
<br>


<h2 id="RPC-VS-PMI"><a href="#RPC-VS-PMI" class="headerlink" title="RPC VS PMI"></a>RPC VS PMI</h2><p>ä¸åŒç‚¹ï¼š</p>
<p>ï¼ˆ1ï¼‰æ–¹æ³•è°ƒç”¨æ–¹å¼ä¸åŒ</p>
<p>RMIä¸­æ˜¯é€šè¿‡åœ¨å®¢æˆ·ç«¯çš„Stubå¯¹è±¡ä½œä¸ºè¿œç¨‹æ¥å£è¿›è¡Œè¿œç¨‹æ–¹æ³•çš„è°ƒç”¨ã€‚æ¯ä¸ªè¿œç¨‹æ–¹æ³•éƒ½å…·æœ‰æ–¹æ³•ç­¾åã€‚å¦‚æœæœåŠ¡å™¨ä¸Šæ·»åŠ äº†ä¸€ä¸ªå¯æ‰§è¡Œæ–¹æ³•ï¼Œä½†æ˜¯æ²¡æœ‰ç›¸åŒ¹é…çš„ç­¾åè¢«æ·»åŠ åˆ°è¿™ä¸ªè¿œç¨‹æ¥å£Stubå¯¹è±¡ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªæ–°æ–¹æ³•å°±ä¸èƒ½è¢«å®¢æˆ·ç«¯è°ƒç”¨ã€‚RPCæ˜¯é€šè¿‡ç½‘ç»œæœåŠ¡åè®®å‘è¿œç¨‹ä¸»æœºå‘é€è¯·æ±‚ï¼Œè¯·æ±‚åŒ…å«äº†ä¸€ä¸ªå‚æ•°é›†å’Œæ–‡æœ¬å€¼ï¼Œé€šå¸¸å½¢æˆâ€classname.methodnameâ€çš„å½¢å¼ï¼ŒæœåŠ¡å™¨å°±å»æœç´¢ä¸ä¹‹ç›¸åŒ¹é…çš„ç±»å’Œæ–¹æ³•ï¼Œæ‰¾åˆ°åå°±æ‰§è¡Œæ–¹æ³•å¹¶æŠŠç»“æœç¼–ç ï¼Œé€šè¿‡ç½‘ç»œåè®®è¿”å›ã€‚</p>
<p>ï¼ˆ2ï¼‰ä½¿ç”¨è¯­è¨€èŒƒå›´ä¸åŒ</p>
<p>RMIæ˜¯J2EEçš„13å¤§è§„èŒƒä¹‹ä¸€ï¼Œåªé€‚ç”¨äºJavaï¼›RPCæ˜¯ç½‘ç»œåè®®ï¼Œä¸æ“ä½œç³»ç»Ÿå’Œè¯­è¨€æ— å…³ã€‚</p>
<p>ï¼ˆ3ï¼‰è°ƒç”¨ç»“æœçš„è¿”å›å½¢å¼ä¸åŒ</p>
<p>RMIçš„è°ƒç”¨ç»“æœå¯ä»¥æ˜¯Javaçš„å¯¹è±¡ç±»å‹æˆ–è€…åŸºæœ¬æ•°æ®ç±»å‹ï¼›RPCçš„è°ƒç”¨ç»“æœç»Ÿä¸€ç”±å¤–éƒ¨æ•°æ®è¡¨ç¤ºã€‚</p>
]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>RPC</tag>
      </tags>
  </entry>
  <entry>
    <title>Springboot-json</title>
    <url>/posts/22416/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>å‰è¨€</p>
</blockquote>
<p>å¹³æ—¥é‡Œé¡¹ç›®ä¸­å¤„ç†JSONä¸€èˆ¬ç”¨çš„éƒ½æ˜¯é˜¿é‡Œå·´å·´çš„fastjsonï¼Œç°åœ¨å‘ç°ä½¿ç”¨SpringBootå†…ç½®çš„Jacksonçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¹ŸæŒºæ–¹ä¾¿çš„ã€‚Jacksonä¸ä½†å¯ä»¥å®Œæˆç®€å•çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œï¼Œä¹Ÿèƒ½å®ç°å¤æ‚çš„ä¸ªæ€§åŒ–çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œã€‚</p>
<p>â€”â€”ä»¥ä¸Šæ–‡æ¡ˆçš†ç›—äºé¸Ÿå”åšå®¢ï¼Œå‹¿æ€ªå‹¿æ€ªã€‚<br></p>
<blockquote>
<p>å‡†å¤‡</p>
</blockquote>
<p>å®ä½“ç±»User</p>
<pre><code class="java">public class User implements Serializable &#123;
    private static final long serialVersionUID = -3180230416244251692L;

    private Integer id;
    private String name;
    private Date birth;

    // NoArgsConstructor
    // AllArgsConstructor
    // Getter and Setter
    // ToString
&#125;</code></pre>
<h2 id="ObjectMapper-API"><a href="#ObjectMapper-API" class="headerlink" title="ObjectMapper API"></a>ObjectMapper API</h2><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/22416/objectmapper.png" class="" title="objectmapper">



<h2 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><p>åºåˆ—åŒ–å±æ€§SerializationFeature</p>
<pre><code class="java">WRAP_ROOT_VALUE(false),                   
INDENT_OUTPUT(false),
FAIL_ON_EMPTY_BEANS(true),
FAIL_ON_SELF_REFERENCES(true),
WRAP_EXCEPTIONS(true),
FAIL_ON_UNWRAPPED_TYPE_IDENTIFIERS(true),
CLOSE_CLOSEABLE(false),
FLUSH_AFTER_WRITE_VALUE(true),
WRITE_DATES_AS_TIMESTAMPS(true),
WRITE_DATE_KEYS_AS_TIMESTAMPS(false),
WRITE_DATES_WITH_ZONE_ID(false),
WRITE_DURATIONS_AS_TIMESTAMPS(true),
WRITE_CHAR_ARRAYS_AS_JSON_ARRAYS(false),
WRITE_ENUMS_USING_TO_STRING(false),
WRITE_ENUMS_USING_INDEX(false),
WRITE_ENUM_KEYS_USING_INDEX(false),
WRITE_SINGLE_ELEM_ARRAYS_UNWRAPPED(false),
WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS(true),
ORDER_MAP_ENTRIES_BY_KEYS(false),
EAGER_SERIALIZER_FETCH(true),
USE_EQUALITY_FOR_OBJECT_ID(false);</code></pre>
<p>ååºåˆ—åŒ–å±æ€§DeserializationFeature</p>
<pre><code class="java">USE_BIG_DECIMAL_FOR_FLOATS(false),
USE_BIG_INTEGER_FOR_INTS(false),
USE_LONG_FOR_INTS(false),
USE_JAVA_ARRAY_FOR_JSON_ARRAY(false),
FAIL_ON_UNKNOWN_PROPERTIES(true),
FAIL_ON_NULL_FOR_PRIMITIVES(false),
FAIL_ON_NUMBERS_FOR_ENUMS(false),
FAIL_ON_INVALID_SUBTYPE(true),
FAIL_ON_READING_DUP_TREE_KEY(false),
FAIL_ON_IGNORED_PROPERTIES(false),
FAIL_ON_UNRESOLVED_OBJECT_IDS(true),
FAIL_ON_MISSING_CREATOR_PROPERTIES(false),
FAIL_ON_NULL_CREATOR_PROPERTIES(false),
FAIL_ON_MISSING_EXTERNAL_TYPE_ID_PROPERTY(true),
FAIL_ON_TRAILING_TOKENS(false),
WRAP_EXCEPTIONS(true),
ACCEPT_SINGLE_VALUE_AS_ARRAY(false),
UNWRAP_SINGLE_VALUE_ARRAYS(false),
UNWRAP_ROOT_VALUE(false),
ACCEPT_EMPTY_STRING_AS_NULL_OBJECT(false),
ACCEPT_EMPTY_ARRAY_AS_NULL_OBJECT(false),
ACCEPT_FLOAT_AS_INT(true),
READ_ENUMS_USING_TO_STRING(false),
READ_UNKNOWN_ENUM_VALUES_AS_NULL(false),
READ_UNKNOWN_ENUM_VALUES_USING_DEFAULT_VALUE(false),
READ_DATE_TIMESTAMPS_AS_NANOSECONDS(true),
ADJUST_DATES_TO_CONTEXT_TIME_ZONE(true),
EAGER_DESERIALIZER_FETCH(true);</code></pre>
<h2 id="environmenté…ç½®"><a href="#environmenté…ç½®" class="headerlink" title="environmenté…ç½®"></a>environmenté…ç½®</h2><p>å¯é…ç½®</p>
<ul>
<li>spring.jackson.deserialization.<feature_name>=true|false</li>
<li>spring.jackson.generator.<feature_name>=true|false</li>
<li>spring.jackson.mapper.<feature_name>=true|false</li>
<li>spring.jackson.parser.<feature_name>=true|false</li>
<li>spring.jackson.serialization.<feature_name>=true|false</li>
<li>spring.jackson.serialization-inclusion=always|non_null|non_absent|non_default|non_empty</li>
</ul>
<p>application.ymlï¼š</p>
<pre><code class="yaml">spring:
  jackson:
    # æ—¥æœŸæ ¼å¼åŒ–
    date-format: yyyy-MM-dd HH:mm:ss
    # è®¾ç½®ç©ºå±æ€§ä½•å¦‚åºåˆ—åŒ–
    default-property-inclusion: non_empty
    # åºåˆ—åŒ–
    serialization:
    # ååºåˆ—åŒ–
    deserialization:
    # è§£æ    
    parser: </code></pre>
<h2 id="configurationé…ç½®"><a href="#configurationé…ç½®" class="headerlink" title="configurationé…ç½®"></a>configurationé…ç½®</h2><p>åœ¨@Configurationç±»ä¸­ç”Ÿæˆbeanï¼š</p>
<pre><code class="java">@Configuration
public class JacksonConfig &#123;

    @Bean
    @Primary
    @ConditionalOnMissingBean(ObjectMapper.class)
    public ObjectMapper objectMapper() &#123;
        ObjectMapper objectMapper = new ObjectMapper();
        // åºåˆ—åŒ–æ—¥æœŸæ ¼å¼
        objectMapper.setDateFormat(new SimpleDateFormat(&quot;yyyy-MM-dd&quot;));
        // æ²¡æœ‰åŒ¹é…çš„å±æ€§åç§°æ—¶ä¸ä½œå¤„ç†
        objectMapper.configure(MapperFeature.AUTO_DETECT_FIELDS, true);

        // åºåˆ—åŒ–
        //ç¦æ­¢åºåˆ—åŒ–ç©ºå€¼
        objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, false);
        objectMapper.configure(SerializationFeature.WRITE_ENUMS_USING_TO_STRING, true);
        objectMapper.configure(SerializationFeature.WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS, true);
        objectMapper.configure(SerializationFeature.FLUSH_AFTER_WRITE_VALUE, true);
        // ä¸åŒ…å«ç©ºå€¼å±æ€§
        objectMapper.setSerializationInclusion(JsonInclude.Include.NON_EMPTY);

        // ååºåˆ—åŒ–
        //ç¦æ­¢é‡åˆ°ç©ºåŸå§‹ç±»å‹æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œç”¨é»˜è®¤å€¼ä»£æ›¿
        objectMapper.configure(DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES, false);
        objectMapper.configure(DeserializationFeature.READ_ENUMS_USING_TO_STRING, true);
        // ç¦æ­¢é‡åˆ°æœªçŸ¥ï¼ˆæ–°ï¼‰å±æ€§æ—¶æŠ¥é”™ï¼Œæ”¯æŒå…¼å®¹æ‰©å±•
        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        objectMapper.configure(DeserializationFeature.FAIL_ON_IGNORED_PROPERTIES, false);
        objectMapper.configure(DeserializationFeature.ACCEPT_EMPTY_ARRAY_AS_NULL_OBJECT, true);
        objectMapper.configure(DeserializationFeature.ACCEPT_EMPTY_STRING_AS_NULL_OBJECT, true);
        objectMapper.configure(DeserializationFeature.READ_DATE_TIMESTAMPS_AS_NANOSECONDS, true);
        objectMapper.configure(DeserializationFeature.READ_UNKNOWN_ENUM_VALUES_AS_NULL, true);
        objectMapper.configure(DeserializationFeature.READ_ENUMS_USING_TO_STRING, true);
        objectMapper.configure(DeserializationFeature.READ_ENUMS_USING_TO_STRING, true);

        return objectMapper;
    &#125;
&#125;</code></pre>
<p>Restæ¥å£ï¼š</p>
<pre><code class="java">@RestController
@RequestMapping(&quot;/user&quot;)
public class UserController &#123;
    private static Logger log = LoggerFactory.getLogger(UserController.class);

    @Autowired
    private ObjectMapper objectMapper;

    // åºåˆ—åŒ–æ¥å£
    @GetMapping(&quot;/get&quot;)
    public String getUser() throws JsonProcessingException &#123;
        User user = new User(1, &quot;KHighness&quot;, new Date());
        return objectMapper.writeValueAsString(user);
    &#125;

    // ååºåˆ—åŒ–æ¥å£
    @PostMapping(&quot;/save&quot;)
    public void saveUser(@RequestBody String userJsonList) throws IOException &#123;
        List&lt;User&gt; userList = objectMapper.readValue(userJsonList, new TypeReference&lt;List&lt;User&gt;&gt;() &#123;&#125;);
        userList.forEach(e -&gt; &#123;log.info(e.toString());&#125;);
    &#125;
&#125;</code></pre>
<p>CURLæµ‹è¯•ï¼ˆwindowsä¸‹å»ºè®®ä½¿ç”¨cmdè¿›è¡Œæµ‹è¯•ï¼Œç”¨powershellä¼šåˆ°å¯¼è‡´POSTé”™è¯¯ï¼‰<br />åºåˆ—åŒ–æµ‹è¯•ï¼š</p>
<pre><code class="powershell">$ curl -X GET http://localhost:3333/user/get</code></pre>
<p>åºåˆ—åŒ–æµ‹è¯•ç»“æœï¼š</p>
<pre><code class="json">&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;KHighness&quot;,&quot;birth&quot;:&quot;2021-04-15&quot;&#125;</code></pre>
<p>ååºåˆ—åŒ–æµ‹è¯•ï¼š</p>
<pre><code class="powershell">$ curl -H &quot;Content-Type:application/json&quot; -X POST --data &quot;[&#123;\&quot;id\&quot;:1, \&quot;name\&quot;:\&quot;Khighness\&quot;, \&quot;birth\&quot;:\&quot;2001-09-11\&quot;&#125;, &#123;\&quot;id\&quot;:2, \&quot;name\&quot;:\&quot;FlowerK\&quot;, \&quot;birth\&quot;:\&quot;2003-07-24\&quot;&#125;]&quot;  http://localhost:3333/user/save</code></pre>
<p>ååºåˆ—åŒ–æµ‹è¯•ç»“æœï¼š</p>
<pre><code class="json">[&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;Khighness&quot;,&quot;birth&quot;:&quot;2001-09-11&quot;&#125;,&#123;&quot;id&quot;:2,&quot;name&quot;:&quot;FlowerK&quot;,&quot;birth&quot;:&quot;2003-07-24&quot;&#125;]</code></pre>
<h2 id="Jacksonæ³¨è§£"><a href="#Jacksonæ³¨è§£" class="headerlink" title="Jacksonæ³¨è§£"></a>Jacksonæ³¨è§£</h2><p>ï¼ˆ1ï¼‰@JsonProperty<br>ä½œç”¨åœ¨å±æ€§ä¸Šï¼Œç”¨äºåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ä¸ºJSON keyæŒ‡å®šä¸€ä¸ªåˆ«åã€‚<br>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">@JsonProperty(&quot;bth&quot;)
private Date birth;</code></pre>
<p>æ­¤æ—¶åºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<pre><code class="json">&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;KHighness&quot;,&quot;bth&quot;:&quot;2021-04-16&quot;&#125;</code></pre>
<p>ï¼ˆ2ï¼‰@JsonIgnore<br>ä½œç”¨åœ¨å±æ€§ä¸Šï¼Œç”¨äºåœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶å¿½ç•¥æ­¤å±æ€§ã€‚<br>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">@JsonIgnore
private String name;</code></pre>
<p>æ­¤æ—¶åºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<pre><code class="json">&#123;&quot;id&quot;:1,&quot;birth&quot;:&quot;2021-04-16&quot;&#125;</code></pre>
<p>ï¼ˆ3ï¼‰@JsonIgnoreProperties<br>ä½œç”¨åœ¨ç±»ä¸Šï¼Œç”¨äºå¿½ç•¥ä¸€ç»„å±æ€§ã€‚<br>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">@JsonIgnoreProperties(&#123;&quot;id&quot;, &quot;birth&quot;&#125;)</code></pre>
<p>æ­¤æ—¶åºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<pre><code class="json">&#123;&quot;name&quot;:&quot;KHighness&quot;&#125;</code></pre>
<p>ï¼ˆ4ï¼‰@JsonFormat<br>ä½œç”¨åœ¨æ—¥æœŸå±æ€§ä¸Šï¼Œç”¨äºæ ¼å¼åŒ–ã€‚<br>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">@JsonFormat(pattern = &quot;yyyy.MM.dd&quot;)
private Date birth;</code></pre>
<p>æ­¤æ—¶åºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<pre><code class="json">&#123;&quot;id&quot;:1,&quot;userName&quot;:&quot;KHighness&quot;,&quot;birth&quot;:&quot;2021.04.16&quot;&#125;</code></pre>
<p>ï¼ˆ5ï¼‰@JsonNaming<br>ä½œç”¨åœ¨ç±»ä¸Šï¼Œç”¨äºæŒ‡å®šä¸€ä¸ªå‘½åç­–ç•¥ã€‚</p>
<p>Jacksonè‡ªå¸¦äº†äº”ç§(ä¸¤ç§)å‘½åç­–ç•¥ï¼Œä½¿ç”¨æ–¹å¼ï¼Œ</p>
<pre><code class="java">@JsonNaming(PropertyNamingStrategy.&lt;Strategy&gt;.class)
public class User &#123;
     private String userName;   
&#125;</code></pre>
<table>
<thead>
<tr>
<th>å‘½åç­–ç•¥</th>
<th>ä¸­æ–‡æè¿°</th>
<th>ä½œç”¨ç»“æœ</th>
</tr>
</thead>
<tbody><tr>
<td>KebabCaseStrategy</td>
<td>ä¸­åˆ’çº¿</td>
<td>user-name</td>
</tr>
<tr>
<td>SnakeCaseStrategy</td>
<td>ä¸‹åˆ’çº¿</td>
<td>user_name</td>
</tr>
<tr>
<td>UpperCamelCaseStrategy</td>
<td>å¤§é©¼å³°</td>
<td>UserName</td>
</tr>
<tr>
<td>LowerCaseStrategy</td>
<td>å…¨å°å†™</td>
<td>username</td>
</tr>
<tr>
<td>LowerDotCaseStrategy</td>
<td>å°å†™ç‚¹</td>
<td>user.name</td>
</tr>
</tbody></table>
<p>ï¼ˆ6ï¼‰@JsonSerialize<br>ä½œç”¨åœ¨ç±»ä¸Šï¼ŒæŒ‡å®šä¸€ä¸ªç±»æ¥è‡ªå®šä¹‰åºåˆ—åŒ–ï¼Œè¯¥ç±»å¿…é¡»å®ç°<code>JsonSerializer</code>æ¥å£ã€‚<br>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">public class UserSerializer extends JsonSerializer&lt;User&gt; &#123;
    @Override
    public void serialize(User user, JsonGenerator jsonGenerator, 
                          SerializerProvider serializerProvider) throws IOException &#123;
        jsonGenerator.writeStartObject();
        jsonGenerator.writeStringField(&quot;USER-NAME&quot;, user.getUserName());
        jsonGenerator.writeEndObject();
    &#125;
&#125;</code></pre>
<pre><code class="java">@JsonSerialize(using = UserSerializer.class)
public class User implements Serializable &#123;
    private static final long serialVersionUID = -3180230416244251692L;
    private String userName;
    // ...
&#125;</code></pre>
<p>æ­¤æ—¶åºåˆ—åŒ–æ¥å£æµ‹è¯•ç»“æœä¸ºï¼š</p>
<pre><code class="json">&#123;&quot;USER-NAME&quot;:&quot;KHighness&quot;&#125;</code></pre>
<p>ï¼ˆ7ï¼‰@JsonDeserialize<br>ä½œç”¨åœ¨ç±»ä¸Šï¼ŒæŒ‡å®šä¸€ä¸ªç±»æ¥è‡ªå®šä¹‰ååºåˆ—åŒ–ï¼Œè¯¥ç±»å¿…é¡»å®ç°<code>JsonDeserializer</code>æ¥å£ã€‚<br>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">public class UserDeserializer extends JsonDeserializer&lt;User&gt; &#123;
    @Override
    public User deserialize(JsonParser jsonParser, DeserializationContext deserializationContext)
            throws IOException, JsonProcessingException &#123;
        JsonNode node = jsonParser.getCodec().readTree(jsonParser);
        String userName = node.get(&quot;user-name&quot;).asText();
        User user = new User();
        user.setUserName(userName);
        return user;
    &#125;
&#125;</code></pre>
<pre><code class="java">@JsonDeserialize(using = UserDeserializer.class)
public class User implements Serializable &#123;
    private static final long serialVersionUID = -3180230416244251692L;
    private String userName;
    // ...
&#125;</code></pre>
<p>ååºåˆ—åŒ–æµ‹è¯•ï¼š</p>
<pre><code class="json">curl -H &quot;Content-Type:application/json&quot; -X POST --data &quot;[&#123;\&quot;user-name\&quot;:\&quot;Khighness\&quot;&#125;, &#123;\&quot;user-name\&quot;:\&quot;FlowerK\&quot;&#125;]&quot;  http://localhost:3333/user/save
[&#123;&quot;userName&quot;:&quot;Khighness&quot;&#125;,&#123;&quot;userName&quot;:&quot;FlowerK&quot;&#125;]</code></pre>
<p>ååºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<pre><code class="json">[&#123;&quot;userName&quot;:&quot;Khighness&quot;&#125;,&#123;&quot;userName&quot;:&quot;FlowerK&quot;&#125;]</code></pre>
<p>ï¼ˆ8ï¼‰@JsonView<br>ä½œç”¨åœ¨ç±»ã€å±æ€§å’Œæ–¹æ³•ä¸Šï¼Œç”¨æ¥åºåˆ—åŒ–ç»„ã€‚<br>æ¯”å¦‚å¯¹äºUserå¯¹è±¡ï¼ŒæŸäº›æƒ…å†µä¸‹åªè¿”å›userNameå³å¯ï¼Œ</p>
<p>è€ŒæŸäº›æƒ…å†µä¸‹éœ€è¦è¿”å›å…¨éƒ¨å±æ€§ã€‚å› æ­¤Userå¯¹è±¡å¯ä»¥è¿™æ ·å®šä¹‰ï¼š</p>
<pre><code class="java">public class User implements Serializable &#123;
    private static final long serialVersionUID = -3180230416244251692L;

    // ä»…åŒ…å«userName
    public interface UserNameView &#123;&#125;;

    // åŒ…å«å…¨éƒ¨å±æ€§
    public interface AllUserFieldView extends UserNameView &#123;&#125;;

    @JsonView(AllUserFieldView.class)
    private Integer id;

    @JsonView(UserNameView.class)
    private String userName;

    @JsonView(AllUserFieldView.class)
    private Date birth;

    // ...
&#125;</code></pre>
<p>ç„¶ååœ¨controllerçš„æ–¹æ³•ä¸Šä½¿ç”¨@JsonViewï¼Œå¯ä»¥æŒ‡å®šåºåˆ—åŒ–ç»„åã€‚<br />ä½¿ç”¨ç»„åUserNameViewï¼š</p>
<pre><code class="java">@JsonView(User.UserNameView.class)
@GetMapping(&quot;/get&quot;)
public User getUser() throws JsonProcessingException &#123;
    User user = new User(1, &quot;KHighness&quot;, new Date());
    return user;
&#125;</code></pre>
<p>åºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<pre><code class="json">&#123;&quot;userName&quot;:&quot;KHighness&quot;&#125;</code></pre>
<p>å½“ç»„åæŒ‡å®šä¸º<code>AllUserFieldView</code>æ—¶ï¼Œåºåˆ—åŒ–æµ‹è¯•ç»“æœä¸ºï¼š</p>
<pre><code class="json">&#123;&quot;id&quot;:1,&quot;userName&quot;:&quot;KHighness&quot;,&quot;birth&quot;:&quot;2021-04-17&quot;&#125;</code></pre>
<br>
å‚è€ƒï¼š

<ul>
<li><a href="https://www.kancloud.cn/ahutchen/spring-boot-reference-guide/333370">è‡ªå®šä¹‰Jackson ObjectMapper</a></li>
<li><a href="https://mrbird.cc/Spring-Boot%20JSON.html">SpringBootä¸­çš„JSONæŠ€æœ¯</a></li>
</ul>
]]></content>
      <categories>
        <category>web</category>
      </categories>
      <tags>
        <tag>json</tag>
      </tags>
  </entry>
  <entry>
    <title>Chartjs</title>
    <url>/posts/50163/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>å‰è¨€</p>
</blockquote>
<p>å››æœˆäº†ï¼Œæ°´ä¸€ç¯‡åšå®¢å§ï¼Œå…³äº<code>hexo-tag-chart</code>æ’ä»¶çš„ä½¿ç”¨ï¼Œæ–‡æ¡£åªæœ‰ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå®˜æ–¹æ–‡æ¡£åªç»™å‡º<code>js</code>ç”¨æ³•ï¼Œè‡³äºæ€ä¹ˆä½¿ç”¨ä»¥åŠç”¨åˆ°ä½•ç§ç¨‹åº¦ï¼Œå°±çœ‹è‡ªå·±çš„é€ åŒ–å§ã€‚</p>
<p>ç¤ºä¾‹ï¼š<a href="https://shen-yu.gitee.io/2020/chartjs">æ²ˆå®‡å¤§ä½¬åšå®¢</a></p>
<p>æ–‡æ¡£ï¼š<a href="https://chartjs.bootcss.com/">ä¸­æ–‡å®˜æ–¹æ–‡æ¡£</a></p>
<h3 id="æ¯æœˆæ˜ç»†"><a href="#æ¯æœˆæ˜ç»†" class="headerlink" title="æ¯æœˆæ˜ç»†"></a>æ¯æœˆæ˜ç»†</h3><div style="width: 80%;margin: 0 auto">
    <canvas id="chart7718" style="height: 120px"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script type="text/javascript">
    var ctx = document.getElementById('chart7718').getContext('2d');
    var options = {
    type: 'line',
    data: {
        labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
        datasets: [{
        	label: '2020',
            borderColor: 'orange',
            backgroundColor: 'yellow',
			data: [0, 0, 0, 0, 0, 1, 0, 0, 1, 6, 5, 1], 
		},{
			label: '2021',
            borderColor: 'blue',
            backgroundColor: 'lightBlue',
			data: [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
		}]
    },
    options: {
        responsive: true,
        title: {
            display: true,
            text: 'æ¯æœˆæ˜ç»†'
        }
    }
};;
    new Chart(ctx, options);
</script>



<a id="more"></a>




<h3 id="å¹´åº¦ç»Ÿè®¡"><a href="#å¹´åº¦ç»Ÿè®¡" class="headerlink" title="å¹´åº¦ç»Ÿè®¡"></a>å¹´åº¦ç»Ÿè®¡</h3><div style="width: 100%;margin: 0 auto">
    <canvas id="chart1240" style="height: 100px"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script type="text/javascript">
    var ctx = document.getElementById('chart1240').getContext('2d');
    var options = {
    type: 'polarArea',
    data: {
        labels: ['2020', '2021'],
        datasets: [{
            backgroundColor: ['orange', 'blue'],
			data: [14, 1], 
		}]
    },
    options: {
        responsive: true,
        title: {
            display: true,
            text: 'åšå®¢ç»Ÿè®¡'
        }
    }
};;
    new Chart(ctx, options);
</script>



<h3 id="èƒ½åŠ›é›·è¾¾"><a href="#èƒ½åŠ›é›·è¾¾" class="headerlink" title="èƒ½åŠ›é›·è¾¾"></a>èƒ½åŠ›é›·è¾¾</h3><div style="width: 100%;margin: 0 auto">
    <canvas id="chart2038" style="height: 100px"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script type="text/javascript">
    var ctx = document.getElementById('chart2038').getContext('2d');
    var options = {
    type: 'radar',
    data: {
        labels: ['Java', 'MySQL', 'Redis', 'Spring', 'SpringBoot', 'SpringCloud Alibaba', 'Vue', 'TCP/IP', 'OS'],
        datasets: [{
            label: '2020',
            fill: true,
            borderColor: 'rgb(253, 100, 131)',
			pointHoverBackgroundColor: 'red',
			data: [0.5, 0.4, 0.4, 0.1, 0.5, 0.2, 0.2, 0.5, 0.3]
		},
		{
			label: '2021',
			fill: true,
			borderColor: 'rgb(100, 147, 208)',
			pointHoverBackgroundColor: 'blue', 
			data: [0.7, 0.7, 0.5, 0.5, 0.7, 0.5, 0.1, 0.6, 0.2]
        }]
    },
    options: {
        responsive: true,
        title: {
            display: true,
            text: 'èƒ½åŠ›é›·è¾¾'
        }
    }
};;
    new Chart(ctx, options);
</script>

]]></content>
      <categories>
        <category>Frontend</category>
      </categories>
      <tags>
        <tag>Chartjs</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL</title>
    <url>/posts/c24675b4/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="MySQLæ¦‚è¿°"><a href="#MySQLæ¦‚è¿°" class="headerlink" title="MySQLæ¦‚è¿°"></a>MySQLæ¦‚è¿°</h2><h3 id="CentOS7å®‰è£…"><a href="#CentOS7å®‰è£…" class="headerlink" title="CentOS7å®‰è£…"></a>CentOS7å®‰è£…</h3><blockquote>
<p>ä¸‹è½½RPMå®‰è£…åŒ…</p>
</blockquote>
<p>ä¸‹è½½: <a href="https://downloads.mysql.com/archives/community/">mysql download</a></p>
<p>å°†å››ä¸ªåŒ…ä¸‹è½½åç§»åŠ¨åˆ°optæ–‡ä»¶å¤¹ä¸‹</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314104200636.png" class="" title="s">



<a id="more"></a>



<blockquote>
<p>æ£€æŸ¥æ˜¯å¦å·²å®‰è£…MySQL</p>
</blockquote>
<p>å¦‚æœæ²¡æœ‰ä¿¡æ¯æ˜¾ç¤ºåˆ™è¡¨ç¤ºæœªå®‰è£…MySQL</p>
<pre><code class="shell">$ rpm -qa | grep -i mysql</code></pre>
<blockquote>
<p>å®‰è£…MySQL</p>
</blockquote>
<p><code>-i</code>ï¼šæ˜¾ç¤ºå¥—ä»¶çš„æ–‡ä»¶åˆ—è¡¨</p>
<p><code>-v</code>ï¼šæ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹</p>
<p><code>-h</code>ï¼šå¥—ä»¶å®‰è£…æ—¶åˆ—å‡ºæ ‡è®°</p>
<pre><code class="shell">$ rpm -ivh &lt;åŒ…å&gt;</code></pre>
<p>å®‰è£…é¡ºåºï¼š</p>
<ol>
<li>common</li>
<li>libs</li>
<li>client</li>
<li>server</li>
</ol>
<p>ä¾èµ–å†²çªï¼š</p>
<p>ç›´æ¥å¸è½½mariadb</p>
<p>è¯¦æƒ…å¦‚ä¸‹ï¼š</p>
<pre><code class="shell">[root@parak opt]# rpm -ivh mysql-community-common-8.0.20-1.el7.x86_64.rpm 
è­¦å‘Šï¼šmysql-community-common-8.0.20-1.el7.x86_64.rpm: å¤´V3 DSA/SHA1 Signature, å¯†é’¥ ID 5072e1f5: NOKEY
å‡†å¤‡ä¸­...                          ################################# [100%]
æ­£åœ¨å‡çº§/å®‰è£…...
   1:mysql-community-common-8.0.20-1.e################################# [100%]
[root@parak opt]# rpm -ivh mysql-community-libs-8.0.20-1.el7.x86_64.rpm 
è­¦å‘Šï¼šmysql-community-libs-8.0.20-1.el7.x86_64.rpm: å¤´V3 DSA/SHA1 Signature, å¯†é’¥ ID 5072e1f5: NOKEY
é”™è¯¯ï¼šä¾èµ–æ£€æµ‹å¤±è´¥ï¼š
    mariadb-libs è¢« mysql-community-libs-8.0.20-1.el7.x86_64 å–ä»£
[root@parak opt]# rpm -qa | grep mariadb
mariadb-libs-5.5.68-1.el7.x86_64
[root@parak opt]# rpm -e mariadb-libs-5.5.68-1.el7.x86_64
é”™è¯¯ï¼šä¾èµ–æ£€æµ‹å¤±è´¥ï¼š
    libmysqlclient.so.18()(64bit) è¢« (å·²å®‰è£) postfix-2:2.10.1-9.el7.x86_64 éœ€è¦
    libmysqlclient.so.18(libmysqlclient_18)(64bit) è¢« (å·²å®‰è£) postfix-2:2.10.1-9.el7.x86_64 éœ€è¦
[root@parak opt]# rpm -e --nodeps mariadb-libs-5.5.68-1.el7.x86_64
[root@parak opt]# rpm -ivh mysql-community-libs-8.0.20-1.el7.x86_64.rpm 
è­¦å‘Šï¼šmysql-community-libs-8.0.20-1.el7.x86_64.rpm: å¤´V3 DSA/SHA1 Signature, å¯†é’¥ ID 5072e1f5: NOKEY
å‡†å¤‡ä¸­...                          ################################# [100%]
æ­£åœ¨å‡çº§/å®‰è£…...
   1:mysql-community-libs-8.0.20-1.el7################################# [100%]
[root@parak opt]# rpm -ivh mysql-community-client-8.0.20-1.el7.x86_64.rpm 
è­¦å‘Šï¼šmysql-community-client-8.0.20-1.el7.x86_64.rpm: å¤´V3 DSA/SHA1 Signature, å¯†é’¥ ID 5072e1f5: NOKEY
å‡†å¤‡ä¸­...                          ################################# [100%]
æ­£åœ¨å‡çº§/å®‰è£…...
   1:mysql-community-client-8.0.20-1.e################################# [100%]
[root@parak opt]# rpm -ivh mysql-community-server-8.0.20-1.el7.x86_64.rpm 
è­¦å‘Šï¼šmysql-community-server-8.0.20-1.el7.x86_64.rpm: å¤´V3 DSA/SHA1 Signature, å¯†é’¥ ID 5072e1f5: NOKEY
å‡†å¤‡ä¸­...                          ################################# [100%]
æ­£åœ¨å‡çº§/å®‰è£…...
   1:mysql-community-server-8.0.20-1.e################################# [100%]</code></pre>
<blockquote>
<p>æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ</p>
</blockquote>
<ul>
<li>æ–¹å¼ä¸€ï¼šæŸ¥çœ‹mysqlç‰ˆæœ¬å·<code>mysqladmin --version</code></li>
<li>æ–¹å¼äºŒï¼šæŸ¥çœ‹æ˜¯å¦åˆ›å»ºäº†mysqlç”¨æˆ·(ç»„)<code>cat /etc/passwd | grep mysql</code></li>
</ul>
<pre><code class="shell">[root@parak opt]# mysqladmin --version
mysqladmin  Ver 8.0.20 for Linux on x86_64 (MySQL Community Server - GPL)
[root@parak opt]# cat /etc/passwd | grep mysql
mysql:x:27:27:MySQL Server:/var/lib/mysql:/bin/false</code></pre>
<blockquote>
<p>å¯åŠ¨MySQLæœåŠ¡</p>
</blockquote>
<ul>
<li>å¯åŠ¨MySQLï¼š<code>systemctl start mysqld</code></li>
<li>åœæ­¢MySQLï¼š<code>systemctl stop mysqld</code></li>
</ul>
<blockquote>
<p>ç™»å½•MySQL</p>
</blockquote>
<p>ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>æ–¹å¼ä¸€ï¼šæŸ¥çœ‹MySQLåˆå§‹å¯†ç <code> cat /var/log/mysqld.log | grep password</code></li>
<li>æ–¹å¼äºŒï¼šä¿®æ”¹<code>my.cnf</code>é…ç½®æ–‡ä»¶ç”¨äºè·³è¿‡å¯†ç ï¼Œåœ¨<code>[mysqld]</code>ä¸‹æ·»åŠ <code> skip-grant-tables</code></li>
</ul>
<p>æ¨èä½¿ç”¨ç¬¬ä¸€ç§ï¼Œå› ä¸ºåœ¨MySQL8åœ¨è·³è¿‡ç™»å½•çš„çŠ¶æ€ä¸‹æ˜¯ä¸å…è®¸ä¿®æ”¹ç™»å½•å¯†ç çš„ã€‚</p>
<pre><code class="shell"># ç™»å½•mysql
$ mysql -uroot -p
Enter password:
# ä¿®æ”¹æ ¡éªŒå¯†ç ç­–ç•¥ç­‰çº§
$ mysql&gt; set global validate_password.policy=LOW;
# è®¾ç½®å¯†ç æœ€å°é•¿åº¦
$ mysql&gt; set global validate_password.length=1;
# æœ€åè®¾ç½®å¯†ç 
$ ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &lt;password&gt;;</code></pre>
<blockquote>
<p>Navicatè¿æ¥äº§ç”Ÿé—®é¢˜</p>
</blockquote>
<p>ï¼ˆ1ï¼‰HOST <IP> is not allowed to connect to this mysql server</p>
<p>è§£å†³ï¼šå…³é—­é˜²ç«å¢™ï¼Œæ›´æ–°å¯è¿æ¥IP</p>
<pre><code class="shell"># æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
$ systemctl status firewalld.service
# å…³é—­é˜²ç«å¢™
$ systemctl stop firewalld.service
# ç¦æ­¢è‡ªå¯åŠ¨
$ systemctl disable firewalld.service
# è®©æ‰€æœ‰IPéƒ½å¯ä»¥è¿æ¥MySQL
$ mysql&gt; update user set host=&#39;%&#39; where user=&#39;root&#39;;
# åˆ·æ–°æƒé™
$ mysql&gt; flush privileges;</code></pre>
<p>ï¼ˆ2ï¼‰Client does not support authentication protocol requested by server</p>
<p>è§£å†³ï¼šæ›´æ”¹åŠ å¯†è§„åˆ™ï¼Œæ›´æ–°ç”¨æˆ·å¯†ç </p>
<pre><code class="shell"># #æ›´æ”¹åŠ å¯†æ–¹å¼
$ mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;password&#39; PASSWORD EXPIRE NEVER; 
# æ›´æ–°ç”¨æˆ·å¯†ç 
$ mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY &#39;&lt;password&gt;&#39;;</code></pre>
<blockquote>
<p>è®¾ç½®å¼€æœºè‡ªå¯åŠ¨</p>
</blockquote>
<p>æŒ‰ç…§ä»¥ä¸Šå®‰è£…æ–¹å¼mysqlæœåŠ¡æ˜¯é»˜è®¤å¼€æœºè‡ªå¯åŠ¨çš„ï¼Œå¯ä»¥é€šè¿‡<code>systemctl list-unit-files </code>æŸ¥çœ‹å¼€æœºå¯åŠ¨é¡¹</p>
<pre><code class="shell">[root@parak mysql]# systemctl list-unit-files | grep mysql
mysqld.service                                enabled 
mysqld@.service                               disabled</code></pre>
<p>å¦‚æœä¸æ˜¯å¼€æœºè‡ªå¯åŠ¨ï¼Œå¯ä»¥é€šè¿‡<code>ntsysv</code>å¯ç”¨æœåŠ¡ï¼Œ<code>[]</code>ä¸­è®¾ç½®<code>*</code>å³å¯ä½¿å…¶å¼€æœºè‡ªå¯åŠ¨ï¼š</p>
<ul>
<li>ä¸Šä¸‹é”®ï¼šå¯ä»¥åœ¨ä¸­é—´çš„æ–¹æ¡†å½“ä¸­ï¼Œåœ¨å„ä¸ªæœåŠ¡ä¹‹é—´ç§»åŠ¨</li>
<li>ç©ºæ ¼é”®ï¼šå¯ä»¥ç”¨æ¥é€‰æ‹©ä½ æ‰€éœ€è¦çš„æœåŠ¡ï¼Œ[*]è¡¨ç¤ºå¼€èµ·å¯åŠ¨</li>
<li>tabé”®ï¼šå¯ä»¥åœ¨æ–¹æ¡†ã€OKã€Cancelä¹‹é—´ç§»åŠ¨</li>
<li>F1é”®ï¼šå¯ä»¥æ˜¾ç¤ºè¯¥æœåŠ¡çš„è¯´æ˜</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314131906998.png" class="" title="image-20210314131906998">



<h3 id="Dockerå®‰è£…"><a href="#Dockerå®‰è£…" class="headerlink" title="Dockerå®‰è£…"></a>Dockerå®‰è£…</h3><blockquote>
<p>æ‹‰å–é•œåƒ</p>
</blockquote>
<pre><code class="shell">$ docker pull mysql:8.0.20</code></pre>
<blockquote>
<p>åˆ›å»ºæŒ‚è½½çš„æ•°æ®å’Œé…ç½®æ–‡ä»¶å¤¹</p>
</blockquote>
<pre><code class="shell">$ mkdir -p /home/mysql/data /home/mysql/conf</code></pre>
<blockquote>
<p>å…ˆå¯åŠ¨MySQLå®¹å™¨</p>
</blockquote>
<pre><code class="shell">$ docker run --name mysql -d -p 3306:3306 \
-e MYSQL_ROOT_PASSWORD=&lt;password&gt; mysql:8.0.20</code></pre>
<blockquote>
<p>è¿›å…¥å®¹å™¨æŸ¥çœ‹é…ç½®æ–‡ä»¶ä½ç½®</p>
</blockquote>
<pre><code class="shell">$ docker exec -it mysql bash
$ mysql --help | grep my.cnf
                      order of preference, my.cnf, $MYSQL_TCP_PORT,
/etc/my.cnf /etc/mysql/my.cnf ~/.my.cnf 
$ exit</code></pre>
<blockquote>
<p>å°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°æŒ‚è½½é…ç½®æ–‡ä»¶å¤¹</p>
</blockquote>
<pre><code class="shell">$ docker cp mysql:/etc/mysql/my.cnf /home/mysql/conf</code></pre>
<blockquote>
<p>åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ </p>
</blockquote>
<pre><code class="shell"># è¡¨åç§°å¤§å°å†™ä¸æ•æ„Ÿ
lower_case_table_names=1</code></pre>
<blockquote>
<p>å…ˆåœæ­¢å¹¶åˆ é™¤å®¹å™¨</p>
</blockquote>
<pre><code class="shell">$ docker stop mysql &amp;&amp; docker rm mysql</code></pre>
<blockquote>
<p>é‡æ–°è¿è¡ŒMySQLå®¹å™¨</p>
</blockquote>
<pre><code class="shell">$ docker run --name mysql \
-d -p 3306:3306  \
-e MYSQL_ROOT_PASSWORD=&lt;password&gt; \
--mount type=bind,src=/home/mysql/conf/my.cnf,dst=/etc/mysql/my.cnf \
--mount type=bind,src=/home/mysql/data,dst=/var/lib/mysql \
--restart=on-failure:3 \
 mysql:8.0.20</code></pre>
<blockquote>
<p>Navicatæ— æ³•è¿æ¥</p>
</blockquote>
<pre><code class="sh">$ docker exec -it mysql bash
$ mysql -u root -p&lt;password&gt;
$ ALTER USER &#39;root&#39;@&#39;%&#39; IDENTIFIED WITH mysql_native_password BY &#39;&lt;password&gt;&#39;;</code></pre>
<h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><blockquote>
<p>å®‰è£…ç›®å½•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">è·¯å¾„</th>
<th align="center">è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td align="center">/var/lib/mysql/</td>
<td align="center">æ•°æ®åº“æ–‡ä»¶çš„å­˜æ”¾ä½ç½®</td>
</tr>
<tr>
<td align="center">/usr/share/mysql-8.0/</td>
<td align="center">é…ç½®æ–‡ä»¶ç›®å½•</td>
</tr>
<tr>
<td align="center">/usr/bin/</td>
<td align="center">ç›¸å…³å‘½ä»¤ç›®å½•</td>
</tr>
</tbody></table>
<blockquote>
<p>æŸ¥çœ‹ç¼–ç </p>
</blockquote>
<pre><code class="shell">mysql&gt; show variables like &#39;character%&#39;;
+--------------------------+--------------------------------+
| Variable_name            | Value                          |
+--------------------------+--------------------------------+
| character_set_client     | utf8mb4                        |
| character_set_connection | utf8mb4                        |
| character_set_database   | utf8mb4                        |
| character_set_filesystem | binary                         |
| character_set_results    | utf8mb4                        |
| character_set_server     | utf8mb4                        |
| character_set_system     | utf8                           |
| character_sets_dir       | /usr/share/mysql-8.0/charsets/ |
+--------------------------+--------------------------------+</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒMySQL 8çš„é»˜è®¤ç¼–ç æ ¼å¼é™¤äº†æ–‡ä»¶ç³»ç»Ÿæ˜¯äºŒè¿›åˆ¶ç¼–ç ä»¥å¤–ï¼Œå·²ç»å…¨éƒ¨æ”¹ä¸ºutf8å’Œutf8mb4(æ‹¥æœ‰æ¯”utf8æ›´å¥½çš„å…¼å®¹æ€§)ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦å†ä¿®æ”¹ã€‚</p>
<p>æ³¨æ„ï¼šä½¿ç”¨Navicatè¿æ¥MySQLæ—¶ç¼–ç åº”è®¾ç½®ä¸ºè‡ªåŠ¨ï¼Œåˆ‡å‹¿è®¾ç½®ä¸ºutf8ï¼Œå¦åˆ™ä¼šä¸­æ–‡ä¹±ç ã€‚</p>
<h3 id="é€»è¾‘æ¶æ„"><a href="#é€»è¾‘æ¶æ„" class="headerlink" title="é€»è¾‘æ¶æ„"></a>é€»è¾‘æ¶æ„</h3><blockquote>
<p>ä¼˜åŠ¿</p>
</blockquote>
<p>å’Œå…¶ä»–æ•°æ®åº“ç›¸æ¯”ï¼ŒMySQLæœ‰ç‚¹ä¸ä¼—ä¸åŒï¼Œå®ƒçš„æ¶æ„å¯ä»¥åœ¨å¤šç§ä¸åŒåœºæ™¯ä¸­åº”ç”¨å¹¶å‘æŒ¥è‰¯å¥½ä½œç”¨å’Œã€‚ä¸»è¦ä½“ç°åœ¨å­˜å‚¨å¼•æ“çš„æ¶æ„ä¸Šï¼Œæ’ä»¶å¼çš„å­˜å‚¨å¼•æ“æ¶æ„å°†æŸ¥è¯¢å¤„ç†å’Œå…¶ä»–çš„ç³»ç»Ÿä»»åŠ¡ä»¥åŠæ•°æ®çš„å­˜å‚¨æå–ç›¸åˆ†ç¦»ã€‚è¿™ç§æ¶æ„å¯ä»¥æ ¹æ®ä¸šåŠ¡çš„éœ€æ±‚å’Œå®é™…éœ€è¦é€‰æ‹©åˆé€‚çš„å­˜å‚¨å¼•æ“ã€‚</p>
<blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210324110838854.png" class="" title="image-20210324110838854">



<blockquote>
<p>è¯¦è§£</p>
</blockquote>
<ul>
<li>è¿æ¥å±‚ï¼šæœ€ä¸Šå±‚æ˜¯ä¸€äº›å®¢æˆ·ç«¯å’Œè¿æ¥æœåŠ¡ï¼ŒåŒ…å«æœ¬åœ°socké€šä¿¡å’Œå¤§å¤šæ•°åŸºäºå®¢æˆ·ç«¯/æœåŠ¡ç«¯å·¥å…·å®ç°çš„ç±»ä¼¼äºTCP/IPé€šä¿¡ã€‚ä¸»è¦å®Œæˆä¸€äº›ç±»ä¼¼äºè¿æ¥å¤„ç†ã€æˆæƒè®¤è¯åŠç›¸å…³çš„å®‰å…¨æ–¹æ¡ˆã€‚åœ¨è¯¥å±‚ä¸Šå¼•å…¥äº†çº¿ç¨‹æ± çš„æ¦‚å¿µï¼Œæœªé€šè¿‡è®¤è¯å®‰å…¨æ¥å…¥çš„å®¢æˆ·ç«¯æä¾›çº¿ç¨‹ã€‚åŒæ ·åœ¨è¯¥å±‚ä¸Šå¯ä»¥å®ç°åŸºäºSSLçš„å®‰å…¨è¿æ¥ã€‚æœåŠ¡å™¨ä¹Ÿä¼šä¸ºå®‰å…¨æ¥å…¥çš„æ¯ä¸ªå®¢æˆ·ç«¯éªŒè¯å®ƒæ‰€å…·æœ‰çš„æ“ä½œæƒé™ã€‚</li>
<li>æœåŠ¡å±‚ï¼šç¬¬äºŒå±‚æ¶æ„ä¸»è¦å®Œæˆå¤§å¤šæ•°çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå¦‚SQLæ¥å£ï¼Œå¹¶å®Œæˆç¼“å­˜çš„æŸ¥è¯¢ï¼ŒSQLçš„åˆ†æå’Œä¼˜åŒ–åŠéƒ¨åˆ†å†…ç½®å‡½æ•°çš„æ‰§è¡Œã€‚æ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½ä¹Ÿåœ¨è¿™ä¸€å±‚å®ç°ï¼Œå¦‚è¿‡ç¨‹ã€å‡½æ•°ç­‰ã€‚åœ¨è¯¥å±‚ï¼ŒæœåŠ¡å™¨ä¼šè§£ææŸ¥è¯¢å¹¶åˆ›å»ºç›¸åº”çš„å†…éƒ¨è§£ææ ‘ï¼Œå¹¶å¯¹å…¶å®Œæˆç›¸åº”çš„ä¼˜åŒ–å¦‚ç¡®å®šæŸ¥è¯¢è¡¨çš„é¡ºåºï¼Œæ˜¯å¦åˆ©ç”¨ç´¢å¼•ç­‰ï¼Œæœ€åç”Ÿæˆç›¸åº”çš„æ‰§è¡Œæ“ä½œã€‚å¦‚æœæ˜¯selectè¯­å¥ï¼ŒæœåŠ¡å™¨è¿˜ä¼šæŸ¥è¯¢å†…éƒ¨çš„ç¼“å­˜ã€‚å¦‚æœç¼“å­˜ç©ºé—´è¶³å¤Ÿå¤§ï¼Œè¿™æ ·åœ¨è§£å†³å¤§é‡è¯»æ“ä½œçš„ç¯å¢ƒä¸­èƒ½å¤Ÿå¾ˆå¥½çš„æå‡ç³»ç»Ÿçš„æ€§èƒ½ã€‚</li>
<li>å¼•æ“å±‚ï¼šå­˜å‚¨å¼•æ“å±‚ï¼Œå­˜å‚¨å¼•æ“çœŸæ­£çš„è´Ÿè´£äº†MySQLä¸­æ•°æ®çš„å­˜å‚¨å’Œæå–ï¼ŒæœåŠ¡å™¨é€šè¿‡APIä¸å­˜å‚¨å¼•æ“è¿›è¡Œé€šä¿¡ã€‚ä¸åŒçš„å­˜å‚¨å¼•æ“å…·æœ‰çš„åŠŸèƒ½ä¸åŒï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€è¦è¿›è¡Œé€‰å–ã€‚</li>
<li>å­˜å‚¨å±‚ï¼šæ•°æ®å­˜å‚¨å±‚ï¼Œä¸»è¦æ˜¯å°†æ•°æ®å­˜å‚¨åœ¨è¿è¡Œäºè£¸è®¾å¤‡çš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼Œå¹¶å®Œæˆä¸å­˜å‚¨å¼•æ“çš„äº¤äº’ã€‚</li>
</ul>
<h3 id="å­˜å‚¨å¼•æ“"><a href="#å­˜å‚¨å¼•æ“" class="headerlink" title="å­˜å‚¨å¼•æ“"></a>å­˜å‚¨å¼•æ“</h3><blockquote>
<p>æŸ¥çœ‹å­˜å‚¨å¼•æ“</p>
</blockquote>
<pre><code class="shell">$ mysql&gt;show engines;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314164337734.png" class="" title="image-20210314164337734">



<blockquote>
<p>MyISAMå’ŒInnoDB</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å¯¹æ¯”é¡¹</th>
<th align="center">MyISAM</th>
<th align="center">InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ä¸»å¤–é”®</td>
<td align="center">ä¸æ”¯æŒ</td>
<td align="center">æ”¯æŒ</td>
</tr>
<tr>
<td align="center">äº‹åŠ¡</td>
<td align="center">ä¸æ”¯æŒ</td>
<td align="center">æ”¯æŒ</td>
</tr>
<tr>
<td align="center">è¡Œè¡¨é”</td>
<td align="center">è¡¨é”ï¼Œå³ä½¿æ“ä½œä¸€æ¡è®°å½•ä¹Ÿä¼šé”ä½æ•´ä¸ªè¡¨ï¼Œä¸åˆé€‚é«˜å¹¶å‘çš„æ“ä½œ</td>
<td align="center">è¡Œé”ï¼Œæ“ä½œæ—¶åªé”ä½æŸä¸€è¡Œï¼Œä¸å¯¹å…¶ä»–è¡Œæœ‰å½±å“ï¼Œé€‚åˆé«˜å¹¶å‘çš„æ“ä½œ</td>
</tr>
<tr>
<td align="center">ç¼“å­˜</td>
<td align="center">åªç¼“å­˜ç´¢å¼•ï¼Œä¸ç¼“å­˜çœŸå®æ•°æ®</td>
<td align="center">ä¸ä»…ç¼“å­˜ç´¢å¼•è¿˜è¦ç¼“å­˜çœŸå®æ•°æ®ï¼Œå¯¹å†…å­˜è¦æ±‚è¾ƒé«˜ï¼Œè€Œä¸”å†…å­˜å¤§å°å¯¹æ€§èƒ½æœ‰å†³å®šæ€§çš„å½±å“ã€‚</td>
</tr>
<tr>
<td align="center">è¡¨ç©ºé—´</td>
<td align="center">å°</td>
<td align="center">å¤§</td>
</tr>
<tr>
<td align="center">å…³æ³¨ç‚¹</td>
<td align="center">æ€§èƒ½</td>
<td align="center">äº‹åŠ¡</td>
</tr>
<tr>
<td align="center">é»˜è®¤å®‰è£…</td>
<td align="center">Y</td>
<td align="center">Y</td>
</tr>
</tbody></table>
<blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>MySQL 8.0ï¼šä¸å†æ”¯æŒæŸ¥è¯¢ç¼“å­˜ã€‚</p>
<p>MySQLå›¢é˜Ÿåšå®¢ï¼š<a href="https://mysqlserverteam.com/mysql-8-0-retiring-support-for-the-query-cache/">https://mysqlserverteam.com/mysql-8-0-retiring-support-for-the-query-cache/</a></p>
<pre><code>å°½ç®¡MySQL Query Cacheæ—¨åœ¨æé«˜æ€§èƒ½ï¼Œä½†å®ƒå­˜åœ¨ä¸¥é‡çš„å¯ä¼¸ç¼©æ€§é—®é¢˜ï¼Œå¹¶ä¸”å¾ˆå®¹æ˜“æˆä¸ºä¸¥é‡çš„ç“¶é¢ˆã€‚

è‡ªMySQL 5.6ï¼ˆ2013ï¼‰ä»¥æ¥ï¼Œé»˜è®¤æƒ…å†µä¸‹å·²ç¦ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Œå› ä¸ºä¼—æ‰€å‘¨çŸ¥ï¼Œå®ƒä¸èƒ½ä¸å¤šæ ¸è®¡ç®—æœºä¸Šåœ¨é«˜ååé‡å·¥ä½œè´Ÿè½½æƒ…å†µä¸‹è¿›è¡Œæ‰©å±•ã€‚

æˆ‘ä»¬è€ƒè™‘äº†å¯ä»¥å¯¹æŸ¥è¯¢ç¼“å­˜è¿›è¡Œå“ªäº›æ”¹è¿›ï¼Œä»¥åŠæˆ‘ä»¬å¯ä»¥è¿›è¡Œçš„ä¼˜åŒ–ï¼Œè¿™äº›ä¼˜åŒ–å¯ä»¥æ”¹å–„æ‰€æœ‰å·¥ä½œè´Ÿè½½ã€‚

è™½ç„¶è¿™äº›é€‰æ‹©æœ¬èº«æ˜¯æ­£äº¤çš„ï¼Œä½†å·¥ç¨‹èµ„æºæ˜¯æœ‰é™çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æ­£åœ¨è½¬å˜æˆ˜ç•¥ï¼ŒæŠ•èµ„äºæ›´æ™®éé€‚ç”¨äºæ‰€æœ‰å·¥ä½œè´Ÿè½½çš„æ”¹è¿›ã€‚

å»ºè®®æŠŠç¼“å­˜æ”¾åˆ°å®¢æˆ·ç«¯ã€‚</code></pre>
<blockquote>
<p>Alibabaé€‰æ‹©</p>
</blockquote>
<ul>
<li>Perconaä¸ºMySQLæ•°æ®åº“æœåŠ¡è¿›è¡Œäº†æ”¹è¿›ï¼Œåœ¨åŠŸèƒ½å’Œæ€§èƒ½ä¸Šè¾ƒMySQLæœ‰ç€å¾ˆæ˜¾è‘—çš„æå‡ã€‚è¯¥ç‰ˆæœ¬æå‡äº†åœ¨é«˜è´Ÿè½½æƒ…å†µä¸‹çš„InnoDBçš„æ€§èƒ½ã€ä¸ºDBAæä¾›äº†ä¸€äº›éå¸¸æœ‰ç”¨çš„æ€§èƒ½è¯Šæ–­å·¥å…·ï¼›å¦å¤–æœ‰æ›´å¤šçš„å‚æ•°å’Œå‘½ä»¤æ¥æ§åˆ¶æœåŠ¡å™¨è¡Œä¸ºã€‚</li>
<li>é˜¿é‡Œå·´å·´å¤§éƒ¨åˆ†MySQLæ•°æ®åº“å…¶å®ä½¿ç”¨çš„æ—¶perconaçš„åŸå‹åŠ ä»¥ä¿®æ”¹ã€‚é˜¿é‡Œæ–°å»ºäº†ä¸€æ¬¾å­˜å‚¨å¼•æ“å«xtradbå®Œå…¨å¯ä»¥æ›¿ä»£innodbï¼Œå¹¶ä¸”åœ¨æ€§èƒ½å’Œå¹¶å‘ä¸Šåšå¾—æ›´å¥½ã€‚</li>
</ul>
<h2 id="ç´¢å¼•ä¼˜åŒ–"><a href="#ç´¢å¼•ä¼˜åŒ–" class="headerlink" title="ç´¢å¼•ä¼˜åŒ–"></a>ç´¢å¼•ä¼˜åŒ–</h2><h3 id="ç´¢å¼•ç®€ä»‹"><a href="#ç´¢å¼•ç®€ä»‹" class="headerlink" title="ç´¢å¼•ç®€ä»‹"></a>ç´¢å¼•ç®€ä»‹</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>MySQLå®˜æ–¹å¯¹ç´¢å¼•çš„å®šä¹‰ä¸ºï¼šç´¢å¼•æ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„ã€‚</p>
<p>å¯ä»¥å¾—åˆ°ç´¢å¼•çš„æœ¬è´¨ï¼šç´¢å¼•æ˜¯æ•°æ®ç»“æ„ã€‚</p>
<p>ç®€å•ç†è§£ï¼šæ’å¥½åºçš„å¿«é€ŸæŸ¥æ‰¾æ•°æ®ç»“æ„ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ç´¢å¼•æœ¬èº«ä¹Ÿå¾ˆå¤§ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚</p>
<p>æˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ç‰¹åˆ«æŒ‡æ˜ï¼Œéƒ½æ˜¯æŒ‡Bæ ‘ï¼ˆå¤šè·¯æœç´¢æ ‘ï¼Œä¸ä¸€å®šæ˜¯äºŒå‰æ ‘ï¼‰ç»“æ„çš„ç´¢å¼•ã€‚</p>
<p>å…¶ä¸­èšé›†ç´¢å¼•ï¼Œæ¬¡è¦ç´¢å¼•ï¼Œå¤åˆç´¢å¼•ï¼Œå‰ç¼€ç´¢å¼•ï¼Œå”¯ä¸€ç´¢å¼•é»˜è®¤éƒ½æ˜¯ä½¿ç”¨B+æ ‘ç´¢å¼•ï¼Œç»Ÿç§°ç´¢å¼•ã€‚é™¤äº†B+æ ‘è¿™ç§ç±»å‹çš„ç´¢å¼•ä¹‹å¤–ï¼Œè¿˜æœ‰å“ˆå¸Œç´¢å¼•ç­‰ã€‚</p>
<blockquote>
<p>ä¼˜åŠ¿</p>
</blockquote>
<p>ç±»ä¼¼äºå¤§å­¦å›¾ä¹¦é¦†å»ºæ•°ç›®ç´¢å¼•ï¼Œæé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½æ•°æ®åº“çš„IOæˆæœ¬ã€‚</p>
<p>é€šè¿‡ç´¢å¼•åˆ—é˜Ÿæ•°æ®è¿›è¡Œæ’åºï¼Œé™ä½æ•°æ®æ’åºçš„æˆæœ¬ï¼Œé™ä½äº†CPUçš„æ¶ˆè€—ã€‚</p>
<blockquote>
<p>åŠ£åŠ¿</p>
</blockquote>
<p>è™½ç„¶ç´¢å¼•å¤§å¤§æé«˜äº†æŸ¥è¯¢é€Ÿåº¦ï¼ŒåŒæ—¶ä¼šé™ä½è¡¨çš„æ›´æ–°é€Ÿåº¦ï¼Œå¦‚å¯¹è¡¨è¿›è¡ŒINSERTã€UPDATEå’ŒDELETEã€‚å› ä¸ºæ›´æ–°è¡¨æ—¶ï¼ŒMySQLä¸ä»…è¦ä¿å­˜æ•°æ®ï¼Œè¿˜è¦ä¿å­˜ä¸€ä¸‹ç´¢å¼•æ–‡ä»¶æ¯æ¬¡æ›´æ–°æ·»åŠ äº†ç´¢å¼•åˆ—çš„å­—æ®µï¼Œéƒ½ä¼šè°ƒæ•´å› ä¸ºæ›´æ–°æ‰€å¸¦æ¥çš„é”®å€¼å˜åŒ–åçš„ç´¢å¼•ä¿¡æ¯ã€‚</p>
<p>ç´¢å¼•åªæ˜¯æé«˜æ•ˆç‡çš„ä¸€ä¸ªå› ç´ ï¼Œå¦‚æœä½ çš„MySQLæœ‰å¤§æ•°æ®é‡çš„è¡¨ï¼Œå°±éœ€è¦èŠ±æ—¶é—´ç ”ç©¶å»ºç«‹æœ€ä¼˜ç§€çš„ç´¢å¼•ï¼Œæˆ–ä¼˜åŒ–æŸ¥è¯¢ã€‚</p>
<h3 id="ç´¢å¼•åˆ†ç±»"><a href="#ç´¢å¼•åˆ†ç±»" class="headerlink" title="ç´¢å¼•åˆ†ç±»"></a>ç´¢å¼•åˆ†ç±»</h3><blockquote>
<p>å•å€¼ç´¢å¼•</p>
</blockquote>
<p>ä¸€ä¸ªç´¢å¼•åˆ—åªåŒ…å«å•ä¸ªåˆ—ï¼Œä¸€ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ªç´¢å¼•ã€‚</p>
<blockquote>
<p>å”¯ä¸€ç´¢å¼•</p>
</blockquote>
<p>ç´¢å¼•åˆ—çš„å€¼å¿…é¡»å”¯ä¸€ï¼Œä½†å…è®¸æœ‰ç©ºå€¼ã€‚</p>
<blockquote>
<p>å¤åˆç´¢å¼•</p>
</blockquote>
<p>ä¸€ä¸ªç´¢å¼•åŒ…å«å¤šä¸ªåˆ—ã€‚</p>
<blockquote>
<p>è¦†ç›–ç´¢å¼•</p>
</blockquote>
<p>SQLåªéœ€è¦é€šè¿‡ç´¢å¼•å°±å¯ä»¥è¿”å›æŸ¥è¯¢æ‰€éœ€è¦çš„æ•°æ®ï¼Œè€Œä¸å¿…é€šè¿‡äºŒçº§ç´¢å¼•æŸ¥åˆ°ä¸»é”®ä¹‹åå†å»æŸ¥è¯¢æ•°æ®ï¼Œå³æŸ¥è¯¢å­—æ®µä¸ºç´¢å¼•å­—æ®µã€‚</p>
<blockquote>
<p>åŸºæœ¬è¯­æ³•</p>
</blockquote>
<ul>
<li>åˆ›å»º</li>
</ul>
<pre><code class="mysql">CREATE [UNIQUE] INDEX &lt;index_name&gt; ON &lt;table_name&gt;(&lt;column_name&gt;(length));
ALTER &lt;table_name&gt; ADD [UNIQUE] INDEX &lt;index_name&gt; ON (&lt;column_name&gt;(length));</code></pre>
<ul>
<li>åˆ é™¤</li>
</ul>
<pre><code class="mysql">DROP INDEX &lt;index_name&gt; ON &lt;table_name&gt;;</code></pre>
<ul>
<li>æŸ¥çœ‹</li>
</ul>
<pre><code class="sql">SHOW INDEX FROM &lt;table_name&gt;;</code></pre>
<ul>
<li>ALTER</li>
</ul>
<pre><code class="mysql">-- æ·»åŠ ä¸»é”®ï¼Œå³å”¯ä¸€ç´¢å¼•
ALTER TABLE &lt;table_name&gt; PRIMARY KEY (column_list);
-- åˆ›å»ºå”¯ä¸€ç´¢å¼•
ALTER TABLE &lt;table_name&gt; UNIQUE &lt;index_name&gt;(column_list);
-- æ·»åŠ æ™®é€šç´¢å¼•
ALTER TABLE &lt;table_name&gt; INDEX &lt;index_name&gt;(column_list);
-- æŒ‡å®šå…¨æ–‡ç´¢å¼•
ALTER TABLE &lt;table_name&gt; FULLTEXT index_name&gt;(column_list);</code></pre>
<h3 id="ç´¢å¼•ç»“æ„"><a href="#ç´¢å¼•ç»“æ„" class="headerlink" title="ç´¢å¼•ç»“æ„"></a>ç´¢å¼•ç»“æ„</h3><blockquote>
<p>ç´¢å¼•</p>
</blockquote>
<ul>
<li>BTREE </li>
<li>HASH</li>
<li>FULL-TEXT</li>
<li>R-TREE</li>
</ul>
<blockquote>
<p>éœ€è¦å»ºç«‹ç´¢å¼•çš„æƒ…å†µ</p>
</blockquote>
<ul>
<li>ä¸»é”®è‡ªåŠ¨å»ºç«‹å”¯ä¸€ç´¢å¼•</li>
<li>é¢‘ç¹ä½œä¸ºæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µåº”è¯¥åˆ›å»ºç´¢å¼•</li>
<li>æŸ¥è¯¢ä¸­ä¸å…¶å®ƒè¡¨å…³è”çš„å­—æ®µï¼Œå¤–é”®å…³ç³»å»ºç«‹ç´¢å¼•</li>
<li>é¢‘ç¹æ›´æ–°çš„å­—æ®µä¸é€‚åˆåˆ›å»ºç´¢å¼•</li>
<li>Whereæ¡ä»¶é‡Œç”¨ä¸åˆ°çš„å­—æ®µä¸åˆ›å»ºç´¢å¼•</li>
<li>å•å€¼/ç»„åˆç´¢å¼•çš„é€‰æ‹©ï¼Œåœ¨é«˜å¹¶å‘ä¸‹å€¾å‘åˆ›å»ºç»„åˆç´¢å¼•</li>
<li>æŸ¥è¯¢ä¸­æ’åºçš„å­—æ®µï¼Œæ’åºå­—æ®µè‹¥é€šè¿‡ç´¢å¼•å»è®¿é—®å°†å¤§å¤§æé«˜æ’åºé€Ÿåº¦</li>
<li>æŸ¥è¯¢ä¸­ç»Ÿè®¡æˆ–è€…åˆ†ç»„å­—æ®µ</li>
</ul>
<blockquote>
<p>ä¸éœ€è¦å»ºç«‹ç´¢å¼•çš„æƒ…å†µ</p>
</blockquote>
<ul>
<li>è¡¨è®°å½•å¤ªå°‘  [åŸå› ï¼šä½äºç™¾ä¸‡æ•°çš„è¡¨MySQLè¿˜æ˜¯æ‰›å¾—ä½çš„ã€‚]</li>
<li>ç»å¸¸å¢åˆ æ”¹çš„è¡¨  [åŸå› ï¼šæé«˜äº†æŸ¥è¯¢é€Ÿåº¦ï¼ŒåŒæ—¶å´ä¼šé™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦ï¼Œå¦‚å¯¹è¡¨è¿›è¡ŒINSERTã€UPDATEå’ŒDELETEã€‚å› ä¸ºæ›´æ–°è¡¨æ—¶ï¼ŒMySQLä¸ä»…è¦ä¿å­˜æ•°æ®ï¼Œè¿˜è¦ä¿å­˜ä¸€ä¸‹ç´¢å¼•æ–‡ä»¶ã€‚]</li>
<li>æ•°æ®é‡å¤ä¸”åˆ†å¸ƒå‡åŒ€çš„è¡¨å­—æ®µï¼Œå› æ­¤åº”è¯¥åªä¸ºæœ€ç»å¸¸æŸ¥è¯¢å’Œæœ€ç»å¸¸æ’åºçš„æ•°æ®åˆ—å»ºç«‹ç´¢å¼•ã€‚æ³¨æ„ï¼Œå¦‚æœæŸä¸ªæ•°æ®åˆ—åŒ…å«è®¸å¤šé‡å¤çš„å†…å®¹ï¼Œä¸ºå®ƒå»ºç«‹ç´¢å¼•å°±æ²¡æœ‰å¤ªå¤§çš„å®é™…æ•ˆæœ  [ä¾‹å¦‚ï¼šæ€§åˆ«ç­‰å­—æ®µã€‚]</li>
</ul>
<h3 id="JoinæŸ¥è¯¢"><a href="#JoinæŸ¥è¯¢" class="headerlink" title="JoinæŸ¥è¯¢"></a>JoinæŸ¥è¯¢</h3><blockquote>
<p>joinè¯´æ˜</p>
</blockquote>
<ul>
<li>LEFT JOINï¼šè¿”å›å·¦è¡¨ä¸­çš„æ‰€æœ‰è®°å½•å’Œå³è¡¨ä¸­è”ç»“å­—æ®µç›¸ç­‰çš„è®°å½•ã€‚<ul>
<li>æ ¼å¼ï¼š<code>SELECT ... table1 LEFT JOIN table2 ON ...</code></li>
<li>è¯´æ˜ï¼šä¼šå–å¾—table1å…¨éƒ¨è®°å½•ï¼Œå³ä½¿table2æ²¡æœ‰åŒ¹é…è®°å½•</li>
</ul>
</li>
<li>RIGHT JOINï¼šè¿”å›å³è¡¨ä¸­çš„æ‰€æœ‰è®°å½•å’Œå·¦è¡¨ä¸­è”ç»“å­—æ®µç›¸ç­‰çš„è®°å½•ã€‚<ul>
<li>æ ¼å¼ï¼š<code>SELECT ... table1 RIGHT JOIN table2 ON ...</code></li>
<li>è¯´æ˜ï¼šä¼šå–å¾—table2å…¨éƒ¨è®°å½•ï¼Œå³ä½¿table1æ²¡æœ‰åŒ¹é…è®°å½•</li>
</ul>
</li>
<li>INNER JOINï¼šåªè¿”å›ä¸¤ä¸ªè¡¨ä¸­è”ç»“å­—æ®µç›¸ç­‰çš„è®°å½•ã€‚<ul>
<li>æ ¼å¼ï¼š<code>SELECT ... table1 INNER JOIN table2 ON ...</code></li>
<li>è¯´æ˜ï¼šä¼šå–å¾—table1table2è”ç»“å­—æ®µç›¸ç­‰çš„è®°å½•</li>
</ul>
</li>
</ul>
<blockquote>
<p>joinå›¾ç¤º</p>
</blockquote>
<pre><code class="mysql">  SELECT &lt;select_list&gt; from table_a a LEFT JOIN table_b b ON a.key = b.key</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314221223407.png" class="" title="image-20210314221223407">

<pre><code class="mysql">  SELECT &lt;select_list&gt; from table_a a LEFT JOIN table_b ON a.key == b.key WHERE b.key is NULL</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314222433261.png" class="" title="image-20210314222433261">

<pre><code class="mysql">  SELECT &lt;select_list&gt; from table_a a INNER JOIN table_b b ON a.key = b.key</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314221536479.png" class="" title="image-20210314221536479">

<pre><code class="mysql">  SELECT &lt;select_list&gt; from table_a a RIGHT JOIN table_b b ON a.key = b.key</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314221440655.png" class="" title="image-20210314221440655">

<pre><code class="mysql">  SELECT &lt;select_list&gt; from table_a a RIGHT JOIN table_b ON a.key = b.key WHERE a.key is NULL</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314222235183.png" class="" title="image-20210314222235183">

<pre><code class="mysql">  # Oracleæ”¯æŒ FULL OUTER JOINï¼Œä½†æ˜¯MySQLä¸æ”¯æŒ
  # Oracle
  SELECT &lt;select_list&gt; FROM table_a a FULL OUTER JOIN table_b b ON a.key = b.key
  # MySQL
  SELECT &lt;select_list&gt; from table_a a LEFT JOIN table_b b ON a.key = b.key
  union
  SELECT &lt;select_list&gt; from table_a a RIGHT JOIN table_b b ON a.key = b.key</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314222826674.png" class="" title="image-20210314222826674">

<pre><code class="mysql">  # Oracle
  SELECT &lt;select_list&gt; FROM table_a a FULL OUTER JOIN table_b b ON a.key = b.key WHERE a.key is NULL or b.key is NULL
  # MySQL
  SELECT &lt;select_list&gt; from table_a a LEFT JOIN table_b b ON a.key = b.key where b.id is null
  union
  SELECT &lt;select_list&gt; from table_a a RIGHT JOIN table_b b ON a.key = b.key where a.id is null</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314222858303.png" class="" title="image-20210314222858303">





<blockquote>
<p>SQLæ‰§è¡Œé¡ºåº</p>
</blockquote>
<ul>
<li>æ‰‹å†™</li>
</ul>
<pre><code class="sql">SELECT DISTINCT
    &lt;select_list&gt;
FROM
    &lt;left_table&gt; &lt;join_table&gt;
JOIN &lt;right_table&gt; ON &lt;join_condetion&gt;
WHERE
    &lt;where_condition&gt;
GROUP BY
    &lt;group_by_list&gt;
HAVING
    &lt;having_condition&gt;
ORDER BY
    &lt;order_by_condition&gt;
LIMIT &lt;limit_number&gt;</code></pre>
<ul>
<li>æœºè¯»</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/c24675b4/image-20210314215216629.png" class="" title="image-20210314215216629">





<h3 id="æ€§èƒ½åˆ†æ"><a href="#æ€§èƒ½åˆ†æ" class="headerlink" title="æ€§èƒ½åˆ†æ"></a>æ€§èƒ½åˆ†æ</h3><blockquote>
<p>MySQL Query Optimizer</p>
</blockquote>
<p>MySQLä¸­æœ‰ä¸“é—¨è´Ÿè´£ä¼˜åŒ–SELECTè¯­å¥çš„ä¼˜åŒ–å™¨æ¨¡å—ï¼Œä¸»è¦åŠŸèƒ½ï¼šé€šè¿‡è®¡ç®—åˆ†æç³»ç»Ÿä¸­æ”¶é›†åˆ°çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œä¸ºå®¢æˆ·ç«¯è¯·æ±‚çš„Queryæä¾›ä»–è®¤ä¸ºæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’(å®ƒè®¤ä¸ºæœ€ä¼˜çš„æ•°æ®æ£€ç´¢æ–¹å¼ï¼Œä½†ä¸è§å¾—æ˜¯DBAè®¤ä¸ºæ˜¯æœ€ä¼˜çš„ï¼Œè¿™éƒ¨åˆ†æœ€è€—è´¹æ—¶é—´)<br>å½“å®¢æˆ·ç«¯å‘MySQLè¯·æ±‚ä¸€æ¡Queryï¼Œå‘½ä»¤è§£æå™¨æ¨¡å—å®Œæˆè¯·æ±‚åˆ†ç±»ï¼ŒåŒºåˆ«å‡ºæ˜¯SELECTå¹¶è½¬å‘ç»™MySQL Query Optimizeræ—¶ï¼ŒMySQL Query Optimizer é¦–å…ˆä¼šå¯¹æ•´æ¡Queryè¿›è¡Œä¼˜åŒ–ï¼Œå¤„ç†æ‰ä¸€äº›å¸¸é‡è¡¨è¾¾å¼çš„é¢„ç®—ï¼Œç›´æ¥æ¢ç®—æˆå¸¸é‡å€¼ã€‚å¹¶å¯¹Query ä¸­çš„æŸ¥è¯¢æ¡ä»¶è¿›è¡Œç®€åŒ–å’Œè½¬æ¢ï¼Œå¦‚å»æ‰ä¸€äº›æ— ç”¨æˆ–æ˜¾è€Œæ˜“è§çš„æ¡ä»¶ã€ç»“æ„è°ƒæ•´ç­‰ã€‚ç„¶ååˆ†æQuery ä¸­çš„Hint ä¿¡æ¯(å¦‚æœæœ‰)ï¼Œçœ‹æ˜¾ç¤ºHintä¿¡æ¯æ˜¯å¦å¯ä»¥å®Œå…¨ç¡®å®šè¯¥Queryçš„æ‰§è¡Œè®¡åˆ’ã€‚å¦‚æœæ²¡æœ‰Hintæˆ–Hintä¿¡æ¯è¿˜ä¸è¶³ä»¥å®Œå…¨ç¡®å®šæ‰§è¡Œè®¡åˆ’ï¼Œåˆ™ä¼šè¯»å–æ‰€æ¶‰åŠå¯¹è±¡çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæ ¹æ®Queryè¿›è¡Œå†™ç›¸åº”çš„è®¡ç®—åˆ†æï¼Œç„¶åå†å¾—å‡ºæœ€åçš„æ‰§è¡Œè®¡åˆ’ã€‚</p>
<blockquote>
<p>MySQLæ€§èƒ½ç“¶é¢ˆ</p>
</blockquote>
<p>CPU: CPUåœ¨é¥±å’Œçš„æ—¶å€™ä¸€èˆ¬å‘ç”Ÿåœ¨æ•°æ®è£…å…¥å†…å­˜æˆ–ä»ç£ç›˜ä¸Šè¯»å–æ•°æ®çš„æ—¶å€™</p>
<p>IO: ç£ç›˜I/Oç“¶é¢ˆå‘ç”Ÿåœ¨è£…å…¥æ•°æ®è¿œå¤§äºå†…å­˜å®¹é‡çš„æ—¶å€™</p>
<p>æœåŠ¡å™¨ç¡¬ä»¶çš„æ€§èƒ½ç“¶é¢ˆï¼š<code>top</code>ã€<code>free</code>ã€<code>iostat</code>ã€<code>vmstat</code>æ¥æŸ¥çœ‹ç³»ç»Ÿçš„æ€§èƒ½çŠ¶æ€</p>
<blockquote>
<p>Explain</p>
</blockquote>
<p>å®˜ç½‘ä»‹ç»ï¼š<a href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html">https://dev.mysql.com/doc/refman/8.0/en/explain-output.html</a></p>
<p>ä½¿ç”¨ç›®çš„ï¼š</p>
<ul>
<li>è¡¨çš„è¯»å–é¡ºåº</li>
<li>æ•°æ®è¯»å–æ“ä½œçš„æ“ä½œç±»å‹</li>
<li>å¯ä»¥ä½¿ç”¨çš„ç´¢å¼•</li>
<li>å®é™…ä½¿ç”¨çš„ç´¢å¼•</li>
<li>è¡¨ä¹‹é—´çš„å¼•ç”¨</li>
<li>æ¯å¼ è¡¨è¢«ä¼˜åŒ–å™¨æŸ¥è¯¢çš„è¡Œæ•°</li>
</ul>
<p>ä½¿ç”¨æ–¹æ³•ï¼š<code>explain + sqlè¯­å¥</code></p>
<blockquote>
<p>å­—æ®µè§£é‡Š</p>
</blockquote>
<p>ï¼ˆ1ï¼‰id</p>
<p>è§£é‡Šï¼š</p>
<p>selectæŸ¥è¯¢çš„åºåˆ—å·ï¼ŒåŒ…å«ä¸€ç»„æ•°å­—ï¼Œè¡¨ç¤ºæŸ¥è¯¢ä¸­æ‰§è¡Œçš„selectå­å¥æˆ–æ“ä½œè¡¨çš„é¡ºåºã€‚</p>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>idç›¸åŒï¼Œæ‰§è¡Œé¡ºåºç”±ä¸Šè‡³ä¸‹ï¼›</li>
<li>idä¸åŒï¼Œå¦‚æœæ˜¯å­æŸ¥è¯¢ï¼Œidé€’å¢ï¼Œidå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆè¢«æ‰§è¡Œï¼›</li>
<li>idç›¸åŒä¸åŒï¼ŒåŒæ—¶å­˜åœ¨ï¼Œidå¦‚æœç›¸åŒï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç»„ï¼Œä»ä¸Šå¾€ä¸‹é¡ºåºæ‰§è¡Œï¼Œåœ¨æ‰€æœ‰ç»„ä¸­ï¼Œidå€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
<p>ï¼ˆ2ï¼‰select_type</p>
<p>è§£é‡Šï¼š</p>
<p>æŸ¥è¯¢çš„ç±»å‹ï¼šSIMPLEã€PRIMARYã€SUBQUERYã€DERIVEDã€UNIONã€UNION RESULTã€‚æŸ¥è¯¢çš„ç±»å‹ï¼Œä¸»è¦æ˜¯ç”¨äºåŒºåˆ«æ™®é€šæŸ¥è¯¢ã€è”åˆæŸ¥è¯¢ã€å­æŸ¥è¯¢ç­‰çš„å¤æ‚æŸ¥è¯¢ã€‚</p>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>SIMPLEï¼šç®€å•çš„selectæŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸­ä¸åŒ…å«å­æŸ¥è¯¢æˆ–è€…UNIONï¼›</li>
<li>PRIMARYï¼šæŸ¥è¯¢ä¸­è‹¥åŒ…å«ä»»ä½•å¤æ‚çš„å­éƒ¨åˆ†ï¼Œæœ€å¤–å±‚æŸ¥è¯¢è´£åˆ™è¢«æ ‡è®°ä¸ºPRIMARYï¼›</li>
<li>SUBQUERYï¼šåœ¨SELECTæˆ–WHEREåˆ—è¡¨ä¸­åŒ…å«äº†å­æŸ¥è¯¢ï¼›</li>
<li>DERIVEDï¼šåœ¨FROMåˆ—è¡¨ä¸­åŒ…å«çš„å­æŸ¥è¯¢è¢«æ ‡è®°ä¸ºDERIVED(è¡ç”Ÿ)ï¼ŒMySQLä¼šé€’å½’æ‰§è¡Œè¿™äº›å­æŸ¥è¯¢ï¼ŒæŠŠç»“æœæ”¾åœ¨ä¸´æ—¶è¡¨é‡Œï¼›</li>
<li>UNIONï¼šè‹¥ç¬¬äºŒä¸ªSELECTå‡ºç°åœ¨UNIONä¹‹åï¼Œåˆ™è¢«æ ‡è®°ä¸ºUNIONï¼›è‹¥UNIONåŒ…å«åœ¨FROMå­å¥çš„å­æŸ¥è¯¢ä¸­ï¼Œå¤–å±‚SELECTå°†è¢«è¢«æ ‡è®°ä¸ºï¼šDERIVEDï¼›</li>
<li>UNION RESULTï¼šä»UNIONè¡¨è·å–ç»“æœçš„SELECTã€‚</li>
</ul>
<p>ï¼ˆ3ï¼‰table</p>
<p>è§£é‡Šï¼šæ˜¾ç¤ºè¿™ä¸€è¡Œæ•°æ®æ˜¯å…³äºå“ªä¸€å¼ è¡¨çš„ã€‚</p>
<p>ï¼ˆ4ï¼‰type</p>
<p>è§£é‡Šï¼šæ˜¾ç¤ºæŸ¥è¯¢äº†ä½•ç§ç±»å‹ã€‚</p>
<p>è¯´æ˜ï¼š</p>
<p>ä»æœ€å¥½åˆ°æœ€å·®ä¾æ¬¡æ˜¯ï¼š<code>system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL</code>ã€‚</p>
<p>å¸¸è§çš„æ˜¯ï¼š<code>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</code>ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå¾—ä¿è¯æŸ¥è¯¢è‡³å°‘è¾¾åˆ°rangeçº§åˆ«ï¼Œæœ€å¥½èƒ½åˆ°refã€‚</p>
<ul>
<li>systemï¼šè¡¨åªæœ‰ä¸€è¡Œè®°å½•ï¼ˆç­‰äºç³»ç»Ÿè¡¨ï¼‰ï¼Œè¿™æ˜¯constç±»å‹çš„ç‰¹ä¾‹ï¼Œå¹³æ—¶ä¸ä¼šå‡ºç°ï¼Œè¿™ä¸ªä¹Ÿå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</li>
<li>constï¼šè¡¨ç¤ºé€šè¿‡ç´¢å¼•ä¸€æ¬¡å°±æ‰¾åˆ°äº†ï¼Œconstç”¨äºæ¯”è¾ƒprimary keyæˆ–è€…uniqueç´¢å¼•ã€‚å› ä¸ºåªåŒ¹é…ä¸€è¡Œæ•°æ®ï¼Œæ‰€ä»¥å¾ˆå¿«ã€‚å¦‚å°†ä¸»é”®ç½®äºwhereåˆ—è¡¨ä¸­ï¼ŒMySQLå°±èƒ½å°†è¯¥æŸ¥è¯¢è½¬æ¢ä¸ºä¸€ä¸ªå¸¸é‡ã€‚</li>
<li>eq_refï¼šå”¯ä¸€æ€§ç´¢å¼•æ‰«æï¼Œå¯¹äºæ¯ä¸ªç´¢å¼•é”®ï¼Œè¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•ä¸ä¹‹åŒ¹é…ã€‚å¸¸è§äºä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•æ‰«æã€‚</li>
<li>refï¼šéå”¯ä¸€æ€§ç´¢å¼•æ‰«æï¼Œè¿”å›åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„æ‰€æœ‰è¡Œã€‚æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§ç´¢å¼•è®¿é—®ï¼Œå®ƒè¿”å›æ‰€æœ‰åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„è¡Œï¼Œç„¶è€Œï¼Œå®ƒå¯èƒ½ä¼šæ‰¾åˆ°å¤šä¸ªç¬¦åˆæ¡ä»¶çš„è¡Œï¼Œæ‰€ä»¥ä»–åº”è¯¥å±äºæŸ¥æ‰¾å’Œæ‰«æçš„æ··åˆä½“ã€‚</li>
<li>rangeï¼šåªæ£€ç´¢ç»™å®šèŒƒå›´çš„è¡Œï¼Œä½¿ç”¨ä¸€ä¸ªç´¢å¼•æ¥é€‰æ‹©è¡Œã€‚keyåˆ—æ˜¾ç¤ºä½¿ç”¨äº†å“ªä¸ªç´¢å¼•ï¼Œä¸€èˆ¬å°±æ˜¯åœ¨ä½ çš„whereè¯­å¥ä¸­å‡ºç°äº†betweenã€&lt;ã€&gt;ã€inç­‰çš„æŸ¥è¯¢è¿™ç§èŒƒå›´æ‰«æç´¢å¼•ä¼šæ¯”å…¨è¡¨æ‰«æè¦å¥½ï¼Œå› ä¸ºå®ƒåªéœ€è¦å¼€å§‹äºç´¢å¼•çš„æŸä¸€ç‚¹ï¼Œè€Œç»“æŸäºå¦ä¸€ç‚¹ï¼Œä¸ç”¨æ‰«æå…¨éƒ¨ç´¢å¼•ã€‚</li>
<li>indexï¼šFull Index Scanï¼Œindexä¸ALLåŒºåˆ«ä¸ºindexç±»å‹åªéå†ç´¢å¼•æ ‘ã€‚è¿™é€šå¸¸æ¯”ALLå¿«ï¼Œå› ä¸ºç´¢å¼•æ–‡ä»¶é€šå¸¸æ¯”æ•°æ®æ–‡ä»¶å°ã€‚ï¼ˆä¹Ÿå°±æ˜¯è¯´è™½ç„¶ALLå’Œindexéƒ½æ˜¯å…¨è¡¨ï¼Œä½†indexæ˜¯ä»ç´¢å¼•å‡ºå‘çš„ï¼Œè€ŒALLæ˜¯ä»ç¡¬ç›˜è¯»å–çš„ã€‚ï¼‰</li>
<li>ALLï¼šFull Table Scanï¼Œå°†æ‰«æå…¨è¡¨ä»¥æ‰¾åˆ°åŒ¹é…çš„è¡Œã€‚</li>
</ul>
<p>ï¼ˆ5ï¼‰possible_keys</p>
<p>è§£é‡Šï¼š</p>
<p>æ˜¾ç¤ºå¯èƒ½åº”ç”¨åœ¨è¿™å¼ è¡¨ä¸­çš„ç´¢å¼•ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªã€‚</p>
<p>æŸ¥è¯¢æ¶‰åŠåˆ°çš„å­—æ®µä¸Šè‹¥å­˜åœ¨ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å°†è¢«åˆ—å‡ºï¼Œä½†ä¸ä¸€å®šè¢«æŸ¥è¯¢å®é™…ä½¿ç”¨ã€‚</p>
<p>ï¼ˆ6ï¼‰key</p>
<p>è§£é‡Šï¼šå®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚å¦‚æœä¸ºNULLï¼Œåˆ™æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚æŸ¥è¯¢ä¸­è‹¥ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•ä»…å‡ºç°åœ¨keyåˆ—è¡¨ä¸­ã€‚</p>
<p>ï¼ˆ7ï¼‰key_len</p>
<p>è§£é‡Šï¼šè¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå¯é€šè¿‡è¯¥åˆ—è®¡ç®—æŸ¥è¯¢ä¸­ä½¿ç”¨çš„ç´¢å¼•çš„é•¿åº¦ã€‚åœ¨ä¸æŸå¤±ç²¾ç¡®æ€§çš„æƒ…å†µä¸‹ï¼Œé•¿åº¦è¶ŠçŸ­è¶Šå¥½ã€‚key_lenæ˜¾ç¤ºçš„å€¼ä¸ºç´¢å¼•å­—æ®µçš„æœ€å¤§å¯èƒ½é•¿åº¦ï¼Œå¹¶éå®é™…ä½¿ç”¨é•¿åº¦ï¼Œå³key_lenæ—¶æ ¹æ®è¡¨å®šä¹‰è®¡ç®—è€Œå¾—ï¼Œä¸æ˜¯é€šè¿‡è¡¨å†…æ£€ç´¢å‡ºçš„ã€‚</p>
<p>è®¡ç®—ï¼š</p>
<ul>
<li>å­—ç¬¦ä¸² <ul>
<li>char(n)ï¼šnå­—èŠ‚é•¿åº¦</li>
<li>varchar(n)ï¼š2å­—èŠ‚å­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦ï¼Œå¦‚æœæ˜¯utf-8ï¼Œåˆ™é•¿åº¦ 3n + 2</li>
</ul>
</li>
<li>æ•°å€¼ç±»å‹ <ul>
<li>tinyintï¼š1å­—èŠ‚</li>
<li>smallintï¼š2å­—èŠ‚</li>
<li>intï¼š4å­—èŠ‚</li>
<li>bigintï¼š8å­—èŠ‚ã€€ã€€</li>
</ul>
</li>
<li>æ—¶é—´ç±»å‹ã€€ <ul>
<li>dateï¼š3å­—èŠ‚</li>
<li>timestampï¼š4å­—èŠ‚</li>
<li>datetimeï¼š8å­—èŠ‚</li>
</ul>
</li>
<li>å¦‚æœå­—æ®µå…è®¸ä¸º NULLï¼Œéœ€è¦1å­—èŠ‚è®°å½•æ˜¯å¦ä¸º NULL</li>
</ul>
<p>ç´¢å¼•æœ€å¤§é•¿åº¦æ˜¯768å­—èŠ‚ï¼Œå½“å­—ç¬¦ä¸²è¿‡é•¿æ—¶ï¼Œmysqlä¼šåšä¸€ä¸ªç±»ä¼¼å·¦å‰ç¼€ç´¢å¼•çš„å¤„ç†ï¼Œå°†å‰åŠéƒ¨åˆ†çš„å­—ç¬¦æå–å‡ºæ¥åšç´¢å¼•ã€‚</p>
<p>ï¼ˆ8ï¼‰ref</p>
<p>è§£é‡Šï¼š</p>
<p>æ˜¾ç¤ºç´¢å¼•çš„å“ªä¸€åˆ—è¢«ä½¿ç”¨äº†ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œæ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚å“ªäº›åˆ—æˆ–å¸¸é‡è¢«ç”¨äºæŸ¥æ‰¾ç´¢å¼•åˆ—ä¸Šçš„å€¼ã€‚</p>
<p>ï¼ˆ9ï¼‰rows</p>
<p>è§£é‡Šï¼š</p>
<p>è¿™ä¸€åˆ—æ˜¯mysqlä¼°è®¡è¦è¯»å–å¹¶æ£€æµ‹çš„è¡Œæ•°ï¼Œæ³¨æ„è¿™ä¸ªä¸æ˜¯ç»“æœé›†é‡Œçš„è¡Œæ•°ã€‚</p>
<p>ï¼ˆ10ï¼‰extra</p>
<p>è§£é‡Šï¼š</p>
<p>åŒ…å«ä¸é€‚åˆåœ¨å…¶ä»–åˆ—ä¸­æ˜¾ç¤ºä½†ååˆ†é‡è¦çš„é¢å¤–ä¿¡æ¯ã€‚</p>
<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>using index</code>ï¼šè¿™å‘ç”Ÿåœ¨å¯¹è¡¨çš„è¯·æ±‚åˆ—éƒ½æ˜¯åŒä¸€ç´¢å¼•çš„éƒ¨åˆ†çš„æ—¶å€™ï¼Œè¿”å›çš„åˆ—æ•°æ®åªä½¿ç”¨äº†ç´¢å¼•ä¸­çš„ä¿¡æ¯ï¼Œè€Œæ²¡æœ‰å†å»è®¿é—®è¡¨ä¸­çš„è¡Œè®°å½•ï¼Œæ˜¯æ€§èƒ½é«˜çš„è¡¨ç°ã€‚å¦‚æœåŒæ—¶å‡ºç°using whereï¼Œè¡¨æ˜ç´¢å¼•è¢«ç”¨æ¥æ‰§è¡Œç´¢å¼•é”®å€¼çš„æŸ¥æ‰¾ï¼›å¦‚æœæ²¡æœ‰åŒæ—¶å‡ºç°using whereï¼Œè¡¨æ˜ç´¢å¼•ç”¨æ¥è¯»å–æ•°æ®è€Œéæ‰§è¡ŒæŸ¥æ‰¾åŠ¨ä½œã€‚</li>
<li><code>using filesort</code>ï¼šMySQLä¼šå¯¹ç»“æœä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨ç´¢å¼•æ’åºï¼Œè€Œä¸æ˜¯æŒ‰ç´¢å¼•æ¬¡åºä»è¡¨é‡Œè¯»å–è¡Œã€‚æ­¤æ—¶MySQLä¼šæ ¹æ®è”æ¥ç±»å‹æµè§ˆæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå¹¶ä¿å­˜æ’åºå…³é”®å­—å’Œè¡ŒæŒ‡é’ˆï¼Œç„¶åæ’åºå…³é”®å­—å¹¶æŒ‰é¡ºåºæ£€ç´¢è¡Œä¿¡æ¯ã€‚è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯å¾ˆå±é™©çš„ï¼Œä¹æ­»ä¸€ç”Ÿã€‚</li>
<li><code>using temporary</code>ï¼šMySQLéœ€è¦åˆ›å»ºä¸€å¼ ä¸´æ—¶è¡¨æ¥å¤„ç†æŸ¥è¯¢ï¼Œå¯¹äºæŸ¥è¯¢ç»“æœæ’åºæ—¶ä½¿ç”¨ä¸´æ—¶è¡¨ï¼Œå¸¸è§äºæ’åºorder byå’Œåˆ†ç»„æŸ¥è¯¢group byã€‚å¸¸è§äºè¿™ç§æƒ…å†µå°±æ›´åŠ å±é™©äº†ï¼Œåæ­»æ— ç”Ÿã€‚</li>
<li><code>using where</code>ï¼šä½¿ç”¨whereè¿‡æ»¤ã€‚</li>
<li><code>using join buffer</code>ï¼šä½¿ç”¨è¿æ¥ç¼“å­˜ã€‚</li>
<li><code>impossible where</code>ï¼šwhereå­å¥æ€»æ˜¯falseï¼Œä¸èƒ½ç”¨æ¥è·å–ä»»ä½•å…ƒç»„ã€‚</li>
<li><code>select tables optimized away</code>ï¼šåœ¨æ²¡æœ‰GROUP BYå­å¥çš„æƒ…å†µä¸‹ï¼ŒåŸºäºç´¢å¼•ä¼˜åŒ–MIN/MAXæˆ–è€…å¯¹äºMyISAMå­˜å‚¨å¼•æ“ä¼˜åŒ–COUNT(*)æ“ä½œï¼Œä¸å¿…ç­‰åˆ°æ‰§è¡Œé˜¶æ®µå†è¿›è¡Œè®¡ç®—ï¼ŒæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ç”Ÿæˆçš„é˜¶æ®µå³å®Œæˆä¼˜åŒ–ã€‚</li>
<li><code>distinct</code>ï¼šä¸€æ—¦MySQLæ‰¾åˆ°äº†ä¸è¡Œç›¸è”åˆåŒ¹é…çš„è¡Œï¼Œå°±åœæ­¢æœç´¢ã€‚</li>
</ul>
<h3 id="SQLä¼˜åŒ–"><a href="#SQLä¼˜åŒ–" class="headerlink" title="SQLä¼˜åŒ–"></a>SQLä¼˜åŒ–</h3><blockquote>
<p>æ¡ˆä¾‹1</p>
</blockquote>
<p>å»ºè¡¨ï¼š</p>
<pre><code class="mysql">CREATE TABLE `tb2_article` (
  `id` int NOT NULL AUTO_INCREMENT,
  `author_id` int NOT NULL,
  `category_id` int NOT NULL,
  `views` int NOT NULL,
  `comments` int NOT NULL,
  `title` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `content` text NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

INSERT INTO `tb2_article` VALUES (1, 1, 1, 1, 1, &#39;1&#39;, &#39;1&#39;);
INSERT INTO `tb2_article` VALUES (2, 2, 2, 2, 2, &#39;2&#39;, &#39;2&#39;);
INSERT INTO `tb2_article` VALUES (3, 3, 3, 3, 3, &#39;3&#39;, &#39;3&#39;);</code></pre>
<p>ç¬¬ä¸€æ¬¡explainï¼š</p>
<pre><code class="mysql">EXPLAIN SELECT id, author_id FROM tb2_article WHERE category_id = 1 AND comments &gt; 1 order by views desc limit 1;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="mysql">+----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+
| id | select_type | table       | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                       |
+----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+
|  1 | SIMPLE      | tb2_article | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    2 |    50.00 | Using where; Using filesort |
+----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</code></pre>
<p>å»ºç«‹ç´¢å¼•ï¼š</p>
<pre><code class="mysql">CREATE INDEX idx_article_ccv on tb2_article(category_id,comments, views);</code></pre>
<p>ç¬¬äºŒæ¬¡explainï¼š</p>
<pre><code class="mysql">EXPLAIN SELECT id, author_id FROM tb2_article WHERE category_id = 1 AND comments &gt; 1 order by views desc limit 1;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="mysql">+----+-------------+-------------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+
| id | select_type | table       | partitions | type  | possible_keys   | key             | key_len | ref  | rows | filtered | Extra                                 |
+----+-------------+-------------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+
|  1 | SIMPLE      | tb2_article | NULL       | range | idx_article_ccv | idx_article_ccv | 8       | NULL |    1 |   100.00 | Using index condition; Using filesort |
+----+-------------+-------------+------------+-------+-----------------+-----------------+---------+------+------+----------+---------------------------------------+
</code></pre>
<p>å‘ç°keyä¸­å·²ç»æ˜¾ç¤ºäº†åˆšåˆšå»ºç«‹çš„ç´¢å¼•ï¼Œä½†æ˜¯ä¾ç„¶ä½¿ç”¨äº†æ–‡ä»¶æ’åºã€‚</p>
<p>ç¬¬ä¸‰æ¬¡explainï¼š</p>
<pre><code class="mysql">EXPLAIN SELECT id, author_id FROM tb2_article WHERE category_id = 1 AND comments = 1 order by views desc limit 1;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="mysql">+----+-------------+-------------+------------+------+-----------------+-----------------+---------+-------------+------+----------+---------------------+
| id | select_type | table       | partitions | type | possible_keys   | key             | key_len | ref         | rows | filtered | Extra               |
+----+-------------+-------------+------------+------+-----------------+-----------------+---------+-------------+------+----------+---------------------+
|  1 | SIMPLE      | tb2_article | NULL       | ref  | idx_article_ccv | idx_article_ccv | 8       | const,const |    1 |   100.00 | Backward index scan |
+----+-------------+-------------+------------+------+-----------------+-----------------+---------+-------------+------+----------+---------------------+</code></pre>
<p>å½“æŠŠæŸ¥è¯¢æ¡ä»¶ä¿®æ”¹ä¸ºç­‰äºæ—¶ï¼Œå‘ç°refä¸­å‡ºç°ä¸¤ä¸ªå¸¸é‡ï¼Œå³ä¸¤ä¸ªæŸ¥è¯¢å¸¸é‡ï¼Œå¹¶ä¸”æ²¡æœ‰ä½¿ç”¨æ–‡ä»¶æ’åºã€‚è¯´æ˜å½“æŸ¥è¯¢æ¡ä»¶ä¸ºå¤§äºå·æ—¶ï¼Œç´¢å¼•å¤±æ•ˆã€‚</p>
<p>æµ…æç¬¬äºŒæ¬¡åŠ äº†ç´¢å¼•ä¹‹åexplainä¾ç„¶ä½¿ç”¨<code>filesort</code>ï¼š</p>
<p>æŒ‰ç…§BTreeçš„å·¥ä½œåŸç†ï¼Œå…ˆæ’åº<code>category_id</code>ï¼Œå¦‚æœé‡åˆ°ç›¸åŒçš„<code>category_id</code>åˆ™å†æ’åº<code>comments</code>ï¼Œå¦‚æœé‡åˆ°ç›¸åŒçš„<code>commnents</code>åˆ™å†æ’åº<code>views</code>ã€‚å½“<code>comments</code>å­—æ®µåœ¨è”åˆç´¢å¼•é‡Œå¤„äºä¸­é—´ä½ç½®æ—¶ï¼Œå› <code>comments &gt; 1</code>æ¡ä»¶æ˜¯ä¸€ä¸ªèŒƒå›´å€¼(range)ï¼ŒMySQLæ— æ³•åˆ©ç”¨ç´¢å¼•å†å¯¹åé¢çš„viewséƒ¨åˆ†è¿›è¡Œæ£€ç´¢ï¼Œå³rangeç±»å‹æŸ¥è¯¢å­—æ®µåé¢çš„ç´¢å¼•æ— æ•ˆã€‚</p>
<p>åˆ é™¤ç´¢å¼•ï¼š</p>
<pre><code class="mysql">DROP INDEX idx_article_ccv ON tb2_article;</code></pre>
<p>æ–°å»ºç´¢å¼•ï¼š</p>
<pre><code class="mysql">CREATE INDEX idx_article_cv ON  tb2_article(category_id, views);</code></pre>
<p>å†æ¬¡explainï¼š</p>
<pre><code class="mysql">EXPLAIN SELECT id, author_id FROM tb2_article WHERE category_id = 1 AND comments &gt; 1 order by views desc limit 1;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="mysql">+----+-------------+-------------+------------+------+----------------+----------------+---------+-------+------+----------+----------------------------------+
| id | select_type | table       | partitions | type | possible_keys  | key            | key_len | ref   | rows | filtered | Extra                            |
+----+-------------+-------------+------------+------+----------------+----------------+---------+-------+------+----------+----------------------------------+
|  1 | SIMPLE      | tb2_article | NULL       | ref  | idx_article_cv | idx_article_cv | 4       | const |    1 |    50.00 | Using where; Backward index scan |
+----+-------------+-------------+------------+------+----------------+----------------+---------+-------+------+----------+----------------------------------+</code></pre>
<p>å¯ä»¥çœ‹åˆ°typeå˜æˆäº†<code>ref</code>ï¼ŒExtraä¸­çš„<code>using filesort</code>ä¹Ÿæ¶ˆå¤±äº†ï¼Œç»“æœéå¸¸ç†æƒ³ã€‚</p>
<p>ç»“è®ºï¼šå»ºç«‹å¤åˆç´¢å¼•çš„æ—¶å€™æœ€å¥½ä¸è¦å¸¦ä¸Šå«æœ‰èŒƒå›´æŸ¥è¯¢çš„å­—æ®µã€‚</p>
<blockquote>
<p>æ¡ˆä¾‹2</p>
</blockquote>
<p>ç»§ç»­å»ºè¡¨ï¼š</p>
<pre><code class="mysql">CREATE TABLE `tb2_class` (
  `id` int NOT NULL AUTO_INCREMENT,
  `card` int NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `tb2_book` (
  `bookid` int NOT NULL AUTO_INCREMENT,
  `card` int NOT NULL,
  PRIMARY KEY (`bookid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

INSERT INTO tb2_class(card) VALUES(FLOOR(1 + RAND() * 20));
INSERT INTO tb2_book(card) VALUES(FLOOR(1 + RAND() * 20));</code></pre>
<p>ç¬¬ä¸€æ¬¡explainï¼š</p>
<pre><code class="mysql">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book on tb2_class.card = tb2_book.card;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="mysql">+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+
| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                      |
+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+
|  1 | SIMPLE      | tb2_class | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    9 |   100.00 | NULL                                       |
|  1 | SIMPLE      | tb2_book  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    9 |   100.00 | Using where; Using join buffer (hash join) |
+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</code></pre>
<p>å¯ä»¥çœ‹åˆ°typeéƒ½ä¸ºALLã€‚</p>
<p>å»ºç«‹å³è¡¨tb2_bookç´¢å¼•ï¼š</p>
<pre><code class="mysql">ALTER TABLE tb2_book ADD INDEX(card);</code></pre>
<p>ç¬¬äºŒæ¬¡explainï¼š</p>
<pre><code class="mysql">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book on tb2_class.card = tb2_book.card;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="mysql">+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+
| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref                        | rows | filtered | Extra       |
+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+
|  1 | SIMPLE      | tb2_class | NULL       | ALL  | NULL          | NULL | NULL    | NULL                       |    9 |   100.00 | NULL        |
|  1 | SIMPLE      | tb2_book  | NULL       | ref  | card          | card | 4       | mysql_learn.tb2_class.card |    1 |   100.00 | Using index |
+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+</code></pre>
<p>å¯ä»¥çœ‹åˆ°tb2_classçš„typeä¾ç„¶æ˜¯ALLï¼Œtb2_bookçš„typeä¼˜åŒ–ä¸ºrefã€‚</p>
<p>åˆ é™¤tb2_bookçš„ç´¢å¼•ï¼š</p>
<pre><code class="mysql">DROP INDEX card ON tb2_book;</code></pre>
<p>å»ºç«‹å·¦è¡¨tb2_classç´¢å¼•ï¼š</p>
<pre><code class="mysql">ALTER TABLE tb2_class ADD INDEX(card);</code></pre>
<p>ç¬¬ä¸‰æ¬¡explainï¼š</p>
<pre><code class="mysql">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book on tb2_class.card = tb2_book.card;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="mysql">+----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------------+
| id | select_type | table     | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                      |
+----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------------+
|  1 | SIMPLE      | tb2_class | NULL       | index | NULL          | card | 4       | NULL |    9 |   100.00 | Using index                                |
|  1 | SIMPLE      | tb2_book  | NULL       | ALL   | NULL          | NULL | NULL    | NULL |    9 |   100.00 | Using where; Using join buffer (hash join) |
+----+-------------+-----------+------------+-------+---------------+------+---------+------+------+----------+--------------------------------------------+</code></pre>
<p>å¯ä»¥çœ‹åˆ°tb2_classçš„typeä¸ºindexï¼Œtb2_bookçš„typeä¸‹é™ä¸ºALLã€‚</p>
<p>æœ€åå†æ¬¡å»ºç«‹tb2_bookçš„ç´¢å¼•ï¼š</p>
<pre><code class="mysql">ALTER TABLE tb2_book ADD INDEX(card);</code></pre>
<p>ç¬¬å››æ¬¡explainï¼š</p>
<pre><code class="mysql">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book on tb2_class.card = tb2_book.card;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="mysql">+----+-------------+-----------+------------+-------+---------------+------+---------+----------------------------+------+----------+-------------+
| id | select_type | table     | partitions | type  | possible_keys | key  | key_len | ref                        | rows | filtered | Extra       |
+----+-------------+-----------+------------+-------+---------------+------+---------+----------------------------+------+----------+-------------+
|  1 | SIMPLE      | tb2_class | NULL       | index | NULL          | card | 4       | NULL                       |    9 |   100.00 | Using index |
|  1 | SIMPLE      | tb2_book  | NULL       | ref   | card          | card | 4       | mysql_learn.tb2_class.card |    1 |   100.00 | Using index |
+----+-------------+-----------+------------+-------+---------------+------+---------+----------------------------+------+----------+-------------+</code></pre>
<p>å‘ç°typeéƒ½æå‡äº†ï¼Œindexå’Œrefï¼Œç»“æœå¾ˆç†æƒ³ã€‚</p>
<p>ç»“è®ºï¼šå¯¹äºJOINè¿æ¥æŸ¥è¯¢çš„ä¸¤å¼ è¡¨æœ€å¥½éƒ½åœ¨è”ç»“å­—æ®µå»ºç«‹å•å€¼ç´¢å¼•ã€‚</p>
<blockquote>
<p>æ¡ˆä¾‹3</p>
</blockquote>
<p>ç»§ç»­å»ºè¡¨ï¼š</p>
<pre><code class="mysql">CREATE TABLE `tb2_phone` (
  `phoneid` int NOT NULL AUTO_INCREMENT,
  `card` int DEFAULT NULL,
  PRIMARY KEY (`phoneid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

INSERT INTO tb2_phone(card) VALUES(FLOOR(1 + (RAND()*20)));</code></pre>
<p>ç¬¬ä¸€æ¬¡explainï¼š</p>
<pre><code class="mysql">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book ON tb2_class.card = tb2_book.card LEFT JOIN tb2_phone ON tb2_book.card = tb2_phone.card ;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="mysql">+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+
| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                      |
+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+
|  1 | SIMPLE      | tb2_class | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    9 |   100.00 | NULL                                       |
|  1 | SIMPLE      | tb2_book  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    9 |   100.00 | Using where; Using join buffer (hash join) |
|  1 | SIMPLE      | tb2_phone | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    9 |   100.00 | Using where; Using join buffer (hash join) |
+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+</code></pre>
<p>å‘ç°ä¸‰å¼ è¡¨çš„typeéƒ½æ˜¯ALLã€‚</p>
<p>å»ºç«‹tb2_phoneå’Œtb2_bookçš„ç´¢å¼•ï¼š</p>
<pre><code class="mysql">ALTER TABLE tb2_phone INDEX(card);
ALTER TABLE tb2_book ADD INDEX(card);</code></pre>
<p>ç¬¬äºŒæ¬¡explainï¼š</p>
<pre><code class="mysql">EXPLAIN SELECT * FROM tb2_class LEFT JOIN tb2_book ON tb2_class.card = tb2_book.card LEFT JOIN tb2_phone ON tb2_book.card = tb2_phone.card ;</code></pre>
<p>ç»“æœï¼š</p>
<pre><code class="mysql">+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+
| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref                        | rows | filtered | Extra       |
+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+
|  1 | SIMPLE      | tb2_class | NULL       | ALL  | NULL          | NULL | NULL    | NULL                       |    9 |   100.00 | NULL        |
|  1 | SIMPLE      | tb2_book  | NULL       | ref  | card          | card | 4       | mysql_learn.tb2_class.card |    1 |   100.00 | Using index |
|  1 | SIMPLE      | tb2_phone | NULL       | ref  | card          | card | 5       | mysql_learn.tb2_book.card  |    1 |   100.00 | Using index |
+----+-------------+-----------+------------+------+---------------+------+---------+----------------------------+------+----------+-------------+</code></pre>
<p>å‘ç°tb2_phoneå’Œtb2_bookçš„typeè¢«ä¼˜åŒ–ä¸ºrefï¼Œå¹¶ä¸”rowsä¹Ÿä¼˜åŒ–çš„å¾ˆå¥½ã€‚</p>
<p>ç»“è®ºï¼š</p>
<ul>
<li><strong>æ°¸è¿œç”¨å°ç»“æœé›†é©±åŠ¨å¤§ç»“æœé›†</strong></li>
<li>å°½å¯èƒ½å‡å°‘Joinè¯­å¥ä¸­çš„NestedLoopçš„å¾ªç¯æ€»æ¬¡æ•°</li>
<li>ä¼˜å…ˆä¼˜åŒ–NestedLoopçš„å†…å­˜å¾ªç¯</li>
<li>ä¿è¯Joinè¯­å¥ä¸­è¢«é©±åŠ¨è¡¨ä¸ŠJoinæ¡ä»¶å­—æ®µå·²ç»è¢«ç´¢å¼•</li>
<li>å½“æ— æ³•ä¿è¯è¢«é©±åŠ¨è¡¨çš„Joinæ¡ä»¶å­—æ®µè¢«ç´¢å¼•ä¸”å†…å­˜èµ„æºå……è¶³çš„å‰æä¸‹ï¼Œä¸è¦å¤ªåå•¬JoinBufferçš„è®¾ç½®</li>
</ul>
<h3 id="ç´¢å¼•å¤±æ•ˆ"><a href="#ç´¢å¼•å¤±æ•ˆ" class="headerlink" title="ç´¢å¼•å¤±æ•ˆ"></a>ç´¢å¼•å¤±æ•ˆ</h3><blockquote>
<p>SQLè„šæœ¬</p>
</blockquote>
<pre><code class="mysql">CREATE TABLE `tb3_staff` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(20) DEFAULT NULL,
  `age` int DEFAULT NULL,
  `pos` varchar(20) DEFAULT NULL,
  `add_time` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

INSERT INTO tb3_staff(name, age, pos, add_time) VALUES ( &#39;KHighness&#39;, 19, &#39;manager&#39;, NOW());
INSERT INTO tb3_staff(name, age, pos, add_time) VALUES ( &#39;FlowerK&#39;, 18, &#39;dev&#39;, NOW());
INSERT INTO tb3_staff(name, age, pos, add_time) VALUES ( &#39;UnknownK&#39;, 17, &#39;dev&#39;, NOW());

ALTER TABLE tb3_staff ADD INDEX id_staff_nameagepos(name, age, pos);</code></pre>
<blockquote>
<p>ç”Ÿæ•ˆåœºæ™¯</p>
</blockquote>
<ul>
<li><code>EXPLAIN SELECT * FROM tb3_staff WHERE name = &#39;KHighness&#39;;</code></li>
<li><code>EXPLAIN SELECT * FROM tb3_staff WHERE name = &#39;KHighness&#39; and age = 19;</code></li>
<li><code>EXPLAIN SELECT * FROM tb3_staff WHERE name = &#39;KHighness&#39; and age = 19 and pos = &quot;dev&quot;;</code></li>
</ul>
<blockquote>
<p>å¤±æ•ˆåœºæ™¯</p>
</blockquote>
<ul>
<li><code>EXPLAIN SELECT * FROM tb3_staff WHERE age = 19 and pos = &quot;dev&quot;;</code></li>
<li> <code>EXPLAIN SELECT * FROM tb3_staff WHERE  pos = &quot;dev&quot;;</code></li>
</ul>
<blockquote>
<p>éƒ¨åˆ†å¤±æ•ˆ</p>
</blockquote>
<ul>
<li><code>EXPLAIN SELECT * FROM tb3_staff WHERE name = &#39;KHighness&#39; and pos = &quot;dev&quot;;</code></li>
</ul>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<p>1ã€æœ€ç†æƒ³çš„æƒ…å†µå°±æ˜¯æŸ¥è¯¢å­—æ®µä¸ç´¢å¼•å­—æ®µç›¸åŒ</p>
<p>2ã€æœ€ä½³å·¦å‰ç¼€æ³•åˆ™</p>
<p>3ã€ä¸åœ¨ç´¢å¼•åˆ—ä¸Šåšä»»ä½•æ“ä½œï¼ˆè®¡ç®—ã€å‡½æ•°ã€ï¼ˆè‡ªåŠ¨oræ‰‹åŠ¨ï¼‰ç±»å‹è½¬æ¢ï¼‰ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆè€Œè½¬å‘å…¨è¡¨æ‰«æ</p>
<p>4ã€å­˜å‚¨å¼•æ“ä¸èƒ½ä½¿ç”¨ç´¢å¼•ä¸­èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—</p>
<p>5ã€å°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ˆåªè®¿é—®ç´¢å¼•çš„æŸ¥è¯¢ï¼ˆç´¢å¼•åˆ—å’ŒæŸ¥è¯¢åˆ—ä¸€è‡´ï¼‰ï¼‰ï¼Œå‡å°‘select *</p>
<p>6ã€ä½¿ç”¨ä¸ç­‰äº(!= æˆ–è€… &lt;&gt;)çš„æ—¶å€™ç´¢å¼•å¤±æ•ˆä¼šå¯¼è‡´rangeï¼ˆMySQL5ä¸­æ˜¯ALLï¼‰</p>
<p>7ã€ä½¿ç”¨is nullæˆ–è€…is not nullçš„æ—¶å€™ç´¢å¼•å¤±æ•ˆä¼šå¯¼è‡´rangeï¼ˆMySQL5ä¸­æ˜¯ALLï¼‰</p>
<p>8ã€likeä»¥é€šé…ç¬¦å¼€å¤´ç´¢å¼•å¤±æ•ˆä¼šå¯¼è‡´ALLï¼Œå»ºç«‹è¦†ç›–ç´¢å¼•å¯ä»¥é˜²æ­¢</p>
<p>9ã€MySQL5ä¸­å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ç´¢å¼•å¤±æ•ˆä¼šå¯¼è‡´ALLï¼ŒMySQL8ä¸­ç›´æ¥æŠ¥é”™</p>
<p>10ã€ä½¿ç”¨orè¿æ¥ç´¢å¼•å¤±æ•ˆä¼šå¯¼è‡´ALL</p>
<h3 id="ç´¢å¼•é¢è¯•"><a href="#ç´¢å¼•é¢è¯•" class="headerlink" title="ç´¢å¼•é¢è¯•"></a>ç´¢å¼•é¢è¯•</h3><blockquote>
<p>SQLè¯­å¥</p>
</blockquote>
<pre><code class="mysql">CREATE TABLE `tb4_test` (
  `id` int NOT NULL AUTO_INCREMENT,
  `c1` char(10) DEFAULT NULL,
  `c2` char(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,
  `c3` char(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,
  `c4` char(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,
  `c5` char(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE INDEX idx_tb4_test_c1234 ON tb4_test(c1, c2, c3, c4);

INSERT INTO `mysql_learn`.`tb4_test`(`id`, `c1`, `c2`, `c3`, `c4`, `c5`) VALUES (1, &#39;a1&#39;, &#39;a2&#39;, &#39;a3&#39;, &#39;a4&#39;, &#39;a5&#39;);
INSERT INTO `mysql_learn`.`tb4_test`(`id`, `c1`, `c2`, `c3`, `c4`, `c5`) VALUES (2, &#39;b1&#39;, &#39;b2&#39;, &#39;b3&#39;, &#39;b4&#39;, &#39;b5&#39;);
INSERT INTO `mysql_learn`.`tb4_test`(`id`, `c1`, `c2`, `c3`, `c4`, `c5`) VALUES (3, &#39;c1&#39;, &#39;c2&#39;, &#39;c3&#39;, &#39;c4&#39;, &#39;c5&#39;);
INSERT INTO `mysql_learn`.`tb4_test`(`id`, `c1`, `c2`, `c3`, `c4`, `c5`) VALUES (4, &#39;d1&#39;, &#39;d2&#39;, &#39;d3&#39;, &#39;d4&#39;, &#39;d5&#39;);
INSERT INTO `mysql_learn`.`tb4_test`(`id`, `c1`, `c2`, `c3`, `c4`, `c5`) VALUES (5, &#39;e1&#39;, &#39;e2&#39;, &#39;e3&#39;, &#39;e4&#39;, &#39;e5&#39;);</code></pre>
<blockquote>
<p>EXPLAINæµ‹è¯•</p>
</blockquote>
<pre><code class="mysql">-- æœ€å¥½ç´¢å¼•å¦‚ä½•åˆ›å»ºå°±å¦‚ä½•ä½¿ç”¨ï¼Œé¿å…è®©MySQLè‡ªå·±å†ç¿»è¯‘ä¼˜åŒ– --

-- 1. ç”¨åˆ°ç´¢å¼•c1 c2 c3 c4å…¨å­—æ®µï¼Œå…¨å€¼åŒ¹é…
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c2 = &#39;a2&#39; AND c3 = &#39;a3&#39; AND c4 = &#39;a4&#39;;

-- 2. ç”¨åˆ°ç´¢å¼•c1 c2 c3 c4å…¨å­—æ®µï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä¼˜åŒ–SQLè¯­å¥çš„æ‰§è¡Œé¡ºåº
EXPLAIN SELECT * FROM tb4_test WHERE c4 = &#39;a4&#39; AND c3 = &#39;a3&#39; AND c2 = &#39;a2&#39; AND c1 = &#39;a1&#39;;

-- 3. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc4å­—æ®µå¤±æ•ˆï¼ŒèŒƒå›´ä¹‹åå…¨å¤±æ•ˆ
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c2 = &#39;a2&#39; AND c3 &gt; &#39;a3&#39; AND c4 = &#39;a4&#39;;

-- 4. ç”¨åˆ°ç´¢å¼•c1 c2 c3 c4å…¨å­—æ®µï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä¼˜åŒ–SQLè¯­å¥çš„æ‰§è¡Œé¡ºåº
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c2 = &#39;a2&#39; AND c4 &gt; &#39;a4&#39; AND c3 = &#39;a3&#39;;

-- order byæ’åºä¸€å®šè¦æ³¨æ„é¡ºåºï¼Œè¿™ä¸ªé¡ºåºMySQLä¸ä¼šè‡ªåŠ¨ä¼˜åŒ– --

-- 5. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc1 c2ç”¨äºæŸ¥æ‰¾ï¼Œc3ç”¨äºæ’åºï¼Œä½†æ˜¯æ²¡æœ‰ç»Ÿè®¡åˆ°key_lenä¸­ï¼Œc4å­—æ®µå¤±æ•ˆ
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c2 = &#39;a2&#39; AND c4 &gt; &#39;a4&#39; ORDER BY c3;

-- 6. ç”¨åˆ°ç´¢å¼•c1 c2å­—æ®µï¼Œc1 c2ç”¨äºæŸ¥æ‰¾ï¼Œc4æ’åºäº§ç”Ÿäº†Using filesortè¯´æ˜c4å¤±æ•ˆ
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c2 = &#39;a2&#39; ORDER BY c4;

-- 7. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc1ç”¨äºæŸ¥æ‰¾ï¼Œc2 c3ç”¨äºæ’åº
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c5 = &#39;a5&#39; ORDER BY c2, c3;

-- 8. ç”¨åˆ°ç´¢å¼•c1å­—æ®µï¼Œc1ç”¨äºæŸ¥æ‰¾ï¼Œc3 c2å¤±æ•ˆï¼Œäº§ç”Ÿäº†Using filesort
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c5 = &#39;a5&#39; ORDER BY c3, c2;

-- 9. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc1 c2ç”¨äºæŸ¥æ‰¾ï¼Œc2 c3ç”¨äºæ’åº
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c2 = &#39;a2&#39; AND c5 = &#39;a5&#39; ORDER BY c2, c3;

-- 10. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc1 c2ç”¨äºæŸ¥æ‰¾ï¼Œc3æ‰ç”¨äºæ’åº
--     æ²¡æœ‰äº§ç”ŸUsing filesortï¼Œå› ä¸ºc2æŸ¥æ‰¾æ—¶å·²ç»ç¡®å®šäº†ï¼Œæ’åºæ—¶c2å·²ç»ä¸ç”¨æ’åºäº†
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c2 = &#39;a2&#39; AND c5 = &#39;a5&#39; ORDER BY c3, c2;

-- group byè™½ç„¶æ˜¯åˆ†ç»„ï¼Œä½†æ˜¯åˆ†ç»„ä¹‹å‰å¿…ç„¶æ’åº --

-- 11. ç”¨åˆ°ç´¢å¼•c1 c2 c3å­—æ®µï¼Œc1ç”¨äºæŸ¥æ‰¾ï¼Œc2 c3ç”¨äºæ’åºï¼Œc4å¤±æ•ˆ
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c4 = &#39;a4&#39; GROUP BY c2, c3;

-- 12. ç”¨åˆ°ç´¢å¼•c1å­—æ®µï¼Œc1ç”¨äºæŸ¥æ‰¾ï¼Œc2 c3å¤±æ•ˆï¼Œäº§ç”Ÿäº†Using temporary
EXPLAIN SELECT * FROM tb4_test WHERE c1 = &#39;a1&#39; AND c4 = &#39;a4&#39; GROUP BY c3, c2;</code></pre>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<ul>
<li>å®šå€¼ã€èŒƒå›´è¿˜æ˜¯æ’åºï¼Œä¸€èˆ¬order byæ˜¯ç»™ä¸ªèŒƒå›´ã€‚</li>
<li>group byåŸºæœ¬ä¸Šéƒ½éœ€è¦è¿›è¡Œæ’åºï¼Œä¼šæœ‰ä¸´æ—¶è¡¨äº§ç”Ÿã€‚</li>
<li>likeåŒ¹é…%åœ¨å­—ç¬¦ä¸²æœ€å³è¾¹ä¼šä½¿ç”¨ä½¿ç”¨ï¼Œ%åœ¨å­—ç¬¦ä¸²æœ€å·¦è¾¹ä¸ä¼šä½¿ç”¨ã€‚</li>
</ul>
<blockquote>
<p>ä¸€èˆ¬æ€§å»ºè®®</p>
</blockquote>
<ul>
<li><p>å¯¹äºå•é”®ç´¢å¼•ï¼Œå°½é‡é€‰æ‹©é’ˆå¯¹å½“å‰queryè¿‡æ»¤æ€§æ›´å¥½çš„ç´¢å¼•ã€‚</p>
</li>
<li><p>åœ¨é€‰æ‹©ç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå½“å‰queryä¸­è¿‡æ»¤æ€§æœ€å¥½çš„å­—æ®µåœ¨ç´¢å¼•å­—æ®µé¡ºåºä¸­ï¼Œä½ç½®è¶Šé å‰è¶Šå¥½ã€‚</p>
</li>
<li><p>åœ¨é€‰æ‹©ç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå°½é‡é€‰æ‹©å¯ä»¥èƒ½å¤ŸåŒ…å«å½“å‰queryä¸­çš„whereå­å¥ä¸­æ›´å¤šå­—æ®µçš„ç´¢å¼•ã€‚</p>
</li>
<li><p>å°½å¯èƒ½é€šè¿‡åˆ†æç»Ÿè®¡ä¿¡æ¯å’Œè°ƒæ•´queryçš„å†™æ³•æ¥è¾¾åˆ°é€‰æ‹©åˆé€‚ç´¢å¼•çš„ç›®çš„ã€‚</p>
</li>
</ul>
<blockquote>
<p>ä¼˜åŒ–å£è¯€</p>
</blockquote>
<p>å¸¦å¤´å¤§å“¥ä¸èƒ½æ­»ï¼Œä¸­é—´å…„å¼Ÿä¸èƒ½æ–­ï¼›</p>
<p>è¦†ç›–ç´¢å¼•ä¸å†™æ˜Ÿï¼Œç´¢å¼•åˆ—ä¸Šå°‘è®¡ç®—ï¼›</p>
<p>ä¸ç­‰æœ‰æ—¶ä¼šå¤±æ•ˆï¼ŒèŒƒå›´ä¹‹åå…¨å¤±æ•ˆï¼›</p>
<p>LIKEç™¾åˆ†å†™æœ€å³ï¼Œä¸€èˆ¬SQLå°‘ç”¨ORã€‚</p>
<h2 id="æŸ¥è¯¢æˆªå–"><a href="#æŸ¥è¯¢æˆªå–" class="headerlink" title="æŸ¥è¯¢æˆªå–"></a>æŸ¥è¯¢æˆªå–</h2><h3 id="æŸ¥è¯¢ä¼˜åŒ–-1"><a href="#æŸ¥è¯¢ä¼˜åŒ–-1" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–-1"></a>æŸ¥è¯¢ä¼˜åŒ–-1</h3><blockquote>
<p>ä¼˜åŒ–ç­–ç•¥</p>
</blockquote>
<p>æ°¸è¿œå°è¡¨é©±åŠ¨å¤§è¡¨ã€‚</p>
<blockquote>
<p>IN</p>
</blockquote>
<pre><code class="mysql">SELECT * FROM A WHERE id IN (SELECT id FROM B)</code></pre>
<p>ç­‰ä»·äºï¼š</p>
<pre><code>for select id from B
    for select * from A where A.id = B.id</code></pre>
<p>å½“Aè¡¨çš„æ•°æ®é›†å¤§äºBè¡¨çš„æ•°æ®é›†æ—¶ï¼Œç”¨inä¼˜å…ˆexistsã€‚</p>
<blockquote>
<p>EXISTS</p>
</blockquote>
<pre><code class="mysql">SELECT * FROM A WHERE EXISTS (SELECT 1 FROM B WHERE B.id = A.id)</code></pre>
<p>ç­‰ä»·äº</p>
<pre><code>for select id from A
    for select * from B = B.id = A.id</code></pre>
<p>å½“Aè¡¨çš„æ•°æ®é›†å°äºBè¡¨çš„æ•°æ®é›†æ—¶ï¼Œç”¨existsä¼˜å…ˆinã€‚</p>
<h3 id="æŸ¥è¯¢ä¼˜åŒ–-2"><a href="#æŸ¥è¯¢ä¼˜åŒ–-2" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–-2"></a>æŸ¥è¯¢ä¼˜åŒ–-2</h3><blockquote>
<p>ä¼˜åŒ–ç­–ç•¥</p>
</blockquote>
<p>Order Byå…³é”®å­—ä¼˜åŒ–ï¼š</p>
<p>Order Byå­å¥ï¼Œå°½é‡ä½¿ç”¨Indexæ–¹å¼æ’åºï¼Œé¿å…ä½¿ç”¨FileSortæ–¹å¼æ’åºã€‚</p>
<p>å°½å¯èƒ½åœ¨ç´¢å¼•åˆ—ä¸Šå®Œæˆæ’åºæ“ä½œï¼Œéµç…§ç´¢å¼•å»ºçš„æœ€ä½³å·¦å‰ç¼€ã€‚</p>
<p>å¦‚æœä¸åœ¨ç´¢å¼•åˆ—ä¸Šï¼ŒFileSortæœ‰ä¸¤ç§ç®—æ³•ï¼šMySQLå°±è¦å¯åŠ¨åŒè·¯æ’åºå’Œå•è·¯æ’åºã€‚</p>
<blockquote>
<p>æ¡ˆä¾‹</p>
</blockquote>
<p>SQLè„šæœ¬ï¼š</p>
<pre><code class="mysql">CREATE TABLE `tb5_a` (
  `age` int NOT NULL,
  `birth` timestamp NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

INSERT INTO tb5_a(age, birth) VALUES(17, NOW());
INSERT INTO tb5_a(age, birth) VALUES(18, NOW());
INSERT INTO tb5_a(age, birth) VALUES(19, NOW());

CREATE INDEX idx_a_agebirth ON tb5_a(age, birth);</code></pre>
<p>å…«ä¸ªcaseï¼š</p>
<ul>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE age &gt; 20 ORDER BY age;</code> =&gt; æ­£å¸¸</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE age &gt; 20 ORDER BY birth;</code> =&gt; using filesort</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE age &gt; 20 ORDER BY age, birth;</code> =&gt; æ­£å¸¸</li>
<li><code> EXPLAIN SELECT * FROM tb5_a WHERE age &gt; 20 ORDER BY birthï¼Œage;</code> =&gt; using filesprt</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE birth &gt; &#39;2020-3:23 00:00:00&#39; ORDER BY age;</code> =&gt; æ­£å¸¸</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE birth &gt; &#39;2020-3:23 00:00:00&#39; ORDER BY birth;</code> =&gt; using filesort</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE birth &gt; &#39;2020-3:23 00:00:00&#39; ORDER BY age,birth;</code> =&gt; æ­£å¸¸</li>
<li><code>EXPLAIN SELECT * FROM tb5_a WHERE birth &gt; &#39;2020-3:23 00:00:00&#39; ORDER BY birth,age;</code> =&gt; using filesort</li>
<li><code>EXPLAIN SELECT * FROM tb5_a ORDER BY age ASC,birth ASC;</code> =&gt; æ­£å¸¸</li>
<li><code>EXPLAIN SELECT * FROM tb5_a ORDER BY age DESC,birth DESC;</code> =&gt; æ­£å¸¸</li>
<li><code>EXPLAIN SELECT * FROM tb5_a ORDER BY age ASC,birth DESC;</code> =&gt; using filesort</li>
<li><code>EXPLAIN SELECT * FROM tb5_a ORDER BY age DESC,birth ASC;</code> =&gt; using filesort</li>
</ul>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<p>æ€»ç»“ï¼šOrder Byæ»¡è¶³ä¸¤ç§æƒ…å†µï¼Œä¼šä½¿ç”¨Indexæ–¹å¼æ’åºï¼š</p>
<ul>
<li>Order Byè¯­å¥ä½¿ç”¨ç´¢å¼•æœ€å·¦å‰åˆ—</li>
<li>ä½¿ç”¨Whereå­å¥ä¸Order Byå­å¥æ¡ä»¶åˆ—ç»„åˆæ»¡è¶³ç´¢å¼•æœ€å·¦å‰åˆ—</li>
</ul>
<p>æ³¨æ„ï¼šå¦‚æœä¸åœ¨ç´¢å¼•åˆ—ä¸Šï¼Œfilesortæœ‰ä¸¤ç§ç®—æ³•ï¼š</p>
<ul>
<li>åŒè·¯æ’åºï¼šä¸¤æ¬¡æ‰«æç£ç›˜è·å–æ•°æ®ï¼Œè¯»å–è¡ŒæŒ‡é’ˆå’Œorder byåˆ—ï¼Œå¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼Œç„¶åæ‰«æå·²ç»æ’åºå·çš„åˆ—è¡¨ï¼ŒæŒ‰ç…§åˆ—è¡¨ä¸­çš„å€¼é‡æ–°ä»åˆ—è¡¨ä¸­è¯»å–å¯¹åº”çš„æ•°æ®è¾“å‡ºã€‚</li>
<li>å•è·¯æ’åºï¼šä»ç£ç›˜è¯»å–æŸ¥è¯¢éœ€è¦çš„æ‰€æœ‰åˆ—ï¼ŒæŒ‰ç…§order byåˆ—åœ¨bufferå¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼Œç„¶åæ‰«ææ’åºåçš„åˆ—è¡¨è¿›è¡Œè¾“å‡ºï¼Œå®ƒçš„æ•ˆç‡æ›´å¿«ä¸€äº›ï¼Œé¿å…äº†ç¬¬äºŒæ¬¡è¯»å–æ•°æ®ã€‚å¹¶ä¸”æŠŠéšæœºIOå˜æˆäº†é¡ºåºIOï¼Œä½†æ˜¯å®ƒä¼šä½¿ç”¨æ›´å¤šçš„ç©ºé—´ï¼Œå› ä¸ºå®ƒæŠŠæ¯ä¸€è¡Œéƒ½ä¿å­˜åœ¨å†…å­˜ä¸­äº†ã€‚</li>
<li>å•è·¯é—®é¢˜ï¼šåœ¨å•è·¯æ’åºä¸­ï¼Œè¦å ç”¨å¾ˆå¤šç©ºé—´ï¼Œå› ä¸ºéœ€è¦æŠŠæ‰€æœ‰å­—æ®µéƒ½å–å‡ºï¼Œæ‰€ä»¥æœ‰å¯èƒ½å–å‡ºçš„æ•°æ®çš„æ€»å¤§å°è¶…å‡ºäº†sort_bufferçš„å®¹é‡ï¼Œå¯¼è‡´æ¯æ¬¡åªèƒ½å–sort_bufferå®¹é‡å¤§å°çš„æ•°æ®ï¼Œè¿›è¡Œæ’åºï¼ˆåˆ›å»ºtmpæ–‡ä»¶ï¼Œå¤šè·¯åˆå¹¶ï¼‰ï¼Œæ’å®Œå†å–sort_bufferå®¹é‡å¤§å°ï¼Œå†æ’ï¼Œä»è€Œå¯¼è‡´å¤šæ¬¡I/Oã€‚</li>
<li>ä¼˜åŒ–ç­–ç•¥ï¼šSQLæœåŠ¡å™¨å‚æ•°è°ƒä¼˜ï¼Œå¢å¤§sort_buffer_sizeå‚æ•°çš„è®¾ç½®ï¼Œå¢å¤§max_length_for_sort_dataå‚æ•°çš„è®¾ç½®ã€‚</li>
</ul>
<p>æé«˜Order Byçš„é€Ÿåº¦ï¼š</p>
<p>ï¼ˆ1ï¼‰Order Byæ—¶select *æ˜¯ä¸€ä¸ªå¤§å¿Œï¼ŒåªæŸ¥è¯¢éœ€è¦å­—æ®µï¼Œè¿™ç‚¹éå¸¸é‡è¦ã€‚</p>
<p>ï¼ˆ2ï¼‰å°è¯•æé«˜sort_buffer_sizeã€‚</p>
<p>ï¼ˆ3ï¼‰å°è¯•æé«˜max_length_for_sort_dataã€‚</p>
<blockquote>
<p>æ’åºæ¡ˆä¾‹</p>
</blockquote>
<pre><code class="mysql">index a_b_c(a, b, c);

-- ä½¿ç”¨ç´¢å¼•æœ€å·¦å‰ç¼€
ORDER BY a
ORDER BY a, b
ORDER BY a, b, c
ORDER BY a DESC, b DESC, c DESC

-- WHEREä½¿ç”¨ç´¢å¼•çš„æœ€å·¦å‰ç¼€å®šä¹‰ä¸ºå¸¸é‡
WHERE a = const ORDER BY b, c
WHERE a = const AND b = const ORDER BY c
WHERE a = const ORDER BY b, c
WHERE a = count AND b &gt; const ORDER BY b, c

-- ä¸èƒ½ä½¿ç”¨æˆ·ç´¢å¼•è¿›è¡Œæ’åº
ORDER BY a ASC, b DESC, c DESC  -- æ’åºä¸ä¸€è‡´
WHERE g = const ORDER BY b, c   -- ä¸¢å¤±aç´¢å¼•
WHERE a = const ORDER BY  c     -- ä¸¢å¤±bç´¢å¼•
WHERE a = const ORDER BY a, d   -- dä¸æ˜¯ç´¢å¼•çš„ä¸€éƒ¨åˆ†
WHERE a IN (...) ORDER BY b, c  -- å¯¹äºæ’åºæ¥è¯´ï¼Œå¤šä¸ªç›¸ç­‰æ¡ä»¶ä¹Ÿæ˜¯èŒƒå›´æŸ¥è¯¢</code></pre>
<h3 id="æŸ¥è¯¢ä¼˜åŒ–-3"><a href="#æŸ¥è¯¢ä¼˜åŒ–-3" class="headerlink" title="æŸ¥è¯¢ä¼˜åŒ–-3"></a>æŸ¥è¯¢ä¼˜åŒ–-3</h3><blockquote>
<p>ä¼˜åŒ–ç­–ç•¥</p>
</blockquote>
<p>Group Byå…³é”®å­—ä¼˜åŒ–ï¼š</p>
<p>ä¼˜åŒ–ç­–ç•¥ä¸Order Byç›¸ä¼¼ã€‚</p>
<p>Group Byå®è´¨æ˜¯å…ˆæ’åºåè¿›è¡Œåˆ†ç»„ï¼Œéµç…§ç´¢å¼•å»ºçš„æœ€ä½³å·¦å‰ç¼€ã€‚</p>
<p>å½“æ— æ³•ä½¿ç”¨ç´¢å¼•åˆ—ï¼Œå¢å¤§max_length_for_sort_dataå‚æ•°è®¾ç½®ï¼Œå¢å¤§sort_buffer_sizeå‚æ•°çš„è®¾ç½®ã€‚</p>
<p>whereé«˜äºhavingï¼Œèƒ½å¸è½½whereé™å®šçš„æ¡ä»¶å°±ä¸è¦å»havingé™å®šäº†ã€‚</p>
<h3 id="æ…¢æŸ¥è¯¢æ—¥å¿—"><a href="#æ…¢æŸ¥è¯¢æ—¥å¿—" class="headerlink" title="æ…¢æŸ¥è¯¢æ—¥å¿—"></a>æ…¢æŸ¥è¯¢æ—¥å¿—</h3><blockquote>
<p>ç®€ä»‹</p>
</blockquote>
<ul>
<li><p>MySQLçš„æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯MySQLæä¾›çš„ä¸€ç§æ—¥å¿—è®°å½•ï¼Œå®ƒç”¨æ¥è®°å½•åœ¨MySQLä¸­å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼çš„è¯­å¥ï¼Œå…·ä½“æŒ‡è¿è¡Œæ—¶é—´è¶…è¿‡long_query_timeå€¼çš„SQLï¼Œåˆ™ä¼šè¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ã€‚</p>
</li>
<li><p>å…·ä½“æŒ‡è¿è¡Œæ—¶é—´è¶…è¿‡long_query_timeå€¼çš„SQLï¼Œåˆ™ä¼šè¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ã€‚long_query_timeçš„é»˜è®¤å€¼ä¸º10ï¼Œæ„æ€æ˜¯è¿è¡Œ10ç§’ä»¥ä¸Šçš„è¯­å¥ã€‚</p>
</li>
<li><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQLæ•°æ®åº“æ²¡æœ‰å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ¥è®¾ç½®è¿™ä¸ªå‚æ•°ã€‚</p>
</li>
<li><p>å½“ç„¶ï¼Œå¦‚æœä¸æ˜¯è°ƒä¼˜éœ€è¦çš„è¯ï¼Œä¸€èˆ¬ä¸å»ºè®®å¯åŠ¨è¯¥å‚æ•°ï¼Œå› ä¸ºå¼€å¯æ¼«é•¿å“ˆè®¯æ—¥å¿—ä¼šæˆ–å¤šæˆ–å°‘å¸¦æ¥ä¸€å®šçš„æ€§èƒ½å½±å“ã€‚æ…¢æŸ¥è¯¢æ—¥å¿—æ”¯æŒå°†æ—¥å¿—è®°å½•å†™å…¥æ–‡ä»¶ã€‚</p>
</li>
</ul>
<blockquote>
<p>é…ç½®</p>
</blockquote>
<p>æŸ¥çœ‹æ˜¯å¦å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å’Œæ–‡ä»¶ä½ç½®ï¼š</p>
<pre><code class="mysql">mysql&gt; SHOW VARIABLES LIKE &#39;%SLOW_QUERY_LOG%&#39;;
+---------------------+-------------------------------+
| Variable_name       | Value                         |
+---------------------+-------------------------------+
| slow_query_log      | OFF                           |
| slow_query_log_file | /var/lib/mysql/parak-slow.log |
+---------------------+-------------------------------+</code></pre>
<p>å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆåªå¯¹æœ¬æ¬¡ç”Ÿæ•ˆï¼Œé‡å¯åå¤±æ•ˆï¼‰ï¼š</p>
<pre><code class="mysql">SET global slow_query_log = 1;</code></pre>
<p>æŸ¥çœ‹æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆé»˜è®¤ä¸º10sï¼‰ï¼š</p>
<pre><code class="mysql">mysql&gt; SHOW VARIABLES LIKE &#39;long_query_time%&#39;;
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |
+-----------------+-----------+</code></pre>
<p>è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆ3sï¼‰ï¼š</p>
<pre><code class="mysql">SET global long_query_time = 3;</code></pre>
<p>æŸ¥çœ‹æ…¢æŸ¥è¯¢è®°å½•æ•°é‡ï¼š</p>
<pre><code class="mysql">SHOW global STATUS LIKE &#39;%SLOW_QUERIES%&#39;;</code></pre>
<p>æ°¸ä¹…ç”Ÿæ•ˆéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/my.cnfï¼Œéœ€è¦åœ¨[mysqld]ä¸‹å¢åŠ æˆ–ä¿®æ”¹å‚æ•°ï¼š</p>
<pre><code class="mysql">slow_query_log = 1
slow_query_log_file = /var/lib/mysql/&lt;hostname&gt;-slow.log
long_query_time  = &lt;time&gt;</code></pre>
<blockquote>
<p>mysqldumpslow</p>
</blockquote>
<p>å‚æ•°ï¼š</p>
<ul>
<li>sï¼šè¡¨ç¤ºæŒ‰ç…§ä½•ç§æ–¹å¼æ’åº</li>
<li>cï¼šè®¿é—®æ¬¡æ•°</li>
<li>lï¼šé”å®šæ—¶é—´</li>
<li>rï¼šè¿”å›è®°å½•</li>
<li>tï¼šæŸ¥è¯¢æ—¶é—´</li>
<li>alï¼šå¹³å‡é”å®šæ—¶é—´</li>
<li>arï¼šå¹³å‡è¿”å›è®°å½•æ•°é‡</li>
<li>atï¼šå¹³å‡æŸ¥è¯¢æ—¶é—´</li>
<li>tï¼šè¿”å›æ•°æ®æ•°é‡</li>
<li>gï¼šæ­£åˆ™åŒ¹é…ï¼Œå¤§å°å†™ä¸æ•æ„Ÿ</li>
</ul>
<p>å¾—åˆ°è¿”å›è®°å½•æœ€å¤šçš„10ä¸ªSQLï¼š</p>
<pre><code class="mysql">mysqldumpslow -s r -t 10 /var/lib/mysql/parak-slow.log</code></pre>
<p>å¾—åˆ°è®¿é—®æ¬¡æ•°æœ€å¤šçš„10ä¸ªSQLï¼š</p>
<pre><code class="mysql">mysqldumpslow -s c -t 10 /var/lib/mysql/parak-slow.log</code></pre>
<p>å¾—åˆ°æŒ‰ç…§æ—¶é—´æ’åºçš„å‰10æ¡é‡Œé¢å«æœ‰å·¦è¿æ¥çš„æŸ¥è¯¢è¯­å¥ï¼š</p>
<pre><code class="mysql">mysqldumpslow -s t -t 10 -g &quot;left join&quot; /var/lib/mysql/parak-slow.log</code></pre>
<p>å»ºè®®åœ¨ä½¿ç”¨è¿™äº›å‘½ä»¤æ—¶ç»“åˆ | å’Œ moreä½¿ç”¨ï¼Œé˜²æ­¢çˆ†å±ã€‚</p>
<h3 id="æ‰¹é‡æ•°æ®è„šæœ¬"><a href="#æ‰¹é‡æ•°æ®è„šæœ¬" class="headerlink" title="æ‰¹é‡æ•°æ®è„šæœ¬"></a>æ‰¹é‡æ•°æ®è„šæœ¬</h3><blockquote>
<p>é…ç½®</p>
</blockquote>
<p>å˜é‡<code>log_bin_trust_function_creators</code>ï¼šæ§åˆ¶æ˜¯å¦å¯ä»¥ä¿¡ä»»å­˜å‚¨å‡½æ•°åˆ›å»ºè€…ï¼Œä¸ä¼šåˆ›å»ºå†™å…¥äºŒè¿›åˆ¶æ—¥å¿—å¼•èµ·ä¸å®‰å…¨äº‹ä»¶çš„å­˜å‚¨å‡½æ•°ã€‚</p>
<p>æŸ¥çœ‹æ˜¯å¦å¼€å¯ï¼š</p>
<pre><code class="mysql">mysql&gt; SHOW VARIABLES LIKE &#39;log_bin_trust_function_creators&#39;;
+---------------------------------+-------+
| Variable_name                   | Value |
+---------------------------------+-------+
| log_bin_trust_function_creators | OFF   |
+---------------------------------+-------+</code></pre>
<p>å¼€å¯ï¼ˆæš‚æ—¶æ€§å¼€å¯ï¼Œæ°¸ä¹…æ€§ä¾ç„¶æ˜¯ä¿®æ”¹my.cnfï¼‰ï¼š</p>
<pre><code class="mysql"> SET global log_bin_trust_function_creators = 1;</code></pre>
<blockquote>
<p>æ•°æ®å‡†å¤‡</p>
</blockquote>
<pre><code class="mysql">CREATE TABLE `tb6_dept` (
  `id` int NOT NULL AUTO_INCREMENT,
  `deptno` mediumint NOT NULL DEFAULT &#39;0&#39;,
  `dname` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `loc` varchar(13) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE `tb6_emp` (
  `id` int NOT NULL AUTO_INCREMENT,
  `empno` mediumint NOT NULL DEFAULT &#39;0&#39;,
  `ename` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `job` varchar(9) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `mgr` mediumint NOT NULL DEFAULT &#39;0&#39;,
  `hiredate` date NOT NULL,
  `sal` decimal(7,2) NOT NULL,
  `comm` decimal(7,2) DEFAULT NULL,
  `deptno` mediumint NOT NULL DEFAULT &#39;0&#39;,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;</code></pre>
<blockquote>
<p>åˆ›å»ºå‡½æ•°</p>
</blockquote>
<pre><code class="mysql"># éšæœºäº§ç”Ÿå­—ç¬¦ä¸²
DELIMITER $$
CREATE FUNCTION rand_string(n INT) RETURNS VARCHAR(255)
BEGIN
    DECLARE chars_str VARCHAR(100) DEFAULT &#39;abcdefghijklmnopqrstuvwsyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;;
    DECLARE return_str VARCHAR(255) DEFAULT &#39;&#39;;
    DECLARE i INT DEFAULT 0;
    WHILE i &lt; n DO
    SET return_str = CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));
    SET i = i + 1;
    END WHILE;
    RETURN return_str;
END $$

# éšæœºäº§ç”Ÿéƒ¨é—¨ç¼–å·
DELIMITER $$
CREATE FUNCTION rand_num() RETURNS INT(5)
BEGIN
    DECLARE i INT DEFAULT 0;
    SET i = FLOOR(100 + RAND() * 10);
    RETURN i;
END $$</code></pre>
<blockquote>
<p>åˆ›å»ºå­˜å‚¨è¿‡ç¨‹</p>
</blockquote>
<pre><code class="mysql"># å‘tb6_deptè¡¨æ‰¹é‡æ’å…¥
DELIMITER $$
CREATE PROCEDURE insert_dept(IN START INT(10),IN max_num INT(10))
BEGIN
DECLARE i INT DEFAULT 0;
    SET autocommit = 0;
    REPEAT
    SET i = i + 1;
    INSERT INTO dept(deptno,dname,loc) VALUES((START + i),rand_string(10),rand_string(8));
    UNTIL i = max_num
    END REPEAT;
    COMMIT;
END $$

# å‘tb6_empè¡¨æ‰¹é‡æ’å…¥
DELIMITER $$
CREATE PROCEDURE insert_emp(IN START INT(10),IN max_num INT(10))
BEGIN
DECLARE i INT DEFAULT 0;
    SET autocommit = 0;
    REPEAT
    SET i = i + 1;
    INSERT INTO emp(empno,ename,job,mgr,hiredata,sal,comm,deptno) VALUES((START + i),rand_string(6),&#39;SALESMAN&#39;,0001,CURDATE(),2000,400,rand_num());
    UNTIL i = max_num
    END REPEAT;
    COMMIT;
END $$</code></pre>
<blockquote>
<p>æ‰¹é‡æ’å…¥æ•°æ®</p>
</blockquote>
<pre><code class="mysql"># å‘tb6_deptä¸­æ’å…¥10æ¡æ•°æ®
DELIMITER ;
CALL insert_dept(100, 10);

# å‘tb6_empä¸­æ’å…¥50ä¸‡æ¡æ•°æ®
DELIMITER ;
CALL insert_emp(100001, 500000);</code></pre>
<h3 id="Show-Profile"><a href="#Show-Profile" class="headerlink" title="Show Profile"></a>Show Profile</h3><blockquote>
<p>æ¦‚è¿°</p>
</blockquote>
<p>MySQLæä¾›çš„å¯ä»¥ç”¨æ¥åˆ†æå½“å‰ä¼šè¯ä¸­è¯­å¥æ‰§è¡Œçš„èµ„æºæ¶ˆè€—æƒ…å†µï¼Œå¯ä»¥ç”¨äºSQLè°ƒä¼˜çš„æµ‹é‡ã€‚</p>
<p>å®˜ç½‘ï¼š<a href="https://dev.mysql.com/doc/refman/8.0/en/show-profile.html">https://dev.mysql.com/doc/refman/8.0/en/show-profile.html</a></p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå‚æ•°å¤„äºå…³é—­çŠ¶æ€ï¼Œå¹¶ä¿å­˜æœ€è¿‘15æ¬¡çš„è¿è¡Œç»“æœã€‚</p>
<blockquote>
<p>é…ç½®</p>
</blockquote>
<p>æŸ¥çœ‹å¼€å¯çŠ¶æ€ï¼š</p>
<pre><code class="mysql">mysql&gt; SHOW VARIABLES LIKE &#39;profiling&#39;;
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| profiling     | OFF   |
+---------------+-------+</code></pre>
<p>å¼€å¯ï¼š</p>
<pre><code class="mysql">SET global profiling = 1;</code></pre>
<p>MySQL8éœ€è¦å…³é—­ä¾èµ–æ£€æµ‹ï¼Œå³ä»sql_modeä¸­ç§»é™¤<code>ONLY_FULL_GROUP_BY</code>ï¼š</p>
<p>æŸ¥çœ‹sql_modeï¼š</p>
<pre><code class="mysql">mysql&gt; SELECT @@global.sql_mode;
+-----------------------------------------------------------------------------------------------------------------------+
| @@global.sql_mode                                                                                                     |
+-----------------------------------------------------------------------------------------------------------------------+
| ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION |
+-----------------------------------------------------------------------------------------------------------------------+</code></pre>
<p>ç§»é™¤<code>ONLY_FULL_GROUP_BY</code>ï¼š</p>
<pre><code class="mysql">SET global @@sql_mode = `STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION`;</code></pre>
<blockquote>
<p>ç›¸å…³å‘½ä»¤</p>
</blockquote>
<p>æŸ¥çœ‹SQLï¼š<code>SHOW PROFILES</code></p>
<p>è¯Šæ–­SQLï¼š<code>SHOW PROFILE &lt;type ...&gt; FOR QUERY &lt;Query_ID&gt;</code></p>
<p>å¯é€‰å‚æ•°å¦‚ä¸‹ï¼š</p>
<pre><code class="mysql">| ALL                -- æ˜¾ç¤ºæ‰€æœ‰çš„å¼€é”€ä¿¡æ¯
| BLOCK IO           -- æ˜¾ç¤ºå—IOç›¸å…³å¼€é”€
| CONTEXT SWITCHES   -- ä¸Šä¸‹æ–‡åˆ‡æ¢ç›¸å…³å¼€é”€
| CPU                -- æ˜¾ç¤ºCPUç›¸å…³å¼€é”€ä¿¡æ¯
| IPC                -- æ˜¾ç¤ºå†…å­˜ç›¸å…³å¼€é”€ä¿¡æ¯
| MEMORY             -- æ˜¾ç¤ºå†…å­˜ç›¸å…³å¼€é”€ä¿¡æ¯
| PAGE FAULTS        -- æ˜¾ç¤ºé¡µé¢é”™è¯¯ç›¸å…³å¼€é”€ä¿¡æ¯
| SOURCE             -- æ˜¾ç¤ºå’ŒSource_function, Source_file, Source_lineç›¸å…³çš„å¼€é”€ä¿¡æ¯
| SWAPS              -- æ˜¾ç¤ºäº¤æ¢æ¬¡æ•°ç›¸å…³å¼€é”€çš„ä¿¡æ¯</code></pre>
<blockquote>
<p>æ—¥å¸¸å¼€å‘éœ€è¦æ³¨æ„</p>
</blockquote>
<ul>
<li>converting HEAP to MyISAM æŸ¥è¯¢ç»“æœå¤ªå¤§ï¼Œå†…å­˜éƒ½ä¸å¤Ÿç”¨äº†ç‹ç£ç›˜ä¸Šæ¬äº†</li>
<li>Creating tmp table æ‹·è´æ•°æ®åˆ°ä¸´æ—¶è¡¨ï¼Œç”¨å®Œå†åˆ é™¤</li>
<li>Copying to tmp table on disk å§å†…å­˜ä¸­ä¸´æ—¶è¡¨å¤åˆ¶åˆ°ç£ç›˜ï¼Œå±é™©</li>
<li>locked æ­»é”</li>
</ul>
<h3 id="å…¨å±€æŸ¥è¯¢æ—¥å¿—"><a href="#å…¨å±€æŸ¥è¯¢æ—¥å¿—" class="headerlink" title="å…¨å±€æŸ¥è¯¢æ—¥å¿—"></a>å…¨å±€æŸ¥è¯¢æ—¥å¿—</h3><blockquote>
<p>æ°¸ä¹…å¯ç”¨</p>
</blockquote>
<p>ä¿®æ”¹my.cnfï¼Œè®¾ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="mysql"># å¼€å¯
general_log = 1
# è®°å½•æ—¥å¿—æ–‡ä»¶çš„è·¯å¾„
general_log_file = /&lt;path&gt;/&lt;name&gt;
# è¾“å‡ºæ ¼å¼
log_output = &lt;.extension&gt;</code></pre>
<blockquote>
<p>ä¸´æ—¶å¯ç”¨</p>
</blockquote>
<pre><code class="mysql">set global general_log = 1;
set global log_output = &#39;TABLE&#39;;</code></pre>
<blockquote>
<p>æ³¨æ„</p>
</blockquote>
<p>æ°¸è¿œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒå¼€å¯è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<h2 id="é”æœºåˆ¶"><a href="#é”æœºåˆ¶" class="headerlink" title="é”æœºåˆ¶"></a>é”æœºåˆ¶</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><blockquote>
<p>å‰è¨€</p>
</blockquote>
<p>é”æ˜¯è®¡ç®—æœºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¹¶å‘è®¿é—®æŸä¸€èµ„æºçš„æœºåˆ¶ã€‚</p>
<p>åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤ä¼ ç»Ÿçš„è®¡ç®—èµ„æºï¼ˆå¦‚CPUã€RAMã€I/Oç­‰ï¼‰çš„äº‰ç”¨ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¸€ç§ä¾›è®¸å¤šç”¨æˆ·å…±äº«çš„èµ„æºã€‚å¦‚ä½•ä¿è¯æ•°æ®å¹¶å‘è®¿é—®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§æ˜¯æ‰€æœ‰æ•°æ®åº“å¿…é¡»è§£å†³çš„ä¸€ä¸ªé—®é¢˜ï¼Œé”å†²çªä¹Ÿæ˜¯å½±å“æ•°æ®åº“å¹¶å‘è®¿é—®æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œé”å¯¹æ•°æ®åº“è€Œè¨€æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚</p>
<blockquote>
<p>åˆ†ç±»</p>
</blockquote>
<p>ä»å¯¹æ•°æ®æ“ä½œçš„ç±»å‹åˆ†ï¼š</p>
<ul>
<li>è¯»é”ï¼ˆå…±äº«é”ï¼‰ï¼šé’ˆå¯¹åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªè¯»æ“ä½œå¯ä»¥åŒæ—¶è¿›è¡Œè€Œä¸ä¼šç›¸äº’å½±å“ã€‚</li>
<li>å†™é”ï¼ˆæ’ä»–é”ï¼‰ï¼šå½“å‰å†™æ“ä½œæ²¡æœ‰å®Œæˆä¹‹å‰ï¼Œå®ƒä¼šé˜»æ–­å…¶ä»–å†™é”å’Œè¯»é”ã€‚</li>
</ul>
<p>ä»å¯¹æ•°æ®æ“ä½œçš„ç²’åº¦åˆ†ï¼š</p>
<ul>
<li>è¡Œçº§é”ï¼šå¯¹å½“å‰æ“ä½œçš„è¡ŒåŠ é”ã€‚ï¼ˆå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦æœ€é«˜ï¼‰</li>
<li>è¡¨çº§é”ï¼šå¯¹å½“å‰æ“ä½œçš„è¡¨åŠ é”ã€‚ï¼ˆå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘å‡ºé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ï¼‰</li>
<li>é¡µçº§é”ï¼šä»‹äºè¡Œçº§é”å’Œè¡¨çº§é”ä¸­é—´çš„ä¸€ç§é”ã€‚ï¼ˆå¼€é”€å’ŒåŠ é”æ—¶é—´ä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œä¼šå‡ºç°æ­»é”ï¼›å¹¶å‘åº¦ä¸€èˆ¬ï¼‰</li>
</ul>
<h3 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h3><blockquote>
<p>æ¦‚è¿°</p>
</blockquote>
<p>äº‹åŠ¡æ˜¯ç”±ä¸€ç»„SQLè¯­å¥ç»„æˆçš„é€»è¾‘å¤„ç†å•å…ƒï¼Œäº‹åŠ¡å…·æœ‰ä»¥ä¸‹4ä¸ªå±æ€§ï¼Œé€šå¸¸ç®€ç§°ä¸ºäº‹åŠ¡çš„ACIDå±æ€§ã€‚</p>
<ul>
<li><p>A(atomicity/åŸå­æ€§)ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œå•å…ƒï¼Œå…¶å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œè¦ä¹ˆå…¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚</p>
</li>
<li><p>C(consistency/ä¸€è‡´æ€§)ï¼šåœ¨äº‹åŠ¡å¼€å§‹å’Œå®Œæˆæ—¶ï¼Œæ•°æ®éƒ½å¿…é¡»ä¿æŒä¸€è‡´çŠ¶æ€ã€‚è¿™æ„å‘³ç€æ‰€æœ‰ç›¸å…³çš„æ•°æ®è§„åˆ™éƒ½å¿…é¡»åº”ç”¨äºäº‹åŠ¡çš„ä¿®æ”¹ï¼Œä»¥ä¿æŒæ•°æ®çš„å®Œæ•´æ€§ï¼›äº‹åŠ¡ç»“æŸæ—¶ï¼Œæ‰€æœ‰çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼ˆå¦‚Bæ ‘ç´¢å¼•æˆ–åŒå‘é“¾è¡¨ï¼‰ä¹Ÿéƒ½å¿…é¡»æ˜¯æ­£ç¡®çš„ã€‚</p>
</li>
<li><p>I(isolation/éš”ç¦»æ€§)ï¼šæ•°æ®åº“ç³»ç»Ÿæä¾›ä¸€å®šçš„éš”ç¦»æœºåˆ¶ï¼Œä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„â€œç‹¬ç«‹â€ç¯å¢ƒæ‰§è¡Œã€‚è¿™æ„å‘³ç€äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€å¯¹å¤–éƒ¨æ˜¯ä¸å¯è§çš„ï¼Œåä¹‹äº¦ç„¶ã€‚</p>
</li>
<li><p>D(durability/æŒä¹…æ€§)ï¼šäº‹åŠ¡å®Œæˆä¹‹åï¼Œå®ƒå¯¹äºæ•°æ®çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³æ—¶å‡ºç°ç³»ç»Ÿæ•…éšœä¹Ÿèƒ½å¤Ÿä¿æŒã€‚</p>
</li>
</ul>
<blockquote>
<p>å¹¶å‘äº‹åŠ¡å¤„ç†å¸¦æ¥çš„é—®é¢˜</p>
</blockquote>
<p><strong>æ›´æ–°ä¸¢å¤±ï¼ˆLost Updateï¼‰</strong></p>
<p>å½“ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡é€‰æ‹©åŒä¸€è¡Œï¼Œç„¶ååŸºäºæœ€åˆé€‰å®šçš„å€¼æ›´æ–°è¯¥è¡Œæ—¶ï¼Œç”±äºæ¯ä¸ªäº‹åŠ¡éƒ½ä¸çŸ¥é“å…¶ä»–äº‹åŠ¡çš„å­˜åœ¨ï¼Œå°±ä¼šå‘ç”Ÿä¸¢å¤±æ›´æ–°é—®é¢˜â€”â€”æœ€åçš„æ›´æ–°è¦†ç›–äº†ç”±å…¶ä»–äº‹åŠ¡æ‰€åšçš„æ›´æ–°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸¤ä¸ªç¨‹åºå‘˜ä¿®æ”¹åŒä¸€Javaæ–‡ä»¶ã€‚æ¯ç¨‹åºå‘˜ç‹¬ç«‹åœ°æ›´æ”¹å…¶å‰¯æœ¬ï¼Œç„¶åä¿å­˜æ›´æ”¹çš„å‰¯æœ¬åï¼Œè¿™æ ·å°±è¦†ç›–äº†åŸå§‹æ–‡æ¡£ã€‚æœ€åä¿å­˜å…¶æ›´æ”¹å‰¯æœ¬çš„ç¼–è¾‘äººå‘˜è¦†ç›–å‰ä¸€ä¸ªç¨‹åºå‘˜æ‰€åšçš„æ›´æ”¹ã€‚</p>
<p>å¦‚æœä¸€ä¸ªåœ¨ä¸€ä¸ªç¨‹åºå‘˜å®Œæˆå¹¶æäº¤äº‹åŠ¡ä¹‹å‰ï¼Œå¦ä¸€ä¸ªç¨‹åºå‘˜ä¸èƒ½è®¿é—®åŒä¸€æ–‡ä»¶ï¼Œåˆ™å¯é¿å…æ­¤é—®é¢˜ã€‚</p>
<p><strong>è„è¯»ï¼ˆDirty Readsï¼‰</strong></p>
<p>ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å¯¹ä¸€æ¡è®°å½•åšä¿®æ”¹ï¼Œåœ¨è¿™ä¸ªäº‹åŠ¡å®Œæˆå¹¶æäº¤å‰ï¼Œè¿™æ¡è®°å½•çš„æ•°æ®å°±å¤„äºä¸ä¸€è‡´çŠ¶æ€ï¼›è¿™æ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿæ¥è¯»å–åŒä¸€æ¡è®°å½•ï¼Œå¦‚æœä¸åŠ æ§åˆ¶ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡è¯»å–äº†è¿™äº›â€œè„â€æ•°æ®ï¼Œå¹¶æ®æ­¤åšè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œå°±ä¼šäº§ç”Ÿæœªæäº¤çš„æ•°æ®ä¾èµ–å…³ç³»ã€‚è¿™ç§ç°è±¡è¢«å½¢è±¡åœ°å«åšâ€œè„è¯»â€ã€‚</p>
<p>äº‹åŠ¡Aè¯»å–åˆ°äº‹åŠ¡Bå·²ä¿®æ”¹ä½†æœªæäº¤çš„æ•°æ®ï¼Œè¿˜åœ¨è¿™ä¸ªæ•°æ®åŸºç¡€ä¸Šåšäº†æ“ä½œã€‚æ­¤æ—¶ï¼Œå¦‚æœBäº‹åŠ¡å›æ»šï¼ŒAè¯»å–çš„æ•°æ®æ— æ•ˆï¼Œä¸ç¬¦åˆä¸€è‡´æ€§è¦æ±‚ã€‚</p>
<p><strong>ä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readsï¼‰</strong></p>
<p>ä¸€ä¸ªäº‹åŠ¡åœ¨æœåŠ¡æŸäº›æ•°æ®åçš„æŸä¸ªæ—¶é—´ï¼Œå†æ¬¡è¯»å–ä»¥å‰è¯»è¿‡çš„æ•°æ®ï¼Œå´å‘ç°å…¶è¯»å‡ºçš„æ•°æ®å·²ç»å‘ç”Ÿäº†æ”¹å˜ã€æˆ–æŸäº›è®°å½•å·²ç»è¢«åˆ é™¤ï¼Œè¿™ç§ç°è±¡å°±å«åšä¸å¯é‡å¤è¯»ã€‚</p>
<p>äº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bå·²ç»æäº¤çš„ä¿®æ”¹æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ã€‚</p>
<p><strong>å¹»è¯»ï¼ˆPhantom Readsï¼‰</strong></p>
<p>ä¸€ä¸ªäº‹åŠ¡æŒ‰ç›¸åŒçš„æŸ¥è¯¢æ¡ä»¶é‡æ–°è¯»å–ä»¥å‰æ£€ç´¢è¿‡çš„æ•°æ®ï¼Œå´å‘ç°å…¶ä»–äº‹åŠ¡æ’å…¥äº†æ»¡è¶³å…¶æŸ¥è¯¢æ¡ä»¶çš„æ–°æ•°æ®ï¼Œè¿™ç§ç°è±¡å°±ç§°ä¸ºâ€œå¹»è¯»â€ã€‚</p>
<p>äº‹åŠ¡Aè¯»å–åˆ°äº‹åŠ¡Bæäº¤çš„æ–°å¢æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§ã€‚</p>
<blockquote>
<p>äº‹åŠ¡éš”ç¦»çº§åˆ«</p>
</blockquote>
<p>â€œè„è¯»â€ã€â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€ï¼Œå…¶å®éƒ½æ˜¯æ•°æ®åº“è¯»ä¸€è‡´æ€§é—®é¢˜ï¼Œå¿…é¡»ç”±æ•°æ®åº“æä¾›ä¸€å®šçš„ä¹¦å±‹éš”ç¦»çº§åˆ«æ¥è§£å†³ã€‚</p>
<p>æ•°æ®åº“å®ç°äº‹åŠ¡éš”ç¦»çš„æ–¹å¼ï¼ŒåŸºæœ¬ä¸Šå¯åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š</p>
<ul>
<li>ä¸€ç§æ˜¯åœ¨è¯»å–æ•°æ®å‰ï¼Œå¯¹å…¶åŠ é”ï¼Œé˜»æ­¢å…¶ä»–äº‹ç‰©å¯¹æ•°æ®ä¿®æ”¹ã€‚</li>
<li>å¦ä¸€ç§æ˜¯ä¸ç”¨åŠ ä»»ä½•é”ï¼Œé€šè¿‡ä¸€å®šæœºåˆ¶ç”Ÿæˆä¸€ä¸ªæ•°æ®è¯·æ±‚æ—¶é—´ç‚¹çš„ä¸€è‡´æ€§æ•°æ®å¿«ç…§ï¼ˆSnapshotï¼‰ï¼Œå¹¶ç”¨è¿™ä¸ªå¿«ç…§æ¥æä¾›ä¸€å®šçº§åˆ«ï¼ˆè¯­å¥çº§æˆ–äº‹åŠ¡çº§ï¼‰çš„ä¸€è‡´æ€§è¯»å–ã€‚åŒç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œå¥½åƒæ˜¯æ•°æ®åº“å¯ä»¥æä¾›ç»Ÿä¸€æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œå› æ­¤ï¼Œè¿™ç§æŠ€æœ¯å«æ•°æ®å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMultiVersion Concurrency Controlï¼Œç®€ç§°MVCCæˆ–MCCï¼‰ï¼Œä¹Ÿç»å¸¸ç§°ä¸ºå¤šç‰ˆæœ¬æ•°æ®åº“ã€‚</li>
</ul>
<p>ä¸ºäº†è§£å†³â€œéš”ç¦»â€ä¸â€œå¹¶å‘â€çš„çŸ›ç›¾ï¼ŒISO/ANSI SQL92å®šä¹‰äº†4ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œæ¯ä¸ªçº§åˆ«çš„éš”ç¦»ç¨‹åº¦ä¸åŒï¼Œå…è®¸å‡ºç°çš„å‰¯ä½œç”¨ä¹Ÿä¸åŒï¼Œå…è®¸å‡ºç°çš„å‰¯ä½œç”¨ä¹Ÿä¸åŒï¼Œåº”ç”¨å¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘éœ€æ±‚ï¼Œé€šè¿‡é€‰æ‹©ä¸åŒçš„éš”ç¦»çº§åˆ«æ¥å¹³è¡¡â€œéš”ç¦»â€ä¸â€œå¹¶å‘â€çš„çŸ›ç›¾ã€‚</p>
<table>
<thead>
<tr>
<th>è¯»æ•°æ®ä¸€è‡´æ€§åŠå…è®¸çš„å¹¶å‘å‰¯ä½œç”¨éš”ç¦»çº§åˆ«</th>
<th>è¯»æ•°æ®ä¸€è‡´æ€§</th>
<th>è„è¯»</th>
<th>ä¸å¯é‡å¤è¯»</th>
<th>å¹»è¯»</th>
</tr>
</thead>
<tbody><tr>
<td>æœªæäº¤è¯»ï¼ˆRead uncommittedï¼‰</td>
<td>æœ€ä½çº§åˆ«ï¼Œåªèƒ½ä¿è¯ä¸è¯»å–ç‰©ç†ä¸ŠæŸåçš„æ•°æ®</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>å·²æäº¤è¯»ï¼ˆRead committedï¼‰</td>
<td>è¯­å¥çº§</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>å¯é‡å¤è¯»ï¼ˆRepeatable readï¼‰</td>
<td>äº‹åŠ¡çº§</td>
<td>å¦</td>
<td>å¦</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>å¯åºåˆ—åŒ–ï¼ˆSerializableï¼‰</td>
<td>æœ€é«˜çº§åˆ«ï¼Œäº‹åŠ¡çº§</td>
<td>å¦</td>
<td>å¦</td>
<td>å¦</td>
</tr>
</tbody></table>
<p>æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»è¶Šä¸¥æ ¼ï¼Œå¹¶å‘å‰¯ä½œç”¨è¶Šå°ï¼Œä½†ä»˜å‡ºçš„ä»£ä»·ä¹Ÿç–è¶Šå¤§ï¼Œå› ä¸ºäº‹åŠ¡éš”ç¦»å®è´¨ä¸Šå°±æ˜¯ä½¿äº‹åŠ¡åœ¨ä¸€å®šç¨‹åº¦ä¸Šâ€œä¸²è¡ŒåŒ–â€è¿›è¡Œï¼Œè¿™æ˜¾ç„¶ä¸â€œå¹¶å‘â€æ˜¯çŸ›ç›¾çš„ã€‚åŒæ—¶ï¼Œä¸åŒçš„åº”ç”¨å¯¹è¯»ä¸€è‡´æ€§å’Œäº‹åŠ¡éš”ç¦»ç¨‹åº¦çš„è¦æ±‚ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚è®¸å¤šåº”ç”¨å¯¹â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€å¹¶ä¸æ•æ„Ÿï¼Œå¯èƒ½æ›´å…³å¿ƒæ•°æ®å¹¶å‘è®¿é—®çš„èƒ½åŠ›ã€‚</p>
<blockquote>
<p>é…ç½®</p>
</blockquote>
<p>æŸ¥çœ‹çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆé»˜è®¤ä¸ºå¯é‡å¤è¯»ï¼‰ï¼š<code>SELECT @@transaction_isolation;</code>  </p>
<pre><code class="mysql">mysql&gt; SELECT @@transaction_isolation;
+-------------------------+
| @@transaction_isolation |
+-------------------------+
| REPEATABLE-READ         |
+-------------------------+</code></pre>
<p>è®¾ç½®è¯»æœªæäº¤: <code>SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;</code></p>
<p>è®¾ç½®è¯»å·²æäº¤ï¼š<code>SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;</code></p>
<p>è®¾ç½®å¯é‡å¤è¯»ï¼š<code>SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;</code></p>
<p>è®¾ç½®å¯åºåˆ—åŒ–ï¼š<code> SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;</code></p>
<blockquote>
<p>SQLå‘½ä»¤</p>
</blockquote>
<p>äº‹åŠ¡å¼€å§‹ï¼š<code>BEGIN</code> æˆ–è€… <code>START TRANSACTION</code></p>
<p>äº‹åŠ¡ç»“æŸï¼š<code>COMMIT</code>æˆ–è€…<code>COMMIT WORK</code></p>
<p>äº‹åŠ¡å›æ»šï¼š<code>ROLLBACK</code>æˆ–è€…<code>ROLLBACK WORK</code></p>
<h3 id="è¡¨é”"><a href="#è¡¨é”" class="headerlink" title="è¡¨é”"></a>è¡¨é”</h3><blockquote>
<p>ç‰¹ç‚¹</p>
</blockquote>
<p>è¡¨é”ï¼ˆåè¯»ï¼‰ï¼šåå‘MyISAMå­˜å‚¨å¼•æ“ï¼Œå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›æ— æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ã€‚</p>
<blockquote>
<p>æ“ä½œ</p>
</blockquote>
<p>æ‰‹åŠ¨å¢åŠ è¡¨é”ï¼š<code>LOCK TABLE &lt;tablename_1&gt; read(write),&lt;tablename_1&gt; read(write) ... </code></p>
<p>æŸ¥çœ‹è¡¨ä¸Šçš„é”ï¼š<code>SHOW OPEN TABLES;</code></p>
<p>è§£é”ï¼š<code>UNLOCK TABLES;</code></p>
<blockquote>
<p>åˆ†æ</p>
</blockquote>
<p>åˆ†æè¡¨é”å®šï¼š<code>SHOW STATUS LIKE &#39;table%&#39;;</code></p>
<p>æœ‰ä¸¤ä¸ªçŠ¶æ€å˜é‡è®°å½•MySQLå†…éƒ¨è¡¨çº§é”å®šçš„æƒ…å†µï¼Œä¸¤ä¸ªå˜é‡è¯´ä¸‹ï¼š</p>
<p><code>Table_locs_immediate</code>ï¼šäº§ç”Ÿè¡¨çº§é”å®šçš„æ¬¡æ•°ï¼Œè¡¨ç¤ºå¯ä»¥ç«‹å³è·å–é”çš„æŸ¥è¯¢æ¬¡æ•°ï¼Œæ¯ç«‹å³è·å–é”å€¼+1;</p>
<p><code>Table_locks_waited</code>ï¼šå‡ºç°è¡¨çº§é”å®šäº‰ç”¨è€Œå‘ç”Ÿç­‰å¾…çš„æ¬¡æ•°ï¼ˆä¸èƒ½ç«‹å³è·å–é”çš„æ¬¡æ•°ï¼Œæ¯ç­‰å¾…ä¸€æ¬¡é”å€¼+1ï¼‰ï¼Œæ­¤å€¼é«˜åˆ™è¯´æ˜å­˜åœ¨ç€æ¯”è¾ƒä¸¥é‡çš„è¡¨çº§é”äº‰ç”¨æƒ…å†µã€‚</p>
<p>æ­¤å¤–ï¼ŒMyISAMçš„è¯»å†™é”è°ƒåº¦æ˜¯å†™ä¼˜å…ˆï¼Œè¿™ä¹Ÿæ˜¯MyISAMä¸é€‚åˆåšå†™ä¸ºä¸»è¡¨çš„å¼•æ“ï¼Œå› ä¸ºå†™é”åï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½åšä»»ä½•æ“ä½œï¼Œå¤§é‡çš„æ›´æ–°ä¼šä½¿æŸ¥è¯¢å¾ˆéš¾å¾—åˆ°é”ï¼Œä»è€Œé€ æˆæ°¸è¿œé˜»å¡ã€‚</p>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<p>å½“å‰çº¿ç¨‹ç»™ä¸€ä¸ªè¡¨åŠ ä¸Šè¯»é”æ—¶ï¼Œå½“å‰çº¿ç¨‹å’Œå…¶ä»–çº¿ç¨‹éƒ½å¯ä»¥è¯»è¿™ä¸ªè¡¨ï¼Œä½†æ˜¯å½“å‰çº¿ç¨‹çº¿ç¨‹è¯»å…¶ä»–è¡¨æ—¶ä¼šæŠ¥é”™ï¼Œå½“å‰çº¿ç¨‹å†™è¯¥è¡¨æ—¶ä¼šæŠ¥é”™ï¼Œå…¶ä»–çº¿ç¨‹å†™è¯¥è¡¨æ—¶ä¼šé˜»å¡ã€‚</p>
<p>å½“å‰çº¿ç¨‹ç»™ä¸€ä¸ªè¡¨åŠ ä¸Šå†™é”æ—¶ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥å¯¹è¯¥è¡¨è¿›è¡Œè¯»å’Œå†™æ“ä½œï¼Œä½†æ˜¯å½“å‰çº¿ç¨‹å¯¹å…¶ä»–è¡¨è¿›è¡Œè¯»å’Œå†™æ“ä½œæ—¶ä¼šæŠ¥é”™ï¼Œå…¶ä»–çº¿ç¨‹å¯¹è¯¥è¡¨è¿›è¡Œè¯»å’Œå†™æ—¶ä¼šé˜»å¡ã€‚</p>
<p>è¯»é”é˜»å¡å†™ï¼Œå†™é”éƒ½é˜»å¡ã€‚</p>
<h3 id="è¡Œé”"><a href="#è¡Œé”" class="headerlink" title="è¡Œé”"></a>è¡Œé”</h3><blockquote>
<p>ç‰¹ç‚¹</p>
</blockquote>
<p>è¡Œé”ï¼ˆåå†™ï¼‰ï¼šåå‘InnoDBå­˜å‚¨å¼•æ“ï¼Œå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦ä¹Ÿæœ€é«˜ã€‚</p>
<p>InnoDBä¸MyISAMçš„æœ€å¤§ä¸åŒæœ‰ä¸¤ç‚¹ï¼šä¸€æ˜¯æ”¯æŒäº‹åŠ¡ï¼›äºŒæ˜¯é‡‡ç”¨äº†è¡Œçº§é”ã€‚</p>
<blockquote>
<p>InnoDBè¡Œé”å®ç°æ–¹å¼</p>
</blockquote>
<p>InnoDBè¡Œé”æ˜¯é€šè¿‡ç´¢å¼•ä¸Šçš„ç´¢å¼•é¡¹åŠ é”æ¥å®ç°çš„ï¼Œè¿™ä¸€ç‚¹MySQLä¸Oracleä¸åŒï¼Œåè€…æ˜¯é€šè¿‡åœ¨æ•°æ®å—ä¸­å¯¹ç›¸åº”æ•°æ®è¡ŒåŠ é”æ¥å®ç°çš„ã€‚InnoDBè¿™ç§è¡Œé”å®ç°ç‰¹ç‚¹æ„å‘³ç€ï¼šåªæœ‰é€šè¿‡ç´¢å¼•æ¡ä»¶æ¥æ£€ç´¢æ•°æ®ï¼ŒInnoDBæ‰ä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™InnoDBå°†ä½¿ç”¨è¡¨é”ã€‚</p>
<blockquote>
<p>æ€»ç»“</p>
</blockquote>
<p>å½“å‰çº¿ç¨‹<code>begin</code>ä»¥åå¯¹ä¸€å¼ è¡¨è¿›è¡Œå†™æ“ä½œï¼Œå…¶ä»–çº¿ç¨‹å¯¹è¯¥è¡¨è¿›è¡Œå†™æ“ä½œæ—¶ä¼šé˜»å¡ã€‚å½“å‰çº¿ç¨‹å†™æ“ä½œå®Œæ¯•åä»…å½“å‰çº¿ç¨‹å¯è§ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½è¯»æ›´æ–°ä¹‹å‰çš„æ•°æ®ï¼Œåªæœ‰å½“å‰çº¿ç¨‹<code>commit;</code>ä¹‹åå…¶ä»–çº¿ç¨‹æ‰å¯è¯»æ›´æ–°æ•°æ®ã€‚</p>
<blockquote>
<p>é—´éš™é”</p>
</blockquote>
<p>å½“æˆ‘ä»¬ç”¨èŒƒå›´æ¡ä»¶è€Œä¸æ˜¯ç›¸ç­‰æ¡ä»¶æ£€ç´¢æ•°æ®ï¼Œå¹¶è¯·æ±‚å…±äº«æˆ–æ’ä»–é”æ—¶ï¼ŒInnoDBä¼šç»™ç¬¦åˆæ¡ä»¶çš„å·²æœ‰æ•°æ®è®°å½•çš„ç´¢å¼•é¡¹åŠ é”ï¼›å¯¹äºé”®å€¼åœ¨æ¡ä»¶èŒƒå›´å†…ä½†å¹¶ä¸å­˜åœ¨çš„è®°å½•ï¼Œå«åšé—´éš™ã€‚</p>
<p>InnoDBä¹Ÿä¼šå¯¹è¿™ä¸ªé—´éš™åŠ é”ï¼Œè¿™ç§é”æœºåˆ¶å°±æ˜¯æ‰€è°“çš„é—´éš™é”ã€‚</p>
<p>å±å®³ï¼šå› ä¸ºQueryæ‰§è¡Œè¿‡ç¨‹ä¸­é€šè¿‡èŒƒå›´æŸ¥æ‰¾çš„è¯ï¼Œå®ƒä¼šé”å®šæ•´ä¸ªèŒƒå›´å†…çš„æ‰€æœ‰ç´¢å¼•é”®å€¼ï¼Œå³ä½¿è¿™ä¸ªé”®å€¼å¹¶ä¸å­˜åœ¨ã€‚é—´éš™æ‰€æœ‰ä¸€ä¸ªæ¯”è¾ƒè‡´å‘½çš„å¼±ç‚¹ï¼Œå°±æ˜¯å½“é”å®šä¸€ä¸ªèŒƒå›´é”®å€¼ä¹‹åï¼Œå³æ—¶æŸäº›ä¸å­˜åœ¨çš„é”®å€¼ä¹Ÿä¼šè¢«æ— è¾œçš„é”å®šï¼Œè€Œé€ æˆåœ¨é”å®šçš„æ—¶å€™æ— æ³•æ’å…¥é”å®šé”®å€¼èŒƒå›´å†…çš„ä»»ä½•æ•°æ®ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹è¿™å¯èƒ½ä¼šå¯¹æ€§èƒ½é€ æˆå¾ˆå¤§çš„å±å®³ã€‚</p>
<blockquote>
<p>å¦‚ä½•é”å®šä¸€è¡Œ</p>
</blockquote>
<p><code>SELECT .....FOR UPDATE</code>åœ¨é”å®šæŸä¸€è¡Œåï¼Œå…¶ä»–å†™æ“ä½œä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é”å®šçš„è¡Œè¢«<code>COMMIT</code>ã€‚</p>
<p>ç»“è®ºï¼š</p>
<p>InnoDBå­˜å‚¨å¼•æ“ç”±äºå®ç°äº†è¡Œçº§é”å®šï¼Œè™½ç„¶åœ¨é”å®šæœºåˆ¶çš„å®ç°æ–¹é¢æ‰€å¸¦æ¥çš„æ€§èƒ½æŸè€—å¯èƒ½æ¯”è¡¨çº§é”å®šä¼šè¦æ›´é«˜ä¸€äº›ï¼Œä½†æ˜¯åœ¨æ•´ä½“å¹¶å‘å¤„ç†èƒ½åŠ›æ–¹é¢è¦è¿œè¿œä¼˜äºMyISAMçš„è¡¨çº§é”å®šçš„ã€‚å½“ç³»ç»Ÿå¹¶å‘é‡è¾ƒé«˜çš„æ—¶å€™ï¼ŒInnoDBçš„æ•´ä½“æ€§èƒ½å’ŒMyISAMç›¸æ¯”å°±ä¼šæœ‰æ¯”è¾ƒæ˜æ˜¾çš„ä¼˜åŠ¿äº†ã€‚</p>
<p>ä½†æ˜¯ï¼ŒInnoDBçš„è¡Œçº§é”å®šåŒæ ·æœ‰å…¶è„†å¼±çš„ä¸€é¢ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ä¸å½“çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šè®©InnoDBçš„æ•´ä½“æ€§èƒ½è¡¨ç°ä¸ä»…ä¸èƒ½æ¯”MyISAMé«˜ï¼Œç”šè‡³å¯èƒ½æ›´å·®ã€‚</p>
<blockquote>
<p>åˆ†æè¡Œé”å®š</p>
</blockquote>
<p>é€šè¿‡æ£€æŸ¥InnoDB_row_lockçŠ¶æ€å˜é‡æ¥åˆ†æç³»ç»Ÿä¸Šçš„è¡Œé”çš„äº‰å¤ºæƒ…å†µï¼š<code>SHOW STATUS LIKE &#39;innodb_row_lock;&#39;</code></p>
<pre><code class="mysql">mysql&gt; SHOW STATUS LIKE &#39;innodb_row_lock%&#39;;
+-------------------------------+-------+
| Variable_name                 | Value |
+-------------------------------+-------+
| Innodb_row_lock_current_waits | 0     |
| Innodb_row_lock_time          | 38921 |
| Innodb_row_lock_time_avg      | 9730  |
| Innodb_row_lock_time_max      | 14962 |
| Innodb_row_lock_waits         | 4     |
+-------------------------------+-------+</code></pre>
<p>å¯¹å„ä¸ªçŠ¶æ€é‡çš„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>Innodb_row_lock_current_waits</code>ï¼šå½“å‰æ­£åœ¨ç­‰å¾…é”å®šçš„æ•°é‡</li>
<li><code>Innodb_row_lock_time</code>ï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨é”å®šæ€»æ—¶é—´é•¿åº¦</li>
<li><code>Innodb_row_lock_time_avg</code>ï¼šæ¯æ¬¡ç­‰å¾…æ‰€èŠ±å¹³å‡æ—¶é—´</li>
<li><code>Innodb_row_lock_time_max</code>ï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨ç­‰å¾…æœ€é•¿çš„ä¸€æ¬¡æ‰€èŠ±çš„æ—¶é—´</li>
<li><code>Innodb_row_lock_waits</code>ï¼šç³»ç»Ÿå¯åŠ¨ååˆ°ç°åœ¨æ€»å…±ç­‰å¾…çš„æ¬¡æ•°</li>
</ul>
<p>æ³¨æ„waitsé‡‘é¢time_avgæ¯”è¾ƒé«˜çš„ï¼Œå°±è¦åˆ†æç³»ç»Ÿå¹¶åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆã€‚</p>
<blockquote>
<p>ä¼˜åŒ–å»ºè®®</p>
</blockquote>
<ul>
<li>å°½å¯èƒ½è®©æ‰€æœ‰æ•°æ®æ£€ç´¢éƒ½é€šè¿‡ç´¢å¼•æ¥å®Œæˆï¼Œé¿å…æ— ç´¢å¼•è¡Œé”å‡çº§ä¸ºè¡¨é”</li>
<li>åˆç†è®¾è®¡ç´¢å¼•ï¼Œå°½é‡ç¼©å°é”çš„èŒƒå›´</li>
<li>å°½å¯èƒ½å‡å°‘æ£€ç´¢æ¡ä»¶ï¼Œé¿å…é—´éš™é”</li>
<li>å°½é‡æ§åˆ¶äº‹åŠ¡å¤§å°ï¼Œå‡å°‘é”å®šèµ„æºé‡å’Œæ—¶é—´é•¿åº¦</li>
<li>å°½å¯èƒ½ä½çº§åˆ«äº‹åŠ¡éš”ç¦»</li>
</ul>
<h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>MVCCï¼ˆMultiversion concurrency control ï¼‰æ˜¯ä¸€ç§å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æœºåˆ¶ã€‚</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<ul>
<li>æ’å…¥ï¼šæ·»åŠ éšè—ä¸¤åˆ—ï¼Œåˆ›å»ºç‰ˆæœ¬å·(å½“å‰äº‹åŠ¡id)å’Œåˆ é™¤ç‰ˆæœ¬å·(null)</li>
<li>æŸ¥è¯¢ï¼šéœ€è¦æ»¡è¶³æ¡ä»¶ï¼Œåˆ›å»ºç‰ˆæœ¬å· &lt; å½“å‰äº‹åŠ¡id &lt; åˆ é™¤ç‰ˆæœ¬å·</li>
<li>åˆ é™¤ï¼šæ›´æ–°æ•°æ®çš„åˆ é™¤ç‰ˆæœ¬å·ä¸ºå½“å‰äº‹åŠ¡id</li>
<li>æ›´æ–°ï¼šå¤åˆ¶ä¸€ä»½æ•°æ®ï¼Œå…ˆæ‰§è¡Œåˆ é™¤ï¼Œå†æ‰§è¡Œæ’å…¥ï¼Œå°±æ—§æ•°æ®çš„åˆ é™¤ç‰ˆæœ¬å·å’Œæ–°æ•°æ®çš„åˆ›å»ºç‰ˆæœ¬å·éƒ½è®¾ç½®ä¸ºå½“å‰äº‹åŠ¡id</li>
</ul>
<h2 id="ä¸»ä»å¤åˆ¶"><a href="#ä¸»ä»å¤åˆ¶" class="headerlink" title="ä¸»ä»å¤åˆ¶"></a>ä¸»ä»å¤åˆ¶</h2><h3 id="å¤åˆ¶çš„åŸºæœ¬åŸåˆ™"><a href="#å¤åˆ¶çš„åŸºæœ¬åŸåˆ™" class="headerlink" title="å¤åˆ¶çš„åŸºæœ¬åŸåˆ™"></a>å¤åˆ¶çš„åŸºæœ¬åŸåˆ™</h3><p>MySQLå¤åˆ¶è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š</p>
<ul>
<li>Masterå°†æ”¹å˜è®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—(Binary Log)ã€‚è¿™äº›è®°å½•è¿‡ç¨‹å«åšäºŒè¿›åˆ¶æ—¥å¿—äº‹ä»¶ï¼Œ<code>Binary Log Events</code>ï¼›</li>
<li>Slaveå°†Masterçš„<code>Binary Log Events</code>æ‹·è´åˆ°å®ƒçš„ä¸­ç»§æ—¥å¿—(Replay Log);</li>
<li>Slaveé‡åšä¸­ç»§æ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†æ”¹å˜åº”ç”¨åˆ°è‡ªå·±çš„æ•°æ®åº“ä¸­ã€‚MySQLå¤åˆ¶æ˜¯å¼‚æ­¥ä¸”ä¸²è¡ŒåŒ–çš„ã€‚</li>
</ul>
<h3 id="å¤åˆ¶çš„æœ€å¤§é—®é¢˜"><a href="#å¤åˆ¶çš„æœ€å¤§é—®é¢˜" class="headerlink" title="å¤åˆ¶çš„æœ€å¤§é—®é¢˜"></a>å¤åˆ¶çš„æœ€å¤§é—®é¢˜</h3><ul>
<li>æ¯ä¸ªSlaveåªæœ‰ä¸€ä¸ªMasterã€‚</li>
<li>æ¯ä¸ªSlaveåªèƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æœåŠ¡å™¨IDã€‚</li>
<li>æ¯ä¸ªMasterå¯ä»¥æœ‰å¤šä¸ªSalveã€‚</li>
</ul>
<h3 id="ä¸€ä¸»ä¸€ä»é…ç½®"><a href="#ä¸€ä¸»ä¸€ä»é…ç½®" class="headerlink" title="ä¸€ä¸»ä¸€ä»é…ç½®"></a>ä¸€ä¸»ä¸€ä»é…ç½®</h3><blockquote>
<p>åŸºæœ¬å‡†å¤‡</p>
</blockquote>
<pre><code class="shell">[root@parak home]# mkdir -p mysql-3307/conf mysql-3307/data mysql-3308/conf mysql-3308/data
[root@parak home]# touch mysql-3307/conf/my.cnf mysql-3308/conf/my.cnf
# Masteré…ç½®æ–‡ä»¶
[root@parak home]# vi mysql-3307/conf/my.cnf
[mysqld]
datadir = /var/lib/mysql
server-id = 1
log-bin = mysql-bin
sql_mode=STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION
# Slaveé…ç½®æ–‡ä»¶
[root@parak home]# vi mysql-3308/conf/my.cnf
[mysqld]
datadir = /var/lib/mysql
server-id = 2
log-bin = mysql-bin
sql_mode=STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION</code></pre>
<blockquote>
<p>Dockerå¯åŠ¨</p>
</blockquote>
<p>mysql-3307ç”¨ä½œMaster</p>
<pre><code class="shell">docker run -d \
-v /home/mysql-3307/conf/my.cnf:/etc/my.cnf \
-v /home/mysql-3307/data:/var/lib/mysql \
-p 3307:3306 \
-e MYSQL_ROOT_PASSWORD=KAG1823 \
--restart=always \
--name mysql-3307 \
mysql:8.0.20</code></pre>
<p>mysql-3308ç”¨ä½œSlave</p>
<pre><code class="shell">docker run -d \
-v /home/mysql-3308/conf/my.cnf:/etc/my.cnf \
-v /home/mysql-3308/data:/var/lib/mysql \
-p 3308:3306 \
-e MYSQL_ROOT_PASSWORD=KAG1823 \
--restart=always \
--name mysql-3308 \
mysql:8.0.20</code></pre>
<blockquote>
<p>æŸ¥çœ‹ç½‘ç»œ</p>
</blockquote>
<p>æŸ¥çœ‹bridgeç½‘ç»œçš„æ‰€æœ‰å®¹å™¨ï¼š<code>docker inspect bridgr</code></p>
<p>æ ¹æ®å®¹å™¨IDæˆ–è€…å®¹å™¨åç§°æŸ¥è¯¢ï¼š<code>docker inspect --format=&#39;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#39; å®¹å™¨åç§° | å®¹å™¨id</code></p>
<pre><code class="shell">[root@parak ~]# docker inspect --format=&#39;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#39; mysql-3307
172.17.0.5
[root@parak ~]# docker inspect --format=&#39;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#39; mysql-3308
172.17.0.6</code></pre>
<p>mysql-3307çš„IPä¸ºï¼š<code>172.17.0.5</code></p>
<p>mysql-3308çš„IPä¸ºï¼š<code>172.17.0.6</code></p>
<blockquote>
<p>Masteré…ç½®</p>
</blockquote>
<p>è¿›å…¥Masterå†…éƒ¨</p>
<pre><code class="mysql"># åˆ›å»ºç”¨æˆ·ï¼Œç”¨äºSlaveè®¿é—®Master
mysql&gt; CREATE USER &#39;Khighness&#39;@&#39;%&#39; IDENTIFIED WITH mysql_native_password BY &#39;KAG1823&#39;;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; GRANT REPLICATION SLAVE ON *.* TO &#39;Khighness&#39;@&#39;%&#39;;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)

# è®°å½•Fileå’ŒPosition
mysql&gt; SHOW MASTER STATUS\G;
*************************** 1. row ***************************
             File: mysql-bin.000003
         Position: 4440
     Binlog_Do_DB:
 Binlog_Ignore_DB:
Executed_Gtid_Set:
1 row in set (0.00 sec)

ERROR:
No query specified</code></pre>
<p>ç”¨æˆ·åï¼š<code>slave</code></p>
<p>Fileï¼š<code>mysql-bin.000003</code></p>
<p>Positionï¼š<code>4440</code></p>
<blockquote>
<p>Slaveé…ç½®</p>
</blockquote>
<p>è¿›å…¥Slaveå†…éƒ¨</p>
<pre><code class="mysql">mysql&gt; CHANGE MASTER TO
    -&gt; MASTER_HOST=&#39;172.17.0.5&#39;,
    -&gt; MASTER_PORT=3307,
    -&gt; MASTER_USER=&#39;Khighness&#39;,
    -&gt; MASTER_PASSWORD=&#39;KAG1823&#39;,
    -&gt; MASTER_LOG_FILE=&#39;mysql-bin.000003&#39;,
    -&gt; MASTER_LOG_POS=4440;
Query OK, 0 rows affected, 2 warnings (0.02 sec)

mysql&gt; START SLAVE;
Query OK, 0 rows affected (0.01 sec)</code></pre>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker</title>
    <url>/posts/f5f9fa9b/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ğŸ“–æ¦‚è¿°"><a href="#ğŸ“–æ¦‚è¿°" class="headerlink" title="ğŸ“–æ¦‚è¿°"></a>ğŸ“–æ¦‚è¿°</h2>

<blockquote>
<p>æ•…äº‹</p>
</blockquote>
<p>2010å¹´ï¼Œå‡ ä¸ªæ IT çš„å¹´è½»äººï¼Œåœ¨ç¾å›½æ—§é‡‘å±±æˆç«‹äº†ä¸€å®¶åå« <code>dotCloud </code>çš„å…¬å¸ã€‚<code>dotCloud </code>çš„å¹³å°å³æœåŠ¡ï¼ˆPlatform-as-a-Serviceï¼‰æä¾›å•†ã€‚åº•å±‚æŠ€æœ¯ä¸Šï¼Œ<code>dotCloud</code> å¹³å°åˆ©ç”¨äº†<code>Linux</code>çš„ <code>LXC </code>å®¹å™¨æŠ€æœ¯ã€‚ä¸ºäº†æ–¹ä¾¿åˆ›å»ºå’Œç®¡ç†è¿™äº›å®¹å™¨ï¼Œ<code>dotCloud </code>åŸºäº Google å…¬å¸æ¨å‡ºçš„ <code>Go </code>è¯­è¨€å¼€å‘äº†ä¸€å¥—å†…éƒ¨å·¥å…·ï¼Œä¹‹åè¢«å‘½åä¸º <code>Docker</code>ã€‚<code>Docker </code>å°±æ˜¯è¿™æ ·è¯ç”Ÿçš„ã€‚</p>
<p>2013å¹´çš„åç«¯æŠ€æœ¯é¢†åŸŸå·²ç»å¤ªä¹…æ²¡æœ‰å‡ºç°è®©äººæŒ¯å¥‹çš„ä¸œè¥¿äº†ã€‚å½“ç„¶<code>Docker</code>åœ¨å‘è¡Œä¹‹åä¹Ÿæ²¡ç”¨å¼•èµ·è¡Œä¸šçš„å…³æ³¨ã€‚åœ¨å¼€æºä¹‹åæ‰çˆ†ç«ã€‚</p>
<p><code>Docker</code>å®šä¹‰å®¹å™¨æŠ€æœ¯æ ‡ç –ä½¿å¾—å®¹å™¨æŠ€æœ¯çš„è½åœ°å˜å¾—ååˆ†ç®€å•ï¼Œåº”ç”¨å¯ä»¥ç¨³å®šä¾¿æºçš„è¿è¡Œåœ¨å®¹å™¨ä¸­ã€‚</p>
<a id="more"></a>



<blockquote>
<p>ç‰¹ç‚¹</p>
</blockquote>
<ul>
<li><strong>æ›´å¿«é€Ÿçš„åº”ç”¨äº¤ä»˜å’Œéƒ¨ç½²</strong></li>
<li><strong>æ›´ä¾¿æ·çš„å‡çº§å’Œæ‰©ç¼©å®¹</strong></li>
<li><strong>æ›´é«˜æ•ˆçš„è®¡ç®—èµ„æºåˆ©ç”¨</strong></li>
<li><strong>æ›´ç®€å•çš„ç³»ç»Ÿè¿ç»´</strong></li>
</ul>
<blockquote>
<p>æ¶æ„</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/Docker%E6%9E%B6%E6%9E%84.jpg" class="" title="Docker">

<p><strong>é•œåƒï¼ˆimageï¼‰ï¼š</strong> ç›¸å½“äºä¸€ä¸ªæ¨¡æ¿ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ¨¡æ¿æ¥åˆ›å»ºå®¹å™¨æœåŠ¡</p>
<p><strong>å®¹å™¨ï¼ˆcontainerï¼‰ï¼š</strong> ç‹¬ç«‹è¿è¡Œä¸€ä¸ªæˆ–è€…ä¸€ä¸ªç»„åº”ç”¨</p>
<p><strong>ä»“åº“ï¼ˆrepositoryï¼‰ï¼š</strong> å­˜æ”¾é•œåƒçš„åœ°æ–¹</p>
<br>

<h2 id="ğŸ”¨å®‰è£…"><a href="#ğŸ”¨å®‰è£…" class="headerlink" title="ğŸ”¨å®‰è£…"></a>ğŸ”¨å®‰è£…</h2><blockquote>
<p>å®˜æ–¹æ–‡æ¡£</p>
</blockquote>
<p>CentOS 7å®‰è£…ï¼š<a href="https://docs.docker.com/engine/install/centos/">https://docs.docker.com/engine/install/centos/</a></p>
<blockquote>
<p>å¸è½½æ—§ç‰ˆæœ¬</p>
</blockquote>
<pre><code class="shell">$ sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine</code></pre>
<blockquote>
<p>è®¾ç½®å­˜å‚¨åº“</p>
</blockquote>
<pre><code class="shell">$ sudo yum install -y yum-utils</code></pre>
<blockquote>
<p>æ›´æ¢é•œåƒæº</p>
</blockquote>
<pre><code class="shell">$ sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></pre>
<blockquote>
<p>æ›´æ–°YUMåŒ…</p>
<p>æ›´æ–°YUMç´¢å¼•</p>
</blockquote>
<pre><code class="shell">$ sudo yum update
$ sudo yum makecache fast</code></pre>
<blockquote>
<p>å®‰è£…dockerå¼•æ“å’Œå®¹å™¨</p>
</blockquote>
<pre><code class="shell">$ sudo yum install docker-ce docker-ce-cli containerd.io</code></pre>
<blockquote>
<p>å¯åŠ¨Dockerå¹¶æµ‹è¯•hello-world</p>
</blockquote>
<pre><code class="shell">$ sudo systemctl start docker
$ sudo docker run hello-world</code></pre>
<blockquote>
<p>å¸è½½æ–¹å¼</p>
</blockquote>
<pre><code class="shell">$ sudo yum remove docker-ce docker-ce-cli containerd.io
$ sudo rm -rf /var/lib/docker</code></pre>
<blockquote>
<p>é•œåƒåŠ é€Ÿ</p>
</blockquote>
<p>1ï¸âƒ£ä½¿ç”¨é˜¿é‡Œé•œåƒåŠ é€Ÿå™¨</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201206122604398.png" class="" title="image-20201206122604398">

<p>2ï¸âƒ£ä½¿ç”¨ä¸­ç§‘å¤§æˆ–è€…ç½‘æ˜“é•œåƒåŠ é€Ÿ</p>
<pre><code class="shell"># æ·»åŠ daemon.json
$ touch /etc/docker/daemon.json

# å†™å…¥å†…å®¹å¹¶ä¿å­˜
# ç§‘å¤§æº: https://docker.mirrors.ustc.edu.cn/
# ç½‘æ˜“æºï¼šhttp://hub-mirror.c.163.com
&#123;
  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn/&quot;]
&#125;

# é‡å¯Dicker
$ sudo systemctl restart docker</code></pre>
<br>

<h2 id="ğŸš€åŸç†"><a href="#ğŸš€åŸç†" class="headerlink" title="ğŸš€åŸç†"></a>ğŸš€åŸç†</h2><blockquote>
<p>docker runçš„æ‰§è¡Œæµç¨‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201203233730702.png" class="" title="image-20201203233730702">

<blockquote>
<p>Dockerçš„å·¥ä½œ</p>
</blockquote>
<p>Dockeræ˜¯ä¸€ä¸ªClient-Serverç»“æ„çš„ç³»ç»Ÿï¼ŒDockerçš„å®ˆæŠ¤è¿›ç¨‹è¿è¡Œåœ¨ä¸»æœºä¸Šã€‚é€šè¿‡Socketä»å®¢æˆ·ç«¯è®¿é—®ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆDockeræ¯”VMå¿«ï¼Ÿ</strong></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201204003500802.png" class="" title="image-20201204003500802">

<p>1ã€Dockeræœ‰æ¯”è™šæ‹Ÿæœºæ›´å°‘çš„æŠ½è±¡å±‚ã€‚Dockerä¸éœ€è¦Hypervisorå®ç°ç¡¬ä»¶èµ„æºè™šæ‹ŸåŒ–ï¼Œè¿è¡Œåœ¨Dockerå®¹å™¨ä¸Šçš„ç¨‹åºç›´æ¥ä½¿ç”¨çš„æ˜¯å®é™…ç‰©ç†æœºçš„ç¡¬ä»¶èµ„æºï¼Œå› æ­¤åœ¨CPUã€å†…å­˜åˆ©ç”¨ç‡ä¸ŠDockerå°†ä¼šåœ¨æ•ˆç‡ä¸Šæœ‰æ˜æ˜¾çš„ä¼˜åŠ¿ã€‚</p>
<p>2ã€Dockeråˆ©ç”¨çš„æ˜¯å®¿ä¸»æœºçš„å†…æ ¸ï¼Œè€Œä¸éœ€è¦Guest OSã€‚å› æ­¤åˆ›å»ºä¸€ä¸ªå®¹å™¨æ—¶ï¼Œä¸éœ€è¦å’Œè™šæ‹Ÿæœºä¸€æ ·é‡æ–°åŠ è½½ä¸€ä¸ªæ“ä½œç³»ç»Ÿå†…æ ¸ã€‚ä»è€Œé¿å…å¼•å¯»ã€åŠ è½½æ“ä½œç³»ç»Ÿå†…æ ¸è¿”å›æ—¶è€—æ—¶è€—èµ„æºçš„è¿‡ç¨‹ï¼Œå½“æ–°å»ºä¸€ä¸ªè™šæ‹Ÿæœºæ—¶ï¼Œè™šæ‹Ÿæœºè½¯ä»¶éœ€è¦åŠ è½½Guest OSï¼Œè¿”å›æ–°å»ºè¿‡ç¨‹æ˜¯åˆ†é’Ÿçº§åˆ«çš„ã€‚è€Œæ–°å»ºä¸€ä¸ªDockerå®¹å™¨åªéœ€è¦å‡ ç§’é’Ÿã€‚</p>
<p>3ã€Dockerä¸VMç›¸æ¯”ï¼š</p>
<ul>
<li>Dockerçµæ´»ï¼ŒVMç¬¨é‡</li>
<li>Dockerå­˜å‚¨çš„é•œåƒå°ï¼Œä¾¿äºå­˜å‚¨å’Œä¼ è¾“ï¼ŒVMé•œåƒåºå¤§</li>
</ul>
<br>

<h2 id="ğŸ”°å‘½ä»¤"><a href="#ğŸ”°å‘½ä»¤" class="headerlink" title="ğŸ”°å‘½ä»¤"></a>ğŸ”°å‘½ä»¤</h2><blockquote>
<p>ğŸŒå®˜æ–¹æ–‡æ¡£</p>
</blockquote>
<p>Command-line referenceï¼š<a href="https://docs.docker.com/reference/">https://docs.docker.com/reference/</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201204225734966.png" class="" title="image-20201204225734966">

<br>

<h3 id="1ï¸âƒ£å¸®åŠ©å‘½ä»¤"><a href="#1ï¸âƒ£å¸®åŠ©å‘½ä»¤" class="headerlink" title="1ï¸âƒ£å¸®åŠ©å‘½ä»¤"></a>1ï¸âƒ£å¸®åŠ©å‘½ä»¤</h3><pre><code class="shell">$ docker version    # æ˜¾ç¤ºDockerç‰ˆæœ¬ä¿¡æ¯
$ docker info       # æ˜¾ç¤ºDockerç³»ç»Ÿä¿¡æ¯
$ docker --help     # Dockerå‘½ä»¤å¸®åŠ©ä¿¡æ¯</code></pre>
<br>

<h3 id="2ï¸âƒ£é•œåƒå‘½ä»¤"><a href="#2ï¸âƒ£é•œåƒå‘½ä»¤" class="headerlink" title="2ï¸âƒ£é•œåƒå‘½ä»¤"></a>2ï¸âƒ£é•œåƒå‘½ä»¤</h3><blockquote>
<p>æŸ¥çœ‹é•œåƒ</p>
</blockquote>
<pre><code class="shell">$ docker images

# å¯é€‰é¡¹
-a, --all             # åˆ—å‡ºæ‰€æœ‰é•œåƒ
    --digests         # æ˜¾ç¤ºé•œåƒçš„æ‘˜è¦ä¿¡æ¯
-q, --quiet           # åªæ˜¾ç¤ºé•œåƒçš„ID

# è¿è¡Œ
[root@parak khighness]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
hello-world         latest              bf756fb1ae65        11 months ago       13.3kB
# è§£é‡Š
REPOSITORY  é•œåƒçš„ä»“åº“æº
TAG         é•œåƒçš„æ ‡ç­¾
IMAGE ID    é•œåƒçš„ID
CREATED     é•œåƒçš„åˆ›å»ºæ—¶é—´
SIZE        é•œåƒçš„å¤§å°</code></pre>
<blockquote>
<p>æœç´¢é•œåƒ</p>
</blockquote>
<pre><code class="shell">$ docker search &lt;IMAGE&gt;

# å¯é€‰é¡¹
--filter=STARS=1000 # é•œåƒçš„STARSå¤§äº1000</code></pre>
<blockquote>
<p>ä¸‹è½½é•œåƒ</p>
</blockquote>
<pre><code class="shell">$ docker pull &lt;IMAGE&gt;
$ docker pull .io/library/mysql:latest

# å¦‚æœä¸å†™tagï¼Œé»˜è®¤å°±æ˜¯æœ€æ–°çš„

# æŒ‡å®šç‰ˆæœ¬ä¸‹è½½
[root@parak khighness]# docker pull mysql:8.0.20
8.0.20: Pulling from library/mysql  # åˆ†å±‚ä¸‹è½½
8559a31e96f4: Pull complete 
d51ce1c2e575: Pull complete 
c2344adc4858: Pull complete 
fcf3ceff18fc: Pull complete 
16da0c38dc5b: Pull complete 
b905d1797e97: Pull complete 
4b50d1c6b05c: Pull complete 
c75914a65ca2: Pull complete 
1ae8042bdd09: Pull complete 
453ac13c00a3: Pull complete 
9e680cd72f08: Pull complete 
a6b5dc864b6c: Pull complete 
Digest: sha256:8b7b328a7ff6de46ef96bcf83af048cb00a1c86282bfca0cb119c84568b4caf6
Status: Downloaded newer image for mysql:8.0.20
docker.io/library/mysql:8.0.20</code></pre>
<blockquote>
<p>åˆ é™¤é•œåƒ</p>
</blockquote>
<pre><code class="shell"># é€šè¿‡é•œåƒIDåˆ é™¤
$ docker rmi -f &lt;IMAGE ID&gt; ...
# åˆ é™¤æ‰€æœ‰é•œåƒ
$ docker rmi -f $(docker images -aq)0</code></pre>
<br>

<h3 id="3ï¸âƒ£å®¹å™¨å‘½ä»¤"><a href="#3ï¸âƒ£å®¹å™¨å‘½ä»¤" class="headerlink" title="3ï¸âƒ£å®¹å™¨å‘½ä»¤"></a>3ï¸âƒ£å®¹å™¨å‘½ä»¤</h3><blockquote>
<p>ä¸‹è½½ä¸€ä¸ªCentOSé•œåƒæ¥æµ‹è¯•å­¦(å¥—)ä¹ (å¨ƒ)</p>
</blockquote>
<pre><code class="shell">[root@parak khighness]# docker pull centos
Using default tag: latest
latest: Pulling from library/centos
3c72a8ed6814: Pull complete 
Digest: sha256:76d24f3ba3317fa945743bb3746fbaf3a0b752f10b10376960de01da70685fbd
Status: Downloaded newer image for centos:latest
docker.io/library/centos:latest</code></pre>
<blockquote>
<p>æ–°å»ºå®¹å™¨å¹¶å¯åŠ¨</p>
</blockquote>
<pre><code class="shell">$ docker run [å¯é€‰å‚æ•°] &lt;IMAGE&gt;

# å‚æ•°è¯´æ˜
--name=&quot;NAME&quot;   å®¹å™¨åå­—ï¼Œç”¨äºåŒºåˆ†å®¹å™¨
-d              åå°æ–¹å¼è¿è¡Œ
-it             ä½¿ç”¨äº¤äº’æ–¹å¼è¿è¡Œï¼Œè¿›å¦‚å®¹å™¨æŸ¥çœ‹å†…å®¹
-p              æŒ‡å®šå®¹å™¨ç«¯å£  -p 8080:8080
    -p ip:ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£
    -p ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£
    -p å®¹å™¨ç«¯å£

# æµ‹è¯•ï¼Œå¯åŠ¨å¹¶è¿›å…¥å®¹å™¨
[root@parak khighness]# docker run -it centos /bin/bash
[root@e4efa1c507b8 /]# ls
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
# ä»å®¹å™¨ä¸­é€€å›ä¸»æœº
[root@e4efa1c507b8 /]# exit
exit
[root@parak khighness]# ls
å…¬å…±  æ¨¡æ¿  è§†é¢‘  å›¾ç‰‡  æ–‡æ¡£  ä¸‹è½½  éŸ³ä¹  æ¡Œé¢</code></pre>
<blockquote>
<p>æŸ¥çœ‹å®¹å™¨</p>
</blockquote>
<pre><code class="shell">$ docker ps  # æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨
-a           # æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨+å†å²è¿è¡Œè¿‡çš„å®¹å™¨
-n=?         # æ˜¾ç¤ºæœ€è¿‘åˆ›å»ºçš„nä¸ªå®¹å™¨
-q           # åªæ˜¾ç¤ºå®¹å™¨çš„ç¼–å·</code></pre>
<blockquote>
<p>é€€å‡ºå®¹å™¨</p>
</blockquote>
<pre><code class="shell">$ exit        </code></pre>
<blockquote>
<p>åˆ é™¤å®¹å™¨</p>
</blockquote>
<pre><code class="shell">$ docker rm &lt;Container ID/NAME&gt;    # åˆ é™¤æŒ‡å®šçš„å®¹å™¨ï¼Œä¸èƒ½åˆ é™¤åªåœ¨è¿è¡Œçš„å®¹å™¨
$ docker rm -f $(docker ps -aq)    # åˆ é™¤æ‰€æœ‰çš„å®¹å™¨
$ docker ps -a -q|xargs docker rm  # åˆ é™¤æ‰€æœ‰çš„å®¹å™¨ </code></pre>
<blockquote>
<p>å®¹å™¨æ“ä½œ</p>
</blockquote>
<pre><code class="shell">$ docker start   &lt;Container ID/NAME&gt;  # å¯åŠ¨å®¹å™¨ 
$ docker restart &lt;Container ID/NAME&gt;  # é‡å¯å®¹å™¨
$ docker stop    &lt;Container ID/NAME&gt;  # åœæ­¢å½“å‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨
$ docker kill    &lt;Container ID/NAME&gt;  # å¼ºåˆ¶åœæ­¢å½“å‰å®¹å™¨</code></pre>
<blockquote>
<p>æŸ¥çœ‹æ—¥å¿—</p>
</blockquote>
<pre><code class="shell">$ docker logs -tf --tail &lt;n&gt; &lt;Container ID/NAME&gt; # æ˜¾ç¤ºæŒ‡å®šè¡Œæ•°çš„æ—¥å¿—</code></pre>
<blockquote>
<p>æŸ¥çœ‹å®¹å™¨ä¸­è¿›ç¨‹ä¿¡æ¯</p>
</blockquote>
<pre><code class="shell">$ docker top &lt;Container ID/NAME&gt;</code></pre>
<blockquote>
<p>æŸ¥çœ‹é•œåƒçš„å…ƒæ•°æ®</p>
</blockquote>
<pre><code class="shell">$ docker inspect</code></pre>
<blockquote>
<p>è¿›å…¥å½“å‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨</p>
</blockquote>
<pre><code class="shell">$ docker exec -it &lt;Container ID&gt; bashShell  
# è¿›å…¥å®¹å™¨åå¼€å¯ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œå¯ä»¥åœ¨é‡Œé¢æ“ä½œï¼›
# execä¹‹åä¸ä¼šç»ˆç»“å½“å‰å®¹å™¨è¿›ç¨‹

$ docker attach &lt;Container ID&gt;              
# è¿›å…¥å®¹å™¨ä¸­æ­£åœ¨æ‰§è¡Œçš„ç»ˆç«¯ï¼Œä¸ä¼šå¯åŠ¨æ–°çš„è¿›ç¨‹
# execä¹‹åç»ˆç»“å½“å‰å®¹å™¨è¿›ç¨‹</code></pre>
<blockquote>
<p>ä»å®¹å™¨æ‹·è´æ–°çš„ä¸œè¥¿åˆ°ä¸»æœº</p>
</blockquote>
<pre><code class="shell"># å¼€å¯CentOSå®¹å™¨
[root@parak khighness]# docker start b9ace468ea7d
b9ace468ea7d
# è¿›å…¥CentOSå®¹å™¨
[root@parak khighness]# docker attach b9ace468ea7d
# åˆ›å»ºæ–‡ä»¶å¤¹å’Œæ–‡ä»¶
[root@b9ace468ea7d /]# cd home/
[root@b9ace468ea7d home]# mkdir document 
[root@b9ace468ea7d home]# vi K1.java
# é€€å‡ºå®¹å™¨
[root@b9ace468ea7d document]# exit
exit
# å°†å®¹å™¨æ–‡ä»¶å¤åˆ¶åˆ°ä¸»æœºä¸Š
[root@parak khighness]# docker cp b9ace468ea7d:/home/document/K1.java document/
[root@parak khighness]# cd document/
[root@parak document]# ll
æ€»ç”¨é‡ 4
-rw-r--r--. 1 root root 186 12æœˆ  5 11:33 K1.java</code></pre>
<br>

<h2 id="ğŸ”±ç»ƒä¹ "><a href="#ğŸ”±ç»ƒä¹ " class="headerlink" title="ğŸ”±ç»ƒä¹ "></a>ğŸ”±ç»ƒä¹ </h2><br>

<h3 id="ğŸŒ -å®‰è£…Nginx"><a href="#ğŸŒ -å®‰è£…Nginx" class="headerlink" title="ğŸŒ  å®‰è£…Nginx"></a>ğŸŒ  å®‰è£…Nginx</h3><pre><code class="shell"># æœç´¢é•œåƒ
[root@parak khighness]# docker search nginx
NAME                               DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED
nginx                              Official build of Nginx.                        14063               [OK]                
jwilder/nginx-proxy                Automated Nginx reverse proxy for docker conâ€¦   1912                                    [OK]
richarvey/nginx-php-fpm            Container running Nginx + PHP-FPM capable ofâ€¦   795                                     [OK]
linuxserver/nginx                  An Nginx container, brought to you by LinuxSâ€¦   131                                     
jc21/nginx-proxy-manager           Docker container for managing Nginx proxy hoâ€¦   115                                     
tiangolo/nginx-rtmp                Docker image with Nginx using the nginx-rtmpâ€¦   105                                     [OK]
bitnami/nginx                      Bitnami nginx Docker Image                      90                                      [OK]
alfg/nginx-rtmp                    NGINX, nginx-rtmp-module and FFmpeg from souâ€¦   80                                      [OK]
jlesage/nginx-proxy-manager        Docker container for Nginx Proxy Manager        72                                      [OK]
nginxdemos/hello                   NGINX webserver that serves a simple page coâ€¦   63                                      [OK]
nginx/nginx-ingress                NGINX Ingress Controller for Kubernetes         45                                      
privatebin/nginx-fpm-alpine        PrivateBin running on an Nginx, php-fpm &amp; Alâ€¦   42                                      [OK]
nginxinc/nginx-unprivileged        Unprivileged NGINX Dockerfiles                  21                                      
schmunk42/nginx-redirect           A very simple container to redirect HTTP traâ€¦   19                                      [OK]
nginx/nginx-prometheus-exporter    NGINX Prometheus Exporter                       15                                      
centos/nginx-112-centos7           Platform for running nginx 1.12 or building â€¦   15                                      
staticfloat/nginx-certbot          Opinionated setup for automatic TLS certs loâ€¦   14                                      [OK]
raulr/nginx-wordpress              Nginx front-end for the official wordpress:fâ€¦   13                                      [OK]
centos/nginx-18-centos7            Platform for running nginx 1.8 or building nâ€¦   13                                      
mailu/nginx                        Mailu nginx frontend                            8                                       [OK]
bitwarden/nginx                    The Bitwarden nginx web server acting as a râ€¦   7                                       
flashspys/nginx-static             Super Lightweight Nginx Image                   7                                       [OK]
bitnami/nginx-ingress-controller   Bitnami Docker Image for NGINX Ingress Contrâ€¦   6                                       [OK]
wodby/nginx                        Generic nginx                                   1                                       [OK]
ansibleplaybookbundle/nginx-apb    An APB to deploy NGINX                          1                                       [OK]
# ä¸‹è½½é•œåƒ
[root@parak khighness]# docker pull nginx
Using default tag: latest
latest: Pulling from library/nginx
852e50cd189d: Pull complete 
571d7e852307: Pull complete 
addb10abd9cb: Pull complete 
d20aa7ccdb77: Pull complete 
8b03f1e11359: Pull complete 
Digest: sha256:6b1daa9462046581ac15be20277a7c75476283f969cb3a61c8725ec38d3b01c3
Status: Downloaded newer image for nginx:latest
docker.io/library/nginx:latest
# æŸ¥çœ‹é•œåƒ
[root@parak khighness]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
nginx               latest              bc9a0695f571        10 days ago         133MB
centos              latest              0d120b6ccaa8        3 months ago        215MB
mysql               8.0.20              be0dbf01a0f3        5 months ago        541MB
hello-world         latest              bf756fb1ae65        11 months ago       13.3kB
# åå°å¯åŠ¨80ç«¯å£nginxï¼Œå¯¹å¤–å¼€æ”¾3355ç«¯å£
[root@parak khighness]# docker run -d --name nginx1 -p 3355:80 nginx 
b6072408f44cd78594f01c95bc63da6baf911f74d62bf232ec42c1cd8b08b4d0
[root@parak khighness]# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                  NAMES
b6072408f44c        nginx               &quot;/docker-entrypoint.â€¦&quot;   6 seconds ago       Up 4 seconds        0.0.0.0:3355-&gt;80/tcp   nginx1
# æµ‹è¯•ï¼Œå¯ä»¥ç”¨ip:3355åœ¨æµè§ˆå™¨è®¿é—®
[root@parak khighness]# curl localhost:3355
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body &#123;
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    &#125;
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<br>

<h3 id="ğŸŒ -å®‰è£…Tomcat"><a href="#ğŸŒ -å®‰è£…Tomcat" class="headerlink" title="ğŸŒ  å®‰è£…Tomcat"></a>ğŸŒ  å®‰è£…Tomcat</h3><pre><code class="shell">[root@parak khighness]# docker pull tomcat:9.0
9.0: Pulling from library/tomcat
756975cb9c7e: Pull complete 
d77915b4e630: Pull complete 
5f37a0a41b6b: Pull complete 
96b2c1e36db5: Pull complete 
27a2d52b526e: Pull complete 
a867dba77389: Pull complete 
0939c055fb79: Pull complete 
0b0694ce0ae2: Pull complete 
81a5f8099e05: Pull complete 
c3d7917d545e: Pull complete 
Digest: sha256:a319b10d8729817c7ce0bcc2343a6f97711c7870395019340d96b6aafd6ccbea
Status: Downloaded newer image for tomcat:9.0
docker.io/library/tomcat:9.0

[root@parak khighness]# docker run -d -p 3355:8080 --name tomcat1 tomcat
48c7de09007af158b13a9bef1f2d2b77bed0c4bc2f93a4887eac427911118a9b
[root@parak khighness]# docker exec -it tomcat1 /bin/bash
root@48c7de09007a:/usr/local/tomcat# ls -al
total 128
drwxr-xr-x. 1 root root    30 Nov 19 06:16 .
drwxr-xr-x. 1 root root    20 Nov 19 06:12 ..
-rw-r--r--. 1 root root 18982 Nov 12 15:41 BUILDING.txt
-rw-r--r--. 1 root root  5409 Nov 12 15:41 CONTRIBUTING.md
-rw-r--r--. 1 root root 57092 Nov 12 15:41 LICENSE
-rw-r--r--. 1 root root  2333 Nov 12 15:41 NOTICE
-rw-r--r--. 1 root root  3257 Nov 12 15:41 README.md
-rw-r--r--. 1 root root  6898 Nov 12 15:41 RELEASE-NOTES
-rw-r--r--. 1 root root 16507 Nov 12 15:41 RUNNING.txt
drwxr-xr-x. 2 root root  4096 Nov 19 06:16 bin
drwxr-xr-x. 1 root root    22 Dec  5 13:15 conf
drwxr-xr-x. 2 root root  4096 Nov 19 06:16 lib
drwxrwxrwx. 1 root root   177 Dec  5 13:15 logs
drwxr-xr-x. 2 root root   134 Nov 19 06:16 native-jni-lib
drwxrwxrwx. 2 root root    30 Nov 19 06:16 temp
drwxr-xr-x. 2 root root     6 Nov 19 06:16 webapps
drwxr-xr-x. 7 root root    81 Nov 12 15:38 webapps.dist
drwxrwxrwx. 2 root root     6 Nov 12 15:35 work
# å¯ä»¥å‘ç°webappsç›®å½•ä¸ºç©º
root@48c7de09007a:/usr/local/tomcat# cd webapps
root@48c7de09007a:/usr/local/tomcat/webapps# ls -l
total 0

# å°†webapps.listç›®å½•ä¸‹çš„å†…å®¹æ‹·è´åˆ°webappsä¸‹ï¼Œå†ç”¨æµè§ˆå™¨æµ‹è¯•è®¿é—®
root@48c7de09007a:/usr/local/tomcat/webapps# cd ..
root@48c7de09007a:/usr/local/tomcat# cd webapps.dist/
root@48c7de09007a:/usr/local/tomcat/webapps.dist# ls
ROOT  docs  examples  host-manager  manager
root@48c7de09007a:/usr/local/tomcat/webapps.dist# cd ..
root@48c7de09007a:/usr/local/tomcat# cp -r webapps.dist/* webapps/
root@48c7de09007a:/usr/local/tomcat# cd webapps
root@48c7de09007a:/usr/local/tomcat/webapps# ls
ROOT  docs  examples  host-manager  manager</code></pre>
<blockquote>
<p>æµ‹è¯•è®¿é—® <a href="http://192.168.117.155:3355/">http://192.168.117.155:3355/</a></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201205214537503.png" class="" title="image-20201205214537503">

<br>

<h3 id="ğŸŒ å®‰è£…es-kibana"><a href="#ğŸŒ å®‰è£…es-kibana" class="headerlink" title="ğŸŒ å®‰è£…es + kibana"></a>ğŸŒ å®‰è£…es + kibana</h3><pre><code class="shell"># --net somenetwork ç½‘ç»œé…ç½®
$ docker run -d --name es1 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:7.6.2
# æŸ¥çœ‹ä¸»æœºçŠ¶æ€
$ doucker stats

# ä¸‹è½½å¹¶è¿è¡ŒES
[root@parak khighness]#  docker run -d --name es1 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch:7.6.2
Unable to find image &#39;elasticsearch:7.6.2&#39; locally
7.6.2: Pulling from library/elasticsearch
ab5ef0e58194: Pull complete 
c4d1ca5c8a25: Pull complete 
941a3cc8e7b8: Pull complete 
43ec483d9618: Pull complete 
c486fd200684: Pull complete 
1b960df074b2: Pull complete 
1719d48d6823: Pull complete 
Digest: sha256:1b09dbd93085a1e7bca34830e77d2981521a7210e11f11eda997add1c12711fa
Status: Downloaded newer image for elasticsearch:7.6.2
51441d9abfb966c4baa0402ceb99e702f58ec68cd427710a2b8c8043983412e9
# æŸ¥çœ‹ä¸»æœºçŠ¶æ€
[root@parak khighness]# docker stats
CONTAINER ID    NAME   CPU %   MEM USAGE/LIMIT  MEM %     NET I/O    BLOCK I/O      PIDS
51441d9abfb9    es1   42.74%  495.6MiB/972.4MiB 50.97%    656B/0B   4.76GB/629MB     46

# åœæ­¢es1
$ docker stop es1
# åˆ é™¤es1
$ docker rm es1

# é™åˆ¶å†…å­˜ï¼Œå¯åŠ¨ES
$ docker run -d --name es1 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; elasticsearch:7.6.2

# é‡æ–°å¯åŠ¨es1
[root@parak khighness]# docker run -d --name es1 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; elasticsearch:7.6.2
ca4494f52e5642d5992c49816b636b1858f2e2f5c1aaf38621c76001262e8e4d
# å†æ¬¡æŸ¥çœ‹çŠ¶æ€
[root@parak khighness]# docker stats
CONTAINER ID    NAME   CPU %   MEM USAGE/LIMIT   MEM %     NET I/O   BLOCK I/O       PIDS
ca4494f52e56    es1    0.68%   357.5MiB/972.4MiB 36.77%    737B/0B   476MB/1.78MB     45
# æµ‹è¯•è®¿é—®
[root@parak khighness]# curl localhost:9200
&#123;
  &quot;name&quot; : &quot;ca4494f52e56&quot;,
  &quot;cluster_name&quot; : &quot;docker-cluster&quot;,
  &quot;cluster_uuid&quot; : &quot;aDKZlZW_T7Ss3Dr0CXZQlQ&quot;,
  &quot;version&quot; : &#123;
    &quot;number&quot; : &quot;7.6.2&quot;,
    &quot;build_flavor&quot; : &quot;default&quot;,
    &quot;build_type&quot; : &quot;docker&quot;,
    &quot;build_hash&quot; : &quot;ef48eb35cf30adf4db14086e8aabd07ef6fb113f&quot;,
    &quot;build_date&quot; : &quot;2020-03-26T06:34:37.794943Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;8.4.0&quot;,
    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,
    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;
  &#125;,
  &quot;tagline&quot; : &quot;You Know, for Search&quot;
&#125;</code></pre>
<br>

<h2 id="ğŸ“ˆå¯è§†åŒ–"><a href="#ğŸ“ˆå¯è§†åŒ–" class="headerlink" title="ğŸ“ˆå¯è§†åŒ–"></a>ğŸ“ˆå¯è§†åŒ–</h2><p>Y1S1å¯è§†åŒ–é¢æ¿çš„å‰ç«¯å†™çš„çœŸå¥½çœ‹ï¼Œæˆ‘çˆ±äº†ã€‚</p>
<pre><code class="shell"># å®‰è£…è¿è¡Œ
$ docker run -d -p 8088:9000 --name=pt --restart=always -v /var/run/docker.sock:/var/run/docker.sock --privileged=true portainer/portainer</code></pre>
<blockquote>
<p>è®¿é—®æµ‹è¯• <a href="http://192.168.117.155:8088/">http://192.168.117.155:8088/</a></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="Docker/image-20201205232646075.png" alt="image-20201205232646075"  />

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="Docker/image-20201206105337297.png" alt="image-20201206105337297"  />





<h2 id="ğŸ“‘DockerFile"><a href="#ğŸ“‘DockerFile" class="headerlink" title="ğŸ“‘DockerFile"></a>ğŸ“‘DockerFile</h2><p>DockerFileå°±æ˜¯ç”¨æ¥æ„å»ºdockeré•œåƒçš„æ„å»ºæ–‡ä»¶-å‘½ä»¤è„šæœ¬ã€‚</p>
<blockquote>
<p>å‘½ä»¤</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
<th align="center">ç†è§£</th>
</tr>
</thead>
<tbody><tr>
<td align="center">FROM</td>
<td align="center">æŒ‡å®šåŸºç¡€é•œåƒ</td>
<td align="center">å…¬å¸çš„çˆ¶å…¬å¸</td>
</tr>
<tr>
<td align="center">MAINTAINER</td>
<td align="center">æŒ‡å®šç»´æŠ¤è€…ä¿¡æ¯</td>
<td align="center">å…¬å¸æ³¨å†Œä¿¡æ¯</td>
</tr>
<tr>
<td align="center">RUN</td>
<td align="center">æŠŠå‘½ä»¤å‰é¢åŠ ä¸ŠRUNå³å¯</td>
<td align="center">å…¬å¸æ³¨å†Œæµç¨‹</td>
</tr>
<tr>
<td align="center">ADD</td>
<td align="center">COPYæ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨è§£å‹</td>
<td align="center">å…¬å¸æ³¨å†Œèµ„é‡‘</td>
</tr>
<tr>
<td align="center">WORKDIR</td>
<td align="center">è®¾ç½®å½“å‰å·¥ä½œç›®å½•</td>
<td align="center">å…¬å¸å¤§æ¥¼ä»“åº“</td>
</tr>
<tr>
<td align="center">VOLUMN</td>
<td align="center">æŒ‚è½½ä¸»æœºç›®å½•</td>
<td align="center">å…¬å¸çš„ä¸»ä»“åº“</td>
</tr>
<tr>
<td align="center">EXPOSE</td>
<td align="center">æŒ‡å®šå¯¹å¤–ç«¯å£</td>
<td align="center">å…¬å¸å¼€æ”¾å¤§é—¨</td>
</tr>
<tr>
<td align="center">RUN</td>
<td align="center">è¿›ç¨‹è¦ä¸€ç›´è¿è¡Œä¸‹å»</td>
<td align="center">å…¬å¸æ°¸ä¸å€’é—­</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">CMD</td>
<td align="center">æŒ‡å®šè¿™å®¹å™¨å¯åŠ¨çš„æ—¶å€™è¦è¿è¡Œçš„å‘½ä»¤åªæœ‰æœ€åä¸€ä¸ªä¼šç”Ÿæ•ˆï¼Œå¯è¢«æ›¿ä»£ã€‚</td>
</tr>
<tr>
<td align="center">ENTRYPOINT</td>
<td align="center">æŒ‡å®šè¿™ä¸ªå®¹å™¨å¯åŠ¨çš„æ—¶å€™è¦è¿è¡Œçš„å‘½ä»¤ï¼Œå¯ä»¥è¿½åŠ å‘½ä»¤ã€‚</td>
</tr>
<tr>
<td align="center">ONBUILD</td>
<td align="center">å½“æ„å»ºä¸€ä¸ªè¢«ç»§æ‰¿DockerFileè¿™å°±ä¼šè¿è¡ŒONBUILDæŒ‡ä»¤ã€‚è§¦å‘æŒ‡ä»¤.</td>
</tr>
<tr>
<td align="center">COPY</td>
<td align="center">ç±»ä¼¼ADDï¼Œå°†æ–‡ä»¶æ‹·è´åˆ°é•œåƒä¸­ã€‚</td>
</tr>
<tr>
<td align="center">ENV</td>
<td align="center">æ„å»ºçš„æ—¶å€™è®¾ç½®ç¯å¢ƒå˜é‡ã€‚</td>
</tr>
</tbody></table>
<blockquote>
<p>å®ä¾‹1-æµ‹è¯•</p>
</blockquote>
<pre><code class="shell">[root@parak home]# mkdir volume
[root@parak home]# cd volume/
[root@parak volume]# vim dockerfile1
[root@parak volume]# cat dockerfile1 
FROM centos
VOLUME [&quot;volume01&quot;,&quot;volume02&quot;]
CMD echo &quot;---end---&quot;
CMD /bin/bash
[root@parak volume]# docker build -f /home/volume/dockerfile1 -t khighness/centos:1.0 .
Sending build context to Docker daemon  2.048kB
Step 1/4 : FROM centos
 ---&gt; 0d120b6ccaa8
Step 2/4 : VOLUME [&quot;volume01&quot;,&quot;volume02&quot;]
 ---&gt; Running in 79dc7b449286
Removing intermediate container 79dc7b449286
 ---&gt; 9a6608557c9a
Step 3/4 : CMD echo &quot;---end---&quot;
 ---&gt; Running in 8b8c40056f99
Removing intermediate container 8b8c40056f99
 ---&gt; 2158b18dedff
Step 4/4 : CMD /bin/bash
 ---&gt; Running in 9d76c3598d69
Removing intermediate container 9d76c3598d69
 ---&gt; 240a84cdfbef
Successfully built 240a84cdfbef
Successfully tagged khighness/centos:1.0</code></pre>
<blockquote>
<p>å®ä¾‹2-æ„å»ºè‡ªå·±çš„centos</p>
</blockquote>
<pre><code class="shell"># 1ã€ç¼–å†™DockerFileæ–‡ä»¶
[root@parak dockerfile]# vim mydockerfile-centos
[root@parak dockerfile]# cat mydockerfile-centos 
FROM centos
MAINTAINER khighness&lt;1823676372@qq.com&gt;

ENV MYPATH /usr/local
WORKDIR $MYPATH 

RUN yum -y install vim
RUN yum -y install net-tools

EXPOSE 80

CMD echo $MYPATH
CMD echo &quot;---end---&quot;
CMD /bin/bash

# 2ã€é€šè¿‡DockerFileæ„å»ºé•œåƒ
[root@parak dockerfile]# docker build -f mydockerfile-centos  -t mycentos:1.0 .
Sending build context to Docker daemon  2.048kB
Step 1/10 : FROM centos
 ---&gt; 0d120b6ccaa8
Step 2/10 : MAINTAINER khighness&lt;1823676372@qq.com&gt;
 ---&gt; Running in 024da1b1d4cc
Removing intermediate container 024da1b1d4cc
 ---&gt; 6c9b636504d2
Step 3/10 : ENV MYPATH /usr/local
 ---&gt; Running in 4046d4e257ac
Removing intermediate container 4046d4e257ac
 ---&gt; a5710fdc760e
Step 4/10 : WORKDIR $MYPATH
 ---&gt; Running in 252416d49e94
Removing intermediate container 252416d49e94
 ---&gt; fdbae7da4ca4
Step 5/10 : RUN yum -y install vim
 ---&gt; Running in 9eb786294022
CentOS-8 - AppStream                            288 kB/s | 6.2 MB     00:22    
CentOS-8 - Base                                 703 kB/s | 2.3 MB     00:03    
CentOS-8 - Extras                               1.3 kB/s | 8.1 kB     00:06    
Dependencies resolved.
================================================================================
 Package             Arch        Version                   Repository      Size
================================================================================
Installing:
 vim-enhanced        x86_64      2:8.0.1763-15.el8         AppStream      1.4 M
Installing dependencies:
 gpm-libs            x86_64      1.20.7-15.el8             AppStream       39 k
 vim-common          x86_64      2:8.0.1763-15.el8         AppStream      6.3 M
 vim-filesystem      noarch      2:8.0.1763-15.el8         AppStream       48 k
 which               x86_64      2.21-12.el8               BaseOS          49 k

Transaction Summary
================================================================================
Install  5 Packages

Total download size: 7.8 M
Installed size: 30 M
Downloading Packages:
(1/5): gpm-libs-1.20.7-15.el8.x86_64.rpm        340 kB/s |  39 kB     00:00    
(2/5): vim-filesystem-8.0.1763-15.el8.noarch.rp 664 kB/s |  48 kB     00:00    
(3/5): which-2.21-12.el8.x86_64.rpm             315 kB/s |  49 kB     00:00    
(4/5): vim-enhanced-8.0.1763-15.el8.x86_64.rpm  543 kB/s | 1.4 MB     00:02    
(5/5): vim-common-8.0.1763-15.el8.x86_64.rpm    387 kB/s | 6.3 MB     00:16    
--------------------------------------------------------------------------------
Total                                           448 kB/s | 7.8 MB     00:17     
warning: /var/cache/dnf/AppStream-02e86d1c976ab532/packages/gpm-libs-1.20.7-15.el8.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID 8483c65d: NOKEY
CentOS-8 - AppStream                            1.6 MB/s | 1.6 kB     00:00    
Importing GPG key 0x8483C65D:
 Userid     : &quot;CentOS (CentOS Official Signing Key) &lt;security@centos.org&gt;&quot;
 Fingerprint: 99DB 70FA E1D7 CE22 7FB6 4882 05B5 55B3 8483 C65D
 From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-centosofficial
Key imported successfully
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Preparing        :                                                        1/1 
  Installing       : which-2.21-12.el8.x86_64                               1/5 
  Installing       : vim-filesystem-2:8.0.1763-15.el8.noarch                2/5 
  Installing       : vim-common-2:8.0.1763-15.el8.x86_64                    3/5 
  Installing       : gpm-libs-1.20.7-15.el8.x86_64                          4/5 
  Running scriptlet: gpm-libs-1.20.7-15.el8.x86_64                          4/5 
  Installing       : vim-enhanced-2:8.0.1763-15.el8.x86_64                  5/5 
  Running scriptlet: vim-enhanced-2:8.0.1763-15.el8.x86_64                  5/5 
  Running scriptlet: vim-common-2:8.0.1763-15.el8.x86_64                    5/5 
  Verifying        : gpm-libs-1.20.7-15.el8.x86_64                          1/5 
  Verifying        : vim-common-2:8.0.1763-15.el8.x86_64                    2/5 
  Verifying        : vim-enhanced-2:8.0.1763-15.el8.x86_64                  3/5 
  Verifying        : vim-filesystem-2:8.0.1763-15.el8.noarch                4/5 
  Verifying        : which-2.21-12.el8.x86_64                               5/5 

Installed:
  gpm-libs-1.20.7-15.el8.x86_64         vim-common-2:8.0.1763-15.el8.x86_64    
  vim-enhanced-2:8.0.1763-15.el8.x86_64 vim-filesystem-2:8.0.1763-15.el8.noarch
  which-2.21-12.el8.x86_64             

Complete!
Removing intermediate container 9eb786294022
 ---&gt; 491907dac3e2
Step 6/10 : RUN yum -y install net-tools
 ---&gt; Running in 3a13d71952e5
Last metadata expiration check: 0:00:24 ago on Mon Dec  7 11:45:38 2020.
Dependencies resolved.
================================================================================
 Package         Architecture Version                        Repository    Size
================================================================================
Installing:
 net-tools       x86_64       2.0-0.52.20160912git.el8       BaseOS       322 k

Transaction Summary
================================================================================
Install  1 Package

Total download size: 322 k
Installed size: 942 k
Downloading Packages:
net-tools-2.0-0.52.20160912git.el8.x86_64.rpm   1.0 MB/s | 322 kB     00:00    
--------------------------------------------------------------------------------
Total                                           141 kB/s | 322 kB     00:02     
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Preparing        :                                                        1/1 
  Installing       : net-tools-2.0-0.52.20160912git.el8.x86_64              1/1 
  Running scriptlet: net-tools-2.0-0.52.20160912git.el8.x86_64              1/1 
  Verifying        : net-tools-2.0-0.52.20160912git.el8.x86_64              1/1 

Installed:
  net-tools-2.0-0.52.20160912git.el8.x86_64                                     

Complete!
Removing intermediate container 3a13d71952e5
 ---&gt; 0d095f331d4a
Step 7/10 : EXPOSE 80
 ---&gt; Running in 66d8aceea20c
Removing intermediate container 66d8aceea20c
 ---&gt; a86402c5f9b7
Step 8/10 : CMD echo $MYPATH
 ---&gt; Running in b6af3ea8ff6a
Removing intermediate container b6af3ea8ff6a
 ---&gt; 17533352607f
Step 9/10 : CMD echo &quot;---end---&quot;
 ---&gt; Running in f015d24c9277
Removing intermediate container f015d24c9277
 ---&gt; cf7d78851a04
Step 10/10 : CMD /bin/bash
 ---&gt; Running in d0f70eaa39ec
Removing intermediate container d0f70eaa39ec
 ---&gt; d59930f07e43
Successfully built d59930f07e43
Successfully tagged mycentos:1.0


# 3ã€æµ‹è¯•è¿è¡Œï¼Œå®˜æ–¹çš„centosé•œåƒä¸­æ˜¯æ²¡æœ‰ç½‘ç»œå‘½ä»¤å’ŒVIMå‘½ä»¤çš„ï¼Œè€Œè‡ªå·±æ„å»ºçš„centosä¸­å·²ç»æœ‰
[root@parak dockerfile]# docker run -it --name=mycen mycentos:1.0 
[root@43b0b7eb76d8 local]# pwd
/usr/local
[root@43b0b7eb76d8 local]# vim test
[root@43b0b7eb76d8 local]# cat test 
Khighness
[root@43b0b7eb76d8 local]# ifconfig
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.17.0.4  netmask 255.255.0.0  broadcast 172.17.255.255
        ether 02:42:ac:11:00:04  txqueuelen 0  (Ethernet)
        RX packets 8  bytes 656 (656.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0    
[root@43b0b7eb76d8 local]# exit
exit

# 4ã€æŸ¥çœ‹é•œåƒçš„å˜æ›´å†å²
[root@parak dockerfile]# docker history mycentos:1.0 
IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT
d59930f07e43        23 minutes ago      /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;/binâ€¦   0B          
cf7d78851a04        23 minutes ago      /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;echoâ€¦   0B               
17533352607f        23 minutes ago      /bin/sh -c #(nop)  CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;echoâ€¦   0B                  
a86402c5f9b7        23 minutes ago      /bin/sh -c #(nop)  EXPOSE 80                    0B                  
0d095f331d4a        23 minutes ago      /bin/sh -c yum -y install net-tools             23.2MB              
491907dac3e2        23 minutes ago      /bin/sh -c yum -y install vim                   57.7MB              
fdbae7da4ca4        24 minutes ago      /bin/sh -c #(nop) WORKDIR /usr/local            0B                  
a5710fdc760e        24 minutes ago      /bin/sh -c #(nop)  ENV MYPATH=/usr/local        0B                  
6c9b636504d2        24 minutes ago      /bin/sh -c #(nop)  MAINTAINER khighness&lt;1823â€¦   0B                  
0d120b6ccaa8        3 months ago        /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B                  
&lt;missing&gt;           3 months ago        /bin/sh -c #(nop)  LABEL org.label-schema.scâ€¦   0B                  
&lt;missing&gt;           3 months ago        /bin/sh -c #(nop) ADD file:538afc0c5c964ce0dâ€¦   215MB         </code></pre>
<blockquote>
<p>CMDå’ŒENTRYPOINTçš„åŒºåˆ«</p>
</blockquote>
<p><strong>æµ‹è¯•CMD</strong></p>
<pre><code class="shell"># ç¼–å†™æµ‹è¯•CMDçš„dockerfile
[root@parak dockerfile]# vim dockerfile-cmd-test1
# å†…å®¹å°±æ˜¯ä¸€ä¸ªCMDå‘½ä»¤
[root@parak dockerfile]# cat dockerfile-cmd-test1 
FROM centos
CMD [&quot;ls&quot;,&quot;-a&quot;]
# æ„å»ºé•œåƒ
[root@parak dockerfile]# docker build -f dockerfile-cmd-test1 -t cmdtest .
Sending build context to Docker daemon  3.072kB
Step 1/2 : FROM centos
 ---&gt; 0d120b6ccaa8
Step 2/2 : CMD [&quot;ls&quot;,&quot;-a&quot;]
 ---&gt; Running in e4df49ad7ca4
Removing intermediate container e4df49ad7ca4
 ---&gt; 4be395747805
Successfully built 4be395747805
Successfully tagged cmdtest:latest
# è¿è¡Œé•œåƒå°±ç›¸å½“äºè¿è¡ŒCMDå‘½ä»¤ï¼šls -a
[root@parak dockerfile]# docker run cmdtest
.
..
.dockerenv
bin
dev
etc
home
lib
lib64
lost+found
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
# è¿½åŠ å‘½ä»¤-lï¼Œå³ls -al
[root@parak dockerfile]# docker run cmdtest -l
docker: Error response from daemon: OCI runtime create failed: container_linux.go:349: starting container process caused &quot;exec: \&quot;-l\&quot;: executable file not found in $PATH&quot;: unknown.

</code></pre>
<p><strong>æµ‹è¯•ENTRYPOINT</strong></p>
<pre><code class="shell"># ç¼–å†™æµ‹è¯•ENTRYPOINTçš„dockerfile
[root@parak dockerfile]# vim dockerfile-entrypoint-test1
# å†…å®¹å°±æ˜¯ä¸€ä¸ªENTRYPOINTå‘½ä»¤
[root@parak dockerfile]# cat dockerfile-entrypoint-test1 
FROM centos
ENTRYPOINT [&quot;ls&quot;, &quot;-a&quot;]
# æ„å»ºé•œåƒ
[root@parak dockerfile]# docker build -f dockerfile-entrypoint-test1 -t entrypointtest .
Sending build context to Docker daemon  4.096kB
Step 1/2 : FROM centos
 ---&gt; 0d120b6ccaa8
Step 2/2 : ENTRYPOINT [&quot;ls&quot;, &quot;-a&quot;]
 ---&gt; Running in 0aa9b4c97293
Removing intermediate container 0aa9b4c97293
 ---&gt; 472d86e826d8
Successfully built 472d86e826d8
Successfully tagged entrypointtest:latest
# è¿è¡Œé•œåƒ
[root@parak dockerfile]# docker run entrypointtest
.
..
.dockerenv
bin
dev
etc
home
lib
lib64
lost+found
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
# è¿½å‡»å‘½ä»¤-lï¼Œå³ls -al
[root@parak dockerfile]# docker run entrypointtest -l
total 0
drwxr-xr-x.   1 root root   6 Dec  7 12:27 .
drwxr-xr-x.   1 root root   6 Dec  7 12:27 ..
-rwxr-xr-x.   1 root root   0 Dec  7 12:27 .dockerenv
lrwxrwxrwx.   1 root root   7 May 11  2019 bin -&gt; usr/bin
drwxr-xr-x.   5 root root 340 Dec  7 12:27 dev
drwxr-xr-x.   1 root root  66 Dec  7 12:27 etc
drwxr-xr-x.   2 root root   6 May 11  2019 home
lrwxrwxrwx.   1 root root   7 May 11  2019 lib -&gt; usr/lib
lrwxrwxrwx.   1 root root   9 May 11  2019 lib64 -&gt; usr/lib64
drwx------.   2 root root   6 Aug  9 21:40 lost+found
drwxr-xr-x.   2 root root   6 May 11  2019 media
drwxr-xr-x.   2 root root   6 May 11  2019 mnt
drwxr-xr-x.   2 root root   6 May 11  2019 opt
dr-xr-xr-x. 259 root root   0 Dec  7 12:27 proc
dr-xr-x---.   2 root root 162 Aug  9 21:40 root
drwxr-xr-x.  11 root root 163 Aug  9 21:40 run
lrwxrwxrwx.   1 root root   8 May 11  2019 sbin -&gt; usr/sbin
drwxr-xr-x.   2 root root   6 May 11  2019 srv
dr-xr-xr-x.  13 root root   0 Dec  6 08:24 sys
drwxrwxrwt.   7 root root 145 Aug  9 21:40 tmp
drwxr-xr-x.  12 root root 144 Aug  9 21:40 usr
drwxr-xr-x.  20 root root 262 Aug  9 21:40 var</code></pre>
<br>

<h2 id="ğŸ”é•œåƒ"><a href="#ğŸ”é•œåƒ" class="headerlink" title="ğŸ”é•œåƒ"></a>ğŸ”é•œåƒ</h2><blockquote>
<p>æ¦‚å¿µ</p>
</blockquote>
<p>é•œåƒæ˜¯ä¸€ç§è½»é‡çº§ã€å¯æ‰§è¡Œçš„ç‹¬ç«‹è½¯ä»¶åŒ…ï¼Œç”¨æ¥æ‰“åŒ…è½¯ä»¶è¿è¡Œç¯å¢ƒå’ŒåŸºäºè¿è¡Œç¯å¢ƒå¼€å‘çš„è½¯ä»¶ï¼Œå®ƒåŒ…å«è¿è¡ŒæŸä¸ªè½¯ä»¶æ‰€éœ€çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬ä»£ç ã€è¿è¡Œæ—¶ã€åº“ã€ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ã€‚</p>
<blockquote>
<p>UnionFS(è”åˆæ–‡ä»¶ç³»ç»Ÿ)</p>
</blockquote>
<p>UnionFS: è”åˆæ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ç§åˆ†å±‚ã€è½»é‡çº§å¹¶ä¸”é«˜æ€§èƒ½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæ”¯æŒå¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹ä½œä¸ºä¸€æ¬¡æäº¤æ¥ä¸€å±‚å±‚çš„å åŠ ï¼ŒåŒæ—¶å¯ä»¥å°†ä¸åŒç›®å½•æŒ‚è½½åˆ°åŒä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸‹(Unite several directions into a single virtual file system)ã€‚Unionæ–‡ä»¶ç³»ç»Ÿæ˜¯Dockeré•œåƒçš„åŸºç¡€ã€‚é•œåƒå¯ä»¥é€šè¿‡åˆ†å±‚æ¥è¿›è¡Œç»§æ‰¿ï¼ŒåŸºäºåŸºç¡€é•œåƒ(æ²¡æœ‰çˆ¶é•œåƒ)ï¼Œå¯ä»¥åˆ¶ä½œå„ç§å…·ä½“çš„åº”ç”¨é•œåƒã€‚</p>
<p>ç‰¹æ€§ï¼šä¸€æ¬¡åŒæ—¶åŠ è½½å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä½†ä»å¤–é¢çœ‹èµ·æ¥ï¼Œåªèƒ½çœ‹åˆ°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè”åˆåŠ è½½ä¼šæŠŠå„å±‚æ–‡ä»¶ç³»ç»Ÿå åŠ èµ·æ¥ï¼Œè¿™æ ·æœ€ç»ˆçš„æ–‡ä»¶ç³»ç»Ÿä¼šåŒ…å«æ‰€æœ‰åº•å±‚çš„æ–‡ä»¶å’Œç›®å½•ã€‚</p>
<blockquote>
<p>Dockeré•œåƒåŠ è½½åŸç†</p>
</blockquote>
<p>Dockerçš„é•œåƒå®é™…ä¸Šç”±ä¸€å±‚ä¸€å±‚çš„æ–‡ä»¶ç³»ç»Ÿç»„æˆï¼Œè¿™ç§å±‚çº§çš„æ–‡ä»¶ç³»ç»ŸUnionFSã€‚</p>
<p>bootfs(boot file system)ä¸»è¦åŒ…å«bootloaderå’Œkernelï¼Œbootloaderä¸»è¦æ˜¯å¼•å¯¼åŠ è½½kernelï¼ŒLinuxåˆšå¯åŠ¨æ—¶ä¼šåœ¨å®¶bootfsæ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨Dockeré•œåƒçš„æœ€åº•å±‚æ˜¯bootfsã€‚è¿™ä¸€å±‚ä¸æˆ‘ä»¬å…¸å‹çš„Linux/Unixç³»ç»Ÿæ˜¯ä¸€æ ·çš„ï¼ŒåŒ…å«bootåŠ è½½å™¨å’Œå†…æ ¸ã€‚å½“bootåŠ è½½å®Œæˆä¹‹åæ•´ä¸ªå†…æ ¸å°±éƒ½åœ¨å†…å­˜ä¸­äº†ï¼Œæ­¤æ—¶å†…å­˜å’Œä½¿ç”¨æƒå·²ç”±bootfsè½¬äº¤ç»™å†…æ ¸ï¼Œæ­¤æ—¶ç³»ç»Ÿä¹Ÿä¼šå¸è½½bootfsã€‚</p>
<p>rootfs(root file system)ï¼Œåœ¨bootfsä¹‹åã€‚åŒ…å«çš„å°±æ˜¯å…¸å‹Linuxç³»ç»Ÿ/devï¼Œ/procï¼Œ/binï¼Œ/etcç­‰æ ‡å‡†ç›®å½•å’Œæ–‡ä»¶ã€‚rootfså°±æ˜¯å„ç§ä¸åŒçš„æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆï¼Œæ¯”å¦‚Ubuntuã€CentOSç­‰ç­‰ã€‚</p>
<blockquote>
<p>commité•œåƒ</p>
</blockquote>
<pre><code class="shell">$ docker commit -m=&quot;&lt;messahe&gt;&quot; -a=&quot;&lt;author&gt;&quot; &lt;Container ID/NAME&gt; &lt;Target&gt;:&lt;Tag&gt;

# ä¾‹å¦‚ï¼Œæ”¹è£…tomcat:9.0çš„é•œåƒæ‰“åŒ…æˆè‡ªå·±çš„é•œåƒk-tom:1.0
[root@parak khighness]# docker commit -a=&quot;Khighness&quot; -m=&quot;Add web application&quot; tom1 k-tom:1.0
sha256:fa4617c8771c81b890dc2a87c7be1d2b851c6ba92b053d0d1d8730b2006550c5
[root@parak khighness]# docker images
REPOSITORY            TAG                 IMAGE ID            CREATED             SIZE
k-tom                 1.0                 fa4617c8771c        26 seconds ago      654MB
nginx                 latest              bc9a0695f571        11 days ago         133MB
tomcat                9.0                 e0bd8b34b4ea        2 weeks ago         649MB
redis                 latest              74d107221092        2 weeks ago         104MB
portainer/portainer   latest              62771b0b9b09        4 months ago        79.1MB
elasticsearch         7.6.2               f29a1ee41030        8 months ago        791MB
hello-world           latest              bf756fb1ae65        11 months ago       13.3kB</code></pre>
<br>

<h2 id="ğŸŒ€å®¹å™¨æ•°æ®å·"><a href="#ğŸŒ€å®¹å™¨æ•°æ®å·" class="headerlink" title="ğŸŒ€å®¹å™¨æ•°æ®å·"></a>ğŸŒ€å®¹å™¨æ•°æ®å·</h2><blockquote>
<p>æ¦‚å¿µ</p>
</blockquote>
<p>ç›®å½•æŒ‚è½½ï¼Œå°†å®¹å™¨å†…çš„ç›®å½•æŒ‚è½½åœ¨CentOSä¸Š</p>
<ul>
<li>Dockerå®¹å™¨äº§ç”Ÿçš„æ•°æ®åŒæ­¥åˆ°å®¿ä¸»æœº</li>
<li>æ•°æ®å·å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«æˆ–é‡ç”¨æ•°æ®</li>
</ul>
<blockquote>
<p>å‘½ä»¤è¡ŒæŒ‚è½½</p>
</blockquote>
<pre><code class="shell">$ docker run -it -v -p &lt;ä¸»æœºç›®å½•&gt;:&lt;å®¹å™¨ç›®å½•&gt; 

# ä¾‹å¦‚ï¼Œå°†dockerçš„centoså®¹å™¨ç›®å½•/home/testä¸å®¿ä¸»centosçš„/home/testæŒ‚è½½èµ·æ¥
[root@parak khighness]# docker run -it --name=cen -v /home/test:/home/test centos  /bin/bash
Unable to find image &#39;centos:latest&#39; locally
latest: Pulling from library/centos
3c72a8ed6814: Pull complete 
Digest: sha256:76d24f3ba3317fa945743bb3746fbaf3a0b752f10b10376960de01da70685fbd
Status: Downloaded newer image for centos:latest
[root@4410a5c86528 /]# ls
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
[root@4410a5c86528 /]# cd home/
[root@4410a5c86528 home]# ls
test
[khighness@parak ~]$ cd /home/
[khighness@parak home]$ ls
khighness  test
[root@parak home]# docker inspect cen
# å¦‚ä¸‹æ˜¯æŒ‚è½½ä¿¡æ¯
        &quot;Mounts&quot;: [
            &#123;
                &quot;Type&quot;: &quot;bind&quot;,              # ç±»å‹ï¼šç»‘å®š
                &quot;Source&quot;: &quot;/home/test&quot;,      # å®¹å™¨ç›®å½•
                &quot;Destination&quot;: &quot;/home/test&quot;, # ä¸»æœºç›®å½•
                &quot;Mode&quot;: &quot;&quot;,
                &quot;RW&quot;: true,
                &quot;Propagation&quot;: &quot;rprivate&quot;
            &#125;
        ]
</code></pre>
<p>åœ¨å®¹å™¨çš„æŒ‚è½½ç›®å½•ä¸‹æ–°å»ºK1.javaï¼Œåœ¨å®¿ä¸»æœºçš„æŒ‚è½½ç›®å½•ä¸­å¯ä»¥ç›´æ¥çœ‹åˆ°</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201206183841366.png" class="" title="image-20201206183841366">



<blockquote>
<p>å®‰è£…MySQL</p>
</blockquote>
<pre><code class="shell"># ä¸‹è½½8.0.20ç‰ˆæœ¬çš„mysqlé•œåƒ
$ docker pull mysql:8.0.20
# å¯åŠ¨mysqlæœåŠ¡
# -d åå°è¿è¡Œ
# -v æŒ‚è½½é…ç½®å’Œæ•°æ®
# -e MYSQL_ROOT)PASSWORD è®¾ç½®å¯†ç 
$ docker run --name ksql -d -p 3306:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=KAG1823 mysql:8.0.20

# è§£å†³windowsçš„navicatæ— æ³•è¿æ¥çš„é—®é¢˜
# è¿›å…¥mysqlå®¢æˆ·ç«¯
$ docker exec -it ksql  bash
# ç™»å½•mysql
$ mysql -u root -pKAG1823
# é‡ç½®å¯†ç 
$ ALTER USER &#39;root&#39;@&#39;%&#39; IDENTIFIED WITH mysql_native_password BY &#39;KAG1823&#39;;</code></pre>
<br>

<h2 id="ğŸŒDockerç½‘ç»œ"><a href="#ğŸŒDockerç½‘ç»œ" class="headerlink" title="ğŸŒDockerç½‘ç»œ"></a>ğŸŒDockerç½‘ç»œ</h2><blockquote>
<p>å®ç°åŸç†</p>
</blockquote>
<p>Dockerä½¿ç”¨Linuxæ¡¥æ¥ï¼Œåœ¨å®¿ä¸»æœºè™šæ‹Ÿä¸€ä¸ªDockerå®¹å™¨ç½‘æ¡¥(Docker0)ï¼ŒDockerå¯åŠ¨ä¸€ä¸ªå®¹å™¨æ—¶ä¼šæ ¹æ®Dockerç½‘æ¡¥çš„ç½‘æ®µåˆ†é…ç»™å®¹å™¨ä¸€ä¸ªIPåœ°å€ï¼Œç§°ä¸ºContainer-IPï¼ŒåŒæ—¶Dockerç½‘æ¡¥æ˜¯æ¯ä¸ªå®¹å™¨çš„é»˜è®¤ç½‘å…³ã€‚å› ä¸ºåœ¨åŒä¸€å®¿ä¸»æœºå†…çš„å®¹å™¨éƒ½æ¥å…¥åŒä¸€ç½‘æ¡¥ã€‚è¿™æ ·å®¹å™¨ä¹‹é—´å°±èƒ½å¤Ÿé€šè¿‡å®¹å™¨çš„Contain-IPç›´æ¥é€šä¿¡ã€‚</p>
<p>Dockerç½‘æ¡¥æ˜¯å®¿ä¸»æœºè™šæ‹Ÿå‡ºæ¥çš„ï¼Œå¹¶ä¸æ˜¯çœŸå®å­˜åœ¨çš„ç½‘ç»œè®¾å¤‡ï¼Œå¤–éƒ¨è®¾å¤‡æ˜¯æ— æ³•å¯»å€åˆ°çš„ï¼Œè¿™ä¹Ÿæ„å‘³ç€å¤–éƒ¨è®¾å¤‡æ— æ³•é€šè¿‡ç›´æ¥Container-IPè®¿é—®åˆ°å®¹å™¨ã€‚å¦‚æœå®¹å™¨å¸Œæœ›å¤–éƒ¨è®¿é—®åˆ°ï¼Œå¯ä»¥é€šè¿‡æ˜ å°„å®¹å™¨ç«¯å£åˆ°å®¿ä¸»ä¸»æœºï¼ˆç«¯å£æ˜ å°„ï¼‰ï¼Œå³docker runåˆ›å»ºå®¹å™¨æ—¶å€™é€šè¿‡-pæˆ–è€…-På‚æ•°æ¥å¯åŠ¨ï¼Œè®¿é—®å®¹å™¨çš„æ—¶å€™å°±é€šè¿‡[å®¿ä¸»æœºIP]:[å®¹å™¨ç«¯å£]è®¿é—®å®¹å™¨ã€‚</p>
<blockquote>
<p>ç½‘ç»œæ¨¡å¼</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ¨¡å¼</th>
<th align="center">é…ç½®</th>
<th align="center">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Bridgeæ¨¡å¼</td>
<td align="center">-net=bridge</td>
<td align="center">é»˜è®¤æ¨¡å¼</td>
</tr>
<tr>
<td align="center">Hostæ¨¡å¼</td>
<td align="center">-net=host</td>
<td align="center">å®¹å™¨å’Œå®¿ä¸»æœºå…±äº«Network NameSpace</td>
</tr>
<tr>
<td align="center">Containeræ¨¡å¼</td>
<td align="center">-net=container : NAME OR ID</td>
<td align="center">å®¹å™¨å’Œå¦å¤–ä¸€ä¸ªå®¹å™¨å…±äº«Network NameSpace</td>
</tr>
<tr>
<td align="center">Noneæ¨¡å¼</td>
<td align="center">-net=none</td>
<td align="center">å®¹å™¨æœ‰ç‹¬ç«‹çš„Network NameSpaceï¼Œä½†å¹¶æ²¡æœ‰å¯¹å…¶è¿›è¡Œä»»ä½•ç½‘ç»œè®¾ç½®ï¼Œå¦‚åˆ†é…veth pair å’Œç½‘æ¡¥è¿æ¥ï¼Œé…ç½®IPç­‰</td>
</tr>
</tbody></table>
<br>

<h3 id="1ï¸âƒ£hostæ¨¡å¼"><a href="#1ï¸âƒ£hostæ¨¡å¼" class="headerlink" title="1ï¸âƒ£hostæ¨¡å¼"></a>1ï¸âƒ£hostæ¨¡å¼</h3><p>å¦‚æœå¯åŠ¨å®¹å™¨çš„æ—¶å€™ä½¿ç”¨hostæ¨¡å¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¹å™¨å°†ä¸ä¼šè·å¾—ä¸€ä¸ªç‹¬ç«‹çš„Network NameSpaceï¼Œè€Œæ˜¯å’Œå®¿ä¸»æœºå…±ç”¨ä¸€ä¸ªNetwork NameSpaceã€‚å®¹å™¨å°†ä¸ä¼šè™šæ‹Ÿå‡ºè‡ªå·±çš„ç½‘å¡ï¼Œé…ç½®è‡ªå·±çš„IPç­‰ï¼Œè€Œæ˜¯ä½¿ç”¨å®¿ä¸»æœºçš„IPå’Œç«¯å£ã€‚ä½†æ˜¯ï¼Œå®¹å™¨çš„å…¶ä»–æ–¹é¢ï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹åˆ—è¡¨ç­‰è¿˜æ˜¯å’Œå®¿ä¸»æœºéš”ç¦»çš„ã€‚</p>
<p>ä½¿ç”¨hostæ¨¡å¼çš„å®¹å™¨å¯ä»¥ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„IPåœ°å€ä¸å¤–ç•Œé€šä¿¡ï¼Œå®¹å™¨å†…éƒ¨çš„æœåŠ¡ç«¯å£ä¹Ÿå¯ä»¥ä½¿ç”¨å®¿ä¸»æœºçš„ç«¯å£ï¼Œä¸éœ€è¦è¿›è¡ŒNATï¼Œhostæœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯ç½‘ç»œæ€§èƒ½æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯docker hostä¸Šå·²ç»ä½¿ç”¨çš„ç«¯å£å°±ä¸èƒ½å†ç”¨äº†ï¼Œç½‘ç»œçš„éš”ç¦»æ€§ä¸å¥½ã€‚</p>
<br>

<h3 id="2ï¸âƒ£containeræ¨¡å¼"><a href="#2ï¸âƒ£containeræ¨¡å¼" class="headerlink" title="2ï¸âƒ£containeræ¨¡å¼"></a>2ï¸âƒ£containeræ¨¡å¼</h3><p>è¿™ä¸ªæ¨¡å¼æŒ‡å®šæ–°åˆ›å»ºçš„å®¹å™¨å’Œå·²ç»å­˜åœ¨çš„ä¸€ä¸ªå®¹å™¨å…±äº«ä¸€ä¸ª Network NameSpaceï¼Œè€Œä¸æ˜¯å’Œå®¿ä¸»æœºå…±äº«ã€‚æ–°åˆ›å»ºçš„å®¹å™¨ä¸ä¼šåˆ›å»ºè‡ªå·±çš„ç½‘å¡ï¼Œé…ç½®è‡ªå·±çš„ IPï¼Œè€Œæ˜¯å’Œä¸€ä¸ªæŒ‡å®šçš„å®¹å™¨å…±äº« IPã€ç«¯å£èŒƒå›´ç­‰ã€‚åŒæ ·ï¼Œä¸¤ä¸ªå®¹å™¨é™¤äº†ç½‘ç»œæ–¹é¢ï¼Œå…¶ä»–çš„å¦‚æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹åˆ—è¡¨ç­‰è¿˜æ˜¯éš”ç¦»çš„ã€‚ä¸¤ä¸ªå®¹å™¨çš„è¿›ç¨‹å¯ä»¥é€šè¿‡ lo ç½‘å¡è®¾å¤‡é€šä¿¡ã€‚</p>
<br>

<h3 id="3ï¸âƒ£noneæ¨¡å¼"><a href="#3ï¸âƒ£noneæ¨¡å¼" class="headerlink" title="3ï¸âƒ£noneæ¨¡å¼"></a>3ï¸âƒ£noneæ¨¡å¼</h3><p>ä½¿ç”¨noneæ¨¡å¼ï¼ŒDockerå®¹å™¨æ‹¥æœ‰è‡ªå·±çš„Network NameSpaceï¼Œä½†æ˜¯ï¼Œå¹¶ä¸ä¸ºDockerå®¹å™¨è¿›è¡Œä»»ä½•ç½‘ç»œé…ç½®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªDockerå®¹å™¨æ²¡æœ‰ç½‘å¡ã€IPã€è·¯ç”±ç­‰ä¿¡æ¯ã€‚éœ€è¦æˆ‘ä»¬è‡ªå·±ä¸ºDockerå®¹å™¨æ·»åŠ ç½‘å¡ã€é…ç½®IPç­‰ã€‚</p>
<p>è¿™ç§ç½‘ç»œæ¨¡å¼ä¸‹å®¹å™¨åªæœ‰loå›ç¯ç½‘ç»œï¼Œæ²¡æœ‰å…¶ä»–ç½‘å¡ã€‚noneæ¨¡å¼å¯ä»¥åœ¨å®¹å™¨åˆ›å»ºæ—¶é€šè¿‡â€“network=noneæ¥æŒ‡å®šã€‚è¿™ç§ç±»å‹çš„ç½‘ç»œæ²¡æœ‰åŠæ³•è”ç½‘ï¼Œå°é—­çš„ç½‘ç»œèƒ½å¾ˆå¥½çš„ä¿è¯å®¹å™¨çš„å®‰å…¨æ€§ã€‚</p>
<br>

<h3 id="4ï¸âƒ£bridgeæ¨¡å¼"><a href="#4ï¸âƒ£bridgeæ¨¡å¼" class="headerlink" title="4ï¸âƒ£bridgeæ¨¡å¼"></a>4ï¸âƒ£bridgeæ¨¡å¼</h3><p>å½“Dockerè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šåœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªåä¸ºdocker0çš„è™šæ‹Ÿç½‘æ¡¥ï¼Œæ­¤ä¸»æœºä¸Šå¯åŠ¨çš„Dockerå®¹å™¨ä¼šè¿æ¥åˆ°è¿™ä¸ªè™šæ‹Ÿç½‘æ¡¥ä¸Šã€‚è™šæ‹Ÿç½‘æ¡¥çš„å·¥ä½œæ–¹å¼å’Œç‰©ç†äº¤æ¢æœºç±»ä¼¼ï¼Œè¿™æ ·ä¸»æœºä¸Šçš„æ‰€æœ‰å®¹å™¨å°±é€šè¿‡äº¤æ¢æœºè¿åœ¨äº†ä¸€ä¸ªäºŒå±‚ç½‘ç»œä¸­ã€‚</p>
<p>ä»docker0å­ç½‘ä¸­åˆ†é…ä¸€ä¸ªIPç»™å®¹å™¨ä½¿ç”¨ï¼Œå¹¶è®¾ç½®docker0çš„IPåœ°å€ä¸ºå®¹å™¨çš„é»˜è®¤ç½‘å…³ã€‚åœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€å¯¹è™šæ‹Ÿç½‘å¡veth pairè®¾å¤‡ï¼ŒDockerå°†veth pairè®¾å¤‡çš„ä¸€ç«¯æ”¾åœ¨æ–°åˆ›å»ºçš„å®¹å™¨ä¸­ï¼Œå¹¶å‘½åä¸ºeth0ï¼ˆå®¹å™¨çš„ç½‘å¡ï¼‰ï¼Œå¦ä¸€ç«¯æ”¾åœ¨ä¸»æœºä¸­ï¼Œä»¥vethxxxè¿™æ ·ç±»ä¼¼çš„åå­—å‘½åï¼Œå¹¶å°†è¿™ä¸ªç½‘ç»œè®¾å¤‡åŠ å…¥åˆ°docker0ç½‘æ¡¥ä¸­ã€‚å¯ä»¥é€šè¿‡brctl showå‘½ä»¤æŸ¥çœ‹ã€‚</p>
<p>bridgeæ¨¡å¼æ˜¯dockerçš„é»˜è®¤ç½‘ç»œæ¨¡å¼ï¼Œä¸å†™â€“netå‚æ•°ï¼Œå°±æ˜¯bridgeæ¨¡å¼ã€‚ä½¿ç”¨docker run -pæ—¶ï¼Œdockerå®é™…æ˜¯åœ¨iptablesåšäº†DNATè§„åˆ™ï¼Œå®ç°ç«¯å£è½¬å‘åŠŸèƒ½ã€‚å¯ä»¥ä½¿ç”¨iptables -t nat -vnLæŸ¥çœ‹ã€‚</p>
<blockquote>
<p>â€“linkæ¢ç©¶</p>
</blockquote>
<p>å®˜æ–¹å·²ç»ä¸æ¨èä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£ä¸€ä¸‹ã€‚</p>
<p>2ä¸ªå®¹å™¨ä¹‹é—´äº’ç›¸è®¿é—®é€šä¿¡ï¼š<code>docker run &lt;container1-id/name&gt; --link &lt;container2-id/name&gt; &lt;image&gt;</code></p>
<p>ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å¯åŠ¨å®¹å™¨2çš„æ—¶å€™ï¼Œå®¹å™¨ä¾¿å¯ä»¥pingé€šå®¹å™¨1ï¼Œä½†æ˜¯åå‘pingä¸é€šã€‚</p>
<pre><code class="shell"># åˆ›å»ºå®¹å™¨tom1
[root@parak khighness]# docker run -d -p 3356:8080 --name tom1 tomcat:9.0 
dd615d6d2ccb9467aad8ba008ece995588680d849b9f61945b10de5c3475f671
# ä½¿ç”¨--linkåˆ›å»ºå®¹å™¨2
[root@parak khighness]# docker run -d -p 3357:8081 --name tom2 --link tom1  tomcat:9.0 
b2c17969a2cb4407bb1a61a53703a38998a11db01ce516feb70e397b42af6ad3
# tom1ä¸èƒ½pingé€štom2
[root@parak khighness]# docker exec -it tom1 ping tom2
ping: tom2: Name or service not known
# tom2å¯ä»¥pingé€štom1
[root@parak khighness]# docker exec -it tom2 ping tom1
PING tom1 (172.17.0.4) 56(84) bytes of data.
64 bytes from tom1 (172.17.0.4): icmp_seq=1 ttl=64 time=0.161 ms
64 bytes from tom1 (172.17.0.4): icmp_seq=2 ttl=64 time=0.108 ms
64 bytes from tom1 (172.17.0.4): icmp_seq=3 ttl=64 time=0.122 ms
^C
--- tom1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 4ms
rtt min/avg/max/mdev = 0.108/0.130/0.161/0.024 ms
# æŸ¥çœ‹tom2å†…éƒ¨çš„hostsæ–‡ä»¶
[root@parak khighness]# docker exec -it tom2 cat /etc/hosts
127.0.0.1    localhost
::1    localhost ip6-localhost ip6-loopback
fe00::0    ip6-localnet
ff00::0    ip6-mcastprefix
ff02::1    ip6-allnodes
ff02::2    ip6-allrouters
172.17.0.4    tom1 dd615d6d2ccb # ==&gt; æ ¹æºï¼šæœ¬è´¨å°±æ˜¯tom2å°±æ˜¯åœ¨æœ¬åœ°é…ç½®äº†tom1çš„åŸŸåIPè§£æã€‚
172.17.0.5    b2c17969a2cb</code></pre>
<blockquote>
<p>è‡ªå®šä¹‰ç½‘ç»œ</p>
</blockquote>
<pre><code class="shell"># åˆ›å»ºç½‘ç»œ
[root@parak khighness]# docker network create --driver bridge --subnet 192.168.0.0/16 --gateway 192.168.0.1 mynet
abaebdc493149a140ee77965274885adea3882bf117c4f8e61e4034730c3b890
# æŸ¥çœ‹ç½‘ç»œ
[root@parak khighness]# docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
4399361ba4a9        bridge              bridge              local
65f0ec2bfb42        host                host                local
abaebdc49314        mynet               bridge              local
feab1dfce431        none                null                local
# è¯¦ç»†ä¿¡æ¯
[root@parak khighness]# docker network inspect mynet 
[
    &#123;
        &quot;Name&quot;: &quot;mynet&quot;,
        &quot;Id&quot;: &quot;abaebdc493149a140ee77965274885adea3882bf117c4f8e61e4034730c3b890&quot;,
        &quot;Created&quot;: &quot;2020-12-10T16:12:08.563828418+08:00&quot;,
        &quot;Scope&quot;: &quot;local&quot;,
        &quot;Driver&quot;: &quot;bridge&quot;,
        &quot;EnableIPv6&quot;: false,
        &quot;IPAM&quot;: &#123;
            &quot;Driver&quot;: &quot;default&quot;,
            &quot;Options&quot;: &#123;&#125;,
            &quot;Config&quot;: [
                &#123;
                    &quot;Subnet&quot;: &quot;192.168.0.0/16&quot;,
                    &quot;Gateway&quot;: &quot;192.168.0.1&quot;
                &#125;
            ]
        &#125;,
        &quot;Internal&quot;: false,
        &quot;Attachable&quot;: false,
        &quot;Ingress&quot;: false,
        &quot;ConfigFrom&quot;: &#123;
            &quot;Network&quot;: &quot;&quot;
        &#125;,
        &quot;ConfigOnly&quot;: false,
        &quot;Containers&quot;: &#123;&#125;,
        &quot;Options&quot;: &#123;&#125;,
        &quot;Labels&quot;: &#123;&#125;
    &#125;
]
# åœ¨mynetä¸‹å¯åŠ¨tomcat1
[root@parak khighness]# docker run -d -it -p 8080:3355 --net mynet --name mynet-tom1 tomcat:9.0 
4d799757f01f560af7fd44d610b7fdabd1e0f66ef528bf1259f09242bddbb636
# åœ¨mynetä¸‹å¯åŠ¨tomcat2
[root@parak khighness]# docker run -d -it -p 8081:3356 --net mynet --name mynet-tom2 tomcat:9.0 
15c045f96d5b7b2ee2e470cb69e5b1f86511929f7ed05ed8f20db26ef4b975af
# ä½¿ç”¨mynet-tom2 ping mynet-tom1
[root@parak khighness]# docker exec -it mynet-tom2 ping mynet-tom1
PING mynet-tom1 (192.168.0.2) 56(84) bytes of data.
64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.068 ms
64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=2 ttl=64 time=0.042 ms
64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=3 ttl=64 time=0.055 ms
--- mynet-tom1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 4ms
rtt min/avg/max/mdev = 0.042/0.055/0.068/0.010 ms
# ä½¿ç”¨mynet-tom1 ping mynet-tom2
[root@parak khighness]# docker exec -it mynet-tom1 ping mynet-tom2
PING mynet-tom2 (192.168.0.3) 56(84) bytes of data.
64 bytes from mynet-tom2.mynet (192.168.0.3): icmp_seq=1 ttl=64 time=0.036 ms
64 bytes from mynet-tom2.mynet (192.168.0.3): icmp_seq=2 ttl=64 time=0.048 ms
64 bytes from mynet-tom2.mynet (192.168.0.3): icmp_seq=3 ttl=64 time=0.058 ms
--- mynet-tom2 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2ms
rtt min/avg/max/mdev = 0.036/0.047/0.058/0.010 ms</code></pre>
<p>è‡ªå®šä¹‰ç½‘ç»œè‡ªåŠ¨ç»´æŠ¤å¥½å®¹å™¨çš„ç½‘ç»œå…³ç³»ï¼</p>
<blockquote>
<p>ç½‘ç»œè¿é€š</p>
</blockquote>
<pre><code class="shell"># åœ¨Docker0ç½‘ç»œå¯åŠ¨tomcat
[root@parak khighness]# docker run -d -it -p 8082:3357 --name tom1 tomcat:9.0 
0344f04baab2eaeaac0118dac7a93d8b2d77946636c76ed3bde804cbeda836be
# æµ‹è¯•tom1 ping mynetâ€”tom1
[root@parak khighness]# docker exec tom1 ping mynet-tom1
ping: mynet-tom1: Name or service not known
# è¿é€šmynet - tom1
[root@parak khighness]# docker network connect mynet tom1 
# æŸ¥çœ‹mynet1çš„è¯¦ç»†ä¿¡æ¯
[root@parak khighness]# docker inspect mynet
[
    &#123;
        &quot;Name&quot;: &quot;mynet&quot;,
        &quot;Id&quot;: &quot;abaebdc493149a140ee77965274885adea3882bf117c4f8e61e4034730c3b890&quot;,
        &quot;Created&quot;: &quot;2020-12-10T16:12:08.563828418+08:00&quot;,
        &quot;Scope&quot;: &quot;local&quot;,
        &quot;Driver&quot;: &quot;bridge&quot;,
        &quot;EnableIPv6&quot;: false,
        &quot;IPAM&quot;: &#123;
            &quot;Driver&quot;: &quot;default&quot;,
            &quot;Options&quot;: &#123;&#125;,
            &quot;Config&quot;: [
                &#123;
                    &quot;Subnet&quot;: &quot;192.168.0.0/16&quot;,
                    &quot;Gateway&quot;: &quot;192.168.0.1&quot;
                &#125;
            ]
        &#125;,
        &quot;Internal&quot;: false,
        &quot;Attachable&quot;: false,
        &quot;Ingress&quot;: false,
        &quot;ConfigFrom&quot;: &#123;
            &quot;Network&quot;: &quot;&quot;
        &#125;,
        &quot;ConfigOnly&quot;: false,
        &quot;Containers&quot;: &#123;
            # å‘ç°mynetå°†tom1æ”¾åˆ°äº†mynetç½‘ç»œä¸‹ï¼Œå³ä¸€ä¸ªå®¹å™¨ï¼Œä¸¤ä¸ªIP
            &quot;0344f04baab2eaeaac0118dac7a93d8b2d77946636c76ed3bde804cbeda836be&quot;: &#123;
                &quot;Name&quot;: &quot;tom1&quot;,
                &quot;EndpointID&quot;: &quot;8911ad05a9b0d7d0effbf50c82659f36b82d21e18f992359b09494073dddd969&quot;,
                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:04&quot;,
                &quot;IPv4Address&quot;: &quot;192.168.0.4/16&quot;,
                &quot;IPv6Address&quot;: &quot;&quot;
            &#125;,
            &quot;15c045f96d5b7b2ee2e470cb69e5b1f86511929f7ed05ed8f20db26ef4b975af&quot;: &#123;
                &quot;Name&quot;: &quot;mynet-tom2&quot;,
                &quot;EndpointID&quot;: &quot;907f16284e90be0d880a999b29210d1cd82adb2c79b4179eeb1d70d75130362a&quot;,
                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:03&quot;,
                &quot;IPv4Address&quot;: &quot;192.168.0.3/16&quot;,
                &quot;IPv6Address&quot;: &quot;&quot;
            &#125;,
            &quot;4d799757f01f560af7fd44d610b7fdabd1e0f66ef528bf1259f09242bddbb636&quot;: &#123;
                &quot;Name&quot;: &quot;mynet-tom1&quot;,
                &quot;EndpointID&quot;: &quot;6529ef4fc05dffe65fe875fdf15f2f4a61665c4d969767db94dd828baf88b323&quot;,
                &quot;MacAddress&quot;: &quot;02:42:c0:a8:00:02&quot;,
                &quot;IPv4Address&quot;: &quot;192.168.0.2/16&quot;,
                &quot;IPv6Address&quot;: &quot;&quot;
            &#125;
        &#125;,
        &quot;Options&quot;: &#123;&#125;,
        &quot;Labels&quot;: &#123;&#125;
    &#125;
]
# å†æ¬¡æµ‹è¯•tom1 ping mynetâ€”tom1
[root@parak khighness]# docker exec -it tom1 ping mynet-tom1
PING mynet-tom1 (192.168.0.2) 56(84) bytes of data.
64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=1 ttl=64 time=0.097 ms
64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=2 ttl=64 time=0.052 ms
64 bytes from mynet-tom1.mynet (192.168.0.2): icmp_seq=3 ttl=64 time=0.053 ms
--- mynet-tom1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 3ms
rtt min/avg/max/mdev = 0.052/0.067/0.097/0.022 ms</code></pre>
<br>

<h2 id="ğŸ’ Redisé›†ç¾¤éƒ¨ç½²"><a href="#ğŸ’ Redisé›†ç¾¤éƒ¨ç½²" class="headerlink" title="ğŸ’ Redisé›†ç¾¤éƒ¨ç½²"></a>ğŸ’ Redisé›†ç¾¤éƒ¨ç½²</h2><blockquote>
<p>shellè„šæœ¬</p>
</blockquote>
<pre><code class="shell"># åˆ›å»ºç½‘å¡
docker network create redis --subnet 172.38.0.0/16

# é€šè¿‡è„šæœ¬åˆ›å»ºå…­ä¸ªredisé…ç½®
for port in $(seq 1 6); \
do \
mkdir -p /mydata/redis/node-$&#123;port&#125;/conf
touch /mydata/redis/node-$&#123;port&#125;/conf/redis.conf
cat &lt;&lt; EOF &gt;&gt;/mydata/redis/node-$&#123;port&#125;/conf/redis.conf
port 6379
bind 0.0.0.0
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
cluster-announce-ip 172.38.0.1$&#123;port&#125;
cluster-announce-port 6379
cluster-announce-bus-port 16379
appendonly yes
EOF
done

# è¿è¡Œredis
for port in $(seq 1 6); \
do
docker run -p 637$&#123;port&#125;:6379 -p 1637$&#123;port&#125;:16379 --name redis-$&#123;port&#125; \
-v /mydata/redis/node-$&#123;port&#125;/data:/data \
-v /mydata/redis/node-$&#123;port&#125;/conf/redis.conf:/etc/redis/redis.conf \
-d --net redis --ip 172.38.0.1$&#123;port&#125; redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf
done

# è¿›å…¥redis-1
docker exec -it redis-1 /bin/sh
# æ­å»ºé›†ç¾¤
redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 

# åœæ­¢é›†ç¾¤
for port in $(seq 1 6); \
do
docker stop redis-$&#123;port&#125; 
done

# å¯åŠ¨é›†ç¾¤
for port in $(seq 1 6); \
do 
docker start redis-$&#123;port&#125; 
done</code></pre>
<br>

<h2 id="ğŸ’¨SpringBootæµ‹è¯•"><a href="#ğŸ’¨SpringBootæµ‹è¯•" class="headerlink" title="ğŸ’¨SpringBootæµ‹è¯•"></a>ğŸ’¨SpringBootæµ‹è¯•</h2><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<ul>
<li>æ„å»ºSpringBooté¡¹ç›®</li>
<li>æ‰“åŒ…webåº”ç”¨</li>
<li>ç¼–å†™dockerfile</li>
<li>æ„å»ºé•œåƒ</li>
<li>å‘å¸ƒè¿è¡Œ</li>
</ul>
<blockquote>
<p>ç¼–å†™Controller</p>
</blockquote>
<pre><code class="java">@RestController
public class HelloController &#123;
    @GetMapping(&quot;/hello/&#123;name&#125;&quot;)
    public String sayHello(@PathVariable(&quot;name&quot;) String name) &#123;
        return &quot;Hello, &quot; + name + &quot;\n\n&quot; + &quot; -from KHighness&quot;;
    &#125;
&#125;</code></pre>
<blockquote>
<p>é€šè¿‡mavençš„packageæ‰“åŒ…</p>
</blockquote>
<pre><code class="shell">[INFO] Scanning for projects...
[INFO] 
[INFO] --------------------------&lt; top.parak:hello &gt;---------------------------
[INFO] Building hello 1.0-SNAPSHOT
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] --- maven-resources-plugin:3.1.0:resources (default-resources) @ hello ---
[INFO] Using &#39;UTF-8&#39; encoding to copy filtered resources.
[INFO] Copying 0 resource
[INFO] Copying 0 resource
[INFO] --- maven-compiler-plugin:3.8.1:compile (default-compile) @ hello ---
[INFO] Changes detected - recompiling the module!
[INFO] Compiling 2 source files to C:\Users\18236\Desktop\Recent\hello\target\classes
[INFO] --- maven-resources-plugin:3.1.0:testResources (default-testResources) @ hello ---
[INFO] Using &#39;UTF-8&#39; encoding to copy filtered resources.
[INFO] skip non existing resourceDirectory C:\Users\18236\Desktop\Recent\hello\src\test\resources
[INFO] --- maven-compiler-plugin:3.8.1:testCompile (default-testCompile) @ hello ---
[INFO] No sources to compile
[INFO] --- maven-surefire-plugin:2.22.2:test (default-test) @ hello ---
[INFO] No tests to run.
[INFO] --- maven-jar-plugin:3.1.2:jar (default-jar) @ hello ---
[INFO] Building jar: C:\Users\18236\Desktop\Recent\hello\target\hello-1.0-SNAPSHOT.jar
[INFO] --- spring-boot-maven-plugin:2.2.5.RELEASE:repackage (repackage) @ hello ---
[INFO] Replacing main artifact with repackaged archive
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  5.534 s
[INFO] Finished at: 2020-12-10T17:54:11+08:00
[INFO] ------------------------------------------------------------------------</code></pre>
<blockquote>
<p>ç¼–å†™Dockerfile</p>
</blockquote>
<pre><code class="shell">FROM java:8

COPY *.jar /app.jar

CMD [&quot;--server.port=8080&quot;]

EXPOSE 8080

ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;/app.jar&quot;]</code></pre>
<p>é€šè¿‡Xftpå°†æ„å»ºå¥½çš„jaråŒ…å’ŒDockerFileå‘é€åˆ°è™šæ‹Ÿæœº</p>
<blockquote>
<p>æ„å»ºé•œåƒ</p>
</blockquote>
<pre><code class="shell">[root@parak hello]# docker build -t hello .
Sending build context to Docker daemon   17.6MB
Step 1/5 : FROM java:8
 ---&gt; d23bdf5b1b1b
Step 2/5 : COPY *.jar /app.jar
 ---&gt; 34774df7a107
Step 3/5 : CMD [&quot;--server.port=8080&quot;]
 ---&gt; [Warning] IPv4 forwarding is disabled. Networking will not work.
 ---&gt; Running in 11d95474e047
Removing intermediate container 11d95474e047
 ---&gt; e8b6fa21a3a0
Step 4/5 : EXPOSE 8080
 ---&gt; [Warning] IPv4 forwarding is disabled. Networking will not work.
 ---&gt; Running in 896cc7d50875
Removing intermediate container 896cc7d50875
 ---&gt; b139242b232d
Step 5/5 : ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;/app.jar&quot;]
 ---&gt; [Warning] IPv4 forwarding is disabled. Networking will not work.
 ---&gt; Running in 562f3bb605a0
Removing intermediate container 562f3bb605a0
 ---&gt; 1d28463205d5
Successfully built 1d28463205d5
Successfully tagged hello:latest</code></pre>
<blockquote>
<p>è¿è¡Œé•œåƒ</p>
</blockquote>
<pre><code class="shell">[root@parak hello]# docker run -d -it -p 8001:8080 hello
7e19b364789de18c736c51e5c84d611e7474d3a733f188220dfd7cc011e55729
[root@parak hello]# curl http://192.168.117.155:8001/hello/KKK
Hello, KKK

 -from KHighness</code></pre>
<br>

<h2 id="â­•ç›¸å…³é—®é¢˜"><a href="#â­•ç›¸å…³é—®é¢˜" class="headerlink" title="â­•ç›¸å…³é—®é¢˜"></a>â­•ç›¸å…³é—®é¢˜</h2><blockquote>
<p>è§£å†³é—®é¢˜1: WARNING: IPv4 forwarding is disabled. Networking will not work.</p>
</blockquote>
<pre><code class="shell">$ echo &quot;net.ipv4.ip_forward=1&quot; &gt;&gt;/usr/lib/sysctl.d/00-system.conf
$ systemctl restart network &amp;&amp; systemctl restart docker</code></pre>
<blockquote>
<p>è§£å†³é—®é¢˜2: ä½¿ç”¨é˜¿é‡Œäº‘æœåŠ¡å™¨è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œå¤–éƒ¨IPä¸èƒ½è®¿é—®</p>
</blockquote>
<p>éœ€è¦åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨é…ç½®é˜²ç«å¢™ç›¸å…³ç«¯å£å¯¹å¤–å¼€æ”¾ã€‚</p>
<p>æ¯”å¦‚è·‘ä¸€ä¸ªå¼€æ”¾ç«¯å£ä¸º3333çš„springbootåº”ç”¨éœ€è¦åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨æ§åˆ¶å°çš„é˜²ç«å¢™æ·»åŠ è§„åˆ™:</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f5f9fa9b/image-20201211233834182.png" class="" title="image-20201211233834182">



]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>è´Ÿè·ç¦»</title>
    <url>/posts/33422a09/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/33422a09/bg.jpg" class="" title="bg">



<p>æƒ³æ˜¯å› ä¸ºä¹…äº†æ‰€ä»¥è®°ä¸èµ·äº†ï¼Œæƒ³æ˜¯å› ä¸ºç©ºæ°”æ¹¿äº†ä¸æ˜¯çœ¼çœ¶çº¢äº†ã€‚</p>
<p>æˆ‘çœ‹è§å‡‹é›¶çš„æ«ï¼Œå¤©ç©ºçš„é¢œè‰²æ¯”æ²¹å½©æ›´å‡é‡ï¼Œå¤§å—ç™½è‰²çš„æµ®äº‘æ è¿‡ï¼Œé‚£æ ‹ç°è‰²çš„å»ºç­‘é—ªçƒé¦™æ§Ÿè‰²çš„å…‰èŠ’ï¼Œæˆ‘ä»æœªæ€€ç–‘è¿‡è‡ªå·±åœ¨æ¢¦é‡Œã€‚</p>
<p>ä¸¤å¹´ä»¥æ¥ï¼Œè‡ªå·±æ˜¯å¦æˆé•¿ï¼Œåˆæ˜¯å¦æ”¹å˜ï¼Ÿå½“åˆæ‡µæ‡‚çš„é€‰æ‹©ï¼Œä¸­é—´åŠªåŠ›çš„è¿·èŒ«ï¼Œè€Œä»Šè¿™å·²æ˜¯ä¸€æ¡ä¸å½’è·¯ã€‚</p>
<p>æ¯ä¸ªäººçš„èº«ä½“å’Œæ„å¿—ï¼Œæ€»æœ‰è¢«ç¯å¢ƒçš„ç‰¢ç¬¼ç¦é”¢é‚£ä¸€éƒ¨åˆ†ï¼Œæƒ³æ–½å±•æ‹³è„šå°±å„ç§Errorã€‚</p>
<p>æˆ–è®¸äººéƒ½åº”è¯¥åšåˆ°å¼ å¼›æœ‰åº¦ï¼Œé€Ÿåº¦ä¸ç¼“ä¸æ€¥ï¼Œè‡ªæœ‰å®‰æ’å¦¥å½“çš„èŠ‚å¥ï¼Œè¯¥æ”¶æ•›çš„æ—¶å€™ä¸é€å¼ºï¼Œè¯¥å‡ºå‡»çš„æ—¶å€™ä¸çŠ¹è±«ï¼Œè¯¥ä¿ç•™çš„æ—¶å€™ä¸ç›²ç›®ï¼Œè¯¥ç«­åŠ›çš„æ—¶å€™ä¸æ°”çŸ­ã€‚</p>
<p>2020ï¼ŒæƒŸæ„¿ä¿¡å¿µä½¿è‡ªå·±è¶…è¶Šã€‚</p>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>JWT</title>
    <url>/posts/1bb08f7a/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ğŸ“–å®˜æ–¹æ–‡æ¡£"><a href="#ğŸ“–å®˜æ–¹æ–‡æ¡£" class="headerlink" title="ğŸ“–å®˜æ–¹æ–‡æ¡£"></a>ğŸ“–å®˜æ–¹æ–‡æ¡£</h2><blockquote>
<p>ğŸŒå®˜æ–¹æ–‡æ¡£</p>
</blockquote>
<p>ğŸ‘‰<a href="https://jwt.io/introduction/">JWT</a></p>
<blockquote>
<p>ğŸ’°JWTæ¦‚è¿°</p>
</blockquote>
<p><strong>JSON Web Token</strong>æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘ä¸”åŒ…å«çš„æ–¹å¼ï¼Œç”¨äºåœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ä½œä¸ºJSONå¯¹è±¡ã€‚ç”±äºæ­¤ä¿¡æ¯æ˜¯ç»è¿‡æ•°å­—ç­¾åçš„ï¼Œç”¨äºåœ¨å„æ–¹é¢ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ä½œä¸ºJSONå¯¹è±¡ã€‚ç”±äºæ­¤ä¿¡æ¯æ˜¯ç»è¿‡æ•°å­—ç­¾ååœ°ï¼Œå› æ­¤å¯ä»¥è¢«éªŒè¯å’Œä¿¡ä»»ã€‚å¯ä»¥ä½¿ç”¨ç§˜å¯†ï¼ˆæˆ–è€…<strong>HMAC</strong>ç®—æ³•ï¼‰æˆ–ä½¿ç”¨<strong>RSA</strong>æˆ–<strong>ECDSA</strong>çš„å…¬é’¥/ç§é’¥å¯¹å¯¹JWTè¿›è¡Œç­¾åã€‚</p>
<p>å°½ç®¡å¯ä»¥å¯¹JWTè¿›è¡ŒåŠ å¯†ä»¥æä¾›åŒæ–¹ä¹‹é—´çš„ä¿å¯†æ€§ï¼Œä½†æˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨å·²ç­¾åçš„ä»¤ç‰Œã€‚ç­¾åçš„ä»¤ç‰Œå¯ä»¥éªŒè¯å…¶ä¸­åŒ…å«çš„å£°æ˜çš„å®Œæ•´æ€§ï¼Œè€ŒåŠ å¯†çš„ä»¤ç‰Œåˆ™å°†è¿™äº›å£°æ˜éšè—åœ¨å…¶ä»–æ–¹çš„é¢å‰ã€‚å½“ä½¿ç”¨å…¬é’¥/ç§é’¥å¯¹å¯¹ä»¤ç‰Œè¿›è¡Œç­¾åæ—¶ï¼Œç­¾åè¿˜è¯æ˜åªæœ‰æŒæœ‰ç§é’¥çš„ä¸€æ–¹æ‰æ˜¯å¯¹å…¶è¿›è¡Œç­¾åçš„ä¸€æ–¹ã€‚</p>
<br>

<a id="more"></a>



<blockquote>
<p>ğŸ”±åº”ç”¨åœºæ™¯</p>
</blockquote>
<ul>
<li>æˆæƒè®¤è¯ï¼šä½¿ç”¨JWTçš„æœ€å¸¸è§æ–¹æ¡ˆã€‚ä¸€æ—¦ç”¨æˆ·ç™»å½•ï¼Œæ¯ä¸ªåç»­è¯·æ±‚å°†åŒ…æ‹¬ä»¤ç‰Œï¼Œä»è€Œå…è®¸ç”¨æˆ·è®¿é—®è¯¥ä»¤ç‰Œå…è®¸çš„è·¯ç”±ã€æœåŠ¡å’Œèµ„æºã€‚å•ç‚¹ç™»å½•æ˜¯å½“ä»Šå¹¿æ³›ä½¿ç”¨JWTçš„ä¸€é¡¹åŠŸèƒ½ï¼Œå› ä¸ºå®ƒçš„å¼€é”€å¾ˆå°å¹¶ä¸”å¯ä»¥åœ¨ä¸åŒçš„åŸŸä¸­è½»æ¾ä½¿ç”¨ã€‚</li>
<li>ä¿¡æ¯äº¤æ¢ï¼šJWTæ˜¯åœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯çš„ä¸€ç§å¥½æ–¹æ³•ã€‚å› ä¸ºå¯ä»¥å¯¹JWTè¿›è¡Œç­¾åï¼Œä¾‹å¦‚ä½¿ç”¨å…¬é’¥/ç§é’¥å¯¹ã€‚æ­¤å¤–ã€‚ç”±äºç­¾åæ˜¯ä½¿ç”¨æ ‡å¤´å’Œæœ‰æ•ˆè´Ÿè½½è®¡ç®—çš„ï¼Œå› æ­¤è¿˜å¯ä»¥éªŒè¯å†…å®¹æ˜¯å¦é­åˆ°ç¯¡æ”¹ã€‚</li>
</ul>
<br>

<h2 id="ğŸš€è®¤è¯æµç¨‹"><a href="#ğŸš€è®¤è¯æµç¨‹" class="headerlink" title="ğŸš€è®¤è¯æµç¨‹"></a>ğŸš€è®¤è¯æµç¨‹</h2><blockquote>
<p>â›”ï¸sessionè®¤è¯</p>
</blockquote>
<p>ä¼ ç»Ÿæ–¹å¼ï¼šç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚ç™»å½•æ—¶å€™è®¾ç½®sessionï¼Œæ­¤åæ¯æ¬¡è®¿é—®æºå¸¦cookieã€‚</p>
<p>é—®é¢˜ï¼š</p>
<ul>
<li>æ¯ä¸ªç”¨æˆ·ç»è¿‡æˆ‘ä»¬çš„åº”ç”¨è®¤è¯ä¹‹åï¼Œæˆ‘ä»¬çš„åº”ç”¨éƒ½è¦åœ¨æœåŠ¡ç«¯åšä¸€æ¬¡è®°å½•ï¼Œä»¥æ–¹ä¾¿ç”¨æˆ·ä¸‹æ¬¡è¯·æ±‚çš„é‰´åˆ«ï¼Œé€šå¸¸è€Œè¨€sessionéƒ½æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè€Œéšç€ç”¨æˆ·çš„å¢å¤šï¼ŒæœåŠ¡ç«¯çš„å¼€é”€ä¼šæ˜æ˜¾å¢å¤§ã€‚</li>
<li>ç”¨æˆ·è®¤è¯ä¹‹åï¼ŒæœåŠ¡ç«¯åšè®¤è¯è®°å½•ï¼Œå¦‚æœè®¤è¯çš„è®°å½•è¢«ä¿å­˜åœ¨å†…å­˜ä¸­çš„è¯ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·ä¸‹æ¬¡è¯·æ±‚è¿˜å¿…é¡»è¦è¯·æ±‚åœ¨è¿™å°æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·æ‰èƒ½æ‹¿åˆ°æˆæƒçš„èµ„æºï¼Œè¿™æ ·åœ¨åˆ†å¸ƒå¼çš„åº”ç”¨ä¸Šï¼Œç›¸åº”çš„é™åˆ¶äº†è´Ÿè½½å‡è¡¡å™¨çš„èƒ½åŠ›ï¼Œè¿™ä¹Ÿæ„å‘³ç€é™åˆ¶äº†åº”ç”¨çš„æ‰©å±•èƒ½åŠ›ã€‚</li>
<li>å› ä¸ºæ˜¯åŸºäºcookieæ¥è¿›è¡Œç”¨æˆ·è¯†åˆ«çš„ï¼Œcookieå¦‚ä½•è¢«æˆªè·ï¼Œç”¨æˆ·å¾ˆå®¹æ˜“å—åˆ°è·¨ç«™è¯·æ±‚ä¼ªé€ çš„æ”»å‡»ã€‚</li>
</ul>
<br>

<blockquote>
<p>ğŸ”°JWTè®¤è¯</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1bb08f7a/JWT%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B.png" class="" title="JWTè®¤è¯">

<p>è®¤è¯æµç¨‹ï¼š</p>
<p>é¦–å…ˆï¼Œå‰ç«¯é€šè¿‡webè¡¨å•å°†è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç å‘é€åˆ°åç«¯çš„æ¥å£ï¼Œè¿™ä¸€è¿‡ç¨‹ä¸€èˆ¬æ˜¯ä¸€ä¸ªHttp POSTè¯·æ±‚ã€‚</p>
<p>åç«¯æ ¸å¯¹ç”¨æˆ·åå’Œå¯†ç æˆåŠŸåï¼Œå°†ç”¨æˆ·çš„idç­‰å…¶ä»–ä¿¡æ¯ä½œä¸ºJWT payload(è´Ÿè½½)ï¼Œå°†å…¶ä¸å¤´éƒ¨åˆ†åˆ«è¿›è¡ŒBased64ç¼–ç æ‹¼æ¥åç­¾åï¼Œå½¢æˆä¸€ä¸ªJWTã€‚å½¢æˆçš„JWTå°±å½¢åŒxxx.yyy.zzzçš„å­—ç¬¦ä¸²ã€‚</p>
<p>åç«¯å°†JWTå­—ç¬¦ä¸²ä½œä¸ºç™»é™†æˆåŠŸçš„è¿”å›ç»“æœè¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯å¯ä»¥å°†è¿”å›çš„ç»“æœä¿å­˜åœ¨localStorageä¸Šï¼Œé€€å‡ºç™»å½•æ—¶å‰ç«¯åˆ é™¤ä¿å­˜çš„JWTå³å¯ã€‚</p>
<p>å‰ç«¯åœ¨æ¯æ¬¡è¯·æ±‚æ—¶å°†JWTæ”¾å…¥HTTP Headerçš„Authorizationä½ã€‚ï¼ˆè§£å†³XSSå’ŒXSRFé—®é¢˜ï¼‰</p>
<p>åç«¯æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œå¦‚å­˜åœ¨éªŒè¯JWTçš„æœ‰æ•ˆæ€§ã€‚ï¼ˆç­¾åæ˜¯å¦æ­£ç¡®ï¼ŒTokenæ˜¯å¦è¿‡æœŸç­‰ï¼‰</p>
<p>éªŒè¯é€šè¿‡ååç«¯ä½¿ç”¨JWTä¸­åŒ…å«çš„ç”¨æˆ·ä¿¡æ¯è¿›è¡Œå…¶ä»–é€»è¾‘æ“ä½œï¼Œå¹¶è¿”å›ç›¸åº”ç»“æœã€‚</p>
<p>ä¼˜åŠ¿ï¼š</p>
<ul>
<li>ç®€æ´ï¼Œå¯ä»¥é€šè¿‡URLï¼ŒPOSTå‚æ•°æˆ–è€…åœ¨HTTP Headerå‘é€ï¼Œå› ä¸ºæ•°æ®é‡å°ï¼Œä¼ è¾“é€Ÿåº¦ä¹Ÿå¾ˆå¿«</li>
<li>è‡ªåŒ…å«ï¼šè´Ÿè½½ä¸­åŒ…å«äº†æ‰€æœ‰ç”¨æˆ·æ‰€éœ€è¦çš„ä¿¡æ¯ï¼Œé¿å…äº†å¤šæ¬¡æŸ¥è¯¢æ•°æ®åº“</li>
<li>å› ä¸ºTokenæ˜¯JSONåŠ å¯†çš„å½¢å¼ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„ï¼Œæ‰€ä»¥JWTæ˜¯è·¨è¯­è¨€çš„ï¼ŒåŸåˆ™ä¸Šä»»ä½•webå½¢å¼éƒ½æ”¯æŒ</li>
<li>ä¸éœ€è¦å†æœåŠ¡ç«¯ä¿å­˜ä¼šè¯ä¿¡æ¯ï¼Œç‰¹åˆ«é€‚åˆç”¨äºåˆ†å¸ƒå¼å¾®æœåŠ¡</li>
</ul>
<br>

<blockquote>
<p>â›“ä»¤ç‰Œç»“æ„</p>
</blockquote>
<p>JSON Web Tokenä»¥ç´§å‡‘çš„å½¢å¼ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œä¸‰éƒ¨åˆ†ç”±<code>.</code>åˆ†éš”ï¼Œå³<code>xxxxx.yyyyy.zzzzz</code></p>
<ul>
<li><p>æ ‡å¤´(Header)  : Base64ç¼–ç ï¼Œç”±ä»¤ç‰Œç±»å‹å’Œç­¾åç®—æ³•ç»„æˆ</p>
<pre><code class="json">&#123;
    &quot;alg&quot;: &quot;HS256&quot;,
    &quot;typ&quot;: &quot;JWT&quot;
&#125;</code></pre>
</li>
<li><p>è´Ÿè½½(Payload) : Base64ç¼–ç ï¼Œç”¨äºæ”¾ç½®æºå¸¦ä¿¡æ¯ï¼Œä¸èƒ½æ”¾æ•æ„Ÿä¿¡æ¯</p>
<pre><code class="json">&#123;
    &quot;name&quot;:&quot;Khighness&quot;
    &quot;admin&quot;:true
    &quot;gender&quot;:&quot;male&quot;
&#125;</code></pre>
</li>
<li><p>ç­¾å(Signature) : å¯¹æ ‡å¤´å’Œè´Ÿè½½è¿›è¡Œç­¾åï¼Œé˜²æ­¢å†…å®¹è¢«ç¯¡æ”¹</p>
<pre><code class="json">HMACSHA256(baseUrlEncode(header)) + &quot;.&quot; + base64UrlEncode(payload).secret)</code></pre>
</li>
</ul>
<br>

<h2 id="ğŸ’»JWT-Demo"><a href="#ğŸ’»JWT-Demo" class="headerlink" title="ğŸ’»JWT-Demo"></a>ğŸ’»JWT-Demo</h2><blockquote>
<p>â•æ·»åŠ ä¾èµ–</p>
</blockquote>
<pre><code class="xml">        &lt;!-- JWT --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.auth0&lt;/groupId&gt;
            &lt;artifactId&gt;java-jwt&lt;/artifactId&gt;
            &lt;version&gt;$&#123;jwt.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;</code></pre>
<br>

<blockquote>
<p>ğŸ“‘Javaä»£ç </p>
</blockquote>
<pre><code class="java">    @Test
    void generateToken()  &#123;
        HashMap&lt;String, Object&gt; map = new HashMap&lt;&gt;();

        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.SECOND, 60);

        String token = JWT.create()
                .withHeader(map)                                     // Header
                .withClaim(&quot;userID&quot;, 1011)              // Payload
                .withClaim(&quot;username&quot;, &quot;KHighness&quot;)
                .withExpiresAt(calendar.getTime())                  // æŒ‡å®šä»¤ç‰Œè¿‡æœŸæ—¶é—´: 60S
                .sign(Algorithm.HMAC256(&quot;PARAK&quot;));                 // Signatureï¼Œè®¾ç½®å¯†é’¥PARAK

        System.out.println(token);
    &#125;

    /**
     * &lt;p&gt;éªŒè¯ä»¤ç‰Œ&lt;/p&gt;
     */
    @Test
    void verifyToken() &#123;
        JWTVerifier jwtVerifier = JWT.require(Algorithm.HMAC512(&quot;PARAK&quot;)).build();
        String token = &quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2MDU5NDU0ODQsInVzZXJJRCI6MTAxMSwidXNlcm5hbWUiOiJLSGlnaG5lc3MifQ.Gvwa3vu_LYogcEPFxKOgFgaH6WnTKoo-UDW977W1GAw&quot;;
        DecodedJWT verify = jwtVerifier.verify(token);
        System.out.println(verify.getClaim(&quot;userID&quot;).asInt());
        System.out.println(verify.getClaim(&quot;username&quot;).asString());
    &#125;</code></pre>
<br>

<blockquote>
<p>â—ï¸ å¸¸è§å¼‚å¸¸</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å¼‚å¸¸</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">TokenExpiredException</td>
<td align="center">ä»¤ç‰Œè¿‡æœŸå¼‚å¸¸</td>
</tr>
<tr>
<td align="center">SignatureVerificationException</td>
<td align="center">ç­¾åä¸ä¸€è‡´å¼‚å¸¸</td>
</tr>
<tr>
<td align="center">AlgorithmMismatchException</td>
<td align="center">åŠ å¯†ç®—æ³•ä¸åŒ¹é…å¼‚å¸¸</td>
</tr>
<tr>
<td align="center">InvalidClaimException</td>
<td align="center">å¤±æ•ˆçš„è´Ÿè½½å¼‚å¸¸</td>
</tr>
</tbody></table>
<br>

<h2 id="ğŸƒæ•´åˆSpringboot"><a href="#ğŸƒæ•´åˆSpringboot" class="headerlink" title="ğŸƒæ•´åˆSpringboot"></a>ğŸƒæ•´åˆSpringboot</h2><blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>ç”¨æˆ·åœ¨ç¬¬ä¸€æ¬¡ç™»é™†çš„æ—¶å€™ï¼Œåå°ç”Ÿæˆtokenè¿”å›ç»™å‰ç«¯å­˜å‚¨åœ¨sessionStorageä¸­ï¼Œæ­¤åæ¯æ¬¡å‰ç«¯éœ€è¦è°ƒç”¨åç«¯éœ€è¦è®¤è¯çš„æ¥å£æ—¶éƒ½æŠŠtokenå–å‡ºæ¥æºå¸¦åœ¨http headerä¸­ã€‚åå°è®¾ç½®æ‹¦æˆªå™¨ï¼Œè®¾ç½®éœ€è¦è®¤è¯æ‰èƒ½è®¿é—®çš„æ¥å£ï¼Œæ¯æ¬¡å¤„ç†è¯·æ±‚æ—¶ï¼Œå…ˆä»requestçš„http headerä¸­å–å‡ºtokenè¿›è¡Œè®¤è¯ï¼Œé€šè¿‡åæ‰è¿›è¡Œç›¸å…³æ¥å£å¤„ç†ã€‚</p>
<br>

<blockquote>
<p>ğŸ”§å°è£…å·¥å…·ç±»</p>
</blockquote>
<pre><code class="java">import com.auth0.jwt.JWT;
import com.auth0.jwt.JWTCreator;
import com.auth0.jwt.algorithms.Algorithm;
import com.auth0.jwt.interfaces.DecodedJWT;
import org.springframework.stereotype.Component;

import java.util.Calendar;
import java.util.Map;

/**
 * &lt;p&gt; Project: Springboot-JWT &lt;/P&gt;
 * &lt;p&gt; Package: top.parak.common &lt;/p&gt;
 * &lt;p&gt; FileName: KKJWTUtil &lt;p&gt;
 * &lt;p&gt; Description: JWTå·¥å…·ç±» &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/22
 */

@Component
public class KKJWTUtil &#123;

    /**
     * &lt;p&gt;ç­¾åçš„å¯†é’¥[@NAME]&lt;/p&gt;
     */
    private static final String secret = &quot;@KHIGHNESS&quot;;

    /**
     * &lt;p&gt;ç­¾åçš„è¿‡æœŸæ—¶é—´[A Week]&lt;/p&gt;
     */
    private static final int accessTokenExpireTime = 604800;

    /**
     * &lt;p&gt;ä»¤ç‰Œé¢å¸ƒè€…èº«ä»½æ ‡è¯†[DOMAIN]&lt;/p&gt;
     */
    private static final String issuer = &quot;parak.top&quot;;

    /**
     * &lt;p&gt;ç”ŸæˆToken&lt;/p&gt;
     * @param chaims
     * @return
     */
    public static String generateToken(Map&lt;String, String&gt; chaims) &#123;
        JWTCreator.Builder builder = JWT.create();

        /* æ·»åŠ è´Ÿè½½ */
        chaims.forEach((k, v) -&gt; &#123;
            builder.withClaim(k, v);
        &#125;);

        /* è®¾ç½®è¿‡æœŸæ—¶é—´ */
        Calendar calendar = Calendar.getInstance();
        calendar.add(Calendar.SECOND, accessTokenExpireTime);
        builder.withExpiresAt(calendar.getTime());

        /* è®¾ç½®é¢å‘è€…èº«ä»½ */
        builder.withIssuer(issuer);

        /* è®¾ç½®åŠ å¯†ç®—æ³•ä»¥åŠå¯†é’¥ */
        String token = builder.sign(Algorithm.HMAC256(secret));

        return token;
    &#125;


    /**
     * &lt;p&gt;è§£ætoken&lt;/p&gt;
     * @param token
     * @return
     */
    public static DecodedJWT verifyToken(String token) &#123;
        return JWT.require(Algorithm.HMAC256(secret)).build().verify(token);
    &#125;

&#125;</code></pre>
<br>

<blockquote>
<p>ç”¨æˆ·æ§åˆ¶å™¨</p>
</blockquote>
<pre><code class="java">import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.auth0.jwt.interfaces.DecodedJWT;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.ObjectUtils;
import org.springframework.web.bind.annotation.*;
import top.parak.common.KKCondition;
import top.parak.common.KKDataResponse;
import top.parak.common.KKJWTUtil;
import top.parak.entity.User;
import top.parak.service.UserService;
import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid;
import java.util.HashMap;
import java.util.Map;

/**
 * &lt;p&gt;
 *     ç”¨æˆ·æ§åˆ¶å±‚
 * &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020-11-19
 */

@Slf4j
@CrossOrigin
@RestController
@RequestMapping(&quot;/api/user&quot;)
public class UserController &#123;

    @Autowired
    private UserService userService;

    /**
     * &lt;p&gt;ç”¨æˆ·æ³¨å†Œ&lt;/p&gt;
     * @param user
     * @return
     */
    @PostMapping(&quot;/register&quot;)
    public KKDataResponse register(@Valid @RequestBody User user) &#123;
        String username = user.getUsername();
        String password = user.getPassword();
        log.info(&quot;ç”¨æˆ·æ³¨å†Œ =&gt; [&#123;&#125;]&quot;, username);
        KKCondition condition = new KKCondition();
        condition.setName(username);
        if (!ObjectUtils.isEmpty(userService.queryUserInCondition(condition))) &#123;
            log.warn(&quot;ç”¨æˆ·å&#123;&#125;å·²è¢«æ³¨å†Œï¼Œä¸å¯é‡å¤æ³¨å†Œ&quot;, username);
            return KKDataResponse.errorResponse(&quot;è¯¥ç”¨æˆ·åå·²è¢«æ³¨å†Œï¼Œä¸å¯é‡å¤æ³¨å†Œ&quot;);
        &#125;
        return userService.saveUser(username, password) == 1 ? KKDataResponse.successResponse(true) : KKDataResponse.errorResponse(false);
    &#125;

    /**
     * &lt;p&gt;ç”¨æˆ·ç™»å½•&lt;/p&gt;
     * @param loginDataJson
     * @return
     */
    @PostMapping(&quot;/login&quot;)
    public KKDataResponse login(@RequestBody String loginDataJson) &#123;
        JSONObject loginData = JSON.parseObject(loginDataJson);
        String username = loginData.get(&quot;username&quot;).toString();
        String password = loginData.get(&quot;password&quot;).toString();
        log.info(&quot;ç”¨æˆ·ç™»å½• =&gt; [&#123;&#125;]&quot;, username);
        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();
        if (userService.authenticate(username, password)) &#123;
            response.put(&quot;loginState&quot;, true);
            /* ç”Ÿæˆä»¤ç‰Œ */
            Map&lt;String, String&gt; payload = new HashMap&lt;&gt;();
            payload.put(&quot;username&quot;, username);
            String token = KKJWTUtil.generateToken(payload);
            response.put(&quot;kktoken&quot;, token);
            return KKDataResponse.successResponse(response);
        &#125; else &#123;
            response.put(&quot;loginState&quot;, false);
            response.put(&quot;kktoken&quot;, null);
            return KKDataResponse.errorResponse(response);
        &#125;
    &#125;

    @GetMapping(&quot;/test&quot;)
    public KKDataResponse test(HttpServletRequest request) &#123;
        String kktoken = (String) request.getHeader(&quot;Authorization&quot;);
        DecodedJWT verify = KKJWTUtil.verifyToken(kktoken);
        String username = verify.getClaim(&quot;username&quot;).asString();
        log.info(&quot;è¯·æ±‚ç”¨æˆ· =&gt; [&#123;&#125;]&quot;, username);
        return KKDataResponse.successResponse(&quot;è¯·æ±‚æˆåŠŸ&quot;);
    &#125;

&#125;</code></pre>
<br>

<blockquote>
<p>è®¾ç½®æ‹¦æˆªå™¨</p>
</blockquote>
<pre><code class="java">
import com.auth0.jwt.exceptions.AlgorithmMismatchException;
import com.auth0.jwt.exceptions.InvalidClaimException;
import com.auth0.jwt.exceptions.SignatureVerificationException;
import com.auth0.jwt.exceptions.TokenExpiredException;
import com.auth0.jwt.interfaces.DecodedJWT;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.servlet.HandlerInterceptor;
import top.parak.common.JwtTokenUtil;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.util.HashMap;
import java.util.Map;

/**
 * &lt;p&gt; Project: Springboot-JWT &lt;/P&gt;
 * &lt;p&gt; Package: top.parak.interceptor &lt;/p&gt;
 * &lt;p&gt; FileName: JWTInterceptor &lt;p&gt;
 * &lt;p&gt; Description: ä»¤ç‰Œæ‹¦æˆªå™¨ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/22
 */

@Slf4j
public class JWTInterceptor implements HandlerInterceptor &#123;
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;
        String kktoken = request.getHeader(&quot;Authorization&quot;);
        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
        try &#123;
            log.info(&quot;è¯·æ±‚ä»¤ç‰Œ =&gt; [&#123;&#125;]&quot;, kktoken);
            DecodedJWT decodedJWT = KKJWTUtil.verifyToken(kktoken);
            log.info(&quot;éªŒè¯ç»“æœ =&gt; [&#123;&#125;]&quot;, true);
            return true;
        &#125; catch (TokenExpiredException e) &#123;
            log.error(&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;, e.getMessage());
            map.put(&quot;msg&quot;, &quot;ä»¤ç‰Œè¿‡æœŸ&quot;);
        &#125; catch (SignatureVerificationException e) &#123;
            log.error(&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;, e.getMessage());
            map.put(&quot;msg&quot;, &quot;ç­¾åé”™è¯¯&quot;);
        &#125; catch (AlgorithmMismatchException e) &#123;
            log.error(&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;, e.getMessage());
            map.put(&quot;msg&quot;, &quot;åŠ å¯†ç®—æ³•ä¸åŒ¹é…&quot;);
        &#125; catch (InvalidClaimException e) &#123;
            log.error(&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;, e.getMessage());
            map.put(&quot;msg&quot;, &quot;å¤±æ•ˆè´Ÿè½½&quot;);
        &#125; catch (NullPointerException e) &#123;
            log.error(&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;, e.getMessage());
            map.put(&quot;msg&quot;, &quot;ä»¤ç‰Œä¸ºç©º&quot;);
        &#125; catch (Exception e) &#123;
            log.error(&quot;å‘æˆå¼‚å¸¸ =&gt; [&#123;&#125;]&quot;, e.getMessage());
            map.put(&quot;msg&quot;, e.getMessage());
        &#125;
        log.error(&quot;éªŒè¯ç»“æœ =&gt; [&#123;&#125;]&quot;, false);
        map.put(&quot;state&quot;, false);
        /* mapè½¬json */
        String json = new ObjectMapper().writeValueAsString(map);
        response.setContentType(&quot;application/json;charset=UTF-8&quot;);
        PrintWriter writer = response.getWriter();
        writer.println(json);
        writer.close();
        return false;
    &#125;
&#125;</code></pre>
<br>

<blockquote>
<p>æ‹¦æˆªå™¨é…ç½®</p>
</blockquote>
<pre><code class="java">import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;
import top.parak.intercepter.JWTIntercepter;

/**
 * &lt;p&gt; Project: Springboot-JWT &lt;/P&gt;
 * &lt;p&gt; Package: top.parak.config &lt;/p&gt;
 * &lt;p&gt; FileName: IntercepterConfig &lt;p&gt;
 * &lt;p&gt; Description: &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/22
 */

@Configuration
public class InterceptorConfig implements WebMvcConfigurer &#123;
    @Override
    public void addInterceptors(InterceptorRegistry registry) &#123;
        registry.addInterceptor(new JWTInterceptor())
                .addPathPatterns(&quot;/api/**/**&quot;)
                .excludePathPatterns(&quot;/api/user/login&quot;);
    &#125;
&#125;
</code></pre>
]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>JWT</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis-plus</title>
    <url>/posts/fd1960c6/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ğŸ“–-å®˜æ–¹æ–‡æ¡£"><a href="#ğŸ“–-å®˜æ–¹æ–‡æ¡£" class="headerlink" title="ğŸ“– å®˜æ–¹æ–‡æ¡£"></a>ğŸ“– å®˜æ–¹æ–‡æ¡£</h2><blockquote>
<p>ğŸŒæ–‡æ¡£</p>
</blockquote>
<p>ğŸ‘‰ <a href="https://mybatis.plus/">mybatis-plus</a></p>
<blockquote>
<p>â˜„ï¸ç‰¹æ€§</p>
</blockquote>
<ul>
<li>æ¶¦ç‰©æ— å£°ï¼šåªåšå¢å¼ºä¸åšæ”¹å˜ï¼Œå¼•å…¥å®ƒä¸ä¼šå¯¹ç°æœ‰å·¥ç¨‹äº§ç”Ÿå½±å“ï¼Œå¦‚ä¸èˆ¬é¡ºæ»‘ã€‚</li>
<li>æ•ˆç‡è‡³ä¸Šï¼šåªéœ€ç®€å•é…ç½®ï¼Œå³å¯å¿«é€Ÿè¿›è¡Œå•è¡¨ CRUD æ“ä½œï¼Œä»è€ŒèŠ‚çœå¤§é‡æ—¶é—´ã€‚</li>
<li>ä¸°å¯ŒåŠŸèƒ½ï¼šä»£ç ç”Ÿæˆã€ç‰©ç†åˆ†é¡µã€æ€§èƒ½åˆ†æç­‰åŠŸèƒ½ä¸€åº”ä¿±å…¨ã€‚</li>
</ul>
<blockquote>
<p>â›“ç»“æ„</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/fd1960c6/mybatis-plus-framework.jpg" class="" title="mybatis-plus-framework">

<br>

<a id="more"></a>



<h2 id="â•-æ·»åŠ ä¾èµ–"><a href="#â•-æ·»åŠ ä¾èµ–" class="headerlink" title="â• æ·»åŠ ä¾èµ–"></a>â• æ·»åŠ ä¾èµ–</h2><pre><code class="properties">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;top.parak&lt;/groupId&gt;
    &lt;artifactId&gt;Mybatis-plus&lt;/artifactId&gt;
    &lt;description&gt;Mybatis-plus Learning&lt;/description&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

    &lt;developers&gt;
        &lt;developer&gt;
            &lt;name&gt;KHighness&lt;/name&gt;
            &lt;email&gt;parakovo@gmail.com&lt;/email&gt;
        &lt;/developer&gt;
    &lt;/developers&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.2.5.RELEASE&lt;/version&gt;
    &lt;/parent&gt;

    &lt;properties&gt;
        &lt;mysql.version&gt;8.0.20&lt;/mysql.version&gt;
        &lt;fastjson.version&gt;1.2.58&lt;/fastjson.version&gt;
        &lt;gson.version&gt;2.8.6&lt;/gson.version&gt;
        &lt;mybatis-plus.version&gt;3.4.0&lt;/mybatis-plus.version&gt;
        &lt;common-io.version&gt;2.6&lt;/common-io.version&gt;
        &lt;common-fileupload.version&gt;1.4&lt;/common-fileupload.version&gt;
        &lt;mybatis-plus-generate.version&gt;2.3.3&lt;/mybatis-plus-generate.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;

        &lt;!-- Spring Web --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- Spring Aop --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- Spring Test --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;
                    &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;

        &lt;!-- Spring Configuration --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;

        &lt;!-- Mybatis-plus --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;$&#123;mybatis-plus.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- mybatis-plus-generator --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-generate&lt;/artifactId&gt;
            &lt;version&gt;$&#123;mybatis-plus-generate.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Mysql --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;$&#123;mysql.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Unit Test --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;junit&lt;/groupId&gt;
            &lt;artifactId&gt;junit&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- Lombok --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- FastJSON --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;
            &lt;version&gt;$&#123;fastjson.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;mainClass&gt;top.parak.KHighnessApplication&lt;/mainClass&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;</code></pre>
<br>

<h2 id="ğŸ’¥é…ç½®æ—¥å¿—"><a href="#ğŸ’¥é…ç½®æ—¥å¿—" class="headerlink" title="ğŸ’¥é…ç½®æ—¥å¿—"></a>ğŸ’¥é…ç½®æ—¥å¿—</h2><pre><code class="properties"># Server
server.port=3333
server.tomcat.uri-encoding=UTF-8

# Database
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowMultiQueries=true
spring.datasource.username=root
spring.datasource.password=KAG1823

# Mybatis-plus
mybatis-plus.mapper-locations=classpath*:/mapper/**/*.xml
mybatis-plus.type-aliases-package=top.parak.entity
mybatis-plus.configuration.map-underscore-to-camel-case=true
mybatis-plus.global-config.banner=false
mybatis-plus.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
# Logic-Delete
mybatis-plus.global-config.db-config.logic-delete-value=1
mybatis-plus.global-config.db-config.logic-not-delete-value=0

# Log
logging.level.top.parak.mapper=debug
logging.level.top.parak.controller=debug</code></pre>
<br>

<h2 id="ğŸŒ€ä¸»é”®ç”Ÿæˆç­–ç•¥"><a href="#ğŸŒ€ä¸»é”®ç”Ÿæˆç­–ç•¥" class="headerlink" title="ğŸŒ€ä¸»é”®ç”Ÿæˆç­–ç•¥"></a>ğŸŒ€ä¸»é”®ç”Ÿæˆç­–ç•¥</h2><blockquote>
<p>â„ï¸Snowflake</p>
</blockquote>
<p><code>SnowFlake</code>æ˜¯<code>Twitter</code>å¼€æºçš„åˆ†å¸ƒå¼<code>ID</code>ç”Ÿæˆç®—æ³•ã€‚</p>
<blockquote>
<p>ğŸ†”IDç»“æ„</p>
</blockquote>
<p><code>SnowFlake</code>ç”Ÿæˆ<code>ID</code>å›ºå®šæ˜¯ä¸€ä¸ª<code>long</code>å‹çš„æ•°å­—ï¼Œä¸€ä¸ª<code>long</code>å‹å 8ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯64ä¸ª<code>bit</code>ï¼Œåˆ†é…å¦‚ä¸‹ï¼š</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/fd1960c6/SnowFlakeID.jpg" class="" title="SnowFlake">

<ol>
<li>ç¬¬ä¸€ä¸ªbitæ˜¯æ ‡è¯†ä½éƒ¨åˆ†ï¼Œåœ¨<code>Java</code>ä¸­ç”±äº<code>long</code>çš„æœ€é«˜ä½æ˜¯ç¬¦å·ä½ï¼Œæ­£æ•°æ˜¯<code>0</code>ï¼Œè´Ÿæ•°æ˜¯<code>1</code>ï¼Œä¸€èˆ¬ç”Ÿæˆçš„<code>ID</code>ä¸ºæ­£æ•°ï¼Œæ‰€ä»¥å›ºå®šä¸º<code>0</code>ã€‚</li>
<li>æ—¶é—´æˆ³éƒ¨åˆ†å <code>41bit</code>ï¼Œè¿™ä¸ªæ˜¯æ¯«ç§’çº§çš„æ—¶é—´ï¼Œä¸€èˆ¬å®ç°ä¸Šä¸ä¼šå­˜å‚¨å½“å‰çš„æ—¶é—´æˆ³ï¼Œè€Œæ˜¯æ—¶é—´æˆ³çš„å·®å€¼(å½“å‰æ—¶é—´-å›ºå®šçš„å¼€å§‹æ—¶é—´)ï¼Œè¿™æ ·å¯ä»¥ä½¿äº§ç”Ÿçš„<code>ID</code>ä»æ›´å°å€¼å¼€å§‹ã€‚<code>41</code>ä½çš„æ—¶é—´æˆ³å¯ä»¥ä½¿ç”¨<code>69</code>å¹´ã€‚</li>
<li>å·¥ä½œæœºå™¨<code>ID</code>å <code>10bit</code>ï¼Œè¿™é‡Œæ¯”è¾ƒçµæ´»ï¼Œæ¯”å¦‚ï¼Œå¯ä»¥ä½¿ç”¨å‰<code>5</code>ä½ä½œä¸ºæ•°æ®ä¸­å¿ƒæœºæˆ¿æ ‡è¯†ï¼Œå<code>5</code>ä½ä½œä¸ºå•æœºæˆ¿æœºå™¨æ ‡è¯†ï¼Œå¯ä»¥éƒ¨ç½²<code>1024</code>ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>åºåˆ—å·éƒ¨åˆ†å <code>12bit</code>ï¼Œæ”¯æŒåŒä¸€æ¯«ç§’å†…åŒä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥ç”Ÿæˆ2^12^=<code>4096</code>ä¸ª<code>ID</code>ã€‚</li>
</ol>
<blockquote>
<p>ğŸŒ  ä¼˜ç‚¹å’Œç¼ºç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ¯«ç§’æ•°åœ¨é«˜ä½ï¼Œè‡ªå¢åºåˆ—åœ¨ä½ä½ï¼Œ<code>ID</code>è¶‹åŠ¿é€’å¢ã€‚</li>
<li>ä»¥æœåŠ¡æ–¹å¼éƒ¨ç½²ï¼Œå¯ä»¥åšé«˜å¯ç”¨ã€‚</li>
<li>æ ¹æ®ä¸šåŠ¡åˆ†é…<code>bit</code>ä½ï¼Œçµæ´»ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ¯å°æœºå™¨çš„æ—¶é’Ÿä¸åŒï¼Œå½“æ—¶é’Ÿå›æ‹¨å¯èƒ½ä¼šå‘ç”Ÿé‡å¤IDã€‚</li>
<li>å½“æ•°æ®é‡å¤§æ—¶ï¼Œéœ€è¦å¯¹<code>ID</code>å–æ¨¡åˆ†åº“åˆ†è¡¨ï¼Œåœ¨è·¨æ¯«ç§’æ—¶ï¼Œåºåˆ—å·æ€»æ˜¯å½’<code>0</code>ï¼Œä¼šå‘ç”Ÿå–æ¨¡ååˆ†å¸ƒä¸å‡è¡¡ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’» Javaå®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.common;

import java.text.ParseException;
import java.text.SimpleDateFormat;

/**
 * &lt;p&gt; Project: Mybatis-plus &lt;/P&gt;
 * &lt;p&gt; Package: top.parak.common &lt;/p&gt;
 * &lt;p&gt; FileName: SnowShakeUntil &lt;p&gt;
 * &lt;p&gt; Description: é›ªèŠ±ç®—æ³• &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/8
 */

public class SnowFlakeUntil &#123;

    /**
     * &lt;p&gt;å¼€å§‹æ—¶é—´æˆ³&lt;/p&gt;
     */
    public static long START_STMP;
    static &#123;
        String startDateTime = &quot;2001-09-11 00:00:00&quot;;
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);
        try &#123;
            /* 13ä½æ—¶é—´æˆ³ */
            START_STMP = simpleDateFormat.parse(startDateTime).getTime();
        &#125; catch (ParseException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    /**
     * &lt;p&gt;åºåˆ—å·å ç”¨çš„ä½æ•°&lt;/p&gt;
     */
    private final static long SEQUENCE_BIT = 12;

    /**
     * &lt;p&gt;æ•°æ®ä¸­å¿ƒæ ‡è¯†å ç”¨çš„ä½æ•°&lt;/p&gt;
     */
    private final static long MACHINE_BIT = 5;

    /**
     * &lt;p&gt;æœºå™¨æ ‡è¯†å ç”¨çš„ä½æ•°&lt;/p&gt;
     */
    private final static long DATACENTER_BIT = 5;

    /* æ¯ä¸€éƒ¨åˆ†çš„æœ€å¤§å€¼ï¼šå…ˆè¿›è¡Œå·¦ç§»è¿ç®—ï¼Œå†åŒ-1è¿›è¡Œå¼‚æˆ–è¿ç®— */

    /**
     * &lt;p&gt;ç”¨ä½è¿ç®—è®¡ç®—å‡ºæœ€å¤§æ”¯æŒçš„æ•°æ®ä¸­å¿ƒæ•°é‡ï¼š31&lt;/p&gt;
     */
    private final static long MAX_DATACENTER_NUM = -1L ^ (-1L &lt;&lt; DATACENTER_BIT);

    /**
     * &lt;p&gt;ç”¨ä½è¿ç®—è®¡ç®—å‡ºæœ€å¤§æ”¯æŒçš„æœºå™¨æ•°é‡&lt;/p&gt;
     */
    private final static long MAX_MACHINE_NUM = -1L ^ (-1L &lt;&lt; MACHINE_BIT);

    /**
     * &lt;p&gt;ç”¨ä½è¿ç®—è®¡ç®—å‡ºæœ€å¤§æ”¯æŒçš„æœ€å¤§æ­£æ•´æ•°4095&lt;/p&gt;
     */
    private final static long MAX_SEQUENCE = -1L ^ (-1L &lt;&lt; SEQUENCE_BIT);

    /**
     * &lt;p&gt;æœºå™¨æ ‡å¿—è¾ƒåºåˆ—å·çš„åç§»é‡&lt;/p&gt;
     */
    private final static long MACHINE_LEFT = SEQUENCE_BIT;

    /**
     * &lt;p&gt;æ•°æ®ä¸­å¿ƒè¾ƒæœºå™¨æ ‡å¿—çš„åç§»é‡&lt;/p&gt;
     */
    private final static long DATACENTER_LEFT = SEQUENCE_BIT + MACHINE_BIT;

    /**
     * &lt;p&gt;æ—¶é—´æˆ³è¾ƒæ•°æ®ä¸­å¿ƒçš„åç§»é‡&lt;/p&gt;
     */
    private final static long TIMESTMP_LEFT = DATACENTER_LEFT + DATACENTER_BIT;

    /**
     * &lt;p&gt;æ•°æ®ä¸­å¿ƒ&lt;/p&gt;
     */
    private static long dataCenterId;

    /**
     * &lt;p&gt;æœºå™¨æ ‡è¯†&lt;/p&gt;
     */
    private static long machineId;

    /**
     * &lt;p&gt;åºåˆ—å·&lt;/p&gt;
     */
    private static long sequence = 0L;

    /**
     * 4&lt;p&gt;ä¸Šä¸€æ¬¡æ—¶é—´æˆ³&lt;/p&gt;
     */
    private static long lastStmp = -1L;

    /**
     * &lt;p&gt;æ­¤å¤„æ— å‚æ„é€ ç§æœ‰ï¼ŒåŒæ—¶æ²¡æœ‰ç»™å‡ºæœ‰å‚æ„é€ ï¼Œåœ¨äºé¿å…ä»¥ä¸‹ä¸¤ç‚¹é—®é¢˜ï¼š&lt;/p&gt;
     * &lt;li&gt;1. ç§æœ‰åŒ–é¿å…äº†é€šè¿‡newçš„æ–¹å¼è¿›è¡Œè°ƒç”¨ï¼Œä¸»è¦æ˜¯è§£å†³äº†åœ¨forå¾ªç¯ä¸­é€šè¿‡newçš„æ–¹å¼è°ƒç”¨äº§ç”Ÿçš„idä¸ä¸€å®šå”¯ä¸€é—®é¢˜é—®é¢˜ï¼Œå› ä¸ºç”¨äºè®°å½•ä¸Šä¸€æ¬¡æ—¶é—´æˆ³çš„lastStmpæ°¸è¿œæ— æ³•å¾—åˆ°æ¯”å¯¹&lt;/li&gt;
     * &lt;li&gt;2. æ²¡æœ‰ç»™å‡ºæœ‰å‚æ„é€ åœ¨ç¬¬ä¸€ç‚¹çš„åŸºç¡€ä¸Šè€ƒè™‘äº†ä¸€å¥—åˆ†å¸ƒå¼ç³»ç»Ÿäº§ç”Ÿçš„å”¯ä¸€åºåˆ—å·åº”è¯¥æ˜¯åŸºäºç›¸åŒçš„å‚æ•°&lt;/li&gt;
     */
    private SnowFlakeUntil() &#123;&#125;

    /**
     * &lt;p&gt;ç”ŸæˆID&lt;/p&gt;
     * @return
     */
    public static synchronized long nextID() &#123;
        /* è·å–å½“å‰æ—¶é—´æˆ³*/
        long currStmp = getNewStmp();
        /* å¦‚æœå½“å‰æ—¶é—´æˆ³å°äºä¸Šæ¬¡æ—¶é—´æˆ³åˆ™æŠ›å‡ºå¼‚å¸¸ */
        if (currStmp &lt; lastStmp) &#123;
            throw new RuntimeException(&quot;Clock moved backwards. Refusing to generate id&quot;);
        &#125;
        /* ç›¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·è‡ªå¢ */
        if (currStmp == lastStmp) &#123;
            sequence = (sequence + 1) &amp; MAX_SEQUENCE;
            /* åŒä¸€æ¯«ç§’çš„åºåˆ—æ•°å·²ç»è¾¾åˆ°æœ€å¤§*/
            if (sequence == 0L) &#123;
                currStmp = getNextStmp();
            &#125;
        &#125;
        /* ä¸åŒæ¯«ç§’å†…ï¼Œåºåˆ—å·è®¾ä¸º0 */
        else &#123;
            sequence = 0L;
        &#125;

        /* å½“å‰æ—¶é—´æˆ³å­˜æ¡£è®°å½•*/
        lastStmp = currStmp;


        return (currStmp - START_STMP) &lt;&lt; TIMESTMP_LEFT  // æ—¶é—´æˆ³éƒ¨åˆ†
                | dataCenterId &lt;&lt; DATACENTER_LEFT        // æ•°æ®ä¸­å¿ƒéƒ¨åˆ†
                | machineId &lt;&lt; MACHINE_LEFT              // æœºå™¨æ ‡è¯†éƒ¨åˆ†
                | sequence;                              // åºåˆ—å·éƒ¨åˆ†
    &#125;

    /**
     * &lt;p&gt;å½“å‰æ—¶é—´æˆ³&lt;/p&gt;
     * @return
     */
    public static long getNewStmp() &#123;
        return System.currentTimeMillis();
    &#125;

    /**
     * &lt;p&gt;ä¸‹ä¸€æ—¶é—´çš„æ—¶é—´æˆ³&lt;/p&gt;
     * @return
     */
    public static long getNextStmp() &#123;
        long mill = getNewStmp();
        while (mill &lt;= lastStmp) &#123;
            mill = getNewStmp();
        &#125;
        return mill;
    &#125;

&#125;</code></pre>
<blockquote>
<p>ğŸ”±åœ¨Mybatis-plusä¸­è‡ªå®šä¹‰IDç”Ÿæˆå™¨</p>
</blockquote>
<pre><code class="java">@Component
public class CustomIdGenerator implements IdentifierGenerator &#123;
    @Override
    public Long nextId(Object entity) &#123;
          // å¯ä»¥å°†å½“å‰ä¼ å…¥çš„classå…¨ç±»åæ¥ä½œä¸ºbizKey,æˆ–è€…æå–å‚æ•°æ¥ç”ŸæˆbizKeyè¿›è¡Œåˆ†å¸ƒå¼Idè°ƒç”¨ç”Ÿæˆ.
          String bizKey = entity.getClass().getName();
        // æ ¹æ®bizKeyè°ƒç”¨åˆ†å¸ƒå¼IDç”Ÿæˆ
        long id = ....;
          // è¿”å›ç”Ÿæˆçš„idå€¼å³å¯.
        return id;
    &#125;
&#125;</code></pre>
<br>

<h2 id="ğŸš€-CRUDæ‹“å±•"><a href="#ğŸš€-CRUDæ‹“å±•" class="headerlink" title="ğŸš€ CRUDæ‹“å±•"></a>ğŸš€ CRUDæ‹“å±•</h2><blockquote>
<p>å»ºè¡¨</p>
</blockquote>
<pre><code class="sql">CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(20) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
  `age` tinyint DEFAULT NULL,
  `email` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=18 DEFAULT CHARSET=utf8 COLLATE=utf8_bin;</code></pre>
<blockquote>
<p>å®ä½“</p>
</blockquote>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class User &#123;

    @TableId(type = IdType.AUTO)
    private Long id;

    private String name;

    private Integer age;

    @Email
    private String email;

&#125;</code></pre>
<br>

<h3 id="ğŸŒŒè‡ªåŠ¨å¡«å……"><a href="#ğŸŒŒè‡ªåŠ¨å¡«å……" class="headerlink" title="ğŸŒŒè‡ªåŠ¨å¡«å……"></a>ğŸŒŒè‡ªåŠ¨å¡«å……</h3><p>å¯¹äºæ™®é€šå­—æ®µ</p>
<pre><code class="java">public enum FieldFill &#123;
    /* é»˜è®¤ä¸å¤„ç† */
    DEFAULT,
    /* æ’å…¥å¡«å……å­—æ®µ */
    INSERT,
    /*æ›´æ–°å¡«å……å­—æ®µ */
    UPDATE,
    /* æ’å…¥å’Œæ›´æ–°å¡«å……å­—æ®µ */
    INSERT_UPDATE
&#125;</code></pre>
<p>æ‰€æœ‰çš„æ•°æ®åº“è¡¨éƒ½åº”è¯¥åŒ…å«åˆ›å»ºæ—¶é—´gmt_createå’Œä¿®æ”¹æ—¶é—´gmt_modifiedï¼Œè€Œä¸”éœ€è¦è‡ªåŠ¨åŒ–ã€‚â€”â€”ã€Šé˜¿é‡Œå·´å·´å¼€å‘æ‰‹å†Œã€‹</p>
<blockquote>
<p>ğŸ›¢æ•°æ®åº“çº§åˆ«</p>
</blockquote>
<pre><code class="sql"> ALTER TABLE user ADD update_time DATETIME DEFAULT CURRENT_TIMESTAMP;
 ALTER TABLE user ADD create_time DATETIME DEFAULT CURRENT_TIMESTAMP;</code></pre>
<blockquote>
<p>âŒ¨ï¸ä»£ç çº§åˆ«</p>
</blockquote>
<ul>
<li>æ•°æ®è¡¨æ·»åŠ å­—æ®µ</li>
</ul>
<pre><code class="sql"> ALTER TABLE user ADD update_time DATETIME;
 ALTER TABLE user ADD create_time DATETIME;</code></pre>
<ul>
<li>å®ä½“ç±»æ·»åŠ å­—æ®µå’Œæ³¨è§£</li>
</ul>
<pre><code class="java">    @TableField(fill = FieldFill.INSERT)
    private Date createTime;
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Date updateTime;</code></pre>
<ul>
<li>ç¼–å†™å¤„ç†å™¨å¤„ç†æ³¨è§£</li>
</ul>
<pre><code class="java">package top.parak.handler;

import com.baomidou.mybatisplus.core.handlers.MetaObjectHandler;
import lombok.extern.slf4j.Slf4j;
import org.apache.ibatis.reflection.MetaObject;
import org.springframework.stereotype.Component;

import java.util.Date;

/**
 * &lt;p&gt; Project: Mybatis-plus &lt;/P&gt;
 * &lt;p&gt; Package: top.parak.handler &lt;/p&gt;
 * &lt;p&gt; FileName: DataObjectHandler &lt;p&gt;
 * &lt;p&gt; Description: è‡ªåŠ¨å¡«å……å¤„ç†å™¨ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/9
 */

@Slf4j
@Component
public class DataObjectHandler implements MetaObjectHandler &#123;

    /**
     * &lt;p&gt;æ’å…¥æ—¶çš„å¡«å……ç­–ç•¥&lt;/p&gt;
     * @param metaObject
     */
    @Override
    public void insertFill(MetaObject metaObject) &#123;
        this.setFieldValByName(&quot;createTime&quot;, new Date(), metaObject);
        this.setFieldValByName(&quot;updateTime&quot;, new Date(), metaObject);
    &#125;

    /**
     * &lt;p&gt;æ›´æ–°æ—¶çš„å¡«å……ç­–ç•¥&lt;/p&gt;
     * @param metaObject
     */
    @Override
    public void updateFill(MetaObject metaObject) &#123;
        this.setFieldValByName(&quot;updateTime&quot;, new Date(), metaObject);
    &#125;
&#125;</code></pre>
<br>

<h3 id="ğŸ”æ‚²è§‚é”"><a href="#ğŸ”æ‚²è§‚é”" class="headerlink" title="ğŸ”æ‚²è§‚é”"></a>ğŸ”æ‚²è§‚é”</h3><blockquote>
<p>ğŸ“–ç†è§£</p>
</blockquote>
<p>å½“è¦å¯¹æ•°æ®åº“çš„ä¸€æ¡æ•°æ®è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…åŒæ—¶è¢«å…¶ä»–äººä¿®æ”¹ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯ç›´æ¥å¯¹æ•°æ®è¿›è¡ŒåŠ é”é˜²æ­¢å¹¶å‘ã€‚</p>
<p>è¿™ç§å€ŸåŠ©æ•°æ®åº“é”æœºåˆ¶ï¼Œåœ¨ä¿®æ”¹æ•°æ®ä¹‹å‰å…ˆé”å®šï¼Œå†ä¿®æ”¹çš„æ–¹å¼è¢«ç§°ä¸ºæ‚²è§‚å¹¶å‘æ§åˆ¶(Pessimistic Concurrency Controlï¼Œç¼©å†™PCCï¼Œåˆåæ‚²è§‚é”)ã€‚</p>
<blockquote>
<p>ğŸ’ å®ç°</p>
</blockquote>
<p>æ‚²è§‚é”çš„å®ç°ï¼Œå¾€å¾€ä¾é æ•°æ®åº“æä¾›çš„é”æœºåˆ¶(åªæœ‰æ•°æ®åº“å±‚æä¾›çš„é”æœºåˆ¶æ‰èƒ½çœŸæ­£ä¿è¯æ•°æ®è®¿é—®çš„æ’ä»–æ€§ï¼Œå¦åˆ™ï¼Œå³ä½¿åœ¨æœ¬ç³»ç»Ÿä¸­å®ç°äº†åŠ é”æœºåˆ¶ï¼Œä¹Ÿæ— æ³•ä¿è¯å¤–éƒ¨ç³»ç»Ÿä¸ä¼šä¿®æ”¹æ•°æ®)ã€‚æ‚²è§‚é”çš„å®ç°ï¼š</p>
<ul>
<li>ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“ä½¿ç”¨è¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ã€è¡¨é”ã€è¯»é”ã€å†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨åšæ“ä½œä¹‹å‰å…ˆä¸Šé”</li>
<li>Javaé‡Œé¢çš„åŒæ­¥<code>synchronized</code>å…³é”®å­—çš„å®ç°</li>
<li><code>JUC</code>ä¸­çš„<code>lock</code>åŠ é”</li>
</ul>
<blockquote>
<p>ğŸ”±åˆ†ç±» </p>
</blockquote>
<ul>
<li>å…±äº«é”ï¼šåˆç§°ä¸ºè¯»é”ï¼Œç®€ç§°Sé”ã€‚é¡¾åæ€ä¹‰ï¼Œå…±äº«é”å°±æ˜¯å¤šä¸ªäº‹åŠ¡å¯¹äºåŒä¸€ä¸ªæ•°ä¹å¯ä»¥å…±äº«ä¸€æŠŠé”ï¼Œéƒ½èƒ½è®¿é—®åˆ°æ•°æ®ï¼Œä½†æ˜¯åªèƒ½è¯»ä¸èƒ½ä¿®æ”¹ã€‚</li>
<li>æ’ä»–é”ï¼šåˆç§°ä¸ºå†™é”ï¼Œç®€ç§°Xé”ã€‚é¡¾åæ€ä¹‰ï¼Œæ’ä»–é”å°±æ˜¯ä¸èƒ½ä¸å…¶ä»–é”å¹¶å­˜ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡è·å–äº†ä¸€ä¸ªæ•°æ®è¡Œçš„æ’å®ƒé”ï¼Œå…¶ä»–äº‹åŠ¡å°±ä¸èƒ½å†è·å–è¯¥è¡Œçš„å…¶ä»–é”ï¼ŒåŒ…æ‹¬å…±äº«é”å’Œæ’ä»–é”ï¼Œä½†æ˜¯è·å–åˆ°æ’ä»–é”çš„äº‹åŠ¡å¯ä»¥å¯¹æ•°æ®è¿›è¡Œè¯»å–å’Œä¿®æ”¹ã€‚</li>
</ul>
<blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>æ‚²è§‚å¹¶å‘æ§åˆ¶å®è´¨ä¸Šæ˜¯<strong>å…ˆå–é”å†è®¿é—®</strong>çš„ä¿å®ˆç­–ç•¥ï¼Œä¸ºæ•°æ®å¤„ç†çš„å®‰å…¨æä¾›äº†ä¿è¯ã€‚</p>
<p>ä½†æ˜¯åœ¨æ•ˆç‡æ–¹é¢ï¼Œå¤„ç†åŠ é”çš„æœºåˆ¶ä¼šè®©æ•°æ®åº“äº§ç”Ÿé¢å¤–çš„å¼€é”€ï¼Œè¿˜æœ‰å¢åŠ äº§ç”Ÿæ­»é”çš„æœºä¼šã€‚</p>
<p>å¦å¤–è¿˜ä¼šé™ä½å¹¶è¡Œæ€§ï¼Œä¸€ä¸ªäº‹åŠ¡å¦‚æœé”å®šäº†æŸè¡Œæ•°æ®ï¼Œå…¶ä»–äº‹åŠ¡å°±å¿…é¡»ç­‰å¾…è¯¥äº‹åŠ¡å¤„ç†å®Œæ‰å¯ä»¥å¤„ç†é‚£è¡Œæ•°æ®ã€‚</p>
<br>

<h3 id="ğŸ”“ä¹è§‚é”"><a href="#ğŸ”“ä¹è§‚é”" class="headerlink" title="ğŸ”“ä¹è§‚é”"></a>ğŸ”“ä¹è§‚é”</h3><blockquote>
<p>ğŸ“–ç†è§£</p>
</blockquote>
<p>ä¹è§‚é”å‡è®¾æ•°æ®åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šé€ æˆå†²çªï¼Œæ‰€ä»¥åœ¨æ•°æ®è¿›è¡Œæäº¤æ›´æ–°çš„æ—¶å€™ï¼Œæ‰ä¼šæ­£å¼å¯¹æ•°æ®çš„å†²çªä¸å¦è¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœå‘ç°å†²çªäº†ï¼Œåˆ™è¿”å›ç»™ç”¨æˆ·é”™è¯¯çš„ä¿¡æ¯ï¼Œè®©ç”¨æˆ·å†³å®šå¦‚ä½•å»åšã€‚ä¹è§‚é”é€‚ç”¨äºè¯»æ“ä½œå¤šçš„åœºæ™¯ï¼Œè¿™æ ·å¯ä»¥æé«˜ç¨‹åºçš„ååé‡ã€‚</p>
<blockquote>
<p>ğŸ’ å®ç°</p>
</blockquote>
<p>ä¹è§‚é”ä¸ä¼šå¯ä»¥ä½¿ç”¨æ•°æ®åº“æœ¬èº«çš„é”æœºåˆ¶ï¼Œè€Œæ˜¯ä¾æ®æ•°æ®æœ¬èº«æ¥ä¿è¯æ•°æ®çš„æ­£ç¡®æ€§ã€‚ä¹è§‚é”çš„å®ç°ï¼š</p>
<ul>
<li><p>CASå®ç°ï¼š<code>Java </code>ä¸­<code>java.concurrent.atomic</code>åŒ…ä¸‹é¢çš„åŸå­å˜é‡ä½¿ç”¨äº†ä¹è§‚é”çš„ä¸€ç§ <code>CAS</code> å®ç°æ–¹å¼</p>
</li>
<li><p>ç‰ˆæœ¬å·æ§åˆ¶ï¼šä¸€èˆ¬æ˜¯åœ¨æ•°æ®è¡¨ä¸­æ·»åŠ ä¸€ä¸ªæ•°æ®ç‰ˆæœ¬å·<code>version</code>å­—æ®µï¼Œè¡¨ç¤ºæ•°æ®è¢«ä¿®æ”¹çš„æ¬¡æ•°ã€‚å½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œ<code>version</code>å€¼ä¼š+1ã€‚å½“çº¿ç¨‹Aæ›´æ–°æ•°æ®å€¼æ—¶ï¼Œåœ¨è¯»å–æ•°æ®çš„åŒæ—¶ä¹Ÿä¼šè¯»å–<code>version</code>å€¼ï¼Œåœ¨æäº¤æ›´æ–°æ—¶ï¼Œè‹¥åˆšæ‰è¯»å–åˆ°<code>version</code>å€¼ä¸å½“å‰æ•°æ®åº“ä¸­çš„<code>version</code>å€¼ç›¸ç­‰æ—¶æ‰æ›´æ–°ï¼Œå¦åˆ™é‡è¯•æ›´æ–°æ“ä½œï¼Œç›´åˆ°æ›´æ–°æˆåŠŸã€‚</p>
<pre><code class="sql">-- 1 æŸ¥è¯¢ç‰ˆæœ¬å·
select version as oldversion where id = #&#123;id&#125;
-- 2 æ›´æ–°æ“ä½œ
update set ... , version = version  + 1 where id = #&#123;id&#125;  and version = oldversion</code></pre>
</li>
</ul>
<blockquote>
<p>ğŸ’¬è¯´æ˜</p>
</blockquote>
<p>ä¹è§‚å¹¶å‘æ§åˆ¶ç›¸ä¿¡äº‹åŠ¡ä¹‹é—´çš„æ•°æ®ç«äº‰æ¦‚ç‡æ˜¯æ¯”è¾ƒå°çš„ã€‚å› æ­¤å°½å¯èƒ½ç›´æ¥åšä¸‹å»ï¼Œç›´åˆ°æäº¤çš„æ—¶å€™æ‰å»é”å®šï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”Ÿä»»ä½•é”æˆ–æ­»é”ã€‚</p>
<blockquote>
<p>ğŸ”§æ’ä»¶</p>
</blockquote>
<ul>
<li>æ•°æ®è¡¨æ·»åŠ å­—æ®µ</li>
</ul>
<pre><code class="sql">ALTER TABLE user ADD version INT DEFAULT 1; </code></pre>
<ul>
<li>å®ä½“ç±»æ·»åŠ å±æ€§å’Œæ³¨è§£</li>
</ul>
<pre><code class="java">    /* ä¹è§‚é” */
    @Version
    private Integer version;</code></pre>
<ul>
<li>åœ¨mybatis-plusé…ç½®ç±»ä¸­å¢åŠ ä¹è§‚é”æ‹¦æˆªå™¨</li>
</ul>
<pre><code class="java">@Configuration
public class MybatisPlusConfig &#123;

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor()  &#123;
        MybatisPlusInterceptor mybatisPlusInterceptor = new MybatisPlusInterceptor();
        /* ä¹è§‚é”æ’ä»¶ */
        mybatisPlusInterceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
        return mybatisPlusInterceptor;
    &#125;

&#125;</code></pre>
<ul>
<li>ä¹è§‚é”æµ‹è¯•</li>
</ul>
<pre><code class="java">    /**
     * &lt;p&gt;ä¹è§‚é”æµ‹è¯•1&lt;/p&gt;
     */    
    @Test
    void optimisticLock() &#123;
        // æŸ¥è¯¢ä¿¡æ¯
        User user1 = userMapper.selectById(10L);
        // ä¿®æ”¹ä¿¡æ¯
        user1.setName(&quot;Khighness10&quot;);
        user1.setAge(10);
        user1.setEmail(&quot;khighness10@qq.com&quot;);

        // æ’é˜Ÿæ“ä½œ: æŠ¢å…ˆæ›´æ–°ï¼Œä¼šæ›´æ–°ç‰ˆæœ¬å·
        User user2 = userMapper.selectById(10L);
        user2.setAge(100);
        userMapper.updateById(user2);

        // æ‰§è¡Œæ›´æ–°ï¼šæ›´æ–°å¤±è´¥ï¼Œç‰ˆæœ¬å·ä¸å¯¹
        userMapper.updateById(user1);
    &#125;</code></pre>
<pre><code># æµ‹è¯•ç»“æœ
JDBC Connection [HikariProxyConnection@597623166 wrapping com.mysql.cj.jdbc.ConnectionImpl@38cedb7d] will not be managed by Spring
==&gt;  Preparing: SELECT id,name,age,email,create_time,update_time,version FROM user WHERE id=? 
==&gt; Parameters: 10(Long)
&lt;==    Columns: id, name, age, email, create_time, update_time, version
&lt;==        Row: 10, Khighness10, 10, khighness10@qq.com, 2020-11-09 13:30:04, 2020-11-09 13:35:49, 2
&lt;==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@12a14b74]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6a9344f5] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1434769862 wrapping com.mysql.cj.jdbc.ConnectionImpl@38cedb7d] will not be managed by Spring
==&gt;  Preparing: SELECT id,name,age,email,create_time,update_time,version FROM user WHERE id=? 
==&gt; Parameters: 10(Long)
&lt;==    Columns: id, name, age, email, create_time, update_time, version
&lt;==        Row: 10, Khighness10, 10, khighness10@qq.com, 2020-11-09 13:30:04, 2020-11-09 13:35:49, 2
&lt;==      Total: 1
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@6a9344f5]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3234474] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1137013089 wrapping com.mysql.cj.jdbc.ConnectionImpl@38cedb7d] will not be managed by Spring
==&gt;  Preparing: UPDATE user SET name=?, age=?, email=?, create_time=?, update_time=?, version=? WHERE id=? AND version=? 
==&gt; Parameters: Khighness10(String), 100(Integer), khighness10@qq.com(String), 2020-11-09 13:30:04.0(Timestamp), 2020-11-09 13:59:41.434(Timestamp), 3(Integer), 10(Long), 2(Integer)
&lt;==    Updates: 1   // æ’é˜Ÿæ›´æ–°ï¼Œå½±å“è¡Œæ•°ä¸º1=&gt;æˆåŠŸ
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@3234474]
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@58658f63] was not registered for synchronization because synchronization is not active
JDBC Connection [HikariProxyConnection@1424043852 wrapping com.mysql.cj.jdbc.ConnectionImpl@38cedb7d] will not be managed by Spring
==&gt;  Preparing: UPDATE user SET name=?, age=?, email=?, create_time=?, update_time=?, version=? WHERE id=? AND version=? 
==&gt; Parameters: Khighness10(String), 10(Integer), khighness10@qq.com(String), 2020-11-09 13:30:04.0(Timestamp), 2020-11-09 13:59:41.45(Timestamp), 3(Integer), 10(Long), 2(Integer)
&lt;==    Updates: 0   // æ‰§è¡Œæ›´æ–°ï¼Œå½±å“è¡Œæ•°ä¸º0=&gt;å¤±è´¥
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@58658f63]</code></pre>
<br>

<h3 id="ğŸ”–åˆ†é¡µæŸ¥è¯¢"><a href="#ğŸ”–åˆ†é¡µæŸ¥è¯¢" class="headerlink" title="ğŸ”–åˆ†é¡µæŸ¥è¯¢"></a>ğŸ”–åˆ†é¡µæŸ¥è¯¢</h3><ul>
<li>mybatis-plusé…ç½®ç±»ä¸­å¢åŠ åˆ†é¡µæ‹¦æˆªå™¨</li>
</ul>
<pre><code class="java">@Configuration
public class MybatisPlusConfig &#123;

    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor()  &#123;
        MybatisPlusInterceptor mybatisPlusInterceptor = new MybatisPlusInterceptor();
        /* åˆ†é¡µæ’ä»¶ */
        mybatisPlusInterceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return mybatisPlusInterceptor;
    &#125;

&#125;</code></pre>
<ul>
<li>ç›´æ¥ä½¿ç”¨<code>Page</code>å¯¹è±¡</li>
</ul>
<pre><code class="java">    /**
     * åˆ†é¡µæŸ¥è¯¢ï¼Œä½¿ç”¨page
     * æ„é€ å‡½æ•°Page(current, size)
     * current: é¡µå·
     * size: é¡µé¢å¤§å°
     */
    @Test
    void page() &#123;
        Page&lt;User&gt; userPage = new Page&lt;&gt;(3, 3);
        userMapper.selectPage(userPage, null);
        log.info(&quot;æ€»è®°å½•æ•°é‡: &#123;&#125;&quot;, userPage.getTotal());
        log.info(&quot;ç¬¬3é¡µç»“æœå¦‚ä¸‹&quot;);
        userPage.getRecords().stream().forEach(System.out::println);
    &#125;</code></pre>
<pre><code># æµ‹è¯•ç»“æœ
Creating a new SqlSession
SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@d5556bf] was not registered for synchronization because synchronization is not active
2020-11-09 15:44:02.969  INFO 6560 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
2020-11-09 15:44:03.107  INFO 6560 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
JDBC Connection [HikariProxyConnection@2068279617 wrapping com.mysql.cj.jdbc.ConnectionImpl@784223e9] will not be managed by Spring
==&gt;  Preparing: SELECT COUNT(1) FROM user
==&gt; Parameters: 
&lt;==    Columns: COUNT(1)
&lt;==        Row: 12
&lt;==      Total: 1
==&gt;  Preparing: SELECT id,name,age,email,create_time,update_time,version FROM user LIMIT ?,?
==&gt; Parameters: 6(Long), 3(Long)
&lt;==    Columns: id, name, age, email, create_time, update_time, version
&lt;==        Row: 7, UnknownK, 3, unknownk@gmail.@32423.com, 2020-11-09 15:33:38, 2020-11-09 15:33:38, 1
&lt;==        Row: 8, UnknownK, 3, unknownk@gmail.@32423.com, 2020-11-09 15:33:38, 2020-11-09 15:33:38, 1
&lt;==        Row: 9, UnknownK, 3, unknownk@gmail.com, 2020-11-09 13:28:49, 2020-11-09 13:28:49, 1
&lt;==      Total: 3
Closing non transactional SqlSession [org.apache.ibatis.session.defaults.DefaultSqlSession@d5556bf]
2020-11-09 15:44:03.170  INFO 6560 --- [           main] top.parak.mapper.UserMapperTest          : æ€»è®°å½•æ•°é‡: 12
2020-11-09 15:44:03.170  INFO 6560 --- [           main] top.parak.mapper.UserMapperTest          : ç¬¬3é¡µç»“æœå¦‚ä¸‹
User(id=7, name=UnknownK, age=3, email=unknownk@gmail.@32423.com, createTime=Mon Nov 09 15:33:38 CST 2020, updateTime=Mon Nov 09 15:33:38 CST 2020, version=1)
User(id=8, name=UnknownK, age=3, email=unknownk@gmail.@32423.com, createTime=Mon Nov 09 15:33:38 CST 2020, updateTime=Mon Nov 09 15:33:38 CST 2020, version=1)
User(id=9, name=UnknownK, age=3, email=unknownk@gmail.com, createTime=Mon Nov 09 13:28:49 CST 2020, updateTime=Mon Nov 09 13:28:49 CST 2020, version=1)</code></pre>
<br>

<h3 id="ğŸ“›é€»è¾‘åˆ é™¤"><a href="#ğŸ“›é€»è¾‘åˆ é™¤" class="headerlink" title="ğŸ“›é€»è¾‘åˆ é™¤"></a>ğŸ“›é€»è¾‘åˆ é™¤</h3><blockquote>
<p>ç‰©ç†åˆ é™¤ï¼šä»æ•°æ®åº“ä¸­ç›´æ¥åˆ é™¤ã€‚</p>
<p>é€»è¾‘åˆ é™¤ï¼šä¸ä»æ•°æ®åº“ä¸­ç§»é™¤ï¼Œé€šè¿‡ä¸€ä¸ªå˜é‡ä½¿å…¶å¤±æ•ˆã€‚å®è´¨ä¸Šæ˜¯æ›´æ–°ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚</p>
</blockquote>
<ul>
<li>æ•°æ®åº“æ·»åŠ å­—æ®µ</li>
</ul>
<pre><code class="sql">ALTER TABLE user ADD deleted </code></pre>
<ul>
<li>å®ä½“ç±»æ·»åŠ å±æ€§å’Œæ³¨è§£</li>
</ul>
<pre><code class="java">    /* é€»è¾‘åˆ é™¤ */
    @TableLogic
    private Integer deleted;</code></pre>
<ul>
<li>Application.propertiesä¸­å¢åŠ é…ç½®</li>
</ul>
<pre><code class="properties"># é€»è¾‘åˆ é™¤
mybatis-plus.global-config.db-config.logic-delete-value=1
mybatis-plus.global-config.db-config.logic-not-delete-value=0</code></pre>
<br>

<h3 id="ğŸ”æ€§èƒ½åˆ†æ"><a href="#ğŸ”æ€§èƒ½åˆ†æ" class="headerlink" title="ğŸ”æ€§èƒ½åˆ†æ"></a><del>ğŸ”æ€§èƒ½åˆ†æ</del></h3><p>3.4.Xç‰ˆæœ¬ä¸­è¯¥æ’ä»¶å·²ç»ç§»é™¤ã€‚</p>
<br>

<h3 id="ğŸ’¤æ¡ä»¶æ„é€ å™¨"><a href="#ğŸ’¤æ¡ä»¶æ„é€ å™¨" class="headerlink" title="ğŸ’¤æ¡ä»¶æ„é€ å™¨"></a>ğŸ’¤æ¡ä»¶æ„é€ å™¨</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/fd1960c6/image-20201112160607792.png" class="" title="image-20201112160607792">

<pre><code class="java">@SpringBootTest
@Slf4j
public class WrapperTest &#123;

    @Autowired
    private UserMapper userMapper;

    @Test
    void test() &#123;
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();
        // å§“åä¸ä¸ºç©º
        // é‚®ç®±ä¸ä¸ºç©º
        // å¹´é¾„å¤§äºç­‰äº18
        wrapper
                .isNotNull(&quot;name&quot;)
                .isNotNull(&quot;email&quot;)
                .ge(&quot;age&quot;, 18);
        userMapper.selectList(wrapper).stream().forEach(System.out::println);
    &#125;

    @Test
    void test2() &#123;
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();
        wrapper.eq(&quot;name&quot;, &quot;RubbishK&quot;);
        // åªèƒ½æŸ¥è¯¢ä¸€ä¸ªç”¨æˆ·ï¼Œç»“æœå¤šäº1ä¸ªä¼šæŠ¥é”™
        System.out.println(userMapper.selectOne(wrapper));
    &#125;

    @Test
    void test3() &#123;
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();
        // æŸ¥è¯¢å¹´é¾„åœ¨13åˆ°19çš„ç”¨æˆ·æ•°é‡
        wrapper.between(&quot;age&quot;, 13, 19);
        System.out.println(userMapper.selectCount(wrapper));
    &#125;

    @Test
    void test4() &#123;
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();
        // æ¨¡ç³ŠæŸ¥è¯¢
        wrapper
                .likeRight(&quot;name&quot;, &quot;K&quot;)  // K%
                .likeLeft(&quot;email&quot;, &quot;@gmail.com&quot;);  // %@gmail.com
        userMapper.selectList(wrapper).stream().forEach(System.out::println);
    &#125;

    @Test
    void test5() &#123;
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();
        // æ‹¼æ¥sqlè¯­å¥
        wrapper.inSql(&quot;id&quot;, &quot;select id from user where id &lt; 3&quot;);
        userMapper.selectList(wrapper).stream().forEach(System.out::println);
    &#125;

    @Test
    void test6() &#123;
        QueryWrapper&lt;User&gt; wrapper = new QueryWrapper&lt;&gt;();
        // é€šè¿‡IDé™åºæ’åº
        wrapper.orderByDesc(&quot;id&quot;);
        userMapper.selectList(wrapper).stream().forEach(System.out::println);

    &#125;
&#125;</code></pre>
<br>

<h3 id="ğŸ”°ä»£ç ç”Ÿæˆå™¨"><a href="#ğŸ”°ä»£ç ç”Ÿæˆå™¨" class="headerlink" title="ğŸ”°ä»£ç ç”Ÿæˆå™¨"></a>ğŸ”°ä»£ç ç”Ÿæˆå™¨</h3><blockquote>
<p>è‡ªåŠ¨ç”Ÿæˆ entityã€mapperã€serviceã€controllerå±‚çš„ä»£ç </p>
</blockquote>
<pre><code class="java">package top.parak.generator;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.annotation.FieldFill;
import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.generator.AutoGenerator;
import com.baomidou.mybatisplus.generator.InjectionConfig;
import com.baomidou.mybatisplus.generator.config.DataSourceConfig;
import com.baomidou.mybatisplus.generator.config.GlobalConfig;
import com.baomidou.mybatisplus.generator.config.PackageConfig;
import com.baomidou.mybatisplus.generator.config.StrategyConfig;
import com.baomidou.mybatisplus.generator.config.po.TableFill;
import com.baomidou.mybatisplus.generator.config.rules.DateType;
import com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;

import java.util.ArrayList;
import java.util.List;

/**
 * &lt;p&gt; Project: Mybatis-plus &lt;/P&gt;
 * &lt;p&gt; Package: top.parak.generator &lt;/p&gt;
 * &lt;p&gt; FileName: ParaKCode &lt;p&gt;
 * &lt;p&gt; Description: &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/12
 */

public class ParaKCodeGenerator &#123;
    public static void main(String[] args) &#123;
        // ä»£ç ç”Ÿæˆå™¨
        AutoGenerator autoGenerator = new AutoGenerator();

        // å…¨å±€é…ç½®
        GlobalConfig globalConfig = new GlobalConfig();
        String projectPath = System.getProperty(&quot;user.dir&quot;);
        globalConfig.setOutputDir(projectPath + &quot;/src/main/java&quot;);
        // è®¾ç½®ä½œè€…å
        globalConfig.setAuthor(&quot;KHighness&quot;);
        // æ“ä½œå®Œæˆæ˜¯å¦æ‰“å¼€èµ„æºç®¡ç†å™¨
        globalConfig.setOpen(false);
        // æ˜¯å¦è¦†ç›–åŸæœ‰æ–‡ä»¶
        globalConfig.setFileOverride(false);
        // å»Serviceçš„Iå‰ç¼€
        globalConfig.setServiceName(&quot;%sService&quot;); 
        globalConfig.setIdType(IdType.ID_WORKER);
        globalConfig.setDateType(DateType.ONLY_DATE);
        autoGenerator.setGlobalConfig(globalConfig);

        // æ•°æ®æºé…ç½®
        DataSourceConfig dataSourceConfig = new DataSourceConfig();
        dataSourceConfig.setDbType(DbType.MYSQL);
        dataSourceConfig.setUrl(&quot;jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&quot;);
        dataSourceConfig.setDriverName(&quot;com.mysql.cj.jdbc.Driver&quot;);
        dataSourceConfig.setUsername(&quot;root&quot;);
        dataSourceConfig.setPassword(&quot;KAG1823&quot;);
        autoGenerator.setDataSource(dataSourceConfig);

        // åŒ…é…ç½®
        PackageConfig packageConfig = new PackageConfig();
        packageConfig.setModuleName(&quot;test&quot;);
        packageConfig.setParent(&quot;top.parak&quot;);
        packageConfig.setEntity(&quot;entity&quot;);
        packageConfig.setMapper(&quot;mapper&quot;);
        packageConfig.setService(&quot;service&quot;);
        packageConfig.setController(&quot;controller&quot;);
        autoGenerator.setPackageInfo(packageConfig);

        // ç­–ç•¥é…ç½®
        StrategyConfig strategyConfig = new StrategyConfig();
        // æ˜ å°„è¡¨å
        strategyConfig.setInclude(&quot;user&quot;);
        strategyConfig.setNaming(NamingStrategy.underline_to_camel);
        strategyConfig.setColumnNaming(NamingStrategy.underline_to_camel);
        // Lombokå®ä½“ç±»
        strategyConfig.setEntityLombokModel(true);
        // é©¼å³°å‘½å
        strategyConfig.setRestControllerStyle(true);
        // é€»è¾‘åˆ é™¤
        strategyConfig.setLogicDeleteFieldName(&quot;deleted&quot;);
        // åˆ›å»ºæ—¶é—´
        TableFill gmt_create = new TableFill(&quot;create_time&quot;, FieldFill.INSERT);
        // æ›´æ–°æ—¶é—´
        TableFill gmt_modify = new TableFill(&quot;update_time&quot;, FieldFill.INSERT);
        List&lt;TableFill&gt; tableFills = new ArrayList&lt;&gt;();
        tableFills.add(gmt_create);
        tableFills.add(gmt_modify);
        strategyConfig.setTableFillList(tableFills);
        // ä¹è§‚é”
        strategyConfig.setVersionFieldName(&quot;version&quot;);
        strategyConfig.setControllerMappingHyphenStyle(true);
        autoGenerator.setStrategy(strategyConfig);

        // è‡ªå®šä¹‰é…ç½®
        InjectionConfig injectionConfig = new InjectionConfig() &#123;
            @Override
            public void initMap() &#123;
            &#125;
        &#125;;

        // æ‰§è¡Œç”Ÿæˆ
        autoGenerator.execute();
    &#125;
&#125;</code></pre>
]]></content>
      <categories>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Mybatis-plus</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼</title>
    <url>/posts/41682/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>å¯æ‰©å±•æ€§çš„æœ¬è´¨æ˜¯æ‰¾åˆ°ç³»ç»Ÿçš„å˜åŒ–ç‚¹ï¼Œå¹¶éš”ç¦»å˜åŒ–ç‚¹ã€‚ </p>
<p>ä¸–é—´ä¼—å¤šè®¾è®¡æ¨¡å¼å…¶å®å°±æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼å³éš”ç¦»å˜åŒ–ç‚¹çš„æ¨¡å¼ã€‚</p>
<p>æè‡´æ‰©å±•æ€§çš„æ ‡å¿—ï¼Œå°±æ˜¯éœ€æ±‚çš„æ–°å¢ï¼Œä¸ä¼šåœ¨åŸæœ‰ä»£ç äº¤ä»˜ç‰©ä¸Šè¿›è¡Œä»»ä½•å½¢å¼çš„ä¿®æ”¹ã€‚</p>
<p>â€”â€”ã€Šé˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œã€‹</p>
<br>

<h2 id="1-è®¾è®¡åŸåˆ™"><a href="#1-è®¾è®¡åŸåˆ™" class="headerlink" title="1. è®¾è®¡åŸåˆ™"></a>1. è®¾è®¡åŸåˆ™</h2><br>

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/41682/image-20210413121732627.png" class="" title="DesignPrinciple">



<a id="more"></a>

<br>

<h3 id="1-1-å¼€é—­åŸåˆ™"><a href="#1-1-å¼€é—­åŸåˆ™" class="headerlink" title="1.1 å¼€é—­åŸåˆ™"></a>1.1 å¼€é—­åŸåˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>è½¯ä»¶å®ä½“åº”å½“å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<p>å¯ä»¥é€šè¿‡â€œæŠ½è±¡çº¦æŸã€å°è£…å˜åŒ–â€æ¥å®ç°å¼€é—­åŸåˆ™ï¼Œå³é€šè¿‡æ¥å£æˆ–è€…æŠ½è±¡ç±»ä¸ºè½¯ä»¶å®ä½“å®šä¹‰ä¸€ä¸ªç›¸å¯¹ç¨³å®šçš„æŠ½è±¡å±‚ï¼Œè€Œå°†ç›¸åŒçš„å¯å˜å› ç´ å°è£…åœ¨ç›¸åŒçš„å…·ä½“å®ç°ç±»ä¸­ã€‚</p>
<p>å› ä¸ºæŠ½è±¡çµæ´»æ€§å¥½ï¼Œé€‚åº”æ€§å¹¿ï¼Œåªè¦æŠ½è±¡çš„åˆç†ï¼Œå¯ä»¥åŸºæœ¬ä¿æŒè½¯ä»¶æ¶æ„çš„ç¨³å®šã€‚è€Œè½¯ä»¶ä¸­æ˜“å˜çš„ç»†èŠ‚å¯ä»¥ä»æŠ½è±¡æ´¾ç”Ÿæ¥çš„å®ç°ç±»æ¥è¿›è¡Œæ‰©å±•ï¼Œå½“è½¯ä»¶éœ€è¦å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªéœ€è¦æ ¹æ®éœ€æ±‚é‡æ–°æ´¾ç”Ÿä¸€ä¸ªå®ç°ç±»æ¥æ‰©å±•å°±å¯ä»¥äº†ã€‚</p>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>å¼€é—­åŸåˆ™æ˜¯é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡çš„ç»ˆæç›®æ ‡ï¼Œå®ƒä½¿è½¯ä»¶å®ä½“æ‹¥æœ‰ä¸€å®šçš„é€‚åº”æ€§å’Œçµæ´»æ€§çš„åŒæ—¶å…·å¤‡ç¨³å®šæ€§å’Œå»¶ç»­æ€§ã€‚å…·ä½“æ¥è¯´ï¼Œå…¶ä½œç”¨å¦‚ä¸‹ã€‚</p>
<ol>
<li>å¯¹è½¯ä»¶æµ‹è¯•çš„å½±å“</li>
</ol>
<p>è½¯ä»¶éµå®ˆå¼€é—­åŸåˆ™çš„è¯ï¼Œè½¯ä»¶æµ‹è¯•æ—¶åªéœ€è¦å¯¹æ‰©å±•çš„ä»£ç è¿›è¡Œæµ‹è¯•å°±å¯ä»¥äº†ï¼Œå› ä¸ºåŸæœ‰çš„æµ‹è¯•ä»£ç ä»ç„¶èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚</p>
<ol start="2">
<li>å¯ä»¥æé«˜ä»£ç çš„å¯å¤ç”¨æ€§</li>
</ol>
<p>ç²’åº¦è¶Šå°ï¼Œè¢«å¤ç”¨çš„å¯èƒ½æ€§å°±è¶Šå¤§ï¼›åœ¨é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡ä¸­ï¼Œæ ¹æ®åŸå­å’ŒæŠ½è±¡ç¼–ç¨‹å¯ä»¥æé«˜ä»£ç çš„å¯å¤ç”¨æ€§ã€‚</p>
<ol start="3">
<li>å¯ä»¥æé«˜è½¯ä»¶çš„å¯ç»´æŠ¤æ€§</li>
</ol>
<p>éµå®ˆå¼€é—­åŸåˆ™çš„è½¯ä»¶ï¼Œå…¶ç¨³å®šæ€§é«˜å’Œå»¶ç»­æ€§å¼ºï¼Œä»è€Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤ã€‚</p>
<br>

<h3 id="1-2-é‡Œå¼æ›¿æ¢åŸåˆ™"><a href="#1-2-é‡Œå¼æ›¿æ¢åŸåˆ™" class="headerlink" title="1.2 é‡Œå¼æ›¿æ¢åŸåˆ™"></a>1.2 é‡Œå¼æ›¿æ¢åŸåˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ç»§æ‰¿å¿…é¡»ç¡®ä¿è¶…ç±»æ‰€æ‹¥æœ‰çš„æ€§è´¨åœ¨å­ç±»ä¸­ä»ç„¶æˆç«‹</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<p>å­ç±»å¯ä»¥æ‰©å±•çˆ¶ç±»çš„åŠŸèƒ½ï¼Œä½†ä¸èƒ½æ”¹å˜çˆ¶ç±»åŸæœ‰çš„åŠŸèƒ½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼šå­ç±»ç»§æ‰¿çˆ¶ç±»æ—¶ï¼Œé™¤æ·»åŠ æ–°çš„æ–¹æ³•å®Œæˆæ–°å¢åŠŸèƒ½å¤–ï¼Œå°½é‡ä¸è¦é‡å†™çˆ¶ç±»çš„æ–¹æ³•ã€‚</p>
<p>æ ¹æ®ä¸Šè¿°ç†è§£ï¼Œå¯¹é‡Œæ°æ›¿æ¢åŸåˆ™çš„å®šä¹‰å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>å­ç±»å¯ä»¥å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œä½†ä¸èƒ½è¦†ç›–çˆ¶ç±»çš„éæŠ½è±¡æ–¹æ³•</li>
<li>å­ç±»ä¸­å¯ä»¥å¢åŠ è‡ªå·±ç‰¹æœ‰çš„æ–¹æ³•</li>
<li>å½“å­ç±»çš„æ–¹æ³•é‡è½½çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„å‰ç½®æ¡ä»¶ï¼ˆå³æ–¹æ³•çš„è¾“å…¥å‚æ•°ï¼‰è¦æ¯”çˆ¶ç±»çš„æ–¹æ³•æ›´å®½æ¾</li>
<li>å½“å­ç±»çš„æ–¹æ³•å®ç°çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼ˆé‡å†™/é‡è½½æˆ–å®ç°æŠ½è±¡æ–¹æ³•ï¼‰ï¼Œæ–¹æ³•çš„åç½®æ¡ä»¶ï¼ˆå³æ–¹æ³•çš„çš„è¾“å‡º/è¿”å›å€¼ï¼‰è¦æ¯”çˆ¶ç±»çš„æ–¹æ³•æ›´ä¸¥æ ¼æˆ–ç›¸ç­‰</li>
</ul>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<ul>
<li><p>é‡Œæ°æ›¿æ¢åŸåˆ™æ˜¯å®ç°å¼€é—­åŸåˆ™çš„é‡è¦æ–¹å¼ä¹‹ä¸€ã€‚</p>
</li>
<li><p>å®ƒå…‹æœäº†ç»§æ‰¿ä¸­é‡å†™çˆ¶ç±»é€ æˆçš„å¯å¤ç”¨æ€§å˜å·®çš„ç¼ºç‚¹ã€‚</p>
</li>
<li><p>å®ƒæ˜¯åŠ¨ä½œæ­£ç¡®æ€§çš„ä¿è¯ã€‚å³ç±»çš„æ‰©å±•ä¸ä¼šç»™å·²æœ‰çš„ç³»ç»Ÿå¼•å…¥æ–°çš„é”™è¯¯ï¼Œé™ä½äº†ä»£ç å‡ºé”™çš„å¯èƒ½æ€§ã€‚</p>
</li>
<li><p>åŠ å¼ºç¨‹åºçš„å¥å£®æ€§ï¼ŒåŒæ—¶å˜æ›´æ—¶å¯ä»¥åšåˆ°éå¸¸å¥½çš„å…¼å®¹æ€§ï¼Œæé«˜ç¨‹åºçš„ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§ï¼Œé™ä½éœ€æ±‚å˜æ›´æ—¶å¼•å…¥çš„é£é™©ã€‚</p>
</li>
</ul>
<br>

<h3 id="1-3-ä¾èµ–å€’ç½®åŸåˆ™"><a href="#1-3-ä¾èµ–å€’ç½®åŸåˆ™" class="headerlink" title="1.3 ä¾èµ–å€’ç½®åŸåˆ™"></a>1.3 ä¾èµ–å€’ç½®åŸåˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–å…¶æŠ½è±¡ï¼›æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚ï¼Œç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡ã€‚</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<ul>
<li><p>æ¯ä¸ªç±»å°½é‡æä¾›æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œæˆ–è€…ä¸¤è€…éƒ½å…·å¤‡ã€‚</p>
</li>
<li><p>å˜é‡çš„å£°æ˜ç±»å‹å°½é‡æ˜¯æ¥å£æˆ–è€…æ˜¯æŠ½è±¡ç±»ã€‚</p>
</li>
<li><p>ä»»ä½•ç±»éƒ½ä¸åº”è¯¥ä»å…·ä½“ç±»æ´¾ç”Ÿã€‚</p>
</li>
<li><p>ä½¿ç”¨ç»§æ‰¿æ—¶å°½é‡éµå¾ªé‡Œæ°æ›¿æ¢åŸåˆ™ã€‚</p>
</li>
</ul>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<ul>
<li>ä¾èµ–å€’ç½®åŸåˆ™å¯ä»¥é™ä½ç±»é—´çš„è€¦åˆæ€§ã€‚</li>
<li>ä¾èµ–å€’ç½®åŸåˆ™å¯ä»¥æé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚</li>
<li>ä¾èµ–å€’ç½®åŸåˆ™å¯ä»¥å‡å°‘å¹¶è¡Œå¼€å‘å¼•èµ·çš„é£é™©ã€‚</li>
<li>ä¾èµ–å€’ç½®åŸåˆ™å¯ä»¥æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</li>
</ul>
<br>

<h3 id="1-4-å•ä¸€èŒè´£åŸåˆ™"><a href="#1-4-å•ä¸€èŒè´£åŸåˆ™" class="headerlink" title="1.4 å•ä¸€èŒè´£åŸåˆ™"></a>1.4 å•ä¸€èŒè´£åŸåˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ä¸€ä¸ªç±»åº”è¯¥æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¼•èµ·å®ƒå˜åŒ–çš„åŸå› ï¼Œå¦åˆ™ç±»åº”è¯¥è¢«æ‹†åˆ†</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<p>å•ä¸€èŒè´£åŸåˆ™æ˜¯æœ€ç®€å•ä½†åˆæœ€éš¾è¿ç”¨çš„åŸåˆ™ï¼Œéœ€è¦è®¾è®¡äººå‘˜å‘ç°ç±»çš„ä¸åŒèŒè´£å¹¶å°†å…¶åˆ†ç¦»ï¼Œå†å°è£…åˆ°ä¸åŒçš„ç±»æˆ–æ¨¡å—ä¸­ã€‚</p>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>å•ä¸€èŒè´£åŸåˆ™çš„æ ¸å¿ƒå°±æ˜¯æ§åˆ¶ç±»çš„ç²’åº¦å¤§å°ã€å°†å¯¹è±¡è§£è€¦ã€æé«˜å…¶å†…èšæ€§ã€‚</p>
<ul>
<li>é™ä½ç±»çš„å¤æ‚åº¦ã€‚ä¸€ä¸ªç±»åªè´Ÿè´£ä¸€é¡¹èŒè´£ï¼Œå…¶é€»è¾‘è‚¯å®šè¦æ¯”è´Ÿè´£å¤šé¡¹èŒè´£ç®€å•å¾—å¤šã€‚</li>
<li>æé«˜ç±»çš„å¯è¯»æ€§ã€‚å¤æ‚æ€§é™ä½ï¼Œè‡ªç„¶å…¶å¯è¯»æ€§ä¼šæé«˜ã€‚</li>
<li>æé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€‚å¯è¯»æ€§æé«˜ï¼Œé‚£è‡ªç„¶æ›´å®¹æ˜“ç»´æŠ¤äº†ã€‚</li>
<li>å˜æ›´å¼•èµ·çš„é£é™©é™ä½ã€‚å˜æ›´æ˜¯å¿…ç„¶çš„ï¼Œå¦‚æœå•ä¸€èŒè´£åŸåˆ™éµå®ˆå¾—å¥½ï¼Œå½“ä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½æ—¶ï¼Œå¯ä»¥æ˜¾è‘—é™ä½å¯¹å…¶ä»–åŠŸèƒ½çš„å½±å“ã€‚</li>
</ul>
<br>

<h3 id="1-5-æ¥å£éš”ç¦»åŸåˆ™"><a href="#1-5-æ¥å£éš”ç¦»åŸåˆ™" class="headerlink" title="1.5 æ¥å£éš”ç¦»åŸåˆ™"></a>1.5 æ¥å£éš”ç¦»åŸåˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>è¦ä¸ºå„ä¸ªç±»å»ºç«‹å®ƒä»¬éœ€è¦çš„ä¸“ç”¨æ¥å£ï¼Œè€Œä¸è¦è¯•å›¾å»å»ºç«‹ä¸€ä¸ªå¾ˆåºå¤§çš„æ¥å£ä¾›æ‰€æœ‰ä¾èµ–å®ƒçš„ç±»å»è°ƒç”¨ã€‚</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<p>åœ¨å…·ä½“åº”ç”¨æ¥å£éš”ç¦»åŸåˆ™æ—¶ï¼Œåº”è¯¥æ ¹æ®ä»¥ä¸‹å‡ ä¸ªè§„åˆ™æ¥è¡¡é‡ã€‚</p>
<ul>
<li>æ¥å£å°½é‡å°ï¼Œä½†æ˜¯è¦æœ‰é™åº¦ã€‚ä¸€ä¸ªæ¥å£åªæœåŠ¡äºä¸€ä¸ªå­æ¨¡å—æˆ–ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>ä¸ºä¾èµ–æ¥å£çš„ç±»å®šåˆ¶æœåŠ¡ã€‚åªæä¾›è°ƒç”¨è€…éœ€è¦çš„æ–¹æ³•ï¼Œå±è”½ä¸éœ€è¦çš„æ–¹æ³•ã€‚</li>
<li>äº†è§£ç¯å¢ƒï¼Œæ‹’ç»ç›²ä»ã€‚æ¯ä¸ªé¡¹ç›®æˆ–äº§å“éƒ½æœ‰é€‰å®šçš„ç¯å¢ƒå› ç´ ï¼Œç¯å¢ƒä¸åŒï¼Œæ¥å£æ‹†åˆ†çš„æ ‡å‡†å°±ä¸åŒæ·±å…¥äº†è§£ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>æé«˜å†…èšï¼Œå‡å°‘å¯¹å¤–äº¤äº’ã€‚ä½¿æ¥å£ç”¨æœ€å°‘çš„æ–¹æ³•å»å®Œæˆæœ€å¤šçš„äº‹æƒ…ã€‚</li>
</ul>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>æ¥å£éš”ç¦»åŸåˆ™æ˜¯ä¸ºäº†çº¦æŸæ¥å£ã€é™ä½ç±»å¯¹æ¥å£çš„ä¾èµ–æ€§ï¼Œéµå¾ªæ¥å£éš”ç¦»åŸåˆ™æœ‰ä»¥ä¸‹ 5 ä¸ªä¼˜ç‚¹ã€‚</p>
<ul>
<li><p>å°†è‡ƒè‚¿åºå¤§çš„æ¥å£åˆ†è§£ä¸ºå¤šä¸ªç²’åº¦å°çš„æ¥å£ï¼Œå¯ä»¥é¢„é˜²å¤–æ¥å˜æ›´çš„æ‰©æ•£ï¼Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
</li>
<li><p>æ¥å£éš”ç¦»æé«˜äº†ç³»ç»Ÿçš„å†…èšæ€§ï¼Œå‡å°‘äº†å¯¹å¤–äº¤äº’ï¼Œé™ä½äº†ç³»ç»Ÿçš„è€¦åˆæ€§ã€‚</p>
</li>
<li><p>å¦‚æœæ¥å£çš„ç²’åº¦å¤§å°å®šä¹‰åˆç†ï¼Œèƒ½å¤Ÿä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼›ä½†æ˜¯ï¼Œå¦‚æœå®šä¹‰è¿‡å°ï¼Œåˆ™ä¼šé€ æˆæ¥å£æ•°é‡è¿‡å¤šï¼Œä½¿è®¾è®¡å¤æ‚åŒ–ï¼›å¦‚æœå®šä¹‰å¤ªå¤§ï¼Œçµæ´»æ€§é™ä½ï¼Œæ— æ³•æä¾›å®šåˆ¶æœåŠ¡ï¼Œç»™æ•´ä½“é¡¹ç›®å¸¦æ¥æ— æ³•é¢„æ–™çš„é£é™©ã€‚</p>
</li>
<li><p>ä½¿ç”¨å¤šä¸ªä¸“é—¨çš„æ¥å£è¿˜èƒ½å¤Ÿä½“ç°å¯¹è±¡çš„å±‚æ¬¡ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡æ¥å£çš„ç»§æ‰¿ï¼Œå®ç°å¯¹æ€»æ¥å£çš„å®šä¹‰ã€‚</p>
</li>
<li><p>èƒ½å‡å°‘é¡¹ç›®å·¥ç¨‹ä¸­çš„ä»£ç å†—ä½™ã€‚è¿‡å¤§çš„å¤§æ¥å£é‡Œé¢é€šå¸¸æ”¾ç½®è®¸å¤šä¸ç”¨çš„æ–¹æ³•ï¼Œå½“å®ç°è¿™ä¸ªæ¥å£çš„æ—¶å€™ï¼Œè¢«è¿«è®¾è®¡å†—ä½™çš„ä»£ç ã€‚</p>
</li>
</ul>
<br>

<h3 id="1-6-è¿ªç±³ç‰¹æ³•åˆ™"><a href="#1-6-è¿ªç±³ç‰¹æ³•åˆ™" class="headerlink" title="1.6 è¿ªç±³ç‰¹æ³•åˆ™"></a>1.6 è¿ªç±³ç‰¹æ³•åˆ™</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å¦‚æœä¸¤ä¸ªè½¯ä»¶å®ä½“æ— é¡»ç›´æ¥é€šä¿¡ï¼Œé‚£ä¹ˆå°±ä¸åº”å½“å‘ç”Ÿç›´æ¥çš„ç›¸äº’è°ƒç”¨ï¼Œå¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹è½¬å‘è¯¥è°ƒç”¨ã€‚</p>
<blockquote>
<p>å®ç°</p>
</blockquote>
<ul>
<li><p>ä»ä¾èµ–è€…çš„è§’åº¦æ¥è¯´ï¼Œåªä¾èµ–åº”è¯¥ä¾èµ–çš„å¯¹è±¡ã€‚</p>
</li>
<li><p>ä»è¢«ä¾èµ–è€…çš„è§’åº¦è¯´ï¼Œåªæš´éœ²åº”è¯¥æš´éœ²çš„æ–¹æ³•ã€‚</p>
</li>
</ul>
<blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>è¿ªç±³ç‰¹æ³•åˆ™è¦æ±‚é™åˆ¶è½¯ä»¶å®ä½“ä¹‹é—´é€šä¿¡çš„å®½åº¦å’Œæ·±åº¦ï¼Œæ­£ç¡®ä½¿ç”¨è¿ªç±³ç‰¹æ³•åˆ™å°†æœ‰ä»¥ä¸‹ä¸¤ä¸ªä¼˜ç‚¹ã€‚</p>
<ul>
<li><p>é™ä½äº†ç±»ä¹‹é—´çš„è€¦åˆåº¦ï¼Œæé«˜äº†æ¨¡å—çš„ç›¸å¯¹ç‹¬ç«‹æ€§ã€‚</p>
</li>
<li><p>ç”±äºäº²åˆåº¦é™ä½ï¼Œä»è€Œæé«˜äº†ç±»çš„å¯å¤ç”¨ç‡å’Œç³»ç»Ÿçš„æ‰©å±•æ€§ã€‚</p>
</li>
</ul>
<br>

<h2 id="2-è®¾è®¡æ¨¡å¼"><a href="#2-è®¾è®¡æ¨¡å¼" class="headerlink" title="2. è®¾è®¡æ¨¡å¼"></a>2. è®¾è®¡æ¨¡å¼</h2><br>

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/41682/image-20210413121858931.png" class="" title="DesignPrinciple">



<h3 id="2-1-å•ä¾‹æ¨¡å¼-Singleton"><a href="#2-1-å•ä¾‹æ¨¡å¼-Singleton" class="headerlink" title="2.1 å•ä¾‹æ¨¡å¼-Singleton"></a>2.1 å•ä¾‹æ¨¡å¼-Singleton</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œä¸”è¯¥ç±»èƒ½è‡ªè¡Œåˆ›å»ºè¿™ä¸ªå®ä¾‹</p>
<blockquote>
<p>ç‰¹ç‚¹</p>
</blockquote>
<ol>
<li>å•ä¾‹ç±»åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚</li>
<li>è¯¥å•ä¾‹å¯¹è±¡å¿…é¡»ç”±å•ä¾‹ç±»è‡ªè¡Œåˆ›å»ºã€‚</li>
<li>å•ä¾‹ç±»å¯¹å¤–æä¾›ä¸€ä¸ªè®¿é—®è¯¥å•ä¾‹çš„å…¨å±€è®¿é—®ç‚¹ã€‚</li>
</ol>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å•ä¾‹æ¨¡å¼å¯ä»¥ä¿è¯å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜çš„å¼€é”€ã€‚</li>
<li>å¯ä»¥é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ã€‚</li>
<li>å•ä¾‹æ¨¡å¼è®¾ç½®å…¨å±€è®¿é—®ç‚¹ï¼Œå¯ä»¥ä¼˜åŒ–å’Œå…±äº«èµ„æºçš„è®¿é—®ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å•ä¾‹æ¨¡å¼ä¸€èˆ¬æ²¡æœ‰æ¥å£ï¼Œæ‰©å±•å›°éš¾ï¼Œå¦‚æœè¦æ‰©å±•ï¼Œåˆ™é™¤äº†ä¿®æ”¹åŸæ¥çš„ä»£ç ï¼Œæ²¡æœ‰ç¬¬äºŒç§é€”å¾„ï¼Œè¿èƒŒå¼€é—­åŸåˆ™ã€‚</li>
<li>åœ¨å¹¶å‘æµ‹è¯•ä¸­ï¼Œå•ä¾‹æ¨¡å¼ä¸åˆ©äºä»£ç è°ƒè¯•ã€‚åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå•ä¾‹ä¸­çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¸èƒ½æ¨¡æ‹Ÿç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</li>
<li>å•ä¾‹æ¨¡å¼çš„åŠŸèƒ½ä»£ç é€šå¸¸å†™åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œå¦‚æœåŠŸèƒ½è®¾è®¡ä¸åˆç†ï¼Œåˆ™å¾ˆå®¹æ˜“è¿èƒŒå•ä¸€èŒè´£åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>å•ä¾‹ç±»</li>
<li>è®¿é—®ç±»</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<ul>
<li>æ‡’æ±‰å¼å•ä¾‹</li>
</ul>
<pre><code class="java">package top.parak.singleton.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.singeleton.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: LazySingleton &lt;p&gt;
 * &lt;p&gt; Description: æ‡’æ±‰å¼å•ä¾‹ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/16
 */

/**
 * &lt;p&gt; ç‰¹ç‚¹ï¼š
 * ç±»åŠ è½½æ—¶æ²¡æœ‰ç”Ÿæˆå•ä¾‹ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨getInstanceæ–¹æ³•æ—¶æ‰ä¼šåˆ›å»ºè¿™ä¸ªå•ä¾‹
 * &lt;/p&gt;
 */
public class LazySingleton &#123;

    /* volatile: å…·æœ‰å¯è§æ€§ã€æœ‰åºæ€§ï¼Œä¸å…·å¤‡åŸå­æ€§
    volatileå£°æ˜å˜é‡çš„å€¼å¯èƒ½éšæ—¶ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œ
    ä½¿ç”¨volatileä¿®é¥°çš„å˜é‡ä¼šå¼ºåˆ¶å°†ä¿®æ”¹çš„å€¼ç«‹å³å†™å…¥ä¸»å­˜ï¼Œ
    ä¸»å­˜ä¸­å€¼çš„æ›´æ–°ä¼šä½¿ç¼“å­˜ä¸­çš„å€¼å¤±æ•ˆã€‚
    volatileä¸ä¼šè®©çº¿ç¨‹é˜»å¡ï¼Œå“åº”é€Ÿåº¦æ¯”synchronizedå¿« */

    // volatileä¿è¯instanceåœ¨æ‰€æœ‰çº¿ç¨‹ä¸­åŒæ­¥å¯è§
    private static volatile LazySingleton instance = null;

    // privateé¿å…ç±»åœ¨å¤–éƒ¨è¢«å®ä¾‹åŒ–
    private LazySingleton() &#123;&#125;

    // åŠ é”åŒæ­¥ï¼Œä¿è¯getInstance()åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨
    public static synchronized LazySingleton getInstance() &#123;
        if (instance == null) &#123;
            instance = new LazySingleton();
        &#125;
        return instance;
    &#125;

&#125;</code></pre>
<ul>
<li>é¥¿æ±‰å¼å•ä¾‹</li>
</ul>
<pre><code class="java">package top.parak.singleton.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.singeleton.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: HungrySingleton &lt;p&gt;
 * &lt;p&gt; Description: é¥¿æ±‰å¼å•ä¾‹ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/16
 */

/**
 * &lt;p&gt; ç‰¹ç‚¹ï¼š
 * ç±»ä¸€æ—¦åŠ è½½å°±åˆ›å»ºä¸€ä¸ªå•ä¾‹ï¼Œä¿è¯åœ¨è°ƒç”¨getInstance()ä¹‹å‰å•ä¾‹å°±å·²ç»å­˜åœ¨
 * &lt;/p&gt;
 */

public class HungrySingleton &#123;

    /* åœ¨ç±»åŠ è½½æ—¶å°±åˆ›å»ºä¸€ä¸ªé™æ€å¯¹è±¡ä¾›ç³»ç»Ÿä½¿ç”¨ï¼Œä»¥åä¸å†æ”¹å˜ï¼Œ
    æ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥ç›´æ¥ç”¨äºå¤šçº¿ç¨‹è€Œä¸ä¼šå‡ºç°é—®é¢˜ */

    private static final HungrySingleton instance = new HungrySingleton();

    private HungrySingleton() &#123;&#125;

    public static HungrySingleton getInstance() &#123;
        return instance;
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-2-åŸå‹æ¨¡å¼-Prototype"><a href="#2-2-åŸå‹æ¨¡å¼-Prototype" class="headerlink" title="2.2 åŸå‹æ¨¡å¼-Prototype"></a>2.2 åŸå‹æ¨¡å¼-Prototype</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ç”¨ä¸€ä¸ªå·²ç»åˆ›å»ºçš„å®ä¾‹ï¼Œé€šè¿‡å¤åˆ¶è¯¥åŸå‹å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªå’ŒåŸå‹ç›¸åŒæˆ–è€…ç›¸ä¼¼çš„æ–°å¯¹è±¡</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>Javaè‡ªå¸¦çš„åŸå‹æ¨¡å¼åŸºäºå†…å­˜äºŒè¿›åˆ¶æµçš„å¤åˆ¶ï¼Œåœ¨æ€§èƒ½ä¸Šæ¯”ç›´æ¥newä¸€ä¸ªå¯¹è±¡æ›´åŠ ä¼˜è‰¯ã€‚</li>
<li>å¯ä»¥ä½¿ç”¨æ·±å…‹éš†æ–¹å¼ä¿å­˜å¯¹è±¡çš„çŠ¶æ€ï¼Œä½¿ç”¨åŸå‹æ¨¡å¼å°†å¯¹è±¡å¤åˆ¶ä¸€ä»½ï¼Œå¹¶å°†å…¶çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œç®€åŒ–äº†åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ï¼Œä»¥ä¾¿åœ¨éœ€è¦çš„æ—¶å€™ä½¿ç”¨ï¼ˆä¾‹å¦‚æ¢å¤åˆ°å†å²æŸä¸€çŠ¶æ€ï¼‰ï¼Œå¯å¤åˆ¶å®ç°æ’¤é”€æ“ä½œã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>éœ€è¦ä¸ºæ¯ä¸€ä¸ªç±»éƒ½é…ç½®ä¸€ä¸ªcloneæ–¹æ³•ã€‚</li>
<li>cloneæ–¹æ³•ä½äºç±»çš„å†…éƒ¨ï¼Œå½“å¯¹äºå·²æœ‰ç±»è¿›è¡Œæ”¹é€ çš„æ—¶å€™ï¼Œéœ€è¦ä¿®æ”¹ä»£ç ï¼Œè¿èƒŒäº†å¼€é—­åŸåˆ™ã€‚</li>
<li>å½“å®ç°æ·±å…‹éš†æ—¶ï¼Œéœ€è¦ç¼–å†™è¾ƒä¸ºå¤æ‚çš„ä»£ç ï¼Œè€Œä¸”å½“å¯¹è±¡ä¹‹é—´å­˜åœ¨å¤šé‡åµŒå¥—å¼•ç”¨æ—¶ï¼Œä¸ºäº†å®ç°æ·±å…‹éš†ï¼Œæ¯ä¸€å±‚å¯¹è±¡å¯¹åº”çš„ç±»éƒ½å¿…é¡»æ”¯æŒæ·±å…‹éš†ï¼Œå®ç°èµ·æ¥ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤ï¼Œæµ…å…‹éš†å’Œæ·±å…‹éš†éœ€è¦éœ€è¦è¿ç”¨å¾—å½“ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡åŸå‹ç±»ï¼šè§„å®šäº†å…·ä½“åŸå‹å¯¹è±¡å¿…é¡»å®ç°çš„æ¥å£ã€‚</li>
<li>å…·ä½“åŸå‹ç±»ï¼šå®ç°æŠ½è±¡åŸå‹ç±»çš„clone()æ–¹æ³•ï¼Œå®ƒæ˜¯å¯è¢«å¤åˆ¶çš„å¯¹è±¡ã€‚</li>
<li>è®¿é—®ç±»ï¼šä½¿ç”¨å…·ä½“åŸå‹ç±»ä¸­çš„clone()æ–¹æ³•ç±»å¤åˆ¶æ–°çš„å¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.prototype.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.prototype.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: Prototype &lt;p&gt;
 * &lt;p&gt; Description: åŸå‹æ¨¡å¼æµ…å…‹éš† &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/16
 */

import org.apache.log4j.Logger;

/**
 * &lt;p&gt; ç‰¹ç‚¹ï¼š
 * æµ…å…‹éš†ï¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ–°å¯¹è±¡çš„å±æ€§å’ŒåŸæ¥å¯¹è±¡å®Œå…¨ç›¸åŒï¼Œå¯¹äºéåŸºæœ¬ç±»å‹å±æ€§ï¼Œæ‰”æŒ‡å‘åŸæœ‰å±æ€§æ‰€æŒ‡å‘çš„å¯¹è±¡çš„å†…å­˜åœ°å€
 * æ·±å…‹éš†ï¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå±æ€§ä¸­å¼•ç”¨çš„å¯¹è±¡ä¹Ÿä¼šè¢«å…‹éš†ï¼Œä¸å†æŒ‡å‘åŸæœ‰å¯¹è±¡åœ°å€
 * &lt;/p&gt;
 */
public class Prototype &#123;
    public static Logger log = Logger.getLogger(Prototype.class);
    public static void main(String[] args) throws CloneNotSupportedException &#123;
        RealizeType realizeType1 = new RealizeType();
        RealizeType realizeType2 = (RealizeType) realizeType1.clone();
        log.info(&quot;realizeType1 == realizeType2 ? &quot; + (realizeType1 == realizeType2));
    &#125;
&#125;

class RealizeType implements Cloneable &#123;

    private Logger log = Logger.getLogger(RealizeType.class);

    RealizeType() &#123;
        log.info(&quot;åŸå‹åˆ›å»º&quot;);
    &#125;

    @Override
    protected Object clone() throws CloneNotSupportedException &#123;
        log.info(&quot;åŸå‹å¤åˆ¶&quot;);
        return super.clone();
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-3-ç®€å•å·¥å‚æ¨¡å¼-Simple-Factory"><a href="#2-3-ç®€å•å·¥å‚æ¨¡å¼-Simple-Factory" class="headerlink" title="2.3 ç®€å•å·¥å‚æ¨¡å¼-Simple Factory"></a>2.3 <del>ç®€å•å·¥å‚æ¨¡å¼-Simple Factory</del></h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å®šä¹‰ä¸€ä¸ªåˆ›å»ºäº§å“å¯¹è±¡çš„å·¥å‚æ¥å£ï¼Œå°†äº§å“å¯¹è±¡çš„å®é™…åˆ›å»ºå·¥ä½œæ¨è¿Ÿåˆ°å…·ä½“å­å·¥å‚ç±»å½“ä¸­ã€‚</p>
<blockquote>
<p>æŒ‰ç…§ä¸šåŠ¡åœºæ™¯åˆ’åˆ†ï¼Œå·¥å‚æ¨¡å¼æœ‰3ç§å®ç°æ–¹å¼</p>
</blockquote>
<p><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="../../../../Java/DesignPatternNote/DesignPattern/image-20201111164349538.png" alt="image-20201111164349538"></p>
<center>
    <font face="Kristen ITC" color="#555555" font-size=100px>ä¸‰ç§å®ç°æ–¹å¼</font><br>
</center>



<blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>ç®€å•å·¥å‚æ¨¡å¼æœ‰ä¸€ä¸ªå…·ä½“çš„å·¥å‚ç±»ï¼Œå¯ä»¥ç”Ÿäº§å¤šä¸ªä¸åŒçš„äº§å“ï¼Œå±äºåˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œä½†æ˜¯ç®€å•å·¥å‚æ¨¡å¼ä¸åœ¨GOF23ä¸­è®¾è®¡æ¨¡å¼ä¹‹åˆ—ã€‚</p>
<p>åœ¨ç®€å•å·¥å‚æ¨¡å¼ä¸­åˆ›å»ºå®ä¾‹çš„æ–¹æ³•é€šå¸¸ä¸ºé™æ€(static)æ–¹æ³•ï¼Œå› æ­¤ç®€å•å·¥å‚æ¨¡å¼(Simple Factory Pattern)åˆå«åšé™æ€å·¥å‚æ–¹æ³•æ¨¡å¼(Static Factory Method Pattern)ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å·¥å‚ç±»åŒ…å«å¿…è¦çš„é€»è¾‘åˆ¤æ–­ï¼Œå¯ä»¥å†³å®šåœ¨ä»€ä¹ˆæ—¶å€™åˆ›å»ºå“ªä¸€ä¸ªäº§å“çš„å®ä¾‹ã€‚å®¢æˆ·ç«¯å¯ä»¥å…é™¤ç›´æ¥åˆ›å»ºäº§å“å¯¹è±¡çš„èŒè´£ï¼Œå¾ˆæ–¹ä¾¿çš„åˆ›å»ºå“åº”çš„äº§å“ã€‚å·¥å‚å’Œäº§å“çš„èŒè´£åŒºåˆ†æ˜ç¡®ã€‚</li>
<li>å®¢æˆ·ç«¯æ— éœ€çŸ¥é“æ‰€åˆ›å»ºå…·ä½“äº§å“çš„ç±»åï¼Œåªéœ€çŸ¥é“å‚æ•°å³å¯ã€‚</li>
<li>ä¹Ÿå¯ä»¥å¼•å…¥é…ç½®æ–‡ä»¶ï¼Œåœ¨ä¸ä¿®æ”¹å®¢æˆ·ç«¯çš„ä»£ç çš„æƒ…å†µä¸‹æ›´æ¢å’Œæ·»åŠ æ–°çš„å…·ä½“äº§å“ç±»ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ç®€å•å·¥å‚æ¨¡å¼çš„å·¥å‚ç±»å•ä¸€ï¼Œè´Ÿè´£æ‰€æœ‰äº§å“çš„åˆ›å»ºï¼ŒèŒè´£è¿‡é‡ï¼Œä¸€æ—¦å¼‚å¸¸ï¼Œæ•´ä¸ªç³»ç»Ÿå°†å—åˆ°å½±å“ã€‚ä¸”å·¥å‚ç±»ä»£ç ä¼šéå¸¸è‡ƒè‚¿ï¼Œè¿èƒŒé«˜èšåˆåŸåˆ™ã€‚</li>
<li>ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼ä¼šå¢åŠ ç³»ç»Ÿä¸­ç±»çš„ä¸ªæ•°(å¼•å…¥æ–°çš„å·¥å‚ç±»)ï¼Œå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦å’Œç†è§£éš¾åº¦ã€‚</li>
<li>ç³»ç»Ÿæ‹“å±•å›°éš¾ï¼Œä¸€æ—¦å¢åŠ æ–°äº§å“ä¸å¾—ä¸ä¿®æ”¹å·¥å‚é€»è¾‘ï¼Œåœ¨äº§å“ç±»å‹è¾ƒå¤šæ—¶ï¼Œå¯èƒ½é€ æˆé€»è¾‘è¿‡äºå¤æ‚ã€‚</li>
</ul>
<blockquote>
<p>åº”ç”¨åœºæ™¯</p>
</blockquote>
<p>å¯¹äºäº§å“ç§ç±»ç›¸å¯¹è¾ƒå°‘çš„æƒ…å†µï¼Œè€ƒè™‘ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼ã€‚ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼çš„å®¢æˆ·ç«¯åªéœ€è¦ä¼ å…¥å·¥å‚ç±»çš„å‚æ•°ï¼Œä¸éœ€è¦å…³å¿ƒå¦‚ä½•åˆ›å»ºå¯¹è±¡çš„é€»è¾‘ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°åˆ›å»ºæ‰€éœ€äº§å“ã€‚</p>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>ç®€å•å·¥å‚(Simple Factory)ï¼šæ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„æ ¸å¿ƒï¼Œè´Ÿè´£å®ç°åˆ›å»ºæ‰€æœ‰å®ä¾‹çš„å†…éƒ¨é€»è¾‘ã€‚å·¥å‚ç±»åˆ›å»ºäº§å“ç±»çš„æ–¹æ³•å¯ä»¥è¢«å¤–ç•Œç›´æ¥è°ƒç”¨ï¼Œåˆ›å»ºæ‰€éœ€çš„äº§å“å¯¹è±¡ã€‚</li>
<li>æŠ½è±¡äº§å“(Abstract Product)ï¼šæ˜¯ç®€å•å·¥å‚åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡çš„çˆ¶äº²ï¼Œè´Ÿè´£æè¿°æ‰€æœ‰å®ä¾‹å…±æœ‰çš„å…¬å…±æ¥å£ã€‚</li>
<li>å…·ä½“äº§å“(Concrete Product)ï¼šæ˜¯ç®€å•å·¥å‚æ¨¡å¼çš„åˆ›å»ºç›®æ ‡ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.simpleFactory.pattern;

import org.apache.log4j.Logger;
import java.util.Scanner;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.simpleactory.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: Client &lt;p&gt;
 * &lt;p&gt; Description: ç®€å•å·¥å‚æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/17
 */

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class SimpleFactoryDemo &#123;
    private static Logger log = Logger.getLogger(SimpleFactoryDemo.class);
    public static void main(String[] args) &#123;
        Scanner scanner = new Scanner(System.in);
        while (true) &#123;
            System.out.print(&quot;è¾“å…¥äº§å“å‹å·ï¼š&quot;);
            int choice = scanner.nextInt();
            switch (choice) &#123;
                case 0: log.info(&quot;æˆåŠŸé€€å‡º&quot;); return;
                case 1: SimpleFactory.makeProduct(Constant.PRODUCT_1).show(); break;
                case 2: SimpleFactory.makeProduct(Constant.PRODUCT_2).show(); break;
                case 3: SimpleFactory.makeProduct(Constant.PRODUCT_3).show(); break;
                default: log.info(&quot;è¯¥äº§å“ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥ï¼&quot;); break;
            &#125;
        &#125;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡äº§å“
 * &lt;/p&gt;
 */
interface product &#123;
    void show();
&#125;

/**
 * &lt;p&gt;
 *     æšä¸¾æ‰€æœ‰äº§å“
 * &lt;/p&gt;
 */
enum Constant &#123;
    PRODUCT_1,
    PRODUCT_2,
    PRODUCT_3;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“äº§å“1
 * &lt;/p&gt;
 */
class ConcreteProduct1 implements product &#123;
    private Logger log = Logger.getLogger(ConcreteProduct1.class);
    public void show() &#123;
        log.info(&quot;å…·ä½“äº§å“1æ˜¾ç¤º...&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“äº§å“2
 * &lt;/p&gt;
 */
class ConcreteProduct2 implements product &#123;
    private Logger log = Logger.getLogger(ConcreteProduct2.class);
    public void show() &#123;
        log.info(&quot;å…·ä½“äº§å“2æ˜¾ç¤º...&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“äº§å“3
 * &lt;/p&gt;
 */
class ConcreteProduct3 implements product &#123;
    private Logger log = Logger.getLogger(ConcreteProduct3.class);
    public void show() &#123;
        log.info(&quot;å…·ä½“äº§å“3æ˜¾ç¤º...&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     ç®€å•å·¥å‚
 * &lt;/p&gt;
 */
class SimpleFactory &#123;
    public static product makeProduct(Constant c) &#123;
        switch (c) &#123;
            case PRODUCT_1:
                return new ConcreteProduct1();
            case PRODUCT_2:
                return new ConcreteProduct2();
            case PRODUCT_3:
                return new ConcreteProduct3();
        &#125;
        return null;
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-4-å·¥å‚æ–¹æ³•æ¨¡å¼-Factory-Method"><a href="#2-4-å·¥å‚æ–¹æ³•æ¨¡å¼-Factory-Method" class="headerlink" title="2.4 å·¥å‚æ–¹æ³•æ¨¡å¼-Factory Method"></a>2.4 å·¥å‚æ–¹æ³•æ¨¡å¼-Factory Method</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼æ˜¯å¯¹ç®€å•å·¥å‚æ¨¡å¼çš„è¿›ä¸€æ­¥æŠ½è±¡åŒ–ï¼Œå…¶å¥½å¤„æ˜¯å¯ä»¥ä½¿ç³»ç»Ÿåœ¨ä¸ä¿®æ”¹åŸæ¥ä»£ç çš„æƒ…å†µä¸‹å¼•è¿›æ–°çš„äº§å“ï¼Œå³æ»¡è¶³å¼€é—­åŸåˆ™ã€‚</p>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼è€ƒè™‘çš„æ˜¯ä¸€ç§å·¥å‚è´Ÿè´£ä¸€ç±»äº§å“çš„ç”Ÿäº§ï¼Œç•œç‰§åœºåªå…»åŠ¨ç‰©ã€ç”µè§†æœºå‚åªç”Ÿäº§ç”µè§†æœºã€è®¡ç®—æœºè½¯ä»¶å­¦é™¢åªåŸ¹å…»è®¡ç®—æœºè½¯ä»¶ä¸“ä¸šçš„å­¦ç”Ÿç­‰ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>ç”¨æˆ·åªéœ€è¦å…·ä½“å·¥å‚çš„åç§°å°±å¯å¾—åˆ°æ‰€è¦çš„äº§å“ï¼Œæ— éœ€çŸ¥é“äº§å“çš„å…·ä½“åˆ›å»ºè¿‡ç¨‹ã€‚</li>
<li>çµæ´»æ€§å¢å¼ºï¼Œå¯¹äºæ–°äº§å“çš„åˆ›å»ºï¼Œåªéœ€å¤šå†™ä¸€ä¸ªç›¸åº”çš„å·¥å‚ç±»ã€‚</li>
<li>å…¸å‹çš„è§£è€¦æ¡†æ¶ã€‚é«˜å±‚æ¨¡å—åªéœ€è¦çŸ¥é“äº§å“çš„æŠ½è±¡ç±»ï¼Œæ— éœ€å…³ç³»å…¶ä»–å®ç°ç±»ï¼Œæ»¡è¶³è¿ªç±³ç‰¹æ³•åˆ™ã€ä¾èµ–å€’ç½®åŸåˆ™å’Œé‡Œå¼æ›¿æ¢åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ç±»çš„ä¸ªæ•°å®¹æ˜“è¿‡å¤šï¼Œå¢åŠ å¤æ‚åº¦ã€‚</li>
<li>å¢åŠ äº†ç³»ç»Ÿçš„æŠ½è±¡æ€§å’Œç†è§£éš¾åº¦ã€‚</li>
<li>ä¸€ä¸ªå·¥å‚åªèƒ½ç”Ÿäº§ä¸€ç§äº§å“ï¼Œæ­¤å¼Šç«¯å¯ä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼è§£å†³ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡å·¥å‚(Abstract Factory)ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ¥å£ï¼Œè°ƒç”¨è€…é€šè¿‡å®ƒè®¿é—®å…·ä½“å·¥å‚çš„å·¥å‚æ–¹æ³•ç±»åˆ›å»ºäº§å“ã€‚</li>
<li>å…·ä½“å·¥å‚(Concrete Factory)ï¼šä¸»è¦æ˜¯å®ç°æŠ½è±¡å·¥å‚ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆå…·ä½“äº§å“çš„åˆ›å»ºã€‚</li>
<li>æŠ½è±¡äº§å“(Abstract Product)ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚</li>
<li>å…·ä½“äº§å“(Concrete Product)ï¼šå®ç°äº†æŠ½è±¡äº§å“è§’è‰²å®šä¹‰çš„æ¥å£ï¼Œç”±å…·ä½“å·¥å‚æ¥åˆ›å»ºï¼Œå®ƒåŒå…·ä½“å·¥å‚ä¹‹é—´ä¸€ä¸€å¯¹åº”ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.factoryMethod.pattern;

import org.apache.log4j.Logger;
import org.w3c.dom.Document;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import java.io.File;
import java.io.IOException;
import java.util.LinkedList;
import java.util.List;
import java.util.concurrent.TimeUnit;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.factoryMethod.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: FactoryMethod &lt;p&gt;
 * &lt;p&gt; Description: å·¥å‚æ–¹æ³•æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/17
 */

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class FactoryMethodDemo &#123;
    private static Logger log = Logger.getLogger(FactoryMethodDemo.class);

    /**
     * &lt;p&gt;
     * è¯»å–XMLé…ç½®æ–‡ä»¶ï¼Œæå–å…·ä½“ç±»åï¼Œè¿”å›å®ä¾‹å¯¹è±¡é›†åˆ
     * &lt;/p&gt;
     * @return List&lt;Object&gt;
     * @throws IOException
     * @throws SAXException
     * @throws ParserConfigurationException
     * @throws ClassNotFoundException
     * @throws IllegalAccessException
     * @throws InstantiationException
     */
    public static List&lt;Object&gt; getObjects(String filePath) throws IOException, SAXException, ParserConfigurationException,  ClassNotFoundException, IllegalAccessException, InstantiationException &#123;
        DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();
        DocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();
        Document document = documentBuilder.parse(new File(filePath));
        NodeList nodeList = document.getElementsByTagName(&quot;className&quot;);
        List&lt;Object&gt; objects = new LinkedList&lt;&gt;();
        for (int i = 0; i &lt; nodeList.getLength(); i++) &#123;
            String packageName = FactoryMethodDemo.class.getPackage().getName();
            String className = nodeList.item(i).getTextContent();
            Class&lt;?&gt; c = Class.forName(packageName + &quot;.&quot; + className);
            objects.add(c.newInstance());
        &#125;
        return objects;
    &#125;

    public static void main(String[] args) &#123;
        try &#123;
            List&lt;Object&gt; objects = getObjects(&quot;src/main/java/top/parak/factoryMethod/pattern/config.xml&quot;);
            objects.stream().forEach( o -&gt; &#123;
                AbstractFactory factory = (AbstractFactory) o;
                try &#123;
                    factory.produce().show();
                &#125; catch (InterruptedException e) &#123;
                    log.error(e.getMessage());
                &#125;;
            &#125;);
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
        &#125;
    &#125;
&#125;

/**
 * &lt;P&gt;
 *     æŠ½è±¡äº§å“
 * &lt;/p&gt;
 */
interface product &#123;
    void show();
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“äº§å“1
 * &lt;/p&gt;
 */
class ConcreteProduct1 implements product &#123;
    private Logger log = Logger.getLogger(ConcreteProduct1.class);
    public void show() &#123;
        log.info(&quot;å…·ä½“äº§å“1å±•ç¤º...&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“äº§å“2
 * &lt;/p&gt;
 */
class ConcreteProduct2 implements product &#123;
    private Logger log = Logger.getLogger(ConcreteProduct2.class);
    public void show() &#123;
        log.info(&quot;å…·ä½“äº§å“2å±•ç¤º...&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“äº§å“3
 * &lt;/p&gt;
 */
class ConcreteProduct3 implements product &#123;
    private Logger log = Logger.getLogger(ConcreteProduct3.class);
    public void show() &#123;
        log.info(&quot;å…·ä½“äº§å“3å±•ç¤º...&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡å·¥å‚
 * &lt;/p&gt;
 */
interface AbstractFactory &#123;
    public product produce() throws InterruptedException;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“å·¥å‚1
 * &lt;/p&gt;
 */
class ConcreteFactory1 implements AbstractFactory &#123;
    private Logger log = Logger.getLogger(ConcreteFactory1.class);
    public product produce() &#123;
        log.info(&quot;å…·ä½“å·¥å‚1ç”Ÿäº§ä¸­...&quot;);
        try &#123;
            TimeUnit.SECONDS.sleep(1);
        &#125; catch (InterruptedException e) &#123;
            log.error(e.getMessage());
        &#125;
        log.info(&quot;===&gt;äº§å“1ç”Ÿäº§å®Œæˆ&quot;);
        return new ConcreteProduct1();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“å·¥å‚2
 * &lt;/p&gt;
 */
class ConcreteFactory2 implements AbstractFactory &#123;
    private Logger log = Logger.getLogger(ConcreteFactory2.class);
    public product produce() &#123;
        log.info(&quot;å…·ä½“å·¥å‚2ç”Ÿäº§ä¸­...&quot;);
        try &#123;
            TimeUnit.SECONDS.sleep(1);
        &#125; catch (InterruptedException e) &#123;
            log.error(e.getMessage());
        &#125;
        log.info(&quot;===&gt;äº§å“2ç”Ÿäº§å®Œæˆ&quot;);
        return new ConcreteProduct2();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“å·¥å‚3
 * &lt;/p&gt;
 */
class ConcreteFactory3 implements AbstractFactory &#123;
    private Logger log = Logger.getLogger(ConcreteFactory3.class);
    public product produce() &#123;
        log.info(&quot;å…·ä½“å·¥å‚3ç”Ÿäº§ä¸­...&quot;);
        try &#123;
            TimeUnit.SECONDS.sleep(1);
        &#125; catch (InterruptedException e) &#123;
            log.error(e.getMessage());
        &#125;
        log.info(&quot;===&gt;äº§å“3ç”Ÿäº§å®Œæˆ&quot;);
        return new ConcreteProduct3();
    &#125;
&#125;</code></pre>
<blockquote>
<p>config.xml</p>
</blockquote>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;config&gt;
    &lt;className&gt;ConcreteFactory1&lt;/className&gt;
    &lt;className&gt;ConcreteFactory2&lt;/className&gt;
    &lt;className&gt;ConcreteFactory3&lt;/className&gt;
&lt;/config&gt;</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<pre><code class="shell">2020-10-17 11:25:34 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory1] [thread: main] [FactoryMethod.java: 143] - å…·ä½“å·¥å‚1ç”Ÿäº§ä¸­...
2020-10-17 11:25:35 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory1] [thread: main] [FactoryMethod.java: 149] - ===&gt;äº§å“1ç”Ÿäº§å®Œæˆ
2020-10-17 11:25:35 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteProduct1] [thread: main] [FactoryMethod.java: 98] - å…·ä½“äº§å“1å±•ç¤º...
2020-10-17 11:25:35 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory2] [thread: main] [FactoryMethod.java: 162] - å…·ä½“å·¥å‚2ç”Ÿäº§ä¸­...
2020-10-17 11:25:36 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory2] [thread: main] [FactoryMethod.java: 168] - ===&gt;äº§å“2ç”Ÿäº§å®Œæˆ
2020-10-17 11:25:36 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteProduct2] [thread: main] [FactoryMethod.java: 110] - å…·ä½“äº§å“2å±•ç¤º...
2020-10-17 11:25:36 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory3] [thread: main] [FactoryMethod.java: 181] - å…·ä½“å·¥å‚3ç”Ÿäº§ä¸­...
2020-10-17 11:25:37 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteFactory3] [thread: main] [FactoryMethod.java: 187] - ===&gt;äº§å“3ç”Ÿäº§å®Œæˆ
2020-10-17 11:25:37 PARAK INFO  [top.parak.factoryMethod.pattern.ConcreteProduct3] [thread: main] [FactoryMethod.java: 122] - å…·ä½“äº§å“3å±•ç¤º...</code></pre>
<br>

<h3 id="2-5-æŠ½è±¡å·¥å‚æ¨¡å¼-Abstract-Factory"><a href="#2-5-æŠ½è±¡å·¥å‚æ¨¡å¼-Abstract-Factory" class="headerlink" title="2.5 æŠ½è±¡å·¥å‚æ¨¡å¼-Abstract Factory"></a>2.5 æŠ½è±¡å·¥å‚æ¨¡å¼-Abstract Factory</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>å·¥å‚æ–¹æ³•æ¨¡å¼ï¼šä¸€ä¸ªå·¥å‚åªè´Ÿè´£ä¸€ç±»äº§å“çš„ç”Ÿäº§ï¼Œåƒå°ä½œåŠï¼Œç”µå™¨å‚åªç”Ÿäº§ç”µé£æ‰‡ã€‚<br>æŠ½è±¡å·¥å‚æ¨¡å¼ï¼šä¸€ä¸ªå·¥å‚è´Ÿè´£å¤šç§ç›¸å…³äº§å“çš„ç”Ÿäº§ï¼Œåƒç»¼åˆå‹å·¥å‚ï¼Œç”µå™¨å‚ç”Ÿäº§ç”µè§†æœºã€ç©ºè°ƒå’Œå†°ç®±ç­‰ã€‚</p>
<p>æŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯å·¥å‚æ–¹æ³•æ¨¡å¼çš„å‡çº§ç‰ˆæœ¬ï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼åªç”Ÿäº§ä¸€ä¸ªç­‰çº§çš„äº§å“ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼å¯ç”Ÿäº§å¤šä¸ªç­‰çº§çš„äº§å“ã€‚</p>
<blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ä¸€ç§ä¸ºè®¿é—®ç±»æä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç»„ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£ï¼Œä¸”è®¿é—®ç±»æ— é¡»æŒ‡å®šæ‰€è¦äº§å“çš„å…·ä½“ç±»å°±èƒ½å¾—åˆ°åŒæ—çš„ä¸åŒç­‰çº§çš„äº§å“çš„æ¨¡å¼ç»“æ„ã€‚</p>
<blockquote>
<p>ä½¿ç”¨æ¡ä»¶</p>
</blockquote>
<ul>
<li>ç³»ç»Ÿä¸­æœ‰å¤šä¸ªäº§å“æ—ï¼Œæ¯ä¸ªå…·ä½“å·¥å‚åˆ›å»ºåŒä¸€æ—ä½†å±äºä¸åŒç­‰çº§ç»“æ„çš„äº§å“ã€‚</li>
<li>ç³»ç»Ÿä¸€æ¬¡åªå¯èƒ½æ¶ˆè´¹å…¶ä¸­æŸä¸€æ—äº§å“ï¼Œå³åŒæ—çš„äº§å“ä¸€èµ·ä½¿ç”¨ã€‚</li>
</ul>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<p>é™¤äº†åŒ…å«å·¥å‚æ–¹æ³•æ¨¡å¼çš„ä¼˜ç‚¹ï¼Œè¿˜æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š</p>
<ul>
<li>å¯ä»¥åœ¨ç±»çš„å†…éƒ¨å¯¹äº§å“æ—ä¸­ç›¸å…³è”çš„å¤šç­‰çº§äº§å“å…±åŒç®¡ç†ï¼Œè€Œä¸å¿…ä¸“é—¨å¼•å…¥å¤šä¸ªæ–°çš„ç±»æ¥è¿›è¡Œç®¡ç†ã€‚</li>
<li>å½“éœ€è¦äº§å“æ—æ—¶ï¼ŒæŠ½è±¡å·¥å‚å¯ä»¥ä¿è¯å®¢æˆ·ç«¯å§‹ç»ˆåªä½¿ç”¨åŒä¸€ä¸ªäº§å“çš„äº§å“æ—ã€‚</li>
<li>æŠ½è±¡å·¥å‚å¢å¼ºäº†ç¨‹åºçš„å¯æ‰©å±•æ€§ï¼Œå½“å¢åŠ ä¸€ä¸ªæ–°çš„äº§å“æ—æ—¶ï¼Œä¸éœ€è¦ä¿®æ”¹åŸä»£ç ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<p>å½“äº§å“æ—ä¸­éœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„äº§å“æ—¶ï¼Œæ‰€æœ‰çš„å·¥å‚ç±»éƒ½éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚å¢åŠ äº†ç³»ç»Ÿçš„æŠ½è±¡æ€§å’Œç†è§£éš¾åº¦ã€‚</p>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡å·¥å‚(Abstract Factory)ï¼šæä¾›äº†åˆ›å»ºäº§å“çš„æ¥å£ï¼Œå®ƒåŒ…å«å¤šä¸ªåˆ›å»ºäº§å“çš„æ–¹æ³•ï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªä¸åŒç­‰çº§çš„äº§å“ã€‚</li>
<li>å…·ä½“å·¥å‚(Concrete Factory)ï¼šä¸»è¦æ˜¯å®ç°æŠ½è±¡å·¥å‚ä¸­çš„å¤šä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå®Œæˆå…·ä½“äº§å“çš„åˆ›å»ºã€‚</li>
<li>æŠ½è±¡äº§å“(Abstract Product)ï¼šå®šä¹‰äº†äº§å“çš„è§„èŒƒï¼Œæè¿°äº†äº§å“çš„ä¸»è¦ç‰¹æ€§å’ŒåŠŸèƒ½ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼æœ‰å¤šä¸ªæŠ½è±¡äº§å“ã€‚</li>
<li>å…·ä½“äº§å“(Concrete Product)ï¼šå®ç°äº†æŠ½è±¡äº§å“è§’è‰²æ‰€å®šä¹‰çš„æ¥å£ï¼Œç”±å…·ä½“å·¥å‚æ¥åˆ›å»ºï¼Œå®ƒåŒå…·ä½“å·¥å‚ä¹‹é—´æ˜¯å¤šå¯¹ä¸€çš„å…³ç³»ã€‚</li>
</ul>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<pre><code class="java">package top.parak.abstractFactory.example;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.abstractFactory.example &lt;/p&gt;
 * &lt;p&gt; FileName: Farm &lt;p&gt;
 * &lt;p&gt; Description: æŠ½è±¡å·¥å‚æ¨¡å¼æ¨¡æ‹Ÿå†œåœº &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/17
 */

import org.apache.log4j.Logger;
import javax.swing.*;
import javax.swing.border.TitledBorder;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.text.SimpleDateFormat;
import java.util.Date;

/**
 * &lt;p&gt;
 *     å†œåœºæµ‹è¯•ç±»
 * &lt;/p&gt;
 */
public class FarmDemo &#123;
    private JFrame frame = new JFrame(&quot;FarmDemo&quot;);
    private JDesktopPane desktopPane = new JDesktopPane();
    private JPanel contentPane = (JPanel) frame.getContentPane();
    private JPanel leftPanel = new JPanel();
    private final ImageIcon backIcon = new ImageIcon(&quot;img/Farm.jpg&quot;);
    private final JLabel rightLabel = new JLabel(backIcon);
    private final JLabel tipLabel = new JLabel(&quot;é€‰æ‹©äº§å“&quot;);
    private final JButton produceButton = new JButton(&quot;å¼€å§‹ç”Ÿäº§&quot;);
    private final Font font = new Font(&quot;å¾®è½¯é›…é»‘&quot;, Font.PLAIN, 20);
    private JComboBox&lt;String&gt; productComboBox = new JComboBox&lt;&gt;();
    private JTextArea textArea = new JTextArea();

    private AbstractFarm baoXingFarm = new BaoXingFarm();
    private AbstractFarm zhouQiaoFarm = new ZhouQiaoFarm();

    public FarmDemo() &#123;
        contentPane.setOpaque(false);
        contentPane.setLayout(null);
        rightLabel.setBounds(300, 0, backIcon.getIconWidth(), backIcon.getIconHeight());
        desktopPane.setLayout(null);
        desktopPane.add(rightLabel, new Integer(Integer.MIN_VALUE));
        leftPanel.setBackground(Color.CYAN);
        leftPanel.setBounds(0, 0, 300, 420);
        desktopPane.add(leftPanel);

        leftPanel.setLayout(null);
        tipLabel.setFont(font);
        tipLabel.setBounds(5, 10, 90, 30);
        leftPanel.add(tipLabel);
        String[] products = new String[]&#123;&quot;é©¬&quot;, &quot;ç‰›&quot;, &quot;é’èœ&quot;, &quot;ç™½èœ&quot;&#125;;
        for (String product : products) &#123;
            productComboBox.addItem(product);
        &#125;
        productComboBox.setFont(font);
        produceButton.setFont(font);
        productComboBox.setBounds(90, 10, 80, 30);
        leftPanel.add(productComboBox);
        produceButton.setBounds(180, 10, 115, 30);
        leftPanel.add(produceButton);
        produceButton.addActionListener(new ProductAction());

        textArea.setFont(new Font(&quot;å¾®è½¯é›…é»‘&quot;, Font.PLAIN, 14));
        JScrollPane scrollPane = new JScrollPane(textArea);
        scrollPane.setBounds(10, 50, 280, 360);
        scrollPane.setBorder(new TitledBorder(&quot;ç”Ÿäº§æ—¥å¿—&quot;));
        scrollPane.getViewport().setOpaque(false);
        leftPanel.add(scrollPane);

        frame.setContentPane(desktopPane);
        frame.setBounds(300,300,1500,500);
        frame.setVisible(true);
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
    &#125;

    private int index = 0;
    class ProductAction implements ActionListener &#123;
        @Override
        public void actionPerformed(ActionEvent e) &#123;
            JInternalFrame internalFrame = null;
            switch (productComboBox.getSelectedItem().toString()) &#123;
                case &quot;é©¬&quot;:
                    internalFrame = zhouQiaoFarm.produceAnimalProduct().showImage();
                    textArea.append(getTime() + &quot; å‘¨æ¡¥å†œåœºï¼šæ–°é©¬å‡ºç”Ÿ\n&quot;);
                    break;
                case &quot;ç‰›&quot;:
                    internalFrame = baoXingFarm.produceAnimalProduct().showImage();
                    textArea.append(getTime() + &quot; å®å…´å†œåœºï¼šæ–°ç‰›å‡ºç”Ÿ\n&quot;);
                    break;
                case &quot;é’èœ&quot;:
                    internalFrame = baoXingFarm.producePlantProduct().showImage();
                    textArea.append(getTime() + &quot; å®å…´å†œåœºï¼šé’èœå‡ºç”Ÿ\n&quot;);
                    break;
                case &quot;ç™½èœ&quot;:
                    internalFrame = zhouQiaoFarm.producePlantProduct().showImage();
                    textArea.append(getTime() + &quot; å‘¨æ¡¥å†œåœºï¼šç™½èœå‡ºç”Ÿ\n&quot;);
                    break;
                default:
                    throw new IllegalArgumentException(&quot;Error&quot;);
            &#125;
            internalFrame.setBounds(index + 300, 100, 300, 350);
            desktopPane.add(internalFrame);
            index = (index + 300) % 1200;
        &#125;

        private String getTime() &#123;
            return new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date());
        &#125;
    &#125;

    public static void main(String[] args) &#123;
        new FarmDemo();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡äº§å“ï¼šåŠ¨ç‰©ç±»
 * &lt;/p&gt;
 */
interface AnimalProduct &#123;
    public JInternalFrame showImage();
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡äº§å“ï¼šæ¤ç‰©ç±»
 * &lt;/p&gt;
 */
interface PlantProduct &#123;
    public JInternalFrame showImage();
&#125;

/**
 * &lt;p&gt;
 *     åŠ¨ç‰©äº§å“å±•ç¤ºçª—å£
 * &lt;/p&gt;
 */
class AnimalFrame extends JInternalFrame implements AnimalProduct &#123;
    public AnimalFrame(String animalName, String imagePath) &#123;
        Container contentPane = getContentPane();
        JPanel panel = new JPanel();
        panel.setLayout(new GridLayout(1, 1));
        panel.setBorder(BorderFactory.createTitledBorder(&quot;åŠ¨ç‰©ï¼š&quot; + animalName));
        JScrollPane scrollPane = new JScrollPane(panel);
        contentPane.add(scrollPane, BorderLayout.CENTER);
        JLabel label = new JLabel(new ImageIcon(imagePath));
        panel.add(label);
        pack();
        setTitle(animalName);
        setVisible(false);
        setClosable(true);
        setIconifiable(true);
        setResizable(false);
        setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);
    &#125;

    @Override
    public JInternalFrame showImage() &#123;
        this.setVisible(true);
        return this;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æ¤ç‰©äº§å“å±•ç¤ºçª—å£
 * &lt;/p&gt;
 */
class PlantFrame extends JInternalFrame implements PlantProduct&#123;
    public PlantFrame(String plantName, String imagePath) &#123;
        Container contentPane = getContentPane();
        JPanel panel = new JPanel();
        panel.setLayout(new GridLayout(1, 1));
        panel.setBorder(BorderFactory.createTitledBorder(&quot;æ¤ç‰©ï¼š&quot; + plantName));
        JScrollPane scrollPane = new JScrollPane(panel);
        contentPane.add(scrollPane, BorderLayout.CENTER);
        JLabel label = new JLabel(new ImageIcon(imagePath));
        panel.add(label);
        pack();
        setTitle(plantName);
        setVisible(false);
        setClosable(true);
        setIconifiable(true);
        setResizable(false);
        setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);
    &#125;

    @Override
    public JInternalFrame showImage() &#123;
        this.setVisible(true);
        return this;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“åŠ¨ç‰©äº§å“ï¼šé©¬ç±»
 * &lt;/p&gt;
 */
class Horse extends AnimalFrame  &#123;
    public Horse() &#123;
        super(&quot;é©¬-ğŸ´&quot;, &quot;img/Horse.jpg&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“åŠ¨ç‰©äº§å“ï¼šç‰›ç±»
 * &lt;/p&gt;
 */
class Cattle extends AnimalFrame &#123;
    public Cattle() &#123;
        super(&quot;ç‰›-ğŸ®&quot;, &quot;img/Cattle.jpg&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“æ¤ç‰©äº§å“ï¼šé’èœ
 * &lt;/p&gt;
 */
class Vegetable extends PlantFrame &#123;
    public Vegetable() &#123;
        super(&quot;é’èœ&quot;, &quot;img/Vegetable.jpg&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“æ¤ç‰©äº§å“ï¼šç™½èœ
 * &lt;/p&gt;
 */
class Cabbage extends PlantFrame &#123;
    public Cabbage() &#123;
        super(&quot;ç™½èœ&quot;, &quot;img/Cabbage.jpg&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡å·¥å‚ï¼šå†œåœºç±»
 * &lt;/p&gt;
 */
interface AbstractFarm &#123;
    public AnimalProduct produceAnimalProduct();
    public PlantProduct producePlantProduct();
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“å·¥å‚ï¼šå®å…´å†œåœº
 *     ç”Ÿäº§äº§å“ï¼šç‰›ã€é’èœ
 * &lt;/p&gt;
 */
class BaoXingFarm implements AbstractFarm &#123;
    private Logger log = Logger.getLogger(BaoXingFarm.class);
    @Override
    public AnimalProduct produceAnimalProduct() &#123;
        log.info(&quot;å®å…´å†œåœº===&gt;æ–°ç‰›å‡ºç”Ÿ&quot;);
        return new Cattle();
    &#125;

    @Override
    public PlantProduct producePlantProduct() &#123;
        log.info(&quot;å®å…´å†œåœº===&gt;é’èœé•¿æˆ&quot;);
        return new Vegetable();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“å†œåœºï¼šå‘¨æ¡¥å†œåœº
 *     ç”Ÿäº§äº§å“ï¼šé©¬ã€ç™½èœ
 * &lt;/p&gt;
 */
class ZhouQiaoFarm implements AbstractFarm &#123;
    private Logger log = Logger.getLogger(ZhouQiaoFarm.class);
    @Override
    public AnimalProduct produceAnimalProduct() &#123;
        log.info(&quot;å‘¨æ¡¥å†œåœº===&gt;æ–°é©¬å‡ºç”Ÿ&quot;);
        return new Horse();
    &#125;

    @Override
    public PlantProduct producePlantProduct() &#123;
        log.info(&quot;å‘¨æ¡¥å†œåœº===&gt;ç™½èœé•¿æˆ&quot;);
        return new Cabbage();
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<p><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="../../../../Java/DesignPatternNote/DesignPattern/image-20201017185342528.png" alt="image-20201017185342528"></p>
<br>

<h3 id="2-6-å»ºé€ è€…æ¨¡å¼-Builder"><a href="#2-6-å»ºé€ è€…æ¨¡å¼-Builder" class="headerlink" title="2.6 å»ºé€ è€…æ¨¡å¼-Builder"></a>2.6 å»ºé€ è€…æ¨¡å¼-Builder</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„é€ ä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿åŒæ ·çš„æ„é€ è¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å°è£…æ€§å¥½ï¼Œæ„å»ºå’Œè¡¨ç¤ºåˆ†ç¦»ã€‚</li>
<li>æ‰©å±•æ€§å¥½ï¼Œå„ä¸ªå…·ä½“çš„å»ºé€ è€…ç›¸äº’ç‹¬ç«‹ï¼Œæœ‰åˆ©äºç³»ç»Ÿçš„è§£è€¦ã€‚</li>
<li>å®¢æˆ·ç«¯ä¸å¿…çŸ¥é“äº§å“å†…éƒ¨ç»„æˆçš„ç»†èŠ‚ï¼Œå»ºé€ è€…å¯ä»¥å¯¹åˆ›å»ºè¿‡ç¨‹é€æ­¥ç»†åŒ–ï¼Œè€Œä¸å¯¹å…¶ä»–æ¨¡å—äº§ç”Ÿä»»ä½•å½±å“ï¼Œä¾¿äºæ§åˆ¶ç»†èŠ‚é£é™©ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>äº§å“çš„ç»„æˆéƒ¨åˆ†å¿…é¡»ç›¸åŒï¼Œè¿™é™åˆ¶äº†å…¶ä½¿ç”¨èŒƒå›´ã€‚</li>
<li>å¦‚æœäº§å“çš„å†…éƒ¨å˜åŒ–å¤æ‚ï¼Œå¦‚æœäº§å“å†…éƒ¨å‘ç”Ÿå˜åŒ–ï¼Œåˆ™å»ºé€ è€…ä¹Ÿè¦åŒæ­¥ä¿®æ”¹ï¼ŒåæœŸç»´æŠ¤æˆæœ¬è¾ƒå¤§ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li><p>äº§å“è§’è‰²(Product)ï¼šåŒ…å«å¤šä¸ªç»„ä»¶çš„å¤æ‚å¯¹è±¡ï¼Œç”±å…·ä½“å»ºé€ è€…æ¥åˆ›å»ºå…¶å„ä¸ªé›¶éƒ¨ä»¶ã€‚</p>
</li>
<li><p>æŠ½è±¡å»ºé€ è€…(Abstract Builder)ï¼šåŒ…å«åˆ›å»ºäº§å“å„ä¸ªå­éƒ¨ä»¶çš„æŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œé€šå¸¸è¿˜åŒ…å«ä¸€ä¸ªè¿”å›å¤æ‚äº§å“çš„æ–¹æ³•getResult()ã€‚</p>
</li>
<li><p>å…·ä½“å»ºé€ è€…(Concrete Builder)ï¼šå®ç°æŠ½è±¡å»ºé€ è€…çš„æ¥å£ï¼Œå®Œæˆå¤æ‚äº§å“çš„å„ä¸ªéƒ¨ä»¶çš„å…·ä½“åˆ›å»ºæ–¹æ³•ã€‚</p>
</li>
<li><p>æŒ‡æŒ¥è€…(Director)ï¼šå®ƒè°ƒç”¨å»ºé€ è€…å¯¹è±¡ä¸­çš„éƒ¨ä»¶æ„é€ ä¸è£…é…æ–¹æ³•å®Œæˆå¤æ‚å¯¹è±¡çš„åˆ›å»ºï¼Œåœ¨æŒ‡æŒ¥è€…ä¸­ä¸æ¶‰åŠå…·ä½“äº§å“çš„ä¿¡æ¯ã€‚</p>
</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.builder.pattern;

import lombok.Data;
import org.apache.log4j.Logger;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.builder.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: Builder &lt;p&gt;
 * &lt;p&gt; Description: å»ºé€ è€…æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/17
 */

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class BuilderDemo &#123;
    private static Logger log = Logger.getLogger(BuilderDemo.class);
    public static void main(String[] args) &#123;
        Builder builder = new ConcreteBuilder();
        Director director = new Director(builder);
        Product product = director.construct();
        log.info(product.toString());
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡äº§å“ç±»
 * &lt;/p&gt;
 */
@Data
class Product &#123;
    private String componentA;
    private String componentB;
    private String componentC;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡å»ºé€ è€…
 * &lt;/p&gt;
 */
abstract class Builder &#123;
    protected Product product = new Product();
    public abstract void buildComponentA();
    public abstract void buildComponentB();
    public abstract void buildComponentC();
    public Product getProduct() &#123;
        return product;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“å»ºé€ è€…
 * &lt;/p&gt;
 */
class ConcreteBuilder extends Builder &#123;

    @Override
    public void buildComponentA() &#123;
        product.setComponentA(&quot;å»ºé€ é›¶ä»¶A&quot;);
    &#125;

    @Override
    public void buildComponentB() &#123;
        product.setComponentB(&quot;å»ºé€ é›¶ä»¶B&quot;);
    &#125;

    @Override
    public void buildComponentC() &#123;
        product.setComponentC(&quot;å»ºé€ é›¶ä»¶C&quot;);
    &#125;
&#125;

/**
 * &lt;P&gt;
 *     æŒ‡æŒ¥è€…
 * &lt;/p&gt;
 */
class Director &#123;
    private Builder builder;
    public Director(Builder builder) &#123;
        this.builder = builder;
    &#125;
    public Product construct() &#123;
        builder.buildComponentA();
        builder.buildComponentB();
        builder.buildComponentC();
        return builder.getProduct();
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-7-ä»£ç†æ¨¡å¼-Proxy"><a href="#2-7-ä»£ç†æ¨¡å¼-Proxy" class="headerlink" title="2.7 ä»£ç†æ¨¡å¼-Proxy"></a>2.7 ä»£ç†æ¨¡å¼-Proxy</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ç”±äºæŸäº›åŸå› éœ€è¦ç»™æŸå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹è¯¥å¯¹è±¡çš„è®¿é—®ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>ä»£ç†æ¨¡å¼åœ¨å®¢æˆ·ç«¯å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸€ä¸ªä¸­ä»‹ä½œç”¨å’Œä¿æŠ¤ç›®æ ‡å¯¹è±¡çš„ä½œç”¨ã€‚</li>
<li>ä»£ç†å¯¹è±¡å¯ä»¥æ‰©å±•å¯¹è±¡çš„åŠŸèƒ½ã€‚</li>
<li>ä»£ç†æ¨¡å¼èƒ½å°†å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡åˆ†ç¦»ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½ç³»ç»Ÿçš„è€¦åˆåº¦ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ä»£ç†æ¨¡å¼ä¼šé€ æˆç³»ç»Ÿè®¾è®¡ä¸­ç±»çš„æ•°é‡å¢åŠ ã€‚</li>
<li>ä»£ç†æ¨¡å¼èƒ½å°†å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡ä¹‹é—´å¢åŠ ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä¼šé€ æˆè¯·æ±‚å¤„ç†é€Ÿåº¦å˜æ…¢ã€‚</li>
<li>å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡ä¸»é¢˜(Subject)ï¼šé€šè¿‡æ¥å£æˆ–æŠ½è±¡ç±»å£°æ˜çœŸå®ä¸»é¢˜å’Œä»£ç†å¯¹è±¡å®ç°çš„ä¸šåŠ¡æ–¹æ³•ã€‚</li>
<li>çœŸå®ä¸»é¢˜(Real Subject)ï¼šå®ç°äº†æŠ½è±¡ä¸»é¢˜ä¸­çš„å…·ä½“ä¸šåŠ¡ï¼Œæ˜¯ä»£ç†å¯¹è±¡é”ä»£è¡¨çš„çœŸå®å¯¹è±¡ï¼Œæ˜¯æœ€ç»ˆè¦å¼•ç”¨çš„å¯¹è±¡ã€‚</li>
<li>ä»£ç†(Proxy)ï¼šæä¾›äº†ä¸çœŸå®ä¸»é¢˜ç›¸åŒçš„æ¥å£ï¼Œå…¶å†…éƒ¨å«æœ‰å¯¹çœŸå®ä¸»é¢˜çš„å¼•ç”¨ï¼Œå®ƒå¯ä»¥è®¿é—®ã€æ§åˆ¶æˆ–æ‰©å±•çœŸå®ä¸»é¢˜çš„åŠŸèƒ½ã€‚</li>
</ul>
<pre><code class="java">package top.parak.proxy.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.proxy.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: Proxy &lt;p&gt;
 * &lt;p&gt; Description: ä»£ç†æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/18
 */

import org.apache.log4j.Logger;

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class ProxyDemo &#123;
    public static void main(String[] args) &#123;
        Proxy proxy = new Proxy();
        proxy.request();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡ä¸»é¢˜
 * &lt;/p&gt;
 */
interface Subject &#123;
    void request();
&#125;

/**
 * &lt;p&gt;
 *     çœŸå®ä¸»é¢˜
 * &lt;/p&gt;
 */
class RealSubject implements Subject &#123;
    private Logger log = Logger.getLogger(RealSubject.class);
    @Override
    public void request() &#123;
        log.info(&quot;è®¿é—®çœŸå®ä¸»é¢˜...&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     ä»£ç†
 * &lt;/p&gt;
 */
class Proxy implements Subject &#123;
    private Logger log = Logger.getLogger(Proxy.class);
    private RealSubject realSubject;

    @Override
    public void request() &#123;
        if (realSubject == null) &#123;
            realSubject = new RealSubject();
            preHandler();
            realSubject.request();
            postHandler();
        &#125;
    &#125;

    public void preHandler() &#123;
        log.info(&quot;è®¿é—®çœŸå®ä¸»é¢˜ä¹‹å‰çš„é¢„å¤„ç†&quot;);
    &#125;

    public void postHandler() &#123;
        log.info(&quot;è®¿é—®çœŸå®ä¸»é¢˜ä¹‹åçš„åç»­å¤„ç†&quot;);
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-8-é€‚é…å™¨æ¨¡å¼-Adapter"><a href="#2-8-é€‚é…å™¨æ¨¡å¼-Adapter" class="headerlink" title="2.8 é€‚é…å™¨æ¨¡å¼-Adapter"></a>2.8 é€‚é…å™¨æ¨¡å¼-Adapter</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ï¼Œä½¿å¾—åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»èƒ½ä¸€èµ·å·¥ä½œ</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å®¢æˆ·ç«¯é€šè¿‡é€‚é…å™¨å¯ä»¥é€æ˜åœ°è°ƒç”¨ç›®æ ‡æ¥å£ã€‚</li>
<li>å¤ç”¨äº†ç°å­˜çš„ç±»ï¼Œç¨‹åºå‘˜ä¸éœ€è¦ä¿®æ”¹åŸæœ‰ä»£ç è€Œå¤ç”¨ç°æœ‰çš„é€‚é…è€…ç±»ã€‚</li>
<li>å°†ç›®æ ‡ç±»ä¸é€‚é…è€…ç±»è§£è€¦ï¼Œè§£å†³äº†ç›®æ ‡ç±»å’Œé€‚é…è€…ç±»æ¥å£ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</li>
<li>åœ¨å¾ˆå¤šä¸šåŠ¡åœºæ™¯ä¸­ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>é€‚é…å™¨ç¼–å†™è¿‡ç¨‹éœ€è¦ç»“åˆä¸šåŠ¡åœºæ™¯å…¨é¢è€ƒè™‘ï¼Œå¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚</li>
<li>å¢åŠ ä»£ç é˜…è¯»éš¾åº¦ï¼Œè¿‡å¤šä½¿ç”¨é€‚é…å™¨ä¼šä½¿ç³»ç»Ÿä»£ç å˜å¾—å‡Œä¹±ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>ç›®æ ‡æ¥å£(Target)ï¼šå½“å‰ç³»ç»Ÿä¸šåŠ¡æ‰€æœŸå¾…çš„æ¥å£ï¼Œå¯ä»¥æ˜¯æŠ½è±¡ç±»æˆ–è€…æ¥å£ã€‚</li>
<li>é€‚é…è€…ç±»(Adaptee)ï¼šè¢«è®¿é—®å’Œé€‚é…çš„ç°å­˜ç»„ä»¶åº“ä¸­çš„ç»„ä»¶æ¥å£ã€‚</li>
<li>é€‚é…å™¨ç±»(Adapter)ï¼šè½¬æ¢å™¨ï¼Œé€šè¿‡ç»§æ‰¿æˆ–å¼•ç”¨é€‚é…è€…çš„å¯¹è±¡ï¼ŒæŠŠé€‚é…è€…æ¥å£è½¬æ¢ç›®æ ‡æ¥å£ï¼Œè®©å®¢æˆ·ç«¯ç›®æ ‡æ¥å£çš„æ ¼å¼è®¿é—®é€‚é…è€…ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.adapter.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.adapter.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: Adapter &lt;p&gt;
 * &lt;p&gt; Description: é€‚é…å™¨æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/18
 */

import org.apache.log4j.Logger;

/**
 * &lt;P&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class AdapterDemo &#123;
    public static void main(String[] args) &#123;
        Target target = new Adapter();
        target.request();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     ç›®æ ‡æ¥å£
 * &lt;/p&gt;
 */
interface Target &#123;
    public void request();
&#125;

/**
 * &lt;p&gt;
 *     é€‚é…è€…æ¥å£
 * &lt;/p&gt;
 */
class Adaptee &#123;
    private Logger log = Logger.getLogger(Adaptee.class);
    public void specificRequest() &#123;
        log.info(&quot;é€‚é…è€…ä¸­çš„ä¸šåŠ¡ä»£ç è¢«è°ƒç”¨&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     é€‚é…å™¨ç±»
 * &lt;/p&gt;
 */
class Adapter extends Adaptee implements Target&#123;
    @Override
    public void request() &#123;
        specificRequest();
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-9-æ¡¥æ¥æ¨¡å¼-Bridge"><a href="#2-9-æ¡¥æ¥æ¨¡å¼-Bridge" class="headerlink" title="2.9 æ¡¥æ¥æ¨¡å¼-Bridge"></a>2.9 æ¡¥æ¥æ¨¡å¼-Bridge</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å°†æŠ½è±¡ä¸å®ç°åˆ†ç¦»ï¼Œä½¿å®ƒä»¬å¯ä»¥ç‹¬ç«‹å˜åŒ–ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>æŠ½è±¡ä¸å®ç°åˆ†ç¦»ï¼Œæ‰©å±•èƒ½åŠ›å¼ºã€‚</li>
<li>ç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li>
<li>ç¬¦åˆåˆæˆå¤ç”¨åŸåˆ™ã€‚</li>
<li>å…¶å®ç°ç»†èŠ‚å¯¹å®¢æˆ·é€æ˜ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ç”±äºèšåˆå…³ç³»å»ºç«‹åœ¨æŠ½è±¡å±‚ï¼Œè¦æ±‚å¼€å‘è€…å¯¹æŠ½è±¡åŒ–è¿›è¡Œè®¾è®¡ä¸ç¼–ç¨‹ï¼Œèƒ½æ­£ç¡®çš„è¯†åˆ«å‡ºç³»ç»Ÿä¸­ä¸¤ä¸ªç‹¬ç«‹å˜åŒ–çš„ç»´åº¦ï¼Œè¿™å¢åŠ äº†ç³»ç»Ÿçš„ç†è§£ä¸è®¾è®¡éš¾åº¦ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡åŒ–è§’è‰²(Abstraction)ï¼šå®šä¹‰æŠ½è±¡ç±»ï¼Œå¹¶åŒ…å«ä¸€ä¸ªå¯¹å®ç°åŒ–å¯¹è±¡çš„å¼•ç”¨ã€‚</li>
<li>æ‰©å±•æŠ½è±¡åŒ–è§’è‰²(Refined Abstraction)ï¼šæ˜¯æŠ½è±¡åŒ–è§’è‰²çš„å­ç±»ï¼Œå®ç°çˆ¶ç±»ä¸­çš„ä¸šåŠ¡æ–¹æ³•ï¼Œå¹¶é€šè¿‡ç»„åˆå…³ç³»è°ƒç”¨å®ç°åŒ–è§’è‰²ä¸­çš„ä¸šåŠ¡æ–¹æ³•ã€‚</li>
<li>å®ç°åŒ–è§’è‰²(Implementor)ï¼šå®šä¹‰å®ç°åŒ–è§’è‰²çš„æ¥å£ï¼Œä¾›æ‰©å±•æŠ½è±¡åŒ–è§’è‰²è°ƒç”¨ã€‚</li>
<li>å…·ä½“å®ç°åŒ–è§’è‰²(Concrete Implementor)ï¼šç»™å‡ºå®ç°åŒ–è§’è‰²æ¥å£çš„å…·ä½“å®ç°ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.bridge.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.bridge.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: Bridge &lt;p&gt;
 * &lt;p&gt; Description: æ¡¥æ¥æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/18
 */

import org.apache.log4j.Logger;

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class BridgeDemo &#123;
    public static void main(String[] args) &#123;
        Implementor implementor = new ConcreteImplementorA();
        Abstraction abstraction = new RefinedAbstraction(implementor);
        abstraction.operation();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å®ç°åŒ–è§’è‰²
 * &lt;/p&gt;
 */
interface Implementor &#123;
    public void operationImpl();
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“å®ç°åŒ–è§’è‰²
 * &lt;/p&gt;
 */
class ConcreteImplementorA implements Implementor &#123;
    private Logger log = Logger.getLogger(ConcreteImplementorA.class);
    @Override
    public void operationImpl() &#123;
        log.info(&quot;å…·ä½“å®ç°åŒ–è§’è‰²(Concrete Implementor)è¢«è®¿é—®&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡åŒ–è§’è‰²
 * &lt;/p&gt;
 */
abstract class Abstraction &#123;
    protected Implementor implementor;

    protected Abstraction(Implementor implementor) &#123;
        this.implementor = implementor;
    &#125;

    public abstract void operation();
&#125;

/**
 * &lt;p&gt;
 *     æ‰©å±•æŠ½è±¡åŒ–è§’è‰²
 * &lt;/p&gt;
 */
class RefinedAbstraction extends Abstraction &#123;
    private Logger log = Logger.getLogger(RefinedAbstraction.class);

    protected RefinedAbstraction(Implementor implementor) &#123;
        super(implementor);
    &#125;

    @Override
    public void operation() &#123;
        log.info(&quot;æ‰©å±•æŠ½è±¡åŒ–è§’è‰²(Refined Abstraction)è¢«è®¿é—®&quot;);
        implementor.operationImpl();
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-10-è£…é¥°æ¨¡å¼-Decorator"><a href="#2-10-è£…é¥°æ¨¡å¼-Decorator" class="headerlink" title="2.10 è£…é¥°æ¨¡å¼-Decorator"></a>2.10 è£…é¥°æ¨¡å¼-Decorator</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>åœ¨ä¸æ”¹å˜ç°æœ‰å¯¹è±¡ç»“æ„çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€åœ°ç»™è¯¥å¯¹è±¡å¢åŠ ä¸€äº›èŒè´£çš„æ¨¡å¼ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>è£…é¥°å™¨æ˜¯ç»§æ‰¿çš„æœ‰åŠ›è¡¥å……ï¼Œæ¯”ç»§æ‰¿çµæ´»ï¼Œåœ¨ä¸æ”¹å˜åŸæœ‰å¯¹è±¡çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€çš„ç»™ä¸€ä¸ªå¯¹è±¡æ‰©å±•åŠŸèƒ½ï¼Œå³æ’å³ç”¨ã€‚</li>
<li>é€šè¿‡ä½¿ç”¨ä¸ç”¨è£…é¥°ç±»åŠè¿™äº›è£…é¥°ç±»çš„æ’åˆ—ç»„åˆï¼Œå¯ä»¥å®ç°ä¸åŒæ•ˆæœã€‚</li>
<li>è£…é¥°æ¨¡å¼å®Œå…¨éµå®ˆå¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>è£…é¥°æ¨¡å¼ä¼šå¢åŠ è®¸å¤šå­ç±»ï¼Œè¿‡åº¦ä½¿ç”¨ä¼šå¢åŠ ç¨‹åºçš„å¤æ‚æ€§ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡æ„å»ºè§’è‰²(Component)ï¼šå®šä¹‰ä¸€ä¸ªæŠ½è±¡æ¥å£ä»¥è§„èŒƒå‡†å¤‡æ¥é™„åŠ è´£ä»»çš„å¯¹è±¡ã€‚</li>
<li>å…·ä½“æ„å»ºè§’è‰²(Concrete Component)ï¼šå®ç°æŠ½è±¡æ„ä»¶ï¼Œé€šè¿‡è£…é¥°è§’è‰²ä¸ºå…¶æ·»åŠ ä¸€äº›èŒè´£ã€‚</li>
<li>æŠ½è±¡è£…é¥°è§’è‰²(Decorator)ï¼šç»§æ‰¿æŠ½è±¡æ„ä»¶ï¼Œå¹¶åŒ…å«å…·ä½“æ„ä»¶çš„å®ä¾‹ï¼Œå¯ä»¥é€šè¿‡å…¶å­ç±»æ‰©å±•å…·ä½“æ„ä»¶çš„åŠŸèƒ½ã€‚</li>
<li>å…·ä½“è£…é¥°è§’è‰²(Concrete Decorator)ï¼šå®ç°æŠ½è±¡è£…é¥°çš„ç›¸å…³æ–¹æ³•ï¼Œå¹¶ç»™å…·ä½“æ„ä»¶å¯¹è±¡æ·»åŠ é™„åŠ çš„è´£ä»»ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.decorator.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.decorator.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: Decorator &lt;p&gt;
 * &lt;p&gt; Description: è£…é¥°æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/18
 */

import org.apache.log4j.Logger;

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class DecoratorDemo &#123;
    public static void main(String[] args) &#123;
        Component component1 = new ConcreteComponent();
        component1.operation();
        Component component2 = new ConcreteDecorator(component1);
        component2.operation();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡æ„ä»¶è§’è‰²
 * &lt;/p&gt;
 */
interface Component &#123;
    public void operation();
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“æ„ä»¶è§’è‰²
 * &lt;/p&gt;
 */
class ConcreteComponent implements Component &#123;
    private Logger log = Logger.getLogger(ConcreteComponent.class);
    public ConcreteComponent() &#123;
        log.info(&quot;åˆ›å»ºå…·ä½“æ„ä»¶è§’è‰²&quot;);
    &#125;

    @Override
    public void operation() &#123;
        log.info(&quot;è°ƒç”¨å…·ä½“æ„ä»¶è§’è‰²çš„æ–¹æ³•operation()&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡è£…é¥°è§’è‰²
 * &lt;/p&gt;
 */
class Decorator implements Component &#123;
    private Component component;

    public Decorator(Component component) &#123;
        this.component = component;
    &#125;

    @Override
    public void operation() &#123;

    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“è£…é¥°è§’è‰²
 * &lt;/p&gt;
 */
class ConcreteDecorator extends Decorator &#123;
    private Logger log = Logger.getLogger(ConcreteComponent.class);

    public ConcreteDecorator(Component component) &#123;
        super(component);
    &#125;

    @Override
    public void operation() &#123;
        super.operation();
        addFunction();
    &#125;

    public void addFunction() &#123;
        log.info(&quot;ä¸ºå…·ä½“æ„ä»¶è§’è‰²å¢åŠ é¢å¤–çš„åŠŸèƒ½function()&quot;);
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-11-å¤–è§‚æ¨¡å¼-Facade"><a href="#2-11-å¤–è§‚æ¨¡å¼-Facade" class="headerlink" title="2.11 å¤–è§‚æ¨¡å¼-Facade"></a>2.11 å¤–è§‚æ¨¡å¼-Facade</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>é€šè¿‡ä¸ºå¤šä¸ªå¤æ‚çš„å­ç³»ç»Ÿæä¾›ä¸€ä¸ªä¸€è‡´çš„æ¥å£ï¼Œè€Œä½¿è¿™äº›å­ç³»ç»Ÿæ›´åŠ å®¹æ˜“è¢«è®¿é—®ã€‚å¤–è§‚æ¨¡å¼å¯¹å¤–æœ‰ä¸€ä¸ªç»Ÿä¸€æ¥å£ï¼Œå¤–éƒ¨åº”ç”¨ç¨‹åºä¸ç”¨å…³å¿ƒå†…éƒ¨å­ç³»ç»Ÿçš„å…·ä½“ç»†èŠ‚ï¼Œè¿™æ ·ä¼šå¤§å¤§é™ä½åº”ç”¨ç¨‹åºçš„å¤æ‚åº¦ï¼Œæé«˜äº†ç¨‹åºçš„å¯ç»´æŠ¤æ€§ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>é™ä½äº†å­ç³»ç»Ÿä¸å®¢æˆ·ç«¯ä¹‹é—´çš„è€¦åˆåº¦ï¼Œä½¿å¾—å­ç³»ç»Ÿé«˜çš„å˜åŒ–ä¸ä¼šå½±å“è°ƒç”¨å®ƒçš„å®¢æˆ·ç±»ã€‚</li>
<li>å¯¹å®¢æˆ·å±è”½äº†å­ç³»ç»Ÿç»„ä»¶ï¼Œå‡å°‘äº†å®¢æˆ·å¤„ç†çš„å¯¹è±¡æ•°ç›®ï¼Œå¹¶ä½¿å¾—å­ç³»ç»Ÿä½¿ç”¨èµ·æ¥æ›´åŠ å®¹æ˜“ã€‚</li>
<li>é™ä½äº†å¤§å‹è½¯ä»¶ç³»ç»Ÿä¸­çš„ç¼–è¯‘ä¾èµ–æ€§ï¼Œç®€åŒ–äº†ç³»ç»Ÿåœ¨ä¸åŒå¹³å°ä¹‹é—´çš„ç§»æ¤è¿‡ç¨‹ï¼Œå› ä¸ºç¼–è¯‘ä¸€ä¸ªå­ç³»ç»Ÿä¸ä¼šå½±å“å…¶ä»–çš„å­ç³»ç»Ÿï¼Œä¹Ÿä¸ä¼šå½±å“å¤–è§‚å¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ä¸èƒ½å¾ˆå¥½åœ°é™åˆ¶å®¢æˆ·ä½¿ç”¨å­ç³»ç»Ÿç±»ï¼Œå¾ˆå®¹æ˜“å¸¦æ¥æœªçŸ¥é£é™©ã€‚</li>
<li>å¢åŠ æ–°çš„å­ç³»ç»Ÿå¯èƒ½éœ€è¦ä¿®æ”¹å¤–è§‚ç±»æˆ–å®¢æˆ·ç«¯çš„æºä»£ç ï¼Œè¿èƒŒäº†å¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>å¤–è§‚è§’è‰²(Facade)ï¼šä¸ºå¤šä¸ªå­ç³»ç»Ÿå¯¹å¤–æä¾›ä¸€ä¸ªå…±åŒçš„æ¥å£ã€‚</li>
<li>å­ç³»ç»Ÿè§’è‰²(Sub System)ï¼šå®ç°ç³»ç»Ÿçš„éƒ¨åˆ†åŠŸèƒ½ï¼Œå®¢æˆ·å¯ä»¥é€šè¿‡å¤–è§‚è§’è‰²è®¿é—®å®ƒã€‚</li>
<li>å®¢æˆ·è§’è‰²(Client)ï¼šé€šè¿‡ä¸€ä¸ªå¤–è§‚è§’è‰²è®¿é—®å„ä¸ªå­ç³»ç»Ÿçš„åŠŸèƒ½ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.facade.pattern;

import org.apache.log4j.Logger;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/P&gt;
 * &lt;p&gt; Package: top.parak.facade.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: Facade &lt;p&gt;
 * &lt;p&gt; Description: å¤–è§‚æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/19
 */

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class FacadeDemo &#123;
    public static void main(String[] args) &#123;
        Facade facade = new Facade();
        facade.method();
    &#125;
&#125;

class Facade &#123;
    private SubSys1 subSys1 = new SubSys1();
    private SubSys2 subSys2 = new SubSys2();
    private SubSys3 subSys3 = new SubSys3();
    public void method() &#123;
        subSys1.method1();
        subSys2.method2();
        subSys3.method3();
    &#125;
&#125;

class SubSys1 &#123;
    private Logger log = Logger.getLogger(SubSys1.class);
    public void method1() &#123;
        log.info(&quot;å­ç³»ç»Ÿ1çš„method1è¢«è°ƒç”¨&quot;);
    &#125;
&#125;

class SubSys2 &#123;
    private Logger log = Logger.getLogger(SubSys2.class);
    public void method2() &#123;
        log.info(&quot;å­ç³»ç»Ÿ2çš„method2è¢«è°ƒç”¨&quot;);
    &#125;
&#125;


class SubSys3 &#123;
    private Logger log = Logger.getLogger(SubSys3.class);
    public void method3() &#123;
        log.info(&quot;å­ç³»ç»Ÿ3çš„method3è¢«è°ƒç”¨&quot;);
    &#125;
&#125;

</code></pre>
<br>

<h3 id="2-12-äº«å…ƒæ¨¡å¼-Flyweight"><a href="#2-12-äº«å…ƒæ¨¡å¼-Flyweight" class="headerlink" title="2.12 äº«å…ƒæ¨¡å¼-Flyweight"></a>2.12 äº«å…ƒæ¨¡å¼-Flyweight</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>è¿ç”¨å…±äº«æŠ€æœ¯æ¥æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦å¯¹è±¡çš„å¤ç”¨ã€‚</p>
<blockquote>
<p>ä¼˜åŠ¿</p>
</blockquote>
<p>ç›¸åŒå¯¹è±¡åªä¿å­˜ä¸€ä»½ï¼Œè¿™é™ä½äº†ç³»ç»Ÿä¸­å¯¹è±¡çš„æ•°é‡ï¼Œä»è€Œé™ä½äº†ç³»ç»Ÿä¸­ç»†ç²’åº¦å¯¹è±¡ç»™å†…å­˜å¸¦æ¥çš„å‹åŠ›ã€‚</p>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ä¸ºäº†ä½¿å¯¹è±¡å¯ä»¥å…±äº«ï¼Œéœ€è¦å°†ä¸€äº›ä¸èƒ½å…±äº«çš„çŠ¶æ€å¤–éƒ¨åŒ–ï¼Œè¿™å°†å¢åŠ ç¨‹åºçš„å¤æ‚æ€§ã€‚</li>
<li>è¯»å–äº«å…ƒæ¨¡å¼çš„å¤–éƒ¨çŠ¶æ€ä¼šä½¿å¾—è¿è¡Œæ—¶é—´ç¨å¾®å˜é•¿ã€‚</li>
</ul>
<blockquote>
<p>çŠ¶æ€</p>
</blockquote>
<ul>
<li>å†…éƒ¨çŠ¶æ€ï¼šä¸ä¼šéšç€ç¯å¢ƒçš„æ”¹å˜è€Œæ”¹å˜çš„å¯å…±äº«éƒ¨åˆ†ã€‚</li>
<li>å¤–éƒ¨çŠ¶æ€ï¼šéšç€ç¯å¢ƒæ”¹å˜è€Œæ”¹å˜çš„ä¸å¯ä»¥å…±äº«çš„éƒ¨åˆ†ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡äº«å…ƒè§’è‰²(Flyweight)ï¼šæ‰€æœ‰çš„å…·ä½“äº«å…ƒç±»çš„åŸºç±»ï¼Œä¸ºå…·ä½“äº«å…ƒè§„èŒƒéœ€è¦å®ç°çš„å…¬å…±æ¥å£ï¼Œéäº«å…ƒçš„å¤–éƒ¨çŠ¶æ€ä»¥å‚æ•°çš„å½¢å¼é€šè¿‡æ–¹æ³•ä¼ å…¥ã€‚</li>
<li>å…·ä½“äº«å…ƒè§’è‰²(Concrete Flyweight)ï¼šå®ç°æŠ½è±¡äº«å…ƒè§’è‰²ä¸­æ‰€è§„å®šçš„æ¥å£ã€‚</li>
<li>éäº«å…ƒè§’è‰²(Unsharable Flyweight)ï¼šæ˜¯ä¸å¯ä»¥å…±äº«çš„å¤–éƒ¨çŠ¶æ€ï¼Œå®ƒä»¥å‚æ•°çš„å½¢å¼æ³¨å…¥å…·ä½“äº«å…ƒçš„ç›¸å…³æ–¹æ³•ä¸­ã€‚</li>
<li>äº«å…ƒå·¥å‚è§’è‰²(Flyweight Factory)ï¼šè´Ÿè´£åˆ›å»ºå’Œç®¡ç†äº«å…ƒè§’è‰²ã€‚å½“å®¢æˆ·å¯¹è±¡è¯·æ±‚çš„æ—¶å€™ï¼Œäº«å…ƒå·¥å‚æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨ç¬¦åˆè¦æ±‚çš„äº«å…ƒå¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨åˆ™æä¾›ç»™å®¢æˆ·ï¼›å¦‚æœä¸å­˜åœ¨çš„è¯ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº«å…ƒå¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.flyweight.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.flyweight.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: Flyweight &lt;p&gt;
 * &lt;p&gt; Description: äº«å…ƒæ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/19
 */

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.Setter;
import org.apache.log4j.Logger;

import java.util.HashMap;

/**
 * &lt;P&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class FlyweightDemo &#123;
    public static void main(String[] args) &#123;
        FlyweightFactory factory = new FlyweightFactory();
        Flyweight f1 = factory.getFlyweight(&quot;K&quot;);
        Flyweight f2 = factory.getFlyweight(&quot;H&quot;);
        Flyweight f3 = factory.getFlyweight(&quot;I&quot;);
        Flyweight f4 = factory.getFlyweight(&quot;G&quot;);
        Flyweight f5 = factory.getFlyweight(&quot;H&quot;);
        f1.operation(new UnsharedConcreteFlyweight(&quot;ç¬¬ä¸€æ¬¡è°ƒç”¨K&quot;));
        f2.operation(new UnsharedConcreteFlyweight(&quot;ç¬¬ä¸€æ¬¡è°ƒç”¨H&quot;));
        f3.operation(new UnsharedConcreteFlyweight(&quot;ç¬¬ä¸€æ¬¡è°ƒç”¨I&quot;));
        f4.operation(new UnsharedConcreteFlyweight(&quot;ç¬¬ä¸€æ¬¡è°ƒç”¨G&quot;));
        f5.operation(new UnsharedConcreteFlyweight(&quot;ç¬¬äºŒæ¬¡è°ƒç”¨H&quot;));
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     éäº«å…ƒè§’è‰²
 * &lt;/p&gt;
 */
@AllArgsConstructor
@Setter
@Getter
class UnsharedConcreteFlyweight &#123;
    private String info;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡äº«å…ƒè§’è‰²
 * &lt;/p&gt;
 */
interface Flyweight &#123;
    public void operation(UnsharedConcreteFlyweight concreteFlyweight);
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“äº«å…ƒè§’è‰²
 * &lt;/p&gt;
 */
class ConcreteFlyweight implements Flyweight &#123;
    private Logger log = Logger.getLogger(ConcreteFlyweight.class);
    private String key;
    public ConcreteFlyweight(String key) &#123;
        this.key = key;
        log.info(&quot;å…·ä½“äº«å…ƒ&quot; + key + &quot;è¢«åˆ›å»º&quot;);
    &#125;

    @Override
    public void operation(UnsharedConcreteFlyweight concreteFlyweight) &#123;
        log.info(&quot;å…·ä½“äº«å…ƒ&quot; + key + &quot;è¢«è°ƒç”¨&quot;);
        log.info(&quot;éäº«å…ƒä¿¡æ¯æ˜¯ï¼š&quot; + concreteFlyweight.getInfo());
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     äº«å…ƒå·¥å‚è§’è‰²
 * &lt;/p&gt;
 */
class FlyweightFactory &#123;
    private Logger log = Logger.getLogger(FlyweightFactory.class);
    private HashMap&lt;String, Flyweight&gt; flyweightMap = new HashMap&lt;String, Flyweight&gt;();
    public Flyweight getFlyweight(String key) &#123;
        Flyweight flyweight = (Flyweight) flyweightMap.get(key);
        if (flyweight != null) &#123;
            log.info(&quot;å…·ä½“äº«å…ƒ&quot; + key + &quot;å·²ç»å­˜åœ¨ï¼Œè¢«æˆåŠŸè·å–ï¼&quot;);
        &#125; else &#123;
            flyweight = new ConcreteFlyweight(key);
            flyweightMap.put(key, flyweight);
        &#125;
        return flyweight;
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-13-ç»„åˆæ¨¡å¼-Composite"><a href="#2-13-ç»„åˆæ¨¡å¼-Composite" class="headerlink" title="2.13 ç»„åˆæ¨¡å¼-Composite"></a>2.13 ç»„åˆæ¨¡å¼-Composite</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>æœ‰æ—¶åˆå«åšéƒ¨åˆ†-æ•´ä½“æ¨¡å¼ï¼Œå®ƒæ˜¯ä¸€ç§å°†å¯¹è±¡ç»„åˆæˆæ ‘çŠ¶çš„å±‚æ¬¡ç»“æ„çš„æ¨¡å¼ï¼Œç”¨æ¥è¡¨ç¤ºâ€éƒ¨åˆ†-æ•´ä½“â€çš„å…³ç³»ï¼Œä½¿ç”¨æˆ·å¯¹å•ä¸ªç»„åˆå¯¹è±¡å…·æœ‰ä¸€è‡´çš„è®¿é—®æ€§ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>ç»„åˆæ¨¡å¼ä½¿å¾—å®¢æˆ·ç«¯ä»£ç å¯ä»¥ä¸€è‡´åœ°å¤„ç†å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡ï¼Œæ— é¡»å…³å¿ƒè‡ªå·±å¤„ç†çš„æ˜¯å•ä¸ªå¯¹è±¡ï¼Œè¿˜æ˜¯ç»„åˆå¯¹è±¡ï¼Œè¿™ç®€åŒ–äº†å®¢æˆ·ç«¯ä»£ç ã€‚</li>
<li>æ›´å®¹æ˜“åœ¨ç»„åˆä½“å†…åŠ å…¥äº†æ–°çš„å¯¹è±¡ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå› ä¸ºåŠ å…¥äº†æ–°çš„å¯¹è±¡è€Œæ›´æ”¹æºä»£ç ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>è®¾è®¡è¾ƒå¤æ‚ï¼Œå®¢æˆ·ç«¯éœ€è¦èŠ±æ›´å¤šæ—¶é—´ç†æ¸…ç±»ä¹‹é—´çš„å±‚æ¬¡å…³ç³»ã€‚</li>
<li>ä¸å®¹æ˜“é™åˆ¶å®¹å™¨ä¸­çš„æ„ä»¶ã€‚</li>
<li>ä¸å®¹æ˜“ç”¨ç»§æ‰¿çš„æ–¹æ³•æ¥å¢åŠ æ„ä»¶çš„æ–°åŠŸèƒ½ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡æ„ä»¶è§’è‰²(Component)ï¼šå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºæ ‘å¶æ„ä»¶å’Œæ ‘ææ„ä»¶å£°æ˜å…¬å…±æ¥å£ï¼Œå¹¶å®ç°å®ƒä»¬çš„é»˜è®¤è¡Œä¸ºï¼Œåœ¨é€æ˜å¼çš„ç»„åˆæ¨¡å¼ä¸­æŠ½è±¡æ’ä»¶è¿˜å£°æ˜è®¿é—®å’Œç®¡ç†å­ç±»çš„æ¥å£ï¼›åœ¨å®‰å…¨å¼çš„ç»„åˆæ¨¡å¼ä¸­ä¸å£°æ˜è®¿é—®å’Œç®¡ç†å­ç±»çš„æ¥å£ï¼Œç®¡ç†å·¥ä½œç”±æ ‘ææ„ä»¶å®Œæˆã€‚</li>
<li>æ ‘å¶æ„ä»¶è§’è‰²(Leaf)ï¼šæ˜¯ç»„åˆæ¨¡å¼ä¸­çš„å¶å­ç»“ç‚¹ï¼Œæ²¡æœ‰å­ç»“ç‚¹ï¼Œç”¨äºå®ç°æŠ½è±¡æ„ä»¶è§’è‰²ä¸­å£°æ˜çš„å…¬å…±æ¥å£ã€‚</li>
<li>æ ‘ææ„ä»¶è§’è‰²(Composite)ï¼šæ˜¯ç»„åˆæ¨¡å¼ä¸­çš„åˆ†æ”¯ç»“ç‚¹å¯¹è±¡ï¼Œæœ‰å­ç»“ç‚¹ï¼Œå®ƒå®ç°äº†æŠ½è±¡æ„ä»¶è§’è‰²ä¸­å£°æ˜çš„æ¥å£ï¼Œä¸»è¦ä½œç”¨æ˜¯å­˜å‚¨å’Œç®¡ç†å­éƒ¨ä»¶ï¼Œé€šå¸¸åŒ…å«add()ã€remove()ã€getChild()ç­‰æ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.composite.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.composite.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: Composite &lt;p&gt;
 * &lt;p&gt; Description: ç»„åˆæ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/19
 */

import org.apache.log4j.Logger;
import java.util.ArrayList;
import java.util.List;

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class CompositeDemo &#123;
    public static void main(String[] args) &#123;
        Component component0 = new Composite();
        Component component1 = new Composite();
        Component component2 = new Leaf(&quot;1&quot;);
        Component component3 = new Leaf(&quot;2&quot;);
        Component component4 = new Leaf(&quot;3&quot;);
        component0.add(component2);
        component0.add(component1);
        component1.add(component3);
        component1.add(component4);
        component0.operation();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡æ„ä»¶
 * &lt;/p&gt;
 */
interface Component &#123;
    public void add(Component c);
    public void remove(Component c);
    public Component getChild(int i);
    public void operation();
&#125;

/**
 * &lt;p&gt;
 *     æ ‘å¶æ„ä»¶
 * &lt;/p&gt;
 */
class Leaf implements Component &#123;
    private Logger log = Logger.getLogger(Leaf.class);
    private String name;

    public Leaf(String name) &#123;
        this.name = name;
    &#125;

    @Override
    public void add(Component c) &#123; &#125;

    @Override
    public void remove(Component c) &#123; &#125;

    @Override
    public Component getChild(int i) &#123;
        return null;
    &#125;

    @Override
    public void operation() &#123;
        log.info(&quot;æ ‘å¶&quot; + name + &quot;è¢«è®¿é—®&quot;);
    &#125;
&#125;
     **
 * &lt;p&gt;
 *     æ ‘ææ„ä»¶
 * &lt;/p&gt;
 */
class Composite implements Component&#123;
    private List&lt;Component&gt; children = new ArrayList&lt;&gt;();

    @Override
    public void add(Component c) &#123;
        children.add(c);
    &#125;

    @Override
    public void remove(Component c) &#123;
        children.remove(c);
    &#125;

    @Override
    public Component getChild(int i) &#123;
        return children.get(i);
    &#125;

    @Override
    public void operation() &#123;
        for (Object obj : children) &#123;
            ((Component) obj).operation();
        &#125;
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-14-æ¨¡æ¿æ–¹æ³•æ¨¡å¼-Template-Method"><a href="#2-14-æ¨¡æ¿æ–¹æ³•æ¨¡å¼-Template-Method" class="headerlink" title="2.14 æ¨¡æ¿æ–¹æ³•æ¨¡å¼-Template Method"></a>2.14 æ¨¡æ¿æ–¹æ³•æ¨¡å¼-Template Method</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•éª¨æ¶ï¼Œè€Œå°†ç®—æ³•ä¸­çš„ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ï¼Œä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å°è£…äº†ä¸å˜éƒ¨åˆ†ï¼Œæ‰©å±•å¯å˜éƒ¨åˆ†ã€‚å®ƒæŠŠè®¤ä¸ºæ˜¯ä¸å˜éƒ¨åˆ†çš„ç®—æ³•å°è£…åˆ°çˆ¶ç±»å®ç°ä¸­ï¼Œè€ŒæŠŠå¯å˜éƒ¨åˆ†ç®—æ³•ç”±å­ç±»ç»§æ‰¿å®ç°ï¼Œä¾¿äºå­ç±»ç»§ç»­æ‰©å±•ã€‚</li>
<li>å®ƒåœ¨çˆ¶ç±»ä¸­æå–äº†å…¬å…±çš„éƒ¨åˆ†ä»£ç ï¼Œä¾¿äºä»£ç å¤ç”¨ã€‚</li>
<li>éƒ¨åˆ†æ–¹æ³•æ˜¯å­ç±»å®ç°çš„ï¼Œå› æ­¤å­ç±»å¯ä»¥é€šè¿‡æ‰©å±•æ–¹å¼å¢åŠ ç›¸åº”çš„åŠŸèƒ½ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å¯¹æ¯ä¸ªä¸åŒçš„å®ç°éƒ½éœ€è¦å®šä¹‰ä¸€ä¸ªå­ç±»ï¼Œè¿™ä¼šå¯¼è‡´ç±»çš„ä¸ªæ•°å¢åŠ ï¼Œç³»ç»Ÿæ›´åŠ åºå¤§ï¼Œè®¾è®¡ä¹Ÿæ›´åŠ æŠ½è±¡ã€‚</li>
<li>çˆ¶ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•ç”±å­ç±»å®ç°ï¼Œå­ç±»æ‰§è¡Œçš„ç»“æœä¼šå½±å“çˆ¶ç±»çš„ç»“æœï¼Œè¿™å¯¼è‡´ä¸€ç§åå‘çš„æ§åˆ¶ç»“æ„ï¼Œå®ƒæé«˜äº†ä»£ç é˜…è¯»çš„éš¾åº¦ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡ç±»(Abstract class)ï¼šè´Ÿè´£ç»™å‡ºä¸€ä¸ªç®—æ³•çš„è½®å»“å’Œéª¨æ¶ã€‚å®ƒç”±ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•å’Œè‹¥å¹²ä¸ªåŸºæœ¬æ–¹æ³•æ„æˆ<ul>
<li>æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰äº†ç®—æ³•çš„éª¨æ¶ï¼ŒæŒ‰æŸç§é¡ºåºè°ƒç”¨å…¶åŒ…å«çš„åŸºæœ¬æ–¹æ³•</li>
<li>åŸºæœ¬æ–¹æ³•ï¼š<ul>
<li>æŠ½è±¡æ–¹æ³•ï¼šåœ¨æŠ½è±¡ç±»ä¸­ç”³æ˜ï¼Œç”±å…·ä½“å­ç±»ä¸­å¯ä»¥ç»§æ‰¿æˆ–é‡å†™å®ƒã€‚</li>
<li>å…·ä½“æ–¹æ³•ï¼šåœ¨æŠ½è±¡ç±»ä¸­å·²ç»å®ç°ï¼Œåœ¨å…·ä½“å­ç±»ä¸­å¯ä»¥ç»§æ‰¿æˆ–é‡å†™å®ƒã€‚</li>
<li>é’©å­æ–¹æ³•ï¼šåœ¨æŠ½è±¡ç±»ä¸­å·²ç»å®ç°ï¼ŒåŒ…æ‹¬ç”¨äºåˆ¤æ–­çš„é€»è¾‘æ–¹æ³•å’Œéœ€è¦å­ç±»é‡å†™çš„å­”æ–¹æ³•ä¸¤ç§ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>å…·ä½“å­ç±»(Concrete Class)ï¼šå®ç°æŠ½è±¡ç±»ä¸­æ‰€å®šä¹‰çš„æŠ½è±¡æ–¹æ³•å’Œé’©å­æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯ä¸€ä¸ªé¡¶çº§é€»è¾‘çš„ä¸€ä¸ªç»„æˆæ­¥éª¤ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.templateMethod.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.templateMethod.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: TemplateMethodDemo &lt;p&gt;
 * &lt;p&gt; Description: &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/7
 */

import org.apache.log4j.Logger;

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class TemplateMethodDemo &#123;
    public static void main(String[] args) &#123;
        AbstractClass abstractClass = new ConcreteClass();
        abstractClass.templateMethod();
    &#125;
&#125;

/**
 * &lt;P&gt;
 *     æŠ½è±¡ç±»
 * &lt;/p&gt;
 */
abstract class AbstractClass &#123;
    private Logger log = Logger.getLogger(AbstractClass.class);

    /* æ¨¡æ¿æ–¹æ³• */
    public void templateMethod() &#123;
        specificMethod();
        abstractMethod1();
        abstractMethod2();
    &#125;

    /* å…·ä½“æ–¹æ³• */
    public void specificMethod() &#123;
        log.info(&quot;å…·ä½“æ–¹æ³•è¢«è°ƒç”¨&quot;);
    &#125;

    /* æŠ½è±¡æ–¹æ³•1 */
    public abstract void abstractMethod1();
    /* æŠ½è±¡æ–¹æ³•2 */
    public abstract void abstractMethod2();
&#125;

class ConcreteClass extends AbstractClass &#123;
    private Logger log = Logger.getLogger(ConcreteClass.class);

    @Override
    public void abstractMethod1() &#123;
        log.info(&quot;æŠ½è±¡æ–¹æ³•1çš„å®ç°è¢«è°ƒç”¨&quot;);
    &#125;

    @Override
    public void abstractMethod2() &#123;
        log.info(&quot;æŠ½è±¡æ–¹æ³•2çš„å®ç°è¢«è°ƒç”¨&quot;);
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-15-ç­–ç•¥æ¨¡å¼-Strategy"><a href="#2-15-ç­–ç•¥æ¨¡å¼-Strategy" class="headerlink" title="2.15 ç­–ç•¥æ¨¡å¼-Strategy"></a>2.15 ç­–ç•¥æ¨¡å¼-Strategy</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>è¯¥æ¨¡å¼å®šä¹‰äº†ä¸€ç³»åˆ—ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å®ƒä»¬å¯ä»¥ç›¸äº’ä¾èµ–ï¼Œä¸”ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“åˆ°ä½¿ç”¨ç®—æ³•çš„ç”¨æˆ·ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>å¤šé‡æ¡ä»¶è¯­å¥ä¸æ˜“ç»´æŠ¤ï¼Œè€Œä½¿ç”¨ç­–ç•¥æ¨¡å¼å¯ä»¥é¿å…ä½¿ç”¨å¤šé‡æ¡ä»¶è¯­å¥ã€‚</li>
<li>ç­–ç•¥æ¨¡å¼æä¾›äº†ä¸€ç³»åˆ—çš„å¯ä¾›é‡ç”¨çš„ç®—æ³•æ—ï¼Œæ°å½“ä½¿ç”¨ç»§æ‰¿å¯ä»¥æŠŠç®—æ³•æ—çš„å…¬å…±ä»£ç è½¬ç§»åˆ°çˆ¶ç±»é‡Œé¢ï¼Œä»è€Œé¿å…é‡å¤çš„ä»£ç ã€‚</li>
<li>ç­–ç•¥æ¨¡å¼å¯ä»¥æä¾›ç›¸åŒè¡Œä¸ºçš„ä¸åŒå®ç°ï¼Œå®¢æˆ·å¯ä»¥æ ¹æ®ä¸åŒæ—¶é—´æˆ–ç©ºé—´è¦æ±‚é€‰æ‹©ä¸åŒçš„ã€‚</li>
<li>ç­–ç•¥æ¨¡å¼æä¾›äº†å¯¹å¼€é—­åŸåˆ™çš„å®Œç¾æ”¯æŒï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹åŸä»£ç çš„æƒ…å†µä¸‹ï¼Œçµæ´»å¢åŠ æ–°ç®—æ³•ã€‚</li>
<li>ç­–ç•¥æ¨¡å¼æŠŠç®—æ³•çš„ä½¿ç”¨æ”¾åˆ°ç¯å¢ƒç±»ä¸­ï¼Œè€Œç®—æ³•çš„å®ç°ç§»åˆ°å…·ä½“ç­–ç•¥ç±»ä¸­ï¼Œå®ç°äº†äºŒè€…çš„åˆ†ç¦»ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å®¢æˆ·ç«¯å¿…é¡»ç†è§£æ‰€æœ‰ç­–ç•¥ç®—æ³•çš„åŒºåˆ«ï¼Œä»¥ä¾¿é€‚æ—¶é€‰æ‹©æ°å½“çš„ç®—æ³•ç±»ã€‚</li>
<li>ç­–ç•¥æ¨¡å¼é€ æˆå¾ˆå¤šçš„ç­–ç•¥ç±»ã€‚</li>
</ul>
<blockquote>
<p> ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡ç­–ç•¥ç±»(Strategy)ï¼šå®šä¹‰äº†ä¸€ä¸ªå…¬å…±æ¥å£ï¼Œå„ç§ä¸åŒçš„ç®—æ³•ä»¥ä¸åŒçš„æ–¹å¼å®ç°è¿™ä¸ªæ¥å£ï¼Œç¯å¢ƒè§’è‰²ä½¿ç”¨è¿™ä¸ªæ¥å£è°ƒç”¨ä¸åŒçš„ç®—æ³•ï¼Œä¸€èˆ¬ä½¿ç”¨æ¥å£æˆ–æŠ½è±¡ç±»å®ç°ã€‚</li>
<li>å…·ä½“ç­–ç•¥ç±»(Concrete Strategy)ï¼šå®ç°äº†æŠ½è±¡äº†ç­–ç•¥å®šä¹‰çš„æ¥å£ï¼Œç¯å¢ƒè§’è‰²ä½¿ç”¨è¿™ä¸ªæ¥å£è°ƒç”¨ä¸åŒçš„ç®—æ³•ï¼Œä¸€èˆ¬ä½¿ç”¨æ¥å£æˆ–æŠ½è±¡ç±»å®ç°ã€‚</li>
<li>ç¯å¢ƒç±»(Context)ï¼šæŒæœ‰ä¸€ä¸ªç­–ç•¥ç±»çš„å¼•ç”¨ï¼Œæœ€ç»ˆç»™å®¢æˆ·ç«¯è°ƒç”¨ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.strategy.pattern;

import org.apache.log4j.Logger;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.strategy.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: StrategyDemo &lt;p&gt;
 * &lt;p&gt; Description: ç­–ç•¥æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/7
 */

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class StrategyDemo &#123;
    public static void main(String[] args) &#123;
        Context context = new Context();
        Strategy strategy1 = new ConcreteStrategyA();
        Strategy strategy2 = new ConcreteStrategyB();
        context.setStrategy(strategy1);
        context.strategyMethod();
        context.setStrategy(strategy2);
        context.strategyMethod();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡ç­–ç•¥ç±»
 * &lt;/p&gt;
 */
interface Strategy &#123;
    void strategyMethod();
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“ç­–ç•¥ç±»A
 * &lt;/p&gt;
 */
class ConcreteStrategyA implements Strategy &#123;
    private Logger log = Logger.getLogger(ConcreteStrategyA.class);
    @Override
    public void strategyMethod() &#123;
        log.info(&quot;å…·ä½“ç­–ç•¥Açš„ç­–ç•¥æ–¹æ³•è¢«è®¿é—®&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“ç­–ç•¥ç±»B
 * &lt;/p&gt;
 */
class ConcreteStrategyB implements Strategy &#123;
    private Logger log = Logger.getLogger(ConcreteStrategyB.class);
    @Override
    public void strategyMethod() &#123;
        log.info(&quot;å…·ä½“ç­–ç•¥Bçš„ç­–ç•¥æ–¹æ³•è¢«è®¿é—®&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     ç¯å¢ƒç±»
 * &lt;/p&gt;
 */
class Context &#123;
    private Strategy strategy;
    public Strategy getStrategy() &#123;
        return strategy;
    &#125;
    public void setStrategy(Strategy strategy) &#123;
        this.strategy = strategy;
    &#125;
    public void strategyMethod() &#123;
        strategy.strategyMethod();
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-16-å‘½ä»¤æ¨¡å¼-Command"><a href="#2-16-å‘½ä»¤æ¨¡å¼-Command" class="headerlink" title="2.16 å‘½ä»¤æ¨¡å¼-Command"></a>2.16 å‘½ä»¤æ¨¡å¼-Command</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å°†è¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä½¿å‘å‡ºè¯·æ±‚çš„è´£ä»»å’Œæ‰§è¡Œè¯·æ±‚çš„è´£ä»»åˆ†å‰²å¼€ã€‚è¿™æ ·ä¸¤è€…ä¹‹é—´é€šè¿‡å‘½ä»¤å¯¹è±¡è¿›è¡Œæ²Ÿé€šï¼Œè¿™æ ·æ–¹ä¾¿å°†å‘½ä»¤å¯¹è±¡è¿›è¡Œå‚¨å­˜ã€ä¼ é€’ã€è°ƒç”¨ã€å¢åŠ ä¸ç®¡ç†ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>é™ä½ç³»ç»Ÿçš„è€¦åˆåº¦ã€‚å‘½ä»¤æ¨¡å¼èƒ½å°†è°ƒç”¨æ“ä½œçš„å¯¹è±¡ä¸å®ç°è¯¥æ“ä½œçš„å¯¹è±¡è§£è€¦ã€‚</li>
<li>å¢åŠ æˆ–åˆ é™¤å‘½ä»¤éå¸¸æ–¹ä¾¿ã€‚é‡‡ç”¨å‘½ä»¤æ¨¡å¼å¢åŠ ä¸åˆ é™¤å‘½ä»¤ä¸ä¼šå½±å“å…¶ä»–ç±»ï¼Œå®ƒæ»¡è¶³å¼€é—­åŸåˆ™ï¼Œå¯¹æ‹“å±•æ¯”è¾ƒçµæ´»ã€‚</li>
<li>å¯ä»¥å®ç°å®å‘½ä»¤ã€‚å‘½ä»¤æ¨¡å¼å¯ä»¥ä¸ç»„åˆæ¨¡å¼ç»“åˆï¼Œå°†å¤šä¸ªå‘½ä»¤è£…é…æˆä¸€ä¸ªç»„åˆå‘½ä»¤ï¼Œå³å®å‘½ä»¤ã€‚</li>
<li>æ–¹ä¾¿å®ç°Undoå’ŒRedoæ“ä½œã€‚å‘½ä»¤æ¨¡å¼å¯ä»¥ä¸å¤‡å¿˜å½•æ¨¡å¼ç»“åˆï¼Œå®ç°å‘½ä»¤çš„æ’¤é”€ä¸æ¢å¤ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<p>å¯èƒ½äº§ç”Ÿå¤§é‡å…·ä½“å‘½ä»¤ç±»ã€‚å› ä¸ºå¯¹æ¯ä¸€ä¸ªå…·ä½“æ“ä½œéƒ½éœ€è¦è®¾è®¡ä¸€ä¸ªå…·ä½“å‘½ä»¤ç±»ï¼Œè¿™å°†å¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚</p>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡å‘½ä»¤ç±»(Command)ï¼šå£°æ˜æ‰§è¡Œå‘½ä»¤çš„æ¥å£ï¼Œæ‹¥æœ‰æ‰§è¡Œå‘½ä»¤çš„æŠ½è±¡æ–¹æ³•execute()ã€‚</li>
<li>å…·ä½“å‘½ä»¤è§’è‰²(Concrete Command)ï¼šæ˜¯æŠ½è±¡å‘½ä»¤ç±»çš„å…·ä½“å®ç°ç±»ï¼Œå®ƒæ‹¥æœ‰æ¥æ”¶è€…å¯¹è±¡ï¼Œå¹¶é€šè¿‡è°ƒç”¨æ¥æ”¶è€…çš„åŠŸèƒ½æ¥å®Œæˆå‘½ä»¤è¦æ‰§è¡Œçš„æ“ä½œã€‚</li>
<li>æ¥æ”¶è€…(Receiver)ï¼šæ‰§è¡Œå‘½ä»¤åŠŸèƒ½çš„ç›¸å…³æ“ä½œï¼Œæ˜¯å…·ä½“å‘½ä»¤å¯¹è±¡ä¸šåŠ¡çš„çœŸæ­£å®ç°è€…ã€‚</li>
<li>è¯·æ±‚è€…(Invoker)ï¼šè¯·æ±‚çš„å‘é€è€…ï¼Œå®ƒé€šå¸¸æ‹¥æœ‰å¾ˆå¤šçš„å‘½ä»¤å¯¹è±¡ï¼Œå¹¶é€šè¿‡è®¿é—®å‘½ä»¤å¯¹è±¡ç±»æ‰§è¡Œç›¸å…³è¯·æ±‚ï¼Œå®ƒä¸å¼ å­æ°è®¿é—®æ¥æ”¶è€…ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.command.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.command.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: CommandDemo &lt;p&gt;
 * &lt;p&gt; Description: å‘½ä»¤æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/7
 */

import org.apache.log4j.Logger;

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class CommandDemo &#123;
    public static Logger log = Logger.getLogger(CommandDemo.class);
    public static void main(String[] args) &#123;
        Command command = new ConcreteCommand();
        Invoker invoker = new Invoker(command);
        log.info(&quot;å®¢æˆ·è®¿é—®è°ƒç”¨è€…çš„callæ–¹æ³•&quot;);
        invoker.call();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     è°ƒç”¨è€…
 * &lt;/p&gt;
 */
class Invoker &#123;
    private Logger log = Logger.getLogger(Invoker.class);
    private Command command;
    public Invoker(Command command)  &#123;
        this.command = command;
    &#125;
    public void setCommand(Command command) &#123;
        this.command = command;
    &#125;
    public void call() &#123;
        log.info(&quot;è°ƒç”¨è€…æ‰§è¡Œå‘½ä»¤command&quot;);
        command.execute();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡å‘½ä»¤
 * &lt;/p&gt;
 */
interface Command &#123;
    abstract void execute();
&#125;

/**
 * &lt;p&gt;å…·ä½“å‘½ä»¤&lt;/p&gt;
 */
class ConcreteCommand implements Command &#123;
    private Receiver receiver;
    public ConcreteCommand() &#123;
        this.receiver = new Receiver();
    &#125;
    @Override
    public void execute() &#123;
        receiver.action();
    &#125;
&#125;

/**
 * &lt;p&gt;æ¥æ”¶è€…&lt;/p&gt;
 */
class Receiver &#123;
    private Logger log = Logger.getLogger(Receiver.class);
    public void action() &#123;
        log.info(&quot;æ¥æ”¶è€…çš„actionæ–¹æ³•è¢«è°ƒç”¨&quot;);
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-17-è´£ä»»é“¾æ¨¡å¼-Chain-of-Responsibility"><a href="#2-17-è´£ä»»é“¾æ¨¡å¼-Chain-of-Responsibility" class="headerlink" title="2.17 è´£ä»»é“¾æ¨¡å¼-Chain of Responsibility"></a>2.17 è´£ä»»é“¾æ¨¡å¼-Chain of Responsibility</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ä¸ºäº†é¿å…è¯·æ±‚å‘é€è€…ä¸å¤šä¸ªè¯·æ±‚å¤„ç†è€…è€¦åˆåœ¨ä¸€èµ·ï¼Œå°†æ‰€æœ‰è¯·æ±‚çš„å¤„ç†è€…é€šè¿‡å‰ä¸€å¯¹è±¡è®°ä½å…¶ä¸‹ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è€Œè¿æˆä¸€æ¡é“¾ï¼›å½“æœ‰è¯·æ±‚å‘ç”Ÿæ—¶ï¼Œå¯ä»¥å°†è¯·æ±‚æ²¿ç€è¿™æ¡é“¾ä¼ é€’ï¼Œç›´åˆ°æœ‰å¯¹è±¡å¤„ç†å®ƒä¸ºæ­¢ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>é™ä½äº†å¯¹è±¡ä¹‹é—´çš„è€¦åˆåº¦ã€‚è¯¥æ¨¡å¼ä½¿å¾—ä¸€ä¸ªå¯¹è±¡æ— é¡»çŸ¥é“åˆ°åº•æ˜¯å“ªä¸€ä¸ªå¯¹è±¡å¤„ç†å…¶è¯·æ±‚ä»¥åŠé“¾çš„ç»“æ„ï¼Œå‘é€è€…å’Œæ¥æ”¶è€…ä¹Ÿæ— é¡»æ‹¥æœ‰å¯¹æ–¹çš„æ˜ç¡®ä¿¡æ¯ã€‚</li>
<li>å¢å¼ºäº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚å¯ä»¥æ ¹æ®éœ€è¦å¢åŠ æ–°çš„è¯·æ±‚å¤„ç†ç±»ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™ã€‚</li>
<li>å¢å¼ºäº†ç»™å¯¹è±¡æŒ‡æ´¾èŒè´£çš„çµæ´»æ€§ã€‚å½“å·¥ä½œæµç¨‹å‘ç”Ÿå˜åŒ–ï¼Œå¯ä»¥åŠ¨æ€åœ°æ”¹å˜é“¾å†…çš„æˆå‘˜æˆ–è€…è°ƒåŠ¨å®ƒä»¬çš„æ¬¡åºï¼Œä¹Ÿå¯åŠ¨æ€åœ°æ–°å¢æˆ–è€…åˆ é™¤è´£ä»»ã€‚</li>
<li>è´£ä»»é“¾ç®€åŒ–äº†å¯¹è±¡ä¹‹é—´çš„è¿æ¥ã€‚æ¯ä¸ªå¯¹è±¡åªéœ€ä¿æŒä¸€ä¸ªæŒ‡å‘å…¶åç»§è€…çš„å¼•ç”¨ï¼Œä¸éœ€ä¿æŒå…¶ä»–æ‰€æœ‰å¤„ç†è€…çš„å¼•ç”¨ï¼Œè¿™é¿å…äº†ä½¿ç”¨ä¼—å¤šçš„if-elseè¯­å¥ã€‚</li>
<li>è´£ä»»åˆ†æ‹…ã€‚æ¯ä¸ªç±»åªéœ€è¦å¤„ç†è‡ªå·±è¯¥å¤„ç†çš„å·¥ä½œï¼Œä¸è¯¥å¤„ç†çš„ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¯¹è±¡å®Œæˆï¼Œæ˜ç¡®å„ç±»çš„è´£ä»»èŒƒå›´ï¼Œç¬¦åˆç±»çš„å•ä¸€èŒè´£åŸåˆ™ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ä¸èƒ½ä¿è¯æ¯ä¸ªè¯·æ±‚ä¸€å®šè¢«å¤„ç†ã€‚ç”±äºä¸€ä¸ªè¯·æ±‚æ²¡æœ‰æ˜ç¡®çš„æ¥æ”¶è€…ï¼Œæ‰€ä»¥ä¸èƒ½ä¿è¯å®ƒä¸€å®šä¼šè¢«å¤„ç†ï¼Œè¯¥è¯·æ±‚å¯èƒ½ä¸€ç›´ä¼ åˆ°é“¾çš„æœ«ç«¯éƒ½å¾—ä¸åˆ°å¤„ç†ã€‚</li>
<li>å¯¹æ¯”è¾ƒé•¿çš„è´£ä»»é“¾ï¼Œè¯·æ±‚çš„å¤„ç†å¯èƒ½æ¶‰åŠå¤šä¸ªå¤„ç†å¯¹è±¡ï¼Œç³»ç»Ÿæ€§èƒ½å°†å—åˆ°ä¸€ä¸ªå½±å“ã€‚</li>
<li>èŒè´£é“¾çš„å»ºç«‹çš„åˆç†æ€§è¦é å®¢æˆ·ç«¯æ¥ä¿è¯ï¼Œå¢åŠ äº†å®¢æˆ·ç«¯çš„å¤æ‚æ€§ï¼Œå¯èƒ½ä¼šç”±äºè´£ä»»é“¾çš„é”™è¯¯è®¾ç½®è€Œå¯¼è‡´ç³»ç»Ÿå‡ºé”™ï¼Œå¦‚å¯èƒ½è¿˜ä¼šé€ æˆå¾ªç¯è°ƒç”¨ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li><p>æŠ½è±¡å¤„ç†è€…(Handler)ï¼šå®šä¹‰ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„æ¥å£ï¼ŒåŒ…å«æŠ½è±¡å¤„ç†æ–¹æ³•å’Œä¸€ä¸ªåç»§è¿æ¥ã€‚</p>
</li>
<li><p>å…·ä½“å¤„ç†è€…(Concrete Handler)ï¼šå®ç°æŠ½è±¡å¤„ç†è€…çš„å¤„ç†æ–¹æ³•ï¼Œåˆ¤æ–­èƒ½å¦æœ¬æ¬¡è¯·æ±‚ï¼Œå¦‚æœå¯ä»¥å¤„ç†è¯·æ±‚åˆ™å¤„ç†ï¼Œå¦åˆ™å°†ç»™è¯·æ±‚è½¬ç»™å®ƒçš„åç»§è€…ã€‚</p>
</li>
<li><p>å®¢æˆ·ç±»(Client)ï¼šåˆ›å»ºå¤„ç†é“¾ï¼Œå¹¶å‘é“¾å¤´çš„å…·ä½“å¤„ç†è€…å¯¹è±¡æäº¤è¯·æ±‚ï¼Œå®ƒä¸å…³å¿ƒå¤„ç†ç»†èŠ‚å’Œè¯·æ±‚çš„ä¼ é€’è¿‡ç¨‹ã€‚</p>
</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.chainofResposibility.example;

import org.apache.log4j.Logger;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.chainofResposibility.example &lt;/p&gt;
 * &lt;p&gt; FileName: Main &lt;p&gt;
 * &lt;p&gt; Description: è´£ä»»é“¾Demo &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/23
 */

/**
 * &lt;p&gt;
 *     æµ‹è¯•ç±»
 * &lt;/p&gt;
 */
public class Main &#123;
    public static void main(String[] args) &#123;
        Support RubbishK = new NoSupport(&quot;RubbishK&quot;);
        Support FlowerK = new LimitSupport(&quot;FlowerK&quot;, 100);
        Support EyedropK = new LimitSupport(&quot;EyedropK&quot;, 200);
        Support UnknownK = new SpecialSupport(&quot;UnknownK&quot;, 300);
        Support KHighness = new SpecialSupport(&quot;KHighness&quot;, 330);
        Support BrotherK = new OddSupport(&quot;BrotherK&quot;);
        // åˆ¶é€ è´£ä»»é“¾
        RubbishK.setNext(FlowerK).setNext(EyedropK).setNext(UnknownK).setNext(KHighness).setNext(BrotherK);
        // åˆ¶é€ é—®é¢˜
        for (int i = 0; i &lt; 500; i += 30) &#123;
            RubbishK.support(new Trouble(i));
        &#125;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å‘ç”Ÿçš„é—®é¢˜çš„ç±»
 * &lt;/p&gt;
 */
class Trouble &#123;
    private int number;

    public Trouble(int number) &#123;
        this.number = number;
    &#125;

    public int getNumber() &#123;
        return number;
    &#125;

    @Override
    public String toString() &#123;
        return &quot;[Trouble &quot; +
                &quot;number=&quot; + number +
                &#39;]&#39;;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     ç”¨æ¥è§£å†³é—®çš„æŠ½è±¡ç±»
 * &lt;/p&gt;
 */
abstract class Support &#123;
    private Logger log = Logger.getLogger(Support.class);

    private String name;
    private Support next;

    public Support(String name) &#123;
        this.name = name;
    &#125;

    public Support setNext(Support next) &#123;
        this.next = next;
        return next;
    &#125;

    @Override
    public String toString() &#123;
        return &quot;[&quot; + name + &quot;]&quot;;
    &#125;

    public final void support(Trouble trouble) &#123;
        if (resolve(trouble)) &#123;
            done(trouble);
        &#125; else if (next != null) &#123;
            next.support(trouble);
        &#125; else &#123;
            fail(trouble);
        &#125;
    &#125;

    public abstract boolean resolve(Trouble trouble);

    protected void done(Trouble trouble) &#123;
        log.info(trouble + &quot; is resolved by &quot; + this + &quot;.&quot;);
    &#125;

    protected void fail(Trouble trouble) &#123;
        log.info(trouble + &quot; cannot be resolved.&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     è§£å†³é—®é¢˜å…·ä½“ç±»ï¼šä¸èƒ½è§£å†³é—®é¢˜
 * &lt;/p&gt;
 */
class NoSupport extends Support &#123;
    public NoSupport(String name) &#123;
        super(name);
    &#125;

    @Override
    public boolean resolve(Trouble trouble) &#123;
        return false;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     è§£å†³é—®é¢˜å…·ä½“ç±»ï¼šè§£å†³é—®é¢˜ç¼–å·å°äºlimitå€¼å¾—ç±»
 * &lt;/p&gt;
 */
class LimitSupport extends Support &#123;
    private int limit;

    public LimitSupport(String name, int limit) &#123;
        super(name);
        this.limit = limit;
    &#125;

    @Override
    public boolean resolve(Trouble trouble) &#123;
        if (trouble.getNumber() &lt; limit) &#123;
            return true;
        &#125; else &#123;
            return false;
        &#125;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     è§£å†³é—®é¢˜å…·ä½“ç±»ï¼šè§£å†³å¥‡æ•°ç¼–å·å¾—é—®é¢˜
 * &lt;/p&gt;
 */
class OddSupport extends Support &#123;
    public OddSupport(String name) &#123;
        super(name);
    &#125;

    @Override
    public boolean resolve(Trouble trouble) &#123;
        if (trouble.getNumber() % 2 != 0) &#123;
            return true;
        &#125; else &#123;
            return false;
        &#125;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     è§£å†³é—®é¢˜å…·ä½“ç±»ï¼šåªè§£å†³æŒ‡å®šç¼–å·å¾—é—®é¢˜
 * &lt;/p&gt;
 */
class SpecialSupport extends Support &#123;
    private int number;

    public SpecialSupport(String name, int number) &#123;
        super(name);
        this.number = number;
    &#125;

    @Override
    public boolean resolve(Trouble trouble) &#123;
        if (trouble.getNumber() == this.number) &#123;
            return true;
        &#125; else &#123;
            return false;
        &#125;
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-18-çŠ¶æ€æ¨¡å¼-State"><a href="#2-18-çŠ¶æ€æ¨¡å¼-State" class="headerlink" title="2.18 çŠ¶æ€æ¨¡å¼-State"></a>2.18 çŠ¶æ€æ¨¡å¼-State</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å¯¹æœ‰çŠ¶æ€çš„å¯¹è±¡ï¼ŒæŠŠå¤æ‚çš„â€œåˆ¤æ–­é€»è¾‘â€æå–åˆ°ä¸åŒçš„çŠ¶æ€å¯¹è±¡ä¸­ï¼Œå…è®¸çŠ¶æ€å¯¹è±¡åœ¨å…¶å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶æ”¹å˜å…¶è¡Œä¸ºã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>çŠ¶æ€æ¨¡å¼ä¸ç‰¹å®šçŠ¶æ€ç›¸å…³çš„è¡Œä¸ºå±€éƒ¨åŒ–åˆ°ä¸€ä¸ªçŠ¶æ€ä¸­ï¼Œå¹¶ä¸”å°†ä¸åŒçŠ¶æ€çš„è¡Œä¸ºåˆ†å‰²å¼€æ¥ï¼Œæ»¡è¶³å•ä¸€èŒè´£åŸåˆ™ã€‚</li>
<li>å‡å°‘å¯¹è±¡é—´çš„ç›¸äº’ä¾èµ–ã€‚å°†ä¸åŒçš„çŠ¶æ€å¼•å…¥ç‹¬ç«‹çš„å¯¹è±¡ä¸­ä¼šä½¿å¾—çŠ¶æ€å˜å¾—æ›´åŠ æ˜ç¡®ï¼Œåˆ‡å‡å°‘å¯¹è±¡é—´çš„ç›¸äº’ä¾èµ–ã€‚</li>
<li>æœ‰åˆ©äºç¨‹åºçš„æ‹“å±•ã€‚é€šè¿‡å®šä¹‰æ–°çš„å­ç±»å¾ˆå®¹æ˜“å¾·å¢åŠ æ–°çš„çŠ¶æ€å’Œè½¬æ¢ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>çŠ¶æ€æ¨¡å¼çš„ä½¿ç”¨å¿…ç„¶ä¼šå¢åŠ ç³»ç»Ÿçš„ç±»ä¸å¯¹è±¡çš„ä¸ªæ•°ã€‚</li>
<li>çŠ¶æ€æ¨¡å¼çš„ç»“æ„å’Œå®ç°éƒ½è¾ƒä¸ºå¤æ‚ï¼Œå¦‚æœä½¿ç”¨ä¸å½“ä¼šå¯¼è‡´ç¨‹åºç»“æ„å’Œä»£ç çš„æ··ä¹±ã€‚ </li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>ç¯å¢ƒç±»(Context)ï¼šä¹Ÿç§°ä¸ºä¸Šä¸‹æ–‡ï¼Œå®ƒå®šä¹‰äº†å®¢æˆ·æ„Ÿå…´è¶£çš„æ¥å£ï¼Œç»´æŠ¤ä¸€ä¸ªå½“å‰çŠ¶æ€ï¼Œå¹¶å°†ä¸çŠ¶æ€ç›¸å…³çš„æ“ä½œéƒ½å§”æ‰˜ç»™å½“å‰çŠ¶æ€å¯¹è±¡ç±»å¤„ç†ã€‚</li>
<li>æŠ½è±¡çŠ¶æ€ç±»(State)ï¼šå®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç”¨ä»¥å°è£…ç¯å¢ƒå¯¹è±¡ä¸­ç‰¹å®šçŠ¶æ€æ‰€å¯¹åº”çš„è¡Œä¸ºã€‚</li>
<li>å…·ä½“çŠ¶æ€ç±»(Concrete State)ï¼šå®ç°æŠ½è±¡çŠ¶æ€æ‰€å¯¹åº”çš„è¡Œä¸ºã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">&#39;package top.parak.state.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.state.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: StateDemo &lt;p&gt;
 * &lt;p&gt; Description: çŠ¶æ€æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/8
 */

import org.apache.log4j.Logger;

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class StateDemo &#123;
    public static void main(String[] args) &#123;
        Context context = new Context();
        context.handle();
        context.handle();
        context.handle();
        context.handle();
        context.handle();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     ç¯å¢ƒç±»
 * &lt;/p&gt;
 */
class Context &#123;
    private State state;
    /* åˆå§‹çŠ¶æ€ */
    public Context()  &#123;
        this.state = new ConcreteStateA();
    &#125;
    /* è¯»å–çŠ¶æ€ */
    public State getState() &#123;
        return state;
    &#125;
    /* è®¾ç½®çŠ¶æ€ */
    public void setState(State state) &#123;
        this.state = state;
    &#125;
    /* å¤„ç†è¯·æ±‚ */
    public void handle()  &#123;
        state.handle(this);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡çŠ¶æ€ç±»
 * &lt;/p&gt;
 */
abstract class State &#123;
    abstract void handle(Context context);
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“çŠ¶æ€Aç±»
 * &lt;/p&gt;
 */
class ConcreteStateA extends State &#123;
    private Logger log = Logger.getLogger(ConcreteStateA.class);

    @Override
    void handle(Context context) &#123;
        log.info(&quot;å½“å‰çŠ¶æ€ï¼šA&quot;);
        context.setState(new ConcreteStateB());
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“çŠ¶æ€Bç±»
 * &lt;/p&gt;
 */
class ConcreteStateB extends State &#123;
    private Logger log = Logger.getLogger(ConcreteStateB.class);

    @Override
    void handle(Context context) &#123;
        log.info(&quot;å½“å‰çŠ¶æ€ï¼šB&quot;);
        context.setState(new ConcreteStateA());
    &#125;
&#125;&#39;</code></pre>
<br>

<h3 id="2-19-è§‚å¯Ÿè€…æ¨¡å¼-Observer"><a href="#2-19-è§‚å¯Ÿè€…æ¨¡å¼-Observer" class="headerlink" title="2.19 è§‚å¯Ÿè€…æ¨¡å¼-Observer"></a>2.19 è§‚å¯Ÿè€…æ¨¡å¼-Observer</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å¤šä¸ªå¯¹è±¡ä¹‹é—´å­˜åœ¨ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ï¼Œåˆå«åšå‘å¸ƒ-è®¢é˜…æ¨¡å¼ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li><p>é™ä½äº†ç›®æ ‡ä¸è§‚å¯Ÿè€…ä¹‹é—´çš„è€¦åˆå…³ç³»ï¼Œä¸¤è€…ä¹‹é—´æ˜¯æŠ½è±¡è€¦åˆå…³ç³»ã€‚</p>
</li>
<li><p>ç›®æ ‡ä¸è§‚å¯Ÿè€…ä¹‹é—´å»ºç«‹äº†ä¸€å¥—è§¦å‘æœºåˆ¶ã€‚</p>
</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>ç›®æ ‡ä¸è§‚å¯Ÿè€…ä¹‹é—´çš„ä¾èµ–å…³ç³»å¹¶æ²¡æœ‰å®Œå…¨è§£é™¤ï¼Œè€Œä¸”æœ‰å¯èƒ½å‡ºç°å¾ªç¯å¼•ç”¨ã€‚</li>
<li>å½“è§‚å¯Ÿè€…å¯¹è±¡å¾ˆå¤šæ—¶ï¼Œé€šçŸ¥çš„å‘å¸ƒä¼šèŠ±è´¹å¾ˆå¤šæ—¶é—´ï¼Œå½±å“ç¨‹åºçš„æ•ˆç‡ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡ä¸»é¢˜(Subject)ï¼šæä¾›äº†ä¸€ä¸ªç”¨äºä¿å­˜è§‚å¯Ÿè€…å¯¹è±¡çš„èšé›†ç±»å’Œå¢åŠ ã€å¢åŠ è§‚å¯Ÿè€…å¯¹è±¡çš„æ–¹æ³•ï¼Œä»¥åŠé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…çš„æŠ½è±¡æ–¹æ³•ã€‚</li>
<li>å…·ä½“ä¸»é¢˜(Concrete Subject)ï¼šå®ç°æŠ½è±¡ç›®æ ‡ä¸­çš„é€šçŸ¥æ–¹æ³•ï¼Œå½“å…·ä½“ä¸»é¢˜çš„å†…éƒ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œé€šçŸ¥æ‰€æœ‰æ³¨å†Œè¿‡çš„è§‚å¯Ÿè€…å¯¹è±¡ã€‚</li>
<li>æŠ½è±¡è§‚å¯Ÿè€…(Observer)ï¼šä¸€ä¸ªæŠ½è±¡ç±»æˆ–è€…æ¥å£ï¼ŒåŒ…å«äº†ä¸€ä¸ªæ›´æ–°è‡ªå·±çš„æŠ½è±¡æ–¹æ³•ï¼Œå½“æ¥åˆ°å…·ä½“ä¸»é¢˜çš„æ›´æ”¹é€šçŸ¥æ—¶è¢«è°ƒç”¨ã€‚</li>
<li>å…·ä½“è§‚å¯Ÿè€…(Concrete Observer)ï¼šå®ç°æŠ½è±¡è§‚å¯Ÿè€…ä¸­å®šä¹‰çš„æŠ½è±¡æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨å¾—åˆ°ç›®æ ‡çš„æ›´æ”¹é€šçŸ¥æ—¶æ›´æ–°è‡ªèº«çš„çŠ¶æ€ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.observer.pattern;

import org.apache.log4j.Logger;

import java.util.ArrayList;
import java.util.List;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.observer.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: ObserverDemo &lt;p&gt;
 * &lt;p&gt; Description: è§‚å¯Ÿè€…æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/27
 */

public class ObserverDemo &#123;
    public static void main(String[] args) &#123;
        Subject subject = new ConcreteSubject();
        Observer[] observers = new Observer[20];
        for (int i = 0; i &lt; 20; i++) &#123;
            if (i % 2 == 1) &#123;
                observers[i] = new ConcreteObserver1();
            &#125; else &#123;
                observers[i] = new ConcreteObserver2();
            &#125;
            subject.add(observers[i]);
        &#125;
        subject.notifyObserver();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡ç›®æ ‡
 * &lt;/p&gt;
 */
abstract class Subject &#123;
    protected List&lt;Observer&gt; observers = new ArrayList&lt;Observer&gt;();
    /* å¢åŠ è§‚å¯Ÿè€… */
    public void add(Observer observer) &#123;
        observers.add(observer);
    &#125;
    /* åˆ é™¤è§‚å¯Ÿè€… */
    public void del(Observer observer) &#123;
        observers.remove(observer);
    &#125;
    /* é€šçŸ¥è§‚å¯Ÿè€… */
    public abstract void notifyObserver();
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“ç›®æ ‡
 * &lt;/p&gt;
 */
class ConcreteSubject extends Subject &#123;
    @Override
    public void notifyObserver() &#123;
        System.out.println(&quot;å…·ä½“ç›®æ ‡å‘ç”Ÿæ”¹å˜&quot;);
        System.out.println(&quot;â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”&quot;);
        for (Observer observer : observers) &#123;
            observer.response();
        &#125;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡è§‚å¯Ÿè€…
 * &lt;/p&gt;
 */
interface Observer &#123;
    /* ä½œå‡ºååº” */
    void response();
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“è§‚å¯Ÿè€…1
 * &lt;/p&gt;
 */
class ConcreteObserver1 implements Observer &#123;
    private Logger log = Logger.getLogger(ConcreteObserver1.class);
    @Override
    public void response() &#123;
        log.info(&quot;å…·ä½“è§‚å¯Ÿè€…1ä½œå‡ºååº”&quot;);
    &#125;
&#125;

/**
 * &lt;P&gt;
 *     å…·ä½“è§‚å¯Ÿè€…2
 * &lt;/p&gt;
 */
class ConcreteObserver2 implements Observer &#123;
    private Logger log = Logger.getLogger(ConcreteObserver2.class);
    @Override
    public void response() &#123;
        log.info(&quot;å…·ä½“è§‚å¯Ÿè€…2ä½œå‡ºååº”&quot;);
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-20-ä¸­ä»‹è€…æ¨¡å¼-Mediator"><a href="#2-20-ä¸­ä»‹è€…æ¨¡å¼-Mediator" class="headerlink" title="2.20 ä¸­ä»‹è€…æ¨¡å¼-Mediator"></a>2.20 ä¸­ä»‹è€…æ¨¡å¼-Mediator</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å®šä¹‰ä¸€ä¸ªä¸­ä»‹å¯¹è±¡æ¥å°è£…ä¸€ç³»åˆ—å¯¹è±¡ä¹‹é—´çš„äº¤äº’ï¼Œä½¿åŸæœ‰å¯¹è±¡ç›´æ¥çš„è€¦åˆæ¾æ•£ï¼Œä¸”å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜å®ƒä»¬ä¹‹é—´çš„äº¤äº’ã€‚ä¸­ä»‹è€…æ¨¡å¼åˆå«è°ƒåœæ¨¡å¼ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>é™ä½äº†å¯¹è±¡ä¹‹é—´çš„è€¦åˆæ€§ï¼Œä½¿å¾—å¯¹è±¡æ˜“äºç‹¬ç«‹åœ°è¢«å¤ç”¨ã€‚</li>
<li>å°†å¯¹è±¡ä¹‹é—´çš„ä¸€å¯¹å¤šå…³è”è½¬ä¸ºä¸€å¯¹ä¸€çš„å…³è”ï¼Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§ï¼Œä½¿å¾—ç³»ç»Ÿæ˜“äºç»´æŠ¤å’Œæ‹“å±•ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å½“åŒäº‹ç±»å¤ªå¤šæ—¶ï¼Œä¸­ä»‹è€…çš„èŒè´£èŒè´£å°†å¾ˆå¤§ï¼Œå®ƒä¼šå˜å¾—å¤æ‚è€Œåºå¤§ï¼Œä»¥è‡³äºç³»ç»Ÿéš¾ä»¥ç»´æŠ¤ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡ä¸­ä»‹è€…(Mediator)ï¼šå®ƒæ˜¯ä¸­ä»‹è€…çš„æ¥å£ï¼Œæä¾›äº†åŒäº‹å¯¹è±¡æ³¨å†Œä¸è½¬å‘åŒäº‹å¯¹è±¡ä¿¡æ¯çš„æŠ½è±¡æ–¹æ³•ã€‚</li>
<li>å…·ä½“ä¸­ä»‹è€…(Concrete Mediator)ï¼šå®ç°ä¸­ä»‹è€…æ¥å£ï¼Œå®šä¹‰ä¸€ä¸ªListæ¥ç®¡ç†åŒäº‹å¯¹è±¡ï¼Œåè°ƒå„ä¸ªåŒäº‹è§’è‰²ä¹‹é—´çš„äº¤äº’å…³ç³»ï¼Œå› æ­¤å®ƒä¾èµ–äºåŒäº‹è§’è‰²ã€‚</li>
<li>æŠ½è±¡åŒäº‹ç±»(Colleague)ï¼šå®šä¹‰åŒäº‹ç±»çš„æ¥å£ï¼Œä¿å­˜ä¸­ä»‹è€…å¯¹è±¡ï¼Œæä¾›åŒäº‹å¯¹è±¡äº¤äº’çš„æŠ½è±¡æ–¹æ³•ï¼Œå®ç°æ‰€æœ‰ç›¸äº’å½±å“çš„åŒäº‹ç±»çš„å…¬å…±åŠŸèƒ½ã€‚</li>
<li>å…·ä½“åŒäº‹ç±»(Concrete Colleague)ï¼šæ˜¯æŠ½è±¡åŒäº‹ç±»çš„å®ç°è€…ï¼Œå½“éœ€è¦ä¸å…¶ä»–åŒäº‹å¯¹è±¡äº¤äº’æ—¶ï¼Œç”±ä¸­ä»‹è€…å¯¹è±¡è´Ÿè´£åç»­çš„äº¤äº’ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.mediator.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.mediator.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: MediatorDemo &lt;p&gt;
 * &lt;p&gt; Description: &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/8
 */

import org.apache.log4j.Logger;

import java.util.ArrayList;
import java.util.List;

/**
 * &lt;p&gt;
 *     ä¸­ä»‹è€…
 * &lt;/p&gt;
 */
public class MediatorDemo &#123;
    public static void main(String[] args) &#123;
        Mediator mediator = new ConcreteMediator();
        Colleague colleague1, colleague2;
        colleague1 = new ConcreteColleague1();
        colleague2 = new ConcreteColleague2();
        mediator.register(colleague1);
        mediator.register(colleague2);
        colleague1.send();
        colleague2.send();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     ä¸­ä»‹è€…
 * &lt;/p&gt;
 */
abstract class Mediator &#123;
    /* æ³¨å†Œ */
    public abstract void register(Colleague colleague);
    /* è½¬å‘ */
    public abstract void relay(Colleague colleague);
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“ä¸­ä»‹è€…
 * &lt;/p&gt;
 */
class ConcreteMediator extends Mediator &#123;
    private List&lt;Colleague&gt; colleagues = new ArrayList&lt;&gt;();

    @Override
    public void register(Colleague colleague) &#123;
        colleagues.add(colleague);
        colleague.setMediator(this);
    &#125;

    @Override
    public void relay(Colleague colleague) &#123;
        for (Colleague colleague1 : colleagues) &#123;
            if (!colleague1.equals(colleague)) &#123;
                colleague1.receive();
            &#125;
        &#125;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡åŒäº‹ç±»
 * &lt;/p&gt;
 */
abstract class Colleague &#123;
    private Logger log = Logger.getLogger(Colleague.class);
    protected Mediator mediator;

    public void setMediator(Mediator mediator) &#123;
        this.mediator = mediator;
    &#125;

    public abstract void receive();
    public abstract void send();
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“åŒäº‹ç±»1
 * &lt;/p&gt;
 */
class ConcreteColleague1 extends Colleague &#123;
    private Logger log = Logger.getLogger(ConcreteColleague1.class);

    @Override
    public void receive() &#123;
        log.info(&quot;å…·ä½“åŒäº‹ç±»1æ”¶åˆ°è¯·æ±‚&quot;);
    &#125;

    @Override
    public void send() &#123;
        log.info(&quot;å…·ä½“åŒäº‹1å‘å‡ºè¯·æ±‚&quot;);
        mediator.relay(this);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“åŒäº‹ç±»2
 * &lt;/p&gt;
 */
class ConcreteColleague2 extends Colleague &#123;
    private Logger log = Logger.getLogger(ConcreteColleague2.class);

    @Override
    public void receive() &#123;
        log.info(&quot;å…·ä½“åŒäº‹ç±»2æ”¶åˆ°è¯·æ±‚&quot;);
    &#125;

    @Override
    public void send() &#123;
        log.info(&quot;å…·ä½“åŒäº‹2å‘å‡ºè¯·æ±‚&quot;);
        mediator.relay(this);
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-21è¿­ä»£å™¨æ¨¡å¼-Iterator"><a href="#2-21è¿­ä»£å™¨æ¨¡å¼-Iterator" class="headerlink" title="2.21è¿­ä»£å™¨æ¨¡å¼-Iterator"></a>2.21è¿­ä»£å™¨æ¨¡å¼-Iterator</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>æä¾›ä¸€ä¸ªå¯¹è±¡æ¥é¡ºåºè®¿é—®èšåˆå¯¹è±¡ä¸­çš„ä¸€ç³»åˆ—æ•°æ®ï¼Œè€Œä¸æš´éœ²èšåˆå¯¹è±¡çš„å†…éƒ¨è¡¨ç¤ºã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>è®¿é—®ä¸€ä¸ªèšåˆå¯¹è±¡çš„å†…å®¹è€Œæ— é¡»æš´éœ²å®ƒçš„å†…éƒ¨è¡¨ç¤ºã€‚</li>
<li>éå†ä»»åŠ¡äº¤ç”±è¿­ä»£å™¨å®Œæˆï¼Œè¿™ç®€åŒ–äº†èšåˆç±»ã€‚</li>
<li>å®ƒæ”¯æŒä»¥ä¸åŒæ–¹å¼éå†ä¸€ä¸ªèšåˆï¼Œç”šè‡³å¯ä»¥è‡ªå®šä¹‰è¿­ä»£å™¨çš„å­ç±»ä»¥æ”¯æŒæ–°çš„éå†ã€‚</li>
<li>å¢åŠ æ–°çš„èšåˆç±»å’Œè¿­ä»£å™¨éƒ½å¾ˆæ–¹ä¾¿ï¼Œæ— é¡»ä¿®æ”¹åŸæœ‰ä»£ç ã€‚</li>
<li>å°è£…æ€§è‰¯å¥½ï¼Œä¸ºéå†ä¸åŒçš„èšåˆç»“æ„æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ã€‚</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å¢åŠ äº†ç±»çš„ä¸ªæ•°ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡èšåˆè§’è‰²(Aggregate)ï¼šå®šä¹‰å­˜å‚¨ã€æ·»åŠ ã€åˆ é™¤èšåˆå¯¹è±¡ä»¥åŠåˆ›å»ºè¿­ä»£å™¨å¯¹è±¡çš„æ¥å£ã€‚</li>
<li>å…·ä½“èšåˆè‰²(Concrete Aggregate)ï¼šå®ç°æŠ½è±¡èšåˆç±»ï¼Œè¿”å›ä¸€ä¸ªå…·ä½“è¿­ä»£å™¨çš„å®ä¾‹ã€‚</li>
<li>æŠ½è±¡è¿­ä»£å™¨è§’è‰²(Iterator)ï¼šå®šä¹‰è®¿é—®å’Œéå†èšåˆå…ƒç´ çš„æ¥å£ï¼Œé€šå¸¸åŒ…å«hasNext()ã€first()ã€next()ç­‰æ–¹æ³•ã€‚</li>
<li>å…·ä½“è¿­ä»£å™¨è§’è‰²(Concrete Iterator)ï¼šå®ç°æŠ½è±¡è¿­ä»£å™¨æ¥å£ä¸­æ‰€å®šä¹‰çš„æ–¹æ³•ï¼Œå®Œæˆå¯¹èšåˆå¯¹è±¡çš„éå†ï¼Œè®°å½•éå†çš„å½“å‰ä½ç½®ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.iterator.pattern;

import org.apache.log4j.Logger;

import java.util.ArrayList;
import java.util.List;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.iterator.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: IteratorDemo &lt;p&gt;
 * &lt;p&gt; Description: è¿­ä»£å™¨æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/10/27
 */

public class IteratorDemo &#123;
    public static Logger log = Logger.getLogger(IteratorDemo.class);

    public static void main(String[] args) &#123;
        Aggregate aggregate = new ConcreteAggregate();
        aggregate.add(&quot;KHighness&quot;);
        aggregate.add(&quot;ParaK&quot;);
        aggregate.add(&quot;FlowerK&quot;);
        log.info(&quot;èšåˆçš„å†…å®¹&quot;);
        Iterator iterator = aggregate.getIterator();
        log.info(iterator.first().toString());
        while (iterator.hasNext()) &#123;
            log.info(iterator.next().toString());
        &#125;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡èšåˆ
 * &lt;/p&gt;
 */
interface Aggregate &#123;
    public void add(Object o);
    public void del(Object o);
    public Iterator getIterator();
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“èšåˆ
 * &lt;/p&gt;
 */
class ConcreteAggregate implements Aggregate &#123;
    private List&lt;Object&gt; list = new ArrayList&lt;&gt;();

    @Override
    public void add(Object o) &#123;
        list.add(o);
    &#125;

    @Override
    public void del(Object o) &#123;
        list.remove(o);
    &#125;

    @Override
    public Iterator getIterator() &#123;
            return (new ConcreteIterator(list));
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡è¿­ä»£å™¨
 * &lt;/p&gt;
 */
interface Iterator &#123;
    Object first();
    Object next();
    boolean hasNext();
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“è¿­ä»£å™¨
 * &lt;/p&gt;
 */
class ConcreteIterator implements Iterator &#123;

    private List&lt;Object&gt; list = null;
    private int index = 1;

    public ConcreteIterator(List&lt;Object&gt; list) &#123;
        this.list = list;
    &#125;

    @Override
    public Object first() &#123;
        index = 0;
        Object object = list.get(index);
        return object;
    &#125;

    @Override
    public Object next() &#123;
        Object object = null;
        if (this.hasNext()) &#123;
            object = list.get(++index);
        &#125;
        return object;
    &#125;

    @Override
    public boolean hasNext() &#123;
        if (index &lt; list.size() - 1) &#123;
            return true;
        &#125; else &#123;
            return false;
        &#125;
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-22-è®¿é—®è€…æ¨¡å¼-Visitor"><a href="#2-22-è®¿é—®è€…æ¨¡å¼-Visitor" class="headerlink" title="2.22 è®¿é—®è€…æ¨¡å¼-Visitor"></a>2.22 è®¿é—®è€…æ¨¡å¼-Visitor</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>å°†ä½œç”¨äºæŸç§æ•°æ®ç»“æ„ä¸­çš„å„å…ƒç´ çš„æ“ä½œåˆ†ç¦»å‡ºæ¥å°è£…æˆç‹¬ç«‹çš„ç±»ï¼Œä½¿å…¶åœ¨ä¸æ”¹å˜æ•°æ®ç»“æ„çš„å‰æä¸‹å¯ä»¥æ·»åŠ ä½œç”¨äºè¿™äº›å…ƒç´ çš„æ–°çš„æ“ä½œã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>æ‰©å±•æ€§å¥½</li>
<li>å¤ç”¨æ€§å¥½</li>
<li>çµæ´»æ€§å¥½</li>
<li>ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>å¢åŠ æ–°çš„å…ƒç´ å¾ˆå›°éš¾</li>
<li>ç ´åå°è£…</li>
<li>è¿åäº†ä¾èµ–å€’ç½®åŸåˆ™</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡è®¿é—®è€…(Visitor)ï¼šå®šä¹‰ä¸€ä¸ªè®¿é—®å…·ä½“å…ƒç´ çš„æ¥å£ï¼Œä¸ºæ¯ä¸ªå…·ä½“å…ƒç´ ç±»å¯¹åº”ä¸€ä¸ªè®¿é—®æ“ä½œvisit()ï¼Œè¯¥æ“ä½œä¸­çš„å‚æ•°ç±»å‹æ ‡è¯†äº†è¢«è®¿é—®çš„å…·ä½“å…ƒç´ ã€‚</li>
<li>å…·ä½“è®¿é—®è€…(Concrete Visitor)ï¼šå®ç°æŠ½è±¡è®¿é—®è€…è§’è‰²å£°æ˜çš„å„ä¸ªè®¿é—®æ“ä½œï¼Œç¡®å®šè®¿é—®è€…è®¿é—®ä¸€ä¸ªå…ƒç´ æ—¶è¯¥åšä»€ä¹ˆã€‚</li>
<li>æŠ½è±¡å…ƒç´ (Element)ï¼šå£°æ˜ä¸€ä¸ªåŒ…å«æ¥å—æ“ä½œaccept()çš„æ¥å£ï¼Œè¢«æ¥å—çš„è®¿é—®è€…å¯¹è±¡ä½œä¸ºaccept()çš„å‚æ•°ã€‚</li>
<li>å…·ä½“å…ƒç´ (Concrete Element)ï¼šå®ç°æŠ½è±¡å…ƒç´ è§’è‰²æä¾›çš„accept()æ“ä½œã€‚</li>
<li>å¯¹è±¡ç»“æ„(Object Structure)ï¼šåŒ…å«å…ƒç´ è§’è‰²çš„å®¹å™¨ï¼Œæä¾›è®©è®¿é—®è€…å¯¹è±¡éå†å®¹å™¨ä¸­çš„æ‰€æœ‰å…ƒç´ çš„æ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.visitor.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.visitor.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: VisitorDemo &lt;p&gt;
 * &lt;p&gt; Description: è®¿é—®è€…æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/8
 */

import org.apache.log4j.Logger;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class VisitorDemo &#123;
    public static void main(String[] args) &#123;
        ObjectStructure structure = new ObjectStructure();
        structure.add(new ConcreteElementA());
        structure.add(new ConcreteElementB());
        structure.add(new ConcreteElementC());

        Visitor visitorA = new ConcreteVisitorA();
        Visitor visitorB = new ConcreteVisitorB();
        structure.accept(visitorA);
        structure.accept(visitorB);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡è®¿é—®è€…
 * &lt;/p&gt;
 */
interface Visitor &#123;
    void visit(ConcreteElementA elementA);
    void visit(ConcreteElementB elementB);
    void visit(ConcreteElementC elementC);
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“è®¿é—®è€…A
 * &lt;/p&gt;
 */
class ConcreteVisitorA implements Visitor &#123;
    private Logger log = Logger.getLogger(ConcreteVisitorA.class);

    @Override
    public void visit(ConcreteElementA elementA) &#123;
        log.info(&quot;å…·ä½“è®¿é—®è€…Aè®¿é—®=&gt;å…·ä½“å…ƒç´ A&quot;);
        elementA.operaA();
    &#125;

    @Override
    public void visit(ConcreteElementB elementB) &#123;
        log.info(&quot;å…·ä½“è®¿é—®è€…Aè®¿é—®=&gt;å…·ä½“å…ƒç´ B&quot;);
        elementB.operaB();
    &#125;

    @Override
    public void visit(ConcreteElementC elementC) &#123;
        log.info(&quot;å…·ä½“è®¿é—®è€…Aè®¿é—®=&gt;å…·ä½“å…ƒç´ C&quot;);
        elementC.operaC();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“è®¿é—®è€…B
 * &lt;/p&gt;
 */
class ConcreteVisitorB implements Visitor &#123;
    private Logger log = Logger.getLogger(ConcreteVisitorB.class);

    @Override
    public void visit(ConcreteElementA elementA) &#123;
        log.info(&quot;å…·ä½“è®¿é—®è€…Bè®¿é—®=&gt;å…·ä½“å…ƒç´ A&quot;);
        elementA.operaA();
    &#125;

    @Override
    public void visit(ConcreteElementB elementB) &#123;
        log.info(&quot;å…·ä½“è®¿é—®è€…Bè®¿é—®=&gt;å…·ä½“å…ƒç´ B&quot;);
        elementB.operaB();
    &#125;

    @Override
    public void visit(ConcreteElementC elementC) &#123;
        log.info(&quot;å…·ä½“è®¿é—®è€…Bè®¿é—®=&gt;å…·ä½“å…ƒç´ C&quot;);
        elementC.operaC();
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡å…ƒç´ ç±»
 * &lt;/p&gt;
 */
interface Element &#123;
    void accept(Visitor visitor);
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“å…ƒç´ A
 * &lt;/p&gt;
 */
class ConcreteElementA implements Element &#123;
    private Logger log = Logger.getLogger(ConcreteElementA.class);

    @Override
    public void accept(Visitor visitor) &#123;
        visitor.visit(this);
    &#125;

    public void operaA()  &#123;
        log.info(&quot;å…·ä½“å…ƒç´ Aæ“ä½œ...&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“å…ƒç´ B
 * &lt;/p&gt;
 */
class ConcreteElementB implements Element &#123;
    private Logger log = Logger.getLogger(ConcreteElementB.class);

    @Override
    public void accept(Visitor visitor) &#123;
        visitor.visit(this);
    &#125;

    public void operaB()  &#123;
        log.info(&quot;å…·ä½“å…ƒç´ Bæ“ä½œ...&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å…·ä½“å…ƒç´ C
 * &lt;/p&gt;
 */
class ConcreteElementC implements Element &#123;
    private Logger log = Logger.getLogger(ConcreteElementC.class);

    @Override
    public void accept(Visitor visitor) &#123;
        visitor.visit(this);
    &#125;

    public void operaC()  &#123;
        log.info(&quot;å…·ä½“å…ƒç´ Cæ“ä½œ...&quot;);
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å¯¹è±¡ç»“æ„è§’è‰²
 * &lt;/p&gt;
 */
class ObjectStructure &#123;
    private List&lt;Element&gt; list = new ArrayList&lt;Element&gt;();

    public void accept(Visitor visitor) &#123;
        Iterator&lt;Element&gt; iterator = list.iterator();
        while (iterator.hasNext()) &#123;
            iterator.next().accept(visitor);
        &#125;
    &#125;

    public void add(Element element) &#123;
        list.add(element);
    &#125;

    public void remove(Element element) &#123;
        list.remove(element);
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-23-å¤‡å¿˜å½•æ¨¡å¼-Memento"><a href="#2-23-å¤‡å¿˜å½•æ¨¡å¼-Memento" class="headerlink" title="2.23 å¤‡å¿˜å½•æ¨¡å¼-Memento"></a>2.23 å¤‡å¿˜å½•æ¨¡å¼-Memento</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>åœ¨ä¸ç ´åå°è£…æ€§çš„å‰æä¸‹ï¼Œæ•è·ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶åœ¨è¯¥å¯¹è±¡ä¹‹å¤–ä¿å­˜è¿™ä¸ªçŠ¶æ€ï¼Œä»¥ä¾¿ä»¥åå½“éœ€è¦æ—¶èƒ½å°†è¯¥å¯¹è±¡æ¢å¤åˆ°åŸå…ˆä¿å­˜çš„çŠ¶æ€ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>æä¾›äº†ä¸€ä¸ªå¯ä»¥æ¢å¤çŠ¶æ€çš„æœºåˆ¶</li>
<li>å®ç°å†…éƒ¨çŠ¶æ€çš„å°è£…</li>
<li>ç®€åŒ–äº†å‘èµ·äºº</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>èµ„æºæ¶ˆè€—å¤§</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>å‘èµ·äºº(Originator)ï¼šè®°å½•å½“å‰æ—¶åˆ»çš„å†…éƒ¨çŠ¶æ€ä¿¡æ¯ï¼Œæä¾›åˆ›å»ºå¤‡å¿˜å½•å’Œæ¢å¤å¤‡å¿˜å½•æ•°æ®çš„åŠŸèƒ½ï¼Œå®ç°å…¶ä»–ä¸šåŠ¡åŠŸèƒ½ï¼Œå®ƒå¯ä»¥è®¿é—®å¤‡å¿˜å½•é‡Œçš„æ‰€æœ‰ä¿¡æ¯ã€‚</li>
<li>å¤‡å¿˜å½•(Memento)ï¼šè´Ÿè´£å­˜å‚¨å‘èµ·äººçš„å†…éƒ¨çŠ¶æ€ï¼Œåœ¨éœ€è¦çš„æ—¶å€™æä¾›è¿™äº›å†…éƒ¨çŠ¶æ€ç»™å‘èµ·äººã€‚</li>
<li>ç®¡ç†è€…(Caretaker)ï¼šå¯¹å¤‡å¿˜å½•è¿›è¡Œç®¡ç†ï¼Œæä¾›ä¿å­˜ä¸è·å–å¤‡å¿˜å½•çš„åŠŸèƒ½ï¼Œä½†ä¸èƒ½å¯¹å¤‡å¿˜å½•è¿›è¡Œè®¿é—®ä¸ä¿®æ”¹ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.memento.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.memento.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: MementoDemo &lt;p&gt;
 * &lt;p&gt; Description: å¤‡å¿˜å½•æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/8
 */

import org.apache.log4j.Logger;

/**
 * &lt;p&gt;æµ‹è¯•ç±»&lt;/p&gt;
 */
public class MementoDemo &#123;
    public static Logger log = Logger.getLogger(MementoDemo.class);
    public static void main(String[] args) &#123;
        Originator originator = new Originator();
        Caretaker caretaker = new Caretaker();
        originator.setState(&quot;State1&quot;);
        log.info(&quot;åˆå§‹çŠ¶æ€ï¼š&quot; + originator.getState());
        // ä¿å­˜çŠ¶æ€
        caretaker.setMemento(originator.createMemento());
        originator.setState(&quot;State2&quot;);
        log.info(&quot;æ–°çš„çŠ¶æ€ï¼š&quot; + originator.getState());
        // æ¢å¤çŠ¶æ€
        originator.restoreMemento(caretaker.getMemento());
        log.info(&quot;æ¢å¤çŠ¶æ€ï¼š&quot; + originator.getState());
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å¤‡å¿˜å½•
 * &lt;/p&gt;
 */
class Memento &#123;
    private String state;

    public Memento(String state) &#123;
        this.state = state;
    &#125;

    public String getState() &#123;
        return state;
    &#125;

    public void setState(String state) &#123;
        this.state = state;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     å‘èµ·äºº
 * &lt;/p&gt;
 */
class Originator &#123;
    private String state;

    public String getState() &#123;
        return state;
    &#125;

    public void setState(String state) &#123;
        this.state = state;
    &#125;

    public Memento createMemento() &#123;
        return new Memento(state);
    &#125;

    public void restoreMemento(Memento memento) &#123;
        this.setState(memento.getState());
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     ç®¡ç†è€…
 * &lt;/p&gt;
 */
class Caretaker &#123;
    private Memento memento;

    public Memento getMemento() &#123;
        return memento;
    &#125;

    public void setMemento(Memento memento) &#123;
        this.memento = memento;
    &#125;
&#125;</code></pre>
<br>

<h3 id="2-24-è§£é‡Šå™¨æ¨¡å¼-Interpreter"><a href="#2-24-è§£é‡Šå™¨æ¨¡å¼-Interpreter" class="headerlink" title="2.24 è§£é‡Šå™¨æ¨¡å¼-Interpreter"></a>2.24 è§£é‡Šå™¨æ¨¡å¼-Interpreter</h3><blockquote>
<p>å®šä¹‰</p>
</blockquote>
<p>ç»™åˆ†æå¯¹è±¡å®šä¹‰ä¸€ä¸ªè¯­è¨€ï¼Œå¹¶å®šä¹‰è¯¥è¯­è¨€çš„æ–‡æ³•è¡¨ç¤ºï¼Œå†è®¾è®¡ä¸€ä¸ªè§£æå™¨æ¥è§£é‡Šå…¶ä¸­çš„å¥å­ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<ul>
<li>æ‰©å±•æ€§å¥½</li>
<li>å®¹æ˜“å®ç°</li>
</ul>
<blockquote>
<p>ç¼ºç‚¹</p>
</blockquote>
<ul>
<li>æ‰§è¡Œæ•ˆç‡è¾ƒä½</li>
<li>ä¼šå¼•èµ·ç±»è†¨èƒ€</li>
<li>å¯åº”ç”¨çš„åœºæ™¯æ¯”è¾ƒå°‘</li>
</ul>
<blockquote>
<p>ç»“æ„</p>
</blockquote>
<ul>
<li>æŠ½è±¡è¡¨è¾¾å¼(Abstract Expression)ï¼šå®šä¹‰è§£é‡Šå™¨çš„æ¥å£ï¼Œçº¦å®šè§£é‡Šå™¨çš„è§£é‡Šæ“ä½œï¼Œä¸»è¦åŒ…å«è§£é‡Šæ–¹æ³•interpret()ã€‚</li>
<li>ç»ˆç»“ç¬¦è¡¨è¾¾å¼(Terminal Expression)ï¼šæŠ½è±¡è¡¨è¾¾å¼çš„å­ç±»ï¼Œç”¨æ¥å®ç°æ–‡æ³•ä¸­ä¸ç»ˆç»“ç¬¦ç›¸å…³çš„æ“ä½œï¼Œæ–‡æ³•ä¸­çš„æ¯æ¡ä¸€ä¸ªç»ˆç»“ç¬¦éƒ½å¯¹åº”äºä¸€ä¸ªéç»ˆç»“ç¬¦è¡¨è¾¾å¼ã€‚</li>
<li>éç»ˆç»“ç¬¦è¡¨è¾¾å¼(Terminal Expression)ï¼šæŠ½è±¡è¡¨è¾¾å¼çš„å­ç±»ï¼Œç”¨æ¥å®ç°æ–‡æ³•ä¸­ä¸éç»ˆç»“ç¬¦ç›¸å…³çš„æ“ä½œï¼Œæ–‡æ³•ä¸­çš„æ¯æ¡è§„åˆ™éƒ½å¯¹åº”äºä¸€ä¸ªéç»ˆç»“ç¬¦è¡¨è¾¾å¼ã€‚</li>
<li>ç¯å¢ƒ(Context)ï¼šé€šå¸¸åŒ…å«å„ä¸ªè§£é‡Šå™¨éœ€è¦çš„æ•°æ®æˆ–æ˜¯å…¬å…±çš„åŠŸèƒ½ï¼Œä¸€èˆ¬ç”¨æ¥ä¼ é€’è¢«æ‰€æœ‰è§£é‡Šå™¨å…±äº«çš„æ•°æ®ï¼Œåå¼€ä½ çš„è§£é‡Šå™¨å¯ä»¥ä»è¿™é‡Œè·å–è¿™äº›å€¼ã€‚</li>
<li>å®¢æˆ·ç«¯(Client)ï¼šä¸»è¦ä»»åŠ¡æ˜¯å°†éœ€è¦åˆ†æçš„å¥å­æˆ–è¡¨è¾¾å¼è½¬æ¢æˆä½¿ç”¨è§£é‡Šå™¨å¯¹è±¡æè¿°çš„æŠ½è±¡è¯­æ³•æ ‘ï¼Œç„¶åè°ƒç”¨è§£é‡Šå™¨çš„è§£é‡Šæ–¹æ³•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒè§’è‰²é—´æ¥è®¿é—®è§£é‡Šå™¨çš„è§£é‡Šæ–¹æ³•ã€‚</li>
</ul>
<blockquote>
<p>å®ç°</p>
</blockquote>
<pre><code class="java">package top.parak.interpreter.pattern;

/**
 * &lt;p&gt; Project: DesignPattern &lt;/p&gt;
 * &lt;p&gt; Package: top.parak.interpreter.pattern &lt;/p&gt;
 * &lt;p&gt; FileName: InterpreterDemo &lt;p&gt;
 * &lt;p&gt; Description: è§£é‡Šå™¨æ¨¡å¼ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/8
 */

/**
 * &lt;p&gt;
 *     æµ‹è¯•ç±»
 * &lt;/p&gt;
 */
public class InterpreterDemo &#123;
&#125;

/**
 * &lt;p&gt;
 *     æŠ½è±¡è¡¨è¾¾å¼
 * &lt;/p&gt;
 */
interface AbstractExpression &#123;
    Object interpret(String info);
&#125;

/**
 * &lt;p&gt;
 *     ç»ˆç»“ç¬¦è¡¨è¾¾å¼ç±»
 * &lt;/p&gt;
 */
class TerminalExpression implements AbstractExpression &#123;
    @Override
    public Object interpret(String info) &#123;
        /* å¯¹ç»ˆç»“ç¬¦è¡¨è¾¾å¼çš„å¤„ç† */
        return null;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     éç»ˆç»“ç¬¦è¡¨è¾¾å¼ç±»
 * &lt;/p&gt;
 */
class NonTerminalExpression implements AbstractExpression &#123;
    @Override
    public Object interpret(String info) &#123;
        /* å¯¹éç»ˆç»“ç¬¦è¡¨è¾¾å¼çš„å¤„ç† */
        return null;
    &#125;
&#125;

/**
 * &lt;p&gt;
 *     ç¯å¢ƒç±»
 * &lt;/p&gt;
 */
class Context &#123;
    private AbstractExpression abstractExpression;
    public Context() &#123;
        /* æ•°æ®åˆå§‹åŒ– */
    &#125;
    public void operation(String info) &#123;
        /* è°ƒç”¨ç›¸å…³è¡¨è¾¾å¼çš„è§£é‡Šæ–¹æ³• */
    &#125;
&#125;</code></pre>
]]></content>
      <categories>
        <category>Software Engineering</category>
      </categories>
      <tags>
        <tag>Design Pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>çº¢é»‘æ ‘</title>
    <url>/posts/f89cb603/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ğŸ““-å®šä¹‰"><a href="#ğŸ““-å®šä¹‰" class="headerlink" title="ğŸ““ å®šä¹‰"></a>ğŸ““ å®šä¹‰</h2><p>çº¢é»‘æ ‘æ˜¯ä¸€ç§å«æœ‰çº¢é»‘èŠ‚ç‚¹å¹¶èƒ½è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘</p>
<blockquote>
<p>ğŸŒ²äºŒå‰æŸ¥æ‰¾æ ‘</p>
<p>æ»¡è¶³çº¦æŸï¼šå·¦ç»“ç‚¹çš„å€¼å°äºçˆ¶ç»“ç‚¹ï¼Œçˆ¶ç»“ç‚¹çš„å€¼å°äºå³ç»“ç‚¹çš„å€¼ã€‚</p>
<p>åœºæ™¯ç†è§£ï¼šå‡è®¾äºŒå‰æŸ¥æ‰¾æ ‘å»ºç«‹åœ¨x-yç¬›å¡å°”åæ ‡ç³»ä¸­ï¼Œåˆ™æ‰€æœ‰ç»“ç‚¹å‘xè½´æŠ•å½±ï¼Œå€¼æ­£å¥½æ²¿ç€xè½´é€’å¢ã€‚</p>
</blockquote>
<br>



<h2 id="ğŸ”°-æ€§è´¨"><a href="#ğŸ”°-æ€§è´¨" class="headerlink" title="ğŸ”° æ€§è´¨"></a>ğŸ”° æ€§è´¨</h2><ul>
<li>æ¯ä¸ªç»“ç‚¹è¦ä¹ˆæ˜¯é»‘è‰²ï¼Œè¦ä¹ˆæ˜¯çº¢è‰²</li>
<li>æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²</li>
<li>æ¯ä¸ªå¶å­ç»“ç‚¹(NIL)æ˜¯é»‘è‰²çš„(è™šç»“ç‚¹)</li>
<li>æ¯ä¸ªçº¢è‰²ç»“ç‚¹çš„ä¸¤ä¸ªå­ç»“ç‚¹ä¸€å®šéƒ½æ˜¯é»‘è‰²</li>
<li>ä»»æ„ä¸€ç»“ç‚¹åˆ°æ¯ä¸ªå¶å­ç»“ç‚¹çš„è·¯å¾„éƒ½åŒ…å«æ•°é‡ç›¸åŒçš„é»‘ç»“ç‚¹(é»‘è‰²å®Œç¾å¹³è¡¡)</li>
</ul>
<p>ä»¥ä¸Šä¸ºæœ€ç®€æ€§è´¨ï¼Œä»»ä½•ä¸€æ¡ä¸å¯ç¼ºå°‘ï¼Œä»»æ„å››æ¡ä¸èƒ½æ¨å‡ºå¦å¤–ä¸€æ¡ã€‚</p>
<br>

<h2 id="ğŸŒ—-å¹³è¡¡"><a href="#ğŸŒ—-å¹³è¡¡" class="headerlink" title="ğŸŒ— å¹³è¡¡"></a>ğŸŒ— å¹³è¡¡</h2><p>çº¢é»‘æ ‘æ˜¯éå®Œç¾å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¯å®Œç¾é»‘è‰²å¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ã€‚</p>
<br>

<blockquote>
<p>â­•çº¢é»‘æ ‘è‡ªå¹³è¡¡çš„æœ€å°å•å…ƒ</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f89cb603/image-20201106225159861.png" class="" title="image-20201106225159861">

<p>çº¢é»‘æ ‘çš„è‡ªå¹³è¡¡</p>
<p>æ’å…¥åªè€ƒè™‘G-{P, U}-Cä¸‰ä»£ï¼Œåˆ é™¤åªè€ƒè™‘P-{C, B}-{CL, CR, BL, BR}ä¸‰ä»£</p>
<br>

<blockquote>
<p>ğŸ”±çº¢é»‘æ ‘è‡ªå¹³è¡¡çš„åŸå­æ“ä½œ</p>
</blockquote>
<p>åŒ…æ‹¬ï¼šå˜è‰²ã€å·¦æ—‹ã€å³æ—‹</p>
<p>æ—‹è½¬è¦æœ‰åœ†å¿ƒï¼Œæœ‰æ–¹å‘ã€‚</p>
<p>æ—‹è½¬ç»“ç‚¹æ˜¯çˆ¶ç»“ç‚¹å›´ç»•å­èŠ‚ç‚¹æ—‹è½¬(å­èŠ‚ç‚¹ä¸ºåœ†å¿ƒ)ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f89cb603/image-20201103220142748.png" class="" title="image-20201103220142748">

<center>
    <font face="Kristen ITC" color="#555555" font-size=100px>â˜¬ æ—‹è½¬ç»“ç‚¹ â˜¬</font><br>
</center>

<br>

<blockquote>
<p>ğŸŒå˜è‰²ï¼šP-Black=&gt;Red,CB-Red=&gt;Black</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f89cb603/image-20201103221816468.png" class="" title="image-20201103221816468">

<center>
    <font face="Kristen ITC" color="#555555" font-size=100px>â˜¬ å˜è‰²æ“ä½œ â˜¬</font><br>
</center>

<br>

<blockquote>
<p>ğŸŒ”å·¦æ—‹ï¼šæ—‹è½¬ç»“ç‚¹ç»•åœ†å¿ƒé€†æ—¶é’ˆæ–¹å‘æ—‹è½¬ã€‚åŸºäºæœ€çŸ­è·¯å¾„æ¥ç¡®å®šæ–¹å‘ã€‚</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f89cb603/image-20201103222025132.png" class="" title="image-20201103222025132">

<center>
    <font face="Kristen ITC" color="#555555" font-size=100px>â˜¬ å·¦æ—‹æ“ä½œ â˜¬</font><br>
</center>

<br>

<pre><code class="java">    /**
     * &lt;p&gt;å·¦æ—‹&lt;/p&gt;
     * &lt;p&gt;è¿‡ç¨‹ï¼šçˆ¶äº²ä¸‹æ²‰ï¼Œå³å­ä¸Šå‡ï¼Œå³å­çš„å·¦å­å˜ä¸ºåŸçˆ¶çš„å³å­&lt;/p&gt;
     * &lt;p&gt;
     *     å·¦æ—‹Xç»“ç‚¹
     *             P                                P
     *            /                                /
     *           X                                Y
     *         /  \        --(å·¦æ—‹)--&gt;           / \
     *       lX    Y                           X  rY
     *            / \                        /  \
     *          lY   rY                     lX  lY
     * &lt;/p&gt;
     * @param x
     */
    public void leftRotate(RBTNode&lt;T, D&gt; x) &#123;
        /* å³å­ç»“ç‚¹ */
        RBTNode&lt;T, D&gt; y = x.getRight();
        /* çˆ¶äº²ç»“ç‚¹ */
        RBTNode&lt;T, D&gt; p = x.getParent();

        /* Yçš„å·¦å­ å˜æˆ Xçš„å³å­
        * è‹¥Xä¸Yçš„å·¦å­ä¸ä¸ºç©º
        * åˆ™è®¾ç½®Yçš„å·¦å­çš„çˆ¶äº²ä¸ºX */
        x.setRight(y.getLeft());
        if (y.getLeft() != null) &#123;
            y.getLeft().setParent(x);
        &#125;

        /* è®¾ç½®Yçš„çˆ¶äº²ä¸ºP
        * 1. Pä¸ºç©ºï¼Œåˆ™æ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºY
        * 2. Xä¸ºPçš„å·¦å­ï¼Œ åˆ™Pçš„å·¦å­è®¾ç½®ä¸ºY
        * 3. Xä¸ºPçš„å³å­ï¼Œåˆ™Pçš„å³å­è®¾ç½®ä¸ºY */
        y.setParent(p);
        if (p == null) &#123;
            this.root = y;
        &#125; else &#123;
            if (p.getLeft() == x) &#123;
                p.setLeft(y);
            &#125; else &#123;
                p.setRight(y);
            &#125;
        &#125;

        /* å°†Xçš„çˆ¶äº²è®¾ç½®ä¸ºY
        * å°†Yçš„å·¦å­è®¾ç½®ä¸ºX */
        x.setParent(y);
        y.setLeft(x);
    &#125;</code></pre>
<blockquote>
<p>ğŸŒ–å³æ—‹ï¼šæ—‹è½¬ç»“ç‚¹ç»•åœ†å¿ƒé¡ºæ—¶é’ˆæ–¹å‘æ—‹è½¬ã€‚åŸºäºæœ€çŸ­è·¯å¾„ç¡®å®šæ–¹å‘ã€‚</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f89cb603/image-20201103223223997.png" class="" title="image-20201103223223997">

<center>
    <font face="Kristen ITC" color="#555555" font-size=100px>â˜¬ å³æ—‹æ“ä½œ â˜¬</font><br>
</center>

<br>

<pre><code class="java">    /**
     * &lt;p&gt;å³æ—‹&lt;/p&gt;
     * &lt;p&gt;è¿‡ç¨‹ï¼šçˆ¶äº²ä¸‹æ²‰ï¼Œå·¦å­ä¸Šå‡ï¼Œå·¦å­çš„å³å­å˜æˆåŸçˆ¶çš„å·¦å­&lt;/p&gt;
     * &lt;p&gt;
     *     å³æ—‹Xç»“ç‚¹
     *             P                                P
     *            /                                /
     *           X                                Y
     *         /  \        --(å³æ—‹)--&gt;           /  \
     *        Y   rX                           lY   X
     *       / \                                   / \
     *     lY  rY                                rY  rX
     * &lt;/p&gt;
     * @param x
     */
    public void rightRotate(RBTNode&lt;T, D&gt; x) &#123;
        /* å·¦å­ç»“ç‚¹ */
        RBTNode&lt;T, D&gt; y = x.getLeft();
        /* çˆ¶äº²ç»“ç‚¹ */
        RBTNode&lt;T, D&gt; p = x.getParent();

        /* Yçš„å³å­ å˜æˆ Xçš„å·¦å­
        * è‹¥Yçš„å³å­ä¸ä¸ºç©º
        * åˆ™è®¾ç½®Yçš„å³å­çš„çˆ¶äº²ä¸ºX */
        x.setLeft(y.getRight());
        if (y.getRight() != null) &#123;
            y.getRight().setParent(x);
        &#125;

        /* è®¾ç½®Yçš„çˆ¶äº²ä¸ºP
         * 1. Pä¸ºç©ºï¼Œåˆ™æ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºY
         * 2. Xä¸ºPçš„å·¦å­ï¼Œ åˆ™Pçš„å·¦å­è®¾ç½®ä¸ºY
         * 3. Xä¸ºPçš„å³å­ï¼Œåˆ™Pçš„å³å­è®¾ç½®ä¸ºY */
        y.setParent(p);
        if (p == null) &#123;
            this.root = y;
        &#125; else &#123;
            if (p.getLeft() == x) &#123;
                p.setLeft(y);
            &#125; else &#123;
                p.setRight(y);
            &#125;
        &#125;

        /* å°†Xçš„çˆ¶äº²è®¾ç½®ä¸ºY
        * å°†Yçš„å³å­è®¾ç½®ä¸ºX */
        x.setParent(y);
        y.setRight(x);
    &#125;</code></pre>
<br>

<h2 id="ğŸŒ€-å¢åˆ "><a href="#ğŸŒ€-å¢åˆ " class="headerlink" title="ğŸŒ€ å¢åˆ "></a>ğŸŒ€ å¢åˆ </h2><br>

<blockquote>
<p>â•æ’å…¥ç»“ç‚¹</p>
</blockquote>
<p>æ–°å¢ç»“ç‚¹é»˜è®¤ä¸ºçº¢è‰²ï¼Œé¿å…ç ´åé»‘è‰²å®Œç¾å¹³è¡¡ã€‚</p>
<p>é¦–å…ˆå¯»æ‰¾æ–°ç»“ç‚¹çš„æ’å…¥ä½ç½®ï¼Œå³æ‰¾åˆ°æ–°ç»“ç‚¹çš„çˆ¶äº²ï¼Œç„¶åå†³å®šå°†æ–°ç»“ç‚¹æ’å…¥åˆ°çˆ¶äº²çš„å·¦è¾¹è¿˜æ˜¯å³è¾¹ã€‚</p>
<pre><code class="java">    /**
     * &lt;p&gt;æ’å…¥ç»“ç‚¹&lt;/p&gt;
     * @param key
     * @param data
     */
    public void insertNode(T key, D data) &#123;
        int cmp;
        RBTNode&lt;T, D&gt; x = this.root;
        RBTNode&lt;T, D&gt; y = null;

        /* å¯»æ‰¾æ–°ç»“ç‚¹çš„æ’å…¥ä½ç½® */
        while (x != null) &#123;
            y = x;
            cmp = key.compareTo(x.getKey());

            if (cmp == 0) &#123;
                /* keyå·²å­˜åœ¨ï¼Œç›´æ¥æ›´æ–° */
                System.out.println(getCurrentTime() + &quot; [WARN] keyå·²å­˜åœ¨&quot;);
                System.out.println(getCurrentTime() + &quot; [INFO] æ›´æ–°value: &quot; + get(key) + &quot; =&gt; &quot; + data);
                return;
            &#125; else if (cmp &gt; 0)&#123;
                /* keyè¾ƒå¤§ï¼Œç»§ç»­å‘å³æŸ¥è¯¢ */
                x = x.getRight();
            &#125; else if (cmp &lt; 0) &#123;
                /* keyè¾ƒå°ï¼Œç»§ç»­å‘å·¦æŸ¥è¯¢ */
                x = x.getLeft();
            &#125;
        &#125;

        /* ç”Ÿæˆä¸€ä¸ªæ–°çš„ç»“ç‚¹ */
        RBTNode&lt;T, D&gt; node = new RBTNode&lt;&gt;(RBTColor.red, key, data, null, null, null);
        System.out.println(getCurrentTime() + &quot; [INFO] æ–°å¢ç»“ç‚¹ (&quot; + key + &quot;, &quot; + data + &quot;)&quot;);
        /* æ€»ç»“ç‚¹æ•°é‡+1 */
        this.count.incrementAndGet();
        /* è®¾ç½®æ–°ç»“ç‚¹çš„çˆ¶äº²ä¸ºY */
        node.setParent(y);

        /* å†æ¬¡æ¯”è¾ƒå†³å®šæ–°ç»“ç‚¹æ˜¯yçš„å·¦å­è¿˜æ˜¯å³å­*/
        if (y == null) &#123;
            this.root = node;
        &#125; else &#123;
            cmp = key.compareTo(y.getKey());
            if (cmp &gt; 0) &#123;
                y.setRight(node);
            &#125; else &#123;
                y.setLeft(node);
            &#125;
        &#125;

        /* æœ€åè¿›è¡Œè‡ªå¹³è¡¡ */
        balanceInsertion(node);
    &#125;</code></pre>
<br>

<blockquote>
<p>ğŸ’‰æ’å…¥ä¿®å¤</p>
</blockquote>
<p>æ’å…¥ç»“ç‚¹ä¸ºçº¢è‰²ï¼Œå› æ­¤åªæœ‰å½“çˆ¶äº²ç»“ç‚¹ä¸ºçº¢è‰²æ—¶æ‰éœ€è¦ä¿®å¤ã€‚</p>
<p>G-ç¥–çˆ¶ã€P-çˆ¶äº²ã€U-å”å”ã€C-æ’å…¥ã€‚</p>
<p>æˆ‘æ€»ç»“äº†äº”ç§æƒ…å†µä»¥åŠè§£å†³å£è¯€:</p>
<p>ï¼ˆ1ï¼‰å”å”ä¸ºçº¢</p>
<p>CASE 1</p>
<p>Description: å”å”ä¸ºçº¢</p>
<p>Solution: GPUå˜è‰²ï¼Œè‹¥ä¸æ»¡è¶³çº¢é»‘æ ‘çº¦æŸåˆ™é€’å½’å˜è‰²</p>
<br>

<p>ï¼ˆ2ï¼‰å”å”ä¸ºé»‘</p>
<p>CASE 2</p>
<p>Description: çˆ¶ä¸ºå·¦å­ï¼ŒGPCä¸‰ç‚¹ä¸€çº¿</p>
<p>Solution: å³æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</p>
<pre><code class="java">         (1) å³æ—‹ç¥–çˆ¶ç»“ç‚¹
           é»‘ç¥–                        çº¢çˆ¶
           / \                         / \
        çº¢çˆ¶  é»‘å”    --(å³æ—‹)--&gt;    çº¢æ’  é»‘ç¥–
         /                                 \
       çº¢æ’                                é»‘å”
         (2) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²
           çº¢çˆ¶                        é»‘çˆ¶
           / \                         / \
        çº¢æ’  é»‘ç¥–    --(å˜è‰²)--&gt;    çº¢æ’  çº¢ç¥–
              \                            \
              é»‘å”                         é»‘å”</code></pre>
<br>

<p>CASE 3: </p>
<p>Description: çˆ¶ä¸ºå·¦å­ï¼ŒGPCä¸‰è§’å…³ç³»</p>
<p>Solution: å·¦æ—‹çˆ¶äº²ï¼Œäº¤æ¢PCï¼Œå³æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</p>
<pre><code class="java">         (1) å·¦æ—‹çˆ¶äº²ç»“ç‚¹ï¼Œå¹¶ä¸”äº¤æ¢çˆ¶å­èº«ä»½ï¼Œæ­¤æ—¶GPCä¸‰ç‚¹ä¸€çº¿
          é»‘ç¥–                        é»‘ç¥–                        é»‘ç¥–
          / \                         / \                        / \
       çº¢çˆ¶  é»‘å”    --(å·¦æ—‹)--&gt;    çº¢æ’  é»‘å”    --(äº¤æ¢)--&gt;    çº¢çˆ¶  é»‘å”
        \                          /                           /
        çº¢æ’                     çº¢çˆ¶                         çº¢æ’
        (2) å³æ—‹ç¥–çˆ¶ç»“ç‚¹
          é»‘ç¥–                        çº¢çˆ¶
          / \                         / \
       çº¢çˆ¶  é»‘å”    --(å³æ—‹)--&gt;    çº¢æ’  é»‘ç¥–
        /                                 \
      çº¢æ’                                é»‘å”
        (3) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²
          çº¢çˆ¶                        é»‘çˆ¶
          / \                         / \
       çº¢æ’  é»‘ç¥–    --(å˜è‰²)--&gt;    çº¢æ’  çº¢ç»„
              \                           \
              é»‘å”                        é»‘å”</code></pre>
<br>

<p>CASE 4</p>
<p>Description: çˆ¶ä¸ºå³å­ï¼ŒGPCä¸‰ç‚¹ä¸€çº¿</p>
<p>Solution: å·¦æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</p>
<pre><code class="java">         (1) å·¦æ—‹ç¥–çˆ¶ç»“ç‚¹
           é»‘ç¥–                        çº¢çˆ¶
           / \                         / \
        é»‘å”  çº¢çˆ¶    --(å³æ—‹)--&gt;    é»‘ç¥–  çº¢æ’
               \                     /
               çº¢æ’                é»‘å”
         (2) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²
           çº¢çˆ¶                        é»‘çˆ¶
           / \                         / \
        é»‘ç¥–  çº¢æ’    --(å˜è‰²)--&gt;    çº¢ç¥–  çº¢æ’
         /                           /
       é»‘å”                        é»‘å”</code></pre>
<br>

<p>CASE 5</p>
<p>Description: çˆ¶ä¸ºå³å­ï¼ŒGPCä¸‰è§’å…³ç³»</p>
<p>Solution: å³æ—‹çˆ¶äº²ï¼Œäº¤æ¢PCï¼Œå·¦æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²</p>
<pre><code class="java">          (1) å³æ—‹çˆ¶äº²ç»“ç‚¹ï¼Œå¹¶ä¸”äº¤æ¢çˆ¶å­èº«ä»½ï¼Œæ­¤æ—¶GPCä¸‰ç‚¹ä¸€çº¿
           é»‘ç¥–                        é»‘ç¥–                        é»‘ç¥–
           / \                         / \                        / \
        é»‘å”  çº¢çˆ¶    --(å³æ—‹)--&gt;    é»‘ç¥–  çº¢æ’    --(äº¤æ¢)--&gt;    é»‘ç¥–  çº¢çˆ¶
              /                            \                          \
            çº¢æ’                           çº¢çˆ¶                        çº¢æ’
          (2) å·¦æ—‹ç¥–çˆ¶
           é»‘ç¥–                        çº¢çˆ¶
           / \                         / \
        é»‘å”  çº¢çˆ¶    --(å·¦æ—‹)--&gt;    é»‘ç¥–  çº¢æ’
               \                    /
               çº¢æ’               é»‘å”
          (3) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²
           çº¢çˆ¶                        é»‘çˆ¶
           / \                         / \
        é»‘å”  çº¢æ’    --(å˜è‰²)--&gt;    çº¢ç¥–  çº¢æ’
         /                         /
       é»‘å”                      é»‘å”</code></pre>
<br>

<blockquote>
<p>â–åˆ é™¤ç»“ç‚¹</p>
</blockquote>
<p>ä¸‰ç§æƒ…å†µï¼Œè§£å†³æ–¹æ¡ˆä¸»è¦ä¸ºå¯»æ‰¾åè£”é¡¶æ›¿è‡ªå·±</p>
<p>CASE 1</p>
<p>Description: å¾…åˆ ç»“ç‚¹å·¦å­å’Œå³å­éƒ½å­˜åœ¨:</p>
<p>Solution: æ›¿ä»£ç»“ç‚¹ä¸ºå³å­æ ‘çš„æœ€å·¦å­©å­ï¼Œç„¶åè°ƒæ•´å…³ç³»</p>
<p>CASE 2:</p>
<p>Description: å¾…åˆ ç»“ç‚¹æ²¡æœ‰å·¦å­å’Œå³å­:</p>
<p>Solution: ç›´æ¥åˆ é™¤ï¼Œç„¶åè°ƒæ•´å…³ç³»</p>
<p>CASE 3:</p>
<p>Description: å¾…åˆ ç»“ç‚¹åªæœ‰å·¦å­æˆ–è€…å³å­:</p>
<p>Solution: æ›¿ä»£ç»“ç‚¹ä¸ºå­˜åœ¨çš„å­©å­ï¼Œç„¶åè°ƒæ•´å…³ç³»</p>
<br>

<blockquote>
<p>ğŸ’‰åˆ é™¤ä¿®å¤</p>
</blockquote>
<p>ä»…åˆ é™¤é»‘è‰²ç»“ç‚¹éœ€è¦ä¿®å¤ï¼Œåˆ é™¤çº¢è‰²ä¸éœ€è¦ã€‚</p>
<p>P-çˆ¶äº²ã€D-åˆ é™¤ã€B-å…„å¼Ÿã€BR-å…„å¼Ÿå³å­ã€BL-å…„å¼Ÿå·¦å­ã€‚</p>
<ul>
<li>Dä¸ºå·¦å­<ul>
<li>Bä¸ºçº¢è‰²ï¼šå·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue</li>
<li>Bä¸ºé»‘è‰²<ul>
<li>BLä¸ºé»‘è‰²ä¸”BRé»‘è‰²ï¼šå…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯</li>
<li>BLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå³æ—‹å…„å¼Ÿï¼Œå…„å¼ŸæŸ“çº¢ï¼ŒBLæŸ“é»‘</li>
<li>BRä¸ºçº¢è‰²ï¼šå·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBRé»‘åŒ–ï¼Œç„¶åbreak</li>
</ul>
</li>
</ul>
</li>
<li>Dä¸ºå³å­<ul>
<li>Bä¸ºçº¢è‰²ï¼šå³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue</li>
<li>Bä¸ºé»‘è‰²ï¼š<ul>
<li>BLä¸ºé»‘è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯</li>
<li>BLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå·¦æ—‹å…„å¼Ÿï¼Œçˆ¶äº²æŸ“çº¢ï¼ŒBRæŸ“é»‘</li>
<li>BLä¸ºçº¢è‰²ï¼šå³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBLé»‘åŒ–ï¼Œç„¶åbreak</li>
</ul>
</li>
</ul>
</li>
</ul>
<br>

<h2 id="ğŸ“‘-æºç "><a href="#ğŸ“‘-æºç " class="headerlink" title="ğŸ“‘ æºç "></a>ğŸ“‘ æºç </h2><pre><code class="java">package top.parak.DataStructures.RBTree;

import java.text.SimpleDateFormat;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicLong;

/**
 * &lt;p&gt; Project: Algorithm &lt;/P&gt;
 * &lt;p&gt; Package: top.parak.DataStructures.RBTree &lt;/p&gt;
 * &lt;p&gt; FileName: RBTree &lt;p&gt;
 * &lt;p&gt; Description: çº¢é»‘æ ‘ &lt;p&gt;
 * &lt;p&gt; Created By IntelliJ IDEA &lt;/p&gt;
 *
 * @author KHighness
 * @since 2020/11/5
 */

/* çº¢é»‘é¢œè‰² */
enum RBTColor &#123;
    red,
    black
&#125;

/* çº¢é»‘ç»“ç‚¹ */
class RBTNode&lt;T extends Comparable&lt;T&gt;, D&gt; &#123;

    /* ç»“ç‚¹é¢œè‰² */
    private RBTColor color;
    /* ç»“ç‚¹é”®å€¼ */
    private T key;
    /* ç»“ç‚¹æ•°æ® */
    private D data;
    /* çˆ¶äº²ç»“ç‚¹ */
    private RBTNode&lt;T, D&gt; parent;
    /* å·¦å­ç»“ç‚¹ */
    private RBTNode left;
    /* å³å­ç»“ç‚¹ */
    private RBTNode right;

    public RBTNode(RBTColor color, T key, D data, RBTNode&lt;T, D&gt; parent, RBTNode left, RBTNode right) &#123;
        this.color = color;
        this.key = key;
        this.data = data;
        this.parent = parent;
        this.left = left;
        this.right = right;
    &#125;

    public RBTColor getColor() &#123;
        if (this != null) &#123;
            return color;
        &#125;
        return null;
    &#125;

    public void setColor(RBTColor color) &#123;
        this.color = color;
    &#125;

    public void updateColor() &#123;
        if (this.color == RBTColor.red) &#123;
            this.color = RBTColor.black;
        &#125; else &#123;
            this.color = RBTColor.red;
        &#125;
    &#125;

    public T getKey() &#123;
        if (this != null) &#123;
            return key;
        &#125;
        return null;
    &#125;

    public void setKey(T key) &#123;
        this.key = key;
    &#125;

    public D getData() &#123;
        if (this != null) &#123;
            return data;
        &#125;
        return null;
    &#125;

    public void setData(D data) &#123;
        this.data = data;
    &#125;

    public RBTNode&lt;T, D&gt; getParent() &#123;
        return parent;
    &#125;

    public void setParent(RBTNode&lt;T, D&gt; parent) &#123;
        this.parent = parent;
    &#125;

    public RBTNode getLeft() &#123;
        if (this != null) &#123;
            return left;
        &#125;
        return null;
    &#125;

    public void setLeft(RBTNode left) &#123;
        this.left = left;
    &#125;

    public RBTNode getRight() &#123;
        if (this != null) &#123;
            return right;
        &#125;
        return null;
    &#125;

    public void setRight(RBTNode right) &#123;
        this.right = right;
    &#125;

    @Override
    public String toString() &#123;
        return &quot;RBTNode[&quot; +
                &quot;color=&quot; + color +
                &quot;, key=&quot; + key +
                &quot;, data=&quot; + data +
                &#39;]&#39;;
    &#125;
&#125;

/* çº¢é»‘æ ‘ */
public class RedBlackTree&lt;T extends Comparable&lt;T&gt;, D&gt; &#123;

    /* æ—¶é—´æ ¼å¼ */
    private static final SimpleDateFormat SDF = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);

    /* æ ¹èŠ‚ç‚¹ */
    private RBTNode&lt;T, D&gt; root;

    /* æ ‘ç»“ç‚¹æ•°é‡ */
    private AtomicLong count = new AtomicLong(0);


    /**
     * &lt;p&gt;è·å–æ—¶é—´&lt;/p&gt;
     * @return
     */
    private String getCurrentTime() &#123;
        return SDF.format(new Date());
    &#125;

    /**
     * &lt;p&gt;å¤§å°&lt;p/&gt;
     * @return
     */
    public long size() &#123;
        return count.get();
    &#125;

    /**
     * &lt;p&gt;æŸ¥è¯¢&lt;/p&gt;
     * @param key
     * @return
     */
    public D get(T key) &#123;
        RBTNode&lt;T, D&gt; node = search(key, this.root);
        return node == null ? null : node.getData();
    &#125;

    /**
     * &lt;p&gt;æ’å…¥&lt;/p&gt;
     * @param key
     * @param data
     */
    public void add(T key, D data) &#123;
        insertNode(key, data);
    &#125;

    /**
     * &lt;p&gt;åˆ é™¤&lt;/p&gt;
     * @param key
     */
    public void del(T key) &#123;
        RBTNode&lt;T, D&gt; node = search(key, this.root);
        if (node != null) &#123;
            deleteNode(node);
        &#125; else &#123;
            System.out.println(getCurrentTime() + &quot; [ERROR] &quot; + &quot;keyä¸º&quot; + key + &quot;çš„ç»“ç‚¹ä¸å­˜åœ¨&quot;);
        &#125;
    &#125;

    /**
     * &lt;p&gt;root-getter&lt;/p&gt;
     * @return
     */
    public RBTNode&lt;T, D&gt; getRoot() &#123;
        return root;
    &#125;

    /**
     * &lt;p&gt;åˆ¤æ–­ç»“ç‚¹æ˜¯å¦ä¸ºçº¢è‰²&lt;/p&gt;
     * @param node
     * @return
     */
    public Boolean isRed(RBTNode&lt;T, D&gt; node) &#123;
        return (node != null &amp;&amp; node.getColor() == RBTColor.red) ? true : false;
    &#125;

    /**
     * &lt;p&gt;åˆ¤æ–­ç»“ç‚¹æ˜¯å¦ä¸ºé»‘è‰²&lt;/p&gt;
     * @param node
     * @return
     */
    public Boolean isBlack(RBTNode&lt;T, D&gt; node) &#123;
        return (node == null || node.getColor() == RBTColor.black) ? true : false;
    &#125;

    /**
     * &lt;p&gt;æŸ¥è¯¢keyå€¼çš„ç»“ç‚¹&lt;/p&gt;
     * &lt;p&gt;é€’å½’æŸ¥è¯¢: æ¯”è¾ƒkeyï¼Œç›¸ç­‰ç›´æ¥è¿”å›ï¼Œè¿‡å¤§åˆ™ç»§ç»­å‘å³ï¼Œè¿‡å°åˆ™ç»§ç»­å‘å·¦&lt;/p&gt;
     * @param key
     * @param node
     * @return
     */
    public RBTNode&lt;T, D&gt; search(T key, RBTNode&lt;T, D&gt; node) &#123;
        if (node != null) &#123;
            int cmp = key.compareTo(node.getKey());
            if (cmp == 0) &#123;
                return node;
            &#125; else if (cmp &gt; 0) &#123;
                return search(key, node.getRight());
            &#125; else if (cmp &lt; 0) &#123;
                return search(key, node.getLeft());
            &#125;
        &#125;
        return null;
    &#125;

    /**
     * &lt;p&gt;å·¦æ—‹&lt;/p&gt;
     * &lt;p&gt;è¿‡ç¨‹ï¼šçˆ¶äº²ä¸‹æ²‰ï¼Œå³å­ä¸Šå‡ï¼Œå³å­çš„å·¦å­å˜ä¸ºåŸçˆ¶çš„å³å­&lt;/p&gt;
     * &lt;p&gt;
     *     å·¦æ—‹Xç»“ç‚¹
     *             P                                P
     *            /                                /
     *           X                                Y
     *         /  \        --(å·¦æ—‹)--&gt;           / \
     *       lX    Y                           X  rY
     *            / \                        /  \
     *          lY   rY                     lX  lY
     * &lt;/p&gt;
     * @param x
     */
    private void leftRotate(RBTNode&lt;T, D&gt; x) &#123;
        /* å³å­ç»“ç‚¹ */
        RBTNode&lt;T, D&gt; y = x.getRight();
        /* çˆ¶äº²ç»“ç‚¹ */
        RBTNode&lt;T, D&gt; p = x.getParent();

        /* Yçš„å·¦å­ å˜æˆ Xçš„å³å­
        * è‹¥Xä¸Yçš„å·¦å­ä¸ä¸ºç©º
        * åˆ™è®¾ç½®Yçš„å·¦å­çš„çˆ¶äº²ä¸ºX */
        x.setRight(y.getLeft());
        if (y.getLeft() != null) &#123;
            y.getLeft().setParent(x);
        &#125;

        /* è®¾ç½®Yçš„çˆ¶äº²ä¸ºP
        * 1. Pä¸ºç©ºï¼Œåˆ™æ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºY
        * 2. Xä¸ºPçš„å·¦å­ï¼Œ åˆ™Pçš„å·¦å­è®¾ç½®ä¸ºY
        * 3. Xä¸ºPçš„å³å­ï¼Œåˆ™Pçš„å³å­è®¾ç½®ä¸ºY */
        y.setParent(p);
        if (p == null) &#123;
            this.root = y;
        &#125; else &#123;
            if (p.getLeft() == x) &#123;
                p.setLeft(y);
            &#125; else &#123;
                p.setRight(y);
            &#125;
        &#125;

        /* å°†Xçš„çˆ¶äº²è®¾ç½®ä¸ºY
        * å°†Yçš„å·¦å­è®¾ç½®ä¸ºX */
        x.setParent(y);
        y.setLeft(x);
    &#125;

    /**
     * &lt;p&gt;å³æ—‹&lt;/p&gt;
     * &lt;p&gt;è¿‡ç¨‹ï¼šçˆ¶äº²ä¸‹æ²‰ï¼Œå·¦å­ä¸Šå‡ï¼Œå·¦å­çš„å³å­å˜æˆåŸçˆ¶çš„å·¦å­&lt;/p&gt;
     * &lt;p&gt;
     *     å³æ—‹Xç»“ç‚¹
     *             P                                P
     *            /                                /
     *           X                                Y
     *         /  \        --(å³æ—‹)--&gt;           /  \
     *        Y   rX                           lY   X
     *       / \                                   / \
     *     lY  rY                                rY  rX
     * &lt;/p&gt;
     * @param x
     */
    private void rightRotate(RBTNode&lt;T, D&gt; x) &#123;
        /* å·¦å­ç»“ç‚¹ */
        RBTNode&lt;T, D&gt; y = x.getLeft();
        /* çˆ¶äº²ç»“ç‚¹ */
        RBTNode&lt;T, D&gt; p = x.getParent();

        /* Yçš„å³å­ å˜æˆ Xçš„å·¦å­
        * è‹¥Yçš„å³å­ä¸ä¸ºç©º
        * åˆ™è®¾ç½®Yçš„å³å­çš„çˆ¶äº²ä¸ºX */
        x.setLeft(y.getRight());
        if (y.getRight() != null) &#123;
            y.getRight().setParent(x);
        &#125;

        /* è®¾ç½®Yçš„çˆ¶äº²ä¸ºP
         * 1. Pä¸ºç©ºï¼Œåˆ™æ ¹èŠ‚ç‚¹è®¾ç½®ä¸ºY
         * 2. Xä¸ºPçš„å·¦å­ï¼Œ åˆ™Pçš„å·¦å­è®¾ç½®ä¸ºY
         * 3. Xä¸ºPçš„å³å­ï¼Œåˆ™Pçš„å³å­è®¾ç½®ä¸ºY */
        y.setParent(p);
        if (p == null) &#123;
            this.root = y;
        &#125; else &#123;
            if (p.getLeft() == x) &#123;
                p.setLeft(y);
            &#125; else &#123;
                p.setRight(y);
            &#125;
        &#125;

        /* å°†Xçš„çˆ¶äº²è®¾ç½®ä¸ºY
        * å°†Yçš„å³å­è®¾ç½®ä¸ºX */
        x.setParent(y);
        y.setRight(x);
    &#125;

    /**
     * &lt;p&gt;æ’å…¥ç»“ç‚¹&lt;/p&gt;
     * @param key
     * @param data
     */
    private void insertNode(T key, D data) &#123;
        int cmp;
        RBTNode&lt;T, D&gt; x = this.root;
        RBTNode&lt;T, D&gt; y = null;

        /* å¯»æ‰¾æ–°ç»“ç‚¹çš„æ’å…¥ä½ç½® */
        while (x != null) &#123;
            y = x;
            cmp = key.compareTo(x.getKey());

            if (cmp == 0) &#123;
                /* keyå·²å­˜åœ¨ï¼Œç›´æ¥æ›´æ–° */
                System.out.println(getCurrentTime() + &quot; [WARN] keyå·²å­˜åœ¨&quot;);
                System.out.println(getCurrentTime() + &quot; [INFO] æ›´æ–°value: &quot; + get(key) + &quot; =&gt; &quot; + data);
                return;
            &#125; else if (cmp &gt; 0)&#123;
                /* keyè¾ƒå¤§ï¼Œç»§ç»­å‘å³æŸ¥è¯¢ */
                x = x.getRight();
            &#125; else if (cmp &lt; 0) &#123;
                /* keyè¾ƒå°ï¼Œç»§ç»­å‘å·¦æŸ¥è¯¢ */
                x = x.getLeft();
            &#125;
        &#125;

        /* ç”Ÿæˆä¸€ä¸ªæ–°çš„ç»“ç‚¹ */
        RBTNode&lt;T, D&gt; node = new RBTNode&lt;&gt;(RBTColor.red, key, data, null, null, null);
        System.out.println(getCurrentTime() + &quot; [INFO] æ–°å¢ç»“ç‚¹ (&quot; + key + &quot;, &quot; + data + &quot;)&quot;);
        /* æ€»ç»“ç‚¹æ•°é‡+1 */
        this.count.incrementAndGet();
        /* è®¾ç½®æ–°ç»“ç‚¹çš„çˆ¶äº²ä¸ºY */
        node.setParent(y);

        /* å†æ¬¡æ¯”è¾ƒå†³å®šæ–°ç»“ç‚¹æ˜¯yçš„å·¦å­è¿˜æ˜¯å³å­*/
        if (y == null) &#123;
            this.root = node;
        &#125; else &#123;
            cmp = key.compareTo(y.getKey());
            if (cmp &gt; 0) &#123;
                y.setRight(node);
            &#125; else &#123;
                y.setLeft(node);
            &#125;
        &#125;

        /* æœ€åè¿›è¡Œè‡ªå¹³è¡¡ */
        balanceInsertion(node);
    &#125;

    /**
     * &lt;p&gt;æ’å…¥ç»“ç‚¹çš„è‡ªå¹³è¡¡æ“ä½œ&lt;/p&gt;
     * &lt;p&gt;ç”±äºæ’å…¥èŠ‚ç‚¹é»˜è®¤é¢œè‰²ä¸ºçº¢è‰²ï¼Œæ‰€ä»¥åªæœ‰çˆ¶ç»“ç‚¹ä¸ºçº¢è‰²æ—¶å€™æ‰éœ€è¦ä¿®å¤
     *   åˆ†ä¸‰ç§æƒ…å†µè®¨è®º&lt;/p&gt;
     * &lt;li&gt;case1. å”å”ç»“ç‚¹ä¹Ÿä¸ºçº¢è‰²&lt;/li&gt;
     * &lt;li&gt;case2. å”å”ç»“ç‚¹ä¸ºç©ºï¼Œä¸”ç¥–çˆ¶å­ä¸‰ç‚¹ä¸€çº¿&lt;/li&gt;
     * &lt;li&gt;case3. å”å”ç»“ç‚¹ä¸ºç©ºï¼Œä¸”ç¥–çˆ¶å­ä¸‰è§’å…³ç³»&lt;/li&gt;
     * &lt;p&gt;G-ç¥–çˆ¶ã€P-çˆ¶äº²ã€U-å”å”ã€C-æ’å…¥&lt;/p&gt;
     * @param node
     */
    private void balanceInsertion(RBTNode&lt;T, D&gt; node) &#123;
        /* çˆ¶äº² Â· ç¥–çˆ¶ */
        RBTNode&lt;T, D&gt; paren, grand;

        /* å½“çˆ¶äº²èŠ‚ç‚¹ä¸ºé»‘è‰²æ—¶ï¼Œç»“æŸä¿®å¤ */
        while (((paren = node.getParent()) != null) &amp;&amp; isRed(paren)) &#123;
            grand = paren.getParent();

            /* ç¡®å®šçˆ¶äº²å’Œå”å”çš„å·¦å³å…³ç³» */

            /* CASE: çˆ¶å·¦å”å³ */
            if (grand.getLeft() == paren) &#123;
                RBTNode&lt;T, D&gt; uncle = grand.getRight();

                /**
                 * case1: PUåŒçº¢
                 * solution1: GPUå˜è‰²
                 * å¦‚æœæ­¤æ—¶æ•´æ£µæ ‘ä¸æ»¡è¶³çº¦æŸï¼Œåˆ™é€’å½’è¿›è¡ŒGPUå˜è‰²
                 */
                if (isRed(uncle)) &#123;
                    grand.setColor(RBTColor.red);
                    paren.setColor(RBTColor.black);
                    uncle.setColor(RBTColor.black);
                    node = grand;
                    continue;
                &#125;
                /*
                 * case2: Pçº¢Ué»‘ï¼Œçˆ¶ä¸ºå·¦å­ï¼ŒGPCä¸‰ç‚¹ä¸€çº¿
                 * solution2: å³æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²
                 *         (1) å³æ—‹ç¥–çˆ¶ç»“ç‚¹
                 *           é»‘ç¥–                        çº¢çˆ¶
                 *           / \                         / \
                 *        çº¢çˆ¶  é»‘å”    --(å³æ—‹)--&gt;    çº¢æ’  é»‘ç¥–
                 *         /                                 \
                 *       çº¢æ’                                é»‘å”
                 *         (2) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²
                 *           çº¢çˆ¶                        é»‘çˆ¶
                 *           / \                         / \
                 *        çº¢æ’  é»‘ç¥–    --(å˜è‰²)--&gt;    çº¢æ’  çº¢ç¥–
                 *              \                            \
                 *              é»‘å”                         é»‘å”
                 *
                 *
                * case3: Pçº¢Ué»‘ï¼Œçˆ¶ä¸ºå·¦å­ï¼ŒGPCä¸‰è§’å…³ç³»
                * solution3: å·¦æ—‹çˆ¶äº²ï¼Œäº¤æ¢PCï¼Œå³æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²
                *         (1) å·¦æ—‹çˆ¶äº²ç»“ç‚¹ï¼Œå¹¶ä¸”äº¤æ¢çˆ¶å­èº«ä»½ï¼Œæ­¤æ—¶GPCä¸‰ç‚¹ä¸€çº¿
                *          é»‘ç¥–                        é»‘ç¥–                        é»‘ç¥–
                *          / \                         / \                        / \
                *       çº¢çˆ¶  é»‘å”    --(å·¦æ—‹)--&gt;    çº¢æ’  é»‘å”    --(äº¤æ¢)--&gt;    çº¢çˆ¶  é»‘å”
                *        \                          /                           /
                *        çº¢æ’                     çº¢çˆ¶                         çº¢æ’
                *        (2) å³æ—‹ç¥–çˆ¶ç»“ç‚¹
                *          é»‘ç¥–                        çº¢çˆ¶
                *          / \                         / \
                *       çº¢çˆ¶  é»‘å”    --(å³æ—‹)--&gt;    çº¢æ’  é»‘ç¥–y
                *        /                                 \
                *      çº¢æ’                                é»‘å”
                *        (3) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²
                *          çº¢çˆ¶                        é»‘
                *          / \                         / \
                *       çº¢æ’  é»‘ç¥–    --(å˜è‰²)--&gt;    çº¢æ’  çº¢ç»„
                *              \                           \
                *              é»‘å”                        é»‘å”
                 *
                 * attention:
                 * ä¸‰è§’å…³ç³»ç»è¿‡ä¸€æ­¥æ—‹è½¬å³å¯è½¬æ¢æˆä¸‰ç‚¹ä¸€çº¿
                 * å› æ­¤case3å…ˆç»è¿‡ä¸€æ­¥å¤„ç†åˆ°case2ï¼Œå†è¿›è¡Œcase2çš„å¤„ç†
                 */
                else &#123;
                    if (paren.getRight() == node) &#123; // case3
                        leftRotate(paren);
                        RBTNode&lt;T, D&gt; temp = node;
                        node = paren;
                        paren = temp;
                    &#125; // case2
                    rightRotate(grand);
                    grand.updateColor();
                    paren.updateColor();
                &#125;
            &#125;
            /* CASE: çˆ¶å³å”å·¦ */
            else &#123;
                RBTNode&lt;T, D&gt; uncle = grand.getLeft();

                /**
                 * case1: PUåŒçº¢(çˆ¶äº²å’Œå”å”éƒ½ä¸ºçº¢è‰²)
                 * solution1: GPUå˜è‰²(ç¥–çˆ¶å˜ä¸ºçº¢è‰²ï¼Œçˆ¶äº²å’Œå”å”éƒ½å˜ä¸ºé»‘è‰²)
                 * å¦‚æœæ­¤æ—¶æ•´æ£µæ ‘ä¸æ»¡è¶³çº¦æŸï¼Œåˆ™é€’å½’è¿›è¡ŒGPUå˜è‰²
                 */
                if (isRed(uncle)) &#123;
                    grand.setColor(RBTColor.red);
                    paren.setColor(RBTColor.black);
                    uncle.setColor(RBTColor.black);
                    node = grand;
                    continue;
                &#125;
                /*
                 * case4: Pçº¢Ué»‘ï¼Œçˆ¶ä¸ºå·¦å­ï¼ŒGPCä¸‰ç‚¹ä¸€çº¿
                 * solution4: å·¦æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²
                 *         (1) å·¦æ—‹ç¥–çˆ¶ç»“ç‚¹
                 *           é»‘ç¥–                        çº¢çˆ¶
                 *           / \                         / \
                 *        é»‘å”  çº¢çˆ¶    --(å³æ—‹)--&gt;    é»‘ç¥–  çº¢æ’
                 *               \                     /
                 *               çº¢æ’                é»‘å”
                 *          (2) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²
                 *           çº¢çˆ¶                        é»‘çˆ¶
                 *           / \                         / \
                 *        é»‘ç¥–  çº¢æ’    --(å˜è‰²)--&gt;    çº¢ç¥–  çº¢æ’
                 *         /                           /
                 *       é»‘å”                        é»‘å”
                 *
                 * case5: Pçº¢Ué»‘ï¼Œçˆ¶ä¸ºå³å­ï¼ŒGPCä¸‰è§’å…³ç³»
                 * solution5: å³æ—‹çˆ¶äº²ï¼Œäº¤æ¢PCï¼Œå·¦æ—‹ç¥–çˆ¶ï¼ŒGPå˜è‰²
                 *          (1) å³æ—‹çˆ¶äº²ç»“ç‚¹ï¼Œå¹¶ä¸”äº¤æ¢çˆ¶å­èº«ä»½ï¼Œæ­¤æ—¶GPCä¸‰ç‚¹ä¸€çº¿
                 *           é»‘ç¥–                        é»‘ç¥–                        é»‘ç¥–
                 *           / \                         / \                        / \
                 *        é»‘å”  çº¢çˆ¶    --(å³æ—‹)--&gt;    é»‘ç¥–  çº¢æ’    --(äº¤æ¢)--&gt;    é»‘ç¥–  çº¢çˆ¶
                 *              /                            \                          \
                 *            çº¢æ’                           çº¢çˆ¶                        çº¢æ’
                 *          (2) å·¦æ—‹ç¥–çˆ¶
                 *           é»‘ç¥–                        çº¢çˆ¶
                 *           / \                         / \
                 *        é»‘å”  çº¢çˆ¶    --(å·¦æ—‹)--&gt;    é»‘ç¥–  çº¢æ’
                 *               \                    /
                 *               çº¢æ’               é»‘å”
                 *          (3) ç¥–çˆ¶å’Œçˆ¶äº²å˜è‰²
                 *           çº¢çˆ¶                        é»‘çˆ¶
                 *           / \                         / \
                 *        é»‘å”  çº¢æ’    --(å˜è‰²)--&gt;    çº¢ç¥–  çº¢æ’
                 *         /                         /
                 *       é»‘å”                      é»‘å”
                 *
                 * attention:
                 * ä¸‰è§’å…³ç³»ç»è¿‡ä¸€æ­¥æ—‹è½¬å³å¯è½¬æ¢æˆä¸‰ç‚¹ä¸€çº¿
                 * å› æ­¤case3å…ˆç»è¿‡ä¸€æ­¥å¤„ç†åˆ°case2ï¼Œå†è¿›è¡Œcase2çš„å¤„ç†
                 */
                else &#123;
                    if (paren.getLeft() == node) &#123; // case3
                        rightRotate(paren);
                        RBTNode&lt;T, D&gt; temp = node;
                        node = paren;
                        paren = temp;
                    &#125; // case2
                    leftRotate(grand);
                    grand.updateColor();
                    paren.updateColor();
                &#125;
            &#125;
        &#125;

        /* ä¿è¯æ ¹èŠ‚ç‚¹ä¸ºé»‘è‰² */
        if (root == node) &#123;
            node.setColor(RBTColor.black);
        &#125;
    &#125;

    /**
     * &lt;p&gt;åˆ é™¤ç»“ç‚¹&lt;/p&gt;
     * &lt;p&gt;ä¸‰ç§æƒ…å†µ&lt;/p&gt;
     * &lt;li&gt;case1. å¾…åˆ ç»“ç‚¹å·¦å­å’Œå³å­éƒ½å­˜åœ¨&lt;/li&gt;
     * &lt;li&gt;case2. å¾…åˆ ç»“ç‚¹æ²¡æœ‰å·¦å­å’Œå³å­&lt;/li&gt;
     * &lt;li&gt;case3. å¾…åˆ ç»“ç‚¹åªæœ‰å·¦å­æˆ–è€…å³å­&lt;/li&gt;
     * @param node
     */
    private void deleteNode(RBTNode&lt;T, D&gt; node) &#123;
        /* çˆ¶äº² Â· å„¿å­ Â· ç»§æ‰¿è€… */
        RBTNode&lt;T, D&gt; paren, child, replace;
        RBTColor color;

        /*
         * case1: å¾…åˆ ç»“ç‚¹å·¦å­å’Œå³å­éƒ½å­˜åœ¨
         * solution1:
         * - æ‰¾åˆ°è¯¥ç»“ç‚¹çš„å³å­æ ‘ä¸­çš„æœ€å·¦å­ç»“ç‚¹
         * - æŠŠå®ƒçš„å€¼å’Œè¦åˆ é™¤çš„ç»“ç‚¹çš„å€¼è¿›è¡Œäº¤æ¢
         * - ç„¶ååˆ é™¤è¿™ä¸ªç»“ç‚¹å³ç›¸å½“äºåˆ é™¤æ‰€éœ€åˆ é™¤ç»“ç‚¹
         */
        if ((node.getLeft() != null) &amp;&amp; (node.getRight() != null))  &#123;

            /*  è·å–å…¶åç»§ç»“ç‚¹: å³å­æ ‘ä¸­çš„æœ€å·¦å­ç»“ç‚¹ */
            replace = descendants(node);
            paren = replace.getParent();
            child = replace.getRight();
            color = replace.getColor();

            if (node == replace.getParent()) &#123;
                /**
                 * case:
                 *    node              replace
                 *      \                  \
                 *      replace    --&gt;    child
                 *         \
                 *         child
                 */
                paren = replace;
            &#125; else &#123;
                /**
                 * case:
                 *     node                replace
                 *       \                   \
                 *        X                   X
                 *       / \                 / \
                 *  paren   X    --&gt;    paren   X
                 *     /                  /
                 *  replace            child
                 *     \
                 *     child
                 *
                 */
                /* å»ºç«‹æ›¿ä»£ç»“ç‚¹çš„çˆ¶äº²ä¸æ›¿æ¢ç»“ç‚¹çš„å³å­çš„çˆ¶å­å…³ç³»ï¼Œå³çˆ·å­™å¤‰çˆ¶å­ */
                if (child != null) &#123;
                    child.setParent(replace.getParent());
                &#125;
                replace.getParent().setLeft(child);
                /* å»ºç«‹æ›¿ä»£èŠ‚ç‚¹ä¸å¾…åˆ èŠ‚ç‚¹çš„å³å­çš„çˆ¶å­å…³ç³» */
                replace.setRight(node.getRight());
                node.getRight().setParent(replace);
            &#125;

            /* å¾…åˆ èŠ‚ç‚¹çš„çˆ¶äº²è®¾ç½®ä¸ºæ›¿ä»£ç»“ç‚¹çš„çˆ¶äº² */
            replace.setParent(node.getParent());
            /* å»ºç«‹æ›¿æ¢ç»“ç‚¹ä¸å¾…åˆ èŠ‚ç‚¹å·¦å­çš„çˆ¶å­å…³ç³» */
            replace.setLeft(node.getLeft());
            node.getLeft().setParent(replace);
            /* æ›¿ä»£ç»“ç‚¹æ²¿ç”¨å¾…åˆ èŠ‚ç‚¹çš„é¢œè‰² */
            replace.setColor(node.getColor());

            /* å¾…åˆ ç»“ç‚¹çš„çˆ¶äº²ä¸ä¸ºç©ºï¼Œåˆ™è°ƒæ•´å·¦å³å­ */
            if (node.getParent() != null) &#123;
                if (node.getParent().getLeft() == node) &#123;
                    node.getParent().setLeft(replace);
                &#125; else &#123;
                    node.getParent().setRight(replace);
                &#125;
            &#125;
            /* å¾…åˆ ç»“ç‚¹çš„çˆ¶äº²ä¸ºç©ºï¼Œåˆ™è®¾ç½®æ ¹ç»“ç‚¹ */
            else &#123;
                this.root = replace;
            &#125;

            /* åˆ é™¤é»‘è‰²ç»“ç‚¹éœ€è¦è°ƒæ•´å¹³è¡¡ï¼Œçº¢è‰²ä¸éœ€è¦ */
            if (color == RBTColor.black) &#123;
                balanceDeletion(child, paren);
            &#125;
        &#125;
        /**
         * case2: å¾…åˆ ç»“ç‚¹æ²¡æœ‰å·¦å­å’Œå³å­
         * solution2: ç›´æ¥åˆ é™¤ç»“ç‚¹
         */
        else if((node.getLeft() == null) &amp;&amp; (node.getRight() == null)) &#123;
            paren = node.getParent();
            if (node == paren.getLeft()) &#123;
                paren.setLeft(node.getLeft());
            &#125; else &#123;
                paren.setRight(node.getRight());
            &#125;
        &#125;
        /**
         * case3: å¾…åˆ ç»“ç‚¹åªæœ‰å·¦å­æˆ–è€…å³å­
         * solution3: å¾…åˆ èŠ‚ç‚¹çš„çˆ¶äº²æŒ‡å‘å­˜åœ¨çš„å­å—£
         */
        else &#123;
            /* ç¡®å®šæ›¿ä»£ç»“ç‚¹ */
            if (node.getLeft() != null) &#123;
                replace = node.getLeft();
            &#125; else &#123;
                replace = node.getRight();
            &#125;

            /* å¾…åˆ ç»“ç‚¹çš„çˆ¶äº² */
            paren = node.getParent();

            /* å¾…åˆ ç»“ç‚¹çš„çˆ¶äº²æ˜¯å¦ä¸ºç©º */
            if (paren != null) &#123;
                if (paren.getLeft() == node) &#123;
                    paren.setLeft(replace);
                &#125; else &#123;
                    paren.setRight(replace);
                &#125;
            &#125; else &#123;
                this.root = replace;
            &#125;

            /* å¾…åˆ èŠ‚ç‚¹çš„çˆ¶äº²æŒ‡å‘æ›¿ä»£ç»“ç‚¹ */
            replace.setParent(paren);

            color = node.getColor();
            child = replace;

            /* åˆ é™¤é»‘è‰²ç»“ç‚¹éœ€è¦è°ƒæ•´å¹³è¡¡ï¼Œçº¢è‰²ä¸éœ€è¦ */
            if (color == RBTColor.black) &#123;
                balanceDeletion(child, paren);
            &#125;
        &#125;

        /* ç»“ç‚¹æ•°é‡-1 */
        count.decrementAndGet();
        System.out.println(getCurrentTime() + &quot; [INFO] keyä¸º&quot; + node.getKey() + &quot;çš„ç»“ç‚¹åˆ é™¤æˆåŠŸ&quot;);
    &#125;

    /**
     * &lt;p&gt;å¯»æ‰¾ç»§æ‰¿çš„åè£”&lt;/p&gt;
     * @param node
     * @return
     */
    public RBTNode&lt;T, D&gt; descendants(RBTNode&lt;T, D&gt; node) &#123;
        /* æŸ¥è¯¢å¤§äºè¯¥èŠ‚ç‚¹çš„æœ€å°ç»“ç‚¹ï¼Œå³å³å­æ ‘çš„æœ€å·¦ç»“ç‚¹ */
        if (node.getRight() != null) &#123;
            RBTNode&lt;T, D&gt; right = node.getRight();
            if (right.getLeft() == null) &#123;
                return right;
            &#125;
            while (right.getLeft() != null) &#123;
                right = right.getLeft();
            &#125;
            return right;
        &#125;

        /* @deprecated */
        RBTNode&lt;T, D&gt; paren = node.getParent();
        while ((paren != null) &amp;&amp; (paren.getRight() == node)) &#123;
            node = paren;
            paren = paren.getParent();
        &#125;
        return paren;
    &#125;


    /**
     * &lt;p&gt;åˆ é™¤ç»“ç‚¹çš„è‡ªå¹³è¡¡æ“ä½œ&lt;/p&gt;
     * &lt;p&gt;
     * P-çˆ¶äº²ã€D-åˆ é™¤ã€B-å…„å¼Ÿã€BR-å…„å¼Ÿå³å­ã€BL-å…„å¼Ÿå·¦å­ã€‚
     *
     * - Dä¸ºå·¦å­
     *   - Bä¸ºçº¢è‰²ï¼šå·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue
     *   - Bä¸ºé»‘è‰²
     *     - BLä¸ºé»‘è‰²ä¸”BRé»‘è‰²ï¼šå…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯
     *     - BLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå³æ—‹å…„å¼Ÿï¼Œå…„å¼ŸæŸ“çº¢ï¼ŒBLæŸ“é»‘
     *     - BRä¸ºçº¢è‰²ï¼šå·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBRé»‘åŒ–ï¼Œç„¶åbreak
     * - Dä¸ºå³å­
     *   - Bä¸ºçº¢è‰²ï¼šå³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue
     *   - Bä¸ºé»‘è‰²ï¼š
     *     - BLä¸ºé»‘è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯
     *     - BLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²ï¼šå·¦æ—‹å…„å¼Ÿï¼Œçˆ¶äº²æŸ“çº¢ï¼ŒBRæŸ“é»‘
     *     - BLä¸ºçº¢è‰²ï¼šå³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBLé»‘åŒ–ï¼Œç„¶åbreak
     * &lt;/p&gt;
     *
     * @param node
     * @param paren
     * &lt;p&gt;
     *     å…¥å‚æƒ…å†µ:
     *     1. node=æ›¿æ¢èŠ‚ç‚¹ paren=æ›¿æ¢èŠ‚ç‚¹çš„çˆ¶äº²èŠ‚ç‚¹
     *     2. node=æ›¿æ¢èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹ paren=æ›¿æ¢èŠ‚ç‚¹
     *     3. node=æ›¿æ¢èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹ parent=æ›¿æ¢èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹
     * &lt;/p&gt;
     */
    private void balanceDeletion(RBTNode&lt;T, D&gt; node, RBTNode&lt;T, D&gt; paren) &#123;
        RBTNode&lt;T, D&gt; broth;

        while (isBlack(node) &amp;&amp; node != this.root) &#123;

            if (paren.getLeft() == node) &#123;
                broth = paren.getRight();

                /**
                 * case1: Dä¸ºå·¦å­ã€‚Bä¸ºçº¢è‰²
                 * solution1: å·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue
                 */
                if (isRed(broth)) &#123;
                    leftRotate(paren);
                    paren.setColor(RBTColor.red);
                    broth.setColor(RBTColor.black);
                    continue;
                &#125; else &#123;
                    /**
                     * case2: Dä¸ºå·¦å­ã€‚Bä¸ºé»‘è‰²ï¼ŒBLä¸ºé»‘è‰²ä¸”BRä¸ºé»‘è‰²
                     * solution2: å…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯
                     */
                    if (isBlack(broth.getLeft()) &amp;&amp; isBlack(broth.getRight())) &#123;
                        broth.setColor(RBTColor.red);
                        node = paren;
                        paren = paren.getParent();
                    &#125;
                    /**
                     * case3: Dä¸ºå·¦å­ã€‚Bä¸ºé»‘è‰²ï¼ŒBLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²
                     * solution3: å³æ—‹å…„å¼Ÿï¼Œå…„å¼ŸæŸ“çº¢ï¼ŒBLæŸ“é»‘
                     */
                    else if (isRed(broth.getLeft()) &amp;&amp; isBlack(broth.getRight())) &#123;
                        rightRotate(broth);
                        broth.setColor(RBTColor.red);
                        broth.getLeft().setColor(RBTColor.black);
                    &#125;
                    /**
                     * case4: Dä¸ºå·¦å­ï¼ŒBä¸ºé»‘è‰²ï¼ŒBRä¸ºçº¢è‰²
                     * solution4: å·¦æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBRé»‘åŒ–ï¼Œç„¶åbreak
                     */
                    else if (isRed(broth.getRight())) &#123;
                        leftRotate(paren);
                        broth.setColor(paren.getColor());
                        paren.setColor(RBTColor.black);
                        broth.getRight().setColor(RBTColor.black);
                        break;
                    &#125;
                &#125;
            &#125; else &#123;
                broth = paren.getLeft();

                /**
                 * case5: Dä¸ºå³å­ã€‚Bä¸ºçº¢è‰²
                 * solution5: å³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²æŸ“çº¢ï¼Œå…„å¼ŸæŸ“é»‘ï¼Œç„¶åcontinue
                 */
                if (isRed(broth)) &#123;
                    rightRotate(paren);
                    paren.setColor(RBTColor.red);
                    broth.setColor(RBTColor.black);
                &#125; else &#123;
                    /**
                     * case6: Dä¸ºå³å­ã€‚Bä¸ºé»‘è‰²ï¼ŒBLä¸ºé»‘è‰²ä¸”BRä¸ºé»‘è‰²
                     * solution6: å…„å¼ŸæŸ“çº¢ï¼Œçˆ¶äº²å›æº¯
                     */
                    if (isBlack(broth.getLeft()) &amp;&amp; isBlack(broth.getRight())) &#123;
                        broth.setColor(RBTColor.red);
                        node = paren;
                        paren = paren.getParent();
                    &#125;
                    /**
                     * case7: Dä¸ºå³å­ã€‚Bä¸ºé»‘è‰²ï¼ŒBLä¸ºçº¢è‰²ä¸”BRä¸ºé»‘è‰²
                     * solution7: å·¦æ—‹å…„å¼Ÿï¼Œçˆ¶äº²æŸ“çº¢ï¼ŒBRæŸ“é»‘
                     */
                    else if (isRed(broth.getLeft()) &amp;&amp; isBlack(broth.getRight())) &#123;
                        leftRotate(broth);
                        paren.setColor(RBTColor.red);
                        broth.getRight().setColor(RBTColor.black);
                    &#125;
                    /**
                     * case8: Dä¸ºå³å­ï¼ŒBä¸ºé»‘è‰²ï¼ŒBRä¸ºçº¢è‰²
                     * solution8: å³æ—‹çˆ¶äº²ï¼Œçˆ¶äº²çš„é¢œè‰²ç»™å…„å¼Ÿï¼Œçˆ¶äº²é»‘åŒ–ï¼ŒBLé»‘åŒ–ï¼Œç„¶åbreak
                     */
                    else if (isRed(broth.getRight())) &#123;
                        rightRotate(paren);
                        broth.setColor(paren.getColor());
                        paren.setColor(RBTColor.black);
                        broth.getRight().setColor(RBTColor.black);
                        break;
                    &#125;
                &#125;
            &#125;

        &#125;

        /* nodeæŸ“æˆè¢«åˆ ç»“ç‚¹çš„é¢œè‰² */
        node.setColor(RBTColor.black);
    &#125;

    /**
     * &lt;p&gt;å±‚æ¬¡éå†&lt;/p&gt;
     */
    public void levelOrder() &#123;
        List&lt;List&lt;RBTNode&lt;T, D&gt;&gt;&gt; levelList = levelOrder(this.root);
        for (List&lt;RBTNode&lt;T, D&gt;&gt; list:levelList) &#123;
            for (RBTNode node : list) &#123;
                System.out.print(node.getKey() + &quot; &quot;);
            &#125;
            System.out.println();
        &#125;
    &#125;

    /**
     * &lt;p&gt;å±‚æ¬¡éå†&lt;/p&gt;
     * @param node
     * @return
     */
    private List&lt;List&lt;RBTNode&lt;T, D&gt;&gt;&gt; levelOrder(RBTNode&lt;T, D&gt; node) &#123;
        List&lt;List&lt;RBTNode&lt;T, D&gt;&gt;&gt; res = new LinkedList&lt;&gt;();
        Queue&lt;RBTNode&lt;T, D&gt;&gt; queue = new LinkedList&lt;&gt;();
        queue.add(node);
        while (!queue.isEmpty()) &#123;
            int count = queue.size();
            List&lt;RBTNode&lt;T, D&gt;&gt; cur = new LinkedList&lt;&gt;();
            while (count != 0) &#123;
                RBTNode&lt;T, D&gt; temp = queue.poll();
                cur.add(temp);
                if (temp.getLeft() != null) queue.add(temp.getLeft());
                if (temp.getRight() != null) queue.add(temp.getRight());
                count--;
            &#125;
            res.add(cur);
        &#125;
        return res;
    &#125;

    /**
     * &lt;p&gt;è¾“å‡ºçº¢é»‘æ ‘çš„å±‚çº§ç»“æ„&lt;/p&gt;
     */
    public void printRBTreeLevel() &#123;
        System.out.println(getCurrentTime() + &quot; [INFO] å¼€å§‹æ‰“å°çº¢é»‘æ ‘çš„å±‚çº§ç»“æ„&quot;);
        ConcurrentHashMap&lt;Integer, List&lt;RBTNode&gt;&gt; map = showTree();
        int size = map.size();

        for (int i = 0; i &lt; map.size(); i++) &#123;
            System.out.println();
            for (int j = 0; j &lt; map.get(i).size(); j++) &#123;
                System.out.print( makeSpace(size, i) +
                        (map.get(i).get(j).getKey() == null ? &quot; &quot; : (map.get(i).get(j).getKey()) + (map.get(i).get(j).getColor() == RBTColor.black ? &quot;(é»‘)&quot; : &quot;(çº¢)&quot;)) + makeSpace(size, i));
            &#125;
            System.out.println();
        &#125;
        System.out.println(getCurrentTime() + &quot; [INFO] çº¢é»‘æ ‘çš„å±‚çº§ç»“æ„æ‰“å°å®Œæ¯•&quot;);
    &#125;

    /**
     * &lt;p&gt;è¾“å‡ºæ•´æ£µæ ‘çš„Graphvizç»“æ„&lt;/p&gt;
     */
    public void printGraphviz()&#123;
        System.out.println(getCurrentTime() + &quot; [INFO] å¼€å§‹æ‰“å°æ ‘çš„Graphvizç»“æ„&quot;);
        ConcurrentHashMap&lt;Integer, List&lt;RBTNode&gt;&gt; map = showTree();
        int size = map.size();
        System.out.println(&quot;digraph &#123;&quot;);
        for (int i = 0; i &lt; map.size(); i++) &#123;
            for (int j = 0; j &lt; map.get(i).size(); j++) &#123;
                if(map.get(i).get(j).getKey() != null)&#123;
                    System.out.println(map.get(i).get(j).getKey() + &quot; [color=&quot;  + (map.get(i).get(j).getColor()) + &quot;] &quot;);
                &#125;
            &#125;
        &#125;

        for (int i = 0; i &lt; map.size(); i++) &#123;
            for (int j = 0; j &lt; map.get(i).size(); j++) &#123;
                if(map.get(i).get(j).getKey() != null)&#123;
                    if(map.get(i).get(j).getLeft() != null)&#123;
                        System.out.println(map.get(i).get(j).getKey() + &quot;-&gt;&quot; + map.get(i).get(j).getLeft().getKey() + &quot;[label=left]&quot;);
                    &#125;
                    if(map.get(i).get(j).getRight() != null)&#123;
                        System.out.println(map.get(i).get(j).getKey() + &quot;-&gt;&quot; + map.get(i).get(j).getRight().getKey() + &quot;[label=right]&quot;);
                    &#125;
                &#125;
            &#125;
        &#125;
        System.out.println(&quot;&#125;&quot;);
        System.out.println(getCurrentTime() + &quot; [INFO] æ ‘çš„Graphvizç»“æ„æ‰“å°å®Œæ¯•&quot;);
    &#125;

    public String makeSpace(int size, int index)&#123;
        StringBuilder builder = new StringBuilder();
        for (int i = 0; i &lt; 1 &lt;&lt; (size - index); i++) &#123;
            builder.append(&quot;  &quot;);
        &#125;
        return builder.toString();
    &#125;

    public ConcurrentHashMap&lt;Integer, List&lt;RBTNode&gt;&gt; showTree()&#123;
        ConcurrentHashMap&lt;Integer, List&lt;RBTNode&gt;&gt; map = new ConcurrentHashMap&lt;&gt;();
        showTree(root, 0, map);
        return map;
    &#125;

    public void showTree(RBTNode root, int count, ConcurrentHashMap&lt;Integer, List&lt;RBTNode&gt;&gt; map)&#123;
        if (map.get(count) == null)&#123;
            map.put(count, new ArrayList&lt;&gt;());
        &#125;
        map.get(count).add(root);

        if (root.getLeft() != null)&#123;
            showTree(root.getLeft(), count+1 , map);
        &#125; else&#123;
            if(map.get(count+1) == null)&#123;
                map.put(count+1, new ArrayList&lt;&gt;());
            &#125;
            map.get(count+1).add(new RBTNode(RBTColor.red, null, null, null, null, null));
        &#125;
        if (root.getRight() != null)&#123;
            showTree(root.getRight(), count+1 , map);
        &#125; else&#123;
            if(map.get(count+1) == null)&#123;
                map.put(count+1, new ArrayList&lt;&gt;());
            &#125;
            map.get(count+1).add(new RBTNode(RBTColor.red, null, null, null, null, null));
        &#125;
    &#125;


    /**
     * &lt;p&gt;èœå•&lt;/p&gt;
     */
    public void RBT() &#123;
        RedBlackTree KTree = new RedBlackTree();
        Scanner scanner = new Scanner(System.in);
        while (true) &#123;
            System.out.println((&quot;â”â”â”â”â”â”â”â”â”â” â–¶ â–¶ â–¶ â–¶ â–¶ RED â¤ BLACK â—€ â—€ â—€ â—€ â—€ â”â”â”â”â”â”â”â”â”â”â”“&quot;));
            System.out.println((&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 1. æ’å…¥èŠ‚ç‚¹ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;));
            System.out.println((&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 2. æŸ¥è¯¢èŠ‚ç‚¹ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;));
            System.out.println((&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 3. åˆ é™¤ç»“ç‚¹ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;));
            System.out.println((&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 4. æŸ¥è¯¢æ•°é‡ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;));
            System.out.println((&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 5. å±‚æ¬¡ç»“æ„ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;));
            System.out.println((&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 6. Graphviz â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;));
            System.out.println((&quot;   âœªâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 7. é€€å‡ºç³»ç»Ÿ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âœª&quot;));
            System.out.println((&quot;â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›&quot;));

            System.out.print(getCurrentTime() + &quot; [input] è¾“å…¥é€‰æ‹©ï¼š&quot;);
            int choice = scanner.nextInt();
            int key;
            String value;
            switch (choice) &#123;
                case 1:
                    System.out.print(getCurrentTime() + &quot; [INPUT] è¾“å…¥é”®å€¼ï¼š&quot;);
                    key = scanner.nextInt();
                    System.out.print(getCurrentTime() + &quot; [INPUT] è¾“å…¥æ•°æ®ï¼š&quot;);
                    value = scanner.next();
                    KTree.add(key, value);
                    break;
                case 2:
                    System.out.print(getCurrentTime() + &quot; [INPUT] è¾“å…¥é”®å€¼ï¼š&quot;);
                    key = scanner.nextInt();
                    System.out.println(getCurrentTime() + &quot; [INFO] æŸ¥è¯¢ç»“æœ value = &quot; + KTree.get(key));
                    break;
                case 3:
                    System.out.print(getCurrentTime() + &quot; [INPUT] è¾“å…¥é”®å€¼ï¼š&quot;);
                    key = scanner.nextInt();
                    KTree.del(key);
                    break;
                case 4:
                    System.out.println(getCurrentTime() + &quot; [INFO] æŸ¥è¯¢ç»“æœ size = &quot; + KTree.size());
                    break;
                case 5:
                    KTree.printRBTreeLevel();
                    break;
                case 6:
                    KTree.printGraphviz();
                    break;
                case 7:
                    System.out.println(getCurrentTime() + &quot; [INFO] é€€å‡ºæˆåŠŸ&quot;);
                    System.exit(0);
                default:
                    System.out.println(getCurrentTime() + &quot; [ERROR] è¾“å…¥é”™è¯¯&quot;);
                    break;
            &#125;
        &#125;
    &#125;


    public static void main(String[] args) &#123;
        RedBlackTree redBlackTree = new RedBlackTree();
        redBlackTree.RBT();
    &#125;
&#125;</code></pre>
]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
      <tags>
        <tag>RedBlackTree</tag>
      </tags>
  </entry>
  <entry>
    <title>å¶æƒ ç¾</title>
    <url>/posts/f8cdfd0a/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/f8cdfd0a/MyCD.jpg" class="" title="MyCD">


        <div id="aplayer-zowbuDEl" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>
			  <script>
				  var options = {"narrow":false,"autoplay":false,"showlrc":1,"mode":"oredr","mutex":true,"theme":"#e6d0b2","preload":"metadata","listmaxheight":"513px","music":[{"title":"ä»¥çˆ¶ä¹‹å","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/ä»¥çˆ¶ä¹‹å.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"ä»¥çˆ¶ä¹‹å.txt"},{"title":"æ‡¦å¤«","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/æ‡¦å¤«.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"æ‡¦å¤«.txt"},{"title":"æ™´å¤©","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/æ™´å¤©.flac","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"æ™´å¤©.txt"},{"title":"ä¸‰å¹´äºŒç­","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/ä¸‰å¹´äºŒç­.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"ä¸‰å¹´äºŒç­.txt"},{"title":"ä¸œé£ç ´","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/ä¸œé£ç ´.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"ä¸œé£ç ´.txt"},{"title":"ä½ å¬å¾—åˆ°","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/ä½ å¬å¾—åˆ°.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"ä½ å¬å¾—åˆ°.txt"},{"title":"åŒä¸€ç§è°ƒè°ƒ","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/åŒä¸€ç§è°ƒè°ƒ.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"åŒä¸€ç§è°ƒè°ƒ.txt"},{"title":"å¥¹çš„ç«æ¯›","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/å¥¹çš„ç«æ¯›.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"å¥¹çš„ç«æ¯›.txt"},{"title":"çˆ±æƒ…æ‚¬å´–","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/çˆ±æƒ…æ‚¬å´–.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"çˆ±æƒ…æ‚¬å´–.txt"},{"title":"æ¢¯ç”°","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/æ¢¯ç”°.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"æ¢¯ç”°.txt"},{"title":"åŒåˆ€","author":"å‘¨æ°ä¼¦","url":"/posts/f8cdfd0a/åŒåˆ€.ogg","pic":"/posts/f8cdfd0a/YHM.jpg","lrc":"åŒåˆ€.txt"}]};
				  options.element = document.getElementById("aplayer-zowbuDEl");
				  var ap = new APlayer(options);
			    window.aplayers || (window.aplayers = []);
				  window.aplayers.push(ap);
			  </script>



<a id="more"></a>



<center>
<p>å¬å¦ˆå¦ˆçš„è¯ï¼Œä½ æ¯”ä»å‰å¿«ä¹ï¼›</p>
<p>å¬çˆ¸çˆ¸çš„è¯ï¼Œçˆ¸ï¼Œæˆ‘å›æ¥äº†ã€‚</p>
<p>æˆ‘æŠŠçˆ·çˆ·æ³¡çš„èŒ¶ï¼Œé€ç»™å¤©å°çš„å¤–å©†ï¼›</p>
<p>å¥¹åŠ äº†ç‚¹éº¦èŠ½ç³–ï¼Œå‘³é“å˜å¾—ç”œç”œçš„ã€‚</p>
<p>æ«æ—å¤œæ›²è¯‰ç´ä¼¤ï¼Œæ¢¯ç”°èŠ±æµ·ä¸ƒé‡Œé¦™ã€‚</p>
<p>å¤§ç¬¨é’Ÿè¿·é­‚æ›²åœ¨æˆ‘çš„åœ°ç›˜ï¼Œåˆå¥æ­¢æˆ˜ä¹‹æ®‡ã€‚</p>
<p>ç¨»é¦™ä¸­çªƒçˆ±å½“æ¢¦æƒ³å¯åŠ¨ï¼Œä½ å´è¯´äº†å†è§ï¼Œ</p>
<p>ä¸çˆ±æˆ‘å°±æ‹‰å€’æˆ‘è¦å¤å¤©ï¼Œå¡«æ»¡æ‰‹å†™çš„ä»å‰ï¼Œ</p>
<p>å‘å¦‚é›ªçš„å¨˜å­ç”¨æ–­äº†çš„å¼¦å¼¹å¥ä¸œé£ç ´ï¼Œ</p>
<p>åœ¨çº¢å°˜å®¢æ ˆå†™å…°äº­åºï¼Œé€å¤©æ¶¯è¿‡å®¢ï¼Œ</p>
<p>çƒŸèŠ±æ˜“å†·å¤©ä¸‹æ— åŒçš„è‹±é›„ä¹Ÿä¼šè½å¯ã€‚</p>
<p>èº«æŠ«é»„é‡‘ç”²çš„å°†å†›ï¼Œåœ¨èŠèŠ±å°å››é¢æ¥šæ­Œï¼Œ</p>
<p>å¤§ä¾ éœå…ƒç”²åœ¨ä¸Šæµ·1943å¤æ´»ï¼Œ</p>
<p>ç”¨é¾™æ‹³åŒæˆªæ£å‡»è´¥äº†æ‹¿åŒåˆ€çš„å¿è€…ï¼Œ</p>
<p>é¾™æˆ˜éª‘å£«ä»¥çˆ¶ä¹‹åå‘åŠ¨æœ€åçš„æˆ˜å½¹ï¼Œ</p>
<p>å›°å…½ä¹‹æ–—åŠå…½äººåœ¨è“è‰²é£æš´ä¸­æˆ˜æ —ï¼Œ</p>
<p>æµæµªè¯—äººé€å¯çˆ±å¥³äººä¸€ä»¶é»‘è‰²æ¯›è¡£ï¼Œ</p>
<p>é˜³å…‰å®…ç”·ä¸è¶…è·‘å¥³ç¥åœ¨é˜³æ˜å±±æ¼‚ç§»ï¼Œ</p>
<p>ç‰›ä»”å¾ˆå¿™å´ä¸ç±³å…°çš„å°é“åŒ è·³èµ·è›‡èˆï¼Œ</p>
<p>é­”æœ¯å…ˆç”ŸåŠä¹”å…‹å”å”ä¸è¦å½“æ‡¦å¤«ã€‚</p>
<p>å®‰é™ç¦»å¼€çˆ±æƒ…æ‚¬å´–ï¼Œæˆ‘è½æ³ªæƒ…ç»ªé›¶ç¢ï¼Œ</p>
<p>ä¸€è·¯å‘åŒ—çš„åé€€ï¼Œå“¦å¯¹ä¸èµ·æ˜¯æˆ‘ä¸é…ï¼Œ</p>
<p>å°±åƒæ°´æ‰‹æ€•æ°´ï¼Œå°±åƒè¶…äººä¸ä¼šé£ï¼Œ</p>
<p>è¿™è¡¨ç™½çš„è¯æˆ‘æ— æ³•ä¸€å£æ°”å…¨å¿µå¯¹ï¼Œ</p>
<p>ä½ æ˜æ˜å°±å–œæ¬¢å¥¹ï¼Œå´ä¸ºä½•å¼€ä¸äº†å£ï¼Œ</p>
<p>ä½ ç®—ä»€ä¹ˆç”·äººï¼Œæ€»æ˜¯è½¬èº«è¯´èµ°å°±èµ°ï¼Œ</p>
<p>ä¸è¯¥æ‰¾å€Ÿå£é€€åï¼ŒMojitoæ¥ä¸€ç‚¹ç‚¹ï¼Œ</p>
<p>è‡ªå¯¼è‡ªæ¼”å¯¹å¥¹è¯´ä½ å¥½å—ï¼Ÿå¥½ä¹…ä¸è§ã€‚</p>
<p>æ‹¨åŠ¨åæ–¹å‘çš„é’Ÿï¼Œæƒ³å›åˆ°è¿‡å»è¯´å¥½ä¸å“­ï¼Œ</p>
<p>çˆ±å°±åƒæ˜¯é¾™å·é£ï¼Œå¤¹æ‚å¿ƒé›¨ä½•æ—¶åœä½ï¼Œ</p>
<p>è·Ÿå…è´¹æ•™å­¦å½•éŸ³å¸¦å­¦æ‰‹è¯­æ€ä¹ˆäº†ï¼Œ</p>
<p>æˆ‘ä¸æƒ³å½“çˆ±æƒ…åºŸæŸ´ï¼Œè¯´å¥½çš„å¹¸ç¦å‘¢ï¼Ÿ</p>
<p>å›­æ¸¸ä¼šä¸­æˆ‘ç‰µç€å‘Šç™½æ°”çƒåœ¨å‚»ç¬‘ï¼Œ</p>
<p>æ™´å¤©çš„å½©è™¹ä¸‹ä½ å¬å¾—åˆ°æˆ‘çš„æš—å·ï¼Œ</p>
<p>åå››å­£åˆ—è½¦å»åƒé‡Œä¹‹å¤–çš„ä¼Šæ–¯å¦å ¡ï¼Œ</p>
<p>çˆ±ä½ æ²¡å·®ä½ æˆ‘ç”¨åŒä¸€ç§è°ƒè°ƒã€‚</p>
<p>ååœ¨ä¸‰å¹´äºŒç­é—¨å£çœ‹ç™½è‰²é£è½¦ï¼Œ</p>
<p>é›¨ä¸‹ä¸€æ•´æ™šäº†ï¼Œæˆ‘åœ¨ç­‰ä½ ä¸‹è¯¾ï¼Œ</p>
<p>åœ¨ç§˜å¯†èŠ±å›­é‡Œé€ä½ åŠå²›é“ç›’ï¼Œ</p>
<p>ç»™æˆ‘ä¸€é¦–æ­Œçš„æ—¶é—´ï¼Œç®€å•çˆ±è¦å¯¹ä½ è¯´ï¼Œ</p>
<p>ä¸ºä½ å¼¹ä¹Œå…‹ä¸½ä¸½ï¼Œé™ªä½ çœ‹æœ€é•¿çš„ç”µå½±ï¼Œ</p>
<p>æ²¿ç€æ—¶å…‰æœºçš„è½¨è¿¹ï¼Œå†™çˆ±çš„é£è¡Œæ—¥è®°ï¼Œ</p>
<p>éµä»ä½ çš„å®Œç¾ä¸»ä¹‰ï¼Œå®ˆæŠ¤ä¸èƒ½è¯´çš„ç§˜å¯†ï¼Œ</p>
<p>Now you see meï¼Œå“ªé‡Œéƒ½æ˜¯ä½ çš„å…¬ä¸»ç—…ã€‚</p>
<p>ä¸ä½ åƒåœŸè€³å…¶å†°æ·‡æ·‹å¬è§ä¸‹é›¨çš„å£°éŸ³ï¼Œ</p>
<p>åœ¨å¸ƒæ‹‰æ ¼å¹¿åœºä¸€èµ·å¬æ¯”è¾ƒå¤§çš„å¤§æç´ã€‚</p>
<p>åºŠè¾¹æ•…äº‹å¤œçš„ç¬¬ä¸ƒç« è®²ç€çˆ±åœ¨è¥¿å…ƒå‰ï¼Œ</p>
<p>å‰ä¸–æƒ…äººé€†é³ç¾äººé±¼ææµ…åœ¨çŠç‘šæµ·è¾¹ï¼Œ</p>
<p>å˜»å“ˆç©ºå§æ”¾ä¸‹æµªæ¼«æ‰‹æœºåƒç–—ä¼¤çƒ§è‚‰ç²½ï¼Œ</p>
<p>æ³¢çˆ·ç¿»å¼€æœ¬è‰çº²ç›®æ²»å¥½äº†å…¬å…¬åå¤´ç—›ï¼Œ</p>
<p>å°ç¬¬å®‰è€æ–‘é¸ åœ¨å¨å»‰å¤å ¡çœ‹èœ—ç‰›æ–—ç‰›ï¼Œ</p>
<p>é’èŠ±ç“·æ—å‘¨å¤§ä¾ çœ‹çš®å½±æˆé‡Œä¹±èˆæ˜¥ç§‹ã€‚</p>
<p>æˆ‘æ˜¯å¦‚æ­¤ç›¸ä¿¡æœ‰å¤©ä½ è¿˜ä¼šå‡ºæ–°æ­Œï¼Œ</p>
<p>ä¸–ç•Œæœ«æ—¥ã€ä¸–ç•Œæœªæœ«æ—¥éƒ½ä¼šç­‰ç€ã€‚</p>
</center>




]]></content>
      <categories>
        <category>Music</category>
      </categories>
      <tags>
        <tag>å¶æƒ ç¾</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis</title>
    <url>/posts/bae4ff13/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-ğŸ“©NoSQLæ¦‚è¿°"><a href="#1-ğŸ“©NoSQLæ¦‚è¿°" class="headerlink" title="1. ğŸ“©NoSQLæ¦‚è¿°"></a>1. ğŸ“©NoSQLæ¦‚è¿°</h2><h3 id="1-1-ğŸ“ƒç®€ä»‹"><a href="#1-1-ğŸ“ƒç®€ä»‹" class="headerlink" title="1.1 ğŸ“ƒç®€ä»‹"></a>1.1 ğŸ“ƒç®€ä»‹</h3><blockquote>
<p>âš¡ NoSQL</p>
</blockquote>
<p>NoSQL != éSQL </p>
<p>NoSQL == Not Only SQL</p>
<p>ä¸ä»…ä»…æ˜¯SQLï¼</p>
<p>æ³›æŒ‡éå…³ç³»å‹çš„æ•°æ®åº“ã€‚å…‹æœå¤§å¹¶å‘ã€‚</p>
<p>å¾ˆå¤šçš„æ•°æ®ç±»å‹ï¼Œç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ã€ç¤¾äº¤ç½‘ç»œå’Œåœ°ç†ä½ç½®ï¼Œè¿™äº›æ•°æ®ç±»å‹çš„å­˜å‚¨ä¸éœ€è¦ä¸€ä¸ªå›ºå®šçš„æ ¼å¼ï¼Œä¸éœ€è¦å¤šå…ƒçš„æ“ä½œå°±å¯ä»¥æ¨ªå‘æ‰©å±•ã€‚</p>
<a id="more"></a>



<h3 id="1-2-ğŸŒ€ç‰¹ç‚¹"><a href="#1-2-ğŸŒ€ç‰¹ç‚¹" class="headerlink" title="1.2 ğŸŒ€ç‰¹ç‚¹"></a>1.2 ğŸŒ€ç‰¹ç‚¹</h3><ul>
<li><p>æ–¹ä¾¿æ‰©å±•ï¼ˆæ•°æ®ä¹‹é—´æ²¡æœ‰å…³ç³»ï¼Œå¾ˆå¥½æ‰©å±•ï¼‰</p>
</li>
<li><p>å¤§æ•°æ®é‡é«˜æ€§èƒ½ï¼ˆç»†ç²’åº¦ç¼“å­˜ï¼Œæ€§èƒ½é«˜ï¼‰</p>
</li>
<li><p>æ•°æ®ç±»å‹å¤šæ ·ï¼ˆä¸éœ€è¦è®¾è®¡æ•°æ®åº“ï¼Œéšå–éšç”¨ï¼‰</p>
</li>
<li><p>RDBMSå’ŒNoSQLçš„åŒºåˆ«: </p>
<ul>
<li>RDBMS<ul>
<li>ç»“æ„åŒ–ç»„ç»‡</li>
<li>SQL</li>
<li>æ•°æ®å’Œå…³ç³»éƒ½å­˜åœ¨å•ç‹¬çš„è¡¨ä¸­</li>
<li>ä¸¥æ ¼çš„ä¸€è‡´æ€§</li>
<li>åŸºç¡€çš„äº‹åŠ¡</li>
<li>Â·Â·Â·</li>
</ul>
</li>
<li>NoSQL<ul>
<li>ä¸ä»…ä»…æ˜¯æ•°æ®</li>
<li>æ²¡æœ‰å›ºå®šçš„æŸ¥è¯¢è¯­è¨€</li>
<li>é”®å€¼å¯¹å­˜å‚¨ï¼Œåˆ—å­˜å‚¨ï¼Œæ–‡æ¡£å­˜å‚¨ï¼Œå›¾å½¢å­˜å‚¨</li>
<li>æœ€ç»ˆä¸€è‡´æ€§</li>
<li>CAPå’ŒBASE</li>
<li>ä¸‰é«˜ï¼šé«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€é«˜å¯æ‰©å±•</li>
<li>Â·Â·Â·</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="1-3-ğŸš€3V-3H"><a href="#1-3-ğŸš€3V-3H" class="headerlink" title="1.3 ğŸš€3V+3H"></a>1.3 ğŸš€3V+3H</h3><ul>
<li>å¤§æ•°æ®æ—¶ä»£çš„3V<ul>
<li>æµ·é‡ Volume</li>
<li>å¤šæ · Variety</li>
<li>å®æ—¶ Velocity</li>
</ul>
</li>
<li>äº’è”ç½‘éœ€æ±‚çš„3H<ul>
<li>é«˜å¹¶å‘ High concurrency</li>
<li>é«˜å¯æ‹“ High scalable</li>
<li>é«˜æ€§èƒ½ High performance</li>
</ul>
</li>
</ul>
<h3 id="1-4-ğŸ“šåˆ†ç±»"><a href="#1-4-ğŸ“šåˆ†ç±»" class="headerlink" title="1.4 ğŸ“šåˆ†ç±»"></a>1.4 ğŸ“šåˆ†ç±»</h3><blockquote>
<p>ğŸ˜­å‘œå‘œå‘œï¼Œæˆ‘å¥½èœï¼Œæˆ‘å•¥éƒ½ä¸ä¼šğŸ¼</p>
</blockquote>
<table>
<thead>
<tr>
<th>åˆ†ç±»</th>
<th>ä¸¾ä¾‹</th>
<th>å…¸å‹åº”ç”¨åœºæ™¯</th>
<th>æ•°æ®æ¨¡å‹</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>é”®å€¼å¯¹</td>
<td>Tokyo Cabinet/Tyrantï¼ŒRedisï¼ŒVoldemortï¼ŒOracle BDB</td>
<td>å†…å®¹UANï¼Œä¸»è¦ç”¨äºå¤„ç†å¤§é‡æ•°æ®çš„é«˜è®¿é—®è´Ÿè½½ï¼Œä¹Ÿç”¨äºä¸€äº›æ—¥å¿—ç³»ç»Ÿç­‰ç­‰</td>
<td>KeyæŒ‡å‘valueçš„é”®å€¼å¯¹ï¼Œé€šå¸¸ç”¨hash tableæ¥å®ç°</td>
<td>æŸ¥æ‰¾é€Ÿåº¦å¿«</td>
<td>æ•°æ®æ— ç»“æ„åŒ–ï¼Œé€šå¸¸åªè¢«å½“åšå­—ç¬¦ä¸²æˆ–è€…äºŒè¿›åˆ¶æ•°æ®</td>
</tr>
<tr>
<td>åˆ—å­˜å‚¨æ•°æ®åº“</td>
<td>Cassandraï¼ŒHBaseï¼ŒRiak</td>
<td>åˆ†å¸ƒå¼çš„æ–‡ä»¶ç³»ç»Ÿ</td>
<td>ä»¥åˆ—ç°‡å¼å­˜å‚¨ï¼Œå°†åŒä¸€åˆ—æ•°æ®å­˜åœ¨ä¸€èµ·</td>
<td>æŸ¥æ‰¾é€Ÿåº¦å¿«ï¼Œå¯æ‰©å±•æ€§å¼ºï¼Œæ›´å®¹æ˜“è¿›è¡Œåˆ†å¸ƒå¼æ‰©å±•</td>
<td>åŠŸèƒ½ç›¸å¯¹å±€é™</td>
</tr>
<tr>
<td>æ–‡æ¡£å‹æ•°æ®åº“</td>
<td>CouchDBï¼ŒMongoDB</td>
<td>Webåº”ç”¨</td>
<td>Key-Valueå¯¹åº”çš„é”®å€¼å¯¹ï¼ŒValueä¸ºç»“æ„åŒ–æ•°æ®</td>
<td>æ•°æ®ç»“æ„è¦æ±‚ä¸ä¸¥æ ¼ï¼Œè¡¨ç»“æ„å¯å˜ï¼Œä¸éœ€è¦åƒå…³ç³»å‹æ•°æ®åº“ä¸€æ ·éœ€è¦é¢„å…ˆå®šä¹‰è¡¨ç»“æ„</td>
<td>æŸ¥è¯¢æ€§èƒ½ä¸é«˜ï¼Œè€Œä¸”ç¼ºä¹ç»Ÿä¸€çš„æŸ¥è¯¢è¯­è¨€</td>
</tr>
<tr>
<td>å›¾å½¢æ•°æ®åº“</td>
<td>Neo4Jï¼ŒInfoGridï¼ŒInfinite Graph</td>
<td>ç¤¾äº¤ç½‘ç»œã€æ¨èç³»ç»Ÿç­‰ç­‰ï¼Œä¸“æ³¨äºæ„å»ºå…³ç³»å›¾è°±</td>
<td>å›¾ç»“æ„</td>
<td>åˆ©ç”¨å›¾ç»“æ„ç›¸å…³ç®—æ³•ã€‚æ¯”å¦‚æœ€çŸ­è·¯å¾„å¯»å€ï¼ŒNåº¦å…³ç³»æŸ¥æ‰¾ç­‰</td>
<td>å¾ˆå¤šæ—¶å€™éœ€è¦å¯¹æ•´ä¸ªå›¾åšè®¡ç®—æ‰èƒ½å¾—å‡ºéœ€è¦çš„ä¿¡æ¯ï¼Œè€Œä¸”è¿™ç§ç»“æ„ä¸å¤ªå¥½åšåˆ†å¸ƒå¼çš„é›†ç¾¤æ–¹æ¡ˆ</td>
</tr>
</tbody></table>
<h3 id="1-5-ğŸ“ˆé˜¿é‡Œå·´æŠ€æœ¯æ¼”è¿›"><a href="#1-5-ğŸ“ˆé˜¿é‡Œå·´æŠ€æœ¯æ¼”è¿›" class="headerlink" title="1.5 ğŸ“ˆé˜¿é‡Œå·´æŠ€æœ¯æ¼”è¿›"></a>1.5 ğŸ“ˆé˜¿é‡Œå·´æŠ€æœ¯æ¼”è¿›</h3><blockquote>
<p>âœ¡æŠ€æœ¯å¹¶æ— é«˜ä½ä¹‹åˆ†ï¼Œå°±çœ‹ä½ å¦‚ä½•ä½¿ç”¨</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009144812661.png" class="" title="image-20201009144812661.png">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009145619674.png" class="" title="image-20201009145619674.png">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009153115683.png" class="" title="image-20201009153115683.png">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009153346176.png" class="" title="image-20201009153346176.png">





<h2 id="2-ğŸ“©Rediså…¥é—¨"><a href="#2-ğŸ“©Rediså…¥é—¨" class="headerlink" title="2. ğŸ“©Rediså…¥é—¨"></a>2. ğŸ“©Rediså…¥é—¨</h2><blockquote>
<p> ğŸŒ official website</p>
</blockquote>
<ul>
<li><p>è‹±æ–‡å®˜ç½‘ï¼š<a href="https://www.redis.io/">redis</a></p>
</li>
<li><p>ä¸­æ–‡å®˜ç½‘ï¼š<del><a href="https://www.redis.cn/">redis</a></del></p>
</li>
<li><p>ä¸­æ–‡å®˜ç½‘ï¼š<a href="https://www.redis.net.cn/">redis</a></p>
</li>
</ul>
<h3 id="2-1-ğŸ“‘ç®€ä»‹"><a href="#2-1-ğŸ“‘ç®€ä»‹" class="headerlink" title="2.1 ğŸ“‘ç®€ä»‹"></a>2.1 ğŸ“‘ç®€ä»‹</h3><blockquote>
<p>ğŸ’¡ Redis = Remote Dictionary Server</p>
</blockquote>
<p>Redis æ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSDè®¸å¯ï¼‰çš„ï¼Œå†…å­˜ä¸­çš„æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒå¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ã€‚ å®ƒæ”¯æŒå¤šç§ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå¦‚ <a href="http://redis.cn/topics/data-types-intro.html#strings">å­—ç¬¦ä¸²ï¼ˆstringsï¼‰</a>ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#hashes">æ•£åˆ—ï¼ˆhashesï¼‰</a>ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#lists">åˆ—è¡¨ï¼ˆlistsï¼‰</a>ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#sets">é›†åˆï¼ˆsetsï¼‰</a>ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#sorted-sets">æœ‰åºé›†åˆï¼ˆsorted setsï¼‰</a> ä¸èŒƒå›´æŸ¥è¯¢ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#bitmaps">bitmaps</a>ï¼Œ <a href="http://redis.cn/topics/data-types-intro.html#hyperloglogs">hyperloglogs</a> å’Œ <a href="http://redis.cn/commands/geoadd.html">åœ°ç†ç©ºé—´ï¼ˆgeospatialï¼‰</a> ç´¢å¼•åŠå¾„æŸ¥è¯¢ã€‚ Redis å†…ç½®äº† <a href="http://redis.cn/topics/replication.html">å¤åˆ¶ï¼ˆreplicationï¼‰</a>ï¼Œ<a href="http://redis.cn/commands/eval.html">LUAè„šæœ¬ï¼ˆLua scriptingï¼‰</a>ï¼Œ <a href="http://redis.cn/topics/lru-cache.html">LRUé©±åŠ¨äº‹ä»¶ï¼ˆLRU evictionï¼‰</a>ï¼Œ<a href="http://redis.cn/topics/transactions.html">äº‹åŠ¡ï¼ˆtransactionsï¼‰</a> å’Œä¸åŒçº§åˆ«çš„ <a href="http://redis.cn/topics/persistence.html">ç£ç›˜æŒä¹…åŒ–ï¼ˆpersistenceï¼‰</a>ï¼Œ å¹¶é€šè¿‡ <a href="http://redis.cn/topics/sentinel.html">Rediså“¨å…µï¼ˆSentinelï¼‰</a>å’Œè‡ªåŠ¨ <a href="http://redis.cn/topics/cluster-tutorial.html">åˆ†åŒºï¼ˆClusterï¼‰</a>æä¾›é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰^(æ¥è‡ªå®˜æ–¹æ–‡æ¡£)^ã€‚</p>
<h3 id="2-2-ğŸŒ ç‰¹æ€§"><a href="#2-2-ğŸŒ ç‰¹æ€§" class="headerlink" title="2.2 ğŸŒ ç‰¹æ€§"></a>2.2 ğŸŒ ç‰¹æ€§</h3><ul>
<li><input checked="" disabled="" type="checkbox"> æ€§èƒ½ä¼˜ç§€ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™é€Ÿåº¦éå¸¸å¿«ï¼Œæ”¯æŒ10wå¹¶å‘QPS</li>
<li><input checked="" disabled="" type="checkbox"> å•è¿›ç¨‹å•çº¿ç¨‹ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé‡‡ç”¨IOå¤šè·¯å¤ç”¨æœºåˆ¶</li>
<li><input checked="" disabled="" type="checkbox"> ä¸°å¯Œçš„æ•°æ®ç±»å‹ï¼Œæ”¯æŒStringã€Hashã€Listã€Setã€Sorted Set</li>
<li><input checked="" disabled="" type="checkbox"> æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­æ•°æ®ä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œé‡å¯æ—¶åŠ è½½</li>
<li><input checked="" disabled="" type="checkbox"> ä¸»ä»å¤åˆ¶ï¼Œå“¨å…µæ¨¡å¼ï¼Œé«˜å¯ç”¨</li>
<li><input checked="" disabled="" type="checkbox"> å¯ä»¥ç”¨ä½œåˆ†å¸ƒå¼é”</li>
<li><input checked="" disabled="" type="checkbox"> å¯ä»¥è¿›è¡Œåœ°å›¾ä¿¡æ¯åˆ†æ</li>
<li><input checked="" disabled="" type="checkbox"> å¯ä»¥ä½œä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ä½¿ç”¨ï¼Œæ”¯æŒå‘å¸ƒè®¢é˜…</li>
<li><input checked="" disabled="" type="checkbox"> å¯ä»¥ä½œä¸ºè®¡æ•°å™¨ä½¿ç”¨ï¼Œè®°å½•ç½‘é¡µæˆ–è€…å°ç¨‹åºç­‰çš„æµè§ˆé‡</li>
<li><input checked="" disabled="" type="checkbox"> Â·Â·Â·Â·Â·Â·</li>
</ul>
<h3 id="2-3-ğŸ”°æ‹“å±•"><a href="#2-3-ğŸ”°æ‹“å±•" class="headerlink" title="2.3 ğŸ”°æ‹“å±•"></a>2.3 ğŸ”°æ‹“å±•</h3><blockquote>
<p>Redis ğŸ†š Memcache</p>
</blockquote>
<ol>
<li>å­˜å‚¨æ–¹å¼ä¸Šï¼šmemcacheä¼šæŠŠæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ï¼Œæ–­ç”µåä¼šæŒ‚æ‰ï¼Œæ•°æ®ä¸èƒ½è¶…è¿‡å†…å­˜å¤§å°ã€‚redisæœ‰éƒ¨åˆ†æ•°æ®å­˜åœ¨ç¡¬ç›˜ä¸Šï¼Œè¿™æ ·èƒ½ä¿è¯æ•°æ®çš„æŒä¹…æ€§</li>
<li>æ•°æ®æ”¯æŒç±»å‹ä¸Šï¼šmemcacheå¯¹æ•°æ®ç±»å‹çš„æ”¯æŒç®€å•ï¼Œåªæ”¯æŒç®€å•çš„key-valueï¼Œè€Œredisæ”¯æŒäº”å¤§æ•°æ®ç±»å‹å’Œä¸‰å¤§ç‰¹æ®Šæ•°æ®ç±»å‹</li>
<li>åº•å±‚æ¨¡å‹ä¸Šï¼šå®ƒä»¬ä¹‹é—´åº•å±‚å®ç°æ–¹å¼ä»¥åŠä¸å®¢æˆ·ç«¯ä¹‹é—´çš„åº”ç”¨åè®®ä¸ä¸€æ ·ã€‚redisç›´æ¥æ„å»ºäº†VMæœºåˆ¶ï¼Œå› ä¸ºä¸€èˆ¬çš„ç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„è¯ï¼Œä¼šæµªè´¹ä¸€å®šçš„æ—¶é—´å»ç§»åŠ¨å’Œè¯·æ±‚</li>
<li>valueçš„å¤§å°ï¼šrediså¯ä»¥è¾¾åˆ°1GBï¼Œè€Œmemcacheåªæœ‰1MB</li>
</ol>
<h2 id="3-ğŸ“©Rediså®‰è£…"><a href="#3-ğŸ“©Rediså®‰è£…" class="headerlink" title="3. ğŸ“©Rediså®‰è£…"></a>3. ğŸ“©Rediså®‰è£…</h2><blockquote>
<p>âš ï¸ notice</p>
</blockquote>
<ul>
<li><p>Githubä¸Šredisçš„windowsç‰ˆæœ¬å·²ç»å¾ˆä¹…ä¸å†æ›´æ–°ï¼Œå¯¹äºæœ€æ–°çš„3.2.100ç‰ˆæœ¬ï¼Œä¸ªäººä½¿ç”¨è¿‡ï¼Œredis-cli.exeä½¿ç”¨èµ·æ¥å¶å°”ä¼šå‡ºé—®é¢˜ï¼Œå‘½ä»¤å†™å‡ºæ¥é‚£ä¸€è¡Œä¼šå˜æˆé»‘è‰²ï¼Œå…¼å®¹æ€§ä¸å¤ªå¥½ï¼Œç”±äº3.0ä¸æ”¯æŒGEOç­‰æ“ä½œï¼Œæˆ‘è¿˜æ˜¯é€‰æ‹©ä½¿ç”¨3.2.100ç‰ˆæœ¬ã€‚</p>
</li>
<li><p>Redisè¿™ç§é«˜æ€§èƒ½æœåŠ¡å™¨æœ¬èº«ä¸CentOSçš„ä½“è´¨å°±å¾ˆèˆ¬é…ï¼Œä¸ªäººæ¨èåœ¨Linuxä¸Šå®‰è£…ï¼Œå°¤å…¶æ˜¯åæœŸæ­å»ºredisé›†ç¾¤ç¯å¢ƒã€‚CentOS7æœ¬èº«è‡ªå¸¦çš„yumé•œåƒä¸­å¸¦çš„gccå®‰è£…åŒ…åªæœ‰4.8.5ç‰ˆæœ¬ï¼Œä¸æ”¯æŒé«˜ç‰ˆæœ¬redisçš„ç¼–è¯‘ï¼Œæ‰€ä»¥æ¨èä¸‹è½½5.0.8ç‰ˆæœ¬ã€‚</p>
</li>
<li><p>ä»¥ä¸Šï¼Œä¸ç®¡æ˜¯Windowsè¿˜æ˜¯Linuxï¼Œéƒ½æ¨èä½¿ç”¨Xshellå¼€å¯RedisæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚</p>
</li>
</ul>
<blockquote>
<p>ğŸ”½Xshell</p>
</blockquote>
<ul>
<li>ç½‘ç›˜é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1qWtPzJgF3N24yIlUfTtq9w">https://pan.baidu.com/s/1qWtPzJgF3N24yIlUfTtq9w</a></li>
<li>æå–ç ï¼škkkk</li>
</ul>
<h3 id="3-1-ğŸ’»Windows10-å®‰è£…"><a href="#3-1-ğŸ’»Windows10-å®‰è£…" class="headerlink" title="3.1 ğŸ’»Windows10 å®‰è£…"></a>3.1 ğŸ’»Windows10 å®‰è£…</h3><blockquote>
<p>ä¸‹è½½: <a href="https://github.com/MSOpenTech/redis/releases">redis</a></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008213905860.png" class="" title="image-20201008213905860">

<blockquote>
<p>è§£å‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008214011620.png" class="" title="image-20201008214011620">

<blockquote>
<p>å¯åŠ¨</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008214053586.png" class="" title="image-20201008214053586">



<h3 id="3-2-ğŸ’»CentOS7-å®‰è£…"><a href="#3-2-ğŸ’»CentOS7-å®‰è£…" class="headerlink" title="3.2 ğŸ’»CentOS7 å®‰è£…"></a>3.2 ğŸ’»CentOS7 å®‰è£…</h3><blockquote>
<p>å®‰è£…gcc: <code>yum install gcc-c++ tcl</code></p>
<p>æ³¨æ„å®‰è£… version&gt;6 çš„rediséœ€è¦ version&gt;5 çš„gcc: </p>
<p><code>sudo yum install centos-release-scl</code><br><code>sudo yum install devtoolset-7-gcc*</code><br><code>scl enable devtoolset-7 bash</code></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008224757570.png" class="" title="image-20201008224757570">

<blockquote>
<p>ä¸‹è½½å‹ç¼©åŒ…: <code>wget http://download.redis.io/releases/redis-5.0.8.tar.gz</code></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008223909191.png" class="" title="image-20201008223909191">

<blockquote>
<p>è§£å‹å‹ç¼©åŒ…: <code>tar xzf redis-5.0.8.tar.gz</code></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008224102401.png" class="" title="image-20201008224102401">

<blockquote>
<p>è·³è½¬ç›®å½•: <code>cd redis-5.0.8</code>    </p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008215145306.png" class="" title="image-20201008215145306">

<blockquote>
<p>ç¼–è¯‘å®‰è£…: <code>make</code></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008215335902.png" class="" title="image-20201008215335902">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008224230979.png" class="" title="image-20201008224230979">

<blockquote>
<p>å†æ¬¡ç¼–è¯‘: <code>make</code></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008224450296.png" class="" title="image-20201008224450296">

<blockquote>
<p>æœ€åå®‰è£…: </p>
<p><code>cd src/</code></p>
<p><code>make install</code></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008230537427.png" class="" title="image-20201008230537427">

<blockquote>
<p>æŸ¥çœ‹ç»“æœ: <code>ll /usr/local/bin/</code></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201008230723447.png" class="" title="image-20201008230723447">

<blockquote>
<p>æ›´æ”¹é…ç½®:</p>
<p>æ–°å»ºé…ç½®æ–‡ä»¶ç›®å½•: <code>mkdir kconfig</code>   </p>
<p>å°†åŸç”ŸRedisé…ç½®æ–‡ä»¶å¤åˆ¶è¿›æ¥: <code>cp /home/parak/Redis/redis-5.0.8/redis.conf </code></p>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶: <code>gedit redis.conf</code> </p>
<pre><code>daemonize yes</code></pre>
</blockquote>
<blockquote>
<p>æµ‹è¯•å¯åŠ¨: <code>redis-server kconfig/redis.conf</code></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009105138976.png" class="" title="image-20201009105138976">

<blockquote>
<p>æŸ¥çœ‹redisè¿›ç¨‹: <code>ps -ef | grep redis</code></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009105424943.png" class="" title="image-20201009105424943">

<blockquote>
<p>å…³é—­redisæœåŠ¡: <code>shutdown</code></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009105552015.png" class="" title="image-20201009105552015">



<h2 id="4-ğŸ“©Redisé…ç½®"><a href="#4-ğŸ“©Redisé…ç½®" class="headerlink" title="4. ğŸ“©Redisé…ç½®"></a>4. ğŸ“©Redisé…ç½®</h2><h3 id="4-1-ğŸš©å‘½ä»¤"><a href="#4-1-ğŸš©å‘½ä»¤" class="headerlink" title="4.1 ğŸš©å‘½ä»¤"></a>4.1 ğŸš©å‘½ä»¤</h3><blockquote>
<p>ğŸ‘€æŸ¥çœ‹æ‰€æœ‰é…ç½®é¡¹</p>
</blockquote>
<pre><code class="shell">config get *</code></pre>
<blockquote>
<p>âœå‘½ä»¤è¡Œç¼–è¾‘é…ç½®</p>
</blockquote>
<pre><code class="shell">config set &lt;option&gt; &lt;value&gt;</code></pre>
<h3 id="4-2-ğŸ“redis-conf-é…ç½®é¡¹è¯´æ˜"><a href="#4-2-ğŸ“redis-conf-é…ç½®é¡¹è¯´æ˜" class="headerlink" title="4.2 ğŸ“redis.conf é…ç½®é¡¹è¯´æ˜"></a>4.2 ğŸ“redis.conf é…ç½®é¡¹è¯´æ˜</h3><table>
<thead>
<tr>
<th align="left">åºå·</th>
<th align="left">é…ç½®é¡¹</th>
<th align="left">è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left"><code>daemonize no</code></td>
<td align="left">Redis é»˜è®¤ä¸æ˜¯ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥é€šè¿‡è¯¥é…ç½®é¡¹ä¿®æ”¹ï¼Œä½¿ç”¨ yes å¯ç”¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆWindows ä¸æ”¯æŒå®ˆæŠ¤çº¿ç¨‹çš„é…ç½®ä¸º no ï¼‰</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left"><code>pidfile /var/run/redis.pid</code></td>
<td align="left">å½“ Redis ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œæ—¶ï¼ŒRedis é»˜è®¤ä¼šæŠŠ pid å†™å…¥ /var/run/redis.pid æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡ pidfile æŒ‡å®š</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left"><code>port 6379</code></td>
<td align="left">æŒ‡å®š Redis ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ç«¯å£ä¸º 6379</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left"><code>bind 127.0.0.1</code></td>
<td align="left">ç»‘å®šçš„ä¸»æœºåœ°å€</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left"><code>timeout 300</code></td>
<td align="left">å½“å®¢æˆ·ç«¯é—²ç½®å¤šé•¿ç§’åå…³é—­è¿æ¥ï¼Œå¦‚æœæŒ‡å®šä¸º 0 ï¼Œè¡¨ç¤ºå…³é—­è¯¥åŠŸèƒ½</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left"><code>loglevel notice</code></td>
<td align="left">æŒ‡å®šæ—¥å¿—è®°å½•çº§åˆ«ï¼ŒRedis æ€»å…±æ”¯æŒå››ä¸ªçº§åˆ«ï¼šdebugã€verboseã€noticeã€warningï¼Œé»˜è®¤ä¸º notice</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left"><code>logfile stdout</code></td>
<td align="left">æ—¥å¿—è®°å½•æ–¹å¼ï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å‡ºï¼Œå¦‚æœé…ç½® Redis ä¸ºå®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œï¼Œè€Œè¿™é‡Œåˆé…ç½®ä¸ºæ—¥å¿—è®°å½•æ–¹å¼ä¸ºæ ‡å‡†è¾“å‡ºï¼Œåˆ™æ—¥å¿—å°†ä¼šå‘é€ç»™ /dev/null</td>
</tr>
<tr>
<td align="left">8</td>
<td align="left"><code>databases 16</code></td>
<td align="left">è®¾ç½®æ•°æ®åº“çš„æ•°é‡ï¼Œé»˜è®¤æ•°æ®åº“ä¸º0ï¼Œå¯ä»¥ä½¿ç”¨SELECT å‘½ä»¤åœ¨è¿æ¥ä¸ŠæŒ‡å®šæ•°æ®åº“id</td>
</tr>
<tr>
<td align="left">9</td>
<td align="left"><code>save  </code>Redis é»˜è®¤é…ç½®æ–‡ä»¶ä¸­æä¾›äº†ä¸‰ä¸ªæ¡ä»¶ï¼š<strong>save 900 1</strong>ã€<strong>save 300 10</strong> ã€<strong>save 60 10000</strong>åˆ†åˆ«è¡¨ç¤º 900 ç§’ï¼ˆ15 åˆ†é’Ÿï¼‰å†…æœ‰ 1 ä¸ªæ›´æ”¹ï¼Œ300 ç§’ï¼ˆ5 åˆ†é’Ÿï¼‰å†…æœ‰ 10 ä¸ªæ›´æ”¹ä»¥åŠ 60 ç§’å†…æœ‰ 10000 ä¸ªæ›´æ”¹ã€‚</td>
<td align="left">æŒ‡å®šåœ¨å¤šé•¿æ—¶é—´å†…ï¼Œæœ‰å¤šå°‘æ¬¡æ›´æ–°æ“ä½œï¼Œå°±å°†æ•°æ®åŒæ­¥åˆ°æ•°æ®æ–‡ä»¶ï¼Œå¯ä»¥å¤šä¸ªæ¡ä»¶é…åˆ</td>
</tr>
<tr>
<td align="left">10</td>
<td align="left"><code>rdbcompression yes</code></td>
<td align="left">æŒ‡å®šå­˜å‚¨è‡³æœ¬åœ°æ•°æ®åº“æ—¶æ˜¯å¦å‹ç¼©æ•°æ®ï¼Œé»˜è®¤ä¸º yesï¼ŒRedis é‡‡ç”¨ LZF å‹ç¼©ï¼Œå¦‚æœä¸ºäº†èŠ‚çœ CPU æ—¶é—´ï¼Œå¯ä»¥å…³é—­è¯¥é€‰é¡¹ï¼Œä½†ä¼šå¯¼è‡´æ•°æ®åº“æ–‡ä»¶å˜çš„å·¨å¤§</td>
</tr>
<tr>
<td align="left">11</td>
<td align="left"><code>dbfilename dump.rdb</code></td>
<td align="left">æŒ‡å®šæœ¬åœ°æ•°æ®åº“æ–‡ä»¶åï¼Œé»˜è®¤å€¼ä¸º dump.rdb</td>
</tr>
<tr>
<td align="left">12</td>
<td align="left"><code>dir ./</code></td>
<td align="left">æŒ‡å®šæœ¬åœ°æ•°æ®åº“å­˜æ”¾ç›®å½•</td>
</tr>
<tr>
<td align="left">13</td>
<td align="left"><code>slaveof  </code></td>
<td align="left">è®¾ç½®å½“æœ¬æœºä¸º slave æœåŠ¡æ—¶ï¼Œè®¾ç½® master æœåŠ¡çš„ IP åœ°å€åŠç«¯å£ï¼Œåœ¨ Redis å¯åŠ¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä» master è¿›è¡Œæ•°æ®åŒæ­¥</td>
</tr>
<tr>
<td align="left">14</td>
<td align="left"><code>masterauth </code></td>
<td align="left">å½“ master æœåŠ¡è®¾ç½®äº†å¯†ç ä¿æŠ¤æ—¶ï¼Œslav æœåŠ¡è¿æ¥ master çš„å¯†ç </td>
</tr>
<tr>
<td align="left">15</td>
<td align="left"><code>requirepass foobared</code></td>
<td align="left">è®¾ç½® Redis è¿æ¥å¯†ç ï¼Œå¦‚æœé…ç½®äº†è¿æ¥å¯†ç ï¼Œå®¢æˆ·ç«¯åœ¨è¿æ¥ Redis æ—¶éœ€è¦é€šè¿‡ AUTH <password> å‘½ä»¤æä¾›å¯†ç ï¼Œé»˜è®¤å…³é—­</td>
</tr>
<tr>
<td align="left">16</td>
<td align="left"><code> maxclients 128</code></td>
<td align="left">è®¾ç½®åŒä¸€æ—¶é—´æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ï¼Œé»˜è®¤æ— é™åˆ¶ï¼ŒRedis å¯ä»¥åŒæ—¶æ‰“å¼€çš„å®¢æˆ·ç«¯è¿æ¥æ•°ä¸º Redis è¿›ç¨‹å¯ä»¥æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°ï¼Œå¦‚æœè®¾ç½® maxclients 0ï¼Œè¡¨ç¤ºä¸ä½œé™åˆ¶ã€‚å½“å®¢æˆ·ç«¯è¿æ¥æ•°åˆ°è¾¾é™åˆ¶æ—¶ï¼ŒRedis ä¼šå…³é—­æ–°çš„è¿æ¥å¹¶å‘å®¢æˆ·ç«¯è¿”å› max number of clients reached é”™è¯¯ä¿¡æ¯</td>
</tr>
<tr>
<td align="left">17</td>
<td align="left"><code>maxmemory </code></td>
<td align="left">æŒ‡å®š Redis æœ€å¤§å†…å­˜é™åˆ¶ï¼ŒRedis åœ¨å¯åŠ¨æ—¶ä¼šæŠŠæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¾¾åˆ°æœ€å¤§å†…å­˜åï¼ŒRedis ä¼šå…ˆå°è¯•æ¸…é™¤å·²åˆ°æœŸæˆ–å³å°†åˆ°æœŸçš„ Keyï¼Œå½“æ­¤æ–¹æ³•å¤„ç† åï¼Œä»ç„¶åˆ°è¾¾æœ€å¤§å†…å­˜è®¾ç½®ï¼Œå°†æ— æ³•å†è¿›è¡Œå†™å…¥æ“ä½œï¼Œä½†ä»ç„¶å¯ä»¥è¿›è¡Œè¯»å–æ“ä½œã€‚Redis æ–°çš„ vm æœºåˆ¶ï¼Œä¼šæŠŠ Key å­˜æ”¾å†…å­˜ï¼ŒValue ä¼šå­˜æ”¾åœ¨ swap åŒº</td>
</tr>
<tr>
<td align="left">18</td>
<td align="left"><code>appendonly no</code></td>
<td align="left">æŒ‡å®šæ˜¯å¦åœ¨æ¯æ¬¡æ›´æ–°æ“ä½œåè¿›è¡Œæ—¥å¿—è®°å½•ï¼ŒRedis åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯å¼‚æ­¥çš„æŠŠæ•°æ®å†™å…¥ç£ç›˜ï¼Œå¦‚æœä¸å¼€å¯ï¼Œå¯èƒ½ä¼šåœ¨æ–­ç”µæ—¶å¯¼è‡´ä¸€æ®µæ—¶é—´å†…çš„æ•°æ®ä¸¢å¤±ã€‚å› ä¸º redis æœ¬èº«åŒæ­¥æ•°æ®æ–‡ä»¶æ˜¯æŒ‰ä¸Šé¢ save æ¡ä»¶æ¥åŒæ­¥çš„ï¼Œæ‰€ä»¥æœ‰çš„æ•°æ®ä¼šåœ¨ä¸€æ®µæ—¶é—´å†…åªå­˜åœ¨äºå†…å­˜ä¸­ã€‚é»˜è®¤ä¸º no</td>
</tr>
<tr>
<td align="left">19</td>
<td align="left"><code>appendfilename appendonly.aof</code></td>
<td align="left">æŒ‡å®šæ›´æ–°æ—¥å¿—æ–‡ä»¶åï¼Œé»˜è®¤ä¸º appendonly.aof</td>
</tr>
<tr>
<td align="left">20</td>
<td align="left"><code>appendfsync everysec</code></td>
<td align="left">æŒ‡å®šæ›´æ–°æ—¥å¿—æ¡ä»¶ï¼Œå…±æœ‰ 3 ä¸ªå¯é€‰å€¼ï¼š<strong>no</strong>ï¼šè¡¨ç¤ºç­‰æ“ä½œç³»ç»Ÿè¿›è¡Œæ•°æ®ç¼“å­˜åŒæ­¥åˆ°ç£ç›˜ï¼ˆå¿«ï¼‰<strong>always</strong>ï¼šè¡¨ç¤ºæ¯æ¬¡æ›´æ–°æ“ä½œåæ‰‹åŠ¨è°ƒç”¨ fsync() å°†æ•°æ®å†™åˆ°ç£ç›˜ï¼ˆæ…¢ï¼Œå®‰å…¨ï¼‰<strong>everysec</strong>ï¼šè¡¨ç¤ºæ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼ˆæŠ˜ä¸­ï¼Œé»˜è®¤å€¼ï¼‰</td>
</tr>
<tr>
<td align="left">21</td>
<td align="left"><code>vm-enabled no</code></td>
<td align="left">æŒ‡å®šæ˜¯å¦å¯ç”¨è™šæ‹Ÿå†…å­˜æœºåˆ¶ï¼Œé»˜è®¤å€¼ä¸º noï¼Œç®€å•çš„ä»‹ç»ä¸€ä¸‹ï¼ŒVM æœºåˆ¶å°†æ•°æ®åˆ†é¡µå­˜æ”¾ï¼Œç”± Redis å°†è®¿é—®é‡è¾ƒå°‘çš„é¡µå³å†·æ•°æ® swap åˆ°ç£ç›˜ä¸Šï¼Œè®¿é—®å¤šçš„é¡µé¢ç”±ç£ç›˜è‡ªåŠ¨æ¢å‡ºåˆ°å†…å­˜ä¸­ï¼ˆåœ¨åé¢çš„æ–‡ç« æˆ‘ä¼šä»”ç»†åˆ†æ Redis çš„ VM æœºåˆ¶ï¼‰</td>
</tr>
<tr>
<td align="left">22</td>
<td align="left"><code>vm-swap-file /tmp/redis.swap</code></td>
<td align="left">è™šæ‹Ÿå†…å­˜æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤å€¼ä¸º /tmp/redis.swapï¼Œä¸å¯å¤šä¸ª Redis å®ä¾‹å…±äº«</td>
</tr>
<tr>
<td align="left">23</td>
<td align="left"><code>vm-max-memory 0</code></td>
<td align="left">å°†æ‰€æœ‰å¤§äº vm-max-memory çš„æ•°æ®å­˜å…¥è™šæ‹Ÿå†…å­˜ï¼Œæ— è®º vm-max-memory è®¾ç½®å¤šå°ï¼Œæ‰€æœ‰ç´¢å¼•æ•°æ®éƒ½æ˜¯å†…å­˜å­˜å‚¨çš„(Redis çš„ç´¢å¼•æ•°æ® å°±æ˜¯ keys)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ vm-max-memory è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œå…¶å®æ˜¯æ‰€æœ‰ value éƒ½å­˜åœ¨äºç£ç›˜ã€‚é»˜è®¤å€¼ä¸º 0</td>
</tr>
<tr>
<td align="left">24</td>
<td align="left"><code>vm-page-size 32</code></td>
<td align="left">Redis swap æ–‡ä»¶åˆ†æˆäº†å¾ˆå¤šçš„ pageï¼Œä¸€ä¸ªå¯¹è±¡å¯ä»¥ä¿å­˜åœ¨å¤šä¸ª page ä¸Šé¢ï¼Œä½†ä¸€ä¸ª page ä¸Šä¸èƒ½è¢«å¤šä¸ªå¯¹è±¡å…±äº«ï¼Œvm-page-size æ˜¯è¦æ ¹æ®å­˜å‚¨çš„ æ•°æ®å¤§å°æ¥è®¾å®šçš„ï¼Œä½œè€…å»ºè®®å¦‚æœå­˜å‚¨å¾ˆå¤šå°å¯¹è±¡ï¼Œpage å¤§å°æœ€å¥½è®¾ç½®ä¸º 32 æˆ–è€… 64bytesï¼›å¦‚æœå­˜å‚¨å¾ˆå¤§å¤§å¯¹è±¡ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ›´å¤§çš„ pageï¼Œå¦‚æœä¸ç¡®å®šï¼Œå°±ä½¿ç”¨é»˜è®¤å€¼</td>
</tr>
<tr>
<td align="left">25</td>
<td align="left"><code>vm-pages 134217728</code></td>
<td align="left">è®¾ç½® swap æ–‡ä»¶ä¸­çš„ page æ•°é‡ï¼Œç”±äºé¡µè¡¨ï¼ˆä¸€ç§è¡¨ç¤ºé¡µé¢ç©ºé—²æˆ–ä½¿ç”¨çš„ bitmapï¼‰æ˜¯åœ¨æ”¾åœ¨å†…å­˜ä¸­çš„ï¼Œï¼Œåœ¨ç£ç›˜ä¸Šæ¯ 8 ä¸ª pages å°†æ¶ˆè€— 1byte çš„å†…å­˜ã€‚</td>
</tr>
<tr>
<td align="left">26</td>
<td align="left"><code>vm-max-threads 4</code></td>
<td align="left">è®¾ç½®è®¿é—®swapæ–‡ä»¶çš„çº¿ç¨‹æ•°,æœ€å¥½ä¸è¦è¶…è¿‡æœºå™¨çš„æ ¸æ•°,å¦‚æœè®¾ç½®ä¸º0,é‚£ä¹ˆæ‰€æœ‰å¯¹swapæ–‡ä»¶çš„æ“ä½œéƒ½æ˜¯ä¸²è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆæ¯”è¾ƒé•¿æ—¶é—´çš„å»¶è¿Ÿã€‚é»˜è®¤å€¼ä¸º4</td>
</tr>
<tr>
<td align="left">27</td>
<td align="left"><code>glueoutputbuf yes</code></td>
<td align="left">è®¾ç½®åœ¨å‘å®¢æˆ·ç«¯åº”ç­”æ—¶ï¼Œæ˜¯å¦æŠŠè¾ƒå°çš„åŒ…åˆå¹¶ä¸ºä¸€ä¸ªåŒ…å‘é€ï¼Œé»˜è®¤ä¸ºå¼€å¯</td>
</tr>
<tr>
<td align="left">28</td>
<td align="left"><code>hash-max-zipmap-entries 64 hash-max-zipmap-value 512</code></td>
<td align="left">æŒ‡å®šåœ¨è¶…è¿‡ä¸€å®šçš„æ•°é‡æˆ–è€…æœ€å¤§çš„å…ƒç´ è¶…è¿‡æŸä¸€ä¸´ç•Œå€¼æ—¶ï¼Œé‡‡ç”¨ä¸€ç§ç‰¹æ®Šçš„å“ˆå¸Œç®—æ³•</td>
</tr>
<tr>
<td align="left">29</td>
<td align="left"><code>activerehashing yes</code></td>
<td align="left">æŒ‡å®šæ˜¯å¦æ¿€æ´»é‡ç½®å“ˆå¸Œï¼Œé»˜è®¤ä¸ºå¼€å¯ï¼ˆåé¢åœ¨ä»‹ç» Redis çš„å“ˆå¸Œç®—æ³•æ—¶å…·ä½“ä»‹ç»ï¼‰</td>
</tr>
<tr>
<td align="left">30</td>
<td align="left"><code>include /path/to/local.conf</code></td>
<td align="left">æŒ‡å®šåŒ…å«å…¶å®ƒçš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨åŒä¸€ä¸»æœºä¸Šå¤šä¸ªRediså®ä¾‹ä¹‹é—´ä½¿ç”¨åŒä¸€ä»½é…ç½®æ–‡ä»¶ï¼Œè€ŒåŒæ—¶å„ä¸ªå®ä¾‹åˆæ‹¥æœ‰è‡ªå·±çš„ç‰¹å®šé…ç½®æ–‡ä»¶</td>
</tr>
</tbody></table>
<h3 id="4-3-ğŸ”-é‡ç‚¹è¯¦è§£"><a href="#4-3-ğŸ”-é‡ç‚¹è¯¦è§£" class="headerlink" title="4.3 ğŸ” é‡ç‚¹è¯¦è§£"></a>4.3 ğŸ” é‡ç‚¹è¯¦è§£</h3><ol>
<li><p>UNIT: rediså¯¹å¤§å°å†™ä¸æ•æ„Ÿ</p>
</li>
<li><p>INCLUEDS[æ¨¡å—]: å¯ä»¥åŒ…å«å¤šä¸ªé…ç½®æ–‡ä»¶</p>
</li>
<li><p>MOUDLES[æ¨¡å—]: å¯åŠ¨æ—¶åŠ è½½æ¨¡å—</p>
</li>
<li><p>NETWORK[ç½‘ç»œ]: </p>
<ul>
<li>bind: ç»‘å®šIP</li>
<li>protected-mode: ä¿æŠ¤æ¨¡å¼</li>
<li>post: ç«¯å£è®¾ç½®</li>
</ul>
</li>
<li><p>GENERAL[é€šç”¨]: </p>
<ul>
<li>daemonize: æ˜¯å¦ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œ<a href="%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B">^1</a></li>
<li>pidfile /var/run/redis_6379.pid: å¦‚æœä»¥åå°çš„æ–¹å¼è¿è¡Œï¼Œå°±éœ€è¦æŒ‡å®šä¸€ä¸ªpidçš„é…ç½®æ–‡ä»¶</li>
<li>loglevel: æ—¥å¿—çº§åˆ«</li>
<li>logfile: æ—¥å¿—çš„æ–‡ä»¶ä½ç½®</li>
<li>database: æ•°æ®åº“çš„æ•°é‡</li>
<li>always-show-logo: æ˜¯å¦å¼€å¯æœåŠ¡çš„æ—¶å€™æ˜¾ç¤ºlogo</li>
</ul>
</li>
<li><p>SNAPSHOTTING[å¿«ç…§]:</p>
<ul>
<li>save 900 1: å¦‚æœåœ¨900så†…ï¼Œè‡³å°‘æœ‰1ä¸ªkeyè¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</li>
<li>save 300 10: å¦‚æœåœ¨300så†…ï¼Œè‡³å°‘æœ‰10ä¸ªkeyè¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</li>
<li>save 60 10000: å¦‚æœåœ¨60så†…ï¼Œè‡³å°‘æœ‰10000ä¸ªkeyè¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</li>
<li>stop-writes-on-bgsave-error: æŒä¹…åŒ–å‡ºç°é”™è¯¯ï¼Œæ˜¯å¦è®©redisç»§ç»­å·¥ä½œ</li>
<li>rdbcompression: æ˜¯å¦å‹ç¼©rdbæ–‡ä»¶ï¼Œéœ€è¦æ¶ˆè€—ä¸€äº›CPUèµ„æº</li>
<li>rdbchecksum: ä¿å­˜rdbçš„æ–‡ä»¶çš„æ—¶å€™ï¼Œæ˜¯å¦è¿›è¡Œé”™è¯¯æ ¡éªŒ</li>
<li>dir: æ–‡ä»¶ä¿å­˜çš„ç›®å½•</li>
</ul>
</li>
<li><p>REPLICATION[å¤åˆ¶]:</p>
<ul>
<li>è§ä¸»ä»å¤åˆ¶</li>
</ul>
</li>
<li><p>SECURITY[å®‰å…¨]:</p>
<ul>
<li><p>requirepass: è®¾ç½®å¯†ç </p>
</li>
<li><pre><code class="shell"># è®¾ç½®å¯†ç 
&gt; config set requirepass &lt;password&gt;
# ç™»å½•è¾“å…¥
&gt; auth &lt;password&gt;
# è·å–å¯†ç 
&gt; config get requirepass
# å–æ¶ˆè®¾ç½®
&gt; config set requirepass &#39;&#39;</code></pre>
</li>
</ul>
</li>
<li><p>CLIENTS[å®¢æˆ·ç«¯]:</p>
<ul>
<li>maxclients: è®¾ç½®å¯è¿æ¥redisçš„æœ€å¤§å®¢æˆ·ç«¯æ•°é‡</li>
<li>maxmemory: é…ç½®redisçš„æœ€å¤§å†…å­˜å®¹é‡</li>
<li>maxmemory-policy: å†…å­˜åˆ°è¾¾ä¸Šé™çš„å¤„ç†ç­–ç•¥<ul>
<li>volatile-lruï¼šåªå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyè¿›è¡ŒLRUï¼ˆé»˜è®¤å€¼ï¼‰ </li>
<li>allkeys-lru ï¼š åˆ é™¤lruç®—æ³•çš„key  </li>
<li>volatile-randomï¼šéšæœºåˆ é™¤å³å°†è¿‡æœŸkey  </li>
<li>allkeys-randomï¼šéšæœºåˆ é™¤  </li>
<li>volatile-ttl ï¼š åˆ é™¤å³å°†è¿‡æœŸçš„  </li>
<li>noeviction ï¼š æ°¸ä¸è¿‡æœŸï¼Œè¿”å›é”™è¯¯</li>
</ul>
</li>
</ul>
</li>
<li><p>APPEND ONLY MODE[AOF]:</p>
<ul>
<li>appendonly: é»˜è®¤ä¸å¼€å¯AOFæ¨¡å¼</li>
<li>appendfilename: AOFæŒä¹…åŒ–çš„æ–‡ä»¶åç§°</li>
<li>appendfsync always: æ¯æ¬¡ä¿®æ”¹éƒ½ä¼šåŒæ­¥ï¼Œæ¶ˆè€—æ€§èƒ½</li>
<li>appendfsync everysec: æ¯ç§’æ‰§è¡Œä¸€æ¬¡åŒæ­¥ï¼Œå¯èƒ½ä¼šä¸¢å¤±è¿™1sçš„æ•°æ®</li>
<li>appendfsync no: ä¸æ‰§è¡ŒåŒæ­¥ï¼Œæ“ä½œç³»ç»Ÿè‡ªå·±åŒæ­¥æ•°æ®ï¼Œé€Ÿåº¦æœ€å¿«</li>
</ul>
</li>
</ol>
<h2 id="5-ğŸ“©Redisæµ‹è¯•"><a href="#5-ğŸ“©Redisæµ‹è¯•" class="headerlink" title="5. ğŸ“©Redisæµ‹è¯•"></a>5. ğŸ“©Redisæµ‹è¯•</h2><h3 id="5-1ğŸ”¬æµ‹è¯•æ–¹æ³•"><a href="#5-1ğŸ”¬æµ‹è¯•æ–¹æ³•" class="headerlink" title="5.1ğŸ”¬æµ‹è¯•æ–¹æ³•"></a>5.1ğŸ”¬æµ‹è¯•æ–¹æ³•</h3><blockquote>
<p>redisçš„æ€§èƒ½æµ‹è¯•å‘½ä»¤</p>
</blockquote>
<pre><code class="shell">redis-benchmark [option] [option value]</code></pre>
<p>ğŸ””<strong>æ³¨æ„: è¿™ä¸ªå‘½ä»¤æ˜¯åœ¨redisç›®å½•ä¸‹æ‰§è¡Œï¼Œè€Œérediså®¢æˆ·ç«¯çš„å†…éƒ¨å‘½ä»¤</strong></p>
<h3 id="5-2-ğŸ“redisæ€§èƒ½æµ‹è¯•å·¥å…·å¯é€‰å‚æ•°"><a href="#5-2-ğŸ“redisæ€§èƒ½æµ‹è¯•å·¥å…·å¯é€‰å‚æ•°" class="headerlink" title="5.2 ğŸ“redisæ€§èƒ½æµ‹è¯•å·¥å…·å¯é€‰å‚æ•°"></a>5.2 ğŸ“redisæ€§èƒ½æµ‹è¯•å·¥å…·å¯é€‰å‚æ•°</h3><table>
<thead>
<tr>
<th align="left">åºå·</th>
<th align="left">é€‰é¡¹</th>
<th align="left">æè¿°</th>
<th align="left">é»˜è®¤å€¼</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left"><strong>-h</strong></td>
<td align="left">æŒ‡å®šæœåŠ¡å™¨ä¸»æœºå</td>
<td align="left">127.0.0.1</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left"><strong>-p</strong></td>
<td align="left">æŒ‡å®šæœåŠ¡å™¨ç«¯å£</td>
<td align="left">6379</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left"><strong>-s</strong></td>
<td align="left">æŒ‡å®šæœåŠ¡å™¨ socket</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">4</td>
<td align="left"><strong>-c</strong></td>
<td align="left">æŒ‡å®šå¹¶å‘è¿æ¥æ•°</td>
<td align="left">50</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left"><strong>-n</strong></td>
<td align="left">æŒ‡å®šè¯·æ±‚æ•°</td>
<td align="left">10000</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left"><strong>-d</strong></td>
<td align="left">ä»¥å­—èŠ‚çš„å½¢å¼æŒ‡å®š SET/GET å€¼çš„æ•°æ®å¤§å°</td>
<td align="left">3</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left"><strong>-k</strong></td>
<td align="left">1=keep alive 0=reconnect</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">8</td>
<td align="left"><strong>-r</strong></td>
<td align="left">SET/GET/INCR ä½¿ç”¨éšæœº key, SADD ä½¿ç”¨éšæœºå€¼</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">9</td>
<td align="left"><strong>-P</strong></td>
<td align="left">é€šè¿‡ç®¡é“ä¼ è¾“ <numreq> è¯·æ±‚</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">10</td>
<td align="left"><strong>-q</strong></td>
<td align="left">å¼ºåˆ¶é€€å‡º redisã€‚ä»…æ˜¾ç¤º query/sec å€¼</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">11</td>
<td align="left"><strong>â€“csv</strong></td>
<td align="left">ä»¥ CSV æ ¼å¼è¾“å‡º</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">12</td>
<td align="left"><strong>-l</strong></td>
<td align="left">ç”Ÿæˆå¾ªç¯ï¼Œæ°¸ä¹…æ‰§è¡Œæµ‹è¯•</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">13</td>
<td align="left"><strong>-t</strong></td>
<td align="left">ä»…è¿è¡Œä»¥é€—å·åˆ†éš”çš„æµ‹è¯•å‘½ä»¤åˆ—è¡¨ã€‚</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">14</td>
<td align="left"><strong>-I</strong></td>
<td align="left">Idle æ¨¡å¼ã€‚ä»…æ‰“å¼€ N ä¸ª idle è¿æ¥å¹¶ç­‰å¾…ã€‚</td>
<td align="left"></td>
</tr>
</tbody></table>
<h3 id="5-3-ğŸ“Šæµ‹è¯•ç»“æœåˆ†æ"><a href="#5-3-ğŸ“Šæµ‹è¯•ç»“æœåˆ†æ" class="headerlink" title="5.3 ğŸ“Šæµ‹è¯•ç»“æœåˆ†æ"></a>5.3 ğŸ“Šæµ‹è¯•ç»“æœåˆ†æ</h3><pre><code class="shell">redis-benchmark -h 127.0.0.1 -p 6379 -c 100 -n 100000 </code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009193727448.png" class="" title="image-20201009193727448">

<pre><code class="shell">redis-benchmark -h 127.0.0.1 -p 6379 -c 1 -n 100000 -q</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201009194004617.png" class="" title="image-20201009194004617">

<p>è¿™ä¸ªæ˜¯å¯¹æ‰€æœ‰æ“ä½œæµ‹è¯•æ€§èƒ½ï¼Œæ¯ç§’å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚</p>
<h2 id="6-ğŸ“©RedisåŸºç¡€"><a href="#6-ğŸ“©RedisåŸºç¡€" class="headerlink" title="6. ğŸ“©RedisåŸºç¡€"></a>6. ğŸ“©RedisåŸºç¡€</h2><h3 id="6-1-ğŸ’ Redisæ•°æ®åº“"><a href="#6-1-ğŸ’ Redisæ•°æ®åº“" class="headerlink" title="6.1 ğŸ’ Redisæ•°æ®åº“"></a>6.1 ğŸ’ Redisæ•°æ®åº“</h3><p><strong>redisæœ‰16ä¸ªæ•°æ®åº“ï¼Œé»˜è®¤ä½¿ç”¨ç¬¬0ä¸ª</strong></p>
<blockquote>
<p>æµ‹è¯•è¿æ¥</p>
</blockquote>
<pre><code class="shell">ping</code></pre>
<blockquote>
<p>å…³é—­è¿æ¥</p>
</blockquote>
<pre><code class="shell">quit</code></pre>
<blockquote>
<p>è¿”å›æ¶ˆæ¯</p>
</blockquote>
<pre><code class="shell">echo &lt;str&gt;</code></pre>
<blockquote>
<p>åˆ‡æ¢æ•°æ®åº“</p>
</blockquote>
<pre><code class="bash">select &lt;num of database&gt;</code></pre>
<blockquote>
<p>è·å–å½“å‰æ•°æ®åº“çš„å¤§å°</p>
</blockquote>
<pre><code class="shell">dbsize</code></pre>
<blockquote>
<p>æ¸…ç©ºå½“å‰æ•°æ®åº“</p>
</blockquote>
<pre><code class="shell">flushdb</code></pre>
<blockquote>
<p>æ¸…ç©ºæ‰€æœ‰æ•°æ®åº“</p>
</blockquote>
<pre><code class="shell">flushall</code></pre>
<blockquote>
<p>äº¤æ¢æ•°æ®åº“</p>
</blockquote>
<pre><code class="shell">swap &lt;n1&gt; &lt;n2&gt;</code></pre>
<h3 id="6-2-ğŸŒ6379çš„æ•…äº‹"><a href="#6-2-ğŸŒ6379çš„æ•…äº‹" class="headerlink" title="6.2 ğŸŒ6379çš„æ•…äº‹"></a>6.2 ğŸŒ6379çš„æ•…äº‹</h3><p><strong>redisé»˜è®¤ç«¯å£å·ä¸º6379</strong></p>
<blockquote>
<p>ä½œè€…åœ¨è‡ªå·±çš„ä¸€ç¯‡åšæ–‡ä¸­è§£é‡Šäº†ä¸ºä»€ä¹ˆé€‰ç”¨ 6379 ä½œä¸ºé»˜è®¤ç«¯å£ï¼Œå› ä¸º 6379 åœ¨æ‰‹æœºæŒ‰é”®ä¸Š MERZ å¯¹åº”çš„å·ç ï¼Œè€Œ MERZ å–è‡ªæ„å¤§åˆ©æ­Œå¥³ Alessia Merz çš„åå­—ã€‚MERZé•¿æœŸä»¥æ¥è¢«Redisä½œè€…antirezåŠå…¶æœ‹å‹å½“ä½œæ„šè ¢çš„ä»£åè¯ï¼Œåæ¥ä½œè€…åœ¨å¼€å‘Rediså°±é€‰ç”¨äº†è¿™ä¸ªç«¯å£ã€‚</p>
</blockquote>
<h3 id="6-3-âš¡Redisèœœæ±é€Ÿåº¦"><a href="#6-3-âš¡Redisèœœæ±é€Ÿåº¦" class="headerlink" title="6.3 âš¡Redisèœœæ±é€Ÿåº¦"></a>6.3 âš¡Redisèœœæ±é€Ÿåº¦</h3><p><strong>redisæ˜¯å•çº¿ç¨‹çš„ã€‚</strong></p>
<p>redisåŸºäºå†…å­˜æ“ä½œï¼ŒCPUä¸æ˜¯redisçš„æ€§èƒ½ç“¶é¢ˆï¼ŒRedisçš„ç“¶é¢ˆå¾ˆå¯èƒ½æ˜¯æœºå™¨å†…å­˜æˆ–è€…ç½‘è·¯å¸¦å®½ã€‚</p>
<p>æ—¢ç„¶å•çº¿ç¨‹å®¹æ˜“å®ç°ï¼Œè€Œä¸”CPUä¸ä¼šæˆä¸ºç“¶é¢ˆï¼Œé‚£å°±é¡ºç†æˆç« çš„é‡‡ç”¨å•çº¿ç¨‹å®ç°ã€‚</p>
<blockquote>
<p>ğŸ’‰ç†è§£Redisèœœæ±é€Ÿåº¦éœ€è¦è·¨è¿‡ä¸¤ä¸ªè¯¯åŒº</p>
</blockquote>
<ul>
<li><p>è¯¯åŒº1ï¼šé«˜æ€§èƒ½çš„æœåŠ¡å™¨ä¸€å®šæ˜¯å¤šçº¿ç¨‹çš„ï¼Ÿ</p>
</li>
<li><p>è¯¯åŒº2ï¼šå¤šçº¿ç¨‹çš„æ•ˆç‡ä¸€å®šæ¯”å•çº¿ç¨‹é«˜ï¼Ÿ</p>
</li>
</ul>
<blockquote>
<p>ğŸ’ŠRedisé‡‡ç”¨å•çº¿ç¨‹ä¾ç„¶å¿«çš„åŸå› </p>
</blockquote>
<ol>
<li>Rediså®Œå…¨åŸºäºå†…å­˜ï¼Œè¯»å†™å…¨éƒ¨åœ¨ä¸€ä¸ªCPUä¸Šï¼Œç»å¤§éƒ¨åˆ†è¯·æ±‚æ˜¯çº¯ç²¹çš„å†…å­˜æ“ä½œï¼Œéå¸¸è¿…é€Ÿï¼Œæ•°æ®å­˜åœ¨äºå†…å­˜ä¸­ï¼Œç±»ä¼¼äºHashMapï¼ŒHashMapçš„ä¼˜åŠ¿å°±æ˜¯æŸ¥è¯¢å’Œæ“ä½œçš„æ—¶é—´å¤æ‚åº¦æ—¶O(1)</li>
<li>æ•°æ®ç»“æ„ç®€å•ï¼Œå¯¹æ•°æ®æ“ä½œä¹Ÿç®€å•</li>
<li>é‡‡ç”¨å•çº¿ç¨‹ï¼Œé¿å…äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰æ¡ä»¶ï¼Œä¸å­˜åœ¨å¤šçº¿ç¨‹å¯¼è‡´çš„CPUåˆ‡æ¢ï¼Œä¸ç”¨å–è€ƒè™‘å„ç§é”çš„é—®é¢˜ï¼Œä¸å­˜åœ¨åŠ é”æ”¾é”æ“ä½œï¼Œæ²¡æœ‰æ­»é”é—®é¢˜å¯¼è‡´çš„æ€§èƒ½æ¶ˆè€—</li>
<li>ä½¿ç”¨å¤šè·¯å¤ç”¨IOæ¨¡å‹ï¼Œéé˜»å¡IO</li>
</ol>
<h2 id="7-ğŸ“©Redisæ•°æ®ç±»å‹"><a href="#7-ğŸ“©Redisæ•°æ®ç±»å‹" class="headerlink" title="7. ğŸ“©Redisæ•°æ®ç±»å‹"></a>7. ğŸ“©Redisæ•°æ®ç±»å‹</h2><blockquote>
<p>ğŸŒè¯´æ˜</p>
</blockquote>
<p>æ‰€æœ‰å‘½ä»¤å¯æŸ¥çœ‹ä¸­æ–‡å®˜æ–¹æ–‡æ¡£: <a href="http://redis.cn/commands.html#">http://redis.cn/commands.html#</a></p>
<h3 id="7-1-ğŸ†äº”å¤§æ•°æ®ç±»å‹"><a href="#7-1-ğŸ†äº”å¤§æ•°æ®ç±»å‹" class="headerlink" title="7.1 ğŸ†äº”å¤§æ•°æ®ç±»å‹"></a>7.1 ğŸ†äº”å¤§æ•°æ®ç±»å‹</h3><table>
<thead>
<tr>
<th align="center">ç±»å‹</th>
<th align="center">ç®€ä»‹</th>
<th align="center">ç‰¹æ€§</th>
<th align="center">åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td align="center">String(å­—ç¬¦ä¸²)</td>
<td align="center">äºŒè¿›åˆ¶å®‰å…¨</td>
<td align="center">å¯ä»¥åŒ…å«ä»»ä½•æ•°æ®ï¼Œæ¯”å¦‚jpgå›¾ç‰‡æˆ–è€…åºåˆ—åŒ–å¯¹è±¡</td>
<td align="center">â€”</td>
</tr>
<tr>
<td align="center">Hash(å­—å…¸)</td>
<td align="center">é”®å€¼å¯¹é›†åˆ</td>
<td align="center">é€‚åˆå­˜å‚¨å¯¹è±¡ï¼Œå¹¶ä¸”å¯ä»¥åƒæ•°æ®åº“ä¸­çš„updateä¸€ä¸ªå±æ€§ä¸€æ ·å€¼ä¿®æ”¹æŸä¸€é¡¹å±æ€§å€¼</td>
<td align="center">å­˜å‚¨ã€è¯»å–ã€ä¿®æ”¹ç”¨æˆ·å±æ€§</td>
</tr>
<tr>
<td align="center">List(åˆ—è¡¨)</td>
<td align="center">åŒå‘é“¾è¡¨</td>
<td align="center">å¢åˆ å¿«ï¼Œæä¾›äº†æ“ä½œæŸä¸€å…ƒç´ çš„api</td>
<td align="center">æœ€æ–°æ¶ˆæ¯æ’è¡Œï¼›æ¶ˆæ¯é˜Ÿåˆ—</td>
</tr>
<tr>
<td align="center">Set(é›†åˆ)</td>
<td align="center">hashè¡¨å®ç°ï¼Œå…ƒç´ ä¸é‡å¤</td>
<td align="center">å¢åˆ æŸ¥å¿«ï¼Œæä¾›äº†æ±‚äº¤é›†ã€å¹¶é›†å’Œå·®é›†çš„æ“ä½œ</td>
<td align="center">å…±åŒå¥½å‹:  åˆ©ç”¨å”¯ä¸€æ€§ï¼Œç»Ÿè®¡ç½‘ç«™UV</td>
</tr>
<tr>
<td align="center">Sorted Set(æœ‰åºé›†åˆ)</td>
<td align="center">å°†setä¸­çš„å…ƒç´ å¢åŠ ä¸€ä¸ªæƒé‡scoreï¼Œå…ƒç´ æŒ‰ç…§scoreæœ‰åºæ’åˆ—</td>
<td align="center">æ•°æ®æ’å…¥é›†åˆæ—¶ï¼Œå·²ç»è¿›è¡Œäº†å¤©ç„¶æ’åº</td>
<td align="center">æ’è¡Œæ¦œï¼›å¸¦æƒé‡çš„æ¶ˆæ¯é˜Ÿåˆ—</td>
</tr>
</tbody></table>
<p><strong>ğŸ²Key</strong></p>
<blockquote>
<p>æŸ¥çœ‹æ‰€æœ‰çš„key</p>
</blockquote>
<pre><code class="shell">keys *</code></pre>
<blockquote>
<p>åˆ›å»ºé”®å€¼å¯¹</p>
</blockquote>
<pre><code class="shell">set &lt;key&gt; &lt;value&gt;</code></pre>
<blockquote>
<p>è·å–keyçš„å€¼</p>
</blockquote>
<pre><code class="shell">get &lt;key&gt;</code></pre>
<blockquote>
<p>ç§»é™¤é”®å€¼å¯¹</p>
</blockquote>
<pre><code class="shell">move &lt;key&gt; &lt;value&gt;</code></pre>
<blockquote>
<p>åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨</p>
</blockquote>
<pre><code class="shell">exists &lt;key&gt;</code></pre>
<blockquote>
<p>æŸ¥çœ‹keyçš„ç±»å‹</p>
</blockquote>
<pre><code class="shell">type &lt;key&gt;</code></pre>
<blockquote>
<p>è®¾ç½®keyçš„è¿‡æœŸæ—¶é—´/ç§’</p>
</blockquote>
<pre><code class="shell">expire &lt;key&gt; &lt;seconds&gt; </code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰æ•ˆæ—¶é—´/ç§’</p>
</blockquote>
<pre><code class="shell">ttl &lt;key&gt;</code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰æ•ˆæ—¶é—´/æ¯«ç§’</p>
</blockquote>
<pre><code class="shell">pttl &lt;key&gt;</code></pre>
<h4 id="7-1-1-âš½String"><a href="#7-1-1-âš½String" class="headerlink" title="7.1.1 âš½String"></a>7.1.1 âš½String</h4><blockquote>
<p>å‘keyä¸Šè¿½åŠ å­—ç¬¦ä¸²</p>
</blockquote>
<pre><code class="shell">append &lt;key&gt; &lt;value&gt;</code></pre>
<blockquote>
<p>è·å–keyçš„é•¿åº¦</p>
</blockquote>
<pre><code class="shell">strlen &lt;key&gt;</code></pre>
<blockquote>
<p>Integeræ“ä½œ</p>
</blockquote>
<pre><code class="shell"># åŠ 1
incr &lt;key&gt;
# åŠ n
incrby &lt;key&gt; n
# å‡1
decr &lt;key&gt;
# å‡n
decrby &lt;key&gt; n</code></pre>
<blockquote>
<p>subString(start, end)æ“ä½œ</p>
</blockquote>
<pre><code class="shell"># æˆªå–æ•´ä¸ªå­—ç¬¦ä¸²
getrange &lt;key&gt; 0 -1
# æˆªå–éƒ¨åˆ†å­—ç¬¦ä¸²
getrange &lt;key&gt; start end
# ä¾‹å¦‚
&gt; set s &quot;Khighness&quot;
&gt; getrange s 0 -1 # &quot;Khighness&quot;
&gt; getrange s 1 4  # &quot;high&quot;</code></pre>
<blockquote>
<p>replace(start, end)æ“ä½œ</p>
</blockquote>
<pre><code class="shell"># æŠŠå­—ç¬¦ä¸²ä»nä½å¼€å§‹ä¹‹åçš„å­—ç¬¦æ›¿æ¢ä¸ºæ–°çš„å­—ç¬¦ä¸²newStr
setrange &lt;key&gt; n newStr
# ä¾‹å¦‚
&gt; set s &quot;Khighness&quot;
&gt; setrange s 0 X 
&gt; get s # &quot;Xhighness&quot;
&gt; setrange s 5 &quot;XXXXX&quot;
&gt; get s # &quot;XhighXXXXX&quot;</code></pre>
<blockquote>
<p>setex (set with expire) åˆ›å»ºé”®å€¼å¯¹çš„åŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´</p>
<p>setnx (set if not exist)  å¦‚æœkeyä¸å­˜åœ¨åˆ™åˆ›å»ºé”®å€¼å¯¹ï¼Œé˜²æ­¢è¦†ç›–åŸæœ‰é”®å€¼å¯¹ (åˆ†å¸ƒå¼é”ä¸­ç»å¸¸ä½¿ç”¨)</p>
</blockquote>
<pre><code class="shell"># è®¾ç½®é”®å€¼å¯¹ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
setex &lt;key&gt; &lt;seconds&gt; &lt;value&gt;
# keyä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºé”®å€¼å¯¹
setnx &lt;key&gt; &lt;value&gt;

# ä¾‹å¦‚
127.0.0.1:6379&gt; setex k1 10 parak
OK
127.0.0.1:6379&gt; ttl k1
(integer) 5
127.0.0.1:6379&gt; ttl k1
(integer) 3
127.0.0.1:6379&gt; ttl k1
(integer) 2
127.0.0.1:6379&gt; ttl k1
(integer) 2
127.0.0.1:6379&gt; ttl k1
(integer) 1
127.0.0.1:6379&gt; ttl k1
(integer) -2
127.0.0.1:6379&gt; get k1
(nil)

127.0.0.1:6379&gt; setnx k2 parak
(integer) 1 # 1ä»£è¡¨è®¾ç½®æˆåŠŸ
127.0.0.1:6379&gt; setnx k2 flowerk
(integer) 0 # 0ä»£è¡¨è®¾ç½®å¤±è´¥
127.0.0.1:6379&gt; get k2
&quot;parak&quot;     
127.0.0.1:6379&gt; setnx k2 FlowerK
(integer) 0 
127.0.0.1:6379&gt; set k2 FlowerK
OK          # å¼ºåˆ¶è®¾ç½®value
127.0.0.1:6379&gt; get k2
&quot;FlowerK&quot;</code></pre>
<blockquote>
<p>å¤šä¸ªé”®å€¼å¯¹æ“ä½œ</p>
</blockquote>
<pre><code class="shell"># ä¸€æ¬¡æ€§åˆ›å»ºå¤šä¸ªé”®å€¼å¯¹
mset &lt;key&gt; &lt;value&gt; [key value ...]
# è·å–å¤šä¸ªkeyçš„å€¼
meget &lt;key&gt; [key ...]
# ä¸å­˜åœ¨åˆ™åˆ›å»ºå¤šä¸ªé”®å€¼å¯¹
# åŸå­æ€§æ“ä½œï¼Œåªè¦å…¶ä¸­æœ‰ä¸€ä¸ªkeyå·²å­˜åœ¨ï¼Œå°±ä¼šå…¨éƒ¨åˆ›å»ºå¤±è´¥
msetnx &lt;key&gt; &lt;value&gt; [key value ...]

# ä¾‹å¦‚
127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3
OK
127.0.0.1:6379&gt; mget k1 k2 k3
1) &quot;v1&quot;
2) &quot;v2&quot;
3) &quot;v3&quot;
127.0.0.1:6379&gt; msetnx k2 v2 k4 v4 k5 v5
(integer) 0
127.0.0.1:6379&gt; keys *
1) &quot;k2&quot;
2) &quot;k3&quot;
3) &quot;k1&quot;

# å·§å¦™è®¾è®¡key  object:&#123;id&#125;:&#123;field&#125;
127.0.0.1:6379&gt; mset user:1:name Khighness user:1:age 18
OK
127.0.0.1:6379&gt; mget user:1:name user:1:age
1) &quot;Khighness&quot;
2) &quot;18&quot;
</code></pre>
<blockquote>
<p>ç»„åˆæ“ä½œ</p>
</blockquote>
<pre><code class="shell"># å…ˆè·å–å€¼ï¼Œå†è®¾ç½®æ–°çš„å€¼
getset k v</code></pre>
<h4 id="7-1-2-âš¾List"><a href="#7-1-2-âš¾List" class="headerlink" title="7.1.2 âš¾List"></a>7.1.2 âš¾List</h4><p>redisé‡Œé¢ï¼Œlistå¯ä»¥å½“æˆæ ˆã€é˜Ÿåˆ—ã€é˜Ÿåˆ—ã€‚</p>
<blockquote>
<p>å‘listçš„å¤´éƒ¨æ·»åŠ å€¼</p>
</blockquote>
<pre><code class="shell">lpush &lt;key&gt; value [value ...]</code></pre>
<blockquote>
<p>å‘listçš„å°¾éƒ¨æ·»åŠ å€¼</p>
</blockquote>
<pre><code class="shell">rpush &lt;key&gt; value [value ...]</code></pre>
<blockquote>
<p>åˆ¤æ–­listæ˜¯å¦å­˜åœ¨</p>
</blockquote>
<pre><code class="shell">exists &lt;key&gt;</code></pre>
<blockquote>
<p>ç§»é™¤åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ </p>
</blockquote>
<pre><code class="shell">lpop &lt;key&gt; </code></pre>
<blockquote>
<p>ç§»é™¤åˆ—è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ </p>
</blockquote>
<pre><code class="shell">rpop &lt;key&gt; </code></pre>
<blockquote>
<p>ç§»é™¤æŒ‡å®šçš„å€¼</p>
</blockquote>
<pre><code class="shell">lrem &lt;key&gt; &lt;count&gt; &lt;value&gt;</code></pre>
<blockquote>
<p>æ›´æ–°list</p>
</blockquote>
<pre><code class="shell"># æ ¹æ®indexæ›´æ–°å€¼
lset &lt;key&gt; &lt;index&gt; &lt;value&gt;</code></pre>
<blockquote>
<p>æ ¹æ®ä¸‹æ ‡è·å–å€¼</p>
</blockquote>
<pre><code class="shell">lindex &lt;key&gt; &lt;index&gt;</code></pre>
<blockquote>
<p>è·å–listçš„é•¿åº¦</p>
</blockquote>
<pre><code class="shell">llen &lt;key&gt;</code></pre>
<blockquote>
<p>è·å–listæŒ‡å®šèŒƒå›´çš„å€¼</p>
</blockquote>
<pre><code class="shell"># è·å–æ•´ä¸ªlistçš„å€¼
lrange &lt;key&gt; 0 -1
# è·å–æŒ‡å®šèŒƒå›´çš„å€¼
lrange &lt;key&gt; start end

# ä¾‹å¦‚
127.0.0.1:6379&gt; lpush list1 1 2 3 4 5 
(integer) 5
127.0.0.1:6379&gt; lrange list1 0 -1
1) &quot;5&quot;
2) &quot;4&quot;
3) &quot;3&quot;
4) &quot;2&quot;
5) &quot;1&quot;
127.0.0.1:6379&gt; lrange list1 0 1
1) &quot;5&quot;
2) &quot;4&quot;
127.0.0.1:6379&gt; rpush list2 1 2 3 4 5
(integer) 5
127.0.0.1:6379&gt; lrange list2 0 -1
1) &quot;1&quot;
2) &quot;2&quot;
3) &quot;3&quot;
4) &quot;4&quot;
5) &quot;5&quot;
127.0.0.1:6379&gt; lrange list2 0 1
1) &quot;1&quot;
2) &quot;2&quot;</code></pre>
<blockquote>
<p>æˆªå–listä¸­æŒ‡å®šèŒƒå›´çš„å€¼</p>
</blockquote>
<pre><code class="shell"># ä¿ç•™ä¸‹æ ‡[start, end]çš„å€¼
ltrim &lt;key&gt; start end

# ä¾‹å¦‚
127.0.0.1:6379&gt; rpush list parak1 parak2 parak3 parak4 parak5
(integer) 5
127.0.0.1:6379&gt; ltrim list 0 2
OK
127.0.0.1:6379&gt; lrange list 0 -1
1) &quot;parak1&quot;
2) &quot;parak2&quot;
3) &quot;parak3&quot;</code></pre>
<blockquote>
<p>ç»„åˆæ“ä½œ</p>
</blockquote>
<pre><code class="shell"># ç§»é™¤sourceçš„å°¾éƒ¨çš„å€¼æ’å…¥åˆ°destinationçš„å¤´éƒ¨
rpoplpush &lt;source&gt; &lt;destination&gt;

# ä¾‹å¦‚
127.0.0.1:6379&gt; rpush list 1 2 3 4 5
(integer) 5
127.0.0.1:6379&gt; rpoplpush list newlist
&quot;5&quot;
127.0.0.1:6379&gt; lrange newlist 0 -1
1) &quot;5&quot;</code></pre>
<blockquote>
<p>åœ¨listä¸­æ’å…¥å€¼</p>
</blockquote>
<pre><code class="shell"># åœ¨listä¸­çš„æŸä¸ªå€¼ä¹‹å‰æ’å…¥
linsert &lt;key&gt; before &lt;priot&gt; &lt;value&gt;
# åœ¨listä¸­çš„æŸä¸ªå€¼ä¹‹åæ’å…¥
linsert &lt;key&gt; after &lt;priot&gt; &lt;value&gt;

# ä¾‹å¦‚
127.0.0.1:6379&gt; rpush list 1 2 3 4 5
(integer) 5
127.0.0.1:6379&gt; linsert list before 3 6
(integer) 6
127.0.0.1:6379&gt; lrange list 0 -1
1) &quot;1&quot;
2) &quot;2&quot;
3) &quot;6&quot;
4) &quot;3&quot;
5) &quot;4&quot;
6) &quot;5&quot;
127.0.0.1:6379&gt; linsert list after 5 7
(integer) 7
127.0.0.1:6379&gt; lrange list 0 -1
1) &quot;1&quot;
2) &quot;2&quot;
3) &quot;6&quot;
4) &quot;3&quot;
5) &quot;4&quot;
6) &quot;5&quot;
7) &quot;7&quot;</code></pre>
<h4 id="7-1-3-ğŸ€Set"><a href="#7-1-3-ğŸ€Set" class="headerlink" title="7.1.3 ğŸ€Set"></a>7.1.3 ğŸ€Set</h4><p>set æ— åºä¸é‡å¤é›†åˆ</p>
<ul>
<li>seté€šè¿‡å“ˆå¸Œè¡¨å®ç°ï¼Œæ‰€æœ‰å¢åˆ æŸ¥çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(1)</li>
</ul>
<blockquote>
<p>å‘setä¸­å›½æ·»åŠ å€¼</p>
</blockquote>
<pre><code class="shell">sadd &lt;key&gt; &lt;value&gt; [value ...]</code></pre>
<blockquote>
<p>æŸ¥çœ‹setä¸­çš„æ‰€æœ‰å€¼</p>
</blockquote>
<pre><code class="shell">smembers &lt;key&gt;</code></pre>
<blockquote>
<p>æŸ¥çœ‹setä¸­æ˜¯å¦åŒ…å«å€¼value</p>
</blockquote>
<pre><code class="shell">sismember &lt;key&gt; &lt;value&gt;</code></pre>
<blockquote>
<p>è·å–setä¸­çš„å…ƒç´ ä¸ªæ•°</p>
</blockquote>
<pre><code class="shell">scard &lt;key&gt;</code></pre>
<blockquote>
<p>ç§»é™¤setä¸­çš„å€¼value</p>
</blockquote>
<pre><code class="shell">srem &lt;key&gt; &lt;value&gt;</code></pre>
<blockquote>
<p>è·å–setä¸­çš„éšæœºå€¼(å¯ä»¥åšæŠ½å¥–åŠŸèƒ½)</p>
</blockquote>
<pre><code class="shell">srandmember &lt;key&gt;</code></pre>
<blockquote>
<p>éšæœºç§»é™¤setä¸­çš„å…ƒç´ </p>
</blockquote>
<pre><code class="shell">spop &lt;key&gt;</code></pre>
<blockquote>
<p>å°†ä¸€ä¸ªseté›†åˆä¸­æŒ‡å®šçš„å€¼ç§»åŠ¨åˆ°å¦ä¸€ä¸ªseté›†åˆ</p>
</blockquote>
<pre><code class="shell"># å°†sourceä¸­çš„valueç§»åŠ¨åˆ°destination
smove &lt;source&gt; &lt;destination&gt; &lt;value&gt;

# ä¾‹å¦‚
127.0.0.1:6379&gt; sadd set k1 k2 k3 k4 k5 k6 k7
(integer) 7
127.0.0.1:6379&gt; sadd newset k1
(integer) 1
127.0.0.1:6379&gt; smove set newset k3
(integer) 1
127.0.0.1:6379&gt; smembers newset
1) &quot;k3&quot;
2) &quot;k1&quot;</code></pre>
<blockquote>
<p>é›†åˆè¿ç®—</p>
</blockquote>
<pre><code class="shell"># é›†åˆs1å’Œs2çš„å¹¶é›†
sunion &lt;s1&gt; &lt;s&gt;
# é›†åˆs1å’Œs2çš„äº¤é›† (å®ç°å…±åŒå¥½å‹ã€å…±åŒå…³æ³¨)
sinter &lt;s1&gt; &lt;s2&gt;
# é›†åˆs1ä¸­ç‹¬æœ‰çš„å…ƒç´ 
sdiff &lt;s1&gt; &lt;s2&gt;

# ä¾‹å¦‚
127.0.0.1:6379&gt; sadd s1 k1 k2 k3 k4 k5 k6
(integer) 6
127.0.0.1:6379&gt; sadd s2 k5 k6 k7 k8 k9 k10
(integer) 6
127.0.0.1:6379&gt; sunion s1 s2
 1) &quot;k5&quot;
 2) &quot;k6&quot;
 3) &quot;k8&quot;
 4) &quot;k2&quot;
 5) &quot;k3&quot;
 6) &quot;k1&quot;
 7) &quot;k4&quot;
 8) &quot;k7&quot;
 9) &quot;k10&quot;
10) &quot;k9&quot;
127.0.0.1:6379&gt; sinter s1 s2
1) &quot;k5&quot;
2) &quot;k6&quot;
127.0.0.1:6379&gt; sdiff s1 s2
1) &quot;k2&quot;
2) &quot;k1&quot;
3) &quot;k3&quot;
4) &quot;k4&quot;</code></pre>
<h4 id="7-1-4-ğŸˆHash"><a href="#7-1-4-ğŸˆHash" class="headerlink" title="7.1.4 ğŸˆHash"></a>7.1.4 ğŸˆHash</h4><p>ç›¸å½“äºkey-HashMapï¼Œvalueä¸ºä¸€ä¸ªmapé›†åˆï¼Œæ›´é€‚åˆäºå¯¹è±¡çš„å­˜å‚¨ï¼Œå¤šç”¨äºå­˜å‚¨å˜æ›´æ•°æ®ã€</p>
<blockquote>
<p>è®¾ç½®keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µçš„å€¼</p>
</blockquote>
<pre><code class="shell">hset &lt;key&gt; &lt;field&gt; &lt;value&gt; </code></pre>
<blockquote>
<p>keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­ä¸å­˜åœ¨æŒ‡å®šå­—æ®µæ—¶ï¼Œè®¾ç½®å­—æ®µçš„å€¼</p>
</blockquote>
<pre><code class="shell">hsetnx &lt;key&gt; &lt;field&gt; &lt;value&gt;</code></pre>
<blockquote>
<p>åˆ é™¤keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µ</p>
</blockquote>
<pre><code class="shell">hdel &lt;key&gt; &lt;field&gt; [field ...]</code></pre>
<blockquote>
<p>åˆ¤æ–­keyæŒ‡å®šå“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µæ˜¯å¦å­˜åœ¨</p>
</blockquote>
<pre><code class="shell">hexists &lt;key&gt; &lt;field&gt;</code></pre>
<blockquote>
<p>å¯¹keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µçš„å€¼åŠ ä¸Šå¢é‡(Integerå‹ï¼Œå¯æ­£å¯è´Ÿï¼Œå­—æ®µä¸å­˜åœ¨åˆ™åœ¨æ“ä½œæ‰§è¡Œå‰æŠŠè¯¥å­—æ®µçš„å€¼è®¾ç½®ä¸º0)</p>
</blockquote>
<pre><code class="shell">hincrby &lt;key&gt; &lt;field&gt; &lt;integer&gt;</code></pre>
<blockquote>
<p>å¯¹keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µçš„å€¼åŠ ä¸Šå¢é‡(floatå‹ï¼Œå¯æ­£å¯è´Ÿï¼Œå­—æ®µä¸å­˜åœ¨åˆ™åœ¨æ“ä½œæ‰§è¡Œå‰æŠŠè¯¥å­—æ®µçš„å€¼è®¾ç½®ä¸º0)</p>
</blockquote>
<pre><code class="shell">hincrbyfloat &lt;key&gt; &lt;field&gt; &lt;float&gt;</code></pre>
<blockquote>
<p>è·å–keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­å­—æ®µæ•°é‡</p>
</blockquote>
<pre><code class="shell">hlen &lt;key&gt; </code></pre>
<blockquote>
<p>è·å–keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µçš„å€¼çš„å­—ç¬¦ä¸²é•¿åº¦</p>
</blockquote>
<pre><code class="shell">hstrlen hash &lt;key&gt; &lt;value&gt; </code></pre>
<blockquote>
<p>keyæŒ‡å®šçš„å“ˆå¸Œé›†æ“ä½œ</p>
</blockquote>
<pre><code class="shell"># è®¾ç½®keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µçš„å€¼
hmset &lt;key&gt; &lt;field&gt; &lt;value&gt; [field value ...]
# è·å–keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æŒ‡å®šå­—æ®µæ‰€å…³è”çš„å€¼
hmget &lt;key&gt; &lt;field&gt; [field ...]
# è·å–keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æ‰€æœ‰å­—æ®µçš„åå­—
hkeys
# è·å–keyæŒ‡å®šå“ˆå¸Œé›†ä¸­æ‰€æœ‰å­—æ®µçš„å€¼
hvals
# è·å–keyæŒ‡å®šçš„å“ˆå¸Œé›†ä¸­æ‰€æœ‰çš„å­—æ®µå’Œå€¼
hgetall

# ä¾‹å¦‚
127.0.0.1:6379&gt; hmset hash field1 hello field2 world
OK
127.0.0.1:6379&gt; hmget hash field1 field2
1) &quot;hello&quot;
2) &quot;world&quot;
127.0.0.1:6379&gt; hkeys hash
1) &quot;field1&quot;
2) &quot;field2&quot;
127.0.0.1:6379&gt; hvals hash
1) &quot;hello&quot;
2) &quot;world&quot;
127.0.0.1:6379&gt; hgetall hash
1) &quot;field1&quot;
2) &quot;hello&quot;
3) &quot;field2&quot;
4) &quot;world&quot;</code></pre>
<h4 id="7-1-5-ğŸ‰Sorted-Set"><a href="#7-1-5-ğŸ‰Sorted-Set" class="headerlink" title="7.1.5 ğŸ‰Sorted Set"></a>7.1.5 ğŸ‰Sorted Set</h4><p>æœ‰åºé›†åˆsorted setï¼Œé›†åˆä¸­æ¯ä¸ªå…ƒç´ éƒ½ä¼šå…³è”ä¸€ä¸ªdoubleç±»å‹çš„åˆ†æ•°ã€‚</p>
<ul>
<li><p>redisé€šè¿‡åˆ†æ•°å¯¹é›†åˆä¸­çš„æˆå‘˜è¿›è¡Œæ’åºã€‚</p>
</li>
<li><p>æœ‰åºé›†åˆä¸­æˆå‘˜æ˜¯å”¯ä¸€çš„ï¼Œåˆ†æ•°å¯ä»¥é‡å¤ã€‚</p>
</li>
<li><p>é›†åˆæ˜¯é€šè¿‡å“ˆå¸Œè¡¨å®ç°çš„ï¼Œæ‰€ä»¥å¢åˆ æŸ¥çš„äº‹ä»¶å¤æ‚åº¦éƒ½æ˜¯O(1)ã€‚</p>
</li>
<li><p>é›†åˆä¸­æœ€å¤§çš„æˆå‘˜æ•°é‡ä¸º2^32^-1(4294967295)ï¼Œ æ¯ä¸ªé›†åˆå¯å­˜å‚¨40å¤šäº¿ä¸ªæˆå‘˜ã€‚</p>
</li>
</ul>
<blockquote>
<p>å‘keyçš„æœ‰åºé›†åˆä¸­æ·»åŠ åºå·ä¸ºnumberçš„value</p>
</blockquote>
<pre><code class="she">zadd &lt;key&gt; &lt;number&gt; &lt;value&gt; [number value ...]</code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­çš„æ‰€æœ‰å€¼</p>
</blockquote>
<pre><code class="shell">zrange &lt;key&gt; 0 -1</code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­çš„æˆå‘˜æ•°é‡</p>
</blockquote>
<pre><code class="shell">zcard &lt;key&gt; </code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šä¸‹æ ‡åŒºé—´çš„æˆå‘˜</p>
</blockquote>
<pre><code class="shell">zrange &lt;key&gt; start end</code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜memberçš„ç´¢å¼•</p>
</blockquote>
<pre><code class="shell">zrank &lt;key&gt; member</code></pre>
<blockquote>
<p>å¯¹keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜memberçš„åˆ†æ•°åŠ ä¸Šå¢é‡</p>
</blockquote>
<pre><code class="shell">zincrby &lt;key&gt; &lt;Integer&gt; member</code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜memberçš„åˆ†æ•°å€¼</p>
</blockquote>
<pre><code class="shell">zscore &lt;key&gt; member</code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜memberçš„æ’å(ä»å°åˆ°å¤§)</p>
</blockquote>
<pre><code class="shell">zrank &lt;key&gt; member</code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­æŒ‡å®šæˆå‘˜memberçš„æ’å(ä»å¤§åˆ°å°)</p>
</blockquote>
<pre><code class="shell">zrevrank &lt;key&gt; member</code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­åˆ†æ•°åœ¨æŒ‡å®šåŒºé—´[min,max]çš„æˆå‘˜æ•°é‡</p>
</blockquote>
<pre><code class="shell">zcount &lt;key&gt; min max</code></pre>
<blockquote>
<p>é€šè¿‡å­—å…¸åŒºé—´è·å–keyçš„æœ‰åºé›†åˆä¸­çš„æˆå‘˜æ•°é‡</p>
</blockquote>
<pre><code class="shell">zlexcount &lt;key&gt; min max</code></pre>
<blockquote>
<p>é€šè¿‡å­—å…¸åŒºé—´è·å–keyçš„æœ‰åºé›†åˆä¸­çš„æˆå‘˜</p>
</blockquote>
<pre><code class="shell">zrangebylex &lt;key&gt; min max [limit offset count]</code></pre>
<blockquote>
<p>è·å–keyçš„æœ‰åºé›†åˆä¸­åˆ†æ•°åœ¨æŒ‡å®šåŒºé—´[min,max]çš„æˆå‘˜</p>
<blockquote>
<p>å‚æ•°è¯´æ˜</p>
<ul>
<li>min max<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ä¸ºé—­åŒºé—´ï¼Œå³[min ,max]</li>
<li>ä¹Ÿå¯ä»¥æ˜¯ä½¿ç”¨å¼€åŒºé—´ï¼Œå³(min, max)ï¼Œå†™æ³•ä¸º<code> (min  (max</code></li>
</ul>
</li>
<li>withscores<ul>
<li>è¿”å›æˆå‘˜çš„åŒæ—¶ä¼šè¿”å›åˆ†æ•°</li>
</ul>
</li>
<li>limit offset count<ul>
<li>offsetï¼šèµ·å§‹ä½ç½®ï¼Œcountï¼šä»èµ·å§‹ä½ç½®å¼€å§‹çš„è®°å½•æ•°é‡</li>
<li>å®ç°åˆ†é¡µæŸ¥è¯¢</li>
<li>å‚æ•°: é¡µæ•°pagenumï¼Œé¡µé¢å¤§å°pagesize</li>
<li>é‚£ä¹ˆå®é™…çš„offset = (pagenum - 1) * pagesizeï¼Œcount = pagesize</li>
<li>å³æŸ¥è¯¢è¯­å¥ä¸º<code>zrangebyscore salary min max withscores limit (pagenum - 1) * pagesize pagesize  </code></li>
</ul>
</li>
</ul>
</blockquote>
</blockquote>
<pre><code class="shell">zrangebyscore &lt;key&gt; min max [withscores] [limit offset count]</code></pre>
<blockquote>
<p>ä¾‹å¦‚</p>
</blockquote>
<pre><code class="shell">127.0.0.1:6379&gt; zadd salary -10000 W -20000 F -30000 S
(integer) 3
127.0.0.1:6379&gt; zadd salary 10000 K 20000 A 30000 G
(integer) 3
127.0.0.1:6379&gt; zrangebyscore salary -20000 20000
1) &quot;F&quot;
2) &quot;W&quot;
3) &quot;K&quot;
4) &quot;A&quot;
127.0.0.1:6379&gt; zrangebyscore salary -inf inf 
1) &quot;S&quot;
2) &quot;F&quot;
3) &quot;W&quot;
4) &quot;K&quot;
5) &quot;A&quot;
6) &quot;G&quot;
127.0.0.1:6379&gt; zrangebyscore salary -inf inf withscores
 1) &quot;S&quot;
 2) &quot;-30000&quot;
 3) &quot;F&quot;
 4) &quot;-20000&quot;
 5) &quot;W&quot;
 6) &quot;-10000&quot;
 7) &quot;K&quot;
 8) &quot;10000&quot;
 9) &quot;A&quot;
10) &quot;20000&quot;
11) &quot;G&quot;
12) &quot;30000&quot;
127.0.0.1:6379&gt; zrangebyscore salary -inf inf withscores limit 4 2
1) &quot;G&quot;
2) &quot;30000&quot;
3) &quot;K&quot;
4) &quot;60000&quot;</code></pre>
<blockquote>
<p>åˆ é™¤keyçš„æœ‰åºé›†åˆä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜</p>
</blockquote>
<pre><code class="shell">zrem &lt;key&gt; member [member ...]</code></pre>
<h3 id="7-2-ğŸŒŒä¸‰ç§ç‰¹æ®Šç±»å‹"><a href="#7-2-ğŸŒŒä¸‰ç§ç‰¹æ®Šç±»å‹" class="headerlink" title="7.2 ğŸŒŒä¸‰ç§ç‰¹æ®Šç±»å‹"></a>7.2 ğŸŒŒä¸‰ç§ç‰¹æ®Šç±»å‹</h3><h4 id="7-2-1-ğŸ”®Geospatial"><a href="#7-2-1-ğŸ”®Geospatial" class="headerlink" title="7.2.1 ğŸ”®Geospatial"></a>7.2.1 ğŸ”®Geospatial</h4><p>Geospatialï¼Œåœ°ç†ç©ºé—´ï¼Œç®€ç§°GEOï¼Œä¸»è¦ç”¨äºå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œå¹¶å¯¹å­˜å‚¨çš„ä¿¡æ¯è¿›è¡Œæ“ä½œã€‚</p>
<blockquote>
<p>æ“ä½œæ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">geoadd</td>
<td align="center">æ·»åŠ åœ°ç†ä½ç½®çš„åæ ‡</td>
</tr>
<tr>
<td align="center">geopos</td>
<td align="center">è·å–åœ°ç†ä½ç½®çš„åæ ‡</td>
</tr>
<tr>
<td align="center">geodist</td>
<td align="center">è®¡ç®—ä¸¤ä¸ªä½ç½®ä¹‹é—´çš„è·ç¦»</td>
</tr>
<tr>
<td align="center">georadius</td>
<td align="center">æ ¹æ®ç”¨æˆ·ç»™å®šçš„ç»çº¬åº¦åæ ‡æ¥è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆ</td>
</tr>
<tr>
<td align="center">georadiusbymember</td>
<td align="center">æ ¹æ®å‚¨å­˜åœ¨ä½ç½®é›†åˆé‡Œé¢çš„æŸä¸ªåœ°ç‚¹è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆ</td>
</tr>
<tr>
<td align="center">geohash</td>
<td align="center">è¿”å›ä¸€ä¸ªæˆ–è€…å¤šä¸ªä½ç½®å¯¹è±¡çš„geohashå€¼</td>
</tr>
</tbody></table>
<p>æŸ¥è¯¢åœ°ç†æ•°æ®ï¼š<a href="http://www.jsons.cn/lngcode/">åŸå¸‚ç»çº¬åº¦æŸ¥è¯¢</a></p>
<blockquote>
<p>æµ‹è¯•æ•°æ®</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">åœ°æ–¹</th>
<th align="center">ç»åº¦</th>
<th align="center">çº¬åº¦</th>
</tr>
</thead>
<tbody><tr>
<td align="center">é»„å†ˆå¸‚é»„æ¢…å¿</td>
<td align="center">115.94427</td>
<td align="center">30.07033</td>
</tr>
<tr>
<td align="center">æ­¦æ±‰å¸‚æ­¦æ˜ŒåŒº</td>
<td align="center">114.31589</td>
<td align="center">30.55389</td>
</tr>
<tr>
<td align="center">åŒ—äº¬å¸‚ä¸°å°åŒº</td>
<td align="center">116.28625</td>
<td align="center">39.8585</td>
</tr>
<tr>
<td align="center">ä¸Šæµ·å¸‚é»„æµ¦åŒº</td>
<td align="center">121.49295</td>
<td align="center">31.22337</td>
</tr>
<tr>
<td align="center">åˆè‚¥å¸‚èœ€å±±åŒº</td>
<td align="center">117.26104</td>
<td align="center">31.85117</td>
</tr>
<tr>
<td align="center">æ·±åœ³å¸‚å—å±±åŒº</td>
<td align="center">113.93029</td>
<td align="center">22.53291</td>
</tr>
<tr>
<td align="center">å¤§è¿å¸‚ä¸­å±±åŒº</td>
<td align="center">121.64465</td>
<td align="center">38.91859</td>
</tr>
<tr>
<td align="center">å¹¿å·å¸‚å¤©æ²³åŒº</td>
<td align="center">113.36112</td>
<td align="center">23.12467</td>
</tr>
</tbody></table>
<p>1ï¸âƒ£<strong>geoadd</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>geoaddç”¨äºå­˜å‚¨æŒ‡å®šçš„åœ°ç†ä½ç½®ç©ºé—´ï¼Œå¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ªç»åº¦(longitude)ã€çº¬åº¦(latitude)ã€ä½ç½®åç§°(member)æ·»åŠ åˆ°æŒ‡å®šçš„keyä¸­ã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<pre><code class="shell">geoadd &lt;key&gt; longitude latitude member [longtitude latitude member ...]</code></pre>
<blockquote>
<p>è§„åˆ™</p>
</blockquote>
<ul>
<li>ä¸¤çº§æ— æ³•ç›´æ¥æ·»åŠ </li>
<li>æœ‰æ•ˆç»åº¦ï¼š-180 - 180</li>
<li>æœ‰æ•ˆçº¬åº¦ï¼š-85.05112878 - 85.05112878</li>
</ul>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<pre><code class="shell">127.0.0.1:6379&gt; geoadd china:city 115.94427 30.07033 huanggang
(integer) 1
127.0.0.1:6379&gt; geoadd china:city 114.31589 30.55389 wuhan
(integer) 1
127.0.0.1:6379&gt; geoadd china:city 116.28625 39.8585 beijing
(integer) 1
127.0.0.1:6379&gt; geoadd china:city 121.49295 31.22337 shanghai
(integer) 1
127.0.0.1:6379&gt; geoadd china:city 117.26104 31.85117 hefei
(integer) 1
127.0.0.1:6379&gt; geoadd china:city 113.93029 22.53291 shenzhen
(integer) 1
127.0.0.1:6379&gt; geoadd china:city 121.64465 38.91859 dalian
(integer) 1
127.0.0.1:6379&gt; geoadd china:city 113.36112 23.12467 guangzhou
(integer) 1</code></pre>
<p>å®é™…åº”ç”¨ä¸­ï¼Œä¸€èˆ¬ä¼šæŠŠåŸå¸‚åœ°ç†æ•°æ®å†™åœ¨æ–‡ä»¶ä¸­ï¼Œç›´æ¥é€šè¿‡javaç¨‹åºä¸€æ¬¡æ€§å¯¼å…¥ã€‚</p>
<p>2ï¸âƒ£<strong>geopos</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>geoposç”¨äºä»ç»™å®šçš„keyé‡Œè¿”å›æ‰€æœ‰æŒ‡å®šåç§°(member)çš„ä½ç½®(ç»åº¦å’Œçº¬åº¦)ï¼Œä¸å­˜åœ¨çš„è¿”å›nilã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<pre><code class="shell">geopos &lt;key&gt; member [member ...]</code></pre>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<pre><code class="shell">127.0.0.1:6379&gt; geopos china:city huanggang shenzhen shanghai 
1) 1) &quot;115.94427019357681274&quot;
   2) &quot;30.07033115798519418&quot;
2) 1) &quot;113.93029063940048218&quot;
   2) &quot;22.53290942281488896&quot;
3) 1) &quot;121.49295061826705933&quot;
   2) &quot;31.22337074392616074&quot;</code></pre>
<p>3ï¸âƒ£<strong>geodist</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>geodistç”¨äºè®¡ç®—ä¸¤ä¸ªç»™å®šä½ç½®ä¹‹é—´çš„è·ç¦»ã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<pre><code class="shell">geodist &lt;key&gt; member1 member2 [m|km|ft|mi]</code></pre>
<p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li>member1å’Œmember2ä¸ºä¸¤ä¸ªåœ°ç†ä½ç½®</li>
<li>mï¼šç±³ï¼Œé»˜è®¤ä½ç½®</li>
<li>kmï¼šåƒç±³</li>
<li>miï¼šè‹±é‡Œ</li>
<li>ftï¼šè‹±å°º</li>
</ul>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<pre><code class="shell">127.0.0.1:6379&gt; geodist china:city huanggang shenzhen
&quot;862016.4959&quot;
127.0.0.1:6379&gt; geodist china:city huanggang hefei km
&quot;234.5308&quot;
127.0.0.1:6379&gt; geodist china:city shanghai dalian mi
&quot;531.9085&quot;</code></pre>
<p>4ï¸âƒ£<strong>georadius</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>ç»™å®šä¸€ä¸ªä¸­å¿ƒçš„åœ°ç†ä½ç½®(ç»åº¦å’Œçº¬åº¦)ï¼Œç»™å®šä¸€ä¸ªæœ€å¤§è·ç¦»ï¼Œè¿”å›ç»™å®šçš„keyåŒ…å«çš„ä½ç½®å…ƒç´ ä¸­ï¼Œä¸ä¸­å¿ƒçš„è·ç¦»ä¸è¶…è¿‡æœ€å¤§è·ç¦»çš„æ‰€æœ‰ä½ç½®å…ƒç´ ã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<pre><code class="shell">georadius &lt;key&gt; longitude latitude radius m|km|ft|mi [withcoord] [withdist] [withhash] [count] [asc|desc] [store key] [storedist key]</code></pre>
<p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li><p>longitudeï¼šç»™å®šä¸­å¿ƒçš„ç»åº¦</p>
</li>
<li><p>latitudeï¼šç»™å®šä¸­å¿ƒçš„çº¬åº¦</p>
</li>
<li><p>radiusï¼šç»™å®šçš„æœ€å¤§è·ç¦»</p>
</li>
<li><p>withcoordï¼šè¿”å›+(ä½ç½®å…ƒç´ çš„ç»åº¦å’Œçº¬åº¦)</p>
</li>
<li><p>withdistï¼šè¿”å›+(ä½ç½®å…ƒç´ ä¸ä¸­å¿ƒä¹‹é—´çš„è·ç¦»)</p>
</li>
<li><p>withhashï¼šä»¥ 52 ä½æœ‰ç¬¦å·æ•´æ•°çš„å½¢å¼ï¼Œ è¿”å›ä½ç½®å…ƒç´ ç»è¿‡åŸå§‹ geohash ç¼–ç çš„æœ‰åºé›†åˆåˆ†å€¼ã€‚ è¿™ä¸ªé€‰é¡¹ä¸»è¦ç”¨äºåº•å±‚åº”ç”¨æˆ–è€…è°ƒè¯•ï¼Œ å®é™…ä¸­çš„ä½œç”¨å¹¶ä¸å¤§ã€‚</p>
</li>
<li><p>countï¼šé™å®šè¿”å›çš„è®°å½•æ•°é‡</p>
</li>
<li><p>ascï¼šæŸ¥æ‰¾ç»“æœæ ¹æ®è·ç¦»ä»å°åˆ°å¤§æ’åº</p>
</li>
<li><p>descï¼šæŸ¥æ‰¾ç»“æœæ ¹æ®è·ç¦»ä»å¤§åˆ°å°æ’åº</p>
</li>
</ul>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<pre><code class="shell"># æŸ¥çœ‹è·ç¦»å¹¿å·ä¸å¤§äº1000kmçš„åŸå¸‚
127.0.0.1:6379&gt; georadius china:city 113.36112 23.12467 1000 km asc
1) &quot;guangzhou&quot;
2) &quot;shenzhen&quot;
3) &quot;huanggang&quot;
4) &quot;wuhan&quot;
# æŸ¥çœ‹è·ç¦»æ­¦æ±‰ä¸å¤§äº1000kmçš„åŸå¸‚ï¼Œä»å¤§åˆ°å°ï¼Œé™åˆ¶5ä¸ªï¼Œå¹¶ä¸”æ˜¾ç¤ºè·ç¦»å’ŒåŸå¸‚ç»çº¬åº¦
127.0.0.1:6379&gt; georadius china:city 114.31589 30.55389 1000 km withcoord withdist count 5 desc 
1) 1) &quot;shenzhen&quot;
   2) &quot;892.9663&quot;
   3) 1) &quot;113.93029063940048218&quot;
      2) &quot;22.53290942281488896&quot;
2) 1) &quot;guangzhou&quot;
   2) &quot;831.7263&quot;
   3) 1) &quot;113.36112052202224731&quot;
      2) &quot;23.12467049411647935&quot;
3) 1) &quot;shanghai&quot;
   2) &quot;688.9652&quot;
   3) 1) &quot;121.49295061826705933&quot;
      2) &quot;31.22337074392616074&quot;
4) 1) &quot;hefei&quot;
   2) &quot;315.1437&quot;
   3) 1) &quot;117.26104170083999634&quot;
      2) &quot;31.85117048067123591&quot;
5) 1) &quot;huanggang&quot;
   2) &quot;165.3475&quot;
   3) 1) &quot;115.94427019357681274&quot;
      2) &quot;30.07033115798519418&quot;
# æŸ¥çœ‹è·ç¦»åŒ—äº¬ä¸å¤§äº1500kmçš„åŸå¸‚
127.0.0.1:6379&gt; georadius china:city 116.28625 39.8585 1500 km withdist asc
1) 1) &quot;beijing&quot;
   2) &quot;0.0002&quot;
2) 1) &quot;dalian&quot;
   2) &quot;472.2545&quot;
3) 1) &quot;hefei&quot;
   2) &quot;894.9324&quot;
4) 1) &quot;wuhan&quot;
   2) &quot;1050.2106&quot;
5) 1) &quot;shanghai&quot;
   2) &quot;1069.3051&quot;
6) 1) &quot;huanggang&quot;
   2) &quot;1089.1453&quot;</code></pre>
<p>5ï¸âƒ£<strong>georadiusbymember</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>georadiusbymember å’Œ georadiuså‘½ä»¤ä¸€æ ·ï¼Œ éƒ½å¯ä»¥æ‰¾å‡ºä½äºæŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ ï¼Œ ä½†æ˜¯ georadiusbymember çš„ä¸­å¿ƒç‚¹æ˜¯åªèƒ½ä»keyä¸­çš„ä½ç½®å…ƒç´ é€‰ã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<pre><code class="shell">georadiusbymember &lt;key&gt; member radius m|km|ft|mi [withcoord] [withdist] [withhash] [count] [asc|desc] [store key] [storedist key]</code></pre>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<pre><code class="shell"># æŸ¥çœ‹è·ç¦»é»„å†ˆä¸å¤§äº900kmçš„åŸå¸‚
127.0.0.1:6379&gt; georadiusbymember china:city huanggang 900 km withdist asc
1) 1) &quot;huanggang&quot;
   2) &quot;0.0000&quot;
2) 1) &quot;wuhan&quot;
   2) &quot;165.3475&quot;
3) 1) &quot;hefei&quot;
   2) &quot;234.5308&quot;
4) 1) &quot;shanghai&quot;
   2) &quot;546.1566&quot;
5) 1) &quot;guangzhou&quot;
   2) &quot;814.0494&quot;
6) 1) &quot;shenzhen&quot;
   2) &quot;862.0165&quot;
# æŸ¥çœ‹è·ç¦»æ·±åœ³ä¸å¤§äº2000kmçš„åŸå¸‚
127.0.0.1:6379&gt; georadiusbymember china:city shenzhen 2000 km withdist desc
1) 1) &quot;dalian&quot;
   2) &quot;1964.1097&quot;
2) 1) &quot;beijing&quot;
   2) &quot;1939.8454&quot;
3) 1) &quot;shanghai&quot;
   2) &quot;1222.7809&quot;
4) 1) &quot;hefei&quot;
   2) &quot;1087.3585&quot;
5) 1) &quot;wuhan&quot;
   2) &quot;892.9663&quot;
6) 1) &quot;huanggang&quot;
   2) &quot;862.0165&quot;
7) 1) &quot;guangzhou&quot;
   2) &quot;87.9580&quot;
8) 1) &quot;shenzhen&quot;
   2) &quot;0.0000&quot;</code></pre>
<p>6ï¸âƒ£<strong>geohash</strong></p>
<blockquote>
<p>æè¿°</p>
</blockquote>
<p>geohashç”¨äºè·å–ä¸€ä¸ªæˆ–å¤šä¸ªä½ç½®å…ƒç´ çš„geohashå€¼ã€‚</p>
<blockquote>
<p>å®è´¨</p>
</blockquote>
<p><strong>é™ç»´æ‰“å‡»</strong>ï¼šå°†äºŒç»´çš„ç»çº¬åº¦è½¬æ¢ä¸ºä¸€ç»´çš„å­—ç¬¦ä¸²</p>
<p>å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²è¶Šæ¥è¿‘ï¼Œé‚£ä¹ˆè·ç¦»è¶Šè¿‘ã€‚</p>
<blockquote>
<p>è¯­æ³•</p>
</blockquote>
<pre><code class="shell">geohash &lt;key&gt; member [member ...]</code></pre>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<pre><code class="shell">127.0.0.1:6379&gt; geohash china:city huanggang beijing hefei
1) &quot;wt67n6hh3k0&quot;
2) &quot;wx4dy0j0d40&quot;
3) &quot;wtemhq6fs20&quot;</code></pre>
<p>7ï¸âƒ£<strong>Other</strong></p>
<blockquote>
<p>GEO</p>
</blockquote>
<p>GEOçš„åº•å±‚åŸç†å°±æ˜¯Sorted Setï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Sorted Setå‘½ä»¤æ¥æ“ä½œGEOã€‚</p>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<pre><code class="shell"># æŸ¥çœ‹åœ°å›¾ä¸­å…¨éƒ¨å…ƒç´ 
127.0.0.1:6379&gt; zrange china:city 0 -1
1) &quot;shenzhen&quot;
2) &quot;guangzhou&quot;
3) &quot;wuhan&quot;
4) &quot;huanggang&quot;
5) &quot;hefei&quot;
6) &quot;shanghai&quot;
7) &quot;beijing&quot;
8) &quot;dalian&quot;
# ç§»é™¤å¤§è¿è¿™ä¸ªåŸå¸‚
127.0.0.1:6379&gt; zrem china:city dalian
(integer) 1
# æŒ‰ç…§åˆ†æ•°ç»™åŸå¸‚æ’å
127.0.0.1:6379&gt; zrangebyscore china:city -inf inf withscores
 1) &quot;shenzhen&quot;
 2) &quot;4046431599170567&quot;
 3) &quot;guangzhou&quot;
 4) &quot;4046534293000673&quot;
 5) &quot;wuhan&quot;
 6) &quot;4051938129491420&quot;
 7) &quot;huanggang&quot;
 8) &quot;4052334404505800&quot;
 9) &quot;hefei&quot;
10) &quot;4052764524670284&quot;
11) &quot;shanghai&quot;
12) &quot;4054757680623470&quot;
13) &quot;beijing&quot;
14) &quot;4069146323276357&quot;</code></pre>
<h4 id="7-2-2-ğŸ“„HyperLogLog"><a href="#7-2-2-ğŸ“„HyperLogLog" class="headerlink" title="7.2.2 ğŸ“„HyperLogLog"></a>7.2.2 ğŸ“„HyperLogLog</h4><p>HyperLogLogï¼ŒRedisä¸­åŸºæ•°ç»Ÿè®¡çš„ç®—æ³•ã€‚</p>
<blockquote>
<p>ä¼˜ç‚¹</p>
</blockquote>
<p>å ç”¨å†…å­˜å›ºå®šä¸”è¾ƒå°ã€‚æ¯ä¸ªHyperLogLogé”®å ç”¨12KBå†…å­˜ï¼Œå¯ä»¥è®¡ç®—2^64^ä¸ªä¸åŒå…ƒç´ çš„åŸºæ•°ã€‚</p>
<blockquote>
<p>åŸºæ•°</p>
</blockquote>
<p>ä¸€ä¸ªæ•°æ®é›†ä¸­ä¸é‡å¤å…ƒç´ çš„æ•°é‡</p>
<blockquote>
<p>åº”ç”¨åœºæ™¯</p>
</blockquote>
<p>ç»Ÿè®¡ç½‘ç«™UV</p>
<p>ä¼ ç»Ÿæ–¹å¼ï¼šä½¿ç”¨setä¿å­˜ç”¨æˆ·idï¼Œsetçš„å…ƒç´ æ•°é‡å¯ä½œä¸ºæ ‡å‡†åˆ¤æ–­ã€‚</p>
<p>è¿™ä¸ªæ–¹å¼å¦‚æœä¿å­˜å¤§é‡çš„ç”¨æˆ·idï¼Œå°±ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œç›®çš„æ˜¯è®¡æ•°ï¼Œè€Œéä¿å­˜ç”¨æˆ·idã€‚</p>
<p>ä½¿ç”¨HyperLogLogä¼šæœ‰**0.81%**çš„é”™è¯¯ç‡ï¼Œè¿™ä¸ªåœ¨ç»Ÿè®¡UVä»»åŠ¡ä¸­æ˜¯å¯ä»¥æ¥å—çš„ã€‚</p>
<blockquote>
<p>æ“ä½œæ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">pfadd &lt;key&gt; element [element â€¦]</td>
<td align="center">æ·»åŠ æŒ‡å®šå…ƒç´ åˆ°HyperLogLogä¸­</td>
</tr>
<tr>
<td align="center">pfcount &lt;key&gt;</td>
<td align="center">è¿”å›ç»™å®šHyperLogLogçš„åŸºæ•°ä¼°ç®—å€¼</td>
</tr>
<tr>
<td align="center">pfmerge &lt;destkey&gt; &lt;key&gt; [keyâ€¦]</td>
<td align="center">å°†å¤šä¸ªHyperLogLogåˆå¹¶ä¸ºä¸€ä¸ªHyperLogLog</td>
</tr>
</tbody></table>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<pre><code class="shell"># åˆ›å»ºç¬¬ä¸€ç»„å…ƒç´ 
127.0.0.1:6379&gt; pfadd hyper K H I G H N E S S 
(integer) 1
# ç»Ÿè®¡ç¬¬ä¸€ç»„å…ƒç´ åŸºæ•°
127.0.0.1:6379&gt; pfcount hyper
(integer) 7
# åˆ›å»ºç¬¬äºŒç»„å…ƒç´ 
127.0.0.1:6379&gt; pfadd hyper2 P A R A K
(integer) 1
# ç»Ÿè®¡ç¬¬äºŒç»„å…ƒç´ åŸºæ•°
127.0.0.1:6379&gt; pfcount hyper2
(integer) 4
# åˆå¹¶ä¸¤ç»„å…ƒç´ 
127.0.0.1:6379&gt; pfmerge hyper hyper hyper2
OK
# ç»Ÿè®¡æ‰€æœ‰å…ƒç´ åŸºæ•°
127.0.0.1:6379&gt; pfcount hyper
(integer) 10</code></pre>
<h4 id="7-1-3-ğŸ”³Bitmaps"><a href="#7-1-3-ğŸ”³Bitmaps" class="headerlink" title="7.1.3 ğŸ”³Bitmaps"></a>7.1.3 ğŸ”³Bitmaps</h4><p>Bitmapsï¼Œä½å›¾ï¼Œæ“ä½œäºŒè¿›åˆ¶ä½æ¥è¿›è¡Œè®°å½•ï¼Œåªæœ‰0å’Œ1ä¸¤ä¸ªçŠ¶æ€ã€‚</p>
<blockquote>
<p>åº”ç”¨åœºæ™¯</p>
</blockquote>
<p>ç»Ÿè®¡ç”¨æˆ·æ´»è·ƒåº¦ï¼Œæ‰“å¡ï¼Œä¸¤ä¸ªçŠ¶æ€çš„éƒ½å¯ä»¥ä½¿ç”¨Bitmapsã€‚</p>
<blockquote>
<p>æ“ä½œæ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">setbit &lt;key&gt; offset value</td>
<td align="center">è®¾ç½®å€¼</td>
</tr>
<tr>
<td align="center">getbit &lt;key&gt;  offset</td>
<td align="center">è·å–å€¼</td>
</tr>
<tr>
<td align="center">bitcount &lt;key&gt; start end</td>
<td align="center">è·å–BitmapsæŒ‡å®šèŒƒå›´å€¼ä¸º1çš„ä¸ªæ•°</td>
</tr>
<tr>
<td align="center">bitop and|or|not|xor &lt;destkey&gt; key [key â€¦]</td>
<td align="center">Bitmapsçš„é›†åˆè¿ç®—</td>
</tr>
</tbody></table>
<blockquote>
<p>å®ä¾‹</p>
</blockquote>
<pre><code class="shell"># æ‰“å¡ 0-6:å‘¨ä¸€-å‘¨æ—¥
# 2020å¹´ç¬¬ä¸€å‘¨æ‰“å¡
127.0.0.1:6379&gt; setbit 2020:week:1 0 1
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:1 1 1
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:1 2 1
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:1 3 1
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:1 4 1
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:1 5 0
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:1 6 0
(integer) 0
# 2020å¹´ç¬¬äºŒå‘¨æ‰“å¡
127.0.0.1:6379&gt; setbit 2020:week:2 0 0
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:2 1 0
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:2 2 0
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:2 3 1
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:2 4 0
(integer) 1
127.0.0.1:6379&gt; setbit 2020:week:2 5 1
(integer) 0
127.0.0.1:6379&gt; setbit 2020:week:2 6 1
(integer) 0
# æ£€æŸ¥æ‰“å¡
127.0.0.1:6379&gt; getbit 2020:week:1 3
(integer) 1
127.0.0.1:6379&gt; getbit 2020:week:2 1
(integer) 0
# ç»Ÿè®¡æ‰“å¡
127.0.0.1:6379&gt; bitcount 2020:week:1
(integer) 5
127.0.0.1:6379&gt; bitcount 2020:week:2
(integer) 3
# å¯¹ä¸¤å‘¨æ‰“å¡ç»“æœå–å¹¶é›†
127.0.0.1:6379&gt; bitop and andres 2020:week:1 2020:week:2
(integer) 1
127.0.0.1:6379&gt; bitcount andres
(integer) 1
# å¯¹ä¸¤å‘¨æ‰“å¡ç»“æœå–äº¤é›†
127.0.0.1:6379&gt; bitop or orres 2020:week:1 2020:week:2
(integer) 1
127.0.0.1:6379&gt; bitcount orres
(integer) 7</code></pre>
<h2 id="8-ğŸ“©Redisäº‹åŠ¡"><a href="#8-ğŸ“©Redisäº‹åŠ¡" class="headerlink" title="8. ğŸ“©Redisäº‹åŠ¡"></a>8. ğŸ“©Redisäº‹åŠ¡</h2><blockquote>
<p> ğŸ’¡ è¯´æ˜</p>
</blockquote>
<p>Rediså•æ¡å‘½ä»¤æ‰§è¡Œå…·æœ‰åŸå­æ€§ï¼Œä½†æ˜¯äº‹åŠ¡ä¸ä¿è¯åŸå­æ€§ã€‚</p>
<h3 id="8-1ğŸ“–å®šä¹‰"><a href="#8-1ğŸ“–å®šä¹‰" class="headerlink" title="8. 1ğŸ“–å®šä¹‰"></a>8. 1ğŸ“–å®šä¹‰</h3><p>ä¸€ç»„å‘½ä»¤çš„é˜Ÿåˆ—</p>
<h3 id="8-2-ğŸŒ ç‰¹å¾"><a href="#8-2-ğŸŒ ç‰¹å¾" class="headerlink" title="8.2 ğŸŒ ç‰¹å¾"></a>8.2 ğŸŒ ç‰¹å¾</h3><ul>
<li>ä¸€æ¬¡æ€§</li>
<li>é¡ºåºæ€§</li>
<li>æ’ä»–æ€§</li>
</ul>
<h3 id="8-3-â³ä¸‰ä¸ªé˜¶æ®µ"><a href="#8-3-â³ä¸‰ä¸ªé˜¶æ®µ" class="headerlink" title="8.3 â³ä¸‰ä¸ªé˜¶æ®µ"></a>8.3 â³ä¸‰ä¸ªé˜¶æ®µ</h3><ul>
<li>å¼€å§‹äº‹åŠ¡ (multi)</li>
<li>å‘½ä»¤å…¥é˜Ÿ (â€¦)</li>
<li>æ‰§è¡Œäº‹åŠ¡ (exec)</li>
</ul>
<h3 id="8-4-ğŸ“æ“ä½œæ–¹æ³•"><a href="#8-4-ğŸ“æ“ä½œæ–¹æ³•" class="headerlink" title="8.4 ğŸ“æ“ä½œæ–¹æ³•"></a>8.4 ğŸ“æ“ä½œæ–¹æ³•</h3><table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">discard</td>
<td align="center">å–æ¶ˆäº‹åŠ¡ï¼Œæ”¾å¼ƒæ‰§è¡Œäº‹åŠ¡å—å†…çš„æ‰€æœ‰å‘½ä»¤</td>
</tr>
<tr>
<td align="center">exec</td>
<td align="center">æ‰§è¡Œäº‹åŠ¡å—å†…çš„æ‰€æœ‰å‘½ä»¤</td>
</tr>
<tr>
<td align="center">multi</td>
<td align="center">æ ‡è®°ä¸€ä¸ªäº‹åŠ¡çš„å¼€å§‹</td>
</tr>
<tr>
<td align="center">unwatch</td>
<td align="center">å–æ¶ˆwatchå‘½ä»¤å¯¹æ‰€æœ‰keyçš„ç›‘è§†</td>
</tr>
<tr>
<td align="center">watch</td>
<td align="center">ç›‘è§†ä¸€ä¸ªæˆ–å¤šä¸ªkeyï¼Œå¦‚æœåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰è¿™ä¸ªæˆ–è¿™äº›keyè¢«å…¶ä»–å‘½ä»¤é”æ”¹åŠ¨ï¼Œé‚£ä¹ˆäº‹åŠ¡å°†è¢«æ‰“æ–­</td>
</tr>
</tbody></table>
<h3 id="8-5-ğŸ•µï¸å®ä¾‹"><a href="#8-5-ğŸ•µï¸å®ä¾‹" class="headerlink" title="8.5 ğŸ•µï¸å®ä¾‹"></a>8.5 ğŸ•µï¸å®ä¾‹</h3><pre><code class="shell"># å¼€å¯äº‹åŠ¡
127.0.0.1:6379&gt; multi
OK
# å‘½ä»¤å…¥é˜Ÿ
127.0.0.1:6379&gt; set k1 v1
QUEUED
127.0.0.1:6379&gt; set k2 v2 
QUEUED
127.0.0.1:6379&gt; mget k1 k2
QUEUED
127.0.0.1:6379&gt; getset k3 v3
QUEUED
127.0.0.1:6379&gt; get k3
QUEUED
# æ‰§è¡Œäº‹åŠ¡
127.0.0.1:6379&gt; exec
1) OK
2) OK
3) 1) &quot;v1&quot;
   2) &quot;v2&quot;
4) &quot;v3&quot;
5) &quot;v3&quot;</code></pre>
<h3 id="8-6-â­•å¼‚å¸¸"><a href="#8-6-â­•å¼‚å¸¸" class="headerlink" title="8.6 â­•å¼‚å¸¸"></a>8.6 â­•å¼‚å¸¸</h3><ul>
<li>å‘½ä»¤å¼‚å¸¸ï¼šå‘½ä»¤å­˜åœ¨é”™è¯¯ï¼Œæ‰€æœ‰å‘½ä»¤éƒ½ä¸ä¼šè¢«æ‰§è¡Œ</li>
</ul>
<pre><code class="shell">127.0.0.1:6379&gt; multi
OK
127.0.0.1:6379&gt; set k1 v1
QUEUED
127.0.0.1:6379&gt; set k2 v2
QUEUED
127.0.0.1:6379&gt; getset k3 # é”™è¯¯å‘½ä»¤
(error) ERR wrong number of arguments for &#39;getset&#39; command
127.0.0.1:6379&gt; set k4 v4
QUEUED
127.0.0.1:6379&gt; exec # æ‰§è¡Œäº‹åŠ¡æŠ¥é”™
(error) EXECABORT Transaction discarded because of previous errors.
127.0.0.1:6379&gt; get k1 # æ‰€æœ‰å‘½ä»¤éƒ½æœªè¢«æ‰§è¡Œ
(nil)</code></pre>
<ul>
<li>è¿è¡Œå¼‚å¸¸ï¼šé”™è¯¯æ“ä½œçš„å‘½ä»¤æŠ›å‡ºå¼‚å¸¸ï¼Œå…¶ä»–å‘½ä»¤æ­£å¸¸æ‰§è¡Œ</li>
</ul>
<pre><code class="shell">127.0.0.1:6379&gt; multi 
OK
127.0.0.1:6379&gt; set k1 v1
QUEUED
127.0.0.1:6379&gt; incr k1 # é”™è¯¯æ“ä½œ
QUEUED
127.0.0.1:6379&gt; set k2 v2
QUEUED
127.0.0.1:6379&gt; exec # æ‰§è¡Œäº‹åŠ¡ä»…é”™è¯¯æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œå…¶ä»–å‘½ä»¤æ‰§è¡ŒæˆåŠŸ
1) OK
2) (error) ERR value is not an integer or out of range
3) OK
127.0.0.1:6379&gt; mget k1 k2
1) &quot;v1&quot;
2) &quot;v2&quot;</code></pre>
<h3 id="9-7-ğŸ”­ç›‘æ§"><a href="#9-7-ğŸ”­ç›‘æ§" class="headerlink" title="9.7 ğŸ”­ç›‘æ§"></a>9.7 ğŸ”­ç›‘æ§</h3><ul>
<li>æ‚²è§‚é”ï¼šå¾ˆæ‚²è§‚ï¼Œè®¤ä¸ºä»€ä¹ˆæ—¶å€™éƒ½ä¼šå‡ºé—®é¢˜ï¼Œæ— è®ºåšä»€ä¹ˆéƒ½ä¼šåŠ é”ã€‚</li>
<li>ä¹è§‚é”ï¼šå¾ˆä¹è§‚ï¼Œè®¤ä¸ºä»€ä¹ˆæ—¶å€™éƒ½ä¸ä¼šå‡ºé—®é¢˜ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ã€‚æ›´æ–°æ•°æ®çš„æ—¶å€™ä¼šæ¯”è¾ƒversionï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦æ›´æ–°è¿‡ã€‚</li>
<li>watchçš„æœ¬è´¨ï¼šselect versionï¼Œä¸€æ—¦å‘ç°ç›‘è§†çš„æ•°æ®versionæ”¹å˜ï¼Œäº‹åŠ¡å°†è¢«æ‰“æ–­ã€‚</li>
</ul>
<blockquote>
<p>å®ä¾‹1-watchçš„ç›‘æ§æµ‹è¯•</p>
</blockquote>
<pre><code class="shell"># ä¸ªäººè´¢åŠ¡
127.0.0.1:6379&gt; set money 100
OK
# ä¸ªäººæ”¯å‡º
127.0.0.1:6379&gt; set out 0
OK
# ç›‘æ§è´¢åŠ¡
127.0.0.1:6379&gt; watch money 
OK
# å¼€å¯äº‹åŠ¡
127.0.0.1:6379&gt; multi
OK
# æ¶ˆè´¹10å…ƒ
127.0.0.1:6379&gt; decrby money 30
QUEUED
# æ”¯å‡ºå¢åŠ 
127.0.0.1:6379&gt; incrby out 30
QUEUED
# æ‰§è¡Œäº‹åŠ¡
127.0.0.1:6379&gt; exec
1) (integer) 70
2) (integer) 30</code></pre>
<blockquote>
<p>å®ä¾‹2-watchçš„å¤šçº¿ç¨‹æµ‹è¯•ï¼Œwatchå¯ä»¥å½“åšredisçš„ä¹è§‚é”æ“ä½œ</p>
</blockquote>
<pre><code class="shell"># çº¿ç¨‹1
# ç›‘æ§è´¢åŠ¡
127.0.0.1:6379&gt; watch money
OK
127.0.0.1:6379&gt; multi
OK
# æ¶ˆè´¹10å…ƒ
127.0.0.1:6379&gt; decrby money 10
QUEUED
# æ”¯å‡ºå¢åŠ 
127.0.0.1:6379&gt; incrby out 10
QUEUED
# æ‰§è¡Œä¹‹å‰çº¿ç¨‹2ä¿®æ”¹äº†è´¢åŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå¯¼è‡´äº‹åŠ¡æ‰§è¡Œå¤±è´¥
127.0.0.1:6379&gt; exec
(nil)

# çº¿ç¨‹2 
# æ‰§è¡Œåœ¨çº¿ç¨‹1çš„äº‹åŠ¡execä¹‹å‰
# æŸ¥è¯¢è´¢åŠ¡
127.0.0.1:6379&gt; get money
&quot;70&quot;
# å……å€¼1000
127.0.0.1:6379&gt; incrby money 1000
(integer) 1070

# çº¿ç¨‹1
# æ‰§è¡Œåœ¨çº¿ç¨‹1çš„äº‹åŠ¡execä¹‹å
# 1ã€å¦‚æœå‘ç°äº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œå°±å…ˆè§£é”
127.0.0.1:6379&gt; unwatch 
OK
# 2ã€è·å–æœ€æ–°çš„å€¼ï¼Œå†æ¬¡ç›‘è§†
127.0.0.1:6379&gt; watch money
OK
127.0.0.1:6379&gt; multi
OK
127.0.0.1:6379&gt; decrby money 50
QUEUED
127.0.0.1:6379&gt; incrby out 50
QUEUED
# 3ã€å¯¹æ¯”ç›‘è§†çš„å€¼æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–
# å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆå¯ä»¥æ‰§è¡ŒæˆåŠŸï¼Œå¦åˆ™æ‰§è¡Œå¤±è´¥
127.0.0.1:6379&gt; exec
1) (integer) 1020
2) (integer) 80</code></pre>
<h2 id="9-ğŸ“©Jedis"><a href="#9-ğŸ“©Jedis" class="headerlink" title="9. ğŸ“©Jedis"></a>9. ğŸ“©Jedis</h2><blockquote>
<p>ğŸ“¢ è¯´æ˜</p>
</blockquote>
<p>Jedisæ˜¯Rediså®˜æ–¹æ¨èçš„Javaè¿æ¥å¼€å‘å·¥å…·ã€‚</p>
<p>Jedisä¸­çš„æ‰€æœ‰apiå°±å¯¹åº”Redisä¸­çš„æ‰€æœ‰å‘½ä»¤ã€‚</p>
<h3 id="9-1-â•å¯¼å…¥ä¾èµ–"><a href="#9-1-â•å¯¼å…¥ä¾èµ–" class="headerlink" title="9.1 â•å¯¼å…¥ä¾èµ–"></a>9.1 â•å¯¼å…¥ä¾èµ–</h3><blockquote>
<p>pom.xml</p>
</blockquote>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;top.parak&lt;/groupId&gt;
    &lt;artifactId&gt;springboot-redis&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

    &lt;developers&gt;
        &lt;developer&gt;
            &lt;name&gt;KHighness&lt;/name&gt;
            &lt;email&gt;parakovo@gmail.com&lt;/email&gt;
        &lt;/developer&gt;
    &lt;/developers&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.2.5.RELEASE&lt;/version&gt;
        &lt;relativePath/&gt;
    &lt;/parent&gt;

    &lt;properties&gt;
        &lt;fastjson.version&gt;1.2.68&lt;/fastjson.version&gt;
        &lt;jackson.version&gt;2.11.0&lt;/jackson.version&gt;
        &lt;jedis.version&gt;3.3.0&lt;/jedis.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;

        &lt;!-- Springboot-Web  --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- Spring Test --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;
                    &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;

        &lt;!-- Springboot-Aop  --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- Springboot-Redis  --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- SpringCloud-Context --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-context&lt;/artifactId&gt;
            &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Fastjson --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;
            &lt;version&gt;$&#123;fastjson.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Jackson --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
            &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
            &lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Lombok --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- Jedis --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;redis.clients&lt;/groupId&gt;
            &lt;artifactId&gt;jedis&lt;/artifactId&gt;
            &lt;version&gt;$&#123;jedis.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;</code></pre>
<h3 id="9-2-âŒ¨ï¸ç¼–ç æµ‹è¯•"><a href="#9-2-âŒ¨ï¸ç¼–ç æµ‹è¯•" class="headerlink" title="9.2 âŒ¨ï¸ç¼–ç æµ‹è¯•"></a>9.2 âŒ¨ï¸ç¼–ç æµ‹è¯•</h3><h4 id="9-2-1-ğŸ…¿Pingæµ‹è¯•"><a href="#9-2-1-ğŸ…¿Pingæµ‹è¯•" class="headerlink" title="9.2.1 ğŸ…¿Pingæµ‹è¯•"></a>9.2.1 ğŸ…¿Pingæµ‹è¯•</h4><blockquote>
<p>Ping.java</p>
</blockquote>
<pre><code class="java">package top.parak.jedis;

import lombok.extern.log4j.Log4j2;
import redis.clients.jedis.Jedis;

/**
 * @author: KHighness
 * @date: 2020/10/11 17:47
 * @apiNote: æµ‹è¯•é“¾æ¥
 */

@Log4j2
public class Ping &#123;
    public static void main(String[] args) &#123;
        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);
        log.info(jedis.ping());
        jedis.close();
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<pre><code class="shell">17:52:31.303 [main] INFO top.parak.jedis.Ping - PONG</code></pre>
<h4 id="9-2-1-âšªGEO-apiæµ‹è¯•"><a href="#9-2-1-âšªGEO-apiæµ‹è¯•" class="headerlink" title="9.2.1 âšªGEO-apiæµ‹è¯•"></a>9.2.1 âšªGEO-apiæµ‹è¯•</h4><blockquote>
<p>city.txt</p>
</blockquote>
<pre><code class="txt">huanggang    115.94427    30.07033
wuhan        114.31589    30.55389
beijing      116.28625    39.8585
shanghai     121.49295    31.22337
hefei        117.26104    31.85117
shenzhen     113.93029    22.53291
dalian       121.64465    38.91859
guangzhou    113.36112    23.12467</code></pre>
<blockquote>
<p>Geo.java</p>
</blockquote>
<pre><code class="java">package top.parak.jedis;

import lombok.extern.log4j.Log4j2;
import org.springframework.util.ResourceUtils;
import redis.clients.jedis.GeoCoordinate;
import redis.clients.jedis.GeoUnit;
import redis.clients.jedis.Jedis;
import redis.clients.jedis.params.GeoRadiusParam;

import java.io.FileInputStream;
import java.io.IOException;
import java.nio.ByteBuffer;
import java.nio.channels.FileChannel;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;


/**
 * @author: KHighness
 * @date: 2020/10/11 17:59
 * @apiNote: æµ‹è¯•Geospatial
 */

@Log4j2
public class Geo &#123;

    /**
     * è¯»å–æ–‡ä»¶å°†åœ°ç†æ•°æ®å†™è¿›redis
     * @param path
     * @throws IOException
     */
    public static void readAndWriteIntoRedis(String path, Jedis jedis) throws IOException &#123;
        FileInputStream fileInputStream = new FileInputStream(path);
        FileChannel channel = fileInputStream.getChannel();
        ByteBuffer byteBuffer = ByteBuffer.allocate(512);
        channel.read(byteBuffer);
        String[] res = new String(byteBuffer.array()).split(&quot;\n&quot;);
        Map&lt;String, GeoCoordinate&gt; map = new HashMap&lt;&gt;();
        Arrays.stream(res).forEach(s -&gt; &#123;
            // ä½¿ç”¨æ­£åˆ™\s+åŒ¹é…å¤šä¸ªç©ºæ ¼ï¼Œåˆ†å‰²å­—ç¬¦ä¸²
            String[] ss = s.split(&quot;\\s+&quot;);
            map.put(ss[0], new GeoCoordinate(Double.valueOf(ss[1]), Double.valueOf(ss[2])));
        &#125;);
        jedis.geoadd(&quot;china:city&quot;, map);
    &#125;

    public static void main(String[] args) throws IOException &#123;
        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);
        readAndWriteIntoRedis(ResourceUtils.getFile(&quot;src/main/resources/city.txt&quot;).getAbsolutePath(), jedis);
        log.info(&quot;==========åœ°å›¾ä¸­çš„æ‰€æœ‰åŸå¸‚==========&quot;);
        jedis.zrange(&quot;china:city&quot;, 0, -1).stream().forEach(s -&gt; &#123; log.info(s + &quot; &quot;); &#125;);
        log.info(&quot;==========æŸ¥è¯¢é»„å†ˆçš„ç»çº¬åº¦==========&quot;);
        log.info(jedis.geopos(&quot;china:city&quot;, &quot;huanggang&quot;));
        log.info(&quot;==========æŸ¥è¯¢è·ç¦»æ­å·ä¸è¶…è¿‡1000kmçš„åŸå¸‚==========&quot;);
        GeoRadiusParam geoRadiusParam = new GeoRadiusParam();
        geoRadiusParam.withCoord().withDist().sortAscending();
        jedis.georadius(&quot;china:city&quot;, 120.153576, 30.287459, 1000, GeoUnit.KM, geoRadiusParam).forEach( c -&gt; &#123;
            log.info(&quot;åŸå¸‚åç§°ï¼š&#123;&#125;, ç»çº¬åº¦ï¼š&#123;&#125;ï¼Œè·ç¦»ï¼š&#123;&#125;KM&quot;, c.getMemberByString(), c.getCoordinate(), c.getDistance());
        &#125;);
        log.info(&quot;==========æŸ¥è¯¢è·ç¦»æ­¦æ±‰ä¸è¶…è¿‡1000KMçš„åŸå¸‚==========&quot;);
        jedis.georadiusByMember(&quot;china:city&quot;, &quot;wuhan&quot;, 1000, GeoUnit.KM, geoRadiusParam).forEach( c -&gt; &#123;
            log.info(&quot;åŸå¸‚åç§°ï¼š&#123;&#125;, ç»çº¬åº¦ï¼š&#123;&#125;ï¼Œè·ç¦»ï¼š&#123;&#125;KM&quot;, c.getMemberByString(), c.getCoordinate(), c.getDistance());
        &#125;);
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<pre><code class="shell">20:21:02.671 [main] INFO top.parak.jedis.Geo - ==========åœ°å›¾ä¸­çš„æ‰€æœ‰åŸå¸‚==========
20:21:02.718 [main] INFO top.parak.jedis.Geo - shenzhen 
20:21:02.718 [main] INFO top.parak.jedis.Geo - guangzhou 
20:21:02.718 [main] INFO top.parak.jedis.Geo - wuhan 
20:21:02.718 [main] INFO top.parak.jedis.Geo - huanggang 
20:21:02.718 [main] INFO top.parak.jedis.Geo - hefei 
20:21:02.718 [main] INFO top.parak.jedis.Geo - shanghai 
20:21:02.718 [main] INFO top.parak.jedis.Geo - beijing 
20:21:02.718 [main] INFO top.parak.jedis.Geo - dalian 
20:21:02.718 [main] INFO top.parak.jedis.Geo - ==========æŸ¥è¯¢é»„å†ˆçš„ç»çº¬åº¦==========
20:21:02.720 [main] INFO top.parak.jedis.Geo - [(115.94427019357681,30.070331157985194)]
20:21:02.721 [main] INFO top.parak.jedis.Geo - ==========æŸ¥è¯¢è·ç¦»æ­å·ä¸è¶…è¿‡1000kmçš„åŸå¸‚==========
20:21:02.724 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šshanghai, ç»çº¬åº¦ï¼š(121.49295061826706,31.22337074392616)ï¼Œè·ç¦»ï¼š165.0KM
20:21:02.724 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šhefei, ç»çº¬åº¦ï¼š(117.26104170084,31.851170480671236)ï¼Œè·ç¦»ï¼š325.8468KM
20:21:02.725 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šhuanggang, ç»çº¬åº¦ï¼š(115.94427019357681,30.070331157985194)ï¼Œè·ç¦»ï¼š405.4241KM
20:21:02.725 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šwuhan, ç»çº¬åº¦ï¼š(114.31589037179947,30.55389005243692)ï¼Œè·ç¦»ï¼š560.6357KM
20:21:02.725 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šdalian, ç»çº¬åº¦ï¼š(121.64465099573135,38.91858901014995)ï¼Œè·ç¦»ï¼š969.6213KM
20:21:02.725 [main] INFO top.parak.jedis.Geo - ==========æŸ¥è¯¢è·ç¦»æ­¦æ±‰ä¸è¶…è¿‡1000KMçš„åŸå¸‚==========
20:21:02.725 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šwuhan, ç»çº¬åº¦ï¼š(114.31589037179947,30.55389005243692)ï¼Œè·ç¦»ï¼š0.0KM
20:21:02.725 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šhuanggang, ç»çº¬åº¦ï¼š(115.94427019357681,30.070331157985194)ï¼Œè·ç¦»ï¼š165.3475KM
20:21:02.726 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šhefei, ç»çº¬åº¦ï¼š(117.26104170084,31.851170480671236)ï¼Œè·ç¦»ï¼š315.1437KM
20:21:02.726 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šshanghai, ç»çº¬åº¦ï¼š(121.49295061826706,31.22337074392616)ï¼Œè·ç¦»ï¼š688.9652KM
20:21:02.726 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šguangzhou, ç»çº¬åº¦ï¼š(113.36112052202225,23.12467049411648)ï¼Œè·ç¦»ï¼š831.7263KM
20:21:02.726 [main] INFO top.parak.jedis.Geo - åŸå¸‚åç§°ï¼šshenzhen, ç»çº¬åº¦ï¼š(113.93029063940048,22.53290942281489)ï¼Œè·ç¦»ï¼š892.9663KM</code></pre>
<h4 id="9-2-2-âš«Hyper-apiæµ‹è¯•"><a href="#9-2-2-âš«Hyper-apiæµ‹è¯•" class="headerlink" title="9.2.2 âš«Hyper-apiæµ‹è¯•"></a>9.2.2 âš«Hyper-apiæµ‹è¯•</h4><blockquote>
<p>Hyper.java</p>
</blockquote>
<pre><code class="java">package top.parak.jedis;

import lombok.extern.log4j.Log4j2;
import redis.clients.jedis.Jedis;

/**
 * @author: KHighness
 * @date: 2020/10/11 20:26
 * @apiNote: æµ‹è¯•hyper
 */

@Log4j2
public class Hyper &#123;
    public static void main(String[] args) &#123;
        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);
        jedis.pfadd(&quot;hyper1&quot;, &quot;K&quot;, &quot;H&quot;, &quot;I&quot;, &quot;G&quot;, &quot;H&quot;, &quot;N&quot;, &quot;E&quot;, &quot;S&quot;, &quot;S&quot;);
        log.info(&quot;hyper1ä¸­çš„å…ƒç´ åŸºæ•°ï¼š&#123;&#125;&quot;, jedis.pfcount(&quot;hyper1&quot;));
        jedis.pfadd(&quot;hyper2&quot;, &quot;P&quot;, &quot;A&quot;, &quot;R&quot;, &quot;A&quot;, &quot;K&quot;);
        log.info(&quot;hyper2ä¸­çš„å…ƒç´ åŸºæ•°ï¼š&#123;&#125;&quot;, jedis.pfcount(&quot;hyper2&quot;));
        jedis.pfmerge(&quot;hyper&quot;, &quot;hyper1&quot;, &quot;hyper2&quot;);
        log.info(&quot;hyper1å’Œhyper2åˆå¹¶åçš„å…ƒç´ åŸºæ•°ï¼š&#123;&#125;&quot;, jedis.pfcount(&quot;hyper&quot;));
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<pre><code class="shell">20:36:20.386 [main] INFO top.parak.jedis.Hyper - hyper1ä¸­çš„å…ƒç´ åŸºæ•°ï¼š7
20:36:20.390 [main] INFO top.parak.jedis.Hyper - hyper2ä¸­çš„å…ƒç´ åŸºæ•°ï¼š4
20:36:20.390 [main] INFO top.parak.jedis.Hyper - hyper1å’Œhyper2åˆå¹¶åçš„å…ƒç´ åŸºæ•°ï¼š10</code></pre>
<h4 id="9-2-3-ğŸ”´Bitmaps-apiæµ‹è¯•"><a href="#9-2-3-ğŸ”´Bitmaps-apiæµ‹è¯•" class="headerlink" title="9.2.3 ğŸ”´Bitmaps-apiæµ‹è¯•"></a>9.2.3 ğŸ”´Bitmaps-apiæµ‹è¯•</h4><blockquote>
<p>Bit.java</p>
</blockquote>
<pre><code class="java">package top.parak.jedis;

import lombok.extern.log4j.Log4j2;
import redis.clients.jedis.BitOP;
import redis.clients.jedis.Jedis;

/**
 * @author: KHighness
 * @date: 2020/10/11 20:38
 * @apiNote: æµ‹è¯•Bitmaps
 */

@Log4j2
public class Bit &#123;
    public static String getChineseExpression(int i) &#123;
        switch (i) &#123;
            case 0: return &quot;æ˜ŸæœŸä¸€&quot;;
            case 1: return &quot;æ˜ŸæœŸäºŒ&quot;;
            case 2: return &quot;æ˜ŸæœŸä¸‰&quot;;
            case 3: return &quot;æ˜ŸæœŸå››&quot;;
            case 4: return &quot;æ˜ŸæœŸäº”&quot;;
            case 5: return &quot;æ˜ŸæœŸå…­&quot;;
            case 6: return &quot;æ˜ŸæœŸæ—¥&quot;;
            default: return &quot;Error&quot;;
        &#125;
    &#125;
    public static void main(String[] args) &#123;
        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);
        // æ¨¡æ‹Ÿä¸¤å‘¨çš„æ‰“å¡æƒ…å†µ
        boolean[] bool1 = new boolean[]&#123;true, true, true, true, true, false, false&#125;;
        boolean[] bool2 = new boolean[]&#123;false, false, false, true, true, true, false&#125;;
        for (int i = 0; i &lt; bool1.length; i++) &#123; jedis.setbit(&quot;2020:week:1&quot;, i, bool1[i]); &#125;
        for (int i = 0; i &lt; bool2.length; i++) &#123; jedis.setbit(&quot;2020:week:2&quot;, i, bool2[i]); &#125;
        log.info(&quot;2020å¹´ç¬¬ä¸€å‘¨çš„æ‰“å¡å¤©æ•°ï¼š&#123;&#125;&quot;, jedis.bitcount(&quot;2020:week:1&quot;));
        log.info(&quot;2020å¹´ç¬¬ä¸€å‘¨å…·ä½“æ‰“å¡æƒ…å†µ&quot;);
        for (int i = 0; i &lt; bool1.length; i++) &#123; log.info(getChineseExpression(i) + &quot;: &quot; + (jedis.getbit(&quot;2020:week:1&quot;, i) ? &quot;å·²æ‰“å¡&quot; : &quot;æœªæ‰“å¡&quot;)); &#125;
        log.info(&quot;2020å¹´ç¬¬äºŒå‘¨çš„æ‰“å¡å¤©æ•°ï¼š&#123;&#125;&quot;, jedis.bitcount(&quot;2020:week:2&quot;));
        log.info(&quot;2020å¹´ç¬¬äºŒå‘¨å…·ä½“æ‰“å¡æƒ…å†µ&quot;);
        for (int i = 0; i &lt; bool2.length; i++) &#123; log.info(getChineseExpression(i) + &quot;: &quot; + (jedis.getbit(&quot;2020:week:2&quot;, i) ? &quot;å·²æ‰“å¡&quot; : &quot;æœªæ‰“å¡&quot;)); &#125;
        jedis.bitop(BitOP.AND, &quot;2020:week:1and2&quot;, &quot;2020:week:1&quot;, &quot;2020:week:2&quot;);
        log.info(&quot;2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨ä¸¤å¤©éƒ½æ‰“å¡çš„å¤©æ•°ï¼š&#123;&#125;&quot;, jedis.bitcount(&quot;2020:week:1and2&quot;));
        jedis.bitop(BitOP.OR, &quot;2020:week:1or2&quot;, &quot;2020:week:1&quot;, &quot;2020:week:2&quot;);
        log.info(&quot;2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨è‡³å°‘æœ‰ä¸€å¤©æ‰“å¡çš„å¤©æ•°ï¼š&#123;&#125;&quot;, jedis.bitcount(&quot;2020:week:1or2&quot;));
        jedis.bitop(BitOP.XOR,&quot;2020:week:1xor2&quot;, &quot;2020:week:1&quot;, &quot;2020:week:2&quot;);
        log.info(&quot;2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨ä»…æœ‰ä¸€å¤©æ‰“å¡çš„å¤©æ•°ï¼š&#123;&#125;&quot;, jedis.bitcount(&quot;2020:week:1xor2&quot;));
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<pre><code class="shell">21:07:40.042 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬ä¸€å‘¨çš„æ‰“å¡å¤©æ•°ï¼š5
21:07:40.046 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬ä¸€å‘¨å…·ä½“æ‰“å¡æƒ…å†µ
21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸä¸€: å·²æ‰“å¡
21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸäºŒ: å·²æ‰“å¡
21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸä¸‰: å·²æ‰“å¡
21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸå››: å·²æ‰“å¡
21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸäº”: å·²æ‰“å¡
21:07:40.046 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸå…­: æœªæ‰“å¡
21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸæ—¥: æœªæ‰“å¡
21:07:40.047 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬äºŒå‘¨çš„æ‰“å¡å¤©æ•°ï¼š3
21:07:40.047 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬äºŒå‘¨å…·ä½“æ‰“å¡æƒ…å†µ
21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸä¸€: æœªæ‰“å¡
21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸäºŒ: æœªæ‰“å¡
21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸä¸‰: æœªæ‰“å¡
21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸå››: å·²æ‰“å¡
21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸäº”: å·²æ‰“å¡
21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸå…­: å·²æ‰“å¡
21:07:40.047 [main] INFO top.parak.jedis.Bit - æ˜ŸæœŸæ—¥: æœªæ‰“å¡
21:07:40.048 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨ä¸¤å¤©éƒ½æ‰“å¡çš„å¤©æ•°ï¼š2
21:07:40.048 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨è‡³å°‘æœ‰ä¸€å¤©æ‰“å¡çš„å¤©æ•°ï¼š6
21:07:40.048 [main] INFO top.parak.jedis.Bit - 2020å¹´ç¬¬ä¸€å‘¨å’Œç¬¬äºŒå‘¨ä»…æœ‰ä¸€å¤©æ‰“å¡çš„å¤©æ•°ï¼š4</code></pre>
<h4 id="9-2-4-ğŸ”µäº‹åŠ¡æµ‹è¯•"><a href="#9-2-4-ğŸ”µäº‹åŠ¡æµ‹è¯•" class="headerlink" title="9.2.4 ğŸ”µäº‹åŠ¡æµ‹è¯•"></a>9.2.4 ğŸ”µäº‹åŠ¡æµ‹è¯•</h4><blockquote>
<p>Affair.java</p>
</blockquote>
<pre><code class="java">package top.parak.jedis;

import com.alibaba.fastjson.JSONObject;
import lombok.extern.log4j.Log4j2;
import redis.clients.jedis.Jedis;
import redis.clients.jedis.Transaction;

import java.util.concurrent.TimeUnit;

/**
 * @author: KHighness
 * @date: 2020/10/11 21:33
 * @apiNote: æµ‹è¯•äº‹åŠ¡
 */

@Log4j2
public class Affair &#123;
    public static void main(String[] args) &#123;
        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);

        // åˆ›å»ºjsonæ•°æ®
        JSONObject jsonObject1 = new JSONObject();
        jsonObject1.put(&quot;name&quot;, &quot;KHighness&quot;);
        jsonObject1.put(&quot;age&quot;, 19);
        jsonObject1.put(&quot;constellation&quot;, &quot;Virgo&quot;);
        jsonObject1.put(&quot;Hobby&quot;, &quot;Jay&quot;);
        String json1 = jsonObject1.toJSONString();
        JSONObject jsonObject2 = new JSONObject();
        jsonObject2.put(&quot;name&quot;, &quot;BingYao&quot;);
        jsonObject2.put(&quot;age&quot;, 16);
        jsonObject2.put(&quot;constellation&quot;, &quot;Taurus&quot;);
        jsonObject2.put(&quot;Hobby&quot;, &quot;Czk&quot;);
        String json2 = jsonObject2.toJSONString();
        jedis.set(&quot;user1&quot;, json1);
        jedis.set(&quot;user2&quot;, json2);

        // åŠ å…¥ä¹è§‚é”
        jedis.watch(&quot;user1&quot;, &quot;user2&quot;);

        // å¼€å¯äº‹åŠ¡
        Transaction multi = jedis.multi();
        new Thread( () -&gt; &#123;
           try &#123;
               TimeUnit.SECONDS.sleep(5);
               multi.set(&quot;user1&quot;, json1);
               multi.set(&quot;user2&quot;, json2);
               // æ‰§è¡Œäº‹åŠ¡
               multi.exec();
           &#125; catch (InterruptedException e) &#123;
               // å‘ç”Ÿå¼‚å¸¸
               // æ”¾å¼ƒäº‹åŠ¡
               multi.discard();
               log.info(e.getMessage());
           &#125; finally &#123;
               // è¾“å‡ºæ•°æ®
               log.info(&quot;user1: [&#123;&#125;]&quot;, jedis.get(&quot;user1&quot;));
               log.info(&quot;user2: [&#123;&#125;]&quot;, jedis.get(&quot;user2&quot;));
               jedis.close();
           &#125;
        &#125;, &quot;Multi&quot;).start();

        // å¦ä¸€çº¿ç¨‹
        // å¼€å¯åœ¨äº‹åŠ¡ä¹‹å‰
        new Thread( () -&gt; &#123;
            try &#123;
                new Affair().resetInfo1(jedis);
            &#125; catch (InterruptedException e) &#123;
                log.info(e.getMessage());
            &#125;
        &#125;, &quot;Other&quot;).start();

    &#125;

    public void resetInfo1(Jedis jedis) throws InterruptedException &#123;
        TimeUnit.SECONDS.sleep(1);
        JSONObject jsonObject1 = new JSONObject();
        jsonObject1.put(&quot;name&quot;, &quot;KHighness&quot;);
        jsonObject1.put(&quot;age&quot;, 20);
        jsonObject1.put(&quot;constellation&quot;, &quot;Leo&quot;);
        jsonObject1.put(&quot;Hobby&quot;, &quot;BingYao&quot;);
        String json1 = jsonObject1.toJSONString();
        jedis.set(&quot;user1&quot;, json1);
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<pre><code class="shell">Exception in thread &quot;Other&quot; redis.clients.jedis.exceptions.JedisDataException: Cannot use Jedis when in Multi. Please use Transaction or reset jedis state.
    at redis.clients.jedis.BinaryJedis.checkIsInMultiOrPipeline(BinaryJedis.java:1895)
    at redis.clients.jedis.Jedis.set(Jedis.java:152)
    at top.parak.jedis.Affair.resetInfo1(Affair.java:82)
    at top.parak.jedis.Affair.lambda$main$1(Affair.java:66)
    at java.lang.Thread.run(Thread.java:748)
22:05:18.651 [Multi] INFO top.parak.jedis.Affair - user1: [&#123;&quot;constellation&quot;:&quot;Virgo&quot;,&quot;name&quot;:&quot;KHighness&quot;,&quot;Hobby&quot;:&quot;Jay&quot;,&quot;age&quot;:19&#125;]
22:05:18.654 [Multi] INFO top.parak.jedis.Affair - user2: [&#123;&quot;constellation&quot;:&quot;Taurus&quot;,&quot;name&quot;:&quot;BingYao&quot;,&quot;Hobby&quot;:&quot;Czk&quot;,&quot;age&quot;:16&#125;]</code></pre>
<h2 id="10-ğŸ“©Springbootæ•´åˆ"><a href="#10-ğŸ“©Springbootæ•´åˆ" class="headerlink" title="10. ğŸ“©Springbootæ•´åˆ"></a>10. ğŸ“©Springbootæ•´åˆ</h2><blockquote>
<p>âš ï¸notice</p>
</blockquote>
<p>åœ¨SpringBoot2.Xä¹‹åï¼ŒåŸæ¥ä½¿ç”¨çš„jedisè¢«æ›¿æ¢ä¸ºäº†lettuceï¼Œåœ¨windowsä¸‹lettuceè¿æ¥æ± ä»…æ”¯æŒ3.2.100ç‰ˆæœ¬çš„Redis</p>
<ul>
<li><p>jedisï¼šé‡‡ç”¨çš„ç›´è¿ï¼Œå¤šä¸ªçº¿ç¨‹æ“ä½œçš„è¯ï¼Œæ˜¯ä¸å®‰å…¨çš„ï¼Œå¦‚æœæƒ³è¦é¿å…ä¸å®‰å…¨ï¼Œéœ€è¦ä½¿ç”¨jedis poolè¿æ¥æ± ï¼Œæ›´åƒBIOæ¨¡å¼</p>
</li>
<li><p>lettuceï¼šåº•å±‚æ•´åˆNettyï¼Œå®ä¾‹å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«ï¼Œä¸å­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µï¼Œå¯ä»¥å‡å°‘çº¿ç¨‹æ•°æ®ï¼Œæ›´åƒNIOæ¨¡å¼</p>
</li>
</ul>
<h3 id="10-1-ğŸ”æºç åˆ†æ"><a href="#10-1-ğŸ”æºç åˆ†æ" class="headerlink" title="10.1 ğŸ”æºç åˆ†æ"></a>10.1 ğŸ”æºç åˆ†æ</h3><blockquote>
<p>è‡ªåŠ¨é…ç½®ç±»ï¼šRedisAutoConfiguration.java</p>
</blockquote>
<pre><code class="java">@Configuration(
    proxyBeanMethods = false
)
@ConditionalOnClass(&#123;RedisOperations.class&#125;)
@EnableConfigurationProperties(&#123;RedisProperties.class&#125;)
@Import(&#123;LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class&#125;)
public class RedisAutoConfiguration &#123;
    public RedisAutoConfiguration() &#123;
    &#125;

    @Bean
    @ConditionalOnMissingBean(name = &#123;&quot;redisTemplate&quot;&#125;) 
    // ==&gt; è¿™ä¸ªæ³¨è§£è¯´æ˜ï¼Œä¸å­˜åœ¨æˆ‘ä»¬è‡ªå®šä¹‰åä¸ºredisTemplateçš„Beançš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªBeanæ‰ç”Ÿæ•ˆ
    // ==&gt; å› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„RedisTemplateï¼ŒSpringBootä¼šä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰RedisTemplate
    public RedisTemplate&lt;Object, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) throws UnknownHostException &#123;
        // é»˜è®¤çš„RedisTemplateæ²¡æœ‰è¿‡å¤šçš„é…ç½®ï¼ŒRediså¯¹è±¡éƒ½éœ€è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–
        // ä¸¤ä¸ªæ³›å‹éƒ½æ˜¯ Object, Obeject çš„ç±»å‹ï¼Œæˆ‘ä»¬ä»¥åä½¿ç”¨éœ€è¦å¼ºåˆ¶è½¬æ¢æˆ String, Object
        RedisTemplate&lt;Object, Object&gt; template = new RedisTemplate();
        template.setConnectionFactory(redisConnectionFactory);
        return template;
    &#125;

    @Bean
    @ConditionalOnMissingBean
    // ç”±äºStringæ˜¯Redisä¸­æœ€å¸¸ä½¿ç”¨çš„ç±»å‹ï¼Œæ‰€ä»¥å•ç‹¬ä¸€ä¸ªStringRedisTemplate
    // æ‰€ä»¥æ“ä½œStringç±»å‹ï¼Œç›´æ¥ä½¿ç”¨StringRedisTemplateå³å¯
    public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory) throws UnknownHostException &#123;
        StringRedisTemplate template = new StringRedisTemplate();
        template.setConnectionFactory(redisConnectionFactory);
        return template;
    &#125;
&#125;</code></pre>
<h3 id="10-2-ğŸ”‘æ•´åˆä½¿ç”¨"><a href="#10-2-ğŸ”‘æ•´åˆä½¿ç”¨" class="headerlink" title="10.2 ğŸ”‘æ•´åˆä½¿ç”¨"></a>10.2 ğŸ”‘æ•´åˆä½¿ç”¨</h3><blockquote>
<p>å¯¼å…¥ä¾èµ–ï¼špom.xml(è§ä¸Šjedis)</p>
</blockquote>
<blockquote>
<p>é…ç½®ç¯å¢ƒï¼šapplication.properties</p>
</blockquote>
<pre><code class="properties"># Redisæ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤ä¸º0ï¼‰
spring.redis.database=0
# RedisæœåŠ¡å™¨åœ°å€
spring.redis.host=127.0.0.1
# RedisæœåŠ¡å™¨è¿æ¥ç«¯å£
spring.redis.port=6379
# RedisæœåŠ¡å™¨è¿æ¥å¯†ç ï¼ˆé»˜è®¤ä¸ºç©ºï¼‰
spring.redis.password=
# è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
spring.redis.timeout=100

# Spring 2.Xä»¥åï¼Œä½¿ç”¨lettuceè¿æ¥æ± 
# è¿æ¥æ± æœ€å¤§é˜»å¡ç­‰å¾…æ—¶é—´ï¼ˆä½¿ç”¨è´Ÿå€¼è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ï¼‰
spring.redis.lettuce.pool.max-active=100
# è¿æ¥æ± ä¸­çš„æœ€å¤§ç©ºé—²è¿æ¥
spring.redis.lettuce.pool.max-idle=10
# è¿æ¥æ± ä¸­çš„æœ€å°ç©ºé—²è¿æ¥
spring.redis.lettuce.pool.min-idle=0
# è¿æ¥è¶…æ—¶æ—¶é—´
spring.redis.lettuce.shutdown-timeout=100ms</code></pre>
<blockquote>
<p>âŒ¨ï¸è‡ªå®šä¹‰RedisTemplateï¼šRedisConfig.java</p>
</blockquote>
<pre><code class="java">package top.parak.config;

import com.fasterxml.jackson.annotation.JsonAutoDetect;
import com.fasterxml.jackson.annotation.PropertyAccessor;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.jsontype.impl.LaissezFaireSubTypeValidator;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;

/**
 * @author: KHighness
 * @date: 2020/10/7 20:23
 * @apiNote: è‡ªå®šä¹‰RedisTemplate
 */

@Configuration
public class RedisConfig &#123;

    /**
     * &lt;p&gt;è‡ªå®šä¹‰redisTemplate&lt;/p&gt;
     * @param redisConnectionFactory
     * @return
     */
    @Bean
    @SuppressWarnings(&quot;all&quot;)
    @Qualifier(&quot;redisTemplate&quot;)
    public RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) &#123;
        /* åˆ›å»ºredisTemplate */
        RedisTemplate&lt;String, Object&gt; redisTemplate = new RedisTemplate&lt;&gt;();
        /* å…³è”redisConnectionFactory */
        redisTemplate.setConnectionFactory(redisConnectionFactory);
        /* Jackson2JsonRedisSerializerï¼šJsonåºåˆ—åŒ–å™¨ */
        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer(Object.class);
        redisTemplate.setKeySerializer(jackson2JsonRedisSerializer);
        ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
        objectMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL);
        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);
        /* StringRedisSerializerï¼šStringåºåˆ—åŒ–å™¨ */
        StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();
        /* è®¾ç½®keyçš„åºåˆ—åŒ–æ–¹å¼ï¼šString */
        redisTemplate.setKeySerializer(stringRedisSerializer);
        /* è®¾ç½®valueçš„åºåˆ—åŒ–æ–¹å¼ï¼šJson */
        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);
        /* è®¾ç½®hashçš„keyçš„åºåˆ—åŒ–æ–¹å¼ï¼šJson */
        redisTemplate.setHashKeySerializer(jackson2JsonRedisSerializer);
        /* è®¾ç½®hashçš„valueçš„åºåˆ—åŒ–æ–¹å¼ï¼šJson */
        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);
        redisTemplate.afterPropertiesSet();
        return redisTemplate;
    &#125;

&#125;</code></pre>
<blockquote>
<p>âŒ¨ï¸Rediså·¥å…·ç±»ï¼šRedisUtil.java</p>
</blockquote>
<pre><code class="java">package top.parak.common;

import lombok.extern.log4j.Log4j2;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;

import java.util.Map;
import java.util.Set;
import java.util.concurrent.TimeUnit;

/**
 * @author: KHighness
 * @date: 2020/10/7 21:33
 * @apiNote: Redisæ“ä½œå·¥å…·ç±»
 */

@Log4j2
@Component
public class RedisUtil &#123;

    @Autowired
    private RedisTemplate&lt;String, Object&gt; redisTemplate;

    /*==================================================================
    //                            common                              //
    ==================================================================*/

    /**
     * æŒ‡å®šç¼“å­˜å¤±æ•ˆæ—¶é—´
     * @param key é”®
     * @param time æ—¶é—´(ç§’)
     * @return true æˆåŠŸï¼Œfalse å¤±è´¥
     */
    public boolean expire(String key, long time) &#123;
        try &#123;
            if (time &gt; 0) &#123;
                redisTemplate.expire(key, time, TimeUnit.SECONDS);
            &#125;
            return true;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * æ ¹æ®keyè·å–è¿‡æœŸæ—¶é—´
     * @param key é”®
     * @return æ—¶é—´(ç§’) è¿”å›0ä»£è¡¨æ°¸ä¹…æœ‰æ•ˆ
     */
    public long getExpire(String key) &#123;
        return redisTemplate.getExpire(key, TimeUnit.SECONDS);
    &#125;

    /*==================================================================
    //                            String                              //
    ==================================================================*/

    /**
     * åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨
     * @param key é”®
     * @return true å­˜åœ¨ï¼Œfalse ä¸å­˜åœ¨
     */
    public boolean hasKey(String key) &#123;
        try &#123;
            return redisTemplate.hasKey(key);
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * åˆ é™¤ç¼“å­˜
     * @param key å¯ä»¥ä¼ ä¸€ä¸ªæˆ–å¤šä¸ª
     */
    public void del(String... key) &#123;
        if (key != null &amp;&amp; key.length &gt; 0) &#123;
            if (key.length == 1) &#123;
                redisTemplate.delete(key[0]);
            &#125; else &#123;
                redisTemplate.delete(CollectionUtils.arrayToList(key));
            &#125;
        &#125;
    &#125;

    /**
     * æ™®é€šç¼“å­˜è·å–
     * @param key é”®
     * @return å€¼
     */
    public Object get(String key) &#123;
        return key == null ? null : redisTemplate.opsForValue().get(key);
    &#125;

    /**
     * æ™®é€šç¼“å­˜æ”¾å…¥
     * @param key   é”®
     * @param value å€¼
     * @return true æˆåŠŸï¼Œfalse å¤±è´¥
     */
    public boolean set(String key, Object value) &#123;
        try &#123;
            redisTemplate.opsForValue().set(key, value);
            return true;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * æ™®é€šç¼“å­˜æ”¾å…¥å¹¶è®¾ç½®æ—¶é—´
     * @param key   é”®
     * @param value å€¼
     * @param time æ—¶é—´(ç§’) timeè¦å¤§äº0 å¦‚æœtimeå°äºç­‰äº0 å°†è®¾ç½®æ— é™æœŸ
     * @return true æˆåŠŸï¼Œfalse å¤±è´¥
     */
    public boolean set(String key, Object value, long time) &#123;
        try &#123;
            if (time &gt; 0) &#123;
                redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);
            &#125; else &#123;
                set(key, value);
            &#125;
            return true;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * é€’å¢
     * @param key   é”®
     * @param delta å¢é‡
     * @return é€’å¢åçš„å€¼
     */
    public long incr(String key, long delta) &#123;
        if (delta &lt; 0) &#123;
            throw new RuntimeException(&quot;å¢é‡å¿…é¡»å¤§äº0&quot;);
        &#125;
        return redisTemplate.opsForValue().increment(key, delta);
    &#125;

    /**
     * é€’å‡
     * @param key   é”®
     * @param delta å‡é‡
     * @return é€’å‡åçš„å€¼
     */
    public long decr(String key, long delta) &#123;
        if (delta &lt; 0) &#123;
            throw new RuntimeException(&quot;å‡é‡å¿…é¡»å¤§äº0&quot;);
        &#125;
        return redisTemplate.opsForValue().decrement(key, delta);
    &#125;

    /*==================================================================
    //                              map                               //
    ==================================================================*/

    /**
     * HashGet
     * @param key  é”® ä¸èƒ½ä¸ºNULL
     * @param item é¡¹ ä¸èƒ½ä¸ºNULL
     * @return å€¼
     */
    public Object hget(String key, String item) &#123;
        return redisTemplate.opsForHash().get(key, item);
    &#125;

    /**
     * è·å–hashKeyå¯¹åº”çš„æ‰€æœ‰é”®å€¼
     * @param key é”®
     * @return å¯¹åº”çš„å¤šä¸ªé”®å€¼
     */
    public Map&lt;Object, Object&gt; hmget(String key) &#123;
        return redisTemplate.opsForHash().entries(key);
    &#125;

    /**
     * HashSet
     * @param key é”®
     * @param map å¯¹åº”çš„å¤šä¸ªé”®å€¼
     * @return true æˆåŠŸï¼Œfalse å¤±è´¥
     */
    public boolean hmset(String key, Map&lt;String, Object&gt; map) &#123;
        try &#123;
            redisTemplate.opsForHash().putAll(key, map);
            return true;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * HashSet å¹¶è®¾ç½®æ—¶é—´
     * @param key é”®
     * @param map å¯¹åº”å¤šä¸ªé”®å€¼
     * @param time æ—¶é—´(ç§’)
     * @return true æˆåŠŸï¼Œfalse å¤±è´¥
     */
    public boolean hmset(String key, Map&lt;String, Object&gt; map, long time) &#123;
        try &#123;
            redisTemplate.opsForHash().putAll(key, map);
            if (time &gt; 0) &#123;
                expire(key, time);
            &#125;
            return true;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * å‘ä¸€å¼ hashè¡¨ä¸­æ”¾å…¥æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
     * @param key   é”®
     * @param item  é¡¹
     * @param value å€¼
     * @return true æˆåŠŸï¼Œfalse å¤±è´¥
     */
    public boolean hset(String key, String item, Object value) &#123;
        try &#123;
            redisTemplate.opsForHash().put(key, item, value);
            return true;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * å‘ä¸€å¼ hashè¡¨ä¸­æ”¾å…¥æ•°æ®ï¼Œå¹¶è®¾ç½®æ—¶é—´ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
     * @param key   é”®
     * @param item  é¡¹
     * @param value å€¼
     * @param time  æ—¶é—´(ç§’) å¦‚æœå·²å­˜åœ¨çš„hashè¡¨æœ‰æ—¶é—´ï¼Œè¿™é‡Œä¼šæ›´æ–°åŸå€¼
     * @return true æˆåŠŸï¼Œfalse å¤±è´¥
     */
    public boolean hset(String key, String item, Object value, long time) &#123;
        try &#123;
            redisTemplate.opsForHash().put(key, item, value);
            if (time &gt; 0) &#123;
                expire(key, time);
            &#125;
            return true;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * åˆ é™¤hashè¡¨ä¸­çš„å€¼
     * @param key  é”® ä¸èƒ½ä¸ºNULL
     * @param item é¡¹ å¯ä»¥ä½¿å¤šä¸ª ä¸èƒ½ä¸ºNULL
     */
    public void hdel(String key, Object... item) &#123;
        redisTemplate.opsForHash().delete(key, item);
    &#125;

    /**
     * åˆ¤æ–­hashè¡¨ä¸­æ˜¯å¦æœ‰è¯¥é¡¹çš„å€¼
     * @param key  é”® ä¸èƒ½ä¸ºNULL
     * @param item é¡¹ ä¸èƒ½ä¸ºNULL
     * @return true å­˜åœ¨ï¼Œfalse ä¸å­˜åœ¨
     */
    public boolean hHasKey(String key, String item) &#123;
        return redisTemplate.opsForHash().hasKey(key, item);
    &#125;

    /**
     * hashé€’å¢ å¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªï¼Œå¹¶æŠŠé€’å¢åçš„å€¼è¿”å›
     * @param key  é”®
     * @param item å€¼
     * @param by   å¢é‡
     * @return é€’å¢åçš„å€¼
     */
    public double hincr(String key, String item, double by) &#123;
        return redisTemplate.opsForHash().increment(key, item, by);
    &#125;

    /**
     * hashé€’å‡
     * @param key  é”®
     * @param item å€¼
     * @param by   å‡é‡
     * @return é€’å‡åçš„å€¼
     */
    public double hdecr(String key, String item, double by) &#123;
        return redisTemplate.opsForHash().increment(key, item, -by);
    &#125;

    /*==================================================================
    //                              set                               //
    ==================================================================*/

    /**
     * æ ¹æ®keyè·å–Setä¸­çš„æ‰€æœ‰å€¼
     * @param key é”®
     * @return setä¸­çš„æ‰€æœ‰å€¼
     */
    public Set&lt;Object&gt; sGet(String key) &#123;
        try &#123;
            return redisTemplate.opsForSet().members(key);
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return null;
        &#125;
    &#125;

    /**
     * æ ¹æ®valueä»ä¸€ä¸ªsetä¸­æŸ¥è¯¢æ˜¯å¦å­˜åœ¨
     * @param key   é”®
     * @param value å€¼
     * @return true å­˜åœ¨ï¼Œfalse ä¸å­˜åœ¨
     */
    public boolean sHasKey(String key, Object value) &#123;
        try &#123;
            return redisTemplate.opsForSet().isMember(key, value);
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * å°†æ•°æ®æ”¾å…¥setç¼“å­˜
     * @param key    é”®
     * @param values å€¼ å¯ä»¥æ˜¯å¤šä¸ª
     * @return æˆåŠŸä¸ªæ•°
     */
    public long sSet(String key, Object... values) &#123;
        try &#123;
            return redisTemplate.opsForSet().add(key, values);
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return 0;
        &#125;
    &#125;

    /**
     * å°†setæ•°æ®æ”¾å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®æ—¶é—´
     * @param key    é”®
     * @param time   æ—¶é—´(ç§’)
     * @param values å€¼ å¯ä»¥æ˜¯å¤šä¸ª
     * @return æˆåŠŸä¸ªæ•°
     */
    public long sSetAndTime(String key, long time, Object... values) &#123;
        try &#123;
            Long count = redisTemplate.opsForSet().add(key, values);
            if (time &gt; 0) &#123;
                expire(key, time);
            &#125;
            return count;
        &#125; catch (Exception e) &#123;
            log.info(e.getMessage());
            return 0;
        &#125;
    &#125;

    /**
     * è·å–setç¼“å­˜çš„é•¿åº¦
     * @param key é”®
     * @return setçš„é•¿åº¦
     */
    public long sGetSetSize(String key) &#123;
        try &#123;
            return redisTemplate.opsForSet().size(key);
        &#125; catch (Exception e) &#123;
            log.info(e.getMessage());
            return 0;
        &#125;
    &#125;

    /*==================================================================
    //                             list                               //
    ==================================================================*/

    /**
     * è·å–listç¼“å­˜çš„é•¿åº¦
     * @param key é”®
     * @return listçš„é•¿åº¦
     */
    public long lGetListSize(String key) &#123;
        try &#123;
            return redisTemplate.opsForList().size(key);
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return 0;
        &#125;
    &#125;

    /**
     * é€šè¿‡ç´¢å¼•è·å–listä¸­çš„å€¼
     * @param key   é”®
     * @param index ç´¢å¼• index &gt;= 0æ—¶ï¼Œ0 è¡¨å¤´ï¼Œ1 ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä¾æ¬¡ç±»æ¨ï¼›index &lt; 0æ—¶ï¼Œ-1 è¡¨å°¾ï¼Œ-2 å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä¾æ¬¡ç±»æ¨
     * @return å€¼
     */
    public Object lGetIndex(String key, long index) &#123;
        try &#123;
            return redisTemplate.opsForList().index(key, index);
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return null;
        &#125;
    &#125;

    /**
     * å°†listæ”¾å…¥ç¼“å­˜
     * @param key   é”®
     * @param value å€¼
     * @return true æˆåŠŸï¼Œfalse å¤±è´¥
     */
    public boolean lSet(String key, Object value) &#123;
        try &#123;
            redisTemplate.opsForList().rightPush(key, value);
            return true;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * å°†listæ”¾å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®æ—¶é—´
     * @param key   é”®
     * @param value å€¼
     * @param time  æ—¶é—´(ç§’)
     * @return æˆåŠŸæ•°é‡
     */
    public boolean lSet(String key, Object value, long time) &#123;
        try &#123;
            redisTemplate.opsForList().rightPush(key, value);
            if (time &gt; 0) &#123;
                expire(key, time);
            &#125;
            return true;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * æ ¹æ®ç´¢å¼•ä¿®æ”¹listä¸­çš„æŸæ¡æ•°æ®
     * @param key   é”®
     * @param index ç´¢å¼•
     * @param value å€¼
     * @return true æˆåŠŸï¼Œfalse å¤±è´¥
     */
    public boolean lUpdateIndex(String key, long index, Object value) &#123;
        try &#123;
            redisTemplate.opsForList().set(key, index, value);
            return true;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return false;
        &#125;
    &#125;

    /**
     * ç§»é™¤Nä¸ªå€¼ä¸ºvalue
     * @param key   é”®
     * @param count ç§»é™¤æ•°é‡
     * @param value å€¼
     * @return ç§»é™¤æ•°é‡
     */
    public long lRemove(String key, long count ,Object value) &#123;
        try &#123;
            Long remove = redisTemplate.opsForList().remove(key, count, value);
            return remove;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            return 0;
        &#125;
    &#125;

&#125;</code></pre>
<h3 id="10-3-ğŸ’¨apiæµ‹è¯•"><a href="#10-3-ğŸ’¨apiæµ‹è¯•" class="headerlink" title="10.3 ğŸ’¨apiæµ‹è¯•"></a>10.3 ğŸ’¨apiæµ‹è¯•</h3><pre><code class="java">package top.parak;


import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.data.redis.core.StringRedisTemplate;
import top.parak.common.RedisUtil;
import top.parak.entity.User;
import lombok.extern.log4j.Log4j2;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.data.redis.core.RedisTemplate;

import java.util.HashMap;
import java.util.Map;

@SpringBootTest
@Log4j2
class SpringbootRedisApplicationTest &#123;

    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    @Autowired
    private RedisTemplate redisTemplate;

    @Autowired
    private RedisUtil redisUtil;

    @Test
    void main() &#123;
        redisTemplate.opsForValue().set(&quot;name&quot;, &quot;Kæ®¿ä¸‹&quot;);
        log.info(redisTemplate.opsForValue().get(&quot;name&quot;));
    &#125;

    @Test
    void test1() &#123;
        stringRedisTemplate.opsForValue().set(&quot;Knum&quot;, &quot;3&quot;);
        log.info(stringRedisTemplate.opsForValue().increment(&quot;Knum&quot;, 3));
    &#125;

    @Test
    void test2() throws JsonProcessingException &#123;
        User user = new User(&quot;KHighness&quot;, 19);
        String jsonUser = new ObjectMapper().writeValueAsString(user);
        redisTemplate.opsForValue().set(&quot;user&quot;, user);
        log.info(redisTemplate.opsForValue().get(&quot;user&quot;));
    &#125;

    @Test
    void test3() &#123;
        HashMap hashMap = new HashMap&lt;String, String&gt;();
        hashMap.put(&quot;name1&quot;, &quot;KHighness&quot;);
        hashMap.put(&quot;name2&quot;, &quot;ParaK&quot;);
        hashMap.put(&quot;name3&quot;, &quot;FlowerK&quot;);
        redisUtil.hmset(&quot;K&quot;, hashMap);
        for (Map.Entry k : redisUtil.hmget(&quot;K&quot;).entrySet()) &#123;
            log.info(k.toString());
        &#125;
    &#125;

&#125;</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<pre><code class="java">
                        __ __ __    _       __
                       / //_// /_  (_)___ _/ /_  ____  ___  __________
                      / ,&lt;  / __ \/ / __ `/ __ \/ __ \/ _ \/ ___/ ___/
                     / /| |/ / / / / /_/ / / / / / / /  __(__  |__  )
                    /_/ |_/_/ /_/_/\__, /_/ /_/_/ /_/\___/____/____/
                                  /____/

                     Copyright Â© 2020 KHighness. All Rights Reserved

2020-10-12 13:36:35.073  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : No active profile set, falling back to default profiles: default
2020-10-12 13:36:35.417  INFO 18840 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Multiple Spring Data modules found, entering strict repository configuration mode!
2020-10-12 13:36:35.420  INFO 18840 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Bootstrapping Spring Data Redis repositories in DEFAULT mode.
2020-10-12 13:36:35.445  INFO 18840 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Finished Spring Data repository scanning in 10ms. Found 0 Redis repository interfaces.
2020-10-12 13:36:35.534  INFO 18840 --- [           main] o.s.cloud.context.scope.GenericScope     : BeanFactory id=8d774ca9-71ca-37a9-91e1-35cd9af79e44
2020-10-12 13:36:35.699  INFO 18840 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean &#39;org.springframework.cloud.autoconfigure.ConfigurationPropertiesRebinderAutoConfiguration&#39; of type [org.springframework.cloud.autoconfigure.ConfigurationPropertiesRebinderAutoConfiguration$$EnhancerBySpringCGLIB$$67ea5b63] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
2020-10-12 13:36:36.483  INFO 18840 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService &#39;applicationTaskExecutor&#39;
2020-10-12 13:36:36.818  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : Started SpringbootRedisApplicationTest in 2.287 seconds (JVM running for 3.29)

2020-10-12 13:36:37.191  INFO 18840 --- [           main] io.lettuce.core.EpollProvider            : Starting without optional epoll library
2020-10-12 13:36:37.192  INFO 18840 --- [           main] io.lettuce.core.KqueueProvider           : Starting without optional kqueue library
2020-10-12 13:36:37.740  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : Kæ®¿ä¸‹

2020-10-12 13:36:37.762  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : 6

2020-10-12 13:36:37.802  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : User(name=KHighness, age=19)

2020-10-12 13:36:37.836  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : name3=FlowerK
2020-10-12 13:36:37.836  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : name2=ParaK
2020-10-12 13:36:37.836  INFO 18840 --- [           main] t.parak.SpringbootRedisApplicationTest   : name1=KHighness</code></pre>
<h2 id="11-ğŸ“©RedisæŒä¹…åŒ–"><a href="#11-ğŸ“©RedisæŒä¹…åŒ–" class="headerlink" title="11. ğŸ“©RedisæŒä¹…åŒ–"></a>11. ğŸ“©RedisæŒä¹…åŒ–</h2><blockquote>
<p>ğŸ“Œtip</p>
</blockquote>
<p>Redisæ˜¯å†…å­˜æ•°æ®åº“ï¼Œå¦‚æœä¸å°†å†…å­˜ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¿å­˜åœ¨ç£ç›˜ï¼Œé‚£ä¹ˆä¸€æ—¦æœåŠ¡å™¨è¿›ç¨‹é€€å‡ºï¼ŒæœåŠ¡å™¨ä¸­çš„æ•°æ®åº“çŠ¶æ€ä¹Ÿä¼šæ¶ˆå¤±ã€‚æ‰€ä»¥Redisæä¾›äº†æŒä¹…åŒ–åŠŸèƒ½ã€‚</p>
<ul>
<li><p>Redisé»˜è®¤æ˜¯æŒ‰ç…§å¿«ç…§RDBçš„æŒä¹…åŒ–æ–¹å¼</p>
</li>
<li><p>Redisé‡å¯çš„æ—¶å€™ä¼šä¼˜å…ˆä½¿ç”¨AOFæ–‡ä»¶è¿˜åŸæ•°æ®åº“çŠ¶æ€</p>
</li>
</ul>
<h3 id="11-1-ğŸ“RDB"><a href="#11-1-ğŸ“RDB" class="headerlink" title="11.1 ğŸ“RDB"></a>11.1 ğŸ“RDB</h3><blockquote>
<p>ğŸ””RDB = Redis Database</p>
</blockquote>
<p>å°†å†…å­˜ä¸­çš„æ•°æ®ä»¥å¿«ç…§â€RDBâ€çš„å½¢å¼å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜çš„ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶dump.rdbï¼Œå®šæ—¶ä¿å­˜ã€‚</p>
<blockquote>
<p>ğŸ”¨é…ç½®</p>
</blockquote>
<pre><code>save 900 1    # 15åˆ†é’Ÿå¤‡ä»½ä¸€æ¬¡
save 300 10   # å¦‚æœåœ¨300så†…ï¼Œè‡³å°‘æœ‰10ä¸ªkeyè¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ
save 60 10000 # å¦‚æœåœ¨60så†…ï¼Œè‡³å°‘æœ‰10000ä¸ªkeyè¿›è¡Œäº†ä¿®æ”¹ï¼Œå°±è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</code></pre>
<p>å¯ä»¥åœ¨24å°æ—¶å†…ï¼Œæ¯å°æ—¶å¤‡ä»½ä¸€æ¬¡ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªæœˆçš„æ¯ä¸€å¤©ä¹Ÿå¤‡ä»½ä¸€ä¸ªRDBæ–‡ä»¶ã€‚</p>
<p>è¿™æ ·çš„è¯ï¼Œå³ä½¿é‡ä¸Šé—®é¢˜ï¼Œä¹Ÿå¯ä»¥éšæ—¶å°†æ•°æ®é›†æ¢å¤åˆ°ä¸åŒçš„ç‰ˆæœ¬ã€‚</p>
<blockquote>
<p>ğŸ”å·¥ä½œæœºåˆ¶</p>
</blockquote>
<p>Redisä¼šå•ç‹¬åˆ›å»º(fork)ä¸€ä¸ªå­è¿›ç¨‹æ¥è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¼šå…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œå¾…æŒä¹…åŒ–è¿‡ç¨‹éƒ½ç»“æŸäº†ï¼Œå†ç”¨è¿™ä¸ªä¸´æ—¶æ–‡ä»¶æ›¿æ¢ä¸Šæ¬¡æŒä¹…åŒ–å¥½çš„æ–‡ä»¶ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»è¿›ç¨‹æ˜¯ä¸è¿›è¡Œä»»ä½•I/Oæ“ä½œçš„ã€‚è¿™å°±ç¡®ä¿äº†æé«˜çš„æ€§èƒ½ã€‚å¦‚æœéœ€è¦è¿›è¡Œå¤§è§„æ¨¡æ•°æ®çš„æ¢å¤ï¼Œä¸”å¯¹äºæ•°æ®æ¢å¤çš„å®Œæ•´æ€§ä¸æ˜¯éå¸¸æ•æ„Ÿï¼Œé‚£RDBæ–¹å¼è¦æ¯”AOFæ–¹å¼æ›´åŠ é«˜æ•ˆã€‚RDBçš„<strong>ç¼ºç‚¹æ˜¯æœ€åä¸€æ¬¡æŒä¹…åŒ–åçš„æ•°æ®å¯èƒ½ä¸¢å¤±</strong>ã€‚æˆ‘ä»¬é»˜è®¤çš„å°±æ˜¯RDBï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦ä¿®æ”¹è¿™ä¸ªé…ç½®ã€‚</p>
<blockquote>
<p>ğŸ’£è§¦å‘æœºåˆ¶</p>
</blockquote>
<ul>
<li>saveçš„è§„åˆ™æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¼šè‡ªåŠ¨è§¦å‘rdbè§„åˆ™</li>
<li>æ‰§è¡Œflushallå‘½ä»¤ï¼Œä¹Ÿä¼šè§¦å‘rdbè§„åˆ™</li>
<li>é€€å‡ºredisï¼Œä¹Ÿä¼šäº§ç”Ÿrdbæ–‡ä»¶</li>
</ul>
<blockquote>
<p>ğŸ’Ÿæ¢å¤rdb</p>
</blockquote>
<ul>
<li><p>å°†rdbæ–‡ä»¶æ”¾åœ¨rediså¯åŠ¨ç›®å½•ï¼ŒredisæœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨æ£€æŸ¥dump.rdbï¼Œæ¢å¤å…¶ä¸­çš„æ•°æ®</p>
</li>
<li><p>æŸ¥çœ‹éœ€è¦å­˜åœ¨çš„ä½ç½®</p>
</li>
</ul>
<pre><code class="shell">127.0.0.1:6379&gt; config get dir
1) &quot;dir&quot;
2) &quot;/usr/local/bin&quot; # å¦‚æœåœ¨è¿™ä¸ªç›®å½•ä¸‹å­˜åœ¨dump.rdbæ–‡ä»¶ï¼Œå¯åŠ¨å°±ä¼šè‡ªåŠ¨æ¢å¤å…¶ä¸­çš„æ•°æ®</code></pre>
<blockquote>
<p>ğŸŒ ä¼˜ç‚¹ç¼ºç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li><p>é€‚åˆå¤§è§„æ¨¡çš„æ•°æ®æ¢å¤(é€‚åˆæ–‡ä»¶å¤‡ä»½)</p>
</li>
<li><p>å¯¹æ•°æ®çš„å®Œæ•´æ€§è¦æ±‚ä¸é«˜</p>
</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>RedisæœåŠ¡å™¨å®•æœºæ—¶ä¼šä¸¢å¤±æ•°æ®</p>
</li>
<li><p>forkè¿›ç¨‹ä¼šå ç”¨ä¸€å®šçš„å†…å®¹ç©ºé—´</p>
</li>
</ul>
<h3 id="11-2-ğŸ“AOF"><a href="#11-2-ğŸ“AOF" class="headerlink" title="11.2 ğŸ“AOF"></a>11.2 ğŸ“AOF</h3><blockquote>
<p>ğŸ””AOF = Append Only Mode</p>
</blockquote>
<p>æŠŠæ‰€æœ‰çš„å¯¹Redisçš„æœåŠ¡å™¨è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤éƒ½å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶(é»˜è®¤ä¸ºappendonly.aof)é‡Œï¼Œå‘½ä»¤çš„é›†åˆã€‚</p>
<blockquote>
<p>ğŸ””é…ç½®</p>
</blockquote>
<pre><code class="shell">appendonly yes # å¼€å¯AOF
appendfsync yes # é»˜è®¤å¼€å¯åŒæ­¥
appendfsync always # æ¯æ¬¡æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶å€™éƒ½ä¼šå†™å…¥AOFæ–‡ä»¶
appendfsync everysec # æ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œè¿™ä¸ªæ­»AOFçš„ç¼ºçœç­–ç•¥</code></pre>
<blockquote>
<p>ğŸ“AOFé‡å†™</p>
</blockquote>
<ul>
<li>AOFæ–‡ä»¶çš„å¤§å°éšç€æ—¶é—´çš„æµé€ä¸€å®šè¶Šæ¥è¶Šå¤§ï¼Œå½±å“åŒ…æ‹¬ä½†ä¸é™äºï¼šå¯¹äºRedisæœåŠ¡å™¨è®¡ç®—æœºçš„å­˜å‚¨å‹åŠ›ï¼›AOFè¿˜åŸæ•°æ®åº“çŠ¶æ€çš„æ—¶é—´å¢åŠ </li>
<li>ä¸ºäº†è§£å†³AOFæ–‡ä»¶ä½“ç§¯è†¨èƒ€çš„é—®é¢˜ï¼ŒRedisæä¾›äº†AOFé‡å†™åŠŸèƒ½ï¼šRedisæœåŠ¡å™¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„AOFæ–‡ä»¶æ¥æ›¿ä»£ç°æœ‰çš„AOFæ–‡ä»¶ï¼Œæ–°æ—§ä¸¤ä¸ªæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯æ–°çš„AOF æ–‡ä»¶ä¸ä¼šåŒ…å«ä»»ä½•æµªè´¹ç©ºé—´çš„å†—ä½™å‘½ä»¤ï¼Œé€šå¸¸ä¼šè¾ƒæ—§AOFæ–‡ä»¶å°å¾ˆå¤š</li>
</ul>
<p>Redisä¼šåœ¨æœ€è¿‘ä¸€æ¬¡é‡å†™åè®°ä½AOFæ–‡ä»¶çš„å¤§å°ï¼Œå°†æ¬¡åŸºæœ¬å¤§å°ä¸å½“å‰å¤§å°è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå½“å‰å¤§å°å¤§äºæŒ‡å®šçš„ç™¾åˆ†æ¯”ï¼Œåˆ™è§¦å‘é‡å†™ã€‚</p>
<p>æŒ‡å®šé›¶ç™¾åˆ†æ¯”å¯ä»¥ç¦ç”¨é‡å†™åŠŸèƒ½ã€‚</p>
<pre><code class="shell">auto-aof-rewrite-percentage 100 
auto-aof-rewrite-min-size 64mb # è§¦å‘é‡å†™çš„AOFæ–‡ä»¶çš„æœ€å°å¤§å°</code></pre>
<blockquote>
<p>ğŸ’¢äº§ç”Ÿé—®é¢˜</p>
</blockquote>
<p>æ¯æ¬¡é‡å¯Redisçš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆä½¿ç”¨AOFæ–‡ä»¶è¿˜åŸæ•°æ®ã€‚</p>
<p>å¦‚æœAOFæ–‡ä»¶ä»¥å¤–äº§ç”Ÿé”™ä½ï¼Œæˆ–è€…äººå·¥æ„å¤–æ”¹å†™ï¼Œå¯ä»¥é€šè¿‡<code>redis-check-aof --fix appendonly.aof</code>ä¿®å¤æ–‡ä»¶</p>
<pre><code class="shell">[root@master bin]# redis-check-aof --fix appendonly.aof 
&#39;x              3f: Expected prefix &#39;*&#39;, got: &#39;
AOF analyzed: size=114, ok_up_to=63, diff=51
This will shrink the AOF from 114 bytes, with 51 bytes, to 63 bytes
Continue? [y/N]: y
Successfully truncated AOF</code></pre>
<blockquote>
<p>ğŸŒ ä¼˜ç‚¹ç¼ºç‚¹</p>
</blockquote>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>AOFä¼šè®©rediså˜å¾—éå¸¸è€ä¹…ï¼ŒAOFçš„é»˜è®¤ç­–ç•¥æ˜¯æ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼Œåœ¨è¿™ç§é…ç½®ä¸‹ï¼Œå°±ç®—RedisæœåŠ¡å™¨å®•æœºï¼Œä¹Ÿæœ€å¤šä¸¢å¤±ä¸€ç§’é’Ÿçš„æ•°æ®</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>å¯¹äºç›¸åŒçš„æ•°æ®é›†æ¥è¯´ï¼ŒAOFçš„æ–‡ä»¶ä½“ç§¯è¦å¤§äºRDBçš„æ–‡ä»¶ä½“ç§¯ï¼Œæ•°æ®æ¢å¤çš„é€Ÿåº¦æ›´æ…¢</li>
<li>æ ¹æ®æ‰€ä½¿ç”¨çš„syncç­–ç•¥ï¼ŒAOFçš„é€Ÿåº¦å¯èƒ½æ…¢äºRDB</li>
</ul>
<h2 id="12-ğŸ“©Rediså‘å¸ƒè®¢é˜…"><a href="#12-ğŸ“©Rediså‘å¸ƒè®¢é˜…" class="headerlink" title="12. ğŸ“©Rediså‘å¸ƒè®¢é˜…"></a>12. ğŸ“©Rediså‘å¸ƒè®¢é˜…</h2><h3 id="12-1-ğŸ’¬è¯´æ˜"><a href="#12-1-ğŸ’¬è¯´æ˜" class="headerlink" title="12.1 ğŸ’¬è¯´æ˜"></a>12.1 ğŸ’¬è¯´æ˜</h3><p>Redis å‘å¸ƒè®¢é˜… (pub/sub) æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ï¼šå‘é€è€…(pub) å‘é€æ–¹æ¶ˆæ¯ï¼Œè®¢é˜…è€…(sub)æ¥æ”¶æ¶ˆæ¯ã€‚</p>
<p>Rediså®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ã€‚</p>
<h3 id="12-2-ğŸ“·æ¨¡å‹"><a href="#12-2-ğŸ“·æ¨¡å‹" class="headerlink" title="12.2 ğŸ“·æ¨¡å‹"></a>12.2 ğŸ“·æ¨¡å‹</h3><blockquote>
<p>ğŸ—¼è®¢é˜…æ¨¡å‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201125132811770.png" class="" title="image-20201125132811770">

<blockquote>
<p>ğŸ—½æ¶ˆæ¯æ¨¡å‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/image-20201125132839908.png" class="" title="image-20201125132839908">



<blockquote>
<p>ğŸ“œå‘å¸ƒè®¢é˜…å‘½ä»¤</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å‘½ä»¤</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">psubscribe pattern [pattern â€¦]</td>
<td align="center">è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªç¬¦åˆç»™å®šæ¨¡å¼çš„é¢‘é“</td>
</tr>
<tr>
<td align="center">pubsub subcommand [argument [argument â€¦]]</td>
<td align="center">æŸ¥çœ‹è®¢é˜…ä¸å‘å¸ƒç³»ç»ŸçŠ¶æ€</td>
</tr>
<tr>
<td align="center">publish channel message</td>
<td align="center">å°†æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šçš„é¢‘é“</td>
</tr>
<tr>
<td align="center">punsubscribe channel [channel â€¦]</td>
<td align="center">é€€è®¢æ‰€æœ‰ç»™å®šæ¨¡å¼çš„é¢‘é“</td>
</tr>
<tr>
<td align="center">subscribe channel [channel â€¦]</td>
<td align="center">è®¢é˜…ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“çš„ä¿¡æ¯</td>
</tr>
<tr>
<td align="center">unsubscribe [channel [channel â€¦]]</td>
<td align="center">é€€è®¢ç»™å®šçš„é¢‘é“</td>
</tr>
</tbody></table>
<blockquote>
<p>ğŸæ¼”ç¤º</p>
</blockquote>
<p>å¼€å¯ä¸‰ä¸ªredis-cli</p>
<pre><code class="shell"># ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œè®¢é˜…é¢‘é“ï¼šKhighness
127.0.0.1:6379&gt; subscribe Khighness
Reading messages... (press Ctrl-C to quit)
1) &quot;subscribe&quot;
2) &quot;Khighness&quot;
3) (integer) 1
1) &quot;message&quot;
2) &quot;Khighness&quot;

# ç¬¬äºŒä¸ªå®¢æˆ·ç«¯ï¼Œåœ¨é¢‘é“Khighnesså‘å¸ƒæ¶ˆæ¯
127.0.0.1:6379&gt; publish Khighness &quot;Client1: Hello, Khighness&quot;
(integer) 1

# ç¬¬ä¸‰ä¸ªå®¢æˆ·ç«¯ï¼Œåœ¨é¢‘é“Khighnesså‘å¸ƒæ¶ˆæ¯
127.0.0.1:6379&gt; publish Khighness &quot;Client3: Hello, Khighness&quot;
(integer) 1

# è®¢é˜…é¢‘é“çš„ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å°±èƒ½æ”¶åˆ°æ¶ˆæ¯
1) &quot;message&quot;
2) &quot;Khighness&quot;
3) &quot;Client2: Hello, Khighness&quot;
1) &quot;message&quot;
2) &quot;Khighness&quot;
3) &quot;Client3: Hello, Khighness&quot;</code></pre>
<blockquote>
<p>ğŸ•µï¸åŸç†</p>
</blockquote>
<p>Redisæ˜¯Cè¯­è¨€ç¼–å†™çš„ï¼Œé€šè¿‡åˆ†æRedisæºä»£ç é‡Œé¢çš„pubsub.cæ–‡ä»¶ï¼Œäº†è§£å‘å¸ƒå’Œè®¢é˜…æœºåˆ¶çš„åº•å±‚å®ç°ã€‚</p>
<p>é€šè¿‡subscribeå‘½ä»¤è®¢é˜…æŸé¢‘é“åï¼Œredis-serveré‡Œç»´æŠ¤äº†ä¸€ä¸ªå­—å…¸ï¼Œå­—å…¸çš„é”®å°±æ˜¯ä¸€ä¸ªä¸ªé¢‘é“channelï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜äº†æ‰€æœ‰è®¢é˜…è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯clientã€‚subscribeå‘½ä»¤çš„å…³é”®ï¼Œå°±æ˜¯å°†clientæ·»åŠ åˆ°ç»™å®šchannelçš„è®¢é˜…é“¾ä¸­ã€‚</p>
<p>é€šè¿‡publishå‘½ä»¤å‘è®¢é˜…è€…å‘é€æ¶ˆæ¯ï¼Œredis-serverä¼šä½¿ç”¨ç»™å®šçš„é¢‘é“ä½œä¸ºé”®ï¼Œåœ¨å®ƒæ‰€ç»´æŠ¤çš„channelå­—å…¸æŸ¥æ‰¾è®°å½•äº†è®¢é˜…è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰å®¢æˆ·ç«¯çš„é“¾è¡¨ï¼Œéå†è¿™ä¸ªé“¾è¡¨ï¼Œå°†æ¶ˆæ¯å‘å¸ƒç»™æ‰€æœ‰è®¢é˜…è€…ã€‚</p>
<p>åœ¨Redisä¸­ï¼Œå¯ä»¥è®¾å®šå¯¹æŸä¸€ä¸ªkeyå€¼è¿›è¡Œæ¶ˆæ¯å‘å¸ƒåŠæ¶ˆæ¯è®¢é˜…ï¼Œå½“ä¸€ä¸ªkeyå€¼ä¸Šè¿›è¡Œäº†æ¶ˆæ¯å‘å¸ƒåï¼Œæ‰€æœ‰è®¢é˜…å®ƒçš„å®¢æˆ·ç«¯éƒ½ä¼šæ”¶åˆ°å“åº”çš„æ¶ˆæ¯ã€‚è¿™ä¸€åŠŸèƒ½æœ€æ˜æ˜¾çš„ç”¨æ³•å°±æ˜¯ç”¨ä½œå®æ—¶æ¶ˆæ¯ç³»ç»Ÿï¼Œæ™®é€šçš„å³æ—¶èŠå¤©å’Œç¾¤èŠåŠŸèƒ½ã€‚</p>
<h2 id="13-ğŸ“©Redisä¸»ä»å¤åˆ¶"><a href="#13-ğŸ“©Redisä¸»ä»å¤åˆ¶" class="headerlink" title="13. ğŸ“©Redisä¸»ä»å¤åˆ¶"></a>13. ğŸ“©Redisä¸»ä»å¤åˆ¶</h2><h3 id="13-1-ğŸ“–æ¦‚å¿µ"><a href="#13-1-ğŸ“–æ¦‚å¿µ" class="headerlink" title="13.1 ğŸ“–æ¦‚å¿µ"></a>13.1 ğŸ“–æ¦‚å¿µ</h3><p>ä¸»ä»å¤åˆ¶ï¼Œæ˜¯æŒ‡å°†ä¸€å°RedisæœåŠ¡å™¨çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°å…¶ä»–çš„RedisæœåŠ¡å™¨ã€‚å‰è€…ç§°ä¸ºä¸»ç»“ç‚¹(master)ï¼Œåè€…ç§°ä¸ºä»ç»“ç‚¹(slave)ï¼›æ•°æ®çš„å¤åˆ¶æ˜¯å•å‘çš„ï¼Œåªèƒ½ç”±ä¸»èŠ‚ç‚¹åˆ°ä»ç»“ç‚¹ã€‚masterä»¥å†™ä¸ºä¸»ï¼Œsalveä»¥è¯»ä¸ºä¸»ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯å°RedisæœåŠ¡å™¨éƒ½æ˜¯ä¸»ç»“ç‚¹ï¼›ä¸”ä¸€ä¸ªä¸»ç»“ç‚¹å¯ä»¥æœ‰å¤šä¸ªä»ç»“ç‚¹(æˆ–æ²¡æœ‰ä»ç»“ç‚¹)ï¼Œä½†ä¸€ä¸ªä»ç»“ç‚¹åªèƒ½æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ã€‚</p>
<h3 id="13-2-ğŸ”§ä½œç”¨"><a href="#13-2-ğŸ”§ä½œç”¨" class="headerlink" title="13.2 ğŸ”§ä½œç”¨"></a>13.2 ğŸ”§ä½œç”¨</h3><ol>
<li>æ•°æ®å†—ä½™ï¼šä¸»ä»å¤åˆ¶å®ç°äº†æ•°æ®çš„çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼</li>
<li>æ•…éšœæ¢å¤ï¼šå½“ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç”±ä»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤ï¼Œå®é™…ä¸Šæ˜¯ä¸€ç§æœåŠ¡çš„å†—ä½™</li>
<li>è´Ÿè½½å‡è¡¡ï¼šåœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ç”±ä¸»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼Œåˆ†æ‹…æœåŠ¡å™¨è´Ÿè½½ï¼›å°¤å…¶æ˜¯åœ¨å†™å°‘è¯»å¤šçš„åœºæ™¯ä¸‹ï¼Œé€šè¿‡å¤šä¸ªä»ç»“ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¯ä»¥å¤§å¤§æé«˜RedisæœåŠ¡å™¨çš„å¹¶å‘é‡</li>
<li>é«˜å¯ç”¨åŸºçŸ³ï¼šä¸»ä»å¤åˆ¶æ˜¯å“¨å…µå’Œé›†ç¾¤å¯å®æ–½çš„åŸºç¡€ï¼Œå› æ­¤è¯´ä¸»ä»å¤åˆ¶æ˜¯Redisé«˜å¯ç”¨çš„åŸºç¡€</li>
</ol>
<h3 id="13-3-ğŸ”å¤åˆ¶åŸç†"><a href="#13-3-ğŸ”å¤åˆ¶åŸç†" class="headerlink" title="13.3 ğŸ”å¤åˆ¶åŸç†"></a>13.3 ğŸ”å¤åˆ¶åŸç†</h3><p>slaveå¯åŠ¨æˆåŠŸè¿æ¥åˆ°masteråä¼šå‘é€ä¸€ä¸ªsyncåŒæ­¥å‘½ä»¤ã€‚</p>
<p>masteræ¥åˆ°å‘½ä»¤ï¼Œå¯åŠ¨åå°çš„å­˜ç›˜è¿›ç¨‹ï¼ŒåŒæ—¶æ”¶é›†æ‰€æœ‰æ¥æ”¶åˆ°çš„ç”¨äºä¿®æ”¹æ•°æ®é›†å‘½ä»¤ï¼Œåœ¨åå°è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œmasterå°†ä¼ é€æ•´ä¸ªæ•°æ®æ–‡ä»¶åˆ°slaveï¼Œå¹¶å®Œæˆä¸€æ¬¡å®Œå…¨åŒæ­¥ã€‚</p>
<p><strong>å…¨é‡å¤åˆ¶</strong>ï¼šslaveæœåŠ¡åœ¨æ¥æ”¶åˆ°æ•°æ®åº“æ–‡ä»¶åï¼Œå°†å…¶å­˜ç›˜å¹¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p>
<p><strong>å¢é‡å¤åˆ¶</strong>ï¼šmasterç»§ç»­å°†æ–°çš„æ‰€æœ‰æ”¶é›†åˆ°çš„ä¿®æ”¹å‘½ä»¤ä¾æ¬¡ä¼ ç»™slaveï¼Œå®ŒæˆåŒæ­¥ã€‚</p>
<p>ä½†æ˜¯åªè¦æ˜¯é‡æ–°è¿æ¥masterï¼Œä¸€æ¬¡å®Œå…¨åŒæ­¥(å…¨é‡å¤åˆ¶)å°†è¢«è‡ªåŠ¨æ‰§è¡Œã€‚</p>
<h2 id="14-ğŸ“©Redisé›†ç¾¤æ­å»º"><a href="#14-ğŸ“©Redisé›†ç¾¤æ­å»º" class="headerlink" title="14. ğŸ“©Redisé›†ç¾¤æ­å»º"></a>14. ğŸ“©Redisé›†ç¾¤æ­å»º</h2><h3 id="14-1-ğŸ”±æ–¹æ³•"><a href="#14-1-ğŸ”±æ–¹æ³•" class="headerlink" title="14.1 ğŸ”±æ–¹æ³•"></a>14.1 ğŸ”±æ–¹æ³•</h3><p>==æ­å»ºä¸´æ—¶ä¼ªé›†ç¾¤ï¼Œå‘½ä»¤æ“ä½œå³å¯==</p>
<p>ä¸»è¦æ“ä½œï¼š<strong>æ“ä½œä»æœºï¼Œè®¤è€å¤§ã€‚</strong></p>
<p>æŸ¥çœ‹redisæœåŠ¡å™¨ä¿¡æ¯ï¼š<code>info replication</code></p>
<p>åœ¨ä»æœºä¸Šè®¤è€å¤§masterï¼š<code>slaveof &lt;master-ip&gt; &lt;master-port&gt;</code></p>
<p>==æ­å»ºæ°¸ä¹…é›†ç¾¤ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶==</p>
<p>ä¸»è¦æ“ä½œï¼šä¿®æ”¹redis-confæ–‡ä»¶</p>
<pre><code class="shell">replicaof &lt;masterip&gt; &lt;masterport&gt;  # é…ç½®masterçš„ipå’Œç«¯å£å·
masterauth &lt;master-passwordd&gt;      # å¦‚æœmasteræœ‰å¯†ç åˆ™é…ç½®å¯†ç </code></pre>
<p>==masterå…³æœºè§£å†³â€”â€”è°‹æƒç¯¡ä½==</p>
<p>é€šè¿‡<code>slaveof no one</code>è®©slaveè‡ªå·±å˜æˆmaster</p>
<h3 id="14-2-ğŸ”ªæ“ä½œ"><a href="#14-2-ğŸ”ªæ“ä½œ" class="headerlink" title="14.2 ğŸ”ªæ“ä½œ"></a>14.2 ğŸ”ªæ“ä½œ</h3><ol>
<li>å¤åˆ¶ä¸‰ä»½redis.confæ–‡ä»¶ï¼Œä¿®æ”¹ä¿¡æ¯<ul>
<li>port</li>
<li>logfile</li>
<li>pidfile</li>
<li>dbfilename</li>
</ul>
</li>
<li>åˆ†åˆ«åœ¨ä¸‰ä¸ªé…ç½®æ–‡ä»¶ä¸‹å¯åŠ¨redisæœåŠ¡</li>
</ol>
<pre><code class="shell">[root@master bin]# ps -ef | grep redis
root      18914      1  0 00:54 ?        00:01:38 redis-server 127.0.0.1:6379
root      31612      1  0 11:51 ?        00:00:00 redis-server 127.0.0.1:6380
root      31623      1  0 11:51 ?        00:00:00 redis-server 127.0.0.1:6381
root      31634  31340  0 11:51 pts/2    00:00:00 grep --color=auto redis</code></pre>
<ol start="3">
<li>å¼€å¯ä¸‰ä¸ªç»ˆç«¯å¼€å¯ä¸‰ä¸ªrediså®¢æˆ·ç«¯åˆ†åˆ«è¿æ¥ä¸‰ä¸ªredisæœåŠ¡å™¨</li>
</ol>
<pre><code class="shell"># Terminal1
[parak@master bin]$ redis-cli -p 6379
# Terminal2
[parak@master bin]$ redis-cli -p 6380
# Terminal3
[parak@master bin]$ redis-cli -p 6381</code></pre>
<ol start="4">
<li>å°†6379ç«¯å£çš„æœåŠ¡çš„é…ç½®æˆmasterï¼Œå¦å¤–ä¸¤ä¸ªé…ç½®æˆslave</li>
</ol>
<pre><code class="shell"># 6380
127.0.0.1:6380&gt; slaveof 127.0.0.1 6379
OK
127.0.0.1:6380&gt; info replication
# Replication
role:slave
master_host:127.0.0.1
master_port:6379
master_link_status:up
master_last_io_seconds_ago:3
master_sync_in_progress:0
slave_repl_offset:14
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:9c3e61afce386f90c00db9ee4e9a2e7b4b265297
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:14
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:14

# 6381
127.0.0.1:6381&gt; slaveof 127.0.0.1 6379
OK
127.0.0.1:6381&gt; info replication
# Replication
role:slave
master_host:127.0.0.1
master_port:6379
master_link_status:up
master_last_io_seconds_ago:8
master_sync_in_progress:0
slave_repl_offset:42
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:9c3e61afce386f90c00db9ee4e9a2e7b4b265297
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:42
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:43
repl_backlog_histlen:0

# 6379
127.0.0.1:6379&gt; info replication
# Replication
role:master
connected_slaves:2
slave0:ip=127.0.0.1,port=6380,state=online,offset=2087,lag=0
slave1:ip=127.0.0.1,port=6381,state=online,offset=2087,lag=0
master_replid:9c3e61afce386f90c00db9ee4e9a2e7b4b265297
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:2087
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:2087</code></pre>
<ol start="5">
<li>åœ¨masterä¸Šå†™å…¥å€¼ï¼Œåœ¨slaveä¸Šè¯»å–å€¼</li>
</ol>
<pre><code class="shell"># 6379
127.0.0.1:6379&gt; hmset student:1 name Khighness gender male age 19
OK
127.0.0.1:6379&gt; hmset student:2 name bingyao gender female age 16
OK
# 6380
127.0.0.1:6380&gt; hmget student:1 name gender age
1) &quot;Khighness&quot;
2) &quot;male&quot;
3) &quot;19&quot;
# 6381
127.0.0.1:6381&gt; hmget student:2 name gender age
1) &quot;bingyao&quot;
2) &quot;female&quot;
3) &quot;16&quot;

# slaveåªèƒ½è¯»å–ï¼Œä¸èƒ½å†™å…¥
127.0.0.1:6380&gt; set K2 V2
(error) READONLY You can&#39;t write against a read only replica</code></pre>
<h2 id="15-ğŸ“©Rediså“¨å…µæ¨¡å¼"><a href="#15-ğŸ“©Rediså“¨å…µæ¨¡å¼" class="headerlink" title="15. ğŸ“©Rediså“¨å…µæ¨¡å¼"></a>15. ğŸ“©Rediså“¨å…µæ¨¡å¼</h2><p><del>é©¾æ ¡æ‰‹åŠ¨æŒ¡=&gt;ä¸Šè·¯è‡ªåŠ¨æŒ¡</del></p>
<h3 id="15-1-ğŸ“™æ¦‚è¿°"><a href="#15-1-ğŸ“™æ¦‚è¿°" class="headerlink" title="15.1 ğŸ“™æ¦‚è¿°"></a>15.1 ğŸ“™æ¦‚è¿°</h3><p>ä¸»ä»åˆ‡æ¢æŠ€æœ¯çš„æ–¹æ³•ï¼šå½“ä¸»æœåŠ¡å™¨å®•æœºåï¼Œéœ€è¦æ‰‹åŠ¨æŠŠä¸€å°ä»æœåŠ¡å™¨åˆ‡æ¢ä¸ºä¸»æœåŠ¡å™¨ï¼Œè¿™å°±éœ€è¦äººå·¥å¹²é¢„ï¼Œè´¹äº‹è´¹åŠ›ï¼Œè¿˜ä¼šé€ æˆä¸€æ®µæ—¶é—´å†…æœåŠ¡ä¸å¯ç”¨ã€‚è¿™ä¸æ˜¯ä¸€ç§æ¨èçš„æ–¹å¼ï¼Œæ›´å¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¼˜å…ˆè€ƒè™‘å“¨å…µæ¨¡å¼ã€‚Redisä»2.8å¼€å§‹æ­£å¼æä¾›äº†Sentinel(å“¨å…µ)æ¶æ„æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œå“¨å…µæ¨¡å¼å°±æ˜¯è°‹æƒç¯¡ä½çš„è‡ªåŠ¨ç‰ˆï¼Œèƒ½å¤Ÿåå°ç›‘æ§ä¸»æœºæ˜¯å¦æ•…éšœï¼Œå¦‚æœå‘ç”Ÿæ•…éšœåˆ™æ ¹æ®æŠ•ç¥¨æ•°è‡ªåŠ¨å°†åº“è½¬æ¢ä¸ºä¸»åº“ã€‚</p>
<p>å“¨å…µæ¨¡å¼æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ¨¡å¼ï¼Œé¦–å…ˆRedisæä¾›äº†å“¨å…µçš„å‘½ä»¤ï¼Œå“¨å…µæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä½œä¸ºè¿›ç¨‹ï¼Œå®ƒä¼šç‹¬ç«‹è¿è¡Œã€‚</p>
<p>åŸç†ï¼šå“¨å…µé€šè¿‡å‘é€å‘½ä»¤ï¼Œç­‰å¾…RedisæœåŠ¡å™¨å“åº”ï¼Œä»è€Œç›‘æ§è¿è¡Œçš„å¤šä¸ªRediså®ä¾‹ã€‚</p>
<div class="mermaid">
graph TD;
	A((å“¨å…µ))
	B(ä¸»RedisæœåŠ¡å™¨)
	C(ä»RedisæœåŠ¡å™¨1)
	D(ä»RedisæœåŠ¡å™¨2)
	S[ä»¥ç‹¬ç«‹çš„è¿›ç¨‹ç›‘æ§3å°æœåŠ¡å™¨Redisæ˜¯å¦æ­£å¸¸è¿è¡Œ] 
	S --&gt; A
	A --&gt; C
	A --&gt; B
	A --&gt; D
	B --&gt; C
	B --&gt; D</div>




<p>è¿™é‡Œçš„å“¨å…µæœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ul>
<li>é€šè¿‡å‘é€å‘½ä»¤ï¼Œè®©RedisæœåŠ¡å™¨è¿”å›ç›‘æ§å…¶è¿è¡ŒçŠ¶æ€ï¼ŒåŒ…æ‹¬ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨</li>
<li>å½“å“¨å…µç›‘æµ‹åˆ°masterå®•æœºï¼Œä¼šè‡ªåŠ¨å°†slaveåˆ‡æ¢ä¸ºmasterï¼Œç„¶åé€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼é€šçŸ¥å…¶ä»–çš„ä»æœåŠ¡å™¨ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè®©å®ƒä»¬åˆ‡æ¢ä¸»æœº</li>
</ul>
<p>ä¸€ä¸ªå“¨å…µè¿›ç¨‹å¯¹RedisæœåŠ¡å™¨è¿›è¡Œç›‘æ§ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªå“¨å…µè¿›è¡Œç›‘æ§ï¼Œå„ä¸ªå“¨å…µä¹‹é—´è¿˜ä¼šè¿›è¡Œç›‘æ§ï¼Œè¿™æ ·å°±å½¢æˆäº†å¤šå“¨å…µæ¨¡å¼ã€‚</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/bae4ff13/sentinel.jpg" class="" title="sentinel">



<p>å‡è®¾ä¸»æœåŠ¡å™¨å®•æœºï¼Œå“¨å…µ1å…ˆæ£€æµ‹åˆ°è¿™ä¸ªç»“æœï¼Œç³»ç»Ÿå¹¶ä¸ä¼šé©¬ä¸Šè¿›è¡Œfailoverè¿‡ç¨‹ï¼Œä»…ä»…æ˜¯å“¨å…µ1ä¸»ç®¡çš„è®¤ä¸ºä¸»æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œä»…ä»…æ˜¯å“¨å…µ1ä¸»è§‚çš„è®¤ä¸ºä¸»æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œè¿™ä¸ªç°è±¡ç§°ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œå½“åé¢çš„å“¨å…µä¹Ÿæ£€æµ‹åˆ°ä¸»æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œå¹¶ä¸”æ•°é‡è¾¾åˆ°ä¸€å®šå€¼æ—¶ï¼Œé‚£ä¹ˆå“¨å…µä¹‹é—´å°±ä¼šè¿›è¡Œä¸€æ¬¡æŠ•ç¥¨ï¼ŒæŠ•ç¥¨çš„ç»“æœç”±ä¸€ä¸ªå“¨å…µå‘èµ·ï¼Œè¿›è¡Œfailover[æ•…éšœè½¬ç§»]æ“ä½œã€‚åˆ‡æ¢æˆåŠŸåï¼Œå°±ä¼šé€šè¿‡å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œè®©å„ä¸ªå“¨å…µæŠŠè‡ªå·±ç›‘æ§çš„ä»æœåŠ¡å™¨å®ç°åˆ‡æ¢ä¸»æœºï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå®¢è§‚ä¸‹çº¿ã€‚</p>
<h3 id="15-2-ğŸæµ‹è¯•"><a href="#15-2-ğŸæµ‹è¯•" class="headerlink" title="15.2 ğŸæµ‹è¯•"></a>15.2 ğŸæµ‹è¯•</h3><p>å‡†å¤‡ä¸‰ä¸ªredisæœåŠ¡ï¼Œ6379-masterã€6380-slaveã€6381-slave</p>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶sentinel.conf</p>
<pre><code class="shell">sentinel monitor mymaster 127.0.0.1 6379 1</code></pre>
<p>å¯åŠ¨å“¨å…µ</p>
<pre><code class="shell">34055:X 20 Oct 2020 14:39:15.404 * Increased maximum number of open files to 10032 (it was originally set to 1024).
                _._                                                  
           _.-``__ &#39;&#39;-._                                             
      _.-``    `.  `_.  &#39;&#39;-._           Redis 5.0.8 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ &#39;&#39;-._                                   
 (    &#39;      ,       .-`  | `,    )     Running in sentinel mode
 |`-._`-...-` __...-.``-._|&#39;` _.-&#39;|     Port: 26379
 |    `-._   `._    /     _.-&#39;    |     PID: 34055
  `-._    `-._  `-./  _.-&#39;    _.-&#39;                                   
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|                                  
 |    `-._`-._        _.-&#39;_.-&#39;    |           http://redis.io        
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;                                   
 |`-._`-._    `-.__.-&#39;    _.-&#39;_.-&#39;|                                  
 |    `-._`-._        _.-&#39;_.-&#39;    |                                  
  `-._    `-._`-.__.-&#39;_.-&#39;    _.-&#39;                                   
      `-._    `-.__.-&#39;    _.-&#39;                                       
          `-._        _.-&#39;                                           
              `-.__.-&#39;                                               

34055:X 20 Oct 2020 14:39:15.407 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
34055:X 20 Oct 2020 14:39:15.408 # Sentinel ID is dbfb304470e8ed2bb81b4be42f847e21ff5d9519
34055:X 20 Oct 2020 14:39:15.408 # +monitor master mymaster 127.0.0.1 6379 quorum 1
34055:X 20 Oct 2020 14:40:15.646 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:40:25.731 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</code></pre>
<p>å…³é—­masteræœåŠ¡</p>
<pre><code class="shell"># 6379: master -&gt; shutdown
127.0.0.1:6379&gt; SHUTDOWN
not connected&gt; exit

# sentinel
# ç›‘æ§åˆ°masterå®•æœº
# é€‰å‡º6380ä¸ºmaster
34055:X 20 Oct 2020 14:43:47.509 # +sdown master mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:47.509 # +odown master mymaster 127.0.0.1 6379 #quorum 1/1
34055:X 20 Oct 2020 14:43:47.509 # +new-epoch 1
34055:X 20 Oct 2020 14:43:47.509 # +try-failover master mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:47.510 # +vote-for-leader dbfb304470e8ed2bb81b4be42f847e21ff5d9519 1
34055:X 20 Oct 2020 14:43:47.510 # +elected-leader master mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:47.510 # +failover-state-select-slave master mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:47.594 # +selected-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:47.594 * +failover-state-send-slaveof-noone slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:47.678 * +failover-state-wait-promotion slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:48.296 # +promoted-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:48.296 # +failover-state-reconf-slaves master mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:48.371 * +slave-reconf-sent slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:49.310 * +slave-reconf-inprog slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:49.310 * +slave-reconf-done slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:49.362 # +failover-end master mymaster 127.0.0.1 6379
34055:X 20 Oct 2020 14:43:49.362 # +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6380
34055:X 20 Oct 2020 14:43:49.362 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6380
34055:X 20 Oct 2020 14:43:49.362 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
34055:X 20 Oct 2020 14:44:19.365 # +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380

# 6380: æ–°ç‹ç™»åŸº
127.0.0.1:6380&gt; info replication
# Replication
role:master
connected_slaves:1
slave0:ip=127.0.0.1,port=6381,state=online,offset=42337,lag=1
master_replid:12a540accf0c9347d3e45fad83ccddea86f3b3c3
master_replid2:b80e4fbbe06a83ac070f38e89267bd81b26ec5ca
master_repl_offset:42351
second_repl_offset:20188
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:8342
repl_backlog_histlen:34010

# 6381: å‚æ‹œæ–°ç‹
127.0.0.1:6381&gt; info replication
# Replication
role:slave
master_host:127.0.0.1
master_port:6380
master_link_status:up
master_last_io_seconds_ago:0
master_sync_in_progress:0
slave_repl_offset:63969
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:12a540accf0c9347d3e45fad83ccddea86f3b3c3
master_replid2:b80e4fbbe06a83ac070f38e89267bd81b26ec5ca
master_repl_offset:63969
second_repl_offset:20188
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:8053
repl_backlog_histlen:55917

# é‡å¯6379çš„æœåŠ¡
# é‡å¯ä¹‹åä¿¯é¦–ç§°è‡£
[root@master bin]# redis-server kconfig/redis6379.conf 
[root@master bin]# redis-cli -p 6379
127.0.0.1:6379&gt; ping
PONG
127.0.0.1:6379&gt; info relplication
127.0.0.1:6379&gt; info replication
# Replication
role:slave
master_host:127.0.0.1
master_port:6380
master_link_status:up
master_last_io_seconds_ago:2
master_sync_in_progress:0
slave_repl_offset:50522
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:12a540accf0c9347d3e45fad83ccddea86f3b3c3
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:50522
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:48596
repl_backlog_histlen:1927</code></pre>
<h3 id="15-3-ğŸŒ ä¼˜ç‚¹"><a href="#15-3-ğŸŒ ä¼˜ç‚¹" class="headerlink" title="15.3 ğŸŒ ä¼˜ç‚¹"></a>15.3 ğŸŒ ä¼˜ç‚¹</h3><ul>
<li>å“¨å…µé›†ç¾¤ï¼ŒåŸºäºä¸»ä»å¤åˆ¶æ¨¡å¼ï¼Œç»§æ‰¿äº†ä¸»ä»çš„æ‰€æœ‰ä¼˜ç‚¹</li>
<li>ä¸»ä»å¯ä»¥åˆ‡æ¢ï¼Œæ•…éšœå¯ä»¥è½¬ç§»ï¼Œå¢å¼ºç³»ç»Ÿçš„å¯ç”¨æ€§</li>
<li>å“¨å…µæ¨¡å¼æ˜¯ä¸»ä»æ¨¡å¼çš„å‡çº§ç‰ˆï¼Œæ‰‹åŠ¨åˆ°è‡ªåŠ¨ï¼Œæ›´åŠ å¥å£®</li>
</ul>
<h3 id="15-4-ğŸ“°é…ç½®è¯¦è§£"><a href="#15-4-ğŸ“°é…ç½®è¯¦è§£" class="headerlink" title="15.4 ğŸ“°é…ç½®è¯¦è§£"></a>15.4 ğŸ“°é…ç½®è¯¦è§£</h3><pre><code class="shell"># sentinel.conf

# å“¨å…µsentinelå®ä¾‹è¿è¡Œçš„ç«¯å£ï¼Œé»˜è®¤26379
port 26379

# å®ˆæŠ¤è¿›ç¨‹ 
daemonize no

# è¿›ç¨‹æ–‡ä»¶
pidfile &quot;/var/run/redis-sentinel.pid&quot;

# è¿›ç¨‹æ–‡ä»¶
logfile &quot;&quot;

# å·¥ä½œç›®å½•
dir &quot;/tmp&quot;

# å“¨å…µsentinelç›‘æ§çš„masterçš„IPå’ŒPort
# quorumé…ç½®å¤šå°‘ä¸ªå“¨å…µç»Ÿä¸€è®¤ä¸ºmasterå¤±è”ã€‚é‚£ä¹ˆè¿™æ—¶å®¢è§‚ä¸Šè®¤ä¸ºä¸»ç»“ç‚¹å¤±è”
sentinel monitor &lt;master-name&gt; &lt;master-ip&gt; &lt;redis-ip&gt; &lt;quorum&gt;

# åœ¨rediså®ä¾‹ä¸­å¼€å¯äº†æˆæƒå¯†ç 
# è®¾ç½®å“¨å…µsentiçš„è¿æ¥å¯†ç 
sentinel auth-pass &lt;master-name&gt; &lt;password&gt;

# é…ç½®æŒ‡å®šåœ¨å‘ç”Ÿfailoverä¸»ä»åˆ‡æ¢æ—¶æœ€å¤šå¯ä»¥æœ‰å¤šå°‘ä¸ªslaveåŒæ—¶å¯¹æ–°çš„masteråŒæ­¥
# numreplicasè¶Šå°ï¼Œå®Œæˆfailoverçš„äº‹ä»¶å°±è¶Šé•¿
# numreplicasè¶Šå¤§ï¼Œå°±æ„å‘³ç€è¶Šå¤šçš„slaveå› ä¸ºreplication(å¤åˆ¶)è€Œä¸å¯ç”¨
# numreplicasè®¾ç½®ä¸º1ï¼Œä¿è¯æ¯æ¬¡åªæœ‰slaveå¤„äºä¸èƒ½å¤„ç†å‘½ä»¤è¯·æ±‚çš„çŠ¶æ€
sentinel parallel-syncs &lt;master-name&gt; &lt;numreplicas&gt;

# é…ç½®æŒ‡å®šå¤šmillisecondsæ¯«ç§’ä¹‹åï¼Œmasteræ²¡æœ‰å“åº”sentinel
# æ­¤æ—¶ï¼Œå“¨å…µä¸»è§‚ä¸Šè®¤ä¸ºmasterä¸‹çº¿ï¼Œé»˜è®¤30ç§’
sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;

# é…ç½®æ•…éšœè½¬ç§»çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤2åˆ†é’Ÿ
# å¯ä»¥ç”¨äºä»¥ä¸‹æ–¹é¢
# 1. åŒä¸€sentinelå¯¹åŒä¸€ä¸ªmasterä¸¤æ¬¡failo verçš„é—´éš”æ—¶é—´
# 2. å½“ä¸€ä¸ªslaveä»ä¸€ä¸ªé”™è¯¯çš„masteré‚£é‡ŒåŒæ­¥æ•°æ®å¼€å§‹è®¡ç®—æ—¶é—´ï¼Œç›´è‡³slaveè¢«çº æ­£ä¸ºå‘æ­£ç¡®çš„masteré‚£é‡ŒåŒæ­¥æ•°æ®
# 3. å½“æƒ³è¦å–æ¶ˆä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„failoveréœ€è¦çš„æ—¶é—´
# 4. å½“è¿›è¡Œfailoveræ—¶ï¼Œé…ç½®æ‰€æœ‰slavesæŒ‡å‘æ–°çš„masteræ‰€éœ€çš„æœ€å¤§æ—¶é—´
sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;

# é€šçŸ¥è„šæœ¬
sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;

# å®¢æˆ·ç«¯é‡æ–°é…ç½®ä¸»èŠ‚ç‚¹å‚æ•°è„šæœ¬
sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</code></pre>
<h2 id="16-ğŸ“©Redisç©¿é€ã€å‡»ç©¿å’Œé›ªå´©"><a href="#16-ğŸ“©Redisç©¿é€ã€å‡»ç©¿å’Œé›ªå´©" class="headerlink" title="16. ğŸ“©Redisç©¿é€ã€å‡»ç©¿å’Œé›ªå´©"></a>16. ğŸ“©Redisç©¿é€ã€å‡»ç©¿å’Œé›ªå´©</h2><h3 id="16-1-ğŸ”¥ç¼“å­˜ç©¿é€"><a href="#16-1-ğŸ”¥ç¼“å­˜ç©¿é€" class="headerlink" title="16.1 ğŸ”¥ç¼“å­˜ç©¿é€"></a>16.1 ğŸ”¥ç¼“å­˜ç©¿é€</h3><blockquote>
<p>ğŸ’­é—®é¢˜è¯´æ˜</p>
</blockquote>
<p>æŸ¥è¯¢çš„keyå¯¹åº”çš„æ•°æ®ä¸åœ¨redisç¼“å­˜ä¸­ï¼Œå³ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œäºæ˜¯å‘æŒä¹…å±‚æ•°æ®åº“æŸ¥è¯¢ï¼Œæ•°æ®åº“ä¹Ÿæ²¡æœ‰ï¼Œå½“è¯·æ±‚é‡è¿‡å¤§çš„æ—¶å€™ï¼Œå¯èƒ½å‹å®æ•°æ®åº“ã€‚</p>
<p>å³å¤§é¢ç§¯çš„ç¼“å­˜å¤±æ•ˆï¼Œå¤§å¹¶å‘è¯·æ±‚æ‰“å´©DBã€‚</p>
<blockquote>
<p>ğŸ’–è§£å†³æ–¹æ³•</p>
</blockquote>
<p>1ï¸âƒ£<strong>å‚æ•°æ ¡éªŒ</strong></p>
<p>åœ¨æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œä¸åˆæ³•çš„å‚æ•°ç›´æ¥returnï¼Œæ¯”å¦‚id&lt;0ç›´æ¥æ‹¦æˆªã€‚</p>
<p>2ï¸âƒ£<strong>å¸ƒéš†è¿‡æ»¤å™¨</strong></p>
<p>åˆ©ç”¨é«˜æ•ˆçš„æ•°æ®ç»“æ„å’Œç®—æ³•å¿«é€Ÿåˆ¤æ–­å‡ºä½ è¿™ä¸ªKeyæ˜¯å¦åœ¨æ•°æ®åº“ä¸­å­˜åœ¨ï¼Œä¸å­˜åœ¨ä½ returnå°±å¥½äº†ï¼Œå­˜åœ¨ä½ å°±å»æŸ¥DBåˆ·æ–°KVå†returnã€‚</p>
<p>3ï¸âƒ£<strong>ç¼“å­˜ç©ºå¯¹è±¡</strong></p>
<p>å½“å­˜å‚¨å±‚ä¸å‘½ä¸­åï¼Œå³ä½¿è¿”å›çš„ç©ºå¯¹è±¡ä¹Ÿå°†å…¶ç¼“å­˜èµ·æ¥ï¼ŒåŒæ—¶ä¼šè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œä¹‹åå†è®¿é—®è¿™ä¸ªæ•°æ®å°†ä¼šä»ç¼“å­˜ä¸­è·å–ï¼Œä¿æŠ¤æ•°æ®åº“ã€‚</p>
<h3 id="16-2-ğŸ’§ç¼“å­˜å‡»ç©¿"><a href="#16-2-ğŸ’§ç¼“å­˜å‡»ç©¿" class="headerlink" title="16.2 ğŸ’§ç¼“å­˜å‡»ç©¿"></a>16.2 ğŸ’§ç¼“å­˜å‡»ç©¿</h3><blockquote>
<p>ğŸ’­é—®é¢˜è¯´æ˜</p>
</blockquote>
<p>æŸ¥è¯¢çš„ä¸€ä¸ªkeyéå¸¸çƒ­ç‚¹ï¼Œåœ¨ä¸åœåœ°æ‰›ç€å¤§é‡çš„è¯·æ±‚ï¼Œå¤§å¹¶å‘é›†ä¸­å¯¹è¿™ä¸€ä¸ªç‚¹è¿›è¡Œè®¿é—®ï¼Œå½“è¿™ä¸ªkeyåœ¨å¤±æ•ˆçš„ç¬é—´ï¼ŒæŒç»­çš„å¤§å¹¶å‘ç›´æ¥è½åˆ°äº†æ•°æ®åº“ä¸Šï¼Œå°±åœ¨è¿™ä¸ªKeyçš„ç‚¹ä¸Šå‡»ç©¿äº†ç¼“å­˜ã€‚</p>
<p>å³å•ä¸ªkeyçš„ç¼“å­˜å¤±æ•ˆï¼Œå¤§å¹¶å‘è¯·æ±‚å‡»ç©¿redisç›´è½DBã€‚</p>
<blockquote>
<p>ğŸ’™è§£å†³æ–¹æ³•</p>
</blockquote>
<p>è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸï¼Œæˆ–è€…åŠ ä¸Šäº’æ–¥é”ã€‚</p>
<pre><code class="java">public static String getData(String key) throws InterruptedException &#123;
        //ä»RedisæŸ¥è¯¢æ•°æ®
        String result = getDataByKV(key);
        //å‚æ•°æ ¡éªŒ
        if (StringUtils.isBlank(result)) &#123;
            try &#123;
                //è·å¾—é”
                if (reenLock.tryLock()) &#123;
                    //å»æ•°æ®åº“æŸ¥è¯¢
                    result = getDataByDB(key);
                    //æ ¡éªŒ
                    if (StringUtils.isNotBlank(result)) &#123;
                        //æ’è¿›ç¼“å­˜
                        setDataToKV(key, result);
                    &#125;
                &#125; else &#123;
                    //ç¡ä¸€ä¼šå†æ‹¿
                    Thread.sleep(100L);
                    result = getData(key);
                &#125;
            &#125; finally &#123;
                //é‡Šæ”¾é”
                reenLock.unlock();
            &#125;
        &#125;
        return result;
    &#125;</code></pre>
<h3 id="16-3-ğŸŒŠç¼“å­˜é›ªå´©"><a href="#16-3-ğŸŒŠç¼“å­˜é›ªå´©" class="headerlink" title="16.3 ğŸŒŠç¼“å­˜é›ªå´©"></a>16.3 ğŸŒŠç¼“å­˜é›ªå´©</h3><blockquote>
<p>ğŸ’­é—®é¢˜è¯´æ˜</p>
</blockquote>
<p>å½“redisæœåŠ¡å™¨é‡å¯æˆ–åˆ™å¤§é‡ç¼“å­˜é›†ä¸­åœ¨æŸä¸€ä¸ªæ—¶é—´æ®µå¤±æ•ˆï¼Œç¬é—´Redisè·Ÿæ²¡æœ‰ä¸€æ ·ï¼Œé‚£è¿™ä¸ªæ•°é‡çº§åˆ«çš„è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“å‡ ä¹æ˜¯ç¾éš¾æ€§çš„</p>
<blockquote>
<p>ğŸ’šè§£å†³æ–¹æ³•</p>
</blockquote>
<p>1ï¸âƒ£<strong>redisé«˜å¯ç”¨</strong></p>
<p>æ­å»ºé›†ç¾¤ï¼Œå¼‚åœ°å¤šæ´»</p>
<p>2ï¸âƒ£<strong>é™æµé™çº§</strong></p>
<p>åœ¨ç¼“å­˜å¤±æ•ˆåï¼Œé€šè¿‡åŠ é”æˆ–è€…é˜Ÿåˆ—å“æ§åˆ¶è¯»æ•°æ®åº“å†™ç¼“å­˜çš„çº¿ç¨‹æ•°é‡</p>
<p>3ï¸âƒ£<strong>æ•°æ®é¢„çƒ­</strong></p>
<p>åœ¨æ­£å¼éƒ¨ç½²ä¹‹å‰ï¼Œå…ˆæŠŠå¯èƒ½çš„æ•°æ®é¢„å…ˆè®¿é—®ä¸€éï¼Œè®©å¯èƒ½çš„æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚</p>
<p>åœ¨å³å°†å‘ç”Ÿå¤§å¹¶å‘è®¿é—®å†™å…¥keyçš„æ—¶å€™ï¼Œè®¾ç½®ä¸åŒçš„ç¼“å­˜æ—¶é—´ï¼Œè®©ç¼“å­˜å¤±æ•ˆçš„æ—¶é—´ç‚¹å°½é‡å‡åŒ€ã€‚</p>
]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
      </categories>
      <tags>
        <tag>ç¼“å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title>Regex</title>
    <url>/posts/83c5d7ce/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-ç®€ä»‹"><a href="#1-ç®€ä»‹" class="headerlink" title="1. ç®€ä»‹"></a>1. ç®€ä»‹</h2><p>æ­£åˆ™è¡¨è¾¾å¼ï¼ŒRegular Expressionï¼Œä¸€ç§å­—ç¬¦ä¸²åŒ¹é…çš„æ¨¡å¼ã€‚</p>
<p>ç”¨é€”ï¼šæ–‡æœ¬çš„å¤æ‚å¤„ç†ï¼Œå¤§éƒ¨åˆ†ç¼–ç¨‹è¯­è¨€ã€æ•°æ®åº“ã€æ–‡æœ¬ç¼–è¾‘å™¨ã€å¼€å‘ç¯å¢ƒéƒ½æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ã€‚</p>
<blockquote>
<p>å¼€å‘ä¸­ä½¿ç”¨</p>
</blockquote>
<ul>
<li>åˆ†ææ‰€è¦åŒ¹é…çš„æ•°æ®ï¼Œå†™å‡ºæµ‹è¯•ç”¨çš„å…¸å‹æ•°æ®</li>
<li>åœ¨å·¥å…·è½¯ä»¶ä¸­è¿›è¡ŒåŒ¹é…æµ‹è¯•</li>
<li>åœ¨ç¨‹åºä¸­è°ƒç”¨æµ‹è¯•çš„æ­£åˆ™è¡¨è¾¾å¼</li>
</ul>
<h2 id="2-è¯­æ³•"><a href="#2-è¯­æ³•" class="headerlink" title="2. è¯­æ³•"></a>2. è¯­æ³•</h2><h3 id="2-1-æ ‡å‡†å­—ç¬¦é›†åˆ"><a href="#2-1-æ ‡å‡†å­—ç¬¦é›†åˆ" class="headerlink" title="2.1 æ ‡å‡†å­—ç¬¦é›†åˆ"></a>2.1 æ ‡å‡†å­—ç¬¦é›†åˆ</h3><ul>
<li>èƒ½å¤Ÿä¸â€å¤šç§å­—ç¬¦â€åŒ¹é…çš„è¡¨è¾¾å¼</li>
<li>æ³¨æ„åŒºåˆ†å¤§å°å†™ï¼Œå¤§å†™æ˜¯ç›¸åçš„æ„æ€</li>
</ul>
<table>
<thead>
<tr>
<th align="center">å­—ç¬¦</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">\d</td>
<td align="center">ä»»æ„ä¸€ä¸ªæ•°å­—ï¼Œ0-9ä¸­çš„ä»»æ„ä¸€ä¸ª</td>
</tr>
<tr>
<td align="center">\w</td>
<td align="center">ä»»æ„ä¸€ä¸ªå­—æ¯æˆ–æ•°å­—æˆ–ä¸‹åˆ’çº¿ï¼Œä¹Ÿå°±æ˜¯A-Zã€a-zã€0-9ã€_ä¸­ä»»æ„ä¸€ä¸ª</td>
</tr>
<tr>
<td align="center">\s</td>
<td align="center">åŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ç­‰ç©ºç™½å­—ç¬¦çš„å…¶ä¸­ä¸€ä¸ª</td>
</tr>
<tr>
<td align="center">.</td>
<td align="center">å°æ•°ç‚¹å¯ä»¥åŒ¹é…ä»»æ„ä¸€ä¸ªå­—ç¬¦(é™¤äº†æ¢è¡Œç¬¦)ï¼Œ å¦‚æœè¦åŒ¹é…åŒ…æ‹¬â€\nâ€åœ¨å†…çš„æ‰€æœ‰å­—ç¬¦ï¼Œä¸€èˆ¬ç”¨<code>[\s\S]</code></td>
</tr>
</tbody></table>
<p>å¦‚æœè¦åŒ¹é…çœŸæ­£çš„â€™.â€™ã€â€™+â€™ã€â€™-â€˜ã€â€™\&#39; ï¼Œ å°±è¦è½¬ä¹‰ï¼Œç”¨<code>\.</code>ã€<code>\+</code>ã€<code>\-</code>ã€<code>\\</code></p>
<h3 id="2-2-è‡ªå®šä¹‰å­—ç¬¦é›†åˆ"><a href="#2-2-è‡ªå®šä¹‰å­—ç¬¦é›†åˆ" class="headerlink" title="2.2 è‡ªå®šä¹‰å­—ç¬¦é›†åˆ"></a>2.2 è‡ªå®šä¹‰å­—ç¬¦é›†åˆ</h3><ul>
<li>[]æ–¹æ‹¬å·åŒ¹é…æ–¹å¼ï¼Œèƒ½å¤ŸåŒ¹é…æ–¹æ‹¬å·ä¸­ä»»æ„ä¸€ä¸ªå­—ç¬¦</li>
<li>æ­£åˆ™è¡¨è¾¾å¼çš„ç‰¹æ®Šç¬¦å·ï¼Œè¢«åŒ…å«åˆ°ä¸­æ‹¬å·ä¸­ï¼Œåˆ™å¤±å»äº†ç‰¹æ®Šæ„ä¹‰ï¼Œé™¤äº†^ã€-ä¹‹å¤–</li>
<li>æ ‡å‡†å­—ç¬¦é›†åˆï¼Œé™¤å°æ•°ç‚¹å¤–ï¼Œå¦‚æœè¢«åŒ…å«äºä¸­æ‹¬å·ï¼Œè‡ªå®šä¹‰å­—ç¬¦é›†åˆè¢«åŒ…å«è¯¥é›†åˆ<ul>
<li>[\d.-+]å°†åŒ¹é…ï¼šæ•°å­—ã€å°æ•°ç‚¹ã€+ã€-</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">ä¾‹å¦‚</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">[ab5@]</td>
<td align="center">åŒ¹é…â€aâ€æˆ–â€bâ€æˆ–â€5â€æˆ–â€@â€</td>
</tr>
<tr>
<td align="center">[^abc]</td>
<td align="center">åŒ¹é…â€aâ€ã€â€bâ€ã€â€câ€ä¹‹å¤–çš„ä»»æ„ä¸€ä¸ªå­—ç¬¦</td>
</tr>
<tr>
<td align="center">[f-k]</td>
<td align="center">åŒ¹é…â€fâ€-â€œkâ€ä¹‹é—´çš„ä»»æ„ä¸€ä¸ªå­—æ¯</td>
</tr>
<tr>
<td align="center">[^A-F0-3]</td>
<td align="center">åŒ¹é…â€Aâ€-â€œFâ€ã€â€0â€-â€œ3â€ä¹‹å¤–çš„ä»»æ„ä¸€ä¸ªå­—ç¬¦</td>
</tr>
</tbody></table>
<h3 id="2-3-é‡è¯"><a href="#2-3-é‡è¯" class="headerlink" title="2.3 é‡è¯"></a>2.3 é‡è¯</h3><ul>
<li>ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„ç‰¹æ®Šç¬¦å·</li>
<li>åŒ¹é…æ¬¡æ•°ä¸­çš„è´ªå©ªæ¨¡å¼(åŒ¹é…å­—ç¬¦è¶Šå¤šè¶Šå¥½ï¼Œé»˜è®¤)</li>
<li>åŒ¹é…æ¬¡æ•°ä¸­çš„éè´ªå©ªæ¨¡å¼(åŒ¹é…å­—ç¬¦è¶Šå°‘è¶Šå¥½ï¼Œåœ¨ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„ç‰¹æ®Šç¬¦å·åå†åŠ ä¸Šä¸€ä¸ªâ€?â€å·)</li>
</ul>
<table>
<thead>
<tr>
<th align="center">é‡è¯</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">{n}</td>
<td align="center">è¡¨è¾¾å¼é‡å¤næ¬¡</td>
</tr>
<tr>
<td align="center">{m,n}</td>
<td align="center">è¡¨è¾¾å¼è‡³å°‘é‡å¤mæ¬¡ï¼Œæœ€å¤šé‡å¤næ¬¡</td>
</tr>
<tr>
<td align="center">{m,}</td>
<td align="center">è¡¨è¾¾å¼è‡³å°‘é‡å¤mæ¬¡</td>
</tr>
<tr>
<td align="center">?</td>
<td align="center">è¡¨è¾¾å¼åŒ¹é…0æ¬¡æˆ–1æ¬¡ï¼Œç›¸å½“äº{0,1}</td>
</tr>
<tr>
<td align="center">+</td>
<td align="center">è¡¨è¾¾å¼è‡³å°‘å‡ºç°1æ¬¡ï¼Œç›¸å½“äº{1,}</td>
</tr>
<tr>
<td align="center">*</td>
<td align="center">è¡¨è¾¾å¼ä¸å‡ºç°æˆ–å‡ºç°ä»»æ„æ¬¡ï¼Œç›¸å½“äº{0,}</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li><code>[A-Za-z]+</code>å¯ä»¥åŒ¹é…å•è¯</li>
</ul>
<p>ä¾‹å¦‚æ–‡æœ¬ï¼š</p>
<pre><code>6ã€7ã€8ã€9ã€
1ã€2ã€3ã€4ã€5ã€6ã€7ã€8ã€9ã€
ab a1b a12b a123b a1234b a12345b </code></pre>
<p><code>(\dã€)&#123;1,3&#125;</code>çš„åŒ¹é…ç»“æœï¼š</p>
<pre><code>6ã€7ã€8ã€
9ã€
1ã€2ã€3ã€
4ã€5ã€6ã€
7ã€8ã€9ã€</code></pre>
<p><code>(\dã€)&#123;1,3&#125;?</code>çš„åŒ¹é…ç»“æœï¼š</p>
<pre><code>6ã€
7ã€
8ã€
9ã€
1ã€
2ã€
3ã€
4ã€
5ã€
6ã€
7ã€
8ã€
9ã€</code></pre>
<p><code>a\d?b</code>çš„åŒ¹é…ç»“æœï¼š</p>
<pre><code>ab
a1b</code></pre>
<p><code>a\d+b</code>çš„åŒ¹é…ç»“æœï¼š</p>
<pre><code>a1b
a12b
a123b
a1234b
a12345b</code></pre>
<p><code>a\d-b</code>çš„åŒ¹é…ç»“æœï¼š</p>
<pre><code>ab
a1b
a12b
a123b
a1234b
a12345b</code></pre>
<h3 id="2-4-å­—ç¬¦è¾¹ç•Œ"><a href="#2-4-å­—ç¬¦è¾¹ç•Œ" class="headerlink" title="2.4 å­—ç¬¦è¾¹ç•Œ"></a>2.4 å­—ç¬¦è¾¹ç•Œ</h3><table>
<thead>
<tr>
<th align="center">å­—ç¬¦</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">^</td>
<td align="center">ä¸å­—ç¬¦ä¸²å¼€å§‹çš„åœ°æ–¹åŒ¹é…</td>
</tr>
<tr>
<td align="center">$</td>
<td align="center">ä¸å­—ç¬¦ä¸²ç»“æŸçš„åœ°æ–¹åŒ¹é…</td>
</tr>
<tr>
<td align="center">\b</td>
<td align="center">åŒ¹é…ä¸€ä¸ªå•è¯è¾¹ç•Œ</td>
</tr>
</tbody></table>
<p><code>\b</code>åŒ¹é…è¿™æ ·ä¸€ä¸ªä½ç½®ï¼šå‰é¢çš„å­—ç¬¦å’Œåé¢çš„å­—ç¬¦ä¸å…¨æ˜¯\wã€‚</p>
<p>ä¾‹å¦‚æ–‡æœ¬:</p>
<pre><code>Khighness 
Khighness1 Khighness2
3Khighness 
4Khighness 
Khighness5 Khighness6
7Khighness 
8Khighness</code></pre>
<p><code>^K</code>åŒ¹é…æœ€åˆçš„â€Kâ€ï¼Œ<code>s$</code>åŒ¹é…æœ€åçš„â€sâ€ï¼›</p>
<p><code>Khighness\b</code>åŒ¹é…ç¬¬1ã€3ã€4ã€6ã€7è¡Œçš„â€Khighnessâ€ï¼›</p>
<p><code>\bKhighness</code>åŒ¹é…ç¬¬1ã€2ã€5è¡Œçš„â€Khighnessâ€ï¼›</p>
<p><code>\bKhighness\b</code>åŒ¹é…ç¬¬1è¡Œçš„â€Khighnessâ€ã€‚</p>
<h3 id="2-5-åŒ¹é…æ¨¡å¼"><a href="#2-5-åŒ¹é…æ¨¡å¼" class="headerlink" title="2.5 åŒ¹é…æ¨¡å¼"></a>2.5 åŒ¹é…æ¨¡å¼</h3><ul>
<li>IGNORECASE-å¿½ç•¥å¤§å°å†™æ¨¡å¼<ul>
<li>åŒ¹é…æ—¶å¿½ç•¥å¤§å°å†™</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­£åˆ™è¡¨è¾¾å¼æ˜¯è¦åŒºåˆ†å¤§å°å†™çš„</li>
</ul>
</li>
<li>SINGLELINE-å•è¡Œæ¨¡å¼<ul>
<li>æ•´ä¸ªæ–‡æœ¬çœ‹åšä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåªæœ‰ä¸€ä¸ªå¼€å¤´ï¼Œä¸€ä¸ªç»“å°¾</li>
<li>ä½¿å°æ•°ç‚¹â€.â€å¯ä»¥åŒ¹é…åŒ…å«æ¢è¡Œç¬¦(\n)åœ¨å†…çš„ä»»æ„å­—ç¬¦</li>
</ul>
</li>
<li>MULTILINE-å¤šè¡Œæ¨¡å¼<ul>
<li>æ¯è¡Œéƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œéƒ½æœ‰å¼€å¤´å’Œç»“å°¾</li>
<li>åœ¨æŒ‡å®šäº†MULTILINEä¹‹åï¼Œå¦‚æœéœ€è¦ä»…åŒ¹é…å­—ç¬¦ä¸²å¼€å§‹å’Œç»“æŸä¸ºæ­¢ï¼Œå¯ä»¥ä½¿ç”¨<code>\A</code>å’Œ<code>\Z</code></li>
</ul>
</li>
</ul>
<h3 id="2-7-é€‰æ‹©ç¬¦å’Œåˆ†ç»„"><a href="#2-7-é€‰æ‹©ç¬¦å’Œåˆ†ç»„" class="headerlink" title="2.7 é€‰æ‹©ç¬¦å’Œåˆ†ç»„"></a>2.7 é€‰æ‹©ç¬¦å’Œåˆ†ç»„</h3><table>
<thead>
<tr>
<th align="center">è¡¨è¾¾å¼</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">åˆ†æ”¯ç»“æ„: |</td>
<td align="center">å·¦å³ä¸¤è¾¹è¡¨è¾¾å¼ä¹‹é—´â€œæˆ–â€å…³ç³»ï¼ŒåŒ¹é…å·¦è¾¹æˆ–è€…å³è¾¹</td>
</tr>
<tr>
<td align="center">æ•è·ç»„: ()</td>
<td align="center">(1) åœ¨è¢«ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„æ—¶å€™ï¼Œæ‹¬å·ä¸­çš„è¡¨è¾¾å¼å¯ä»¥ä½œä¸ºæ•´ä½“è¢«ä¿®é¥°; (2) å–åŒ¹é…ç»“æœçš„æ—¶å€™ï¼Œæ‹¬å·ä¸­çš„è¡¨è¾¾å¼åŒ¹é…åˆ°çš„å†…å®¹å¯ä»¥è¢«å•ç‹¬å¾—åˆ°; (3) æ¯ä¸€å¯¹æ‹¬å·ä¼šåˆ†é…ä¸€ä¸ªç¼–å·ï¼Œä½¿ç”¨()çš„æ•è·æ ¹æ®å·¦æ‹¬å·çš„é¡ºåºä»1å¼€å§‹è‡ªåŠ¨ç¼–å·ã€‚æ•è·å…ƒç´ ç¼–å·ä¸ºé›¶çš„ç¬¬ä¸€ä¸ªæ•è·æ˜¯ç”±æ•´ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…çš„æ–‡æœ¬</td>
</tr>
<tr>
<td align="center">éæ•è·ç»„: (?:Exception)</td>
<td align="center">ä¸€äº›è¡¨è¾¾å¼ä¸­ï¼Œä¸å¾—ä¸ä½¿ç”¨()ï¼Œä½†åˆä¸éœ€è¦ä¿å­˜()ä¸­å­è¡¨è¾¾å¼åŒ¹é…çš„å†…å®¹ï¼Œè¿™æ—¶å¯ä»¥ç”¨éæ•è·ç»„æ¥æŠµæ¶ˆä½¿ç”¨()å¸¦æ¥çš„å‰¯ä½œç”¨</td>
</tr>
</tbody></table>
<p>åå‘å¼•ç”¨(\num)ï¼šæ¯ä¸€å¯¹()ä¼šåˆ†é…ä¸€ä¸ªç¼–å·ï¼Œä½¿ç”¨()çš„æ•è·æ¨¡å¼</p>
<p>ä¾‹å¦‚<code>([a-z]&#123;2&#125;)\1</code>å¯ä»¥åŒ¹é…ç±»ä¼¼â€ababâ€ã€â€gogoâ€ã€â€totoâ€çš„å­—ç¬¦ä¸²ã€‚</p>
<h3 id="2-8-é¢„æœç´¢-é›¶å®½æ–­è¨€"><a href="#2-8-é¢„æœç´¢-é›¶å®½æ–­è¨€" class="headerlink" title="2.8 é¢„æœç´¢(é›¶å®½æ–­è¨€)"></a>2.8 é¢„æœç´¢(é›¶å®½æ–­è¨€)</h3><ul>
<li>åªè¿›è¡Œå­è¡¨è¾¾å¼çš„åŒ¹é…ï¼ŒåŒ¹é…å†…å®¹ä¸è®¡å…¥æœ€ç»ˆçš„åŒ¹é…ç»“æœï¼Œæ˜¯é›¶å®½åº¦</li>
<li>è¿™ä¸ªä½ç½®åº”è¯¥ç¬¦åˆæŸä¸ªæ¡ä»¶ã€‚åˆ¤æ–­å½“å‰ä½ç½®çš„å‰åå­—ç¬¦ï¼Œæ˜¯å¦ç¬¦åˆæŒ‡å®šçš„æ¡ä»¶ï¼Œä½†ä¸åŒ¹é…å‰åçš„å­—ç¬¦ã€‚æ˜¯å¯¹ä½ç½®çš„åŒ¹é…</li>
<li>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå­è¡¨è¾¾å¼åŒ¹é…åˆ°çš„æ˜¯å­—ç¬¦å†…å®¹ï¼Œè€Œéä½ç½®ï¼Œå¹¶è¢«ä¿å­˜åˆ°æœ€ç»ˆçš„åŒ¹é…ç»“æœä¸­ï¼Œé‚£ä¹ˆä¹…è®¤ä¸ºè¿™ä¸ªå­è¡¨è¾¾å¼æ˜¯å æœ‰å­—ç¬¦çš„ï¼›å¦‚æœå­è¡¨è¾¾å¼åŒ¹é…çš„ä»…ä»…æ˜¯ä½ç½®ï¼Œæˆ–è€…åŒ¹é…çš„å†…å®¹å¹¶ä¸ä¿å­˜åˆ°æœ€ç»ˆçš„åŒ¹é…ç»“æœä¸­ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè¿™ä¸ªå­è¡¨è¾¾å¼æ˜¯é›¶å®½åº¦çš„ã€‚å æœ‰å­—ç¬¦è¿˜æ˜¯é›¶å®½åº¦ï¼Œæ˜¯é’ˆå¯¹åŒ¹é…çš„å†…å®¹å±å¦ä¿å­˜åˆ°æœ€ç»ˆçš„åŒ¹é…ç»“æœä¸­è€Œè¨€çš„ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th align="center">è¡¨è¾¾å¼</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">(?=exp)</td>
<td align="center">æ–­è¨€è‡ªèº«å‡ºç°çš„ä½ç½®çš„åé¢èƒ½åŒ¹é…è¡¨è¾¾å¼exp</td>
</tr>
<tr>
<td align="center">(?&lt;=exp)</td>
<td align="center">æ–­è¨€è‡ªèº«å‡ºç°çš„ä½ç½®çš„å‰é¢èƒ½åŒ¹é…è¡¨è¾¾å¼exp</td>
</tr>
<tr>
<td align="center">(?!exp)</td>
<td align="center">æ–­è¨€æ­¤ä½ç½®çš„åé¢ä¸èƒ½åŒ¹é…è¡¨è¾¾å¼exp</td>
</tr>
<tr>
<td align="center">(?&lt;exp)</td>
<td align="center">æ–­è¨€æ­¤ä½ç½®çš„å‰é¢ä¸èƒ½åŒ¹é…è¡¨è¾¾å¼exp</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚ï¼š</p>
<ul>
<li><p><code>[A-Za-z]+(?=ing)</code>å¯ä»¥åŒ¹é…æ‰€æœ‰ä»¥â€ingâ€ç»“å°¾çš„å•è¯(åŒ¹é…ç»“æœä¸åŒ…å«â€ingâ€ï¼Œ<code>[A-Za-z]+ing</code>çš„åŒ¹é…ç»“æœåŒ…å«â€ingâ€)</p>
</li>
<li><p><code>(?&lt;=in)[A-Za-z]+</code>å¯ä»¥åŒ¹é…æ‰€æœ‰ä»¥â€inâ€ä¸ºå‰ç¼€çš„å•è¯(åŒ¹é…ç»“æœä¸åŒ…å«â€inâ€ï¼Œ<code>in[A-Za-z]+</code>çš„åŒ¹é…ç»“æœåŒ…å«â€inâ€)</p>
</li>
</ul>
<h2 id="3-éªŒè¯"><a href="#3-éªŒè¯" class="headerlink" title="3. éªŒè¯"></a>3. éªŒè¯</h2><h3 id="3-1-ç”µè¯å·ç éªŒè¯"><a href="#3-1-ç”µè¯å·ç éªŒè¯" class="headerlink" title="3.1 ç”µè¯å·ç éªŒè¯"></a>3.1 ç”µè¯å·ç éªŒè¯</h3><blockquote>
<p>è¦æ±‚</p>
</blockquote>
<ul>
<li>å›ºå®šç”µè¯å·ç ç”±æ•°å­—å’Œâ€-â€œæ„æˆï¼Œç”µè¯å·ç ä¸º7åˆ°8ä½</li>
<li>å¦‚æœå›ºå®šç”µè¯å·ç ä¸­åŒ…å«æœ‰åŒºå·ï¼Œé‚£ä¹ˆåŒºå·ä¸ºä¸‰ä½æˆ–å››ä½ï¼Œé¦–ä½æ˜¯0ï¼ŒåŒºå·ç”¨â€-â€œå’Œå…¶ä»–éƒ¨åˆ†éš”å¼€</li>
<li>ç§»åŠ¨ç”µè¯å·ç ä¸º11ä½ï¼Œç¬¬ä¸€ä½å’Œç¬¬äºŒä½ä¸ºâ€13â€ã€â€14â€ã€15â€ã€â€17â€ã€18â€ã€â€19â€</li>
</ul>
<blockquote>
<p>åˆ†æï¼š</p>
</blockquote>
<ul>
<li>å›ºå®šç”µè¯å·ç ï¼š<code>0\d&#123;2,3&#125;-\d&#123;7,9&#125;</code></li>
<li>ç§»åŠ¨ç”µè¯å·ç : <code>1[3|4|5|7|8|9]\d&#123;9&#125;</code></li>
<li>åˆèµ·æ¥å°±æ˜¯ï¼š<code>^0\d&#123;2,3&#125;-\d&#123;7,9&#125;|1[3|4|5|7|8|9]\d&#123;9&#125;$</code></li>
</ul>
<h3 id="3-3-ç”µå­é‚®ç®±éªŒè¯"><a href="#3-3-ç”µå­é‚®ç®±éªŒè¯" class="headerlink" title="3.3 ç”µå­é‚®ç®±éªŒè¯"></a>3.3 ç”µå­é‚®ç®±éªŒè¯</h3><blockquote>
<p>è¦æ±‚</p>
</blockquote>
<ul>
<li>ç”µå­é‚®ç®±æ ¼å¼ï¼šåç§°@åŸŸå</li>
<li>é‚®ç®±åç§°éƒ¨åˆ†ï¼šå…è®¸æ±‰å­—ã€å­—æ¯ã€æ•°å­—ã€ä¸­åˆ’çº¿å’Œä¸‹åˆ’çº¿</li>
<li>é‚®ç®±åŸŸåéƒ¨åˆ†ï¼šå…è®¸å­—æ¯ã€æ•°å­—ã€è‹±è¯­å¥å·</li>
</ul>
<blockquote>
<p>åˆ†æ</p>
</blockquote>
<ul>
<li>é‚®ç®±åç§°è¡¨è¾¾å¼ï¼š<ul>
<li>æ±‰å­—<code>[\u4e00-\u9fa5]</code></li>
<li>å­—æ¯<code>[A-Za-z]</code></li>
<li>æ•°å­—<code>[0-9]</code></li>
<li>ä¸­åˆ’çº¿å’Œä¸‹åˆ’çº¿<code>[-_]</code></li>
<li>ç»¼ä¸Šå¾—åˆ°åç§°è¡¨è¾¾å¼<code>[\u4e00-\u9fa5A-Za-z0-9-_]+</code></li>
</ul>
</li>
<li>é‚®ç®±åŸŸåè¡¨è¾¾å¼ï¼š<ul>
<li>åŸŸåçš„ä¸€èˆ¬è§„å¾‹ä¸º[Nçº§åŸŸå].[ä¸‰çº§åŸŸå].[äºŒçº§åŸŸå].[ä¸€çº§åŸŸå]ï¼Œæ ¼å¼ç±»ä¼¼ä¸º<code>**.**.**.**</code></li>
<li>ä¸€çº§åŸŸååªåŒ…å«å­—æ¯(å¦‚comã€topã€cnç­‰)ï¼Œé•¿åº¦ä¸º2-4ä½</li>
<li><code>**</code>éƒ¨åˆ†å¯ä»¥è¡¨ç¤ºä¸º<code>[A-Za-z0-9-_]+</code></li>
<li><code>.**</code>éƒ¨åˆ†å¯ä»¥è¡¨ç¤ºä¸º<code>\.[A-Za-z0-9-_]+</code></li>
<li>é›¶æˆ–å¤šä¸ª<code>&quot;.**&quot;</code>å¯ä»¥è¡¨ç¤ºä¸º <code> (\.[A-Za-z0-9-_]+)*</code></li>
<li>ä¸€çº§åŸŸåéƒ¨åˆ†<code>.**</code>å¯ä»¥è¡¨ç¤ºä¸º.<code>\.[a-z]&#123;2,4&#125;</code></li>
<li>ç»¼ä¸Šå¾—åˆ°åŸŸåè¡¨è¾¾å¼<code>[A-Za-z0-9-_]+(\.[A-Za-z0-9-_]+)*\.[a-z]&#123;2,4&#125;</code></li>
</ul>
</li>
<li>é‚®ç®±æœ€ç»ˆè¡¨è¾¾å¼ï¼š<ul>
<li>ä½¿ç”¨<code>^</code>åŒ¹é…é‚®ç®±æœ€å¼€å§‹çš„éƒ¨åˆ†ï¼Œä½¿ç”¨<code>$</code>åŒ¹é…é‚®ç®±ç»“æŸéƒ¨åˆ†ä»¥ä¿è¯é‚®ç®±å‰åä¸èƒ½æœ‰å…¶ä»–å­—ç¬¦</li>
<li>ç”±â€åç§°@åŸŸåâ€å¾—åˆ°æœ€ç»ˆè¡¨è¾¾å¼ï¼š<code>[\u4e00-\u9fa5A-Za-z0-9-_]+@[A-Za-z0-9-_]+(\.[A-Za-z0-9-_]+)*\.[a-z]&#123;2,4&#125;</code></li>
<li>ç®€å†™å³ä¸ºï¼š<code>^[\u4e00-\u9fa5-\w]+@[-\w]+(\.[-\w]+)*\.[a-z]&#123;2,4&#125;$</code></li>
</ul>
</li>
</ul>
<br>

<h2 id="4-ä½¿ç”¨"><a href="#4-ä½¿ç”¨" class="headerlink" title="4. ä½¿ç”¨"></a>4. ä½¿ç”¨</h2><p>Javaç¨‹åºä¸­ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œç›¸å…³ç±»ä½äº<code>java.util.regex</code>åŒ…ä¸‹é¢</p>
<ul>
<li>ç±»<code>Pattern</code>:<ul>
<li>æ­£åˆ™è¡¨è¾¾å››çš„ç¼–è¯‘è¡¨ç¤ºå½¢å¼</li>
<li>å»ºç«‹æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶å¯ç”¨ç›¸åº”æ¨¡å¼ï¼š<code>Pattern pattern = Pattern.compile(Regular Expression);</code></li>
</ul>
</li>
<li>ç±»<code>Matcher</code>:<ul>
<li>é€šè¿‡è§£é‡Š<code>Pattern</code>å¯¹<code>character squence</code>æ‰§è¡ŒåŒ¹é…æ“ä½œçš„å¼•æ“</li>
<li>åŒ¹é…strå­—ç¬¦ä¸²ï¼š<code>Matcher matcher = pattern.matcher(str);</code></li>
<li>å°†æ•´ä¸ªå­—ç¬¦ä¸²åºåˆ—ä¸è¯¥æ¨¡å¼åŒ¹é…ï¼š<code>boolean res1 = matcher.matches();</code></li>
<li>æ‰«æå­—ç¬¦ä¸²åºåˆ—ï¼ŒæŸ¥æ‰¾ä¸è¯¥æ¨¡å¼åŒ¹é…çš„ä¸‹ä¸€ä¸ªå­åºåˆ—ï¼š<code>boolean res2 = matcher.find();</code></li>
</ul>
</li>
</ul>
<h3 id="4-1-åŸºæœ¬æ“ä½œ"><a href="#4-1-åŸºæœ¬æ“ä½œ" class="headerlink" title="4.1 åŸºæœ¬æ“ä½œ"></a>4.1 åŸºæœ¬æ“ä½œ</h3><blockquote>
<p>ä»£ç </p>
</blockquote>
<pre><code class="java">package top.parak;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * @author: KHighness
 * @date: 2020/10/7 15:23
 * @apiNote: åŸºæœ¬æ“ä½œ
 */

public class Demo1 &#123;
    public static void main(String[] args) &#123;
        // æ­£åˆ™åŒ¹é…æ¨¡å¼
        Pattern pattern = Pattern.compile(&quot;\\w+&quot;);

        // åŒ¹é…æ“ä½œå¼•æ“
        Matcher matcher = pattern.matcher(&quot;KHighness||ParaK||FlowerK||18236763&quot;);

        // å®Œæ•´åŒ¹é…
        System.out.println(&quot;----------å®Œæ•´åŒ¹é…----------&quot;);
        boolean res = matcher.matches();
        System.out.println(&quot;åŒ¹é…ç»“æœï¼š&quot; + res + &quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot; + (res ? matcher.group() : &quot;NULL&quot;));

        // æ¯æ¬¡æ“ä½œå®Œå¼•æ“ä¸­çš„å­—ç¬¦ä¸²éƒ½ä¼šåˆ°è¾¾æœ«å°¾ï¼Œéœ€è¦é‡æ–°å†™
        matcher = pattern.matcher(&quot;KHighness||ParaK||FlowerK||18236763&quot;);

        // å­ä¸²åŒ¹é…
        System.out.println(&quot;----------å­ä¸²åŒ¹é…----------&quot;);
        boolean res1 = matcher.find();
        System.out.println(&quot;åŒ¹é…ç»“æœï¼š&quot; + res1 + &quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot; + (res1 ? matcher.group() : &quot;NULL&quot;));
        boolean res2 = matcher.find();
        System.out.println(&quot;åŒ¹é…ç»“æœï¼š&quot; + res2 + &quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot; + (res2 ? matcher.group() : &quot;NULL&quot;));
        boolean res3 = matcher.find();
        System.out.println(&quot;åŒ¹é…ç»“æœï¼š&quot; + res3 + &quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot; + (res3 ? matcher.group() : &quot;NULL&quot;));
        boolean res4 = matcher.find();
        System.out.println(&quot;åŒ¹é…ç»“æœï¼š&quot; + res4 + &quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot; + (res4 ? matcher.group() : &quot;NULL&quot;));
        boolean res5 = matcher.find();
        System.out.println(&quot;åŒ¹é…ç»“æœï¼š&quot; + res5 + &quot;ï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š&quot; + (res5 ? matcher.group() : &quot;NULL&quot;));

        // å¾ªç¯æŸ¥æ‰¾
        matcher = pattern.matcher(&quot;KHighness||ParaK||FlowerK||18236763&quot;);
        System.out.println(&quot;----------å¾ªç¯åŒ¹é…----------&quot;);
        while (matcher.find()) &#123;
            System.out.println(matcher.group());
        &#125;
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<pre><code class="powershell">----------å®Œæ•´åŒ¹é…----------
åŒ¹é…ç»“æœï¼šfalseï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼šNULL
----------å­ä¸²åŒ¹é…----------
åŒ¹é…ç»“æœï¼štrueï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼šKHighness
åŒ¹é…ç»“æœï¼štrueï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼šParaK
åŒ¹é…ç»“æœï¼štrueï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼šFlowerK
åŒ¹é…ç»“æœï¼štrueï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼š18236763
åŒ¹é…ç»“æœï¼šfalseï¼ŒåŒ¹é…å­—ç¬¦ä¸²ï¼šNULL
----------å¾ªç¯åŒ¹é…----------
KHighness
ParaK
FlowerK
18236763</code></pre>
<h3 id="4-2-åˆ†ç»„æ“ä½œ"><a href="#4-2-åˆ†ç»„æ“ä½œ" class="headerlink" title="4.2 åˆ†ç»„æ“ä½œ"></a>4.2 åˆ†ç»„æ“ä½œ</h3><blockquote>
<p>ä»£ç </p>
</blockquote>
<pre><code class="java">package top.parak;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * @author: KHighness
 * @date: 2020/10/7 15:46
 * @apiNote: åˆ†ç»„æ“ä½œ
 */

public class Demo2 &#123;
    public static void main(String[] args) &#123;
        // æ­£åˆ™åŒ¹é…æ¨¡å¼
        // åˆ†ç»„ä¸¤ç»„åŒ¹é…ï¼šå­—æ¯å’Œæ•°å­—
        Pattern pattern = Pattern.compile(&quot;([A-Za-z]+)([0-9]+)&quot;);
        // åŒ¹é…æ“ä½œå¼•æ“
        Matcher matcher = pattern.matcher(&quot;KHighness18||ParaK23||FlowerK67||KAG63||KAG72&quot;);

        int index = 1;
        while (matcher.find()) &#123;
            System.out.printf(&quot;-----ç¬¬%dç»„-----\n&quot;, index++);
            System.out.println(&quot;group[0]: &quot; + matcher.group(0));
            System.out.println(&quot;group[1]: &quot; + matcher.group(1));
        &#125;
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<pre><code class="powershell">-----ç¬¬1ç»„-----
group[0]: KHighness18
group[1]: KHighness
-----ç¬¬2ç»„-----
group[0]: ParaK23
group[1]: ParaK
-----ç¬¬3ç»„-----
group[0]: FlowerK67
group[1]: FlowerK
-----ç¬¬4ç»„-----
group[0]: KAG63
group[1]: KAG
-----ç¬¬5ç»„-----
group[0]: KAG72
group[1]: KAG</code></pre>
<h3 id="4-3-æ›¿æ¢æ“ä½œ"><a href="#4-3-æ›¿æ¢æ“ä½œ" class="headerlink" title="4.3 æ›¿æ¢æ“ä½œ"></a>4.3 æ›¿æ¢æ“ä½œ</h3><blockquote>
<p>ä»£ç </p>
</blockquote>
<pre><code class="java">package top.parak;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * @author: KHighness
 * @date: 2020/10/7 16:09
 * @apiNote: æ›¿æ¢æ“ä½œ
 */

public class Demo3 &#123;
    public static void main(String[] args) &#123;
        // æ­£åˆ™åŒ¹é…æ¨¡å¼
        Pattern pattern = Pattern.compile(&quot;[0-9]&quot;);
        // åŒ¹é…æ“ä½œå¼•æ“
        Matcher matcher = pattern.matcher(&quot;KHighness18||ParaK23||FlowerK67||KAG63||KAG72&quot;);

        // æ•°å­—å…¨éƒ¨æ›¿æ¢ä¸º##
        String newStr = matcher.replaceAll(&quot;#&quot;);
        System.out.println(newStr);
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<pre><code class="powershell">KHighness##||ParaK##||FlowerK##||KAG##||KAG##</code></pre>
<h3 id="4-4-åˆ†å‰²æ“ä½œ"><a href="#4-4-åˆ†å‰²æ“ä½œ" class="headerlink" title="4.4 åˆ†å‰²æ“ä½œ"></a>4.4 åˆ†å‰²æ“ä½œ</h3><blockquote>
<p>ä»£ç </p>
</blockquote>
<pre><code class="java">package top.parak;

import java.util.Arrays;

/**
 * @author: KHighness
 * @date: 2020/10/7 16:12
 * @apiNote: åˆ†å‰²æ“ä½œ
 */

public class Demo4 &#123;
    public static void main(String[] args) &#123;
        String str = &quot;K18H23I67G63H72N18E23S67S6372&quot;;
        String[] arr = str.split(&quot;\\d+&quot;); // ä»¥æ•°å­—ä¸ºè¾¹ç•Œè¿›è¡Œåˆ‡å‰²
        System.out.println(Arrays.toString(arr));
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<pre><code class="powershell">[K, H, I, G, H, N, E, S, S]</code></pre>
<h3 id="4-5-çˆ¬å–è…¾è®¯å®˜ç½‘æ‰€æœ‰çš„è¶…é“¾æ¥"><a href="#4-5-çˆ¬å–è…¾è®¯å®˜ç½‘æ‰€æœ‰çš„è¶…é“¾æ¥" class="headerlink" title="4.5 çˆ¬å–è…¾è®¯å®˜ç½‘æ‰€æœ‰çš„è¶…é“¾æ¥"></a>4.5 çˆ¬å–è…¾è®¯å®˜ç½‘æ‰€æœ‰çš„è¶…é“¾æ¥</h3><blockquote>
<p>ä»£ç </p>
</blockquote>
<pre><code class="java">package top.parak;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.charset.Charset;
import java.util.LinkedList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * @author: KHighness
 * @date: 2020/10/7 16:24
 * @apiNote: çˆ¬å–è…¾è®¯å®˜ç½‘çš„æ‰€æœ‰è¶…é“¾æ¥
 */

public class WebSpider &#123;

    /**
     * é€šè¿‡URLè·å–html
     * @param urlStr
     * @return
     */
    public String getURLContent(String urlStr) &#123;
        StringBuilder stringBuilder = new StringBuilder();
        try &#123;
            URL url = new URL(urlStr);
            BufferedReader reader = new BufferedReader(new InputStreamReader(url.openStream(), Charset.forName(&quot;UTF-8&quot;)));
            String temp = &quot;&quot;;
            while ((temp = reader.readLine()) != null) &#123;
                stringBuilder.append(temp + &quot;\n&quot;);
            &#125;
        &#125; catch (MalformedURLException e) &#123;
            System.out.println(e.getMessage());
        &#125; catch (IOException e) &#123;
            System.out.println(e.getMessage());
        &#125;
        return stringBuilder.toString();
    &#125;

    /**
     * å°†åŒ¹é…ç»“æœè£…è¿›list
     * @param destStr
     * @param regex
     * @return
     */
    public List&lt;String&gt; getMatcherSubs(String destStr, String regex) &#123;
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(destStr);
        List&lt;String&gt; result = new LinkedList&lt;String&gt;();
        while (matcher.find()) &#123;
            result.add(matcher.group(1));
        &#125;
        return result;
    &#125;

    public static void main(String[] args) &#123;
        String url = &quot;https://www.tencent.com/zh-cn&quot;;
        WebSpider spider = new WebSpider();
        // è·å–è¶…é“¾æ¥æ ‡ç­¾açš„å†…å®¹ &lt;a\s\S]+?&lt;/a&gt;
        // è·å–hrefçš„å†…å®¹ href=\&quot;(.+?)\&quot;
        spider.getMatcherSubs(spider.getURLContent(url), &quot;href=\\\&quot;([\\w\\s./:]+?)\\\&quot;&quot;).stream().forEach(System.out::println);
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<pre><code class="powershell">/css/base.css
/css/index.css
https://weibo.com/tencent
https://twitter.com/TencentGlobal
https://www.linkedin.com/company/tencent/
https://careers.tencent.com/
https://join.qq.com/
https://spd.tencent.com/portal
https://ipr.tencent.com/
http://beian.miit.gov.cn/
http://beian.miit.gov.cn/
http://beian.miit.gov.cn/
/css/rem.css</code></pre>
]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
      <tags>
        <tag>Regex</tag>
      </tags>
  </entry>
  <entry>
    <title>åšå¼ˆè®º</title>
    <url>/posts/12bcd26e/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><center>
    <font face="Kristen ITC" color="#555555" size=3>Khighnessã€å¯»æ‰¾å¿…è´¥æ€</font><br>
</center>



<h2 id="1-å·´ä»€åšå¼ˆ"><a href="#1-å·´ä»€åšå¼ˆ" class="headerlink" title="1. å·´ä»€åšå¼ˆ"></a>1. å·´ä»€åšå¼ˆ</h2><br>

<h3 id="1-1-é—®é¢˜"><a href="#1-1-é—®é¢˜" class="headerlink" title="1.1 é—®é¢˜"></a>1.1 é—®é¢˜</h3><blockquote>
<p>ä¸¤ä¸ªé¡¶å°–èªæ˜çš„äººåœ¨ç©æ¸¸æˆï¼Œæœ‰ n ä¸ªçŸ³å­ï¼Œæ¯ä¸ªäººæ¯æ¬¡æ‹¿ 1~m ä¸ªçŸ³å¤´ï¼Œæ‹¿æ‰æœ€åä¸€å—çŸ³å¤´çš„äººå°±æ˜¯è·èƒœè€…ã€‚è¯·é—®å…ˆæ‰‹ä¸åæ‰‹è°å¿…èƒœï¼Ÿ</p>
</blockquote>
<br>

<h3 id="1-2-åˆ†æ"><a href="#1-2-åˆ†æ" class="headerlink" title="1.2 åˆ†æ"></a>1.2 åˆ†æ</h3><blockquote>
<p>åˆ†ç±»è®¨è®º: </p>
<p>ï¼ˆ1ï¼‰å½“n â‰¤ mæ—¶ï¼Œè¿™æ—¶å…ˆæ‰‹çš„äººå¯ä»¥ä¸€æ¬¡å–èµ°æ‰€æœ‰çš„ï¼›</p>
<p>ï¼ˆ2ï¼‰å½“n = m+1æ—¶ï¼Œè¿™æ—¶å…ˆæ‰‹æ— è®ºå–èµ°å¤šå°‘ä¸ªï¼Œåæ‰‹çš„äººéƒ½èƒ½å–èµ°å‰©ä¸‹æ‰€æœ‰çš„ï¼›</p>
<p>ï¼ˆ3ï¼‰å½“n = k âˆ— ( m + 1)æ—¶ï¼Œå¯¹äºæ¯(m + 1)ä¸ªçŸ³å­ï¼Œå…ˆæ‰‹å–iä¸ªï¼Œåæ‰‹ä¸€å®šèƒ½å°†å‰©ä¸‹çš„(m + 1 âˆ’ i)ä¸ªéƒ½å–èµ°ï¼Œå› æ­¤åæ‰‹å¿…èƒœï¼›</p>
<p>ï¼ˆ4ï¼‰å½“n = k âˆ— ( m + 1)  + x ( 0&lt; x&lt; m + 1)æ—¶ï¼Œå…ˆæ‰‹å¯ä»¥å…ˆå– x ä¸ªï¼Œä¹‹åçš„å±€åŠ¿å°±å›åˆ°äº†ä¸Šä¸€ç§æƒ…å†µï¼Œæ— è®ºåæ‰‹å–å¤šå°‘ä¸ªï¼Œå…ˆæ‰‹éƒ½èƒ½å–èµ°m+1ä¸ªä¸­å‰©ä¸‹çš„ï¼Œå› æ­¤å…ˆæ‰‹å¿…èƒœã€‚</p>
</blockquote>
<br>

<h3 id="1-3-ç»“è®º"><a href="#1-3-ç»“è®º" class="headerlink" title="1.3 ç»“è®º"></a>1.3 ç»“è®º</h3><blockquote>
<p><strong>å½“n % m + 1) == 0æ—¶ï¼Œåæ‰‹å¿…èƒœï¼Œå¦åˆ™å…ˆæ‰‹å¿…èƒœã€‚</strong></p>
</blockquote>
<br>

<h3 id="1-4-ä»£ç "><a href="#1-4-ä»£ç " class="headerlink" title="1.4 ä»£ç "></a>1.4 ä»£ç </h3><pre><code class="java">public class BashGame &#123;
    public void play(int n, int m) &#123;
        if ((n % (m + 1)) == 0) &#123;
            System.out.println(&quot;åæ‰‹è·èƒœ&quot;);
        &#125; else &#123;
            System.out.println(&quot;å…ˆæ‰‹è·èƒœ&quot;);
        &#125;
    &#125;
&#125;</code></pre>
<br>

<h2 id="2-å°¼å§†åšå¼ˆ"><a href="#2-å°¼å§†åšå¼ˆ" class="headerlink" title="2. å°¼å§†åšå¼ˆ"></a>2. å°¼å§†åšå¼ˆ</h2><br>

<h3 id="2-1-é—®é¢˜"><a href="#2-1-é—®é¢˜" class="headerlink" title="2.1 é—®é¢˜"></a>2.1 é—®é¢˜</h3><blockquote>
<p>ä¸¤ä¸ªé¡¶å°–èªæ˜çš„äººåœ¨ç©æ¸¸æˆï¼Œæœ‰ n å †çŸ³å­ï¼Œç¬¬ i å †æœ‰ ai æ¯ä¸ªäººæ¯æ¬¡èƒ½ä»ä¸€å †çŸ³å­ä¸­å–ä»»æ„å¤šä¸ªçŸ³å­ä½†ä¸èƒ½ä¸å–ï¼Œä¸èƒ½å–çš„äººè¾“ã€‚è¯·é—®å…ˆæ‰‹ä¸åæ‰‹è°å¿…èƒœï¼Ÿ</p>
</blockquote>
<br>

<h3 id="2-2-åˆ†æ"><a href="#2-2-åˆ†æ" class="headerlink" title="2.2 åˆ†æ"></a>2.2 åˆ†æ</h3><blockquote>
<p>ï¼ˆ1ï¼‰å½“n = 1æ—¶ï¼Œæ˜¾ç„¶å…ˆæ‰‹å–èµ°è¿™ä¸€å †å°±èƒ½è·èƒœï¼›</p>
<p>ï¼ˆ2ï¼‰å½“n = 2ä¸”a1 != a2æ—¶ï¼Œæˆ‘ä»¬å‡è®¾a1 &gt; a2ï¼Œå…ˆæ‰‹å¯ä»¥å…ˆåœ¨ç¬¬ä¸€å †å–èµ°a1-a2ä¸ªï¼Œä¸‹ä¸€æ¬¡æ— è®ºåæ‰‹å–èµ°å¤šå°‘ä¸ªï¼Œå…ˆæ‰‹éƒ½å¯ä»¥åœ¨å¦ä¸€å †å–èµ°ç›¸åŒçš„ä¸ªæ•°ï¼Œå› æ­¤å…ˆæ‰‹å¿…èƒœï¼›</p>
<p>ï¼ˆ3ï¼‰å½“n = 2ä¸”a1 == a2æ—¶ï¼Œå…ˆæ‰‹æ— è®ºå–å¤šå°‘ä¸ªï¼Œåæ‰‹éƒ½å¯ä»¥åœ¨å¦ä¸€å †å–ç›¸åŒçš„ä¸ªæ•°ï¼Œå› æ­¤åæ‰‹å¿…èƒœï¼›</p>
<p>ï¼ˆ4ï¼‰å½“n &gt;= 3æ—¶ï¼Œé—®é¢˜å˜å¾—ç¹çèµ·æ¥ï¼Œå…ˆæ‰¾å‡ºè§„å¾‹æ€§çš„ç»“è®ºã€‚</p>
</blockquote>
<br>

<h3 id="2-3-ç»“è®º"><a href="#2-3-ç»“è®º" class="headerlink" title="2.3 ç»“è®º"></a>2.3 ç»“è®º</h3><blockquote>
<p><strong>å½“ a1 ^ a2 ^ Â·Â·Â· ^ an =  0 æ—¶ï¼Œåæ‰‹å¿…èƒœï¼Œå¦åˆ™å…ˆæ‰‹å¿…èƒœã€‚</strong></p>
<p><strong>è¯æ˜ï¼š</strong></p>
<p>å‡è®¾å½“å‰ï¼ša1 ^ a2 ^ Â·Â·Â· ^ an =  0ï¼Œ</p>
<p>å…ˆæ‰‹å›åˆï¼šå–èµ°è‹¥å¹²ä¸ªåï¼Œ</p>
<p>å±€åŠ¿å˜æˆï¼ša1 ^ a2 ^ Â·Â·Â· ^ an =  Kï¼Œ</p>
<p>å³ï¼ša1 ^ a2 ^ Â·Â·Â· ^ an ^ K = 0ã€‚</p>
<p>å‡è®¾ K çš„æœ€é«˜ä½1åœ¨ç¬¬ x ä½ï¼Œ</p>
<p>é‚£ä¹ˆå¿…ç„¶å­˜åœ¨ aj (1 &lt; = j &lt;= n) çš„ ç¬¬ x ä½ä¸º1ï¼Œ</p>
<p>åæ‰‹å›åˆï¼šåªè¦æŠŠ aj å˜æˆ aj ^ Kï¼Œ</p>
<p>å°±èƒ½ä½¿å¾—ï¼ša1 ^ a2 ^ Â·Â·Â· ^ an =  0ã€‚</p>
<p>ç”±äº aj ^ K ä½¿å¾—ç¬¬ x ä½ ä¸º0ï¼Œæ— è®ºä½ä½æ˜¯ä»€ä¹ˆï¼Œ</p>
<p>ç¬¬ x ä½å˜ä¸º0åï¼Œaj æ•´ä¸ªæ•°ä¸€å®šä¼šå˜å°ï¼Œå³ï¼šaj ^ K &lt; ajï¼Œ</p>
<p>æ‰€ä»¥åæ‰‹åªéœ€åœ¨ç¬¬ j å †å–èµ°(aj - aj ^ K)ä¸ªçŸ³å­å³å¯ã€‚</p>
<p>å…ˆæ‰‹æ¯æ¬¡å–å®Œï¼Œåæ‰‹æ¯æ¬¡å–(aj - aj ^ K)ï¼Œ</p>
<p>æœ€åçš„å±€åŠ¿ä¸€å®šæ˜¯ï¼ša1 = a2 = Â·Â·Â· = an = 0ï¼Œ</p>
<p>æ­¤æ—¶å…ˆæ‰‹æ— æ³•å–äº†ï¼Œåæ‰‹å¿…èƒœã€‚</p>
<p>åä¹‹ï¼Œå½“a1 ^ a2 ^ Â·Â·Â· ^ an = K æ—¶ï¼Œ</p>
<p>å±€åŠ¿åè½¬ï¼Œå…ˆæ‰‹æ¯æ¬¡å–(aj - aj ^ K)ä¸ªå³å¯ï¼Œå…ˆæ‰‹å¿…èƒœã€‚</p>
</blockquote>
<br>

<h3 id="2-4-ä»£ç "><a href="#2-4-ä»£ç " class="headerlink" title="2.4 ä»£ç "></a>2.4 ä»£ç </h3><pre><code class="java">public class NimGame &#123;
    public void play(int[] a) &#123;
        int res = 0;
        for (int i : a) &#123;
            res ^= i;
        &#125;
        if (res == 0) &#123;
            System.out.println(&quot;åæ‰‹è·èƒœ&quot;);
        &#125; else &#123;
            System.out.println(&quot;å…ˆæ‰‹è·èƒœ&quot;);
        &#125;
    &#125;
&#125;</code></pre>
<br>

<h2 id="3-å°¼å§†Plusåšå¼ˆ"><a href="#3-å°¼å§†Plusåšå¼ˆ" class="headerlink" title="3. å°¼å§†Plusåšå¼ˆ"></a>3. å°¼å§†Plusåšå¼ˆ</h2><br>

<h3 id="3-1-é—®é¢˜"><a href="#3-1-é—®é¢˜" class="headerlink" title="3.1 é—®é¢˜"></a>3.1 é—®é¢˜</h3><blockquote>
<p>ä¸¤ä¸ªé¡¶å°–èªæ˜çš„äººåœ¨ç©æ¸¸æˆï¼Œæœ‰ n å †çŸ³å­ï¼Œç¬¬ i å †æœ‰ ai ä¸ªçŸ³å­ï¼Œæ¯ä¸ªäººæ¯æ¬¡èƒ½ä» 1~d å †çŸ³å­ä¸­å–ä»»æ„å¤šä¸ªçŸ³å­ä½†ä¸èƒ½ä¸å–ï¼Œä¸èƒ½å–çš„äººè¾“ã€‚è¯·é—®å…ˆæ‰‹ä¸åæ‰‹è°å¿…èƒœï¼Ÿ</p>
</blockquote>
<br>

<h3 id="3-2-åˆ†æ"><a href="#3-2-åˆ†æ" class="headerlink" title="3.2 åˆ†æ"></a>3.2 åˆ†æ</h3><blockquote>
<p>ç‰¹ä¹ˆå¤ªéš¾äº†å•Šï¼Œå‘œå‘œå‘œæˆ‘å¥½èœ</p>
</blockquote>
<br>

<h3 id="3-3-ç»“è®º"><a href="#3-3-ç»“è®º" class="headerlink" title="3.3 ç»“è®º"></a>3.3 ç»“è®º</h3><blockquote>
<p><strong>å°†æ¯å †çŸ³å­æ•°é‡ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œå¯¹äºäºŒè¿›åˆ¶çš„ä»»æ„ä¸€ä½ï¼Œå¦‚æœè¿™ä¸€ä½ä¸º1çš„çŸ³å­å †æ•°é‡%(d+1)==0ï¼Œé‚£ä¹ˆåæ‰‹å¿…èƒœï¼Œå¦åˆ™å…ˆæ‰‹å¿…èƒœã€‚</strong></p>
</blockquote>
<br>

<h3 id="3-4-è¯æ˜"><a href="#3-4-è¯æ˜" class="headerlink" title="3.4 è¯æ˜"></a>3.4 è¯æ˜</h3><blockquote>
<p>åªéœ€è¦è¯æ˜ä¸‰ç‚¹ï¼š</p>
<ol>
<li><p>ç»ˆæ­¢å±€é¢ä¸ºå…ˆæ‰‹å¿…è´¥ï¼ˆæ˜¾ç„¶ï¼‰</p>
</li>
<li><p>ä»»æ„å…ˆæ‰‹å¿…èƒœçš„å±€é¢éƒ½èƒ½è½¬å˜æˆå…ˆæ‰‹å¿…è´¥çš„å±€é¢</p>
</li>
<li><p>ä»»æ„å…ˆæ‰‹å¿…è´¥çš„å±€é¢éƒ½ä¸èƒ½è½¬å˜æˆå…ˆæ‰‹å¿…èƒœçš„å±€é¢</p>
</li>
</ol>
<p><strong>è¯æ˜</strong></p>
<p>è¯æ˜2:</p>
<p>å‡è®¾æœ€é«˜ä½%(d+1) != 0æœ‰må †ï¼Œé‚£ä¹ˆå°†è¿™äº›å †çš„è¿™ä¸€ä½å˜æˆ0ï¼›</p>
<p>å‡è®¾ä¸‹ä¸€ä½%(d+1) != 0çš„ä½æœ‰nä¸ªï¼Œä¹‹å‰må †ä¸­è¿™ä¸€ä½æœ‰aä¸ª1å’Œbä¸ª0ã€‚</p>
<p>ï¼ˆ1ï¼‰å¦‚æœn &lt;= aï¼Œæ˜¾ç„¶å°†è¿™aä¸­çš„nä¸ªå˜æˆ0å³å¯ï¼›</p>
<p>ï¼ˆ2ï¼‰å¦‚æœ(d+1) - n &lt;= bï¼Œé‚£ä¹ˆåªè¦å°†bä¸ªä¸­çš„(d+1) - nä¸ªå˜æˆ1å³å¯ï¼›</p>
<p>å› ä¸ºä¹‹å‰æœ€é«˜ä½æ˜¯å°†1å˜æˆ0ï¼Œæ‰€ä»¥è¿™ä¸€ä½å³ä½¿ç”±0å˜1ï¼Œè¿™å †çŸ³å­ä¹Ÿæ˜¯å‡å°‘çš„ï¼›</p>
<p>ï¼ˆ3ï¼‰å¦‚æœä¸¤ä¸ªéƒ½ä¸æ»¡è¶³ï¼Œå³a &gt; n &amp;&amp; b &lt; (d + 1 - n)ï¼Œé‚£ä¹ˆåªè¦å°†è¿™aå †å’Œmå †ä¹‹å¤–çš„(n - a)å †çš„è¿™ä¸€ä½å˜æˆ0ï¼Œ</p>
<p>é‚£ä¹ˆæ€»æ”¹å˜å †æ•°ä¸º a + b + (n - a) = b + n &lt; (d + 1) - n + n = d + 1ï¼Œ</p>
<p>å³å°†è¿™ä¸€ä½å˜æˆ%(d+1) = 0éœ€è¦æ”¹å˜çš„æ€»å †æ•°è¦å°äº(d+1)ï¼Œ</p>
<p>å³å¯ä»¥ä¸€æ¬¡æ“ä½œå®Œæˆï¼Œç„¶åä»¥æ­¤ç±»æ¨å°±èƒ½ä½¿æ¯ä¸€ä½éƒ½å˜ä¸º%(d+1)=0ã€‚</p>
<p>è¯æ˜3:</p>
<p>å› ä¸ºä¸€æ¬¡æœ€å¤šæ“ä½œdå †çŸ³å­ï¼Œå› æ­¤ä¸èƒ½å°†(d+1)å †æŸä¸€ä½æ˜¯1çš„çŸ³å­å †çš„è¿™ä¸€ä½éƒ½å˜ä¸º0ã€‚</p>
</blockquote>
<br>

<h2 id="4-å¨ä½å¤«åšå¼ˆ"><a href="#4-å¨ä½å¤«åšå¼ˆ" class="headerlink" title="4. å¨ä½å¤«åšå¼ˆ"></a>4. å¨ä½å¤«åšå¼ˆ</h2><br>

<h3 id="4-1-é—®é¢˜"><a href="#4-1-é—®é¢˜" class="headerlink" title="4.1 é—®é¢˜"></a>4.1 é—®é¢˜</h3><blockquote>
<p>ä¸¤ä¸ªé¡¶å°–èªæ˜çš„äººåœ¨ç©æ¸¸æˆï¼Œæœ‰ 2 å †çŸ³å­ï¼Œæ¯ä¸ªäººæ¯æ¬¡å¯ä»¥ä»ä»»æ„ä¸€å †çŸ³å­ä¸­å–ä»»æ„å¤šçš„çŸ³å­æˆ–è€…ä»ä¸¤å †çŸ³å­ä¸­å–åŒæ ·å¤šçš„çŸ³å­ï¼Œä¸èƒ½å–çš„äººè¾“ã€‚è¯·é—®å…ˆæ‰‹ä¸åæ‰‹è°å¿…èƒœï¼Ÿ</p>
</blockquote>
<br>

<h3 id="4-2-åˆ†æ"><a href="#4-2-åˆ†æ" class="headerlink" title="4.2 åˆ†æ"></a>4.2 åˆ†æ</h3><blockquote>
<p>å¨ä½å¤«åšå¼ˆä¸åŒäºå·´ä»€åšå¼ˆå’Œå°¼å§†åšå¼ˆï¼Œå®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºä¸èƒ½å°†ä¸¤å †çŸ³å­åˆ†å¼€åˆ†æã€‚</p>
<p><em>ä¸‹é¢åˆ†æä¸æƒ³çœ‹çš„ç›´æ¥è·³è¿‡è®°ä½ç»“è®ºå³å¯</em></p>
<p>å®šä¹‰å…ˆæ‰‹å¿…è¾“çš„å±€åŠ¿ä¸ºå¥‡å¼‚å±€åŠ¿ï¼Œå‰å‡ ä¸ªå¥‡å¼‚å±€åŠ¿ä¸º: (0, 0), (1, 2), (3, 5), (4, 7), (6,10)â€¦â€¦</p>
<p>å‡è®¾ (x, y) ä¸ºç¬¬ k ä¸ªå¥‡å¼‚å±€åŠ¿</p>
<p>æ€§è´¨ï¼š</p>
<ul>
<li>xä¸ºå‰ 1Â·Â·Â·k ä¸ªå¥‡å¼‚å±€åŠ¿ä¸­æ²¡æœ‰å‡ºç°è¿‡çš„æœ€å°æ­£æ•´æ•°ï¼Œy = x + k (æ‰“è¡¨æ‰¾è§„å¾‹)</li>
<li>ä»»ä½•ä¸€ä¸ªè‡ªç„¶æ•°éƒ½åŒ…å«åœ¨ä¸€ä¸ªä¸”ä»…æœ‰ä¸€ä¸ªå¥‡å¼‚å±€åŠ¿ä¸­</li>
<li>ä»»ä½•æ“ä½œéƒ½ä¼šå°†å¥‡å¼‚å±€åŠ¿å˜ä¸ºéå¥‡å¼‚å±€åŠ¿</li>
<li>éå¥‡å¼‚å±€åŠ¿å¯ä»¥é€šè¿‡é€‚å½“æ“ä½œå˜ä¸ºå¥‡å¼‚å±€åŠ¿</li>
</ul>
<p>è¯æ˜è¿™ä¸ªç»“è®ºï¼Œåªéœ€è¯æ˜ï¼š</p>
<ol>
<li>ä»»æ„è‡ªç„¶æ•°éƒ½å‡ºç°è¿‡</li>
<li>ä»»æ„è‡ªç„¶æ•°ä»…å‡ºç°ä¸€æ¬¡</li>
</ol>
<p>åè¯æ³•æ˜“è¯ã€‚</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/12bcd26e/%E5%A8%81%E4%BD%90%E5%A4%AB%E5%8D%9A%E5%BC%88.jpg" class="" title="XY">

<blockquote>
<p>æˆ‘ä»¬å¯ä»¥å°†ä¸¤å †çŸ³å­çœ‹æˆæ˜¯æ£‹ç›˜ä¸Šä¸€ä¸ªç‚¹çš„çºµæ¨ªåæ ‡ï¼Œé‚£ä¹ˆæ¸¸æˆåˆ‡æ¢ï¼š</p>
<p>æ£‹ç›˜ä¸Šæœ‰ä¸€ä¸ªç‚¹ï¼Œæ¯æ¬¡æ¯ä¸ªäººåªèƒ½å°†æ£‹å­å¾€å·¦æˆ–è€…å¾€ä¸‹ç§»åŠ¨ä»»æ„ä¸ªæ ¼å­ï¼Œä¸èƒ½ç§»åŠ¨çš„äººè¾“ã€‚</p>
<p>å°†èƒ½ä¸€æ­¥åˆ°è¾¾(0, 0)çš„ç‚¹éƒ½æŸ“è‰²ï¼Œé‚£ä¹ˆè¿™äº›ç‚¹å°±æ˜¯å¿…èƒœæ€ï¼Œå†æ‰¾åˆ°æ¨ªçºµåæ ‡ä¹‹å’Œæœ€å°çš„æ²¡è¢«æŸ“è‰²çš„ç‚¹ï¼Œ</p>
<p>è¿™ä¸ªç‚¹å°±æ˜¯ä¸‹ä¸€ä¸ªå¿…è´¥æ€ï¼Œç”±æ­¤ç”»å‡ºä¸Šå›¾ã€‚</p>
</blockquote>
<br>

<h3 id="4-3-ç»“è®º"><a href="#4-3-ç»“è®º" class="headerlink" title="4.3 ç»“è®º"></a>4.3 ç»“è®º</h3><blockquote>
<p><strong>æ ¹æ®<a href="https://baike.baidu.com/item/%E8%B4%9D%E8%92%82%E5%AE%9A%E7%90%86/2677437?fr=aladdin">Bettyå®šç†</a>ï¼Œç¬¬Kä¸ªå±€åŠ¿å°±æ˜¯(âŒŠ(1+âˆš5)/2 *kâŒ‹, âŒŠ(3+âˆš5)/2 *kâŒ‹)ï¼Œå…¶ä¸­(1+âˆš5)/2=1.618æ˜¯é»„é‡‘åˆ†å‰²ç³»æ•°ã€‚</strong></p>
<p><strong>å› æ­¤ï¼Œå±€åŠ¿(x, y)æ»¡è¶³(y - x)*(1+âˆš5)/2)=xæ—¶ï¼Œå…ˆæ‰‹å¿…è´¥ï¼Œå¦åˆ™å…ˆæ‰‹å¿…èƒœã€‚</strong></p>
</blockquote>
<br>

<h3 id="4-4-ä»£ç "><a href="#4-4-ä»£ç " class="headerlink" title="4.4 ä»£ç "></a>4.4 ä»£ç </h3><pre><code class="java">public class WizovGame &#123;
    public void play(int a, int b) &#123;
        // ä¿è¯ a &lt;= b
        if (a &gt; b) &#123;
            int temp = b;
            b = a;
            a = temp;
        &#125;
        // åˆ¤æ–­ a == (b - a) * é»„é‡‘åˆ†å‰²ç³»æ•° (å‘ä¸Šå–æ•´)
        if ( a == (int) Math.ceil( (b - a) * (1 + Math.sqrt(5.0)) / 2) ) &#123;
            System.out.println(&quot;åæ‰‹è·èƒœ&quot;);
        &#125; else &#123;
            System.out.println(&quot;å…ˆæ‰‹è·èƒœ&quot;);
        &#125;
    &#125;
&#125;</code></pre>
<br>

<h2 id="5-æ–æ³¢é‚£å¥‘åšå¼ˆ"><a href="#5-æ–æ³¢é‚£å¥‘åšå¼ˆ" class="headerlink" title="5. æ–æ³¢é‚£å¥‘åšå¼ˆ"></a>5. æ–æ³¢é‚£å¥‘åšå¼ˆ</h2><br>

<h3 id="5-1-é—®é¢˜"><a href="#5-1-é—®é¢˜" class="headerlink" title="5.1 é—®é¢˜"></a>5.1 é—®é¢˜</h3><blockquote>
<p>ä¸¤ä¸ªé¡¶å°–èªæ˜çš„äººåœ¨ç©æ¸¸æˆï¼Œæœ‰ä¸€å †çŸ³å­ï¼Œæ•°é‡ä¸ºnï¼Œä¸¤ä¸ªäººè½®æµå–çŸ³å­ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p>
<p>ï¼ˆ1ï¼‰å…ˆæ‰‹ä¸èƒ½åœ¨ç¬¬ä¸€æ¬¡æŠŠæ‰€æœ‰çš„çŸ³å­å–å®Œï¼Œè‡³å°‘å–ä¸€é¢—ï¼›</p>
<p>ï¼ˆ2ï¼‰ä¹‹åæ¯æ¬¡å¯ä»¥å–çš„çŸ³å­æ•°è‡³å°‘ä¸º1ï¼Œè‡³å¤šä¸ºå¯¹æ‰‹åˆšå–çš„çŸ³å­æ•°çš„2å€ï¼›</p>
<p>ä¸èƒ½å–çš„äººè¾“ã€‚è¯·é—®å…ˆæ‰‹ä¸åæ‰‹è°å¿…èƒœï¼Ÿ</p>
</blockquote>
<br>

<h3 id="5-2-ç»“è®º"><a href="#5-2-ç»“è®º" class="headerlink" title="5.2 ç»“è®º"></a>5.2 ç»“è®º</h3><blockquote>
<p><strong>å½“nä¸ºFibonacciæ•°çš„æ—¶å€™ï¼Œåæ‰‹å¿…èƒœï¼Œå¦åˆ™å…ˆæ‰‹å¿…èƒœã€‚</strong></p>
</blockquote>
<br>

<h3 id="5-3-è¯æ˜"><a href="#5-3-è¯æ˜" class="headerlink" title="5.3 è¯æ˜"></a>5.3 è¯æ˜</h3><blockquote>
<p>æ•°å­¦å½’çº³æ³•ï¼š</p>
<p>å‡è®¾çŸ³å­æ•°é‡n = F[i]ï¼ˆæ–æ³¢é‚£å¥‘æ•°åˆ—ä¸­çš„ç¬¬ié¡¹{1, 1, 2, 3, 5Â·Â·Â·Â·Â·Â·}ï¼‰</p>
<p>ï¼ˆ1ï¼‰å½“ i = 2 æ—¶ï¼Œn = 2ï¼Œæ˜¾ç„¶å…ˆæ‰‹å–ä¸€ä¸ªï¼Œåæ‰‹å¿…èƒœ</p>
<p>ï¼ˆ2ï¼‰å½“ i &gt; 2 æ—¶ï¼Œå‡è®¾å½“ i &lt;= k æ—¶ç»“è®ºæˆç«‹ã€‚</p>
<p>å½“i = k + 1æ—¶ï¼ŒF[i] = F[k] + F[k-1]ï¼Œå°†çŸ³å­åˆ†æˆä¸¤éƒ¨åˆ†æ¥çœ‹ã€‚</p>
<p>å‡è®¾å…ˆæ‰‹ç¬¬ä¸€æ¬¡å– x ä¸ªï¼Œåæ‰‹ç¬¬ä¸€æ¬¡å– y ä¸ªã€‚</p>
<p>1ï¼‰å¦‚æœ x &lt; F[k-1] / 3ï¼Œå› ä¸º n = F[k-1] æ—¶å·²ç»è¯æ˜åæ‰‹ä¸€å®šèƒ½å–åˆ° F[k-1] ä¸ªä¸­çš„æœ€åä¸€ä¸ªï¼Œ</p>
<p>æ‰€ä»¥é—®é¢˜è½¬åŒ–æˆäº†æœ‰ F[k] ä¸ªä¸­çš„æœ€åä¸€ä¸ªï¼Œè¿™ä¸ªä¹Ÿå·²ç»è¯æ˜åæ‰‹ä¸€å®šèƒ½å–åˆ°F[k]ä¸­çš„æœ€åä¸€ä¸ªã€‚</p>
<p>æ‰€ä»¥åæ‰‹å¿…èƒœã€‚</p>
<p>2ï¼‰å¦‚æœ F[k-1] / 3 &lt;= x &lt;= F[k]æ—¶ï¼Œåˆ™F[k-1]ä¸­å‰©ä½™æ•°é‡å°äº2xï¼Œåæ‰‹å¯ä»¥ç›´æ¥å–å®Œï¼Œ</p>
<p>ï¼ˆå¦‚æœä¸é€‰æ‹©ä¸€æ¬¡æ€§å–å®Œï¼Œæ…¢æ…¢ç£¨æœ€ç»ˆä¹Ÿä¼šæ˜¯æ‰€è¯æ˜çš„F[k-1]çš„æƒ…å†µï¼Œåæ‰‹æœ€åå–å®Œï¼‰</p>
<p>å³åæ‰‹å–äº†F[k-1]-xä¸ªï¼Œå³y &lt;= 2/3 * F[k-1]ã€‚æ¯”è¾ƒ 2/3 * F[k-1] ä¸ 1/2 * F[k] çš„å¤§å°ï¼Œ</p>
<p>å³æ¯”è¾ƒ4 * [k-1] ä¸ 3 * F[k] çš„å¤§å°ï¼š</p>
<p>ç”±äº F[k] å‡½æ•°é€’å¢ ä¸” F[k] = F[k-1] + F[k-2]æ˜“çŸ¥ï¼š2 * F[k-2] &lt; F[k] &lt; 2 * F[k-1]ï¼Œ</p>
<p>å› è€Œ 3 * F[k] = 3 * F[k-1] + 3 * F[k-2] &gt; 3 * F[k-1] + 3 / 2 * F[k-1] &gt; 4 * F[k-1]ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åæ‰‹å–å®ŒF[k-1]é‚£ä¸€å †çŸ³å­ä¹‹åï¼Œå…ˆæ‰‹ä¸èƒ½ä¸€æ¬¡æ€§å–å®ŒF[k]é‚£ä¸€å †çŸ³å­ï¼Œ</p>
<p>äºæ˜¯é—®é¢˜æœ€ç»ˆæ¼”å˜æˆäº†F[k]çš„çŠ¶å†µï¼Œåæ‰‹æœ€åå–å®Œã€‚</p>
<p>3ï¼‰å¦‚æœ x &gt; F[k-1]ï¼Œå› ä¸ºF[k] &lt; 2 * F[k-1]ï¼Œåæ‰‹å¯ä»¥ä¸€æ¬¡æ€§å–å®Œã€‚</p>
<p>ç»¼ä¸Šä¸‰ç§æƒ…å†µï¼Œå½“ i &lt;= k æ—¶ç»“è®ºæˆç«‹ï¼Œé‚£ä¹ˆå½“ n = k+1 æ—¶ç»“è®ºä¹Ÿæˆç«‹ã€‚</p>
</blockquote>
<br>

<h3 id="5-4-ä»£ç "><a href="#5-4-ä»£ç " class="headerlink" title="5.4 ä»£ç "></a>5.4 ä»£ç </h3><pre><code class="java">public class FibonacciGame &#123;
    public int fibnacci(int n) &#123;
        // é€’å½’è®¡ç®—ï¼Œæ…¢
//        if (n == 1 || n == 2)
//            return 1;
//        else
//            return fibnacci(n - 1) + fibnacci(n - 2);
        // å…¬å¼è®¡ç®—ï¼Œå¿«
        return (int) Math.floor( ( Math.pow((1 + Math.sqrt(5)) / 2, n)  - Math.pow((1 - Math.sqrt(5)) / 2, n) ) / Math.sqrt(5) );
    &#125;

    public void play(int n) &#123;
        for (int i = 1; fibnacci(i) &lt;= n; i++) &#123;
            if (fibnacci(i+1) == n) &#123;
                System.out.println(&quot;åæ‰‹è·èƒœ&quot;);
                return;
            &#125;
        &#125;
        System.out.println(&quot;å…ˆæ‰‹è·èƒœ&quot;);
    &#125;
&#125;</code></pre>
]]></content>
      <categories>
        <category>Algorithm</category>
      </categories>
      <tags>
        <tag>Game</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤§æ•°æ®</title>
    <url>/posts/ec060e02/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-å®‰è£…CentOS7"><a href="#1-å®‰è£…CentOS7" class="headerlink" title="1. å®‰è£…CentOS7"></a>1. å®‰è£…CentOS7</h2><h3 id="1-ä¸‹è½½é•œåƒ"><a href="#1-ä¸‹è½½é•œåƒ" class="headerlink" title="1. ä¸‹è½½é•œåƒ"></a>1. ä¸‹è½½é•œåƒ</h3><blockquote>
<p>ISO: <a href="https://www.centos.org/download/">CentOS7 X86_64</a></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915192222693.png" class="" title="image-20200915192222693">



<a id="more"></a>



<h3 id="2-å®‰è£…ç³»ç»Ÿ"><a href="#2-å®‰è£…ç³»ç»Ÿ" class="headerlink" title="2. å®‰è£…ç³»ç»Ÿ"></a>2. å®‰è£…ç³»ç»Ÿ</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914201854650.png" class="" title="image-20200914201854650">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914201950325.png" class="" title="image-20200914201950325">



<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914202216056.png" class="" title="image-20200914202216056">



<h3 id="3-è™šæ‹Ÿæœºå®Œæˆ"><a href="#3-è™šæ‹Ÿæœºå®Œæˆ" class="headerlink" title="3. è™šæ‹Ÿæœºå®Œæˆ"></a>3. è™šæ‹Ÿæœºå®Œæˆ</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914204312121.png" class="" title="image-20200914204312121">



<h3 id="4-å®‰è£…Docker"><a href="#4-å®‰è£…Docker" class="headerlink" title="4. å®‰è£…Docker"></a>4. å®‰è£…Docker</h3><blockquote>
<p>Dockerè¦æ±‚CentOSç³»ç»Ÿçš„å†…æ ¸ç‰ˆæœ¬é«˜äº 3.10ï¼ŒæŸ¥çœ‹CentOSç‰ˆæœ¬æ˜¯å¦æ”¯æŒ Docker</p>
</blockquote>
<pre><code class="shell">uname -r</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922202458823.png" class="" title="image-20200922202458823">

<blockquote>
<p>ç¡®ä¿yumåŒ…æ›´æ–°åˆ°æœ€æ–°</p>
</blockquote>
<pre><code class="shell">sudo yum update</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922202118583.png" class="" title="image-20200922202118583">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922202544937.png" class="" title="image-20200922202544937">

<blockquote>
<p>å®‰è£…è¿‡Dockeråˆ™å¸è½½æ—§ç‰ˆæœ¬</p>
</blockquote>
<pre><code class="shell">sudo yum remove docker  docker-common docker-selinux docker-engine</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922204747806.png" class="" title="image-20200922204747806">

<blockquote>
<p>å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…ï¼Œ yum-util æä¾›yum-config-manageråŠŸèƒ½ï¼Œå¦å¤–ä¸¤ä¸ªæ˜¯devicemapperé©±åŠ¨ä¾èµ–çš„</p>
</blockquote>
<pre><code class="shell">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922203530629.png" class="" title="image-20200922203530629">

<blockquote>
<p>è®¾ç½®yumæºï¼ˆä½¿ç”¨é˜¿é‡Œäº‘åœ°å€ï¼‰</p>
</blockquote>
<pre><code class="shell">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922203620500.png" class="" title="image-20200922203620500">

<blockquote>
<p>å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»“åº“ä¸­æ‰€æœ‰çš„dockerç‰ˆæœ¬ï¼Œå¹¶é€‰æ‹©ç‰¹å®šç‰ˆæœ¬å®‰è£…</p>
</blockquote>
<pre><code class="shell">yum list docker-ce --showduplicates | sort -r</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922203726104.png" class="" title="image-20200922203726104">

<blockquote>
<p>å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Docker Engine-Community å’Œ containerd</p>
</blockquote>
<pre><code class="shell">sudo yum install docker-ce docker-ce-cli containerd.io</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922204125206.png" class="" title="image-20200922204125206">

<blockquote>
<p>éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ</p>
</blockquote>
<pre><code class="shell">docker version</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922204248819.png" class="" title="image-20200922204248819">

<blockquote>
<p>å¯åŠ¨Docker</p>
</blockquote>
<pre><code class="shell">sudo systemctl start docker</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922204613291.png" class="" title="image-20200922204613291">

<blockquote>
<p>è¿è¡ŒHello World</p>
</blockquote>
<pre><code class="shell">sudo docker run hello-world</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922204637363.png" class="" title="image-20200922204637363">



<h2 id="2-æ­å»ºHadoopé›†ç¾¤"><a href="#2-æ­å»ºHadoopé›†ç¾¤" class="headerlink" title="2. æ­å»ºHadoopé›†ç¾¤"></a>2. æ­å»ºHadoopé›†ç¾¤</h2><h3 id="1-ä¸‹è½½å¹¶é…ç½®JDK"><a href="#1-ä¸‹è½½å¹¶é…ç½®JDK" class="headerlink" title="1. ä¸‹è½½å¹¶é…ç½®JDK"></a>1. ä¸‹è½½å¹¶é…ç½®JDK</h3><blockquote>
<p>ä¸‹è½½ jdk</p>
</blockquote>
<pre><code class="shell">yum install java-1.8.0-openjdk* -y</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914205909499.png" class="" title="image-20200914205909499">

<blockquote>
<p>è·å–JAVA_HOME</p>
</blockquote>
<pre><code class="shell">dirname $(readlink $(readlink $(which java))) </code></pre>
<blockquote>
<p>é…ç½®ç¯å¢ƒå˜é‡</p>
</blockquote>
<pre><code class="shell">vi /etc/profile

export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.262.b10-0.el7_8.x86_64
export JRE_HOME=$JAVA_HOME/jre
export CLASSPATH=$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH
export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914210707353.png" class="" title="image-20200914210707353">

<blockquote>
<p>æŸ¥çœ‹JAVA_HOME</p>
</blockquote>
<pre><code class="shell">source /etc/profile
echo $JAVA_HOME</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200930135506971.png" class="" title="image-20200930135506971">

<blockquote>
<p>æµ‹è¯•</p>
</blockquote>
<pre><code class="shell">java -version</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200930135637993.png" class="" title="image-20200930135637993">



<h3 id="2-é…ç½®Hostsåˆ—è¡¨"><a href="#2-é…ç½®Hostsåˆ—è¡¨" class="headerlink" title="2. é…ç½®Hostsåˆ—è¡¨"></a>2. é…ç½®Hostsåˆ—è¡¨</h3><p>ç”±äºä¸¤å°è™šæ‹Ÿæœºæ˜¯åŒä¸€å°è™šæ‹Ÿæœºå¤åˆ¶è€Œæ¥ï¼Œæ‰€ä»¥å¿…é¡»å…ˆé‡æ–°ç”ŸæˆMacåœ°å€</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200930135951474.png" class="" title="image-20200930135951474">

<blockquote>
<p>master å’Œ slave ç¦ç”¨é˜²ç«å¢™</p>
</blockquote>
<p>åœæ­¢é˜²ç«å¢™ </p>
<pre><code class="shell">systemctl stop firewalld</code></pre>
<p>ç¦ç”¨é˜²ç«å¢™</p>
<pre><code class="shell">systemctl disable firewalld</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200913225928453.png" class="" title="image-20200913225928453">

<blockquote>
<p>master å’Œ slave ä¿®æ”¹ä¸»æœºå</p>
</blockquote>
<pre><code class="she">vi /etc/sysconfig/network</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200913230804529.png" class="" title="image-20200913230804529">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200913230917724.png" class="" title="image-20200913230917724">

<blockquote>
<p>ç¡®è®¤ä¿®æ”¹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200913231003539.png" class="" title="image-20200913231003539">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200913231047961.png" class="" title="image-20200913231047961">

<blockquote>
<p>master å’Œ slave æ‰§è¡Œ ifconfig æŸ¥è¯¢ IP</p>
</blockquote>
<pre><code class="shell">ifconfig</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914215339951.png" class="" title="image-20200914215339951">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914215731073.png" class="" title="image-20200914215731073">

<blockquote>
<p> master å’Œ slave å°†IPåœ°å€å’Œä¸»æœºååˆ†åˆ«æ·»åŠ è‡³/etc/hostsä¸­</p>
</blockquote>
<pre><code class="shell">vi /etc/hosts</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914215942690.png" class="" title="image-20200914215942690">

<blockquote>
<p>master å’Œ slave ä¹‹é—´äº’ping</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914220102245.png" class="" title="image-20200914220102245">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914220213547.png" class="" title="image-20200914220213547">



<h3 id="3-é›†ç¾¤sshå…å¯†ç™»å½•"><a href="#3-é›†ç¾¤sshå…å¯†ç™»å½•" class="headerlink" title="3. é›†ç¾¤sshå…å¯†ç™»å½•"></a>3. é›†ç¾¤sshå…å¯†ç™»å½•</h3><p>å¯¹masteræ“ä½œï¼š</p>
<blockquote>
<p>master ç”Ÿæˆå…¬é’¥</p>
</blockquote>
<pre><code class="shell">ssh-keygen -t rsa</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914220829338.png" class="" title="image-20200914220829338">

<blockquote>
<p>å°†å…¬é’¥è¿½åŠ åˆ°æˆæƒåˆ—è¡¨</p>
</blockquote>
<pre><code class="shell">cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914221008829.png" class="" title="image-20200914221008829">

<blockquote>
<p>ä¿®æ”¹authorized_keysæ–‡ä»¶çš„æƒé™</p>
</blockquote>
<pre><code class="shell">chmod 600 ~/.ssh/authorized_keys </code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914221036706.png" class="" title="image-20200914221036706">

<blockquote>
<p>å°†authorized_keysæ–‡ä»¶å¤åˆ¶åˆ°slaveèŠ‚ç‚¹</p>
</blockquote>
<pre><code class="shell">scp ~/.ssh/authorized_keys parak@slave:~/.ssh</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914221427275.png" class="" title="image-20200914221427275">

<blockquote>
<p>æŸ¥çœ‹slaveçš„.sshçš„ç›®å½•</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914221514758.png" class="" title="image-20200914221514758">

<blockquote>
<p>ä¿®æ”¹masterå’Œslaveçš„SSHé…ç½®</p>
</blockquote>
<pre><code class="shell">su root
vi /etc/ssh/sshd_config</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914221856072.png" class="" title="image-20200914221856072">

<blockquote>
<p>ä½¿ç”¨ssh-addæŒ‡ä»¤å°†ç§é’¥åŠ å…¥å¹¶é‡å¯sshdæœåŠ¡</p>
</blockquote>
<pre><code class="shell">ssh-add ~/.ssh/id_rsa
service sshd restart</code></pre>
<blockquote>
<p>æµ‹è¯•å…å¯†ç™»å½•</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914223950719.png" class="" title="image-20200914223950719">

<p>sshç™»å½•ä¾ç„¶éœ€è¦å¯†ç ï¼Œæˆ‘ä»¬å¯ä»¥å»çœ‹ä¸€ä¸‹masterçš„æ—¥å¿—æ–‡ä»¶</p>
<blockquote>
<p>cat  var/log/secure </p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200916160625256.png" class="" title="image-20200916160625256">

<blockquote>
<p><strong>åŸå› </strong></p>
<p>sshdä¸ºäº†å®‰å…¨ï¼Œå¯¹å±ä¸»çš„ç›®å½•å’Œæ–‡ä»¶æƒé™æœ‰æ‰€è¦æ±‚ã€‚</p>
<p>å¦‚æœæƒé™ä¸å¯¹ï¼Œåˆ™sshçš„å…å¯†ç ç™»é™†ä¸ç”Ÿæ•ˆã€‚</p>
</blockquote>
<blockquote>
<p><strong>è§£å†³</strong></p>
<p>å°†.sshç›®å½•çš„æƒé™æ”¹ä¸º755</p>
<p>id_rsa.pubå’Œauthorized_keysæƒé™æ”¹ä¸º644</p>
<p>id_rsaæƒé™å¿…é¡»ä¸º600</p>
</blockquote>
<pre><code class="shell">chmod 755 .ssh
cd .ssh
chmod 644 id_rsa.pub authorized_keys
chmod 600 id_rsa</code></pre>
<blockquote>
<p>å†æ¬¡æµ‹è¯•å…å¯†ç™»å½•</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914224837430.png" class="" title="image-20200914224837430">



<h3 id="4-ä¸‹è½½å¹¶é…ç½®Hadoop"><a href="#4-ä¸‹è½½å¹¶é…ç½®Hadoop" class="headerlink" title="4. ä¸‹è½½å¹¶é…ç½®Hadoop"></a>4. ä¸‹è½½å¹¶é…ç½®Hadoop</h3><blockquote>
<p>ä¸‹è½½ï¼š<a href="https://www.apache.org/dyn/closer.cgi/hadoop/common/hadoop-3.3.0/hadoop-3.3.0.tar.gz">hadoop-2.9.2</a>    é€‰æ‹©bsfuçš„åŒ—äº¬å¤–å›½è¯­å­¦é™¢çš„é•œåƒ, é€Ÿåº¦æµæ‰¹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914211714263.png" class="" title="image-20200914211714263">

<blockquote>
<p>è§£å‹ä¸‹è½½çš„å‹ç¼©åŒ…</p>
</blockquote>
<pre><code class="shell">tar -zxvf hadoop-2.3.2.tar.gz</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914211633182.png" class="" title="image-20200914211633182">

<blockquote>
<p>ä¿®æ”¹æ–‡ä»¶æƒé™</p>
</blockquote>
<pre><code class="shell">chmod 777 hadoop-env.sh core-site.xml hdfs-site.xml yarn-site.xml mapred-site.xml slaves</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914212318855.png" class="" title="image-20200914212318855">

<blockquote>
<p>é…ç½®ç¯å¢ƒå˜é‡</p>
</blockquote>
<pre><code class="shell">gedit /home/parak/hadoop/hadoop-2.9.2/etc/hadoop/hadoop-env.sh

æ·»åŠ 
export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.262.b10-0.el7_8.x86_64
export HADOOP_HOME=/home/parak/hadoop/hadoop-2.9.2
export PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;HADOOP_HOME&#125;/bin:$&#123;HADOOP_HOME&#125;/sbin:$PATH</code></pre>
<blockquote>
<p>é…ç½®æ ¸å¿ƒç»„ä»¶  <strong><em>core-site.xml</em></strong></p>
</blockquote>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;
&lt;!--
  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
--&gt;

&lt;!-- Put site-specific property overrides in this file. --&gt;

&lt;configuration&gt;
    &lt;property&gt;
        &lt;name&gt;fs.defaultFS&lt;/name&gt;
        &lt;value&gt;hdfs://master:9000&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;
        &lt;value&gt;/home/parak/hadoopdata&lt;/value&gt;
    &lt;/property&gt;
&lt;/configuration&gt;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914213003704.png" class="" title="image-20200914213003704">

<blockquote>
<p>é…ç½®æ–‡ä»¶ç³»ç»Ÿ  <strong><em>hdfs.site.xml</em></strong></p>
</blockquote>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;
&lt;!--
  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
--&gt;

&lt;!-- Put site-specific property overrides in this file. --&gt;

&lt;configuration&gt;
    &lt;property&gt;
        &lt;name&gt;dfs.replication&lt;/name&gt;
        &lt;value&gt;1&lt;/value&gt;
    &lt;/property&gt;
&lt;/configuration&gt;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914213047280.png" class="" title="image-20200914213047280">

<blockquote>
<p>é…ç½®æ–‡ä»¶ç³»ç»Ÿ  <strong><em>yarn-site.xml</em></strong></p>
</blockquote>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!--
  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
--&gt;
&lt;configuration&gt;

&lt;!-- Site specific YARN configuration properties --&gt;

    &lt;property&gt;
        &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;
        &lt;value&gt;mapreduce_shuffle&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;yarn.resourcemanager.address&lt;/name&gt;
        &lt;value&gt;master:18040&lt;/value&gt;
    &lt;/property&gt;
        &lt;property&gt;
                &lt;name&gt;yarn.resourcemanager.scheduler.address&lt;/name&gt;
                &lt;value&gt;master:18030&lt;/value&gt;
        &lt;/property&gt;
        &lt;property&gt;
            &lt;name&gt;yarn.resourcemanager.resource-tracker.address&lt;/name&gt;
            &lt;value&gt;master:18025&lt;/value&gt;
        &lt;/property&gt;
        &lt;property&gt;
            &lt;name&gt;yarn.resourcemanager.admin.address&lt;/name&gt;
            &lt;value&gt;master:18141&lt;/value&gt;
        &lt;/property&gt;
        &lt;property&gt;
            &lt;name&gt;yarn.resourcemanager.webapp.address&lt;/name&gt;
            &lt;value&gt;master:18088&lt;/value&gt;
        &lt;/property&gt;

&lt;/configuration&gt;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914213215770.png" class="" title="image-20200914213215770">

<blockquote>
<p>é…ç½®è®¡ç®—æ¡†æ¶  <strong><em>mapred-site.xml</em></strong></p>
</blockquote>
<pre><code class="shell">&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;
&lt;!--
  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
--&gt;

&lt;!-- Put site-specific property overrides in this file. --&gt;

&lt;configuration&gt;
    &lt;property&gt;
        &lt;name&gt;mapreduce.framework.name&lt;/name&gt;
        &lt;value&gt;yarn&lt;/value&gt;
    &lt;/property&gt;
&lt;/configuration&gt;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914213254714.png" class="" title="image-20200914213254714">

<blockquote>
<p>åœ¨masterèŠ‚ç‚¹é…ç½®slavesæ–‡ä»¶ </p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914225547865.png" class="" title="image-20200914225547865">



<h3 id="5-å¯åŠ¨Hadooé›†ç¾¤"><a href="#5-å¯åŠ¨Hadooé›†ç¾¤" class="headerlink" title="5. å¯åŠ¨Hadooé›†ç¾¤"></a>5. å¯åŠ¨Hadooé›†ç¾¤</h3><blockquote>
<p>åˆ‡æ¢ç”¨æˆ·  <strong><em>parak</em></strong></p>
</blockquote>
<pre><code class="shell">su parak</code></pre>
<blockquote>
<p>é…ç½®Hadoopå¯åŠ¨çš„ç³»ç»Ÿç¯å¢ƒå˜é‡</p>
</blockquote>
<pre><code class="shell">cd
gedit ~/.bash_profile

æ·»åŠ ï¼š
#HADOOP
export HADOOP_HOME=/home/parak/hadoop/hadoop-2.9.2
export PATH=$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$PATH

æ‰§è¡Œï¼š
source ~/.bash_profile

éªŒè¯ï¼š
echo $&#123;HADOOP_HOME&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914213558226.png" class="" title="image-20200914213558226">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914230053210.png" class="" title="image-20200914230053210">

<blockquote>
<p>åˆ›å»ºæ•°æ®ç›®å½•  <strong><em>hadoopdata</em></strong></p>
</blockquote>
<pre><code class="shell">mkdir /home/parak/hadoopdata
chmod 777 hadoopdata/</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914225858363.png" class="" title="image-20200914225858363">

<blockquote>
<p>æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ</p>
</blockquote>
<pre><code class="shell">hdfs namenode -format</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914230347627.png" class="" title="image-20200914230347627">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914230450.png" class="" title="image-20200914230450">

<blockquote>
<p>å¯åŠ¨Hadoop</p>
</blockquote>
<pre><code class="shell">sbin/start-all.sh</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914232331519.png" class="" title="image-20200914232331519">

<blockquote>
<p>æŸ¥çœ‹è¿›ç¨‹</p>
</blockquote>
<pre><code class="shell">jps</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914232056642.png" class="" title="image-20200914232056642">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914232211741.png" class="" title="image-20200914232211741">



<blockquote>
<p>è¿›å…¥ <strong>FireFox</strong> è¾“å…¥ï¼š<a href="http://master:50070/">http://master:50070/</a>   </p>
<p>æ£€æŸ¥ <strong>namenode</strong> å’Œ <strong>datanode</strong> æ˜¯å¦æ­£å¸¸</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914232603284.png" class="" title="image-20200914232603284">



<blockquote>
<p>è¿›å…¥ <strong>FireFox</strong> è¾“å…¥ï¼š<a href="http://master:18088/">http://master:18088/</a></p>
<p>æ£€æŸ¥ <strong>Yarn</strong> æ˜¯å¦æ­£å¸¸</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200914232824073.png" class="" title="image-20200914232824073">



<blockquote>
<p>è¿è¡ŒPIå®ä¾‹æ£€æŸ¥Hadoopé›†ç¾¤æ˜¯å¦æ­å»ºæˆåŠŸ</p>
</blockquote>
<pre><code class="shell">cd ~/hadoop/hadoop-2.9.2/share/hadoop/mapreduce/
hadoop jar hadoop-mapreduce-examples-2.9.2.jar pi 10 10</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915083538083.png" class="" title="image-20200915083538083">

<blockquote>
<p> <strong>æŠ¥é”™</strong>ï¼šæœªæ‰¾åˆ°ä¸»æœºè·¯ç”±</p>
<p><strong>åˆ†æ</strong>ï¼šslaveçš„é˜²ç«å¢™æ²¡æœ‰å…³é—­</p>
</blockquote>
<blockquote>
<p>æ£€æŸ¥slaveçš„é˜²ç«å¢™</p>
</blockquote>
<pre><code class="shell">systemctl status firewalld</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915084136061.png" class="" title="image-20200915084136061">

<blockquote>
<p>å…³é—­ä¸”ç¦ç”¨é˜²ç«å¢™</p>
</blockquote>
<pre><code class="shell">systemctl stop firewalld
systemctl disable firewalld</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915084354244.png" class="" title="image-20200915084354244">

<blockquote>
<p>å†æ¬¡è¿è¡ŒPIå®ä¾‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915084909905.png" class="" title="image-20200915084909905">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915084933355.png" class="" title="image-20200915084933355">

<p>å¯ä»¥çœ‹åˆ°è¿è¡Œç»“æœï¼šPI = 3.20000000000000000000</p>
<p><strong>ç»¼ä¸Šï¼Œé›†ç¾¤æ­£å¸¸å¯åŠ¨</strong></p>
<blockquote>
<p>å…³é—­Hadoopé›†ç¾¤</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915085606053.png" class="" title="image-20200915085606053">





<h2 id="3-åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„æ“ä½œ"><a href="#3-åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„æ“ä½œ" class="headerlink" title="3. åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„æ“ä½œ"></a>3. åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„æ“ä½œ</h2><h3 id="1-åˆ©ç”¨Shellå‘½ä»¤ä¸HDFSè¿›è¡Œäº¤äº’"><a href="#1-åˆ©ç”¨Shellå‘½ä»¤ä¸HDFSè¿›è¡Œäº¤äº’" class="headerlink" title="1. åˆ©ç”¨Shellå‘½ä»¤ä¸HDFSè¿›è¡Œäº¤äº’"></a>1. åˆ©ç”¨Shellå‘½ä»¤ä¸HDFSè¿›è¡Œäº¤äº’</h3><pre><code class="shell">hadoop fs    //é€‚ç”¨äºä»»ä½•ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå’ŒHDFSæ–‡ä»¶ç³»ç»Ÿ
hadoop dfa   //åªèƒ½é€‚ç”¨äºHDFSæ–‡ä»¶ç³»ç»Ÿ
hdfs dfs     //è·Ÿhadoop dfsçš„å‘½ä»¤ä½œç”¨ä¸€æ ·ï¼Œä¹Ÿåªèƒ½é€‚ç”¨äºHDFSæ–‡ä»¶ç³»ç»Ÿ</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915091307833.png" class="" title="image-20200915091307833">

<pre><code class="shell">hadoop fs -help put</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915091423474.png" class="" title="image-20200915091423474">



<h4 id="1-ç›®å½•æ“ä½œ"><a href="#1-ç›®å½•æ“ä½œ" class="headerlink" title="(1) ç›®å½•æ“ä½œ"></a>(1) ç›®å½•æ“ä½œ</h4><blockquote>
<p>åœ¨HDFSä¸­ä¸ºparakç”¨æˆ·åˆ›å»ºä¸€ä¸ªç”¨æˆ·ç›®å½•ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
</blockquote>
<pre><code class="shell">hadoop fs -mkdir -p /user/parak</code></pre>
<blockquote>
<p>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ˜¾ç¤ºHDFSä¸­/userç›®å½•ä¸‹çš„å†…å®¹ï¼š</p>
</blockquote>
<pre><code class="shell">hadoop fs -ls /user</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915091936795.png" class="" title="image-20200915091936795">

<blockquote>
<p>åˆ›å»º/user/parak/inputç›®å½•</p>
</blockquote>
<pre><code class="shell">hadoop fs -mkdir -p /user/parak/input</code></pre>
<blockquote>
<p>æŸ¥çœ‹/user/parak/inputç›®å½•æ˜¯å¦åˆ›å»ºæˆåŠŸ</p>
</blockquote>
<pre><code class="shell">hadoop fs -ls /user/parak</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915094202790.png" class="" title="image-20200915094202790">

<blockquote>
<p>åˆ›å»º/inputç›®å½•</p>
</blockquote>
<pre><code class="shell">hadoop fs -mkdir -p /input</code></pre>
<blockquote>
<p>åˆ é™¤/inputç›®å½•</p>
</blockquote>
<pre><code class="shell"> hadoop fs -rm -r /input</code></pre>
<blockquote>
<p>æŸ¥çœ‹/inputç›®å½•æ˜¯å¦åˆ é™¤æˆåŠŸ</p>
</blockquote>
<pre><code class="shell">hadoop fs -ls /</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915094415033.png" class="" title="image-20200915094415033">



<h4 id="2-æ–‡ä»¶æ“ä½œ"><a href="#2-æ–‡ä»¶æ“ä½œ" class="headerlink" title="(2) æ–‡ä»¶æ“ä½œ"></a>(2) æ–‡ä»¶æ“ä½œ</h4><p>â€‹       åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç»å¸¸éœ€è¦ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå‘HDFSä¸­ä¸Šä¼ æ–‡ä»¶ï¼Œæˆ–è€…æŠŠHDFSä¸­çš„æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p>
<blockquote>
<p>é¦–å…ˆï¼Œä½¿ç”¨vimç¼–è¾‘å™¨ï¼Œåœ¨æœ¬åœ°Linuxæ–‡ä»¶ç³»ç»Ÿçš„â€œ/home/parak/â€ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶myLocalFile.txtï¼Œé‡Œé¢è¾“å…¥ï¼š</p>
</blockquote>
<pre><code class="text">Hadoop
MapReduce
Spark
Khighness</code></pre>
<blockquote>
<p>ç„¶åï¼ŒæŠŠæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„â€œ/home/parak/myLocalFile.txtâ€ä¸Šä¼ åˆ°HDFSä¸­çš„å½“å‰ç”¨æˆ·ç›®å½•çš„inputç›®å½•ä¸‹ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¼ åˆ°HDFSçš„â€œ/user/parak/input/â€ç›®å½•ä¸‹ï¼š</p>
</blockquote>
<pre><code class="shell">hadoop fs -put /home/parak/myLocalFile.txt /user/parak/input</code></pre>
<blockquote>
<p>æŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸Šä¼ åˆ°HDFSä¸­ï¼š</p>
</blockquote>
<pre><code class="shell">hadoop fs -ls /user/parak/input</code></pre>
<blockquote>
<p>æŸ¥çœ‹HDFSä¸­çš„myLocalFile.txtè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹</p>
</blockquote>
<pre><code class="shell">hadoop fs -cat /user/parak/input/myLocalFile.txt</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915094905208.png" class="" title="image-20200915094905208">

<blockquote>
<p>æŠŠHDFSä¸­çš„myLocalFile.txtæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„â€œ/home/parak/ä¸‹è½½/â€è¿™ä¸ªç›®å½•ä¸‹</p>
</blockquote>
<pre><code class="shell">hadoop fs -get /user/parak/input/myLocalFile.txt /home/parak/ä¸‹è½½</code></pre>
<blockquote>
<p>åœ¨æœ¬åœ°æŸ¥çœ‹ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶myLocalFile.txt</p>
</blockquote>
<pre><code class="shell">cd ä¸‹è½½
ll
cat myLocalFile.txt</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915100241999.png" class="" title="image-20200915100241999">

<blockquote>
<p>æŠŠHDFSçš„â€œ/user/parak/input/myLocalFile.txtâ€æ–‡ä»¶ï¼Œæ‹·è´åˆ°HDFSçš„å¦å¤–ä¸€ä¸ªç›®å½•â€œ/inputâ€ä¸­</p>
</blockquote>
<pre><code class="shell">hadoop fs -mkdir /input
hadoop fs -cp /user/parak/input/myLocalFile.txt /input</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915100148440.png" class="" title="image-20200915100148440">



<h3 id="2-åˆ©ç”¨Webç•Œé¢ç®¡ç†HDFS"><a href="#2-åˆ©ç”¨Webç•Œé¢ç®¡ç†HDFS" class="headerlink" title="2. åˆ©ç”¨Webç•Œé¢ç®¡ç†HDFS"></a>2. åˆ©ç”¨Webç•Œé¢ç®¡ç†HDFS</h3><blockquote>
<p>åœ¨æœ¬æœºChormeè¾“å…¥ <a href="http://192.168.117.141:50070/">http://192.168.117.141:50070</a> , å³å¯çœ‹åˆ°HDFSçš„Webç®¡ç†ç•Œé¢</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915093904228.png" class="" title="image-20200915093904228">





<h2 id="4-åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„ç¼–ç¨‹å®è·µ"><a href="#4-åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„ç¼–ç¨‹å®è·µ" class="headerlink" title="4. åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„ç¼–ç¨‹å®è·µ"></a>4. åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFSä¸Šçš„ç¼–ç¨‹å®è·µ</h2><h3 id="1-å®‰è£…Eclipse"><a href="#1-å®‰è£…Eclipse" class="headerlink" title="1. å®‰è£…Eclipse"></a>1. å®‰è£…Eclipse</h3><h4 id="1-å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…"><a href="#1-å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…" class="headerlink" title="(1) å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…"></a>(1) å®˜ç½‘ä¸‹è½½å®‰è£…åŒ…</h4><blockquote>
<p>è¿›å…¥FireFoxæ‰“å¼€ä¸‹è½½: <a href="http://www.eclipse.org/downloads/packages/release/neon/1a/eclipse-ide-java-ee-developers">eclipe</a></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915190751901.png" class="" title="image-20200915190751901">

<blockquote>
<p>æˆ–è€…</p>
<p>ç™¾åº¦ç½‘ç›˜ä¸‹è½½</p>
<p>é“¾æ¥: <a href="https://pan.baidu.com/s/1P4vDgBEj_eOSakabM93rew">https://pan.baidu.com/s/1P4vDgBEj_eOSakabM93rew</a></p>
<p>å¯†ç : eujp</p>
</blockquote>
<h4 id="2-è§£å‹å®‰è£…åŒ…"><a href="#2-è§£å‹å®‰è£…åŒ…" class="headerlink" title="(2) è§£å‹å®‰è£…åŒ…"></a>(2) è§£å‹å®‰è£…åŒ…</h4><pre><code class="shell">tar xzvf eclipse-inst-linux64.tar.gz 
cd eclipse-installer/
ll</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915191250751.png" class="" title="image-20200915191250751">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915191446018.png" class="" title="image-20200915191446018">

<h4 id="3-å®‰è£…Eclipse-For-JavaEE"><a href="#3-å®‰è£…Eclipse-For-JavaEE" class="headerlink" title="(3) å®‰è£…Eclipse For JavaEE"></a>(3) å®‰è£…Eclipse For JavaEE</h4><pre><code class="shell">eclipse-inst.ini</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915191721107.png" class="" title="image-20200915191721107.png">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915191841247.png" class="" title="image-20200915191841247.png">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915192946961.png" class="" title="image-20200915192946961.png">



<h4 id="4-åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼"><a href="#4-åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼" class="headerlink" title="(4) åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼"></a>(4) åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼</h4><blockquote>
<p>1ã€åˆ‡æ¢rootèº«ä»½ï¼šsu root</p>
<p>2ã€è¿›å…¥usr/share/applicationsç›®å½•ï¼šcd /usr/share/applications</p>
<p>3ã€åˆ›å»ºeclipase.desktopæ–‡ä»¶ï¼štouch eclipase.desktop</p>
<p>4ã€è¾“å…¥ä»¥ä¸‹å†…å®¹åä¿å­˜ï¼švi eclipase.desktop</p>
<p>5ã€æœ€åå°†å¿«æ·æ–¹å¼å¤åˆ¶åˆ°æ¡Œé¢ï¼Œå¹¶æ·»åŠ ä¿¡ä»»å³å¯</p>
</blockquote>
<pre><code class="desktop">[Desktop Entry]
Name=Eclipse
Exec=/home/parak/eclipse/eclipse-j2e/eclipse/eclipse
Type=Application
Icon=/home/parak/eclipse/eclipse-j2e/eclipse/icon.xpm
Terminal=false</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915195019210.png" class="" title="image-20200915195019210">



<h3 id="2-åˆ›å»ºeclipseå·¥ç¨‹"><a href="#2-åˆ›å»ºeclipseå·¥ç¨‹" class="headerlink" title="2. åˆ›å»ºeclipseå·¥ç¨‹"></a>2. åˆ›å»ºeclipseå·¥ç¨‹</h3><blockquote>
<p>åŒå‡»eclipseæ¡Œé¢å¿«æ·æ–¹å¼</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915195625107.png" class="" title="image-20200915195625107">

<blockquote>
<p>è¿›å…¥eclipseIDE</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915195720416.png" class="" title="image-20200915195720416">

<blockquote>
<p>ç‚¹å‡»ï¼šFile â€”&gt; Project â€”&gt; Java Project</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915200231455.png" class="" title="image-20200915200231455">

<blockquote>
<p>è®¾ç½®JRE</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915200448059.png" class="" title="image-20200915200448059">

<blockquote>
<p>æ·»åŠ JAR</p>
</blockquote>
<ul>
<li><strong>/home/parak/hadoop/hadoop-2.9.2/share/hadoop/common/</strong>:  <strong>hadoop-common-2.9.2.jar</strong>å’Œ<strong>hadoop-nfs-2.9.2.jar</strong></li>
<li><strong>/home/parak/hadoop/hadoop-2.9.2/share/hadoop/common/</strong>:  <strong>lib</strong>ç›®å½•ä¸‹çš„æ‰€æœ‰jaråŒ…</li>
<li><strong>/home/parak/hadoop/hadoop-2.9.2/share/hadoop/hdfs/</strong>:  <strong>hadoop-hdfs-2.9.2.jar</strong>å’Œ<strong>hadoop-hdfs-nfs-2.9.2.jar</strong></li>
<li><strong>/home/parak/hadoop/hadoop-2.9.2/share/hadoop/hdfs/</strong>:  <strong>lib</strong>ç›®å½•ä¸‹çš„æ‰€æœ‰jaråŒ…</li>
</ul>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915202106984.png" class="" title="image-20200915202106984">

<blockquote>
<p>ç‚¹å‡»Finishï¼Œç‚¹å‡»Open Perspectiveï¼Œå¹¶ä¸”å‹¾é€‰Remember my decision</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915202239806.png" class="" title="image-20200915202239806">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915202452808.png" class="" title="image-20200915202452808">



<h3 id="3-ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºæ£€æµ‹HDFSä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶"><a href="#3-ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºæ£€æµ‹HDFSä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶" class="headerlink" title="3. ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºæ£€æµ‹HDFSä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶"></a>3. ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºæ£€æµ‹HDFSä¸­æ˜¯å¦å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶</h3><h4 id="1-ç¼–å†™Javaç¨‹åº"><a href="#1-ç¼–å†™Javaç¨‹åº" class="headerlink" title="(1) ç¼–å†™Javaç¨‹åº"></a>(1) ç¼–å†™Javaç¨‹åº</h4><blockquote>
<p>å³å‡»HDFSExample â€”&gt; New â€”&gt; Class</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915203644447.png" class="" title="image-20200915203644447">

<blockquote>
<p>Name = HDFSFileIfExistï¼Œç„¶åFinish</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915203811679.png" class="" title="image-20200915203811679">

<blockquote>
<p>ç¼–å†™ä»£ç </p>
</blockquote>
<pre><code class="java">import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.FileSystem;
import org.apache.hadoop.fs.Path;

/**
 * @author parak
 * @date   2020-9-15 
 */
public class HDFSFileIfExist &#123;
    public static void main(String[] args)&#123;
        try&#123;
            String fileName = &quot;/user/parak/input/myLocalFile.txt&quot;;
            Configuration conf = new Configuration();
            conf.set(&quot;fs.defaultFS&quot;, &quot;hdfs://master:9000&quot;);
            conf.set(&quot;fs.hdfs.impl&quot;, &quot;org.apache.hadoop.hdfs.DistributedFileSystem&quot;);
            FileSystem fs = FileSystem.get(conf);
            if(fs.exists(new Path(fileName)))&#123;
                System.out.println(&quot;æ–‡ä»¶å­˜åœ¨&quot;);
            &#125;else&#123;
                System.out.println(&quot;æ–‡ä»¶ä¸å­˜åœ¨&quot;);
            &#125;
        &#125;catch (Exception e)&#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;</code></pre>
<h4 id="2-è¿è¡Œç¨‹åº"><a href="#2-è¿è¡Œç¨‹åº" class="headerlink" title="(2) è¿è¡Œç¨‹åº"></a>(2) è¿è¡Œç¨‹åº</h4><blockquote>
<p>å¯åŠ¨Hadoopé›†ç¾¤</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915204824967.png" class="" title="image-20200915204824967">

<blockquote>
<p>è¿è¡Œç¨‹åº</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915205051079.png" class="" title="image-20200915205051079">

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915205218013.png" class="" title="image-20200915205218013">

<h4 id="3-éƒ¨ç½²åˆ°Hadoopå¹³å°ä¸Šè¿è¡Œ"><a href="#3-éƒ¨ç½²åˆ°Hadoopå¹³å°ä¸Šè¿è¡Œ" class="headerlink" title="(3) éƒ¨ç½²åˆ°Hadoopå¹³å°ä¸Šè¿è¡Œ"></a>(3) éƒ¨ç½²åˆ°Hadoopå¹³å°ä¸Šè¿è¡Œ</h4><blockquote>
<p>åœ¨hadoopå®‰è£…ç›®å½•ä¸‹æ–°å»ºmyappç›®å½•ï¼Œå­˜æ”¾Hadoopåº”ç”¨ç¨‹åº</p>
</blockquote>
<pre><code class="shell">mkdir ~/hadoop/hadoop-2.9.2/myapp</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915205811634.png" class="" title="image-20200915205811634">

<blockquote>
<p>å³å‡»HDFSExample â€”&gt; Export â€”&gt; Java â€”&gt; Runnable JAR file â€”&gt; Next</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915210022617.png" class="" title="image-20200915210022617">

<blockquote>
<p>Lauch configuration: HDFSFileIfExist -HDFSExsmple</p>
<p>Export destination: /home/parak/hadoop/hadoop-2.9.2/myapp/HDFSExample.jar</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915210640358.png" class="" title="image-20200915210640358">

<blockquote>
<p>å‡ºç°è­¦å‘Šï¼Œé€‰æ‹©OK</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915210911473.png" class="" title="image-20200915210911473">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915211215820.png" class="" title="image-20200915211215820">

<blockquote>
<p>æŸ¥çœ‹myappä¸­ç”Ÿæˆçš„HDFSExample.jaræ–‡ä»¶</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915211618901.png" class="" title="image-20200915211618901">

<blockquote>
<p>è¿è¡Œç¨‹åº</p>
</blockquote>
<pre><code class="shell">java -jar ~/hadoop/hadoop-2.9.2/myapp/HDFSExample.jar </code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915211802010.png" class="" title="image-20200915211802010">



<h3 id="4-ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºè¯»-å†™HDFSæ–‡ä»¶"><a href="#4-ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºè¯»-å†™HDFSæ–‡ä»¶" class="headerlink" title="4. ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºè¯»/å†™HDFSæ–‡ä»¶"></a>4. ç¼–å†™ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºè¯»/å†™HDFSæ–‡ä»¶</h3><h4 id="1-è¯»å–HDFSæ–‡ä»¶ç¨‹åº"><a href="#1-è¯»å–HDFSæ–‡ä»¶ç¨‹åº" class="headerlink" title="(1) è¯»å–HDFSæ–‡ä»¶ç¨‹åº"></a>(1) è¯»å–HDFSæ–‡ä»¶ç¨‹åº</h4><pre><code class="java">import org.apache.hadoop.fs.Path;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.FSDataInputStream;
import org.apache.hadoop.fs.FileSystem;

/**
 * @author parak
 * @date 2020-9-15
 */
public class HDFSReadFile &#123;
    public static void main(String[] args) &#123;
        try &#123;
            Configuration conf = new Configuration();
            conf.set(&quot;fs.defaultFS&quot;, &quot;hdfs://master:9000&quot;);
            conf.set(&quot;fs.hdfs.impl&quot;,
                    &quot;org.apache.hadoop.hdfs.DistributedFileSystem&quot;);
            FileSystem fs = FileSystem.get(conf);
            Path file = new Path(&quot;/user/parak/input/myLocalFile.txt&quot;);
            FSDataInputStream getIt = fs.open(file);
            BufferedReader d = new BufferedReader(new InputStreamReader(getIt));
            String content = null;
            while((content = d.readLine()) != null) &#123;
                System.out.println(content);
            &#125;
            d.close(); // å…³é—­æ–‡ä»¶
            fs.close(); // å…³é—­hdfs
        &#125; catch (Exception e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915213406899.png" class="" title="image-20200915213406899">

<h4 id="2-å†™HDFSæ–‡ä»¶ç¨‹åº"><a href="#2-å†™HDFSæ–‡ä»¶ç¨‹åº" class="headerlink" title="(2) å†™HDFSæ–‡ä»¶ç¨‹åº"></a>(2) å†™HDFSæ–‡ä»¶ç¨‹åº</h4><pre><code class="java">import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.FileSystem;
import org.apache.hadoop.fs.FSDataOutputStream;
import org.apache.hadoop.fs.Path;

/**
* @author parak
* @date 2020-9-15
*/
public class HDFSWriteFile &#123;
   public static void main(String[] args) &#123;
       try &#123;
           Configuration conf = new Configuration();
           conf.set(&quot;fs.defaultFS&quot;, &quot;hdfs://master:9000&quot;);
           conf.set(&quot;fs.hdfs.impl&quot;,
                   &quot;org.apache.hadoop.hdfs.DistributedFileSystem&quot;);
           FileSystem fs = FileSystem.get(conf);
           byte[] buff = &quot;Hello, Khighness&quot;.getBytes(); // è¦å†™å…¥çš„å†…å®¹
           String filename = &quot;/user/parak/test.txt&quot;; // è¦å†™å…¥çš„æ–‡ä»¶å
           FSDataOutputStream os = fs.create(new Path(filename));
           os.write(buff, 0, buff.length);
           System.out.println(&quot;Create:&quot; + filename);
           os.close();
           fs.close();
       &#125; catch (Exception e) &#123;
           e.printStackTrace();
       &#125;
   &#125;
&#125;</code></pre>
<blockquote>
<p>è¿è¡Œ</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200915213012019.png" class="" title="image-20200915213012019">



<h2 id="5-Eclipseä¸Šçš„HDFSæ“ä½œ"><a href="#5-Eclipseä¸Šçš„HDFSæ“ä½œ" class="headerlink" title="5. Eclipseä¸Šçš„HDFSæ“ä½œ"></a>5. Eclipseä¸Šçš„HDFSæ“ä½œ</h2><h3 id="1-å®‰è£…Hadoop-Eclipse-Plugin"><a href="#1-å®‰è£…Hadoop-Eclipse-Plugin" class="headerlink" title="1. å®‰è£…Hadoop-Eclipse-Plugin"></a>1. å®‰è£…Hadoop-Eclipse-Plugin</h3><p>(1) ä¸‹è½½ç›¸å…³æ’ä»¶ï¼š<a href="https://github.com/winghc/hadoop2x-eclipse-plugin">hadoop-eclipse-plugin</a></p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922203150692.png" class="" title="image-20200922203150692">

<p>æˆ‘æ˜¯vpnä¸‹è½½ä¸‹æ¥çš„ï¼Œåˆ†äº«ä¸€ä¸‹ï¼š</p>
<blockquote>
<p>å®Œæ•´åŒ…</p>
<p>ç½‘ç›˜é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1Q72HyCSUnh-Q0JRQK03Jjg">https://pan.baidu.com/s/1Q72HyCSUnh-Q0JRQK03Jjg</a></p>
<p>æå–ç ï¼škkkk</p>
<p>æ’ä»¶åŒ…</p>
<p>ç½‘ç›˜é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1dfBm7JB4ZXTR3bwF7PSaKA">https://pan.baidu.com/s/1dfBm7JB4ZXTR3bwF7PSaKA</a></p>
<p>æå–ç ï¼škkkk</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922222447098.png" class="" title="image-20200922222447098">



<p>(2) ä¸‹è½½åå°†releaseä¸­çš„<code>hadoop-eclipse-plugin-2.6.0.jar</code>å¤åˆ¶åˆ° Eclipse å®‰è£…ç›®å½•çš„ plugins æ–‡ä»¶å¤¹ä¸­</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200922223813270.png" class="" title="image-20200922223813270">

<p>(3) è¿è¡Œ <code>eclipse-clean</code> é‡å¯ Eclipse</p>
<h3 id="2-é…ç½®Hadoop-Eclipse-Plugin"><a href="#2-é…ç½®Hadoop-Eclipse-Plugin" class="headerlink" title="2. é…ç½®Hadoop-Eclipse-Plugin"></a>2. é…ç½®Hadoop-Eclipse-Plugin</h3><p>é…ç½®å‰å¼€å¯Hadoop</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928131439434.png" class="" title="image-20200928131439434">

<p>(1) åˆ‡æ¢åˆ°â€œMap/Reduceâ€å¼€å‘è§†å›¾</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928131546990.png" class="" title="image-20200928131546990">



<p>(2) å»ºç«‹ä¸Hadoopé›†ç¾¤çš„è¿æ¥</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928131720837.png" class="" title="image-20200928131720837">

<p>(3) å¡«å†™Hadoopè¿æ¥é…ç½®</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928131907971.png" class="" title="image-20200928131907971">



<h3 id="3-åœ¨Eclipseä¸­æ“ä½œHDFSä¸­çš„æ–‡ä»¶"><a href="#3-åœ¨Eclipseä¸­æ“ä½œHDFSä¸­çš„æ–‡ä»¶" class="headerlink" title="3. åœ¨Eclipseä¸­æ“ä½œHDFSä¸­çš„æ–‡ä»¶"></a>3. åœ¨Eclipseä¸­æ“ä½œHDFSä¸­çš„æ–‡ä»¶</h3><p>ç‚¹å‡»å·¦ä¾§DFS Locationså³å¯æŸ¥çœ‹HDFSçš„æ–‡ä»¶åˆ—è¡¨</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928132219334.png" class="" title="image-20200928132219334">



<h2 id="6-åœ¨Eclipseä¸­è¿è¡Œâ€Wold-Countâ€MapReduceç¨‹åº"><a href="#6-åœ¨Eclipseä¸­è¿è¡Œâ€Wold-Countâ€MapReduceç¨‹åº" class="headerlink" title="6. åœ¨Eclipseä¸­è¿è¡Œâ€Wold Countâ€MapReduceç¨‹åº"></a>6. åœ¨Eclipseä¸­è¿è¡Œâ€Wold Countâ€MapReduceç¨‹åº</h2><h3 id="1-åœ¨Eclipseä¸­åˆ›å»ºâ€WordCountâ€MapReduceé¡¹ç›®"><a href="#1-åœ¨Eclipseä¸­åˆ›å»ºâ€WordCountâ€MapReduceé¡¹ç›®" class="headerlink" title="1. åœ¨Eclipseä¸­åˆ›å»ºâ€WordCountâ€MapReduceé¡¹ç›®"></a>1. åœ¨Eclipseä¸­åˆ›å»ºâ€WordCountâ€MapReduceé¡¹ç›®</h3><blockquote>
<p>é€‰æ‹©File -&gt; New -&gt; Project -&gt; Map/Reduce Project</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928133415156.png" class="" title="image-20200928133415156">

<blockquote>
<p>é¡¹ç›®åç§°=MyWordCountï¼Œç„¶åConfigure Hadoop install directory -&gt; Finish</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928133508525.png" class="" title="image-20200928133508525">

<blockquote>
<p>æ–°å»ºJavaæ–‡ä»¶ï¼Œname = WordCountTest</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928134118935.png" class="" title="image-20200928134118935">

<blockquote>
<p>ä»£ç å¦‚ä¸‹</p>
</blockquote>
<pre><code class="java">import java.io.IOException;
import java.util.Iterator;
import java.util.StringTokenizer;
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.Path;
import org.apache.hadoop.io.IntWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Job;
import org.apache.hadoop.mapreduce.Mapper;
import org.apache.hadoop.mapreduce.Reducer;
import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;
import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;
import org.apache.hadoop.util.GenericOptionsParser;

/**
 * @author parak
 * @date   2020-9-28
 */
public class WordCountTest &#123;
    public WordCountTest() &#123;
    &#125;

    public static void main(String[] args) throws Exception &#123;
        Configuration conf = new Configuration();
        String[] otherArgs = (new GenericOptionsParser(conf, args)).getRemainingArgs();
        if(otherArgs.length &lt; 2) &#123;
            System.err.println(&quot;Usage: wordcount &lt;in&gt; [&lt;in&gt;...] &lt;out&gt;&quot;);
            System.exit(2);
        &#125;

        Job job = Job.getInstance(conf, &quot;word count test&quot;);
        job.setJarByClass(WordCountTest.class);
        job.setMapperClass(WordCountTest.TokenizerMapper.class);
        job.setCombinerClass(WordCountTest.IntSumReducer.class);
        job.setReducerClass(WordCountTest.IntSumReducer.class);
        job.setOutputKeyClass(Text.class);
        job.setOutputValueClass(IntWritable.class);

        for(int i = 0; i &lt; otherArgs.length - 1; ++i) &#123;
            FileInputFormat.addInputPath(job, new Path(otherArgs[i]));

        FileOutputFormat.setOutputPath(job, new Path(otherArgs[otherArgs.length - 1]));
        System.exit(job.waitForCompletion(true)?0:1);
    &#125;

    public static class IntSumReducer extends Reducer&lt;Text, IntWritable, Text, IntWritable&gt; &#123;
        private IntWritable result = new IntWritable();

        public IntSumReducer() &#123;
        &#125;

        public void reduce(Text key, Iterable&lt;IntWritable&gt; values, Reducer&lt;Text, IntWritable, Text, IntWritable&gt;.Context context) throws IOException, InterruptedException &#123;
            int sum = 0;

            IntWritable val;
            for(Iterator itr = values.iterator(); itr.hasNext(); sum += val.get()) &#123;
                val = (IntWritable)itr.next();
            &#125;

            this.result.set(sum);
            context.write(key, this.result);
        &#125;
    &#125;

    public static class TokenizerMapper extends Mapper&lt;Object, Text, Text, IntWritable&gt; &#123;
        private static final IntWritable one = new IntWritable(1);
        private Text word = new Text();

        public TokenizerMapper() &#123;
        &#125;

        public void map(Object key, Text value, Mapper&lt;Object, Text, Text, IntWritable&gt;.Context context) throws IOException, InterruptedException &#123;
            StringTokenizer itr = new StringTokenizer(value.toString());

            while(itr.hasMoreTokens()) &#123;
                this.word.set(itr.nextToken());
                context.write(this.word, one);
            &#125;

        &#125;
    &#125;
&#125;</code></pre>
<h3 id="2-æ·»åŠ log4j-propertiesé…ç½®æ–‡ä»¶åˆ°srcç›®å½•ä¸‹"><a href="#2-æ·»åŠ log4j-propertiesé…ç½®æ–‡ä»¶åˆ°srcç›®å½•ä¸‹" class="headerlink" title="2. æ·»åŠ log4j.propertiesé…ç½®æ–‡ä»¶åˆ°srcç›®å½•ä¸‹"></a>2. æ·»åŠ log4j.propertiesé…ç½®æ–‡ä»¶åˆ°srcç›®å½•ä¸‹</h3><blockquote>
<p>æ–°å»ºæ–‡ä»¶</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928205438905.png" class="" title="image-20200928205438905">

<blockquote>
<p>å†…å®¹å¦‚ä¸‹</p>
</blockquote>
<pre><code class="properties">log4j.rootLogger = INFO,KAG,CONSOLE

log4j.appender.KAG.Threshold=INFO
log4j.appender.KAG.encoding=UTF-8

log4j.appender.KAG = org.apache.log4j.DailyRollingFileAppender
log4j.appender.KAG.File=log/sHadoop.log
log4j.appender.KAG.ImmediateFlush=true
log4j.appender.KAG.DatePattern=&#39;_&#39;yyyy-MM-dd
log4j.appender.KAG.layout=org.apache.log4j.PatternLayout
log4j.appender.KAG.layout.ConversionPattern=%-d&#123;yyyy-MM-dd HH:mm:ss&#125; KAG %-5p [%c] - %m%n

log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender
log4j.appender.Threshold=INFO

log4j.appender.CONSOLE.Target=System.out
log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout
log4j.appender.CONSOLE.layout.ConversionPattern=%-d&#123;yyyy-MM-dd HH:mm:ss&#125; KAG %-5p [%c] - %m%n</code></pre>
<h3 id="3-é€šè¿‡Eclipseè¿è¡Œâ€œMyWordCountâ€-MapReduceé¡¹ç›®"><a href="#3-é€šè¿‡Eclipseè¿è¡Œâ€œMyWordCountâ€-MapReduceé¡¹ç›®" class="headerlink" title="3. é€šè¿‡Eclipseè¿è¡Œâ€œMyWordCountâ€ MapReduceé¡¹ç›®"></a>3. é€šè¿‡Eclipseè¿è¡Œâ€œMyWordCountâ€ MapReduceé¡¹ç›®</h3><blockquote>
<p>æ›´æ”¹è¿è¡Œé…ç½®</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928183606296.png" class="" title="image-20200928183606296"> 

<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928184930876.png" class="" title="image-20200928184930876">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928184947160.png" class="" title="image-20200928184947160">

<blockquote>
<p>æŸ¥çœ‹/user/parak/outputç›®å½•ï¼Œå’Œç›®å½•ä¸‹çš„æ–‡ä»¶</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928185257730.png" class="" title="image-20200928185257730">

<blockquote>
<p>é‡å¯Eclipseï¼Œåœ¨Eclipseä¸­æŸ¥çœ‹HDFSæ–‡ä»¶ç³»ç»Ÿï¼Œ/user/parak/output</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928185548345.png" class="" title="image-20200928185548345">



<h3 id="4-åœ¨Hadoopå¹³å°ä¸Šéƒ¨ç½²WordCountç¨‹åº"><a href="#4-åœ¨Hadoopå¹³å°ä¸Šéƒ¨ç½²WordCountç¨‹åº" class="headerlink" title="4. åœ¨Hadoopå¹³å°ä¸Šéƒ¨ç½²WordCountç¨‹åº"></a>4. åœ¨Hadoopå¹³å°ä¸Šéƒ¨ç½²WordCountç¨‹åº</h3><blockquote>
<p>å³é”® WordCountTest â€”&gt; Export</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928205719777.png" class="" title="image-20200928205719777">

<blockquote>
<p>é€‰æ‹© Java â€”&gt; Runnable JAR File â€”&gt; Next</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928205756522.png" class="" title="image-20200928205756522">

<blockquote>
<p>å¡«å…¥å†…å®¹ï¼š</p>
<p>Lauch configuration: WordCountTest - MyWordCount</p>
<p>Export destination: /home/parak/hadoop/hadoop-2.9.2/myapp/WordCount.jar</p>
<p>ç„¶åFinishå³å¯</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928210235072.png" class="" title="image-20200928210235072">

<blockquote>
<p>è¿è¡Œç¨‹åº</p>
</blockquote>
<pre><code class="java">java -jar /home/parak/hadoop/hadoop-2.9.2/myapp/WordCount.jar</code></pre>
<h2 id="7-ç»Ÿè®¡æŸç”µå•†ç½‘ç«™ä¹°å®¶æ”¶è—å•†å“æ•°é‡"><a href="#7-ç»Ÿè®¡æŸç”µå•†ç½‘ç«™ä¹°å®¶æ”¶è—å•†å“æ•°é‡" class="headerlink" title="7. ç»Ÿè®¡æŸç”µå•†ç½‘ç«™ä¹°å®¶æ”¶è—å•†å“æ•°é‡"></a>7. ç»Ÿè®¡æŸç”µå•†ç½‘ç«™ä¹°å®¶æ”¶è—å•†å“æ•°é‡</h2><p><strong>è¦æ±‚</strong></p>
<p>ç°æœ‰æŸç”µå•†ç½‘ç«™ç”¨æˆ·å¯¹å•†å“çš„æ”¶è—æ•°æ®ï¼Œè®°å½•äº†ç”¨æˆ·æ”¶è—çš„å•†å“idä»¥åŠæ”¶è—æ—¥æœŸï¼Œåä¸ºbuyer_favorite1ã€‚buyer_favorite1åŒ…å«ï¼šä¹°å®¶idï¼Œå•†å“idï¼Œæ”¶è—æ—¥æœŸè¿™ä¸‰ä¸ªå­—æ®µï¼Œæ•°æ®ä»¥â€œ\tâ€åˆ†å‰²ï¼Œæ ·æœ¬æ•°æ®åŠæ ¼å¼å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>ä¹°å®¶id  å•†å“id  æ”¶è—æ—¥æœŸ </p>
</li>
<li><p>10181  1000481  2010-04-04 16:54:31 </p>
</li>
<li><p>20001  1001597  2010-04-07 15:07:52 </p>
</li>
<li><p>20001  1001560  2010-04-07 15:08:27 </p>
</li>
<li><p>20042  1001368  2010-04-08 08:20:30 </p>
</li>
<li><p>20067  1002061  2010-04-08 16:45:33 </p>
</li>
<li><p>20056  1003289  2010-04-12 10:50:55 </p>
</li>
<li><p>20056  1003290  2010-04-12 11:57:35 </p>
</li>
<li><p>20056  1003292  2010-04-12 12:05:29 </p>
</li>
<li><p>20054  1002420  2010-04-14 15:24:12 </p>
</li>
<li><p>20055  1001679  2010-04-14 19:46:04 </p>
</li>
<li><p>20054  1010675  2010-04-14 15:23:53 </p>
</li>
<li><p>20054  1002429  2010-04-14 17:52:45 </p>
</li>
<li><p>20076  1002427  2010-04-14 19:35:39 </p>
</li>
<li><p>20054  1003326  2010-04-20 12:54:44 </p>
</li>
<li><p>20056  1002420  2010-04-15 11:24:49 </p>
</li>
<li><p>20064  1002422  2010-04-15 11:35:54 </p>
</li>
<li><p>20056  1003066  2010-04-15 11:43:01 </p>
</li>
<li><p>20056  1003055  2010-04-15 11:43:06 </p>
</li>
<li><p>20056  1010183  2010-04-15 11:45:24 </p>
</li>
<li><p>20056  1002422  2010-04-15 11:45:49 </p>
</li>
<li><p>20056  1003100  2010-04-15 11:45:54 </p>
</li>
<li><p>20056  1003094  2010-04-15 11:45:57 </p>
</li>
<li><p>20056  1003064  2010-04-15 11:46:04 </p>
</li>
<li><p>20056  1010178  2010-04-15 16:15:20 </p>
</li>
<li><p>20076  1003101  2010-04-15 16:37:27 </p>
</li>
<li><p>20076  1003103  2010-04-15 16:37:05 </p>
</li>
<li><p>20076  1003100  2010-04-15 16:37:18 </p>
</li>
<li><p>20076  1003066  2010-04-15 16:37:31 </p>
</li>
<li><p>20054  1003103  2010-04-15 16:40:14 </p>
</li>
<li><p>20054  1003100  2010-04-15 16:40:16 </p>
</li>
</ol>
<p>è¦æ±‚ç¼–å†™MapReduceç¨‹åºï¼Œç»Ÿè®¡æ¯ä¸ªä¹°å®¶æ”¶è—å•†å“æ•°é‡ã€‚</p>
<h3 id="1-åœ¨æ–‡æ¡£ä¸‹æ–°å»ºæ–‡ä»¶buyer-favourite9"><a href="#1-åœ¨æ–‡æ¡£ä¸‹æ–°å»ºæ–‡ä»¶buyer-favourite9" class="headerlink" title="1. åœ¨æ–‡æ¡£ä¸‹æ–°å»ºæ–‡ä»¶buyer_favourite9"></a>1. åœ¨æ–‡æ¡£ä¸‹æ–°å»ºæ–‡ä»¶buyer_favourite9</h3><blockquote>
<p>å†™å…¥æ•°æ®</p>
</blockquote>
<pre><code>10181   1000481   2010-04-04æ·»åŠ åˆ°æ—¥å† 16:54:31
20001   1001597   2010-04-07 15:07:52
20001   1001560   2010-04-07 15:08:27
20042   1001368   2010-04-08 08:20:30
20067   1002061   2010-04-08 16:45:33
20056   1003289   2010-04-12 10:50:55
20056   1003290   2010-04-12 11:57:35
20056   1003292   2010-04-12 12:05:29
20054   1002420   2010-04-14 15:24:12
20055   1001679   2010-04-14 19:46:04
20054   1010675   2010-04-14 15:23:53
20054   1002429   2010-04-14 17:52:45
20076   1002427   2010-04-14 19:35:39
20054   1003326   2010-04-20 12:54:44
20056   1002420   2010-04-15 11:24:49
20064   1002422   2010-04-15 11:35:54
20056   1003066   2010-04-15 11:43:01
20056   1003055   2010-04-15 11:43:06
20056   1010183   2010-04-15 11:45:24
20056   1002422   2010-04-15 11:45:49
20056   1003100   2010-04-15 11:45:54
20056   1003094   2010-04-15 11:45:57
20056   1003064   2010-04-15 11:46:04
20056   1010178   2010-04-15 16:15:20
20076   1003101   2010-04-15 16:37:27
20076   1003103   2010-04-15 16:37:05
20076   1003100   2010-04-15 16:37:18
20076   1003066   2010-04-15 16:37:31
20054   1003103   2010-04-15 16:40:14
20054   1003100   2010-04-15 16:40:16 </code></pre>
<h3 id="2-å°†buyer-favourite9ä¸Šä¼ åˆ°HDFSæ–‡ä»¶ç³»ç»Ÿ"><a href="#2-å°†buyer-favourite9ä¸Šä¼ åˆ°HDFSæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="2. å°†buyer_favourite9ä¸Šä¼ åˆ°HDFSæ–‡ä»¶ç³»ç»Ÿ"></a>2. å°†buyer_favourite9ä¸Šä¼ åˆ°HDFSæ–‡ä»¶ç³»ç»Ÿ</h3><blockquote>
<p>å³é”®input â€”&gt; Upload files to DFS</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928222920023.png" class="" title="image-20200928222920023">

<blockquote>
<p>é€‰æ‹©buyer_favourite1åç¡®å®š</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928225427432.png" class="" title="image-20200928225427432">



<h3 id="3-æ–°å»ºjavaæ–‡ä»¶ProductNumber"><a href="#3-æ–°å»ºjavaæ–‡ä»¶ProductNumber" class="headerlink" title="3. æ–°å»ºjavaæ–‡ä»¶ProductNumber"></a>3. æ–°å»ºjavaæ–‡ä»¶ProductNumber</h3><blockquote>
<p>ä»£ç å¦‚ä¸‹</p>
</blockquote>
<pre><code class="java">package com.kag;

import java.io.IOException;  
import java.util.StringTokenizer;  
import org.apache.log4j.Logger;
import org.apache.hadoop.fs.Path;  
import org.apache.hadoop.io.IntWritable;  
import org.apache.hadoop.io.Text;  
import org.apache.hadoop.mapreduce.Job;  
import org.apache.hadoop.mapreduce.Mapper;  
import org.apache.hadoop.mapreduce.Reducer;  
import org.apache.hadoop.mapreduce.lib.input.FileInputFormat;  
import org.apache.hadoop.mapreduce.lib.output.FileOutputFormat; 

/**
 * @author parak
 * @date 2020-9-28
 */
public class ProductNumber &#123;

    public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException &#123;
        Job job = Job.getInstance();
        job.setJobName(&quot;ProductNumber&quot;);
        job.setJarByClass(ProductNumber.class);
        job.setMapperClass(MapperHandler.class);  
        job.setReducerClass(ReducerHandler.class);  
        job.setOutputKeyClass(Text.class);  
        job.setOutputValueClass(IntWritable.class);  
        Path inputPath = new Path(&quot;hdfs://master:9000/user/parak/input/buyer_favourite1&quot;);
        Path outputPath = new Path(&quot;hdfs://master:9000/user/parak/output/buyer_favourite1_analysis_result&quot;);
        FileInputFormat.addInputPath(job, inputPath);
        FileOutputFormat.setOutputPath(job, outputPath);
        boolean flag = job.waitForCompletion(true);
        Logger log = Logger.getLogger(ProductNumber.class);
        log.info(&quot;Falg = &quot; + flag);
        System.exit(flag ? 0 : 1);
    &#125;

    public static class MapperHandler extends Mapper&lt;Object, Text, Text, IntWritable&gt; &#123;
        public static final IntWritable intWritable = new IntWritable(1);
        public static Text word = new Text();
        @Override
        protected void map(Object key, Text value, Context context) throws IOException, InterruptedException &#123;
            StringTokenizer tokenizer = new StringTokenizer(value.toString(), &quot;   &quot;);
            word.set(tokenizer.nextToken());
            context.write(word, intWritable);
        &#125;
    &#125;

    public static class ReducerHandler extends Reducer&lt;Text, IntWritable, Text, IntWritable&gt; &#123;
        private IntWritable intWritable = new IntWritable(1);
        @Override
        protected void reduce(Text key, Iterable&lt;IntWritable&gt; values, Context context) throws IOException, InterruptedException &#123;
            int sum = 0;
            for (IntWritable value : values) &#123;
                sum += value.get();
            &#125;
            intWritable.set(sum);
            context.write(key, intWritable);
        &#125;
    &#125;

&#125;</code></pre>
<blockquote>
<p>è¿è¡Œç»“æœ</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928223752502.png" class="" title="image-20200928223752502">

<blockquote>
<p>è¿è¡Œåçš„HDFSæ–‡ä»¶ç³»ç»Ÿ</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928225133967.png" class="" title="image-20200928225133967">



<blockquote>
<p>part-r-00000æ–‡ä»¶å†…å®¹å³ä¸ºç»Ÿè®¡ç»“æœ</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200928225154667.png" class="" title="image-20200928225154667">





<h2 id="8-å®‰è£…éƒ¨ç½²HBase"><a href="#8-å®‰è£…éƒ¨ç½²HBase" class="headerlink" title="8. å®‰è£…éƒ¨ç½²HBase"></a>8. å®‰è£…éƒ¨ç½²HBase</h2><p>HBaseä¸Hadoopç‰ˆæœ¬æ”¯æŒå…³ç³»</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20201002211137852.png" class="" title="image-20201002211137852">





<h3 id="1-ä¸‹è½½å®‰è£…HBase-1-6-0"><a href="#1-ä¸‹è½½å®‰è£…HBase-1-6-0" class="headerlink" title="1. ä¸‹è½½å®‰è£…HBase-1.6.0"></a>1. ä¸‹è½½å®‰è£…HBase-1.6.0</h3><blockquote>
<p>ä½¿ç”¨é•œåƒï¼š<a href="https://mirrors.bfsu.edu.cn/apache/hbase/">https://mirrors.bfsu.edu.cn/apache/hbase/</a></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929100114445.png" class="" title="image-20200929100114445">

<blockquote>
<p>é€‰æ‹©1.6.0ï¼Œä¸‹è½½tar.gzå‹ç¼©åŒ…</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929100159559.png" class="" title="image-20200929100159559">

<blockquote>
<p>è§£å‹</p>
</blockquote>
<pre><code class="bash">tar xzvf hbase-1.6.0-bin.tar.gz </code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929102107183.png" class="" title="image-20200929102107183">

<blockquote>
<p>æŸ¥çœ‹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929102212291.png" class="" title="image-20200929102212291">



<h3 id="2-é…ç½®Hbase"><a href="#2-é…ç½®Hbase" class="headerlink" title="2. é…ç½®Hbase"></a>2. é…ç½®Hbase</h3><blockquote>
<p>è¿›å…¥HBaseå®‰è£…ä¸»ç›®å½•çš„confç›®å½•ï¼Œç„¶åä¿®æ”¹é…ç½®æ–‡ä»¶</p>
</blockquote>
<pre><code class="shell">cd conf/</code></pre>
<h4 id="1-ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-env-sh"><a href="#1-ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-env-sh" class="headerlink" title="(1) ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-env.sh"></a>(1) ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-env.sh</h4><pre><code class="shell">gedit hbase-env.sh

ä¿®æ”¹JAVA_HOME:
export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.262.b10-0.el7_8.x86_64</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929103119874.png" class="" title="image-20200929103119874">

<h4 id="2-ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-site-xml"><a href="#2-ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-site-xml" class="headerlink" title="(2) ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-site.xml"></a>(2) ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-site.xml</h4><blockquote>
<p>å°†hbase-site.xmlä¿®æ”¹ä¸ºâ€˜</p>
</blockquote>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;
&lt;!--
/**
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
--&gt;
&lt;configuration&gt;
&lt;configuration&gt;
    &lt;property&gt;
        &lt;name&gt;hbase.cluster.distributed&lt;/name&gt;
        &lt;value&gt;true&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;hbase.rootdir&lt;/name&gt;
        &lt;value&gt;hdfs://master:9000/hbase&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;hbase.zookeeper.quorum&lt;/name&gt;
        &lt;value&gt;master&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;hbase.master.info.port&lt;/name&gt;
        &lt;value&gt;60010&lt;/value&gt;
    &lt;/property&gt;
&lt;/configuration&gt;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929103343424.png" class="" title="image-20200929103343424">

<h4 id="3-è®¾ç½®-regionservers"><a href="#3-è®¾ç½®-regionservers" class="headerlink" title="(3) è®¾ç½® regionservers"></a>(3) è®¾ç½® regionservers</h4><blockquote>
<p>å°†regionserversä¸­çš„localhostä¿®æ”¹ä¸º: slave</p>
</blockquote>
<h4 id="4-è®¾ç½®ç¯å¢ƒå˜é‡"><a href="#4-è®¾ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="(4) è®¾ç½®ç¯å¢ƒå˜é‡"></a>(4) è®¾ç½®ç¯å¢ƒå˜é‡</h4><pre><code class="shell">gedit ~/.bash_profile

å°†ä¸‹é¢ä»£ç æ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼š
#HBase
export HBASE_HOME=/home/parak/HBase/hbase-1.6.0
export PATH=$HBASE_HOME/bin:$PATH
export HADOOP_CLASSPATH=$HBASE_HOME/lib/*</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929104148521.png" class="" title="image-20200929104148521">

<h4 id="5-å°†HBaseå¤åˆ¶åˆ°Slaveç»“ç‚¹"><a href="#5-å°†HBaseå¤åˆ¶åˆ°Slaveç»“ç‚¹" class="headerlink" title="(5) å°†HBaseå¤åˆ¶åˆ°Slaveç»“ç‚¹"></a>(5) å°†HBaseå¤åˆ¶åˆ°Slaveç»“ç‚¹</h4><pre><code class="shell">scp -r /home/parak/HBase/hbase-1.6.0 slave:/home/parak/HBase/</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929104703378.png" class="" title="image-20200929104703378">

<blockquote>
<p>æŸ¥çœ‹slaveç»“ç‚¹çš„HBaseæ–‡ä»¶å¤¹</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929104827983.png" class="" title="image-20200929104827983">



<h3 id="3-éªŒè¯å¹¶å¯åŠ¨HBase"><a href="#3-éªŒè¯å¹¶å¯åŠ¨HBase" class="headerlink" title="3. éªŒè¯å¹¶å¯åŠ¨HBase"></a>3. éªŒè¯å¹¶å¯åŠ¨HBase</h3><blockquote>
<p>å…ˆå¯åŠ¨Hadoop: start-all.sh</p>
<p>å†å¯åŠ¨Hbase: start-hbase.sh</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929105006101.png" class="" title="image-20200929105006101">

<blockquote>
<p>å¯åŠ¨HBaseå‡ºç°é”™è¯¯</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929110647176.png" class="" title="image-20200929110647176">

<p>æˆ‘æ„è¯†åˆ°æ˜¯Hadoop-2.9.2ä¸HBase-1.6.0çš„ç‰ˆæœ¬åŒ¹é…é—®é¢˜ï¼Œäºæ˜¯æˆ‘ä¸‹è½½HBase-2.2.6ã€‚</p>
<h3 id="4-é‡æ–°ä¸‹è½½é…ç½®HBase-2-2-6"><a href="#4-é‡æ–°ä¸‹è½½é…ç½®HBase-2-2-6" class="headerlink" title="4. é‡æ–°ä¸‹è½½é…ç½®HBase-2.2.6"></a>4. é‡æ–°ä¸‹è½½é…ç½®HBase-2.2.6</h3><blockquote>
<p>ä¸‹è½½</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929110514041.png" class="" title="image-20200929110514041">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929110553845.png" class="" title="image-20200929110553845">

<blockquote>
<p>è§£å‹: tar xzvf hbase-2.2.6-bin.tar.gz</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929110818266.png" class="" title="image-20200929110818266">

<blockquote>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-env.sh</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929111024747.png" class="" title="image-20200929111024747">

<blockquote>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶hbase-site.xml</p>
</blockquote>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;
&lt;!--
/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
--&gt;
&lt;configuration&gt;
  &lt;!--
    The following properties are set for running HBase as a single process on a
    developer workstation. With this configuration, HBase is running in
    &quot;stand-alone&quot; mode and without a distributed file system. In this mode, and
    without further configuration, HBase and ZooKeeper data are stored on the
    local filesystem, in a path under the value configured for `hbase.tmp.dir`.
    This value is overridden from its default value of `/tmp` because many
    systems clean `/tmp` on a regular basis. Instead, it points to a path within
    this HBase installation directory.

    Running against the `LocalFileSystem`, as opposed to a distributed
    filesystem, runs the risk of data integrity issues and data loss. Normally
    HBase will refuse to run in such an environment. Setting
    `hbase.unsafe.stream.capability.enforce` to `false` overrides this behavior,
    permitting operation. This configuration is for the developer workstation
    only and __should not be used in production!__

    See also https://hbase.apache.org/book.html#standalone_dist
  --&gt;
    &lt;property&gt;
        &lt;name&gt;hbase.cluster.distributed&lt;/name&gt;
        &lt;value&gt;true&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;hbase.tmp.dir&lt;/name&gt;
        &lt;value&gt;./tmp&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;hbase.unsafe.stream.capability.enforce&lt;/name&gt;
        &lt;value&gt;false&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;hbase.rootdir&lt;/name&gt;
        &lt;value&gt;hdfs://master:9000/hbase&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;hbase.zookeeper.quorum&lt;/name&gt;
        &lt;value&gt;master&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;hbase.master.info.port&lt;/name&gt;
        &lt;value&gt;60010&lt;/value&gt;
    &lt;/property&gt;
&lt;/configuration&gt;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929111344171.png" class="" title="image-20200929111344171">

<blockquote>
<p>ä¿®æ”¹regionserversæ–‡ä»¶</p>
</blockquote>
<p><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="Hadoop%5Cimage-20200929113716160.png" alt="image-20200929113716160"></p>
<blockquote>
<p>å°†HBaseå¤åˆ¶åˆ°SlaveèŠ‚ç‚¹</p>
</blockquote>
<pre><code class="shell">scp -r /home/parak/HBase/hbase-2.2.6 slave:/home/parak/HBase</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929112324004.png" class="" title="image-20200929112324004">

<blockquote>
<p>å†æ¬¡å¯åŠ¨Hbase</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929113827901.png" class="" title="image-20200929113827901">

<blockquote>
<p>æ‰“å¼€FireFoxï¼Œè¿›å…¥<a href="http://master:60010/">http://master:60010</a></p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929113959833.png" class="" title="image-20200929113959833">

<p>è¯´æ˜HBaseå¯åŠ¨æˆåŠŸ</p>
<h3 id="4-å…³é—­HBase"><a href="#4-å…³é—­HBase" class="headerlink" title="4. å…³é—­HBase"></a>4. å…³é—­HBase</h3><blockquote>
<p>å…ˆå…³é—­HBase: stop-hbase.sh</p>
<p>å†å…³é—­Hadoop: stop-all.sh</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929114148065.png" class="" title="image-20200929114148065">



<h2 id="9-HBase-Shellå‘½ä»¤æ“ä½œ"><a href="#9-HBase-Shellå‘½ä»¤æ“ä½œ" class="headerlink" title="9. HBase Shellå‘½ä»¤æ“ä½œ"></a>9. HBase Shellå‘½ä»¤æ“ä½œ</h2><h3 id="1-å¯åŠ¨HBase-Shell"><a href="#1-å¯åŠ¨HBase-Shell" class="headerlink" title="1. å¯åŠ¨HBase Shell"></a>1. å¯åŠ¨HBase Shell</h3><h4 id="1-å¯åŠ¨HBase-Shellç•Œé¢"><a href="#1-å¯åŠ¨HBase-Shellç•Œé¢" class="headerlink" title="(1) å¯åŠ¨HBase Shellç•Œé¢"></a>(1) å¯åŠ¨HBase Shellç•Œé¢</h4><pre><code class="shell">hbase shell</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929191351747.png" class="" title="image-20200929191351747">

<h4 id="2-HBase-Shellçš„helpå‘½ä»¤"><a href="#2-HBase-Shellçš„helpå‘½ä»¤" class="headerlink" title="(2) HBase Shellçš„helpå‘½ä»¤"></a>(2) HBase Shellçš„helpå‘½ä»¤</h4><pre><code class="shell">help</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929191531507.png" class="" title="image-20200929191531507">

<blockquote>
<p>æŸ¥çœ‹HBaseå»ºè¡¨å‘½ä»¤createçš„ç”¨æ³•</p>
</blockquote>
<pre><code class="shell">help &quot;create&quot;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929191618099.png" class="" title="image-20200929191618099">



<h3 id="2-åˆ›å»ºHBaseæ•°æ®è¡¨"><a href="#2-åˆ›å»ºHBaseæ•°æ®è¡¨" class="headerlink" title="2. åˆ›å»ºHBaseæ•°æ®è¡¨"></a>2. åˆ›å»ºHBaseæ•°æ®è¡¨</h3><blockquote>
<p>HBaseä¸­ç”¨createå‘½ä»¤åˆ›å»ºè¡¨</p>
</blockquote>
<pre><code class="sql">create &#39;student&#39;, &#39;Sname&#39;, &#39;Ssex&#39;, &#39;Sage&#39;, &#39;Sdept&#39;, &#39;course&#39;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929191856923.png" class="" title="image-20200929191856923">

<blockquote>
<p>æŸ¥çœ‹â€™studentâ€™è¡¨çš„å±æ€§</p>
</blockquote>
<pre><code class="shell">describe &#39;student&#39;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929191953519.png" class="" title="image-20200929191953519">



<h3 id="3-HBaseæ•°æ®åº“åŸºæœ¬æ“ä½œ"><a href="#3-HBaseæ•°æ®åº“åŸºæœ¬æ“ä½œ" class="headerlink" title="3. HBaseæ•°æ®åº“åŸºæœ¬æ“ä½œ"></a>3. HBaseæ•°æ®åº“åŸºæœ¬æ“ä½œ</h3><h4 id="1-æ·»åŠ æ•°æ®"><a href="#1-æ·»åŠ æ•°æ®" class="headerlink" title="(1) æ·»åŠ æ•°æ®"></a>(1) æ·»åŠ æ•°æ®</h4><blockquote>
<p>putå‘½ä»¤æ·»åŠ æ•°æ®ï¼Œä¸€æ¬¡åªèƒ½ä¸ºä¸€ä¸ªè¡¨çš„ä¸€è¡Œæ•°æ®çš„ä¸€ä¸ªåˆ—æ·»åŠ ä¸€ä¸ªæ•°æ®</p>
</blockquote>
<pre><code class="shell">put &#39;student&#39;, &#39;95001&#39;, &#39;Sname&#39;, &#39;Li Ying&#39;
put &#39;student&#39;, &#39;95001&#39;, &#39;Sdept&#39;, &#39;CS&#39;
put &#39;student&#39;, &#39;95001&#39;, &#39;course:math&#39;, &#39;81&#39;
put &#39;student&#39;, &#39;95001&#39;, &#39;course:english&#39;, &#39;85&#39;
put &#39;student&#39;, &#39;95002&#39;, &#39;course:math&#39;, &#39;83&#39;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929193655517.png" class="" title="image-20200929193655517">



<h4 id="2-æŸ¥çœ‹æ•°æ®"><a href="#2-æŸ¥çœ‹æ•°æ®" class="headerlink" title="(2) æŸ¥çœ‹æ•°æ®"></a>(2) æŸ¥çœ‹æ•°æ®</h4><blockquote>
<p>æŸ¥çœ‹è¡¨æŸä¸€è¡Œçš„æ•°æ®</p>
</blockquote>
<pre><code class="shell">get &#39;student&#39;, &#39;95001&#39;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929194017359.png" class="" title="image-20200929194017359">

<blockquote>
<p>æŸ¥çœ‹è¡¨çš„å…¨éƒ¨æ•°æ®</p>
</blockquote>
<pre><code class="shell">scan &#39;student&#39;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929194135877.png" class="" title="image-20200929194135877">



<h4 id="3-åˆ é™¤æ•°æ®"><a href="#3-åˆ é™¤æ•°æ®" class="headerlink" title="(3) åˆ é™¤æ•°æ®"></a>(3) åˆ é™¤æ•°æ®</h4><blockquote>
<p>deleteå‘½ä»¤åˆ é™¤æŸä¸€é¡¹æ•°æ®</p>
</blockquote>
<pre><code class="shell">delete &#39;student&#39;, &#39;95001&#39;, &#39;Ssex&#39;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929194514884.png" class="" title="image-20200929194514884">

<blockquote>
<p>deleteå‘½ä»¤åˆ é™¤æŸè¡Œçš„å…¨éƒ¨æ•°æ®</p>
</blockquote>
<pre><code class="shell">delete &#39;student&#39;,&#39;95001&#39;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929194626605.png" class="" title="image-20200929194626605">



<h4 id="4-åˆ é™¤è¡¨"><a href="#4-åˆ é™¤è¡¨" class="headerlink" title="(4) åˆ é™¤è¡¨"></a>(4) åˆ é™¤è¡¨</h4><pre><code class="shell">disable &#39;student&#39;
drop &#39;student&#39;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929193442627.png" class="" title="image-20200929193442627">



<h3 id="4-æŸ¥è¯¢HBaseæ•°æ®è¡¨çš„å†å²æ•°æ®"><a href="#4-æŸ¥è¯¢HBaseæ•°æ®è¡¨çš„å†å²æ•°æ®" class="headerlink" title="4. æŸ¥è¯¢HBaseæ•°æ®è¡¨çš„å†å²æ•°æ®"></a>4. æŸ¥è¯¢HBaseæ•°æ®è¡¨çš„å†å²æ•°æ®</h3><blockquote>
<p>åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™ï¼ŒæŒ‡å®šä¿å­˜çš„ç‰ˆæœ¬æ•°</p>
</blockquote>
<pre><code class="shell">create &#39;teacher&#39;, &#123;NAME=&gt;&#39;username&#39;, VERSIONS=&gt;5&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929203801474.png" class="" title="image-20200929203801474">

<blockquote>
<p>æ’å…¥æ•°æ®ç„¶åæ›´æ–°æ•°æ®ï¼Œä½¿å…¶äº§ç”Ÿå†å²ç‰ˆæœ¬æ•°æ®</p>
</blockquote>
<pre><code class="shell">put &#39;teacher&#39;, &#39;91001&#39;, &#39;username&#39;, &#39;Mary&#39;
put &#39;teacher&#39;, &#39;91001&#39;, &#39;username&#39;, &#39;Mary1&#39;
put &#39;teacher&#39;, &#39;91001&#39;, &#39;username&#39;, &#39;Mary2&#39;
put &#39;teacher&#39;, &#39;91001&#39;, &#39;username&#39;, &#39;Mary3&#39;
put &#39;teacher&#39;, &#39;91001&#39;, &#39;username&#39;, &#39;Mary4&#39;
put &#39;teacher&#39;, &#39;91001&#39;, &#39;username&#39;, &#39;Mary5&#39;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929204220031.png" class="" title="image-20200929204220031">

<blockquote>
<p>æŸ¥è¯¢æ—¶ï¼ŒæŒ‡å®šæŸ¥è¯¢çš„å†å²ç‰ˆæœ¬ä¹¦ï¼ˆé»˜è®¤ä¼šæŸ¥è¯¢å‡ºæœ€æ–°çš„æ•°æ®ï¼‰</p>
</blockquote>
<pre><code class="shell">get &#39;teacher&#39;, &#39;91001&#39;, &#123;COLUMN=&gt;&#39;username&#39;, VERSIONS=&gt;5&#125;</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/ec060e02/image-20200929204245861.png" class="" title="image-20200929204245861">



<h3 id="5-é€€å‡ºHBase-Shell"><a href="#5-é€€å‡ºHBase-Shell" class="headerlink" title="5. é€€å‡ºHBase Shell"></a>5. é€€å‡ºHBase Shell</h3><pre><code class="sh">exit</code></pre>
]]></content>
      <categories>
        <category>Cloud</category>
      </categories>
      <tags>
        <tag>Hadoop</tag>
      </tags>
  </entry>
  <entry>
    <title>Netty</title>
    <url>/posts/1c6ba3e2/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-IO"><a href="#1-IO" class="headerlink" title="1. IO"></a>1. IO</h2><h3 id="1-1-BIO"><a href="#1-1-BIO" class="headerlink" title="1.1 BIO"></a>1.1 BIO</h3><h4 id="1-1-1-ä»‹ç»"><a href="#1-1-1-ä»‹ç»" class="headerlink" title="1.1.1 ä»‹ç»"></a>1.1.1 ä»‹ç»</h4><ul>
<li>Java BIOå°±æ˜¯ä¼ ç»Ÿçš„Java IOç¼–ç¨‹ï¼Œç›¸å…³APIéƒ½åœ¨java.io</li>
<li>BIO (<strong>blocking I/O</strong>)ï¼š<strong>åŒæ­¥å¹¶é˜»å¡</strong>ï¼ŒæœåŠ¡å™¨å®ç°æ¨¡å¼ä¸ºä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹ï¼Œå³æœ‰è¿æ¥è¯·æ±‚æ—¶æœåŠ¡å™¨å°±éœ€è¦å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¦‚æœè¿™ä¸ªè¿æ¥ä¸åšä»»ä½•äº‹æƒ…ä¼šé€ æˆä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€</li>
<li>BIOæ–¹å¼é€‚ç”¨äºè¿æ¥æ•°ç›®è¾ƒå°ä¸”å›ºå®šçš„æ¶æ„ï¼Œè¿™ç§æ–¹å¼å¯¹æœåŠ¡å™¨èµ„æºè¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¹¶å‘å±€é™äºåº”ç”¨ä¸­ï¼ŒJDK1.4ä»¥å‰çš„å”¯ä¸€é€‰æ‹©</li>
</ul>
<a id="more"></a>



<h4 id="1-1-2-å®ä¾‹"><a href="#1-1-2-å®ä¾‹" class="headerlink" title="1.1.2 å®ä¾‹"></a>1.1.2 å®ä¾‹</h4><blockquote>
<p>BIOæœåŠ¡å™¨</p>
</blockquote>
<pre><code class="java">package com.kag.bio;

import org.apache.log4j.Logger;
import java.io.IOException;
import java.io.InputStream;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * @Author: KHighness
 * @Date: 2020/9/13 11:07
 * @Description: BIOæœåŠ¡å™¨
 */

public class BIOServer &#123;

    private Logger logger = Logger.getLogger(BIOServer.class);

    /**
     *  å¯åŠ¨æœåŠ¡å™¨
     * @throws IOException
     */
    public void start() throws IOException &#123;

        /**
         * çº¿ç¨‹æ± æœºåˆ¶
         * æ€è·¯
         * 1ã€åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± 
         * 2ã€å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ± è”æœºå‘ƒï¼Œå°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ä¹‹é€šè®¯
         */

        ExecutorService newCachedThreadPool = Executors.newCachedThreadPool();

        // åˆ›å»ºServerSocket
        ServerSocket serverSocket = new ServerSocket(6666);
        logger.info(&quot;NIO æœåŠ¡å™¨å¯åŠ¨ &quot;);

        while (true) &#123;
            // ç›‘å¬ï¼Œç­‰å¾…å®¢æˆ·ç«¯æ¥å—
            final Socket socket = serverSocket.accept();
            logger.info(&quot;æ–°å¢ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥&quot;);
            // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ä¹‹é€šè®¯
            newCachedThreadPool.execute(new Runnable() &#123;
                public void run() &#123;
                    handler(socket);
                &#125;
            &#125;);
        &#125;
    &#125;

    /**
     * handlerï¼Œå’Œå®¢æˆ·ç«¯é€šè®¯
     * @param socket
     */
    public void handler(Socket socket) &#123;
        try &#123;
            byte[] bytes = new byte[1024];
            // é€šè¿‡socketè·å–è¾“å…¥æµ
            InputStream inputStream = socket.getInputStream();
            // å¾ªç¯è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
            while (true) &#123;
                // è¾“å‡ºçº¿ç¨‹ä¿¡æ¯
                logger.info(&quot;çº¿ç¨‹ä¿¡æ¯ï¼š&#123; PID = &quot; + Thread.currentThread().getId()
                        + &quot;, Name = &quot; + Thread.currentThread().getName() + &quot; &#125;&quot;);
                int read = inputStream.read(bytes);
                if (read != -1) &#123;
                    logger.info(&quot;[å®¢æˆ·ç«¯ï¼š&quot; + new String(bytes, 0, read) + &quot;]&quot;);
                &#125; else &#123;
                    break;
                &#125;
            &#125;
        &#125; catch (Exception e) &#123;
            logger.info(e.getMessage());
        &#125; finally &#123;
            logger.info(&quot;å…³é—­ä¸å®¢æˆ·ç«¯çš„è¿æ¥&quot;);
            try &#123;
                socket.close();
            &#125; catch (IOException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;

    public static void main(String[] args) &#123;
        try &#123;
            new BIOServer().start();
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;
</code></pre>
<h4 id="1-1-3-é…ç½®"><a href="#1-1-3-é…ç½®" class="headerlink" title="1.1.3 é…ç½®"></a>1.1.3 é…ç½®</h4><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200913115739418.png" class="" title="image-20200913115739418">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200913115851769.png" class="" title="image-20200913115851769">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200913115947574.png" class="" title="image-20200913115947574">



<h4 id="1-1-4-è¿è¡Œ"><a href="#1-1-4-è¿è¡Œ" class="headerlink" title="1.1.4 è¿è¡Œ"></a>1.1.4 è¿è¡Œ</h4><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200913120322526.png" class="" title="image-20200913120322526">



<pre><code class="shell">telnet 127.0.0.1 6666</code></pre>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200913120406689.png" class="" title="image-20200913120406689">



<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200913121954652.png" class="" title="image-20200913121954652">

<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200913122028056.png" class="" title="image-20200913122028056">



<h4 id="1-1-5-ä¸è¶³"><a href="#1-1-5-ä¸è¶³" class="headerlink" title="1.1.5 ä¸è¶³"></a>1.1.5 ä¸è¶³</h4><p>1ï¼‰æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦åˆ›å»ºç‹¬ç«‹çš„çº¿ç¨‹ï¼Œä¸å¯¹åº”çš„å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®Readï¼Œä¸šåŠ¡å¤„ç†ï¼Œæ•°æ®Write</p>
<p>2ï¼‰å½“å¹¶å‘æ•°è¾ƒå¤§æ—¶ï¼Œéœ€è¦åˆ›å»ºå¤§é‡çº¿ç¨‹æ¥å¤„ç†è¿æ¥ï¼Œç³»ç»Ÿèµ„æºå ç”¨è¾ƒå¤§</p>
<p>3ï¼‰è¿æ¥å»ºç«‹åï¼Œå¦‚æœå½“å½“å‰çº¿ç¨‹æš‚å­˜æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™çº¿ç¨‹å°±é˜»å¡åœ¨Readä¸Šï¼Œé€ æˆçº¿ç¨‹èµ„æºæµªè´¹</p>
<h3 id="1-2-NIO"><a href="#1-2-NIO" class="headerlink" title="1.2 NIO"></a>1.2 NIO</h3><h4 id="1-2-1-ä»‹ç»"><a href="#1-2-1-ä»‹ç»" class="headerlink" title="1.2.1 ä»‹ç»"></a>1.2.1 ä»‹ç»</h4><ul>
<li>Java NIO å…¨ç§° <strong>java non-blocking IO</strong>ï¼Œæ˜¯æŒ‡JDKæä¾›çš„å¿ƒAPIï¼Œæ˜¯<strong>åŒæ­¥éé˜»å¡</strong>çš„ã€‚</li>
<li>NIO ç›¸å…³ç±»éƒ½è¢«æ”¾åœ¨ java.nioåŒ…åŠå­åŒ…ä¸‹ï¼Œå¹¶ä¸”å¯¹åŸ java.ioåŒ…ä¸­çš„å¾ˆå¤šç±»è¿›è¡Œæ”¹å†™</li>
<li>NIO ä¸‰å¤§æ ¸å¿ƒéƒ¨åˆ†ï¼š<u>Channel</u>(é€šé“)ã€<u>Buffer</u>(ç¼“å†²åŒº)ã€<u>Selector</u>(é€‰æ‹©å™¨)</li>
<li>NIO æ˜¯é¢å‘ç¼“å†²åŒºæˆ–è€…é¢å‘å—ç¼–ç¨‹çš„ã€‚æ•°æ®è¯»å–åˆ°ä¸€ä¸ªå®ƒç¨åå¤„ç†çš„ç¼“å†²åŒºï¼Œéœ€è¦æ—¶å¯åœ¨ç¼“å†²åŒºå‰åç§»åŠ¨ï¼Œè¿™å°±å¢åŠ å¤„ç†è¿‡ç¨‹ä¸­çš„çµæ´»æ€§ï¼Œä½¿ç”¨å®ƒå¯ä»¥æä¾›éé˜»å¡çš„é«˜ä¼¸ç¼©æ€§ç½‘ç»œ</li>
</ul>
<h4 id="1-2-2-æ¯”è¾ƒ"><a href="#1-2-2-æ¯”è¾ƒ" class="headerlink" title="1.2.2 æ¯”è¾ƒ"></a>1.2.2 æ¯”è¾ƒ</h4><blockquote>
<p><code>BIO</code> VS <code>NIO</code></p>
</blockquote>
<ul>
<li><p>BIOä»¥æµçš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œè€ŒNIOä»¥å—çš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œå—I/Oçš„æ•ˆç‡æ¯”æµI/Oé«˜å¾ˆå¤š</p>
</li>
<li><p>BIOæ˜¯é˜»å¡çš„ï¼ŒNIOåˆ™æ˜¯éé˜»å¡çš„</p>
</li>
<li><p>BIOåŸºäºå­—èŠ‚æµå’Œå­—ç¬¦æµè¿›è¡Œæ“ä½œï¼Œè€ŒNIOåŸºäº<code>Channel</code>(é€šé“)å’Œ<code>Buffer</code>(ç¼“å†²åŒº)è¿›è¡Œæ“ä½œï¼Œæ•°æ®æ€»æ˜¯ä»é€šé“è¯»å–åˆ°ç¼“å†²åŒºä¸­ï¼Œæˆ–è€…ä»ç¼“å†²åŒºå†™å…¥åˆ°åŒé“ä¸­äººã€‚<code>Selectors</code>(é€‰æ‹©å™¨)ç”¨äºç›‘å¬å¤šä¸ªé€šé“çš„äº‹ä»¶ï¼ˆæ¯”å¦‚ï¼šè¿æ¥è¯·æ±‚ã€æ•°æ®åˆ°è¾¾ç­‰ï¼‰ï¼Œå› æ­¤ä½¿ç”¨å•ä¸ªçº¿ç¨‹å°±å¯ä»¥ç›‘å¬å¤šä¸ªå®¢æˆ·ç«¯é€šé“</p>
</li>
</ul>
<h4 id="1-2-3-ç»„ä»¶"><a href="#1-2-3-ç»„ä»¶" class="headerlink" title="1.2.3 ç»„ä»¶"></a>1.2.3 ç»„ä»¶</h4><p>ä¸‰å¤§ç»„ä»¶ï¼š<code>Selector</code>ã€<code>Channe</code>å’Œ<code>Buffer</code></p>
<blockquote>
<p>å…³ç³»å›¾</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200913164017187.png" class="" title="image-20200913164017187">

<blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li>æ¯ä¸ª<code>channel</code>éƒ½ä¼šå¯¹åº”ä¸€ä¸ª<code>Buffer</code></li>
<li><code>Selector</code>å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”å¤šä¸ª<code>channel</code></li>
<li>è¯¥å›¾ååº”æœ‰ä¸‰ä¸ª<code>channel</code>æ³¨å†Œåˆ°äº†è¯¥<code>Selector</code>ç¨‹åº</li>
<li>ç¨‹åºåˆ‡æ¢åˆ°å“ªä¸ª<code>channel</code>æ˜¯æœ‰äº‹ä»¶å†³å®šçš„ï¼Œ<code>Event</code>å°±æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µ</li>
<li><code>Selector</code>ä¼šæ ¹æ®ä¸åŒçš„äº‹ä»¶ï¼Œåœ¨å„ä¸ªé€šé“ä¸Šåˆ‡æ¢</li>
<li><code>Buffer</code>å°±æ˜¯ä¸€ä¸ªå†…å­˜å—ï¼Œåº•å±‚æ˜¯æœ‰ä¸€ä¸ªæ•°ç»„</li>
<li>æ•°æ®çš„è¯»å–å†™å…¥éƒ½é€šè¿‡<code>Buffer</code>ï¼Œè¿™ä¸ªå’ŒBIOä¸åŒã€‚BIOè¦ä¹ˆæ˜¯è¾“å…¥æµï¼Œè¦ä¹ˆæ˜¯è¾“å‡ºæµï¼Œä¸èƒ½åŒå‘ï¼Œä½†æ˜¯NIOçš„<code>buffer</code>æ˜¯å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ï¼Œéœ€è¦<code>flip</code>æ–¹æ³•åˆ‡æ¢</li>
<li><code>channel</code>æ˜¯åŒå‘çš„ï¼Œå¯ä»¥è¿”å›åº•å±‚æ“ä½œç³»ç»Ÿçš„æƒ…å†µï¼Œæ¯”å¦‚<code>Linux</code>ï¼Œåº•å±‚çš„æ“ä½œç³»ç»Ÿé€šé“å°±æ˜¯åŒå‘çš„</li>
</ul>
<h5 id="1-2-3-1-Buffer"><a href="#1-2-3-1-Buffer" class="headerlink" title="1.2.3.1 Buffer"></a>1.2.3.1 Buffer</h5><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>ç¼“å†²åŒºï¼šç¼“å†²åŒºæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯ä»¥è¯»å†™æ•°æ®çš„å†…å­˜å—</p>
<blockquote>
<p>å¸¸ç”¨Bufferå­ç±»ï¼š</p>
</blockquote>
<ul>
<li>ByteBuffer</li>
<li>ShortBuffer</li>
<li>CharBuffer</li>
<li>IntBuffer</li>
<li>LongBuffer</li>
<li>DoubleBuffer</li>
<li>FloatBuffer</li>
</ul>
<blockquote>
<p>Bufferç±»å®šä¹‰äº†æ‰€æœ‰çš„ç¼“å†²åŒºéƒ½å…·æœ‰çš„å››ä¸ªå±æ€§æ¥æä¾›å…³äºå…¶æ‰€åŒ…å«çš„æ•°æ®å…ƒç´ </p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">å±æ€§</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Capacity</td>
<td align="center">å®¹é‡ï¼Œå³å¯ä»¥å®¹çº³çš„æœ€å¤§æ•°æ®é‡ï¼›åœ¨ç¼“å†²åŒºåˆ›å»ºæ—¶è¢«è®¾å®šä¸”ä¸èƒ½æ”¹å˜</td>
</tr>
<tr>
<td align="center">Limit</td>
<td align="center">è¡¨ç¤ºç¼“å†²åŒºçš„å½“å‰é‡ç‚¹ï¼Œä¸èƒ½å¯¹ç¼“å†²åŒºè¶…è¿‡æé™çš„ä½ç½®è¿›è¡Œè¯»å†™æ“ä½œï¼Œä¸”æé™æ˜¯å¯ä»¥ä¿®æ”¹çš„</td>
</tr>
<tr>
<td align="center">Position</td>
<td align="center">ä½ç½®ï¼Œä¸‹ä¸€ä¸ªè¦è¢«è¯»æˆ–å†™çš„å…ƒç´ çš„ç´¢å¼•ï¼Œæ¯æ¬¡è¯»å†™ç¼“å†²åŒºæ•°æ®æ—¶éƒ½ä¼šæ”¹å˜çš„å€¼ï¼Œä¸ºä¸‹æ¬¡è¯»å†™ä½œå‡†å¤‡</td>
</tr>
<tr>
<td align="center">Mark</td>
<td align="center">æ ‡è®°</td>
</tr>
</tbody></table>
<p>mark &lt;= position &lt;= limit &lt;= capacity</p>
<h5 id="1-2-3-2-Channel"><a href="#1-2-3-2-Channel" class="headerlink" title="1.2.3.2 Channel"></a>1.2.3.2 Channel</h5><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>é€šé“ï¼šNIOçš„é€šé“ç±»ä¼¼äºæµï¼Œä½†æœ‰äº›åŒºåˆ«</p>
<ul>
<li>é€šé“å¯ä»¥åŒæ—¶è¿›è¡Œè¯»å†™ï¼Œè€Œæµåªèƒ½è¯»æˆ–è€…åªèƒ½å†™</li>
<li>é€šé“å¯ä»¥å®ç°å¼‚æ­¥è¯»å†™æ•°æ®</li>
<li>é€šé“å¯ä»¥ä»ç¼“å†²è¯»æ•°æ®ï¼Œä¹Ÿå¯ä»¥å†™æ•°æ®åˆ°ç¼“å†²</li>
</ul>
<blockquote>
<p> å¸¸ç”¨çš„Channelç±»ï¼š</p>
</blockquote>
<ul>
<li>FileChannel                      â”â”â”â”â”â–¶          æ–‡ä»¶çš„æ•°æ®è¯»å†™</li>
<li>DatagramChannel            â”â”â”â”â”â–¶          UDPçš„æ•°æ®è¯»å†™</li>
<li>ServerSocketChannel      â”â”â”â”â”â–¶          TCPçš„æ•°æ®è¯»å†™</li>
<li>SocketChannel                 â”â”â”â”â”â–¶          TCPçš„æ•°æ®è¯»å†™</li>
</ul>
<blockquote>
<p>FileChannelçš„ä¸»è¦IOæ“ä½œ</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public int read(ByteBuffer dst)</td>
<td align="center">ä»é€šé“è¯»å–æ•°æ®å¹¶æ”¾åˆ°ç¼“å†²åŒºä¸­</td>
</tr>
<tr>
<td align="center">public int write(ByteBuffer src)</td>
<td align="center">æŠŠç¼“å†²åŒºçš„æ•°æ®å†™åˆ°é€šé“ä¸­</td>
</tr>
<tr>
<td align="center">public long transferFrom(ReadableByteChannel src, long position, long count)</td>
<td align="center">ä»ç›®æ ‡é€šé“ä¸­å¤åˆ¶æ•°æ®åˆ°å½“å‰é€šé“</td>
</tr>
<tr>
<td align="center">public long transferTo(long position, long count, WritableByteChannel target)</td>
<td align="center">æŠŠæ•°æ®ä»å½“å‰é€šé“å¤åˆ¶ç»™ç›®æ ‡é€šé“</td>
</tr>
</tbody></table>
<h5 id="1-2-3-3-Selector"><a href="#1-2-3-3-Selector" class="headerlink" title="1.2.3.3 Selector"></a>1.2.3.3 Selector</h5><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p>é€‰æ‹©å™¨ï¼š</p>
<ul>
<li>Javaçš„NIOï¼Œç”¨éé˜»å¡çš„IOæ–¹å¼ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤„ç†å¤šä¸ªçš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå°±ä¼šä½¿ç”¨åˆ°<code>Selector</code></li>
<li><code>Selector</code>èƒ½å¤Ÿæ£€æµ‹å¤šä¸ªæ³¨å†Œçš„é€šé“ä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼ˆå¤šä¸ª<code>Channel</code>ä»¥äº‹ä»¶çš„æ–¹å¼å¯ä»¥æ³¨å†Œåˆ°åŒä¸€ä¸ª<code>Selector</code>ï¼‰ï¼Œå¦‚æœæœ‰äº‹ä»¶å‘ç”Ÿï¼Œä¾¿è·å–äº‹ä»¶ç„¶åé’ˆå¯¹æ¯ä¸ªäº‹ä»¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¿™æ ·å°±å¯ä»¥åªç”¨ä¸€ä¸ªå•çº¿ç¨‹å»ç®¡ç†å¤šä¸ªé€šé“ï¼Œä¹Ÿå°±æ˜¯ç®¡ç†å¤šä¸ªè¿æ¥å’Œè¯·æ±‚</li>
<li>åªæœ‰åœ¨è¿æ¥çœŸæ­£æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰ä¼šè¿›è¡Œè¯»å†™ï¼Œå°±å¤§å¤§åœ°å‡å°‘äº†ç³»ç»Ÿå¼€é”€ï¼Œå¹¶ä¸”ä¸å¿…ä¸ºæ¯ä¸ªè¿æ¥éƒ½åˆ›å»ºä¸€ä¸ªçº¿ç¨‹</li>
<li>é¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¯¼è‡´çš„å¼€é”€</li>
</ul>
<blockquote>
<p>ç±»åŠç›¸å…³æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Class | Method</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public abstract class Selector implements Closeable</td>
<td align="center">æŠ½è±¡ç±»</td>
</tr>
<tr>
<td align="center">public static Selector open()</td>
<td align="center">å¾—åˆ°ä¸€ä¸ªé€‰æ‹©å™¨å¯¹è±¡</td>
</tr>
<tr>
<td align="center">public int select(long timeout)</td>
<td align="center">ç›‘æ§æ‰€æœ‰æ³¨å†Œçš„é€šé“ï¼Œå‚æ•°ç”¨æ¥è®¾ç½®è¶…æ—¶æ—¶é—´</td>
</tr>
<tr>
<td align="center">public Set<SelectionKey> selectedKeys()</td>
<td align="center">ä»å†…éƒ¨é›†åˆä¸­å¾—åˆ°æ‰€æœ‰çš„SelectionKeâ€™y</td>
</tr>
</tbody></table>
<blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li>å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œä¼šé€šè¿‡<code>ServerSocketChannel</code>å¾—åˆ°<code>SocketChannel</code></li>
<li>å°†<code>SocketChannel</code>æ³¨å†Œåˆ°<code>Selector</code>ä¸Šï¼Œæ³¨å†Œåè¿”å›ä¸€ä¸ª<code>SelectionKey</code></li>
<li><code>Selector</code>è¿›è¡Œç›‘å¬<code>select</code>æ–¹æ³•ï¼Œè¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„é€šé“çš„ä¸ªæ•°</li>
<li>è¿›ä¸€æ­¥å¾—åˆ°å„ä¸ª<code>SelectionKey</code></li>
<li>åœ¨é€šé“<code>SelectionKey</code>åå‘è·å–<code>SocketChannel</code>ï¼Œæ–¹æ³•<code>channel()</code></li>
<li>å¯ä»¥å¾—åˆ°æ‰€æœ‰çš„<code>channel</code>ï¼Œå®Œæˆä¸šåŠ¡å¤„ç†</li>
</ul>
<h4 id="1-2-3-ç¼–ç¨‹"><a href="#1-2-3-ç¼–ç¨‹" class="headerlink" title="1.2.3 ç¼–ç¨‹"></a>1.2.3 ç¼–ç¨‹</h4><blockquote>
<p>å°†æ•°æ®å†™å…¥åˆ°æœ¬åœ°æ–‡ä»¶</p>
</blockquote>
<pre><code class="java">    public static void write(String s) throws IOException &#123;
        // åˆ›å»ºè¾“å‡ºæµ â€”â€”&gt; channel
        FileOutputStream fileOutputStream = new FileOutputStream(&quot;D:\\Java\\Test\\K1.txt&quot;);

        // é€šè¿‡ fileOutputStream è·å– å¯¹åº”çš„ FileChannel
        // è¿™ä¸ª fileChannel çœŸå®ç±»å‹æ˜¯  FileChannelImpl
        FileChannel fileChannel = fileOutputStream.getChannel();

        // åˆ›å»ºä¸€ä¸ªç¼“å†²åŒº ByteBuffer
        ByteBuffer byteBuffer = ByteBuffer.allocate(1024);

        // å°† s æ”¾å…¥ byteBuffer
        byteBuffer.put(s.getBytes());

        // å¯¹ byteBuffer è¿›è¡Œflip
        byteBuffer.flip();

        // å°† byteBuffer æ•°æ®å†™å…¥åˆ° fileChannel
        fileChannel.write(byteBuffer);
        fileOutputStream.close();
    &#125;</code></pre>
<blockquote>
<p>ä»æœ¬åœ°æ–‡ä»¶è¯»å–æ•°æ®</p>
</blockquote>
<pre><code class="java">    public static void read(String path) throws IOException &#123;
        // åˆ›å»ºæ–‡ä»¶çš„è¾“å…¥æµ
        File file = new File(path);
        FileInputStream fileInputStream = new FileInputStream(file);

        // é€šè¿‡ fileInputStream è·å–å¯¹åº”çš„ FileChannel â€”â€”&gt;  å®é™…ç±»å‹ FileChannelImpl
        FileChannel fileChannel = fileInputStream.getChannel();

        // åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºByteBuffer
        ByteBuffer byteBuffer = ByteBuffer.allocate(1024);

        // å°† é€šé“çš„æ•°æ® è¯»å…¥åˆ° Buffer
        fileChannel.read(byteBuffer);

        // å°†byteBufferçš„å­—èŠ‚æ•°æ®è½¬æˆå­—ç¬¦ä¸²
        System.out.println(new String(byteBuffer.array()));
        fileInputStream.close();
    &#125;</code></pre>
<blockquote>
<p>æ‹·è´æ–‡ä»¶</p>
</blockquote>
<pre><code class="java">    public static void copy(String source, String destination) throws IOException &#123;
        FileInputStream fileInputStream = new FileInputStream(source);
        FileChannel fileChannel1 = fileInputStream.getChannel();

        FileOutputStream fileOutputStream = new FileOutputStream(destination);
        FileChannel fileChannel2 = fileOutputStream.getChannel();

        ByteBuffer byteBuffer = ByteBuffer.allocate(1024);

        while (true) &#123;
            // å¤ä½ï¼Œé‡ç½®æ ‡å¿—ä½
            byteBuffer.clear();

            int read = fileChannel1.read(byteBuffer);
            if (read == -1) &#123;// è¡¨ç¤ºè¯»å®Œ
                break;
            &#125;
            // å°†bufferä¸­çš„æ•°æ®å†™å…¥åˆ°fileChannel02 -- K2.txt
            byteBuffer.flip();
            fileChannel2.write(byteBuffer);
        &#125;
        fileOutputStream.close();
        fileInputStream.close();
    &#125;</code></pre>
<blockquote>
<p>ä½¿ç”¨transferFromå®Œæˆæ‹·è´</p>
</blockquote>
<pre><code class="java">    public static void copyImage(String fromPath, String toPath) throws IOException &#123;
        // åˆ›å»ºç›¸å…³æµ
        FileInputStream fileInputStream = new FileInputStream(fromPath);
        FileOutputStream fileOutputStream = new FileOutputStream(toPath);

        // è·å–Channel
        FileChannel sourceChannel = fileInputStream.getChannel();
        FileChannel destinChannel = fileOutputStream.getChannel();

        // ä½¿ç”¨transferFromå®Œæˆæ‹·è´
        destinChannel.transferFrom(sourceChannel, 0, sourceChannel.size());

        // å…³é—­ç›¸å…³æµ
        sourceChannel.close();
        destinChannel.close();
        fileInputStream.close();
        fileOutputStream.close();
    &#125;</code></pre>
<blockquote>
<p>bufferæ•°ç»„å®Œæˆè¯»å†™æ“ä½œ</p>
</blockquote>
<pre><code class="java">// Scattering: å°†æ•°æ®å†™å…¥åˆ°bufferæ—¶ï¼Œå¯ä»¥é‡‡ç”¨bufferæ•°ç»„ï¼Œä¾æ¬¡å†™å…¥[åˆ†æ•£]
// Gathering: ä»bufferè¯»å–æ•°æ®æ—¶ï¼Œå¯ä»¥é‡‡ç”¨bufferæ•°ç»„ï¼Œä¾æ¬¡è¯»å–[èšé›†]
public class ScatteringAndGatheringTest &#123;

    public static void demo() throws Exception&#123;
        // ä½¿ç”¨ServerSocketChannel å’Œ SocketChannel ç½‘ç»œ
        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
        InetSocketAddress inetSocketAddress = new InetSocketAddress(7000);

        // ç»‘å®šç«¯å£åˆ°Socketï¼Œå¹¶å¯åŠ¨
        serverSocketChannel.socket().bind(inetSocketAddress);

        // åˆ›å»ºbufferæ•°ç»„
        ByteBuffer[] byteBuffers = new ByteBuffer[2];
        byteBuffers[0] = ByteBuffer.allocate(5);
        byteBuffers[1] = ByteBuffer.allocate(3);

        // ç­‰å®¢æˆ·ç«¯è¿æ¥
        SocketChannel socketChannel = serverSocketChannel.accept();
        int messageLength = 8;

        // å¾ªç¯çš„è¯»å–
        while (true) &#123;
            int byteRead = 0;

            while (byteRead &lt; messageLength) &#123;
                long l = socketChannel.read(byteBuffers);
                byteRead  += l;
                System.out.println(&quot;byteRead = &quot; + byteRead);
                Arrays.asList(byteBuffers)
                        .stream()
                        .map(buffer -&gt; &quot;position = &quot;
                                + buffer.position()
                                + &quot;, limit = &quot;
                                + buffer.limit())
                        .forEach(System.out::println);

                // å°†æ‰€æœ‰çš„bufferåè½¬
                Arrays.asList(byteBuffers).forEach(buffer -&gt; buffer.flip());

                // å°†æ•°æ®è¯»å‡ºæ˜¾ç¤ºåˆ°å®¢æˆ·ç«¯
                long byteWrite = 0;
                while (byteWrite &lt; messageLength) &#123;
                    socketChannel.write(byteBuffers);
                    byteWrite += 1;
                &#125;

                // å°†æ‰€æ¬²çš„bufferè¿›è¡Œclear
                Arrays.asList(byteBuffers).forEach(buffer -&gt; &#123;
                    buffer.clear();
                &#125;);

                System.out.println(
                                &quot;byteRead = &quot; + byteRead
                                + &quot;, byteWrite = &quot; + byteWrite
                                + &quot;, messageLength = &quot; + messageLength);
            &#125;
        &#125;
    &#125;</code></pre>
<h4 id="1-2-4-å®ä¾‹"><a href="#1-2-4-å®ä¾‹" class="headerlink" title="1.2.4 å®ä¾‹"></a>1.2.4 å®ä¾‹</h4><p><strong>ç¾¤èŠç³»ç»ŸDemo</strong></p>
<p>ç¼–ç æ­¥éª¤ï¼š</p>
<ol>
<li>å½“å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œä¼šé€šè¿‡<code>ServerSocketChannel</code> å¾—åˆ° SocketChannel</li>
<li>Selector è¿›è¡Œç›‘å¬ select æ–¹æ³•, è¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„é€šé“çš„ä¸ªæ•°.</li>
<li>å°†socketChannelæ³¨å†Œåˆ°Selectorä¸Š, register(Selector sel, int ops), ä¸€ä¸ªselectorä¸Šå¯ä»¥æ³¨å†Œå¤šä¸ªSocketChannel</li>
<li>æ³¨å†Œåè¿”å›ä¸€ä¸ª SelectionKey, ä¼šå’Œè¯¥Selector å…³è”(é›†åˆ)</li>
<li>è¿›ä¸€æ­¥å¾—åˆ°å„ä¸ª SelectionKey (æœ‰äº‹ä»¶å‘ç”Ÿ)</li>
<li>åœ¨é€šè¿‡ SelectionKey åå‘è·å– SocketChannel , æ–¹æ³• channel()</li>
<li>åˆ¤æ–­è¯¥Channelçš„äº‹ä»¶ç±»å‹ï¼Œå¯¹ä¸åŒäº‹ä»¶è¿›è¡Œä¸åŒçš„ä¸šåŠ¡å¤„ç†</li>
</ol>
<blockquote>
<p>NIOServer</p>
</blockquote>
<pre><code class="java">package com.kag.nio.groupchat;

import org.apache.log4j.Logger;
import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.*;
import java.util.Iterator;

/**
 * @Author: KHighness
 * @Date: 2020/9/19 22:59
 * @Description:
 */

public class GroupChatServer &#123;

    private Logger log = Logger.getLogger(GroupChatServer.class);

    private Selector selector;

    private ServerSocketChannel listenChannel;

    private final int PORT = 3333;

    public GroupChatServer() &#123;
        try &#123;
            // 1ã€è·å–é€‰æ‹©å™¨
            selector = Selector.open();
            // 2ã€è·å–é€šé“
            listenChannel = ServerSocketChannel.open();
            // 3ã€ç»‘å®šç«¯å£
            listenChannel.socket().bind(new InetSocketAddress(PORT));
            // 4ã€è®¾ç½®éé˜»å¡
            listenChannel.configureBlocking(false);
            // 5ã€å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ï¼Œæ³¨å†Œæ“ä½œï¼šâ€œæ¥æ”¶â€
            listenChannel.register(selector, SelectionKey.OP_ACCEPT);
        &#125; catch (IOException e) &#123;
            log.info(e.getMessage());
        &#125;
    &#125;

    // ç›‘å¬
    public void listen() &#123;
        try &#123;
            // 6ã€é‡‡ç”¨è½®è¯¢çš„æ–¹å¼ï¼ŒæŸ¥è¯¢è·å–â€œå‡†å¤‡å°±ç»ªâ€çš„æ³¨å†Œè¿‡çš„æ“ä½œ
            while (true) &#123;
                int count = selector.select();
                if (count &gt; 0) &#123;
                    // 7ã€è·å–å½“å‰é€‰æ‹©å™¨ä¸­æ‰€æœ‰æ³¨å†Œçš„é€‰æ‹©é”®
                    Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();
                    while (iterator.hasNext()) &#123;
                        // 8ã€è·å–â€œå‡†å¤‡å°±ç»ªâ€çš„æ—¶é—´
                        SelectionKey selectionKey = iterator.next();

                        // 9ã€åˆ¤æ–­selectionKeyæ˜¯å…·ä½“çš„ä»€ä¹ˆäº‹ä»¶
                        // ç›‘å¬åˆ°acceptäº‹ä»¶
                        if (selectionKey.isAcceptable()) &#123;
                            // 10ã€è‹¥æ¥å—çš„äº‹ä»¶æ˜¯â€œæ¥æ”¶å°±ç»ªâ€æ“ä½œï¼Œå°±è·å–å®¢æˆ·ç«¯è¿æ¥
                            SocketChannel socketChannel = listenChannel.accept();
                            // 11ã€åˆ‡æ¢ä¸ºéé˜»å¡æ¨¡å¼
                            socketChannel.configureBlocking(false);
                            // å°†è¯¥é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š
                            socketChannel.register(selector, SelectionKey.OP_READ);
                            log.info(&quot;[&quot; + socketChannel.getRemoteAddress().toString().substring(1) + &quot;]ä¸Šçº¿&quot;);
                        &#125;

                        // ç›‘å¬åˆ°readäº‹ä»¶
                        if (selectionKey.isReadable()) &#123;
                            // å¤„ç†è¯» (ä¸“é—¨æ–¹æ³•)
                            readMessage(selectionKey);
                        &#125;

                        // endï¼šç§»é™¤é€‰æ‹©é”®ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
                        iterator.remove();

                    &#125;
                &#125; else &#123;
                    log.info(&quot;ç­‰å¾…Â·Â·Â·Â·&quot;);
                &#125;
            &#125;
        &#125; catch (IOException e) &#123;
            log.error(e.getMessage());
        &#125;
    &#125;

    // è¯»å–å®¢æˆ·ç«¯æ¶ˆæ¯
    public void readMessage(SelectionKey selectionKey) &#123;
        // å®šä¹‰ä¸€ä¸ª SocketChannel
        SocketChannel socketChannel = null;
        try &#123;
            // 13ã€è·å–è¯¥é€‰æ‹©å™¨ä¸Šçš„â€œè¯»å°±ç»ªâ€çŠ¶æ€çš„é€šé“
            socketChannel = (SocketChannel) selectionKey.channel();
            // 14ã€è¯»å–æ•°æ®
            ByteBuffer buffer = ByteBuffer.allocate(1024);

            int count = socketChannel.read(buffer);
            // æ ¹æ®countçš„hå€¼åšå¤„ç†
            if (count &gt; 0) &#123;
                // æŠŠç¼“å­˜åŒºçš„æ•°æ®è½¬æˆå­—ç¬¦ä¸²
                String msg = new String(buffer.array());
                // è¾“å‡ºè¯¥æ¶ˆæ¯
                log.info(&quot;å®¢æˆ·ç«¯-&quot; + msg);
                // å‘å…¶ä»–å®¢æˆ·ç«¯è½¬å‘æ¶ˆæ¯(æ’é™¤è‡ªå·±)ï¼Œä¸“é—¨å†™ä¸€ä¸ªæ–¹æ³•æ¥å¤„ç†
                sendMessageToOtherClients(msg, socketChannel);
            &#125;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
            try &#123;
                log.info(&quot;[&quot; + socketChannel.getRemoteAddress().toString().substring(1) + &quot;]ç¦»çº¿&quot;);
                // å–æ¶ˆæ³¨å†Œ
                selectionKey.cancel();
                // å…³é—­é€šé“
                socketChannel.close();
            &#125; catch (IOException ioException) &#123;
                log.error(e.getMessage());
            &#125;
        &#125;
    &#125;

    // è½¬å‘æ¶ˆæ¯ç»™å…¶ä»–å®¢æˆ·
    private void sendMessageToOtherClients(String msg, SocketChannel self) throws IOException &#123;
        log.info(&quot;æœåŠ¡å™¨è½¬å‘æ¶ˆæ¯&quot;);
        // éå†æ‰€æœ‰æ³¨å†Œåˆ° selector ä¸Šçš„SocketChannelï¼Œå¹¶æ’é™¤self
        for (SelectionKey key : selector.keys()) &#123;
            // é€šè¿‡ key å–å‡º å¯¹åº”çš„ SocketChannel
            Channel targetChannel = key.channel();
            // æ’é™¤è‡ªå·±
            if (targetChannel instanceof SocketChannel &amp;&amp; targetChannel != self) &#123;
                // è½¬å‹
                SocketChannel dest = (SocketChannel) targetChannel;
                // å°†msgå­˜å‚¨åˆ°buffer
                ByteBuffer byteBuffer = ByteBuffer.wrap(msg.getBytes());
                // å°†bufferçš„æ•°æ®å†™å…¥é€šé“
                dest.write(byteBuffer);
            &#125;
        &#125;
    &#125;

    public static void main(String[] args) &#123;
        // åˆ›å»ºæœåŠ¡å™¨å¯¹è±¡
        GroupChatServer groupChatServer = new GroupChatServer();
        groupChatServer.listen();
    &#125;
&#125;</code></pre>
<blockquote>
<p>NIOClient</p>
</blockquote>
<pre><code class="java">package com.kag.nio.groupchat;

import org.apache.log4j.Logger;
import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.SocketChannel;
import java.util.Iterator;
import java.util.Scanner;

/**
 * @Author: KHighness
 * @Date: 2020/9/20 0:53
 * @Description:
 */

public class GroupChatClient &#123;

    private Logger log = Logger.getLogger(GroupChatClient.class);

    private final String HOST = &quot;127.0.0.1&quot;;

    private final int    PORT = 3333;

    private Selector selector;

    private SocketChannel socketChannel;

    private String username;

    // æ„é€ å™¨
    public GroupChatClient() throws IOException &#123;
        selector = Selector.open();
        // è¿æ¥æœåŠ¡å™¨
        socketChannel = socketChannel.open(new InetSocketAddress(HOST, PORT));
        // è®¾ç½®éé˜»å¡
        socketChannel.configureBlocking(false);
        // å°†socketChannelæ³¨å†Œåˆ°selector
        socketChannel.register(selector, SelectionKey.OP_READ);
        // å¾—åˆ°username
        username = socketChannel.getLocalAddress().toString().substring(1);
        log.info(&quot;[&quot; + username + &quot;]å·²å°±ç»ªÂ·Â·Â·&quot;);
    &#125;

    // å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯
    public void sendMessage(String msg) &#123;
        msg = username + &quot;: &quot; + msg;
        try &#123;
            socketChannel.write(ByteBuffer.wrap(msg.getBytes()));
        &#125; catch (IOException e) &#123;
            log.error(e.getMessage());
        &#125;
    &#125;

    // ä»æœåŠ¡å™¨å›å¤çš„æ¶ˆæ¯
    public void readMessage() &#123;
        try &#123;
            int readChannels = selector.select();
            if (readChannels &gt; 0) &#123;
                Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();
                while (iterator.hasNext()) &#123;
                    SelectionKey key = iterator.next();
                    if (key.isReadable()) &#123;
                        // å¾—åˆ°ç›¸å…³çš„é€šé“
                        SocketChannel socketChannel = (SocketChannel) key.channel();
                        // å¾—åˆ°ä¸€ä¸ªbuffer
                        ByteBuffer buffer = ByteBuffer.allocate(1024);
                        // è¯»å–
                        socketChannel.read(buffer);
                        // æŠŠè¯»åˆ°çš„ç¼“å†²åŒºçš„æ•°æ®è½¬æˆå­—ç¬¦ä¸²
                        String msg = new String(buffer.array());
                        log.info(msg);
                    &#125;
                &#125;
                // åˆ é™¤å½“å‰ SelectionKey
                iterator.remove();
            &#125; else &#123;
                //log.error(&quot;æ— å¯ç”¨çš„é€šé“Â·Â·Â·&quot;);
            &#125;
        &#125; catch (Exception e) &#123;
            log.error(e.getMessage());
        &#125;
    &#125;

    public static void main(String[] args) throws Exception&#123;
        // å¯åŠ¨å®¢æˆ·ç«¯
        GroupChatClient chatClient = new GroupChatClient();

        // å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯éš”3ç§’ï¼Œè¯»å–ä»æœåŠ¡å™¨
        new Thread() &#123;
            public void run() &#123;
                while (true) &#123;
                    chatClient.readMessage();
                    try &#123;
                        Thread.currentThread().sleep(3000);
                    &#125; catch (InterruptedException e) &#123;
                        System.err.println(e.getMessage());
                    &#125;
                &#125;
            &#125;
        &#125;.start();

        // å‘é€æ•°æ®ç»™æœåŠ¡å™¨
        Scanner scanner = new Scanner(System.in);
        while (scanner.hasNextLine()) &#123;
            String s = scanner.nextLine();
            chatClient.sendMessage(s);
        &#125;
    &#125;
&#125;</code></pre>
<h4 id="1-2-5-é›¶æ‹·è´"><a href="#1-2-5-é›¶æ‹·è´" class="headerlink" title="1.2.5 é›¶æ‹·è´"></a>1.2.5 é›¶æ‹·è´</h4><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><p>é›¶æ‹·è´ï¼Œæ˜¯ä»OS(æ“ä½œç³»ç»Ÿ)çš„è§’åº¦æ¥è¯´çš„ã€‚å› ä¸ºå†…æ ¸ç¼“å†²åŒºä¹‹é—´ï¼Œæ²¡æœ‰æ•°æ®æ˜¯é‡å¤çš„</p>
</li>
<li><p>é›¶æ‹·è´ä¸ä»…ä»…å¸¦æ¥æ›´å°‘çš„æ•°æ®å¤åˆ¶ï¼Œè¿˜èƒ½å¸¦æ¥å…¶ä»–çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œæ›´å°‘çš„CPUç¼“å­˜ä¼ªå…±äº«ä»¥åŠæ— CPUæ ¡éªŒå’Œè®¡ç®—</p>
</li>
</ul>
<blockquote>
<p>mmap</p>
</blockquote>
<ul>
<li>mmapé€šè¿‡å†…å­˜æ˜ å°„ï¼Œå°†æ–‡ä»¶æ˜ å°„åˆ°å†…æ ¸ç¼“å†²åŒºï¼ŒåŒæ—¶ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥å…±äº«å†…æ ¸ç©ºé—´çš„æ•°æ®ã€‚è¿™æ ·ï¼Œåœ¨è¿›è¡Œç½‘ç»œä¼ è¾“æ—¶ï¼Œå°±å¯ä»¥å‡å°‘å†…æ ¸ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„æ‹·è´æ¬¡æ•°</li>
</ul>
<blockquote>
<p>mmapå’ŒsendFileçš„åŒºåˆ«</p>
</blockquote>
<ul>
<li>mmpé€‚åˆå°æ•°æ®é‡è¯»å†™ï¼ŒsendFileé€‚åˆå¤§æ–‡ä»¶ä¼ è¾“</li>
<li>mmapéœ€è¦4æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ3æ¬¡æ•°æ®æ‹·è´ï¼›sendFileéœ€è¦3æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæœ€å°‘2æ¬¡æ•°æ®æ‹·è´</li>
<li>sendFileå¯ä»¥åˆ©ç”¨DMA(direct memory access: ç›´æ¥å†…å­˜æ‹·è´)æ–¹å¼ï¼Œå‡å°‘CPUæ‹·è´ï¼Œmmapåˆ™ä¸èƒ½(å¿…é¡»ä»å†…æ ¸æ‹·è´åˆ°Socketç¼“å†²åŒº)</li>
</ul>
<h2 id="2-æ¦‚è¿°"><a href="#2-æ¦‚è¿°" class="headerlink" title="2. æ¦‚è¿°"></a>2. æ¦‚è¿°</h2><p>å®˜ç½‘: <a href="https://netty.io/">Netty.io</a></p>
<h3 id="1-1-ä»‹ç»"><a href="#1-1-ä»‹ç»" class="headerlink" title="1.1 ä»‹ç»"></a>1.1 ä»‹ç»</h3><p>Nettyæ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤çš„é«˜æ€§èƒ½åè®®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚</p>
<h3 id="1-2-è®¾è®¡"><a href="#1-2-è®¾è®¡" class="headerlink" title="1.2 è®¾è®¡"></a>1.2 è®¾è®¡</h3><ul>
<li>é€‚ç”¨äºå„ç§ä¼ è¾“ç±»å‹çš„ç»Ÿä¸€API-é˜»å¡å’Œéé˜»å¡å¥—æ¥å­—</li>
<li>åŸºäºçµæ´»ä¸”å¯æ‰©å±•çš„äº‹ä»¶æ¨¡å‹ï¼Œå¯å°†å…³æ³¨ç‚¹æ˜ç¡®åˆ†ç¦»</li>
<li>é«˜åº¦å¯å®šåˆ¶çš„çº¿ç¨‹æ¨¡å‹-å•çº¿ç¨‹ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ± ï¼Œä¾‹å¦‚SEDA</li>
<li>çœŸæ­£çš„æ— è¿æ¥æ•°æ®æŠ¥å¥—æ¥å­—æ”¯æŒï¼ˆä»3.1å¼€å§‹ï¼‰</li>
</ul>
<h3 id="1-3-æ€§èƒ½"><a href="#1-3-æ€§èƒ½" class="headerlink" title="1.3 æ€§èƒ½"></a>1.3 æ€§èƒ½</h3><ul>
<li>æ›´é«˜çš„ååé‡ï¼Œæ›´ä½çš„å»¶è¿Ÿ</li>
<li>å‡å°‘èµ„æºæ¶ˆè€—</li>
<li>å‡å°‘ä¸å¿…è¦çš„å†…å­˜å¤åˆ¶</li>
</ul>
<h3 id="1-4-æ¶æ„"><a href="#1-4-æ¶æ„" class="headerlink" title="1.4 æ¶æ„"></a>1.4 æ¶æ„</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200921092848809.png" class="" title="image-20200921092848809">



<h2 id="3-Reactor"><a href="#3-Reactor" class="headerlink" title="3. Reactor"></a>3. Reactor</h2><h3 id="2-1-ä»‹ç»"><a href="#2-1-ä»‹ç»" class="headerlink" title="2.1 ä»‹ç»"></a>2.1 ä»‹ç»</h3><blockquote>
<p>ååº”å™¨æ¨¡å¼  |  åˆ†å‘è€…æ¨¡å¼  |  é€šçŸ¥è€…æ¨¡å¼</p>
</blockquote>
<ul>
<li>åŸºäºI/Oå¤ç”¨æ¨¡å‹: å¤šä¸ªè¿æ¥å…±ç”¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦å†ä¸€ä¸ªé˜»å¡å¯¹è±¡ç­‰å¾…ï¼Œæ— éœ€é˜»å¡ç­‰å¾…æ‰€æœ‰è¿æ¥ã€‚å½“æŸä¸ªè¿æ¥æœ‰æ–°çš„æ•°æ®å¯ä»¥å¤„ç†æ—¶ï¼Œæ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œçº¿ç¨‹ä»é˜»å¡çŠ¶æ€è¿”å›ï¼Œå¼€å§‹è¿›è¡Œä¸šåŠ¡å¤„ç†</li>
<li>åŸºäºçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹èµ„æº: ä¸å¿…å†ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºçº¿ç¨‹ï¼Œé”®è¿æ¥å®Œæˆåçš„ä¸šåŠ¡å¤„ç†çƒ­èˆåˆ†é…ç»™çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡</li>
</ul>
<h3 id="2-2-ç»„æˆ"><a href="#2-2-ç»„æˆ" class="headerlink" title="2.2 ç»„æˆ"></a>2.2 ç»„æˆ</h3><ul>
<li>Reactor: Reactoråœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œï¼Œè´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œåˆ†å‘ç»™é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å¯¹IOäº‹ä»¶åšå‡ºååº”ã€‚</li>
<li>Handlers: å¤„ç†ç¨‹åºæ‰§è¡ŒI/Oäº‹ä»¶è¦å®Œæˆçš„å®é™…äº‹ä»¶ã€‚Reactoré€šè¿‡è°ƒåº¦é€‚å½“çš„å¤„ç†ç¨‹åºæ¥å“åº”I/Oäº‹ä»¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œéé˜»å¡æ“ä½œã€‚</li>
</ul>
<h3 id="2-3-åˆ†ç±»"><a href="#2-3-åˆ†ç±»" class="headerlink" title="2.3 åˆ†ç±»"></a>2.3 åˆ†ç±»</h3><ul>
<li>å•Reactorå•çº¿ç¨‹        â”â”â”â”â”â–¶    å‰å°æ¥å¾…å‘˜å’ŒæœåŠ¡å‘˜æ˜¯åŒä¸€ä¸ªäººï¼Œå…¨ç¨‹ä¸ºé¡¾å®¢æœåŠ¡</li>
<li>å•Reactorå¤šçº¿ç¨‹        â”â”â”â”â”â–¶    1ä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡å‘˜ï¼Œæ¥å¾…å‘˜åªè´Ÿè´£æ¥å¾…</li>
<li>ä¸»ä»Reactorå¤šçº¿ç¨‹    â”â”â”â”â”â–¶    å¤šä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡ç”Ÿ</li>
</ul>
<h4 id="2-2-1-å•Reactorå•çº¿ç¨‹"><a href="#2-2-1-å•Reactorå•çº¿ç¨‹" class="headerlink" title="2.2.1 å•Reactorå•çº¿ç¨‹"></a>2.2.1 å•Reactorå•çº¿ç¨‹</h4><blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200921181936951.png" class="" title="image-20200921181936951">

<blockquote>
<p>åˆ†æ</p>
</blockquote>
<ol>
<li>ä¼˜ç‚¹ï¼šæ¨¡å‹ç®€å•ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹ã€è¿›ç¨‹é€šä¿¡ã€ç«äº‰çš„é—®é¢˜ï¼Œå…¨éƒ¨éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆ</li>
<li>ç¼ºç‚¹ï¼šæ€§èƒ½é—®é¢˜ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ— æ³•å‘æŒ¥å¤šæ ¸CPUçš„æ€§èƒ½ã€‚<code>Handler</code>åœ¨å¤„ç†æŸä¸ªè¿æ¥ä¸Šçš„ä¸šåŠ¡æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–è¿æ¥äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆ</li>
<li>ç¼ºç‚¹ï¼šå¯é æ€§é—®é¢˜ï¼Œçº¿ç¨‹æ„å¤–ç»ˆæ­¢ï¼Œæˆ–è€…è¿›å…¥æ­»å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿé€šä¿¡æ¨¡å—ä¸å¯ç”¨ï¼Œä¸èƒ½æ¥æ”¶å’Œå¤„ç†å¤–éƒ¨æ¶ˆæ¯ï¼Œé€ æˆèŠ‚ç‚¹æ•…éšœ</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šå®¢æˆ·ç«¯çš„æ•°é‡æœ‰é™ï¼Œä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿ</li>
</ol>
<h4 id="2-2-2-å•Reactorå¤šçº¿ç¨‹"><a href="#2-2-2-å•Reactorå¤šçº¿ç¨‹" class="headerlink" title="2.2.2 å•Reactorå¤šçº¿ç¨‹"></a>2.2.2 å•Reactorå¤šçº¿ç¨‹</h4><blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200921182914960.png" class="" title="image-20200921182914960">

<blockquote>
<p>æ–¹æ¡ˆè¯´æ˜</p>
</blockquote>
<ol>
<li><code>Reactor</code>å¯¹è±¡é€šè¿‡<code>select</code>ç›‘æ§å®¢æˆ·ç«¯è¯·æ±‚äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡<code>dispatch</code>è¿›è¡Œåˆ†å‘</li>
<li>å¦‚æœå»ºç«‹è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”±<code>Acceptor</code>é€šè¿‡<code>accept</code>å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç„¶åä»é»„å¥ä¸€ä¸ªHandlerå¯¹è±¡å¤„ç†å®Œæˆè¿æ¥åçš„å„ç§äº‹ä»¶</li>
<li>å¦‚æœä¸æ˜¯è¿æ¥è¯·æ±‚ï¼Œåˆ™ç”±<code>Reactor</code>åˆ†å‘è°ƒç”¨è¿æ¥å¯¹åº”çš„<code>handler</code>è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„<code>Worker</code>çº¿ç¨‹æ± çš„æŸä¸ªçº¿ç¨‹å¤„ç†ä¸šåŠ¡</li>
<li><code>Handler</code>åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸åšå…·ä½“çš„ä¸šåŠ¡å¤„ç†ï¼Œé€šè¿‡<code>read</code>è¯»å–æ•°æ®åï¼Œä¼šåˆ†å‘ç»™åé¢çš„<code>worker</code>çº¿ç¨‹æ± çš„æŸä¸ªçº¿ç¨‹å¤„ç†ä¸šåŠ¡</li>
<li><code>Worker</code>çº¿ç¨‹æ± ä¼šåˆ†é…ç‹¬ç«‹çº¿ç¨‹å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™<code>Handler</code></li>
<li><code>Handler</code>æ”¶åˆ°å“åº”åï¼Œé€šè¿‡<code>send</code>å°†ç»“æœè¿”å›ç»™<code>Client</code></li>
</ol>
<blockquote>
<p>åˆ†æ</p>
</blockquote>
<ol>
<li>ä¼˜ç‚¹ï¼šå¯ä»¥å……åˆ†çš„åˆ©ç”¨å¤šæ ¸<code>CPU</code>çš„å¤„ç†èƒ½åŠ›</li>
<li>ç¼ºç‚¹ï¼šå¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚ï¼Œ<code>Reactor</code>å¤„ç†æ‰€æœ‰çš„äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåœ¨å•çº¿ç¨‹è¿è¡Œï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯å®¹æ˜“æˆä¸ºæ€§èƒ½ç“¶é¢ˆ</li>
</ol>
<h4 id="2-2-3-ä¸»ä»Reactorå¤šçº¿ç¨‹"><a href="#2-2-3-ä¸»ä»Reactorå¤šçº¿ç¨‹" class="headerlink" title="2.2.3 ä¸»ä»Reactorå¤šçº¿ç¨‹"></a>2.2.3 ä¸»ä»Reactorå¤šçº¿ç¨‹</h4><blockquote>
<p>å›¾ç¤º</p>
</blockquote>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200921191731035.png" class="" title="image-20200921191731035">

<blockquote>
<p>æ–¹æ¡ˆè¯´æ˜</p>
</blockquote>
<ol>
<li><code>Reactor</code>ä¸»çº¿ç¨‹<code>MainReactor</code>å¯¹è±¡é€šè¿‡<code>select</code>ç›‘å¬è¿æ¥äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œé€šè¿‡<code>Acceptor</code>å¤„ç†è¿æ¥äº‹ä»¶</li>
<li>å½“<code>Acceptor</code>å¤„ç†è¿æ¥äº‹ä»¶åï¼Œ<code>MainReactor</code>å°†è¿æ¥åˆ†é…ç»™<code>SubReactor</code></li>
<li><code>SubReactor</code>å°†è¿æ¥åŠ å…¥åˆ°è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ›å»º<code>Handler</code>è¿›è¡Œå„ç§äº‹ä»¶å¤„ç†</li>
<li>å½“æœ‰æ–°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ<code>SubReactor</code>å°±ä¼šè°ƒç”¨å¯¹åº”çš„Handlerå¤„ç†</li>
<li><code>Worker</code>çº¿ç¨‹æ± åˆ†é…ç‹¬ç«‹çš„<code>Worker</code>çº¿ç¨‹è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œå¹¶è¿”å›ç»“æœ</li>
<li><code>Handler</code>æ”¶åˆ°å“åº”çš„ç»“æœåï¼Œå†é€šè¿‡<code>send</code>å°†ç»“æœè¿”å›ç»™<code>Client</code></li>
<li><code>Reactor</code>ä¸»çº¿ç¨‹å¯ä»¥å¯¹äºå¤šä¸ª<code>Reactor</code>å­çº¿ç¨‹ï¼Œå³<code>MainReactor</code>ï¼Œå¯ä»¥å…³è”å¤šä¸ª<code>SubReactor</code></li>
</ol>
<blockquote>
<p>åˆ†æ</p>
</blockquote>
<ol>
<li><p>ä¼˜ç‚¹ï¼šçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„èŒè´£æ˜ç¡®ï¼Œçˆ¶çº¿ç¨‹åªéœ€è¦æ¥æ”¶æ–°è¿æ¥ï¼Œå­çº¿ç¨‹å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†</p>
</li>
<li><p>ä¼˜ç‚¹ï¼šçˆ¶çº¿ç¨‹ä¸å­çº¿ç¨‹çš„æ•°æ®äº¤äº’ç®€å•ï¼Œ<code>Reactor</code>ä¸»çº¿ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹æ— éœ€è¿”å›æ•°æ®</p>
</li>
<li><p>ç¼ºç‚¹ï¼šç¼–ç¨‹å¤æ‚åº¦è¾ƒé«˜</p>
</li>
</ol>
<h3 id="2-4-ä¼˜ç‚¹"><a href="#2-4-ä¼˜ç‚¹" class="headerlink" title="2.4 ä¼˜ç‚¹"></a>2.4 ä¼˜ç‚¹</h3><ul>
<li>å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥æ—¶é—´æ‰€é˜»å¡ï¼Œè™½ç„¶<code>Reactor</code>æœ¬èº«ä¾ç„¶æ˜¯åŒæ­¥çš„</li>
<li>å¯ä»¥æœ€å¤§ç¨‹åº¦çš„æ¯”æ›¼å¤æ‚çš„å¤šçº¿ç¨‹åŠåŒæ­¥é—®é¢˜ï¼Œå¹¶ä¸”é¿å…äº†å¤šçº¿ç¨‹/è¿›ç¨‹çš„åˆ‡æ¢å¼€é”€</li>
<li>æ‰©å±•æ€§å¥½ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡å¢åŠ <code>Reactor</code>å®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©ç”¨CPUèµ„æº</li>
<li>å¤ç”¨æ€§å¥½ï¼Œ<code>Reactor</code>æ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘æ— å…³ï¼Œå…·æœ‰å¾ˆé«˜çš„å¤ç”¨æ€§</li>
</ul>
<h2 id="4-æ¶æ„"><a href="#4-æ¶æ„" class="headerlink" title="4. æ¶æ„"></a>4. æ¶æ„</h2><h3 id="3-1-å›¾ç¤º"><a href="#3-1-å›¾ç¤º" class="headerlink" title="3.1 å›¾ç¤º"></a>3.1 å›¾ç¤º</h3><img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20200921204851799.png" class="" title="image-20200921204851799">

<h3 id="3-2-è¯´æ˜"><a href="#3-2-è¯´æ˜" class="headerlink" title="3.2 è¯´æ˜"></a>3.2 è¯´æ˜</h3><ol>
<li><code>Netty</code>æŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ± <code>BossGroup</code>ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œ<code>WorkerGroup</code>ä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™</li>
<li><code>BossGroup</code>å’Œ<code>WorkerGroup</code>ç±»å‹çš„æœ¬è´¨éƒ½æ˜¯<code>NioEventLoopGroup</code></li>
<li><code>NioEventLoopGroup</code>ç›¸å½“äºä¸€ä¸ªäº‹ä»¶å¾ªç¯ç»„ï¼Œè¿™ä¸ªç»„ä¸­å«æœ‰å¤šä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯æ˜¯<code>NioEventLoop</code></li>
<li><code>NioEventLoop</code>è¡¨ç¤ºä¸€ä¸ªä¸æ–­å¾ªç¯çš„æ‰§è¡Œå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œæ¯ä¸ª<code>NioEventLoop</code>éƒ½æœ‰ä¸€ä¸ª<code>selector</code>ï¼Œç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„socketçš„ç½‘ç»œé€šè®¯</li>
<li><code>NioEventLoopGroup</code>å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå³å¯ä»¥å«æœ‰å¤šä¸ª<code>NioEventLoop</code></li>
<li>æ¯ä¸ª<code>Boss NioEventLoop</code>å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤æœ‰ä¸‰æ­¥:<ol>
<li>è½®è¯¢<code>accept</code>äº‹ä»¶</li>
<li>å¤„ç†<code>accept</code>äº‹ä»¶ï¼Œä¸<code>client</code>å»ºç«‹è¿æ¥ï¼Œç”Ÿæˆ<code>NioSocketChannel</code>ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°æŸä¸ª<code>Worker NioEventLoop</code>ä¸Šçš„<code>selector</code></li>
<li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³<code>runAllTasks</code></li>
</ol>
</li>
<li>æ¯ä¸ª<code>Worker NIOEventLoop</code>å¾ªç¯æ‰§è¡Œçš„æ­¥éª¤<ol>
<li>è½®è¯¢<code>read</code>ã€<code>write</code>äº‹ä»¶</li>
<li>å¤„ç†i/oäº‹ä»¶ï¼Œå³<code>read</code>ã€<code>write</code>äº‹ä»¶ï¼Œåœ¨å¯¹åº”<code>NioSocketChannel</code>å¤„ç†</li>
<li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³<code>runAllTasks</code></li>
</ol>
</li>
</ol>
<h3 id="3-3-ä»£ç ç¤ºä¾‹"><a href="#3-3-ä»£ç ç¤ºä¾‹" class="headerlink" title="3.3 ä»£ç ç¤ºä¾‹"></a>3.3 ä»£ç ç¤ºä¾‹</h3><blockquote>
<p>NettyServer.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.simple;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.*;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;

/**
 * @author: KHighness
 * @date: 2020/9/21 21:53
 * @apiNote:
 */

public class NettyServer &#123;

    public static void main(String[] args) throws Exception&#123;

        /*
         * åˆ›å»ºBossGroup å’Œ WorkerGroup
         * è¯´æ˜ï¼š
         * 1ã€åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„ï¼šbossGroup å’Œ workerGroup
         * 2ã€bossGroupå¤„ç†è¿æ¥è¯·æ±‚
         * 3ã€workerGroupå¤„ç†å’Œå®¢æˆ·ç«¯çš„ä¸šåŠ¡
         * 4ã€ä¸¤ä¸ªéƒ½æ˜¯æ— é™å¾ªç¯
         */
        EventLoopGroup bossGroup = new NioEventLoopGroup();
        NioEventLoopGroup workerGroup = new NioEventLoopGroup();

        try &#123;
            // åˆ›å»ºæœåŠ¡å™¨ç«¯çš„å¯åŠ¨å¯¹è±¡ï¼Œé…ç½®å‚æ•°
            ServerBootstrap bootstrap = new ServerBootstrap();

            // ä½¿ç”¨é“¾å¼ç¼–ç¨‹æ¥è¿›è¡Œè®¾ç½®
            bootstrap.group(workerGroup, workerGroup)                         // è®¾ç½®ä¸¤ä¸ªçº¿ç¨‹ç»„
                    .channel(NioServerSocketChannel.class)                    // ä½¿ç”¨NioSocketChannelä½œä¸ºæœåŠ¡å™¨çš„é€šé“å®ç°
                    .option(ChannelOption.SO_BACKLOG, 128)              // è®¾ç½®çº¿ç¨‹é˜Ÿåˆ—å¾—åˆ°è¿æ¥ä¸ªæ•°
                    .childOption(ChannelOption.SO_KEEPALIVE, true)      // è®¾ç½®ä¿æŒæ´»åŠ¨è¿æ¥çŠ¶æ€
                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;   // åˆ›å»ºä¸€ä¸ªé€šé“æµ‹è¯•å¯¹è±¡
                        // ç»™Pipelineè®¾ç½®å¤„ç†å™¨
                        @Override
                        protected void initChannel(SocketChannel socketChannel) throws Exception &#123;
                            socketChannel.pipeline().addLast(new NettyServerHandler());
                        &#125;
                    &#125;);  // ç»™workerGroupçš„EventLoopå¯¹åº”çš„ç®¡é“è®¾ç½®å¤„ç†å™¨

            System.out.println(&quot;æœåŠ¡å™¨å·²å°±ç»ªÂ·Â·Â·&quot;);

            // ç»‘å®šä¸€ä¸ªç«¯å£å¹¶ä¸”åŒæ­¥
            // ç»‘å®šç«¯å£å¹¶å¯åŠ¨æœåŠ¡å™¨
            ChannelFuture channelFuture = bootstrap.bind(3333).sync();

            // å¯¹å…³é—­é€šé“è¿›è¡Œç›‘å¬
            channelFuture.channel().closeFuture().sync();
        &#125; finally &#123;
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        &#125;
    &#125;
&#125;</code></pre>
<blockquote>
<p>NettyHandler.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.simple;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.util.CharsetUtil;

/**
 * @author: KHighness
 * @date: 2020/9/21 22:20
 * @apiNote:
 */

/**
 * è¯´æ˜ï¼š
 * è‡ªå®šä¹‰ä¸€ä¸ªHandleréœ€è¦ç»§æ‰¿Nettyè§„å®šå¥½çš„æŸä¸ªHandlerAdapter
 */
public class NettyServerHandler extends ChannelInboundHandlerAdapter &#123;

    /**
     * è¯»å–æ•°æ®äº‹ä»¶
     * @param ctx ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå«æœ‰ç®¡é“pipline[å¤„ç†æ•°æ®]ï¼Œé€šé“channel[ä¼ è¾“æ•°æ®]ï¼Œåœ°å€
     * @param msg å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
     * @throws Exception
     */
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;
        System.out.println(&quot;server ctx = &quot; + ctx);
        // å°†msgè½¬æˆByteBuffer
        ByteBuf byteBuf = (ByteBuf) msg;
        System.out.println(&quot;å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š&quot; + byteBuf.toString(CharsetUtil.UTF_8));
        System.out.println(&quot;å®¢æˆ·ç«¯åœ°å€ï¼š&quot; + ctx.channel().remoteAddress());
    &#125;

    /**
     * æ•°æ®è¯»å–å®Œæ¯•
     * @param ctx
     * @throws Exception
     */
    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception &#123;
        // å°†æ•°æ®å†™å…¥åˆ°ç¼“å­˜ï¼Œå¹¶åˆ·æ–°
        ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;Hello, å®¢æˆ·ç«¯~&quot;, CharsetUtil.UTF_8));
    &#125;

    /**
     * å¤„ç†å¼‚å¸¸
     * @param ctx
     * @param cause
     * @throws Exception
     */
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;
        System.out.println(cause.getMessage());
        ctx.close();
    &#125;
&#125;</code></pre>
<blockquote>
<p>NettyClient.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.simple;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.util.CharsetUtil;

/**
 * @author: KHighness
 * @date: 2020/9/21 22:20
 * @apiNote:
 */

/**
 * è¯´æ˜ï¼š
 * è‡ªå®šä¹‰ä¸€ä¸ªHandleréœ€è¦ç»§æ‰¿Nettyè§„å®šå¥½çš„æŸä¸ªHandlerAdapter
 */
public class NettyServerHandler extends ChannelInboundHandlerAdapter &#123;

    /**
     * è¯»å–æ•°æ®äº‹ä»¶
     * @param ctx ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå«æœ‰ç®¡é“pipline[å¤„ç†æ•°æ®]ï¼Œé€šé“channel[ä¼ è¾“æ•°æ®]ï¼Œåœ°å€
     * @param msg å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
     * @throws Exception
     */
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;
        System.out.println(&quot;server ctx = &quot; + ctx);
        // å°†msgè½¬æˆByteBuffer
        ByteBuf byteBuf = (ByteBuf) msg;
        System.out.println(&quot;å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š&quot; + byteBuf.toString(CharsetUtil.UTF_8));
        System.out.println(&quot;å®¢æˆ·ç«¯åœ°å€ï¼š&quot; + ctx.channel().remoteAddress());
    &#125;

    /**
     * æ•°æ®è¯»å–å®Œæ¯•
     * @param ctx
     * @throws Exception
     */
    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception &#123;
        // å°†æ•°æ®å†™å…¥åˆ°ç¼“å­˜ï¼Œå¹¶åˆ·æ–°
        ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;Hello, å®¢æˆ·ç«¯~&quot;, CharsetUtil.UTF_8));
    &#125;

    /**
     * å¤„ç†å¼‚å¸¸
     * @param ctx
     * @param cause
     * @throws Exception
     */
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;
        System.out.println(cause.getMessage());
        ctx.close();
    &#125;
&#125;
</code></pre>
<blockquote>
<p>NettyClientHandler.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.simple;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.util.CharsetUtil;

/**
 * @author: KHighness
 * @date: 2020/9/22 19:09
 * @apiNote:
 */

public class NettyClientHandler extends ChannelInboundHandlerAdapter &#123;

    /**
     * é€šé“å°±ç»ª-&gt;è§¦å‘
     * @param ctx
     * @throws Exception
     */
    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;
        System.out.println(&quot;client &quot; +  ctx);
        ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;Hello, server~å–µ&quot;, CharsetUtil.UTF_8));
    &#125;

    /**
     * æœ‰è¯»å–äº‹ä»¶æ—¶-&gt;è§¦å‘
     * @param ctx
     * @param msg
     * @throws Exception
     */
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;
        ByteBuf byteBuf = (ByteBuf) msg;
        System.out.println(&quot;æœåŠ¡å™¨å›å¤æ¶ˆæ¯ï¼š&quot; + byteBuf.toString(CharsetUtil.UTF_8));
        System.out.println(&quot;æœåŠ¡å™¨çš„åœ°å€ï¼š&quot; + ctx.channel().remoteAddress());
    &#125;

    /**
     * å¤„ç†å¼‚å¸¸
     * @param ctx
     * @param cause
     * @throws Exception
     */
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;
        System.out.println(cause.getMessage());
        ctx.close();
    &#125;
&#125;</code></pre>
<h3 id="3-4-ä»»åŠ¡é˜Ÿåˆ—"><a href="#3-4-ä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="3.4 ä»»åŠ¡é˜Ÿåˆ—"></a>3.4 ä»»åŠ¡é˜Ÿåˆ—</h3><p>ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„<code>Task</code>æœ‰ä¸‰ç§å…¸å‹ä½¿ç”¨åœºæ™¯</p>
<ul>
<li>ç”¨æˆ·ç¨‹åºè‡ªå®šä¹‰çš„æ™®é€šä»»åŠ¡</li>
<li>ç”¨æˆ·è‡ªå®šä¹‰å®šæ—¶ä»»åŠ¡</li>
<li>éå½“å‰<code>Reactor</code>çº¿ç¨‹è°ƒç”¨<code>Channel</code>çš„å„ç§æ–¹æ³•</li>
</ul>
<h3 id="3-5-å¼‚æ­¥æ¨¡å‹"><a href="#3-5-å¼‚æ­¥æ¨¡å‹" class="headerlink" title="3.5 å¼‚æ­¥æ¨¡å‹"></a>3.5 å¼‚æ­¥æ¨¡å‹</h3><h4 id="3-5-1-åŸºæœ¬ä»‹ç»"><a href="#3-5-1-åŸºæœ¬ä»‹ç»" class="headerlink" title="3.5.1 åŸºæœ¬ä»‹ç»"></a>3.5.1 åŸºæœ¬ä»‹ç»</h4><ol>
<li>å¼‚æ­¥çš„æ¦‚å¿µå’ŒåŒæ­¥ç›¸å¯¹ã€‚å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœã€‚å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„ç»„ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…</li>
<li><code>Netty</code>ä¸­çš„I/Oæ“ä½œæ˜¯å¼‚æ­¥çš„ï¼ŒåŒ…æ‹¬<code>Bind</code>ã€<code>Write</code>ã€<code>Connect</code>ç­‰æ“ä½œä¼šç®€å•çš„è¿”å›ä¸€ä¸ª<code>ChannelFuture</code></li>
<li>è°ƒç”¨è€…å¹¶ä¸èƒ½ç†ç§‘è·å¾—ç»“æœï¼Œè€Œæ˜¯é€šè¿‡Future-Listeneræœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿çš„ä¸»åŠ¨è·å–æˆ–è€…é€šè¿‡é€šçŸ¥æœºåˆ¶è·å¾—IOæ“ä½œç»“æœ</li>
<li><code>Netty</code>çš„å¼‚æ­¥æ¨¡å‹æ˜¯å»ºç«‹åœ¨<code>future</code>å’Œ<code>callback</code>ä¹‹ä¸Šçš„ã€‚<code>callback</code>å°±æ˜¯å›è°ƒã€‚é‡ç‚¹æ˜¯<code>future</code>ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šç»“ç¤¾ä¸€ä¸ªæ–¹æ³•<code>fun</code>ï¼Œè®¡ç®—è¿‡ç¨‹å¯èƒ½éå¸¸è€—æ—¶ï¼Œç­‰å¾…<code>fun</code>è¿”å›æ˜¾ç„¶ä¸åˆé€‚ã€‚é‚£ä¹ˆå¯ä»¥åœ¨è°ƒç”¨<code>fun</code>çš„æ—¶å€™ç«‹é©¬è¿”å›ä¸€ä¸ª<code>future</code>ï¼Œåç»­å¯ä»¥é€šè¿‡<code>future</code>å»ç›‘æ§æ–¹æ³•<code>fun</code>çš„å¤„ç†è¿‡ç¨‹</li>
</ol>
<h4 id="3-5-2-Futureè¯´æ˜"><a href="#3-5-2-Futureè¯´æ˜" class="headerlink" title="3.5.2 Futureè¯´æ˜"></a>3.5.2 Futureè¯´æ˜</h4><ol>
<li><p>è¡¨ç¤ºå¼‚æ­¥çš„æ‰§è¡Œç»“æœï¼Œå¯ä»¥é€šè¿‡å®ƒæä¾›çš„æ–¹æ³•æ¥æ£€æµ‹æ‰§è¡Œæ˜¯å¦å®Œæˆ</p>
</li>
<li><p><code>ChannelFuture</code>æ˜¯ä¸€ä¸ªæ¥å£: public interface ChannelFuture extends Future<Void></p>
<p>æˆ‘ä»¬å¯ä»¥æ·»åŠ ç›‘å¬å™¨ï¼Œå½“ç›‘å¬çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šé€šçŸ¥åˆ°ç›‘å¬å™¨</p>
</li>
</ol>
<h4 id="3-5-3-Future-Listeneræœºåˆ¶"><a href="#3-5-3-Future-Listeneræœºåˆ¶" class="headerlink" title="3.5.3 Future-Listeneræœºåˆ¶"></a>3.5.3 Future-Listeneræœºåˆ¶</h4><ol>
<li><p>å½“<code>future</code>å¯¹è±¡åˆšåˆšåˆ›å»ºæ—¶ï¼Œå¤„äºéå®ŒæˆçŠ¶æ€ï¼Œè°ƒç”¨è€…å¯ä»¥é€šè¿‡è¿”å›çš„<code>ChannelFuture</code>æ¥è·å–æ“ä½œæ‰§è¡Œçš„çŠ¶æ€ï¼Œæ³¨å†Œç›‘å¬å‡½æ•°æ¥æ‰§è¡Œå®Œæˆåçš„æ“ä½œ</p>
</li>
<li><p>å¸¸è§æ“ä½œï¼š</p>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">isDone()</td>
<td align="center">åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦å®Œæˆ</td>
</tr>
<tr>
<td align="center">isSuccess()</td>
<td align="center">åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦æˆåŠŸ</td>
</tr>
<tr>
<td align="center">getCause()</td>
<td align="center">è·å–å·²å®Œæˆçš„å½“å‰æ“ä½œå¤±è´¥çš„åŸå› </td>
</tr>
<tr>
<td align="center">isCancelled()</td>
<td align="center">åˆ¤æ–­å·²å®Œæˆçš„å½“å‰æ“ä½œæ˜¯å¦è¢«å–æ¶ˆ</td>
</tr>
<tr>
<td align="center">addListener()</td>
<td align="center">æ³¨å†Œç›‘å¬å™¨ï¼Œå½“æ“ä½œå·²å®Œæˆ(isDoneè¿”å›å®Œæˆ)ï¼Œå°†ä¼šé€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨ï¼›å¦‚æœFutureå¯¹è±¡å·²å®Œæˆï¼Œåˆ™é€šçŸ¥æŒ‡å®šçš„ç›‘å¬å™¨</td>
</tr>
</tbody></table>
</li>
</ol>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="java">            // ç»‘å®šä¸€ä¸ªç«¯å£å¹¶ä¸”åŒæ­¥
            // ç»‘å®šç«¯å£å¹¶å¯åŠ¨æœåŠ¡å™¨
            ChannelFuture CF = bootstrap.bind(3333).sync();

            // ç»™CFæ³¨å†Œç›‘å¬å™¨
            CF.addListener(new ChannelFutureListener() &#123;
                @Override
                public void operationComplete(ChannelFuture channelFuture) throws Exception &#123;
                    if (CF.isSuccess()) &#123;
                        System.out.println(&quot;æœåŠ¡å™¨ç›‘å¬ç«¯å£[3333]æˆåŠŸ&quot;);
                    &#125; else &#123;
                        System.out.println(&quot;æœåŠ¡å™¨ç›‘å¬ç«¯å£[3333]å¤±è´¥&quot;);
                    &#125;
                &#125;
            &#125;);</code></pre>
<h3 id="3-6-HttpæœåŠ¡"><a href="#3-6-HttpæœåŠ¡" class="headerlink" title="3.6 HttpæœåŠ¡"></a>3.6 HttpæœåŠ¡</h3><blockquote>
<p>TestServer.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.http;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.nio.NioServerSocketChannel;

/**
 * @author: KHighness
 * @date: 2020/9/26 10:34
 * @apiNote:
 */

public class TestServer &#123;
    public static void main(String[] args) &#123;

        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();

        try &#123;
            ServerBootstrap serverBootstrap = new ServerBootstrap();
            serverBootstrap.group(bossGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .childHandler(new TestServerInitializer());

            ChannelFuture CF = serverBootstrap.bind(3333).sync();

            CF.channel().closeFuture().sync();

        &#125; catch (InterruptedException e) &#123;
            System.out.println(e.getMessage());
        &#125; finally&#123;
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        &#125;
    &#125;
&#125;</code></pre>
<blockquote>
<p>TestServerInitializer.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.http;

import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelPipeline;
import io.netty.channel.socket.SocketChannel;
import io.netty.handler.codec.http.HttpServerCodec;

/**
 * @author: KHighness
 * @date: 2020/9/26 10:39
 * @apiNote:
 */

public class TestServerInitializer extends ChannelInitializer&lt;SocketChannel&gt; &#123;
    @Override
    protected void initChannel(SocketChannel socketChannel) throws Exception &#123;
        // å‘ç®¡é“åŠ å…¥å¤„ç†å™¨

        // å¾—åˆ°ç®¡é“
        ChannelPipeline pipeline = socketChannel.pipeline();

        // åŠ å…¥ä¸€ä¸ªNettyæä¾›çš„HttpServerCodeC codec =&gt; [coder - decoder]
        // 1ã€HttpServerCodeC: å¤„ç†httpçš„ç¼–&amp;è§£ç å™¨
        pipeline.addLast(&quot;MyHttpServerCodec&quot;, new HttpServerCodec());
        // 2ã€å¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰handler
        pipeline.addLast(&quot;MyTestServerHandler&quot;, new TestHttpServerHandler());
    &#125;
&#125;</code></pre>
<blockquote>
<p>TestHttpServerHandler.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.http;

import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelPipeline;
import io.netty.channel.socket.SocketChannel;
import io.netty.handler.codec.http.HttpServerCodec;

/**
 * @author: KHighness
 * @date: 2020/9/26 10:39
 * @apiNote:
 */

public class TestServerInitializer extends ChannelInitializer&lt;SocketChannel&gt; &#123;
    @Override
    protected void initChannel(SocketChannel socketChannel) throws Exception &#123;
        // å‘ç®¡é“åŠ å…¥å¤„ç†å™¨

        // å¾—åˆ°ç®¡é“
        ChannelPipeline pipeline = socketChannel.pipeline();

        // åŠ å…¥ä¸€ä¸ªNettyæä¾›çš„HttpServerCodeC codec =&gt; [coder - decoder]
        // 1ã€HttpServerCodeC: å¤„ç†httpçš„ç¼–&amp;è§£ç å™¨
        pipeline.addLast(&quot;MyHttpServerCodec&quot;, new HttpServerCodec());
        // 2ã€å¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰handler
        pipeline.addLast(&quot;MyTestServerHandler&quot;, new TestHttpServerHandler());
    &#125;
&#125;</code></pre>
<h2 id="5-æ ¸å¿ƒ"><a href="#5-æ ¸å¿ƒ" class="headerlink" title="5. æ ¸å¿ƒ"></a>5. æ ¸å¿ƒ</h2><h3 id="4-1-BootStrapã€ServerBootStrap"><a href="#4-1-BootStrapã€ServerBootStrap" class="headerlink" title="4.1 BootStrapã€ServerBootStrap"></a>4.1 BootStrapã€ServerBootStrap</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p><code>BootStrap</code>æ„æ€æ˜¯å¼•å¯¼ç¨‹åºï¼Œä¸€ä¸ª<code>Netty</code>åº”ç”¨é€šå¸¸ç”±ä¸€ä¸ª<code>BootStrap</code>å¼€å§‹ï¼Œä¸»è¦ä½œç”¨æ˜¯é…ç½®æ•´ä¸ª<code>Netty</code>ç¨‹åºï¼Œä¸²è”å„ä¸ªç»„ä»¶ï¼Œ<code>Netty</code>ä¸­<code>BootStrap</code>ç±»æ˜¯å®¢æˆ·ç«¯ç¨‹åºçš„å¯åŠ¨å¼•å¯¼ç±»ï¼Œ<code>ServerBootStrap</code>æ˜¯æœåŠ¡å™¨ç«¯å¯åŠ¨å¼•å¯¼ç±»</p>
<blockquote>
<p>å¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public ServerBootStrap group(EventLoopGroup parentGroup, EventLoopGroup childGroup)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œç”¨æ¥è®¾ç½®ä¸¤ä¸ªEventLoop</td>
</tr>
<tr>
<td align="center">public B group(EventLoopGroup group)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨äºå®¢æˆ·ç«¯ï¼Œç”¨æ¥è®¾ç½®ä¸€ä¸ªEventLoop</td>
</tr>
<tr>
<td align="center">public B channel(Class&lt;? extends C&gt; channelClass)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨ç«¯çš„é€šé“å®ç°</td>
</tr>
<tr>
<td align="center">public <T> B option(ChannelOption<T> option, T value)</td>
<td align="center">ç”¨æ¥ç»™ServerChannelæ·»åŠ é…ç½®</td>
</tr>
<tr>
<td align="center">public  ServerBootstrap childOption(ChannelOption childOption, T value)</td>
<td align="center">ç”¨æ¥ç»™æ¥æ”¶åˆ°çš„é€šé“æ·»åŠ é…ç½®</td>
</tr>
<tr>
<td align="center">public ServerBootstrap childHandler(ChannelHandler childHandler)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®ä¸šåŠ¡å¤„ç†ç±»(è‡ªå®šä¹‰çš„handler)</td>
</tr>
<tr>
<td align="center">public ChannelFuture bind(int inetPort)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨äºæœåŠ¡å™¨ç«¯ï¼Œç”¨æ¥è®¾ç½®å ç”¨çš„ç«¯å£å·</td>
</tr>
<tr>
<td align="center">public ChannelFuture connect(String inetHost, int inetPort)</td>
<td align="center">è¯¥æ–¹æ³•ç”¨äºå®¢æˆ·ç«¯ï¼Œç”¨æ¥è¿æ¥æœåŠ¡å™¨</td>
</tr>
</tbody></table>
<h3 id="4-2-Futureã€ChannelFuture"><a href="#4-2-Futureã€ChannelFuture" class="headerlink" title="4.2 Futureã€ChannelFuture"></a>4.2 Futureã€ChannelFuture</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p><code>Netty</code>ä¸­æ‰€æœ‰çš„IOæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸èƒ½ç«‹åˆ»å¾—çŸ¥æ¶ˆæ¯æ˜¯å¦è¢«æ­£ç¡®å¤„ç†ã€‚ä½†æ˜¯å¯ä»¥è¿‡ä¸€ä¼šç­‰å®ƒæ‰§è¡Œå®Œæˆ–è€…ç›´æ¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå…·ä½“çš„å®ç°å°±æ˜¯é€šè¿‡<code>Future</code>å’Œ<code>ChannelFuture</code>ï¼Œå®ƒä»¬å¯ä»¥æ³¨å†Œä¸€ä¸ªç›‘å¬ï¼Œå½“æ“ä½œæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥æ—¶ç›‘å¬ä¼šè‡ªåŠ¨è§¦å‘æ³¨å†Œçš„ç›‘å¬äº‹ä»¶</p>
<blockquote>
<p>å¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Channel channel()</td>
<td align="center">è¿”å›å½“å‰æ­£åœ¨è¿›è¡ŒIOæ“ä½œçš„é€šé“</td>
</tr>
<tr>
<td align="center">ChannelFuture sync()</td>
<td align="center">ç­‰å¾…å¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œæ¯•ï¼Œç›¸å½“äºå°†é˜»å¡åœ¨å½“å‰</td>
</tr>
</tbody></table>
<h3 id="4-3-Channel"><a href="#4-3-Channel" class="headerlink" title="4.3 Channel"></a>4.3 Channel</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><code>Netty</code>ç½‘ç»œé€šä¿¡çš„ç»„ä»¶ï¼Œèƒ½å¤Ÿç”¨äºæ‰§è¡Œç½‘ç»œI/Oæ“ä½œ</li>
<li>é€šè¿‡<code>Channel</code>å¯è·å¾—å½“å‰ç½‘ç»œè¿æ¥çš„é€šé“çš„çŠ¶æ€</li>
<li>é€šè¿‡<code>Channel</code>å¯è·å¾—ç½‘ç»œè¿æ¥çš„é…ç½®å‚æ•°</li>
<li><code>Channel</code>é€šè¿‡å¼‚æ­¥çš„ç½‘ç»œI/Oæ“ä½œ(æ¯”å¦‚ï¼šå»ºç«‹è¿æ¥ã€è¯»å†™å’Œç»‘å®šç«¯å£)ï¼Œå¼‚æ­¥è°ƒç”¨æ„å‘³ç€ä»»ä½•I/Oè°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ï¼Œå¹¶ä¸”ä¸ä¿è¯åœ¨è°ƒç”¨ç»“æŸæ—¶æ‰€è¯·æ±‚çš„I/Oæ“ä½œå·²å®Œæˆ</li>
<li>è°ƒç”¨ç«‹å³è¿”å›ä¸€ä¸ª<code>ChannelFuture</code>å®ä¾‹ï¼Œé€šè¿‡æ³¨å†Œå™¨åˆ°<code>ChannelFuture</code>ä¸Šï¼Œå¯ä»¥I/Oæ“ä½œæˆåŠŸã€å¤±è´¥æˆ–å–æ¶ˆæ—¶å›è°ƒé€šçŸ¥è°ƒç”¨æ–¹ </li>
<li>æ”¯æŒå…³è”I/Oæ“ä½œä¸å¯¹åº”çš„å¤„ç†ç¨‹åº</li>
<li>ä¸åŒåè®®ã€ä¸åŒçš„é˜»å¡ç±»å‹çš„è¿æ¥éƒ½æœ‰ä¸åŒçš„<code>Channel</code>ç±»å‹ä¸ä¹‹å¯¹åº”</li>
</ul>
<blockquote>
<p>å¸¸è§Channelç±»å‹</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">åç§°</th>
<th align="center">ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">NioSocketChannel</td>
<td align="center">å¼‚æ­¥çš„å®¢æˆ·ç«¯TCP Socketè¿æ¥</td>
</tr>
<tr>
<td align="center">NioServerSocketChannel</td>
<td align="center">å¼‚æ­¥çš„æœåŠ¡å™¨ç«¯TCP Socketè¿æ¥</td>
</tr>
<tr>
<td align="center">NioDatagramChannel</td>
<td align="center">å¼‚æ­¥çš„UDPè¿æ¥</td>
</tr>
<tr>
<td align="center">NioSctpChannel</td>
<td align="center">å¼‚æ­¥çš„å®¢æˆ·ç«¯Sctpè¿æ¥</td>
</tr>
<tr>
<td align="center">NioSctpServerChannel</td>
<td align="center">å¼‚æ­¥çš„SctpæœåŠ¡å™¨ç«¯è¿æ¥ï¼Œè¿™äº›é€šé“æ¶µç›–äº†UDPå’ŒTCPç½‘ç»œI/Oä»¥åŠæ–‡ä»¶I/O</td>
</tr>
</tbody></table>
<h3 id="4-4-Selector"><a href="#4-4-Selector" class="headerlink" title="4.4 Selector"></a>4.4 Selector</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><code>Netty</code>åŸºäº<code>Selector</code>å¯¹è±¡å®ç°I/Oå¤šè·¯å¤ç”¨ï¼Œé€šè¿‡<code>Selector</code>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘å¬å¤šä¸ªè¿æ¥çš„<code>Channel</code>äº‹ä»¶</li>
<li>å½“å‘ä¸€ä¸ª<code>Selector</code>ä¸­æ³¨å†Œ<code>Channel</code>åï¼Œ<code>Selector</code>å†…éƒ¨çš„æœºåˆ¶å°±å¯ä»¥è‡ªåŠ¨ä¸æ–­åœ°æŸ¥è¯¢(<code>Select</code>)è¿™äº›æ³¨å†Œçš„<code>Channel</code>æ˜¯å¦æœ‰å·²å°±ç»ªçš„I/Oäº‹ä»¶(æ¯”å¦‚ï¼šå¯è¯»ã€å¯å†™ã€ç½‘ç»œè¿æ¥å®Œæˆç­‰)ï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥å¾ˆç®€å•åœ°ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹é«˜æ•ˆåœ°ç®¡ç†å¤šä¸ª<code>Channel</code></li>
<li>åŒæ—¶ï¼Œ<code>Netty</code>ä¸­å¯¹<code>Selector</code>ä¸­çš„<code>selectedKey</code>é›†åˆè¿›è¡Œäº†æ›¿æ¢ï¼Œå®ƒæ›¿æ¢æˆäº†ä¸€ä¸ªå®ƒè‡ªå·±å®ç°çš„ä¸€ä¸ª<code>set</code>é›†åˆï¼Œè¿™æ ·æ•ˆç‡æ›´é«˜</li>
</ul>
<h3 id="4-5-ChannelHandleråŠå…¶å®ç°ç±»"><a href="#4-5-ChannelHandleråŠå…¶å®ç°ç±»" class="headerlink" title="4.5 ChannelHandleråŠå…¶å®ç°ç±»"></a>4.5 ChannelHandleråŠå…¶å®ç°ç±»</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><p><code>ChannelHandler</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¤„ç†I/Oäº‹ä»¶æˆ–æ‹¦æˆªI/Oæ“ä½œï¼Œå¹¶å°†å…¶è½¬å‘åˆ°<code>ChannelPipeline</code>(ä¸šåŠ¡å¤„ç†é“¾)ä¸­çš„ä¸‹ä¸€ä¸ªå¤„ç†ç¨‹åº</p>
</li>
<li><p><code>ChannelHandler</code>æœ¬èº«å¹¶æ²¡æœ‰æä¾›å¾ˆå¤šæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ¥å£æœ‰è®¸å¤šçš„æ–¹æ³•éœ€è¦å®ç°ï¼Œæ–¹ä¾¿ä½¿ç”¨æœŸé—´ï¼Œå¯ä»¥ç»§æ‰¿å®ƒçš„å­ç±»</p>
</li>
<li><p>æˆ‘ä»¬ç»å¸¸éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ª<code>Handler</code>ç±»å–ç»§æ‰¿<code>ChannelInboundHandlerAdapter</code>ï¼Œç„¶åé€šè¿‡é‡å†™ç›¸åº”æ–¹æ³•å®ç°ä¸šåŠ¡é€»è¾‘</p>
<p>ä¸€èˆ¬éœ€è¦é‡å†™çš„æ–¹æ³•</p>
<pre><code class="java">public class ChannelInboundHandlerAdapter extends ChannelHandlerAdapter implements ChannelInboundHandler &#123;

    //é€šé“æ³¨å†Œäº‹ä»¶
    @Skip
    @Override
    public void channelRegistered(ChannelHandlerContext ctx) throws Exception &#123;
        ctx.fireChannelRegistered();
    &#125;

    //é€šé“å–æ¶ˆæ³¨å†Œäº‹ä»¶
    @Skip
    @Override
    public void channelUnregistered(ChannelHandlerContext ctx) throws Exception &#123;
        ctx.fireChannelUnregistered();
    &#125;

    //é€šé“å°±ç»ªäº‹ä»¶
    @Skip
    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;
        ctx.fireChannelActive();
    &#125;

    //é€šé“æ–­è”äº‹ä»¶
    @Skip
    @Override
    public void channelInactive(ChannelHandlerContext ctx) throws Exception &#123;
        ctx.fireChannelInactive();
    &#125;

    //é€šé“è¯»å–æ•°æ®äº‹ä»¶
    @Skip
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;
        ctx.fireChannelRead(msg);
    &#125;

    //é€šé“æ•°æ®è¯»å–å®Œæ¯•äº‹ä»¶
    @Skip
    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception &#123;
        ctx.fireChannelReadComplete();
    &#125;

    //ç”¨æ³•äº‹ä»¶è§¦å‘
    @Skip
    @Override
    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception &#123;
        ctx.fireUserEventTriggered(evt);
    &#125;

    //é€šé“å¯å†™æ€§æ›´æ”¹äº‹ä»¶
    @Skip
    @Override
    public void channelWritabilityChanged(ChannelHandlerContext ctx) throws Exception &#123;
        ctx.fireChannelWritabilityChanged();
    &#125;

    //é€šé“å‘ç”Ÿå¼‚å¸¸äº‹ä»¶
    @Skip
    @Override
    @SuppressWarnings(&quot;deprecation&quot;)
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
            throws Exception &#123;
        ctx.fireExceptionCaught(cause);
    &#125;
&#125;</code></pre>
<ul>
<li><code>ChannelInboundHandler</code>  ç”¨äºå¤„ç†å…¥ç«™I/Oäº‹ä»¶</li>
<li><code>ChannelOutboundHandler</code>  ç”¨äºå¤„ç†å‡ºæˆ˜I/Oäº‹ä»¶</li>
</ul>
<blockquote>
<p>é€‚é…å™¨</p>
</blockquote>
</li>
<li><p><code>ChannelInboundHandlerAdapter</code> ç”¨äºå¤„ç†å…¥ç«™ I/O äº‹ä»¶</p>
</li>
<li><p><code>ChannelOutboundHandlerAdapter</code> ç”¨äºå¤„ç†å‡ºç«™ I/O æ“ä½œ</p>
</li>
<li><p><code>ChannelDuplexHandler</code> ç”¨äºå¤„ç†å…¥ç«™å’Œå‡ºç«™äº‹ä»¶</p>
</li>
</ul>
<h3 id="4-6-Pipelineã€Channel"><a href="#4-6-Pipelineã€Channel" class="headerlink" title="4.6 Pipelineã€Channel"></a>4.6 Pipelineã€Channel</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><p><code>ChannelPipeline</code>æ˜¯ä¸€ä¸ªHandlerçš„é›†åˆï¼Œå®ƒè´Ÿè´£å¤„ç†å’Œæ‹¦æˆª<code>inbound</code>å’Œ<code>outbound</code>çš„äº‹ä»¶å’Œæ“ä½œï¼Œç›¸å½“äºä¸€ä¸ªè´¯ç©¿<code>Netty</code>çš„é“¾ï¼ˆé€šä¿—çš„è®²ï¼š<code>ChannelPipeline</code>æ˜¯ä¿å­˜<code>ChannelHandler</code>çš„<code>list</code>ï¼Œç”¨äºå¤„ç†æˆ–æ‹¦æˆª<code>Channel</code>çš„å…¥ç«™äº‹ä»¶å’Œå‡ºæˆ˜æ“ä½œï¼‰</p>
</li>
<li><p><code>ChanenelPipline</code>å®ç°äº†ä¸€ç§é«˜çº§å½¢å¼çš„æ‹¦æˆªè¿‡æ»¤å™¨æ¨¡å¼ï¼Œä½¿ç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶äº‹ä»¶çš„å¤„ç†æ–¹å¼ï¼Œä»¥åŠ<code>Channel</code>ä¸­å„ä¸ªçš„<code>ChannelHandler</code>å¦‚ä½•ç›¸äº’äº¤äº’</p>
</li>
<li><p>åœ¨<code>Netty</code>ä¸­æ¯ä¸ª<code>Channel</code>éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª<code>ChannelPipeline</code>ä¸ä¹‹å¯¹åº”ï¼Œä»–ä»¬çš„ç»„æˆå…³ç³»å¦‚ä¸‹</p>
<img src= "https://cdn.jsdelivr.net/gh/Khighness/cdn/common/loading.gif" data-lazy-src="/posts/1c6ba3e2/image-20201002192427279.png" class="" title="image-20201002192427279">
</li>
<li><p>ä¸€ä¸ª<code>Channel</code>åŒ…å«ä¸€ä¸ª<code>ChannelPipeline</code>ï¼Œè€Œ<code>ChannelPipeline</code>ä¸­åˆç»´æŠ¤äº†ä¸€ä¸ªç”±<code>ChannelHandlerContext</code>ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸”æ¯ä¸ª<code>ChannelHandlerContext</code>ä¸­åˆå…³è”ç€ä¸€ä¸ª<code>ChannelHandler</code></p>
</li>
<li><p>å…¥ç«™äº‹ä»¶å’Œå‡ºæˆ˜äº‹ä»¶åœ¨ä¸€ä¸ªåŒå‘é“¾è¡¨ä¸­ï¼Œå…¥ç«™äº‹ä»¶ä¼šä»é“¾è¡¨<code>head</code>å¾€åä¼ é€’åˆ°æœ€åä¸€ä¸ªå…¥ç«™çš„handlerï¼Œå‡ºç«™äº‹ä»¶ä¼šä»é“¾è¡¨<code>tail</code>å¾€å‰ä¼ é€’åˆ°æœ€å‰ä¸€ä¸ªå‡ºç«™çš„<code>handler</code>ï¼Œä¸¤ç§ç±»å‹çš„<code>handler</code>äº’ä¸å¹²æ‰°</p>
</li>
</ul>
<blockquote>
<p>å¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ChannelPipeline addFirst(ChannelHandlerâ€¦ handlers)</td>
<td align="center">æŠŠä¸€ä¸ªä¸šåŠ¡å¤„ç†ç±»ï¼ˆhandlerï¼‰æ·»åŠ åˆ°é“¾ä¸­çš„ç¬¬ä¸€ä¸ªä½ç½®</td>
</tr>
<tr>
<td align="center">ChannelPipeline addLast(ChannelHandlerâ€¦ handlers)</td>
<td align="center">æŠŠä¸€ä¸ªä¸šåŠ¡å¤„ç†ç±»ï¼ˆhandlerï¼‰æ·»åŠ åˆ°é“¾ä¸­çš„æœ€åä¸€ä¸ªä½ç½®</td>
</tr>
</tbody></table>
<h3 id="4-7-ChannelHandlerContext"><a href="#4-7-ChannelHandlerContext" class="headerlink" title="4.7 ChannelHandlerContext"></a>4.7 ChannelHandlerContext</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li>ä¿å­˜<code>Channel</code>ç›¸å…³çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒæ—¶å…³è”ä¸€ä¸ªChannelHandlerå¯¹è±¡</li>
<li>å³<code>ChannelHandlerContext</code>ä¸­åŒ…å«ä¸€ä¸ªå…·ä½“çš„äº‹ä»¶å¤„ç†å™¨<code>ChannelHandler</code>ï¼ŒåŒæ—¶<code>ChannelHandlerContext</code>ä¸­ä¹Ÿç»‘å®šäº†å¯¹åº”çš„<code>Pipeline</code>å’Œ<code>Channel</code>çš„ä¿¡æ¯ï¼Œæ–¹ä¾¿å¯¹<code>ChannelHandler</code>è¿›è¡Œè°ƒç”¨</li>
</ul>
<blockquote>
<p>å¸¸è§æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ChannelFuture close()</td>
<td align="center">å…³é—­é€šé“</td>
</tr>
<tr>
<td align="center">ChannelOutboundInvoker flush()</td>
<td align="center">åˆ·æ–°</td>
</tr>
<tr>
<td align="center">ChannelFuture writeAndFlush(Object msg)</td>
<td align="center">å°†æ•°æ®å†™åˆ°ChannelPipelineä¸­å½“å‰ChannelHandlerçš„ä¸‹ä¸€ä¸ªChannelHandlerå¼€å§‹å¤„ç†</td>
</tr>
</tbody></table>
<h3 id="4-8-ChannelOption"><a href="#4-8-ChannelOption" class="headerlink" title="4.8 ChannelOption"></a>4.8 ChannelOption</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p><code>Netty</code>åœ¨åˆ›å»º<code>Channel</code>å®ä¾‹åï¼Œä¸€èˆ¬éƒ½éœ€è¦è®¾ç½®<code>ChannelOption</code>å‚æ•°</p>
<blockquote>
<p>å‚æ•°å¦‚ä¸‹ï¼š</p>
</blockquote>
<ul>
<li>ChannelOption.SO_BACKLOG:<ul>
<li>å¯¹åº”TCP/IPåè®®listenå‡½æ•°ä¸­çš„backlogå‚æ•°ï¼Œç”¨æ¥åˆå§‹åŒ–æœåŠ¡å™¨å¯è¿æ¥é˜Ÿåˆ—å¤§å°</li>
<li>æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ˜¯é¡ºåºå¤„ç†çš„ï¼Œæ‰€ä»¥åŒä¸€æ—¶é—´åªèƒ½å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚å¤šä¸ªå®¢æˆ·ç«¯æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯å°†ä¸èƒ½å¤„ç†çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ”¾åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†ï¼Œbacklogå‚æ•°æŒ‡å®šäº†é˜Ÿåˆ—çš„å¤§å°</li>
</ul>
</li>
<li>ChannelOption.SO_KEEPALIVE:<ul>
<li>ä¸€ç›´ä¿æŒè¿æ¥æ´»åŠ¨çŠ¶æ€</li>
</ul>
</li>
</ul>
<h3 id="4-9-EventLoopGroupå’Œå…¶å®ç°ç±»NioEventLoopGroup"><a href="#4-9-EventLoopGroupå’Œå…¶å®ç°ç±»NioEventLoopGroup" class="headerlink" title="4.9 EventLoopGroupå’Œå…¶å®ç°ç±»NioEventLoopGroup"></a>4.9 EventLoopGroupå’Œå…¶å®ç°ç±»NioEventLoopGroup</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<ul>
<li><code>EventLoopGroup</code>æ˜¯ä¸€ç»„<code>EventLoop</code>çš„æŠ½è±¡ï¼Œ<code>Netty</code>ä¸ºäº†æ›´å¥½çš„åˆ©ç”¨å¤šæ ¸CPUèµ„æºï¼Œä¸€èˆ¬ä¼šæœ‰å¤šä¸ª<code>EventLoop</code>åŒæ—¶å·¥ä½œï¼Œæ¯ä¸ª<code>EventLoop</code>ç»´æŠ¤è€…ä¸€ä¸ªSelectorå®ä¾‹ã€‚</li>
<li><code>EventLoopGroup</code>æä¾›nextæ¥å£ï¼Œå¯ä»¥ä»ç»„é‡Œé¢æŒ‰ç…§ä¸€å®šè§„åˆ™è·å–å…¶ä¸­ä¸€ä¸ª<code>EventLoop</code>æ¥å¤„ç†ä»»åŠ¡ã€‚åœ¨NettyæœåŠ¡å™¨ç«¯ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½éœ€è¦æä¾›ä¸¤ä¸ª<code>EventLoopGroup</code>ï¼Œ<code>BossGroup</code>å’Œ<code>WorkerGroup</code></li>
<li>é€šå¸¸ä¸€ä¸ªæœåŠ¡ç«¯å£å³ä¸€ä¸ª<code>ServerSocketChannel</code>å¯¹åº”ä¸€ä¸ª<code>Selector</code>å’Œä¸€ä¸ª<code>EventLoop</code>çº¿ç¨‹ã€‚<code>BossEventLoop</code>è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥å¹¶å°†<code>SocketChannel</code>äº¤ç»™<code>WorkerEventLoopGroup</code>æ¥è¿›è¡ŒIOå¤„ç†</li>
<li><code>BossEventLoopGroup</code>é€šå¸¸æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„<code>EventLoop</code>ï¼Œ<code>EventLoop</code>ç»´æŠ¤ç€ä¸€ä¸ªæ³¨å†Œäº†<code>ServerSocketChannel</code>çš„<code>Selector</code>å®ä¾‹<code>BossEventLoop</code>ä¸æ–­è½®è¯¢<code>Selector</code>å°†è¿æ¥äº‹ä»¶åˆ†ç¦»å‡ºæ¥</li>
<li>é€šå¸¸æ˜¯OP_ACCEPTäº‹ä»¶ï¼Œç„¶åå°†æ¥æ”¶åˆ°çš„<code>SocketChannel</code>äº¤ç»™<code>WorkerEventLoopGroup</code></li>
<li><code>WorkerEventLoopGroup</code>ä¼šç”±<code>next</code>é€‰æ‹©å…¶ä¸­ä¸€ä¸ª<code>EventLoop</code>æ¥å°†è¿™ä¸ª<code>SocketChannel</code>æ³¨å†Œåˆ°å…¶ç»´æŠ¤çš„<code>Selector</code>å¹¶å¯¹å…¶åç»­çš„IOäº‹ä»¶è¿›è¡Œå¤„ç†</li>
</ul>
<blockquote>
<p>å¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public NioEventLoopGroup()</td>
<td align="center">æ„é€ æ–¹æ³•</td>
</tr>
<tr>
<td align="center">public Future&lt;?&gt; shutdownGracefully()</td>
<td align="center">æ–­å¼€è¿æ¥ï¼Œå…³é—­çº¿ç¨‹</td>
</tr>
</tbody></table>
<h3 id="4-10-Unpooled"><a href="#4-10-Unpooled" class="headerlink" title="4.10 Unpooled"></a>4.10 Unpooled</h3><blockquote>
<p>è¯´æ˜</p>
</blockquote>
<p><code>Netty</code>æä¾›ä¸€ä¸ªä¸“é—¨ç”¨æ¥æ“ä½œç¼“å†²åŒºï¼ˆå³<code>Netty</code>çš„æ•°æ®å®¹å™¨ï¼‰çš„å·¥å…·ç±»</p>
<blockquote>
<p>å¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">æ–¹æ³•åç§°</th>
<th align="center">æ–¹æ³•ä»‹ç»</th>
</tr>
</thead>
<tbody><tr>
<td align="center">public static ByteBuf copiedBuffer(CharSequence string, Charset charset)</td>
<td align="center">é€šè¿‡ç»™å®šçš„æ•°æ®å’Œå­—ç¬¦ç¼–ç è¿”å›ä¸€ä¸ª ByteBuf å¯¹è±¡ï¼ˆç±»ä¼¼äº NIO ä¸­çš„ ByteBuffer ä½†æœ‰åŒºåˆ«ï¼‰</td>
</tr>
</tbody></table>
<h3 id="4-11-ç¾¤èŠç³»ç»Ÿ"><a href="#4-11-ç¾¤èŠç³»ç»Ÿ" class="headerlink" title="4.11 ç¾¤èŠç³»ç»Ÿ"></a>4.11 ç¾¤èŠç³»ç»Ÿ</h3><blockquote>
<p>è¦æ±‚</p>
</blockquote>
<ul>
<li>ç¼–å†™ä¸€ä¸ª Netty ç¾¤èŠç³»ç»Ÿï¼Œå®ç°æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ•°æ®ç®€å•é€šè®¯ï¼ˆéé˜»å¡ï¼‰</li>
<li>å®ç°å¤šäººç¾¤èŠ</li>
<li>æœåŠ¡å™¨ï¼šå¯ä»¥ç›‘æµ‹ç”¨æˆ·ä¸Šçº¿ï¼Œç¦»çº¿ï¼Œå¹¶å®ç°æ¶ˆæ¯è½¬å‘åŠŸèƒ½</li>
<li>å®¢æˆ·ç«¯ï¼šé€šè¿‡channel å¯ä»¥æ— é˜»å¡å‘é€æ¶ˆæ¯ç»™å…¶å®ƒæ‰€æœ‰ç”¨æˆ·ï¼ŒåŒæ—¶å¯ä»¥æ¥å—å…¶å®ƒç”¨æˆ·å‘é€çš„æ¶ˆæ¯(ç”±æœåŠ¡å™¨è½¬å‘å¾—åˆ°)</li>
</ul>
<blockquote>
<p>GroupChatServer.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.groupChat;

import com.kag.nio.groupchat.GroupChatClient;
import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.*;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.string.StringDecoder;
import io.netty.handler.codec.string.StringEncoder;

/**
 * @author: KHighness
 * @date: 2020/10/2 8:19
 * @apiNote:
 */

public class GroupChatServer &#123;

    private int port;

    public GroupChatServer(int port) &#123;
        this.port = port;
    &#125;

    public void run() &#123;

        // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();

        ServerBootstrap serverBootstrap = new ServerBootstrap();

        serverBootstrap.group(workerGroup, workerGroup)
                .channel(NioServerSocketChannel.class)
                .option(ChannelOption.SO_BACKLOG, 128)
                .childOption(ChannelOption.SO_KEEPALIVE, true)
                .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;
                    @Override
                    protected void initChannel(SocketChannel channel) throws Exception &#123;
                        // è·å–pipeline
                        ChannelPipeline pipeline = channel.pipeline();;
                        // å‘pipelineåŠ å…¥è§£ç å™¨
                        pipeline.addLast(&quot;decoder&quot;, new StringDecoder());
                        // å‘pipelineåŠ å…¥ç¼–ç å™¨
                        pipeline.addLast(&quot;encoder&quot;, new StringEncoder());
                        // åŠ å…¥è‡ªå·±çš„ä¸šåŠ¡å¤„ç†handler
                        pipeline.addLast(new GroupChatServerHandler());
                    &#125;
                &#125;);

        try &#123;
            System.out.println(&quot;â–¶-----NettyæœåŠ¡å™¨å¯åŠ¨-----â—€&quot;);
            ChannelFuture channelFuture = serverBootstrap.bind(port).sync();

            // ç›‘å¬å…³é—­
            channelFuture.channel().closeFuture().sync();
        &#125; catch (InterruptedException e) &#123;
            System.out.println(e.getMessage());
        &#125; finally &#123;
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        &#125;
    &#125;

    public static void main(String[] args) throws InterruptedException &#123;
        new GroupChatServer(3333).run();
    &#125;
&#125;</code></pre>
<blockquote>
<p>GroupChatServerHandler.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.groupChat;

import io.netty.channel.Channel;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.channel.group.ChannelGroup;
import io.netty.channel.group.DefaultChannelGroup;
import io.netty.util.concurrent.EventExecutor;
import io.netty.util.concurrent.GlobalEventExecutor;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

/**
 * @author: KHighness
 * @date: 2020/10/2 8:33
 * @apiNote:
 */

public class GroupChatServerHandler extends SimpleChannelInboundHandler&lt;String&gt; &#123;

    // å®šä¹‰ä¸€ä¸ªchannelç»„ï¼Œç®¡ç†æ‰€æœ‰çš„channel
    // GlobalEventExecutor.INSTANCE æ˜¯å…¨å±€çš„æ—¶é—´æ‰§è¡Œå™¨ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹
    EventExecutor executor;
    private static ChannelGroup channelGroup = new DefaultChannelGroup(GlobalEventExecutor.INSTANCE);

    private String now() &#123;
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);
        return simpleDateFormat.format(new Date());
    &#125;

    /**
     * HandlerAdded
     * è¡¨ç¤ºè¿æ¥å»ºç«‹ï¼Œä¸€æ—¦è¿æ¥ï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œ
     * @param ctx
     * @throws Exception
     */
    @Override
    public void handlerAdded(ChannelHandlerContext ctx) throws Exception &#123;
        Channel channel = ctx.channel();
        // å°†è¯¥å®¢æˆ·åŠ å…¥èŠå¤©çš„ä¿¡æ¯æ¨é€ç»™å…¶ä»–åœ¨çº¿çš„å®¢æˆ·
        // è¯¥æ–¹æ³•ä¼šå°†channelGroupä¸­çš„æ‰€æœ‰channeléå†ï¼Œå¹¶å‘é€æ¶ˆæ¯
        channelGroup.writeAndFlush(now() + &quot; [å®¢æˆ·ç«¯]&quot; + channel.remoteAddress() + &quot;åŠ å…¥èŠå¤©\n&quot;);
        channelGroup.add(channel);
    &#125;

    /**
     * HandlerRemoved
     * è¡¨ç¤ºæ–­å¼€è¿æ¥ï¼Œå°†XXå®¢æˆ·ç¦»çº¿ä¿¡æ¯æ¨é€ç»™å½“å‰åœ¨çº¿å®¢æˆ·
     * @param ctx
     * @throws Exception
     */
    @Override
    public void handlerRemoved(ChannelHandlerContext ctx) throws Exception &#123;
        Channel channel = ctx.channel();
        channelGroup.writeAndFlush(now() + &quot; [å®¢æˆ·ç«¯]&quot; + channel.remoteAddress() + &quot;ç¦»å¼€èŠå¤©\n&quot;);
        System.out.println(&quot;Channel Group Size = &quot; + channelGroup.size());
    &#125;

    /**
     * channelActive
     * è¡¨ç¤ºchannelå¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæç¤ºXXä¸Šçº¿
     * @param ctx
     * @throws Exception
     */
    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;
        System.out.println(now() + &quot; &quot; + ctx.channel().remoteAddress() + &quot;ä¸Šçº¿&quot;);
    &#125;

    /**
     * channelInactive
     * è¡¨ç¤ºchannelå¤„äºéæ´»åŠ¨çŠ¶æ€
     * @param ctx
     * @throws Exception
     */
    @Override
    public void channelInactive(ChannelHandlerContext ctx) throws Exception &#123;
        System.out.println(now() + &quot; &quot; + ctx.channel().remoteAddress() + &quot;ç¦»çº¿&quot;);
    &#125;

    /**
     * ChannelRead0
     * è½¬å‘æ¶ˆæ¯
     * @param channelHandlerContext
     * @param s
     * @throws Exception
     */
    @Override
    protected void channelRead0(ChannelHandlerContext channelHandlerContext, String s) throws Exception &#123;
        Channel channel = channelHandlerContext.channel();
        // éå†ChannelGroup
        channelGroup.forEach(ch -&gt; &#123;
            if (channel != ch) // ä¸æ˜¯å½“å‰channelï¼Œç›´æ¥è½¬å‘
                ch.writeAndFlush(now() + &quot; [å®¢æˆ·]&quot; + channel.remoteAddress() + &quot;ï¼š&quot; + s + &quot;\n&quot;);
            else // å½“å‰channelæ˜¯è‡ªå·±
                ch.writeAndFlush(now() + &quot; [è‡ªå·±]: &quot; + s + &quot;\n&quot;);
        &#125;);
    &#125;

    /**
     * å¼‚å¸¸å¤„ç†
     * @param ctx
     * @param cause
     * @throws Exception
     */
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;
        super.exceptionCaught(ctx, cause);
    &#125;

&#125;</code></pre>
<blockquote>
<p>GroupChatClient.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.groupChat;

import io.netty.bootstrap.Bootstrap;
import io.netty.channel.*;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;
import io.netty.handler.codec.string.StringDecoder;
import io.netty.handler.codec.string.StringEncoder;

import java.net.SocketAddress;
import java.util.Scanner;

/**
 * @author: KHighness
 * @date: 2020/10/2 9:22
 * @apiNote:
 */

public class GroupChatClient &#123;

    private final String host;
    private final int port;

    public GroupChatClient(String host, int port) &#123;
        this.host = host;
        this.port = port;
    &#125;

    public void run() &#123;
        EventLoopGroup group = new NioEventLoopGroup();

        Bootstrap bootstrap = new Bootstrap()
                .group(group)
                .channel(NioSocketChannel.class)
                .handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;
                    @Override
                    protected void initChannel(SocketChannel channel) throws Exception &#123;
                        // å¾—åˆ°pipeline
                        ChannelPipeline pipeline = channel.pipeline();
                        // åŠ å…¥ç›¸å…³handler
                        pipeline.addLast(&quot;decoder&quot;, new StringDecoder());
                        pipeline.addLast(&quot;encoder&quot;, new StringEncoder());
                        // åŠ å…¥è‡ªå®šä¹‰çš„handler
                        pipeline.addLast(new GroupChatClientHandler());
                    &#125;
                &#125;);

        try &#123;
            ChannelFuture channelFuture = bootstrap.connect(host, port).sync();
            Channel channel = channelFuture.channel();
            System.out.println(&quot;â–¶-----&quot; + channel.localAddress().toString().substring(1) + &quot;-----â—€&quot;);
            // è¾“å…¥ä¿¡æ¯
            Scanner scanner = new Scanner(System.in);
            while (scanner.hasNextLine()) &#123;
                String msg = scanner.nextLine();
                // é€šè¿‡channelå‘é€åˆ°æœåŠ¡å™¨ç«¯
                channel.writeAndFlush(msg + &quot;\r\n&quot;);
            &#125;
        &#125; catch (InterruptedException e) &#123;
            System.out.println(e.getMessage());
        &#125; finally &#123;
            group.shutdownGracefully();
        &#125;
    &#125;

    public static void main(String[] args) throws Exception&#123;
        new GroupChatClient(&quot;127.0.0.1&quot;, 3333).run();
    &#125;
&#125;</code></pre>
<blockquote>
<p>GroupChatClientHandler.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.groupChat;

import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;

/**
 * @author: KHighness
 * @date: 2020/10/2 10:06
 * @apiNote:
 */

public class GroupChatClientHandler extends SimpleChannelInboundHandler&lt;String&gt; &#123;

    @Override
    protected void channelRead0(ChannelHandlerContext channelHandlerContext, String s) throws Exception &#123;
        System.out.println(s.trim());
    &#125;
&#125;</code></pre>
<h3 id="4-12-å¿ƒè·³æ£€æµ‹"><a href="#4-12-å¿ƒè·³æ£€æµ‹" class="headerlink" title="4.12 å¿ƒè·³æ£€æµ‹"></a>4.12 å¿ƒè·³æ£€æµ‹</h3><blockquote>
<p>è¦æ±‚</p>
</blockquote>
<ul>
<li>å½“æœåŠ¡å™¨è¶…è¿‡3ç§’æ²¡æœ‰è¯»æ“ä½œæ—¶ï¼Œå°±æç¤ºè¯»ç©ºé—²</li>
<li>å½“æœåŠ¡å™¨è¶…è¿‡5ç§’æ²¡æœ‰å†™æ“ä½œæ—¶ï¼Œå°±æç¤ºå†™ç©ºé—²</li>
<li>å½“æœåŠ¡å™¨è¶…è¿‡7ç§’æ²¡æœ‰è¯»æˆ–å†™æ—¶ï¼Œå°±æç¤ºè¯»å†™ç©ºé—²</li>
</ul>
<blockquote>
<p>MyServer.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.heartbeat;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelPipeline;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.logging.LogLevel;
import io.netty.handler.logging.LoggingHandler;
import io.netty.handler.timeout.IdleStateHandler;

import java.util.concurrent.TimeUnit;

/**
 * @author: KHighness
 * @date: 2020/10/2 10:25
 * @apiNote:
 */

public class MyServer &#123;
    public static void main(String[] args) throws InterruptedException &#123;
        NioEventLoopGroup bossGroup = new NioEventLoopGroup(1);
        NioEventLoopGroup workerGroup = new NioEventLoopGroup();

        try &#123;
            ServerBootstrap serverBootstrap = new ServerBootstrap();
            serverBootstrap.group(bossGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .handler(new LoggingHandler(LogLevel.INFO))  //ä¸ºBossGroupä¸­çš„è¯·æ±‚æ·»åŠ æ—¥å¿—å¤„ç†Handler
                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123;
                        @Override
                        protected void initChannel(SocketChannel ch) throws Exception &#123;
                            ChannelPipeline pipeline = ch.pipeline();
                            /**
                             * åŠ å…¥ä¸€ä¸ª netty æä¾›çš„ IdleStateHandler
                             * è¯´æ˜
                             * 1ã€IdleStateHandler æ˜¯ netty æä¾›çš„æ£€æµ‹ç©ºé—²çŠ¶æ€çš„å¤„ç†å™¨
                             * 2ã€long readerIdleTimeï¼šè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»ï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çš„çŠ¶æ€
                             * 3ã€long writerIdleTimeï¼šè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰å†™ï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çš„çŠ¶æ€
                             * 4ã€long allIdleTimeï¼šè¡¨ç¤ºå¤šé•¿æ—¶é—´æ²¡æœ‰è¯»å†™ï¼Œå°±ä¼šå‘é€ä¸€ä¸ªå¿ƒè·³æ£€æµ‹åŒ…æ£€æµ‹æ˜¯å¦è¿˜æ˜¯è¿æ¥çš„çŠ¶æ€
                             * 5ã€å½“ IdleStateEvent è§¦å‘åï¼Œå°±ä¼šä¼ é€’ç»™ç®¡é“çš„ä¸‹ä¸€ä¸ª Handlerï¼Œé€šè¿‡è°ƒç”¨ï¼ˆè§¦å‘ï¼‰ä¸‹ä¸€ä¸ªHandlerçš„ userEventTriggeredï¼Œåœ¨è¯¥æ–¹æ³•åŒºå¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚
                             */
                            pipeline.addLast(new IdleStateHandler(3, 5, 7, TimeUnit.SECONDS));

                            //åŠ å…¥ä¸€ä¸ªå¯¹ç©ºé—²æ£€æµ‹è¿›ä¸€æ­¥å¤„ç†çš„Handlerï¼ˆè‡ªå®šä¹‰ï¼‰
                            pipeline.addLast(new MyServerHandler());
                        &#125;
                    &#125;);
            //å¯åŠ¨æœåŠ¡å™¨ï¼Œè®¾ç½®ä¸ºåŒæ­¥æ¨¡å¼
            ChannelFuture channelFuture = serverBootstrap.bind(3333).sync();
            channelFuture.channel().closeFuture().sync();
        &#125; finally &#123;
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        &#125;
    &#125;
&#125;</code></pre>
<blockquote>
<p>MyServerHandler.java</p>
</blockquote>
<pre><code class="java">package com.kag.netty.heartbeat;

import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.handler.timeout.IdleStateEvent;

/**
 * @author: KHighness
 * @date: 2020/10/2 10:48
 * @apiNote:
 */

public class MyServerHandler extends ChannelInboundHandlerAdapter &#123;

    /**
     *
     * @param ctx ä¸Šä¸‹æ–‡
     * @param evt äº‹ä»¶
     * @throws Exception
     */
    @Override
    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception &#123;
        if (evt instanceof IdleStateEvent) &#123;
            // å°†evtå‘ä¸‹è½¬å‹
            IdleStateEvent event = (IdleStateEvent) evt;
            String eventType = null;
            switch (event.state()) &#123;
                case READER_IDLE:
                    eventType = &quot;è¯»ç©ºé—²&quot;;
                    break;
                case WRITER_IDLE:
                    eventType = &quot;å†™ç©ºé—²&quot;;
                    break;
                case ALL_IDLE:
                    eventType = &quot;è¯»å†™ç©ºé—²&quot;;
                    break;
            &#125;
            System.out.println(ctx.channel().remoteAddress() + &quot;â€”â€”&gt;è¶…æ—¶ï¼š&quot; + eventType);

            // å¦‚æœå‘ç”Ÿç©ºé—²ï¼Œç›´æ¥å…³é—­é€šé“
//            ctx.channel().close();
//            System.out.println(&quot;æœåŠ¡å™¨å…³é—­é€šé“Â·Â·Â·&quot;);
        &#125;
    &#125;
&#125;</code></pre>
<h3 id="4-13-ç®€å•æ€»ç»“"><a href="#4-13-ç®€å•æ€»ç»“" class="headerlink" title="4.13 ç®€å•æ€»ç»“"></a>4.13 ç®€å•æ€»ç»“</h3><blockquote>
<p>æœåŠ¡å™¨</p>
</blockquote>
<ol>
<li>åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ç»„ï¼Œ<code>bossGroup</code>å’Œ<code>workerGroup</code></li>
<li>åˆ›å»ºæœåŠ¡å™¨å¯åŠ¨å¯¹è±¡<code>ServerBootStrap</code></li>
<li>é“¾å¼ç¼–ç¨‹é…ç½®<code>ServerBootStrap</code>çš„å‚æ•°<ol>
<li><code>group</code>ï¼šè®¾ç½®çº¿ç¨‹ç»„<code>bossGroup</code>å’Œ<code>workerGroup</code></li>
<li><code>channel</code>ï¼šè®¾ç½®é€šé“å®ç°ï¼Œä¸€èˆ¬é€‰æ‹©<code>NioServerSocketChannel</code></li>
<li><code>option</code>ï¼šè®¾ç½®å¯è¿æ¥çº¿ç¨‹é˜Ÿåˆ—ä»¥åŠå¤§å°ï¼Œä¸€èˆ¬é€‰æ‹©<code>SO_BACKLOG</code></li>
<li><code>childOption</code>ï¼šè®¾ç½®ä¿æŒæ´»åŠ¨è¿æ¥çŠ¶æ€ï¼Œé€‰æ‹©<code>SO_KEEPALIVE</code></li>
<li><code>handler</code>ï¼šç»™<code>bossGroup</code>è®¾ç½®<code>Handler</code></li>
<li><code>childHandler</code>ï¼šç»™<code>workerGroup</code>è®¾ç½®<code>Hadnler</code></li>
</ol>
</li>
<li><code>ServerBootStrap</code>ç»‘å®šç«¯å£ï¼Œè®¾ç½®åŒæ­¥ï¼Œå¹¶ä¸”ç›‘å¬é€šé“å…³é—­äº‹ä»¶</li>
</ol>
<blockquote>
<p>å®¢æˆ·ç«¯</p>
</blockquote>
<ol>
<li>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç»„<code>group</code></li>
<li>åˆ›å»ºå®¢æˆ·ç«¯å¯åŠ¨å¯¹è±¡<code>BootStrap</code></li>
<li>é“¾å¼ç¼–ç¨‹é…ç½®<code>BootStrap</code>çš„å‚æ•°<ol>
<li><code>group</code>ï¼šè®¾ç½®çº¿ç¨‹ç»„<code>group</code></li>
<li><code>channel</code>ï¼šè®¾ç½®é€šé“å®ç°ï¼Œä¸€èˆ¬é€‰æ‹©<code>NioSocketChannel</code></li>
<li><code>handler</code>ï¼šè®¾ç½®<code>Handler</code></li>
</ol>
</li>
<li><code>BootStrap</code>ç»‘å®šç«¯å£ï¼Œè®¾ç½®åŒæ­¥ï¼Œå¹¶ä¸”ç›‘å¬é€šé“å…³é—­äº‹ä»¶</li>
</ol>
<blockquote>
<p>å¸¸è§Handler</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Handler</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SimpleChannelInboundHandler</td>
<td align="center">å¤„ç†é€šä¿¡(æœåŠ¡å™¨æœ€å¸¸ç”¨)</td>
</tr>
<tr>
<td align="center">IdleStateHandler</td>
<td align="center">æ£€æµ‹ç©ºé—²çŠ¶æ€(å¿ƒè·³æ£€æµ‹)</td>
</tr>
<tr>
<td align="center">WebSocketServerProtocolHandler</td>
<td align="center">å°†httpåè®®å‡çº§wsåè®®ï¼Œä¿æŒé•¿è¿æ¥</td>
</tr>
</tbody></table>
<blockquote>
<p>Handlerå¸¸ç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Method</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">handlerAdded(ChannelHandlerContext ctx)</td>
<td align="center">è¿æ¥å»ºç«‹ï¼Œä¸€æ—¦å»ºç«‹è¿æ¥ï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„æ–¹æ³•</td>
</tr>
<tr>
<td align="center">handlerRemoved(ChannelHandlerContext ctx)</td>
<td align="center">è¿æ¥æ–­å¼€ï¼Œå°†XXå®¢æˆ·ç¦»çº¿ä¿¡æ¯æ¨é€ç»™å½“å‰åœ¨çº¿å®¢æˆ·</td>
</tr>
<tr>
<td align="center">channelActive(ChannelHandlerContext ctx)</td>
<td align="center">è¡¨ç¤ºchannelå¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œæç¤ºXXä¸Šçº¿</td>
</tr>
<tr>
<td align="center">channelInactive(ChannelHandlerContext ctx)</td>
<td align="center">è¡¨ç¤ºchannelå¤„äºéæ´»åŠ¨çŠ¶æ€ï¼Œæç¤ºXXç¦»çº¿</td>
</tr>
<tr>
<td align="center">channelRead0(ChannelHandlerContext channelHandlerContext, String s)</td>
<td align="center">è¯»å–æ•°æ®ï¼Œå¹¶è¿›è¡Œæ¶ˆæ¯è½¬å‘</td>
</tr>
<tr>
<td align="center">exceptionCaught(ChannelHandlerContext ctx, Throwable cause)</td>
<td align="center">å¼‚å¸¸å¤„ç†</td>
</tr>
<tr>
<td align="center">userEventTriggered(ChannelHandlerContext ctx, Object evt)</td>
<td align="center">äº‹ä»¶è§¦å‘å™¨ã€‚åœ¨<code>IdleStateHandler</code>åé¢åŠ ä¸Šä¸€ä¸ªè§¦å‘å™¨ï¼Œå¯ä»¥æ£€æµ‹å¿ƒè·³ã€‚</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Server</tag>
      </tags>
  </entry>
  <entry>
    <title>Java8-Stream</title>
    <url>/posts/3e51ba23/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><p>â€‹       Stream æ˜¯ Java8 ä¸­å¤„ç†é›†åˆçš„å…³é”®æŠ½è±¡æ¦‚å¿µï¼Œå®ƒå¯ä»¥æŒ‡å®šä½ å¸Œæœ›å¯¹é›†åˆè¿›è¡Œçš„æ“ä½œï¼Œå¯ä»¥æ‰§è¡Œéå¸¸å¤æ‚çš„æŸ¥æ‰¾ã€è¿‡æ»¤å’Œæ˜ å°„æ•°æ®ç­‰æ“ä½œã€‚ä½¿ç”¨Stream API å¯¹é›†åˆæ•°æ®è¿›è¡Œæ“ä½œï¼Œå°±ç±»ä¼¼äºä½¿ç”¨ SQL æ‰§è¡Œçš„æ•°æ®åº“æŸ¥è¯¢ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ Stream API æ¥å¹¶è¡Œæ‰§è¡Œæ“ä½œã€‚ç®€è€Œè¨€ä¹‹ï¼ŒStream API æä¾›äº†ä¸€ç§é«˜æ•ˆä¸”æ˜“äºä½¿ç”¨çš„å¤„ç†æ•°æ®çš„æ–¹å¼ã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li><p>ä¸æ˜¯æ•°æ®ç»“æ„ï¼Œä¸ä¼šä¿å­˜æ•°æ®ã€‚</p>
</li>
<li><p>ä¸ä¼šä¿®æ”¹åŸæ¥çš„æ•°æ®æºï¼Œå®ƒä¼šå°†æ“ä½œåçš„æ•°æ®ä¿å­˜åˆ°å¦å¤–ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚ï¼ˆä¿ç•™æ„è§ï¼šæ¯•ç«Ÿpeekæ–¹æ³•å¯ä»¥ä¿®æ”¹æµä¸­å…ƒç´ ï¼‰</p>
</li>
<li><p>æƒ°æ€§æ±‚å€¼ï¼Œæµåœ¨ä¸­é—´å¤„ç†è¿‡ç¨‹ä¸­ï¼Œåªæ˜¯å¯¹æ“ä½œè¿›è¡Œäº†è®°å½•ï¼Œå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œéœ€è¦ç­‰åˆ°æ‰§è¡Œç»ˆæ­¢æ“ä½œçš„æ—¶å€™æ‰ä¼šè¿›è¡Œå®é™…çš„è®¡ç®—ã€‚</p>
</li>
</ul>
<h2 id="2-åˆ†ç±»"><a href="#2-åˆ†ç±»" class="headerlink" title="2. åˆ†ç±»"></a>2. åˆ†ç±»</h2><table>
<thead>
<tr>
<th align="center">ç±»å‹</th>
<th align="center">çŠ¶æ€</th>
<th align="center">API</th>
</tr>
</thead>
<tbody><tr>
<td align="center">ä¸­é—´æ“ä½œ</td>
<td align="center">æœ‰çŠ¶æ€</td>
<td align="center">unordered() filter() map() mapToInt() mapToDouble() flatMap() flatMapToInt() flatMapToLong() flatMapToDouble() peek()</td>
</tr>
<tr>
<td align="center">ä¸­é—´æ“ä½œ</td>
<td align="center">æ— çŠ¶æ€</td>
<td align="center">distinct() sorted() limit() skip()</td>
</tr>
<tr>
<td align="center">ç»“æŸæ“ä½œ</td>
<td align="center">éçŸ­è·¯æ“ä½œ</td>
<td align="center">foreach() forEachOrdered() toArray() reduce() collect() max() min() count()</td>
</tr>
<tr>
<td align="center">ç»“æŸæ“ä½œ</td>
<td align="center">çŸ­è·¯æ“ä½œ</td>
<td align="center">anyMatch() allMatch() noneMatch() findFirst() findAny()</td>
</tr>
</tbody></table>
<p>æ³¨é‡Šï¼š</p>
<ul>
<li><p>æ— çŠ¶æ€ï¼šæŒ‡å…ƒç´ çš„å¤„ç†ä¸å—ä¹‹å‰å…ƒç´ çš„å½±å“ï¼›</p>
</li>
<li><p>æœ‰çŠ¶æ€ï¼šæŒ‡è¯¥æ“ä½œåªæœ‰æ‹¿åˆ°æ‰€æœ‰å…ƒç´ ä¹‹åæ‰èƒ½ç»§ç»­ä¸‹å»ã€‚</p>
</li>
<li><p>éçŸ­è·¯æ“ä½œï¼šæŒ‡å¿…é¡»å¤„ç†æ‰€æœ‰å…ƒç´ æ‰èƒ½å¾—åˆ°æœ€ç»ˆç»“æœï¼›</p>
</li>
<li><p>çŸ­è·¯æ“ä½œï¼šæŒ‡é‡åˆ°æŸäº›ç¬¦åˆæ¡ä»¶çš„å…ƒç´ å°±å¯ä»¥å¾—åˆ°æœ€ç»ˆç»“æœï¼Œå¦‚ A || Bï¼Œåªè¦Aä¸ºtrueï¼Œåˆ™æ— éœ€åˆ¤æ–­Bçš„ç»“æœã€‚</p>
</li>
</ul>
<h2 id="3-ä½¿ç”¨"><a href="#3-ä½¿ç”¨" class="headerlink" title="3. ä½¿ç”¨"></a>3. ä½¿ç”¨</h2><h3 id="3-1-æµçš„å¸¸ç”¨åˆ›å»ºæ–¹æ³•"><a href="#3-1-æµçš„å¸¸ç”¨åˆ›å»ºæ–¹æ³•" class="headerlink" title="3.1 æµçš„å¸¸ç”¨åˆ›å»ºæ–¹æ³•"></a>3.1 æµçš„å¸¸ç”¨åˆ›å»ºæ–¹æ³•</h3><h4 id="3-1-1ä½¿ç”¨Collectionä¸‹çš„-stream-å’Œ-parallelStream-æ–¹æ³•"><a href="#3-1-1ä½¿ç”¨Collectionä¸‹çš„-stream-å’Œ-parallelStream-æ–¹æ³•" class="headerlink" title="3.1.1ä½¿ç”¨Collectionä¸‹çš„ stream() å’Œ parallelStream() æ–¹æ³•"></a>3.1.1ä½¿ç”¨Collectionä¸‹çš„ <code>stream()</code> å’Œ <code>parallelStream()</code> æ–¹æ³•</h4><pre><code class="java">public static void method1() &#123;
    System.out.println(&quot;----------method1----------&quot;);
    List&lt;Integer&gt; list = new ArrayList&lt;Integer&gt;();
    list.add(1);
    list.add(3);
    list.add(5);
    list.add(7);
    list.add(9);
    Stream&lt;Integer&gt; stream = list.stream();
    Stream&lt;Integer&gt; parallelStream = list.parallelStream();
&#125;</code></pre>
<h4 id="3-1-2-ä½¿ç”¨Arraysä¸­çš„-stream-æ–¹æ³•ï¼Œå°†æ•°ç»„è½¬æˆæµ"><a href="#3-1-2-ä½¿ç”¨Arraysä¸­çš„-stream-æ–¹æ³•ï¼Œå°†æ•°ç»„è½¬æˆæµ" class="headerlink" title="3.1.2 ä½¿ç”¨Arraysä¸­çš„ stream() æ–¹æ³•ï¼Œå°†æ•°ç»„è½¬æˆæµ"></a>3.1.2 ä½¿ç”¨Arraysä¸­çš„ <code>stream()</code> æ–¹æ³•ï¼Œå°†æ•°ç»„è½¬æˆæµ</h4><pre><code class="java">public static void method2() &#123;
    System.out.println(&quot;----------method2----------&quot;);
    Double[] nums = new Double[10];
    for (int i = 0; i &lt; 10; i++) &#123;
        nums[i] = random();
    &#125;
    Stream&lt;Double&gt; stream = Arrays.stream(nums);
    stream.forEach(System.out::println);
&#125;</code></pre>
<h4 id="3-1-3-ä½¿ç”¨Streamä¸­çš„é™æ€æ–¹æ³•-of-ã€iterate-ã€generate"><a href="#3-1-3-ä½¿ç”¨Streamä¸­çš„é™æ€æ–¹æ³•-of-ã€iterate-ã€generate" class="headerlink" title="3.1.3 ä½¿ç”¨Streamä¸­çš„é™æ€æ–¹æ³•: of()ã€iterate()ã€generate()"></a>3.1.3 ä½¿ç”¨Streamä¸­çš„é™æ€æ–¹æ³•: <code>of()</code>ã€<code>iterate()</code>ã€<code>generate()</code></h4><pre><code class="java">public static void method3() &#123;
    System.out.println(&quot;----------method3----------&quot;);
    Stream&lt;Integer&gt; stream1 = Stream.of(1, 2, 3, 4, 5, 6);
    stream1.forEach(System.out::println);

    Stream&lt;Integer&gt; stream2 = Stream.iterate(0, (x) -&gt; x + 1).limit(6);
    stream2.forEach(System.out::println);

    Stream&lt;Double&gt; stream3 = Stream.generate(Math::random).limit(6);
    stream3.forEach(System.out::println);
&#125;</code></pre>
<h4 id="3-1-4-ä½¿ç”¨-BufferedReader-lines-æ–¹æ³•ï¼Œå°†æ¯è¡Œå†…å®¹è½¬æˆæµ"><a href="#3-1-4-ä½¿ç”¨-BufferedReader-lines-æ–¹æ³•ï¼Œå°†æ¯è¡Œå†…å®¹è½¬æˆæµ" class="headerlink" title="3.1.4 ä½¿ç”¨ BufferedReader.lines() æ–¹æ³•ï¼Œå°†æ¯è¡Œå†…å®¹è½¬æˆæµ"></a>3.1.4 ä½¿ç”¨ <code>BufferedReader.lines()</code> æ–¹æ³•ï¼Œå°†æ¯è¡Œå†…å®¹è½¬æˆæµ</h4><pre><code class="java">public static void method4() throws IOException &#123;
    System.out.println(&quot;----------method4----------&quot;);
    BufferedReader reader = new BufferedReader(new FileReader(&quot;D:/Java/Test/K1.txt&quot;));
    Stream&lt;String&gt; lines = reader.lines();
    lines.forEach(System.out::println);
&#125;</code></pre>
<h4 id="3-1-5-ä½¿ç”¨-Pattern-splitAsStream-æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²åˆ†éš”æˆæµ"><a href="#3-1-5-ä½¿ç”¨-Pattern-splitAsStream-æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²åˆ†éš”æˆæµ" class="headerlink" title="3.1.5 ä½¿ç”¨ Pattern.splitAsStream() æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²åˆ†éš”æˆæµ"></a>3.1.5 ä½¿ç”¨ <code>Pattern.splitAsStream()</code> æ–¹æ³•ï¼Œå°†å­—ç¬¦ä¸²åˆ†éš”æˆæµ</h4><pre><code class="java">public static void method5() &#123;
    System.out.println(&quot;----------method5----------&quot;);
    Pattern pattern = Pattern.compile(&quot;,&quot;);
    Stream&lt;String&gt; stringStream = pattern.splitAsStream(&quot;K,H,I,G,H,N,E,S,S&quot;);
    stringStream.forEach(System.out::println);
&#125;</code></pre>
<h3 id="3-2-æµçš„ä¸­é—´æ“ä½œ"><a href="#3-2-æµçš„ä¸­é—´æ“ä½œ" class="headerlink" title="3.2 æµçš„ä¸­é—´æ“ä½œ"></a>3.2 æµçš„ä¸­é—´æ“ä½œ</h3><h4 id="3-2-1-ç­›é€‰ä¸åˆ‡ç‰‡"><a href="#3-2-1-ç­›é€‰ä¸åˆ‡ç‰‡" class="headerlink" title="3.2.1 ç­›é€‰ä¸åˆ‡ç‰‡"></a>3.2.1 ç­›é€‰ä¸åˆ‡ç‰‡</h4><ul>
<li><code>filter()</code>ï¼šè¿‡æ»¤æµä¸­çš„æŸäº›å…ƒç´ </li>
<li><code>limit()</code>ï¼šè·å–å‰nä¸ªå…ƒç´ </li>
<li><code>skip()</code>ï¼šè·³è¿‡å‰nä¸ªå…ƒç´ </li>
<li><code>limit + skip</code>ï¼šå¯ä»¥å®ç°åˆ†é¡µ<code>skip(PageNumber * PageSize).limit(PageSize)</code></li>
<li><code>distinct()</code>ï¼šé€šè¿‡æµä¸­å…ƒç´ çš„<code>hashCode()</code>å’Œ<code>equals()</code>å»é™¤é‡å¤å…ƒç´ </li>
</ul>
<pre><code class="java">public static void method1() &#123;
    System.out.println(&quot;----------method1----------&quot;);
    List&lt;Integer&gt; list = Arrays.asList( 1, 1, 1,
                                       2, 2, 2,
                                       3, 3, 3,
                                       4, 4, 4,
                                       5, 5, 5,
                                       6, 6, 6,
                                       7, 7, 7,
                                       8, 8, 8,
                                       9, 9, 9);

    System.out.println(&quot;----------è¿‡æ»¤å¤§äº5çš„å…ƒç´ ----------&quot;);
    Stream&lt;Integer&gt; stream1 = list.stream().filter(x -&gt; x &lt;= 5);
    stream1.forEach(System.out::println);

    System.out.println(&quot;----------åˆ†é¡µæŸ¥è¯¢/5/3----------&quot;);
    Stream&lt;Integer&gt; stream2 = list.stream().skip(5 * 3).limit(3);
    stream2.forEach(System.out::println);

    System.out.println(&quot;----------å»æ‰é‡å¤å…ƒç´ ----------&quot;);
    Stream stream3 = list.stream().distinct();
    stream3.forEach(System.out::println);
&#125;</code></pre>
<h4 id="3-2-2-æ˜ å°„"><a href="#3-2-2-æ˜ å°„" class="headerlink" title="3.2.2 æ˜ å°„"></a>3.2.2 æ˜ å°„</h4><ul>
<li><p><code>map()</code>ï¼šæ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°ä¼šè¢«åº”ç”¨åˆ°æ¯ä¸ªå…ƒç´ ä¸Šï¼Œå¹¶å°†å…¶æ˜ å°„æˆä¸€ä¸ªæ–°çš„å…ƒç´ </p>
</li>
<li><p><code>flatMap()</code>ï¼šæ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå°†æµä¸­çš„æ¯ä¸ªå€¼éƒ½æ¢æˆå¦ä¸€ä¸ªæµï¼Œç„¶åæŠŠæ‰€æœ‰æµè¿æ¥æˆä¸€ä¸ªæµ</p>
<pre><code class="java">public static void method2() &#123;
  System.out.println(&quot;----------method2----------&quot;);

  List&lt;String&gt; list = Arrays.asList(&quot;A,B,C&quot;, &quot;1,2,3&quot;);

  Stream&lt;String&gt; stringStream1 = list.stream().map( x -&gt; x.replaceAll(&quot;,&quot;, &quot;|&quot;));
  stringStream1.forEach(System.out::println);

  Stream&lt;String&gt; stringStream2 = list.stream().flatMap( x -&gt;&#123;
      String[] split = x.split(&quot;,&quot;);
      Stream&lt;String&gt; stringStream = Arrays.stream(split);
      return stringStream;
  &#125;);
  stringStream2.forEach(System.out::println);
&#125;</code></pre>
</li>
</ul>
<h4 id="3-2-3-æ’åº"><a href="#3-2-3-æ’åº" class="headerlink" title="3.2.3 æ’åº"></a>3.2.3 æ’åº</h4><ul>
<li><p><code>sorted()</code>: è‡ªç„¶æ’åºï¼Œæµä¸­å…ƒç´ éœ€è¦å®ç°Comparableæ¥å£</p>
</li>
<li><p><code>sorted(Comparator c)</code>: è‡ªå®šä¹‰æ’åºï¼Œè‡ªå®šä¹‰Comparatoræ’åºå™¨</p>
<pre><code class="java">public static void method3() &#123;
 System.out.println(&quot;----------method3----------&quot;);

 List&lt;Integer&gt; integers = Arrays.asList(1, 8, 2, 3, 6, 7, 6, 3, 7, 2);
 integers.stream().sorted().forEach(System.out::println);

 List&lt;String&gt; strings = Arrays.asList(&quot;K&quot;, &quot;H&quot;, &quot;I&quot;, &quot;G&quot;, &quot;H&quot;, &quot;N&quot;, &quot;E&quot;, &quot;S&quot;, &quot;S&quot;);
 strings.stream().sorted(
     (s1, s2) -&gt; &#123;
         return s1.compareTo(s2);
     &#125;
 ).forEach(System.out::println);

 @Data
 @AllArgsConstructor
 class Student &#123;
     String name;
     int score; 
 &#125;
 List&lt;Student&gt; students = Arrays.asList( new Student(&quot;K&quot;, 100),
                                        new Student(&quot;H&quot;, 91),
                                        new Student(&quot;I&quot;, 95),
                                        new Student(&quot;G&quot;, 98),
                                        new Student(&quot;N&quot;, 88));
 students.stream().sorted(
     (s1, s2) -&gt; &#123;
         return s1.score - s2.score;
     &#125;
 ).forEach(System.out::println);
&#125;</code></pre>
</li>
</ul>
<h4 id="3-2-4-æ¶ˆè´¹"><a href="#3-2-4-æ¶ˆè´¹" class="headerlink" title="3.2.4 æ¶ˆè´¹"></a>3.2.4 æ¶ˆè´¹</h4><ul>
<li><p><code>peek()</code>ï¼šæ¥æ”¶<code>Consumer</code>è¡¨è¾¾å¼ï¼Œæ— è¿”å›å€¼</p>
<pre><code class="java">public static void method4() &#123;
  System.out.println(&quot;----------method4----------&quot;);

  @Data
  @AllArgsConstructor
  class Student &#123;
      String name;
      int score;
  &#125;
  List&lt;Student&gt; students = Arrays.asList( new Student(&quot;K&quot;, 100),
                                         new Student(&quot;H&quot;, 91),
                                         new Student(&quot;I&quot;, 95),
                                         new Student(&quot;G&quot;, 98),
                                         new Student(&quot;N&quot;, 88));
  students.stream().peek(
      s -&gt; &#123;
          s.setScore(99);
      &#125;
  ).forEach(System.out::println);
&#125;</code></pre>
</li>
</ul>
<h3 id="4-æµçš„ç»ˆæ­¢æ“ä½œ"><a href="#4-æµçš„ç»ˆæ­¢æ“ä½œ" class="headerlink" title="4. æµçš„ç»ˆæ­¢æ“ä½œ"></a>4. æµçš„ç»ˆæ­¢æ“ä½œ</h3><h4 id="4-1-åŒ¹é…ã€èšåˆæ“ä½œ"><a href="#4-1-åŒ¹é…ã€èšåˆæ“ä½œ" class="headerlink" title="4.1 åŒ¹é…ã€èšåˆæ“ä½œ"></a>4.1 åŒ¹é…ã€èšåˆæ“ä½œ</h4><ul>
<li><code>allMatch()</code>ï¼šæ¥æ”¶ä¸€ä¸ª<code>Predicate</code>å‡½æ•°ï¼Œå½“æµä¸­æ¯ä¸ªå…ƒç´ éƒ½ç¬¦åˆè¯¥æ–­è¨€æ—¶æ‰è¿”å›trueï¼Œå¦åˆ™è¿”å›false</li>
<li><code>noneMatch()</code>ï¼šæ¥æ”¶ä¸€ä¸ª<code>Predicate</code>å‡½æ•°ï¼Œå½“æµä¸­æ¯ä¸ªå…ƒç´ éƒ½ä¸ç¬¦åˆè¯¥æ–­è¨€æ—¶æ‰è¿”å›trueï¼Œå¦åˆ™è¿”å›false</li>
<li><code>anyMatch()</code>ï¼šæ¥æ”¶ä¸€ä¸ª<code>Predicate</code>å‡½æ•°ï¼Œåªè¦æµä¸­æœ‰ä¸€ä¸ªå…ƒç´ æ»¡è¶³è¯¥æ–­è¨€åˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</li>
<li><code>findFIrst()</code>ï¼šè¿”å›æµä¸­ç¬¬ä¸€ä¸ªå…ƒç´ </li>
<li><code>findAny()</code>ï¼šè¿”å›æµä¸­çš„ä»»æ„å…ƒç´ </li>
<li><code>count()</code>ï¼šè¿”å›æµä¸­å…ƒç´ æ€»ä¸ªæ•°</li>
<li><code>max()</code>ï¼šè¿”å›æµä¸­å…ƒç´ çš„æœ€å¤§å€¼</li>
<li><code>min()</code>ï¼šè¿”å›æµä¸­å…ƒç´ çš„æœ€å°å€¼</li>
</ul>
<pre><code class="java">public static void method1() &#123;
    System.out.println(&quot;----------method1----------&quot;);
    List&lt;Integer&gt; list = Arrays.asList(1, 8, 2, 3, 6, 7, 6, 3, 7, 2);

    boolean allMatch = list.stream().anyMatch(e -&gt; e &gt; 10);    // false
    boolean noneMatch = list.stream().noneMatch(e -&gt; e &gt; 10);  // true
    boolean anyMatch = list.stream().anyMatch(e -&gt; e &gt; 4);     // true
    System.out.println(allMatch + &quot; &quot; + noneMatch + &quot; &quot; + anyMatch);

    Integer findFirst = list.stream().findFirst().get();
    Integer findAny = list.stream().findAny().get();
    System.out.println(&quot;first = &quot; + findFirst + &quot;, any = &quot; + findAny);

    long count = list.stream().count();
    Integer max = list.stream().max(Integer::compareTo).get();
    Integer min = list.stream().min(Integer::compareTo).get();
    System.out.println(&quot;count = &quot; + count + &quot;, max = &quot; + max + &quot;, min = &quot; + min);
&#125;</code></pre>
<h4 id="4-2-è§„çº¦æ“ä½œ"><a href="#4-2-è§„çº¦æ“ä½œ" class="headerlink" title="4.2 è§„çº¦æ“ä½œ"></a>4.2 è§„çº¦æ“ä½œ</h4><ul>
<li><code>Optional&lt;T&gt; reduce(BinaryOperator&lt;T&gt; accumulator)</code>ï¼šç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œ<code>accumulator</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæµä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæµä¸­å…ƒç´ çš„ç¬¬äºŒä¸ªå…ƒç´ ï¼›ç¬¬äºŒæ¬¡æ‰§è¡Œæ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç¬¬ä¸€æ¬¡å‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæµä¸­çš„ç¬¬ä¸‰ä¸ªå…ƒç´ ï¼›ä¾æ¬¡ç±»æ¨ã€‚</li>
<li><code>T reduce(T identity, BinaryOperator&lt;T&gt; accumulator)</code>ï¼šæµç¨‹è·Ÿä¸Šé¢ä¸€æ ·ï¼Œåªæ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œ<code>accumulator</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º<code>identity</code>ï¼Œè€Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæµä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</li>
<li><code>&lt;U&gt; U reduce(U identity,BiFunction&lt;U, ? super T, U&gt; accumulator,BinaryOperator&lt;U&gt; combiner)</code>ï¼šåœ¨ä¸²è¡Œæµ(stream)ä¸­ï¼Œè¯¥æ–¹æ³•è·Ÿç¬¬äºŒä¸ªæ–¹æ³•ä¸€æ ·ï¼Œå³ç¬¬ä¸‰ä¸ªå‚æ•°<code>combiner</code>ä¸ä¼šèµ·ä½œç”¨ã€‚åœ¨å¹¶è¡Œæµ(parallelStream)ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“æµè¢«fork joinå‡ºå¤šä¸ªçº¿ç¨‹è¿›è¡Œæ‰§è¡Œï¼Œæ­¤æ—¶æ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæµç¨‹å°±è·Ÿç¬¬äºŒä¸ªæ–¹æ³•<code>reduce(identity, accumulator)</code>ä¸€æ ·ï¼Œè€Œç¬¬ä¸‰ä¸ªå‚æ•°<code>combiner</code>å‡½æ•°ï¼Œåˆ™æ˜¯å°†æ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœå½“æˆä¸€ä¸ªæ–°çš„æµï¼Œç„¶åä½¿ç”¨ç¬¬ä¸€ä¸ªæ–¹æ³•<code>reduce(accumulator)</code>æµç¨‹è¿›è¡Œè§„çº¦ã€‚</li>
</ul>
<pre><code class="java">public static void method2() &#123;
    System.out.println(&quot;----------method2----------&quot;);
    List&lt;Integer&gt; list = Arrays.asList(1, 2, 3, 4, 5, 6, 7, 8, 9, 10);

    // æ±‚å’Œ
    Integer v = list.stream().reduce(0, (x1, x2) -&gt; x1 + x2);
    System.out.println(&quot;sum = &quot;  + v);

    // 10 + å’Œ
    Integer v1 = list.stream().reduce(10, (x1, x2) -&gt; x1 + x2);
    System.out.println(&quot;10 + sum = &quot; + v1);

    // æ±‚-å’Œ
    Integer v2 = list.stream().reduce(0,
                                      (x1, x2) -&gt; &#123;
                                          System.out.println(&quot;stream accumulator: x1: &quot; + x1 + &quot; x2: &quot; + x2);
                                          return x1 - x2;
                                      &#125;
                                     );
    System.out.println(v2);

    // æ±‚ç´¯ç§¯
    Integer v3 = list.stream().reduce(1,
                                      (x1, x2) -&gt; &#123;
                                          System.out.println(&quot;stream combiner: x1:&quot; + x1 + &quot;  x2:&quot; + x2);
                                          return x1 * x2;
                                      &#125;
                                     );
    System.out.println(v3);

    // å­—ç¬¦ä¸²æ‹¼æ¥
    List&lt;String&gt; list1 = Arrays.asList(&quot;K&quot;, &quot;Highness&quot;, &quot;. Nice &quot;, &quot;to &quot;, &quot;meet &quot;, &quot;you&quot;);
    String res = list1.stream().reduce(&quot;Hello &quot;, (c1, c2) -&gt; &#123;
        return c1 + c2;
    &#125;);
    System.out.println(res);
&#125;</code></pre>
<h4 id="4-3-æ”¶é›†æ“ä½œ"><a href="#4-3-æ”¶é›†æ“ä½œ" class="headerlink" title="4.3 æ”¶é›†æ“ä½œ"></a>4.3 æ”¶é›†æ“ä½œ</h4><p><code>collect()</code>ï¼šæ¥æ”¶ä¸€ä¸ªCollectorå®ä¾‹ï¼Œå°†æµä¸­å…ƒç´ æ”¶é›†æˆå¦å¤–ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚</p>
<p><code>Collector&lt;T, A, R&gt;</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰ä»¥ä¸‹5ä¸ªæŠ½è±¡æ–¹æ³•ï¼š</p>
<ul>
<li><code>Supplier&lt;A&gt; supplier()</code>ï¼šåˆ›å»ºä¸€ä¸ªç»“æœå®¹å™¨Aã€‚</li>
<li><code>BiConsumer&lt;A, T&gt; accumulator()</code>ï¼šæ¶ˆè´¹å‹æ¥å£ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå®¹å™¨Aï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºæµä¸­å…ƒç´ Tã€‚</li>
<li><code>BinaryOperator&lt;A&gt; combiner()</code>ï¼šå‡½æ•°æ¥å£ï¼Œè¯¥å‚æ•°çš„ä½œç”¨è·Ÿä¸Šä¸€ä¸ªæ–¹æ³•(reduce)ä¸­çš„combinerå‚æ•°ä¸€æ ·ï¼Œå°†å¹¶è¡Œæµä¸­å„ä¸ªå­è¿›ç¨‹çš„è¿è¡Œç»“æœ(accumulatorå‡½æ•°æ“ä½œåçš„å®¹å™¨A)è¿›è¡Œåˆå¹¶ã€‚</li>
<li><code>Function&lt;A, R&gt; finisher()</code>ï¼šå‡½æ•°å¼æ¥å£ï¼Œå‚æ•°ä¸ºå®¹å™¨Aï¼Œè¿”å›ç±»å‹ä¸ºcollectæ–¹æ³•æœ€ç»ˆæƒ³è¦çš„ç»“æœRã€‚</li>
<li><code>Set&lt;Characteristics&gt; characteristics()</code>ï¼šè¿”å›ä¸€ä¸ªä¸å¯å˜çš„Seté›†åˆï¼Œç”¨æ¥è¡¨æ˜è¯¥Collectorçš„ç‰¹å¾ã€‚</li>
</ul>
<p>æœ‰ä»¥ä¸‹ä¸‰ä¸ªç‰¹å¾ï¼š</p>
<ul>
<li><code>CONCURRENT</code>ï¼šè¡¨ç¤ºæ­¤æ”¶é›†å™¨æ”¯æŒå¹¶å‘ã€‚</li>
<li><code>UNORDERED</code>ï¼šè¡¨ç¤ºè¯¥æ”¶é›†æ“ä½œä¸ä¼šä¿ç•™æµä¸­å…ƒç´ åŸæœ‰çš„é¡ºåºã€‚</li>
<li><code>IDENTITY_FINISH</code>ï¼šè¡¨ç¤ºfinisherå‚æ•°åªæ˜¯æ ‡è¯†è€Œå·²ï¼Œå¯å¿½ç•¥ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java8</tag>
      </tags>
  </entry>
  <entry>
    <title>HttpçŠ¶æ€ç </title>
    <url>/posts/140645a5/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><div class="note info flat"><p>äº”ç§çŠ¶æ€</p>
</div>


<table>
<thead>
<tr>
<th align="center">åˆ†ç±»</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1**</td>
<td align="center">ä¿¡æ¯ï¼ŒæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚ï¼Œéœ€è¦è¯·æ±‚è€…ç»§ç»­æ‰§è¡Œæ“ä½œ</td>
</tr>
<tr>
<td align="center">2**</td>
<td align="center">æˆåŠŸï¼Œæ“ä½œè¢«æˆåŠŸæ¥æ”¶å¹¶å¤„ç†</td>
</tr>
<tr>
<td align="center">3**</td>
<td align="center">é‡å®šå‘ï¼Œéœ€è¦è¿›ä¸€æ­¥çš„æ“ä½œä»¥å®Œæˆè¯·æ±‚</td>
</tr>
<tr>
<td align="center">4**</td>
<td align="center">å®¢æˆ·ç«¯é”™è¯¯ï¼Œè¯·æ±‚ç™½è›¤è¯­æ³•é”™è¯¯æˆ–æ— åˆ†å‘å®Œæˆè¯·æ±‚</td>
</tr>
<tr>
<td align="center">5**</td>
<td align="center">æœåŠ¡å™¨é”™è¯¯ï¼ŒæœåŠ¡å™¨æ‰å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯</td>
</tr>
</tbody></table>
<h2 id="1xx-æ¶ˆæ¯"><a href="#1xx-æ¶ˆæ¯" class="headerlink" title="1xx-æ¶ˆæ¯"></a>1xx-æ¶ˆæ¯</h2><p>è¿™ä¸€ç±»å‹çš„çŠ¶æ€ç ï¼Œä»£è¡¨è¯·æ±‚å·²è¢«æ¥å—ï¼Œéœ€è¦ç»§ç»­å¤„ç†ã€‚è¿™ç±»å“åº”æ˜¯ä¸´æ—¶å“åº”ï¼ŒåªåŒ…å«çŠ¶æ€è¡Œå’ŒæŸäº›å¯é€‰çš„å“åº”å¤´ä¿¡æ¯ï¼Œå¹¶ä»¥ç©ºè¡Œç»“æŸã€‚ç”±äºHTTP/1.0åè®®ä¸­æ²¡æœ‰å®šä¹‰ä»»ä½•1xxçŠ¶æ€ç ï¼Œæ‰€ä»¥é™¤éåœ¨æŸäº›è¯•éªŒæ¡ä»¶ä¸‹ï¼ŒæœåŠ¡å™¨ç¦æ­¢å‘æ­¤ç±»å®¢æˆ·ç«¯å‘é€1xxå“åº”ã€‚ è¿™äº›çŠ¶æ€ç ä»£è¡¨çš„å“åº”éƒ½æ˜¯ä¿¡æ¯æ€§çš„ï¼Œæ ‡ç¤ºå®¢æˆ·åº”è¯¥é‡‡å–çš„å…¶ä»–è¡ŒåŠ¨ã€‚</p>
<ul>
<li><p>100 Continue<br>æœåŠ¡å™¨å·²ç»æ¥æ”¶åˆ°è¯·æ±‚å¤´ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯åº”ç»§ç»­å‘é€è¯·æ±‚ä¸»ä½“ï¼ˆåœ¨éœ€è¦å‘é€èº«ä½“çš„è¯·æ±‚çš„æƒ…å†µä¸‹ï¼šä¾‹å¦‚ï¼ŒPOSTè¯·æ±‚ï¼‰ï¼Œæˆ–è€…å¦‚æœè¯·æ±‚å·²ç»å®Œæˆï¼Œå¿½ç•¥è¿™ä¸ªå“åº”ã€‚æœåŠ¡å™¨å¿…é¡»åœ¨è¯·æ±‚å®Œæˆåå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæœ€ç»ˆå“åº”ã€‚è¦ä½¿æœåŠ¡å™¨æ£€æŸ¥è¯·æ±‚çš„å¤´éƒ¨ï¼Œå®¢æˆ·ç«¯å¿…é¡»åœ¨å…¶åˆå§‹è¯·æ±‚ä¸­å‘é€Expect: 100-continueä½œä¸ºå¤´éƒ¨ï¼Œå¹¶åœ¨å‘é€æ­£æ–‡ä¹‹å‰æ¥æ”¶100 ContinueçŠ¶æ€ä»£ç ã€‚å“åº”ä»£ç 417æœŸæœ›å¤±è´¥è¡¨ç¤ºè¯·æ±‚ä¸åº”ç»§ç»­ã€‚</p>
</li>
<li><p>101 Switching Protocols<br>æœåŠ¡å™¨å·²ç»ç†è§£äº†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶å°†é€šè¿‡Upgradeæ¶ˆæ¯å¤´é€šçŸ¥å®¢æˆ·ç«¯é‡‡ç”¨ä¸åŒçš„åè®®æ¥å®Œæˆè¿™ä¸ªè¯·æ±‚ã€‚åœ¨å‘é€å®Œè¿™ä¸ªå“åº”æœ€åçš„ç©ºè¡Œåï¼ŒæœåŠ¡å™¨å°†ä¼šåˆ‡æ¢åˆ°åœ¨Upgradeæ¶ˆæ¯å¤´ä¸­å®šä¹‰çš„é‚£äº›åè®®ã€‚<br>åªæœ‰åœ¨åˆ‡æ¢æ–°çš„åè®®æ›´æœ‰å¥½å¤„çš„æ—¶å€™æ‰åº”è¯¥é‡‡å–ç±»ä¼¼æªæ–½ã€‚ä¾‹å¦‚ï¼Œåˆ‡æ¢åˆ°æ–°çš„HTTPç‰ˆæœ¬ï¼ˆå¦‚HTTP/2ï¼‰æ¯”æ—§ç‰ˆæœ¬æ›´æœ‰ä¼˜åŠ¿ï¼Œæˆ–è€…åˆ‡æ¢åˆ°ä¸€ä¸ªå®æ—¶ä¸”åŒæ­¥çš„åè®®ï¼ˆå¦‚WebSocketï¼‰ä»¥ä¼ é€åˆ©ç”¨æ­¤ç±»ç‰¹æ€§çš„èµ„æºã€‚</p>
</li>
<li><p>102 Processingï¼ˆWebDAVï¼›RFC 2518ï¼‰<br>WebDAVè¯·æ±‚å¯èƒ½åŒ…å«è®¸å¤šæ¶‰åŠæ–‡ä»¶æ“ä½œçš„å­è¯·æ±‚ï¼Œéœ€è¦å¾ˆé•¿æ—¶é—´æ‰èƒ½å®Œæˆè¯·æ±‚ã€‚è¯¥ä»£ç è¡¨ç¤ºæœåŠ¡å™¨å·²ç»æ”¶åˆ°å¹¶æ­£åœ¨å¤„ç†è¯·æ±‚ï¼Œä½†æ— å“åº”å¯ç”¨ã€‚[6]è¿™æ ·å¯ä»¥é˜²æ­¢å®¢æˆ·ç«¯è¶…æ—¶ï¼Œå¹¶å‡è®¾è¯·æ±‚ä¸¢å¤±ã€‚</p>
</li>
</ul>
<br>

<h2 id="2xx-æˆåŠŸ"><a href="#2xx-æˆåŠŸ" class="headerlink" title="2xx-æˆåŠŸ"></a>2xx-æˆåŠŸ</h2><p>è¿™ä¸€ç±»å‹çš„çŠ¶æ€ç ï¼Œä»£è¡¨è¯·æ±‚å·²æˆåŠŸè¢«æœåŠ¡å™¨æ¥æ”¶ã€ç†è§£ã€å¹¶æ¥å—ã€‚</p>
<ul>
<li><p>200 OK<br>è¯·æ±‚å·²æˆåŠŸï¼Œè¯·æ±‚æ‰€å¸Œæœ›çš„å“åº”å¤´æˆ–æ•°æ®ä½“å°†éšæ­¤å“åº”è¿”å›ã€‚å®é™…çš„å“åº”å°†å–å†³äºæ‰€ä½¿ç”¨çš„è¯·æ±‚æ–¹æ³•ã€‚åœ¨GETè¯·æ±‚ä¸­ï¼Œå“åº”å°†åŒ…å«ä¸è¯·æ±‚çš„èµ„æºç›¸å¯¹åº”çš„å®ä½“ã€‚åœ¨POSTè¯·æ±‚ä¸­ï¼Œå“åº”å°†åŒ…å«æè¿°æˆ–æ“ä½œç»“æœçš„å®ä½“ã€‚</p>
</li>
<li><p>201 Created<br>è¯·æ±‚å·²ç»è¢«å®ç°ï¼Œè€Œä¸”æœ‰ä¸€ä¸ªæ–°çš„èµ„æºå·²ç»ä¾æ®è¯·æ±‚çš„éœ€è¦è€Œåˆ›å»ºï¼Œä¸”å…¶URIå·²ç»éšLocationå¤´ä¿¡æ¯è¿”å›ã€‚å‡å¦‚éœ€è¦çš„èµ„æºæ— æ³•åŠæ—¶åˆ›å»ºçš„è¯ï¼Œåº”å½“è¿”å›â€™202 Acceptedâ€™ã€‚</p>
</li>
<li><p>202 Accepted<br>æœåŠ¡å™¨å·²æ¥å—è¯·æ±‚ï¼Œä½†å°šæœªå¤„ç†ã€‚æœ€ç»ˆè¯¥è¯·æ±‚å¯èƒ½ä¼šä¹Ÿå¯èƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œå¹¶ä¸”å¯èƒ½åœ¨å¤„ç†å‘ç”Ÿæ—¶è¢«ç¦æ­¢ã€‚</p>
</li>
<li><p>203 Non-Authoritative Informationï¼ˆè‡ªHTTP / 1.1èµ·ï¼‰<br>æœåŠ¡å™¨æ˜¯ä¸€ä¸ªè½¬æ¢ä»£ç†æœåŠ¡å™¨ï¼ˆtransforming proxyï¼Œä¾‹å¦‚ç½‘ç»œåŠ é€Ÿå™¨ï¼‰ï¼Œä»¥200 OKçŠ¶æ€ç ä¸ºèµ·æºï¼Œä½†å›åº”äº†åŸå§‹å“åº”çš„ä¿®æ”¹ç‰ˆæœ¬ã€‚</p>
</li>
<li><p>204 No Content<br>æœåŠ¡å™¨æˆåŠŸå¤„ç†äº†è¯·æ±‚ï¼Œæ²¡æœ‰è¿”å›ä»»ä½•å†…å®¹ã€‚</p>
</li>
<li><p>205 Reset Content<br>æœåŠ¡å™¨æˆåŠŸå¤„ç†äº†è¯·æ±‚ï¼Œä½†æ²¡æœ‰è¿”å›ä»»ä½•å†…å®¹ã€‚ä¸204å“åº”ä¸åŒï¼Œæ­¤å“åº”è¦æ±‚è¯·æ±‚è€…é‡ç½®æ–‡æ¡£è§†å›¾ã€‚</p>
</li>
<li><p>206 Partial Content<br>æœåŠ¡å™¨å·²ç»æˆåŠŸå¤„ç†äº†éƒ¨åˆ†GETè¯·æ±‚ã€‚ç±»ä¼¼äºFlashGetæˆ–è€…è¿…é›·è¿™ç±»çš„HTTP ä¸‹è½½å·¥å…·éƒ½æ˜¯ä½¿ç”¨æ­¤ç±»å“åº”å®ç°æ–­ç‚¹ç»­ä¼ æˆ–è€…å°†ä¸€ä¸ªå¤§æ–‡æ¡£åˆ†è§£ä¸ºå¤šä¸ªä¸‹è½½æ®µåŒæ—¶ä¸‹è½½ã€‚</p>
</li>
<li><p>207 Multi-Statusï¼ˆWebDAVï¼›RFC 4918ï¼‰<br>ä»£è¡¨ä¹‹åçš„æ¶ˆæ¯ä½“å°†æ˜¯ä¸€ä¸ªXMLæ¶ˆæ¯ï¼Œå¹¶ä¸”å¯èƒ½ä¾ç…§ä¹‹å‰å­è¯·æ±‚æ•°é‡çš„ä¸åŒï¼ŒåŒ…å«ä¸€ç³»åˆ—ç‹¬ç«‹çš„å“åº”ä»£ç ã€‚</p>
</li>
<li><p>208 Already Reported ï¼ˆWebDAVï¼›RFC 5842ï¼‰<br>DAVç»‘å®šçš„æˆå‘˜å·²ç»åœ¨ï¼ˆå¤šçŠ¶æ€ï¼‰å“åº”ä¹‹å‰çš„éƒ¨åˆ†è¢«åˆ—ä¸¾ï¼Œä¸”æœªè¢«å†æ¬¡åŒ…å«ã€‚</p>
</li>
<li><p>226 IM Used ï¼ˆRFC 3229ï¼‰<br>æœåŠ¡å™¨å·²ç»æ»¡è¶³äº†å¯¹èµ„æºçš„è¯·æ±‚ï¼Œå¯¹å®ä½“è¯·æ±‚çš„ä¸€ä¸ªæˆ–å¤šä¸ªå®ä½“æ“ä½œçš„ç»“æœè¡¨ç¤ºã€‚</p>
</li>
</ul>
<br>

<h2 id="3xx-é‡å®šå‘"><a href="#3xx-é‡å®šå‘" class="headerlink" title="3xx-é‡å®šå‘"></a>3xx-é‡å®šå‘</h2><p>è¿™ç±»çŠ¶æ€ç ä»£è¡¨éœ€è¦å®¢æˆ·ç«¯é‡‡å–è¿›ä¸€æ­¥çš„æ“ä½œæ‰èƒ½å®Œæˆè¯·æ±‚ã€‚é€šå¸¸ï¼Œè¿™äº›çŠ¶æ€ç ç”¨æ¥é‡å®šå‘ï¼Œåç»­çš„è¯·æ±‚åœ°å€ï¼ˆé‡å®šå‘ç›®æ ‡ï¼‰åœ¨æœ¬æ¬¡å“åº”çš„LocationåŸŸä¸­æŒ‡æ˜ã€‚</p>
<p>å½“ä¸”ä»…å½“åç»­çš„è¯·æ±‚æ‰€ä½¿ç”¨çš„æ–¹æ³•æ˜¯GETæˆ–è€…HEADæ—¶ï¼Œç”¨æˆ·æµè§ˆå™¨æ‰å¯ä»¥åœ¨æ²¡æœ‰ç”¨æˆ·ä»‹å…¥çš„æƒ…å†µä¸‹è‡ªåŠ¨æäº¤æ‰€éœ€è¦çš„åç»­è¯·æ±‚ã€‚å®¢æˆ·ç«¯åº”å½“è‡ªåŠ¨ç›‘æµ‹æ— é™å¾ªç¯é‡å®šå‘ï¼ˆä¾‹å¦‚ï¼šAâ†’Bâ†’Câ†’â€¦â€¦â†’Aæˆ–Aâ†’Aï¼‰ï¼Œå› ä¸ºè¿™ä¼šå¯¼è‡´æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¤§é‡ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—ã€‚æŒ‰ç…§HTTP/1.0ç‰ˆè§„èŒƒçš„å»ºè®®ï¼Œæµè§ˆå™¨ä¸åº”è‡ªåŠ¨è®¿é—®è¶…è¿‡5æ¬¡çš„é‡å®šå‘ã€‚</p>
<ul>
<li><p>300 Multiple Choices<br>è¢«è¯·æ±‚çš„èµ„æºæœ‰ä¸€ç³»åˆ—å¯ä¾›é€‰æ‹©çš„å›é¦ˆä¿¡æ¯ï¼Œæ¯ä¸ªéƒ½æœ‰è‡ªå·±ç‰¹å®šçš„åœ°å€å’Œæµè§ˆå™¨é©±åŠ¨çš„å•†è®®ä¿¡æ¯ã€‚ç”¨æˆ·æˆ–æµè§ˆå™¨èƒ½å¤Ÿè‡ªè¡Œé€‰æ‹©ä¸€ä¸ªé¦–é€‰çš„åœ°å€è¿›è¡Œé‡å®šå‘ã€‚<br>é™¤éè¿™æ˜¯ä¸€ä¸ªHEADè¯·æ±‚ï¼Œå¦åˆ™è¯¥å“åº”åº”å½“åŒ…æ‹¬ä¸€ä¸ªèµ„æºç‰¹æ€§åŠåœ°å€çš„åˆ—è¡¨çš„å®ä½“ï¼Œä»¥ä¾¿ç”¨æˆ·æˆ–æµè§ˆå™¨ä»ä¸­é€‰æ‹©æœ€åˆé€‚çš„é‡å®šå‘åœ°å€ã€‚è¿™ä¸ªå®ä½“çš„æ ¼å¼ç”±Content-Typeå®šä¹‰çš„æ ¼å¼æ‰€å†³å®šã€‚æµè§ˆå™¨å¯èƒ½æ ¹æ®å“åº”çš„æ ¼å¼ä»¥åŠæµè§ˆå™¨è‡ªèº«èƒ½åŠ›ï¼Œè‡ªåŠ¨ä½œå‡ºæœ€åˆé€‚çš„é€‰æ‹©ã€‚å½“ç„¶ï¼ŒRFC 2616è§„èŒƒå¹¶æ²¡æœ‰è§„å®šè¿™æ ·çš„è‡ªåŠ¨é€‰æ‹©è¯¥å¦‚ä½•è¿›è¡Œã€‚<br>å¦‚æœæœåŠ¡å™¨æœ¬èº«å·²ç»æœ‰äº†é¦–é€‰çš„å›é¦ˆé€‰æ‹©ï¼Œé‚£ä¹ˆåœ¨Locationä¸­åº”å½“æŒ‡æ˜è¿™ä¸ªå›é¦ˆçš„URIï¼›æµè§ˆå™¨å¯èƒ½ä¼šå°†è¿™ä¸ªLocationå€¼ä½œä¸ºè‡ªåŠ¨é‡å®šå‘çš„åœ°å€ã€‚æ­¤å¤–ï¼Œé™¤éé¢å¤–æŒ‡å®šï¼Œå¦åˆ™è¿™ä¸ªå“åº”ä¹Ÿæ˜¯å¯ç¼“å­˜çš„ã€‚</p>
</li>
<li><p>301 Moved Permanently<br>è¢«è¯·æ±‚çš„èµ„æºå·²æ°¸ä¹…ç§»åŠ¨åˆ°æ–°ä½ç½®ï¼Œå¹¶ä¸”å°†æ¥ä»»ä½•å¯¹æ­¤èµ„æºçš„å¼•ç”¨éƒ½åº”è¯¥ä½¿ç”¨æœ¬å“åº”è¿”å›çš„è‹¥å¹²ä¸ªURIä¹‹ä¸€ã€‚å¦‚æœå¯èƒ½ï¼Œæ‹¥æœ‰é“¾æ¥ç¼–è¾‘åŠŸèƒ½çš„å®¢æˆ·ç«¯åº”å½“è‡ªåŠ¨æŠŠè¯·æ±‚çš„åœ°å€ä¿®æ”¹ä¸ºä»æœåŠ¡å™¨åé¦ˆå›æ¥çš„åœ°å€ã€‚é™¤éé¢å¤–æŒ‡å®šï¼Œå¦åˆ™è¿™ä¸ªå“åº”ä¹Ÿæ˜¯å¯ç¼“å­˜çš„ã€‚<br>æ–°çš„æ°¸ä¹…æ€§çš„URIåº”å½“åœ¨å“åº”çš„LocationåŸŸä¸­è¿”å›ã€‚é™¤éè¿™æ˜¯ä¸€ä¸ªHEADè¯·æ±‚ï¼Œå¦åˆ™å“åº”çš„å®ä½“ä¸­åº”å½“åŒ…å«æŒ‡å‘æ–°çš„URIçš„è¶…é“¾æ¥åŠç®€çŸ­è¯´æ˜ã€‚<br>å¦‚æœè¿™ä¸æ˜¯ä¸€ä¸ªGETæˆ–è€…HEADè¯·æ±‚ï¼Œé‚£ä¹ˆæµè§ˆå™¨ç¦æ­¢è‡ªåŠ¨è¿›è¡Œé‡å®šå‘ï¼Œé™¤éå¾—åˆ°ç”¨æˆ·çš„ç¡®è®¤ï¼Œå› ä¸ºè¯·æ±‚çš„æ¡ä»¶å¯èƒ½å› æ­¤å‘ç”Ÿå˜åŒ–ã€‚<br>æ³¨æ„ï¼šå¯¹äºæŸäº›ä½¿ç”¨HTTP/1.0åè®®çš„æµè§ˆå™¨ï¼Œå½“å®ƒä»¬å‘é€çš„POSTè¯·æ±‚å¾—åˆ°äº†ä¸€ä¸ª301å“åº”çš„è¯ï¼Œæ¥ä¸‹æ¥çš„é‡å®šå‘è¯·æ±‚å°†ä¼šå˜æˆGETæ–¹å¼ã€‚</p>
</li>
<li><p>302 Found<br>è¦æ±‚å®¢æˆ·ç«¯æ‰§è¡Œä¸´æ—¶é‡å®šå‘ï¼ˆåŸå§‹æè¿°çŸ­è¯­ä¸ºâ€œMoved Temporarilyâ€ï¼‰ã€‚ç”±äºè¿™æ ·çš„é‡å®šå‘æ˜¯ä¸´æ—¶çš„ï¼Œå®¢æˆ·ç«¯åº”å½“ç»§ç»­å‘åŸæœ‰åœ°å€å‘é€ä»¥åçš„è¯·æ±‚ã€‚åªæœ‰åœ¨Cache-Controlæˆ–Expiresä¸­è¿›è¡Œäº†æŒ‡å®šçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå“åº”æ‰æ˜¯å¯ç¼“å­˜çš„ã€‚<br>æ–°çš„ä¸´æ—¶æ€§çš„URIåº”å½“åœ¨å“åº”çš„LocationåŸŸä¸­è¿”å›ã€‚é™¤éè¿™æ˜¯ä¸€ä¸ªHEADè¯·æ±‚ï¼Œå¦åˆ™å“åº”çš„å®ä½“ä¸­åº”å½“åŒ…å«æŒ‡å‘æ–°çš„URIçš„è¶…é“¾æ¥åŠç®€çŸ­è¯´æ˜ã€‚<br>å¦‚æœè¿™ä¸æ˜¯ä¸€ä¸ªGETæˆ–è€…HEADè¯·æ±‚ï¼Œé‚£ä¹ˆæµè§ˆå™¨ç¦æ­¢è‡ªåŠ¨è¿›è¡Œé‡å®šå‘ï¼Œé™¤éå¾—åˆ°ç”¨æˆ·çš„ç¡®è®¤ï¼Œå› ä¸ºè¯·æ±‚çš„æ¡ä»¶å¯èƒ½å› æ­¤å‘ç”Ÿå˜åŒ–ã€‚<br>æ³¨æ„ï¼šè™½ç„¶RFC 1945å’ŒRFC 2068è§„èŒƒä¸å…è®¸å®¢æˆ·ç«¯åœ¨é‡å®šå‘æ—¶æ”¹å˜è¯·æ±‚çš„æ–¹æ³•ï¼Œä½†æ˜¯å¾ˆå¤šç°å­˜çš„æµè§ˆå™¨å°†302å“åº”è§†ä½œä¸º303å“åº”ï¼Œå¹¶ä¸”ä½¿ç”¨GETæ–¹å¼è®¿é—®åœ¨Locationä¸­è§„å®šçš„URIï¼Œè€Œæ— è§†åŸå…ˆè¯·æ±‚çš„æ–¹æ³•ã€‚å› æ­¤çŠ¶æ€ç 303å’Œ307è¢«æ·»åŠ äº†è¿›æ¥ï¼Œç”¨ä»¥æ˜ç¡®æœåŠ¡å™¨æœŸå¾…å®¢æˆ·ç«¯è¿›è¡Œä½•ç§ååº”ã€‚</p>
</li>
<li><p>303 See Other<br>å¯¹åº”å½“å‰è¯·æ±‚çš„å“åº”å¯ä»¥åœ¨å¦ä¸€ä¸ªURIä¸Šè¢«æ‰¾åˆ°ï¼Œå½“å“åº”äºPOSTï¼ˆæˆ–PUT / DELETEï¼‰æ¥æ”¶åˆ°å“åº”æ—¶ï¼Œå®¢æˆ·ç«¯åº”è¯¥å‡å®šæœåŠ¡å™¨å·²ç»æ”¶åˆ°æ•°æ®ï¼Œå¹¶ä¸”åº”è¯¥ä½¿ç”¨å•ç‹¬çš„GETæ¶ˆæ¯å‘å‡ºé‡å®šå‘ã€‚è¿™ä¸ªæ–¹æ³•çš„å­˜åœ¨ä¸»è¦æ˜¯ä¸ºäº†å…è®¸ç”±è„šæœ¬æ¿€æ´»çš„POSTè¯·æ±‚è¾“å‡ºé‡å®šå‘åˆ°ä¸€ä¸ªæ–°çš„èµ„æºã€‚è¿™ä¸ªæ–°çš„URIä¸æ˜¯åŸå§‹èµ„æºçš„æ›¿ä»£å¼•ç”¨ã€‚åŒæ—¶ï¼Œ303å“åº”ç¦æ­¢è¢«ç¼“å­˜ã€‚å½“ç„¶ï¼Œç¬¬äºŒä¸ªè¯·æ±‚ï¼ˆé‡å®šå‘ï¼‰å¯èƒ½è¢«ç¼“å­˜ã€‚<br>æ–°çš„URIåº”å½“åœ¨å“åº”çš„LocationåŸŸä¸­è¿”å›ã€‚é™¤éè¿™æ˜¯ä¸€ä¸ªHEADè¯·æ±‚ï¼Œå¦åˆ™å“åº”çš„å®ä½“ä¸­åº”å½“åŒ…å«æŒ‡å‘æ–°çš„URIçš„è¶…é“¾æ¥åŠç®€çŸ­è¯´æ˜ã€‚<br>æ³¨æ„ï¼šè®¸å¤šHTTP/1.1ç‰ˆä»¥å‰çš„æµè§ˆå™¨ä¸èƒ½æ­£ç¡®ç†è§£303çŠ¶æ€ã€‚å¦‚æœéœ€è¦è€ƒè™‘ä¸è¿™äº›æµè§ˆå™¨ä¹‹é—´çš„äº’åŠ¨ï¼Œ302çŠ¶æ€ç åº”è¯¥å¯ä»¥èƒœä»»ï¼Œå› ä¸ºå¤§å¤šæ•°çš„æµè§ˆå™¨å¤„ç†302å“åº”æ—¶çš„æ–¹å¼æ°æ°å°±æ˜¯ä¸Šè¿°è§„èŒƒè¦æ±‚å®¢æˆ·ç«¯å¤„ç†303å“åº”æ—¶åº”å½“åšçš„ã€‚</p>
</li>
<li><p>304 Not Modified<br>è¡¨ç¤ºèµ„æºæœªè¢«ä¿®æ”¹ï¼Œå› ä¸ºè¯·æ±‚å¤´æŒ‡å®šçš„ç‰ˆæœ¬If-Modified-Sinceæˆ–If-None-Matchã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºå®¢æˆ·ç«¯ä»ç„¶å…·æœ‰ä»¥å‰ä¸‹è½½çš„å‰¯æœ¬ï¼Œå› æ­¤ä¸éœ€è¦é‡æ–°ä¼ è¾“èµ„æºã€‚</p>
</li>
<li><p>305 Use Proxy<br>è¢«è¯·æ±‚çš„èµ„æºå¿…é¡»é€šè¿‡æŒ‡å®šçš„ä»£ç†æ‰èƒ½è¢«è®¿é—®ã€‚LocationåŸŸä¸­å°†ç»™å‡ºæŒ‡å®šçš„ä»£ç†æ‰€åœ¨çš„URIä¿¡æ¯ï¼Œæ¥æ”¶è€…éœ€è¦é‡å¤å‘é€ä¸€ä¸ªå•ç‹¬çš„è¯·æ±‚ï¼Œé€šè¿‡è¿™ä¸ªä»£ç†æ‰èƒ½è®¿é—®ç›¸åº”èµ„æºã€‚åªæœ‰åŸå§‹æœåŠ¡å™¨æ‰èƒ½åˆ›å»º305å“åº”ã€‚è®¸å¤šHTTPå®¢æˆ·ç«¯ï¼ˆåƒæ˜¯Mozillaå’ŒInternet Explorerï¼‰éƒ½æ²¡æœ‰æ­£ç¡®å¤„ç†è¿™ç§çŠ¶æ€ä»£ç çš„å“åº”ï¼Œä¸»è¦æ˜¯å‡ºäºå®‰å…¨è€ƒè™‘ã€‚<br>æ³¨æ„ï¼šRFC 2068ä¸­æ²¡æœ‰æ˜ç¡®305å“åº”æ˜¯ä¸ºäº†é‡å®šå‘ä¸€ä¸ªå•ç‹¬çš„è¯·æ±‚ï¼Œè€Œä¸”åªèƒ½è¢«åŸå§‹æœåŠ¡å™¨å»ºç«‹ã€‚å¿½è§†è¿™äº›é™åˆ¶å¯èƒ½å¯¼è‡´ä¸¥é‡çš„å®‰å…¨åæœã€‚</p>
</li>
<li><p>306 Switch Proxy<br>åœ¨æœ€æ–°ç‰ˆçš„è§„èŒƒä¸­ï¼Œ306çŠ¶æ€ç å·²ç»ä¸å†è¢«ä½¿ç”¨ã€‚æœ€åˆæ˜¯æŒ‡â€œåç»­è¯·æ±‚åº”ä½¿ç”¨æŒ‡å®šçš„ä»£ç†â€ã€‚</p>
</li>
<li><p>307 Temporary Redirect<br>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ±‚åº”è¯¥ä¸å¦ä¸€ä¸ªURIé‡å¤ï¼Œä½†åç»­çš„è¯·æ±‚åº”ä»ä½¿ç”¨åŸå§‹çš„URIã€‚ ä¸302ç›¸åï¼Œå½“é‡æ–°å‘å‡ºåŸå§‹è¯·æ±‚æ—¶ï¼Œä¸å…è®¸æ›´æ”¹è¯·æ±‚æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼Œåº”è¯¥ä½¿ç”¨å¦ä¸€ä¸ªPOSTè¯·æ±‚æ¥é‡å¤POSTè¯·æ±‚ã€‚</p>
</li>
<li><p>308 Permanent Redirect (RFC 7538)<br>è¯·æ±‚å’Œæ‰€æœ‰å°†æ¥çš„è¯·æ±‚åº”è¯¥ä½¿ç”¨å¦ä¸€ä¸ªURIé‡å¤ã€‚ 307å’Œ308é‡å¤302å’Œ301çš„è¡Œä¸ºï¼Œä½†ä¸å…è®¸HTTPæ–¹æ³•æ›´æ”¹ã€‚ ä¾‹å¦‚ï¼Œå°†è¡¨å•æäº¤ç»™æ°¸ä¹…é‡å®šå‘çš„èµ„æºå¯èƒ½ä¼šé¡ºåˆ©è¿›è¡Œã€‚</p>
</li>
</ul>
<br>

<h2 id="4xx-å®¢æˆ·ç«¯é”™è¯¯"><a href="#4xx-å®¢æˆ·ç«¯é”™è¯¯" class="headerlink" title="4xx-å®¢æˆ·ç«¯é”™è¯¯"></a>4xx-å®¢æˆ·ç«¯é”™è¯¯</h2><p>è¿™ç±»çš„çŠ¶æ€ç ä»£è¡¨äº†å®¢æˆ·ç«¯çœ‹èµ·æ¥å¯èƒ½å‘ç”Ÿäº†é”™è¯¯ï¼Œå¦¨ç¢äº†æœåŠ¡å™¨çš„å¤„ç†ã€‚é™¤éå“åº”çš„æ˜¯ä¸€ä¸ªHEADè¯·æ±‚ï¼Œå¦åˆ™æœåŠ¡å™¨å°±åº”è¯¥è¿”å›ä¸€ä¸ªè§£é‡Šå½“å‰é”™è¯¯çŠ¶å†µçš„å®ä½“ï¼Œä»¥åŠè¿™æ˜¯ä¸´æ—¶çš„è¿˜æ˜¯æ°¸ä¹…æ€§çš„çŠ¶å†µã€‚è¿™äº›çŠ¶æ€ç é€‚ç”¨äºä»»ä½•è¯·æ±‚æ–¹æ³•ã€‚æµè§ˆå™¨åº”å½“å‘ç”¨æˆ·æ˜¾ç¤ºä»»ä½•åŒ…å«åœ¨æ­¤ç±»é”™è¯¯å“åº”ä¸­çš„å®ä½“å†…å®¹ã€‚</p>
<p>å¦‚æœé”™è¯¯å‘ç”Ÿæ—¶å®¢æˆ·ç«¯æ­£åœ¨ä¼ é€æ•°æ®ï¼Œé‚£ä¹ˆä½¿ç”¨TCPçš„æœåŠ¡å™¨å®ç°åº”å½“ä»”ç»†ç¡®ä¿åœ¨å…³é—­å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥ä¹‹å‰ï¼Œå®¢æˆ·ç«¯å·²ç»æ”¶åˆ°äº†åŒ…å«é”™è¯¯ä¿¡æ¯çš„æ•°æ®åŒ…ã€‚å¦‚æœå®¢æˆ·ç«¯åœ¨æ”¶åˆ°é”™è¯¯ä¿¡æ¯åç»§ç»­å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼ŒæœåŠ¡å™¨çš„TCPæ ˆå°†å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªé‡ç½®æ•°æ®åŒ…ï¼Œä»¥æ¸…é™¤è¯¥å®¢æˆ·ç«¯æ‰€æœ‰è¿˜æœªè¯†åˆ«çš„è¾“å…¥ç¼“å†²ï¼Œä»¥å…è¿™äº›æ•°æ®è¢«æœåŠ¡å™¨ä¸Šçš„åº”ç”¨ç¨‹åºè¯»å–å¹¶å¹²æ‰°åè€…ã€‚</p>
<ul>
<li><p>400 Bad Request<br>ç”±äºæ˜æ˜¾çš„å®¢æˆ·ç«¯é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œæ ¼å¼é”™è¯¯çš„è¯·æ±‚è¯­æ³•ï¼Œå¤ªå¤§çš„å¤§å°ï¼Œæ— æ•ˆçš„è¯·æ±‚æ¶ˆæ¯æˆ–æ¬ºéª—æ€§è·¯ç”±è¯·æ±‚ï¼‰ï¼ŒæœåŠ¡å™¨ä¸èƒ½æˆ–ä¸ä¼šå¤„ç†è¯¥è¯·æ±‚ã€‚</p>
</li>
<li><p>401 Unauthorizedï¼ˆRFC 7235ï¼‰<br>å‚è§ï¼šHTTPåŸºæœ¬è®¤è¯ã€HTTPæ‘˜è¦è®¤è¯<br>ç±»ä¼¼äº403 Forbiddenï¼Œ401è¯­ä¹‰å³â€œæœªè®¤è¯â€ï¼Œå³ç”¨æˆ·æ²¡æœ‰å¿…è¦çš„å‡­æ®ã€‚è¯¥çŠ¶æ€ç è¡¨ç¤ºå½“å‰è¯·æ±‚éœ€è¦ç”¨æˆ·éªŒè¯ã€‚è¯¥å“åº”å¿…é¡»åŒ…å«ä¸€ä¸ªé€‚ç”¨äºè¢«è¯·æ±‚èµ„æºçš„WWW-Authenticateä¿¡æ¯å¤´ç”¨ä»¥è¯¢é—®ç”¨æˆ·ä¿¡æ¯ã€‚å®¢æˆ·ç«¯å¯ä»¥é‡å¤æäº¤ä¸€ä¸ªåŒ…å«æ°å½“çš„Authorizationå¤´ä¿¡æ¯çš„è¯·æ±‚ã€‚[33]å¦‚æœå½“å‰è¯·æ±‚å·²ç»åŒ…å«äº†Authorizationè¯ä¹¦ï¼Œé‚£ä¹ˆ401å“åº”ä»£è¡¨ç€æœåŠ¡å™¨éªŒè¯å·²ç»æ‹’ç»äº†é‚£äº›è¯ä¹¦ã€‚å¦‚æœ401å“åº”åŒ…å«äº†ä¸å‰ä¸€ä¸ªå“åº”ç›¸åŒçš„èº«ä»½éªŒè¯è¯¢é—®ï¼Œä¸”æµè§ˆå™¨å·²ç»è‡³å°‘å°è¯•äº†ä¸€æ¬¡éªŒè¯ï¼Œé‚£ä¹ˆæµè§ˆå™¨åº”å½“å‘ç”¨æˆ·å±•ç¤ºå“åº”ä¸­åŒ…å«çš„å®ä½“ä¿¡æ¯ï¼Œå› ä¸ºè¿™ä¸ªå®ä½“ä¿¡æ¯ä¸­å¯èƒ½åŒ…å«äº†ç›¸å…³è¯Šæ–­ä¿¡æ¯ã€‚<br>æ³¨æ„ï¼šå½“ç½‘ç«™ï¼ˆé€šå¸¸æ˜¯ç½‘ç«™åŸŸåï¼‰ç¦æ­¢IPåœ°å€æ—¶ï¼Œæœ‰äº›ç½‘ç«™çŠ¶æ€ç æ˜¾ç¤ºçš„401ï¼Œè¡¨ç¤ºè¯¥ç‰¹å®šåœ°å€è¢«æ‹’ç»è®¿é—®ç½‘ç«™ã€‚</p>
</li>
<li><p>402 Payment Required<br>è¯¥çŠ¶æ€ç æ˜¯ä¸ºäº†å°†æ¥å¯èƒ½çš„éœ€æ±‚è€Œé¢„ç•™çš„ã€‚è¯¥çŠ¶æ€ç æœ€åˆçš„æ„å›¾å¯èƒ½è¢«ç”¨ä½œæŸç§å½¢å¼çš„æ•°å­—ç°é‡‘æˆ–åœ¨çº¿æ”¯ä»˜æ–¹æ¡ˆçš„ä¸€éƒ¨åˆ†ï¼Œä½†å‡ ä¹æ²¡æœ‰å“ªå®¶æœåŠ¡å•†ä½¿ç”¨ï¼Œè€Œä¸”è¿™ä¸ªçŠ¶æ€ç é€šå¸¸ä¸è¢«ä½¿ç”¨ã€‚å¦‚æœç‰¹å®šå¼€å‘äººå‘˜å·²è¶…è¿‡è¯·æ±‚çš„æ¯æ—¥é™åˆ¶ï¼ŒGoogle Developers APIä¼šä½¿ç”¨æ­¤çŠ¶æ€ç ã€‚</p>
</li>
<li><p>403 Forbidden<br>ä¸»æ¡ç›®ï¼šHTTP 403<br>æœåŠ¡å™¨å·²ç»ç†è§£è¯·æ±‚ï¼Œä½†æ˜¯æ‹’ç»æ‰§è¡Œå®ƒã€‚ä¸401å“åº”ä¸åŒçš„æ˜¯ï¼Œèº«ä»½éªŒè¯å¹¶ä¸èƒ½æä¾›ä»»ä½•å¸®åŠ©ï¼Œè€Œä¸”è¿™ä¸ªè¯·æ±‚ä¹Ÿä¸åº”è¯¥è¢«é‡å¤æäº¤ã€‚å¦‚æœè¿™ä¸æ˜¯ä¸€ä¸ªHEADè¯·æ±‚ï¼Œè€Œä¸”æœåŠ¡å™¨å¸Œæœ›èƒ½å¤Ÿè®²æ¸…æ¥šä¸ºä½•è¯·æ±‚ä¸èƒ½è¢«æ‰§è¡Œï¼Œé‚£ä¹ˆå°±åº”è¯¥åœ¨å®ä½“å†…æè¿°æ‹’ç»çš„åŸå› ã€‚å½“ç„¶æœåŠ¡å™¨ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ª404å“åº”ï¼Œå‡å¦‚å®ƒä¸å¸Œæœ›è®©å®¢æˆ·ç«¯è·å¾—ä»»ä½•ä¿¡æ¯ã€‚</p>
</li>
<li><p>404 Not Found<br>ä¸»æ¡ç›®ï¼šHTTP 404<br>è¯·æ±‚å¤±è´¥ï¼Œè¯·æ±‚æ‰€å¸Œæœ›å¾—åˆ°çš„èµ„æºæœªè¢«åœ¨æœåŠ¡å™¨ä¸Šå‘ç°ï¼Œä½†å…è®¸ç”¨æˆ·çš„åç»­è¯·æ±‚ã€‚æ²¡æœ‰ä¿¡æ¯èƒ½å¤Ÿå‘Šè¯‰ç”¨æˆ·è¿™ä¸ªçŠ¶å†µåˆ°åº•æ˜¯æš‚æ—¶çš„è¿˜æ˜¯æ°¸ä¹…çš„ã€‚å‡å¦‚æœåŠ¡å™¨çŸ¥é“æƒ…å†µçš„è¯ï¼Œåº”å½“ä½¿ç”¨410çŠ¶æ€ç æ¥å‘ŠçŸ¥æ—§èµ„æºå› ä¸ºæŸäº›å†…éƒ¨çš„é…ç½®æœºåˆ¶é—®é¢˜ï¼Œå·²ç»æ°¸ä¹…çš„ä¸å¯ç”¨ï¼Œè€Œä¸”æ²¡æœ‰ä»»ä½•å¯ä»¥è·³è½¬çš„åœ°å€ã€‚404è¿™ä¸ªçŠ¶æ€ç è¢«å¹¿æ³›åº”ç”¨äºå½“æœåŠ¡å™¨ä¸æƒ³æ­ç¤ºåˆ°åº•ä¸ºä½•è¯·æ±‚è¢«æ‹’ç»æˆ–è€…æ²¡æœ‰å…¶ä»–é€‚åˆçš„å“åº”å¯ç”¨çš„æƒ…å†µä¸‹ã€‚</p>
</li>
<li><p>405 Method Not Allowed<br>è¯·æ±‚è¡Œä¸­æŒ‡å®šçš„è¯·æ±‚æ–¹æ³•ä¸èƒ½è¢«ç”¨äºè¯·æ±‚ç›¸åº”çš„èµ„æºã€‚è¯¥å“åº”å¿…é¡»è¿”å›ä¸€ä¸ªAllowå¤´ä¿¡æ¯ç”¨ä»¥è¡¨ç¤ºå‡ºå½“å‰èµ„æºèƒ½å¤Ÿæ¥å—çš„è¯·æ±‚æ–¹æ³•çš„åˆ—è¡¨ã€‚ä¾‹å¦‚ï¼Œéœ€è¦é€šè¿‡POSTå‘ˆç°æ•°æ®çš„è¡¨å•ä¸Šçš„GETè¯·æ±‚ï¼Œæˆ–åªè¯»èµ„æºä¸Šçš„PUTè¯·æ±‚ã€‚<br>é‰´äºPUTï¼ŒDELETEæ–¹æ³•ä¼šå¯¹æœåŠ¡å™¨ä¸Šçš„èµ„æºè¿›è¡Œå†™æ“ä½œï¼Œå› è€Œç»å¤§éƒ¨åˆ†çš„ç½‘é¡µæœåŠ¡å™¨éƒ½ä¸æ”¯æŒæˆ–è€…åœ¨é»˜è®¤é…ç½®ä¸‹ä¸å…è®¸ä¸Šè¿°è¯·æ±‚æ–¹æ³•ï¼Œå¯¹äºæ­¤ç±»è¯·æ±‚å‡ä¼šè¿”å›405é”™è¯¯ã€‚</p>
</li>
<li><p>406 Not Acceptable<br>å‚è§ï¼šå†…å®¹åå•†<br>è¯·æ±‚çš„èµ„æºçš„å†…å®¹ç‰¹æ€§æ— æ³•æ»¡è¶³è¯·æ±‚å¤´ä¸­çš„æ¡ä»¶ï¼Œå› è€Œæ— æ³•ç”Ÿæˆå“åº”å®ä½“ï¼Œè¯¥è¯·æ±‚ä¸å¯æ¥å—ã€‚<br>é™¤éè¿™æ˜¯ä¸€ä¸ªHEADè¯·æ±‚ï¼Œå¦åˆ™è¯¥å“åº”å°±åº”å½“è¿”å›ä¸€ä¸ªåŒ…å«å¯ä»¥è®©ç”¨æˆ·æˆ–è€…æµè§ˆå™¨ä»ä¸­é€‰æ‹©æœ€åˆé€‚çš„å®ä½“ç‰¹æ€§ä»¥åŠåœ°å€åˆ—è¡¨çš„å®ä½“ã€‚å®ä½“çš„æ ¼å¼ç”±Content-Typeå¤´ä¸­å®šä¹‰çš„åª’ä½“ç±»å‹å†³å®šã€‚æµè§ˆå™¨å¯ä»¥æ ¹æ®æ ¼å¼åŠè‡ªèº«èƒ½åŠ›è‡ªè¡Œä½œå‡ºæœ€ä½³é€‰æ‹©ã€‚ä½†æ˜¯ï¼Œè§„èŒƒä¸­å¹¶æ²¡æœ‰å®šä¹‰ä»»ä½•ä½œå‡ºæ­¤ç±»è‡ªåŠ¨é€‰æ‹©çš„æ ‡å‡†ã€‚</p>
</li>
<li><p>407 Proxy Authentication Requiredï¼ˆRFC 2617ï¼‰<br>ä¸401å“åº”ç±»ä¼¼ï¼Œåªä¸è¿‡å®¢æˆ·ç«¯å¿…é¡»åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šè¿›è¡Œèº«ä»½éªŒè¯ã€‚ä»£ç†æœåŠ¡å™¨å¿…é¡»è¿”å›ä¸€ä¸ªProxy-Authenticateç”¨ä»¥è¿›è¡Œèº«ä»½è¯¢é—®ã€‚å®¢æˆ·ç«¯å¯ä»¥è¿”å›ä¸€ä¸ªProxy-Authorizationä¿¡æ¯å¤´ç”¨ä»¥éªŒè¯ã€‚</p>
</li>
<li><p>408 Request Timeout<br>è¯·æ±‚è¶…æ—¶ã€‚æ ¹æ®HTTPè§„èŒƒï¼Œå®¢æˆ·ç«¯æ²¡æœ‰åœ¨æœåŠ¡å™¨é¢„å¤‡ç­‰å¾…çš„æ—¶é—´å†…å®Œæˆä¸€ä¸ªè¯·æ±‚çš„å‘é€ï¼Œå®¢æˆ·ç«¯å¯ä»¥éšæ—¶å†æ¬¡æäº¤è¿™ä¸€è¯·æ±‚è€Œæ— éœ€è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚</p>
</li>
<li><p>409 Conflict<br>è¡¨ç¤ºå› ä¸ºè¯·æ±‚å­˜åœ¨å†²çªæ— æ³•å¤„ç†è¯¥è¯·æ±‚ï¼Œä¾‹å¦‚å¤šä¸ªåŒæ­¥æ›´æ–°ä¹‹é—´çš„ç¼–è¾‘å†²çªã€‚</p>
</li>
<li><p>410 Gone<br>è¡¨ç¤ºæ‰€è¯·æ±‚çš„èµ„æºä¸å†å¯ç”¨ï¼Œå°†ä¸å†å¯ç”¨ã€‚å½“èµ„æºè¢«æœ‰æ„åœ°åˆ é™¤å¹¶ä¸”èµ„æºåº”è¢«æ¸…é™¤æ—¶ï¼Œåº”è¯¥ä½¿ç”¨è¿™ä¸ªã€‚åœ¨æ”¶åˆ°410çŠ¶æ€ç åï¼Œç”¨æˆ·åº”åœæ­¢å†æ¬¡è¯·æ±‚èµ„æºã€‚ä½†å¤§å¤šæ•°æœåŠ¡ç«¯ä¸ä¼šä½¿ç”¨æ­¤çŠ¶æ€ç ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨404çŠ¶æ€ç ã€‚</p>
</li>
<li><p>411 Length Required<br>æœåŠ¡å™¨æ‹’ç»åœ¨æ²¡æœ‰å®šä¹‰Content-Lengthå¤´çš„æƒ…å†µä¸‹æ¥å—è¯·æ±‚ã€‚åœ¨æ·»åŠ äº†è¡¨æ˜è¯·æ±‚æ¶ˆæ¯ä½“é•¿åº¦çš„æœ‰æ•ˆContent-Lengthå¤´ä¹‹åï¼Œå®¢æˆ·ç«¯å¯ä»¥å†æ¬¡æäº¤è¯¥è¯·æ±‚ã€‚</p>
</li>
<li><p>412 Precondition Failedï¼ˆRFC 7232ï¼‰<br>æœåŠ¡å™¨åœ¨éªŒè¯åœ¨è¯·æ±‚çš„å¤´å­—æ®µä¸­ç»™å‡ºå…ˆå†³æ¡ä»¶æ—¶ï¼Œæ²¡èƒ½æ»¡è¶³å…¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªã€‚è¿™ä¸ªçŠ¶æ€ç å…è®¸å®¢æˆ·ç«¯åœ¨è·å–èµ„æºæ—¶åœ¨è¯·æ±‚çš„å…ƒä¿¡æ¯ï¼ˆè¯·æ±‚å¤´å­—æ®µæ•°æ®ï¼‰ä¸­è®¾ç½®å…ˆå†³æ¡ä»¶ï¼Œä»¥æ­¤é¿å…è¯¥è¯·æ±‚æ–¹æ³•è¢«åº”ç”¨åˆ°å…¶å¸Œæœ›çš„å†…å®¹ä»¥å¤–çš„èµ„æºä¸Šã€‚</p>
</li>
<li><p>413 Request Entity Too Largeï¼ˆRFC 7231ï¼‰<br>å‰ç§°â€œRequest Entity Too Largeâ€ï¼Œè¡¨ç¤ºæœåŠ¡å™¨æ‹’ç»å¤„ç†å½“å‰è¯·æ±‚ï¼Œå› ä¸ºè¯¥è¯·æ±‚æäº¤çš„å®ä½“æ•°æ®å¤§å°è¶…è¿‡äº†æœåŠ¡å™¨æ„¿æ„æˆ–è€…èƒ½å¤Ÿå¤„ç†çš„èŒƒå›´ã€‚æ­¤ç§æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨å¯ä»¥å…³é—­è¿æ¥ä»¥å…å®¢æˆ·ç«¯ç»§ç»­å‘é€æ­¤è¯·æ±‚ã€‚<br>å¦‚æœè¿™ä¸ªçŠ¶å†µæ˜¯ä¸´æ—¶çš„ï¼ŒæœåŠ¡å™¨åº”å½“è¿”å›ä¸€ä¸ªRetry-Afterçš„å“åº”å¤´ï¼Œä»¥å‘ŠçŸ¥å®¢æˆ·ç«¯å¯ä»¥åœ¨å¤šå°‘æ—¶é—´ä»¥åé‡æ–°å°è¯•ã€‚</p>
</li>
<li><p>414 Request-URI Too Longï¼ˆRFC 7231ï¼‰<br>å‰ç§°â€œRequest-URI Too Longâ€ï¼Œè¡¨ç¤ºè¯·æ±‚çš„URIé•¿åº¦è¶…è¿‡äº†æœåŠ¡å™¨èƒ½å¤Ÿè§£é‡Šçš„é•¿åº¦ï¼Œå› æ­¤æœåŠ¡å™¨æ‹’ç»å¯¹è¯¥è¯·æ±‚æä¾›æœåŠ¡ã€‚é€šå¸¸å°†å¤ªå¤šæ•°æ®çš„ç»“æœç¼–ç ä¸ºGETè¯·æ±‚çš„æŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº”å°†å…¶è½¬æ¢ä¸ºPOSTè¯·æ±‚ã€‚è¿™æ¯”è¾ƒå°‘è§ï¼Œé€šå¸¸çš„æƒ…å†µåŒ…æ‹¬ï¼š<br>æœ¬åº”ä½¿ç”¨POSTæ–¹æ³•çš„è¡¨å•æäº¤å˜æˆäº†GETæ–¹æ³•ï¼Œå¯¼è‡´æŸ¥è¯¢å­—ç¬¦ä¸²è¿‡é•¿ã€‚<br>é‡å®šå‘URIâ€œé»‘æ´â€ï¼Œä¾‹å¦‚æ¯æ¬¡é‡å®šå‘æŠŠæ—§çš„URIä½œä¸ºæ–°çš„URIçš„ä¸€éƒ¨åˆ†ï¼Œå¯¼è‡´åœ¨è‹¥å¹²æ¬¡é‡å®šå‘åURIè¶…é•¿ã€‚<br>å®¢æˆ·ç«¯æ­£åœ¨å°è¯•åˆ©ç”¨æŸäº›æœåŠ¡å™¨ä¸­å­˜åœ¨çš„å®‰å…¨æ¼æ´æ”»å‡»æœåŠ¡å™¨ã€‚è¿™ç±»æœåŠ¡å™¨ä½¿ç”¨å›ºå®šé•¿åº¦çš„ç¼“å†²è¯»å–æˆ–æ“ä½œè¯·æ±‚çš„URIï¼Œå½“GETåçš„å‚æ•°è¶…è¿‡æŸä¸ªæ•°å€¼åï¼Œå¯èƒ½ä¼šäº§ç”Ÿç¼“å†²åŒºæº¢å‡ºï¼Œå¯¼è‡´ä»»æ„ä»£ç è¢«æ‰§è¡Œã€‚æ²¡æœ‰æ­¤ç±»æ¼æ´çš„æœåŠ¡å™¨ï¼Œåº”å½“è¿”å›414çŠ¶æ€ç ã€‚</p>
</li>
<li><p>415 Unsupported Media Type<br>å¯¹äºå½“å‰è¯·æ±‚çš„æ–¹æ³•å’Œæ‰€è¯·æ±‚çš„èµ„æºï¼Œè¯·æ±‚ä¸­æäº¤çš„äº’è”ç½‘åª’ä½“ç±»å‹å¹¶ä¸æ˜¯æœåŠ¡å™¨ä¸­æ‰€æ”¯æŒçš„æ ¼å¼ï¼Œå› æ­¤è¯·æ±‚è¢«æ‹’ç»ã€‚ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯å°†å›¾åƒä¸Šä¼ æ ¼å¼ä¸ºsvgï¼Œä½†æœåŠ¡å™¨è¦æ±‚å›¾åƒä½¿ç”¨ä¸Šä¼ æ ¼å¼ä¸ºjpgã€‚</p>
</li>
<li><p>416 Requested Range Not Satisfiableï¼ˆRFC 7233ï¼‰<br>å‰ç§°â€œRequested Range Not Satisfiableâ€ã€‚å®¢æˆ·ç«¯å·²ç»è¦æ±‚æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼ˆByte servingï¼‰ï¼Œä½†æœåŠ¡å™¨ä¸èƒ½æä¾›è¯¥éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå®¢æˆ·ç«¯è¦æ±‚æ–‡ä»¶çš„ä¸€éƒ¨åˆ†è¶…å‡ºæ–‡ä»¶å°¾ç«¯ã€‚</p>
</li>
<li><p>417 Expectation Failed<br>åœ¨è¯·æ±‚å¤´Expectä¸­æŒ‡å®šçš„é¢„æœŸå†…å®¹æ— æ³•è¢«æœåŠ¡å™¨æ»¡è¶³ï¼Œæˆ–è€…è¿™ä¸ªæœåŠ¡å™¨æ˜¯ä¸€ä¸ªä»£ç†æœæ˜¾çš„è¯æ®è¯æ˜åœ¨å½“å‰è·¯ç”±çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼ŒExpectçš„å†…å®¹æ— æ³•è¢«æ»¡è¶³ã€‚</p>
</li>
<li><p>418 Iâ€™m a teapotï¼ˆRFC 2324ï¼‰<br>æœ¬æ“ä½œç æ˜¯åœ¨1998å¹´ä½œä¸ºIETFçš„ä¼ ç»Ÿæ„šäººèŠ‚ç¬‘è¯, åœ¨RFC 2324è¶…æ–‡æœ¬å’–å•¡å£¶æ§åˆ¶åè®®â€™ä¸­å®šä¹‰çš„ï¼Œå¹¶ä¸éœ€è¦åœ¨çœŸå®çš„HTTPæœåŠ¡å™¨ä¸­å®šä¹‰ã€‚å½“ä¸€ä¸ªæ§åˆ¶èŒ¶å£¶çš„HTCPCPæ”¶åˆ°BREWæˆ–POSTæŒ‡ä»¤è¦æ±‚å…¶ç…®å’–å•¡æ—¶åº”å½“å›ä¼ æ­¤é”™è¯¯ã€‚è¿™ä¸ªHTTPçŠ¶æ€ç åœ¨æŸäº›ç½‘ç«™ï¼ˆåŒ…æ‹¬Google.comï¼‰ä¸é¡¹ç›®ï¼ˆå¦‚Node.jsã€ASP.NETå’ŒGoè¯­è¨€ï¼‰ä¸­ç”¨ä½œå½©è›‹ã€‚</p>
</li>
<li><p>420 Enhance Your Caim<br>Twitter Searchä¸Trends APIåœ¨å®¢æˆ·ç«¯è¢«é™é€Ÿçš„æƒ…å†µä¸‹è¿”å›ã€‚</p>
</li>
<li><p>421 Misdirected Request ï¼ˆRFC 7540ï¼‰<br>è¯¥è¯·æ±‚é’ˆå¯¹çš„æ˜¯æ— æ³•äº§ç”Ÿå“åº”çš„æœåŠ¡å™¨ï¼ˆä¾‹å¦‚å› ä¸ºè¿æ¥é‡ç”¨ï¼‰ã€‚</p>
</li>
<li><p>422 Unprocessable Entityï¼ˆWebDAVï¼›RFC 4918 ï¼‰<br>è¯·æ±‚æ ¼å¼æ­£ç¡®ï¼Œä½†æ˜¯ç”±äºå«æœ‰è¯­ä¹‰é”™è¯¯ï¼Œæ— æ³•å“åº”ã€‚</p>
</li>
<li><p>423 Lockedï¼ˆWebDAVï¼›RFC 4918ï¼‰<br>å½“å‰èµ„æºè¢«é”å®šã€‚</p>
</li>
<li><p>424 Failed Dependencyï¼ˆWebDAVï¼›RFC 4918ï¼‰<br>ç”±äºä¹‹å‰çš„æŸä¸ªè¯·æ±‚å‘ç”Ÿçš„é”™è¯¯ï¼Œå¯¼è‡´å½“å‰è¯·æ±‚å¤±è´¥ï¼Œä¾‹å¦‚PROPPATCHã€‚</p>
</li>
<li><p>425 Unordered Collection<br>åœ¨WebDAV Advanced Collections Protocolä¸­å®šä¹‰ï¼Œä½†Web Distributed Authoring and Versioning (WebDAV) Ordered Collections Protocolä¸­å¹¶ä¸å­˜åœ¨ã€‚</p>
</li>
<li><p>426 Upgrade Requiredï¼ˆRFC 2817ï¼‰<br>å®¢æˆ·ç«¯åº”å½“åˆ‡æ¢åˆ°TLS/1.0ï¼Œå¹¶åœ¨HTTP/1.1 Upgrade headerä¸­ç»™å‡ºã€‚</p>
</li>
<li><p>428 Precondition Required (RFC 6585)<br>åŸæœåŠ¡å™¨è¦æ±‚è¯¥è¯·æ±‚æ»¡è¶³ä¸€å®šæ¡ä»¶ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢â€œâ€˜æœªæ›´æ–°â€™é—®é¢˜ï¼Œå³å®¢æˆ·ç«¯è¯»å–ï¼ˆGETï¼‰ä¸€ä¸ªèµ„æºçš„çŠ¶æ€ï¼Œæ›´æ”¹å®ƒï¼Œå¹¶å°†å®ƒå†™ï¼ˆPUTï¼‰å›æœåŠ¡å™¨ï¼Œä½†è¿™æœŸé—´ç¬¬ä¸‰æ–¹å·²ç»åœ¨æœåŠ¡å™¨ä¸Šæ›´æ”¹äº†è¯¥èµ„æºçš„çŠ¶æ€ï¼Œå› æ­¤å¯¼è‡´äº†å†²çªã€‚â€</p>
</li>
<li><p>429 Too Many Requests ï¼ˆRFC 6585ï¼‰<br>ç”¨æˆ·åœ¨ç»™å®šçš„æ—¶é—´å†…å‘é€äº†å¤ªå¤šçš„è¯·æ±‚ã€‚æ—¨åœ¨ç”¨äºç½‘ç»œé™é€Ÿã€‚</p>
</li>
<li><p>431 Request Header Fields Too Large ï¼ˆRFC 6585ï¼‰<br>æœåŠ¡å™¨ä¸æ„¿å¤„ç†è¯·æ±‚ï¼Œå› ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªå¤´å­—æ®µè¿‡å¤§ã€‚</p>
</li>
<li><p>444 No Response<br>Nginxä¸ŠHTTPæœåŠ¡å™¨æ‰©å±•ã€‚æœåŠ¡å™¨ä¸å‘å®¢æˆ·ç«¯è¿”å›ä»»ä½•ä¿¡æ¯ï¼Œå¹¶å…³é—­è¿æ¥ï¼ˆæœ‰åŠ©äºé˜»æ­¢æ¶æ„è½¯ä»¶ï¼‰ã€‚</p>
</li>
<li><p>450 Blocked by Windows Parental Controls<br>è¿™æ˜¯ä¸€ä¸ªç”±Windowså®¶åº­æ§åˆ¶ï¼ˆMicrosoftï¼‰HTTPé˜»æ­¢çš„450çŠ¶æ€ä»£ç çš„ç¤ºä¾‹ï¼Œç”¨äºä¿¡æ¯å’Œæµ‹è¯•ã€‚</p>
</li>
<li><p>451 Unavailable For Legal Reasons<br>è¯¥è®¿é—®å› æ³•å¾‹çš„è¦æ±‚è€Œè¢«æ‹’ç»ï¼Œç”±IETFåœ¨2015æ ¸å‡†åæ–°å¢åŠ ã€‚</p>
</li>
<li><p>494 Request Header Too Large<br>åœ¨é”™è¯¯ä»£ç 431æå‡ºä¹‹å‰Nginxä¸Šä½¿ç”¨çš„æ‰©å±•HTTPä»£ç ã€‚</p>
</li>
</ul>
<br>

<h2 id="5xx-æœåŠ¡å™¨é”™è¯¯"><a href="#5xx-æœåŠ¡å™¨é”™è¯¯" class="headerlink" title="5xx-æœåŠ¡å™¨é”™è¯¯"></a>5xx-æœåŠ¡å™¨é”™è¯¯</h2><p>è¡¨ç¤ºæœåŠ¡å™¨æ— æ³•å®Œæˆæ˜æ˜¾æœ‰æ•ˆçš„è¯·æ±‚ã€‚è¿™ç±»çŠ¶æ€ç ä»£è¡¨äº†æœåŠ¡å™¨åœ¨å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­æœ‰é”™è¯¯æˆ–è€…å¼‚å¸¸çŠ¶æ€å‘ç”Ÿï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æœåŠ¡å™¨æ„è¯†åˆ°ä»¥å½“å‰çš„è½¯ç¡¬ä»¶èµ„æºæ— æ³•å®Œæˆå¯¹è¯·æ±‚çš„å¤„ç†ã€‚é™¤éè¿™æ˜¯ä¸€ä¸ªHEADè¯·æ±‚ï¼Œå¦åˆ™æœåŠ¡å™¨åº”å½“åŒ…å«ä¸€ä¸ªè§£é‡Šå½“å‰é”™è¯¯çŠ¶æ€ä»¥åŠè¿™ä¸ªçŠ¶å†µæ˜¯ä¸´æ—¶çš„è¿˜æ˜¯æ°¸ä¹…çš„è§£é‡Šä¿¡æ¯å®ä½“ã€‚æµè§ˆå™¨åº”å½“å‘ç”¨æˆ·å±•ç¤ºä»»ä½•åœ¨å½“å‰å“åº”ä¸­è¢«åŒ…å«çš„å®ä½“ã€‚è¿™äº›çŠ¶æ€ç é€‚ç”¨äºä»»ä½•å“åº”æ–¹æ³•ã€‚</p>
<ul>
<li><p>500 Internal Server Error<br>é€šç”¨é”™è¯¯æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨é‡åˆ°äº†ä¸€ä¸ªæœªæ›¾é¢„æ–™çš„çŠ¶å†µï¼Œå¯¼è‡´äº†å®ƒæ— æ³•å®Œæˆå¯¹è¯·æ±‚çš„å¤„ç†ã€‚æ²¡æœ‰ç»™å‡ºå…·ä½“é”™è¯¯ä¿¡æ¯ã€‚</p>
</li>
<li><p>501 Not Implemented<br>æœåŠ¡å™¨ä¸æ”¯æŒå½“å‰è¯·æ±‚æ‰€éœ€è¦çš„æŸä¸ªåŠŸèƒ½ã€‚å½“æœåŠ¡å™¨æ— æ³•è¯†åˆ«è¯·æ±‚çš„æ–¹æ³•ï¼Œå¹¶ä¸”æ— æ³•æ”¯æŒå…¶å¯¹ä»»ä½•èµ„æºçš„è¯·æ±‚ã€‚ï¼ˆä¾‹å¦‚ï¼Œç½‘ç»œæœåŠ¡APIçš„æ–°åŠŸèƒ½ï¼‰</p>
</li>
<li><p>502 Bad Gateway<br>ä½œä¸ºç½‘å…³æˆ–è€…ä»£ç†å·¥ä½œçš„æœåŠ¡å™¨å°è¯•æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œä»ä¸Šæ¸¸æœåŠ¡å™¨æ¥æ”¶åˆ°æ— æ•ˆçš„å“åº”ã€‚</p>
</li>
<li><p>503 Service Unavailable<br>ç”±äºä¸´æ—¶çš„æœåŠ¡å™¨ç»´æŠ¤æˆ–è€…è¿‡è½½ï¼ŒæœåŠ¡å™¨å½“å‰æ— æ³•å¤„ç†è¯·æ±‚ã€‚è¿™ä¸ªçŠ¶å†µæ˜¯æš‚æ—¶çš„ï¼Œå¹¶ä¸”å°†åœ¨ä¸€æ®µæ—¶é—´ä»¥åæ¢å¤ã€‚å¦‚æœèƒ½å¤Ÿé¢„è®¡å»¶è¿Ÿæ—¶é—´ï¼Œé‚£ä¹ˆå“åº”ä¸­å¯ä»¥åŒ…å«ä¸€ä¸ªRetry-Afterå¤´ç”¨ä»¥æ ‡æ˜è¿™ä¸ªå»¶è¿Ÿæ—¶é—´ã€‚å¦‚æœæ²¡æœ‰ç»™å‡ºè¿™ä¸ªRetry-Afterä¿¡æ¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯åº”å½“ä»¥å¤„ç†500å“åº”çš„æ–¹å¼å¤„ç†å®ƒã€‚</p>
</li>
<li><p>504 Gateway Timeout<br>ä½œä¸ºç½‘å…³æˆ–è€…ä»£ç†å·¥ä½œçš„æœåŠ¡å™¨å°è¯•æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œæœªèƒ½åŠæ—¶ä»ä¸Šæ¸¸æœåŠ¡å™¨ï¼ˆURIæ ‡è¯†å‡ºçš„æœåŠ¡å™¨ï¼Œä¾‹å¦‚HTTPã€FTPã€LDAPï¼‰æˆ–è€…è¾…åŠ©æœåŠ¡å™¨ï¼ˆä¾‹å¦‚DNSï¼‰æ”¶åˆ°å“åº”ã€‚<br>æ³¨æ„ï¼šæŸäº›ä»£ç†æœåŠ¡å™¨åœ¨DNSæŸ¥è¯¢è¶…æ—¶æ—¶ä¼šè¿”å›400æˆ–è€…500é”™è¯¯ã€‚</p>
</li>
<li><p>505 HTTP Version Not Supported<br>æœåŠ¡å™¨ä¸æ”¯æŒï¼Œæˆ–è€…æ‹’ç»æ”¯æŒåœ¨è¯·æ±‚ä¸­ä½¿ç”¨çš„HTTPç‰ˆæœ¬ã€‚[63]è¿™æš—ç¤ºç€æœåŠ¡å™¨ä¸èƒ½æˆ–ä¸æ„¿ä½¿ç”¨ä¸å®¢æˆ·ç«¯ç›¸åŒçš„ç‰ˆæœ¬ã€‚å“åº”ä¸­åº”å½“åŒ…å«ä¸€ä¸ªæè¿°äº†ä¸ºä½•ç‰ˆæœ¬ä¸è¢«æ”¯æŒä»¥åŠæœåŠ¡å™¨æ”¯æŒå“ªäº›åè®®çš„å®ä½“ã€‚</p>
</li>
<li><p>506 Variant Also Negotiatesï¼ˆRFC 2295ï¼‰<br>ç”±ã€Šé€æ˜å†…å®¹åå•†åè®®ã€‹ï¼ˆRFC 2295ï¼‰æ‰©å±•ï¼Œä»£è¡¨æœåŠ¡å™¨å­˜åœ¨å†…éƒ¨é…ç½®é”™è¯¯ï¼Œè¢«è¯·æ±‚çš„åå•†å˜å…ƒèµ„æºè¢«é…ç½®ä¸ºåœ¨é€æ˜å†…å®¹åå•†ä¸­ä½¿ç”¨è‡ªå·±ï¼Œå› æ­¤åœ¨ä¸€ä¸ªåå•†å¤„ç†ä¸­ä¸æ˜¯ä¸€ä¸ªåˆé€‚çš„é‡ç‚¹ã€‚</p>
</li>
<li><p>507 Insufficient Storageï¼ˆWebDAVï¼›RFC 4918ï¼‰<br>æœåŠ¡å™¨æ— æ³•å­˜å‚¨å®Œæˆè¯·æ±‚æ‰€å¿…é¡»çš„å†…å®¹ã€‚è¿™ä¸ªçŠ¶å†µè¢«è®¤ä¸ºæ˜¯ä¸´æ—¶çš„ã€‚</p>
</li>
<li><p>508 Loop Detected ï¼ˆWebDAVï¼›RFC 5842ï¼‰<br>æœåŠ¡å™¨åœ¨å¤„ç†è¯·æ±‚æ—¶é™·å…¥æ­»å¾ªç¯ã€‚ ï¼ˆå¯ä»£æ›¿ 208çŠ¶æ€ç ï¼‰</p>
</li>
<li><p>510 Not Extendedï¼ˆRFC 2774ï¼‰<br>è·å–èµ„æºæ‰€éœ€è¦çš„ç­–ç•¥å¹¶æ²¡æœ‰è¢«æ»¡è¶³ã€‚</p>
</li>
<li><p>511 Network Authentication Required ï¼ˆRFC 6585ï¼‰<br>å®¢æˆ·ç«¯éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯æ‰èƒ½è·å¾—ç½‘ç»œè®¿é—®æƒé™ï¼Œæ—¨åœ¨é™åˆ¶ç”¨æˆ·ç¾¤è®¿é—®ç‰¹å®šç½‘ç»œã€‚ï¼ˆä¾‹å¦‚è¿æ¥WiFiçƒ­ç‚¹æ—¶çš„å¼ºåˆ¶ç½‘ç»œé—¨æˆ·ï¼‰</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Http</category>
      </categories>
      <tags>
        <tag>HttpCode</tag>
      </tags>
  </entry>
</search>
